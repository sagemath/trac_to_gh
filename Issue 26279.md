# Issue 26279: Wrong sig_on_count in libgap

archive/issues_026279.json:
```json
{
    "body": "Keywords: libgap sig_on_count\n\nWhen running doctests in my applications of libgap, sig_on_count reveals problems.\n\nIndeed, in `src/sage/libs/gap/*`, one often sees constructions like the following:\n\n```python\n        try:\n            sig_on()\n            result = libGAP_EQ(self.value, c_other.value)\n            sig_off()\n        except RuntimeError as msg:\n            raise ValueError('libGAP: cannot compare equality: '+str(msg))\n        finally:\n            libgap_exit()\n...\n        try:\n            libgap_enter()\n            sig_on()\n            result = libGAP_SUM(self.value, (<GapElement>right).value)\n            sig_off()\n        except RuntimeError as msg:\n            libGAP_ClearError()\n            raise ValueError('libGAP: '+str(msg))\n        finally:\n            libgap_exit()\n...\n```\n\nSo, sig_off() is only called when no error is raised. But in my applications, I am in fact catching errors raised by libgap. So, maybe it is no surprise that the sig_on/sig_off count got wrong.\n\nProposed fix: move the sig_off() call to the \"finally\" clause, directly before libgap_exit()\n\nIssue created by migration from https://trac.sagemath.org/ticket/26516\n\n",
    "created_at": "2018-10-21T09:09:25Z",
    "labels": [
        "interfaces",
        "major",
        "bug"
    ],
    "title": "Wrong sig_on_count in libgap",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26279",
    "user": "SimonKing"
}
```
Keywords: libgap sig_on_count

When running doctests in my applications of libgap, sig_on_count reveals problems.

Indeed, in `src/sage/libs/gap/*`, one often sees constructions like the following:

```python
        try:
            sig_on()
            result = libGAP_EQ(self.value, c_other.value)
            sig_off()
        except RuntimeError as msg:
            raise ValueError('libGAP: cannot compare equality: '+str(msg))
        finally:
            libgap_exit()
...
        try:
            libgap_enter()
            sig_on()
            result = libGAP_SUM(self.value, (<GapElement>right).value)
            sig_off()
        except RuntimeError as msg:
            libGAP_ClearError()
            raise ValueError('libGAP: '+str(msg))
        finally:
            libgap_exit()
...
```

So, sig_off() is only called when no error is raised. But in my applications, I am in fact catching errors raised by libgap. So, maybe it is no surprise that the sig_on/sig_off count got wrong.

Proposed fix: move the sig_off() call to the "finally" clause, directly before libgap_exit()

Issue created by migration from https://trac.sagemath.org/ticket/26516





---

archive/issue_comments_370335.json:
```json
{
    "body": "Replying to [ticket:26516 SimonKing]:\n> Proposed fix: move the sig_off() call to the \"finally\" clause, directly before libgap_exit()\n\nNo, that `finally` is meant for `libgap_exit`. So you need a nested `try`/`finally`:\n\n```\ntry:\n    sig_on()\n    try:\n        ...\n    finally:\n        sig_off\nfinally:\n    libgap_exit()\n```\n\nor something like that.",
    "created_at": "2018-10-21T09:36:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370335",
    "user": "jdemeyer"
}
```

Replying to [ticket:26516 SimonKing]:
> Proposed fix: move the sig_off() call to the "finally" clause, directly before libgap_exit()

No, that `finally` is meant for `libgap_exit`. So you need a nested `try`/`finally`:

```
try:
    sig_on()
    try:
        ...
    finally:
        sig_off
finally:
    libgap_exit()
```

or something like that.



---

archive/issue_comments_370336.json:
```json
{
    "body": "Replying to [ticket:26516 SimonKing]:\n> But in my applications, I am in fact catching errors raised by libgap.\n\nCan you elaborate on what you mean with that? As far as I know, libgap is a C library, so how could it raise Python exceptions?",
    "created_at": "2018-10-21T09:38:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370336",
    "user": "jdemeyer"
}
```

Replying to [ticket:26516 SimonKing]:
> But in my applications, I am in fact catching errors raised by libgap.

Can you elaborate on what you mean with that? As far as I know, libgap is a C library, so how could it raise Python exceptions?



---

archive/issue_comments_370337.json:
```json
{
    "body": "Replying to [comment:3 jdemeyer]:\n> Replying to [ticket:26516 SimonKing]:\n> > But in my applications, I am in fact catching errors raised by libgap.\n> \n> Can you elaborate on what you mean with that? As far as I know, libgap is a C library, so how could it raise Python exceptions?\n\nRight. I use \"libgap\" synonymous to SageMath's libgap wrapper.\n\nAnyway, I am doing things like this:\n\n```\n    try:\n        G = G.MinimalGeneratingSet().Group()\n    except (RuntimeError, ValueError):\n        G = G.SmallGeneratingSet().Group()\n```\n\nFor some of my groups, the attempt to compute a minimal generating set fails, and if I understand correctly, the libgap wrapper would call sig_on(), then kindly ask libgap to compute the minimal generating set, and when this fails would not call sig_off() before raising a Python error.\n\nEDIT: I tested and found that *this* is not giving a sig_on_count() failure. But I am now going through the actual tests of my applications and will hopefully be able to create a minimal example.",
    "created_at": "2018-10-21T09:48:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370337",
    "user": "SimonKing"
}
```

Replying to [comment:3 jdemeyer]:
> Replying to [ticket:26516 SimonKing]:
> > But in my applications, I am in fact catching errors raised by libgap.
> 
> Can you elaborate on what you mean with that? As far as I know, libgap is a C library, so how could it raise Python exceptions?

Right. I use "libgap" synonymous to SageMath's libgap wrapper.

Anyway, I am doing things like this:

```
    try:
        G = G.MinimalGeneratingSet().Group()
    except (RuntimeError, ValueError):
        G = G.SmallGeneratingSet().Group()
```

For some of my groups, the attempt to compute a minimal generating set fails, and if I understand correctly, the libgap wrapper would call sig_on(), then kindly ask libgap to compute the minimal generating set, and when this fails would not call sig_off() before raising a Python error.

EDIT: I tested and found that *this* is not giving a sig_on_count() failure. But I am now going through the actual tests of my applications and will hopefully be able to create a minimal example.



---

archive/issue_comments_370338.json:
```json
{
    "body": "Replying to [comment:4 SimonKing]:\n> if I understand correctly, the libgap wrapper would call sig_on(), then kindly ask libgap to compute the minimal generating set, and when this fails would not call sig_off() before raising a Python error.\n\nNo, the code that you posted in this ticket is correct in that sense. Libgap error handling in Sage uses `sig_error()` (see `error_handler` in `src/sage/libs/gap/util.pyx`). For that, there must *not* be a `sig_off()` call.\n\n> But I am now going through the actual tests of my applications and will hopefully be able to create a minimal example.\n\nPlease do.",
    "created_at": "2018-10-21T10:43:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370338",
    "user": "jdemeyer"
}
```

Replying to [comment:4 SimonKing]:
> if I understand correctly, the libgap wrapper would call sig_on(), then kindly ask libgap to compute the minimal generating set, and when this fails would not call sig_off() before raising a Python error.

No, the code that you posted in this ticket is correct in that sense. Libgap error handling in Sage uses `sig_error()` (see `error_handler` in `src/sage/libs/gap/util.pyx`). For that, there must *not* be a `sig_off()` call.

> But I am now going through the actual tests of my applications and will hopefully be able to create a minimal example.

Please do.



---

archive/issue_comments_370339.json:
```json
{
    "body": "Replying to [comment:5 jdemeyer]:\n> Replying to [comment:4 SimonKing]:\n> > if I understand correctly, the libgap wrapper would call sig_on(), then kindly ask libgap to compute the minimal generating set, and when this fails would not call sig_off() before raising a Python error.\n> \n> No, the code that you posted in this ticket is correct in that sense. Libgap error handling in Sage uses `sig_error()` (see `error_handler` in `src/sage/libs/gap/util.pyx`). For that, there must *not* be a `sig_off()` call.\n\nI see. In that case, my original assessment was very likely wrong. I have moved my cohomology programs from using gap-via-pexpect to using gap-via-libgap, and so it seemed very likely to me that the problem came from that move, even more so when it seemed to me that sig_off() was forgotten in basically all try-except-finally clauses in sage/libs/gap/*.\n\nCurrently, my smallest example triggering sig_on_count to complain is an example in which another library results in an error in an example that previously worked. So, very likely the wrong sig_on/off count comes from there, not from libgap.",
    "created_at": "2018-10-21T10:57:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370339",
    "user": "SimonKing"
}
```

Replying to [comment:5 jdemeyer]:
> Replying to [comment:4 SimonKing]:
> > if I understand correctly, the libgap wrapper would call sig_on(), then kindly ask libgap to compute the minimal generating set, and when this fails would not call sig_off() before raising a Python error.
> 
> No, the code that you posted in this ticket is correct in that sense. Libgap error handling in Sage uses `sig_error()` (see `error_handler` in `src/sage/libs/gap/util.pyx`). For that, there must *not* be a `sig_off()` call.

I see. In that case, my original assessment was very likely wrong. I have moved my cohomology programs from using gap-via-pexpect to using gap-via-libgap, and so it seemed very likely to me that the problem came from that move, even more so when it seemed to me that sig_off() was forgotten in basically all try-except-finally clauses in sage/libs/gap/*.

Currently, my smallest example triggering sig_on_count to complain is an example in which another library results in an error in an example that previously worked. So, very likely the wrong sig_on/off count comes from there, not from libgap.



---

archive/issue_comments_370340.json:
```json
{
    "body": "Replying to [comment:6 SimonKing]:\n> Currently, my smallest example triggering sig_on_count to complain is an example in which another library results in an error in an example that previously worked. So, very likely the wrong sig_on/off count comes from there, not from libgap.\n\nActually it seems that the problem rather lies in the SharedMeatAxe wrapper, not in the libgap wrapper. Namely, when wrapped libmtx functions are called, they are encapsulated into sig_on/sig_off, but the wrapper also translates propagated C errors into Python errors. So, presumable when such error is raised, sig_off ought to be called.\n\nQuestion on the way to proceed:\n- Change the topic of this ticket from libgap wrapper to libmtx wrapper?\n- Resolve this ticket as \"invalid/won't fix\" and open a new ticket addressing the libmtx wrapper?",
    "created_at": "2018-10-21T11:34:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370340",
    "user": "SimonKing"
}
```

Replying to [comment:6 SimonKing]:
> Currently, my smallest example triggering sig_on_count to complain is an example in which another library results in an error in an example that previously worked. So, very likely the wrong sig_on/off count comes from there, not from libgap.

Actually it seems that the problem rather lies in the SharedMeatAxe wrapper, not in the libgap wrapper. Namely, when wrapped libmtx functions are called, they are encapsulated into sig_on/sig_off, but the wrapper also translates propagated C errors into Python errors. So, presumable when such error is raised, sig_off ought to be called.

Question on the way to proceed:
- Change the topic of this ticket from libgap wrapper to libmtx wrapper?
- Resolve this ticket as "invalid/won't fix" and open a new ticket addressing the libmtx wrapper?



---

archive/issue_comments_370341.json:
```json
{
    "body": "Technical question about sig_on/sig_off, sig_check, and sig_error.\n\nAssume that in the error handler of the libmtx wrapper I call sig_error, similar to what is done in the case of libgap. Would it be needed to henceforth only use sig_on/sig_off, but not sig_check? Namely, when calling sig_error, it is required that sig_on has been called before.\n\nAnd if that's really the case, then maybe it would be good to know about the use cases of the different sig_* functions. So far, I thought it is like this:\n- Use sig_on/sig_off arount a library call that potentially takes a long time.\n- Use sig_check when there is a tight loop involving library calls, as that's faster than sig_on/sig_off.\n- I didn't know at all about sig_error.\n\nSo, is it really the case that I have to accept the slow-down that comes from being forced to use sig_on/off instead of sig_check?\n\nIn any case, I realised that I need to go through matrix_gfpn_dense, as there are many library calls that are in fact not wrapped into sig_on/off pairs.",
    "created_at": "2018-10-21T13:27:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370341",
    "user": "SimonKing"
}
```

Technical question about sig_on/sig_off, sig_check, and sig_error.

Assume that in the error handler of the libmtx wrapper I call sig_error, similar to what is done in the case of libgap. Would it be needed to henceforth only use sig_on/sig_off, but not sig_check? Namely, when calling sig_error, it is required that sig_on has been called before.

And if that's really the case, then maybe it would be good to know about the use cases of the different sig_* functions. So far, I thought it is like this:
- Use sig_on/sig_off arount a library call that potentially takes a long time.
- Use sig_check when there is a tight loop involving library calls, as that's faster than sig_on/sig_off.
- I didn't know at all about sig_error.

So, is it really the case that I have to accept the slow-down that comes from being forced to use sig_on/off instead of sig_check?

In any case, I realised that I need to go through matrix_gfpn_dense, as there are many library calls that are in fact not wrapped into sig_on/off pairs.



---

archive/issue_comments_370342.json:
```json
{
    "body": "Replying to [comment:8 SimonKing]:\n> Technical question about sig_on/sig_off, sig_check, and sig_error.\n> \n> Assume that in the error handler of the libmtx wrapper I call sig_error, similar to what is done in the case of libgap. Would it be needed to henceforth only use sig_on/sig_off, but not sig_check? Namely, when calling sig_error, it is required that sig_on has been called before.\n\nAbsolutely.\n\n> And if that's really the case, then maybe it would be good to know about the use cases of the different sig_* functions. So far, I thought it is like this:\n> - Use sig_on/sig_off arount a library call that potentially takes a long time.\n> - Use sig_check when there is a tight loop involving library calls, as that's faster than sig_on/sig_off.\n\nThat's more or less correct.\n\n> - I didn't know at all about sig_error.\n\n`sig_error` is quite specialized to handle errors from a C library in a callback. But for SharedMeatAxe, this doesn't seem to be needed since it has a way to deal with errors already.\n\nConclusion: the best solution is probably to wrap errors from SharedMeatAxe as\n\n```\nsig_on()\ntry:\n    # MeatAxe call which might raise a Python exception\nfinally:\n    sig_off()\n```\n",
    "created_at": "2018-10-21T16:05:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370342",
    "user": "jdemeyer"
}
```

Replying to [comment:8 SimonKing]:
> Technical question about sig_on/sig_off, sig_check, and sig_error.
> 
> Assume that in the error handler of the libmtx wrapper I call sig_error, similar to what is done in the case of libgap. Would it be needed to henceforth only use sig_on/sig_off, but not sig_check? Namely, when calling sig_error, it is required that sig_on has been called before.

Absolutely.

> And if that's really the case, then maybe it would be good to know about the use cases of the different sig_* functions. So far, I thought it is like this:
> - Use sig_on/sig_off arount a library call that potentially takes a long time.
> - Use sig_check when there is a tight loop involving library calls, as that's faster than sig_on/sig_off.

That's more or less correct.

> - I didn't know at all about sig_error.

`sig_error` is quite specialized to handle errors from a C library in a callback. But for SharedMeatAxe, this doesn't seem to be needed since it has a way to deal with errors already.

Conclusion: the best solution is probably to wrap errors from SharedMeatAxe as

```
sig_on()
try:
    # MeatAxe call which might raise a Python exception
finally:
    sig_off()
```




---

archive/issue_comments_370343.json:
```json
{
    "body": "Replying to [comment:8 SimonKing]:\n> - Use sig_check when there is a tight loop involving library calls, as that's faster than sig_on/sig_off.\n\nActually, a more important reason is not so much that it's faster but safer too. `sig_on()`/`sig_off()` is really \"use this only when you really know what you are doing\" while `sig_check()` is pretty foolproof.",
    "created_at": "2018-10-21T16:07:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370343",
    "user": "jdemeyer"
}
```

Replying to [comment:8 SimonKing]:
> - Use sig_check when there is a tight loop involving library calls, as that's faster than sig_on/sig_off.

Actually, a more important reason is not so much that it's faster but safer too. `sig_on()`/`sig_off()` is really "use this only when you really know what you are doing" while `sig_check()` is pretty foolproof.



---

archive/issue_comments_370344.json:
```json
{
    "body": "I suppose changing title and description means I should use **this** ticket to fix the libmtx wrapper, rather than create a new ticket.\n\nReplying to [comment:9 jdemeyer]:\n> `sig_error` is quite specialized to handle errors from a C library in a callback. But for SharedMeatAxe, this doesn't seem to be needed since it has a way to deal with errors already.\n\nIn SharedMeatAxe, in contrast to MeatAxe, I am consequently propagating error values, so that a program calling a library function can take proper action when an error occurs. MeatAxe does make it possible to have a custom error handler, which I am using here of course.\n\nMaybe I am misunderstanding the role of sig_*. Namely, the library functions have an error return value, and Cython knows about it (it is declared in the .pxd files). So, a Python error is raised regardless whether sig_on/sig_off is involved or not.\n\nIs it correct that the only added bonus of using sig_on/sig_off is that the user can interrupt with ctrl-c?",
    "created_at": "2018-10-21T16:56:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370344",
    "user": "SimonKing"
}
```

I suppose changing title and description means I should use **this** ticket to fix the libmtx wrapper, rather than create a new ticket.

Replying to [comment:9 jdemeyer]:
> `sig_error` is quite specialized to handle errors from a C library in a callback. But for SharedMeatAxe, this doesn't seem to be needed since it has a way to deal with errors already.

In SharedMeatAxe, in contrast to MeatAxe, I am consequently propagating error values, so that a program calling a library function can take proper action when an error occurs. MeatAxe does make it possible to have a custom error handler, which I am using here of course.

Maybe I am misunderstanding the role of sig_*. Namely, the library functions have an error return value, and Cython knows about it (it is declared in the .pxd files). So, a Python error is raised regardless whether sig_on/sig_off is involved or not.

Is it correct that the only added bonus of using sig_on/sig_off is that the user can interrupt with ctrl-c?



---

archive/issue_comments_370345.json:
```json
{
    "body": "Replying to [comment:11 SimonKing]:\n> Is it correct that the only added bonus of using sig_on/sig_off is that the user can interrupt with ctrl-c?\n\nYes.",
    "created_at": "2018-10-21T17:10:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370345",
    "user": "jdemeyer"
}
```

Replying to [comment:11 SimonKing]:
> Is it correct that the only added bonus of using sig_on/sig_off is that the user can interrupt with ctrl-c?

Yes.



---

archive/issue_comments_370346.json:
```json
{
    "body": "Replying to [comment:12 jdemeyer]:\n> Replying to [comment:11 SimonKing]:\n> > Is it correct that the only added bonus of using sig_on/sig_off is that the user can interrupt with ctrl-c?\n> \n> Yes.\n\nOK, in that case I should use\n\n```\nsig_on()\ntry:\n    <library call>\nfinally:\n    sig_off()\n```\n\nonly for functions that potentially run long enough so that it makes sense for them being interruptible.",
    "created_at": "2018-10-21T17:12:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370346",
    "user": "SimonKing"
}
```

Replying to [comment:12 jdemeyer]:
> Replying to [comment:11 SimonKing]:
> > Is it correct that the only added bonus of using sig_on/sig_off is that the user can interrupt with ctrl-c?
> 
> Yes.

OK, in that case I should use

```
sig_on()
try:
    <library call>
finally:
    sig_off()
```

only for functions that potentially run long enough so that it makes sense for them being interruptible.



---

archive/issue_comments_370347.json:
```json
{
    "body": "Is it ok if Python stuff happens between sig_on and sig_off, such as\n\n```python\n        try:\n            mat = MatAlloc(self.Data.Field, self._nrows, right._ncols)\n            MatMulStrassen(mat, self.Data, right.Data)\n            return new_mtx(mat, self)\n        finally:\n            sig_off()\n```\n\n?\n\nOr should, in particular, return statements happen *after* the `finally: sig_off()'?",
    "created_at": "2018-10-21T17:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370347",
    "user": "SimonKing"
}
```

Is it ok if Python stuff happens between sig_on and sig_off, such as

```python
        try:
            mat = MatAlloc(self.Data.Field, self._nrows, right._ncols)
            MatMulStrassen(mat, self.Data, right.Data)
            return new_mtx(mat, self)
        finally:
            sig_off()
```

?

Or should, in particular, return statements happen *after* the `finally: sig_off()'?



---

archive/issue_comments_370348.json:
```json
{
    "body": "Replying to [comment:14 SimonKing]:\n> Is it ok if Python stuff happens between sig_on and sig_off\n\nYou should try hard to avoid that as it's unsafe.\n\n> Or should, in particular, return statements happen *after* the `finally: sig_off()'?\n\nThere is nothing in particular about `return` statements. There just shouldn't be any kind of Python object manipulation (especially no creation of new Python objects).",
    "created_at": "2018-10-21T18:29:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370348",
    "user": "jdemeyer"
}
```

Replying to [comment:14 SimonKing]:
> Is it ok if Python stuff happens between sig_on and sig_off

You should try hard to avoid that as it's unsafe.

> Or should, in particular, return statements happen *after* the `finally: sig_off()'?

There is nothing in particular about `return` statements. There just shouldn't be any kind of Python object manipulation (especially no creation of new Python objects).



---

archive/issue_comments_370349.json:
```json
{
    "body": "Replying to [comment:15 jdemeyer]:\n> Replying to [comment:14 SimonKing]:\n> > Is it ok if Python stuff happens between sig_on and sig_off\n> \n> You should try hard to avoid that as it's unsafe.\n> \n> > Or should, in particular, return statements happen *after* the `finally: sig_off()'?\n> \n> There is nothing in particular about `return` statements. There just shouldn't be any kind of Python object manipulation (especially no creation of new Python objects).\n\nGood, then I guess the following is bad, as `new_mtx` creates a python object (namely: a !Matrix_gfpn_dense):\n\n```python\n        sig_on()\n        try:\n            mat = MatAlloc(self.Data.Field, self.Data.Nor+other.Data.Nor, self.Data.Noc)\n            memcpy(mat.Data, self.Data.Data, FfCurrentRowSize*self.Data.Nor)\n            memcpy(MatGetPtr(mat, self.Data.Nor), other.Data.Data, FfCurrentRowSize*other.Data.Nor)\n            return new_mtx(mat, self)\n        finally:\n            sig_off()\n```\n",
    "created_at": "2018-10-21T19:07:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370349",
    "user": "SimonKing"
}
```

Replying to [comment:15 jdemeyer]:
> Replying to [comment:14 SimonKing]:
> > Is it ok if Python stuff happens between sig_on and sig_off
> 
> You should try hard to avoid that as it's unsafe.
> 
> > Or should, in particular, return statements happen *after* the `finally: sig_off()'?
> 
> There is nothing in particular about `return` statements. There just shouldn't be any kind of Python object manipulation (especially no creation of new Python objects).

Good, then I guess the following is bad, as `new_mtx` creates a python object (namely: a !Matrix_gfpn_dense):

```python
        sig_on()
        try:
            mat = MatAlloc(self.Data.Field, self.Data.Nor+other.Data.Nor, self.Data.Noc)
            memcpy(mat.Data, self.Data.Data, FfCurrentRowSize*self.Data.Nor)
            memcpy(MatGetPtr(mat, self.Data.Nor), other.Data.Data, FfCurrentRowSize*other.Data.Nor)
            return new_mtx(mat, self)
        finally:
            sig_off()
```




---

archive/issue_comments_370350.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-10-21T21:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370350",
    "user": "SimonKing"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_370351.json:
```json
{
    "body": "I am sorry that I cannot provide a new test, but I think the code is a bit safer now.\n----\nNew commits:",
    "created_at": "2018-10-21T21:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370351",
    "user": "SimonKing"
}
```

I am sorry that I cannot provide a new test, but I think the code is a bit safer now.
----
New commits:



---

archive/issue_comments_370352.json:
```json
{
    "body": "I assume that you actually tested this? No patchbot with meataxe has tested this so far.",
    "created_at": "2018-10-24T09:34:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370352",
    "user": "jdemeyer"
}
```

I assume that you actually tested this? No patchbot with meataxe has tested this so far.



---

archive/issue_comments_370353.json:
```json
{
    "body": "It would be safer to do `self._converter.field_to_int` calls outside of `sig_on`, as that involves Python calls.\n\nWhile looking at that code, I also noticed a potential bug: #26546",
    "created_at": "2018-10-24T09:45:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370353",
    "user": "jdemeyer"
}
```

It would be safer to do `self._converter.field_to_int` calls outside of `sig_on`, as that involves Python calls.

While looking at that code, I also noticed a potential bug: #26546



---

archive/issue_comments_370354.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-10-24T09:46:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370354",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_370355.json:
```json
{
    "body": "I suggest to base this on top of #26546",
    "created_at": "2018-10-24T09:55:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370355",
    "user": "SimonKing"
}
```

I suggest to base this on top of #26546



---

archive/issue_comments_370356.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-03T11:38:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370356",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_370357.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-11-03T11:56:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370357",
    "user": "SimonKing"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_370358.json:
```json
{
    "body": "While merging with #26546 I had to resolve a couple of conflicts. Now all tests pass, I think that the usage of sig_on/sig_off is safer, and thus it is ready for review.",
    "created_at": "2018-11-03T11:56:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370358",
    "user": "SimonKing"
}
```

While merging with #26546 I had to resolve a couple of conflicts. Now all tests pass, I think that the usage of sig_on/sig_off is safer, and thus it is ready for review.



---

archive/issue_comments_370359.json:
```json
{
    "body": "I'd rather review this after the dependency has actually been merged. Feel free to remind me when that happens.",
    "created_at": "2018-11-05T08:44:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370359",
    "user": "jdemeyer"
}
```

I'd rather review this after the dependency has actually been merged. Feel free to remind me when that happens.



---

archive/issue_comments_370360.json:
```json
{
    "body": "on this branch with installed meataxe, and #22626 and #26856, merged all the tests pass.",
    "created_at": "2018-12-30T16:19:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370360",
    "user": "dimpase"
}
```

on this branch with installed meataxe, and #22626 and #26856, merged all the tests pass.



---

archive/issue_comments_370361.json:
```json
{
    "body": "Replying to [comment:25 jdemeyer]:\n> I'd rather review this after the dependency has actually been merged. Feel free to remind me when that happens.\n\nReplying to [comment:26 dimpase]:\n> on this branch with installed meataxe, and #22626 and #26856, merged all the tests pass. \n\nIs that the reminder? `;-)`",
    "created_at": "2018-12-30T16:57:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370361",
    "user": "SimonKing"
}
```

Replying to [comment:25 jdemeyer]:
> I'd rather review this after the dependency has actually been merged. Feel free to remind me when that happens.

Replying to [comment:26 dimpase]:
> on this branch with installed meataxe, and #22626 and #26856, merged all the tests pass. 

Is that the reminder? `;-)`



---

archive/issue_comments_370362.json:
```json
{
    "body": "Rebased to 8.6.beta0 and put back this comment (assuming that it was removed by accident)\n\n```diff\n-            # Inverting a singular matrix causes MatInverse to raise a\n-            # ZeroDivisionError (see sage_meataxe_error_handler).\n-            # So we need to support exceptions here.\n```\n\n----\nNew commits:",
    "created_at": "2018-12-30T20:53:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370362",
    "user": "jdemeyer"
}
```

Rebased to 8.6.beta0 and put back this comment (assuming that it was removed by accident)

```diff
-            # Inverting a singular matrix causes MatInverse to raise a
-            # ZeroDivisionError (see sage_meataxe_error_handler).
-            # So we need to support exceptions here.
```

----
New commits:



---

archive/issue_comments_370363.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-06T08:27:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370363",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_370364.json:
```json
{
    "body": "Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.",
    "created_at": "2019-01-15T18:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370364",
    "user": "embray"
}
```

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.



---

archive/issue_comments_370365.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-01-23T14:17:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26279",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26279#issuecomment-370365",
    "user": "vbraun"
}
```

Resolution: fixed
