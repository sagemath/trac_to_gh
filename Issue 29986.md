# Issue 29986: Combinatorial designs: generate GQ with spread

Issue created by migration from https://trac.sagemath.org/ticket/30223

Original creator: @Ivo-Maffei

Original creation time: 2020-07-26 11:13:24

CC:  dimpase

Keywords: generalised_quadrangle

Implement a few functions to generate and work on generalised quadrangles with spreads


---

Comment by @Ivo-Maffei created at 2020-07-26 11:17:15

At the moment the examples at the top of the file fail and they shouldn't.
In particular using the objects defined there one gets:

```
sage: set(GQ2._points) == set(range(1,1106))
False
sage: for i in GQ2._points:
....:     if i not in range(1,1106):
....:         print(i)
....:         
sage: for i in range(1,1106):
....:     if i not in GQ2._points:
....:         print(i)
....:      
sage:
```

I wonder if I'm missing something or if `==` is returning some weird output.


---

Comment by slelievre created at 2020-07-26 13:06:06

Minor suggestions, no hurry.


```
-- YOUR NAME (2005-01-03): initial version
+- Ivo Maffei (2020-07-26): initial version
```



```
-#       Copyright (C) 2013 IVO MAFFEI <ivomaffei@gmail.com>
+#       Copyright (C) 2013 Ivo Maffei <ivomaffei@gmail.com>
```



```
-    Construct the generalised quadrangle `H(3,q^2)` with an ovoid
-    The GQ has order `(q^2,q)`
+    Construct the generalised quadrangle `H(3,q^2)` with an ovoid.
+
+    The GQ has order `(q^2,q)`.
```



---

Comment by slelievre created at 2020-07-26 13:06:06

Changing type from PLEASE CHANGE to enhancement.


---

Comment by dimpase created at 2020-07-26 22:33:47

Replying to [comment:1 gh-Ivo-Maffei]:
> At the moment the examples at the top of the file fail and they shouldn't.
> In particular using the objects defined there one gets:
> {{{
> sage: set(GQ2._points) == set(range(1,1106))
> False
> sage: for i in GQ2._points:
> ....:     if i not in range(1,1106):
> ....:         print(i)
> ....:         
> sage: for i in range(1,1106):
> ....:     if i not in GQ2._points:
> ....:         print(i)
> ....:      
> sage:
> }}}
> I wonder if I'm missing something or if `==` is returning some weird output.

`set(GQ2._points)` consists of GAP's  Integers, but in `range(1,1106)` you have Python `<int>`.

There is no automatic conversion between these set elements when you compare them:

```
sage: libgap(1)==int(1)
True
sage: type(libgap(1))
<class 'sage.libs.gap.element.GapElement_Integer'>
sage: set([libgap(1)])==set([int(1)])
False
```



---

Comment by git created at 2020-07-27 08:52:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @Ivo-Maffei created at 2020-07-27 08:53:37

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-08-11 13:56:22

where is this supposed to be used?


---

Comment by @Ivo-Maffei created at 2020-08-11 16:08:33

The point graph of a GQ removed its spread is distance-regular. It's shown in BCN 12.5.
I haven't yet made a ticket that puts the required code in distance_regular.pyx.


---

Comment by dimpase created at 2020-08-22 10:26:46

The description of 
https://en.wikipedia.org/wiki/Generalized_quadrangle

How about renaming gen_quadrangles.pyx to gen_quadrangles_with_spread.pyx

Also, `generalised_quadrangle_hermitian` should be renamed to something like
`generalised_quadrangle_hermitian_with_ovoid`

Perhaps it makes sense to introduce spreads for general Sage's incidence systems
(sets of blocks that don't pairwise intersect and cover all the points) - then spreads here will be a particular case.


---

Comment by @Ivo-Maffei created at 2020-08-22 10:54:23

Replying to [comment:8 dimpase]:
> Perhaps it makes sense to introduce spreads for general Sage's incidence systems
> (sets of blocks that don't pairwise intersect and cover all the points) - then spreads here will be a particular case.
Do you have any idea on how to do so? We could add a field to the `IncidenceStructure` class or make a subclass `IncidenceStructureWithSpread`...


---

Comment by dimpase created at 2020-08-22 11:57:01

I meant a member function that verifies that a given set of blocks is a spread.


---

Comment by git created at 2020-08-22 13:52:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-08-24 17:42:39

I get a memory error here:

```
File "src/sage/combinat/designs/gen_quadrangles_with_spread.pyx", line 257, in sage.combinat.designs.gen_quadrangles_with_spread.generalised_quadrangle_hermitian_with_ovoid
Failed example:
    t[0].is_generalized_quadrangle()  # long time
Exception raised:
...
```

and even worse crash (Bad Exit) here:

```
File "src/sage/combinat/designs/gen_quadrangles_with_spread.pyx", line 271, in sage.combinat.designs.gen_quadrangles_with_spread.generalised_quadrangle_hermitian_with_ovoid
Failed example:
    is_GQ_with_spread(*t, s=3, t=9)
Exception raised:
...
```



---

Comment by @Ivo-Maffei created at 2020-08-25 09:23:01

I merged 9.2.beta10 and tried both:

```
sage -tp src/sage/combinat/designs/gen_quadrangles_with_spread.pyx
sage -tp --long src/sage/combinat/designs/gen_quadrangles_with_spread.pyx
```


They both terminate with all tests passed.
Could you try again with the merged branch and post the traceback?


---

Comment by git created at 2020-08-25 09:23:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-08-25 22:15:53

The non-long tests pass, but the long ones end up with

```
$ ./sage -tp 1 --long src/sage/combinat/designs/gen_quadrangles_with_spread.pyx 2>&1 >/tmp/p
Process DocTestWorker-1:
Traceback (most recent call last):
  File "/usr/lib/python3.7/multiprocessing/process.py", line 297, in _bootstrap
    self.run()
  File "/mnt/opt/Sage/sage-dev/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2185, in run
    task(self.options, self.outtmpfile, msgpipe, self.result_queue)
  File "/mnt/opt/Sage/sage-dev/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 2535, in __call__
    result_queue.put(result, False)
  File "/usr/lib/python3.7/multiprocessing/queues.py", line 87, in put
    self._start_thread()
  File "/usr/lib/python3.7/multiprocessing/queues.py", line 170, in _start_thread
    self._thread.start()
  File "/usr/lib/python3.7/threading.py", line 852, in start
    _start_new_thread(self._bootstrap, ())
RuntimeError: can't start new thread
```

in 

```
sage: t[0].is_generalized_quadrangle()  # long time ## line 257 ##
```


This seems to be limited to this machine, though. If I run the test in question at the Sage prompt
it takes about 30 sec and takes a lot of RAM.
A much quicker test for t[0] being GQ(16,4) is to look at the dual graph

```
sage: tt=t[0]                                                                                                                        
sage: ig=tt.intersection_graph([1])                                                                                                  
sage: ig.is_strongly_regular(parameters=True)                                                                                        
(325, 68, 3, 17)
sage: set(tt.block_sizes())                                                                                                          
{17}
```

Indeed, we got the collinearity graph of GQ(s,t)=GQ(4,16), as 68=s(t+1)=4*17, lambda=s-1=3, mu=t+1=17, and each of 325 blocks has size 17 (i.e. dually each of the 325 points has 17 blocks
of size s+1=5 on it).


---

Comment by dimpase created at 2020-08-25 22:15:53

Changing status from needs_review to positive_review.


---

Comment by git created at 2020-08-26 06:47:36

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2020-08-26 06:47:36

Changing status from positive_review to needs_review.


---

Comment by dimpase created at 2020-08-26 07:21:01

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-08-26 07:21:01

perhaps on another ticket one should change the is_generalised_quadrangle to use this approach, it is faster.


---

Comment by dimpase created at 2020-08-26 13:40:24

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2020-08-26 13:40:24

I spoke too soon - docs don't build:

```
...
[dochtml] [combinat ] The inventory files are in local/share/doc/sage/inventory/en/reference/combinat.
[dochtml] Error building the documentation.
[dochtml] Traceback (most recent call last):
[dochtml]   File "/usr/lib/python3.7/runpy.py", line 193, in _run_module_as_main
[dochtml]     "__main__", mod_spec)
[dochtml]   File "/usr/lib/python3.7/runpy.py", line 85, in _run_code
[dochtml]     exec(code, run_globals)
[dochtml]   File "/mnt/opt/Sage/sage-dev/local/lib/python3.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
[dochtml]     main()
[dochtml]   File "/mnt/opt/Sage/sage-dev/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 1721, in main
[dochtml]     builder()
[dochtml]   File "/mnt/opt/Sage/sage-dev/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 328, in _wrapper
[dochtml]     getattr(get_builder(document), 'inventory')(*args, **kwds)
[dochtml]   File "/mnt/opt/Sage/sage-dev/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 553, in _wrapper
[dochtml]     self._build_everything_except_bibliography(lang, format, *args, **kwds)
[dochtml]   File "/mnt/opt/Sage/sage-dev/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 539, in _build_everything_except_bibliography
[dochtml]     build_many(build_ref_doc, non_references)
[dochtml]   File "/mnt/opt/Sage/sage-dev/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 281, in build_many
[dochtml]     _build_many(target, args, processes=NUM_THREADS)
[dochtml]   File "/mnt/opt/Sage/sage-dev/local/lib/python3.7/site-packages/sage_setup/docbuild/utils.py", line 283, in build_many
[dochtml]     raise worker_exc.original_exception
[dochtml] OSError: WARNING: autodoc: failed to import module 'gen_quadrangles' from module 'sage.combinat.designs'; the following exception was raised:
make[3]: *** [Makefile:1866: doc-html] Error 1
```



---

Comment by dimpase created at 2020-08-26 13:57:19

I suppose one needs

```diff
diff --git a/src/doc/en/reference/combinat/module_list.rst b/src/doc/en/reference/combinat/module_list.rst
index 39ca27c4a6..c8eca43954 100644
--- a/src/doc/en/reference/combinat/module_list.rst
+++ b/src/doc/en/reference/combinat/module_list.rst
@@ -104,7 +104,7 @@ Comprehensive Module list
     sage/combinat/designs/difference_matrices
     sage/combinat/designs/evenly_distributed_sets
     sage/combinat/designs/ext_rep
-    sage/combinat/designs/gen_quadrangles
+    sage/combinat/designs/gen_quadrangles_with_spread
     sage/combinat/designs/incidence_structures
     sage/combinat/designs/latin_squares
     sage/combinat/designs/orthogonal_arrays
diff --git a/src/sage/combinat/designs/__init__.py b/src/sage/combinat/designs/__init__.py
index f8de34936f..4808cf1a55 100644
--- a/src/sage/combinat/designs/__init__.py
+++ b/src/sage/combinat/designs/__init__.py
@@ -27,7 +27,7 @@ design catalog:
 - :ref:`sage.combinat.designs.steiner_quadruple_systems`
 - :ref:`sage.combinat.designs.twographs`
 - :ref:`sage.combinat.designs.database`
-- :ref:`sage.combinat.designs.gen_quadrangles`
+- :ref:`sage.combinat.designs.gen_quadrangles_with_spread`
 
 **Technical things**
 
diff --git a/src/sage/combinat/designs/design_catalog.py b/src/sage/combinat/designs/design_catalog.py
index 3a3c11597a..a9572e119c 100644
--- a/src/sage/combinat/designs/design_catalog.py
+++ b/src/sage/combinat/designs/design_catalog.py
@@ -59,7 +59,7 @@ This module gathers the following designs:
     :meth:`~sage.combinat.designs.steiner_quadruple_systems.steiner_quadruple_system`
     :meth:`~sage.combinat.designs.block_design.projective_plane`
     :meth:`~sage.combinat.designs.biplane`
-    :meth:`~sage.combinat.designs.gen_quadrangles`
+    :meth:`~sage.combinat.designs.gen_quadrangles_with_spread`
 
 And the :meth:`designs.best_known_covering_design_from_LJCR
 <sage.combinat.designs.covering_design.best_known_covering_design_www>` function
```



---

Comment by git created at 2020-08-26 14:13:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @Ivo-Maffei created at 2020-08-26 14:16:10

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2020-08-26 14:30:21

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-08-30 08:39:03

Resolution: fixed


---

Comment by vdelecroix created at 2020-09-03 09:47:01

Replying to [comment:3 dimpase]:
> Replying to [comment:1 gh-Ivo-Maffei]:
> > At the moment the examples at the top of the file fail and they shouldn't.
> > In particular using the objects defined there one gets:
> > {{{
> > sage: set(GQ2._points) == set(range(1,1106))
> > False
> > sage: for i in GQ2._points:
> > ....:     if i not in range(1,1106):
> > ....:         print(i)
> > ....:         
> > sage: for i in range(1,1106):
> > ....:     if i not in GQ2._points:
> > ....:         print(i)
> > ....:      
> > sage:
> > }}}
> > I wonder if I'm missing something or if `==` is returning some weird output.
> 
> `set(GQ2._points)` consists of GAP's  Integers, but in `range(1,1106)` you have Python `<int>`.
> 
> There is no automatic conversion between these set elements when you compare them:
> {{{
> sage: libgap(1)==int(1)
> True
> sage: type(libgap(1))
> <class 'sage.libs.gap.element.GapElement_Integer'>
> sage: set([libgap(1)])==set([int(1)])
> False
> }}}
> 
> 

To my mind this is a serious issue, see #30498.
