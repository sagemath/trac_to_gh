# Issue 31302: conda-forge-standard (linux): python3 spkg-configure.m4 rejects conda's python3

archive/issues_031302.json:
```json
{
    "body": "CC:  @isuruf @videlec @dimpase\n\n\n```\nChecking whether SageMath should install SPKG python3...\nchecking whether any of bzip2 xz libffi is installed as or will be installed as SPKG... no\nchecking for python3 >= 3.6.0, < 3.10.0 with modules sqlite3, ctypes, math, hashlib, crypt, readline, socket, zlib, distutils.core... \nchecking ... whether /opt/conda/bin/python3 is good... no, this is a misconfigured Python whose sysconfig compiler/linker flags contain -I or -L options, which may cause wrong versions of libraries to leak into the build of Python packages - see https://trac.sagemath.org/ticket/31132; to use it anyway, use ./configure --with-python=/opt/conda/bin/python3\nchecking ... whether /opt/conda/bin/python3 is good... no, this is a misconfigured Python whose sysconfig compiler/linker flags contain -I or -L options, which may cause wrong versions of libraries to leak into the build of Python packages - see https://trac.sagemath.org/ticket/31132; to use it anyway, use ./configure --with-python=/opt/conda/bin/python3\n\nconfigure: to try to use a different system python, use ./configure --with-python=/path/to/python\nconfigure: no suitable system package found for SPKG python3\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/31539\n\n",
    "created_at": "2021-03-22T21:58:41Z",
    "labels": [
        "component: build: configure",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "conda-forge-standard (linux): python3 spkg-configure.m4 rejects conda's python3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31302",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @isuruf @videlec @dimpase


```
Checking whether SageMath should install SPKG python3...
checking whether any of bzip2 xz libffi is installed as or will be installed as SPKG... no
checking for python3 >= 3.6.0, < 3.10.0 with modules sqlite3, ctypes, math, hashlib, crypt, readline, socket, zlib, distutils.core... 
checking ... whether /opt/conda/bin/python3 is good... no, this is a misconfigured Python whose sysconfig compiler/linker flags contain -I or -L options, which may cause wrong versions of libraries to leak into the build of Python packages - see https://trac.sagemath.org/ticket/31132; to use it anyway, use ./configure --with-python=/opt/conda/bin/python3
checking ... whether /opt/conda/bin/python3 is good... no, this is a misconfigured Python whose sysconfig compiler/linker flags contain -I or -L options, which may cause wrong versions of libraries to leak into the build of Python packages - see https://trac.sagemath.org/ticket/31132; to use it anyway, use ./configure --with-python=/opt/conda/bin/python3

configure: to try to use a different system python, use ./configure --with-python=/path/to/python
configure: no suitable system package found for SPKG python3
```


Issue created by migration from https://trac.sagemath.org/ticket/31539





---

archive/issue_comments_447009.json:
```json
{
    "body": "On this system, `python3 -m sysconfig` gives\n`LDFLAGS = \"-Wl,-O2 -Wl,--sort-common -Wl,--as-needed -Wl,-z,relro -Wl,-z,now -Wl,--disable-new-dtags -Wl,--gc-sections -Wl,-rpath,/opt/conda/lib -Wl,-rpath-link,/opt/conda/lib -L/opt/conda/lib -Wl,-O2 -Wl,--sort-common -Wl,--as-needed -Wl,-z,relro -Wl,-z,now -Wl,--disable-new-dtags -Wl,--gc-sections -Wl,-rpath,/opt/conda/lib -Wl,-rpath-link,/opt/conda/lib -L/opt/conda/lib\"`\n\nIt is the `-L/opt/conda/lib` that our `configure` is unhappy about.",
    "created_at": "2021-03-24T06:07:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31302#issuecomment-447009",
    "user": "https://github.com/mkoeppe"
}
```

On this system, `python3 -m sysconfig` gives
`LDFLAGS = "-Wl,-O2 -Wl,--sort-common -Wl,--as-needed -Wl,-z,relro -Wl,-z,now -Wl,--disable-new-dtags -Wl,--gc-sections -Wl,-rpath,/opt/conda/lib -Wl,-rpath-link,/opt/conda/lib -L/opt/conda/lib -Wl,-O2 -Wl,--sort-common -Wl,--as-needed -Wl,-z,relro -Wl,-z,now -Wl,--disable-new-dtags -Wl,--gc-sections -Wl,-rpath,/opt/conda/lib -Wl,-rpath-link,/opt/conda/lib -L/opt/conda/lib"`

It is the `-L/opt/conda/lib` that our `configure` is unhappy about.



---

archive/issue_comments_447010.json:
```json
{
    "body": "Moving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31302#issuecomment-447010",
    "user": "https://github.com/mkoeppe"
}
```

Moving to 9.4, as 9.3 has been released.



---

archive/issue_comments_447011.json:
```json
{
    "body": "`@`isuruf wrote in https://groups.google.com/g/sage-devel/c/ZCjFpJGD-JA/m/5hOi6hcZBwAJ:\n> Looks like the check for misconfigured python is a little bit too extreme.\n> If sysconfig's CFLAGS includes any path in the environment's CFLAGS,\n> then it shouldn't be considered misconfigured.\n\nFrom the viewpoint of user installable Python packages, it is actually misconfigured, for the same reasons that led to the introduction of this check in #31132.\nThe -L options are in the front of the command line, and take precedence over any package-provided -L options that come in from the use of setuptools.",
    "created_at": "2021-06-28T22:31:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31302#issuecomment-447011",
    "user": "https://github.com/mkoeppe"
}
```

`@`isuruf wrote in https://groups.google.com/g/sage-devel/c/ZCjFpJGD-JA/m/5hOi6hcZBwAJ:
> Looks like the check for misconfigured python is a little bit too extreme.
> If sysconfig's CFLAGS includes any path in the environment's CFLAGS,
> then it shouldn't be considered misconfigured.

From the viewpoint of user installable Python packages, it is actually misconfigured, for the same reasons that led to the introduction of this check in #31132.
The -L options are in the front of the command line, and take precedence over any package-provided -L options that come in from the use of setuptools.



---

archive/issue_comments_447012.json:
```json
{
    "body": "From isuruf in #31132#comment:77:\n\n`-I` can't be stripped, but `-L` can be stripped by setting `LDSHARED` env variable. This would fix the conda-forge issue as conda-forge only use `-L` and doesn't use `-I`.",
    "created_at": "2021-09-25T01:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31302#issuecomment-447012",
    "user": "https://github.com/mkoeppe"
}
```

From isuruf in #31132#comment:77:

`-I` can't be stripped, but `-L` can be stripped by setting `LDSHARED` env variable. This would fix the conda-forge issue as conda-forge only use `-L` and doesn't use `-I`.



---

archive/issue_comments_447013.json:
```json
{
    "body": "A previous attempt to use `LDSHARED` were not successful in #29408.\nBut of course in the meantime the Xcode python3 has changed (it no longer seems to use `xcrun`) so this may be worth trying if it can be done without breaking another platform.\n\nHas there been a discussion in conda-forge regarding this misconfiguration of python3?",
    "created_at": "2021-09-25T01:58:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31302#issuecomment-447013",
    "user": "https://github.com/mkoeppe"
}
```

A previous attempt to use `LDSHARED` were not successful in #29408.
But of course in the meantime the Xcode python3 has changed (it no longer seems to use `xcrun`) so this may be worth trying if it can be done without breaking another platform.

Has there been a discussion in conda-forge regarding this misconfiguration of python3?



---

archive/issue_comments_447014.json:
```json
{
    "body": "> Has there been a discussion in conda-forge regarding this misconfiguration of python3? \n\nNope, but the use-case we have in sage is really a rare case because we usually don't want to override a library in a conda environment. Removing -L will cause more harm than good.\n\nSomething like below should give the LDSHARED to use and ldflags to append to LDFLAGS.\n\n\n```\nimport sysconfig\nimport os\nimport shlex\n\norig_ldshared = sysconfig.get_config_var(\"LDSHARED\")\norig_cc = sysconfig.get_config_var(\"CC\")\nif 'LDSHARED' in os.environ:\n    orig_ldshared = os.environ['LDSHARED']\nelif 'CC' in os.environ and orig_ldshared.startswith(orig_cc):\n    orig_ldshared = os.environ['CC'] + orig_ldshared[len(orig_cc):]\n\norig_ldshared = shlex.split(orig_ldshared)\nnew_ldshared = shlex.join(filter(lambda x: not x.startswith(\"-L\"), orig_ldshared))\nappend_ldflags = shlex.join(filter(lambda x: x.startswith(\"-L\"), orig_ldshared))\n\nprint(new_ldshared)\nprint(append_ldflags)\n```\n",
    "created_at": "2021-09-25T04:15:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31302#issuecomment-447014",
    "user": "https://github.com/isuruf"
}
```

> Has there been a discussion in conda-forge regarding this misconfiguration of python3? 

Nope, but the use-case we have in sage is really a rare case because we usually don't want to override a library in a conda environment. Removing -L will cause more harm than good.

Something like below should give the LDSHARED to use and ldflags to append to LDFLAGS.


```
import sysconfig
import os
import shlex

orig_ldshared = sysconfig.get_config_var("LDSHARED")
orig_cc = sysconfig.get_config_var("CC")
if 'LDSHARED' in os.environ:
    orig_ldshared = os.environ['LDSHARED']
elif 'CC' in os.environ and orig_ldshared.startswith(orig_cc):
    orig_ldshared = os.environ['CC'] + orig_ldshared[len(orig_cc):]

orig_ldshared = shlex.split(orig_ldshared)
new_ldshared = shlex.join(filter(lambda x: not x.startswith("-L"), orig_ldshared))
append_ldflags = shlex.join(filter(lambda x: x.startswith("-L"), orig_ldshared))

print(new_ldshared)
print(append_ldflags)
```




---

archive/issue_comments_447015.json:
```json
{
    "body": "`@`mkoeppe, would you be able to help with this? I don't have experience with writing\nautoconf scripts. Only experience in patching them. ;)",
    "created_at": "2021-09-29T07:11:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31302#issuecomment-447015",
    "user": "https://github.com/isuruf"
}
```

`@`mkoeppe, would you be able to help with this? I don't have experience with writing
autoconf scripts. Only experience in patching them. ;)



---

archive/issue_comments_447016.json:
```json
{
    "body": "Not clear from the ticket description whether this is a failure to accept a correct configuration,\nor there is more to fix than just this.\n\nIf the former, we can just waive Conda's Python3 python through, if we knew how to distinguish it.\n\nIs https://wiki.sagemath.org/Conda up to date?",
    "created_at": "2021-09-30T11:59:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31302#issuecomment-447016",
    "user": "https://github.com/dimpase"
}
```

Not clear from the ticket description whether this is a failure to accept a correct configuration,
or there is more to fix than just this.

If the former, we can just waive Conda's Python3 python through, if we knew how to distinguish it.

Is https://wiki.sagemath.org/Conda up to date?



---

archive/issue_comments_447017.json:
```json
{
    "body": "Replying to [comment:12 dimpase]:\n> Not clear from the ticket description \n... it should be clear from the comments above",
    "created_at": "2021-10-13T06:44:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31302#issuecomment-447017",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:12 dimpase]:
> Not clear from the ticket description 
... it should be clear from the comments above
