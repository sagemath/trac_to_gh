# Issue 12016: Bug in is_smooth for curves over CC

Issue created by migration from Trac.

Original creator: johanbosman

Original creation time: 2011-12-18 21:05:03

Assignee: AlexGhitza

CC:  burcin malb vbraun simonking nbruin

Keywords: singular


```
sage: P.<X,Y,Z> = CC[]
sage: C = Curve(X)
sage: C.is_smooth()
singular_ring_delete(ring*) called with NULL pointer.
...
Exception KeyError: (The ring pointer 0x0,) in 'sage.libs.singular.ring.singular_ring_delete' ignored
True
```



---

Comment by burcin created at 2011-12-18 23:35:19

I'm not sure if this is actually supposed to work in Sage right now. Multivariate polynomial rings over `CC` use a generic implementation. The error message should just say "First parameter's ring must be multivariate polynomial ring via libsingular." This is not entirely clear, but at least it is a less scary message than "singular_ring_delete(ring*) called with NULL pointer."

Here is a shorter segment to reproduce the problem:


```
sage: P.<X,Y,Z> = CC[]
sage: I = P*X
sage: GroebnerStrategy(I)
  File "/home/burcin/sage/sage-4.7.2/local/bin/sage-ipython", line 52, in <module>
    ipy_sage.mainloop(sys_exit=1, banner='')
  File "/home/burcin/sage/sage-4.7.2/local/lib/python2.6/site-packages/IPython/Shell.py", line 76, in mainloop
    self.IP.mainloop(banner)
  File "/home/burcin/sage/sage-4.7.2/local/lib/python2.6/site-packages/IPython/iplib.py", line 1762, in mainloop
    self.interact(banner)
  File "/home/burcin/sage/sage-4.7.2/local/lib/python2.6/site-packages/IPython/iplib.py", line 2001, in interact
    more = self.push(line)
  File "/home/burcin/sage/sage-4.7.2/local/lib/python2.6/site-packages/IPython/iplib.py", line 2305, in push
    more = self.runsource('\n'.join(self.buffer), self.filename)
  File "/home/burcin/sage/sage-4.7.2/local/lib/python2.6/site-packages/IPython/iplib.py", line 2231, in runsource
    if self.runcode(code) == 0:
  File "/home/burcin/sage/sage-4.7.2/local/lib/python2.6/site-packages/IPython/iplib.py", line 2260, in runcode
    exec code_obj in self.user_global_ns, self.user_ns
  File "<ipython console>", line 1, in <module>
Exception KeyError: (The ring pointer 0x0,) in  ignored
singular_ring_delete(ring*) called with NULL pointer.
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)

/home/burcin/sage/sage-4.7.2/<ipython console> in <module>()

/home/burcin/sage/sage-4.7.2/local/lib/python2.6/site-packages/sage/libs/singular/groebner_strategy.so in sage.libs.singular.groebner_strategy.GroebnerStrategy.__cinit__ (sage/libs/singular/groebner_strategy.cpp:2169)()

TypeError: First parameter's ring must be multivariate polynomial ring via libsingular.
```


This is the message I get after adding an "except +" after the declaration of `singular_ring_delete()`.

It seems that `GroebnerStrategy.__cinit__()` (why `__cinit__` and not `__init__`?) already has a doctest for this case. I don't see why the error message is not caught by the doctesting framework. Are these cython errors printed to `stderr` now?

In any case, `GroebnerStrategy.__cinit__()` raises an error on line 99 of `sage/libs/singular/groebner_strategy.pyx`. I thought the `__dealloc__()` method is not called if there is an error during `__init__()`. Any ideas what is going wrong here?

I suggest to open a new ticket to use libsingular from multivariate polynomial rings over CC and RR. This ticket can be about eliminating the scary `singular_ring_delete` error message.


---

Comment by jdemeyer created at 2012-09-07 09:48:22

Changing priority from major to critical.


---

Comment by nbruin created at 2012-09-26 07:56:24

A quick test reveals that:

```
P.<X,Y,Z> = CC[]
C = Curve(X)
self = C
d = self.codimension()
minors = self.Jacobian_matrix().minors(d)
I = self.defining_ideal()
minors = tuple([ I.reduce(m) for m in minors ])
```

(Who ever thought that "Jacobian" was a good name for the singular subscheme? I think most algebraic geometers expect something else when they ask for the Jacobian of a curve).

and a little look indeed shows that this code tries to use "singular"'s reduce (the ideal gets reconstructed several times), and I think it does so successfully (does singular now allow rings with float coefficients?), so it looks indeed like a mismatch in ring deletions. It may be a good test case, because the ring really gets constructed internally, via a `_singular_` method.


---

Comment by pbruin created at 2013-08-07 22:27:08

check for NULL pointer before deleting Singular ring


---

Attachment


---

Comment by pbruin created at 2013-08-07 22:30:27

Changing status from new to needs_review.


---

Comment by pbruin created at 2013-08-07 22:46:39

Replying to [comment:2 burcin]:
> I'm not sure if this is actually supposed to work in Sage right now. Multivariate polynomial rings over `CC` use a generic implementation. The error message should just say "First parameter's ring must be multivariate polynomial ring via libsingular." This is not entirely clear, but at least it is a less scary message than "singular_ring_delete(ring*) called with NULL pointer."

With the patch, the example in the ticket description gives the right answer (`is_smooth() -> True`) and no error.

> Here is a shorter segment to reproduce the problem: [...]

Here the correct `TypeError` message is displayed.

> It seems that `GroebnerStrategy.__cinit__()` (why `__cinit__` and not `__init__`?)

It would be cleaner to separate the initialisation of Python and C attributes into `__init__` and `__cinit__`.  I tried changing `__cinit__` to `__init__` and it did not make any difference.

> already has a doctest for this case. I don't see why the error message is not caught by the doctesting framework. Are these cython errors printed to `stderr` now?

This is indeed surprising.

> In any case, `GroebnerStrategy.__cinit__()` raises an error on line 99 of `sage/libs/singular/groebner_strategy.pyx`. I thought the `__dealloc__()` method is not called if there is an error during `__init__()`. Any ideas what is going wrong here?

Apparently `__dealloc__` _is_ called; I didn't check the Cython documentation.


---

Comment by vbraun created at 2013-08-07 23:58:13

Common pitfall for C++ users, see also https://groups.google.com/d/msg/cython-users/zWxngTspfsY/ItcbwkIqR20J


---

Comment by vbraun created at 2013-08-07 23:59:16

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-08-16 21:10:39

Resolution: fixed
