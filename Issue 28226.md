# Issue 28226: .stack() or .facet_adjacency_matrix() error in Polyhedron

Issue created by migration from https://trac.sagemath.org/ticket/28463

Original creator: jipilab

Original creation time: 2019-09-09 07:30:35

CC:  @laisrast @kliem

Keywords: polytopes, stack

The following Error happens in Sage8.9.beta8:


```
sage: s = polytopes.simplex(7)
sage: f = s.faces(3)[0]
sage: sf = s.stack(f)
---------------------------------------------------------------------------
IndexError                                Traceback (most recent call last)
<ipython-input-3-fae09a40457d> in <module>()
----> 1 sf = s.stack(f)

/home/jplabbe/sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py in stack(self, face, position)
   4135         neighboring_facets = set()
   4136         for facet in face_star:
-> 4137             for neighbor_facet in facet.neighbors():
   4138                 if neighbor_facet not in face_star:
   4139                     neighboring_facets.add(neighbor_facet)

/home/jplabbe/sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/representation.py in neighbors(self)
    463         adjacency_matrix = self.polyhedron().facet_adjacency_matrix()
    464         for x in self.polyhedron().Hrep_generator():
--> 465             if adjacency_matrix[self.index(), x.index()] == 1:
    466                 yield x
    467 

/home/jplabbe/sage/local/lib/python3.7/site-packages/sage/matrix/matrix0.pyx in sage.matrix.matrix0.Matrix.__getitem__ (build/cythonized/sage/matrix/matrix0.c:7282)()
    963                     col += ncols
    964                 if col < 0 or col >= ncols:
--> 965                     raise IndexError("matrix index out of range")
    966                 single_col = 1
    967 

IndexError: matrix index out of range
```



---

Comment by @LaisRast created at 2019-09-09 11:06:46

This is actually a serious problem. See

```
sage: P = polytopes.simplex()
....: F1 = P.Hrepresentation()[1]
....: list(F1.neighbors())
....:
---------------------------------------------------------------------------
IndexError                                Traceback (most recent call last)
<ipython-input-11-3a4d81457d82> in <module>()
      1 P = polytopes.simplex()
      2 F = P.Hrepresentation()[Integer(1)]
----> 3 list(F.neighbors())

/usr/lib/python2.7/site-packages/sage/geometry/polyhedron/representation.pyc in neighbors(self)
    463         adjacency_matrix = self.polyhedron().facet_adjacency_matrix()
    464         for x in self.polyhedron().Hrep_generator():
--> 465             if adjacency_matrix[self.index(), x.index()] == 1:
    466                 yield x
    467

/usr/lib/python2.7/site-packages/sage/matrix/matrix0.pyx in sage.matrix.matrix0.Matrix.__getitem__ (build/cythonized/sage/matrix/matrix0.c:7281)()
    963                     col += ncols
    964                 if col < 0 or col >= ncols:
--> 965                     raise IndexError("matrix index out of range")
    966                 single_col = 1
    967

IndexError: matrix index out of range
```


The method `neighbors()` says that it iterates over the adjacent inequalities _and equations_. However, its code uses the `facet_adjacency_matrix()` method which returns the adjacency of just the inequalities.
To solve this, I think we should introduce `H_adjacency_matrix()`, and use it in the code of `neighbors()`.


---

Comment by @kliem created at 2019-09-10 22:53:28

Changing status from new to needs_review.


---

Comment by @kliem created at 2019-09-10 22:53:28

I added a suggested fix.

I changed `neighbors` to only include `facets`/`inequalities`. There is no meaning in checking anything else anyway, is there?

Additionally I changed a few things, which I noticed about `stacked`.

As `neighbors` did not work for polyhedra with equalities and is not altered for those with without, I don't think a deprecation error is needed.
----
New commits:


---

Comment by @kliem created at 2019-09-10 22:53:28

Changing keywords from "polytopes, stack" to "polytopes, stack, representation, neighbors".


---

Comment by git created at 2019-09-11 04:50:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2019-09-12 06:30:54

Changing status from needs_review to needs_work.


---

Comment by jipilab created at 2019-09-12 06:30:54

A few comments:

 - You should put "Checking that :trac:`28463` is fixed::" in the docstring before the failing test coming from this ticket.

 - I would not refer to an internal variable in the TEST block, but try to say it in words.

 - It would be good to show the new raised ValueError at the end of the examples to say that you should do this on proper faces only (but really at the end, so that "working examples" come first...)

 - Careful with 1 empty line after `::` and indentation of code blocks, otherwise documentation won't build.

 - You introduced two useless empty lines it seems.

 - Please reread what you changed in `representation` it seems contradictory "Does not work for inequalities::" and "AssertionError: must be inequality" is at best very confusing.

 - I don't know what you are talking about with a deprecation: you are changing the behavior of the function, not changing a name or an option. In principle, this change is not wished. That is: we may break a lot of code doing so. That said, the code was broken, so fair enough. But the question remains: is there internal code that breaks due to a weird use of `neighbor()`? Could you check that? Then, I would say it should be a TypeError and not an AssertionError.


---

Comment by @LaisRast created at 2019-09-12 09:48:58

A small remark. The docstring of `neighbors` still says inequalities and _equations_:

```
    Iterate over the adjacent facets (i.e. inequalities/equations)
```



---

Comment by git created at 2019-09-12 21:27:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2019-09-12 21:28:58

Replying to [comment:4 jipilab]:
> A few comments:
> 
>  - You should put "Checking that :trac:`28463` is fixed::" in the docstring before the failing test coming from this ticket.
> 
>  - I would not refer to an internal variable in the TEST block, but try to say it in words.
> 
>  - It would be good to show the new raised ValueError at the end of the examples to say that you should do this on proper faces only (but really at the end, so that "working examples" come first...)
> 
>  - Careful with 1 empty line after `::` and indentation of code blocks, otherwise documentation won't build.
> 
>  - You introduced two useless empty lines it seems.
My editor deletes trailing white spaces by default.
> 
>  - Please reread what you changed in `representation` it seems contradictory "Does not work for inequalities::" and "AssertionError: must be inequality" is at best very confusing.
> 
>  - I don't know what you are talking about with a deprecation: you are changing the behavior of the function, not changing a name or an option. In principle, this change is not wished. That is: we may break a lot of code doing so. That said, the code was broken, so fair enough. But the question remains: is there internal code that breaks due to a weird use of `neighbor()`? Could you check that? Then, I would say it should be a TypeError and not an AssertionError.


---

Comment by @kliem created at 2019-09-12 21:29:10

Changing status from needs_work to needs_review.


---

Comment by jipilab created at 2019-09-13 06:38:03


```diff
-        Checking that stacked point needs to be in the interior of
-        ``locus_polyhedron``::
+        The stacked vertex may not satisfy any inequality
+        defining the original polyhedron::
```


This is making it less precise. Why not say:


```diff
+        Taking the stacking vertex too far with the parameter `XXX` may result in a failure to produce the desired (combinatorial type of) polytope.
```


You forgot to indent the sage blocks.

Have you looked at the other places where `.neighbors` is used in the polyhedron folder?


---

Comment by jipilab created at 2019-09-13 06:38:15

Changing status from needs_review to needs_work.


---

Comment by @kliem created at 2019-09-13 08:13:28

Replying to [comment:9 jipilab]:
> {{{
> #!diff
> -        Checking that stacked point needs to be in the interior of
> -        ``locus_polyhedron``::
> +        The stacked vertex may not satisfy any inequality
> +        defining the original polyhedron::
> }}}
> 
> This is making it less precise. Why not say:
> 
> {{{
> #!diff
> +        Taking the stacking vertex too far with the parameter `XXX` may result in a failure to produce the desired (combinatorial type of) polytope.
> }}}

Actually, I did fix a bug in stacked as well. The set of permittable points should be the relative interior of `locus_polyhedron`. This is not the way it was before. Maybe I should really set up another ticket for the fixes in `stack` and describe this in the ticket.

`position=4` is in the boundary of `locus_polyhedron` and before my fix it returned a wrong combinatorial type.
> 
> You forgot to indent the sage blocks.
> 
> Have you looked at the other places where `.neighbors` is used in the polyhedron folder?

Not yet. The tests passed and so I figured it's fine. Also `neighbors` returned complete nonsense for non-fulldimensional cases due to index shifting. So if anyone has successfully used it, he or she got really lucky. Nevertheless, I can check.


---

Comment by jipilab created at 2019-09-13 10:04:50

Replying to [comment:11 gh-kliem]:
> Replying to [comment:9 jipilab]:
> > {{{
> > #!diff
> > -        Checking that stacked point needs to be in the interior of
> > -        ``locus_polyhedron``::
> > +        The stacked vertex may not satisfy any inequality
> > +        defining the original polyhedron::
> > }}}
> > 
> > This is making it less precise. Why not say:
> > 
> > {{{
> > #!diff
> > +        Taking the stacking vertex too far with the parameter `XXX` may result in a failure to produce the desired (combinatorial type of) polytope.
> > }}}
> 
> Actually, I did fix a bug in stacked as well. The set of permittable points should be the relative interior of `locus_polyhedron`. This is not the way it was before. Maybe I should really set up another ticket for the fixes in `stack` and describe this in the ticket.

No, I believe it is fine. This ticket is about the fact that stacking was not working (originally). So I would say that one can fix the bug and adapt the description of the ticket accordingly.


> 
> `position=4` is in the boundary of `locus_polyhedron` and before my fix it returned a wrong combinatorial type.

One more reason to mention this in the documentation before this test (how should I know that this is what is tested???).

> > 
> > You forgot to indent the sage blocks.
> > 
> > Have you looked at the other places where `.neighbors` is used in the polyhedron folder?
> 
> Not yet. The tests passed and so I figured it's fine. 

Exactly, that's my point: just checking the tests is not enough. One should do a grep to see where this function is used _internally_.


---

Comment by git created at 2019-09-13 19:58:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2019-09-13 19:59:14

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2019-09-13 19:59:14

New commits:
----
New commits:


---

Comment by jipilab created at 2019-10-14 09:31:39

Two minor things:

permittable -> possible, permitted, allowed
`position` -> ``position``


Once you fix these and the pyflakes error at line 8112, you can set it to positive review on my behalf.

P.S. Welcome back to work!


---

Comment by jipilab created at 2019-10-14 09:31:39

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-10-14 10:34:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2019-10-14 10:35:36

Replying to [comment:16 jipilab]:
> Two minor things:
> 
> permittable -> possible, permitted, allowed
> `position` -> ``position``
> 
> 
> Once you fix these and the pyflakes error at line 8112, you can set it to positive review on my behalf.

I can't even locate that error. I don't know in which line this appears (I don't find a version, where line 8112 could have resulted in this error.)
> 
> P.S. Welcome back to work!


---

Comment by @kliem created at 2019-10-14 10:35:45

Changing status from needs_work to needs_review.


---

Comment by git created at 2019-10-15 07:20:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2019-10-21 13:13:13

I guess this is the case now. I'll put in on positive review.

Replying to [comment:16 jipilab]:
> Two minor things:
> 
> permittable -> possible, permitted, allowed
> `position` -> ``position``
> 
> 
> Once you fix these and the pyflakes error at line 8112, you can set it to positive review on my behalf.
> 
> P.S. Welcome back to work!


---

Comment by @kliem created at 2019-10-21 13:13:21

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-10-23 22:58:05

Resolution: fixed
