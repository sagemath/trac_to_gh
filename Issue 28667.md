# Issue 28667: Move reversed graph from backend to CGraph for sparse graphs

archive/issues_028667.json:
```json
{
    "body": "CC:  @videlec @dcoudert\n\nKeywords: sparse graphs, backend\n\nCurrently, for sparse graphs the backend keeps a copy of the reversed graph. This makes iterating over ingoing neighbors much faster.\n\nHowever, `SparseGraph` itself does not have access to this. So e.g. when deleting vertices, this results in a massive slow down as it needs to delete incoming edges.\n\nWe initialize the sparse backend with the reversed structure and instead add the reversed structure directly to `SparseGraph`.\n\nBefore this ticket:\n\n\n```\nsage: edges = [(randint(0,1000), randint(0,1000)) for _ in range(100000)]\nsage: D = DiGraph(multiedges=True, loops=True)\nsage: D.add_edges(edges)\nsage: for i in range(1000): G.add_vertex(i)\nsage: %time for i in range(100): D.delete_vertex(i)\nCPU times: user 10.1 ms, sys: 0 ns, total: 10.1 ms\nWall time: 10.1 ms\n```\n\n\nWith this ticket:\n\n\n```\nCPU times: user 4.4 ms, sys: 4 \u00b5s, total: 4.41 ms\nWall time: 4.41 ms\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28904\n\n",
    "created_at": "2019-12-21T00:44:43Z",
    "labels": [
        "component: graph theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Move reversed graph from backend to CGraph for sparse graphs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28667",
    "user": "https://github.com/kliem"
}
```
CC:  @videlec @dcoudert

Keywords: sparse graphs, backend

Currently, for sparse graphs the backend keeps a copy of the reversed graph. This makes iterating over ingoing neighbors much faster.

However, `SparseGraph` itself does not have access to this. So e.g. when deleting vertices, this results in a massive slow down as it needs to delete incoming edges.

We initialize the sparse backend with the reversed structure and instead add the reversed structure directly to `SparseGraph`.

Before this ticket:


```
sage: edges = [(randint(0,1000), randint(0,1000)) for _ in range(100000)]
sage: D = DiGraph(multiedges=True, loops=True)
sage: D.add_edges(edges)
sage: for i in range(1000): G.add_vertex(i)
sage: %time for i in range(100): D.delete_vertex(i)
CPU times: user 10.1 ms, sys: 0 ns, total: 10.1 ms
Wall time: 10.1 ms
```


With this ticket:


```
CPU times: user 4.4 ms, sys: 4 Âµs, total: 4.41 ms
Wall time: 4.41 ms
```


Issue created by migration from https://trac.sagemath.org/ticket/28904





---

archive/issue_comments_404426.json:
```json
{
    "body": "TBtw, there is a bug that leads to a crash with:\n\n\n```\nsage: G = DiGraph(2, data_structure='dense')\nsage: G.add_edge(0,1)\nsage: G.is_eulerian()\n```\n\n\nThis ticket also fixes this (the method `in_degree` in the CGraph backend assumes `_cg_rev` to be initialized).",
    "created_at": "2019-12-21T00:46:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404426",
    "user": "https://github.com/kliem"
}
```

TBtw, there is a bug that leads to a crash with:


```
sage: G = DiGraph(2, data_structure='dense')
sage: G.add_edge(0,1)
sage: G.is_eulerian()
```


This ticket also fixes this (the method `in_degree` in the CGraph backend assumes `_cg_rev` to be initialized).



---

archive/issue_comments_404427.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-12-21T00:50:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404427",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_404428.json:
```json
{
    "body": "This probably needs to be cleaned up a lot.\nIs it going in a good direction?\nOn my side, all tests in graphs seem to succeed.\n----\nNew commits:",
    "created_at": "2019-12-21T00:50:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404428",
    "user": "https://github.com/kliem"
}
```

This probably needs to be cleaned up a lot.
Is it going in a good direction?
On my side, all tests in graphs seem to succeed.
----
New commits:



---

archive/issue_comments_404429.json:
```json
{
    "body": "One needs to be careful, about taking the same set of edges I guess.",
    "created_at": "2019-12-21T10:31:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404429",
    "user": "https://github.com/kliem"
}
```

One needs to be careful, about taking the same set of edges I guess.



---

archive/issue_comments_404430.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-21T10:32:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404430",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_404431.json:
```json
{
    "body": "Thank you for doing this, it's really needed.\n\nWith these changes, `_cg_rev` is no longer initialized, right ? If it's no longer needed, may be we can remove it, but we have to ensure that no-one is using it. Actually I fear that some users are using it for personal code. I see 2 solutions for that:\n1. send a pool to sage-dev for complete removal\n2. maintain an object build from `_cg` with appropriate pointers, and add a warning in the documentation.\n\n\n## in `sparse_graph.pyx`:\n\n```diff\n-            for i from 0 <= i < self.active_vertices.size * self.hash_length:\n+            for i in range(self.active_vertices.size * self.hash_length):\n```\n\n\nI think you can simplify tests to `NULL`\n\n```diff\n-                while temp[0] != NULL:\n+                while temp[0]:\n```\n\n\n\n\n```diff\n-        Lists the in-neighbors of a vertex as BTNodes\n+        List the in-neighbors of a vertex as BTNodes\n```\n\n\n\n```diff\n-        Builds the list of arcs into a vertex.\n+        Build the list of arcs into a vertex.\n```\n\n\n\n```diff\n-        Adds arc (u, v) to the graph with label l.\n+        Add arc (u, v) to the graph with label l.\n```\n\n\nBetter to use `True` and `False` instead of 0 and 1.\n\n```diff\n-        cdef int u_int = self.check_labelled_vertex(u, 0)\n-        cdef int v_int = self.check_labelled_vertex(v, 0)\n+        cdef int u_int = self.check_labelled_vertex(u, False)\n+        cdef int v_int = self.check_labelled_vertex(v, False)\n```\n\n\n\n## in `c_graph.pyx` we can do some extra optimisations, like\n\nin `verts`\n\n```diff\n-        cdef int i\n-        return [i for i in range(<int>self.active_vertices.size)\n-                if bitset_in(self.active_vertices, i)]\n+       return bitset_list(self.active_vertices)\n```\n\n\nin `iterator_verts`\n\n```diff\n-            for i in range(self._cg.active_vertices.size):\n-                if (bitset_in(self._cg.active_vertices, i)\n-                    and i not in self.vertex_labels\n-                    and i not in self.vertex_ints):\n-                        yield i\n+            i = bitset_first(self._cg.active_vertices)\n+            while i >= 0:\n+                if (i not in self.vertex_labels\n+                    and i not in self.vertex_ints):\n+                        yield i\n+                i = bitset_next(self._cg.active_vertices, i + 1)\n```\n",
    "created_at": "2019-12-21T10:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404431",
    "user": "https://github.com/dcoudert"
}
```

Thank you for doing this, it's really needed.

With these changes, `_cg_rev` is no longer initialized, right ? If it's no longer needed, may be we can remove it, but we have to ensure that no-one is using it. Actually I fear that some users are using it for personal code. I see 2 solutions for that:
1. send a pool to sage-dev for complete removal
2. maintain an object build from `_cg` with appropriate pointers, and add a warning in the documentation.


## in `sparse_graph.pyx`:

```diff
-            for i from 0 <= i < self.active_vertices.size * self.hash_length:
+            for i in range(self.active_vertices.size * self.hash_length):
```


I think you can simplify tests to `NULL`

```diff
-                while temp[0] != NULL:
+                while temp[0]:
```




```diff
-        Lists the in-neighbors of a vertex as BTNodes
+        List the in-neighbors of a vertex as BTNodes
```



```diff
-        Builds the list of arcs into a vertex.
+        Build the list of arcs into a vertex.
```



```diff
-        Adds arc (u, v) to the graph with label l.
+        Add arc (u, v) to the graph with label l.
```


Better to use `True` and `False` instead of 0 and 1.

```diff
-        cdef int u_int = self.check_labelled_vertex(u, 0)
-        cdef int v_int = self.check_labelled_vertex(v, 0)
+        cdef int u_int = self.check_labelled_vertex(u, False)
+        cdef int v_int = self.check_labelled_vertex(v, False)
```



## in `c_graph.pyx` we can do some extra optimisations, like

in `verts`

```diff
-        cdef int i
-        return [i for i in range(<int>self.active_vertices.size)
-                if bitset_in(self.active_vertices, i)]
+       return bitset_list(self.active_vertices)
```


in `iterator_verts`

```diff
-            for i in range(self._cg.active_vertices.size):
-                if (bitset_in(self._cg.active_vertices, i)
-                    and i not in self.vertex_labels
-                    and i not in self.vertex_ints):
-                        yield i
+            i = bitset_first(self._cg.active_vertices)
+            while i >= 0:
+                if (i not in self.vertex_labels
+                    and i not in self.vertex_ints):
+                        yield i
+                i = bitset_next(self._cg.active_vertices, i + 1)
```




---

archive/issue_comments_404432.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404432",
    "user": "https://github.com/embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_404433.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-01-07T19:30:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404433",
    "user": "https://github.com/kliem"
}
```

New commits:



---

archive/issue_comments_404434.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-07T21:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404434",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_404435.json:
```json
{
    "body": "Thanks for the comments.\n\nReplying to [comment:6 dcoudert]:\n> \n> in `iterator_verts`\n> {{{#!diff\n> -            for i in range(self._cg.active_vertices.size):\n> -                if (bitset_in(self._cg.active_vertices, i)\n> -                    and i not in self.vertex_labels\n> -                    and i not in self.vertex_ints):\n> -                        yield i\n> +            i = bitset_first(self._cg.active_vertices)\n> +            while i >= 0:\n> +                if (i not in self.vertex_labels\n> +                    and i not in self.vertex_ints):\n> +                        yield i\n> +                i = bitset_next(self._cg.active_vertices, i + 1)\n> }}}\n\nFixing this makes a mistake apparent: There is a doctest in `generic_graph.py` that subdivides all edges of a graph by using `self.edges()`. However, one should not iterate over an `EdgesView` object while modifying the graph. I have modified the method `subdivide_edges` to generate a tuple from `EdgesView`.",
    "created_at": "2020-01-07T21:25:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404435",
    "user": "https://github.com/kliem"
}
```

Thanks for the comments.

Replying to [comment:6 dcoudert]:
> 
> in `iterator_verts`
> {{{#!diff
> -            for i in range(self._cg.active_vertices.size):
> -                if (bitset_in(self._cg.active_vertices, i)
> -                    and i not in self.vertex_labels
> -                    and i not in self.vertex_ints):
> -                        yield i
> +            i = bitset_first(self._cg.active_vertices)
> +            while i >= 0:
> +                if (i not in self.vertex_labels
> +                    and i not in self.vertex_ints):
> +                        yield i
> +                i = bitset_next(self._cg.active_vertices, i + 1)
> }}}

Fixing this makes a mistake apparent: There is a doctest in `generic_graph.py` that subdivides all edges of a graph by using `self.edges()`. However, one should not iterate over an `EdgesView` object while modifying the graph. I have modified the method `subdivide_edges` to generate a tuple from `EdgesView`.



---

archive/issue_comments_404436.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-07T21:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404436",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_404437.json:
```json
{
    "body": "* I have some compilation warnings. It's better to check if it's possible to avoid.\n\n```\n[2/4] gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -I./sage/cpython -I./sage/libs/ntl -I/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/cysignals -Isage/cpython -I./sage/rings -I/Users/dcoudert/sage3/sage/local/include -I/Users/dcoudert/sage3/sage/src -I/Users/dcoudert/sage3/sage/src/sage/ext -I/Users/dcoudert/sage3/sage/local/include/python3.7m -I/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/numpy/core/include -Ibuild/cythonized -I/Users/dcoudert/sage3/sage/local/include/python3.7m -c build/cythonized/sage/graphs/base/c_graph.cpp -o build/temp.macosx-10.9-x86_64-3.7/build/cythonized/sage/graphs/base/c_graph.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -std=c++11\nbuild/cythonized/sage/graphs/base/c_graph.cpp:16256:48: warning: comparison of integers of different signs: 'size_t' (aka 'unsigned long') and 'long' [-Wsign-compare]\n      __pyx_t_2 = ((__pyx_cur_scope->__pyx_v_i != -1L) != 0);\n                    ~~~~~~~~~~~~~~~~~~~~~~~~~~ ^  ~~~\n1 warning generated.\ng++ -bundle -undefined dynamic_lookup -L/Users/dcoudert/sage3/sage/local/lib -Wl,-rpath,/Users/dcoudert/sage3/sage/local/lib -L/usr/local/opt/openssl/lib -L. -L/Users/dcoudert/sage3/sage/local/lib -Wl,-rpath,/Users/dcoudert/sage3/sage/local/lib -L/usr/local/opt/openssl/lib -L/Users/dcoudert/sage3/sage/local/lib -Wl,-rpath,/Users/dcoudert/sage3/sage/local/lib build/temp.macosx-10.9-x86_64-3.7/build/cythonized/sage/graphs/base/c_graph.o -L/Users/dcoudert/sage3/sage/local/lib -L/Users/dcoudert/sage3/sage/local/lib -lgmp -lstdc++ -o build/lib.macosx-10.9-x86_64-3.7/sage/graphs/base/c_graph.cpython-37m-darwin.so -lpari\n[3/4] gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -I./sage/cpython -Isage/cpython -I/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/cysignals -I/Users/dcoudert/sage3/sage/local/include -I/Users/dcoudert/sage3/sage/src -I/Users/dcoudert/sage3/sage/src/sage/ext -I/Users/dcoudert/sage3/sage/local/include/python3.7m -I/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/numpy/core/include -Ibuild/cythonized -I/Users/dcoudert/sage3/sage/local/include/python3.7m -c build/cythonized/sage/graphs/base/sparse_graph.c -o build/temp.macosx-10.9-x86_64-3.7/build/cythonized/sage/graphs/base/sparse_graph.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -std=c99\nbuild/cythonized/sage/graphs/base/sparse_graph.c:11350:35: warning: comparison of integers of different signs: 'size_t' (aka 'unsigned long') and 'int' [-Wsign-compare]\n    for (__pyx_t_5 = 0; __pyx_t_5 < __pyx_t_4; __pyx_t_5+=1) {\n                        ~~~~~~~~~ ^ ~~~~~~~~~\nbuild/cythonized/sage/graphs/base/sparse_graph.c:11384:35: warning: comparison of integers of different signs: 'size_t' (aka 'unsigned long') and 'int' [-Wsign-compare]\n    for (__pyx_t_5 = 0; __pyx_t_5 < __pyx_t_4; __pyx_t_5+=1) {\n                        ~~~~~~~~~ ^ ~~~~~~~~~\nbuild/cythonized/sage/graphs/base/sparse_graph.c:19114:87: warning: incompatible pointer types passing 'struct __pyx_obj_4sage_6graphs_4base_7c_graph_CGraph *' to parameter of\n      type 'struct __pyx_obj_4sage_6graphs_4base_12sparse_graph_SparseGraph *' [-Wincompatible-pointer-types]\n  ...((struct __pyx_obj_4sage_6graphs_4base_7c_graph_CGraph *)((struct __pyx_obj_4sage_6graphs_4base_12sparse_graph_SparseGraph *)__pyx_v_self->__pyx_base._cg)), __pyx_v_u_int...\n     ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\nbuild/cythonized/sage/graphs/base/sparse_graph.c:9396:149: note: passing argument to parameter '__pyx_v_self' here\nstatic int __pyx_f_4sage_6graphs_4base_12sparse_graph_11SparseGraph_has_arc_unsafe(struct __pyx_obj_4sage_6graphs_4base_12sparse_graph_SparseGraph *__pyx_v_self, int __pyx...\n                                                                                                                                                    ^\nbuild/cythonized/sage/graphs/base/sparse_graph.c:25037:87: warning: incompatible pointer types passing 'struct __pyx_obj_4sage_6graphs_4base_7c_graph_CGraph *' to parameter of\n      type 'struct __pyx_obj_4sage_6graphs_4base_12sparse_graph_SparseGraph *' [-Wincompatible-pointer-types]\n  ...((struct __pyx_obj_4sage_6graphs_4base_7c_graph_CGraph *)((struct __pyx_obj_4sage_6graphs_4base_12sparse_graph_SparseGraph *)__pyx_v_self->__pyx_base._cg)), __pyx_v_u_int...\n     ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\nbuild/cythonized/sage/graphs/base/sparse_graph.c:9396:149: note: passing argument to parameter '__pyx_v_self' here\nstatic int __pyx_f_4sage_6graphs_4base_12sparse_graph_11SparseGraph_has_arc_unsafe(struct __pyx_obj_4sage_6graphs_4base_12sparse_graph_SparseGraph *__pyx_v_self, int __pyx...\n                                                                                                                                                    ^\n4 warnings generated.\n```\n \n\n* method `del_arc_unsafe` returns nothing\n\n* in method `del_arc_label_unsafe`, can't we do this (not sure if it's better or not):\n\n```diff\n-        cdef int error = self._del_arc_label_unsafe(u, v, l, self.vertices)\n-        if error:\n-            return 1 # indicate an error\n+        if self._del_arc_label_unsafe(u, v, l, self.vertices):\n+            return 1 # indicate an error\n```\n\n\n* Thanks for correcting `subdivise_edges`.\n\nI confirm that vertex deletion is much faster now.",
    "created_at": "2020-01-08T12:07:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404437",
    "user": "https://github.com/dcoudert"
}
```

* I have some compilation warnings. It's better to check if it's possible to avoid.

```
[2/4] gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -I./sage/cpython -I./sage/libs/ntl -I/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/cysignals -Isage/cpython -I./sage/rings -I/Users/dcoudert/sage3/sage/local/include -I/Users/dcoudert/sage3/sage/src -I/Users/dcoudert/sage3/sage/src/sage/ext -I/Users/dcoudert/sage3/sage/local/include/python3.7m -I/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/numpy/core/include -Ibuild/cythonized -I/Users/dcoudert/sage3/sage/local/include/python3.7m -c build/cythonized/sage/graphs/base/c_graph.cpp -o build/temp.macosx-10.9-x86_64-3.7/build/cythonized/sage/graphs/base/c_graph.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -std=c++11
build/cythonized/sage/graphs/base/c_graph.cpp:16256:48: warning: comparison of integers of different signs: 'size_t' (aka 'unsigned long') and 'long' [-Wsign-compare]
      __pyx_t_2 = ((__pyx_cur_scope->__pyx_v_i != -1L) != 0);
                    ~~~~~~~~~~~~~~~~~~~~~~~~~~ ^  ~~~
1 warning generated.
g++ -bundle -undefined dynamic_lookup -L/Users/dcoudert/sage3/sage/local/lib -Wl,-rpath,/Users/dcoudert/sage3/sage/local/lib -L/usr/local/opt/openssl/lib -L. -L/Users/dcoudert/sage3/sage/local/lib -Wl,-rpath,/Users/dcoudert/sage3/sage/local/lib -L/usr/local/opt/openssl/lib -L/Users/dcoudert/sage3/sage/local/lib -Wl,-rpath,/Users/dcoudert/sage3/sage/local/lib build/temp.macosx-10.9-x86_64-3.7/build/cythonized/sage/graphs/base/c_graph.o -L/Users/dcoudert/sage3/sage/local/lib -L/Users/dcoudert/sage3/sage/local/lib -lgmp -lstdc++ -o build/lib.macosx-10.9-x86_64-3.7/sage/graphs/base/c_graph.cpython-37m-darwin.so -lpari
[3/4] gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -I./sage/cpython -Isage/cpython -I/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/cysignals -I/Users/dcoudert/sage3/sage/local/include -I/Users/dcoudert/sage3/sage/src -I/Users/dcoudert/sage3/sage/src/sage/ext -I/Users/dcoudert/sage3/sage/local/include/python3.7m -I/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/numpy/core/include -Ibuild/cythonized -I/Users/dcoudert/sage3/sage/local/include/python3.7m -c build/cythonized/sage/graphs/base/sparse_graph.c -o build/temp.macosx-10.9-x86_64-3.7/build/cythonized/sage/graphs/base/sparse_graph.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -std=c99
build/cythonized/sage/graphs/base/sparse_graph.c:11350:35: warning: comparison of integers of different signs: 'size_t' (aka 'unsigned long') and 'int' [-Wsign-compare]
    for (__pyx_t_5 = 0; __pyx_t_5 < __pyx_t_4; __pyx_t_5+=1) {
                        ~~~~~~~~~ ^ ~~~~~~~~~
build/cythonized/sage/graphs/base/sparse_graph.c:11384:35: warning: comparison of integers of different signs: 'size_t' (aka 'unsigned long') and 'int' [-Wsign-compare]
    for (__pyx_t_5 = 0; __pyx_t_5 < __pyx_t_4; __pyx_t_5+=1) {
                        ~~~~~~~~~ ^ ~~~~~~~~~
build/cythonized/sage/graphs/base/sparse_graph.c:19114:87: warning: incompatible pointer types passing 'struct __pyx_obj_4sage_6graphs_4base_7c_graph_CGraph *' to parameter of
      type 'struct __pyx_obj_4sage_6graphs_4base_12sparse_graph_SparseGraph *' [-Wincompatible-pointer-types]
  ...((struct __pyx_obj_4sage_6graphs_4base_7c_graph_CGraph *)((struct __pyx_obj_4sage_6graphs_4base_12sparse_graph_SparseGraph *)__pyx_v_self->__pyx_base._cg)), __pyx_v_u_int...
     ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
build/cythonized/sage/graphs/base/sparse_graph.c:9396:149: note: passing argument to parameter '__pyx_v_self' here
static int __pyx_f_4sage_6graphs_4base_12sparse_graph_11SparseGraph_has_arc_unsafe(struct __pyx_obj_4sage_6graphs_4base_12sparse_graph_SparseGraph *__pyx_v_self, int __pyx...
                                                                                                                                                    ^
build/cythonized/sage/graphs/base/sparse_graph.c:25037:87: warning: incompatible pointer types passing 'struct __pyx_obj_4sage_6graphs_4base_7c_graph_CGraph *' to parameter of
      type 'struct __pyx_obj_4sage_6graphs_4base_12sparse_graph_SparseGraph *' [-Wincompatible-pointer-types]
  ...((struct __pyx_obj_4sage_6graphs_4base_7c_graph_CGraph *)((struct __pyx_obj_4sage_6graphs_4base_12sparse_graph_SparseGraph *)__pyx_v_self->__pyx_base._cg)), __pyx_v_u_int...
     ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
build/cythonized/sage/graphs/base/sparse_graph.c:9396:149: note: passing argument to parameter '__pyx_v_self' here
static int __pyx_f_4sage_6graphs_4base_12sparse_graph_11SparseGraph_has_arc_unsafe(struct __pyx_obj_4sage_6graphs_4base_12sparse_graph_SparseGraph *__pyx_v_self, int __pyx...
                                                                                                                                                    ^
4 warnings generated.
```
 

* method `del_arc_unsafe` returns nothing

* in method `del_arc_label_unsafe`, can't we do this (not sure if it's better or not):

```diff
-        cdef int error = self._del_arc_label_unsafe(u, v, l, self.vertices)
-        if error:
-            return 1 # indicate an error
+        if self._del_arc_label_unsafe(u, v, l, self.vertices):
+            return 1 # indicate an error
```


* Thanks for correcting `subdivise_edges`.

I confirm that vertex deletion is much faster now.



---

archive/issue_comments_404438.json:
```json
{
    "body": "There are tons of compilation warnings, as we include all of `bitset.pxi`, which is annoying, but of course not serious.\n\nThe compilation warning about wrong casting of `self._cg` is a bit tricky. I think I took care of it now. The problem is that `SparseGraphBackend` casts the `SparseGraph` to a `CGraph` in order to assign it to `self._cg`, which is declared to be a `CGraph`. This is later on casted back into a `SpareGraph`, which of course produces a warning.\n\nMy approach now: Remove the attribute `_cg` from `CGraphBackend` and add it to the inherited backends with the proper declaration. Add an inline method `cg`, which returns `_cg` casted to a `CGraph`. This is cleaner, I think.",
    "created_at": "2020-01-08T16:02:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404438",
    "user": "https://github.com/kliem"
}
```

There are tons of compilation warnings, as we include all of `bitset.pxi`, which is annoying, but of course not serious.

The compilation warning about wrong casting of `self._cg` is a bit tricky. I think I took care of it now. The problem is that `SparseGraphBackend` casts the `SparseGraph` to a `CGraph` in order to assign it to `self._cg`, which is declared to be a `CGraph`. This is later on casted back into a `SpareGraph`, which of course produces a warning.

My approach now: Remove the attribute `_cg` from `CGraphBackend` and add it to the inherited backends with the proper declaration. Add an inline method `cg`, which returns `_cg` casted to a `CGraph`. This is cleaner, I think.



---

archive/issue_comments_404439.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-08T16:03:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404439",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_404440.json:
```json
{
    "body": "I'm happy with the current code, but it would be better to get extra opinion (e.g., from the thread [https://groups.google.com/forum/#!topic/sage-devel/2eIaD3r8Vl8](https://groups.google.com/forum/#!topic/sage-devel/2eIaD3r8Vl8)).",
    "created_at": "2020-01-09T17:13:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404440",
    "user": "https://github.com/dcoudert"
}
```

I'm happy with the current code, but it would be better to get extra opinion (e.g., from the thread [https://groups.google.com/forum/#!topic/sage-devel/2eIaD3r8Vl8](https://groups.google.com/forum/#!topic/sage-devel/2eIaD3r8Vl8)).



---

archive/issue_comments_404441.json:
```json
{
    "body": "There remains the question, whether we should remove `cg_rev` altogether and whether we should do it now.\n\nThe advantage of removing it, is that code referring to it won't compile anymore and/or give a proper warning. Currently, if one assumes this to be initialized and uses it in cython, sage might crash hard (segmentation fault I believe).",
    "created_at": "2020-01-09T19:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404441",
    "user": "https://github.com/kliem"
}
```

There remains the question, whether we should remove `cg_rev` altogether and whether we should do it now.

The advantage of removing it, is that code referring to it won't compile anymore and/or give a proper warning. Currently, if one assumes this to be initialized and uses it in cython, sage might crash hard (segmentation fault I believe).



---

archive/issue_comments_404442.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-01-14T08:21:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404442",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_404443.json:
```json
{
    "body": "I removed the attribute `_cg_rev` now.\n\nThe method `check_labelled_vertex` just ignores the input `reverse` now.\n\nThe method `c_graph` return `(self._cg, None)` instead of `(self._cg, self._cg_rev)`.",
    "created_at": "2020-01-14T08:25:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404443",
    "user": "https://github.com/kliem"
}
```

I removed the attribute `_cg_rev` now.

The method `check_labelled_vertex` just ignores the input `reverse` now.

The method `c_graph` return `(self._cg, None)` instead of `(self._cg, self._cg_rev)`.



---

archive/issue_comments_404444.json:
```json
{
    "body": "Why\n\n```\ndiff --git a/src/sage/graphs/generic_graph.py b/src/sage/graphs/generic_graph.py\nindex 139c8df..4fa7f75 100644\n--- a/src/sage/graphs/generic_graph.py\n+++ b/src/sage/graphs/generic_graph.py\n@@ -11001,6 +11001,8 @@ class GenericGraph(GenericGraph_pyx):\n \n             - :meth:`subdivide_edge` -- subdivides one edge\n         \"\"\"\n+        if isinstance(edges, EdgesView):\n+            edges = tuple(edges)\n```\n",
    "created_at": "2020-02-15T15:33:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404444",
    "user": "https://github.com/videlec"
}
```

Why

```
diff --git a/src/sage/graphs/generic_graph.py b/src/sage/graphs/generic_graph.py
index 139c8df..4fa7f75 100644
--- a/src/sage/graphs/generic_graph.py
+++ b/src/sage/graphs/generic_graph.py
@@ -11001,6 +11001,8 @@ class GenericGraph(GenericGraph_pyx):
 
             - :meth:`subdivide_edge` -- subdivides one edge
         """
+        if isinstance(edges, EdgesView):
+            edges = tuple(edges)
```




---

archive/issue_comments_404445.json:
```json
{
    "body": "This is independent from the purpose of this ticket, but this is effectively an issue to be fixed.",
    "created_at": "2020-02-15T16:19:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404445",
    "user": "https://github.com/dcoudert"
}
```

This is independent from the purpose of this ticket, but this is effectively an issue to be fixed.



---

archive/issue_comments_404446.json:
```json
{
    "body": "I updated the description of the ticket to account for the change.",
    "created_at": "2020-02-15T16:24:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404446",
    "user": "https://github.com/kliem"
}
```

I updated the description of the ticket to account for the change.



---

archive/issue_comments_404447.json:
```json
{
    "body": "Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404447",
    "user": "https://github.com/mkoeppe"
}
```

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_comments_404448.json:
```json
{
    "body": "What's the status of this ticket?",
    "created_at": "2020-08-11T17:31:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404448",
    "user": "https://github.com/mkoeppe"
}
```

What's the status of this ticket?



---

archive/issue_comments_404449.json:
```json
{
    "body": "Needs review.\n\nIt's annoying to check, I guess. But it would be a nice improvements with many applications. Maybe I should request a review on sage-devel.",
    "created_at": "2020-08-11T20:24:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404449",
    "user": "https://github.com/kliem"
}
```

Needs review.

It's annoying to check, I guess. But it would be a nice improvements with many applications. Maybe I should request a review on sage-devel.



---

archive/issue_comments_404450.json:
```json
{
    "body": "overall, it's a very nice improvement. I have only a few suggestions.\n\n**`sparse_graph.pyx`**\n-  instead of checking `self.vertices != self.vertices_rev`, we could store a boolean value `self._directed` and have a method `self.is_directed())`.\n\n- instead of `<size_t>-1`, don't we have a constant equal to the max value ? This is something we should do in several places in the code. Could be done in dedicated tickets\n\n- in `out_neighbors_unsafe` and `in_neighbors_unsafe`, remove `cdef list l = []`, not used\n\n\n- I know that the documentation of cdef methods is not displayed, but it would be cleaner to follow the same standard than in the other parts of the code. For instance\n\n```diff\n        INPUT:\n-            u, v -- non-negative integers\n+\n+            - ``u, v`` -- non-negative integers\n```\n\n  Of course, we can do that in a future ticket. Not a priority here\n\n\n- methods `out_arcs_unsafe` and `in_arcs_unsafe` return lists. Why not changing to an iterator ? If I'm not mistaken, these methods are only used in for loops.\n\n- same for method `all_arcs` which is used in a for loop and in some doctests where we could use `list(...)`.\n\n```\nconfetti:sage dcoudert$ git grep -i \"\\.all_arcs\" src/sage/\nsrc/sage/graphs/base/c_graph.pyx:            - :meth:`all_arcs <sage.graphs.base.sparse_graph.SparseGraph.all_arcs>`\nsrc/sage/graphs/base/c_graph.pyx:            sage: G.all_arcs(0, 1)\nsrc/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(0,1)\nsrc/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(1,2)\nsrc/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(7,3)\nsrc/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(0,1)\nsrc/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(1,2)\nsrc/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(5,4)\nsrc/sage/graphs/base/sparse_graph.pyx:            sage: G.all_arcs(1,2)\nsrc/sage/graphs/base/sparse_graph.pyx:        num_arcs = self.all_arcs_unsafe(u, v, arc_labels, size)\nsrc/sage/graphs/base/sparse_graph.pyx:            sage: G.all_arcs(0,1)\nsrc/sage/graphs/base/sparse_graph.pyx:            sage: G.all_arcs(0,1)\nsrc/sage/graphs/base/sparse_graph.pyx:                     for l_int in self._cg.all_arcs(u_int, v_int)]\nsrc/sage/graphs/base/sparse_graph.pyx:        for l_int in self._cg.all_arcs(u_int, v_int):\n```\n",
    "created_at": "2020-08-12T08:41:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404450",
    "user": "https://github.com/dcoudert"
}
```

overall, it's a very nice improvement. I have only a few suggestions.

**`sparse_graph.pyx`**
-  instead of checking `self.vertices != self.vertices_rev`, we could store a boolean value `self._directed` and have a method `self.is_directed())`.

- instead of `<size_t>-1`, don't we have a constant equal to the max value ? This is something we should do in several places in the code. Could be done in dedicated tickets

- in `out_neighbors_unsafe` and `in_neighbors_unsafe`, remove `cdef list l = []`, not used


- I know that the documentation of cdef methods is not displayed, but it would be cleaner to follow the same standard than in the other parts of the code. For instance

```diff
        INPUT:
-            u, v -- non-negative integers
+
+            - ``u, v`` -- non-negative integers
```

  Of course, we can do that in a future ticket. Not a priority here


- methods `out_arcs_unsafe` and `in_arcs_unsafe` return lists. Why not changing to an iterator ? If I'm not mistaken, these methods are only used in for loops.

- same for method `all_arcs` which is used in a for loop and in some doctests where we could use `list(...)`.

```
confetti:sage dcoudert$ git grep -i "\.all_arcs" src/sage/
src/sage/graphs/base/c_graph.pyx:            - :meth:`all_arcs <sage.graphs.base.sparse_graph.SparseGraph.all_arcs>`
src/sage/graphs/base/c_graph.pyx:            sage: G.all_arcs(0, 1)
src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(0,1)
src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(1,2)
src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(7,3)
src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(0,1)
src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(1,2)
src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(5,4)
src/sage/graphs/base/sparse_graph.pyx:            sage: G.all_arcs(1,2)
src/sage/graphs/base/sparse_graph.pyx:        num_arcs = self.all_arcs_unsafe(u, v, arc_labels, size)
src/sage/graphs/base/sparse_graph.pyx:            sage: G.all_arcs(0,1)
src/sage/graphs/base/sparse_graph.pyx:            sage: G.all_arcs(0,1)
src/sage/graphs/base/sparse_graph.pyx:                     for l_int in self._cg.all_arcs(u_int, v_int)]
src/sage/graphs/base/sparse_graph.pyx:        for l_int in self._cg.all_arcs(u_int, v_int):
```




---

archive/issue_comments_404451.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-08-12T10:19:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404451",
    "user": "https://github.com/kliem"
}
```

New commits:



---

archive/issue_comments_404452.json:
```json
{
    "body": "Replying to [comment:25 dcoudert]:\n> overall, it's a very nice improvement. I have only a few suggestions.\n> \n> **`sparse_graph.pyx`**\n> -  instead of checking `self.vertices != self.vertices_rev`, we could store a boolean value `self._directed` and have a method `self.is_directed())`.\nDone.\n> \n> - instead of `<size_t>-1`, don't we have a constant equal to the max value ? This is something we should do in several places in the code. Could be done in dedicated tickets\nThis is being cythonized into `((size_t)-1L)` and I hope the compiler takes care of it from there. It's maybe not so nice codewise, but I don't think it is any loss.\n> \n> - in `out_neighbors_unsafe` and `in_neighbors_unsafe`, remove `cdef list l = []`, not used\nDone.\n> \n> \n> - I know that the documentation of cdef methods is not displayed, but it would be cleaner to follow the same standard than in the other parts of the code. For instance\n> {{{#!diff\n>         INPUT:\n> -            u, v -- non-negative integers\n> +\n> +            - ``u, v`` -- non-negative integers\n> }}}\n>   Of course, we can do that in a future ticket. Not a priority here\nDone. It's a rather large commit though as I went over all the places that \"caught my eye\".\n> \n> \n> - methods `out_arcs_unsafe` and `in_arcs_unsafe` return lists. Why not changing to an iterator ? If I'm not mistaken, these methods are only used in for loops.\n> \n> - same for method `all_arcs` which is used in a for loop and in some doctests where we could use `list(...)`.\n> {{{\n> confetti:sage dcoudert$ git grep -i \"\\.all_arcs\" src/sage/\n> src/sage/graphs/base/c_graph.pyx:            - :meth:`all_arcs <sage.graphs.base.sparse_graph.SparseGraph.all_arcs>`\n> src/sage/graphs/base/c_graph.pyx:            sage: G.all_arcs(0, 1)\n> src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(0,1)\n> src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(1,2)\n> src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(7,3)\n> src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(0,1)\n> src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(1,2)\n> src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(5,4)\n> src/sage/graphs/base/sparse_graph.pyx:            sage: G.all_arcs(1,2)\n> src/sage/graphs/base/sparse_graph.pyx:        num_arcs = self.all_arcs_unsafe(u, v, arc_labels, size)\n> src/sage/graphs/base/sparse_graph.pyx:            sage: G.all_arcs(0,1)\n> src/sage/graphs/base/sparse_graph.pyx:            sage: G.all_arcs(0,1)\n> src/sage/graphs/base/sparse_graph.pyx:                     for l_int in self._cg.all_arcs(u_int, v_int)]\n> src/sage/graphs/base/sparse_graph.pyx:        for l_int in self._cg.all_arcs(u_int, v_int):\n> }}}\n> \nThe last two I would leave for future tickets. But you are right. We really iterate over a structure that is already there (either over a bitset or a tree). So there is no use in wasting resources for creating this list.",
    "created_at": "2020-08-12T10:27:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404452",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:25 dcoudert]:
> overall, it's a very nice improvement. I have only a few suggestions.
> 
> **`sparse_graph.pyx`**
> -  instead of checking `self.vertices != self.vertices_rev`, we could store a boolean value `self._directed` and have a method `self.is_directed())`.
Done.
> 
> - instead of `<size_t>-1`, don't we have a constant equal to the max value ? This is something we should do in several places in the code. Could be done in dedicated tickets
This is being cythonized into `((size_t)-1L)` and I hope the compiler takes care of it from there. It's maybe not so nice codewise, but I don't think it is any loss.
> 
> - in `out_neighbors_unsafe` and `in_neighbors_unsafe`, remove `cdef list l = []`, not used
Done.
> 
> 
> - I know that the documentation of cdef methods is not displayed, but it would be cleaner to follow the same standard than in the other parts of the code. For instance
> {{{#!diff
>         INPUT:
> -            u, v -- non-negative integers
> +
> +            - ``u, v`` -- non-negative integers
> }}}
>   Of course, we can do that in a future ticket. Not a priority here
Done. It's a rather large commit though as I went over all the places that "caught my eye".
> 
> 
> - methods `out_arcs_unsafe` and `in_arcs_unsafe` return lists. Why not changing to an iterator ? If I'm not mistaken, these methods are only used in for loops.
> 
> - same for method `all_arcs` which is used in a for loop and in some doctests where we could use `list(...)`.
> {{{
> confetti:sage dcoudert$ git grep -i "\.all_arcs" src/sage/
> src/sage/graphs/base/c_graph.pyx:            - :meth:`all_arcs <sage.graphs.base.sparse_graph.SparseGraph.all_arcs>`
> src/sage/graphs/base/c_graph.pyx:            sage: G.all_arcs(0, 1)
> src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(0,1)
> src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(1,2)
> src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(7,3)
> src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(0,1)
> src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(1,2)
> src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(5,4)
> src/sage/graphs/base/sparse_graph.pyx:            sage: G.all_arcs(1,2)
> src/sage/graphs/base/sparse_graph.pyx:        num_arcs = self.all_arcs_unsafe(u, v, arc_labels, size)
> src/sage/graphs/base/sparse_graph.pyx:            sage: G.all_arcs(0,1)
> src/sage/graphs/base/sparse_graph.pyx:            sage: G.all_arcs(0,1)
> src/sage/graphs/base/sparse_graph.pyx:                     for l_int in self._cg.all_arcs(u_int, v_int)]
> src/sage/graphs/base/sparse_graph.pyx:        for l_int in self._cg.all_arcs(u_int, v_int):
> }}}
> 
The last two I would leave for future tickets. But you are right. We really iterate over a structure that is already there (either over a bitset or a tree). So there is no use in wasting resources for creating this list.



---

archive/issue_comments_404453.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-12T13:48:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404453",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_404454.json:
```json
{
    "body": "OK to let the change from list to iterator for another ticket.\n\nLGTM.\n\nThank you.",
    "created_at": "2020-08-12T13:48:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404454",
    "user": "https://github.com/dcoudert"
}
```

OK to let the change from list to iterator for another ticket.

LGTM.

Thank you.



---

archive/issue_comments_404455.json:
```json
{
    "body": "Thanks.",
    "created_at": "2020-08-12T15:07:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404455",
    "user": "https://github.com/kliem"
}
```

Thanks.



---

archive/issue_events_026524.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2020-08-14T22:23:47Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28667#event-26524"
}
```



---

archive/issue_comments_404456.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-08-14T22:23:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28667#issuecomment-404456",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
