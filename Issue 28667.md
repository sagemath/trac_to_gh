# Issue 28667: Move reversed graph from backend to CGraph for sparse graphs

Issue created by migration from https://trac.sagemath.org/ticket/28904

Original creator: @kliem

Original creation time: 2019-12-21 00:44:43

CC:  vdelecroix dcoudert

Keywords: sparse graphs, backend

Currently, for sparse graphs the backend keeps a copy of the reversed graph. This makes iterating over ingoing neighbors much faster.

However, `SparseGraph` itself does not have access to this. So e.g. when deleting vertices, this results in a massive slow down as it needs to delete incoming edges.

We initialize the sparse backend with the reversed structure and instead add the reversed structure directly to `SparseGraph`.

Before this ticket:


```
sage: edges = [(randint(0,1000), randint(0,1000)) for _ in range(100000)]
sage: D = DiGraph(multiedges=True, loops=True)
sage: D.add_edges(edges)
sage: for i in range(1000): G.add_vertex(i)
sage: %time for i in range(100): D.delete_vertex(i)
CPU times: user 10.1 ms, sys: 0 ns, total: 10.1 ms
Wall time: 10.1 ms
```


With this ticket:


```
CPU times: user 4.4 ms, sys: 4 Âµs, total: 4.41 ms
Wall time: 4.41 ms
```



---

Comment by @kliem created at 2019-12-21 00:46:29

TBtw, there is a bug that leads to a crash with:


```
sage: G = DiGraph(2, data_structure='dense')
sage: G.add_edge(0,1)
sage: G.is_eulerian()
```


This ticket also fixes this (the method `in_degree` in the CGraph backend assumes `_cg_rev` to be initialized).


---

Comment by @kliem created at 2019-12-21 00:50:15

Changing status from new to needs_review.


---

Comment by @kliem created at 2019-12-21 00:50:15

This probably needs to be cleaned up a lot.
Is it going in a good direction?
On my side, all tests in graphs seem to succeed.
----
New commits:


---

Comment by @kliem created at 2019-12-21 10:31:36

One needs to be careful, about taking the same set of edges I guess.


---

Comment by git created at 2019-12-21 10:32:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2019-12-21 10:46:56

Thank you for doing this, it's really needed.

With these changes, `_cg_rev` is no longer initialized, right ? If it's no longer needed, may be we can remove it, but we have to ensure that no-one is using it. Actually I fear that some users are using it for personal code. I see 2 solutions for that:
1. send a pool to sage-dev for complete removal
2. maintain an object build from `_cg` with appropriate pointers, and add a warning in the documentation.


## in `sparse_graph.pyx`:

```diff
-            for i from 0 <= i < self.active_vertices.size * self.hash_length:
+            for i in range(self.active_vertices.size * self.hash_length):
```


I think you can simplify tests to `NULL`

```diff
-                while temp[0] != NULL:
+                while temp[0]:
```




```diff
-        Lists the in-neighbors of a vertex as BTNodes
+        List the in-neighbors of a vertex as BTNodes
```



```diff
-        Builds the list of arcs into a vertex.
+        Build the list of arcs into a vertex.
```



```diff
-        Adds arc (u, v) to the graph with label l.
+        Add arc (u, v) to the graph with label l.
```


Better to use `True` and `False` instead of 0 and 1.

```diff
-        cdef int u_int = self.check_labelled_vertex(u, 0)
-        cdef int v_int = self.check_labelled_vertex(v, 0)
+        cdef int u_int = self.check_labelled_vertex(u, False)
+        cdef int v_int = self.check_labelled_vertex(v, False)
```



## in `c_graph.pyx` we can do some extra optimisations, like

in `verts`

```diff
-        cdef int i
-        return [i for i in range(<int>self.active_vertices.size)
-                if bitset_in(self.active_vertices, i)]
+       return bitset_list(self.active_vertices)
```


in `iterator_verts`

```diff
-            for i in range(self._cg.active_vertices.size):
-                if (bitset_in(self._cg.active_vertices, i)
-                    and i not in self.vertex_labels
-                    and i not in self.vertex_ints):
-                        yield i
+            i = bitset_first(self._cg.active_vertices)
+            while i >= 0:
+                if (i not in self.vertex_labels
+                    and i not in self.vertex_ints):
+                        yield i
+                i = bitset_next(self._cg.active_vertices, i + 1)
```



---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by @kliem created at 2020-01-07 19:30:44

New commits:


---

Comment by git created at 2020-01-07 21:03:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-01-07 21:25:41

Thanks for the comments.

Replying to [comment:6 dcoudert]:
> 
> in `iterator_verts`
> {{{#!diff
> -            for i in range(self._cg.active_vertices.size):
> -                if (bitset_in(self._cg.active_vertices, i)
> -                    and i not in self.vertex_labels
> -                    and i not in self.vertex_ints):
> -                        yield i
> +            i = bitset_first(self._cg.active_vertices)
> +            while i >= 0:
> +                if (i not in self.vertex_labels
> +                    and i not in self.vertex_ints):
> +                        yield i
> +                i = bitset_next(self._cg.active_vertices, i + 1)
> }}}

Fixing this makes a mistake apparent: There is a doctest in `generic_graph.py` that subdivides all edges of a graph by using `self.edges()`. However, one should not iterate over an `EdgesView` object while modifying the graph. I have modified the method `subdivide_edges` to generate a tuple from `EdgesView`.


---

Comment by git created at 2020-01-07 21:26:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2020-01-08 12:07:09

* I have some compilation warnings. It's better to check if it's possible to avoid.

```
[2/4] gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -I./sage/cpython -I./sage/libs/ntl -I/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/cysignals -Isage/cpython -I./sage/rings -I/Users/dcoudert/sage3/sage/local/include -I/Users/dcoudert/sage3/sage/src -I/Users/dcoudert/sage3/sage/src/sage/ext -I/Users/dcoudert/sage3/sage/local/include/python3.7m -I/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/numpy/core/include -Ibuild/cythonized -I/Users/dcoudert/sage3/sage/local/include/python3.7m -c build/cythonized/sage/graphs/base/c_graph.cpp -o build/temp.macosx-10.9-x86_64-3.7/build/cythonized/sage/graphs/base/c_graph.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -std=c++11
build/cythonized/sage/graphs/base/c_graph.cpp:16256:48: warning: comparison of integers of different signs: 'size_t' (aka 'unsigned long') and 'long' [-Wsign-compare]
      __pyx_t_2 = ((__pyx_cur_scope->__pyx_v_i != -1L) != 0);
                    ~~~~~~~~~~~~~~~~~~~~~~~~~~ ^  ~~~
1 warning generated.
g++ -bundle -undefined dynamic_lookup -L/Users/dcoudert/sage3/sage/local/lib -Wl,-rpath,/Users/dcoudert/sage3/sage/local/lib -L/usr/local/opt/openssl/lib -L. -L/Users/dcoudert/sage3/sage/local/lib -Wl,-rpath,/Users/dcoudert/sage3/sage/local/lib -L/usr/local/opt/openssl/lib -L/Users/dcoudert/sage3/sage/local/lib -Wl,-rpath,/Users/dcoudert/sage3/sage/local/lib build/temp.macosx-10.9-x86_64-3.7/build/cythonized/sage/graphs/base/c_graph.o -L/Users/dcoudert/sage3/sage/local/lib -L/Users/dcoudert/sage3/sage/local/lib -lgmp -lstdc++ -o build/lib.macosx-10.9-x86_64-3.7/sage/graphs/base/c_graph.cpython-37m-darwin.so -lpari
[3/4] gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -I./sage/cpython -Isage/cpython -I/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/cysignals -I/Users/dcoudert/sage3/sage/local/include -I/Users/dcoudert/sage3/sage/src -I/Users/dcoudert/sage3/sage/src/sage/ext -I/Users/dcoudert/sage3/sage/local/include/python3.7m -I/Users/dcoudert/sage3/sage/local/lib/python3.7/site-packages/numpy/core/include -Ibuild/cythonized -I/Users/dcoudert/sage3/sage/local/include/python3.7m -c build/cythonized/sage/graphs/base/sparse_graph.c -o build/temp.macosx-10.9-x86_64-3.7/build/cythonized/sage/graphs/base/sparse_graph.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 -std=c99
build/cythonized/sage/graphs/base/sparse_graph.c:11350:35: warning: comparison of integers of different signs: 'size_t' (aka 'unsigned long') and 'int' [-Wsign-compare]
    for (__pyx_t_5 = 0; __pyx_t_5 < __pyx_t_4; __pyx_t_5+=1) {
                        ~~~~~~~~~ ^ ~~~~~~~~~
build/cythonized/sage/graphs/base/sparse_graph.c:11384:35: warning: comparison of integers of different signs: 'size_t' (aka 'unsigned long') and 'int' [-Wsign-compare]
    for (__pyx_t_5 = 0; __pyx_t_5 < __pyx_t_4; __pyx_t_5+=1) {
                        ~~~~~~~~~ ^ ~~~~~~~~~
build/cythonized/sage/graphs/base/sparse_graph.c:19114:87: warning: incompatible pointer types passing 'struct __pyx_obj_4sage_6graphs_4base_7c_graph_CGraph *' to parameter of
      type 'struct __pyx_obj_4sage_6graphs_4base_12sparse_graph_SparseGraph *' [-Wincompatible-pointer-types]
  ...((struct __pyx_obj_4sage_6graphs_4base_7c_graph_CGraph *)((struct __pyx_obj_4sage_6graphs_4base_12sparse_graph_SparseGraph *)__pyx_v_self->__pyx_base._cg)), __pyx_v_u_int...
     ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
build/cythonized/sage/graphs/base/sparse_graph.c:9396:149: note: passing argument to parameter '__pyx_v_self' here
static int __pyx_f_4sage_6graphs_4base_12sparse_graph_11SparseGraph_has_arc_unsafe(struct __pyx_obj_4sage_6graphs_4base_12sparse_graph_SparseGraph *__pyx_v_self, int __pyx...
                                                                                                                                                    ^
build/cythonized/sage/graphs/base/sparse_graph.c:25037:87: warning: incompatible pointer types passing 'struct __pyx_obj_4sage_6graphs_4base_7c_graph_CGraph *' to parameter of
      type 'struct __pyx_obj_4sage_6graphs_4base_12sparse_graph_SparseGraph *' [-Wincompatible-pointer-types]
  ...((struct __pyx_obj_4sage_6graphs_4base_7c_graph_CGraph *)((struct __pyx_obj_4sage_6graphs_4base_12sparse_graph_SparseGraph *)__pyx_v_self->__pyx_base._cg)), __pyx_v_u_int...
     ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
build/cythonized/sage/graphs/base/sparse_graph.c:9396:149: note: passing argument to parameter '__pyx_v_self' here
static int __pyx_f_4sage_6graphs_4base_12sparse_graph_11SparseGraph_has_arc_unsafe(struct __pyx_obj_4sage_6graphs_4base_12sparse_graph_SparseGraph *__pyx_v_self, int __pyx...
                                                                                                                                                    ^
4 warnings generated.
}}} 

* method `del_arc_unsafe` returns nothing

* in method `del_arc_label_unsafe`, can't we do this (not sure if it's better or not):
{{{#!diff
-        cdef int error = self._del_arc_label_unsafe(u, v, l, self.vertices)
-        if error:
-            return 1 # indicate an error
+        if self._del_arc_label_unsafe(u, v, l, self.vertices):
+            return 1 # indicate an error
}}}

* Thanks for correcting `subdivise_edges`.

I confirm that vertex deletion is much faster now.


---

Comment by @kliem created at 2020-01-08 16:02:45

There are tons of compilation warnings, as we include all of `bitset.pxi`, which is annoying, but of course not serious.

The compilation warning about wrong casting of `self._cg` is a bit tricky. I think I took care of it now. The problem is that `SparseGraphBackend` casts the `SparseGraph` to a `CGraph` in order to assign it to `self._cg`, which is declared to be a `CGraph`. This is later on casted back into a `SpareGraph`, which of course produces a warning.

My approach now: Remove the attribute `_cg` from `CGraphBackend` and add it to the inherited backends with the proper declaration. Add an inline method `cg`, which returns `_cg` casted to a `CGraph`. This is cleaner, I think.


---

Comment by git created at 2020-01-08 16:03:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2020-01-09 17:13:45

I'm happy with the current code, but it would be better to get extra opinion (e.g., from the thread [https://groups.google.com/forum/#!topic/sage-devel/2eIaD3r8Vl8](https://groups.google.com/forum/#!topic/sage-devel/2eIaD3r8Vl8)).


---

Comment by @kliem created at 2020-01-09 19:37:56

There remains the question, whether we should remove `cg_rev` altogether and whether we should do it now.

The advantage of removing it, is that code referring to it won't compile anymore and/or give a proper warning. Currently, if one assumes this to be initialized and uses it in cython, sage might crash hard (segmentation fault I believe).


---

Comment by git created at 2020-01-14 08:21:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-01-14 08:25:35

I removed the attribute `_cg_rev` now.

The method `check_labelled_vertex` just ignores the input `reverse` now.

The method `c_graph` return `(self._cg, None)` instead of `(self._cg, self._cg_rev)`.


---

Comment by vdelecroix created at 2020-02-15 15:33:33

Why

```
diff --git a/src/sage/graphs/generic_graph.py b/src/sage/graphs/generic_graph.py
index 139c8df..4fa7f75 100644
--- a/src/sage/graphs/generic_graph.py
+++ b/src/sage/graphs/generic_graph.py
@@ -11001,6 +11001,8 @@ class GenericGraph(GenericGraph_pyx):
 
             - :meth:`subdivide_edge` -- subdivides one edge
         """
+        if isinstance(edges, EdgesView):
+            edges = tuple(edges)
```



---

Comment by dcoudert created at 2020-02-15 16:19:00

This is independent from the purpose of this ticket, but this is effectively an issue to be fixed.


---

Comment by @kliem created at 2020-02-15 16:24:01

I updated the description of the ticket to account for the change.


---

Comment by mkoeppe created at 2020-04-14 19:41:51

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.


---

Comment by mkoeppe created at 2020-08-11 17:31:11

What's the status of this ticket?


---

Comment by @kliem created at 2020-08-11 20:24:38

Needs review.

It's annoying to check, I guess. But it would be a nice improvements with many applications. Maybe I should request a review on sage-devel.


---

Comment by dcoudert created at 2020-08-12 08:41:16

overall, it's a very nice improvement. I have only a few suggestions.

**`sparse_graph.pyx`**
-  instead of checking `self.vertices != self.vertices_rev`, we could store a boolean value `self._directed` and have a method `self.is_directed())`.

- instead of `<size_t>-1`, don't we have a constant equal to the max value ? This is something we should do in several places in the code. Could be done in dedicated tickets

- in `out_neighbors_unsafe` and `in_neighbors_unsafe`, remove `cdef list l = []`, not used


- I know that the documentation of cdef methods is not displayed, but it would be cleaner to follow the same standard than in the other parts of the code. For instance

```diff
        INPUT:
-            u, v -- non-negative integers
+
+            - ``u, v`` -- non-negative integers
```

  Of course, we can do that in a future ticket. Not a priority here


- methods `out_arcs_unsafe` and `in_arcs_unsafe` return lists. Why not changing to an iterator ? If I'm not mistaken, these methods are only used in for loops.

- same for method `all_arcs` which is used in a for loop and in some doctests where we could use `list(...)`.

```
confetti:sage dcoudert$ git grep -i "\.all_arcs" src/sage/
src/sage/graphs/base/c_graph.pyx:            - :meth:`all_arcs <sage.graphs.base.sparse_graph.SparseGraph.all_arcs>`
src/sage/graphs/base/c_graph.pyx:            sage: G.all_arcs(0, 1)
src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(0,1)
src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(1,2)
src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(7,3)
src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(0,1)
src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(1,2)
src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(5,4)
src/sage/graphs/base/sparse_graph.pyx:            sage: G.all_arcs(1,2)
src/sage/graphs/base/sparse_graph.pyx:        num_arcs = self.all_arcs_unsafe(u, v, arc_labels, size)
src/sage/graphs/base/sparse_graph.pyx:            sage: G.all_arcs(0,1)
src/sage/graphs/base/sparse_graph.pyx:            sage: G.all_arcs(0,1)
src/sage/graphs/base/sparse_graph.pyx:                     for l_int in self._cg.all_arcs(u_int, v_int)]
src/sage/graphs/base/sparse_graph.pyx:        for l_int in self._cg.all_arcs(u_int, v_int):
```



---

Comment by @kliem created at 2020-08-12 10:19:24

New commits:


---

Comment by @kliem created at 2020-08-12 10:27:04

Replying to [comment:25 dcoudert]:
> overall, it's a very nice improvement. I have only a few suggestions.
> 
> **`sparse_graph.pyx`**
> -  instead of checking `self.vertices != self.vertices_rev`, we could store a boolean value `self._directed` and have a method `self.is_directed())`.
Done.
> 
> - instead of `<size_t>-1`, don't we have a constant equal to the max value ? This is something we should do in several places in the code. Could be done in dedicated tickets
This is being cythonized into `((size_t)-1L)` and I hope the compiler takes care of it from there. It's maybe not so nice codewise, but I don't think it is any loss.
> 
> - in `out_neighbors_unsafe` and `in_neighbors_unsafe`, remove `cdef list l = []`, not used
Done.
> 
> 
> - I know that the documentation of cdef methods is not displayed, but it would be cleaner to follow the same standard than in the other parts of the code. For instance
> {{{#!diff
>         INPUT:
> -            u, v -- non-negative integers
> +
> +            - ``u, v`` -- non-negative integers
> }}}
>   Of course, we can do that in a future ticket. Not a priority here
Done. It's a rather large commit though as I went over all the places that "caught my eye".
> 
> 
> - methods `out_arcs_unsafe` and `in_arcs_unsafe` return lists. Why not changing to an iterator ? If I'm not mistaken, these methods are only used in for loops.
> 
> - same for method `all_arcs` which is used in a for loop and in some doctests where we could use `list(...)`.
> {{{
> confetti:sage dcoudert$ git grep -i "\.all_arcs" src/sage/
> src/sage/graphs/base/c_graph.pyx:            - :meth:`all_arcs <sage.graphs.base.sparse_graph.SparseGraph.all_arcs>`
> src/sage/graphs/base/c_graph.pyx:            sage: G.all_arcs(0, 1)
> src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(0,1)
> src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(1,2)
> src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(7,3)
> src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(0,1)
> src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(1,2)
> src/sage/graphs/base/sparse_graph.pyx:    sage: S.all_arcs(5,4)
> src/sage/graphs/base/sparse_graph.pyx:            sage: G.all_arcs(1,2)
> src/sage/graphs/base/sparse_graph.pyx:        num_arcs = self.all_arcs_unsafe(u, v, arc_labels, size)
> src/sage/graphs/base/sparse_graph.pyx:            sage: G.all_arcs(0,1)
> src/sage/graphs/base/sparse_graph.pyx:            sage: G.all_arcs(0,1)
> src/sage/graphs/base/sparse_graph.pyx:                     for l_int in self._cg.all_arcs(u_int, v_int)]
> src/sage/graphs/base/sparse_graph.pyx:        for l_int in self._cg.all_arcs(u_int, v_int):
> }}}
> 
The last two I would leave for future tickets. But you are right. We really iterate over a structure that is already there (either over a bitset or a tree). So there is no use in wasting resources for creating this list.


---

Comment by dcoudert created at 2020-08-12 13:48:24

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2020-08-12 13:48:24

OK to let the change from list to iterator for another ticket.

LGTM.

Thank you.


---

Comment by @kliem created at 2020-08-12 15:07:46

Thanks.


---

Comment by vbraun created at 2020-08-14 22:23:47

Resolution: fixed
