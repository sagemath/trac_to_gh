# Issue 10040: Doctest failure in sage/tensor/differential_forms.py

Issue created by migration from https://trac.sagemath.org/ticket/10041

Original creator: mpatel

Original creation time: 2010-09-30 21:43:00

Assignee: mvngu

CC:  jason jvkersch mhampton niles

With the forthcoming 4.6.alpha2, I get this doctest failure on the Skynet machines cicero (x86-Linux-pentium4-fc) and fulvia (x86_64-SunOS-core2):

```python
sage -t -long "devel/sage/sage/tensor/differential_forms.py"
**********************************************************************
File "/home/mpatel/build/cicero/sage-4.6.alpha2/devel/sage/sage/tensor/differential_forms.py", line 132:
    sage: cmp(F, G)
Expected:
    1
Got:
    -1
```



---

Comment by jvkersch created at 2010-10-01 17:54:36

I will need to think some more about this.  After hearing about this bug, I built 4.6.alpha2 on my Mac OS 10.6 machine and ran the doctests there, all of which passed without errors.


```
./sage -t -long "devel/sage/sage/tensor/differential_forms.py"
sage -t -long "devel/sage/sage/tensor/differential_forms.py"
	 [4.8 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 4.8 seconds
```


I am currently building Sage on my Linux machine and hope to be able to reproduce that bug shortly.  In the meantime, could this be due to `cmp` behaving differently on different platforms?  This would seem very weird to me...


---

Comment by jason created at 2010-10-01 18:43:18

The problem seems to be in the coordinate patch code, I think.

Notice that:


```
sage: var('x,y,z')
(x, y, z)
sage: (x,y,z)<(y,x,z)
x < y
```


I think that comparing tuples of symbolic variables is not well-defined.  Instead, you might compare strings (i.e., call str() on each tuple)


---

Comment by jason created at 2010-10-01 18:44:24

Do you really want to force an order on these things, or would it be enough to only define an equality-checking function?


---

Comment by jvkersch created at 2010-10-01 19:30:52

Thanks Jason!  I am uploading a patch to convert the tuples of coordinates to strings before comparing and I hope this solves the issue.  I'm not sure we should ignore the order in coordinate tuples.  For instance, T(T*Q) has natural bundle coordinates (q, p, q', p') whereas T*(TQ) naturally has coordinates (q, q', p, p').  The two bundles are isomorphic by switching the relevant coordinates, but it would be good to keep the distinction.

Time permitting, I will build Sage again on my Linux machine to make sure that the issue is resolved.


---

Attachment

The failing doctest now passes for me on cicero and fulvia.  If someone else can confirm that it passes on some other machines (on ones where it passed before, we should make sure it still passes), feel free to give it a positive review.

Should this ticket be marked as "needs review"?


---

Comment by jason created at 2010-10-01 20:17:30

Changing status from new to needs_review.


---

Comment by jason created at 2010-10-01 20:17:30

Replying to [comment:5 jvkersch]:
> Thanks Jason!  I am uploading a patch to convert the tuples of coordinates to strings before comparing and I hope this solves the issue.  I'm not sure we should ignore the order in coordinate tuples.  For instance, T(T*Q) has natural bundle coordinates (q, p, q', p') whereas T*(TQ) naturally has coordinates (q, q', p, p').  The two bundles are isomorphic by switching the relevant coordinates, but it would be good to keep the distinction.
> 

I meant, do you want to force a total order on the set of coordinates?  In other words, what does (q,q',p,p')<(q,p,q',p') mean?  Or do you just want to have equality testing, i.e., you can tell that (q,q',p,p') != (q,p,q',p')?

Regardless, I think resolving that design issue should be a separate ticket.


---

Comment by jvkersch created at 2010-10-02 00:18:19

Replying to [comment:7 jason]:
> 
> I meant, do you want to force a total order on the set of coordinates? 
>

Good point -- that wouldn't make sense indeed.

> 
> Regardless, I think resolving that design issue should be a separate ticket.
> 

I've put this up for review as #10053.  This patch just takes out the calls to the `__cmp__` member functions and replaces them with equivalent calls to `__eq__`.


---

Comment by drkirkby created at 2010-10-02 16:33:52

I also see this on OpenSolaris on x86 on the clean 4.6.alpha1 code. I don't feel able to comment on the patches. 


```
sage -t  -long devel/sage/sage/tensor/differential_forms.py
**********************************************************************
File "/export/home/drkirkby/sage-4.6.alpha2/devel/sage-main/sage/tensor/differential_forms.py", line 132:
    sage: cmp(F, G)
Expected:
    1
Got:
    -1
**********************************************************************
1 items had failures:
   1 of  11 in __main__.example_3
***Test Failed*** 1 failures.
For whitespace errors, see the file /export/home/drkirkby/.sage//tmp/.doctest_differential_forms.py
```



---

Comment by cremona created at 2010-10-03 11:02:47

The patch works for me (tests in that one file pass, which used to fail);  I have not tested the whole library, just sage/tensor/*.  This is on 32-bit ubuntu.


---

Comment by jvkersch created at 2010-10-04 23:45:06

For what it's worth, `make ptestlong` tells me that all tests passed on my 64bit Linux machine (CentOS Linux 5.5).


---

Comment by niles created at 2010-10-05 14:58:18

I applied this patch, and the one at #10053.  With these, sage passes all (`-long`) doctests (linux, with Red Hat Enterprise).  Note that the remaining issue, [comment 9](http://trac.sagemath.org/sage_trac/ticket/10041#comment:9) above, appears because this patch addresses comparison only for coordinate patches, not differential form algebras or differential form elements.  Since these _are_ addressed by #10053, this ticket can get positive review when that one does.


---

Comment by niles created at 2010-10-11 21:33:47

Replying to [comment:12 niles]:
> I applied this patch, and the one at #10053.  With these, sage passes all (`-long`) doctests (linux, with Red Hat Enterprise).  Note that the remaining issue, [comment 9](http://trac.sagemath.org/sage_trac/ticket/10041#comment:9) above, appears because this patch addresses comparison only for coordinate patches, not differential form algebras or differential form elements.  Since these _are_ addressed by #10053, this ticket can get positive review when that one does.


#10053 now has positive review.


---

Comment by niles created at 2010-10-11 21:33:47

Changing status from needs_review to positive_review.


---

Comment by leif created at 2010-10-21 02:52:40

Just for the record:

I now get this doctest error after upgrade-testing (#9896) with Sage 4.6.alpha3 (in-place upgrade from 4.5.3) on Ubuntu 9.04 x86, Pentium4 Prescott with SSE enabled (in CFLAGS and CXXFLAGS).

In the build from scratch on the same machine, with the same settings, I didn't get that error.


---

Comment by mpatel created at 2010-10-21 08:42:32

Resolution: fixed
