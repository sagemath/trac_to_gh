# Issue 17615: Small cleanup in rings.arith and rings.integer

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2015-02-25 13:38:16

In this ticket:
 - we implement the two functions `prime_part_m` and `binomial` directly as methods of Sage integers and get rid of the `late_import` in `sage.rings.integer`
 - simplify the import logic in `rings.arith`
 - replace in arith `prod([x for x in hum])` by `prod(x for x in hum)`
 - remove some useless comments in arith


---

Comment by vdelecroix created at 2015-02-25 13:39:57

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2015-02-25 13:39:57

New commits:


---

Comment by jdemeyer created at 2015-02-25 13:48:26

Conflicts with #17819


---

Comment by jdemeyer created at 2015-02-25 13:49:07

I suggest you revert all changes to `Integer.divisors`


---

Comment by vdelecroix created at 2015-02-25 13:52:57

Replying to [comment:3 jdemeyer]:
> I suggest you revert all changes to `Integer.divisors`

there is none...

EDIT: there are... I messed up my develop branch!


---

Comment by git created at 2015-02-25 13:58:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-02-25 13:58:34

No conflicts anymore...


---

Comment by jdemeyer created at 2015-02-25 15:00:59

Changing type from PLEASE CHANGE to enhancement.


---

Comment by jdemeyer created at 2015-02-25 15:48:33

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-02-25 15:48:33

I don't like this:

```
cdef mpz_t g = <mpz_t> mm.value
```


Just use `mm.value` instead of `g`.


---

Comment by jdemeyer created at 2015-02-25 15:50:12

`isinstance(z, (Rational))` -> `isinstance(z, Rational)`


---

Comment by jdemeyer created at 2015-02-25 15:53:39

What's the point of `eratosthenes()`, shouldn't that be a `deprecated_function_alias` of `prime_range`?


---

Comment by jdemeyer created at 2015-02-25 15:55:39

Remove this:

```
    TESTS::

        sage:
```



---

Comment by jdemeyer created at 2015-02-25 15:58:01

For `is_squarefree`, add an example where the `.is_squarefree()` method is not used, for example `ZZ[sqrt(-1)]`.


---

Comment by jdemeyer created at 2015-02-25 15:59:48


```
if isinstance(x, Integer):
    return x.binomial(m, **kwds)
```

should be `try`/`except AttributeError`


---

Comment by jdemeyer created at 2015-02-25 16:00:35

Replace

```
try:
    P = x.parent()
except AttributeError:
    P = type(x)
if m < 0:
    return P(0)
```

by

```
if m < 0:
    return parent(x)(0)
```



---

Comment by jdemeyer created at 2015-02-25 16:05:35

And `powermodm_ui` should be a deprecated alias for `powermod`: what's the point of an optimized path for `unsigned long` in a *Python function*?

Then you can also remove

```
MAX_UNSIGNED_LONG = 2 * sys.maxsize
```

(which is wrong anyway!)


---

Comment by jdemeyer created at 2015-02-25 16:06:22


```
if not self:
    raise ValueError("self must be nonzero")
```

should be `ArithmeticError` instead.


---

Comment by jdemeyer created at 2015-02-25 16:08:17


```
The argument ``m`` or (``self-m``) must fits into unsigned long::
```

`fits` -> `fit`


---

Comment by jdemeyer created at 2015-02-25 16:09:30

I'm done for now :-)


---

Comment by git created at 2015-02-25 17:20:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-02-25 17:42:17

Replying to [comment:10 jdemeyer]:
> What's the point of `eratosthenes()`, shouldn't that be a `deprecated_function_alias` of `prime_range`?

It is excplicitely written "for educational purpose"... I do not want to deprecate it so roughly.

I agreed with all of the other suggestions and implemented them.

Vincent


---

Comment by vdelecroix created at 2015-02-25 17:42:17

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-02-25 18:59:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-02-25 20:55:35

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2015-02-25 20:56:04

just testing... didn't have a problem changing the status.


---

Comment by vbraun created at 2015-02-25 20:56:04

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-02-26 22:01:12

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-02-26 22:01:12

Needs to be rebased on #16878.


---

Comment by git created at 2015-02-28 21:29:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-02-28 21:29:54

Rebased over #16878


---

Comment by vdelecroix created at 2015-02-28 21:29:54

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2015-03-05 09:44:47

This looks dubious to me:

```
-    R = parent(n)
-    if R in [int, long]:
+    if isinstance(int, long):
```



---

Comment by jdemeyer created at 2015-03-05 09:57:02

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-03-06 01:05:16

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-03-06 01:05:16

Replying to [comment:27 chapoton]:
> This looks dubious to me:
> {{{
> -    R = parent(n)
> -    if R in [int, long]:
> +    if isinstance(int, long):
> }}}

EDIT: you are definitely right... see the commit below!

If an object `n` is not a Sage Element `parent(n)` returns the type of `n`.

```
sage: parent(3r)
<type 'int'>
sage: parent(Graph())
<class 'sage.graphs.graph.Graph'>
```

The code `parent(n) in [int,long]` is (roughly) equivalent to `type(n) in [int,long]`. I find much cleaner to use `isinstance`. If you do have a use case for which there is a difference, then please tell me.

Vincent


---

Comment by git created at 2015-03-06 07:38:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-03-06 16:30:18

I get a doc builder error (but I closed my session, so I cannot copy the error message now)


---

Comment by jdemeyer created at 2015-03-06 16:30:18

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2015-03-06 16:36:20

please replace the first :: by : in

```
 TESTS::
+ Check that output are always Sage integers (:trac:`922`)::
```



---

Comment by git created at 2015-03-07 16:50:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-03-07 16:50:45

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-03-09 10:11:31

Why did you remove many doctests of `prime_powers()`? In particular this test:

```
prime_powers(95,1234)
```



---

Comment by jdemeyer created at 2015-03-09 10:18:12

In `prime_powers`, why do you only allow `Integer`, `int` and `long`? Why not

```
if not isinstance(start, Integer):
    start = Integer(start)
```

Then you don't need to `raise TypeError` explicitly, as `Integer(start)` will do that if needed.


---

Comment by jdemeyer created at 2015-03-09 10:18:12

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-03-09 10:33:00

Replace

```
if isinstance(x, (float, complex, RealNumber, RealLiteral, ComplexNumber))
```

by

```
if isinstance(x, (float, complex, RealNumber, ComplexNumber))
```



---

Comment by jdemeyer created at 2015-03-09 10:48:20

Why

```
P(1) * x.binomial(m, **kwds)
```

and not

```
x.binomial(m, **kwds)
```

or

```
P(x.binomial(m, **kwds))
```



---

Comment by jdemeyer created at 2015-03-09 10:54:20

For the binomial function: the documentation mentions

```
Either ``m`` or ``x-m`` must be an integer.
```

but the code doesn't reflect this.

I think therefore you need

```
try:
    m = Integer(m)
except TypeError:
    m = Integer(x - m)
```

Also, a doctest should be added for this case.


---

Comment by jdemeyer created at 2015-03-09 10:56:10

And the conversion of `x` to `ZZ` should be added after the PARI branch.


---

Comment by jdemeyer created at 2015-03-09 10:57:51


```
sage -t --long src/sage/rings/integer.pyx
**********************************************************************
File "src/sage/rings/integer.pyx", line 6118, in sage.rings.integer.Integer.binomial
Failed example:
    alarm(0.1); (2**100).binomial(2**30, algorithm='pari')
Expected:
    Traceback (most recent call last):
    ...
    AlarmInterrupt
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 492, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 854, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.integer.Integer.binomial[12]>", line 1, in <module>
        alarm(RealNumber('0.1')); (Integer(2)**Integer(100)).binomial(Integer(2)**Integer(30), algorithm='pari')
      File "sage/rings/integer.pyx", line 6154, in sage.rings.integer.Integer.binomial (build/cythonized/sage/rings/integer.c:36402)
        return the_integer_ring(self._pari_().binomial(mm))
      File "sage/libs/pari/gen.pyx", line 5379, in sage.libs.pari.gen.gen.binomial (build/cythonized/sage/libs/pari/gen.c:25503)
        pari_catch_sig_on()
      File "sage/libs/pari/handle_error.pyx", line 163, in sage.libs.pari.handle_error._pari_err_handle (build/cythonized/sage/libs/pari/handle_error.c:2656)
        pari_instance.allocatemem(silent=True)
      File "sage/libs/pari/pari_instance.pyx", line 1122, in sage.libs.pari.pari_instance.PariInstance.allocatemem (build/cythonized/sage/libs/pari/pari_instance.c:7709)
        init_stack(s)
      File "sage/libs/pari/pari_instance.pyx", line 1657, in sage.libs.pari.pari_instance.init_stack (build/cythonized/sage/libs/pari/pari_instance.c:11894)
        raise MemoryError("Unable to allocate %s bytes for the PARI stack (instead, allocated %s bytes)"%(failed_size, new_size))
    MemoryError: Unable to allocate 6400000000 bytes for the PARI stack (instead, allocated 5120000000 bytes)
**********************************************************************
1 item had failures:
   1 of  14 in sage.rings.integer.Integer.binomial
    [1031 tests, 1 failure, 10.74 s]
sage -t --long src/doc/en/developer/coding_basics.rst
**********************************************************************
File "src/doc/en/developer/coding_basics.rst", line 845, in doc.en.developer.coding_basics
Failed example:
    z.powermodm_ui(2^32-1, 14)
Expected:
    8                                                               
Got:
    doctest:1: DeprecationWarning: powermodm_ui is deprecated. Please use powermod instead.
    See http://trac.sagemath.org/17852 for details.
    8
**********************************************************************
```



---

Comment by git created at 2015-03-13 21:54:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-03-13 21:55:01

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-03-13 21:55:41

Replying to [comment:41 jdemeyer]:
> And the conversion of `x` to `ZZ` should be added after the PARI branch.

Why?


---

Comment by vdelecroix created at 2015-03-13 21:57:47

Replying to [comment:39 jdemeyer]:
> Why
> {{{
> P(1) * x.binomial(m, **kwds)
> }}}
> and not
> {{{
> x.binomial(m, **kwds)
> }}}

Done


---

Comment by vdelecroix created at 2015-03-13 21:59:10

Replying to [comment:42 jdemeyer]:
> {{{
> sage -t --long src/sage/rings/integer.pyx
> **********************************************************************
> File "src/sage/rings/integer.pyx", line 6118, in sage.rings.integer.Integer.binomial
> Failed example:
>     alarm(0.1); (2**100).binomial(2**30, algorithm='pari')
> ...
> }}}

For the doctest I put more reasonable values for which the call took 2 sec on my computer. I also decrease the alarm time to `0.01`. Does this look better?


---

Comment by jdemeyer created at 2015-03-13 22:16:35

I'm not sure that I like this:

```
sage: a = binomial(float(1001), float(1)); a
1001.0
sage: type(a)
<type 'sage.rings.real_double.RealDoubleElement'>
```


Shouldn't `float` input also give `float` output?


---

Comment by jdemeyer created at 2015-03-13 22:18:06

Replying to [comment:47 vdelecroix]:
> For the doctest I put more reasonable values for which the call took 2 sec on my computer. I also decrease the alarm time to `0.01`. Does this look better?

The problem wasn't time, the problem was memory. We should find input for which the call needs at most 2GB of memory.


---

Comment by vdelecroix created at 2015-03-14 07:50:48

Replying to [comment:49 jdemeyer]:
> Replying to [comment:47 vdelecroix]:
> > For the doctest I put more reasonable values for which the call took 2 sec on my computer. I also decrease the alarm time to `0.01`. Does this look better?
> 
> The problem wasn't time, the problem was memory. We should find input for which the call needs at most 2GB of memory.

I also changed the values to `(2**100).binomial(2**19)` (it is a number with 43223705 bits). At least on my computer, the RAM used stays below 2G.


---

Comment by vdelecroix created at 2015-03-14 08:07:18

There is a test in `doc/en/developer/coding_basics.rst` that uses `Integer.powermod_ui` as an example for difference behavior for 32 bits and 64 bits. Do you have an other example in mind?

Replying to [comment:48 jdemeyer]:
> I'm not sure that I like this:
> {{{
> sage: a = binomial(float(1001), float(1)); a
> 1001.0
> sage: type(a)
> <type 'sage.rings.real_double.RealDoubleElement'>
> }}}
> 
> Shouldn't `float` input also give `float` output?

Right. On the previous version we had

```
sage: type(binomial(5r,2r))
<type 'int'>
sage: type(binomial(5r,2))
<type 'sage.rings.integer.Integer'>
sage: type(binomial(5,2r))
<type 'sage.rings.integer.Integer'>
```

I will change that.


---

Comment by vdelecroix created at 2015-03-14 08:07:18

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-03-14 08:11:37

There was also no care of the output type for rational input

```
sage: type(binomial(5/1,3/1))
<type 'sage.rings.integer.Integer'>
```

(in sage-6.5)


---

Comment by jdemeyer created at 2015-03-14 08:11:50


```
            sage: hash(-920390823904823094890238490238484)
            -873977844            # 32-bit
            6874330978542788722   # 64-bit
```



---

Comment by vdelecroix created at 2015-03-14 08:23:17

Replying to [comment:53 jdemeyer]:
> {{{
>             sage: hash(-920390823904823094890238490238484)
>             -873977844            # 32-bit
>             6874330978542788722   # 64-bit
> }}}

Thanks!

I also noticed that on large input `pari` is faster than `mpir`:

```
sage: %timeit a = (2**50).binomial(2**10, algorithm='mpir')
1000 loops, best of 3: 462 µs per loop
sage: %timeit a = (2**50).binomial(2**10, algorithm='pari')
1000 loops, best of 3: 221 µs per loop
```

and the difference is even more significant with larger numbers... I will had a note related to that.

Finally, I have troubles with the modification of the output type in `arith.binomial` ([comment:48 comment:48], [comment:51 comment:51] and [comment:52 comment:52]). It is responsible for some doctest failure in `rings/polynomial/multi_polynomial_ideal.py` (the random generation stuff). I was not able to track down the issue.


---

Comment by git created at 2015-03-14 14:26:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-03-14 14:34:34

Before doing coercion, what matters is the `parent()`, not the `type()` which should be equal.


---

Comment by git created at 2015-03-14 14:39:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-03-14 21:15:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-03-14 21:24:35

For the strange doctest failure responsible for commit ​61b94c2 see [this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/kYovnNz7NmM).


---

Comment by vdelecroix created at 2015-03-14 21:24:35

Changing status from needs_work to needs_review.


---

Comment by rws created at 2015-03-15 10:01:33

I'm not sure if `rings/arith.py:binomial` should do more than numerics because the console user will first see `functions/other.py:binomial` and use that. The programmer OTOH probably won't need other than numerics. So, your efforts in `rings/arith.py:binomial` regarding other rings looks wasted to me.

There is already #17489 removing function duplicity for `factorial` so this is something to think of.


---

Comment by vdelecroix created at 2015-03-15 10:18:09

Replying to [comment:61 rws]:
> I'm not sure if `rings/arith.py:binomial` should do more than numerics because the console user will first see `functions/other.py:binomial` and use that. The programmer OTOH probably won't need other than numerics. So, your efforts in `rings/arith.py:binomial` regarding other rings looks wasted to me.

In the new version, `arith.binomial` do less than before regarding other rings (especially the symbolic one). What do you mean by numerics: integers? rationals? reals? complex? algebraic numbers?

> There is already #17489 removing function duplicity for `factorial` so this is something to think of.

Removing `binomial` from arith is not an option. On top of #17852 we have

```
sage: from sage.rings.arith import binomial as arith_binomial
sage: %timeit arith_binomial(10,4)
100000 loops, best of 3: 1.87 µs per loop
sage: %timeit binomial(10,4)
10000 loops, best of 3: 47.3 µs per loop
```

The slowdown is less dramatic for factorial but still visible

```
sage: from sage.rings.arith import factorial as arith_factorial
sage: %timeit arith_factorial(10)
1000000 loops, best of 3: 474 ns per loop
sage: %timeit factorial(10)
1000000 loops, best of 3: 1.02 µs per loop
```



---

Comment by git created at 2015-03-15 13:48:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-03-15 13:51:53

An additional commit to take care of #12179.


---

Comment by git created at 2015-03-20 09:20:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-03-20 11:17:38

All test pass on 6.6-beta6!

Vincent


---

Comment by jdemeyer created at 2015-03-21 13:34:45

Comment [comment:36] hasn't been addressed.


---

Comment by jdemeyer created at 2015-03-21 13:34:45

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-03-21 13:48:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-03-21 13:48:25

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-03-21 18:10:53

Now this test is duplicated:

```
sage: len(prime_powers(1000))
```



---

Comment by git created at 2015-03-21 18:15:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-03-21 21:36:41

Sorry but I still don't like the `binomial` code.

In particular, do we really need the coercion there? The arguments `x` and `m` play a very different role, note that `m` is immediately converted to an integer anyway.

Also, the check that `factorial(m)` is invertible has no mathematical meaning and should just be removed.

I will continue my review of the rest of this branch, please do not change anything except `binomial`.


---

Comment by jdemeyer created at 2015-03-21 21:37:28

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-03-21 21:41:51

Not your fault, but should be fixed anyway: the error message of `integer_ceil` has

```
raise NotImplementedError("computation of floor of %s not implemented"%repr(x))
```



---

Comment by jdemeyer created at 2015-03-21 21:54:27

Replace

```
sage: alarm(0.01); (2**100).binomial(2**19, algorithm='pari')
```

by

```
sage: alarm(0.5); (2^100).binomial(2^22, algorithm='pari')
```

(analogously for `mpir`)

With this value, the memory use is reasonable and the computation takes long enough (48s on my machine) that it will not answer in <0.5s in the near future.


---

Comment by jdemeyer created at 2015-03-21 21:55:26

No further comments: if you fix the above without introducing new bugs :-) then it will finally be positive_review.


---

Comment by vdelecroix created at 2015-03-21 22:00:28

Replying to [comment:72 jdemeyer]:
> Sorry but I still don't like the `binomial` code.
> 
> In particular, do we really need the coercion there? The arguments `x` and `m` play a very different role, note that `m` is immediately converted to an integer anyway.

I am not sure I understand. You don't want the case 2 that tries to convert `x` to an integer? It is much faster that way for real or rational input that are actually integers.

> Also, the check that `factorial(m)` is invertible has no mathematical meaning and should just be removed.

I am not sure that what I did in the branch is the best, but there is definitely something that needs to be specified (see #12179). Would you be satisfied with

```
sage: factorial(Zmod(12)(10), 4)
3
```



---

Comment by vdelecroix created at 2015-03-21 22:12:43

Replying to [comment:78 vdelecroix]:
> Replying to [comment:72 jdemeyer]:
> > Sorry but I still don't like the `binomial` code.
> > 
> > In particular, do we really need the coercion there? The arguments `x` and `m` play a very different role, note that `m` is immediately converted to an integer anyway.
> 
> I am not sure I understand. You don't want the case 2 that tries to convert `x` to an integer? It is much faster that way for real or rational input that are actually integers.
> 
> > Also, the check that `factorial(m)` is invertible has no mathematical meaning and should just be removed.
> 
> I am not sure that what I did in the branch is the best, but there is definitely something that needs to be specified (see #12179). Would you be satisfied with
> {{{
> sage: factorial(Zmod(12)(10), 4)
> 3
> }}}

Actually, it does matter. When an operation on a given quotient ring is implemented from the initial ring, you expect it to not depend on the representative you used... but

```
sage: R = Integers(6)
sage: R(binomial(5,2))
4
sage: R(binomial(5+6,2))
1
```

Note that it would have been fine on quotients in which `2!` is invertible.


---

Comment by jdemeyer created at 2015-03-21 22:21:09

Replying to [comment:78 vdelecroix]:
> Replying to [comment:72 jdemeyer]:
> > Sorry but I still don't like the `binomial` code.
> > 
> > In particular, do we really need the coercion there? The arguments `x` and `m` play a very different role, note that `m` is immediately converted to an integer anyway.
> 
> I am not sure I understand.
I mean this:

```
    if parent(m) is not P:
        from sage.structure.element import get_coercion_model
        cm = get_coercion_model()
        x,m = cm.canonical_coercion(x,m)
        P = parent(x)
```



---

Comment by jdemeyer created at 2015-03-21 22:23:46

Replying to [comment:79 vdelecroix]:
> Actually, it does matter. When an operation on a given quotient ring is implemented from the initial ring, you expect it to not depend on the representative you used... but
> {{{
> sage: R = Integers(6)
> sage: R(binomial(5,2))
> 4
> sage: R(binomial(5+6,2))
> 1
> }}}
> Note that it would have been fine on quotients in which `2!` is invertible.

Of course, you are right. Never mind what I said about this.


---

Comment by git created at 2015-03-21 22:44:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-03-21 22:46:14

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-03-21 23:24:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-03-23 14:08:20

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-03-23 14:08:20

I thought a bit more about the invertibility check: in fact it has nothing to do with integral domains, but with the _characteristic_ of the ring.

This is also not well-defined, despite `R` being a field:

```
sage: R = Zmod(7)
sage: binomial(R(10), 7)
1
sage: R(binomial(17, 7))
2
```


The correct condition is that `factorial(m)` should be coprime to the characteristic of the ring. So the code should be something like

```
try:
    c = P.characteristic()
except AttributeError:
    # Assume that P has characteristic zero
    pass
else:
    if c > 0 and any(c.gcd(k) > 1 for k in range(2, m+1)):
        raise ...
```

(you don't need `Q` for this)

The example with `Zmod(7)` should be added as doctest.


---

Comment by git created at 2015-03-23 21:44:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-03-23 21:45:07

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-03-24 14:37:59

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2015-03-24 19:34:57

Indeed, it is not small anymore... thanks!

Vincent


---

Comment by vbraun created at 2015-04-11 08:35:41

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-04-11 08:35:41

On 32-bit:

```
sage -t --long src/sage/combinat/baxter_permutations.py
**********************************************************************
File "src/sage/combinat/baxter_permutations.py", line 232, in sage.combinat.baxter_permutations.BaxterPermutations_size.cardinality
Failed example:
    [BaxterPermutations(n).cardinality() for n in xrange(13)]
Expected:
    [1, 1, 2, 6, 22, 92, 422, 2074, 10754, 58202, 326240, 1882960, 11140560]
Got:
    [1, 1, 2, 6, 22, 92, 422, 2074, 10754, 58202, 326240, 1882960, 11140560L]
**********************************************************************
1 item had failures:
   1 of   2 in sage.combinat.baxter_permutations.BaxterPermutations_size.cardinality
    [31 tests, 1 failure, 1.41 s]
```

Really, cardinality should always return Sage integers.


---

Comment by git created at 2015-04-11 08:52:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-11 08:55:38

Replying to [comment:90 vbraun]:
> On 32-bit:
> {{{
> ...
> }}}

Fixed.

> Really, cardinality should always return Sage integers.

Then we are not to blame here ;-)

```
sage: parent(BaxterPermutations(3).cardinality())
Rational Field
```


Vincent


---

Comment by vdelecroix created at 2015-04-11 08:55:49

Changing status from needs_work to positive_review.


---

Comment by vdelecroix created at 2015-04-11 19:36:01

Replying to [comment:90 vbraun]:
> Really, cardinality should always return Sage integers.

See #18159

Vincent


---

Comment by vbraun created at 2015-04-12 09:16:52

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-04-12 09:16:52


```
sage -t --long --warn-long 48.0 src/sage/rings/arith.py
**********************************************************************
File "src/sage/rings/arith.py", line 2608, in sage.rings.arith.is_squarefree
Failed example:
    is_squarefree(a - 3)
Expected:
    Traceback (most recent call last):
    ...
    ValueError: Non-principal ideal in factorization
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.arith.is_squarefree[13]>", line 1, in <module>
        is_squarefree(a - Integer(3))
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/rings/arith.py", line 2623, in is_squarefree
        return all(r[1] == 1 for r in factor(n))
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/rings/arith.py", line 2391, in factor
        return n.factor(**kwds)
      File "sage/rings/number_field/number_field_element.pyx", line 1485, in sage.rings.number_field.number_field_element.NumberFieldElement.factor (build/cythonized/sage/rings/number_field/number_field_element.cpp:15877)
        raise ArithmeticError("non-principal ideal in factorization")
    ArithmeticError: non-principal ideal in factorization
```



---

Comment by vdelecroix created at 2015-04-12 09:26:15

Volker, I do not get this error. Did you test on top of 6.6.rc2 or 6.6.rc3?

Vincent


---

Comment by vdelecroix created at 2015-04-12 09:27:27

This comes from #17294, not from this ticket!!


---

Comment by vbraun created at 2015-04-12 09:31:10

Well life is tough :-P


---

Comment by git created at 2015-04-15 08:22:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-15 09:47:05

All test pass.


---

Comment by vdelecroix created at 2015-04-15 09:47:05

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-04-15 13:58:20

Resolution: fixed
