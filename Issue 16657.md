# Issue 16657: bug in is_square over number fields

Issue created by migration from Trac.

Original creator: cremona

Original creation time: 2014-08-28 09:07:57

CC:  jdemeyer

A precision bug in pari 2.7.1 causes this:

```
sage: K.<a> = QuadraticField(22)
sage: u = 42*a - 197 # fundamental unit
sage: D = u^14
sage: D.is_square()
MemoryError: Unable to allocate 327680000000 bytes for the PARI stack
(instead, allocated 262144000000 bytes)
```

This was reported upstream (to Karim Belabas) who fixed it in pari's main development branch 2.8.*.  It would be good to get the bug fix into Sage sooner.

From Karim's email:


```
Not a memory issue indeed. The low-level function from the polroots
module that (sharply) estimates the largest modulus of a polynomial
T can't handle the case T(0) = 0 (nor the case where T is constant,
but that's not the issue here...).

It never occurs in the original context of polroots(), but it can occur
in the context of nfroots / nffactor that call it with T := the image
through the successive complex embeddings of our algebraic polynomial.

Fixed in master (2.8.*). Thanks for your report !
```



---

Comment by jdemeyer created at 2014-09-03 09:15:17

Changing component from number fields to packages: standard.


---

Comment by jdemeyer created at 2014-09-03 09:45:25

This patch fixes the bug, but it causes another doctest failure...

```
sage -t --long src/sage/rings/number_field/number_field.py
**********************************************************************
File "src/sage/rings/number_field/number_field.py", line 5172, in sage.rings.number_field.number_field.NumberField_generic.?
Failed example:
    Z = K.zeta_function()
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 843, in compile_and_execute
        exec compiled in globs
      File "<doctest sage.rings.number_field.number_field.NumberField_generic.?[1]>", line 1, in <module>
        Z = K.zeta_function()
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/rings/number_field/number_field.py", line 5198, in zeta_function
        max_asymp_coeffs=max_asymp_coeffs)
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/lfunctions/dokchitser.py", line 342, in init_coeffs
        self._gp_eval(pari_precode)
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/lfunctions/dokchitser.py", line 243, in _gp_eval
        raise RuntimeError("Unable to create L-series, due to precision or other limits in PARI.")
    RuntimeError: Unable to create L-series, due to precision or other limits in PARI.
**********************************************************************
```

----
New commits:


---

Comment by jdemeyer created at 2014-09-03 09:55:14

False alarm, the doctest failure was because I forgot to run `make`.


---

Comment by cremona created at 2014-09-03 11:22:39

Thanks, Jeroen.  I will test this.


---

Comment by jdemeyer created at 2014-09-03 11:25:36

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2014-09-03 11:25:36

Good, I haven't run full doctests myself but at least the tests in `src/sage/rings/number_field` pass.


---

Comment by cremona created at 2014-09-03 12:12:37

I tested all src/sage with --long and it's all ok.


---

Comment by cremona created at 2014-09-03 12:12:37

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2014-09-03 12:20:38

Replying to [comment:8 cremona]:
> I tested all src/sage with --long and it's all ok.
General remark: that is not sufficient, since there is also `src/doc` and the Notebook. Better test with `./sage -t --all` instead of manually specifying the directories.

I don't expect the Notebook to break because of this ticket, but there are some docs which have some number theory (e.g. [http://www.sagemath.org/doc/bordeaux_2008/index.html](http://www.sagemath.org/doc/bordeaux_2008/index.html)), so you should test those also.


---

Comment by cremona created at 2014-09-03 12:28:27

Replying to [comment:9 jdemeyer]:
> Replying to [comment:8 cremona]:
> > I tested all src/sage with --long and it's all ok.
> General remark: that is not sufficient, since there is also `src/doc` and the Notebook. Better test with `./sage -t --all` instead of manually specifying the directories.

OK, I will do (it only took 5 minutes ;)).  I did not know about --all!


> 
> I don't expect the Notebook to break because of this ticket, but there are some docs which have some number theory (e.g. [http://www.sagemath.org/doc/bordeaux_2008/index.html](http://www.sagemath.org/doc/bordeaux_2008/index.html)), so you should test those also.


---

Comment by cremona created at 2014-09-03 13:12:58

OK, I did ./sage -tp 60 --long --all and all was well apart from

```
sage -t --long src/sage/plot/plot.py  # 20 doctests failed
sage -t --long src/sage/gsl/probability_distribution.pyx  # 4 doctests failed
sage -t --long src/sage/sandpiles/sandpile.py  # Timed out
```

which I am sure has nothing to do with the changes on this ticket.


---

Comment by jdemeyer created at 2014-09-03 13:37:53

Replying to [comment:11 cremona]:
> OK, I did ./sage -tp 60 --long --all and all was well apart from

Did you just write `-tp 60`?!


---

Comment by cremona created at 2014-09-03 13:58:43

Replying to [comment:12 jdemeyer]:
> Replying to [comment:11 cremona]:
> > OK, I did ./sage -tp 60 --long --all and all was well apart from
> 
> Did you just write `-tp 60`?!

:)  I left 4 cores free for others.


---

Comment by jdemeyer created at 2014-09-05 13:58:59

Bill Allombert just announced (fix 8 is the bug of this ticket)

```

I have made a prerelease of PARI 2.7.2

Please test the prerelease tarball:
<http://pari.math.u-bordeaux.fr/pub/pari/snapshots/pari-2.7.2-pre1.tar.gz>

Note that this release fixes some rounding error with the multiplication
and division of real numbers. Thus floating point computations can
return slightly different results than 2.7.1, but hopefully more accurate. 

The expected release date is set to the 19/09/2014

Below is the changelog:

Done for version 2.7.2 (released 19/09/2014):
[last column crossreferences current development release 2.8.0]

  Fixed
    1- gaffsg(0, t_PADIC): wrong valuation                                [F21]
    2- (t_INTMOD with word-sized modulus)^(huge negative power) [#1584]   [F24]
    3- (gp -p N) or (primelimit=N in gprc_ for N >= 436273290 resulted in an
       incorrect primetable. N.B. Such commands are now useless: needed primes
       are produced dynamically anyway.                                   [F25]
    4- monomial(exact zero, d, v) returned an invalid t_POL / t_RFRAC     [F26]
    5- contfracpnqn(v, n) returned partial quotients p[-1]/q[-1] ...
       p[n-1]/q[n-1], instead of the documented p[0]/q[0] ... p[n]/q[n]   [F27]
    6- factor((3+4*I)/25) -> factor 2+I had 0 exponent [#1586]            [F29]
BA  7- iferr() could crash if some component of the t_ERROR were clones.  [F31]
    8- nffactor() could overflow the stack when default accuracy too low  [F32]
BA  9- obsolete use of E=[a1,a2,a3,a4,a6] in ellmul crashed  [#1589]      [F33]
   10- incorrect rounding in mulrr/divrr for one-word precision reals     [F34]
BA 11- multiif did not handle correctly return() in conditions [#1590]    [F35]
   12- [0..5] -> [0,0,0,0,0] on some architectures                        [F36]
   13- is_gener_Fp could return wrong results                             [F37]
   14- Fq_sqrtn(t_INT,..,&zeta) could return a wrong root of 1            [F38]
   15- bnfinit: SEGV due to precision issues [#1592]                      [F39]
   16- zm_zc_mul only worked for square zm matrices                       [F40]
   17- genus2red(0,27*x^5+97*x^4+118*x^3+60*x^2+13*x+1,3) -> bug [#1596]  [F41]
   18- [ghelp] oo loop when $COLUMNS too small [#1594]                    [F42]
   19- genus2red(x,-x^6-3*x^4-10*x^2-1,3) -> impossible inverse [#1597]   [F43]
   20- factoru(1) returned a t_MAT instead of the expected "matsmall"     [F44]
   21- FpM_charpoly wrong in small characteristic [#1602]                 [F45]
   22- when compatible = 3; series() used a random precision              [F50]
   23- genus2red(0,6*x^6+5*x^4+x^2+1,7) -> impossible inverse [#1597]     [F51]
   24- isprime() could crash on large input [#1604]                       [F52]
   25- genus2red(x^3+1,1) -> type error [#1597]                           [F53]
   26- gphelp did not handle === correctly [#1603]                        [F54]
```



---

Comment by cremona created at 2014-09-05 14:12:36

I will see Bill next week (we will be at the same conference).  I see that this is a prerelease (= release candidate?) for the next 2 weeks.

I suggest that we do not delay merging this ticket, but at the same time make a new one for 2.7.2 which should be ready in time for the release date.  Is that a good plan?


---

Comment by jdemeyer created at 2014-09-05 19:24:42

Replying to [comment:15 cremona]:
> I suggest that we do not delay merging this ticket
Since this ticket is ready now, there is indeed no point in delaying. Only I would have preferred to know about this pre-release 3 days ago...

> but at the same time make a new one for 2.7.2 which should be ready in time for the release date.  Is that a good plan?
Sure, #16939.


---

Comment by cremona created at 2014-09-05 19:51:40

Replying to [comment:16 jdemeyer]:
> Replying to [comment:15 cremona]:
> > I suggest that we do not delay merging this ticket
> Since this ticket is ready now, there is indeed no point in delaying. Only I would have preferred to know about this pre-release 3 days ago...

Agreed.  Anything else I should ask Bill A who is arriving where I am on Sunday?

> 
> > but at the same time make a new one for 2.7.2 which should be ready in time for the release date.  Is that a good plan?
> Sure, #16939.

Good.


---

Comment by vbraun created at 2014-09-06 11:02:47

Resolution: fixed


---

Comment by jdemeyer created at 2014-09-07 19:15:14

Replying to [comment:17 cremona]:
> Agreed.  Anything else I should ask Bill A who is arriving where I am on Sunday?
Perhaps ask whether they intend to do something with Denis Simon's scripts. On various occasions, the PARI developers have taken over other people's code which was either in scripts or in an external PARI package and put that functionality in PARI itself (a recent example of this is `genus2red`, see #15808). It would absolutely be good if this could be done with Simon's scripts.


---

Comment by cremona created at 2014-09-07 19:18:47

Replying to [comment:19 jdemeyer]:
> Replying to [comment:17 cremona]:
> > Agreed.  Anything else I should ask Bill A who is arriving where I am on Sunday?
> Perhaps ask whether they intend to do something with Denis Simon's scripts. On various occasions, the PARI developers have taken over other people's code which was either in scripts or in an external PARI package and put that functionality in PARI itself (a recent example of this is `genus2red`, see #15808). It would absolutely be good if this could be done with Simon's scripts.

OK, I will ask him about the status of this tomorrow.  I believe that progress was made towards it at the meeting in Besancon last January but do not know what happened since then.
