# Issue 29998: Add construction methods to FiniteRankFreeModule and CombinatorialFreeModule

Issue created by migration from https://trac.sagemath.org/ticket/30235

Original creator: mkoeppe

Original creation time: 2020-07-28 04:04:26

CC:  tscrim egourgoulhon chapoton nthiery

(follow-up from #30194)


---

Comment by mkoeppe created at 2020-07-28 04:05:18

New commits:


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2022-08-21 23:41:15

New commits:


---

Comment by git created at 2022-08-21 23:52:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-08-22 00:08:57

We will need to be really careful with this because lots of classes are subclasses of `CFM`, where the result of `construction()` will become wrong if we do the generic one.

However, I am generally +1 on doing this. There is a ticket out there on implementing extension of scalars, and this would be a step towards doing that generically by being able to implement pushouts.


---

Comment by git created at 2022-08-22 02:11:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-22 02:12:54

Replying to [comment:13 tscrim]:
> We will need to be really careful with this because lots of classes are subclasses of `CFM`, where the result of `construction()` will become wrong if we do the generic one.

Yes, I see a few dozen testsuite failures (`_test_construction`) in `sage.combinat` now.

> However, I am generally +1 on doing this. There is a ticket out there on implementing extension of scalars, and this would be a step towards doing that generically by being able to implement pushouts.

Yes


---

Comment by mkoeppe created at 2022-08-22 02:26:01

Help on these subclasses in `sage.combinat` is very welcome.

Otherwise I'd just add a lot of `def construction(self): return None`


---

Comment by tscrim created at 2022-08-22 02:40:45

There are also a number of them in `sage.algebra` as well. In most cases, the "correct" thing to do would be to have their own `ConstructionFunctor`. Although we probably would remove a lot of redundant code if we have some generic subclass, say `VectorSpaceWithBaseRing` from commutative rings that takes a class and arbitrary inputs/keywords except the base ring. It would have a generic merging that would require all of the inputs/keywords to be equal. It might also be possible to pull the key to `UniqueRepresentation` as these additional structures as a generic implementation in `CFM`.


---

Comment by mkoeppe created at 2022-08-22 02:50:45

For a start, I guess we can just give the `None` construction to all filtered modules


---

Comment by tscrim created at 2022-08-22 02:56:39

True, it makes the situation no worse than before.


---

Comment by git created at 2022-08-22 02:57:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-22 03:46:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-22 04:08:20

Probably safer to just disable the `construction` for all subclasses


---

Comment by git created at 2022-08-22 04:44:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-22 04:47:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-08-22 04:51:17

Replying to [comment:17 tscrim]:
> It might also be possible to pull the key to `UniqueRepresentation` as these additional structures as a generic implementation in `CFM`.

Yes, I think a solution based on `UniqueRepresentation` could be a good idea.


---

Comment by git created at 2022-08-22 04:51:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-22 04:54:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-22 16:25:40


```
sage -t --random-seed=211950378039065916298685714207807222444 doc/en/thematic_tutorials/tutorial-implementing-algebraic-structures.rst  # 1 doctest failed
sage -t --random-seed=211950378039065916298685714207807222444 doc/en/thematic_tutorials/tutorial-objects-and-classes.rst  # 1 doctest failed
sage -t --random-seed=211950378039065916298685714207807222444 sage/combinat/free_module.py  # 1 doctest failed
sage -t --random-seed=211950378039065916298685714207807222444 sage/modules/with_basis/indexed_element.pyx  # 1 doctest failed
```



---

Comment by git created at 2022-08-22 17:18:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-22 17:35:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-22 17:56:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-22 18:05:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-22 19:02:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-22 19:08:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-22 19:12:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-22 19:13:11

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-08-22 20:26:47


```
sage -t --random-seed=116536317366563428683146425021076892502 src/sage/manifolds/vector_bundle_fiber.py  # 1 doctest failed
sage -t --random-seed=116536317366563428683146425021076892502 src/sage/manifolds/differentiable/tangent_space.py  # 1 doctest failed
```



---

Comment by git created at 2022-08-22 20:37:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-22 22:25:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-23 05:17:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-23 15:37:30

Tests pass, the pyright crash is unrelated; needs review


---

Comment by tscrim created at 2022-08-24 03:11:14

While the subclass for the construction version is the proper way to do it, I am not sure how much of a hassle it will create long-term once we have a more general way to do constructions for things that subclass CFM. The hack way would be

```python
def construction(self):
    if self.__class__.__mro__[1] == CombinatorialFreeModule:
         return VectorFunctor(...)
    return super().construction()
```

(We cannot to `type(self) == CFM` because of the dynamic class created from the category. There is a function or method to get this more robustly, but I don't remember offhand.) I am fairly convinced that your proposal is how we should go, but I just have this little nagging doubt.

One thing that does need to be changed is that we will have two `CFM` classes with (almost) identical (public) documentations. This is easy to fix by adding a class-level doc to the new class explaining the difference.


---

Comment by mkoeppe created at 2022-08-24 03:13:09

Another hackish way would be to assign `self.construction` in a `__classcall_private__` method.


---

Comment by tscrim created at 2022-08-24 03:35:15

Replying to [comment:47 mkoeppe]:
> Another hackish way would be to assign `self.construction` in a `__classcall_private__` method.

Indeed, although I think that is even more of a hack since it is doing stuff non-locally (to the method).


---

Comment by mkoeppe created at 2022-08-24 03:38:56

I don't have an objection to using `self.__class__.__base__` or something like this like you suggested. It's probably less confusing than the renaming reimport


---

Comment by mkoeppe created at 2022-08-24 04:09:05

I'm making this change now.


---

Comment by git created at 2022-08-24 04:27:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-24 05:05:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-08-25 02:43:52

I think this is acceptable. Éric, do you have any comments?


---

Comment by egourgoulhon created at 2022-08-26 21:57:40

Replying to [comment:53 tscrim]:
> I think this is acceptable. Éric, do you have any comments?

No, I don't. This is mostly beyond my knowledge, but thanks for asking ;-)


---

Comment by tscrim created at 2022-08-27 01:22:29

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2022-08-27 01:22:29

Then let it be so.


---

Comment by mkoeppe created at 2022-08-27 01:25:49

Thanks!


---

Comment by vbraun created at 2022-08-29 11:24:16

Resolution: fixed
