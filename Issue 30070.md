# Issue 30070: Refactor Components into parent & element

archive/issues_030070.json:
```json
{
    "body": "CC:  @mjungmath @egourgoulhon @tscrim @honglizhaobob\n\nCurrently every `Components` object has lots of metadata attributes in addition to the actual data dictionary in `._comp`.  \n\nIf one has many different `Components` objects with the same metadata, we can reduce storage space as follows.\n\nWe create new classes `CompParent`, `CompParentWithSym`, ..., which \nstore the attributes and become `UniqueRepresentation`. We make `Components` objects elements of these parents.  \n\nData associated with symmetries, computed currently each time for each `CompWithSym` object in methods such as `__init__`, `__add__`, `trace`, ... can then be precomputed and cached in the parent (for example using `@`cached_method in the parent class).\n\n\nThe parents will also have index iterator methods.\n\nThis will make the code in #30229 (subspaces of tensor with symmetries) more elegant because it no longer needs a dummy `Components` object to represent the symmetry but rather a `CompParent` object.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30307\n\n",
    "created_at": "2020-08-07T01:26:06Z",
    "labels": [
        "component: linear algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Refactor Components into parent & element",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30070",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @mjungmath @egourgoulhon @tscrim @honglizhaobob

Currently every `Components` object has lots of metadata attributes in addition to the actual data dictionary in `._comp`.  

If one has many different `Components` objects with the same metadata, we can reduce storage space as follows.

We create new classes `CompParent`, `CompParentWithSym`, ..., which 
store the attributes and become `UniqueRepresentation`. We make `Components` objects elements of these parents.  

Data associated with symmetries, computed currently each time for each `CompWithSym` object in methods such as `__init__`, `__add__`, `trace`, ... can then be precomputed and cached in the parent (for example using `@`cached_method in the parent class).


The parents will also have index iterator methods.

This will make the code in #30229 (subspaces of tensor with symmetries) more elegant because it no longer needs a dummy `Components` object to represent the symmetry but rather a `CompParent` object.

Issue created by migration from https://trac.sagemath.org/ticket/30307





---

archive/issue_events_078464.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-13T17:11:30Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30070#event-78464"
}
```



---

archive/issue_comments_426903.json:
```json
{
    "body": "Help with implementing this would be very welcome!",
    "created_at": "2021-01-22T20:38:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426903",
    "user": "https://github.com/mkoeppe"
}
```

Help with implementing this would be very welcome!



---

archive/issue_comments_426904.json:
```json
{
    "body": "That's a nice idea, +1!\n\n> Data associated with symmetries, computed currently each time for each `CompWithSym` object in methods such as `__init__`, `__add__`, `trace`, ... can then be precomputed and cached in the parent (for example using `@`cached_method in the parent class).\n\n\nI think it would be a good idea to cache results from `trace`, `contract`, ... as well.\n\nThe most annoying thing with this ticket will most likely be the docstring that has to be adapted...is there a good way to use search&replace?",
    "created_at": "2021-01-22T23:41:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426904",
    "user": "https://github.com/mjungmath"
}
```

That's a nice idea, +1!

> Data associated with symmetries, computed currently each time for each `CompWithSym` object in methods such as `__init__`, `__add__`, `trace`, ... can then be precomputed and cached in the parent (for example using `@`cached_method in the parent class).


I think it would be a good idea to cache results from `trace`, `contract`, ... as well.

The most annoying thing with this ticket will most likely be the docstring that has to be adapted...is there a good way to use search&replace?



---

archive/issue_comments_426905.json:
```json
{
    "body": "Currently, the index generators and manipulators take (mostly) lists and can therefore not be cached. To use the caching most efficiently, I suggest we switch entirely to tuples.",
    "created_at": "2021-01-23T13:09:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426905",
    "user": "https://github.com/mjungmath"
}
```

Currently, the index generators and manipulators take (mostly) lists and can therefore not be cached. To use the caching most efficiently, I suggest we switch entirely to tuples.



---

archive/issue_comments_426906.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-23T14:05:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426906",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426907.json:
```json
{
    "body": "Before I go on with this ticket, could you please take a look whether this meets your rough idea?\n\nIs anyone willing to work on the docstrings...? Perhaps there's an efficient way to do this?",
    "created_at": "2021-01-23T14:07:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426907",
    "user": "https://github.com/mjungmath"
}
```

Before I go on with this ticket, could you please take a look whether this meets your rough idea?

Is anyone willing to work on the docstrings...? Perhaps there's an efficient way to do this?



---

archive/issue_comments_426908.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-23T14:11:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426908",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426909.json:
```json
{
    "body": "Replying to [comment:7 gh-mjungmath]:\n> Before I go on with this ticket, could you please take a look whether this meets your rough idea?\n\n\nYes, this is going in the direction that I had in mind.\n\nSome more of the normalization happening in `CompParentWithSym.__init__` should probably be moved to `__classcall_private__`",
    "created_at": "2021-01-23T18:43:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426909",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:7 gh-mjungmath]:
> Before I go on with this ticket, could you please take a look whether this meets your rough idea?


Yes, this is going in the direction that I had in mind.

Some more of the normalization happening in `CompParentWithSym.__init__` should probably be moved to `__classcall_private__`



---

archive/issue_comments_426910.json:
```json
{
    "body": "What would be a proper category for the parent?",
    "created_at": "2021-01-24T11:16:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426910",
    "user": "https://github.com/mjungmath"
}
```

What would be a proper category for the parent?



---

archive/issue_comments_426911.json:
```json
{
    "body": "Replying to [comment:9 mkoeppe]:\n> Some more of the normalization happening in `CompParentWithSym.__init__` should probably be moved to `__classcall_private__`\n\n\nFor example?",
    "created_at": "2021-01-24T11:49:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426911",
    "user": "https://github.com/mjungmath"
}
```

Replying to [comment:9 mkoeppe]:
> Some more of the normalization happening in `CompParentWithSym.__init__` should probably be moved to `__classcall_private__`


For example?



---

archive/issue_comments_426912.json:
```json
{
    "body": "For example the order of the component indices does not matter",
    "created_at": "2021-01-24T18:17:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426912",
    "user": "https://github.com/mkoeppe"
}
```

For example the order of the component indices does not matter



---

archive/issue_comments_426913.json:
```json
{
    "body": "Replying to [comment:10 gh-mjungmath]:\n> What would be a proper category for the parent?\n\n\nTake the following with a grain of salt (this is just a rough/naive thought): It seems to me that the current proposal is a kind of abuse of Sage's parent/element scheme, for `CompParent` does not correspond to a \"genuine\" mathematical object (hence maybe your question...). In particular, it does not know about the ring on which the components are based. I do not deny that a reorganization of `Components` would be a good thing, but maybe at the class level, not at the parent/element level, the issue here being mostly the storage of metadata.",
    "created_at": "2021-01-24T18:50:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426913",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:10 gh-mjungmath]:
> What would be a proper category for the parent?


Take the following with a grain of salt (this is just a rough/naive thought): It seems to me that the current proposal is a kind of abuse of Sage's parent/element scheme, for `CompParent` does not correspond to a "genuine" mathematical object (hence maybe your question...). In particular, it does not know about the ring on which the components are based. I do not deny that a reorganization of `Components` would be a good thing, but maybe at the class level, not at the parent/element level, the issue here being mostly the storage of metadata.



---

archive/issue_comments_426914.json:
```json
{
    "body": "Just use the category of sets. I don't think this is an abuse.\n\nThink of an instance of `CompParent` as the set of all possible `Components` instances that have the specified symmetry.\n\nBy using the parent/element framework, you will get coercion for free - so elements with a coarser symmetry will be `in` a finer parent.",
    "created_at": "2021-01-24T19:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426914",
    "user": "https://github.com/mkoeppe"
}
```

Just use the category of sets. I don't think this is an abuse.

Think of an instance of `CompParent` as the set of all possible `Components` instances that have the specified symmetry.

By using the parent/element framework, you will get coercion for free - so elements with a coarser symmetry will be `in` a finer parent.



---

archive/issue_comments_426915.json:
```json
{
    "body": "Replying to [comment:12 mkoeppe]:\n> For example the order of the component indices does not matter\n\nRight!\n\nReplying to [comment:14 mkoeppe]:\n> Just use the category of sets. I don't think this is an abuse.\n> \n> Think of an instance of `CompParent` as the set of all possible `Components` instances that have the specified symmetry.\n> \n> By using the parent/element framework, you will get coercion for free - so elements with a coarser symmetry will be `in` a finer parent.\n\n\nFor me, it doesn't feel like an abuse either. Besides, I am sure you can make that notion of compontents mathematically rigorous. But I am not sure whether this becomes a well-defined set then... What about the category of objects?",
    "created_at": "2021-01-24T19:23:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426915",
    "user": "https://github.com/mjungmath"
}
```

Replying to [comment:12 mkoeppe]:
> For example the order of the component indices does not matter

Right!

Replying to [comment:14 mkoeppe]:
> Just use the category of sets. I don't think this is an abuse.
> 
> Think of an instance of `CompParent` as the set of all possible `Components` instances that have the specified symmetry.
> 
> By using the parent/element framework, you will get coercion for free - so elements with a coarser symmetry will be `in` a finer parent.


For me, it doesn't feel like an abuse either. Besides, I am sure you can make that notion of compontents mathematically rigorous. But I am not sure whether this becomes a well-defined set then... What about the category of objects?



---

archive/issue_comments_426916.json:
```json
{
    "body": "Alright, I make progress here. I changed only the backend such that most doctests should still pass, and the module can be used exactly as before. The elementary examples already passed.\n\nI'll push my branch tomorrow.\n\nI am looking forward to some benchmarks as soon as this branch is ready. :)",
    "created_at": "2021-01-24T20:37:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426916",
    "user": "https://github.com/mjungmath"
}
```

Alright, I make progress here. I changed only the backend such that most doctests should still pass, and the module can be used exactly as before. The elementary examples already passed.

I'll push my branch tomorrow.

I am looking forward to some benchmarks as soon as this branch is ready. :)



---

archive/issue_comments_426917.json:
```json
{
    "body": "I can understand why this might seem like an abuse because it is a set of objects, but by extension, all of the combinatorial objects would be an abuse as well. So even though we will not be putting an extra mathematical structure on the components, this is still a valid use of the framework because there is a set of objects (the parent) and the individual objects (the elements).\n\nSomething to consider, however, is a potential speed penalty for the extra levels of initialization. This can be somewhat mitigated by using Cython, but performance regression testing is warranted here.",
    "created_at": "2021-01-24T23:22:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426917",
    "user": "https://github.com/tscrim"
}
```

I can understand why this might seem like an abuse because it is a set of objects, but by extension, all of the combinatorial objects would be an abuse as well. So even though we will not be putting an extra mathematical structure on the components, this is still a valid use of the framework because there is a set of objects (the parent) and the individual objects (the elements).

Something to consider, however, is a potential speed penalty for the extra levels of initialization. This can be somewhat mitigated by using Cython, but performance regression testing is warranted here.



---

archive/issue_comments_426918.json:
```json
{
    "body": "Replying to [comment:17 tscrim]:\n> This can be somewhat mitigated by using Cython, but performance regression testing is warranted here.\n\n\nHow so?",
    "created_at": "2021-01-25T02:25:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426918",
    "user": "https://github.com/mjungmath"
}
```

Replying to [comment:17 tscrim]:
> This can be somewhat mitigated by using Cython, but performance regression testing is warranted here.


How so?



---

archive/issue_comments_426919.json:
```json
{
    "body": "Replying to [comment:18 gh-mjungmath]:\n> Replying to [comment:17 tscrim]:\n> > This can be somewhat mitigated by using Cython, but performance regression testing is warranted here.\n\n> \n> How so?\n\n\nBecause Cython is faster than Python, including potential benefits from direct C-level function calls.",
    "created_at": "2021-01-25T02:58:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426919",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:18 gh-mjungmath]:
> Replying to [comment:17 tscrim]:
> > This can be somewhat mitigated by using Cython, but performance regression testing is warranted here.

> 
> How so?


Because Cython is faster than Python, including potential benefits from direct C-level function calls.



---

archive/issue_comments_426920.json:
```json
{
    "body": "Yes, that's clear. I meant, how to implement? Make `CompParent` and `Components` both simply extension types?\n\nWould `cdpef`ing the symmetry related functions cause a speedup btw?\n\nSince this involves only integers, i.e. struct types, one could even try to Cythonize these completely.",
    "created_at": "2021-01-25T07:45:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426920",
    "user": "https://github.com/mjungmath"
}
```

Yes, that's clear. I meant, how to implement? Make `CompParent` and `Components` both simply extension types?

Would `cdpef`ing the symmetry related functions cause a speedup btw?

Since this involves only integers, i.e. struct types, one could even try to Cythonize these completely.



---

archive/issue_comments_426921.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-25T13:50:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426921",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426922.json:
```json
{
    "body": "Replying to [comment:17 tscrim]:\n> I can understand why this might seem like an abuse because it is a set of objects, but by extension, all of the combinatorial objects would be an abuse as well. So even though we will not be putting an extra mathematical structure on the components, this is still a valid use of the framework because there is a set of objects (the parent) and the individual objects (the elements).\n> \n\n\nThank you Matthias, Michael and Travis for your replies. I'm convinced now that parent/element is a good approach here (I was bothered by the lack of algebraic structure of the parent), especially for symmetry-based coercions. \n\n\n> Something to consider, however, is a potential speed penalty for the extra levels of initialization. This can be somewhat mitigated by using Cython, but performance regression testing is warranted here.\n\n\nCertainly!\n\n---\nNew commits:",
    "created_at": "2021-01-25T13:52:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426922",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:17 tscrim]:
> I can understand why this might seem like an abuse because it is a set of objects, but by extension, all of the combinatorial objects would be an abuse as well. So even though we will not be putting an extra mathematical structure on the components, this is still a valid use of the framework because there is a set of objects (the parent) and the individual objects (the elements).
> 


Thank you Matthias, Michael and Travis for your replies. I'm convinced now that parent/element is a good approach here (I was bothered by the lack of algebraic structure of the parent), especially for symmetry-based coercions. 


> Something to consider, however, is a potential speed penalty for the extra levels of initialization. This can be somewhat mitigated by using Cython, but performance regression testing is warranted here.


Certainly!

---
New commits:



---

archive/issue_comments_426923.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-25T13:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426923",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426924.json:
```json
{
    "body": "A possibly relevant ticket, about enhancing symmetries of components beyond the currently implemented ones: #28813\n\n---\nNew commits:",
    "created_at": "2021-01-25T13:54:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426924",
    "user": "https://github.com/egourgoulhon"
}
```

A possibly relevant ticket, about enhancing symmetries of components beyond the currently implemented ones: #28813

---
New commits:



---

archive/issue_comments_426925.json:
```json
{
    "body": "I am sorry for the mess. However, this is my rough approach. I separated elements and parents, and established factory methods to recover the old behavior (backwards compatibility and less work on the docstrings).\n\nI am open to suggestions how to separate the symmetry code apart. Some symmetry treatments are coupled to the element for optimization (e.g. `antisymmetrize` to determine zero more quickly).\n\nThis code is too big for me to do it alone. I'd appreciate some help here. I hope my first approach is of some use for you.",
    "created_at": "2021-01-25T13:57:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426925",
    "user": "https://github.com/mjungmath"
}
```

I am sorry for the mess. However, this is my rough approach. I separated elements and parents, and established factory methods to recover the old behavior (backwards compatibility and less work on the docstrings).

I am open to suggestions how to separate the symmetry code apart. Some symmetry treatments are coupled to the element for optimization (e.g. `antisymmetrize` to determine zero more quickly).

This code is too big for me to do it alone. I'd appreciate some help here. I hope my first approach is of some use for you.



---

archive/issue_comments_426926.json:
```json
{
    "body": "A concern about cythonizing the whole thing: the Python debugger cannot be used in Cython parts of codes, which is a pity, IMHO. So if Cython does not bring any significant performance improvement, we are loosing more than we gain.",
    "created_at": "2021-01-25T14:03:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426926",
    "user": "https://github.com/egourgoulhon"
}
```

A concern about cythonizing the whole thing: the Python debugger cannot be used in Cython parts of codes, which is a pity, IMHO. So if Cython does not bring any significant performance improvement, we are loosing more than we gain.



---

archive/issue_comments_426927.json:
```json
{
    "body": "Also shouldn't one perform a single task in this ticket, namely refactor `Components` into parent/element, and leave cythonization to another ticket?",
    "created_at": "2021-01-25T14:08:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426927",
    "user": "https://github.com/egourgoulhon"
}
```

Also shouldn't one perform a single task in this ticket, namely refactor `Components` into parent/element, and leave cythonization to another ticket?



---

archive/issue_comments_426928.json:
```json
{
    "body": "Replying to [comment:27 egourgoulhon]:\n> Also shouldn't one perform a single task in this ticket, namely refactor `Components` into parent/element, and leave cythonization to another ticket?\n\n\nThat makes sense. In the next step one could try to implement #28813, and perhaps even use Cython to do so.\n\nBesides, I just learned that one could increase the init speed with Python 3 using `__slots__`. Maybe that's what we should do for now.\n\nStill, I don't know how we should separate the symmetry code properly. My idea so far was to let the parent do the symmetrizing work and return the parent with the corresponding symmetries, and construct an element from it, then assign the components. But this doesn't work so well when the element itself such as in `antisymmetrize` is taken into account.\n\nAlternatively, it would be nice do define maps (morphisms) between parents doing that work and cache those morphisms. But that is something I don't know how to do in a nice and proper way. For example, if one antisymmetrizes in the variables where the components are already symmetric, it's simply the \"zero morphism\".",
    "created_at": "2021-01-25T15:14:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426928",
    "user": "https://github.com/mjungmath"
}
```

Replying to [comment:27 egourgoulhon]:
> Also shouldn't one perform a single task in this ticket, namely refactor `Components` into parent/element, and leave cythonization to another ticket?


That makes sense. In the next step one could try to implement #28813, and perhaps even use Cython to do so.

Besides, I just learned that one could increase the init speed with Python 3 using `__slots__`. Maybe that's what we should do for now.

Still, I don't know how we should separate the symmetry code properly. My idea so far was to let the parent do the symmetrizing work and return the parent with the corresponding symmetries, and construct an element from it, then assign the components. But this doesn't work so well when the element itself such as in `antisymmetrize` is taken into account.

Alternatively, it would be nice do define maps (morphisms) between parents doing that work and cache those morphisms. But that is something I don't know how to do in a nice and proper way. For example, if one antisymmetrizes in the variables where the components are already symmetric, it's simply the "zero morphism".



---

archive/issue_comments_426929.json:
```json
{
    "body": "Nevertheless, I think that the rough refactoring into `comp_element` and `comp_parent` (and `comp` to recover the old behavior) is already a good way to go.",
    "created_at": "2021-01-25T15:21:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426929",
    "user": "https://github.com/mjungmath"
}
```

Nevertheless, I think that the rough refactoring into `comp_element` and `comp_parent` (and `comp` to recover the old behavior) is already a good way to go.



---

archive/issue_comments_426930.json:
```json
{
    "body": "Replying to [comment:24 egourgoulhon]:\n> A possibly relevant ticket, about enhancing symmetries of components beyond the currently implemented ones: #28813\n\n\nI agree that it would be a good idea to keep possible generalizations in mind while doing this refactoring. (Also #30276)",
    "created_at": "2021-01-25T18:01:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426930",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:24 egourgoulhon]:
> A possibly relevant ticket, about enhancing symmetries of components beyond the currently implemented ones: #28813


I agree that it would be a good idea to keep possible generalizations in mind while doing this refactoring. (Also #30276)



---

archive/issue_comments_426931.json:
```json
{
    "body": "Definitely! So, do we have a roadmap?",
    "created_at": "2021-01-25T18:15:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426931",
    "user": "https://github.com/mjungmath"
}
```

Definitely! So, do we have a roadmap?



---

archive/issue_comments_426932.json:
```json
{
    "body": "This is looking nice already, and I agree that this ticket should do a Python implementation only. I would hope that there are already performance gains by caching.",
    "created_at": "2021-01-25T19:39:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426932",
    "user": "https://github.com/mkoeppe"
}
```

This is looking nice already, and I agree that this ticket should do a Python implementation only. I would hope that there are already performance gains by caching.



---

archive/issue_comments_426933.json:
```json
{
    "body": "`@`Mattihas: What do you say about the morphism idea in comment:27?\n\n`@`Travis: What about using `__slots__` in this ticket instead of Cythonizing?",
    "created_at": "2021-01-25T20:26:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426933",
    "user": "https://github.com/mjungmath"
}
```

`@`Mattihas: What do you say about the morphism idea in comment:27?

`@`Travis: What about using `__slots__` in this ticket instead of Cythonizing?



---

archive/issue_comments_426934.json:
```json
{
    "body": "Regrading the morphisms: These are exactly the `reduce`, `retract`, `lift` maps that we discussed in #30229 - just on the level of components rather than modules.",
    "created_at": "2021-01-25T20:36:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426934",
    "user": "https://github.com/mkoeppe"
}
```

Regrading the morphisms: These are exactly the `reduce`, `retract`, `lift` maps that we discussed in #30229 - just on the level of components rather than modules.



---

archive/issue_comments_426935.json:
```json
{
    "body": "Replying to [comment:34 mkoeppe]:\n> Regrading the morphisms: These are exactly the `reduce`, `retract`, `lift` maps that we discussed in #30229 - just on the level of components rather than modules.\n\n\nMh...but I suggest more than 3 morphisms. I don't know what you mean, sorry.\n\nCan I take it as a \"yes, what a wonderful idea!\"? :P",
    "created_at": "2021-01-25T21:03:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426935",
    "user": "https://github.com/mjungmath"
}
```

Replying to [comment:34 mkoeppe]:
> Regrading the morphisms: These are exactly the `reduce`, `retract`, `lift` maps that we discussed in #30229 - just on the level of components rather than modules.


Mh...but I suggest more than 3 morphisms. I don't know what you mean, sorry.

Can I take it as a "yes, what a wonderful idea!"? :P



---

archive/issue_comments_426936.json:
```json
{
    "body": "Yes, there are many maps:\n- For a `CompParent` with a coarser symmetry, there is an injection (`lift` map) to any `CompParent` with a finer symmetry.\netc.\n(And yes, it's a wonderful idea.)",
    "created_at": "2021-01-25T23:10:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426936",
    "user": "https://github.com/mkoeppe"
}
```

Yes, there are many maps:
- For a `CompParent` with a coarser symmetry, there is an injection (`lift` map) to any `CompParent` with a finer symmetry.
etc.
(And yes, it's a wonderful idea.)



---

archive/issue_comments_426937.json:
```json
{
    "body": "I don't expect `__slots__` to provide much benefit to speed as from what I am reading, it is more useful for memory usage. The main thing is to turn the file into a `.pyx` file with a `.pxd` header for declarations. The element class should be a `cpdef` with the main parameters declared and given explicit typing. These are relatively easy things to do provided you don't have multiple inheritance in the element classes (the parent can remain normal Python classes in a pyx file).\n\nIMO, you also don't loose too much with converting to Cython with debugging because you still get a lot with error tracebacks. The biggest thing I have found lost is the ease of profiling to find bottlenecks. However, testing with practical examples can get around that a bit, and there is a tool to profile Cython code IIRC. So I generally see this as a smaller trade-off.",
    "created_at": "2021-01-26T02:24:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426937",
    "user": "https://github.com/tscrim"
}
```

I don't expect `__slots__` to provide much benefit to speed as from what I am reading, it is more useful for memory usage. The main thing is to turn the file into a `.pyx` file with a `.pxd` header for declarations. The element class should be a `cpdef` with the main parameters declared and given explicit typing. These are relatively easy things to do provided you don't have multiple inheritance in the element classes (the parent can remain normal Python classes in a pyx file).

IMO, you also don't loose too much with converting to Cython with debugging because you still get a lot with error tracebacks. The biggest thing I have found lost is the ease of profiling to find bottlenecks. However, testing with practical examples can get around that a bit, and there is a tool to profile Cython code IIRC. So I generally see this as a smaller trade-off.



---

archive/issue_comments_426938.json:
```json
{
    "body": "Well, `__slots__` makes initializations faster because attribute access is significantly faster (up to 30%). Memory is just an additional benefit.\n\nEven if we turn `Components` into a `cpdef`, I think we still gain a good performance boost with `__slots__` which can sum up quickly with recurrent use of `_comp`.",
    "created_at": "2021-01-26T06:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426938",
    "user": "https://github.com/mjungmath"
}
```

Well, `__slots__` makes initializations faster because attribute access is significantly faster (up to 30%). Memory is just an additional benefit.

Even if we turn `Components` into a `cpdef`, I think we still gain a good performance boost with `__slots__` which can sum up quickly with recurrent use of `_comp`.



---

archive/issue_comments_426939.json:
```json
{
    "body": "To use morphisms, we need a new category (say `Category of collections of abstract components`) and a homset, right?",
    "created_at": "2021-01-26T06:03:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426939",
    "user": "https://github.com/mjungmath"
}
```

To use morphisms, we need a new category (say `Category of collections of abstract components`) and a homset, right?



---

archive/issue_comments_426940.json:
```json
{
    "body": "Btw, I am not convinced that `cpdef`ing the class makes initializations faster, I'd bet on the contrary. When I understand it correctly, `cpdef` creates two classes in the background, an extension type and a usual Python class. Since we don't expect a benefit during the lifetime of an instance, it should even slowdown things. But maybe I just got things wrong here.",
    "created_at": "2021-01-26T06:11:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426940",
    "user": "https://github.com/mjungmath"
}
```

Btw, I am not convinced that `cpdef`ing the class makes initializations faster, I'd bet on the contrary. When I understand it correctly, `cpdef` creates two classes in the background, an extension type and a usual Python class. Since we don't expect a benefit during the lifetime of an instance, it should even slowdown things. But maybe I just got things wrong here.



---

archive/issue_comments_426941.json:
```json
{
    "body": "What are you talking about `cpdef`ing a class? You only do that to functions AFAIK. I am still not 100% convinced by the `__slots__` approach, more so because it makes it (slightly) harder to switch from a Python class to an extension class IIRC.\n\nI don't see why we need a new category. We don't need to be so heavy-handed with the approach. Having the homset be in the category of (enumerated?) sets is sufficient IMO.",
    "created_at": "2021-01-28T08:21:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426941",
    "user": "https://github.com/tscrim"
}
```

What are you talking about `cpdef`ing a class? You only do that to functions AFAIK. I am still not 100% convinced by the `__slots__` approach, more so because it makes it (slightly) harder to switch from a Python class to an extension class IIRC.

I don't see why we need a new category. We don't need to be so heavy-handed with the approach. Having the homset be in the category of (enumerated?) sets is sufficient IMO.



---

archive/issue_comments_426942.json:
```json
{
    "body": "The main benefit with Cython and extension classes is being able to strongly type things to have as many C level function calls and code as possible.",
    "created_at": "2021-01-28T08:22:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426942",
    "user": "https://github.com/tscrim"
}
```

The main benefit with Cython and extension classes is being able to strongly type things to have as many C level function calls and code as possible.



---

archive/issue_comments_426943.json:
```json
{
    "body": "Replying to [comment:42 tscrim]:\n> I don't see why we need a new category. We don't need to be so heavy-handed with the approach. Having the homset be in the category of (enumerated?) sets is sufficient IMO.\n\n\nMathematically, I am still not convinced that our parents constitute sets. Their elements run over all possible rings (and \"frames\"), which is not a set either.",
    "created_at": "2021-01-28T09:53:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426943",
    "user": "https://github.com/mjungmath"
}
```

Replying to [comment:42 tscrim]:
> I don't see why we need a new category. We don't need to be so heavy-handed with the approach. Having the homset be in the category of (enumerated?) sets is sufficient IMO.


Mathematically, I am still not convinced that our parents constitute sets. Their elements run over all possible rings (and "frames"), which is not a set either.



---

archive/issue_comments_426944.json:
```json
{
    "body": "Replying to [comment:43 tscrim]:\n> The main benefit with Cython and extension classes is being able to strongly type things to have as many C level function calls and code as possible.\n\n\nIndeed. That needs a thorough modification of the current code. The indices checks use mostly lists and Python sets. The components are stored as dictionaries which cannot be strongly typed. I agree, that should eventually be done, however I propose that's something for another ticket.",
    "created_at": "2021-01-28T10:00:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426944",
    "user": "https://github.com/mjungmath"
}
```

Replying to [comment:43 tscrim]:
> The main benefit with Cython and extension classes is being able to strongly type things to have as many C level function calls and code as possible.


Indeed. That needs a thorough modification of the current code. The indices checks use mostly lists and Python sets. The components are stored as dictionaries which cannot be strongly typed. I agree, that should eventually be done, however I propose that's something for another ticket.



---

archive/issue_comments_426945.json:
```json
{
    "body": "For now, we can use `__slots__` for a slight speedup and remove it again when we Cythonize. That's what I meant.",
    "created_at": "2021-01-28T11:32:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426945",
    "user": "https://github.com/mjungmath"
}
```

For now, we can use `__slots__` for a slight speedup and remove it again when we Cythonize. That's what I meant.



---

archive/issue_comments_426946.json:
```json
{
    "body": "I don't really like this partial measure. I wouldn't do it and just keep it pure Python until you actually decide to make it Cython.\n\nWhy is the ring associated with the element and not the parent? In general, why is all of these attributes copied from the parent? Is the extra level of indirection that slow? You can just call `self._parent` in the Cython code.\n\nBecause of how your current implementation is done, you are not going to benefit from coercions. Nor do you seem to be using anything in a category. Thus, I would actually weaken things and not use Sage's Parent/Element classes. Instead, I would just mimic them. Perhaps I am misunderstanding how you plan to apply these.\n\nThere is still a lot of you things you can do to tell Cython to make things be strongly typed even if they are extracted from lists/sets/dicts, such as type-casting.",
    "created_at": "2021-01-28T23:30:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426946",
    "user": "https://github.com/tscrim"
}
```

I don't really like this partial measure. I wouldn't do it and just keep it pure Python until you actually decide to make it Cython.

Why is the ring associated with the element and not the parent? In general, why is all of these attributes copied from the parent? Is the extra level of indirection that slow? You can just call `self._parent` in the Cython code.

Because of how your current implementation is done, you are not going to benefit from coercions. Nor do you seem to be using anything in a category. Thus, I would actually weaken things and not use Sage's Parent/Element classes. Instead, I would just mimic them. Perhaps I am misunderstanding how you plan to apply these.

There is still a lot of you things you can do to tell Cython to make things be strongly typed even if they are extracted from lists/sets/dicts, such as type-casting.



---

archive/issue_comments_426947.json:
```json
{
    "body": "Please don't look at the details yet. The code is far away from being finished. Coercions come, attributes will be removed (it's just to make parts of the code already debuggable).\n\nWhy has the parent no ring? Because the symmetries and indices simply do not depend on it. On the level of indices and symmetries we have: different ring -> same data -> same instance -> more effective storage.",
    "created_at": "2021-01-29T08:02:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426947",
    "user": "https://github.com/mjungmath"
}
```

Please don't look at the details yet. The code is far away from being finished. Coercions come, attributes will be removed (it's just to make parts of the code already debuggable).

Why has the parent no ring? Because the symmetries and indices simply do not depend on it. On the level of indices and symmetries we have: different ring -> same data -> same instance -> more effective storage.



---

archive/issue_comments_426948.json:
```json
{
    "body": "Replying to [comment:48 gh-mjungmath]:\n> Why has the parent no ring? Because the symmetries and indices simply do not depend on it. On the level of indices and symmetries we have: different ring -> same data -> same instance -> more effective storage. \n\n\nYou're passing around a pointer to the ring in a lot of the elements, which is storage. Since I doubt the ring will change much, I don't think you gain much. Plus you have to pass more around, which makes maintenance harder and can come with performance impacts.",
    "created_at": "2021-01-29T08:20:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426948",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:48 gh-mjungmath]:
> Why has the parent no ring? Because the symmetries and indices simply do not depend on it. On the level of indices and symmetries we have: different ring -> same data -> same instance -> more effective storage. 


You're passing around a pointer to the ring in a lot of the elements, which is storage. Since I doubt the ring will change much, I don't think you gain much. Plus you have to pass more around, which makes maintenance harder and can come with performance impacts.



---

archive/issue_comments_426949.json:
```json
{
    "body": "Replying to [comment:44 gh-mjungmath]:\n> \n> Mathematically, I am still not convinced that our parents constitute sets. Their elements run over all possible rings (and \"frames\"), which is not a set either.\n\n\nI've also the feeling that this kind of parents cannot be sets in the meaning of standard set theory.",
    "created_at": "2021-01-29T09:54:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426949",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:44 gh-mjungmath]:
> 
> Mathematically, I am still not convinced that our parents constitute sets. Their elements run over all possible rings (and "frames"), which is not a set either.


I've also the feeling that this kind of parents cannot be sets in the meaning of standard set theory.



---

archive/issue_comments_426950.json:
```json
{
    "body": "Alright, probably you're right, Travis (as always). :P\n\nBut I'm still convinced that `__slots__` is a good thing for now. It will take a while until we have Cythonized everything.\n\nEven if we delegate the ring to the parent, they are still no sets. The \"frame\" is still an object in the category of finite sets (with length `n`).",
    "created_at": "2021-01-30T09:57:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426950",
    "user": "https://github.com/mjungmath"
}
```

Alright, probably you're right, Travis (as always). :P

But I'm still convinced that `__slots__` is a good thing for now. It will take a while until we have Cythonized everything.

Even if we delegate the ring to the parent, they are still no sets. The "frame" is still an object in the category of finite sets (with length `n`).



---

archive/issue_comments_426951.json:
```json
{
    "body": "Replying to [comment:52 gh-mjungmath]:\n> But I'm still convinced that `__slots__` is a good thing for now. It will take a while until we have Cythonized everything.\n\n\nI am not, but I don't have the same stake in the code as you. A little experimentation is not a bad thing either.",
    "created_at": "2021-02-01T02:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426951",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:52 gh-mjungmath]:
> But I'm still convinced that `__slots__` is a good thing for now. It will take a while until we have Cythonized everything.


I am not, but I don't have the same stake in the code as you. A little experimentation is not a bad thing either.



---

archive/issue_comments_426952.json:
```json
{
    "body": "Mh. Matthias, Eric, what are your opinions on that `__slot__` matter?",
    "created_at": "2021-02-01T05:36:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426952",
    "user": "https://github.com/mjungmath"
}
```

Mh. Matthias, Eric, what are your opinions on that `__slot__` matter?



---

archive/issue_comments_426953.json:
```json
{
    "body": "It's a further optimization and I think it should be tried in a follow-up, not this ticket",
    "created_at": "2021-02-01T05:41:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426953",
    "user": "https://github.com/mkoeppe"
}
```

It's a further optimization and I think it should be tried in a follow-up, not this ticket



---

archive/issue_comments_426954.json:
```json
{
    "body": "Replying to [comment:55 mkoeppe]:\n> It's a further optimization and I think it should be tried in a follow-up, not this ticket\n\n\n+1",
    "created_at": "2021-02-01T08:21:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426954",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:55 mkoeppe]:
> It's a further optimization and I think it should be tried in a follow-up, not this ticket


+1



---

archive/issue_events_078465.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30070#event-78465"
}
```



---

archive/issue_events_078466.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30070#event-78466"
}
```



---

archive/issue_comments_426955.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426955",
    "user": "https://github.com/mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_426956.json:
```json
{
    "body": "Alright, let's do that optimization in a follow-up.\n\nHowever, I am still concerned about `CompParent` being a proper class, which means that the collection of all those parents is no class at all and hence no category in terms of strict category theory.\n\nAny ideas how to circumvent this matter?",
    "created_at": "2021-02-14T17:30:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426956",
    "user": "https://github.com/mjungmath"
}
```

Alright, let's do that optimization in a follow-up.

However, I am still concerned about `CompParent` being a proper class, which means that the collection of all those parents is no class at all and hence no category in terms of strict category theory.

Any ideas how to circumvent this matter?



---

archive/issue_comments_426957.json:
```json
{
    "body": "Replying to [comment:58 gh-mjungmath]:\n> However, I am still concerned about `CompParent` being a proper class, which means that the collection of all those parents is no class at all and hence no category in terms of strict category theory.\n> \n> Any ideas how to circumvent this matter?\n\n\nStop worrying about it. We can have slight abuses in Sage (see `RR` being a field), and this is also something that is a very technical point that is occurring below what most users will see.",
    "created_at": "2021-02-15T00:01:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426957",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:58 gh-mjungmath]:
> However, I am still concerned about `CompParent` being a proper class, which means that the collection of all those parents is no class at all and hence no category in terms of strict category theory.
> 
> Any ideas how to circumvent this matter?


Stop worrying about it. We can have slight abuses in Sage (see `RR` being a field), and this is also something that is a very technical point that is occurring below what most users will see.



---

archive/issue_comments_426958.json:
```json
{
    "body": "This task seems nothing that can be done in just one day. I would appreciate a little help and direction here. Especially w.r.t. #30276 and #28813. It would be a shame to put a lot of work in here if we had to refactor it again to achieve #30276 and #28813.",
    "created_at": "2021-03-25T15:53:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426958",
    "user": "https://github.com/mjungmath"
}
```

This task seems nothing that can be done in just one day. I would appreciate a little help and direction here. Especially w.r.t. #30276 and #28813. It would be a shame to put a lot of work in here if we had to refactor it again to achieve #30276 and #28813.



---

archive/issue_comments_426959.json:
```json
{
    "body": "I'll return to it after the 9.3 release",
    "created_at": "2021-03-25T16:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426959",
    "user": "https://github.com/mkoeppe"
}
```

I'll return to it after the 9.3 release



---

archive/issue_comments_426960.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-06-15T17:44:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426960",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_426961.json:
```json
{
    "body": "I have rebased the branch on top of the current develop.\n\nTo keep the ticket more focused, I have undone the Cythonization.",
    "created_at": "2021-06-15T18:14:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426961",
    "user": "https://github.com/mkoeppe"
}
```

I have rebased the branch on top of the current develop.

To keep the ticket more focused, I have undone the Cythonization.



---

archive/issue_comments_426962.json:
```json
{
    "body": "I am going to move `start_index` from the parents to the elements because the symmetries have nothing to do with it.",
    "created_at": "2021-06-15T18:16:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426962",
    "user": "https://github.com/mkoeppe"
}
```

I am going to move `start_index` from the parents to the elements because the symmetries have nothing to do with it.



---

archive/issue_comments_426963.json:
```json
{
    "body": "Same also for `_dim`. \n\nMethod `index_generator` will take a list of range objects - this will provide a generalization for the case of tensors between modules of differing ranks",
    "created_at": "2021-06-15T18:52:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426963",
    "user": "https://github.com/mkoeppe"
}
```

Same also for `_dim`. 

Method `index_generator` will take a list of range objects - this will provide a generalization for the case of tensors between modules of differing ranks



---

archive/issue_comments_426964.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-15T19:57:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426964",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426965.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-15T20:36:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426965",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426966.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-15T23:32:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426966",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426967.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-16T01:39:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426967",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426968.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-16T02:35:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426968",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426969.json:
```json
{
    "body": "Started to prepare the classes for multiple backend implementations.",
    "created_at": "2021-06-16T02:35:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426969",
    "user": "https://github.com/mkoeppe"
}
```

Started to prepare the classes for multiple backend implementations.



---

archive/issue_comments_426970.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-16T03:16:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426970",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426971.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-16T03:55:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426971",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426972.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-17T19:03:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426972",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426973.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-17T19:59:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426973",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426974.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-17T21:15:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426974",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426975.json:
```json
{
    "body": "I will need to revise the design a bit to accommodate different backends.\n\nA `CompParent` will become a free module over a fixed ring.  \n\nFixing the ring is necessary because numerical backends (for example for NumPy's `ndarray`) can only work with base ring `RDF`; whereas the symbolic backends (such as the existing dictionary-based implementation) is for `SR` and exact rings.",
    "created_at": "2021-06-17T22:57:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426975",
    "user": "https://github.com/mkoeppe"
}
```

I will need to revise the design a bit to accommodate different backends.

A `CompParent` will become a free module over a fixed ring.  

Fixing the ring is necessary because numerical backends (for example for NumPy's `ndarray`) can only work with base ring `RDF`; whereas the symbolic backends (such as the existing dictionary-based implementation) is for `SR` and exact rings.



---

archive/issue_comments_426976.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-17T23:20:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426976",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426977.json:
```json
{
    "body": "I've arrived at a point where it just remains to teach the coercion system about coercions/pushouts to combine operands with differing symmetries\n\n```\nFile \"src/sage/tensor/modules/comp_element_dict.py\", line 914, in sage.tensor.modules.comp_element_dict.ComponentsWithSym_dict\nFailed example:\n    s = a + b ; s\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/doctest/forker.py\", line 714, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/doctest/forker.py\", line 1133, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.tensor.modules.comp_element_dict.ComponentsWithSym_dict[27]>\", line 1, in <module>\n        s = a + b ; s\n      File \"sage/structure/element.pyx\", line 1232, in sage.structure.element.Element.__add__\n        return coercion_model.bin_op(left, right, add)\n      File \"sage/structure/coerce.pyx\", line 1248, in sage.structure.coerce.CoercionModel.bin_op\n        raise bin_op_exception(op, x, y)\n    TypeError: unsupported operand parent(s) for +: 'Parent of 2-index components over Rational Field' and 'Parent of Fully symmetric 2-index components over Rational Field'\n```",
    "created_at": "2021-06-17T23:23:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426977",
    "user": "https://github.com/mkoeppe"
}
```

I've arrived at a point where it just remains to teach the coercion system about coercions/pushouts to combine operands with differing symmetries

```
File "src/sage/tensor/modules/comp_element_dict.py", line 914, in sage.tensor.modules.comp_element_dict.ComponentsWithSym_dict
Failed example:
    s = a + b ; s
Exception raised:
    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.tensor.modules.comp_element_dict.ComponentsWithSym_dict[27]>", line 1, in <module>
        s = a + b ; s
      File "sage/structure/element.pyx", line 1232, in sage.structure.element.Element.__add__
        return coercion_model.bin_op(left, right, add)
      File "sage/structure/coerce.pyx", line 1248, in sage.structure.coerce.CoercionModel.bin_op
        raise bin_op_exception(op, x, y)
    TypeError: unsupported operand parent(s) for +: 'Parent of 2-index components over Rational Field' and 'Parent of Fully symmetric 2-index components over Rational Field'
```



---

archive/issue_comments_426978.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-18T00:18:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426978",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426979.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-18T01:24:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426979",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426980.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-18T04:12:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426980",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426981.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-18T04:42:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426981",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426982.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-18T05:55:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426982",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426983.json:
```json
{
    "body": "`sage.tensor.modules` passes all tests except for `_test_not_implemented_methods` (to be fixed by #29619)\n\nThere are still various errors in `sage.manifolds`. \nFor example, in `src/sage/manifolds/differentiable/multivectorfield.py`:\n\n```\nsage -t --random-seed=0 src/sage/manifolds/differentiable/multivectorfield.py\n**********************************************************************\nFile \"src/sage/manifolds/differentiable/multivectorfield.py\", line 117, in sage.manifolds.differentiable.multivectorfield.MultivectorField\nFailed example:\n    a.display(eU)\nExpected:\n    a = (x*y^2 + 2*x) d/dx/\\d/dy\nGot:\n    a = (x*y^2 + 2*x) d/dx*d/dy + (-x*y^2 - 2*x) d/dy*d/dx\n```\n\nHelp in spotting where these errors are coming from would be welcome",
    "created_at": "2021-06-18T05:59:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426983",
    "user": "https://github.com/mkoeppe"
}
```

`sage.tensor.modules` passes all tests except for `_test_not_implemented_methods` (to be fixed by #29619)

There are still various errors in `sage.manifolds`. 
For example, in `src/sage/manifolds/differentiable/multivectorfield.py`:

```
sage -t --random-seed=0 src/sage/manifolds/differentiable/multivectorfield.py
**********************************************************************
File "src/sage/manifolds/differentiable/multivectorfield.py", line 117, in sage.manifolds.differentiable.multivectorfield.MultivectorField
Failed example:
    a.display(eU)
Expected:
    a = (x*y^2 + 2*x) d/dx/\d/dy
Got:
    a = (x*y^2 + 2*x) d/dx*d/dy + (-x*y^2 - 2*x) d/dy*d/dx
```

Help in spotting where these errors are coming from would be welcome



---

archive/issue_comments_426984.json:
```json
{
    "body": "For some reason, the `restrict` method doesn't work properly:\n\n\n```\nsage: M = Manifold(2, 'M')\nsage: U = M.open_subset('U') ; V = M.open_subset('V')\nsage: M.declare_union(U,V)   # M is the union of U and V\nsage: c_xy.<x,y> = U.chart() ; c_uv.<u,v> = V.chart()\nsage: xy_to_uv = c_xy.transition_map(c_uv, (x+y, x-y),\n....:                         intersection_name='W',\n....:                         restrictions1= x>0, restrictions2= u+v>0)\nsage: uv_to_xy = xy_to_uv.inverse()\nsage: W = U.intersection(V)\nsage: eU = c_xy.frame() ; eV = c_uv.frame()\nsage: a = M.multivector_field(2, name='a')\nsage: a[eU,0,1] = x*y^2 + 2*x\nsage: a.add_comp_by_continuation(eV, W, c_uv)\nsage: a.retrict(U)\nTensor field a of type (2,0) on the Open subset U of the 2-dimensional differentiable manifold M\n```\n\nBut it should return\n\n```\n2-vector field a on the Open subset U of the 2-dimensional differentiable manifold M\n```",
    "created_at": "2021-06-19T13:55:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426984",
    "user": "https://github.com/mjungmath"
}
```

For some reason, the `restrict` method doesn't work properly:


```
sage: M = Manifold(2, 'M')
sage: U = M.open_subset('U') ; V = M.open_subset('V')
sage: M.declare_union(U,V)   # M is the union of U and V
sage: c_xy.<x,y> = U.chart() ; c_uv.<u,v> = V.chart()
sage: xy_to_uv = c_xy.transition_map(c_uv, (x+y, x-y),
....:                         intersection_name='W',
....:                         restrictions1= x>0, restrictions2= u+v>0)
sage: uv_to_xy = xy_to_uv.inverse()
sage: W = U.intersection(V)
sage: eU = c_xy.frame() ; eV = c_uv.frame()
sage: a = M.multivector_field(2, name='a')
sage: a[eU,0,1] = x*y^2 + 2*x
sage: a.add_comp_by_continuation(eV, W, c_uv)
sage: a.retrict(U)
Tensor field a of type (2,0) on the Open subset U of the 2-dimensional differentiable manifold M
```

But it should return

```
2-vector field a on the Open subset U of the 2-dimensional differentiable manifold M
```



---

archive/issue_comments_426985.json:
```json
{
    "body": "Okay, I spotted the error. It's caused by these lines:\n\n```diff\n+        self._sym = tuple(self._sym)\n+        self._antisym = tuple(self._antisym)\n```\n\nWhen a tensor field is displayed, it must be restricted to a parallelizable subset first. If that restriction does not exists, it's constructed from scratch. This is done by the `tensor` method of the corresponding vector field module of this subset. In particular, the parameters `sym` and `antisym` are passed to this method. In our particular case the code will be executed until\n\n```python\n        elif tensor_type[0] > 1 and tensor_type[1] == 0 and antisym:\n            if isinstance(antisym[0], (int, Integer)):\n                # a single antisymmetry is provided as a tuple or a\n                # range object; it is converted to a 1-item list:\n                antisym = [tuple(antisym)]\n            if isinstance(antisym, list):\n                antisym0 = antisym[0]\n            else:\n                antisym0 = antisym\n            if len(antisym0) == tensor_type[0]:\n                return self.alternating_contravariant_tensor(\n                                              tensor_type[0], name=name,\n                                              latex_name=latex_name)\n```\n\nWith the above change, however, `len(antisym0)` returns `1`, but it should be `2` because the code turns `[(0, 1)]` into `((0,1),)`. So, this case will be ignored and a tensor without symmetries will be created instead.",
    "created_at": "2021-06-20T21:18:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426985",
    "user": "https://github.com/mjungmath"
}
```

Okay, I spotted the error. It's caused by these lines:

```diff
+        self._sym = tuple(self._sym)
+        self._antisym = tuple(self._antisym)
```

When a tensor field is displayed, it must be restricted to a parallelizable subset first. If that restriction does not exists, it's constructed from scratch. This is done by the `tensor` method of the corresponding vector field module of this subset. In particular, the parameters `sym` and `antisym` are passed to this method. In our particular case the code will be executed until

```python
        elif tensor_type[0] > 1 and tensor_type[1] == 0 and antisym:
            if isinstance(antisym[0], (int, Integer)):
                # a single antisymmetry is provided as a tuple or a
                # range object; it is converted to a 1-item list:
                antisym = [tuple(antisym)]
            if isinstance(antisym, list):
                antisym0 = antisym[0]
            else:
                antisym0 = antisym
            if len(antisym0) == tensor_type[0]:
                return self.alternating_contravariant_tensor(
                                              tensor_type[0], name=name,
                                              latex_name=latex_name)
```

With the above change, however, `len(antisym0)` returns `1`, but it should be `2` because the code turns `[(0, 1)]` into `((0,1),)`. So, this case will be ignored and a tensor without symmetries will be created instead.



---

archive/issue_comments_426986.json:
```json
{
    "body": "One way to solve this could be to adapt the preprocessing of `antisym0` and `sym0` in the `tensor` method, assuming `antisym` and `sym` is a tuple.",
    "created_at": "2021-06-20T21:21:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426986",
    "user": "https://github.com/mjungmath"
}
```

One way to solve this could be to adapt the preprocessing of `antisym0` and `sym0` in the `tensor` method, assuming `antisym` and `sym` is a tuple.



---

archive/issue_comments_426987.json:
```json
{
    "body": "Thanks for spotting this!",
    "created_at": "2021-06-20T22:44:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426987",
    "user": "https://github.com/mkoeppe"
}
```

Thanks for spotting this!



---

archive/issue_comments_426988.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-20T23:10:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426988",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426989.json:
```json
{
    "body": "With these changes, only failures that look like this remain:\n\n```\nsage -t --random-seed=0 src/sage/manifolds/differentiable/examples/sphere.py\n**********************************************************************\nFile \"src/sage/manifolds/differentiable/examples/sphere.py\", line 56, in sage.manifolds.differentiable.examples.sphere\nFailed example:\n    h.display()\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/doctest/forker.py\", line 714, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/doctest/forker.py\", line 1133, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.manifolds.differentiable.examples.sphere[5]>\", line 1, in <module>\n        h.display()\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/manifolds/differentiable/tensorfield.py\", line 1852, in display\n        return rst.display(frame, chart)\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/tensor/modules/free_module_tensor.py\", line 723, in display\n        coef = comp[ind_arg]\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/tensor/modules/comp_element_dict.py\", line 2533, in __getitem__\n        return self._output_formatter(self._comp[ind])\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/manifolds/scalarfield.py\", line 1786, in coord_function\n        raise ValueError(\"no starting chart could be found to \" +\n    ValueError: no starting chart could be found to compute the expression in the Chart (E^3, (x, y, z))\n```",
    "created_at": "2021-06-20T23:12:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426989",
    "user": "https://github.com/mkoeppe"
}
```

With these changes, only failures that look like this remain:

```
sage -t --random-seed=0 src/sage/manifolds/differentiable/examples/sphere.py
**********************************************************************
File "src/sage/manifolds/differentiable/examples/sphere.py", line 56, in sage.manifolds.differentiable.examples.sphere
Failed example:
    h.display()
Exception raised:
    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.manifolds.differentiable.examples.sphere[5]>", line 1, in <module>
        h.display()
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/manifolds/differentiable/tensorfield.py", line 1852, in display
        return rst.display(frame, chart)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/tensor/modules/free_module_tensor.py", line 723, in display
        coef = comp[ind_arg]
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/tensor/modules/comp_element_dict.py", line 2533, in __getitem__
        return self._output_formatter(self._comp[ind])
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/manifolds/scalarfield.py", line 1786, in coord_function
        raise ValueError("no starting chart could be found to " +
    ValueError: no starting chart could be found to compute the expression in the Chart (E^3, (x, y, z))
```



---

archive/issue_comments_426990.json:
```json
{
    "body": "This is likely not the final form of this ticket.\n\nThe goals of this ticket -- one-time precomputation of data related to the symmetries -- have not been fully achieved yet because the parent class is now a module over a base ring. This is fine for numerical tensors that are all over the same ring (`QQ` or `RDF`) but for the symbolic tensors that are used in `sage.manifolds`, there are many base rings, so the symmetries will be recomputed for each of them.\n\nBut for now it was more important to me to have separate parents for separate base rings, as this will allow us to dispatch to different implementation backends (= element classes) - as part of `@`gh-honglizhaobob's project (#31991).\n\nMy solution for allowing more shared precomputation would be to introduce another class, similar to https://docs.sympy.org/latest/modules/tensor/tensor.html#sympy.tensor.tensor.TensorSymmetry, which only captures the symmetry group (with action).\n\nApart from this, there is still some code that should be pushed from element to parent, for example the symmetries from tensor contraction. \n\nAnd there are branches in the code that can no longer be reached because the coercion system, via `CompParent._element_constructor_`, now guarantees that the inputs of single-underscore methods such as `_add_` have the same symmetry already.\n\nAlso, I have not done any time measurements.",
    "created_at": "2021-06-20T23:39:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426990",
    "user": "https://github.com/mkoeppe"
}
```

This is likely not the final form of this ticket.

The goals of this ticket -- one-time precomputation of data related to the symmetries -- have not been fully achieved yet because the parent class is now a module over a base ring. This is fine for numerical tensors that are all over the same ring (`QQ` or `RDF`) but for the symbolic tensors that are used in `sage.manifolds`, there are many base rings, so the symmetries will be recomputed for each of them.

But for now it was more important to me to have separate parents for separate base rings, as this will allow us to dispatch to different implementation backends (= element classes) - as part of `@`gh-honglizhaobob's project (#31991).

My solution for allowing more shared precomputation would be to introduce another class, similar to https://docs.sympy.org/latest/modules/tensor/tensor.html#sympy.tensor.tensor.TensorSymmetry, which only captures the symmetry group (with action).

Apart from this, there is still some code that should be pushed from element to parent, for example the symmetries from tensor contraction. 

And there are branches in the code that can no longer be reached because the coercion system, via `CompParent._element_constructor_`, now guarantees that the inputs of single-underscore methods such as `_add_` have the same symmetry already.

Also, I have not done any time measurements.



---

archive/issue_comments_426991.json:
```json
{
    "body": "Further refactoring will go through #32029 (Action of a sympy `TensorSymmetry`)",
    "created_at": "2021-06-22T07:01:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426991",
    "user": "https://github.com/mkoeppe"
}
```

Further refactoring will go through #32029 (Action of a sympy `TensorSymmetry`)



---

archive/issue_comments_426992.json:
```json
{
    "body": "Looks good so far!\n\nWhat about the idea with the morphisms in comment:28?",
    "created_at": "2021-06-27T11:17:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426992",
    "user": "https://github.com/mjungmath"
}
```

Looks good so far!

What about the idea with the morphisms in comment:28?



---

archive/issue_comments_426993.json:
```json
{
    "body": "Replying to [comment:101 gh-mjungmath]:\n> What about the idea with the morphisms in comment:28?\n\n\nThe next step into this direction should be to fix/complete the existing code for coercions.\n\n```\nsage: cp = CompParentWithSym(QQ, 4, sym=((1, 2), (3, 4)))\nsage: cp2 = CompParentWithSym(QQ, 4, sym=((1, 2, 3, 4)))\nsage: cp.coerce_map_from(cp2)   # returns None, should return injection to cp\n```\nHelp with this is welcome!",
    "created_at": "2021-06-27T17:45:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426993",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:101 gh-mjungmath]:
> What about the idea with the morphisms in comment:28?


The next step into this direction should be to fix/complete the existing code for coercions.

```
sage: cp = CompParentWithSym(QQ, 4, sym=((1, 2), (3, 4)))
sage: cp2 = CompParentWithSym(QQ, 4, sym=((1, 2, 3, 4)))
sage: cp.coerce_map_from(cp2)   # returns None, should return injection to cp
```
Help with this is welcome!



---

archive/issue_events_078467.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:16:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30070#event-78467"
}
```



---

archive/issue_events_078468.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:16:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30070#event-78468"
}
```



---

archive/issue_events_078469.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30070#event-78469"
}
```



---

archive/issue_events_078470.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30070#event-78470"
}
```



---

archive/issue_events_078471.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T00:06:20Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30070#event-78471"
}
```



---

archive/issue_events_078472.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T00:06:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30070#event-78472"
}
```



---

archive/issue_events_078473.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30070#event-78473"
}
```



---

archive/issue_events_078474.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30070#event-78474"
}
```



---

archive/issue_comments_426994.json:
```json
{
    "body": "Restarting this effort with a smaller step in #34497.",
    "created_at": "2022-09-06T00:15:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30070",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30070#issuecomment-426994",
    "user": "https://github.com/mkoeppe"
}
```

Restarting this effort with a smaller step in #34497.
