# Issue 14947: CachedFunction file location seems problematic

archive/issues_014947.json:
```json
{
    "body": "CC:  simonking @ohanar\n\nThere is a problem where cached function report problematic file information. Consider\n\n```\nsage: M=IntegerModRing(7)\nsage: edit(M.is_finite) #no problem\nsage: edit(M.is_field)\nIOError: [Errno 2] No such file or directory: '/sage/rings/finite_rings/integer_mod_ring.py'\n```\n\nIndeed sage doesn't find the appropriate source file:\n\n```\nsage: from sage.misc.sageinspect import sage_getfile\nsage: sage_getfile(M.is_finite)\n'/usr/local/sage/5.10/local/lib/python2.7/site-packages/sage/rings/finite_rings/integer_mod_ring.py'\nsage: sage_getfile(M.is_field)\n'/sage/rings/finite_rings/integer_mod_ring.py'\n```\n\nThe code that makes this happen is `sage/misc/cachefunc.pyx`, line 621:\n\n```python\n            if sourcelines is not None:\n                from sage.env import SAGE_SRC, SAGE_LIB\n                filename = sage_getfile(f)\n                # The following is a heuristics to get\n                # the file name of the cached function\n                # or method\n                if filename.startswith(SAGE_SRC):\n                    filename = filename[len(SAGE_SRC):]\n                elif filename.startswith(SAGE_LIB):\n                    filename = filename[len(SAGE_LIB):]\n                file_info = \"File: %s (starting at line %d)\\n\"%(filename,sourcelines[1])\n                doc = file_info+(f.func_doc or '')\n```\n\nAs you can see, the code actively strips away the part that should really still be there. This change was made on #13432. Would it be very wrong to just do nothing with the filename here and simply report whatever gets reported on the original file?\n\nProposed doctest:\n\n```\nsage: M=IntegerModRing(7)\nsage: from sage.misc.sageinspect import sage_getfile\nsage: os.path.exists(sage_getfile(M.is_finite))\nTrue\nsage: os.path.exists(sage_getfile(M.is_field)) #this presently fails\nTrue\n\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/15184\n\n",
    "created_at": "2013-09-10T20:20:10Z",
    "labels": [
        "misc",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "CachedFunction file location seems problematic",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14947",
    "user": "@nbruin"
}
```
CC:  simonking @ohanar

There is a problem where cached function report problematic file information. Consider

```
sage: M=IntegerModRing(7)
sage: edit(M.is_finite) #no problem
sage: edit(M.is_field)
IOError: [Errno 2] No such file or directory: '/sage/rings/finite_rings/integer_mod_ring.py'
```

Indeed sage doesn't find the appropriate source file:

```
sage: from sage.misc.sageinspect import sage_getfile
sage: sage_getfile(M.is_finite)
'/usr/local/sage/5.10/local/lib/python2.7/site-packages/sage/rings/finite_rings/integer_mod_ring.py'
sage: sage_getfile(M.is_field)
'/sage/rings/finite_rings/integer_mod_ring.py'
```

The code that makes this happen is `sage/misc/cachefunc.pyx`, line 621:

```python
            if sourcelines is not None:
                from sage.env import SAGE_SRC, SAGE_LIB
                filename = sage_getfile(f)
                # The following is a heuristics to get
                # the file name of the cached function
                # or method
                if filename.startswith(SAGE_SRC):
                    filename = filename[len(SAGE_SRC):]
                elif filename.startswith(SAGE_LIB):
                    filename = filename[len(SAGE_LIB):]
                file_info = "File: %s (starting at line %d)\n"%(filename,sourcelines[1])
                doc = file_info+(f.func_doc or '')
```

As you can see, the code actively strips away the part that should really still be there. This change was made on #13432. Would it be very wrong to just do nothing with the filename here and simply report whatever gets reported on the original file?

Proposed doctest:

```
sage: M=IntegerModRing(7)
sage: from sage.misc.sageinspect import sage_getfile
sage: os.path.exists(sage_getfile(M.is_finite))
True
sage: os.path.exists(sage_getfile(M.is_field)) #this presently fails
True

```


Issue created by migration from https://trac.sagemath.org/ticket/15184





---

archive/issue_comments_190914.json:
```json
{
    "body": "The logic above seems like a SAGE_ROOT-less translation of the code introduced on #11115, but I think something went wrong with a \"leading slash\" problem:\n\n```\nsage: sage.env.SAGE_LIB\n'/usr/local/sage/5.10/local/lib/python2.7/site-packages'\nsage: sage_getfile(M.is_field.f)\n'/usr/local/sage/5.10/local/lib/python2.7/site-packages/sage/rings/finite_rings/integer_mod_ring.py'\nsage: sage_getfile(M.is_field)\n'/sage/rings/finite_rings/integer_mod_ring.py'\nsage: sage.env.SAGE_LIB=sage.env.SAGE_LIB+'/'\nsage: sage_getfile(M.is_field)\n'/usr/local/sage/5.10/devel/sage/sage/rings/finite_rings/integer_mod_ring.py'\n```\n\nso it seems that if `_sage_doc_` ensures it returns a *relative* filename, then `sage_getfile` will prefix the appropriate path, but if it returns an *absolute* path (which happens if we snap off 'SAGE_LIB' but not its slash separator) then of course it won't.\n\nAre we sure that the connecting slash is never there? Then we can just do `filename = filename[len(SAGE_LIB)+1:]`. Otherwise, perhaps we should do\n\n```\n                if filename.startswith(SAGE_SRC):\n                    filename = filename[len(SAGE_SRC):]\n                    if filename.startswith('/'):\n                        filename = filename[1:]\n                elif filename.startswith(SAGE_LIB):\n                    filename = filename[len(SAGE_LIB):]\n                    if filename.startswith('/'):\n                        filename = filename[1:]\n```\n\nBy the way, is\n\n```\n            try:\n                sourcelines = sage_getsourcelines(f)\n            except IOError:\n                sourcelines = None\n```\n\nreally the best way of checking that the file reported by `sage_getfile(f)` exists? We could just do a\n\n```\ntry:\n    open(sage_getfile(f),'r')\n    file_exists=True\nexcept IOError:\n    file_exists=False\n```\n\nwhich should be cheaper than actually rummaging through the entire file. The only thing we use later on is the starting line, and in many cases that would be available from elsewhere (e.g., the docstring), so we wouldn't need to actually read the source file.",
    "created_at": "2013-09-10T20:49:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190914",
    "user": "@nbruin"
}
```

The logic above seems like a SAGE_ROOT-less translation of the code introduced on #11115, but I think something went wrong with a "leading slash" problem:

```
sage: sage.env.SAGE_LIB
'/usr/local/sage/5.10/local/lib/python2.7/site-packages'
sage: sage_getfile(M.is_field.f)
'/usr/local/sage/5.10/local/lib/python2.7/site-packages/sage/rings/finite_rings/integer_mod_ring.py'
sage: sage_getfile(M.is_field)
'/sage/rings/finite_rings/integer_mod_ring.py'
sage: sage.env.SAGE_LIB=sage.env.SAGE_LIB+'/'
sage: sage_getfile(M.is_field)
'/usr/local/sage/5.10/devel/sage/sage/rings/finite_rings/integer_mod_ring.py'
```

so it seems that if `_sage_doc_` ensures it returns a *relative* filename, then `sage_getfile` will prefix the appropriate path, but if it returns an *absolute* path (which happens if we snap off 'SAGE_LIB' but not its slash separator) then of course it won't.

Are we sure that the connecting slash is never there? Then we can just do `filename = filename[len(SAGE_LIB)+1:]`. Otherwise, perhaps we should do

```
                if filename.startswith(SAGE_SRC):
                    filename = filename[len(SAGE_SRC):]
                    if filename.startswith('/'):
                        filename = filename[1:]
                elif filename.startswith(SAGE_LIB):
                    filename = filename[len(SAGE_LIB):]
                    if filename.startswith('/'):
                        filename = filename[1:]
```

By the way, is

```
            try:
                sourcelines = sage_getsourcelines(f)
            except IOError:
                sourcelines = None
```

really the best way of checking that the file reported by `sage_getfile(f)` exists? We could just do a

```
try:
    open(sage_getfile(f),'r')
    file_exists=True
except IOError:
    file_exists=False
```

which should be cheaper than actually rummaging through the entire file. The only thing we use later on is the starting line, and in many cases that would be available from elsewhere (e.g., the docstring), so we wouldn't need to actually read the source file.



---

archive/issue_comments_190915.json:
```json
{
    "body": "I think the current code is fragile, in particular if soft links are used (os.path.realpath might be needed at some point). os.path.exists might also come in handy.\n\nThe proposed fix expects the path separator \"/\", which should be os.path.pathsep.\n\nSo, there is enough reason to use os.path, rather than re-inventing its functionality in a non-portable way.",
    "created_at": "2013-09-10T21:56:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190915",
    "user": "@simon-king-jena"
}
```

I think the current code is fragile, in particular if soft links are used (os.path.realpath might be needed at some point). os.path.exists might also come in handy.

The proposed fix expects the path separator "/", which should be os.path.pathsep.

So, there is enough reason to use os.path, rather than re-inventing its functionality in a non-portable way.



---

archive/issue_comments_190916.json:
```json
{
    "body": "Replying to [comment:2 SimonKing]:\n> I think the current code is fragile, in particular if soft links are used (os.path.realpath might be needed at some point). \nDo you think so? Shouldn't we just trust the paths as they are offered to us? Either `$SAGE_ROOT` has already been normalized, and then at this point any path that's coming from sage is already a \"real\" path, or `$SAGE_ROOT` is not normalized (and hence nothing derived from it either) and we shouldn't be normalizing either.\n\n> The proposed fix expects the path separator \"/\", which should be os.path.pathsep.\n> \n> So, there is enough reason to use os.path, rather than re-inventing its functionality in a non-portable way.\n\nI agree with that. However, I don't really see why we need to fondle the path anyway. We're getting the path that would be generated by `sage_getfile` on the original function. How can we improve on that?",
    "created_at": "2013-09-10T23:14:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190916",
    "user": "@nbruin"
}
```

Replying to [comment:2 SimonKing]:
> I think the current code is fragile, in particular if soft links are used (os.path.realpath might be needed at some point). 
Do you think so? Shouldn't we just trust the paths as they are offered to us? Either `$SAGE_ROOT` has already been normalized, and then at this point any path that's coming from sage is already a "real" path, or `$SAGE_ROOT` is not normalized (and hence nothing derived from it either) and we shouldn't be normalizing either.

> The proposed fix expects the path separator "/", which should be os.path.pathsep.
> 
> So, there is enough reason to use os.path, rather than re-inventing its functionality in a non-portable way.

I agree with that. However, I don't really see why we need to fondle the path anyway. We're getting the path that would be generated by `sage_getfile` on the original function. How can we improve on that?



---

archive/issue_comments_190917.json:
```json
{
    "body": "Replying to [comment:3 nbruin]:\n> > So, there is enough reason to use os.path, rather than re-inventing its functionality in a non-portable way.\n> \n> I agree with that. However, I don't really see why we need to fondle the path anyway. We're getting the path that would be generated by `sage_getfile` on the original function. How can we improve on that?\n\nPython does not provide the file information in the doc string, but Cython does. And what would Cython do?\n\n```\nsage: CachedFunction.__doc__\n\"File: sage/misc/cachefunc.pyx (starting at line 452)\\n\\n\n...\n```\n\n\nI guess we try to mimmick this behaviour. Note, however, that we mildly fail:\n\n```\nsage: P.<x,y> = QQ[]\nsage: I = P*x   \nsage: from sage.misc.sageinspect import _sage_getdoc_unformatted\nsage: _sage_getdoc_unformatted(I.groebner_basis)\n\"File: /sage/rings/polynomial/multi_polynomial_ideal.py (starting at line 3507)\n...\n```\n\nSo, there is the additional \"/\" in the beginning of the file location. But in any case, Cython does not give the full path, and thus it should be a good idea that Sage doesn't, either.\n\nBy the way, something that I'm perhaps not to blame for should be changed, too: `sage.misc.cachefunc.FileCache` uses '/' as separator.",
    "created_at": "2013-09-11T10:06:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190917",
    "user": "@simon-king-jena"
}
```

Replying to [comment:3 nbruin]:
> > So, there is enough reason to use os.path, rather than re-inventing its functionality in a non-portable way.
> 
> I agree with that. However, I don't really see why we need to fondle the path anyway. We're getting the path that would be generated by `sage_getfile` on the original function. How can we improve on that?

Python does not provide the file information in the doc string, but Cython does. And what would Cython do?

```
sage: CachedFunction.__doc__
"File: sage/misc/cachefunc.pyx (starting at line 452)\n\n
...
```


I guess we try to mimmick this behaviour. Note, however, that we mildly fail:

```
sage: P.<x,y> = QQ[]
sage: I = P*x   
sage: from sage.misc.sageinspect import _sage_getdoc_unformatted
sage: _sage_getdoc_unformatted(I.groebner_basis)
"File: /sage/rings/polynomial/multi_polynomial_ideal.py (starting at line 3507)
...
```

So, there is the additional "/" in the beginning of the file location. But in any case, Cython does not give the full path, and thus it should be a good idea that Sage doesn't, either.

By the way, something that I'm perhaps not to blame for should be changed, too: `sage.misc.cachefunc.FileCache` uses '/' as separator.



---

archive/issue_comments_190918.json:
```json
{
    "body": "Something along these lines then? Note that this may be a good motivation to refactor sageinspect a little, so that getting \"source file and line\" is a little cheaper in many cases. Getting just a docstring should be fairly cheap (and usually should not involve reading source files), and here we're usually triggering a full fetch of the source code, only to throw it away. The reason is that sage_getsourcelines has a lot of logic that also applies to just fetching (file,lineno), but that logic is not available separately.",
    "created_at": "2013-09-11T18:21:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190918",
    "user": "@nbruin"
}
```

Something along these lines then? Note that this may be a good motivation to refactor sageinspect a little, so that getting "source file and line" is a little cheaper in many cases. Getting just a docstring should be fairly cheap (and usually should not involve reading source files), and here we're usually triggering a full fetch of the source code, only to throw it away. The reason is that sage_getsourcelines has a lot of logic that also applies to just fetching (file,lineno), but that logic is not available separately.



---

archive/issue_comments_190919.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-09-11T18:21:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190919",
    "user": "@nbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_190920.json:
```json
{
    "body": "Replying to [comment:5 nbruin]:\n> Something along these lines then?\n\nSounds good! And thank you that you did not attach a git branch. Hence, there is a chance that I will actually review it soon. Hopefully some people at Sage Days in Oxford will explain how to work with git. It currently seems plainly broken to me.\n\n> Note that this may be a good motivation to refactor sageinspect a little, so that getting \"source file and line\" is a little cheaper in many cases.\n\nHow?\n\n> Getting just a docstring should be fairly cheap (and usually should not involve reading source files), \n\nYes, the docstring itself would be easy. But in order to comply with Cython, it was decided to put file information into the doc string.\n\n> and here we're usually triggering a full fetch of the source code, only to throw it away.\n\nWhat do you mean by \"here\"?\n\n> The reason is that sage_getsourcelines has a lot of logic that also applies to just fetching (file,lineno), but that logic is not available separately.\n\nIs there code duplication? Or do you just suggest to make the code more modular?",
    "created_at": "2013-09-11T18:53:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190920",
    "user": "@simon-king-jena"
}
```

Replying to [comment:5 nbruin]:
> Something along these lines then?

Sounds good! And thank you that you did not attach a git branch. Hence, there is a chance that I will actually review it soon. Hopefully some people at Sage Days in Oxford will explain how to work with git. It currently seems plainly broken to me.

> Note that this may be a good motivation to refactor sageinspect a little, so that getting "source file and line" is a little cheaper in many cases.

How?

> Getting just a docstring should be fairly cheap (and usually should not involve reading source files), 

Yes, the docstring itself would be easy. But in order to comply with Cython, it was decided to put file information into the doc string.

> and here we're usually triggering a full fetch of the source code, only to throw it away.

What do you mean by "here"?

> The reason is that sage_getsourcelines has a lot of logic that also applies to just fetching (file,lineno), but that logic is not available separately.

Is there code duplication? Or do you just suggest to make the code more modular?



---

archive/issue_comments_190921.json:
```json
{
    "body": "Aha, I see your comments in the patch. So, perhaps you are right, it would be a good idea to have a separate function dedicated to getting file and line number.",
    "created_at": "2013-09-11T18:58:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190921",
    "user": "@simon-king-jena"
}
```

Aha, I see your comments in the patch. So, perhaps you are right, it would be a good idea to have a separate function dedicated to getting file and line number.



---

archive/issue_comments_190922.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-09-12T08:59:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190922",
    "user": "@simon-king-jena"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_190923.json:
```json
{
    "body": "With the patch, we get\n\n```\nsage: P.<x,y> = QQ[]\nsage: I = P*x \nsage: from sage.misc.sageinspect import _sage_getdoc_unformatted\nsage: _sage_getdoc_unformatted(I.groebner_basis)\n\"File: /mnt/local/king/SAGE/prereleases/sage-5.12.beta5/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py (starting at line 3533)\n```\n\nand I think this is not what we want. I believe we should be as close to Cython's behaviour as possible, hence, it should be\n\n```\nFile: sage/rings/polynomial/multi_polynomial_ideal.py\n```\n\nCurrently, it is `File: /sage/rings/polynomial/multi_polynomial_ideal.py`, and I think according to what Cython does we should get rid of the leading slash.",
    "created_at": "2013-09-12T08:59:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190923",
    "user": "@simon-king-jena"
}
```

With the patch, we get

```
sage: P.<x,y> = QQ[]
sage: I = P*x 
sage: from sage.misc.sageinspect import _sage_getdoc_unformatted
sage: _sage_getdoc_unformatted(I.groebner_basis)
"File: /mnt/local/king/SAGE/prereleases/sage-5.12.beta5/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py (starting at line 3533)
```

and I think this is not what we want. I believe we should be as close to Cython's behaviour as possible, hence, it should be

```
File: sage/rings/polynomial/multi_polynomial_ideal.py
```

Currently, it is `File: /sage/rings/polynomial/multi_polynomial_ideal.py`, and I think according to what Cython does we should get rid of the leading slash.



---

archive/issue_comments_190924.json:
```json
{
    "body": "Attachment [trac_15184.patch](tarball://root/attachments/some-uuid/ticket15184/trac_15184.patch) by @nbruin created at 2013-09-12 16:22:56\n\nUpdated, with doctest",
    "created_at": "2013-09-12T16:22:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190924",
    "user": "@nbruin"
}
```

Attachment [trac_15184.patch](tarball://root/attachments/some-uuid/ticket15184/trac_15184.patch) by @nbruin created at 2013-09-12 16:22:56

Updated, with doctest



---

archive/issue_comments_190925.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-09-12T16:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190925",
    "user": "@nbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_190926.json:
```json
{
    "body": "Some stupid typos in the old version. Sorry about that. New version should be better. Incidentally, to see that presently things are a bit on the slow side:\n\n```\nsage -t cachefunc.pyx\n    [596 tests, 28.50 s]\n```\n\nand that's for testing a module that doesn't implement any significant computation! I suspect that it's because of extensive testing of incredibly slow introspection tools.",
    "created_at": "2013-09-12T16:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190926",
    "user": "@nbruin"
}
```

Some stupid typos in the old version. Sorry about that. New version should be better. Incidentally, to see that presently things are a bit on the slow side:

```
sage -t cachefunc.pyx
    [596 tests, 28.50 s]
```

and that's for testing a module that doesn't implement any significant computation! I suspect that it's because of extensive testing of incredibly slow introspection tools.



---

archive/issue_comments_190927.json:
```json
{
    "body": "I guess it doesn't hurt to have the path normalization in, but it might not be necessary for the common prefix checking, at least not at far as trailing slashes are concerned:\n\n```\nsage: P=\"/a/b/c/d/e/f\"\nsage: Q=\"/a/b/c/\"\nsage: os.path.commonprefix([P,Q])\n'/a/b/c/'\nsage: Qn=os.path.normpath(Q)\nsage: Qn\n'/a/b/c'\nsage: os.path.commonprefix([P,Qn])\n'/a/b/c'\nsage: os.path.relpath(P,Q)\n'd/e/f'\nsage: os.path.relpath(P,Qn)\n'd/e/f'\nsage: os.path.commonprefix([P,Q]) == Q\nTrue\nsage: os.path.commonprefix([P,Qn]) == Qn\nTrue\n```\n\nOf course we do have:\n\n```\nsage: Q=\"/a/b/../b/c/\"\nsage: os.path.commonprefix([P,Q])\n'/a/b/'\nsage: os.path.commonprefix([P,Q]) == Q\nFalse\nsage: Qn=os.path.normpath(Q)\nsage: Qn\n'/a/b/c'\nsage: os.path.commonprefix([P,Qn]) == Qn\nTrue\n```\n\nso we should make sure that `SAGE_LIB` and `SAGE_SRC` are normalized at some point.\n\nI don't think they need to be made \"real path\"s. If people have `ln -s /usr/local /usr/global` and they refer to files via both paths, they deserve that the system doesn't recognize them as identical. Of course, if sage decides to \"real path\" something, then it should do that, (probably SAGE_ROOT), once, and derive all its paths from that. Certainly at this point we should just trust what we get. The whole \"return relative paths\" is cosmetic anyway and in most of the cases the next step will be to recognize that the path is relative and put the original prefix back.",
    "created_at": "2013-09-12T18:46:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190927",
    "user": "@nbruin"
}
```

I guess it doesn't hurt to have the path normalization in, but it might not be necessary for the common prefix checking, at least not at far as trailing slashes are concerned:

```
sage: P="/a/b/c/d/e/f"
sage: Q="/a/b/c/"
sage: os.path.commonprefix([P,Q])
'/a/b/c/'
sage: Qn=os.path.normpath(Q)
sage: Qn
'/a/b/c'
sage: os.path.commonprefix([P,Qn])
'/a/b/c'
sage: os.path.relpath(P,Q)
'd/e/f'
sage: os.path.relpath(P,Qn)
'd/e/f'
sage: os.path.commonprefix([P,Q]) == Q
True
sage: os.path.commonprefix([P,Qn]) == Qn
True
```

Of course we do have:

```
sage: Q="/a/b/../b/c/"
sage: os.path.commonprefix([P,Q])
'/a/b/'
sage: os.path.commonprefix([P,Q]) == Q
False
sage: Qn=os.path.normpath(Q)
sage: Qn
'/a/b/c'
sage: os.path.commonprefix([P,Qn]) == Qn
True
```

so we should make sure that `SAGE_LIB` and `SAGE_SRC` are normalized at some point.

I don't think they need to be made "real path"s. If people have `ln -s /usr/local /usr/global` and they refer to files via both paths, they deserve that the system doesn't recognize them as identical. Of course, if sage decides to "real path" something, then it should do that, (probably SAGE_ROOT), once, and derive all its paths from that. Certainly at this point we should just trust what we get. The whole "return relative paths" is cosmetic anyway and in most of the cases the next step will be to recognize that the path is relative and put the original prefix back.



---

archive/issue_comments_190928.json:
```json
{
    "body": "*PING* I got bitten by this issue once again, so I adapted the patch here as a branch. Can we review and incorporate this change?\n----\nNew commits:",
    "created_at": "2014-09-20T00:10:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190928",
    "user": "@nbruin"
}
```

*PING* I got bitten by this issue once again, so I adapted the patch here as a branch. Can we review and incorporate this change?
----
New commits:



---

archive/issue_comments_190929.json:
```json
{
    "body": "You comment\n\n```\n+ #this is a rather expensive way of getting the line number, because\n+ #retrieving the source requires reading the source file and in many\n+ #cases this is not required (in cython it's embedded in the docstring,\n+ #on code objects you'll find it in co_filename and co_firstlineno)\n+ #however, this hasn't been factored out yet in sageinspect\n+ #and the logic in sage_getsourcelines is rather intricate.\n```\n\nI didn't check the code yet, but I think I remember that this was improved. But if I am mistaken, we could fix it here, right?",
    "created_at": "2014-09-21T10:06:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190929",
    "user": "@simon-king-jena"
}
```

You comment

```
+ #this is a rather expensive way of getting the line number, because
+ #retrieving the source requires reading the source file and in many
+ #cases this is not required (in cython it's embedded in the docstring,
+ #on code objects you'll find it in co_filename and co_firstlineno)
+ #however, this hasn't been factored out yet in sageinspect
+ #and the logic in sage_getsourcelines is rather intricate.
```

I didn't check the code yet, but I think I remember that this was improved. But if I am mistaken, we could fix it here, right?



---

archive/issue_comments_190930.json:
```json
{
    "body": "Moreover, you will notice that you call `sage_getsourclines` twice. So, instead of doing\n\n```\n+ _, lineno = sage_getsourcelines(f)\n+ file_info = \"File: %s (starting at line %d)\\n\"%(filename,lineno)\n```\n\nyou should do\n\n```\n+ file_info = \"File: %s (starting at line %d)\\n\"%(filename,sourcelines[1])\n```\n",
    "created_at": "2014-09-21T10:09:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190930",
    "user": "@simon-king-jena"
}
```

Moreover, you will notice that you call `sage_getsourclines` twice. So, instead of doing

```
+ _, lineno = sage_getsourcelines(f)
+ file_info = "File: %s (starting at line %d)\n"%(filename,lineno)
```

you should do

```
+ file_info = "File: %s (starting at line %d)\n"%(filename,sourcelines[1])
```




---

archive/issue_comments_190931.json:
```json
{
    "body": "I just pushed an additional commit, hopefully improving the code a little bit. Strange that the commit cannot be seen yet. `git trac push` told me\n\n```\nPushing to Trac #15184...\nGuessed remote branch: u/SimonKing/ticket/15184\nEnter passphrase for key '/home/king/.ssh/id_rsa': \n\nTo git@trac.sagemath.org:sage.git\n * [new branch]      HEAD -> u/SimonKing/ticket/15184\n\nChanging the trac \"Branch:\" field...\n```\n\nbut apparently it did *not* change the branch field.",
    "created_at": "2014-09-21T11:04:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190931",
    "user": "@simon-king-jena"
}
```

I just pushed an additional commit, hopefully improving the code a little bit. Strange that the commit cannot be seen yet. `git trac push` told me

```
Pushing to Trac #15184...
Guessed remote branch: u/SimonKing/ticket/15184
Enter passphrase for key '/home/king/.ssh/id_rsa': 

To git@trac.sagemath.org:sage.git
 * [new branch]      HEAD -> u/SimonKing/ticket/15184

Changing the trac "Branch:" field...
```

but apparently it did *not* change the branch field.



---

archive/issue_comments_190932.json:
```json
{
    "body": "Doing the change manually...\n\nI think it is a clear improvement. I am waiting for the test suite, to be on the safe side.\n\nDo you agree with my review commit? Do you think the co_filename and co_firstlineno thingy should be taken care of here, or elsewhere?",
    "created_at": "2014-09-21T11:07:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190932",
    "user": "@simon-king-jena"
}
```

Doing the change manually...

I think it is a clear improvement. I am waiting for the test suite, to be on the safe side.

Do you agree with my review commit? Do you think the co_filename and co_firstlineno thingy should be taken care of here, or elsewhere?



---

archive/issue_comments_190933.json:
```json
{
    "body": "Replying to [comment:19 SimonKing]:\n> Do you agree with my review commit?\nYes\n\n> Do you think the co_filename and co_firstlineno thingy should be taken care of here, or elsewhere?\nYes\n\n(positive review is OK with me)",
    "created_at": "2014-09-21T16:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190933",
    "user": "@nbruin"
}
```

Replying to [comment:19 SimonKing]:
> Do you agree with my review commit?
Yes

> Do you think the co_filename and co_firstlineno thingy should be taken care of here, or elsewhere?
Yes

(positive review is OK with me)



---

archive/issue_comments_190934.json:
```json
{
    "body": "All tests pass for me, you accept my review patch. So, I'd say it is a positive review.\n\nPlease check if I spelled your name correctly. And Volker will hopefully be able to explain why the patchbot reports a failure...",
    "created_at": "2014-09-22T04:55:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190934",
    "user": "@simon-king-jena"
}
```

All tests pass for me, you accept my review patch. So, I'd say it is a positive review.

Please check if I spelled your name correctly. And Volker will hopefully be able to explain why the patchbot reports a failure...



---

archive/issue_comments_190935.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-09-22T04:55:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190935",
    "user": "@simon-king-jena"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_190936.json:
```json
{
    "body": "For the buildbot failure, from looking at the log there are tests which fail in\n\n```\nsage -t src/sage/modular/modform/numerical.py  # 2 doctests failed\nsage -t src/sage/rings/polynomial/polynomial_element.pyx  # 2 doctests failed\nsage -t src/sage/rings/real_double.pyx  # 2 doctests failed\n```\n\ndue to the results falling outside of the tolerance (so should not be affected by this ticket, plus I only use the buildbot/patchbot as possible failures, i.e. it can give false negatives).\n\nAlso please forgive my nitpicking, but would you be willing to change\n\n```\n        test that #15184 is fixed::\n```\n\ninto\n\n```\n        Test that :trac:`15184` is fixed::\n```\n",
    "created_at": "2014-09-22T06:11:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190936",
    "user": "@tscrim"
}
```

For the buildbot failure, from looking at the log there are tests which fail in

```
sage -t src/sage/modular/modform/numerical.py  # 2 doctests failed
sage -t src/sage/rings/polynomial/polynomial_element.pyx  # 2 doctests failed
sage -t src/sage/rings/real_double.pyx  # 2 doctests failed
```

due to the results falling outside of the tolerance (so should not be affected by this ticket, plus I only use the buildbot/patchbot as possible failures, i.e. it can give false negatives).

Also please forgive my nitpicking, but would you be willing to change

```
        test that #15184 is fixed::
```

into

```
        Test that :trac:`15184` is fixed::
```




---

archive/issue_comments_190937.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2014-09-22T09:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190937",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_190938.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2014-09-22T09:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190938",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_190939.json:
```json
{
    "body": "Replying to [comment:22 tscrim]:\n> Also please forgive my nitpicking, but would you be willing to change\n> {{{\n>         test that #15184 is fixed::\n> }}}\n> into\n> {{{\n>         Test that :trac:`15184` is fixed::\n> }}}\n\nDone.",
    "created_at": "2014-09-22T09:53:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190939",
    "user": "@simon-king-jena"
}
```

Replying to [comment:22 tscrim]:
> Also please forgive my nitpicking, but would you be willing to change
> {{{
>         test that #15184 is fixed::
> }}}
> into
> {{{
>         Test that :trac:`15184` is fixed::
> }}}

Done.



---

archive/issue_comments_190940.json:
```json
{
    "body": "Thanks!",
    "created_at": "2014-09-22T15:18:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190940",
    "user": "@tscrim"
}
```

Thanks!



---

archive/issue_comments_190941.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-09-22T15:18:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190941",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_190942.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-09-25T12:05:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14947",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14947#issuecomment-190942",
    "user": "@vbraun"
}
```

Resolution: fixed
