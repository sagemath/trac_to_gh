# Issue 21842: Arb NaN infinite loop

Issue created by migration from Trac.

Original creator: rws

Original creation time: 2016-12-19 16:36:36

CC:  vdelecroix mmezzarobba


```
sage: RealBallField(NaN)
...
TypeError: maximum recursion depth exceeded while calling a Python object
```



---

Comment by jdemeyer created at 2016-12-19 19:17:45

This had nothing to do with arb. The problem is the conversion `NaN` -> Python `int`.


---

Comment by mmezzarobba created at 2016-12-19 19:58:01

Will hopefully be fixed by the rewrite in progress at #12121.


---

Comment by jdemeyer created at 2017-09-04 12:26:39

Replying to [comment:7 mmezzarobba]:
> Will hopefully be fixed by the rewrite in progress at #12121.

... which is still not fixed.

I just got hit by this again. Do you have any objections to just remove the "infinite loop" block from `ceil()` and `floor()`?


---

Comment by mmezzarobba created at 2017-09-04 14:06:05

Replying to [comment:8 jdemeyer]:
> I just got hit by this again. Do you have any objections to just remove the "infinite loop" block from `ceil()` and `floor()`?

I don't, but maybe you should ask Vincent. (I just rebased his code from #12121 to see how far we are from a solution there, more news on that hopefully after I run the tests!)


---

Comment by jdemeyer created at 2017-09-04 14:14:59

I am also working on a proper solution both for this ticket and for #12121. Hang on...


---

Comment by mmezzarobba created at 2017-09-04 14:22:31

Replying to [comment:10 jdemeyer]:
> I am also working on a proper solution both for this ticket and for #12121. Hang on...

Ok. I pushed the rebased branch (builds, not tested) to `u/mmezzarobba/ticket/12121-rebased` just in case.


---

Comment by jdemeyer created at 2017-09-04 15:04:07

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-09-04 15:04:07

New commits:


---

Comment by jdemeyer created at 2017-09-05 07:57:58

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-09-05 08:40:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-09-05 08:45:58

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-09-05 11:50:58

This passes tests on the patchbot.


---

Comment by vdelecroix created at 2017-09-05 21:46:29

How is this different from the function `incremental_rounding` of #12121 (that proposes a useful `maximum_bits` argument)!? It would be definitely more coherent to work on only one ticket...

I just stopped working on #12121 because of the unreliable equality tests of the symbolic ring. Did you know that pi was a rational number

```
sage: n = continued_fraction(pi).convergent(20)
sage: num = n.numerator()
sage: den = n.denominator()
sage: print bool(den*pi == num)
```



---

Comment by rws created at 2017-09-06 04:40:36

Have you opened a bug ticket?


---

Comment by jdemeyer created at 2017-09-06 07:40:59

Replying to [comment:21 vdelecroix]:
> It would be definitely more coherent to work on only one ticket...

Right. It was not really my intention to start a "competing" implementation. I initially intented to do a simple fix but then realized that a simple fix wasn't possible. So I continue working on my initially-simple fix until I ended up with this.


---

Comment by jdemeyer created at 2017-09-06 07:42:05

Replying to [comment:21 vdelecroix]:
> I just stopped working on #12121 because of the unreliable equality tests of the symbolic ring.

My branch doesn't require equality tests in the symbolic ring.


---

Comment by jdemeyer created at 2017-09-06 07:56:27

Replying to [comment:21 vdelecroix]:
> that proposes a useful `maximum_bits` argument

Right, I do see the point of that.


---

Comment by git created at 2017-09-19 11:16:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-09-19 11:25:24

Now with a `bits` argument (easier to type and less confusing than `maximum_bits`)

Sorry for duplicating part of #12121. I did not intend to do that, it just ended up that way. Anyway, this ticket here fixes real problems so please consider it for review.


---

Comment by vdelecroix created at 2017-09-19 12:11:44

typo `the taregt number`


---

Comment by vdelecroix created at 2017-09-19 12:19:26

About

```
if isinstance(x, (float, complex)):
    m = getattr(math, method)
    return Integer(m(x))
```

Two questions:

- with complex inputs, the `math` library gives an error

```
sage: 
sage: math.floor(0jr)
Traceback (most recent call last):
...
TypeError: can't convert complex to float
sage: math.ceil(0jr)
Traceback (most recent call last):
...
TypeError: can't convert complex to float
```

   hence there is a bit of contradiction here.

- why would you convert to an `Integer` and not just use the result of whatever `math.floor`, `math.ceil` is actually giving you. That would be more Python friendly. As an example the result of `cos` is not a Sage floating point

```
sage: cos(1.0r)
0.5403023058681398
sage: type(_)
<type 'float'>
```



---

Comment by jdemeyer created at 2017-09-19 12:24:21

You may or may not be right, but I consider that outside the scope of this ticket. I am not changing the return types or handling of complex numbers here.


---

Comment by git created at 2017-09-19 13:02:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by rws created at 2017-11-28 07:11:56

Does not apply.


---

Comment by rws created at 2017-11-28 07:11:56

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-11-28 08:30:16

Do you plan to review this ticket if I fix the conflict?


---

Comment by rws created at 2017-11-28 09:04:14

Yes. It's time to get that done.


---

Comment by git created at 2017-11-28 09:24:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-11-28 09:35:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-11-28 09:35:36

Changing status from needs_work to needs_review.


---

Comment by rws created at 2017-11-28 15:21:27

Patchbot is green, the documentation looks good. The code is well documented and improves the present implementation. This all represents my minimum criterion to include code in Sage. There are a few things I'd ask you to change/add:
 - there is one typo (`immediatly`)
 - the ticket makes #12121 mostly a duplicate, and it would be nice if you could add the most relevant doctests from there, I'd suggest

```
sage: floor(log(4) / log(2))
2
sage: a = floor(5.4 + x); a
floor(x + 5.40000000000000)
sage: a.subs(x==2)
7
sage: floor(log(2**(3/2)) / log(2) + 1/2)
2
sage: floor(log(2**(-3/2)) / log(2) + 1/2)
-1
sage: e1 = pi - continued_fraction(pi).convergent(2785)
sage: e2 = e - continued_fraction(e).convergent(1500)
sage: f = e1/e2
sage: f = 1 / (f - continued_fraction(f).convergent(1000))
sage: f = f - continued_fraction(f).convergent(1)
sage: floor(f, bits=40000)
-1
sage: ceil(f, bits=40000)
0
```

You can set positive after the above changes. If you don't agree with my above criterion however then don't.

Finally for a later ticket, one doctest from #12121 cannot be solved. I agree not everything can be solved. This one however would be easy if you had some heuristic to call QQbar on algebraic expressions:

```
sage: z = (11/9*sqrt(3)*sqrt(2) + 3)^(1/3) + 1/3/(11/9*sqrt(3)*sqrt(2) + 3)^(1/3) - 1
sage: ceil(z, bits=400000)
...fails
```

This is still better than current Sage so we should think of a way to limit or predict the effort QQbar is making, e.g. by predicting the degree of the minimal polynomial involved and calling QQbar from `floor()` when it does not take forever.


---

Comment by git created at 2017-11-29 15:46:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-11-29 15:47:11

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-12-02 23:38:05

conflicts with #22024


---

Comment by vbraun created at 2017-12-02 23:38:05

Changing status from positive_review to needs_work.


---

Comment by rws created at 2017-12-03 15:54:48

Changing status from needs_work to positive_review.


---

Comment by rws created at 2017-12-03 15:54:48

New commits:


---

Comment by vbraun created at 2017-12-11 01:04:00

Resolution: fixed
