# Issue 23496: Get rid of src/bin/sage-arch-env, SAGE_LOCAL/etc/sage-64.txt

Issue created by migration from Trac.

Original creator: mkoeppe

Original creation time: 2017-08-28 03:25:44

CC:  dimpase

I propose to get rid of src/bin/sage-arch-env, SAGE_LOCAL/etc/sage-64.txt, 
which is a very specialized mechanism of storing a bit of configuration in SAGE_LOCAL.
Instead, SAGE64 should become a configure option (see #23570).


---

Comment by jdemeyer created at 2017-08-28 10:40:51

Replying to [ticket:23733 mkoeppe]:
> Instead, SAGE64 should become a configure option (see #23570).

Is anybody actually using that option? I would go for deprecating it and getting rid of it eventually.


---

Comment by mkoeppe created at 2017-08-29 18:06:32

Replying to [comment:1 jdemeyer]:
> Is anybody actually using that option? I would go for deprecating it and getting rid of it eventually.

Good idea. Should as well get rid of it in the installation manual eventually (it mentions some ancient Mac OS versions, for which probably no working build infrastructure exists any more anyway).


---

Comment by jhpalmieri created at 2017-09-01 22:37:47

I added two deprecation warnings: once at the beginning and once at the end of the file `build/make/install`: at the beginning so that it appears near the start and is there if someone interrupts the build with ctrl-C, and at the end so that it is clearly displayed. (If I put it in `sage-arch-env` instead, it gets buried with all of the other build messages.) I tested with `SAGE64=yes make`.

I asked on sage-devel whether anyone is using this. Let's wait a bit for responses.
----
New commits:


---

Comment by jhpalmieri created at 2017-09-02 20:52:08

From the few responses on sage-devel so far, I think that SAGE64 is only useful on Solaris. Do we keep the variable? (Do we keep "supporting" Solaris?) Can it be merged into some configure option, in which the system type is detected and `-m64` is added to the appropriate flags automatically?


---

Comment by drkirkby created at 2017-09-11 13:54:37

I don't believe that SAGE64 only adds -m64, as if that had been the case, there are obviously easier ways to do it. Adding -m64 is the case in some packages, but not all of them. 

Dave


---

Comment by dimpase created at 2018-01-26 14:59:44

We now have access to a SPARC T4 running Solaris 11, things don't look too bad for Solaris at the moment. I've opened #24596 to track this.


---

Comment by jdemeyer created at 2018-01-30 14:39:25

New commits:


---

Comment by git created at 2018-01-30 18:53:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-01-31 06:33:50

Changing status from new to needs_review.


---

Comment by dimpase created at 2018-01-31 12:59:51

Do we need ABI=64 set on Solaris 64-bit, or not?


---

Comment by jdemeyer created at 2018-01-31 13:41:21

Replying to [comment:14 dimpase]:
> Do we need ABI=64 set on Solaris 64-bit, or not?

No idea. So far I have _not_ been setting it and it seems to work like that.


---

Comment by mkoeppe created at 2018-02-03 20:41:58

(Disclaimer: Last time I used Solaris was 10 years ago.)  The only time that I remember using the ABI environment variable was for configuring GMP if one wants to do a 32-bit build on 64-bit hardware - a quirk of GMP's configuration scripts. I don't think it's a standard variable at all.


---

Comment by dimpase created at 2018-02-03 23:06:00

A proper way to do this is to allow something like `--abi=32/64` (or `ABI=32/64`) to `./configure`, and
not doing dodgy and error-prone setting of  `CFLAGS`, `CXXFLAGS`, `FCFLAGS`, `FFLAGS`, `LDFLAGS`, etc etc
to take `-m64/32`.

In particular, ABI and `-m64` should persist, i.e. written by `./configure` to the Makefile or something like this.


---

Comment by dimpase created at 2018-02-03 23:26:15

As well, numpy's (and all the other packages that like to test stuff without `CFLAGS` etc set to non-empty values) spkg-install will break, as `-m64` won't be passed. 
The current version of this spkg-install modifies `CC` to include the flag.

We cannot and should not modify `CC` globally to have flags in them, as there might be places where `CC` is assumed not to have spaces (GAP is one such place, I think).


---

Comment by dimpase created at 2018-02-03 23:28:21

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-02-04 12:14:18

Replying to [comment:18 dimpase]:
> dodgy and error-prone setting of  `CFLAGS`, `CXXFLAGS`, `FCFLAGS`, `FFLAGS`, `LDFLAGS`, etc etc to take `-m64/32`.

These are very standard flags. Setting them is a normal thing.


---

Comment by jdemeyer created at 2018-02-04 12:15:29

Replying to [comment:18 dimpase]:
> A proper way to do this is to allow something like `--abi=32/64` (or `ABI=32/64`) to `./configure`
> 
> In particular, ABI and `-m64` should persist, i.e. written by `./configure` to the Makefile or something like this.

Of course. But adding `./configure` options is outside the scope of this ticket. This ticket is about removing something which is unmaintained and almost certainly broken.


---

Comment by jdemeyer created at 2018-02-04 12:15:29

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-02-04 12:28:36

Replying to [comment:19 dimpase]:
> As well, numpy's (and all the other packages that like to test stuff without `CFLAGS` etc set to non-empty values) spkg-install will break, as `-m64` won't be passed. 
> The current version of this spkg-install modifies `CC` to include the flag.
> 
> We cannot and should not modify `CC` globally to have flags in them, as there might be places where `CC` is assumed not to have spaces (GAP is one such place, I think).  

I would argue that it's simply better to build/use a GCC version which has the correct flags _by default_.


---

Comment by dimpase created at 2018-02-04 12:44:29

this patch makes it impossible to build Sage in one go. I  have already explained why, cause you cannot set CC to `gcc -m64` as this will break GAP, but otherwise you will break numpy...


---

Comment by jdemeyer created at 2018-02-04 13:36:31

Replying to [comment:24 dimpase]:
> this patch makes it impossible to build Sage in one go.

First of all, I don't know what you mean with "build Sage in one go".

Second, regardless of what you mean: is it a regression? Suppose that the following are true:

(A) It is impossible to build Sage in one go _without_ this patch.

(B) It is impossible to build Sage in one go _with_ this patch.

In these are both true (since I don't know what you mean, I can't say whether that is the case), then your complaint is not meaningful.


---

Comment by dimpase created at 2018-02-04 15:50:45

I am saying that with this patch on a platform that needs SAGE64 set one will not be able to get Sage built by running configure+make.


The build will break, at some point you will need to build individual packages with adjusted flags.


---

Comment by jdemeyer created at 2018-02-05 07:58:41

Replying to [comment:26 dimpase]:
> I am saying that with this patch on a platform that needs SAGE64 set one will not be able to get Sage built by running configure+make.

OK. I am saying that *without this patch* on a platform that needs `SAGE64` set one will not be able to get Sage built by running configure+make. So, this patch doesn't break anything that wasn't already broken before.


---

Comment by dimpase created at 2018-02-05 08:02:11

I am saying that it breaks more than it fixes, e.g. it removes all the traces of the fact that numpy needs a special treatment.


---

Comment by git created at 2018-02-05 08:19:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2018-02-05 08:19:23

OK fine. I've kept the special-casing for numpy.


---

Comment by dimpase created at 2018-02-05 10:59:48

In Atlas configuration you did the following:

```
-conf['32bit?'] = not conf['64bit?']
+conf['64bit?'] = (conf['bits'] == '64bit')
+conf['32bit?'] = (conf['bits'] == '32bit')
```

This is a different logic for `conf['32bit?']` vs. the originally intended one.
By right, you should have just done

```
+conf['64bit?'] = (conf['bits'] == '64bit')
conf['32bit?'] = not conf['64bit?']
...

```



---

Comment by git created at 2018-02-05 11:03:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2018-02-05 11:03:37

This reverts the ATLAS logic.


---

Comment by dimpase created at 2018-02-05 11:07:30

What does this patch do to CFLAG64? (which is a documented Sage variable after all).

It's not clear. The ticket description does not mention it, but in several places
you remove special-casing for it.


---

Comment by git created at 2018-02-06 11:40:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-02-06 16:15:47

Replying to [comment:18 dimpase]:
> A proper way to do this is to allow something like `--abi=32/64` (or `ABI=32/64`) to `./configure`

I created #24672 for that.


---

Comment by embray created at 2018-03-28 10:01:42

Since the work I'm doing in #24024 will likely conflict heavily with this, I'm trying to remove SAGE64 support from individual packages as I go.  So that work can basically merged with this.  I'll try to pay attention to what changes this is making to the relevant packages.

Alternatively we merge this now, and I rebase everything on top of this.


---

Comment by embray created at 2018-03-28 10:25:31

Also, if you would prefer to just do the latter, then positive review from me.


---

Comment by dimpase created at 2018-03-28 11:11:37

I suppose this needs a bit more testing. Should we try to put together a new branch for Solaris and try this out there?


---

Comment by git created at 2018-03-29 12:34:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-03-29 12:35:00

Replying to [comment:41 dimpase]:
> I suppose this needs a bit more testing. Should we try to put together a new branch for Solaris and try this out there?

Fine, I just rebased it to 8.2.rc0.


---

Comment by dimpase created at 2018-03-31 19:42:50

OK, this works on 64-bit SPARC Solaris.


---

Comment by dimpase created at 2018-03-31 19:42:50

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-04-04 08:02:26

Just as a note, this will currently conflict with most of the tickets listed under

[This is the Trac macro *TicketQuery* that was inherited from the migration called with arguments (keywords~=destdir))](https://trac.sagemath.org/wiki/WikiMacros#TicketQuery-macro)

However, I will merge this branch into those tickets and add this ticket as a dependency.  This one should definitely be merged first though.


---

Comment by vbraun created at 2018-05-08 17:27:12

Resolution: fixed
