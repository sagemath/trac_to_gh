# Issue 17307: Use single-underscore methods in MatrixMorphism_abstract

Issue created by migration from Trac.

Original creator: pbruin

Original creation time: 2014-12-23 17:38:03

CC:  jpflori simonking

Keywords: matrix

After moving modules to the new coercion model (#10513), we should make `sage.modules.matrix_morphism.MatrixMorphism_abstract` use single-underscore methods for addition, subtraction, scalar multiplication and composition. 


---

Comment by SimonKing created at 2014-12-23 18:22:54

Note that at some point I tried to make morphisms use the coercion model with single-underscore methods. It miserably failed, because of a subtle P/Cython bug: If one creates a Python class that inherits from both `ModuleElement` and `Map`, then some cdef attributes of `Map` get confused with some cdef attributes of `ModuleElement`, even though P/Cython accepts the definition of the sub-class.


---

Comment by pbruin created at 2014-12-23 20:51:28

Replying to [comment:1 SimonKing]:
> Note that at some point I tried to make morphisms use the coercion model with single-underscore methods. It miserably failed, because of a subtle P/Cython bug: If one creates a Python class that inherits from both `ModuleElement` and `Map`, then some cdef attributes of `Map` get confused with some cdef attributes of `ModuleElement`, even though P/Cython accepts the definition of the sub-class.
I see, it only makes sense to implement single-underscore methods once we are able to inherit from `ModuleElement` as well as from `Map`.  So I guess that means that this ticket has to wait until Cython supports multiple inheritance?


---

Comment by tscrim created at 2014-12-23 21:03:06

The other (temporary) options are to construct a class `ModuleElementMorphism` which copies the necessary code or to write a wrapper `Morphism` class that just redirects to some underlying matrix. I think the former is a better approach until cython does multiple inheritance (which I don't think will happen anytime soon, perhaps even at all?) as it can be applied and subclassed to things like `AlgebraElementMorphism` (for things like the endomorphism ring).


---

Comment by SimonKing created at 2014-12-23 23:40:40

Replying to [comment:3 tscrim]:
> I think the former is a better approach until cython does multiple inheritance (which I don't think will happen anytime soon, perhaps even at all?)...

Note that I did not talk about a cdef class with two base classes. I am talking about one Python class inheriting from two cdef base classes, which are considered to have compatible layout, but still things get wrong.

I just tried to reconstruct the example, but it seemingly just worked. So, perhaps the problem is actually solved one way or the other. If I recall correctly, the problematic cdef attributes included domain or codomain---which has now changed, because of weak referencing. Perhaps this change has not only fixed a memory leak, but has also worked around the c layout problem.
