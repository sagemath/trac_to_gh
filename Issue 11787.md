# Issue 11787: build spkgs in parallel by default

archive/issues_011787.json:
```json
{
    "body": "Assignee: GeorgSWeber\n\nCC:  leif kcrisman\n\nThe patches on this ticket remove the environment variable `SAGE_PARALLEL_SPKG_BUILD` and turn parallel spkg building on always.  Of course this only has an effect if `MAKE` is set to, for example, \"make -j16\".\n\nThis change was discussed in [sage-devel](https://groups.google.com/d/topic/sage-devel/FW5sP5NPeLs/discussion).\n\nIssue created by migration from https://trac.sagemath.org/ticket/11959\n\n",
    "created_at": "2011-10-27T22:29:00Z",
    "labels": [
        "build",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.8",
    "title": "build spkgs in parallel by default",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11787",
    "user": "jhpalmieri"
}
```
Assignee: GeorgSWeber

CC:  leif kcrisman

The patches on this ticket remove the environment variable `SAGE_PARALLEL_SPKG_BUILD` and turn parallel spkg building on always.  Of course this only has an effect if `MAKE` is set to, for example, "make -j16".

This change was discussed in [sage-devel](https://groups.google.com/d/topic/sage-devel/FW5sP5NPeLs/discussion).

Issue created by migration from https://trac.sagemath.org/ticket/11959





---

archive/issue_comments_134602.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-10-27T22:31:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134602",
    "user": "jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_134603.json:
```json
{
    "body": "Changing keywords from \"\" to \"SAGE_PARALLEL_SPKG_BUILD MAKE -j --jobs\".",
    "created_at": "2011-10-27T22:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134603",
    "user": "leif"
}
```

Changing keywords from "" to "SAGE_PARALLEL_SPKG_BUILD MAKE -j --jobs".



---

archive/issue_comments_134604.json:
```json
{
    "body": "Objections to renaming the ticket to *\"Remove the necessity to set SAGE_PARALLEL_SPKG_BUILD\"*? (It's yours, so I didn't change its title. ;-) )",
    "created_at": "2011-10-27T22:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134604",
    "user": "leif"
}
```

Objections to renaming the ticket to *"Remove the necessity to set SAGE_PARALLEL_SPKG_BUILD"*? (It's yours, so I didn't change its title. ;-) )



---

archive/issue_comments_134605.json:
```json
{
    "body": "John, you confused the names of the patches. :)",
    "created_at": "2011-10-27T22:41:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134605",
    "user": "leif"
}
```

John, you confused the names of the patches. :)



---

archive/issue_comments_134606.json:
```json
{
    "body": "My alternate patch to `$SAGE_ROOT/spkg/install` has become a bit longer:\n\n\n```diff\n\ndiff --git a/spkg/install b/spkg/install\n--- a/spkg/install\n+++ b/spkg/install\n@@ -430,12 +430,10 @@\n \n \n # Skip the rest if nothing to do (i.e., to [re]build):\n-# Note that we should use $MAKE here, but we currently don't use\n-# it further below either unless SAGE_PARALLEL_SPKG_BUILD=yes, which\n-# I consider a \"bug\". -- Leif Leonhardy\n-# If \"make\" doesn't understand the -q option, it should exit with a\n-# non-zero status which is not a problem.\n-if make -q -f standard/deps $1; then\n+# If \"make\" doesn't understand the -q option (although we require\n+# GNU make, which supports it), it should exit with a non-zero status\n+# which is not a problem.\n+if ${MAKE:-make} -q -f standard/deps $1; then\n     echo \"Nothing to (re)build / all up-to-date.\"\n     exit 0\n fi\n@@ -443,48 +441,57 @@\n \n # Dump environment for debugging purposes:\n echo \"*** ALL ENVIRONMENT VARIABLES BEFORE BUILD: ***\"\n-env\n+env | sort\n echo \"***********************************************\"\n \n \n ###############################################################################\n # NOW do the actual build:\n ###############################################################################\n-if [ \"$SAGE_PARALLEL_SPKG_BUILD\" = \"yes\" ] && [ -n \"$MAKE\" ]; then\n-    time $MAKE -f standard/deps $1\n-else\n-    time make -f standard/deps $1\n-fi\n+time ${MAKE:-make} -f standard/deps $1\n \n-# added by Burcin Erocal, see trac #6295.\n+# Added by Burcin Erocal, see trac #6295:\n if [ $? -ne 0 ]; then\n-    echo \"Error building Sage.\"\n+    echo >&2 \"Error building Sage.\"\n     exit 1\n fi\n \n+# Rename makefile to Makefile (see #10156):\n cd \"$SAGE_ROOT\"\n-\n-# Rename makefile to Makefile (see #10156)\n if [ -f makefile ]; then\n-    mv makefile Makefile\n-    if [ $? -ne 0 ]; then\n-        echo \"Error renaming 'makefile' to 'Makefile'.\"\n-        exit 1\n+    if [ ! -f Makefile ]; then\n+        if ! mv makefile Makefile; then\n+            echo >&2 \"Error renaming 'makefile' to 'Makefile'.\"\n+            exit 1\n+        fi\n+    else\n+        # Both 'makefile' and 'Makefile' exist.\n+        echo >&2 \"Warning: Deleting old 'makefile'; 'Makefile' remains.\"\n+        if ! rm -f makefile; then\n+            echo >&2 \"Error deleting old 'makefile'.\"\n+            exit 1\n+        fi\n     fi\n fi\n \n-# build succeeded\n-if [ \"$1\" = \"all\" ]; then\n-    echo \"To install gap, gp, singular, etc., scripts\"\n-    echo \"in a standard bin directory, start sage and\"\n-    echo \"type something like\"\n-    echo \"   sage: install_scripts('/usr/local/bin')\"\n-    echo \"at the Sage command prompt.\"\n-    echo \"\"\n-    echo \"To build the documentation, run\"\n-    echo \"   make doc\"\n-    echo \"\"\n-fi\n-\n+# Build succeeded.\n echo \"Sage build/upgrade complete!\"\n \n+if [ \"$1\" = \"all\" ]; then\n+    echo\n+    echo \"To install small scripts to directly run Sage's versions of GAP,\"\n+    echo \"the PARI/GP interpreter, Maxima, or Singular etc. (by typing e.g.\"\n+    echo \"just 'gap' or 'gp') into a standard 'bin' directory, start Sage\"\n+    echo \"by typing 'sage' (or './sage') and enter something like\"\n+    echo\n+    echo \"    install_scripts('/usr/local/bin')\"\n+    echo\n+    echo \"at the Sage command prompt ('sage:').\"\n+    echo\n+    echo \"To (re)build the HTML documentation, run 'make doc' (if you haven't\"\n+    echo \"issued 'make' but just 'make build' or e.g. 'sage --upgrade'; other-\"\n+    echo \"wise it will be built automatically right now).\"\n+    echo\n+    echo \"To build the PDF version of the documentation, run 'make doc-pdf'.\"\n+    echo\n+fi\n```\n",
    "created_at": "2011-10-27T23:40:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134606",
    "user": "leif"
}
```

My alternate patch to `$SAGE_ROOT/spkg/install` has become a bit longer:


```diff

diff --git a/spkg/install b/spkg/install
--- a/spkg/install
+++ b/spkg/install
@@ -430,12 +430,10 @@
 
 
 # Skip the rest if nothing to do (i.e., to [re]build):
-# Note that we should use $MAKE here, but we currently don't use
-# it further below either unless SAGE_PARALLEL_SPKG_BUILD=yes, which
-# I consider a "bug". -- Leif Leonhardy
-# If "make" doesn't understand the -q option, it should exit with a
-# non-zero status which is not a problem.
-if make -q -f standard/deps $1; then
+# If "make" doesn't understand the -q option (although we require
+# GNU make, which supports it), it should exit with a non-zero status
+# which is not a problem.
+if ${MAKE:-make} -q -f standard/deps $1; then
     echo "Nothing to (re)build / all up-to-date."
     exit 0
 fi
@@ -443,48 +441,57 @@
 
 # Dump environment for debugging purposes:
 echo "*** ALL ENVIRONMENT VARIABLES BEFORE BUILD: ***"
-env
+env | sort
 echo "***********************************************"
 
 
 ###############################################################################
 # NOW do the actual build:
 ###############################################################################
-if [ "$SAGE_PARALLEL_SPKG_BUILD" = "yes" ] && [ -n "$MAKE" ]; then
-    time $MAKE -f standard/deps $1
-else
-    time make -f standard/deps $1
-fi
+time ${MAKE:-make} -f standard/deps $1
 
-# added by Burcin Erocal, see trac #6295.
+# Added by Burcin Erocal, see trac #6295:
 if [ $? -ne 0 ]; then
-    echo "Error building Sage."
+    echo >&2 "Error building Sage."
     exit 1
 fi
 
+# Rename makefile to Makefile (see #10156):
 cd "$SAGE_ROOT"
-
-# Rename makefile to Makefile (see #10156)
 if [ -f makefile ]; then
-    mv makefile Makefile
-    if [ $? -ne 0 ]; then
-        echo "Error renaming 'makefile' to 'Makefile'."
-        exit 1
+    if [ ! -f Makefile ]; then
+        if ! mv makefile Makefile; then
+            echo >&2 "Error renaming 'makefile' to 'Makefile'."
+            exit 1
+        fi
+    else
+        # Both 'makefile' and 'Makefile' exist.
+        echo >&2 "Warning: Deleting old 'makefile'; 'Makefile' remains."
+        if ! rm -f makefile; then
+            echo >&2 "Error deleting old 'makefile'."
+            exit 1
+        fi
     fi
 fi
 
-# build succeeded
-if [ "$1" = "all" ]; then
-    echo "To install gap, gp, singular, etc., scripts"
-    echo "in a standard bin directory, start sage and"
-    echo "type something like"
-    echo "   sage: install_scripts('/usr/local/bin')"
-    echo "at the Sage command prompt."
-    echo ""
-    echo "To build the documentation, run"
-    echo "   make doc"
-    echo ""
-fi
-
+# Build succeeded.
 echo "Sage build/upgrade complete!"
 
+if [ "$1" = "all" ]; then
+    echo
+    echo "To install small scripts to directly run Sage's versions of GAP,"
+    echo "the PARI/GP interpreter, Maxima, or Singular etc. (by typing e.g."
+    echo "just 'gap' or 'gp') into a standard 'bin' directory, start Sage"
+    echo "by typing 'sage' (or './sage') and enter something like"
+    echo
+    echo "    install_scripts('/usr/local/bin')"
+    echo
+    echo "at the Sage command prompt ('sage:')."
+    echo
+    echo "To (re)build the HTML documentation, run 'make doc' (if you haven't"
+    echo "issued 'make' but just 'make build' or e.g. 'sage --upgrade'; other-"
+    echo "wise it will be built automatically right now)."
+    echo
+    echo "To build the PDF version of the documentation, run 'make doc-pdf'."
+    echo
+fi
```




---

archive/issue_comments_134607.json:
```json
{
    "body": "W.r.t. `README.txt`:\n\nI'd quote `make` (`'make'`), and directly refer to the GNU make (online) manual, i.e., its *Options summary* section (which IMHO explains `-j` and `-l` etc. quite good):\n\n [http://www.gnu.org/software/make/manual/make.html#Options-Summary](http://www.gnu.org/software/make/manual/make.html#Options-Summary)\n\n`s/`*so for example if you set*`/`*so for example if you do*`/` (or *... type*)\n\nPerhaps also add that it's usually ok (or advantageous) to use more jobs than the machine has CPU cores (minus already running processes, or the current system load), especially if disk access isn't very fast [provided the machine isn't low of available memory or actually RAM].",
    "created_at": "2011-10-28T00:21:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134607",
    "user": "leif"
}
```

W.r.t. `README.txt`:

I'd quote `make` (`'make'`), and directly refer to the GNU make (online) manual, i.e., its *Options summary* section (which IMHO explains `-j` and `-l` etc. quite good):

 [http://www.gnu.org/software/make/manual/make.html#Options-Summary](http://www.gnu.org/software/make/manual/make.html#Options-Summary)

`s/`*so for example if you set*`/`*so for example if you do*`/` (or *... type*)

Perhaps also add that it's usually ok (or advantageous) to use more jobs than the machine has CPU cores (minus already running processes, or the current system load), especially if disk access isn't very fast [provided the machine isn't low of available memory or actually RAM].



---

archive/issue_comments_134608.json:
```json
{
    "body": "W.r.t. the Sage Installation Guide:\n\n`export MAKE='make -jNUM'` is not *\"a common setting of `MAKE`\"*, but a shell command to set `MAKE`; `'make -jNUM'` is the setting.  (This has been in before.)\n\n`s/`*won't need to use*`/`*won't need to set*`/` (dito)\n\n`s/`*can speed up the process*`/`*can significantly speed up the process*`/`\n\nI'd omit *\"(Not all packages support this, but the ones for which this could be problematic should automatically disable it.)\"* since this is pretty irrelevant (or confusing); or rephrase it to say that a few packages do not support building them with multiple jobs and hence are built sequentially, although in parallel *with other packages*.\n\nIn the warning, substitute *one-processor* by *single-core CPU* or *single-core machine*.  I'd also mention the platform (or operating system) to which this apparently applies; in my experience it is a non-issue on Linux.  Attempting to build Sage with probably too many jobs should in general not hurt; one can simply reduce the number of jobs upon build errors and restart, or more precisely continue, the build afterwards by again typing `make`.\n\n\nSimilar what I've said w.r.t. `README.txt` applies to the Installation Guide.\n\nAlso we should somehow mention potential problems with ATLAS there, and perhaps what I said about self-tuning packages in general (on sage-devel).  (Again, if ATLAS failed to build -- often just due to too high system load -- one can simply type `make` again, perhaps multiple times, since there are usually less packages left to build when `make` finally exits.  If we haven't already, we should also mention that CPU throttling aka power-saving mode should be turned off; \"on-demand\" in contrast should be ok, i.e., provided it works properly. [I don't know whether that's in the `README.txt`; I think it is important enough that it should be there, too.])",
    "created_at": "2011-10-28T01:15:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134608",
    "user": "leif"
}
```

W.r.t. the Sage Installation Guide:

`export MAKE='make -jNUM'` is not *"a common setting of `MAKE`"*, but a shell command to set `MAKE`; `'make -jNUM'` is the setting.  (This has been in before.)

`s/`*won't need to use*`/`*won't need to set*`/` (dito)

`s/`*can speed up the process*`/`*can significantly speed up the process*`/`

I'd omit *"(Not all packages support this, but the ones for which this could be problematic should automatically disable it.)"* since this is pretty irrelevant (or confusing); or rephrase it to say that a few packages do not support building them with multiple jobs and hence are built sequentially, although in parallel *with other packages*.

In the warning, substitute *one-processor* by *single-core CPU* or *single-core machine*.  I'd also mention the platform (or operating system) to which this apparently applies; in my experience it is a non-issue on Linux.  Attempting to build Sage with probably too many jobs should in general not hurt; one can simply reduce the number of jobs upon build errors and restart, or more precisely continue, the build afterwards by again typing `make`.


Similar what I've said w.r.t. `README.txt` applies to the Installation Guide.

Also we should somehow mention potential problems with ATLAS there, and perhaps what I said about self-tuning packages in general (on sage-devel).  (Again, if ATLAS failed to build -- often just due to too high system load -- one can simply type `make` again, perhaps multiple times, since there are usually less packages left to build when `make` finally exits.  If we haven't already, we should also mention that CPU throttling aka power-saving mode should be turned off; "on-demand" in contrast should be ok, i.e., provided it works properly. [I don't know whether that's in the `README.txt`; I think it is important enough that it should be there, too.])



---

archive/issue_comments_134609.json:
```json
{
    "body": "P.S.:\n\nI think (e.g.) `MAKE=\"make -j3 -l10.0\"` **or** `MAKE=\"make -j 3 -l 10.0\"` (or `MAKE=\"make --jobs=3 --load-average=10.0\"`) is more natural.\n\n(Although AFAIK older versions of GNU make interpreted `make -j 3` as *\"build **target**(!) '3' with infinitely many(!) jobs\"*, so the first and last version may be safer.)",
    "created_at": "2011-10-28T03:06:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134609",
    "user": "leif"
}
```

P.S.:

I think (e.g.) `MAKE="make -j3 -l10.0"` **or** `MAKE="make -j 3 -l 10.0"` (or `MAKE="make --jobs=3 --load-average=10.0"`) is more natural.

(Although AFAIK older versions of GNU make interpreted `make -j 3` as *"build **target**(!) '3' with infinitely many(!) jobs"*, so the first and last version may be safer.)



---

archive/issue_comments_134610.json:
```json
{
    "body": "I'm against this as is, but I think something very close is OK.\n\nI think SAGE_PARALLEL_SPKG_BUILD=\"no\" should be supported, but otherwise everything should be like in this proposal.    The reason is that it can be confusing trying to deal with build issues when the build log mixes up output from multiple packages being built at once.  Also there can be weird build issues resulting from building multiple packages at once.  However, using \"make -j16\" (say) is very useful in all cases on a machine with lots of processors so you don't have to wait so long for individual packages to build.",
    "created_at": "2011-10-28T05:11:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134610",
    "user": "was"
}
```

I'm against this as is, but I think something very close is OK.

I think SAGE_PARALLEL_SPKG_BUILD="no" should be supported, but otherwise everything should be like in this proposal.    The reason is that it can be confusing trying to deal with build issues when the build log mixes up output from multiple packages being built at once.  Also there can be weird build issues resulting from building multiple packages at once.  However, using "make -j16" (say) is very useful in all cases on a machine with lots of processors so you don't have to wait so long for individual packages to build.



---

archive/issue_comments_134611.json:
```json
{
    "body": "Replying to [comment:8 was]:\n> I'm against this as is, but I think something very close is OK. \n\n> \n\n> I think SAGE_PARALLEL_SPKG_BUILD=\"no\" should be supported, but otherwise everything should be like in this proposal.    The reason is that it can be confusing trying to deal with build issues when the build log mixes up output from multiple packages being built at once.\n\nTherefore we have (in addition) individual logs for each spkg in `$SAGE_ROOT/spkg/logs`.\n\n\n\n\n> Also there can be weird build issues resulting from building multiple packages at once.  However, using \"make -j16\" (say) is very useful in all cases on a machine with lots of processors so you don't have to wait so long for individual packages to build.\n\nWell, building multiple spkgs in parallel is IMHO quite mature.\n\nIf you only need an equivalent of `SAGE_PARALLEL_SPKG_BUILD=no` (still building each spkg in parallel if it supports that, and of course `MAKE` is set to `make -jN`) for debugging,\n\n```sh\n$ echo \".NOTPARALLEL\" >> $SAGE_ROOT/spkg/standard/deps\n```\n\ndoes the job.\n\nWe could of course document that, perhaps better in the *Developer's* Guide.\n\n(Or provide some [other] way to enable and disable that feature -- by an environment variable or an easier command; the only odd thing is that `deps` is under revision control and hence you get uncommitted changes in the *Sage root repository* :-) whenever that file is modified.  As an alternative, we could include some other \"temporary\" or volatile [make]file which is in `.hgignore`, and is either empty or contains just `.NOTPARALLEL`.)",
    "created_at": "2011-10-28T09:10:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134611",
    "user": "leif"
}
```

Replying to [comment:8 was]:
> I'm against this as is, but I think something very close is OK. 

> 

> I think SAGE_PARALLEL_SPKG_BUILD="no" should be supported, but otherwise everything should be like in this proposal.    The reason is that it can be confusing trying to deal with build issues when the build log mixes up output from multiple packages being built at once.

Therefore we have (in addition) individual logs for each spkg in `$SAGE_ROOT/spkg/logs`.




> Also there can be weird build issues resulting from building multiple packages at once.  However, using "make -j16" (say) is very useful in all cases on a machine with lots of processors so you don't have to wait so long for individual packages to build.

Well, building multiple spkgs in parallel is IMHO quite mature.

If you only need an equivalent of `SAGE_PARALLEL_SPKG_BUILD=no` (still building each spkg in parallel if it supports that, and of course `MAKE` is set to `make -jN`) for debugging,

```sh
$ echo ".NOTPARALLEL" >> $SAGE_ROOT/spkg/standard/deps
```

does the job.

We could of course document that, perhaps better in the *Developer's* Guide.

(Or provide some [other] way to enable and disable that feature -- by an environment variable or an easier command; the only odd thing is that `deps` is under revision control and hence you get uncommitted changes in the *Sage root repository* :-) whenever that file is modified.  As an alternative, we could include some other "temporary" or volatile [make]file which is in `.hgignore`, and is either empty or contains just `.NOTPARALLEL`.)



---

archive/issue_comments_134612.json:
```json
{
    "body": "Replying to [comment:9 leif]:\n> (Or provide some [other] way to enable and disable that feature -- by an environment variable or an easier command; the only odd thing is that `deps` is under revision control and hence you get uncommitted changes in the *Sage root repository* :-) whenever that file is modified.  As an alternative, we could include some other \"temporary\" or volatile [make]file which is in `.hgignore`, and is either empty or contains just `.NOTPARALLEL`.)\n\nWe could easily achieve that by changing `spkg/install` to\n\n```sh\n...\n\nif [[ ${SAGE_PARALLEL_SPKG_BUILD:-yes} = no ]]; then\n    # Disable just building multiple packages at the same time; individual\n    # spkgs still get built in parallel if they support it and '--jobs'\n    # in $MAKE is greater than one (and at all specified):\n    echo \".NOTPARALLEL:\" > \"$SAGE_ROOT\"/spkg/standard/parallel_make.cfg\nelse\n    # Create an (almost) empty file, s.t. including it from spkg/standard/deps\n    # doesn't raise an error, thereby also invalidating any previous setting:\n    echo > \"$SAGE_ROOT\"/spkg/standard/parallel_make.cfg\nfi\n\ntime ${MAKE:-make} -f standard/deps $1\n\n...\n```\n\nadding `spkg/standard/parallel_make.cfg` to `$SAGE_ROOT/.hgignore`, and adding the line\n\n```make\ninclude parallel_make.cfg\n```\n\nto `spkg/standard/deps`.",
    "created_at": "2011-10-28T09:48:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134612",
    "user": "leif"
}
```

Replying to [comment:9 leif]:
> (Or provide some [other] way to enable and disable that feature -- by an environment variable or an easier command; the only odd thing is that `deps` is under revision control and hence you get uncommitted changes in the *Sage root repository* :-) whenever that file is modified.  As an alternative, we could include some other "temporary" or volatile [make]file which is in `.hgignore`, and is either empty or contains just `.NOTPARALLEL`.)

We could easily achieve that by changing `spkg/install` to

```sh
...

if [[ ${SAGE_PARALLEL_SPKG_BUILD:-yes} = no ]]; then
    # Disable just building multiple packages at the same time; individual
    # spkgs still get built in parallel if they support it and '--jobs'
    # in $MAKE is greater than one (and at all specified):
    echo ".NOTPARALLEL:" > "$SAGE_ROOT"/spkg/standard/parallel_make.cfg
else
    # Create an (almost) empty file, s.t. including it from spkg/standard/deps
    # doesn't raise an error, thereby also invalidating any previous setting:
    echo > "$SAGE_ROOT"/spkg/standard/parallel_make.cfg
fi

time ${MAKE:-make} -f standard/deps $1

...
```

adding `spkg/standard/parallel_make.cfg` to `$SAGE_ROOT/.hgignore`, and adding the line

```make
include parallel_make.cfg
```

to `spkg/standard/deps`.



---

archive/issue_comments_134613.json:
```json
{
    "body": "How about a \"make serial\" target instead of the environment variable?",
    "created_at": "2011-10-28T15:07:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134613",
    "user": "jhpalmieri"
}
```

How about a "make serial" target instead of the environment variable?



---

archive/issue_comments_134614.json:
```json
{
    "body": "Replying to [comment:11 jhpalmieri]:\n> How about a \"make serial\" target instead of the environment variable?\n\nI'd say `make build-serial`, which just sets `SAGE_PARALLEL_SPKG_BUILD=no` and then does the usual thing, namely `build`.\n\nJust like `make rebuild` sets `SAGE_UPGRADING=yes` and then \"calls\" `build`. ;-)\n\nYou can of course define some aliases for convenience, e.g. `serial-build` or `build-macosx`... XD",
    "created_at": "2011-10-28T15:32:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134614",
    "user": "leif"
}
```

Replying to [comment:11 jhpalmieri]:
> How about a "make serial" target instead of the environment variable?

I'd say `make build-serial`, which just sets `SAGE_PARALLEL_SPKG_BUILD=no` and then does the usual thing, namely `build`.

Just like `make rebuild` sets `SAGE_UPGRADING=yes` and then "calls" `build`. ;-)

You can of course define some aliases for convenience, e.g. `serial-build` or `build-macosx`... XD



---

archive/issue_comments_134615.json:
```json
{
    "body": "Building in parallel on Mac OS X works just fine in *my* experience.  :p\n\nAnyway, here are new versions of the patches.",
    "created_at": "2011-10-28T18:03:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134615",
    "user": "jhpalmieri"
}
```

Building in parallel on Mac OS X works just fine in *my* experience.  :p

Anyway, here are new versions of the patches.



---

archive/issue_comments_134616.json:
```json
{
    "body": "Some comments about the new versions:\n\n- I've added a \"build-serial\" target in the Makefile.\n- spkg/install writes \"parallel-make.cfg\" in the directory \"spkg\", since that seems to be the current directory when the makefile \"standard/deps\" is executed.\n- Leif's proposed change to spkg/install regarding moving \"makefile\" to \"Makefile\" didn't seem to work on OS X, probably because of the stupid way OS X deals with upper and lower case in their standard file system.  Or maybe I did something else wrong.  Anyway, I didn't change that part of the script.\n- I haven't put everything possible into the top-level README file: the installation guide is supposed to have all of the details. I did add a comment about the spkg/logs/ files.  See also #11926, which adds a message about spkg/logs/PKG.log to the error message printed by sage-spkg.  \n- in the installation guide, I added a few comments about problems building ATLAS.\n\nBy the way, is there anything wrong with this kind of change:\n\n```diff\ndiff --git a/spkg/install b/spkg/install\n--- a/spkg/install\n+++ b/spkg/install\n@@ -483,19 +483,19 @@ fi\n echo \"Sage build/upgrade complete!\"\n \n if [ \"$1\" = \"all\" ]; then\n-    echo\n-    echo \"To install small scripts to directly run Sage's versions of GAP,\"\n-    echo \"the PARI/GP interpreter, Maxima, or Singular etc. (by typing e.g.\"\n-    echo \"just 'gap' or 'gp') into a standard 'bin' directory, start Sage\"\n-    echo \"by typing 'sage' (or './sage') and enter something like\"\n-    echo\n-    echo \"    install_scripts('/usr/local/bin')\"\n-    echo\n-    echo \"at the Sage command prompt ('sage:').\"\n-    echo\n-    echo \"If you issued 'make', 'make all', or a similar command, then the\"\n-    echo \"HTML version of the documentation will be built right now.\"\n-    echo \"Otherwise, if you want to (re)build the HTML documentation,\"\n-    echo \"run 'make doc'.  To build the PDF version, run 'make doc-pdf'.\"\n-    echo\n+    echo \"\n+To install small scripts to directly run Sage's versions of GAP,\n+the PARI/GP interpreter, Maxima, or Singular etc. (by typing e.g.\n+just 'gap' or 'gp') into a standard 'bin' directory, start Sage\n+by typing 'sage' (or './sage') and enter something like\n+\n+    install_scripts('/usr/local/bin')\n+\n+at the Sage command prompt ('sage:').\n+\n+If you issued 'make', 'make all', or a similar command, then the\n+HTML version of the documentation will be built right now.\n+Otherwise, if you want to (re)build the HTML documentation,\n+run 'make doc'.  To build the PDF version, run 'make doc-pdf'.\n+\"\n fi\n```\n\nAre multiline strings not a good idea for \"echo\"?  If this sort of thing is okay, it makes it much easier to edit the message.",
    "created_at": "2011-10-28T18:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134616",
    "user": "jhpalmieri"
}
```

Some comments about the new versions:

- I've added a "build-serial" target in the Makefile.
- spkg/install writes "parallel-make.cfg" in the directory "spkg", since that seems to be the current directory when the makefile "standard/deps" is executed.
- Leif's proposed change to spkg/install regarding moving "makefile" to "Makefile" didn't seem to work on OS X, probably because of the stupid way OS X deals with upper and lower case in their standard file system.  Or maybe I did something else wrong.  Anyway, I didn't change that part of the script.
- I haven't put everything possible into the top-level README file: the installation guide is supposed to have all of the details. I did add a comment about the spkg/logs/ files.  See also #11926, which adds a message about spkg/logs/PKG.log to the error message printed by sage-spkg.  
- in the installation guide, I added a few comments about problems building ATLAS.

By the way, is there anything wrong with this kind of change:

```diff
diff --git a/spkg/install b/spkg/install
--- a/spkg/install
+++ b/spkg/install
@@ -483,19 +483,19 @@ fi
 echo "Sage build/upgrade complete!"
 
 if [ "$1" = "all" ]; then
-    echo
-    echo "To install small scripts to directly run Sage's versions of GAP,"
-    echo "the PARI/GP interpreter, Maxima, or Singular etc. (by typing e.g."
-    echo "just 'gap' or 'gp') into a standard 'bin' directory, start Sage"
-    echo "by typing 'sage' (or './sage') and enter something like"
-    echo
-    echo "    install_scripts('/usr/local/bin')"
-    echo
-    echo "at the Sage command prompt ('sage:')."
-    echo
-    echo "If you issued 'make', 'make all', or a similar command, then the"
-    echo "HTML version of the documentation will be built right now."
-    echo "Otherwise, if you want to (re)build the HTML documentation,"
-    echo "run 'make doc'.  To build the PDF version, run 'make doc-pdf'."
-    echo
+    echo "
+To install small scripts to directly run Sage's versions of GAP,
+the PARI/GP interpreter, Maxima, or Singular etc. (by typing e.g.
+just 'gap' or 'gp') into a standard 'bin' directory, start Sage
+by typing 'sage' (or './sage') and enter something like
+
+    install_scripts('/usr/local/bin')
+
+at the Sage command prompt ('sage:').
+
+If you issued 'make', 'make all', or a similar command, then the
+HTML version of the documentation will be built right now.
+Otherwise, if you want to (re)build the HTML documentation,
+run 'make doc'.  To build the PDF version, run 'make doc-pdf'.
+"
 fi
```

Are multiline strings not a good idea for "echo"?  If this sort of thing is okay, it makes it much easier to edit the message.



---

archive/issue_comments_134617.json:
```json
{
    "body": "Attachment [trac_11959-root.patch](tarball://root/attachments/some-uuid/ticket11959/trac_11959-root.patch) by jhpalmieri created at 2011-10-28 18:17:54\n\nroot repo",
    "created_at": "2011-10-28T18:17:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134617",
    "user": "jhpalmieri"
}
```

Attachment [trac_11959-root.patch](tarball://root/attachments/some-uuid/ticket11959/trac_11959-root.patch) by jhpalmieri created at 2011-10-28 18:17:54

root repo



---

archive/issue_comments_134618.json:
```json
{
    "body": "Sage library",
    "created_at": "2011-10-28T18:31:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134618",
    "user": "jhpalmieri"
}
```

Sage library



---

archive/issue_comments_134619.json:
```json
{
    "body": "Attachment [trac_11959-sage.patch](tarball://root/attachments/some-uuid/ticket11959/trac_11959-sage.patch) by leif created at 2011-10-29 09:20:43\n\nReplying to [comment:13 jhpalmieri]:\n> Building in parallel on Mac OS X works just fine in *my* experience.  :p\n\nIncidentally I ran into \"random\" (non-reproducible) parallel build errors on `bsd.math` just yesterday, when it was btw. otherwise idling; with `MAKE=\"make -j8\"`.",
    "created_at": "2011-10-29T09:20:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134619",
    "user": "leif"
}
```

Attachment [trac_11959-sage.patch](tarball://root/attachments/some-uuid/ticket11959/trac_11959-sage.patch) by leif created at 2011-10-29 09:20:43

Replying to [comment:13 jhpalmieri]:
> Building in parallel on Mac OS X works just fine in *my* experience.  :p

Incidentally I ran into "random" (non-reproducible) parallel build errors on `bsd.math` just yesterday, when it was btw. otherwise idling; with `MAKE="make -j8"`.



---

archive/issue_comments_134620.json:
```json
{
    "body": "Replying to [comment:15 jhpalmieri]:\n> Are multiline strings not a good idea for \"echo\"?  If this sort of thing is okay, it makes it much easier to edit the message.\n\n`echo` has no problem with that, nor any *reasonable* shell.  For larger texts, you might get problems with the size of the environment on some systems though.  Note that\n\n```sh\n$ echo \"\none line\n\"\n```\n\noutputs *three* lines, the first and last being empty.\n\nI'd prefer `cat` and \"here\" documents though (if at all).  If you want to focus on the code rather than the text, it's better to use a chain of (properly indented) `echo` commands.\n\n`bash` also supports indentation of \"here\" documents (that doesn't appear in the output);\n\n```sh\n$ cat <<-EOF\n...\nEOF\n```\n\nstrips leading tabs from the text.",
    "created_at": "2011-10-29T09:42:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134620",
    "user": "leif"
}
```

Replying to [comment:15 jhpalmieri]:
> Are multiline strings not a good idea for "echo"?  If this sort of thing is okay, it makes it much easier to edit the message.

`echo` has no problem with that, nor any *reasonable* shell.  For larger texts, you might get problems with the size of the environment on some systems though.  Note that

```sh
$ echo "
one line
"
```

outputs *three* lines, the first and last being empty.

I'd prefer `cat` and "here" documents though (if at all).  If you want to focus on the code rather than the text, it's better to use a chain of (properly indented) `echo` commands.

`bash` also supports indentation of "here" documents (that doesn't appear in the output);

```sh
$ cat <<-EOF
...
EOF
```

strips leading tabs from the text.



---

archive/issue_comments_134621.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-10-29T10:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134621",
    "user": "leif"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_134622.json:
```json
{
    "body": "`make` doesn't export \"its\" variables by default.  So unless `SAGE_PARALLEL_SPKG_BUILD` was already defined (and exported) when `make` was invoked, setting it in the `Makefile` has no effect on programs (including shells) invoked by `make`.  Without using further GNU make specifics, you'd have to do e.g.\n\n```make\nbuild: $(PIPE) \n        cd spkg && \\\n        \"../$(PIPE)\" \\\n                 \"env SAGE_PARALLEL_SPKG_BUILD='$(SAGE_PARALLEL_SPKG_BUILD)' ./install all 2>&1\" \\\n                 \"tee -a ../install.log\" \n```\n\n\nI <3 lengthy env var names...\n\n\n\n\nIt would be better (i.e., safer) to use an absolute filename in the `include` directive, e.g. `$(SAGE_ROOT)/spkg/parallel_make.cfg`.\n\nI'd perhaps add to the comment there that `.NOTPARALLEL` has no effect on sub-makes.\n\n\n\n\nWhile you're at it, the commit messages are no longer current.",
    "created_at": "2011-10-29T10:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134622",
    "user": "leif"
}
```

`make` doesn't export "its" variables by default.  So unless `SAGE_PARALLEL_SPKG_BUILD` was already defined (and exported) when `make` was invoked, setting it in the `Makefile` has no effect on programs (including shells) invoked by `make`.  Without using further GNU make specifics, you'd have to do e.g.

```make
build: $(PIPE) 
        cd spkg && \
        "../$(PIPE)" \
                 "env SAGE_PARALLEL_SPKG_BUILD='$(SAGE_PARALLEL_SPKG_BUILD)' ./install all 2>&1" \
                 "tee -a ../install.log" 
```


I <3 lengthy env var names...




It would be better (i.e., safer) to use an absolute filename in the `include` directive, e.g. `$(SAGE_ROOT)/spkg/parallel_make.cfg`.

I'd perhaps add to the comment there that `.NOTPARALLEL` has no effect on sub-makes.




While you're at it, the commit messages are no longer current.



---

archive/issue_comments_134623.json:
```json
{
    "body": "P.S.: Using a maximal (avg) sysload of 2.5 to me seems a bit funny [even] as an example; I'd use *at least* the number of cores, which today is usually 4 or more.\n\n\n\n\nIn `README.txt`, grepping for \"An error\" is sufficient and best used with `-l` (which only prints the filenames of matches), or perhaps `-c`, which prints the number of matches in each file (unfortunately also including zero, i.e., one should postprocess that output further), since we always append to the logs and hence previous errors never vanish unless one deletes (or edits) the log.\n\nSince the error message (\"An error ...\") already contains the package's name, using\n\n```sh\n$ grep -h \"An error\" spkg/logs/*\n```\n\nwould also give a more readable output, as an alternative to `-l`, with the advantage that one immediately sees whether a package failed to install multiple times.\n\nTo get the actual error messages, (e)grepping for \"Error\" and \"Failed\" at the beginning of the line (`egrep \"^(Error|Failed)\" spkg/logs/...`<sup>1</sup>), optionally with a (non-POSIX) before-context (`-B`), is usually more informative.  When case-insensitively ( `-i`) grepping for any  \"`error`\", to suppress frequent errors ignored by `make`, one can pipe the whole through `grep -iv ignored`.  `-n` also prepends the line numbers to the output, which is useful if you're going to open the log in an editor.\n\n\n\n\nDo we mention `LC_ALL=C` (or e.g. `LC_MESSAGES=en_US.utf8`) for submitting error logs?\n\n----\n<sup>1</sup> `\"^Failed\"` usually also gives non-fatal errors for the Python spkg (*\"Failed to find the necessary bits...\"*).  In the long run, all of *Sage's* error messages should really start with \"Error\" rather than \"Failed\".  (The new ATLAS spkg with the Python install script in contrast raises arbitrary exceptions.)\n\nWe should really in addition create a fresh temporary file at the start of each build to keep track of which packages failed to build, to be dumped at the end (in case of errors).",
    "created_at": "2011-10-29T11:47:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134623",
    "user": "leif"
}
```

P.S.: Using a maximal (avg) sysload of 2.5 to me seems a bit funny [even] as an example; I'd use *at least* the number of cores, which today is usually 4 or more.




In `README.txt`, grepping for "An error" is sufficient and best used with `-l` (which only prints the filenames of matches), or perhaps `-c`, which prints the number of matches in each file (unfortunately also including zero, i.e., one should postprocess that output further), since we always append to the logs and hence previous errors never vanish unless one deletes (or edits) the log.

Since the error message ("An error ...") already contains the package's name, using

```sh
$ grep -h "An error" spkg/logs/*
```

would also give a more readable output, as an alternative to `-l`, with the advantage that one immediately sees whether a package failed to install multiple times.

To get the actual error messages, (e)grepping for "Error" and "Failed" at the beginning of the line (`egrep "^(Error|Failed)" spkg/logs/...`<sup>1</sup>), optionally with a (non-POSIX) before-context (`-B`), is usually more informative.  When case-insensitively ( `-i`) grepping for any  "`error`", to suppress frequent errors ignored by `make`, one can pipe the whole through `grep -iv ignored`.  `-n` also prepends the line numbers to the output, which is useful if you're going to open the log in an editor.




Do we mention `LC_ALL=C` (or e.g. `LC_MESSAGES=en_US.utf8`) for submitting error logs?

----
<sup>1</sup> `"^Failed"` usually also gives non-fatal errors for the Python spkg (*"Failed to find the necessary bits..."*).  In the long run, all of *Sage's* error messages should really start with "Error" rather than "Failed".  (The new ATLAS spkg with the Python install script in contrast raises arbitrary exceptions.)

We should really in addition create a fresh temporary file at the start of each build to keep track of which packages failed to build, to be dumped at the end (in case of errors).



---

archive/issue_comments_134624.json:
```json
{
    "body": "Slightly off the ticket's topic:\n\nWouldn't it be better to put a lot of stuff into `SAGE_ROOT/TROUBLESHOOTING.txt`?\n\nPeople tend to not read READMEs... (presumably because they're so ubiquitous and many of them are hardly informative)",
    "created_at": "2011-10-29T12:18:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134624",
    "user": "leif"
}
```

Slightly off the ticket's topic:

Wouldn't it be better to put a lot of stuff into `SAGE_ROOT/TROUBLESHOOTING.txt`?

People tend to not read READMEs... (presumably because they're so ubiquitous and many of them are hardly informative)



---

archive/issue_comments_134625.json:
```json
{
    "body": "The `2.5` number for `-l` came straight from the GNU make man page.\n\nRegarding variables in the Makefile, I saw this sentence in the man page: \"When make runs a recipe, variables defined in the makefile are placed into the environment of each shell.\" This is a bit misleading, because it only exports variables that already came from the environment, so I saw that my setting of SAGE_PARALLEL_SPKG_BUILD=yes was being overridden when I ran \"make build-serial\".  I see now that if this variable is unset, then \"make build-serial\" doesn't do what it should.  Why can't I just do\n\n```\nbuild-serial: export SAGE_PARALLEL_SPKG_BUILD = no\nbuild-serial: build\n```\n\nOr is this too specific to GNU make?  (Will our makefiles work without GNU make anyway?)\n\nFor grep, I like the output from `grep -l ...`, so I'll use that.\n\n> Do we mention LC_ALL=C (or e.g. LC_MESSAGES=en_US.utf8) for submitting error logs?\n\nI don't think so, and I'm not planning to add anything about it.\n\nRe `TROUBLESHOOTING.txt`: we could instead have a structure more like many GNU projects: a boilerplate README and then a file INSTALL with specific instructions.\n\nWhile we're off-topic: Is the top-level `install.log` any use as it is right now?  It would be better if it had just summary information:\n\n```\nAll environment variables ...\n```\n\nand then lines like the following (probably intermixed for the different spkgs):\n\n```\n[time] Started building python-...spkg; keeping a log in spkg/logs/python-...log\n[time] Successfully installed python-....\n```\n\nor\n\n```\n[time] Started building python-...spkg; keeping a log in spkg/logs/python-...log\n[time] Error building python-...; see spkg/logs/python-... for a full log\n```\n\nor\n\n```\n[time] Started building python-...spkg; keeping a log in spkg/logs/python-...log\n[time] Error testing python...; see spkg/logs/python-... for a full log\n```\n\nAnd then at the end\n\n```\nreal\t106m26.143s\nuser\t147m9.046s\nsys\t21m31.998s\n\nSage build/upgrade complete!\n...\n```\n\nHow hard would that be?",
    "created_at": "2011-10-29T16:34:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134625",
    "user": "jhpalmieri"
}
```

The `2.5` number for `-l` came straight from the GNU make man page.

Regarding variables in the Makefile, I saw this sentence in the man page: "When make runs a recipe, variables defined in the makefile are placed into the environment of each shell." This is a bit misleading, because it only exports variables that already came from the environment, so I saw that my setting of SAGE_PARALLEL_SPKG_BUILD=yes was being overridden when I ran "make build-serial".  I see now that if this variable is unset, then "make build-serial" doesn't do what it should.  Why can't I just do

```
build-serial: export SAGE_PARALLEL_SPKG_BUILD = no
build-serial: build
```

Or is this too specific to GNU make?  (Will our makefiles work without GNU make anyway?)

For grep, I like the output from `grep -l ...`, so I'll use that.

> Do we mention LC_ALL=C (or e.g. LC_MESSAGES=en_US.utf8) for submitting error logs?

I don't think so, and I'm not planning to add anything about it.

Re `TROUBLESHOOTING.txt`: we could instead have a structure more like many GNU projects: a boilerplate README and then a file INSTALL with specific instructions.

While we're off-topic: Is the top-level `install.log` any use as it is right now?  It would be better if it had just summary information:

```
All environment variables ...
```

and then lines like the following (probably intermixed for the different spkgs):

```
[time] Started building python-...spkg; keeping a log in spkg/logs/python-...log
[time] Successfully installed python-....
```

or

```
[time] Started building python-...spkg; keeping a log in spkg/logs/python-...log
[time] Error building python-...; see spkg/logs/python-... for a full log
```

or

```
[time] Started building python-...spkg; keeping a log in spkg/logs/python-...log
[time] Error testing python...; see spkg/logs/python-... for a full log
```

And then at the end

```
real	106m26.143s
user	147m9.046s
sys	21m31.998s

Sage build/upgrade complete!
...
```

How hard would that be?



---

archive/issue_comments_134626.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-10-29T21:07:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134626",
    "user": "jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_134627.json:
```json
{
    "body": "Here are new patches.\n\nFor changing the format of install.log etc., we could write to the individual log files as part of sage-spkg, instead of when sage-spkg is called by sage-sage or spkg/install.  Then spkg/install could have minimal output (or we could have a flag for setting its verbosity), which it would write directly to install.log.\n\nsage-spkg could take an optional argument, the name of the log file, or at least whether or not to produce a log file; the default would be to append to one.",
    "created_at": "2011-10-29T21:07:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134627",
    "user": "jhpalmieri"
}
```

Here are new patches.

For changing the format of install.log etc., we could write to the individual log files as part of sage-spkg, instead of when sage-spkg is called by sage-sage or spkg/install.  Then spkg/install could have minimal output (or we could have a flag for setting its verbosity), which it would write directly to install.log.

sage-spkg could take an optional argument, the name of the log file, or at least whether or not to produce a log file; the default would be to append to one.



---

archive/issue_comments_134628.json:
```json
{
    "body": "Replying to [comment:22 jhpalmieri]:\n> Why can't I just do\n\n```\nbuild-serial: export SAGE_PARALLEL_SPKG_BUILD = no\nbuild-serial: build\n```\n\n\nWell, you could.  You could also add\n\n```make\nexport SAGE_PARALLEL_SPKG_BUILD\n```\n\nsomewhere in the Makefile (preferably near the top), or use\n\n```make\nEXPORTS = SAGE_PARALLEL_SPKG_BUILD=\"$(SAGE_PARALLEL_SPKG_BUILD)\" \\\n          SAGE_FOO=\"$(SAGE_FOO)\"\n\n...\n\nbar:\n        env $(EXPORTS) ./baz\n```\n\n\n> Or is this too specific to GNU make?\n\nI don't care much, although I prefer not using GNUisms if there's a *simple* alternative.  AFAIK older *GNU* makes don't support `export` either, but I haven't checked since when they do.\n\n\n\n\n> > Do we mention LC_ALL=C (or e.g. LC_MESSAGES=en_US.utf8) for submitting error logs?\n> \n> I don't think so, and I'm not planning to add anything about it.\n\nHmmmm. :(\n\n\n\n\n> Re `TROUBLESHOOTING.txt`: we could instead have a structure more like many GNU projects: a boilerplate README and then a file INSTALL with specific instructions.\n\nTROUBLESHOOTING is much more explicit.  Most INSTALL files shipped are just templates, so it's quite likely that people wouldn't read them either.  We also have the (longer) Sage Installation Guide; I was aiming at a short plain text file purely on topic, i.e. common issues (which might get updated more frequently and easily), and how and where to report build failures / ask for build-related support.\n\n\n\n\n> While we're off-topic: Is the top-level `install.log` any use as it is right now?\n\nI'd keep at least the file; whether it makes sense to dump it to the screen -- especially in parallel builds --  is another question.\n\n> For changing the format of install.log etc., we could write to the individual log files as part of sage-spkg, instead of when sage-spkg is called by sage-sage or spkg/install.\n\nThat's what I suggested more than a year ago. :-)  Also, a large amount of the output are distutils' \"copying ...\" messages, and ECL (also when building Maxima) is far too verbose, too.\n\nWe don't lose much if we move the logging from `deps` to `sage-spkg`.  The latter should take a couple of logging-related parameters like `--logfile=`, `--logfd=`, `--loglevel=`, with the possibility to specify more than one logfile or file descriptor, with the same or different log levels.\n\nUnfortunately `sage-spkg` is a hot spot; it needs work in all places.",
    "created_at": "2011-10-29T22:47:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134628",
    "user": "leif"
}
```

Replying to [comment:22 jhpalmieri]:
> Why can't I just do

```
build-serial: export SAGE_PARALLEL_SPKG_BUILD = no
build-serial: build
```


Well, you could.  You could also add

```make
export SAGE_PARALLEL_SPKG_BUILD
```

somewhere in the Makefile (preferably near the top), or use

```make
EXPORTS = SAGE_PARALLEL_SPKG_BUILD="$(SAGE_PARALLEL_SPKG_BUILD)" \
          SAGE_FOO="$(SAGE_FOO)"

...

bar:
        env $(EXPORTS) ./baz
```


> Or is this too specific to GNU make?

I don't care much, although I prefer not using GNUisms if there's a *simple* alternative.  AFAIK older *GNU* makes don't support `export` either, but I haven't checked since when they do.




> > Do we mention LC_ALL=C (or e.g. LC_MESSAGES=en_US.utf8) for submitting error logs?
> 
> I don't think so, and I'm not planning to add anything about it.

Hmmmm. :(




> Re `TROUBLESHOOTING.txt`: we could instead have a structure more like many GNU projects: a boilerplate README and then a file INSTALL with specific instructions.

TROUBLESHOOTING is much more explicit.  Most INSTALL files shipped are just templates, so it's quite likely that people wouldn't read them either.  We also have the (longer) Sage Installation Guide; I was aiming at a short plain text file purely on topic, i.e. common issues (which might get updated more frequently and easily), and how and where to report build failures / ask for build-related support.




> While we're off-topic: Is the top-level `install.log` any use as it is right now?

I'd keep at least the file; whether it makes sense to dump it to the screen -- especially in parallel builds --  is another question.

> For changing the format of install.log etc., we could write to the individual log files as part of sage-spkg, instead of when sage-spkg is called by sage-sage or spkg/install.

That's what I suggested more than a year ago. :-)  Also, a large amount of the output are distutils' "copying ..." messages, and ECL (also when building Maxima) is far too verbose, too.

We don't lose much if we move the logging from `deps` to `sage-spkg`.  The latter should take a couple of logging-related parameters like `--logfile=`, `--logfd=`, `--loglevel=`, with the possibility to specify more than one logfile or file descriptor, with the same or different log levels.

Unfortunately `sage-spkg` is a hot spot; it needs work in all places.



---

archive/issue_comments_134629.json:
```json
{
    "body": "Replying to [comment:22 jhpalmieri]:\n> For grep, I like the output from `grep -l ...`, so I'll use that.\n\n`grep -li ...` would be better, since `sage-build` also has\n\n```\n\t  echo \"ERROR: There was an error building c_lib.\"\n         echo \"sage: There was an error installing modified $1 library code.\"\n```\n\n\n(Or just change that file, too... :P  Although \"Error: ...\" would be better anyway.)",
    "created_at": "2011-10-29T23:10:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134629",
    "user": "leif"
}
```

Replying to [comment:22 jhpalmieri]:
> For grep, I like the output from `grep -l ...`, so I'll use that.

`grep -li ...` would be better, since `sage-build` also has

```
	  echo "ERROR: There was an error building c_lib."
         echo "sage: There was an error installing modified $1 library code."
```


(Or just change that file, too... :P  Although "Error: ..." would be better anyway.)



---

archive/issue_comments_134630.json:
```json
{
    "body": "for review only",
    "created_at": "2011-10-29T23:19:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134630",
    "user": "jhpalmieri"
}
```

for review only



---

archive/issue_comments_134631.json:
```json
{
    "body": "Attachment [trac_11959-root-delta1to2.patch](tarball://root/attachments/some-uuid/ticket11959/trac_11959-root-delta1to2.patch) by jhpalmieri created at 2011-10-29 23:19:57\n\nfor review only",
    "created_at": "2011-10-29T23:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134631",
    "user": "jhpalmieri"
}
```

Attachment [trac_11959-root-delta1to2.patch](tarball://root/attachments/some-uuid/ticket11959/trac_11959-root-delta1to2.patch) by jhpalmieri created at 2011-10-29 23:19:57

for review only



---

archive/issue_comments_134632.json:
```json
{
    "body": "Sage library",
    "created_at": "2011-10-29T23:20:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134632",
    "user": "jhpalmieri"
}
```

Sage library



---

archive/issue_comments_134633.json:
```json
{
    "body": "Attachment [trac_11959-sage.v2.patch](tarball://root/attachments/some-uuid/ticket11959/trac_11959-sage.v2.patch) by jhpalmieri created at 2011-10-29 23:20:46\n\n(New versions of the v2 patches, just changing \"grep -l\" to \"grep -li\".)",
    "created_at": "2011-10-29T23:20:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134633",
    "user": "jhpalmieri"
}
```

Attachment [trac_11959-sage.v2.patch](tarball://root/attachments/some-uuid/ticket11959/trac_11959-sage.v2.patch) by jhpalmieri created at 2011-10-29 23:20:46

(New versions of the v2 patches, just changing "grep -l" to "grep -li".)



---

archive/issue_comments_134634.json:
```json
{
    "body": "I'm happy with the v2 patches as they are, so in principle positive review.  Just have to take a closer look at the whole and make sure the patches apply... ;-)\n\nFeel free to add or change further things if you like.\n\n\n[IRC distracted me; that was a while ago, but I hadn't yet grabbed the patches... :-) ]",
    "created_at": "2011-10-29T23:37:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134634",
    "user": "leif"
}
```

I'm happy with the v2 patches as they are, so in principle positive review.  Just have to take a closer look at the whole and make sure the patches apply... ;-)

Feel free to add or change further things if you like.


[IRC distracted me; that was a while ago, but I hadn't yet grabbed the patches... :-) ]



---

archive/issue_comments_134635.json:
```json
{
    "body": "*\"If you have a machine with 4 processors...\"*\n\nAsk Intel what the differences between a uni-processor, a dual-processor and a multi-processor machine are... ;-) (These are separate Xeon series; AMD has Athlon/Phenom vs. Opteron.  The Sage cluster machines boxen, geom, mod, redhawk and sage are all 4-processor machines, each processor a hexacore.)\n\n(The cheap desktop and notebook ones are all single-processor multi-core machines, and I think the notion of cores is meanwhile quite common to everyone.)\n\n\n\n\nIf you happen to edit `README.txt` again, perhaps also mention sage-release, which is IMHO better suited for build errors.  The lengthy standard error message of `sage-spkg` already mentions sage-devel (and currently only that).",
    "created_at": "2011-10-29T23:59:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134635",
    "user": "leif"
}
```

*"If you have a machine with 4 processors..."*

Ask Intel what the differences between a uni-processor, a dual-processor and a multi-processor machine are... ;-) (These are separate Xeon series; AMD has Athlon/Phenom vs. Opteron.  The Sage cluster machines boxen, geom, mod, redhawk and sage are all 4-processor machines, each processor a hexacore.)

(The cheap desktop and notebook ones are all single-processor multi-core machines, and I think the notion of cores is meanwhile quite common to everyone.)




If you happen to edit `README.txt` again, perhaps also mention sage-release, which is IMHO better suited for build errors.  The lengthy standard error message of `sage-spkg` already mentions sage-devel (and currently only that).



---

archive/issue_comments_134636.json:
```json
{
    "body": "Small typo in `deps`:\n\n*\"# only determines whether more than **one** spkg may be built at a time.\"*\n\nOr I should just try what it builds when it builds more than spkgs... :-)",
    "created_at": "2011-10-30T00:12:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134636",
    "user": "leif"
}
```

Small typo in `deps`:

*"# only determines whether more than **one** spkg may be built at a time."*

Or I should just try what it builds when it builds more than spkgs... :-)



---

archive/issue_comments_134637.json:
```json
{
    "body": "Replying to [comment:29 leif]:\n> If you happen to edit `README.txt` again [...]\n\nYou could also increase the number of developers in *\"Over 200 people have contributed code to Sage.\"* to 300+.",
    "created_at": "2011-10-30T00:30:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134637",
    "user": "leif"
}
```

Replying to [comment:29 leif]:
> If you happen to edit `README.txt` again [...]

You could also increase the number of developers in *"Over 200 people have contributed code to Sage."* to 300+.



---

archive/issue_comments_134638.json:
```json
{
    "body": "Just in case this isn't written in stone, it would be nice to still have the full thing in install.log.  One could *add* something about referring to the other logs, though, if it doesn't already do so, maybe especially in the case of an error in the build.",
    "created_at": "2011-10-30T00:48:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134638",
    "user": "kcrisman"
}
```

Just in case this isn't written in stone, it would be nice to still have the full thing in install.log.  One could *add* something about referring to the other logs, though, if it doesn't already do so, maybe especially in the case of an error in the build.



---

archive/issue_comments_134639.json:
```json
{
    "body": "I'm curious as to how the full install.log is useful.  Having it essentially doubles the amount of log space, since almost everything is in both the install.log and the individual log files.  The individual log files aren't jumbled together the way they are in install.log (for parallel builds).  If the whole log file just said:\n\n- building X\n- building Y\n- ...\n- done building Y  (or \"error building Y\")\n- done building X\n- ...\n\nwith instructions about how to find the individual log files, doesn't that convey all of the necessary information?",
    "created_at": "2011-10-30T01:16:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134639",
    "user": "jhpalmieri"
}
```

I'm curious as to how the full install.log is useful.  Having it essentially doubles the amount of log space, since almost everything is in both the install.log and the individual log files.  The individual log files aren't jumbled together the way they are in install.log (for parallel builds).  If the whole log file just said:

- building X
- building Y
- ...
- done building Y  (or "error building Y")
- done building X
- ...

with instructions about how to find the individual log files, doesn't that convey all of the necessary information?



---

archive/issue_comments_134640.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-10-30T01:49:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134640",
    "user": "leif"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_134641.json:
```json
{
    "body": "It's amazing how many typos are in the Installation Guide.  But the documentation has really improved compared to how it was e.g. last year.\n\nOne could also add a link to the Environment Variables section (i.e., `MAKE`) when it comes to \"`make`\", since the steps for building from source there currently do not mention building in parallel (or `make -j`) at all.\n\n----\n\nAs said, I'm happy with the patches as they are, and everything works as expected, so **positive review**.",
    "created_at": "2011-10-30T01:49:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134641",
    "user": "leif"
}
```

It's amazing how many typos are in the Installation Guide.  But the documentation has really improved compared to how it was e.g. last year.

One could also add a link to the Environment Variables section (i.e., `MAKE`) when it comes to "`make`", since the steps for building from source there currently do not mention building in parallel (or `make -j`) at all.

----

As said, I'm happy with the patches as they are, and everything works as expected, so **positive review**.



---

archive/issue_comments_134642.json:
```json
{
    "body": "FYI: I'm updating the root patch to fix the typo in deps.",
    "created_at": "2011-10-30T03:13:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134642",
    "user": "jhpalmieri"
}
```

FYI: I'm updating the root patch to fix the typo in deps.



---

archive/issue_comments_134643.json:
```json
{
    "body": "Attachment [trac_11959-root.v2.patch](tarball://root/attachments/some-uuid/ticket11959/trac_11959-root.v2.patch) by jhpalmieri created at 2011-10-30 03:13:23\n\nroot repo",
    "created_at": "2011-10-30T03:13:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134643",
    "user": "jhpalmieri"
}
```

Attachment [trac_11959-root.v2.patch](tarball://root/attachments/some-uuid/ticket11959/trac_11959-root.v2.patch) by jhpalmieri created at 2011-10-30 03:13:23

root repo



---

archive/issue_comments_134644.json:
```json
{
    "body": "Replying to [comment:33 jhpalmieri]:\n> I'm curious as to how the full install.log is useful.  Having it essentially doubles the amount of log space, since almost \nBecause I'm lazy and don't want to have to dive into spkg/ to open them.  Won't revert the positive review on this, though, since it will be in 4.7.3, certainly makes sense in many ways, and if anyone else wants it they'll have plenty of alphas to complain :)",
    "created_at": "2011-10-30T03:30:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134644",
    "user": "kcrisman"
}
```

Replying to [comment:33 jhpalmieri]:
> I'm curious as to how the full install.log is useful.  Having it essentially doubles the amount of log space, since almost 
Because I'm lazy and don't want to have to dive into spkg/ to open them.  Won't revert the positive review on this, though, since it will be in 4.7.3, certainly makes sense in many ways, and if anyone else wants it they'll have plenty of alphas to complain :)



---

archive/issue_comments_134645.json:
```json
{
    "body": "Replying to [comment:36 kcrisman]:\n> Replying to [comment:33 jhpalmieri]:\n> > I'm curious as to how the full install.log is useful.  Having it essentially doubles the amount of log space, since almost \n> Because I'm lazy and don't want to have to dive into spkg/ to open them.  Won't revert the positive review on this\n\nThis ticket doesn't actually affect the contents of install.log, it was just a side discussion.  The patches here do put a little more emphasis on spkg/logs/*, because I think they still aren't well known enough, but no log files were harmed by the patches for this ticket.",
    "created_at": "2011-10-30T03:54:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134645",
    "user": "jhpalmieri"
}
```

Replying to [comment:36 kcrisman]:
> Replying to [comment:33 jhpalmieri]:
> > I'm curious as to how the full install.log is useful.  Having it essentially doubles the amount of log space, since almost 
> Because I'm lazy and don't want to have to dive into spkg/ to open them.  Won't revert the positive review on this

This ticket doesn't actually affect the contents of install.log, it was just a side discussion.  The patches here do put a little more emphasis on spkg/logs/*, because I think they still aren't well known enough, but no log files were harmed by the patches for this ticket.



---

archive/issue_comments_134646.json:
```json
{
    "body": "Rebased on top of #11926",
    "created_at": "2011-11-01T09:46:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134646",
    "user": "jdemeyer"
}
```

Rebased on top of #11926



---

archive/issue_comments_134647.json:
```json
{
    "body": "Attachment [trac_11959-root.v2-rebased.patch](tarball://root/attachments/some-uuid/ticket11959/trac_11959-root.v2-rebased.patch) by jdemeyer created at 2011-11-01 09:47:30",
    "created_at": "2011-11-01T09:47:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134647",
    "user": "jdemeyer"
}
```

Attachment [trac_11959-root.v2-rebased.patch](tarball://root/attachments/some-uuid/ticket11959/trac_11959-root.v2-rebased.patch) by jdemeyer created at 2011-11-01 09:47:30



---

archive/issue_comments_134648.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-11-02T08:32:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134648",
    "user": "jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_134649.json:
```json
{
    "body": "Rebased on top of #11926",
    "created_at": "2011-11-02T19:59:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134649",
    "user": "jdemeyer"
}
```

Rebased on top of #11926



---

archive/issue_comments_134650.json:
```json
{
    "body": "Attachment [trac_11959-sage.v2-rebased.patch](tarball://root/attachments/some-uuid/ticket11959/trac_11959-sage.v2-rebased.patch) by jdemeyer created at 2011-11-03 16:14:43\n\nMilestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11787",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11787#issuecomment-134650",
    "user": "jdemeyer"
}
```

Attachment [trac_11959-sage.v2-rebased.patch](tarball://root/attachments/some-uuid/ticket11959/trac_11959-sage.v2-rebased.patch) by jdemeyer created at 2011-11-03 16:14:43

Milestone sage-4.7.3 deleted
