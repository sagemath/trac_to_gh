# Issue 32794: add tolerance to is_hermitian() for sparse "double" matrices

archive/issues_032794.json:
```json
{
    "body": "CC:  @collares @kliem\n\nDiscovered in #33023, the implementation of `is_hermitian()` for sparse double matrices is the generic one that tests equality of entries, and can fail due to numerical imprecision.\n\nWe already have an `is_hermitian()` for DENSE double matrices, but it is not used for the sparse class, which is its sibling and not a child. A quick way to fix this is to implement the \"naive\" version from the sense class in the sparse class. But a better solution might be to move the \"naive\" algorithm for dense matrices up into the superclass, and just allow the generic method to take a tolerance. If that's stable, it would allow us to avoid reimplementing `is_hermitian()` three times.\n\nIssue created by migration from https://trac.sagemath.org/ticket/33031\n\n",
    "created_at": "2021-12-16T12:33:50Z",
    "labels": [
        "component: linear algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "add tolerance to is_hermitian() for sparse \"double\" matrices",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32794",
    "user": "https://github.com/orlitzky"
}
```
CC:  @collares @kliem

Discovered in #33023, the implementation of `is_hermitian()` for sparse double matrices is the generic one that tests equality of entries, and can fail due to numerical imprecision.

We already have an `is_hermitian()` for DENSE double matrices, but it is not used for the sparse class, which is its sibling and not a child. A quick way to fix this is to implement the "naive" version from the sense class in the sparse class. But a better solution might be to move the "naive" algorithm for dense matrices up into the superclass, and just allow the generic method to take a tolerance. If that's stable, it would allow us to avoid reimplementing `is_hermitian()` three times.

Issue created by migration from https://trac.sagemath.org/ticket/33031





---

archive/issue_comments_467104.json:
```json
{
    "body": "This also needs to take into account cases with entries such as RBF and CBF, RIF amd CIF.",
    "created_at": "2021-12-16T13:20:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32794",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32794#issuecomment-467104",
    "user": "https://github.com/dimpase"
}
```

This also needs to take into account cases with entries such as RBF and CBF, RIF amd CIF.



---

archive/issue_comments_467105.json:
```json
{
    "body": "Replying to [comment:2 dimpase]:\n> This also needs to take into account cases with entries such as RBF and CBF, RIF amd CIF.\n\n\n`is_hermitian()` already fails on `RBF` and `RIF` matrices for want of a `conjugate()` method...",
    "created_at": "2021-12-16T13:34:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32794",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32794#issuecomment-467105",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:2 dimpase]:
> This also needs to take into account cases with entries such as RBF and CBF, RIF amd CIF.


`is_hermitian()` already fails on `RBF` and `RIF` matrices for want of a `conjugate()` method...



---

archive/issue_comments_467106.json:
```json
{
    "body": "Here's a proof-of-concept that attempts to fix sparse RDF/CDF without breaking anything else.\n\n---\nNew commits:",
    "created_at": "2021-12-16T15:51:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32794",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32794#issuecomment-467106",
    "user": "https://github.com/orlitzky"
}
```

Here's a proof-of-concept that attempts to fix sparse RDF/CDF without breaking anything else.

---
New commits:



---

archive/issue_comments_467107.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-12-20T22:06:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32794",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32794#issuecomment-467107",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_467108.json:
```json
{
    "body": "I've also fixed `is_skew_hermitian()`, since doing so is trivial. First things first: can someone confirm that my tolerance of `1e-12` is large enough to avoid the issue on aarch64 (or wherever the problem was observed)?\n\nThis is only a minimal refactoring to address the immediate problem. I've opened #33053 to track the larger issue.",
    "created_at": "2021-12-20T22:16:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32794",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32794#issuecomment-467108",
    "user": "https://github.com/orlitzky"
}
```

I've also fixed `is_skew_hermitian()`, since doing so is trivial. First things first: can someone confirm that my tolerance of `1e-12` is large enough to avoid the issue on aarch64 (or wherever the problem was observed)?

This is only a minimal refactoring to address the immediate problem. I've opened #33053 to track the larger issue.



---

archive/issue_comments_467109.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-12-20T22:16:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32794",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32794#issuecomment-467109",
    "user": "https://github.com/orlitzky"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_467110.json:
```json
{
    "body": "The test runs a little further, but fails after the `change_ring` call:\n\n```\nsage: n = ZZ.random_element(1,5)\n....: A = matrix.random(CDF, n, sparse=True)\n....: I = matrix.identity(CDF, n, sparse=True)\n....: A = A*A.conjugate_transpose() + I\n....: L = A.cholesky()\n....: assert (A - L*L.H).norm(1) < 1e-10\n....: B = A.change_ring(CC)\n....: assert (B.cholesky() - L).norm(1) < 1e-10\n....: \n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-4-193612c9eade> in <module>\n      6 assert (A - L*L.H).norm(Integer(1)) < RealNumber('1e-10')\n      7 B = A.change_ring(CC)\n----> 8 assert (B.cholesky() - L).norm(Integer(1)) < RealNumber('1e-10')\n\n/nix/store/zqyv54wwjaal14k1skabdk9ch6rr6v6r-python3-3.9.6-env/lib/python3.9/site-packages/sage/matrix/matrix2.pyx in sage.matrix.matrix2.Matrix.cholesky (build/cythonized/sage/matrix/matrix2.c:84977)()\n  12631 \n  12632         if not self.is_hermitian():\n> 12633             raise ValueError(\"matrix is not Hermitian\")\n  12634 \n  12635         # Use classical=True to ensure that we don't get a permuted L.\n\nValueError: matrix is not Hermitian\nsage: A\n[ 3.229039802593019 + 1.6322627083148353e-17*I  -0.021330037612755842 - 1.3824367515761828*I    0.18142736612755045 + 0.5825316936751774*I]\n[ -0.021330037612755842 + 1.3824367515761828*I 4.0201724676288855 - 1.6208942612402586e-17*I    -0.2251207850381418 - 1.1919564519572095*I]\n[   0.18142736612755045 - 0.5825316936751775*I    -0.2251207850381418 + 1.1919564519572095*I  1.9658297004722771 - 2.185885234400264e-17*I]\nsage: B\n[3.22903980259302 + 1.63226270831484e-17*I  -0.0213300376127558 - 1.38243675157618*I   0.181427366127550 + 0.582531693675177*I]\n[ -0.0213300376127558 + 1.38243675157618*I 4.02017246762889 - 1.62089426124026e-17*I   -0.225120785038142 - 1.19195645195721*I]\n[  0.181427366127550 - 0.582531693675178*I   -0.225120785038142 + 1.19195645195721*I 1.96582970047228 - 2.18588523440026e-17*I]\n```\n\nThis does not seem to be due to the tolerance, though, because `(B - B.H).norm(1)` is `1.5474000715052094e-16`.",
    "created_at": "2021-12-21T19:11:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32794",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32794#issuecomment-467110",
    "user": "https://github.com/collares"
}
```

The test runs a little further, but fails after the `change_ring` call:

```
sage: n = ZZ.random_element(1,5)
....: A = matrix.random(CDF, n, sparse=True)
....: I = matrix.identity(CDF, n, sparse=True)
....: A = A*A.conjugate_transpose() + I
....: L = A.cholesky()
....: assert (A - L*L.H).norm(1) < 1e-10
....: B = A.change_ring(CC)
....: assert (B.cholesky() - L).norm(1) < 1e-10
....: 
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-4-193612c9eade> in <module>
      6 assert (A - L*L.H).norm(Integer(1)) < RealNumber('1e-10')
      7 B = A.change_ring(CC)
----> 8 assert (B.cholesky() - L).norm(Integer(1)) < RealNumber('1e-10')

/nix/store/zqyv54wwjaal14k1skabdk9ch6rr6v6r-python3-3.9.6-env/lib/python3.9/site-packages/sage/matrix/matrix2.pyx in sage.matrix.matrix2.Matrix.cholesky (build/cythonized/sage/matrix/matrix2.c:84977)()
  12631 
  12632         if not self.is_hermitian():
> 12633             raise ValueError("matrix is not Hermitian")
  12634 
  12635         # Use classical=True to ensure that we don't get a permuted L.

ValueError: matrix is not Hermitian
sage: A
[ 3.229039802593019 + 1.6322627083148353e-17*I  -0.021330037612755842 - 1.3824367515761828*I    0.18142736612755045 + 0.5825316936751774*I]
[ -0.021330037612755842 + 1.3824367515761828*I 4.0201724676288855 - 1.6208942612402586e-17*I    -0.2251207850381418 - 1.1919564519572095*I]
[   0.18142736612755045 - 0.5825316936751775*I    -0.2251207850381418 + 1.1919564519572095*I  1.9658297004722771 - 2.185885234400264e-17*I]
sage: B
[3.22903980259302 + 1.63226270831484e-17*I  -0.0213300376127558 - 1.38243675157618*I   0.181427366127550 + 0.582531693675177*I]
[ -0.0213300376127558 + 1.38243675157618*I 4.02017246762889 - 1.62089426124026e-17*I   -0.225120785038142 - 1.19195645195721*I]
[  0.181427366127550 - 0.582531693675178*I   -0.225120785038142 + 1.19195645195721*I 1.96582970047228 - 2.18588523440026e-17*I]
```

This does not seem to be due to the tolerance, though, because `(B - B.H).norm(1)` is `1.5474000715052094e-16`.



---

archive/issue_comments_467111.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-21T20:42:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32794",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32794#issuecomment-467111",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_467112.json:
```json
{
    "body": "Replying to [comment:9 gh-collares]:\n> The test runs a little further, but fails after the `change_ring` call:\n> \n\n\nArgh, of course, you're now hitting the same problem over `RR` and `CC`, which we use to check the answer. Thankfully those aren't crucial to the process. I just pushed another commit that checks the answer against the dense RDF/CDF factorization instead, which will use a different but supposedly stable `is_hermitian()`, but the same `cholesky()` that we had with RR/CC.",
    "created_at": "2021-12-21T20:44:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32794",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32794#issuecomment-467112",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:9 gh-collares]:
> The test runs a little further, but fails after the `change_ring` call:
> 


Argh, of course, you're now hitting the same problem over `RR` and `CC`, which we use to check the answer. Thankfully those aren't crucial to the process. I just pushed another commit that checks the answer against the dense RDF/CDF factorization instead, which will use a different but supposedly stable `is_hermitian()`, but the same `cholesky()` that we had with RR/CC.



---

archive/issue_comments_467113.json:
```json
{
    "body": "`matrix_double_sparse.pyx` passes now. Thanks!",
    "created_at": "2021-12-21T22:02:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32794",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32794#issuecomment-467113",
    "user": "https://github.com/collares"
}
```

`matrix_double_sparse.pyx` passes now. Thanks!



---

archive/issue_comments_467114.json:
```json
{
    "body": "I would have kept `skew = False` as the default.\n\n```\n-    def _is_hermitian(self, skew = False):\n+    def _is_hermitian(self, skew, tolerance):\n```",
    "created_at": "2021-12-23T10:40:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32794",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32794#issuecomment-467114",
    "user": "https://github.com/dimpase"
}
```

I would have kept `skew = False` as the default.

```
-    def _is_hermitian(self, skew = False):
+    def _is_hermitian(self, skew, tolerance):
```



---

archive/issue_comments_467115.json:
```json
{
    "body": "maybe a default for tolerance may be set, too.",
    "created_at": "2021-12-23T15:56:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32794",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32794#issuecomment-467115",
    "user": "https://github.com/dimpase"
}
```

maybe a default for tolerance may be set, too.



---

archive/issue_comments_467116.json:
```json
{
    "body": "Replying to [comment:13 dimpase]:\n> I would have kept `skew = False` as the default.\n> \n> ```\n> -    def _is_hermitian(self, skew = False):\n> +    def _is_hermitian(self, skew, tolerance):\n> ```\n\n\nThis is mainly a style choice since it's an internal function and users won't be annoyed by the extra parameter. I think it's kind of nice to see the symmetry/contrast between uses of the internal function in the user-facing ones. i.e.:\n\n```python\n# in the superclass\ndef is_hermitian(self):\n    return self._is_hermitian(skew=False, tolerance=0)\ndef is_skew_hermitian(self):\n    return self._is_hermitian(skew=True, tolerance=0)\n# in the subclass\ndef is_hermitian(self, tolerance=1e-12):\n    return self._is_hermitian(skew=False, tolerance=tolerance)\ndef is_skew_hermitian(self, tolerance=1e-12):\n    return self._is_hermitian(skew=True, tolerance=tolerance)\n```\n\nThe user-facing method always knows the value of the `skew` parameter, so there's never any real need to \"default\" it. Doing so would only save a total of five characters. The tolerance parameter is similar... a default of zero would work now, but would be superfluous when we finish making the tolerance (in the superclass) user-facing in #33053.",
    "created_at": "2021-12-24T12:56:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32794",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32794#issuecomment-467116",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:13 dimpase]:
> I would have kept `skew = False` as the default.
> 
> ```
> -    def _is_hermitian(self, skew = False):
> +    def _is_hermitian(self, skew, tolerance):
> ```


This is mainly a style choice since it's an internal function and users won't be annoyed by the extra parameter. I think it's kind of nice to see the symmetry/contrast between uses of the internal function in the user-facing ones. i.e.:

```python
# in the superclass
def is_hermitian(self):
    return self._is_hermitian(skew=False, tolerance=0)
def is_skew_hermitian(self):
    return self._is_hermitian(skew=True, tolerance=0)
# in the subclass
def is_hermitian(self, tolerance=1e-12):
    return self._is_hermitian(skew=False, tolerance=tolerance)
def is_skew_hermitian(self, tolerance=1e-12):
    return self._is_hermitian(skew=True, tolerance=tolerance)
```

The user-facing method always knows the value of the `skew` parameter, so there's never any real need to "default" it. Doing so would only save a total of five characters. The tolerance parameter is similar... a default of zero would work now, but would be superfluous when we finish making the tolerance (in the superclass) user-facing in #33053.



---

archive/issue_comments_467117.json:
```json
{
    "body": "ok",
    "created_at": "2021-12-24T14:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32794",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32794#issuecomment-467117",
    "user": "https://github.com/dimpase"
}
```

ok



---

archive/issue_comments_467118.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-24T14:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32794",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32794#issuecomment-467118",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_087285.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-01-01T00:23:22Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32794",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32794#event-87285"
}
```



---

archive/issue_comments_467119.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-01-01T00:23:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32794",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32794#issuecomment-467119",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
