# Issue 12343: Make mpc a standard package

Issue created by migration from https://trac.sagemath.org/ticket/12515

Original creator: jdemeyer

Original creation time: 2012-02-15 13:18:11

Assignee: tbd

CC:  jpflori leif

Since `gcc-4.6.2` has `mpc` as dependency and since `mpc` could be useful for the rest of Sage, it would be good to include mpc as standard package.  There already is an optional `mpc` package.


---

Comment by strogdon created at 2012-02-16 01:54:45

I've tested just the patch from #12223, the [12515_mpc_standard](http://trac.sagemath.org/sage_trac/attachment/ticket/12515/12515_mpc_standard.patch) patch and the install of [mpc-0.9.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/mpc-0.9.spkg) on top of sage-5.0.beta4. I have one failure:


```
sage -t -long  -force_lib devel/sage-main/sage/rings/complex_mpc.pyx
**********************************************************************
File "/storage/sage/sage-5.0.beta4/devel/sage-main/sage/rings/complex_mpc.pyx", line 559:
    sage: MPComplexField(10).random_element()
Expected:
    0.12 + 0.23*I
Got:
    0.75 + 0.12*I
**********************************************************************
```

The relevant portions of the test from complex_mpc.pyx are:


```
sage: from sage.rings.complex_mpc import MPComplexField
sage: MPComplexField(100).random_element(-5, 10)
sage: MPComplexField(10).random_element()
```

which, from the sage prompt give results that are all over the place, although there is only the indicated failure when the test is repeatedly run individually. I'm not sure how one really knows what the "expected" result really is? Now this was on x86.


---

Attachment


---

Attachment

I marked those tests "# random" since they obviously are...


---

Comment by strogdon created at 2012-02-17 23:49:08

I just completed a build from scratch of 5.0.beta4 with mpc-0.9 just prior to the spkg upgrade. Argh ... So I patched the sage and sage_scripts spkgs before the build. SAGE_ROOT was then patched before the make. Everything from #10492 and #12223 and this ticket was included. Everything built (including mpc) and the tests passed. The new spkg (mpc-1.0.0dev1123) was installed with sage -f and all the tests under sage/rings passed - I only did these again. A positive review here, although I don't see that that's the next action?


---

Comment by jdemeyer created at 2012-02-18 09:19:30

There are still some portability problems that I'm discussing with upstream.  It doesn't build on Solaris with GCC (it does build with Sun's compiler).


---

Attachment


---

Comment by jdemeyer created at 2012-02-22 13:18:24

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2012-02-22 13:18:24

Issues seem to be fixed in the latest svn version, needs review.


---

Comment by strogdon created at 2012-02-23 23:19:16

A fresh build of 5.0.beta5 with the patches from this ticket and #10492. I have the failure


```

sage -t -long  -force_lib devel/sage-main/sage/geometry/fan.py
**********************************************************************
File "/storage/sage/sage-5.0.beta5/devel/sage-main/sage/geometry/fan.py", line 2779:
    sage: fan.complex().homology()
Expected:
    {0: 0, 1: 0, 2: Z x Z, 3: 0}
Got:
    {2: Z x Z, 3: 0}
**********************************************************************
File "/storage/sage/sage-5.0.beta5/devel/sage-main/sage/geometry/fan.py", line 2783:
    sage: fan.complex().homology()
Expected:
    {0: 0, 1: 0, 2: Z, 3: 0}
Got:
    {2: Z, 3: 0}
**********************************************************************
```

presumably because of #11384. The results for #11384 were positive, so I'm wondering if this ticket is interacting with it?


---

Comment by jdemeyer created at 2012-02-24 08:00:05

Replying to [comment:13 strogdon]:
> The results for #11384 were positive, so I'm wondering if this ticket is interacting with it?
That would be quite unlikely.  Try removing just the patch from this ticket and test `sage/geometry/fan.py` again.


---

Comment by jpflori created at 2012-02-24 10:58:27

#11805 can be closed as won't fix/duplicate once this gets merged.

Also we might think of using mpc for our default complex numbers representation, although that's a different question.


---

Comment by jpflori created at 2012-02-24 11:09:30

About the CFLAGS, CC stuff you could add some logic as in the mpir package.

This would let the user break its system if he really wants to.

You could also add the "SAGE... undefined on top of spkg-check.

If at some point we allow to run the testsuite without rebuilding the package, it would avoid another trivial new spkg update.

Not sure why you removed the error message in spg-check.

Ok, MPC will already complain about failing, but it will also do so while building, configuring and so on, won't it?


---

Comment by jdemeyer created at 2012-02-24 14:54:57

Replying to [comment:16 jpflori]:
> About the CFLAGS, CC stuff you could add some logic as in the mpir package.
I see little need for this.  Since mpc will use the same flags as mpir by default, why copy all that logic to mpc?


---

Comment by jdemeyer created at 2012-02-24 14:57:01

Diff for the mpc spkg (w.r.t. the latest optional mpc spkg), for review only


---

Attachment

Replying to [comment:16 jpflori]:
> You could also add the "SAGE... undefined on top of spkg-check.
Done.

> Not sure why you removed the error message in spg-check.
I thought it was superfluous, but it doesn't hurt.  So I put it back.


---

Comment by jpflori created at 2012-02-24 15:06:44

For the CC, CFLAGS stuff we could imagine that someone wants to test  MPC with different flags from mpir. You could argue that if that's the  case, it should be done outside Sage, or that the user is smart enough  to modify the spkg. Anyhow, I agree that this should not prevent  positive review.

I cannot test the spkg on exotic architectures, i.e. mainly Solaris, so that I don't put it as positive review.

Otherwise the package looks fine for me now, so  Jeroen, if you tested it on such architectures, you can go ahead and do it.


---

Comment by jdemeyer created at 2012-02-24 15:12:28

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-02-24 15:12:28

Replying to [comment:19 jpflori]:
> I cannot test the spkg on exotic architectures, i.e. mainly Solaris, so that I don't put it as positive review.

Jean-Pierre, it is never a requirement to test spkgs on "exotic architectures" in order to give positive review to a ticket (unless the ticket is specifically about fixing something on such an architecture).  If there are problems with building a spkg, those will be discovered when the build is tested on the buildbots.  I think reviewing should be mostly about human eyes looking at the patch, as that part can't be automated.


---

Comment by strogdon created at 2012-02-24 20:38:25

Replying to [comment:14 jdemeyer]:

> Replying to [comment:13 strogdon]:
> > The results for #11384 were positive, so I'm wondering if this ticket is interacting with it?
> That would be quite unlikely.  Try removing just the patch from this ticket and test `sage/geometry/fan.py` again.

Sorry for the delay. I had other stuff applied on top of mpc (twisted, jmol, flask) and it wasn't convenient to remove things. I didn't think it was the patches, but perhaps the mpc spkg. A build of just 5.0.beta5 with nothing else still produces the failure. So that belongs somewhere, but not this ticket.


---

Comment by SimonKing created at 2012-03-13 15:10:34

I tried to apply 12515_mpc_sage_root.patch to the root directory, but it failed.

I started with sage-5.0.beta7 and have

```
simon@linux-sqwp:~/SAGE/sage-5.0.beta7> hg qpush
Wende 12515_mpc_sage_root.patch an
Wende Patch auf Datei spkg/install an
FEHLSCHLAG von Teilstück #1 in Zeile 179
1 von 1 Teilstücken sind FEHLGESCHLAGEN -- speichere Ausschuss in Datei spkg/install.rej
Patch schlug fehl und Fortsetzung unmöglich (versuche -v)
Patch schlug fehl, Fehlerabschnitte noch im Arbeitsverzeichnis
Fehler beim Anwenden. Bitte beheben und 12515_mpc_sage_root.patch aktualisieren
simon@linux-sqwp:~/SAGE/sage-5.0.beta7> hg qapplied 
12602_spkg_download.patch
10492_deps_to_Makefile.patch
12515_mpc_sage_root.patch
```

Indeed, the spkg/install file looks totally different to what is expected in the patch:

```
...
MAXIMA=`$newest maxima`
export MAXIMA

MERCURIAL=`$newest mercurial`
export MERCURIAL

MPFI=`$newest mpfi`
export MPFI

MOIN=`$newest moin`
export MOIN

MPFR=`$newest mpfr`
export MPFR

MPMATH=`$newest mpmath`
export MPMATH

NETWORKX=`$newest networkx`
export NETWORKX

NUMPY=`$newest numpy`
export NUMPY
...
```


Is there a dependency that is not stated here?


---

Comment by SimonKing created at 2012-03-13 15:13:06

Oops!! Me stupid!! I had a totally wrong version of the patch from #10429 (namely the attachment, not the raw attachment.

Cheers,
Simon


---

Comment by jdemeyer created at 2012-03-22 16:36:04

This doesn't compile on rosemary (RHEL 5.6 x86_64).  I'm investigating further.


---

Comment by jdemeyer created at 2012-03-22 16:36:04

Changing status from positive_review to needs_work.


---

Comment by jhpalmieri created at 2012-03-22 22:40:33

I'm having problems on the skynet machines cleo and iras (ia64), also.  Using the full tarball from #12369, I'm getting failures with `SAGE_INSTALL_GCC=yes` and with it unset.


---

Comment by jdemeyer created at 2012-03-23 07:57:49

I discovered that _removing_ the flags `-std=c99 -pedantic` makes the problem disappear.  I cannot explain why though.


---

Comment by jdemeyer created at 2012-03-23 08:36:14

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-03-23 08:36:14

New spkg removes the -std=c99 -pedantic compiler flags.  I really cannot explain why it solves the problem though, especially since it seems to be a link issue:

```
/bin/sh ../libtool --tag=CC   --mode=link gcc  -O2 -D_FORTIFY_SOURCE=2 -g -std=c99 -pedantic -Wno-long-long -Wall -Wextra -Wdeclaration-af
ter-statement -Wundef -Wshadow -Wstrict-prototypes -Wmissing-prototypes -Wno-unused-value  -version-info 2:0:0 -L/home/buildbot/build/sage
/cleo-1/cleo_full/build/sage-5.0.beta8-gcc/local/lib -L/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-5.0.beta8-gcc/local/lib  -o l
ibmpc.la -rpath /home/buildbot/build/sage/cleo-1/cleo_full/build/sage-5.0.beta8-gcc/local/lib abs.lo acos.lo acosh.lo add.lo add_fr.lo add
_si.lo add_ui.lo arg.lo asin.lo asinh.lo atan.lo atanh.lo clear.lo cmp.lo cmp_si_si.lo conj.lo cos.lo cosh.lo div_2exp.lo div.lo div_fr.lo
 div_ui.lo exp.lo fma.lo fr_div.lo fr_sub.lo get_prec2.lo get_prec.lo get_version.lo get_x.lo imag.lo init2.lo init3.lo inp_str.lo log.lo
mem.lo mul_2exp.lo mul.lo mul_fr.lo mul_i.lo mul_si.lo mul_ui.lo neg.lo norm.lo out_str.lo pow.lo pow_fr.lo pow_ld.lo pow_d.lo pow_si.lo p
ow_ui.lo pow_z.lo proj.lo real.lo urandom.lo set.lo set_prec.lo set_str.lo set_x.lo set_x_x.lo sin.lo sin_cos.lo sinh.lo sqr.lo sqrt.lo st
rtoc.lo sub.lo sub_fr.lo sub_ui.lo swap.lo tan.lo tanh.lo uceil_log2.lo ui_div.lo ui_ui_sub.lo  -lmpfr -lgmp -lm
libtool: link: gcc -shared  -fPIC -DPIC  .libs/abs.o .libs/acos.o .libs/acosh.o .libs/add.o .libs/add_fr.o .libs/add_si.o .libs/add_ui.o .
libs/arg.o .libs/asin.o .libs/asinh.o .libs/atan.o .libs/atanh.o .libs/clear.o .libs/cmp.o .libs/cmp_si_si.o .libs/conj.o .libs/cos.o .lib
s/cosh.o .libs/div_2exp.o .libs/div.o .libs/div_fr.o .libs/div_ui.o .libs/exp.o .libs/fma.o .libs/fr_div.o .libs/fr_sub.o .libs/get_prec2.
o .libs/get_prec.o .libs/get_version.o .libs/get_x.o .libs/imag.o .libs/init2.o .libs/init3.o .libs/inp_str.o .libs/log.o .libs/mem.o .lib
s/mul_2exp.o .libs/mul.o .libs/mul_fr.o .libs/mul_i.o .libs/mul_si.o .libs/mul_ui.o .libs/neg.o .libs/norm.o .libs/out_str.o .libs/pow.o .
libs/pow_fr.o .libs/pow_ld.o .libs/pow_d.o .libs/pow_si.o .libs/pow_ui.o .libs/pow_z.o .libs/proj.o .libs/real.o .libs/urandom.o .libs/set
.o .libs/set_prec.o .libs/set_str.o .libs/set_x.o .libs/set_x_x.o .libs/sin.o .libs/sin_cos.o .libs/sinh.o .libs/sqr.o .libs/sqrt.o .libs/
strtoc.o .libs/sub.o .libs/sub_fr.o .libs/sub_ui.o .libs/swap.o .libs/tan.o .libs/tanh.o .libs/uceil_log2.o .libs/ui_div.o .libs/ui_ui_sub
.o   -Wl,-rpath -Wl,/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-5.0.beta8-gcc/local/lib -Wl,-rpath -Wl,/home/buildbot/build/sage
/cleo-1/cleo_full/build/sage-5.0.beta8-gcc/local/lib -L/home/buildbot/build/sage/cleo-1/cleo_full/build/sage-5.0.beta8-gcc/local/lib /home
/buildbot/build/sage/cleo-1/cleo_full/build/sage-5.0.beta8-gcc/local/lib/libmpfr.so /home/buildbot/build/sage/cleo-1/cleo_full/build/sage-
5.0.beta8-gcc/local/lib/libgmp.so -lm  -O2   -Wl,-soname -Wl,libmpc.so.2 -o .libs/libmpc.so.2.0.0
.libs/acos.o: In function `realpath':
/usr/include/bits/stdlib.h:33: multiple definition of `realpath'
.libs/abs.o:/usr/include/bits/stdlib.h:33: first defined here
.libs/acos.o: In function `ptsname_r':
/usr/include/bits/stdlib.h:49: multiple definition of `ptsname_r'
.libs/abs.o:/usr/include/bits/stdlib.h:49: first defined here
.libs/acos.o: In function `wctomb':
/usr/include/bits/stdlib.h:64: multiple definition of `wctomb'
.libs/abs.o:/usr/include/bits/stdlib.h:64: first defined here
.libs/acos.o: In function `mbstowcs':
/usr/include/bits/stdlib.h:89: multiple definition of `mbstowcs'
.libs/abs.o:/usr/include/bits/stdlib.h:89: first defined here
.libs/acos.o: In function `wcstombs':
/usr/include/bits/stdlib.h:110: multiple definition of `wcstombs'
.libs/abs.o:/usr/include/bits/stdlib.h:110: first defined here
[...]
```

Why does C99 code get linked differently from C89 code?


---

Comment by jdemeyer created at 2012-03-23 08:38:43

New spkg compiles successfully on iras and rosemary.


---

Comment by jdemeyer created at 2012-03-23 10:31:10

New spkg compiles successfully on bsd.math (OS X 10.6) with

```
i686-apple-darwin10-gcc-4.2.1 (GCC) 4.2.1 (Apple Inc. build 5666) (dot 3)
Copyright (C) 2007 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
```

and also with

```
Apple clang version 1.7 (tags/Apple/clang-77) (based on LLVM 2.9svn)
Target: x86_64-apple-darwin10
Thread model: posix
```



---

Comment by jdemeyer created at 2012-03-23 12:15:18

The problem is really due to -D_FORTIFY_SOURCE=2.  Removed that flag instead.


---

Comment by jdemeyer created at 2012-03-23 12:16:01

Diff for mpc-1.0.0dev1126.p1.spkg, for review only


---

Attachment


---

Comment by vbraun created at 2012-03-27 11:33:05

Looks good!


---

Comment by vbraun created at 2012-03-27 11:33:05

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-04-04 19:28:13

Resolution: fixed
