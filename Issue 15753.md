# Issue 15753: Python 3 preparation: Change syntax of raise statement

Issue created by migration from Trac.

Original creator: wluebbe

Original creation time: 2014-03-20 15:33:47

CC:  tscrim

Keywords: python3

Only the modern syntax like `raise E(V)` and `raise E(V).with_traceback(T)` is accepted by Python 3.

Almost all cases change `raise E, V` to `raise E(V)` where V is a string.

**TODO**: 
* Clarify why the cases `with_traceback` were omitted in `libfuturize/fixes/raise.py`. (Perhaps this belongs to //stage 2//?)

Changes according to `lib2to3/fixes/fix_raise.py`:

```
raise         -> raise
raise E       -> raise E
raise E, V    -> raise E(V)
raise E, V, T -> raise E(V).with_traceback(T)
raise E, None, T -> raise E.with_traceback(T)

raise (((E, E'), E_), E_'), V -> raise E(V)
raise "foo", V, T               -> warns about string exceptions

CAVEATS:
   "raise E, V" will be incorrectly translated if V is an exception
   instance. The correct Python 3 idiom is
       raise E from V
   but since we can't detect instance-hood by syntax alone and since
   any client code would have to be changed as well, we don't automate
   this.
```



---

Comment by wluebbe created at 2014-04-01 08:31:27

Changing status from new to needs_review.


---

Comment by wluebbe created at 2014-04-01 08:32:46

Failed doc test in sage.doctest.forker.SageDocTestRunner.report_unexpected_exception


---

Attachment

In more than 500 py modules the raise statement was (simply) changed to the new syntax.

All doctest succeeded but one (see attachment):

```
./sage -t -p --all --logfile=logs/ptestlong-15990l-2.log
...
----------------------------------------------------------------------
sage -t src/sage/doctest/forker.py  # 1 doctest failed
```


I have no idea why ...


---

Comment by wluebbe created at 2014-04-01 08:38:56

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-04-01 08:51:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ohanar created at 2014-04-02 17:19:06

If you can update the branch, I can maybe see if I can figure out what is going wrong in the forker.


---

Comment by git created at 2014-04-03 08:25:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by wluebbe created at 2014-04-03 08:27:00

Rebased on 6.2.beta6 and resolved merge conflicts.


---

Comment by ohanar created at 2014-04-03 15:59:43

It looks like it is just a bug in the doctest (it is testing the debugger, so the actual source code ends up being in the output to check).

Otherwise, looks good. (Hopefully this will get merged ASAP before it there are a ton of conflicts again).
----
New commits:


---

Comment by ohanar created at 2014-04-03 15:59:43

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2014-04-04 12:08:43


```
File "src/sage/combinat/designs/ext_rep.py", line 737, in sage.combinat.designs.ext_rep.XTree.__getitem__
Failed example:
    xt.__getitem__(119)
Expected:
    Traceback (most recent call last):
    ...
    IndexError: XTree<blocks> has no index 119
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.combinat.designs.ext_rep.XTree.__getitem__[4]>", line 1, in <module>
        xt.__getitem__(Integer(119))
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/combinat/designs/ext_rep.py", line 745, in __getitem__
        raise IndexError('%s no index %s' % (self.__repr__(), `i`))
    IndexError: XTree<blocks> no index 119
```



---

Comment by vbraun created at 2014-04-04 12:08:43

Changing status from positive_review to needs_work.


---

Comment by git created at 2014-04-04 14:01:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ohanar created at 2014-04-04 14:02:10

Changing status from needs_work to needs_review.


---

Comment by wluebbe created at 2014-04-04 14:26:00

Hi Andrew, I am 20 minutes late with the same fix. Thanks!
Fix resolves the above failure (tested OK!).

But my doctest `./sage -tp 4 --all --long >logs/sage-ptestlong-raise-0` had another failure:

```
File "src/sage/interfaces/expect.py", line 1017, in sage.interfaces.expect.Expect._expect_expr
Failed example:
    print sage0.eval("dummy=gp.eval('0'); alarm(1); gp._expect_expr('1')")  # long time
Expected:
    Control-C pressed.  Interrupting PARI/GP interpreter. Please wait a few seconds...
    ...
    AlarmInterrupt:
Got:
    Control-C pressed.  Interrupting PARI/GP interpreter. Please wait a few seconds...
    ---------------------------------------------------------------------------
    KeyboardInterrupt                         Traceback (most recent call last)
    <ipython-input-2-529203ce1422> in <module>()
    ----> 1 dummy=gp.eval('0'); alarm(Integer(Integer(1))); gp._expect_expr('1')
    <BLANKLINE>
    /home/wluebbe/sage-6.2.beta6/local/lib/python2.7/site-packages/sage/interfaces/expect.pyc in _expect_expr(self, expr, timeout)
       1050                 else:
       1051                     break
    -> 1052             raise KeyboardInterrupt(msg)
       1053 
       1054     def _sendstr(self, str):
    <BLANKLINE>
    KeyboardInterrupt:
**********************************************************************
```

The expectation `AlarmInterrupt:` was added by Jeroen in ticket:13311.

Am I the only one to see this failure?


---

Comment by git created at 2014-04-04 14:52:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by wluebbe created at 2014-04-04 15:05:35

Test passed for `expect.py`. Now starting `./sage -tp 4 --all --long >logs/sage-ptestlong-raise-4` to be sure.


---

Comment by tscrim created at 2014-04-04 15:12:15

(Because I want to know when I might have potential conflicts.)


---

Comment by wluebbe created at 2014-04-04 16:00:45

Changing status from needs_review to positive_review.


---

Comment by wluebbe created at 2014-04-04 16:00:45

Finally: All tests passed!
So it's positive.


---

Comment by vbraun created at 2014-04-04 18:58:16

Merge conflicts, you'll probably have to wait for the next beta and merge that in.


---

Comment by vbraun created at 2014-04-08 15:55:34

You can now merge in beta7


---

Comment by vbraun created at 2014-04-08 15:55:34

Changing status from positive_review to needs_work.


---

Comment by wluebbe created at 2014-04-09 09:23:44

After resolving merge conflicts still tests OK

```
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 2417.5 seconds
    cpu time: 8135.6 seconds
```

----
New commits:


---

Comment by wluebbe created at 2014-04-09 09:23:44

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2014-04-09 09:46:46

Conflicts again with #15148 and #11726 which I already merged after beta7


---

Comment by wluebbe created at 2014-04-09 13:07:31

I merged with ticket:15148 and ticket:11726 and tested.

Will it merge now :-/


---

Comment by vbraun created at 2014-04-09 13:48:58

Your branch doesn't exist...


---

Comment by git created at 2014-04-09 14:20:30

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. Last 10 new commits:


---

Comment by git created at 2014-04-09 14:20:30

Changing status from positive_review to needs_review.


---

Comment by wluebbe created at 2014-04-09 14:21:54

Aaargh! I didn't push ...


---

Comment by tscrim created at 2014-04-09 18:41:49

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2014-04-09 18:41:49

Merges cleanly.


---

Comment by vbraun created at 2014-04-09 19:41:04

Resolution: fixed
