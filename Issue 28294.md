# Issue 28294: bliss canonical labels ignores edge labels

archive/issues_028294.json:
```json
{
    "body": "CC:  @dcoudert\n\nWe consider below a path of 3 vertices. The two edges carry different labels. In particular it has no automorphism. Below bliss simply ignores the edge labels\n\n```\n\nsage: for algo in ['sage', 'bliss']:\n....:     G = Graph([(0,1,2),(0,2,1)])\n....:     H = Graph([(0,1,1),(1,2,2)])\n....:     Gcan, Gmap = G.canonical_label(edge_labels=True, certificate=True, algorithm=algo)\n....:     Hcan, Hmap = H.canonical_label(edge_labels=True, certificate=True, algorithm=algo)\n....:     print(sorted(Gcan.edges()) == sorted(Hcan.edges()))\nTrue\nFalse\n```\n\n(note: instead of comparing the sorted list of edges, one can alternatively set `weighted=True` in the constructors)\n\nIssue created by migration from https://trac.sagemath.org/ticket/28531\n\n",
    "created_at": "2019-09-23T17:28:58Z",
    "labels": [
        "component: graph theory",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "bliss canonical labels ignores edge labels",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28294",
    "user": "https://github.com/videlec"
}
```
CC:  @dcoudert

We consider below a path of 3 vertices. The two edges carry different labels. In particular it has no automorphism. Below bliss simply ignores the edge labels

```

sage: for algo in ['sage', 'bliss']:
....:     G = Graph([(0,1,2),(0,2,1)])
....:     H = Graph([(0,1,1),(1,2,2)])
....:     Gcan, Gmap = G.canonical_label(edge_labels=True, certificate=True, algorithm=algo)
....:     Hcan, Hmap = H.canonical_label(edge_labels=True, certificate=True, algorithm=algo)
....:     print(sorted(Gcan.edges()) == sorted(Hcan.edges()))
True
False
```

(note: instead of comparing the sorted list of edges, one can alternatively set `weighted=True` in the constructors)

Issue created by migration from https://trac.sagemath.org/ticket/28531





---

archive/issue_comments_399192.json:
```json
{
    "body": "By default, `bliss` use edge labels, but it's true we must pass the parameter from method `canonical_label` of `generic_graph.py`.\n\nMy understanding of what is done with bliss is:\n1. assign a unique id to each possible edge label. \n2. use method `bliss_graph_from_labelled_edges` to build a graph in which each label is modeled with a distinct gadget of vertices and edges.\n3. compute the canonical form of this modified graph\n4. extract edge labels corresponding to gadgets.\n\nWe have to check if these constructions are ok",
    "created_at": "2019-09-24T14:15:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28294#issuecomment-399192",
    "user": "https://github.com/dcoudert"
}
```

By default, `bliss` use edge labels, but it's true we must pass the parameter from method `canonical_label` of `generic_graph.py`.

My understanding of what is done with bliss is:
1. assign a unique id to each possible edge label. 
2. use method `bliss_graph_from_labelled_edges` to build a graph in which each label is modeled with a distinct gadget of vertices and edges.
3. compute the canonical form of this modified graph
4. extract edge labels corresponding to gadgets.

We have to check if these constructions are ok



---

archive/issue_comments_399193.json:
```json
{
    "body": "There is a brief description page 60 of the documentation of `nauty` (http://pallini.di.uniroma1.it/nug26.pdf).\nRoughly, a label is a color. If we have `2^d-1` colors, we make a new graph with n*d vertices, d copies of the vertices, and a path connecting the copies of vertex u. Then, if we have edge `(u, v, id)` in the original graph, we take id in binary and add an edge between the ith copy of u and v for each bit of id set to 1.   Then the automorphism group of the original graph is the action of the automorphism of the new graph on the first copies of the vertices.\n\nThe code is not nice, but so far I don't see obvious error...",
    "created_at": "2019-09-24T16:19:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28294#issuecomment-399193",
    "user": "https://github.com/dcoudert"
}
```

There is a brief description page 60 of the documentation of `nauty` (http://pallini.di.uniroma1.it/nug26.pdf).
Roughly, a label is a color. If we have `2^d-1` colors, we make a new graph with n*d vertices, d copies of the vertices, and a path connecting the copies of vertex u. Then, if we have edge `(u, v, id)` in the original graph, we take id in binary and add an edge between the ith copy of u and v for each bit of id set to 1.   Then the automorphism group of the original graph is the action of the automorphism of the new graph on the first copies of the vertices.

The code is not nice, but so far I don't see obvious error...



---

archive/issue_comments_399194.json:
```json
{
    "body": "I think that I identified at least one mistake for graphs (not oriented). The \"big graph\" encoding the edge colors has vertex set `V x {0, 1, ..., log(num labels)}` where `V` are the vertices of the original graph. Each `V x {i}` should be thought as a layer. Now, the encoding assumes that one can recognize the element in each layer with the actual set `V x {0, 1, ..., log(num labels)}`. To do so, one adds edges from `(v, i)` to `(v, i+1)`. However, this encoding does not make any difference between up and down (ie `0` and `log(num)`) since edges are not oriented. One simple fix is to add an extra vertex that links to all vertices of the layer `V x {0}`.\n\nI am fixing it now and cleaning the code (you are right: this code is a mess).",
    "created_at": "2019-10-18T03:36:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28294#issuecomment-399194",
    "user": "https://github.com/videlec"
}
```

I think that I identified at least one mistake for graphs (not oriented). The "big graph" encoding the edge colors has vertex set `V x {0, 1, ..., log(num labels)}` where `V` are the vertices of the original graph. Each `V x {i}` should be thought as a layer. Now, the encoding assumes that one can recognize the element in each layer with the actual set `V x {0, 1, ..., log(num labels)}`. To do so, one adds edges from `(v, i)` to `(v, i+1)`. However, this encoding does not make any difference between up and down (ie `0` and `log(num)`) since edges are not oriented. One simple fix is to add an extra vertex that links to all vertices of the layer `V x {0}`.

I am fixing it now and cleaning the code (you are right: this code is a mess).



---

archive/issue_comments_399195.json:
```json
{
    "body": "Much more dramatic: the edge labels of the graph are mapped to integers in a random fashion in `canonical_form` (the mapping depends on how the graph does its enumeration of edges). In particular, there is no way to guarantee that this mapping will be the same on distinct graphs with the same edge labels.\n\nIf we don't require the edge labels to form a total order I don't see how we can fix it.",
    "created_at": "2019-10-18T06:38:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28294#issuecomment-399195",
    "user": "https://github.com/videlec"
}
```

Much more dramatic: the edge labels of the graph are mapped to integers in a random fashion in `canonical_form` (the mapping depends on how the graph does its enumeration of edges). In particular, there is no way to guarantee that this mapping will be the same on distinct graphs with the same edge labels.

If we don't require the edge labels to form a total order I don't see how we can fix it.



---

archive/issue_comments_399196.json:
```json
{
    "body": "At least the attached branch does the job (for edge labels endowed with a total order).\n----\nNew commits:",
    "created_at": "2019-10-18T06:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28294#issuecomment-399196",
    "user": "https://github.com/videlec"
}
```

At least the attached branch does the job (for edge labels endowed with a total order).
----
New commits:



---

archive/issue_comments_399197.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-10-18T06:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28294#issuecomment-399197",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_399198.json:
```json
{
    "body": "This may fail with Python 3\n\n```diff\n+        lab_to_index = {lab:i for i,lab in enumerate(sorted(set(G.edge_labels())))}\n```\n\nEdge labels can be of different types, and so cannot always be sorted. I have no suitable solution for this issue :(",
    "created_at": "2019-10-18T07:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28294#issuecomment-399198",
    "user": "https://github.com/dcoudert"
}
```

This may fail with Python 3

```diff
+        lab_to_index = {lab:i for i,lab in enumerate(sorted(set(G.edge_labels())))}
```

Edge labels can be of different types, and so cannot always be sorted. I have no suitable solution for this issue :(



---

archive/issue_comments_399199.json:
```json
{
    "body": "I don't mind that it fails. The current code returns wrong answers in Python 2 which is much worse than failing.\n\nI see two solutions:\n- Store a universal list \"all objects in Sage up to equality\" -> \"integers\" which is nonsense. You seem to want that kind of feature in comment:6.\n- Use more or less what I wrote and specify in the function that canonical labels reaquires a total order on edge labels. I think it is better to raise an error when we detect that they are not. If the user has funny labels, she should provide a dictionary `labels -> integer` to the function. Inside `Graph.is_isomorphic` we can work around this issue easily since we have all labels in hand. In short\n  - `is_isomorphic` will work as usual\n  - `canonical_label` will work only if the edge labels can be totally sorted.\n\nIf solution 2 is acceptable to you I will polish the branch. If not I will add a stopgap to `canonical_label` when `edge_labels=True`.",
    "created_at": "2019-10-18T15:18:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28294#issuecomment-399199",
    "user": "https://github.com/videlec"
}
```

I don't mind that it fails. The current code returns wrong answers in Python 2 which is much worse than failing.

I see two solutions:
- Store a universal list "all objects in Sage up to equality" -> "integers" which is nonsense. You seem to want that kind of feature in comment:6.
- Use more or less what I wrote and specify in the function that canonical labels reaquires a total order on edge labels. I think it is better to raise an error when we detect that they are not. If the user has funny labels, she should provide a dictionary `labels -> integer` to the function. Inside `Graph.is_isomorphic` we can work around this issue easily since we have all labels in hand. In short
  - `is_isomorphic` will work as usual
  - `canonical_label` will work only if the edge labels can be totally sorted.

If solution 2 is acceptable to you I will polish the branch. If not I will add a stopgap to `canonical_label` when `edge_labels=True`.



---

archive/issue_comments_399200.json:
```json
{
    "body": "Let's go for solution 2. Don't forget to add a note explaining that.\n\nIf we want to add more freedom (do we really want that?), in case the sorting fail, we could try to work with the string representation of the labels....\n\nAlso, have you noticed that parameter `use_edge_labels` is not passed to methods in `bliss.pyx` by methods in `generic_graph.py` ?",
    "created_at": "2019-10-18T17:22:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28294#issuecomment-399200",
    "user": "https://github.com/dcoudert"
}
```

Let's go for solution 2. Don't forget to add a note explaining that.

If we want to add more freedom (do we really want that?), in case the sorting fail, we could try to work with the string representation of the labels....

Also, have you noticed that parameter `use_edge_labels` is not passed to methods in `bliss.pyx` by methods in `generic_graph.py` ?



---

archive/issue_comments_399201.json:
```json
{
    "body": "Replying to [comment:8 dcoudert]:\n> Let's go for solution 2. Don't forget to add a note explaining that.\n> \n> If we want to add more freedom (do we really want that?), in case the sorting fail, we could try to work with the string representation of the labels....\n\nTo me it sounds that it would be less freedom since the computer will perform something that you might not want. It is much better to raise an error in case of doubt that the user can fix by providing the relevant mapping `edge label -> integer`.\n\n> Also, have you noticed that parameter `use_edge_labels` is not passed to methods in `bliss.pyx` by methods in `generic_graph.py` ?\n\nNo. One more bug.",
    "created_at": "2019-10-19T01:29:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28294#issuecomment-399201",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:8 dcoudert]:
> Let's go for solution 2. Don't forget to add a note explaining that.
> 
> If we want to add more freedom (do we really want that?), in case the sorting fail, we could try to work with the string representation of the labels....

To me it sounds that it would be less freedom since the computer will perform something that you might not want. It is much better to raise an error in case of doubt that the user can fix by providing the relevant mapping `edge label -> integer`.

> Also, have you noticed that parameter `use_edge_labels` is not passed to methods in `bliss.pyx` by methods in `generic_graph.py` ?

No. One more bug.



---

archive/issue_comments_399202.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-10-22T05:56:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28294#issuecomment-399202",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_399203.json:
```json
{
    "body": "Ready for review.",
    "created_at": "2019-10-22T05:56:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28294#issuecomment-399203",
    "user": "https://github.com/videlec"
}
```

Ready for review.



---

archive/issue_comments_399204.json:
```json
{
    "body": "(I finally relied on string comparison when the edges are not hashable and sortable)",
    "created_at": "2019-10-22T05:57:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28294#issuecomment-399204",
    "user": "https://github.com/videlec"
}
```

(I finally relied on string comparison when the edges are not hashable and sortable)



---

archive/issue_comments_399205.json:
```json
{
    "body": "Seems OK. A few comments.\n\n\n```diff\n         Pnr = len(partition)\n-        for i in range(len(partition)):\n+        for i in range(Pnr):\n```\n\nand in the else block right after, no need to set `Pnr = 1` (not used).\n\nin `bliss_digraph_from_labelled_edges`, you could do the same modification as in `bliss_graph_from_labelled_edges` for the `# vertex partition gives colors` block, no ?\n\nin `canonical_form`\n\n```diff\n     else:\n-        for x,y,lab in G.edge_iterator(labels=True):\n+        for x,y in G.edge_iterator(labels=False):\n```\n",
    "created_at": "2019-10-22T07:24:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28294#issuecomment-399205",
    "user": "https://github.com/dcoudert"
}
```

Seems OK. A few comments.


```diff
         Pnr = len(partition)
-        for i in range(len(partition)):
+        for i in range(Pnr):
```

and in the else block right after, no need to set `Pnr = 1` (not used).

in `bliss_digraph_from_labelled_edges`, you could do the same modification as in `bliss_graph_from_labelled_edges` for the `# vertex partition gives colors` block, no ?

in `canonical_form`

```diff
     else:
-        for x,y,lab in G.edge_iterator(labels=True):
+        for x,y in G.edge_iterator(labels=False):
```




---

archive/issue_comments_399206.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-10-22T14:56:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28294#issuecomment-399206",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_399207.json:
```json
{
    "body": "done",
    "created_at": "2019-10-22T14:57:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28294#issuecomment-399207",
    "user": "https://github.com/videlec"
}
```

done



---

archive/issue_comments_399208.json:
```json
{
    "body": "Patchbot failures have nothing to do with the ticket changes...",
    "created_at": "2019-10-23T02:04:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28294#issuecomment-399208",
    "user": "https://github.com/videlec"
}
```

Patchbot failures have nothing to do with the ticket changes...



---

archive/issue_comments_399209.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-10-23T07:37:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28294#issuecomment-399209",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_399210.json:
```json
{
    "body": "LGTM.",
    "created_at": "2019-10-23T07:37:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28294#issuecomment-399210",
    "user": "https://github.com/dcoudert"
}
```

LGTM.



---

archive/issue_events_026206.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2019-10-26T22:20:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28294",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28294#event-26206"
}
```



---

archive/issue_comments_399211.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-10-26T22:20:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28294",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28294#issuecomment-399211",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
