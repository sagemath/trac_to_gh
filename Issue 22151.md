# Issue 22151: LatticePoset: Add congruence lattice

Issue created by migration from Trac.

Original creator: jmantysalo

Original creation time: 2017-02-16 19:51:03

CC:  ​mantepse tscrim

Add a function to compute the lattice of congruences.

This needs `principal_congruences_poset()` from #21861, easier to do after next beta.

Also add `is_regular` etc. to the index of functions.


---

Comment by jmantysalo created at 2017-02-26 09:21:17

The code has two dependencies. Waiting for next beta. Can be commentend already.


```
def congruences_lattice(self, labels='congruence'):
    r"""
    Return the lattice of congruences.

    A congruence of a lattice is a partition of elements to classes
    compatible with both meet- and join-operation; see :meth:`congruence`.
    Elements of the *congruence lattice* are congruences ordered by
    refinement; i.e. if every class of a congruence `\Theta` is
    contained in some class of `\Phi`, then `\Theta \le \Phi`
    in the congruence lattice.

    INPUT:

    - ``labels``, a string -- type of elements of resulting lattice

    OUTPUT:

    A distributive lattice.

    - If ``element_constructor='congruence'``, then elements of the
      result will be congruences given as
      :class:`sage.combinat.set_partition.SetPartition`.
    - If ``element_constructor='integers'``, result is a lattice on integers
      isomorphic to the congruence lattice.

    EXAMPLES::

        sage: N5 = Posets.PentagonPoset()
        sage: CL = N5.congruences_lattice(); CL
        Finite lattice containing 5 elements
        sage: CL.atoms()
        [{{0}, {1}, {2, 3}, {4}}]
        sage: CL.coatoms()
        [{{0, 1}, {2, 3, 4}}, {{0, 2, 3}, {1, 4}}]

        sage: C4 = Posets.ChainPoset(4)
        sage: CL = C4.congruences_lattice(element_constructor='integer')
        sage: CL.is_isomorphic(Posets.BooleanLattice(3))
        True

    TESTS::

        sage: Posets.ChainPoset(0).congruences_lattice()
        Finite lattice containing 1 elements
        sage: Posets.ChainPoset(1).congruences_lattice()
        Finite lattice containing 1 elements
        sage: Posets.ChainPoset(2).congruences_lattice()
        Finite lattice containing 2 elements
        sage: Posets.ChainPoset(3).congruences_lattice()
        Finite lattice containing 4 elements
    """
    # TODO: Read Computing Congruence Lattices Of Finite Lattices
    # by Ralph S. Freese. Understand it. Implement it.

    if labels not in ['integer', 'congruence']:
        raise ValueError("'label' must be 'integer' or 'congruence'")

    cong_ji, congs = self._hasse_diagram.principal_congruences_poset()

    # Form of the lattice of congruences can be computed much faster than
    # all congruences.
    if labels == 'integer':
        tmp = Poset(cong_ji).order_ideals_lattice(as_ideals=False)
        return tmp.relabel(tmp._element_to_vertex_dict)

    # To compute full lattice of congruences we "extend" already computed
    # parts of a congruence.
    L = cong_ji.order_ideals_lattice()
    C = {}
    C[Set()] = DisjointSet(self.cardinality())  # the bottom element
    for e in L:
        low = L.lower_covers(e)
        if len(low) == 1:  # a join-irreducible element
            C[e] = congs[max(e, key=lambda x: cong_ji._element_to_vertex(x))]
        if len(low) > 1:  # "extending" congruence to avoid re-computation
            for new_pair in e:
                if new_pair not in low[0]:
                    break
            # Remove copy() when 7.6beta5 is out
            C[e] = self._hasse_diagram.congruence([new_pair], start=copy(C[low[0]]))

    return L.relabel(lambda e: SetPartition([[self._vertex_to_element(v) for v in p] for p in C[e]]))
```



---

Comment by git created at 2017-02-26 21:50:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-02-27 03:50:03

Changing status from new to needs_review.


---

Comment by jmantysalo created at 2017-02-27 03:50:03

To test verify for example against result http://www.sciencedirect.com/science/article/pii/0012365X94900191


```
T = Posets.TamariLattice(5)
CT = T.congruences_lattice()
T.cardinality() == CT.cardinality() and T._hasse_diagram.size() == CT._hasse_diagram.size()
```



---

Comment by git created at 2017-03-06 07:11:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-03-13 16:41:17

Is there something I can do to make a review easier?


---

Comment by chapoton created at 2017-03-13 20:13:37

* "crusial" should be "crucial"

* "any of the congruence block" should be "any of the congruence blocks"

not a real review for the moment, sorry


---

Comment by git created at 2017-03-13 20:34:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-03-13 22:19:41

Little thing:

```diff
-- ``labels``, a string -- type of elements of resulting lattice
+- ``labels`` -- a string; the type of elements in the resulting lattice
```

Otherwise LGTM.


---

Comment by git created at 2017-03-14 05:03:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-03-14 05:30:44

Corrections suggested by Frédéric and Travis done.


---

Comment by chapoton created at 2017-03-18 08:11:57

ok, let it be. useful addition, thanks


---

Comment by chapoton created at 2017-03-18 08:11:57

Changing status from needs_review to positive_review.


---

Comment by jmantysalo created at 2017-03-18 18:18:30

Replying to [comment:13 chapoton]:
> ok, let it be. useful addition, thanks

Thanks.

There is still #22456 left for review. Then I want a function to check if a lattice is congruence normal (can be made from one-element lattice by Day's doubling constructions). I think that it will be the last one in this serie.


---

Comment by vbraun created at 2017-03-27 20:42:28

Resolution: fixed
