# Issue 11857: Fast conversion of ClonableIntArray to list

archive/issues_011857.json:
```json
{
    "body": "Assignee: sage-combinat\n\nCC:  sage-combinat nborie\n\nI think the following is too slow:\n\n```\nsage: from sage.structure.list_clone import IncreasingIntArrays\nsage: I = IncreasingIntArrays()(range(1000))\nsage: timeit(\"L = list(I)\", number=10000)\n10000 loops, best of 3: 41.8 \u00b5s per loop\n```\n\n\nMy patch adds a method `.list()` (I hope this is the fastest way of converting a C-int array into a Python list - Cython experts are welcome to find something better), and it adds an `__iter__()` method that relies on the `.list()` method.\n\nNote that I tried to have an `__iter__` method that does not call `list()` but works on the C-array (this is now possible with the new Cython version), but it turned out to be not faster.\n\nHere are the timings with my patch\n\n```\nsage: from sage.structure.list_clone import IncreasingIntArrays\nsage: I = IncreasingIntArrays()(range(1000))\nsage: timeit(\"L = I.list()\", number=10000)\n10000 loops, best of 3: 19.4 \u00b5s per loop\nsage: timeit(\"L = list(I)\", number=10000)\n10000 loops, best of 3: 32.9 \u00b5s per loop\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/12029\n\n",
    "created_at": "2011-11-14T15:30:32Z",
    "labels": [
        "combinatorics",
        "major",
        "enhancement"
    ],
    "title": "Fast conversion of ClonableIntArray to list",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11857",
    "user": "SimonKing"
}
```
Assignee: sage-combinat

CC:  sage-combinat nborie

I think the following is too slow:

```
sage: from sage.structure.list_clone import IncreasingIntArrays
sage: I = IncreasingIntArrays()(range(1000))
sage: timeit("L = list(I)", number=10000)
10000 loops, best of 3: 41.8 µs per loop
```


My patch adds a method `.list()` (I hope this is the fastest way of converting a C-int array into a Python list - Cython experts are welcome to find something better), and it adds an `__iter__()` method that relies on the `.list()` method.

Note that I tried to have an `__iter__` method that does not call `list()` but works on the C-array (this is now possible with the new Cython version), but it turned out to be not faster.

Here are the timings with my patch

```
sage: from sage.structure.list_clone import IncreasingIntArrays
sage: I = IncreasingIntArrays()(range(1000))
sage: timeit("L = I.list()", number=10000)
10000 loops, best of 3: 19.4 µs per loop
sage: timeit("L = list(I)", number=10000)
10000 loops, best of 3: 32.9 µs per loop
```


Issue created by migration from https://trac.sagemath.org/ticket/12029





---

archive/issue_comments_135742.json:
```json
{
    "body": "Hi Simon,\n\nA few remarks:\n\n- The `.list()` method is not a Python convention, it is a Sage-Combinat (and maybe Sage) convention. Isn't it ?\n\n- Since the new Cython allows it. Did you try to define an iterator (using yield) without relying on the list ? It could be faster.\n\n- Also I'm not sure using append to build the list is a good idea (due to possible reallocation). Si you know the list length from the beginning, why not allocation the list and filling it with a loop ? I'm not sure if it is doable optimally in Cython without using the C-API function `PyList_New` and the macro `PyList_SETITEM`.",
    "created_at": "2011-11-14T20:09:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11857#issuecomment-135742",
    "user": "hivert"
}
```

Hi Simon,

A few remarks:

- The `.list()` method is not a Python convention, it is a Sage-Combinat (and maybe Sage) convention. Isn't it ?

- Since the new Cython allows it. Did you try to define an iterator (using yield) without relying on the list ? It could be faster.

- Also I'm not sure using append to build the list is a good idea (due to possible reallocation). Si you know the list length from the beginning, why not allocation the list and filling it with a loop ? I'm not sure if it is doable optimally in Cython without using the C-API function `PyList_New` and the macro `PyList_SETITEM`.



---

archive/issue_comments_135743.json:
```json
{
    "body": "Replying to [comment:1 hivert]:\n> - The `.list()` method is not a Python convention, it is a Sage-Combinat (and maybe Sage) convention. Isn't it ?\n\nYes. But there are different places in Sage where `.list()` is used, and I think if there is a faster way to return a list than via an iterator then it should at least be offered.\n\n> - Since the new Cython allows it. Did you try to define an iterator (using yield) without relying on the list ? It could be faster.\n\nAs I stated in the ticket description: I did try, and it was not faster. To be concrete: Here is the code that I tested.\n\n```python\n    def __iter__(self):\n        \"\"\"\n        Iterate over the items of self.\n        ...\n        \"\"\"\n        cdef int i\n        for i from 0<=i<self._len:\n            yield self._list[i]\n```\n\nAnd here is the benchmark:\n\n```\nsage: from sage.structure.list_clone import IncreasingIntArrays\nsage: I = IncreasingIntArrays()(range(1000))\nsage: timeit(\"L = list(I)\", number=10000)\n10000 loops, best of 3: 34.3 \u00b5s per loop\n```\n\n \n> - Also I'm not sure using append to build the list is a good idea (due to possible reallocation).\n\nAppending to a list - if the list is cdefined - is a very quick operation in Cython.\n\n> Si you know the list length from the beginning, why not allocation the list and filling it with a loop ?\n\nCan one allocate a Python list without filling it?",
    "created_at": "2011-11-14T20:44:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11857#issuecomment-135743",
    "user": "SimonKing"
}
```

Replying to [comment:1 hivert]:
> - The `.list()` method is not a Python convention, it is a Sage-Combinat (and maybe Sage) convention. Isn't it ?

Yes. But there are different places in Sage where `.list()` is used, and I think if there is a faster way to return a list than via an iterator then it should at least be offered.

> - Since the new Cython allows it. Did you try to define an iterator (using yield) without relying on the list ? It could be faster.

As I stated in the ticket description: I did try, and it was not faster. To be concrete: Here is the code that I tested.

```python
    def __iter__(self):
        """
        Iterate over the items of self.
        ...
        """
        cdef int i
        for i from 0<=i<self._len:
            yield self._list[i]
```

And here is the benchmark:

```
sage: from sage.structure.list_clone import IncreasingIntArrays
sage: I = IncreasingIntArrays()(range(1000))
sage: timeit("L = list(I)", number=10000)
10000 loops, best of 3: 34.3 µs per loop
```

 
> - Also I'm not sure using append to build the list is a good idea (due to possible reallocation).

Appending to a list - if the list is cdefined - is a very quick operation in Cython.

> Si you know the list length from the beginning, why not allocation the list and filling it with a loop ?

Can one allocate a Python list without filling it?



---

archive/issue_comments_135744.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-11-14T20:44:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11857#issuecomment-135744",
    "user": "SimonKing"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_135745.json:
```json
{
    "body": "Replying to [comment:2 SimonKing]:\n\n> > - Since the new Cython allows it. Did you try to define an iterator (using yield) without relying on the list ? It could be faster.\n> \n> As I stated in the ticket description: I did try, and it was not faster. To be concrete: Here is the code that I tested.\n\nSorry I read it to fast !!!\n\n> > - Also I'm not sure using append to build the list is a good idea (due to possible reallocation).\n> \n> Appending to a list - if the list is cdefined - is a very quick operation in Cython.\n> \n> > Si you know the list length from the beginning, why not allocation the list and filling it with a loop ?\n> \n> Can one allocate a Python list without filling it?\n \nFrom the C-API you can do it. Of course you must fill it (at least with None(s)) before returning it to python. See\nhttp://docs.python.org/c-api/list.html and in particular the note after `PyList_New`. I don't know if it is doable directly in Cython without calling the C-API.\n\nFlorent",
    "created_at": "2011-11-14T21:23:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11857#issuecomment-135745",
    "user": "hivert"
}
```

Replying to [comment:2 SimonKing]:

> > - Since the new Cython allows it. Did you try to define an iterator (using yield) without relying on the list ? It could be faster.
> 
> As I stated in the ticket description: I did try, and it was not faster. To be concrete: Here is the code that I tested.

Sorry I read it to fast !!!

> > - Also I'm not sure using append to build the list is a good idea (due to possible reallocation).
> 
> Appending to a list - if the list is cdefined - is a very quick operation in Cython.
> 
> > Si you know the list length from the beginning, why not allocation the list and filling it with a loop ?
> 
> Can one allocate a Python list without filling it?
 
From the C-API you can do it. Of course you must fill it (at least with None(s)) before returning it to python. See
http://docs.python.org/c-api/list.html and in particular the note after `PyList_New`. I don't know if it is doable directly in Cython without calling the C-API.

Florent



---

archive/issue_comments_135746.json:
```json
{
    "body": "Replying to [comment:3 hivert]:\n> > Can one allocate a Python list without filling it?\n>  \n> From the C-API you can do it. Of course you must fill it (at least with None(s)) before returning it to python. See\n> http://docs.python.org/c-api/list.html and in particular the note after `PyList_New`. I don't know if it is doable directly in Cython without calling the C-API.\n\nHi Simon !\n\nSorry for replying to myself but I should have said from the very beginning\nthat I'm not a Cython expert ! I'm currently trying the `PyList_New`\nversion.\n\nFlorent",
    "created_at": "2011-11-14T21:36:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11857#issuecomment-135746",
    "user": "hivert"
}
```

Replying to [comment:3 hivert]:
> > Can one allocate a Python list without filling it?
>  
> From the C-API you can do it. Of course you must fill it (at least with None(s)) before returning it to python. See
> http://docs.python.org/c-api/list.html and in particular the note after `PyList_New`. I don't know if it is doable directly in Cython without calling the C-API.

Hi Simon !

Sorry for replying to myself but I should have said from the very beginning
that I'm not a Cython expert ! I'm currently trying the `PyList_New`
version.

Florent



---

archive/issue_comments_135747.json:
```json
{
    "body": "Replying to [comment:4 hivert]:\n> I'm currently trying the `PyList_New`\n> version.\n\nSo did I, but currently I am getting segfaults. I guess that is because the references produced by `PyList_SetItem` are borrowed.\n\nBest regards,\n\nSimon",
    "created_at": "2011-11-14T21:59:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11857#issuecomment-135747",
    "user": "SimonKing"
}
```

Replying to [comment:4 hivert]:
> I'm currently trying the `PyList_New`
> version.

So did I, but currently I am getting segfaults. I guess that is because the references produced by `PyList_SetItem` are borrowed.

Best regards,

Simon



---

archive/issue_comments_135748.json:
```json
{
    "body": "Replying to [comment:5 SimonKing]:\n> Replying to [comment:4 hivert]:\n> > I'm currently trying the `PyList_New`\n> > version.\n> \n> So did I, but currently I am getting segfaults. I guess that is because the references produced by `PyList_SetItem` are borrowed.\n\nSame problem here !!! :-)\n\nFlorent",
    "created_at": "2011-11-14T22:16:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11857#issuecomment-135748",
    "user": "hivert"
}
```

Replying to [comment:5 SimonKing]:
> Replying to [comment:4 hivert]:
> > I'm currently trying the `PyList_New`
> > version.
> 
> So did I, but currently I am getting segfaults. I guess that is because the references produced by `PyList_SetItem` are borrowed.

Same problem here !!! :-)

Florent



---

archive/issue_comments_135749.json:
```json
{
    "body": "Hi Simon,\n\nIf correct with respect to memory management, I uploaded a patch which when\napplied over yours gains some more speed:\n\nThis is before my patch:\n\n```\nsage: from sage.structure.list_clone import IncreasingIntArrays\nsage: I = IncreasingIntArrays()(range(1000))\nsage: timeit(\"L = I.list()\", number=10000)\n10000 loops, best of 3: 18.1 \u00b5s per loop\n```\n\n\nThis is after my patch:\n\n```\nsage: from sage.structure.list_clone import IncreasingIntArrays\nsage: I = IncreasingIntArrays()(range(1000))\nsage: timeit(\"L = I.list()\", number=10000)\n10000 loops, best of 3: 14 \u00b5s per loop\n```\n\n\nSo this is more 20 percents faster... After having a Cython expert check the\nreference counting stuff, this is probably worth including.\n\nWhat do you think ?\n\nCheers,\n\nFlorent",
    "created_at": "2011-11-14T22:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11857#issuecomment-135749",
    "user": "hivert"
}
```

Hi Simon,

If correct with respect to memory management, I uploaded a patch which when
applied over yours gains some more speed:

This is before my patch:

```
sage: from sage.structure.list_clone import IncreasingIntArrays
sage: I = IncreasingIntArrays()(range(1000))
sage: timeit("L = I.list()", number=10000)
10000 loops, best of 3: 18.1 µs per loop
```


This is after my patch:

```
sage: from sage.structure.list_clone import IncreasingIntArrays
sage: I = IncreasingIntArrays()(range(1000))
sage: timeit("L = I.list()", number=10000)
10000 loops, best of 3: 14 µs per loop
```


So this is more 20 percents faster... After having a Cython expert check the
reference counting stuff, this is probably worth including.

What do you think ?

Cheers,

Florent



---

archive/issue_comments_135750.json:
```json
{
    "body": "While you were posting here, I was asking on [sage-devel](http://groups.google.com/group/sage-devel/browse_thread/thread/61a6daff276a9e64), posting a code that was very similar to yours. Only difference: I did not use `o = PyInt_FromLong(self._list[i])`.\n\nInteresting that this is so fast. I need to catch some sleep now, however...",
    "created_at": "2011-11-14T22:59:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11857#issuecomment-135750",
    "user": "SimonKing"
}
```

While you were posting here, I was asking on [sage-devel](http://groups.google.com/group/sage-devel/browse_thread/thread/61a6daff276a9e64), posting a code that was very similar to yours. Only difference: I did not use `o = PyInt_FromLong(self._list[i])`.

Interesting that this is so fast. I need to catch some sleep now, however...



---

archive/issue_comments_135751.json:
```json
{
    "body": "Replying to [comment:8 SimonKing]:\n> While you were posting here, I was asking on [sage-devel](http://groups.google.com/group/sage-devel/browse_thread/thread/61a6daff276a9e64), posting a code that was very similar to yours. Only difference: I did not use `o = PyInt_FromLong(self._list[i])`.\n\nI just got confirmation (on cython-users) that INCREF is correct where I put it.  \n\n> Interesting that this is so fast. I need to catch some sleep now, however...\n\nMe too ! Sorry for not being around Paris just when you come.\n\nCheers,\n\nFlorent",
    "created_at": "2011-11-14T23:03:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11857#issuecomment-135751",
    "user": "hivert"
}
```

Replying to [comment:8 SimonKing]:
> While you were posting here, I was asking on [sage-devel](http://groups.google.com/group/sage-devel/browse_thread/thread/61a6daff276a9e64), posting a code that was very similar to yours. Only difference: I did not use `o = PyInt_FromLong(self._list[i])`.

I just got confirmation (on cython-users) that INCREF is correct where I put it.  

> Interesting that this is so fast. I need to catch some sleep now, however...

Me too ! Sorry for not being around Paris just when you come.

Cheers,

Florent



---

archive/issue_comments_135752.json:
```json
{
    "body": "Replying to [comment:9 hivert]:\n> I just got confirmation (on cython-users) that INCREF is correct where I put it.  \n\nI was putting the INCREF in precisely the same location as you did. Only difference to the code that I tried (getting segfaults): You did `PyInt_FromLong` before that. And I don't see why that conversion prevents the segfault.\n\nCheers,\n\nSimon",
    "created_at": "2011-11-14T23:11:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11857#issuecomment-135752",
    "user": "SimonKing"
}
```

Replying to [comment:9 hivert]:
> I just got confirmation (on cython-users) that INCREF is correct where I put it.  

I was putting the INCREF in precisely the same location as you did. Only difference to the code that I tried (getting segfaults): You did `PyInt_FromLong` before that. And I don't see why that conversion prevents the segfault.

Cheers,

Simon



---

archive/issue_comments_135753.json:
```json
{
    "body": "> > Interesting that this is so fast. I need to catch some sleep now, however...\n> \n> Me too ! Sorry for not being around Paris just when you come.\n\nJust before I go to bed, Mark Florisson noticed on cython-users that\n\n    return [self._list[i] for i in range(self._len)]\n\nShould be as fast as the former append version.\n\nCheers,\n\nFlorent",
    "created_at": "2011-11-14T23:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11857#issuecomment-135753",
    "user": "hivert"
}
```

> > Interesting that this is so fast. I need to catch some sleep now, however...
> 
> Me too ! Sorry for not being around Paris just when you come.

Just before I go to bed, Mark Florisson noticed on cython-users that

    return [self._list[i] for i in range(self._len)]

Should be as fast as the former append version.

Cheers,

Florent



---

archive/issue_comments_135754.json:
```json
{
    "body": "Attachment\n\nHi Simon,\n\nLooking at the C code I figured out that replacing\n\n```\ncdef list L = PyList_New(self._len)\n```\n\nby\n\n```\ncdef list L = <list> PyList_New(self._len)\n```\n\nallows to gain a few more speed:\n\n```\nsage: %timeit I.list()\n625 loops, best of 3: 13 \u00b5s per loop\n```\n\nSo one less microsecond. Can you fold my patch and review it. I'm Ok with your changes.\n\nCheers,\n\nFlorent",
    "created_at": "2011-11-15T08:29:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11857#issuecomment-135754",
    "user": "hivert"
}
```

Attachment

Hi Simon,

Looking at the C code I figured out that replacing

```
cdef list L = PyList_New(self._len)
```

by

```
cdef list L = <list> PyList_New(self._len)
```

allows to gain a few more speed:

```
sage: %timeit I.list()
625 loops, best of 3: 13 µs per loop
```

So one less microsecond. Can you fold my patch and review it. I'm Ok with your changes.

Cheers,

Florent



---

archive/issue_comments_135755.json:
```json
{
    "body": "Iteration over ClonableIntArray, including Florent's speed-up",
    "created_at": "2011-11-15T20:07:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11857#issuecomment-135755",
    "user": "SimonKing"
}
```

Iteration over ClonableIntArray, including Florent's speed-up



---

archive/issue_comments_135756.json:
```json
{
    "body": "Attachment\n\nI folded Florent's patch and posted the combined patch under the original name of my patch. I hope you don't mind.\n\nI can confirm that using the C-Api gives an additional speed-up. The new doctest from Florent's patch tests against a case that was critical during development (it would result in a segfault without Florent's `PyInt_FromLong`).\n\nAll doctests pass, even when using the new Cython version. Therefore, I can give Florent's patch a positive review. He gave my patch a positive review as well. So, that's done.\n\nApply trac12029_clonable_int_array_2_list.patch",
    "created_at": "2011-11-15T20:14:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11857#issuecomment-135756",
    "user": "SimonKing"
}
```

Attachment

I folded Florent's patch and posted the combined patch under the original name of my patch. I hope you don't mind.

I can confirm that using the C-Api gives an additional speed-up. The new doctest from Florent's patch tests against a case that was critical during development (it would result in a segfault without Florent's `PyInt_FromLong`).

All doctests pass, even when using the new Cython version. Therefore, I can give Florent's patch a positive review. He gave my patch a positive review as well. So, that's done.

Apply trac12029_clonable_int_array_2_list.patch



---

archive/issue_comments_135757.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-11-15T20:14:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11857#issuecomment-135757",
    "user": "SimonKing"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_135758.json:
```json
{
    "body": "Dear Simon,\n\n> All doctests pass, even when using the new Cython version. Therefore, I can give Florent's patch a positive review. He gave my patch a positive review as well. So, that's done.\n\nExcellent ! I'm glad to have you as one of my patch co-author, if this wasn't already the case. Thanks for the review.\n\nFor the record [This thread](http://groups.google.com/group/cython-users/browse_frm/thread/3c732f8c39cc39a5?hl=en_US#) on cython-users indicate that the choosen solution seems to be the correct one. They are starting discussing optimizing list comprehension in Cython to handle our case.\n\nCheers,\n\nFlorent",
    "created_at": "2011-11-15T23:02:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11857#issuecomment-135758",
    "user": "hivert"
}
```

Dear Simon,

> All doctests pass, even when using the new Cython version. Therefore, I can give Florent's patch a positive review. He gave my patch a positive review as well. So, that's done.

Excellent ! I'm glad to have you as one of my patch co-author, if this wasn't already the case. Thanks for the review.

For the record [This thread](http://groups.google.com/group/cython-users/browse_frm/thread/3c732f8c39cc39a5?hl=en_US#) on cython-users indicate that the choosen solution seems to be the correct one. They are starting discussing optimizing list comprehension in Cython to handle our case.

Cheers,

Florent



---

archive/issue_comments_135759.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-11-16T20:36:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11857",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11857#issuecomment-135759",
    "user": "jdemeyer"
}
```

Resolution: fixed
