# Issue 11600: improving error reporting of random_matrix

Issue created by migration from https://trac.sagemath.org/ticket/11772

Original creator: dimpase

Original creation time: 2011-09-01 16:11:43

Assignee: jason, was

CC:  rbeezer

The error message of the call to random_matrix(QQ, 4, 8, rank=5) is quite cryptic.
It should be easy to check that the rank is greater than min(nrows,ncols) and throw a ValueError with a meaningful message.

(patch is coming soon)


---

Comment by dimpase created at 2011-09-01 16:33:07

Changing status from new to needs_review.


---

Attachment


---

Attachment


---

Comment by rbeezer created at 2011-09-02 02:32:58

v2-patch is Dima's original, but with a Trac number in the commit message.

There was one doctest failure on the subspace routine (the fly), since `None` is an allowed value for the rank, and it seems `None < 0` is `True`.  I moved a hunk of code that checks the `rank=None` case to happen early, and removed a pointless else-clause.

I like doctests that exercise error-conditions, so I added 3 new doctests.  Original patch is a positive review from me, whoever wants to review my patch (Dima?) can flip this whole ticket to positive review if my patch is OK.


---

Comment by dimpase created at 2011-09-02 03:14:26

there is at least one more problem with the code in random_echelonizable_matrix

```
sage: random_matrix( QQ, 3, 3, algorithm='echelonizable', rank=1,
                          upper_bound=60)
---------------------------------------------------------------------------
UnboundLocalError                         Traceback (most recent call last)

/Users/dima/<ipython console> in <module>()

/usr/local/src/sage/current/local/lib/python2.6/site-packages/sage/matrix/constructor.pyc in random_matrix(ring, nrows, ncols, algorithm, *args, **kwds)
   1250         return random_rref_matrix(parent, *args, **kwds)
   1251     elif algorithm == 'echelonizable':
-> 1252         return random_echelonizable_matrix(parent, *args, **kwds)
   1253     elif algorithm == 'diagonalizable':
   1254         return random_diagonalizable_matrix(parent, *args, **kwds)

/usr/local/src/sage/current/local/lib/python2.6/site-packages/sage/matrix/constructor.pyc in random_echelonizable_matrix(parent, rank, upper_bound)
   2995                         matrix_copy=matrix.with_added_multiple_of_row(row_index,matrix.pivot_rows()[pivots],randint(-5,5))
   2996                         # Range for scalar multiples determined experimentally.
-> 2997                     if max(map(abs,matrix_copy.list()))<upper_bound:
   2998                     # Continue if the the largest entry after a row operation is within the bound.
   2999                         matrix=matrix_copy

UnboundLocalError: local variable 'matrix_copy' referenced before assignment
sage: 
```



---

Comment by dimpase created at 2011-09-02 03:14:26

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2011-09-02 03:14:50

Changing priority from minor to major.


---

Comment by rbeezer created at 2011-09-02 03:51:56

Replying to [comment:4 dimpase]:
> there is at least one more problem with the code in random_echelonizable_matrix

I've used the function _all the time_ the past year, so that is indeed a surprise.  Looks like it is just the `rank=1` case, based on very limited testing.

How would you like to proceed?


---

Comment by dimpase created at 2011-09-02 05:41:15

Replying to [comment:6 rbeezer]:
> Replying to [comment:4 dimpase]:
> > there is at least one more problem with the code in random_echelonizable_matrix
> 
> I've used the function _all the time_ the past year, so that is indeed a surprise.  Looks like it is just the `rank=1` case, based on very limited testing.
> 
> How would you like to proceed?

the function in question has in general quite suspiciously looking code: e.g. it has

```
if upper_bound==None:
            upper_bound=50
            size=False
```

but then, when `size==False`, `upper_bound` is not used; that whole `size` thing can (and should, in a clearly written code) be replaced by if-else...

My understanding of the code is that it first gets `matrix` of specified `rank`, and then uses it to create the
result, of the same `rank`, but taking random vectors of the row space of `matrix`.
WIth the `upper_bound` set (and `size==True`, I don't even see how it always succeeds to terminate!
If I set `upper_bound=4`, I run into cases that look non-terminating. E.g. try running

```
 for i in range(100):
    rk=randint(2,13)
    print rk,i
    m = random_matrix( QQ, 13, 13, algorithm='echelonizable', rank=rk,   upper_bound=4)
```

I bet it will never finish, or at least I usually see it printing only 1 row of output, and then basically going into
an infinite loop. It seems that `matrix` itself should have well-controlled absolute values of entries, to begin with, 
but it's not done.

I'd say this has either to be re-done, or scrapped...


---

Comment by dimpase created at 2011-09-02 06:11:23

Replying to [comment:7 dimpase]:
> I'd say this has either to be re-done, or scrapped...

and there are sound mathematical reasons behind this, too. E.g. if you ask for a random rank k matrix of size kxn, with small entries, this already means that you need to sample in a hypercube, and I leave it for people with better working knowledge of this range of problems to figure out how to go about it.
For instance, if you impose upper_bound=1, you have just 3^n choices of vectors, and I don't know which proportion of k-subsets of such vectors will correspond to linearly independent ones, nor what uniformly(?) random such a subset should be...

The current code is just a dirty hack, and it should at least have a limit on the number of tries done before giving up!


---

Comment by rbeezer created at 2011-09-03 02:43:45

Replying to [comment:7 dimpase]:

I agree with your reservations - this routine should have some safeguards and could probably be cleaned-up quite a bit.  I also find it very useful, even as is.  It can sometimes take a second or two to finish, but with reasonable inputs, it seems to always finish, and produce useful output.

If you ask for `upper_bound=1`, then I think you get what you deserve.  ;-)

> I'd say this has either to be re-done, or scrapped...

So I would definitely like to see this feature kept - in other words, I would like to see the interface stay stable, with changes to the code.  I'd be happy with throwing an exception after some number of attempts.

I'm taking a break from most Sage work for a few weeks to get caught up on other things, so won't be able to address this immediately.

Rob


---

Comment by dimpase created at 2011-09-04 14:52:41

cumulative for -v2, -doctests, and more changes


---

Attachment


---

Comment by dimpase created at 2011-09-04 14:56:05

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2011-09-04 15:02:23

Replying to [comment:9 rbeezer]:
> Replying to [comment:7 dimpase]:
> 
> I agree with your reservations - this routine should have some safeguards and could probably be cleaned-up quite a bit.  I also find it very useful, even as is.  It can sometimes take a second or two to finish, but with reasonable inputs, it seems to always finish, and produce useful output.
> 
> If you ask for `upper_bound=1`, then I think you get what you deserve.  ;-)

our servers don't deserve being trashed by 120 undergrads, running never ending loops, executing seemingly innocent Sage commands. :)

> 
> > I'd say this has either to be re-done, or scrapped...
> 
> So I would definitely like to see this feature kept - in other words, I would like to see the interface stay stable, with changes to the code.  I'd be happy with throwing an exception after some number of attempts.
> 
> I'm taking a break from most Sage work for a few weeks to get caught up on other things, so won't be able to address this immediately.
> 

I've bitten the bullet and hopefully fixed all the shortcomings we discussed, added throwing exceptions, etc. Please review soon. :-)

> Rob
>


---

Comment by rbeezer created at 2011-09-04 15:13:26

Replying to [comment:11 dimpase]:
> I've bitten the bullet and hopefully fixed all the shortcomings we discussed, added throwing exceptions, etc. Please review soon. :-)

Dima - thanks for biting the bullet!  Long weekend here in the US, and I'm offline for a couple days, but I will get at this very soon.  First-look looks good.

Rob


---

Comment by davidloeffler created at 2012-03-11 11:36:01

Apply trac_11772.patch

(for the patchbot). Any movement on this one?


---

Comment by dimpase created at 2012-03-11 12:11:17

Replying to [comment:13 davidloeffler]:
> Apply trac_11772.patch
> 
> (for the patchbot). Any movement on this one?

IMHO the ball is in Rob's court. Rob?


---

Comment by davidloeffler created at 2012-03-11 14:27:05

Changing status from needs_review to needs_work.


---

Comment by davidloeffler created at 2012-03-11 14:27:05

According to the patchbot, the patch does not apply under either current release (4.8) or current dev (5.0.beta7).


---

Comment by rbeezer created at 2012-03-11 16:58:26

Replying to [comment:14 dimpase]:
> IMHO the ball is in Rob's court. Rob?

Yes, ball is in my court.  So are lots of other balls.  ;-)

I have not forgotten this one, but for months now have not been in a position to get too into Sage work.  I use this routine all the time, and it never fails me.  That is not an excuse, it should be fixed as Dima has noticed, but it has not been a high-priority item for me.

David - thanks for bumping some tickets - I see I have another one to address with Sequence and I think Jeroen bumped another one on some RDF/CDF stuff a few weeks ago.

Rob


---

Comment by dimpase created at 2012-03-11 17:02:00

Replying to [comment:16 rbeezer]:
> Replying to [comment:14 dimpase]:
> > IMHO the ball is in Rob's court. Rob?
> 
> Yes, ball is in my court.  So are lots of other balls.  ;-)
> 
> I have not forgotten this one, but for months now have not been in a position to get too into Sage work.  I use this routine all the time, and it never fails me.  That is not an excuse, it should be fixed as Dima has noticed, but it has not been a high-priority item for me.
> 

I'll ask a student to rebase. I have negative amount of time available, it seems :)


---

Comment by kini created at 2012-03-12 03:40:41

This patch needs work


---

Attachment

I couldn't find any revision onto which the patch actually applied, so I tried to rebase it manually. Please check for errors.

Also, Dima, please remove your print statements and commented out lines... the patch also needs some work in the PEP-8 department, but then again the whole file does, it looks like. I fixed what I could in the function Rob touched.


---

Attachment

Rebase on 5.11


---

Comment by rbeezer created at 2013-08-21 22:04:52

I've made a trivial rebase for Sage 5.11 of the ".2" consolidated patch, now named ".3".

I put Dima's name on it, since all of the significant code contributions are his.  

I am working on a review and will definitely add a reviewer patch.


---

Attachment

Apply on top of ".3" patch


---

Comment by rbeezer created at 2013-08-21 23:26:42

Changing status from needs_work to needs_review.


---

Comment by rbeezer created at 2013-08-21 23:26:42

Reviewer patch:

1.  Removed debugging print statements.
1.  Code for sanity tests on inputs from the very first "v2" patch were missing, so the corresponding doctests were failing.  Code has been restored, doctests function properly now.
1.  Passed `max_tries` through the unimodular routine, since it has an `upper_bound` keyword.

WeBWorK homework system can now query the Sage cell server.  The `random_matrix()` function is very appealing, but it absolutely must return every time or some poor undergrad will just get a system hang rather than a homework exercise.  So I have added three prominent warnings about requesting upper bounds.

I need to fix the randomness in these functions, see #10122.  GSL is to blame, and I have a working fix.  Then the doctests will need a total overhaul, so I'm tempted to do some other things here (document `max_tries`) but want that to wait.

I'm fine with Dima's code contributions.

Dima - I apologize for sitting on this for such a very long time.  If you like my changes/contributions, would you flip this to positive review?  If so, then I will build more onto it on other tickets.

Rob


---

Comment by dimpase created at 2013-08-22 04:02:40

Changing status from needs_review to positive_review.


---

Comment by rbeezer created at 2013-08-22 05:13:28

Thanks, Dima!  You are much more conscientious than me.  ;-)

I'll try to get my GSL-random-seed patch up sometime tomorrow night.  Busy all day tomorrow.

Rob


---

Comment by dimpase created at 2013-08-22 06:00:45

Replying to [comment:24 rbeezer]:
> Thanks, Dima!  You are much more conscientious than me.  ;-)
no, if you ask me to referee a paper, I might sit on it for a year easily...

Good that this patch didn't bitrot completely :–)

Dima


---

Comment by jdemeyer created at 2013-08-28 06:51:59

Resolution: fixed
