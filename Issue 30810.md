# Issue 30810: Conversion of symbolic functions from maxima is broken

archive/issues_030810.json:
```json
{
    "body": "CC:  nbruin egourgoulhon rws @davewittemorris\n\nWhen converting a `NewSymbolicFunction` to a maxima expression and back, sage sometimes returns the correct symbolic function and sometimes it creates a new function with the same name. This happens only when the function has additional information (i.e. a `latex_name` or `nargs`) attached to it. For example:\n\n\n```\nvar('phi')\nassume(phi >= 0)\nfunction('Cp', latex_name='C_+')\nCp(phi).simplify_full() # convert to maxima and back\n```\n\n\nreturns an expression with a new `Cp` function which is not equal to the original one and which doesn't have a latex name, but only if the `assume(phi >= 0)` happens before defining the function.\n\n\nThe issue is that the conversion functions hold a local copy of the symbol table which is not kept in sync with the actual symbol table that new functions are added to. If the conversion functions do not find the function by name in the local copy, `function_factory` is invoked which checks for both `name`, `latex_name` and `nargs` when looking for already registered functions. Since of course the maxima expression doesn't include the `latex_name`, it doesn't find the already registered function and creates a new one.\n\nI have implemented a fix which checks both the local and global copies of the symbol table, but I'm not sure this is the right way to fix things. First, it is not clear to me why the conversion functions have a local copy of the symbol table in the first place. Second, it makes no sense to me that `function_factory` looks for a matching `latex_name` when registering a new function. I see no use case for having to functions with the same `name` and different `latex_name` registered. After all, if I type in the name of the function in the sagemath prompt, I will only get the second definition which I typed in and thus I can't use the first definition anyway.\n\nSee also #14608#comment:9 and links therein for more discussion about this issue.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31047\n\n",
    "created_at": "2020-12-13T18:00:16Z",
    "labels": [
        "symbolics",
        "critical",
        "bug"
    ],
    "title": "Conversion of symbolic functions from maxima is broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30810",
    "user": "@spaghettisalat"
}
```
CC:  nbruin egourgoulhon rws @davewittemorris

When converting a `NewSymbolicFunction` to a maxima expression and back, sage sometimes returns the correct symbolic function and sometimes it creates a new function with the same name. This happens only when the function has additional information (i.e. a `latex_name` or `nargs`) attached to it. For example:


```
var('phi')
assume(phi >= 0)
function('Cp', latex_name='C_+')
Cp(phi).simplify_full() # convert to maxima and back
```


returns an expression with a new `Cp` function which is not equal to the original one and which doesn't have a latex name, but only if the `assume(phi >= 0)` happens before defining the function.


The issue is that the conversion functions hold a local copy of the symbol table which is not kept in sync with the actual symbol table that new functions are added to. If the conversion functions do not find the function by name in the local copy, `function_factory` is invoked which checks for both `name`, `latex_name` and `nargs` when looking for already registered functions. Since of course the maxima expression doesn't include the `latex_name`, it doesn't find the already registered function and creates a new one.

I have implemented a fix which checks both the local and global copies of the symbol table, but I'm not sure this is the right way to fix things. First, it is not clear to me why the conversion functions have a local copy of the symbol table in the first place. Second, it makes no sense to me that `function_factory` looks for a matching `latex_name` when registering a new function. I see no use case for having to functions with the same `name` and different `latex_name` registered. After all, if I type in the name of the function in the sagemath prompt, I will only get the second definition which I typed in and thus I can't use the first definition anyway.

See also #14608#comment:9 and links therein for more discussion about this issue.

Issue created by migration from https://trac.sagemath.org/ticket/31047





---

archive/issue_comments_440399.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-13T18:01:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440399",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_440400.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-12-13T18:02:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440400",
    "user": "@spaghettisalat"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_440401.json:
```json
{
    "body": "Thank you very much for taking care of this long standing issue!\n\nI've performed a few tests and the fix seems good to me. Let us wait for some other viewpoints before setting a positive review. Also it would be nice if the patchbot could run on this ticket branch.",
    "created_at": "2020-12-16T10:04:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440401",
    "user": "egourgoulhon"
}
```

Thank you very much for taking care of this long standing issue!

I've performed a few tests and the fix seems good to me. Let us wait for some other viewpoints before setting a positive review. Also it would be nice if the patchbot could run on this ticket branch.



---

archive/issue_comments_440402.json:
```json
{
    "body": "Another issue with symbolic functions is #27492. It might also be related to the way symbolic functions are stored in the symbol table.",
    "created_at": "2020-12-16T10:07:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440402",
    "user": "egourgoulhon"
}
```

Another issue with symbolic functions is #27492. It might also be related to the way symbolic functions are stored in the symbol table.



---

archive/issue_comments_440403.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-12-28T12:26:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440403",
    "user": "tmonteil"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_440404.json:
```json
{
    "body": "I am not able to judge the quality of the fix, but you should at least add doctests. Eric, could you please provide the tests you did so that they can be added as well ?",
    "created_at": "2020-12-28T12:26:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440404",
    "user": "tmonteil"
}
```

I am not able to judge the quality of the fix, but you should at least add doctests. Eric, could you please provide the tests you did so that they can be added as well ?



---

archive/issue_comments_440405.json:
```json
{
    "body": "I can comment on one question in the description: since it is possible to do the following:\n\n```\nsage: f1=sage.symbolic.function_factory.function('f',latex_name=\"\\phi\")\nsage: f2=sage.symbolic.function_factory.function('f',latex_name=\"\\psi\")\nsage: f1(x)-f2(x)\nf(x) - f(x)\nsage: latex(f1(x)-f2(x))\n\\phi\\left(x\\right) - \\psi\\left(x\\right)\n```\n\nI think our hand is forced on taking into account LaTeX names. It may not be advisable to create many functions with the same print name, it's not forbidden. In fact, automatic code could easily create many functions, and they should not interfere with the latex names used elsewhere.\n\nYou're probably going to run into problems if you do this kind of stuff in other interfaces (particularly maxima), though.",
    "created_at": "2020-12-29T03:28:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440405",
    "user": "nbruin"
}
```

I can comment on one question in the description: since it is possible to do the following:

```
sage: f1=sage.symbolic.function_factory.function('f',latex_name="\phi")
sage: f2=sage.symbolic.function_factory.function('f',latex_name="\psi")
sage: f1(x)-f2(x)
f(x) - f(x)
sage: latex(f1(x)-f2(x))
\phi\left(x\right) - \psi\left(x\right)
```

I think our hand is forced on taking into account LaTeX names. It may not be advisable to create many functions with the same print name, it's not forbidden. In fact, automatic code could easily create many functions, and they should not interfere with the latex names used elsewhere.

You're probably going to run into problems if you do this kind of stuff in other interfaces (particularly maxima), though.



---

archive/issue_comments_440406.json:
```json
{
    "body": "Replying to [comment:7 nbruin]:\n> I think our hand is forced on taking into account LaTeX names. It may not be advisable to create many functions with the same print name, it's not forbidden. \n\nIt should be forbidden, IMHO. As pointed out in the ticket description, I don't see any use case for such a feature. Since maxima has no concept of LaTeX name and maxima is currently heavily used for simplifications in Sage symbolic calculus, it would be safe to forbid to declare a function with an already existing name but a different LaTeX name. \n\n> You're probably going to run into problems if you do this kind of stuff in other interfaces (particularly maxima), though.\n\nWhat do you mean by \"other interfaces (particularly maxima)\", given that this ticket is about the maxima interface?",
    "created_at": "2020-12-29T15:50:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440406",
    "user": "egourgoulhon"
}
```

Replying to [comment:7 nbruin]:
> I think our hand is forced on taking into account LaTeX names. It may not be advisable to create many functions with the same print name, it's not forbidden. 

It should be forbidden, IMHO. As pointed out in the ticket description, I don't see any use case for such a feature. Since maxima has no concept of LaTeX name and maxima is currently heavily used for simplifications in Sage symbolic calculus, it would be safe to forbid to declare a function with an already existing name but a different LaTeX name. 

> You're probably going to run into problems if you do this kind of stuff in other interfaces (particularly maxima), though.

What do you mean by "other interfaces (particularly maxima)", given that this ticket is about the maxima interface?



---

archive/issue_comments_440407.json:
```json
{
    "body": "Replying to [comment:6 tmonteil]:\n> I am not able to judge the quality of the fix, but you should at least add doctests. Eric, could you please provide the tests you did so that they can be added as well ?\n\nHere is a doctest adapted from the ticket description:\n\n```\nsage: assume(x > 0)                                                        \nsage: Cp = function('Cp', latex_name=r'C_+') \nsage: s = Cp(x).simplify()                 \nsage: s - Cp(x)  # in Sage 9.2, returns Cp(x) - Cp(x)                                                             \n0\nsage: latex(s)  # in Sage 9.2, returns {\\rm Cp}\\left(x\\right)                                                                    \nC_+\\left(x\\right)\n```\n",
    "created_at": "2020-12-29T15:57:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440407",
    "user": "egourgoulhon"
}
```

Replying to [comment:6 tmonteil]:
> I am not able to judge the quality of the fix, but you should at least add doctests. Eric, could you please provide the tests you did so that they can be added as well ?

Here is a doctest adapted from the ticket description:

```
sage: assume(x > 0)                                                        
sage: Cp = function('Cp', latex_name=r'C_+') 
sage: s = Cp(x).simplify()                 
sage: s - Cp(x)  # in Sage 9.2, returns Cp(x) - Cp(x)                                                             
0
sage: latex(s)  # in Sage 9.2, returns {\rm Cp}\left(x\right)                                                                    
C_+\left(x\right)
```




---

archive/issue_comments_440408.json:
```json
{
    "body": "The sympy interfaces suffers from exactly the same problem, for example in\n\n\n```\nvar('phi')\nfunction('Cp', latex_name='C_+')\nCp(phi)._sympy_()._sage_()\n```\n",
    "created_at": "2021-01-07T19:59:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440408",
    "user": "@spaghettisalat"
}
```

The sympy interfaces suffers from exactly the same problem, for example in


```
var('phi')
function('Cp', latex_name='C_+')
Cp(phi)._sympy_()._sage_()
```




---

archive/issue_comments_440409.json:
```json
{
    "body": "Replying to [comment:7 nbruin]:\n\n> I think our hand is forced on taking into account LaTeX names. It may not be advisable to create many functions with the same print name, it's not forbidden. In fact, automatic code could easily create many functions, and they should not interfere with the latex names used elsewhere.\n\nBut in basically all cases, sagemath already assumes that the print name can be treated as a unique identifier for the function. The documentation never mentions anything else. External interfaces rely on the assumption. The sagemath prompt treats the print name as a unique identifier: when I create two functions with the same print name and two different latex names and then type in the function name in the prompt, I get only one of the two functions.\n\nTherefore, the \"feature\" that one can create two functions with the same print name but different latex names is in my opinion first of all profoundly useless (because most of the stuff one would want to do with these functions won't work properly) and secondly serves only as a pitfall to confuse unsuspecting users.\n\nGiven that the sympy interface is also broken (it is not unlikely that other interfaces may also suffer from the same problem), in my opinion the only sane solution is to patch `function_factory` to take into account only the print name.",
    "created_at": "2021-01-07T20:19:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440409",
    "user": "@spaghettisalat"
}
```

Replying to [comment:7 nbruin]:

> I think our hand is forced on taking into account LaTeX names. It may not be advisable to create many functions with the same print name, it's not forbidden. In fact, automatic code could easily create many functions, and they should not interfere with the latex names used elsewhere.

But in basically all cases, sagemath already assumes that the print name can be treated as a unique identifier for the function. The documentation never mentions anything else. External interfaces rely on the assumption. The sagemath prompt treats the print name as a unique identifier: when I create two functions with the same print name and two different latex names and then type in the function name in the prompt, I get only one of the two functions.

Therefore, the "feature" that one can create two functions with the same print name but different latex names is in my opinion first of all profoundly useless (because most of the stuff one would want to do with these functions won't work properly) and secondly serves only as a pitfall to confuse unsuspecting users.

Given that the sympy interface is also broken (it is not unlikely that other interfaces may also suffer from the same problem), in my opinion the only sane solution is to patch `function_factory` to take into account only the print name.



---

archive/issue_comments_440410.json:
```json
{
    "body": "Replying to [comment:11 gh-spaghettisalat]:\n> \n> Therefore, the \"feature\" that one can create two functions with the same print name but different latex names is in my opinion first of all profoundly useless (because most of the stuff one would want to do with these functions won't work properly) and secondly serves only as a pitfall to confuse unsuspecting users.\n\n+1\n\n> \n> Given that the sympy interface is also broken (it is not unlikely that other interfaces may also suffer from the same problem), in my opinion the only sane solution is to patch `function_factory` to take into account only the print name.\n\nYes, this seems the route to go.",
    "created_at": "2021-01-10T16:02:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440410",
    "user": "egourgoulhon"
}
```

Replying to [comment:11 gh-spaghettisalat]:
> 
> Therefore, the "feature" that one can create two functions with the same print name but different latex names is in my opinion first of all profoundly useless (because most of the stuff one would want to do with these functions won't work properly) and secondly serves only as a pitfall to confuse unsuspecting users.

+1

> 
> Given that the sympy interface is also broken (it is not unlikely that other interfaces may also suffer from the same problem), in my opinion the only sane solution is to patch `function_factory` to take into account only the print name.

Yes, this seems the route to go.



---

archive/issue_comments_440411.json:
```json
{
    "body": "In any case, there is something weird about the way some kind of \"unique representation\" for functions (and variables) is handled (both with and without the branch):\n\n\n```\nsage: f = function('f', nargs=2)\nsage: f(1,2)\nf(1, 2)\nsage: g = function('f', nargs=1)\nsage: f(1,2)\nTypeError: Symbolic function f takes exactly 1 arguments (2 given)\nsage: f is g\nTrue\n```\n",
    "created_at": "2021-01-10T19:18:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440411",
    "user": "tmonteil"
}
```

In any case, there is something weird about the way some kind of "unique representation" for functions (and variables) is handled (both with and without the branch):


```
sage: f = function('f', nargs=2)
sage: f(1,2)
f(1, 2)
sage: g = function('f', nargs=1)
sage: f(1,2)
TypeError: Symbolic function f takes exactly 1 arguments (2 given)
sage: f is g
True
```




---

archive/issue_comments_440412.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-01-31T21:26:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440412",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_440413.json:
```json
{
    "body": "I have implemented a basic fix to the specific problem reported on this ticket, i.e. only for the conversion of symbolic functions from maxima. The inconsistent behaviour of `function_factory` is untouched because I can't be bothered to wade through even more piles of spaghetti code to fix that too. The sympy interface is also still broken because for some weird reason the conversion functions between sympy and sage seem to be partially duplicated in both projects and I don't know where to implement the fix (in sage, sympy or both), although the fix itself would be very simple.",
    "created_at": "2021-01-31T21:34:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440413",
    "user": "@spaghettisalat"
}
```

I have implemented a basic fix to the specific problem reported on this ticket, i.e. only for the conversion of symbolic functions from maxima. The inconsistent behaviour of `function_factory` is untouched because I can't be bothered to wade through even more piles of spaghetti code to fix that too. The sympy interface is also still broken because for some weird reason the conversion functions between sympy and sage seem to be partially duplicated in both projects and I don't know where to implement the fix (in sage, sympy or both), although the fix itself would be very simple.



---

archive/issue_comments_440414.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-01-31T21:34:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440414",
    "user": "@spaghettisalat"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_440415.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-02-02T19:08:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440415",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_440416.json:
```json
{
    "body": "patchbot reports:\n\n```\nsage -t --long --warn-long 69.4 --random-seed=0 src/sage/functions/log.py  # 1 doctest failed\nsage -t --long --warn-long 69.4 --random-seed=0 src/sage/interfaces/sympy.py  # 2 doctests failed\n```\n",
    "created_at": "2021-02-02T19:08:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440416",
    "user": "mkoeppe"
}
```

patchbot reports:

```
sage -t --long --warn-long 69.4 --random-seed=0 src/sage/functions/log.py  # 1 doctest failed
sage -t --long --warn-long 69.4 --random-seed=0 src/sage/interfaces/sympy.py  # 2 doctests failed
```




---

archive/issue_comments_440417.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-06T22:00:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440417",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_440418.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-02-06T22:00:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440418",
    "user": "@spaghettisalat"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_440419.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-02-07T18:18:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440419",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_440420.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-02-07T21:34:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440420",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_440421.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-02-14T16:54:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440421",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_440422.json:
```json
{
    "body": "needs rebase",
    "created_at": "2021-02-14T16:54:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440422",
    "user": "mkoeppe"
}
```

needs rebase



---

archive/issue_comments_440423.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-02-14T20:05:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440423",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_440424.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-02-14T20:05:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440424",
    "user": "@spaghettisalat"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_440425.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-03-09T00:25:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440425",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_440426.json:
```json
{
    "body": "Just a superficial comment (because I don't know this part of the code very well): \nAll functions (including internal functions) need a docstring and tests to conform with our coding style.",
    "created_at": "2021-03-09T00:25:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440426",
    "user": "mkoeppe"
}
```

Just a superficial comment (because I don't know this part of the code very well): 
All functions (including internal functions) need a docstring and tests to conform with our coding style.



---

archive/issue_comments_440427.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-03-12T18:35:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440427",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_440428.json:
```json
{
    "body": "> Just a superficial comment (because I don't know this part of the code very well): All functions (including internal functions) need a docstring and tests to conform with our coding style. \n\nEverything I added is already covered with tests, either the ones I added in this ticket or existing tests for other functionality that depends on the stuff I changed. Therefore I added only some docstrings. I hope that is finally enough to get this merged.\n\nIs there anybody more familiar with this part of sagemath who we could cc to review this?",
    "created_at": "2021-03-12T18:41:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440428",
    "user": "@spaghettisalat"
}
```

> Just a superficial comment (because I don't know this part of the code very well): All functions (including internal functions) need a docstring and tests to conform with our coding style. 

Everything I added is already covered with tests, either the ones I added in this ticket or existing tests for other functionality that depends on the stuff I changed. Therefore I added only some docstrings. I hope that is finally enough to get this merged.

Is there anybody more familiar with this part of sagemath who we could cc to review this?



---

archive/issue_comments_440429.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-03-12T18:41:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440429",
    "user": "@spaghettisalat"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_440430.json:
```json
{
    "body": "I've performed a few tests and everything seems OK. Thanks for the fix!\n\nRegarding :comment:24, the class `_Function_swap_harmonic` in `src/sage/functions/log.py` should have some (minimal) doctests, as well as the function `_sympysage_function_by_name` and the class `UndefSageHelper` in `src/sage/interfaces/sympy.py`. This will make the [coverage plugin](https://patchbot.sagemath.org/log/31047/Linux/1_SMP_Debian_4.19.171-2_(2021-01-30)/x86_64/4.19.0-14-amd64/tmonteil-lxc1/2021-03-12%2020:29:55?plugin=coverage&diff=/log/0/Linux/1_SMP_Debian_4.19.171-2_%282021-01-30%29/x86_64/4.19.0-14-amd64/tmonteil-lxc1/2021-03-09%2014%3A42%3A51&ticket=31047&base=9.3.beta8) of the patchbot happy. Once this is made, I think we can set the ticket to positive review.",
    "created_at": "2021-03-13T16:28:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440430",
    "user": "egourgoulhon"
}
```

I've performed a few tests and everything seems OK. Thanks for the fix!

Regarding :comment:24, the class `_Function_swap_harmonic` in `src/sage/functions/log.py` should have some (minimal) doctests, as well as the function `_sympysage_function_by_name` and the class `UndefSageHelper` in `src/sage/interfaces/sympy.py`. This will make the [coverage plugin](https://patchbot.sagemath.org/log/31047/Linux/1_SMP_Debian_4.19.171-2_(2021-01-30)/x86_64/4.19.0-14-amd64/tmonteil-lxc1/2021-03-12%2020:29:55?plugin=coverage&diff=/log/0/Linux/1_SMP_Debian_4.19.171-2_%282021-01-30%29/x86_64/4.19.0-14-amd64/tmonteil-lxc1/2021-03-09%2014%3A42%3A51&ticket=31047&base=9.3.beta8) of the patchbot happy. Once this is made, I think we can set the ticket to positive review.



---

archive/issue_comments_440431.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-03-19T21:00:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440431",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_440432.json:
```json
{
    "body": "I have copied some of the tests to the new helper functions created in the new commits.\n\n(Not that this would make any difference since as I said before, there were already tests for the functionality and all I've done now is to spread the tests out into more places. I don't want to be too rude here, but just counting whether a function has doctests or not seems like a pretty shitty way to measure test coverage.)",
    "created_at": "2021-03-19T21:08:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440432",
    "user": "@spaghettisalat"
}
```

I have copied some of the tests to the new helper functions created in the new commits.

(Not that this would make any difference since as I said before, there were already tests for the functionality and all I've done now is to spread the tests out into more places. I don't want to be too rude here, but just counting whether a function has doctests or not seems like a pretty shitty way to measure test coverage.)



---

archive/issue_comments_440433.json:
```json
{
    "body": "Replying to [comment:29 gh-spaghettisalat]:\n> just counting whether a function has doctests or not seems like a pretty shitty way to measure test coverage.\n\nHard to disagree with this, but we don't have a better way.",
    "created_at": "2021-03-19T21:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440433",
    "user": "mkoeppe"
}
```

Replying to [comment:29 gh-spaghettisalat]:
> just counting whether a function has doctests or not seems like a pretty shitty way to measure test coverage.

Hard to disagree with this, but we don't have a better way.



---

archive/issue_comments_440434.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-03-20T09:26:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440434",
    "user": "egourgoulhon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_440435.json:
```json
{
    "body": "Replying to [comment:29 gh-spaghettisalat]:\n> I have copied some of the tests to the new helper functions created in the new commits.\n> \n\nOK, this provides only indirect doctests, but let's move on in order to have the fix merged in 9.3!\n\n> (Not that this would make any difference since as I said before, there were already tests for the functionality and all I've done now is to spread the tests out into more places. I don't want to be too rude here, but just counting whether a function has doctests or not seems like a pretty shitty way to measure test coverage.)\n\nBeside testing, another virtue of doctests is to illustrate quickly the use of the function; this is useful even for helper functions, i.e. for functions that only developers are supposed to take a look at.",
    "created_at": "2021-03-20T09:26:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440435",
    "user": "egourgoulhon"
}
```

Replying to [comment:29 gh-spaghettisalat]:
> I have copied some of the tests to the new helper functions created in the new commits.
> 

OK, this provides only indirect doctests, but let's move on in order to have the fix merged in 9.3!

> (Not that this would make any difference since as I said before, there were already tests for the functionality and all I've done now is to spread the tests out into more places. I don't want to be too rude here, but just counting whether a function has doctests or not seems like a pretty shitty way to measure test coverage.)

Beside testing, another virtue of doctests is to illustrate quickly the use of the function; this is useful even for helper functions, i.e. for functions that only developers are supposed to take a look at.



---

archive/issue_comments_440436.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-03-20T20:55:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440436",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_440437.json:
```json
{
    "body": "This ticket causes an issue with conversions in the Mathematica interface, see #31756. Do you have an idea that might solve this?",
    "created_at": "2021-04-30T07:04:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440437",
    "user": "@mwageringel"
}
```

This ticket causes an issue with conversions in the Mathematica interface, see #31756. Do you have an idea that might solve this?



---

archive/issue_comments_440438.json:
```json
{
    "body": "An unrelated comment on this change:\n\n```diff\n-def symbolic_expression_from_string(s, syms=None, accept_sequence=False):\n+def symbolic_expression_from_string(s, syms={}, accept_sequence=False):\n```\n\nUsually it is best to avoid using `{}` as default value, since it is mutable, so the value that is used as default for all calls to the function can change.\n\nThe way it is used in this particular case does not seem to make a problem, though, as the value is not mutated inside the function.",
    "created_at": "2021-04-30T07:12:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30810#issuecomment-440438",
    "user": "@mwageringel"
}
```

An unrelated comment on this change:

```diff
-def symbolic_expression_from_string(s, syms=None, accept_sequence=False):
+def symbolic_expression_from_string(s, syms={}, accept_sequence=False):
```

Usually it is best to avoid using `{}` as default value, since it is mutable, so the value that is used as default for all calls to the function can change.

The way it is used in this particular case does not seem to make a problem, though, as the value is not mutated inside the function.
