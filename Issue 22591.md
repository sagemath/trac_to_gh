# Issue 22591: py3: rich comparison for asymptotic term monoid

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2017-04-18 19:46:38

CC:  cheuberg behackl dkrenn

as another step towards python3


---

Comment by chapoton created at 2017-04-18 19:47:19

work in progress
----
New commits:


---

Comment by git created at 2017-04-19 19:09:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-04-19 19:32:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-04-19 19:41:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-04-19 19:52:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2017-04-20 08:20:44

I'll have a look at the changes in the next days.


---

Comment by dkrenn created at 2017-04-20 14:27:24

A quick question ahead: Why is something like

```
def _richcmp_(self, other, op):
    if not isinstance(other, GenericGrowthElement):
        return op == op_NE
```

needed? Shouldn't `_richcmp_` always get elements with the same parent (by the coercion model), thus elements that are already directly comparable (and the code not needed)?


---

Comment by dkrenn created at 2017-04-21 06:35:27

Dear Frédéric, I've reviewed your changes, but see comments below this list for a possible future of this ticket:

- Some doctests did not pass (see also the following comments); however, as this ticket was not set to "needs review", I assume that these were just not investigated yet.

- asymptotics_multi...: LGTM, but see comment below this list.

- growth_group.py, line 1196:

```
return richcmp(self._raw_element_, other._raw_element_, op)
```

This does not make sense for a `GenericGrowthElement` (as there is no `<` on it defined).

- growth_group.py, line 3643: The following was rewritten, but the new code is not equivalent to the old:

```
        return bool(abs(self.base) < abs(other.base)) or \
               bool(self.base == other.base)
```

vs

```
        if not isinstance(other, ExponentialGrowthElement):
            return op == op_NE

        lx = self.base
        ly = other.base
        if lx == ly:
            return rich_to_bool(op, 0)

        return richcmp(abs(lx), abs(ly), op)
```

For example: `self.base=1`, `other.base=-1`, `op=op_LE` would incorrectly return `True`.
I think, that this is the origin of the failing doctests.

- term_monoid.py, lines 2915-2933: Maybe a matter of taste, but it looks like the code has blown up quite much (there is even some code doubling); this does not improve readability.

- The patchbot reports also this:

```
File "src/sage/calculus/calculus.py", line 1406, in sage.calculus.calculus.laplace
Failed example:
    laplace(t^n, t, s, algorithm='giac')
Expected:
    Traceback (most recent call last):
    ...
    NotImplementedError: Unable to parse Giac output: integrate(t^n*exp(-s*t),t,0,+infinity)
Got:
    integration(t^n*e^(-s*t), t, 0, +Infinity)
```

I have no glue why this is failing. I cannot imagine that this comes from the changes of this ticket. Any ideas?

When the asymptotic expansion module was written, I had the change in comparison in my mind and tried to prepare everything for it, so that it will be easy at one point. This point seems to be now; I've partially reverted your changes and have prepared a own patch to address the issues of this ticket.
Overall, the code now is much cleaner (compared to the original code) and I am satisified with it.

- Can you please check: Is this is now still Python3 comparision-compatible? (I think so, but it is surely easier for you to tell. ;)

- The main change was to introduce a kind of low-level `_richcmp_` which can be used more broadly. As a consequence only high-level `_eq_` and `_lt_` (very close to the Python 3 recommendation on how to implement comparison, but single underscores to use SageMath's convention on coercion) have to be implemented. I think this is a very convenient to implement new partial orders.

- In asymptotics_multi..., I've deleted the the comparison `<`, as it is mathematically not meaningful and only needed in filtering out multiple factors in the denominator. There is now used a key, where this sorting is needed.
----
Last 10 new commits:


---

Comment by dkrenn created at 2017-04-21 06:35:27

Changing status from new to needs_review.


---

Comment by git created at 2017-04-25 12:26:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2017-04-25 12:29:30

Replying to [comment:11 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[12eb632](https://git.sagemath.org/sage.git/commit/?id=12eb632931b23787b8dc5597e05ff5bfc91aed0c)||`Trac #22828: remove meaningless doctest`||

Is again at needs_review.


---

Comment by chapoton created at 2017-04-27 15:30:20

Probably you should not care about the rubik failure, it should be a random thing.

Could you please check that all tests pass in the asymptotic folder with this branch + the current branch of ticket #22297 ?


---

Comment by dkrenn created at 2017-04-27 17:30:29

Replying to [comment:13 chapoton]:
> Probably you should not care about the rubik failure, it should be a random thing.

I would guess so. I just find random failing doctests not very pleasing (from a global-SageMath-point-of-view).

> Could you please check that all tests pass in the asymptotic folder with this branch + the current branch of ticket #22297 ?

Tests passed.


---

Comment by chapoton created at 2017-04-27 20:43:26

looks ok, but you should not do that:

```
-from __future__ import absolute_import
```

please add them back (at least twice), then you can set a positive review on my behalf.


---

Comment by dkrenn created at 2017-04-28 06:13:17

Replying to [comment:15 chapoton]:
> looks ok, but you should not do that:
> {{{
> -from __future__ import absolute_import
> }}}
> please add them back (at least twice), then you can set a positive review on my behalf.

They are just moved below the copyright notice. (I've taken this change just as it was in the original patch provided by you...)


---

Comment by chapoton created at 2017-04-28 06:33:50

ok, indeed. sorry for the noise.

Then let it be.


---

Comment by chapoton created at 2017-04-28 06:33:50

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-04-29 08:56:55

PDF docs don't build


---

Comment by vbraun created at 2017-04-29 08:56:55

Changing status from positive_review to needs_work.


---

Comment by dkrenn created at 2017-04-29 09:25:35

Replying to [comment:18 vbraun]:
> PDF docs don't build

This is not caused by this ticket. Building the Pdf (tried for reference/asymptotic) fails in a clean 8.0.beta4. Moreover, it fails already in 8.0.beta2, but seems to work in 7.6.
What has changed?


---

Comment by dkrenn created at 2017-04-29 09:25:35

Changing status from needs_work to needs_info.


---

Comment by git created at 2017-04-29 11:14:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2017-04-29 11:16:16

Changing status from needs_info to needs_review.


---

Comment by dkrenn created at 2017-04-29 11:16:16

Replying to [comment:19 dkrenn]:
> Replying to [comment:18 vbraun]:
> > PDF docs don't build
> 
> This is not caused by this ticket. Building the Pdf (tried for reference/asymptotic) fails in a clean 8.0.beta4. Moreover, it fails already in 8.0.beta2, but seems to work in 7.6.
> What has changed?

Ok, as this `iftex`-issue is now not anymore on my machine, I saw the true error (it is related to this ticket, sorry for my wrong assertion above) and changed it.


---

Comment by chapoton created at 2017-04-29 11:21:23

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2017-04-29 11:21:23

ok, then


---

Comment by vbraun created at 2017-05-02 22:12:36

Resolution: fixed
