# Issue 22591: py3: rich comparison for asymptotic term monoid

archive/issues_022591.json:
```json
{
    "body": "CC:  @cheuberg @behackl @dkrenn\n\nas another step towards python3\n\nIssue created by migration from https://trac.sagemath.org/ticket/22828\n\n",
    "created_at": "2017-04-18T19:46:38Z",
    "labels": [
        "component: python3"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "py3: rich comparison for asymptotic term monoid",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22591",
    "user": "https://github.com/fchapoton"
}
```
CC:  @cheuberg @behackl @dkrenn

as another step towards python3

Issue created by migration from https://trac.sagemath.org/ticket/22828





---

archive/issue_comments_314814.json:
```json
{
    "body": "work in progress\n\n---\nNew commits:",
    "created_at": "2017-04-18T19:47:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314814",
    "user": "https://github.com/fchapoton"
}
```

work in progress

---
New commits:



---

archive/issue_comments_314815.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-19T19:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314815",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_314816.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-19T19:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314816",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_314817.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-19T19:41:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314817",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_314818.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-19T19:52:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314818",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_314819.json:
```json
{
    "body": "I'll have a look at the changes in the next days.",
    "created_at": "2017-04-20T08:20:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314819",
    "user": "https://github.com/dkrenn"
}
```

I'll have a look at the changes in the next days.



---

archive/issue_comments_314820.json:
```json
{
    "body": "A quick question ahead: Why is something like\n\n```\ndef _richcmp_(self, other, op):\n    if not isinstance(other, GenericGrowthElement):\n        return op == op_NE\n```\nneeded? Shouldn't `_richcmp_` always get elements with the same parent (by the coercion model), thus elements that are already directly comparable (and the code not needed)?",
    "created_at": "2017-04-20T14:27:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314820",
    "user": "https://github.com/dkrenn"
}
```

A quick question ahead: Why is something like

```
def _richcmp_(self, other, op):
    if not isinstance(other, GenericGrowthElement):
        return op == op_NE
```
needed? Shouldn't `_richcmp_` always get elements with the same parent (by the coercion model), thus elements that are already directly comparable (and the code not needed)?



---

archive/issue_comments_314821.json:
```json
{
    "body": "Dear Fr\u00e9d\u00e9ric, I've reviewed your changes, but see comments below this list for a possible future of this ticket:\n\n- Some doctests did not pass (see also the following comments); however, as this ticket was not set to \"needs review\", I assume that these were just not investigated yet.\n\n- asymptotics_multi...: LGTM, but see comment below this list.\n\n- growth_group.py, line 1196:\n\n```\nreturn richcmp(self._raw_element_, other._raw_element_, op)\n```\nThis does not make sense for a `GenericGrowthElement` (as there is no `<` on it defined).\n\n- growth_group.py, line 3643: The following was rewritten, but the new code is not equivalent to the old:\n\n```\n        return bool(abs(self.base) < abs(other.base)) or \\\n               bool(self.base == other.base)\n```\nvs\n\n```\n        if not isinstance(other, ExponentialGrowthElement):\n            return op == op_NE\n\n        lx = self.base\n        ly = other.base\n        if lx == ly:\n            return rich_to_bool(op, 0)\n\n        return richcmp(abs(lx), abs(ly), op)\n```\nFor example: `self.base=1`, `other.base=-1`, `op=op_LE` would incorrectly return `True`.\nI think, that this is the origin of the failing doctests.\n\n- term_monoid.py, lines 2915-2933: Maybe a matter of taste, but it looks like the code has blown up quite much (there is even some code doubling); this does not improve readability.\n\n- The patchbot reports also this:\n\n```\nFile \"src/sage/calculus/calculus.py\", line 1406, in sage.calculus.calculus.laplace\nFailed example:\n    laplace(t^n, t, s, algorithm='giac')\nExpected:\n    Traceback (most recent call last):\n    ...\n    NotImplementedError: Unable to parse Giac output: integrate(t^n*exp(-s*t),t,0,+infinity)\nGot:\n    integration(t^n*e^(-s*t), t, 0, +Infinity)\n```\nI have no glue why this is failing. I cannot imagine that this comes from the changes of this ticket. Any ideas?\n\nWhen the asymptotic expansion module was written, I had the change in comparison in my mind and tried to prepare everything for it, so that it will be easy at one point. This point seems to be now; I've partially reverted your changes and have prepared a own patch to address the issues of this ticket.\nOverall, the code now is much cleaner (compared to the original code) and I am satisified with it.\n\n- Can you please check: Is this is now still Python3 comparision-compatible? (I think so, but it is surely easier for you to tell. ;)\n\n- The main change was to introduce a kind of low-level `_richcmp_` which can be used more broadly. As a consequence only high-level `_eq_` and `_lt_` (very close to the Python 3 recommendation on how to implement comparison, but single underscores to use SageMath's convention on coercion) have to be implemented. I think this is a very convenient to implement new partial orders.\n\n- In asymptotics_multi..., I've deleted the the comparison `<`, as it is mathematically not meaningful and only needed in filtering out multiple factors in the denominator. There is now used a key, where this sorting is needed.\n \n---\nLast 10 new commits:",
    "created_at": "2017-04-21T06:35:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314821",
    "user": "https://github.com/dkrenn"
}
```

Dear Frédéric, I've reviewed your changes, but see comments below this list for a possible future of this ticket:

- Some doctests did not pass (see also the following comments); however, as this ticket was not set to "needs review", I assume that these were just not investigated yet.

- asymptotics_multi...: LGTM, but see comment below this list.

- growth_group.py, line 1196:

```
return richcmp(self._raw_element_, other._raw_element_, op)
```
This does not make sense for a `GenericGrowthElement` (as there is no `<` on it defined).

- growth_group.py, line 3643: The following was rewritten, but the new code is not equivalent to the old:

```
        return bool(abs(self.base) < abs(other.base)) or \
               bool(self.base == other.base)
```
vs

```
        if not isinstance(other, ExponentialGrowthElement):
            return op == op_NE

        lx = self.base
        ly = other.base
        if lx == ly:
            return rich_to_bool(op, 0)

        return richcmp(abs(lx), abs(ly), op)
```
For example: `self.base=1`, `other.base=-1`, `op=op_LE` would incorrectly return `True`.
I think, that this is the origin of the failing doctests.

- term_monoid.py, lines 2915-2933: Maybe a matter of taste, but it looks like the code has blown up quite much (there is even some code doubling); this does not improve readability.

- The patchbot reports also this:

```
File "src/sage/calculus/calculus.py", line 1406, in sage.calculus.calculus.laplace
Failed example:
    laplace(t^n, t, s, algorithm='giac')
Expected:
    Traceback (most recent call last):
    ...
    NotImplementedError: Unable to parse Giac output: integrate(t^n*exp(-s*t),t,0,+infinity)
Got:
    integration(t^n*e^(-s*t), t, 0, +Infinity)
```
I have no glue why this is failing. I cannot imagine that this comes from the changes of this ticket. Any ideas?

When the asymptotic expansion module was written, I had the change in comparison in my mind and tried to prepare everything for it, so that it will be easy at one point. This point seems to be now; I've partially reverted your changes and have prepared a own patch to address the issues of this ticket.
Overall, the code now is much cleaner (compared to the original code) and I am satisified with it.

- Can you please check: Is this is now still Python3 comparision-compatible? (I think so, but it is surely easier for you to tell. ;)

- The main change was to introduce a kind of low-level `_richcmp_` which can be used more broadly. As a consequence only high-level `_eq_` and `_lt_` (very close to the Python 3 recommendation on how to implement comparison, but single underscores to use SageMath's convention on coercion) have to be implemented. I think this is a very convenient to implement new partial orders.

- In asymptotics_multi..., I've deleted the the comparison `<`, as it is mathematically not meaningful and only needed in filtering out multiple factors in the denominator. There is now used a key, where this sorting is needed.
 
---
Last 10 new commits:



---

archive/issue_comments_314822.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-04-21T06:35:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314822",
    "user": "https://github.com/dkrenn"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_314823.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-25T12:26:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314823",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_314824.json:
```json
{
    "body": "Replying to [comment:11 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> |                                                                                                                                           |                                         |\n> |-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------|\n> |[12eb632](https://git.sagemath.org/sage.git/commit/?id=12eb632931b23787b8dc5597e05ff5bfc91aed0c)|`Trac #22828: remove meaningless doctest`|\n\n\nIs again at needs_review.",
    "created_at": "2017-04-25T12:29:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314824",
    "user": "https://github.com/dkrenn"
}
```

Replying to [comment:11 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> |                                                                                                                                           |                                         |
> |-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------|
> |[12eb632](https://git.sagemath.org/sage.git/commit/?id=12eb632931b23787b8dc5597e05ff5bfc91aed0c)|`Trac #22828: remove meaningless doctest`|


Is again at needs_review.



---

archive/issue_comments_314825.json:
```json
{
    "body": "Probably you should not care about the rubik failure, it should be a random thing.\n\nCould you please check that all tests pass in the asymptotic folder with this branch + the current branch of ticket #22297 ?",
    "created_at": "2017-04-27T15:30:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314825",
    "user": "https://github.com/fchapoton"
}
```

Probably you should not care about the rubik failure, it should be a random thing.

Could you please check that all tests pass in the asymptotic folder with this branch + the current branch of ticket #22297 ?



---

archive/issue_comments_314826.json:
```json
{
    "body": "Replying to [comment:13 chapoton]:\n> Probably you should not care about the rubik failure, it should be a random thing.\n\n\nI would guess so. I just find random failing doctests not very pleasing (from a global-SageMath-point-of-view).\n\n> Could you please check that all tests pass in the asymptotic folder with this branch + the current branch of ticket #22297 ?\n\n\nTests passed.",
    "created_at": "2017-04-27T17:30:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314826",
    "user": "https://github.com/dkrenn"
}
```

Replying to [comment:13 chapoton]:
> Probably you should not care about the rubik failure, it should be a random thing.


I would guess so. I just find random failing doctests not very pleasing (from a global-SageMath-point-of-view).

> Could you please check that all tests pass in the asymptotic folder with this branch + the current branch of ticket #22297 ?


Tests passed.



---

archive/issue_comments_314827.json:
```json
{
    "body": "looks ok, but you should not do that:\n\n```\n-from __future__ import absolute_import\n```\nplease add them back (at least twice), then you can set a positive review on my behalf.",
    "created_at": "2017-04-27T20:43:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314827",
    "user": "https://github.com/fchapoton"
}
```

looks ok, but you should not do that:

```
-from __future__ import absolute_import
```
please add them back (at least twice), then you can set a positive review on my behalf.



---

archive/issue_comments_314828.json:
```json
{
    "body": "Replying to [comment:15 chapoton]:\n> looks ok, but you should not do that:\n> \n> ```\n> -from __future__ import absolute_import\n> ```\n> please add them back (at least twice), then you can set a positive review on my behalf.\n\n\nThey are just moved below the copyright notice. (I've taken this change just as it was in the original patch provided by you...)",
    "created_at": "2017-04-28T06:13:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314828",
    "user": "https://github.com/dkrenn"
}
```

Replying to [comment:15 chapoton]:
> looks ok, but you should not do that:
> 
> ```
> -from __future__ import absolute_import
> ```
> please add them back (at least twice), then you can set a positive review on my behalf.


They are just moved below the copyright notice. (I've taken this change just as it was in the original patch provided by you...)



---

archive/issue_comments_314829.json:
```json
{
    "body": "ok, indeed. sorry for the noise.\n\nThen let it be.",
    "created_at": "2017-04-28T06:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314829",
    "user": "https://github.com/fchapoton"
}
```

ok, indeed. sorry for the noise.

Then let it be.



---

archive/issue_comments_314830.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-04-28T06:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314830",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_314831.json:
```json
{
    "body": "PDF docs don't build",
    "created_at": "2017-04-29T08:56:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314831",
    "user": "https://github.com/vbraun"
}
```

PDF docs don't build



---

archive/issue_comments_314832.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-04-29T08:56:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314832",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_314833.json:
```json
{
    "body": "Replying to [comment:18 vbraun]:\n> PDF docs don't build\n\n\nThis is not caused by this ticket. Building the Pdf (tried for reference/asymptotic) fails in a clean 8.0.beta4. Moreover, it fails already in 8.0.beta2, but seems to work in 7.6.\nWhat has changed?",
    "created_at": "2017-04-29T09:25:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314833",
    "user": "https://github.com/dkrenn"
}
```

Replying to [comment:18 vbraun]:
> PDF docs don't build


This is not caused by this ticket. Building the Pdf (tried for reference/asymptotic) fails in a clean 8.0.beta4. Moreover, it fails already in 8.0.beta2, but seems to work in 7.6.
What has changed?



---

archive/issue_comments_314834.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2017-04-29T09:25:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314834",
    "user": "https://github.com/dkrenn"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_314835.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-29T11:14:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314835",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_314836.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2017-04-29T11:16:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314836",
    "user": "https://github.com/dkrenn"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_314837.json:
```json
{
    "body": "Replying to [comment:19 dkrenn]:\n> Replying to [comment:18 vbraun]:\n> > PDF docs don't build\n\n> \n> This is not caused by this ticket. Building the Pdf (tried for reference/asymptotic) fails in a clean 8.0.beta4. Moreover, it fails already in 8.0.beta2, but seems to work in 7.6.\n> What has changed?\n\n\nOk, as this `iftex`-issue is now not anymore on my machine, I saw the true error (it is related to this ticket, sorry for my wrong assertion above) and changed it.",
    "created_at": "2017-04-29T11:16:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314837",
    "user": "https://github.com/dkrenn"
}
```

Replying to [comment:19 dkrenn]:
> Replying to [comment:18 vbraun]:
> > PDF docs don't build

> 
> This is not caused by this ticket. Building the Pdf (tried for reference/asymptotic) fails in a clean 8.0.beta4. Moreover, it fails already in 8.0.beta2, but seems to work in 7.6.
> What has changed?


Ok, as this `iftex`-issue is now not anymore on my machine, I saw the true error (it is related to this ticket, sorry for my wrong assertion above) and changed it.



---

archive/issue_comments_314838.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-04-29T11:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314838",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_314839.json:
```json
{
    "body": "ok, then",
    "created_at": "2017-04-29T11:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314839",
    "user": "https://github.com/fchapoton"
}
```

ok, then



---

archive/issue_events_059346.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-05-02T22:12:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22591#event-59346"
}
```



---

archive/issue_comments_314840.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-05-02T22:12:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22591#issuecomment-314840",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
