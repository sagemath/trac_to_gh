# Issue 24975: Fix malformatted test in sage.repl.ipython_extension

archive/issues_024975.json:
```json
{
    "body": "For some reason that I don't yet understand, on the main develop branch of Sage, the doctest runner is not complaining about this test even though it's syntactically malformatted.  Whereas on my Python 3 branch it is correctly reported as a syntax error.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25212\n\n",
    "created_at": "2018-04-19T09:02:32Z",
    "labels": [
        "component: misc",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Fix malformatted test in sage.repl.ipython_extension",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24975",
    "user": "https://github.com/embray"
}
```
For some reason that I don't yet understand, on the main develop branch of Sage, the doctest runner is not complaining about this test even though it's syntactically malformatted.  Whereas on my Python 3 branch it is correctly reported as a syntax error.

Issue created by migration from https://trac.sagemath.org/ticket/25212





---

archive/issue_comments_351124.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-04-19T09:03:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24975#issuecomment-351124",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_351125.json:
```json
{
    "body": "Shouldn't the test be:\n\n```\nsage: shell.run_cell('f()')\n```\n\nAdmittedly, I don't know exactly what is going on, but it looks like a different test.",
    "created_at": "2018-04-19T21:56:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24975#issuecomment-351125",
    "user": "https://github.com/tscrim"
}
```

Shouldn't the test be:

```
sage: shell.run_cell('f()')
```

Admittedly, I don't know exactly what is going on, but it looks like a different test.



---

archive/issue_comments_351126.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-04-20T10:16:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24975#issuecomment-351126",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_351127.json:
```json
{
    "body": "In other words, the right fix might be to replace\n\n```\n            ....: shell.run_cell('f()')\n```\n\nby\n\n```\n            sage: shell.run_cell('f()')\n```\n\ninstead of replacing it by\n\n```\n            sage: f()\n```\n",
    "created_at": "2018-04-20T10:57:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24975#issuecomment-351127",
    "user": "https://github.com/slel"
}
```

In other words, the right fix might be to replace

```
            ....: shell.run_cell('f()')
```

by

```
            sage: shell.run_cell('f()')
```

instead of replacing it by

```
            sage: f()
```




---

archive/issue_comments_351128.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-04-20T13:58:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24975#issuecomment-351128",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_351129.json:
```json
{
    "body": "It actually isn't.  I fact the latter won't work (it produces a `NameError`).  I'm not exactly sure why that is the case--I don't know how `get_test_shell` handles namespaces.  But I had that thought at first two and it does not work.  Compare also to the `%%fortran` test in the same module.",
    "created_at": "2018-04-20T13:58:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24975#issuecomment-351129",
    "user": "https://github.com/embray"
}
```

It actually isn't.  I fact the latter won't work (it produces a `NameError`).  I'm not exactly sure why that is the case--I don't know how `get_test_shell` handles namespaces.  But I had that thought at first two and it does not work.  Compare also to the `%%fortran` test in the same module.



---

archive/issue_comments_351130.json:
```json
{
    "body": "I guess you are defeating the whole purpose of the test then....",
    "created_at": "2018-04-20T14:02:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24975#issuecomment-351130",
    "user": "https://github.com/jdemeyer"
}
```

I guess you are defeating the whole purpose of the test then....



---

archive/issue_comments_351131.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-04-20T14:02:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24975#issuecomment-351131",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_351132.json:
```json
{
    "body": "It's not, nor do I think you're correctly interpreting the purpose of the test.\n\nI think the issue is this: `cython_compile` injects its result directly into the actual global namespace (`user_globals`).  `get_test_shell()` meanwhile implements a fake IPython shell for testing features thereof, ~~but takes care not to modify the actual global namespace~~ this appears to not exactly be true, but there's still something going on with how `cython_compile()` uses `user_globals`, and similarly with fortran I think.\n\nThat said, all the test is testing in this case is that `%%cython` magic works, like, syntactically.  So I think it's beside the point.",
    "created_at": "2018-04-20T14:06:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24975#issuecomment-351132",
    "user": "https://github.com/embray"
}
```

It's not, nor do I think you're correctly interpreting the purpose of the test.

I think the issue is this: `cython_compile` injects its result directly into the actual global namespace (`user_globals`).  `get_test_shell()` meanwhile implements a fake IPython shell for testing features thereof, ~~but takes care not to modify the actual global namespace~~ this appears to not exactly be true, but there's still something going on with how `cython_compile()` uses `user_globals`, and similarly with fortran I think.

That said, all the test is testing in this case is that `%%cython` magic works, like, syntactically.  So I think it's beside the point.



---

archive/issue_comments_351133.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-04-20T14:06:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24975#issuecomment-351133",
    "user": "https://github.com/embray"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_351134.json:
```json
{
    "body": "Ok, I take it back.  It seems like this does work at the command-line, but it does not work correctly in the doctests themselves.  So there's a weird interaction between the doctest runner, the test shell, and user_globals. \n\nI think that problem must have existed for a while though considering that\n\na) This test was already broken for a long time but not being run.\n\nand\n\nb) The other similar test in this module seems to already be working around the same issue.",
    "created_at": "2018-04-20T14:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24975#issuecomment-351134",
    "user": "https://github.com/embray"
}
```

Ok, I take it back.  It seems like this does work at the command-line, but it does not work correctly in the doctests themselves.  So there's a weird interaction between the doctest runner, the test shell, and user_globals. 

I think that problem must have existed for a while though considering that

a) This test was already broken for a long time but not being run.

and

b) The other similar test in this module seems to already be working around the same issue.



---

archive/issue_comments_351135.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-04-20T14:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24975#issuecomment-351135",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_351136.json:
```json
{
    "body": "I believe this issue can reasonably be addressed for Sage 8.4.",
    "created_at": "2018-07-18T11:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24975#issuecomment-351136",
    "user": "https://github.com/embray"
}
```

I believe this issue can reasonably be addressed for Sage 8.4.



---

archive/issue_comments_351137.json:
```json
{
    "body": "Fixed in #26038.",
    "created_at": "2018-08-10T14:43:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24975#issuecomment-351137",
    "user": "https://github.com/jdemeyer"
}
```

Fixed in #26038.



---

archive/issue_comments_351138.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2018-08-10T14:43:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24975",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24975#issuecomment-351138",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: duplicate



---

archive/issue_events_023286.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2018-08-10T14:43:56Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24975",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24975#event-23286"
}
```
