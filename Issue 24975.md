# Issue 24975: Fix malformatted test in sage.repl.ipython_extension

Issue created by migration from https://trac.sagemath.org/ticket/25212

Original creator: embray

Original creation time: 2018-04-19 09:02:32

For some reason that I don't yet understand, on the main develop branch of Sage, the doctest runner is not complaining about this test even though it's syntactically malformatted.  Whereas on my Python 3 branch it is correctly reported as a syntax error.


---

Comment by embray created at 2018-04-19 09:03:04

Changing status from new to needs_review.


---

Comment by tscrim created at 2018-04-19 21:56:57

Shouldn't the test be:

```
sage: shell.run_cell('f()')
```

Admittedly, I don't know exactly what is going on, but it looks like a different test.


---

Comment by jdemeyer created at 2018-04-20 10:16:51

Changing status from needs_review to needs_work.


---

Comment by slelievre created at 2018-04-20 10:57:41

In other words, the right fix might be to replace

```
            ....: shell.run_cell('f()')
```

by

```
            sage: shell.run_cell('f()')
```

instead of replacing it by

```
            sage: f()
```



---

Comment by embray created at 2018-04-20 13:58:51

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-04-20 13:58:51

It actually isn't.  I fact the latter won't work (it produces a `NameError`).  I'm not exactly sure why that is the case--I don't know how `get_test_shell` handles namespaces.  But I had that thought at first two and it does not work.  Compare also to the `%%fortran` test in the same module.


---

Comment by jdemeyer created at 2018-04-20 14:02:02

I guess you are defeating the whole purpose of the test then....


---

Comment by jdemeyer created at 2018-04-20 14:02:02

Changing status from needs_review to needs_info.


---

Comment by embray created at 2018-04-20 14:06:41

It's not, nor do I think you're correctly interpreting the purpose of the test.

I think the issue is this: `cython_compile` injects its result directly into the actual global namespace (`user_globals`).  `get_test_shell()` meanwhile implements a fake IPython shell for testing features thereof, ~~but takes care not to modify the actual global namespace~~ this appears to not exactly be true, but there's still something going on with how `cython_compile()` uses `user_globals`, and similarly with fortran I think.

That said, all the test is testing in this case is that `%%cython` magic works, like, syntactically.  So I think it's beside the point.


---

Comment by embray created at 2018-04-20 14:06:52

Changing status from needs_info to needs_review.


---

Comment by embray created at 2018-04-20 14:22:03

Ok, I take it back.  It seems like this does work at the command-line, but it does not work correctly in the doctests themselves.  So there's a weird interaction between the doctest runner, the test shell, and user_globals. 

I think that problem must have existed for a while though considering that

a) This test was already broken for a long time but not being run.

and

b) The other similar test in this module seems to already be working around the same issue.


---

Comment by embray created at 2018-04-20 14:22:03

Changing status from needs_review to needs_info.


---

Comment by embray created at 2018-07-18 11:47:03

I believe this issue can reasonably be addressed for Sage 8.4.


---

Comment by jdemeyer created at 2018-08-10 14:43:56

Fixed in #26038.


---

Comment by jdemeyer created at 2018-08-10 14:43:56

Resolution: duplicate
