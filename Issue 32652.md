# Issue 32652: Move graphs methods to Polyhedron_base4

archive/issues_032652.json:
```json
{
    "body": "CC:  @mkoeppe\n\nPart of #32651.\n\nWe also move `neighborliness` to `Polyhedron_base3` (missed on #32884)\nand `_sage_input_` and `_delete` to `Polyhedron_base0`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/32889\n\n",
    "created_at": "2021-11-17T07:02:24Z",
    "labels": [
        "component: geometry"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Move graphs methods to Polyhedron_base4",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32652",
    "user": "https://github.com/kliem"
}
```
CC:  @mkoeppe

Part of #32651.

We also move `neighborliness` to `Polyhedron_base3` (missed on #32884)
and `_sage_input_` and `_delete` to `Polyhedron_base0`.

Issue created by migration from https://trac.sagemath.org/ticket/32889





---

archive/issue_comments_465260.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-11-17T07:02:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32652",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32652#issuecomment-465260",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_465261.json:
```json
{
    "body": "Pyflakes plugin patchbot says:\n\n```\nsrc/sage/geometry/polyhedron/base.py:1378:17 'sage.graphs.graph' imported but unused\nsrc/sage/geometry/polyhedron/base.py:3876:17 'sage.graphs.graph' imported but unused\nsrc/sage/geometry/polyhedron/base3.py:1941:17 'sage.graphs.graph' imported but unused\nsrc/sage/geometry/polyhedron/base4.py:1186:13 'sage.graphs.graph' imported but unused\n```\n\n\nI just also mentionned it in\nhttps://trac.sagemath.org/ticket/32174#comment:41\nbut I guess it is better to fix that here to avoid later conflicts.",
    "created_at": "2021-11-17T20:00:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32652",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32652#issuecomment-465261",
    "user": "https://github.com/seblabbe"
}
```

Pyflakes plugin patchbot says:

```
src/sage/geometry/polyhedron/base.py:1378:17 'sage.graphs.graph' imported but unused
src/sage/geometry/polyhedron/base.py:3876:17 'sage.graphs.graph' imported but unused
src/sage/geometry/polyhedron/base3.py:1941:17 'sage.graphs.graph' imported but unused
src/sage/geometry/polyhedron/base4.py:1186:13 'sage.graphs.graph' imported but unused
```


I just also mentionned it in
https://trac.sagemath.org/ticket/32174#comment:41
but I guess it is better to fix that here to avoid later conflicts.



---

archive/issue_comments_465262.json:
```json
{
    "body": "There is a failing doctest on the patchbot, but maybe it is unrelated:\n\n```\nsage -t --long --random-seed=257293673212457698646690051018428858654 src/sage/geometry/hyperbolic_space/hyperbolic_model.py\n**********************************************************************\nFile \"src/sage/geometry/hyperbolic_space/hyperbolic_model.py\", line 567, in sage.geometry.hyperbolic_space.hyperbolic_model.HyperbolicModel.random_geodesic\nFailed example:\n    bool((h.endpoints()[0].coordinates()).imag() >= 0)\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n1 item had failures:\n   1 of   3 in sage.geometry.hyperbolic_space.hyperbolic_model.HyperbolicModel.random_geodesic\n    [234 tests, 1 failure, 1.55 s]\n```\n",
    "created_at": "2021-11-17T20:02:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32652",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32652#issuecomment-465262",
    "user": "https://github.com/seblabbe"
}
```

There is a failing doctest on the patchbot, but maybe it is unrelated:

```
sage -t --long --random-seed=257293673212457698646690051018428858654 src/sage/geometry/hyperbolic_space/hyperbolic_model.py
**********************************************************************
File "src/sage/geometry/hyperbolic_space/hyperbolic_model.py", line 567, in sage.geometry.hyperbolic_space.hyperbolic_model.HyperbolicModel.random_geodesic
Failed example:
    bool((h.endpoints()[0].coordinates()).imag() >= 0)
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of   3 in sage.geometry.hyperbolic_space.hyperbolic_model.HyperbolicModel.random_geodesic
    [234 tests, 1 failure, 1.55 s]
```




---

archive/issue_comments_465263.json:
```json
{
    "body": "Replying to [comment:2 slabbe]:\n> Pyflakes plugin patchbot says:\n> {{{\n> src/sage/geometry/polyhedron/base.py:1378:17 'sage.graphs.graph' imported but unused\n> src/sage/geometry/polyhedron/base.py:3876:17 'sage.graphs.graph' imported but unused\n> src/sage/geometry/polyhedron/base3.py:1941:17 'sage.graphs.graph' imported but unused\n> src/sage/geometry/polyhedron/base4.py:1186:13 'sage.graphs.graph' imported but unused\n> }}}\n> \n> I just also mentionned it in\n\n> #32174#comment:41\n> but I guess it is better to fix that here to avoid later conflicts.\n\nNothing new, just moved that code. It's all in test methods, that do not test in case features relying on graphs. E.g.\n\n\n```\n    def _test_combinatorial_face_as_combinatorial_polyhedron(self, tester=None, **options):\n    ...\n        try:\n            import sage.graphs.graph\n        except:\n            pass\n        else:\n            tester.assertTrue(P.combinatorial_polyhedron().vertex_facet_graph().is_isomorphic(D1.vertex_facet_graph()))\n    ...\n```\n",
    "created_at": "2021-11-17T20:05:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32652",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32652#issuecomment-465263",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:2 slabbe]:
> Pyflakes plugin patchbot says:
> {{{
> src/sage/geometry/polyhedron/base.py:1378:17 'sage.graphs.graph' imported but unused
> src/sage/geometry/polyhedron/base.py:3876:17 'sage.graphs.graph' imported but unused
> src/sage/geometry/polyhedron/base3.py:1941:17 'sage.graphs.graph' imported but unused
> src/sage/geometry/polyhedron/base4.py:1186:13 'sage.graphs.graph' imported but unused
> }}}
> 
> I just also mentionned it in

> #32174#comment:41
> but I guess it is better to fix that here to avoid later conflicts.

Nothing new, just moved that code. It's all in test methods, that do not test in case features relying on graphs. E.g.


```
    def _test_combinatorial_face_as_combinatorial_polyhedron(self, tester=None, **options):
    ...
        try:
            import sage.graphs.graph
        except:
            pass
        else:
            tester.assertTrue(P.combinatorial_polyhedron().vertex_facet_graph().is_isomorphic(D1.vertex_facet_graph()))
    ...
```




---

archive/issue_comments_465264.json:
```json
{
    "body": "Replying to [comment:3 slabbe]:\n> There is a failing doctest on the patchbot, but maybe it is unrelated:\n> {{{\n> sage -t --long --random-seed=257293673212457698646690051018428858654 src/sage/geometry/hyperbolic_space/hyperbolic_model.py\n> **********************************************************************\n> File \"src/sage/geometry/hyperbolic_space/hyperbolic_model.py\", line 567, in sage.geometry.hyperbolic_space.hyperbolic_model.HyperbolicModel.random_geodesic\n> Failed example:\n>     bool((h.endpoints()[0].coordinates()).imag() >= 0)\n> Expected:\n>     True\n> Got:\n>     False\n> **********************************************************************\n> 1 item had failures:\n>    1 of   3 in sage.geometry.hyperbolic_space.hyperbolic_model.HyperbolicModel.random_geodesic\n>     [234 tests, 1 failure, 1.55 s]\n> }}}\n\nI opened #32891.",
    "created_at": "2021-11-17T20:07:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32652",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32652#issuecomment-465264",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:3 slabbe]:
> There is a failing doctest on the patchbot, but maybe it is unrelated:
> {{{
> sage -t --long --random-seed=257293673212457698646690051018428858654 src/sage/geometry/hyperbolic_space/hyperbolic_model.py
> **********************************************************************
> File "src/sage/geometry/hyperbolic_space/hyperbolic_model.py", line 567, in sage.geometry.hyperbolic_space.hyperbolic_model.HyperbolicModel.random_geodesic
> Failed example:
>     bool((h.endpoints()[0].coordinates()).imag() >= 0)
> Expected:
>     True
> Got:
>     False
> **********************************************************************
> 1 item had failures:
>    1 of   3 in sage.geometry.hyperbolic_space.hyperbolic_model.HyperbolicModel.random_geodesic
>     [234 tests, 1 failure, 1.55 s]
> }}}

I opened #32891.



---

archive/issue_comments_465265.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-11-17T22:56:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32652",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32652#issuecomment-465265",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_465266.json:
```json
{
    "body": "Replying to [comment:4 gh-kliem]:\n> Replying to [comment:2 slabbe]:\n> > Pyflakes plugin patchbot says:\n> > {{{\n> > src/sage/geometry/polyhedron/base.py:1378:17 'sage.graphs.graph' imported but unused\n> > src/sage/geometry/polyhedron/base.py:3876:17 'sage.graphs.graph' imported but unused\n> > src/sage/geometry/polyhedron/base3.py:1941:17 'sage.graphs.graph' imported but unused\n> > src/sage/geometry/polyhedron/base4.py:1186:13 'sage.graphs.graph' imported but unused\n> > }}}\n> > \n> > I just also mentionned it in\n> \n> > #32174#comment:41\n> > but I guess it is better to fix that here to avoid later conflicts.\n> \n> Nothing new, just moved that code. It's all in test methods, that do not test in case features relying on graphs. E.g.\n> \n> {{{\n>     def _test_combinatorial_face_as_combinatorial_polyhedron(self, tester=None, **options):\n>     ...\n>         try:\n>             import sage.graphs.graph\n>         except:\n>             pass\n>         else:\n>             tester.assertTrue(P.combinatorial_polyhedron().vertex_facet_graph().is_isomorphic(D1.vertex_facet_graph()))\n>     ...\n> }}}\n> \n\nInstead of\n\n\n```\ntry:\n    import sage.graphs.graphh\nexcept ImportError:\n    pass\nelse:\n    # do something\n```\n\n\nWe could also do something as:\n\n\n```\nfrom importlib.util import find_spec\nif find_spec(\"sage.graphs\") and find_spec(\"sage.graphs.graph\"):\n    # do something\n```\n",
    "created_at": "2021-11-18T06:44:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32652",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32652#issuecomment-465266",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:4 gh-kliem]:
> Replying to [comment:2 slabbe]:
> > Pyflakes plugin patchbot says:
> > {{{
> > src/sage/geometry/polyhedron/base.py:1378:17 'sage.graphs.graph' imported but unused
> > src/sage/geometry/polyhedron/base.py:3876:17 'sage.graphs.graph' imported but unused
> > src/sage/geometry/polyhedron/base3.py:1941:17 'sage.graphs.graph' imported but unused
> > src/sage/geometry/polyhedron/base4.py:1186:13 'sage.graphs.graph' imported but unused
> > }}}
> > 
> > I just also mentionned it in
> 
> > #32174#comment:41
> > but I guess it is better to fix that here to avoid later conflicts.
> 
> Nothing new, just moved that code. It's all in test methods, that do not test in case features relying on graphs. E.g.
> 
> {{{
>     def _test_combinatorial_face_as_combinatorial_polyhedron(self, tester=None, **options):
>     ...
>         try:
>             import sage.graphs.graph
>         except:
>             pass
>         else:
>             tester.assertTrue(P.combinatorial_polyhedron().vertex_facet_graph().is_isomorphic(D1.vertex_facet_graph()))
>     ...
> }}}
> 

Instead of


```
try:
    import sage.graphs.graphh
except ImportError:
    pass
else:
    # do something
```


We could also do something as:


```
from importlib.util import find_spec
if find_spec("sage.graphs") and find_spec("sage.graphs.graph"):
    # do something
```




---

archive/issue_comments_465267.json:
```json
{
    "body": "Or can we use newly introduced sage features as in:\n\n```\nfrom sage.features.sagemath import sage__graphs\nif sage__graphs().is_present():\n   ...\n```\n\n?",
    "created_at": "2021-11-18T11:39:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32652",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32652#issuecomment-465267",
    "user": "https://github.com/seblabbe"
}
```

Or can we use newly introduced sage features as in:

```
from sage.features.sagemath import sage__graphs
if sage__graphs().is_present():
   ...
```

?



---

archive/issue_comments_465268.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-11-19T00:46:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32652",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32652#issuecomment-465268",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_465269.json:
```json
{
    "body": "Looks like this has a merge conflict with 9.5.beta7",
    "created_at": "2021-11-19T00:46:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32652",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32652#issuecomment-465269",
    "user": "https://github.com/mkoeppe"
}
```

Looks like this has a merge conflict with 9.5.beta7



---

archive/issue_comments_465270.json:
```json
{
    "body": "That is what happend since 9.5.beta6:\n\n```diff\ngit diff develop 6ec717a56dcb0fd629ca850d9b9391ea8d96ccac base.py\ndiff --git a/src/sage/geometry/polyhedron/base.py b/src/sage/geometry/polyhedron/base.py\nindex c1d27faebd..23e6889087 100644\n--- a/src/sage/geometry/polyhedron/base.py\n+++ b/src/sage/geometry/polyhedron/base.py\n@@ -7225,7 +7225,7 @@ class Polyhedron_base(Polyhedron_base1):\n             sage: Q.volume.is_in_cache()\n             True\n         \"\"\"\n-        from sage.features import FeatureNotPresentError\n+        from sage.features import FeatureNotPresentError, PythonModule\n         if measure == 'induced_rational' and engine not in ['auto', 'latte', 'normaliz']:\n             raise RuntimeError(\"the induced rational measure can only be computed with the engine set to `auto`, `latte`, or `normaliz`\")\n         if measure == 'induced_lattice' and engine not in ['auto', 'latte', 'normaliz']:\n@@ -7237,18 +7237,16 @@ class Polyhedron_base(Polyhedron_base1):\n                 Latte().require()\n                 engine = 'latte'\n             except FeatureNotPresentError:\n-                from sage.features.normaliz import PyNormaliz\n                 try:\n-                    PyNormaliz().require()\n+                    PythonModule(\"PyNormaliz\", spkg=\"pynormaliz\").require()\n                     engine = 'normaliz'\n                 except FeatureNotPresentError:\n                     raise RuntimeError(\"the induced rational measure can only be computed with the optional packages `latte_int`, or `pynormaliz`\")\n \n         if engine == 'auto' and measure == 'induced_lattice':\n             # Enforce a default choice, change if a better engine is found.\n-            from sage.features.normaliz import PyNormaliz\n             try:\n-                PyNormaliz().require()\n+                PythonModule(\"PyNormaliz\", spkg=\"pynormaliz\").require()\n                 engine = 'normaliz'\n             except FeatureNotPresentError:\n                 try:\n```\n",
    "created_at": "2021-11-19T19:15:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32652",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32652#issuecomment-465270",
    "user": "https://github.com/kliem"
}
```

That is what happend since 9.5.beta6:

```diff
git diff develop 6ec717a56dcb0fd629ca850d9b9391ea8d96ccac base.py
diff --git a/src/sage/geometry/polyhedron/base.py b/src/sage/geometry/polyhedron/base.py
index c1d27faebd..23e6889087 100644
--- a/src/sage/geometry/polyhedron/base.py
+++ b/src/sage/geometry/polyhedron/base.py
@@ -7225,7 +7225,7 @@ class Polyhedron_base(Polyhedron_base1):
             sage: Q.volume.is_in_cache()
             True
         """
-        from sage.features import FeatureNotPresentError
+        from sage.features import FeatureNotPresentError, PythonModule
         if measure == 'induced_rational' and engine not in ['auto', 'latte', 'normaliz']:
             raise RuntimeError("the induced rational measure can only be computed with the engine set to `auto`, `latte`, or `normaliz`")
         if measure == 'induced_lattice' and engine not in ['auto', 'latte', 'normaliz']:
@@ -7237,18 +7237,16 @@ class Polyhedron_base(Polyhedron_base1):
                 Latte().require()
                 engine = 'latte'
             except FeatureNotPresentError:
-                from sage.features.normaliz import PyNormaliz
                 try:
-                    PyNormaliz().require()
+                    PythonModule("PyNormaliz", spkg="pynormaliz").require()
                     engine = 'normaliz'
                 except FeatureNotPresentError:
                     raise RuntimeError("the induced rational measure can only be computed with the optional packages `latte_int`, or `pynormaliz`")
 
         if engine == 'auto' and measure == 'induced_lattice':
             # Enforce a default choice, change if a better engine is found.
-            from sage.features.normaliz import PyNormaliz
             try:
-                PyNormaliz().require()
+                PythonModule("PyNormaliz", spkg="pynormaliz").require()
                 engine = 'normaliz'
             except FeatureNotPresentError:
                 try:
```




---

archive/issue_comments_465271.json:
```json
{
    "body": "The version with `from sage.features.normaliz import PyNormaliz` is the better one. (from #27744)",
    "created_at": "2021-11-19T20:27:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32652",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32652#issuecomment-465271",
    "user": "https://github.com/mkoeppe"
}
```

The version with `from sage.features.normaliz import PyNormaliz` is the better one. (from #27744)



---

archive/issue_comments_465272.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-11-19T20:35:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32652",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32652#issuecomment-465272",
    "user": "https://github.com/kliem"
}
```

New commits:



---

archive/issue_comments_465273.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-11-19T20:35:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32652",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32652#issuecomment-465273",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_465274.json:
```json
{
    "body": "Replying to [comment:11 mkoeppe]:\n> The version with `from sage.features.normaliz import PyNormaliz` is the better one. (from #27744)\n\nYes, that is the version I based in upon. Wasn't easy. The merge conflict file was huge.\n\nSo what I did was pull `u/gh-kliem/Polyhedron_base3` into `develop`. Then undid #27744 in `base.py`. Then I pulled `u/gh-kliem/Polyhedron_base4`. Redid #27744 and then squashed the three commits.",
    "created_at": "2021-11-19T20:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32652",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32652#issuecomment-465274",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:11 mkoeppe]:
> The version with `from sage.features.normaliz import PyNormaliz` is the better one. (from #27744)

Yes, that is the version I based in upon. Wasn't easy. The merge conflict file was huge.

So what I did was pull `u/gh-kliem/Polyhedron_base3` into `develop`. Then undid #27744 in `base.py`. Then I pulled `u/gh-kliem/Polyhedron_base4`. Redid #27744 and then squashed the three commits.



---

archive/issue_comments_465275.json:
```json
{
    "body": "Thanks, this looks good",
    "created_at": "2021-11-20T00:06:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32652",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32652#issuecomment-465275",
    "user": "https://github.com/mkoeppe"
}
```

Thanks, this looks good



---

archive/issue_comments_465276.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-11-20T00:06:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32652",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32652#issuecomment-465276",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_465277.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-12-23T20:26:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32652",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32652#issuecomment-465277",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
