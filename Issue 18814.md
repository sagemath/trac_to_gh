# Issue 18814: NTL sublinking

Issue created by migration from Trac.

Original creator: gouezel

Original creation time: 2015-08-18 11:23:58

CC:  jdemeyer

Cygwin compilation fails because several files should link to NTL. 


---

Comment by gouezel created at 2015-08-18 11:27:17

Changing status from new to needs_review.


---

Comment by gouezel created at 2015-08-18 11:27:17

There is also an unrelated linking problem, in `farey_symbol`, that I don't understand. It can be fixed either in this ticket, or later.

Relevant part of the log:

```
g++ -shared -Wl,--enable-auto-image-base -L/home/Sebastien/sage15/sage/local/lib build/temp.cygwin-2.2.0-x86_64-2.7/home/Sebastien/sage15/sage/src/build/cythonized/sage/modular/arithgroup/farey_symbol.o build/temp.cygwin-2.2.0-x86_64-2.7/sage/modular/arithgroup/farey.o build/temp.cygwin-2.2.0-x86_64-2.7/sage/modular/arithgroup/sl2z.o -L/home/Sebastien/sage15/sage/local/lib -L/home/Sebastien/sage15/sage/local/lib/python2.7/config -L/home/Sebastien/sage15/sage/local/lib -lntl -lgmp -lgmpxx -lstdc++ -lpython2.7 -o build/lib.cygwin-2.2.0-x86_64-2.7/sage/modular/arithgroup/farey_symbol.dll
build/temp.cygwin-2.2.0-x86_64-2.7/sage/modular/arithgroup/farey.o: dans la fonction « FareySymbol::get_coset() const »:
/home/Sebastien/sage15/sage/src/sage/modular/arithgroup/farey.cpp:1023: référence indéfinie vers « __imp_convert_to_SL2Z »
...
```


Any hint welcome!


---

Comment by jdemeyer created at 2015-08-18 18:59:59

Can you tell me _why_ it fails? I think until recently, this extra NTL linking was not needed. Maybe we are simply doing something wrong with the headers, since I don't think those modules actually use NTL.


---

Comment by jdemeyer created at 2015-08-18 18:59:59

Changing status from needs_review to needs_info.


---

Comment by gouezel created at 2015-08-18 19:34:04

No, I don't know why it fails. It used to work in 6.8.beta2, and did not work in 6.8.beta8. Didn't you do a big cleanup at some time to remove unnecessary includes in many files? It might be related.

For the record, here is part of the log when ntl is not added (last line might be relevant):

```
[ 30/415] gcc -I/usr/include/ncurses -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -I/home/Sebastien/sage15/sage/local/include -I/home/Sebastien/sage15/sage/local/include/python2.7 -I/home/Sebastien/sage15/sage/local/lib/python2.7/site-packages/numpy/core/include -I/home/Sebastien/sage15/sage/src -I/home/Sebastien/sage15/sage/src/sage/ext -I/home/Sebastien/sage15/sage/src/build/cythonized -I/home/Sebastien/sage15/sage/src/build/cythonized/sage/ext -I/home/Sebastien/sage15/sage/local/include/python2.7 -c /home/Sebastien/sage15/sage/src/build/cythonized/sage/combinat/designs/evenly_distributed_sets.c -o build/temp.cygwin-2.2.0-x86_64-2.7/home/Sebastien/sage15/sage/src/build/cythonized/sage/combinat/designs/evenly_distributed_sets.o -fno-strict-aliasing -w
gcc -I/usr/include/ncurses -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -I/home/Sebastien/sage15/sage/local/include -I/home/Sebastien/sage15/sage/local/include/python2.7 -I/home/Sebastien/sage15/sage/local/lib/python2.7/site-packages/numpy/core/include -I/home/Sebastien/sage15/sage/src -I/home/Sebastien/sage15/sage/src/sage/ext -I/home/Sebastien/sage15/sage/src/build/cythonized -I/home/Sebastien/sage15/sage/src/build/cythonized/sage/ext -I/home/Sebastien/sage15/sage/local/include/python2.7 -c sage/combinat/partitions_c.cc -o build/temp.cygwin-2.2.0-x86_64-2.7/sage/combinat/partitions_c.o -fno-strict-aliasing -w
g++ -shared -Wl,--enable-auto-image-base -L/home/Sebastien/sage15/sage/local/lib build/temp.cygwin-2.2.0-x86_64-2.7/home/Sebastien/sage15/sage/src/build/cythonized/sage/combinat/partitions.o build/temp.cygwin-2.2.0-x86_64-2.7/sage/combinat/partitions_c.o -L/home/Sebastien/sage15/sage/local/lib -L/home/Sebastien/sage15/sage/local/lib/python2.7/config -L/home/Sebastien/sage15/sage/local/lib -lmpfr -lgmp -lstdc++ -lpython2.7 -o build/lib.cygwin-2.2.0-x86_64-2.7/sage/combinat/partitions.dll
build/temp.cygwin-2.2.0-x86_64-2.7/home/Sebastien/sage15/sage/src/build/cythonized/sage/combinat/partitions.o: dans la fonction « ZZ_pEX_conv_modulus(NTL::ZZ_pEX&, NTL::ZZ_pEX const&, NTL::ZZ_pContext const&) »:
/home/Sebastien/sage15/sage/src/sage/libs/ntl/ntlwrap.cpp:697: référence indéfinie vers « NTL::ZZ_pContext::restore() const »
/home/Sebastien/sage15/sage/src/sage/libs/ntl/ntlwrap.cpp:697:(.text+0xa065): relocalisation tronquée pour concorder avec la taille: R_X86_64_PC32 vers le symbole indéfini NTL::ZZ_pContext::restore() const
...
/home/Sebastien/sage15/sage/local/include/NTL/tools.h:511: référence indéfinie vers « NTL::TerminalError(char const*) »
build/temp.cygwin-2.2.0-x86_64-2.7/home/Sebastien/sage15/sage/src/build/cythonized/sage/combinat/partitions.o:partitions.cpp:(.rdata$.refptr._ZN3NTL8ZZ_pInfoE[.refptr._ZN3NTL8ZZ_pInfoE]+0x0): référence indéfinie vers « NTL::ZZ_pInfo »
collect2: erreur: ld a retourné 1 code d'état d'exécution
```



---

Comment by jdemeyer created at 2015-08-18 20:56:20

Please check if #19054 solves your problem. I'm pretty sure it is _part_ of the problem at least.


---

Comment by fbissey created at 2015-08-19 00:24:41

Outputs from `ldd -r` before and after applying #19504

```
        linux-vdso.so.1 (0x00007fff807ff000)
        libgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007f048acb5000)
        libgmpxx.so.4 => /usr/lib64/libgmpxx.so.4 (0x00007f048aaaf000)
        libstdc++.so.6 => /usr/lib/gcc/x86_64-pc-linux-gnu/4.9.3/libstdc++.so.6 (0x00007f048a79f000)
        libpython2.7.so.1.0 => /usr/lib64/libpython2.7.so.1.0 (0x00007f048a3e0000)
        libgcc_s.so.1 => /usr/lib/gcc/x86_64-pc-linux-gnu/4.9.3/libgcc_s.so.1 (0x00007f048a1c9000)
        libc.so.6 => /lib64/libc.so.6 (0x00007f0489e2b000)
        libm.so.6 => /lib64/libm.so.6 (0x00007f0489b27000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f048b1bd000)
        libpthread.so.0 => /lib64/libpthread.so.0 (0x00007f048990c000)
        libdl.so.2 => /lib64/libdl.so.2 (0x00007f0489707000)
        libutil.so.1 => /lib64/libutil.so.1 (0x00007f0489504000)
undefined symbol: _ZN3NTL8ZZ_pInfoE     (/usr/lib64/python2.7/site-packages/sage/modular/arithgroup/farey_symbol.so)
undefined symbol: _Z9_ntl_gmodPvS_PS_   (/usr/lib64/python2.7/site-packages/sage/modular/arithgroup/farey_symbol.so)
undefined symbol: _ZN3NTL5ZZ_pX9normalizeEv     (/usr/lib64/python2.7/site-packages/sage/modular/arithgroup/farey_symbol.so)
undefined symbol: _ZN3NTL13TerminalErrorEPKc    (/usr/lib64/python2.7/site-packages/sage/modular/arithgroup/farey_symbol.so)
undefined symbol: _ZN3NTL14BlockConstructEPNS_4ZZ_pEl   (/usr/lib64/python2.7/site-packages/sage/modular/arithgroup/farey_symbol.so)
undefined symbol: _ZNK3NTL11ZZ_pContext7restoreEv       (/usr/lib64/python2.7/site-packages/sage/modular/arithgroup/farey_symbol.so)
undefined symbol: _ZN3NTL6ZZ_pEX9normalizeEv    (/usr/lib64/python2.7/site-packages/sage/modular/arithgroup/farey_symbol.so)
```

and after

```
        linux-vdso.so.1 (0x00007fff98147000)
        libgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007fdf1ed4f000)
        libgmpxx.so.4 => /usr/lib64/libgmpxx.so.4 (0x00007fdf1eb49000)
        libstdc++.so.6 => /usr/lib/gcc/x86_64-pc-linux-gnu/4.9.3/libstdc++.so.6 (0x00007fdf1e839000)
        libpython2.7.so.1.0 => /usr/lib64/libpython2.7.so.1.0 (0x00007fdf1e47a000)
        libgcc_s.so.1 => /usr/lib/gcc/x86_64-pc-linux-gnu/4.9.3/libgcc_s.so.1 (0x00007fdf1e263000)
        libc.so.6 => /lib64/libc.so.6 (0x00007fdf1dec5000)
        libm.so.6 => /lib64/libm.so.6 (0x00007fdf1dbc1000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fdf1f256000)
        libpthread.so.0 => /lib64/libpthread.so.0 (0x00007fdf1d9a6000)
        libdl.so.2 => /lib64/libdl.so.2 (0x00007fdf1d7a1000)
        libutil.so.1 => /lib64/libutil.so.1 (0x00007fdf1d59e000)
```

So it seems quite conclusive, there are probably a few other instances fixed by it.


---

Comment by fbissey created at 2015-08-19 01:38:21

I checked all the shared libraries that would be affected by the branch attached to this ticket and #15904 make the missing symbols from ntl disappear from all of them. So I think we can close this one as a duplicate.


---

Comment by gouezel created at 2015-08-19 08:54:52

Changing status from needs_info to positive_review.


---

Comment by gouezel created at 2015-08-19 08:54:52

Indeed, all linking problems to NTL are fixed by #19054.

On the other hand, the problem in `farey_symbols` explained in the first comment is still there. Any idea?


---

Comment by fbissey created at 2015-08-19 09:01:47

Replying to [comment:7 gouezel]:
> Indeed, all linking problems to NTL are fixed by #19054.
> 
> On the other hand, the problem in `farey_symbols` explained in the first comment is still there. Any idea?

No idea. `farey_symbols` is the first library I checked and is the one for which I posted the `ldd -r` output in my earlier comment. I am surprised the problem persist during compilation on cygwin.


---

Comment by gouezel created at 2015-08-19 09:04:56

Note that this problem is not NTL-related, this is a different issue (for which I should definitely open a new ticket...)


---

Comment by fbissey created at 2015-08-19 09:15:39

Right, now I see. I don't know where that would be coming from. On linux we don't seem to have any undefined references. We have to track down where this symbol is coming from.


---

Comment by fbissey created at 2015-08-19 09:38:05

I think it may be a linking order problem. `convert_to_SL2Z` is defined in `farey_symbols.pyx` and `farey_symbols.o` is before `farey.o` on the linking line.


---

Comment by gouezel created at 2015-08-19 13:02:14

I already tried a different linking order, it does not make any difference.

Here is the difference between (working) sage.6.8.beta2 and (failing) sage.6.9.beta2 regarding symbols:

in 6.8.beta2:

```
nm /home/Sebastien/sage13/sage/local/lib build/temp.cygwin-1.7.35-x86_64-2.7/build/cythonized/sage/modular/arithgroup/farey_symbol.o | grep _to_SL2Z
000000000001f190 T convert_to_SL2Z

nm build/temp.cygwin-1.7.35-x86_64-2.7/sage/modular/arithgroup/farey.o | grep _to_SL2Z
                 U convert_to_SL2Z
```


in 6.9.beta2:

```
nm build/temp.cygwin-2.2.0-x86_64-2.7/home/Sebastien/sage15/sage/src/build/cythonized/sage/modular/arithgroup/farey_symbol.o | grep _to_SL2Z
000000000001cfa0 T convert_to_SL2Z

nm build/temp.cygwin-2.2.0-x86_64-2.7/sage/modular/arithgroup/farey.o | grep _to_SL2Z
                 U __imp_convert_to_SL2Z
```


looks like the symbol in farey.o got prefixed by `__imp_`for some reason. So, the symbols in the two files do not match... Is this `__imp_` some kind of cython magic? Is it there on other platforms?


---

Comment by gouezel created at 2015-08-19 20:24:25

Got it, see #19057.


---

Comment by vbraun created at 2015-09-12 14:10:15

Resolution: fixed
