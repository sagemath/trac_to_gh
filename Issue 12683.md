# Issue 12683: FLINTQS fails to build on Solaris (with GCC 4.7.x)

Issue created by migration from Trac.

Original creator: leif

Original creation time: 2012-04-18 01:33:07

Assignee: tbd

CC:  ppurka

Keywords: spkg GCC 4.7.0 C++ g++ log() math.h overloaded SunOS

This is a rather subtle issue, related to Solaris' headers, and the fact that GCC (4.7.0) now defines `__cplusplus` to `199711L`, while previous versions defined it to just `1`.

If `__cplusplus >= 199711L`, a lot of overloaded (originally C) functions like `div()` and `log()` get defined in the `std` namespace (if one includes `math.h`), e.g.

```c++
float std::log(float);             // logf() in C
double std::log(double);           // log() in C
long double std::log(long double); // logl() in C
```

which is correct in the first place, but on Solaris these also end up in the *global* namespace:

```c++
// /usr/include/math.h

...

#if __cplusplus >= 199711L
...
using std::log;
...
#endif

```


Now FLINTQS happens to call `log()` with an `unsigned long` (without a cast) in one place, and with the overloaded functions present as well, the call gets ambiguous.  The obvious, trivial fix is to just cast the argument to a `double`, such that `double log(double)` gets called (as before).




There's a lot wrong with the FLINTQS spkg, as I noted a couple of times before, but I won't address other issues _here_.  [The most important fact being that _a newer version_ of Bill Hart's quadratic sieve is included in FLINT since a long time, but the FLINT spkg simply doesn't install it.  So the FLINTQS spkg is obsolete in whole, but we can't remove it until _someone_<sup>TM</sup> fixes the FLINT spkg to also install the QS program included in it.]


---

Comment by jdemeyer created at 2012-05-27 16:07:14

Changing status from new to needs_info.


---

Comment by jdemeyer created at 2012-05-27 16:07:14

Changing keywords from "spkg GCC 4.7.0 C++ g++ log() math.h overloaded SunOS" to "spkg GCC 4.7.0 C++ g++ log() math.h overloaded SunOS sd40.5".


---

Comment by jdemeyer created at 2012-05-28 17:06:14

Changing status from needs_info to needs_review.


---

Attachment

Diff for the flintqs spkg. For reference / review only.


---

Comment by jdemeyer created at 2012-05-28 17:12:23

New spkg builds fine on Skynet `mark` with gcc-4.7.0, needs review.


---

Comment by kcrisman created at 2012-06-20 19:10:36

Just for reference, #9544 has a very small FreeBSD-only patch which perhaps could be integrated into this.  Or is this almost ready for positive review and we should base on that?

```
#ifdef __FreeBSD__ 
#include <stdint.h> 
#endif 
```



---

Comment by kcrisman created at 2012-06-21 13:05:04

See also #11792?


---

Comment by jdemeyer created at 2012-06-21 13:08:33

Replying to [comment:7 kcrisman]:
> See also #11792?

I'm aware of that ticket, but I don't know enough about flint/flintqs to do something about that.


---

Comment by kcrisman created at 2012-06-21 20:36:05

Changing status from needs_review to needs_info.


---

Comment by kcrisman created at 2012-06-21 20:36:05

The diff looks good as far as it goes, and #9544 (based on this) installs fine and passes relevant tests on OS X 10.6.  

I can't test whether this actually works on Solaris or know whether these fixes are right, have to take your word for it. The Mac fix isn't mentioned on this ticket, either, and I can't check if it's necessary or actually fixes anything.

Finally, is `flintqs-gcc-4.3-fix.patch` still in use?    It apparently was _not_ actually applied before?  At least that's what the diff seems to indicate.  That patch was added over 4 years ago, and I'm not even sure whether we allow people to build with gcc-4.3...  In fact, 

```
$ hg log -p spkg-install | less 
```

indicates that maybe the patch was _never_ applied.  ???  Or maybe the fix was simply applied in source (against regulations)?

Anyway, what do you think about that patch?  Obviously it still applies, and maybe doesn't cause any trouble.

----

For positive review, should someone else try it on Solaris?  Also we would need just informational update on the Mac and extra patch as mentioned above.


---

Comment by jdemeyer created at 2012-06-22 09:26:11

Replying to [comment:9 kcrisman]:
> The Mac fix isn't mentioned on this ticket, either, and I can't check if it's necessary or actually fixes anything.
You mean `lanczos.h.patch`?  That existed before, so it's not subject to review for this ticket.

> Finally, is `flintqs-gcc-4.3-fix.patch` still in use? Or maybe the fix was simply applied in source (against regulations)?
That was indeed the case, you can compare the `src/` directories of the old and new spkg if you want.  So that patch itself isn't subject to review.


---

Comment by kcrisman created at 2012-06-22 13:43:51

> > The Mac fix isn't mentioned on this ticket, either, and I can't check if it's necessary or actually fixes anything.
> You mean `lanczos.h.patch`?  That existed before, so it's not subject to review for this ticket.
Ok, that makes sense, and I should have figured that out.

> > Finally, is `flintqs-gcc-4.3-fix.patch` still in use? Or maybe the fix was simply applied in source (against regulations)?
> That was indeed the case, you can compare the `src/` directories of the old and new spkg if you want.  So that patch itself isn't subject to review.
Ok.

So it seems fine, except for the issue that perhaps someone other than jdemeyer should test it on Solaris with gcc-4.7?  I think that's all that's needed here.


---

Comment by kcrisman created at 2012-06-22 13:43:51

Changing status from needs_info to needs_review.


---

Comment by jdemeyer created at 2012-06-24 22:50:05

Replying to [comment:11 kcrisman]:
> So it seems fine, except for the issue that perhaps someone other than jdemeyer should test it on Solaris with gcc-4.7?

I just built GCC-4.7.1 (see #13150) on `mark` (Solaris SPARC) and then built this FLINTQS spkg with GCC-4.7.1 and it worked.  This was starting from sage-5.1.beta0.


---

Comment by jdemeyer created at 2012-06-24 22:50:05

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-06-28 09:36:27

Resolution: fixed
