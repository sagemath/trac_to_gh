# Issue 33211: opensuse-tumbleweed: More fplll issues

Issue created by migration from https://trac.sagemath.org/ticket/33448

Original creator: mkoeppe

Original creation time: 2022-03-02 04:27:47

CC:  dimpase malb

... looking like #33302


```
sage -t --random-seed=138852144024485532212929500921133585206 src/sage/modules/free_module_integer.py
**********************************************************************
File "src/sage/modules/free_module_integer.py", line 213, in sage.modules.free_module_integer.FreeModule_submodule_with_basis_integer
Failed example:
    L.shortest_vector()
Exception raised:
    Traceback (most recent call last):
      File "sage/misc/cachefunc.pyx", line 1943, in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10410)
        return cache[k]
    KeyError: ((True, 'fplll'), ())

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/sage/local/var/lib/sage/venv-python3.8/lib64/python3.8/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/sage/local/var/lib/sage/venv-python3.8/lib64/python3.8/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.modules.free_module_integer.FreeModule_submodule_with_basis_integer[2]>", line 1, in <module>
        L.shortest_vector()
      File "sage/misc/cachefunc.pyx", line 1948, in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10546)
        w = self._instance_call(*args, **kwds)
      File "sage/misc/cachefunc.pyx", line 1824, in sage.misc.cachefunc.CachedMethodCaller._instance_call (build/cythonized/sage/misc/cachefunc.c:10012)
        return self.f(self._instance, *args, **kwds)
      File "/sage/local/var/lib/sage/venv-python3.8/lib64/python3.8/site-packages/sage/modules/free_module_integer.py", line 591, in shortest_vector
        w = vector(ZZ, SVP.shortest_vector(L, *args, **kwds))
      File "src/fpylll/fplll/svpcvp.pyx", line 77, in fpylll.fplll.svpcvp.shortest_vector
      File "src/fpylll/fplll/bkz_param.pyx", line 269, in fpylll.fplll.bkz_param.load_strategies_json
    RuntimeError: Aborted
**********************************************************************
```




---

Comment by dimpase created at 2022-03-02 15:35:02

It's due to missing `b'/'` at the end of `BKZ.DEFAULT_STRATEGY_PATH` on Tumbleweed. There

```
>>> BKZ.DEFAULT_STRATEGY_PATH + os.path.basename(BKZ.DEFAULT_STRATEGY)
b'/usr/share/fplll/strategiesdefault.json'
```



---

Comment by dimpase created at 2022-03-02 17:54:40

New commits:


---

Comment by dimpase created at 2022-03-02 17:54:40

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-03-02 20:14:11

Shouldn't this use `os.path.join`?


---

Comment by git created at 2022-03-03 12:54:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2022-03-03 12:54:46

Replying to [comment:3 mkoeppe]:
> Shouldn't this use `os.path.join`?
yes, certainy. Fixed now.


---

Comment by mkoeppe created at 2022-03-04 02:53:59

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-03-04 02:53:59


```
sage -t --long --random-seed=2407083402840770010480429843422564708 src/sage/modules/free_module_integer.py
**********************************************************************
File "src/sage/modules/free_module_integer.py", line 213, in sage.modules.free_module_integer.FreeModule_submodule_with_basis_integer
Failed example:
    L.shortest_vector()
Exception raised:
    Traceback (most recent call last):
      File "sage/misc/cachefunc.pyx", line 1943, in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10410)
        return cache[k]
    KeyError: ((True, 'fplll'), ())

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/sage/local/var/lib/sage/venv-python3.8/lib64/python3.8/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/sage/local/var/lib/sage/venv-python3.8/lib64/python3.8/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.modules.free_module_integer.FreeModule_submodule_with_basis_integer[2]>", line 1, in <module>
        L.shortest_vector()
      File "sage/misc/cachefunc.pyx", line 1948, in sage.misc.cachefunc.CachedMethodCaller.__call__ (build/cythonized/sage/misc/cachefunc.c:10546)
        w = self._instance_call(*args, **kwds)
      File "sage/misc/cachefunc.pyx", line 1824, in sage.misc.cachefunc.CachedMethodCaller._instance_call (build/cythonized/sage/misc/cachefunc.c:10012)
        return self.f(self._instance, *args, **kwds)
      File "/sage/local/var/lib/sage/venv-python3.8/lib64/python3.8/site-packages/sage/modules/free_module_integer.py", line 591, in shortest_vector
        w = vector(ZZ, SVP.shortest_vector(L, *args, **kwds))
      File "src/fpylll/fplll/svpcvp.pyx", line 77, in fpylll.fplll.svpcvp.shortest_vector
      File "src/fpylll/fplll/bkz_param.pyx", line 269, in fpylll.fplll.bkz_param.load_strategies_json
    RuntimeError: Aborted
```



---

Comment by dimpase created at 2022-03-04 07:44:28

it works for me on opensuse-tumblewheed with a system fplll, and it works on macOS with Sage's built fplll.

How do you get this error?


---

Comment by dimpase created at 2022-03-04 09:02:12

if it's not a wrong branch for you, please post `BKZ.DEFAULT_STRATEGY*` values you get after 

```
from fpylll import BKZ
```



---

Comment by dimpase created at 2022-03-06 21:29:15

ping?


---

Comment by mkoeppe created at 2022-03-07 00:29:20


```
ad8109b3c1c6:/sage # ./sage 
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.6.beta3, Release Date: 2022-02-27               │
│ Using Python 3.8.12. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: from fpylll import BKZ
sage: BKZ.DEFAULT_STRATEGY
b'/usr/share/fplll/strategies/default.json'
sage: BKZ.DEFAULT_STRATEGY_PATH
b'/usr/share/fplll/strategies'
sage:                                                                                                                                                                                                                 
Exiting Sage (CPU time 0m2.48s, Wall time 0m43.43s).
ad8109b3c1c6:/sage # ls -l /usr/share/fplll/strategies
ls: cannot access '/usr/share/fplll/strategies': No such file or directory
```



---

Comment by mkoeppe created at 2022-03-07 00:31:30


```
ad8109b3c1c6:/sage # zypper search fplll
Loading repository data...
Reading installed packages...

S  | Name        | Summary                                                     | Type
---+-------------+-------------------------------------------------------------+--------
   | fplll       | Lenstra-Lovász Lattice Basis Reduction Algorithm Library    | package
i+ | fplll-devel | Development files for Lattice Basis Reduction with libfplll | package
i  | libfplll7   | Lenstra-Lovász Lattice Basis Reduction Algorithm Library    | package
```



---

Comment by mkoeppe created at 2022-03-07 00:32:06


```
ad8109b3c1c6:/sage # ls -l /usr/share/fplll/strategies
total 8408
-rw-r--r-- 1 root root 8606859 Feb 19 21:04 default.json
```



---

Comment by mkoeppe created at 2022-03-07 00:33:28

So do we need to check for a half-installed fplll in `configure`?


---

Comment by mkoeppe created at 2022-03-07 00:36:34

New commits:


---

Comment by mkoeppe created at 2022-03-07 00:36:34

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2022-03-07 10:32:36

New commits:


---

Comment by git created at 2022-03-07 11:58:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-03-07 11:59:53

Replying to [comment:13 mkoeppe]:
> So do we need to check for a half-installed fplll in `configure`?

added in the last commit


---

Comment by mkoeppe created at 2022-03-07 17:14:43

`fplll-devel` was not what was missing, `fplll` was


---

Comment by git created at 2022-03-07 18:05:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-07 18:58:41

Works well now


---

Comment by dimpase created at 2022-03-07 21:11:39

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-03-07 21:11:39

lgtm


---

Comment by vbraun created at 2022-03-09 23:38:02

Resolution: fixed
