# Issue 25112: more improvements to generic polynomials

archive/issues_025112.json:
```json
{
    "body": "\n\nIssue created by migration from https://trac.sagemath.org/ticket/25349\n\n",
    "created_at": "2018-05-11T19:22:53Z",
    "labels": [
        "component: basic arithmetic"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "more improvements to generic polynomials",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25112",
    "user": "https://github.com/mezzarobba"
}
```


Issue created by migration from https://trac.sagemath.org/ticket/25349





---

archive/issue_comments_352941.json:
```json
{
    "body": "See also #25350.",
    "created_at": "2018-05-11T19:30:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25112#issuecomment-352941",
    "user": "https://github.com/mezzarobba"
}
```

See also #25350.



---

archive/issue_comments_352942.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-05-12T06:38:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25112#issuecomment-352942",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_352943.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-05-12T13:38:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25112#issuecomment-352943",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_352944.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-05-12T15:52:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25112#issuecomment-352944",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_352945.json:
```json
{
    "body": "The dependency now has positive_review.",
    "created_at": "2018-06-01T15:07:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25112#issuecomment-352945",
    "user": "https://github.com/mezzarobba"
}
```

The dependency now has positive_review.



---

archive/issue_comments_352946.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-10T09:17:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25112#issuecomment-352946",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_352947.json:
```json
{
    "body": "So the only change I am not sure about is this one:\n\n```diff\n-        zero = self._parent.base_ring().zero()\n-        l = self.list()\n-        return [i for i in range(len(l)) if l[i] != zero]\n+        return [i for i, c in enumerate(self) if c]\n```\nsince `self.list()` returns a list, which we can `cdef list l` and then `cdef int i` to get C-level list lookups instead of going through a Python iterator. Also, we can pass the `copy=False` option. I know there are polynomial implementations where calling `list` always makes a (Sage version) copy of the data. Probably the way to choose for this is look at timings and the generated C code.",
    "created_at": "2018-06-12T03:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25112#issuecomment-352947",
    "user": "https://github.com/tscrim"
}
```

So the only change I am not sure about is this one:

```diff
-        zero = self._parent.base_ring().zero()
-        l = self.list()
-        return [i for i in range(len(l)) if l[i] != zero]
+        return [i for i, c in enumerate(self) if c]
```
since `self.list()` returns a list, which we can `cdef list l` and then `cdef int i` to get C-level list lookups instead of going through a Python iterator. Also, we can pass the `copy=False` option. I know there are polynomial implementations where calling `list` always makes a (Sage version) copy of the data. Probably the way to choose for this is look at timings and the generated C code.



---

archive/issue_comments_352948.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-12T08:07:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25112#issuecomment-352948",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_352949.json:
```json
{
    "body": "You are right, the following variant leads to nicer C code:\n\n```\n        cdef size_t i\n        return [i for i, c in enumerate(self.list(copy=False)) if c]\n```\n\n```\n  __pyx_t_3 = ((struct __pyx_vtabstruct_4sage_5rings_10polynomial_18polynomial_element_Polynomial *)__pyx_v_self->__pyx_base.__pyx_base.__pyx_base.__pyx_base.__pyx_base.__pyx_vtab)->list(__pyx_v_self, 0, &__pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 5554, __pyx_L1_error)\n  __Pyx_GOTREF(__pyx_t_3);\n  __pyx_t_5 = __pyx_t_3; __Pyx_INCREF(__pyx_t_5); __pyx_t_6 = 0;\n  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;\n  for (;;) {\n    if (__pyx_t_6 >= PyList_GET_SIZE(__pyx_t_5)) break;\n    #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS\n    __pyx_t_3 = PyList_GET_ITEM(__pyx_t_5, __pyx_t_6); __Pyx_INCREF(__pyx_t_3); __pyx_t_6++; if (unlikely(0 < 0)) __PYX_ERR(0, 5554, __pyx_L1_error)\n    #else\n    __pyx_t_3 = PySequence_ITEM(__pyx_t_5, __pyx_t_6); __pyx_t_6++; if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 5554, __pyx_L1_error)\n    __Pyx_GOTREF(__pyx_t_3);\n    #endif\n    __Pyx_XDECREF_SET(__pyx_v_c, __pyx_t_3);\n    __pyx_t_3 = 0;\n    __pyx_v_i = __pyx_t_2;\n    __pyx_t_2 = (__pyx_t_2 + 1);\n    __pyx_t_7 = __Pyx_PyObject_IsTrue(__pyx_v_c); if (unlikely(__pyx_t_7 < 0)) __PYX_ERR(0, 5554, __pyx_L1_error)\n    if (__pyx_t_7) {\n      __pyx_t_3 = __Pyx_PyInt_FromSize_t(__pyx_v_i); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 5554, __pyx_L1_error)\n      __Pyx_GOTREF(__pyx_t_3);\n      if (unlikely(__Pyx_ListComp_Append(__pyx_t_1, (PyObject*)__pyx_t_3))) __PYX_ERR(0, 5554, __pyx_L1_error)\n      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;\n    }\n  }\n```",
    "created_at": "2018-06-12T08:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25112#issuecomment-352949",
    "user": "https://github.com/mezzarobba"
}
```

You are right, the following variant leads to nicer C code:

```
        cdef size_t i
        return [i for i, c in enumerate(self.list(copy=False)) if c]
```

```
  __pyx_t_3 = ((struct __pyx_vtabstruct_4sage_5rings_10polynomial_18polynomial_element_Polynomial *)__pyx_v_self->__pyx_base.__pyx_base.__pyx_base.__pyx_base.__pyx_base.__pyx_vtab)->list(__pyx_v_self, 0, &__pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 5554, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_5 = __pyx_t_3; __Pyx_INCREF(__pyx_t_5); __pyx_t_6 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  for (;;) {
    if (__pyx_t_6 >= PyList_GET_SIZE(__pyx_t_5)) break;
    #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
    __pyx_t_3 = PyList_GET_ITEM(__pyx_t_5, __pyx_t_6); __Pyx_INCREF(__pyx_t_3); __pyx_t_6++; if (unlikely(0 < 0)) __PYX_ERR(0, 5554, __pyx_L1_error)
    #else
    __pyx_t_3 = PySequence_ITEM(__pyx_t_5, __pyx_t_6); __pyx_t_6++; if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 5554, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    #endif
    __Pyx_XDECREF_SET(__pyx_v_c, __pyx_t_3);
    __pyx_t_3 = 0;
    __pyx_v_i = __pyx_t_2;
    __pyx_t_2 = (__pyx_t_2 + 1);
    __pyx_t_7 = __Pyx_PyObject_IsTrue(__pyx_v_c); if (unlikely(__pyx_t_7 < 0)) __PYX_ERR(0, 5554, __pyx_L1_error)
    if (__pyx_t_7) {
      __pyx_t_3 = __Pyx_PyInt_FromSize_t(__pyx_v_i); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 5554, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      if (unlikely(__Pyx_ListComp_Append(__pyx_t_1, (PyObject*)__pyx_t_3))) __PYX_ERR(0, 5554, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    }
  }
```



---

archive/issue_comments_352950.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-12T08:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25112#issuecomment-352950",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_352951.json:
```json
{
    "body": "I think it is better to use `Py_ssize_t` instead of `size_t` (at least, this is what is used throughout Sage's cython codebase). Once changed, you can set a positive review on my behalf.\n\nAt least before we were calling `list`, so it will be no worse than before. Plus those implementations that do return a copy even for `self.list(copy=False)` probably should have their own custom version of `exponents` anyways.",
    "created_at": "2018-06-12T11:07:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25112#issuecomment-352951",
    "user": "https://github.com/tscrim"
}
```

I think it is better to use `Py_ssize_t` instead of `size_t` (at least, this is what is used throughout Sage's cython codebase). Once changed, you can set a positive review on my behalf.

At least before we were calling `list`, so it will be no worse than before. Plus those implementations that do return a copy even for `self.list(copy=False)` probably should have their own custom version of `exponents` anyways.



---

archive/issue_comments_352952.json:
```json
{
    "body": "You are right, of course. Thanks!",
    "created_at": "2018-06-12T14:01:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25112#issuecomment-352952",
    "user": "https://github.com/mezzarobba"
}
```

You are right, of course. Thanks!



---

archive/issue_comments_352953.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-12T14:03:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25112#issuecomment-352953",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_352954.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-06-12T14:04:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25112#issuecomment-352954",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_063550.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-06-14T07:41:09Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25112",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25112#event-63550"
}
```



---

archive/issue_comments_352955.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-06-14T07:41:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25112",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25112#issuecomment-352955",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
