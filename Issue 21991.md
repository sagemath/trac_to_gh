# Issue 21991: Fix lcalc build on Mac with long directory names

Issue created by migration from Trac.

Original creator: mkoeppe

Original creation time: 2017-01-22 04:11:28

CC:  jdemeyer vbraun

On Mac, the `install_name_tool` used in `lcalc`'s `spkg-install` sometimes fails when directory names are longer than usual.

```
lcalc-1.23.p14] error: /Library/Developer/CommandLineTools/usr/bin/install_name_tool: changing install names or rpaths can't be redone for: /Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/lib/libLfunction.dylib (for architecture x86_64) because larger updated load commands do not fit (the program must be relinked, and you may need to use -headerpad or -headerpad_max_install_names)
```

No error is signaled (due to a bug in `spkg-install`); but as a result, `libLfunction.dylib` cannot be loaded. This can lead to errors in the docbuild:

```
[dochtml] [libs     ] /Users/mkoeppe/s/sage/sage-rebasing/src/doc/en/reference/libs/sage/libs/lcalc/lcalc_Lfunction.rst:11: WARNING: autodoc: failed to import module u'sage.libs.lcalc.lcalc_Lfunction'; the following exception was raised:
[dochtml] [libs     ] Traceback (most recent call last):
[dochtml] [libs     ] File "/Users/mkoeppe/s/sage/sage-rebasing/src/sage_setup/docbuild/ext/sage_autodoc.py", line 525, in import_object
[dochtml] [libs     ] __import__(self.modname)
[dochtml] [libs     ] ImportError: dlopen(/Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/lib/python2.7/site-packages/sage/libs/lcalc/lcalc_Lfunction.so, 2): Library not loaded: libLfunction.dylib
[dochtml] [libs     ] Referenced from: /Users/mkoeppe/s/sage/sage-rebasing/another-local-sans-autotools/lib/python2.7/site-packages/sage/libs/lcalc/lcalc_Lfunction.so
[dochtml] [libs     ] Reason: image not found
```


(As usual, the whole problem is caused by someone's hand-written Makefiles.)
Really, someone should autotoolize the package instead.



---

Comment by mkoeppe created at 2017-01-22 04:47:44

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2017-01-22 04:47:44

New commits:


---

Comment by mkoeppe created at 2017-03-28 18:07:08

This is likely to show up in users' builds once configuring SAGE_LOCAL (#21479) becomes popular. 
Needs review.


---

Comment by jhpalmieri created at 2017-03-28 21:17:27

Is it the total length of the path, or the length of some component of the path, that triggers this? I would like to reproduce the bug.


---

Comment by mkoeppe created at 2017-03-28 21:20:12

I believe it is the discrepancy of a path when the compiler/linker is invoked to the one that `install_name_tool` is supposed to put.
It may be necessary to use a custom SAGE_LOCAL.


---

Comment by jhpalmieri created at 2017-03-28 21:46:30

So I can't test this unless I use #21479? To use #21479, I need to do something like run `autoconf` to create the new `configure` script, right? How exactly do I do that? If I just run `autoconf` (version 2.69), I get error messages:

```
configure.ac:42: error: possibly undefined macro: AM_INIT_AUTOMAKE
      If this token and others are legitimate, please use m4_pattern_allow.
      See the Autoconf documentation.
configure.ac:45: error: possibly undefined macro: AM_MAINTAINER_MODE
configure.ac:61: error: possibly undefined macro: AC_PACKAGE_NAME
configure.ac:71: error: possibly undefined macro: AC_MSG_ERROR
```

So I must be doing something wrong. Not surprising, since I don't know autoconf and its relatives.


---

Comment by jhpalmieri created at 2017-03-28 21:54:57

Never mind, I guess it was `autoreconf` that I need to run. That seems to have worked.


---

Comment by mkoeppe created at 2017-03-28 21:58:24

Testing it does not really require #21479; it is enough to export `SAGE_LOCAL` (this is not advertised yet, though.)


---

Comment by jhpalmieri created at 2017-03-30 05:19:33

I can reproduce the problem on one machine but not on another; I wonder if depends which version of Xcode is installed. In any case, the changes here fix it where I see it and don't cause new problems where I don't. I'm running one more test to make sure, but if all goes well, I will give it a positive review.


---

Comment by jhpalmieri created at 2017-03-30 15:46:50

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2017-03-30 16:14:16

Thank you!


---

Comment by vbraun created at 2017-04-03 21:00:20

Resolution: fixed
