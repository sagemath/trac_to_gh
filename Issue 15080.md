# Issue 15080: Troubles with Python and ncurses on Cygwin

Issue created by migration from Trac.

Original creator: jpflori

Original creation time: 2013-10-23 06:50:01

CC:  dimpase vbraun jdemeyer

Keywords: cygwin spkg ncurses

Python currently fails/is suboptimal on Cygwin because:
* it does not properly detect readline which is only installed as a shared library, patch "2.7.3-dylib.patch" from Cygwin package fixes that;
* the curses module is not built because of undefined refs, just passing -lcurses when linking is not enough, one should add -ltinfo;
* it segfault at startup when loading the readline module, not sure why. It looks exactly as what is reported at http://trac.macports.org/ticket/29496 . Rebuilding ncurses with debug info (including CFLAGS="-O0 -g" which cannot easily be passed right now) does not give much info. The offending line pointed by GCC is "char *result = exit_attribute_mode;"; maybe some dark magic going on as reported in http://lists.gnu.org/archive/html/bug-ncurses/2006-10/msg00002.html ; please not that on Cygwin the stack is small by default but playing a little bit with that did not really help. Further info: ncurses 5.7 is fine, ncurses 5.8 fails in the same way.


---

Comment by jpflori created at 2013-10-23 06:50:46

Had no time to investigate the diff between 5.7 and 5.8, especially around the offending lines, function calls.
Any help/clues welcomed.


---

Comment by jpflori created at 2013-10-24 07:40:25

Similar problem on different archs: http://lists.busybox.net/pipermail/buildroot/2011-April/042350.html
No solution though...


---

Comment by jpflori created at 2013-10-24 07:45:49

Maybe have a look at http://trac.sagemath.org/ticket/12282


---

Comment by jpflori created at 2013-10-24 11:27:43

Playing a little bit around, it seems that setting TERM to something non-existing (e.g. "" or "blblbblblbl") makes the segfault disappear.


---

Comment by jpflori created at 2013-10-25 06:58:12

Upstream bug report: http://lists.gnu.org/archive/html/bug-ncurses/2013-10/msg00014.html

The problem is that when the config BROKEN_LINKER is set, then a pointer CurTerm is used but never set to something else than zero.
Setting it as in other cases seems to fix the problem.
Or unsetting BROKEN_LINKER on Cygwin.


---

Comment by jpflori created at 2013-10-28 18:02:55

The BROKEN_LINKER stuff should be fixed in ncurses:
* http://lists.gnu.org/archive/html/bug-ncurses/2013-10/msg00017.html


---

Comment by jpflori created at 2013-11-04 10:21:05

There were further problem with the threading code in the Cygwin dll itself.
Fixed in the > 1.7.25 releases (currently only snpashots). See http://cygwin.com/ml/cygwin/2013-10/msg00371.html.


---

Comment by jpflori created at 2013-11-07 10:17:19

As far as not linking to tinfo is concerned, I'm putting this here for reference: http://bugs.python.org/issue7384.

In particular, python uses ldd for linking detection but applies it on import libraries on cygwin which just fails.
(The situation is more or less the same on OS X but OS X seems less picky about providing explicitely all libraries to be linked in.)


---

Comment by jpflori created at 2013-12-27 13:26:19

Here is how to find the dll corresponding to an import lib:
* http://cygwin.com/ml/cygwin/2013-11/msg00167.html$
(dlltool --identify [implib])


---

Comment by dimpase created at 2013-12-28 04:57:32

Replying to [comment:10 jpflori]:
> Here is how to find the dll corresponding to an import lib:
> * http://cygwin.com/ml/cygwin/2013-11/msg00167.html
> (dlltool --identify [implib])

Fixed typo in the url.


---

Comment by jpflori created at 2014-01-01 20:32:20

I've opened #15617 for the ncurses update.


---

Comment by jpflori created at 2014-01-01 22:06:37

I've put a dirty but working python spkg at:
* http://boxen.math.washington.edu/home/jpflori/cygwin/python-2.7.5.p2.spkg
for those wanting to try a Cygwin(32) build.


---

Comment by tscrim created at 2014-01-04 06:09:58

I installed the new version of ncurses and created a new branch with the python spkg at `u/tscrim/cygwin_python-15317` (with #15617 merged in). Now I get somewhere else than I did before (with cygwin32) with it failing at importing the module `_socket`...


---

Comment by jpflori created at 2014-01-04 12:59:42

Replying to [comment:14 tscrim]:
> I installed the new version of ncurses and created a new branch with the python spkg at `u/tscrim/cygwin_python-15317` (with #15617 merged in). Now I get somewhere else than I did before (with cygwin32) with it failing at importing the module `_socket`...
What is in that branch exactly?
From the git log I assume you just updated the tarball with what's within the spkg?
Note that's only for testing purpose and a clean patch should be produced :)
FYI, I think we temporarly could just diff what's in the tarball with the vanilla tarball and ship it as a patch in Sage, but that's definitely not for upstream inclusion.
Right know it basically adds "-ltinfo" all the time which is right for Sage as we build our own ncurses which makes tinfo a separate lib.

The _socket thing reminds me of rebasing issues.
Try to run "find . -name "*.dll" > dlls && rebase -O -T dlls && make" in Sage's root.
And I did not test on Cygwin64 lately, so that might be another problem.


---

Comment by tscrim created at 2014-01-05 04:55:51

Tried that and it didn't work. I also pushed a patch to the branch.


---

Comment by jpflori created at 2014-01-05 21:53:34

Changing status from new to needs_review.


---

Comment by jpflori created at 2014-01-05 21:53:34

The branch I pushed is cleaner and should be good to go.
----
New commits:


---

Comment by jpflori created at 2014-01-05 21:54:33

Groumpf, wrong branch, I'm pushing the right one shortly.

Travis: Could you post the log of the failed build?


---

Comment by git created at 2014-01-05 21:56:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2014-01-07 16:28:00

I think with the new branch it worked...I'm now building atlas. Let me try on Cygwin64 and my Ubuntu machine.


---

Comment by jpflori created at 2014-01-07 21:10:10

I don't promise it works on Cygwin64... though I don't see any reason why it shouldn't.


---

Comment by jpflori created at 2014-01-07 21:11:49

For ATLAS you will need #15615 as I forgot to update the autotools project within the tarball after #14410... and so the changes introduced in the patches/ATLAS-lib dir are not reflected in the build system actually used (src/ATLAS-lib).


---

Attachment

ATLAS built fine for me, but it's failing on pillow. I've attached the log. I'm trying the Cygwin64 now.


---

Attachment

FTR It doesn't work for me on Cygwin64. Here's the log.


---

Comment by jpflori created at 2014-01-08 09:50:20

Replying to [comment:23 tscrim]:
> ATLAS built fine for me, but it's failing on pillow. I've attached the log. I'm trying the Cygwin64 now.
The pillow failure has noting to do with the cahnges here.
It is quite easy to fix and is an upstream bug:
* pillow wants to use some png functions but does not explicitely link to libpng and that's a no go on cygwin (but ok on most other systems).
* in the log see line 314 "building 'PIL._imagingft' extension" and the few next ones


---

Comment by jpflori created at 2014-01-08 09:53:41

Replying to [comment:24 tscrim]:
> FTR It doesn't work for me on Cygwin64. Here's the log.
It seems the readline module is not built:

```
Traceback (most recent call last):
  File "<string>", line 1, in <module>
ImportError: No module named readline
```

and indeed readline is not found:

```
checking how to link readline libs... none
checking for rl_callback_handler_install in -lreadline... no
checking for rl_pre_input_hook in -lreadline... no
checking for rl_completion_display_matches_hook in -lreadline... no
checking for rl_completion_matches in -lreadline... no
```

Could you post your readline log?

Please let's go one step at a time, at least now installing python on Cygwin32 works, I'll try to go with the pillow and installing python on Cygwin64 issues on follow up tickets quickly.


---

Comment by jpflori created at 2014-01-08 09:55:12

Replying to [comment:26 jpflori]:
> Replying to [comment:24 tscrim]:
> > FTR It doesn't work for me on Cygwin64. Here's the log.
> It seems the readline module is not built:
> {{{
> Traceback (most recent call last):
>   File "<string>", line 1, in <module>
> ImportError: No module named readline
> }}}
> and indeed readline is not found:
> {{{
> checking how to link readline libs... none
> checking for rl_callback_handler_install in -lreadline... no
> checking for rl_pre_input_hook in -lreadline... no
> checking for rl_completion_display_matches_hook in -lreadline... no
> checking for rl_completion_matches in -lreadline... no
> }}}
> Could you post your readline log?Atickets quickly.
Also note this failure surel has nothing to do with the changes here as readline is not detected during the autotools based configuration phase, not the setup.py one which I modified.


---

Comment by jpflori created at 2014-01-08 14:42:13

Strangely on my setup, readline seems to have built fine, is detected, but the python fails because of an ICE in GCC.


---

Comment by jpflori created at 2014-01-08 14:43:55

(I mean my Cygwin64 setup, with Cygwin's GCC 4.8.2.)


---

Comment by jpflori created at 2014-01-08 16:56:58

After fixing my ICE on Cygwin64 (using #10572), I oculd build pytohn.


---

Comment by tscrim created at 2014-02-02 05:51:29

Sorry for the delays, let's get this in.


---

Comment by tscrim created at 2014-02-02 05:51:29

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-02-02 23:01:03

Breaks python build on mod:

http://build.sagemath.org/sage/builders/%20%20fast%20UW%20mod%20%28Ubuntu%208.04%20x86_64%29%20incremental/builds/25/steps/compile/logs/python


---

Comment by jpflori created at 2014-02-03 09:43:12

Any chance to get the getbuildinfo.c file?
Doesn't look obvously related, so needs further info.


---

Comment by vbraun created at 2014-02-03 13:47:10

Sorry, the buildbot has already moved on. You'll have to build it yourself.


---

Comment by jpflori created at 2014-02-03 15:46:06

I just did so ... and the build succeeded.

I merged u/jpflori/ticket/15317 with develop, exported MAKE to something sensible and ran make.
Does the buildbot export anything strange before building?


---

Comment by jpflori created at 2014-02-03 15:47:28

Hum, here is waht the pytho log says:

```
gcc -pthread -c -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall   -I. -IIn
clude -I./Include  -fPIC -DPy_BUILD_CORE -o Python/graminit.o Python/graminit.c
gcc -pthread -c -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall   -I. -IIn
clude -I./Include  -fPIC -DPy_BUILD_CORE \
              -DSVNVERSION="\"`LC_ALL=C svnversion .`\"" \
              -DHGVERSION="\"`LC_ALL=C hg id -i .`\"" \
              -DHGTAG="\"`LC_ALL=C hg id -t .`\"" \
              -DHGBRANCH="\"`LC_ALL=C hg id -b .`\"" \
              -o Modules/getbuildinfo.o ./Modules/getbuildinfo.c
************************************************************************
It seems that you are attempting to run Sage from an unpacked source
tarball, but you have not compiled it yet (or maybe the build has not
finished). You should run `make` in the Sage root directory first.
If you did not intend to build Sage from source, you should download
a binary tarball instead. Read README.txt for more information.
************************************************************************
************************************************************************
It seems that you are attempting to run Sage from an unpacked source
tarball, but you have not compiled it yet (or maybe the build has not
finished). You should run `make` in the Sage root directory first.
If you did not intend to build Sage from source, you should download
a binary tarball instead. Read README.txt for more information.
************************************************************************
************************************************************************
It seems that you are attempting to run Sage from an unpacked source
tarball, but you have not compiled it yet (or maybe the build has not
finished). You should run `make` in the Sage root directory first.
If you did not intend to build Sage from source, you should download
a binary tarball instead. Read README.txt for more information.
************************************************************************
```



---

Comment by jpflori created at 2014-02-03 15:50:10

Trying to reinstall python then fails:

```
gcc -pthread -c -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall   -I. -IInclude -I./Include  -fPIC -DPy_BUILD_CORE \
              -DSVNVERSION="\"`LC_ALL=C svnversion .`\"" \
              -DHGVERSION="\"`LC_ALL=C hg id -i .`\"" \
              -DHGTAG="\"`LC_ALL=C hg id -t .`\"" \
              -DHGBRANCH="\"`LC_ALL=C hg id -b .`\"" \
              -o Modules/getbuildinfo.o ./Modules/getbuildinfo.c
<command-line>:0:11: warning: missing terminating " character [enabled by default]
<command-line>:1:7: warning: missing terminating " character [enabled by default]
<command-line>:2:10: warning: missing terminating " character [enabled by default]
./Modules/getbuildinfo.c: In function 'Py_GetBuildInfo':
./Modules/getbuildinfo.c:45:5: error: missing terminating " character
./Modules/getbuildinfo.c:45:48: error: expected expression before ')' token
./Modules/getbuildinfo.c:46:27: error: missing terminating " character
./Modules/getbuildinfo.c:46:27: error: missing terminating " character
./Modules/getbuildinfo.c:47:28: error: missing terminating " character
./Modules/getbuildinfo.c:47:28: error: missing terminating " character
./Modules/getbuildinfo.c:53:19: error: 'buildinfo' undeclared (first use in this function)
./Modules/getbuildinfo.c:53:19: note: each undeclared identifier is reported only once for each function it appears in
./Modules/getbuildinfo.c: In function '_Py_hgversion':
./Modules/getbuildinfo.c:72:5: error: missing terminating " character
./Modules/getbuildinfo.c:72:5: warning: 'return' with no value, in function returning non-void [-Wreturn-type]
./Modules/getbuildinfo.c: In function '_Py_hgidentifier':
./Modules/getbuildinfo.c:79:5: error: missing terminating " character
./Modules/getbuildinfo.c:79:18: error: expected expression before ';' token
./Modules/getbuildinfo.c:83:9: error: missing terminating " character
./Modules/getbuildinfo.c:83:24: error: expected expression before ';' token
./Modules/getbuildinfo.c: In function 'Py_GetBuildInfo':
./Modules/getbuildinfo.c:57:1: warning: control reaches end of non-void function [-Wreturn-type]
make: *** [Modules/getbuildinfo.o] Error 1
```



---

Comment by jpflori created at 2014-02-03 15:54:42

/usr/local/bin/hg is broken on mod:
{{{#!/bin/sh
sage -hg $*
```

whence all the above.

In particular, once sage(.git) is built, one get:

```
(sage-sh) jpflori`@`mod:src$ which hg
/usr/local/bin/hg
(sage-sh) jpflori`@`mod:src$ LC_ALL=C hg id -i .
sage-run received unknown option: -hg 
usage: sage [options]
Try 'sage -h' for more information.
```



---

Comment by jdemeyer created at 2014-02-03 15:56:08

This ticket is not broken, the `hg` command on `mod` is broken.


---

Comment by vbraun created at 2014-02-03 16:18:07

How about

```
./configure HAS_HG=no SVNVERSION=no [...]
```



---

Comment by jpflori created at 2014-02-05 10:20:18

Replying to [comment:41 vbraun]:
> How about
> {{{
> ./configure HAS_HG=no SVNVERSION=no [...]
> }}}
Why not, but let's do this somewhere else.
And maybe only if SAGE_FAT_BINARY is set or something like that.
We cannot deal with every broken systems users may come up with.


---

Comment by vbraun created at 2014-02-05 10:50:41

Fair enough, but this ticket can't be merged until either mod is un-broken or a workaround is implemented. Or both.


---

Comment by jpflori created at 2014-02-05 10:52:20

Maybe William can fix mod (i.e. delete the harmful /usr/local/bin/hg)?


---

Comment by jpflori created at 2014-02-05 10:53:35

(And isn't the failure triggered even without this ticket? I mean: just trying to recompile python should fail.)


---

Comment by vbraun created at 2014-02-05 10:53:36

Can you post to the sage.math users mailing list, this is for admin issues.


---

Comment by jpflori created at 2014-02-05 11:00:07

Done: https://groups.google.com/d/msg/sagemath-users/uMHB5gtlJS8/bKPtZqI-tc0J


---

Comment by vbraun created at 2014-02-14 19:44:52

Resolution: fixed
