# Issue 15836: Python 3 preparation: The semantic of map() function is changed

Issue created by migration from https://trac.sagemath.org/ticket/16073

Original creator: wluebbe

Original creation time: 2014-04-07 08:48:41

CC:  embray jdemeyer fbissey tscrim jhpalmieri vklein

Keywords: python3

In Py2 `map()` returns a list, while in Py3 `map()` returns an iterator (as `itertools.imap()` does in Py2).

The tool 2to3 wraps `map()` usages with a call to `list()`.


An alternative approach is to add `from future_builtins import map` and to check the code.

There are 171 effected modules. 

This ticket is tracked as a dependency of meta-ticket ticket:16052.


---

Comment by wluebbe created at 2014-05-22 09:38:15

This first commit was generated by `2to3`. **It has failing doctests! ** These will be fixed with a separate commit.
----
New commits:


---

Comment by git created at 2014-05-22 13:08:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by wluebbe created at 2014-05-22 13:11:01

The problem was that in one module the standard library function `list` had been overwritten. Now all doctests pass.


---

Comment by wluebbe created at 2014-05-22 13:25:37

The code would now certainly benefit from changing expressions like `list(map(...))` into a list comprehension. 

This is more pythonic, more readable (especially in the case `list(map(lambda ...))` ) and it avoids redundant list creation in Python 2. But it's a lot of stuff to check and change ...


---

Comment by wluebbe created at 2014-05-22 13:43:24

This patch will cause a lot of merge conflicts with #16067 `filter`. It seems advisable to wait until #16067 is merged and then regenerate this patch.

Somebody to review #16067 ... ;-)


---

Comment by wluebbe created at 2014-05-22 13:44:05

Changing status from new to needs_review.


---

Comment by wluebbe created at 2014-05-22 13:44:31

Changing status from needs_review to needs_work.


---

Comment by aapitzsch created at 2014-10-07 18:06:20

Rebased.
----
New commits:


---

Comment by git created at 2014-10-09 20:29:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aapitzsch created at 2014-10-09 20:30:19

Changing status from needs_work to needs_review.


---

Comment by darij created at 2014-11-13 19:36:33

The patch is red.

Either way, shouldn't it be only wrapping some of the uses, rather than all of them?


---

Comment by git created at 2014-11-13 20:49:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by darij created at 2014-11-13 20:51:44

OK, but as I expected there are some questionable things here.

```
- r = sum ( map( lambda x: x[2], cycle ) )
+ r = sum ( [x[2] for x in cycle] )
```

Wouldn't keeping the old line be better? Summing an iterator should be faster than summing a list which has been constructed merely to be summed.


---

Comment by git created at 2014-11-13 21:36:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aapitzsch created at 2014-11-13 21:44:47

Replying to [comment:15 darij]:
> OK, but as I expected there are some questionable things here.
> {{{
> - r = sum ( map( lambda x: x[2], cycle ) )
> + r = sum ( [x[2] for x in cycle] )
> }}}
> Wouldn't keeping the old line be better? Summing an iterator should be faster than summing a list which has been constructed merely to be summed.

You are right.

In this case we should write

```
r = sum ( (x[2] for x in cycle) )
```


Feel free to fix it (and others), currently I have no time to check the necessity of `list()` wrapping.


---

Comment by darij created at 2014-11-14 21:58:39


```
- return "".join(map(lambda x: self._character_to_code[x], string))
+ return "".join([self._character_to_code[x] for x in string])
```

Wondering if this is a good step forward, given that you can join an iterator to a string:

```
>>> map(lambda x: x+x, ['a','b','c'])
<map object at 0x7fd747ddee10>
>>> "blah".join(map(lambda x: x+x, ['a','b','c']))
'aablahbbblahcc'
```

(Python 3).

--------


```
- map(
- lambda x: chr(ord(x) + 49),
- list(str(num[0]))),
+ [chr(ord(x) + 49) for x in list(str(num[0]))],
```

Can't we get rid of the `list`?

--------


```
- a,b,c,d,e,f = map(G,R)
+ a,b,c,d,e,f = list(map(G,R))
```

This seems to not be necessary:

```
>>> a,b,c = iter([1,2,3])
>>> a
1
>>> b
2
>>> c
3
```


--------

This is unnecessary:

```
- if all(map(lambda s: s.is_final, state.label())):
+ if all([s.is_final for s in state.label()]):
```

If anything then `all` definitely works on iterators.

--------

Here is the thing that worries me the most: There are tools for automatic translation of python2 into 3. I am not sure if we should, or are going to, release them on the Sage library; but if we are, I would rather not do any manual work unless we can make sure that it will not interfere with the automated changes. I have a hunches that a well-written bot could do better than some of the changes in this patch (for instance, it should be a rule that `all(map(...))` can stay as it is rather than being replaced by `all(list(map(...)))`), thus leading to better speed, whereas with the changes already done it would not simplify them back to what they should be. This does not speak against edits such as replacing `list` variables by `list_` and likewise, which are the right thing to do either way. But I would be wary of making changes that possibly complicate the situation without knowing that it will become untangled when the time comes to actually switch to python 3.


---

Comment by git created at 2014-11-15 21:23:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aapitzsch created at 2014-11-15 21:48:31

Darij thanks. I hopefully made all the changes you suggested.

Replying to [comment:18 darij]:
> Here is the thing that worries me the most: There are tools for automatic translation of python2 into 3. I am not sure if we should, or are going to, release them on the Sage library; but if we are, I would rather not do any manual work unless we can make sure that it will not interfere with the automated changes. I have a hunches that a well-written bot could do better than some of the changes in this patch (for instance, it should be a rule that `all(map(...))` can stay as it is rather than being replaced by `all(list(map(...)))`), thus leading to better speed, whereas with the changes already done it would not simplify them back to what they should be. This does not speak against edits such as replacing `list` variables by `list_` and likewise, which are the right thing to do either way. But I would be wary of making changes that possibly complicate the situation without knowing that it will become untangled when the time comes to actually switch to python 3.

These tools don't work well in all cases and usually one can disable special fixes. So manual work won't interfere with automated changes.

The target of these changes is to simplify the switch to python 3 without complicating the situation. :)


---

Comment by wluebbe created at 2014-11-16 13:00:08

I got 

```
1 item had failures:
   3 of 211 in sage.tests.cmdline.test_executable
    [210 tests, 3 failures, 29.22 s]
----------------------------------------------------------------------
sage -t --long src/sage/tests/cmdline.py  # 3 doctests failed
```

while there were no failures with plain sage 6.4. I have not yet found the cause.


---

Comment by aapitzsch created at 2014-11-16 16:10:21

Replying to [comment:21 wluebbe]:
> I got 
> {{{
> 1 item had failures:
>    3 of 211 in sage.tests.cmdline.test_executable
>     [210 tests, 3 failures, 29.22 s]
> ----------------------------------------------------------------------
> sage -t --long src/sage/tests/cmdline.py  # 3 doctests failed
> }}}
> while there were no failures with plain sage 6.4. I have not yet found the cause.

I have no problems with `cmdline.py`. Results keep the same with and without merging `origin/develop` into `16073`.


```
sage -t --long src/sage/tests/cmdline.py
    [210 tests, 32.88 s]
----------------------------------------------------------------------
All tests passed!
```



---

Comment by wluebbe created at 2014-11-16 16:40:57

Strange! And Volker just released sage-6.5.beta0 and auto-merge failed again ... :-(

By the way, back in June I was working to replace `map` with list comprehension or generator expressions (mostly). It was not quite complete when I took some time off.

I want to give that approach a fresh start on sage-6.5.beta0. I will describe the reasoning tomorrow (or so ...).


---

Comment by git created at 2014-11-16 17:43:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by wluebbe created at 2014-11-18 16:10:07

I uploaded a new branch `u/wluebbe/ticket/16073-2`.

My goal is to replace all `map` calls with list comprehension or generator expressions. Currently there are still about 40 `list(map(...` in the code (somehow my regexp did not find them :-/ ) and a number of `map`s in the doctests. So there is still some work to do.

The drawback of wrapping `map` with `list` is that in Python2 this is redundant.
If a context accepts iterators then in Python2 `map` cannot exploit this (as it returns a list). Remapping `map` in Python2 on its iterator version `itertools.imap` requires extra code.

The current branch does change list comprehensions to generator expressions in all possible cases. I would rather leave this refactoring to a new ticket since there are lots of applicable cases separate from 16073.

I am very much interested in feedback to `u/wluebbe/ticket/16073-2`.


---

Comment by darij created at 2014-11-18 16:15:17

wluebbe: sorry for the stupid question, but what is the precise difference between the two branches? I cannot tell it from the post.


---

Comment by wluebbe created at 2014-11-18 16:32:34

The 2 branches (the current `public/16073` and `u/wluebbe/ticket/16073-2`) are alternative approaches. 
I did not want to be so impolite and just swap the branches :-)
And I did not think it is appropriate to open a separate ticket.


---

Comment by darij created at 2014-11-19 06:42:04

I have added your branch to #15379 (an accidental duplicate ticket I made a year ago) to be able to see it on the trac viewer.

I have to say I have no idea which of your two branches is the better one :/


---

Comment by wluebbe created at 2014-11-19 08:38:26

My branch gets rid of (mostly) all `map(...)` and `list(map(...))` calls replacing them with list comprehension or generator expressions.
There are currently a few (about 40) `list(map(...))` calls left over (as e.g. in  `src/sage/graphs/bipartite_graph.py` lines 643ff).


---

Comment by git created at 2015-03-02 21:33:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-05-05 19:12:21

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2015-05-05 19:12:21

does not apply


---

Comment by git created at 2015-05-06 18:49:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aapitzsch created at 2015-05-06 18:50:42

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-05-06 19:32:05

I find `[func(_) for _ in L]` more readable than `list(map(func, L))`.


---

Comment by aapitzsch created at 2015-05-06 20:39:03

Replying to [comment:34 jdemeyer]:
> I find `[func(_) for _ in L]` more readable than `list(map(func, L))`.

I will change it.


---

Comment by aapitzsch created at 2015-05-06 20:39:03

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-05-08 09:17:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aapitzsch created at 2015-05-08 09:18:21

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-05-08 10:38:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-05-12 08:47:48

I'm sorry but this is much too boring to review.


---

Comment by jdemeyer created at 2015-05-12 08:50:08

Are the changes scripted? If so, can you just tell me which script you used to generate them, then I'll review the script instead.


---

Comment by aapitzsch created at 2015-05-12 16:46:15

Replying to [comment:40 jdemeyer]:
> Are the changes scripted? If so, can you just tell me which script you used to generate them, then I'll review the script instead.

There is no script. But if necessary we can split this ticket.


---

Comment by git created at 2015-05-14 08:08:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-05-21 10:18:32

Replying to [comment:41 aapitzsch]:
> There is no script.
That actually worries me. If one has to manually review each individual change, that is _a lot_ of changes to review and a lot of potential for mistakes also.


---

Comment by aapitzsch created at 2015-05-22 12:04:53

I still can split this ticket. Would it be sufficient to move the changes in `src/sage/combinat/` to a new ticket?


---

Comment by jdemeyer created at 2015-05-22 15:06:18

Well, my preferred solution would be if the majority of the changes would be scripted.

Splitting would help also but maybe 2 pieces are not enough.


---

Comment by git created at 2015-05-22 16:35:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-05-22 16:46:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aapitzsch created at 2015-05-22 16:48:24

I added three additional tickets (#18472, #18473, #18474).


---

Comment by darij created at 2015-05-27 22:46:07

Can this now be set to closed?


---

Comment by wluebbe created at 2015-05-28 06:17:52

No, unfortunately there are still a significant number of `map`s in the code base.

`@`André: Can you please move the branch `public/16073` from this ticket into a new, separate ticket. Then I will review the change. - Reason: I will create one (maybe two) extra tickets/changes (this is now #18531) for the leftover `map`s that I found during the review of #18473 and #18474. And I would prefer that this tickets only refers to the tickets containing the changes.


---

Comment by wluebbe created at 2015-05-28 06:17:52

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-05-28 06:54:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by wluebbe created at 2015-05-28 12:50:06

There are still a lot of `map()` call in the code. 

But //not all// occurrences must be  removed: there are a number of places where a Py3 `map()`-iterator leads to the same result as the Py2 `map()`.

Here is a long (but incomplete) list:

```
all(here_is_an_iterable_allowed)
any(here_is_an_iterable_allowed)
bytearray(here_is_an_iterable_allowed)
dict(here_is_an_iterable_of_key_value_pairs_allowed)
filter(function, here_is_an_iterable_allowed)
frozenset(here_is_an_iterable_allowed)
list(here_is_an_iterable_allowed)
map(function, here_is_an_iterable_allowed)
max(here_is_an_iterable_allowed)
min(here_is_an_iterable_allowed)
reduce(function, here_is_an_iterable_allowed)
set(here_is_an_iterable_allowed)
sorted(here_is_an_iterable_allowed)
sum(here_is_an_iterable_allowed)
tuple(here_is_an_iterable_allowed)
zip(here_is_an_iterable_allowed)

''.join(here_is_an_iterable_allowed)
a,b,c* = here_is_an_iterable_allowed
x[i:j] = here_is_an_iterable_allowed
a_dict.update(here_is_an_iterable_of_key_value_pairs_allowed)
file.writelines(here_is_an_iterable_allowed)
math.fsum(here_is_an_iterable_allowed)

and MANY functions in module itertools.

for i in here_is_an_iterable_allowed:
    pass
[2*x for x in here_is_an_iterable_allowed]
(2*x for x in here_is_an_iterable_allowed)
```


But if the use of `map` includes a `lambda` then replacing it with a list comprehension improves the readability!


---

Comment by chapoton created at 2016-04-28 06:50:28

Changing component from distribution to python3.


---

Comment by chapoton created at 2017-01-03 09:38:55

see #22121 and #22127 for steps in this direction


---

Comment by chapoton created at 2017-05-26 09:55:57

another step in #23084


---

Comment by chapoton created at 2017-06-02 19:04:59

another step in #23130


---

Comment by chapoton created at 2017-12-15 14:10:18

next #24382


---

Comment by chapoton created at 2018-01-19 16:22:29

next in #24572


---

Comment by embray created at 2018-04-23 14:24:36

Some more in #25231


---

Comment by embray created at 2018-05-21 18:00:57

Some more in #25418


---

Comment by vklein created at 2018-07-25 13:09:40

Some more in #25925


---

Comment by chapoton created at 2019-06-04 09:49:50

Probably one coud close this one too ? Agreed ?


---

Comment by chapoton created at 2019-06-04 14:19:05

Changing status from needs_work to needs_review.


---

Comment by vklein created at 2019-06-04 14:20:36

Sure.


---

Comment by vklein created at 2019-06-04 14:20:36

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2019-06-04 15:26:35

Resolution: fixed
