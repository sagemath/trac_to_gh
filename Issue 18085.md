# Issue 18085: _cmp should try _richcmp_ if _cmp_ failed

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2015-04-28 16:09:10

CC:  vdelecroix

With the current comparison implementation, defining `__cmp__` in a Cython class can actually _break_ `cmp()` if `_cmp_` raises `NotImplementedError`. This is because defining `__cmp__` causes Python to use `__cmp__` and _only_ `__cmp__`. Instead, `__cmp__` (so really `_cmp` in Cython) should itself try `_richcmp_` if `_cmp_` didn't work.

To avoid an infinite loop, it's important that only `_cmp` calls `_richcmp_`, we should not change `_cmp_` here.


---

Comment by jdemeyer created at 2015-04-29 09:16:59

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-04-29 09:16:59

Last 10 new commits:


---

Comment by git created at 2015-05-06 07:40:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-05-06 07:41:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-05-06 07:52:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-05-06 08:10:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-05-08 09:25:02

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-05-08 09:25:02

1. The code of `_cmp_` raises a `NotImplementedError` which has a custom error message which involves string formatting. As this error is catched in a critical part of the code (i.e. `_cmp`) I would either:
 - remove the message `"comparison not implemented for %r"%type(left)`
 - or use lazy strings

 The second option looks better to me.

2. It would be nice to update this comment:

```
    ####################################################################
    # For a derived Cython class, you **must** put the __richcmp__
    ...
    # arguments have identical parents.
    ####################################################################
```

  with something like: `implementing `_richcmp_` will automatically makes `cmp` works, see the implementation of Element._cmp`.

3. Actually, the current implementation let met think that for elements we should:
 - implement `_richcmp_` for more speed (e.g. `==` is cheap but `<` is not) or if `_cmp_` does not make sense (e.g. we want to test for equality but raise errors on `<`)
 - implement `_cmp_` otherwise

 Am I right?

Vincent


---

Comment by git created at 2015-05-08 15:36:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-05-08 16:52:05

Replying to [comment:8 vdelecroix]:
> 3. Actually, the current implementation let met think that for elements we should:
>  - implement `_richcmp_` for more speed (e.g. `==` is cheap but `<` is not) or if `_cmp_` does not make sense (e.g. we want to test for equality but raise errors on `<`)
>  - implement `_cmp_` otherwise
I think so, yes.


---

Comment by git created at 2015-05-08 17:00:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-05-08 17:00:47

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-05-08 21:38:49

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-05-09 23:03:11

Resolution: fixed
