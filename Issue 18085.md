# Issue 18085: _cmp should try _richcmp_ if _cmp_ failed

archive/issues_018085.json:
```json
{
    "body": "CC:  @videlec\n\nWith the current comparison implementation, defining `__cmp__` in a Cython class can actually *break* `cmp()` if `_cmp_` raises `NotImplementedError`. This is because defining `__cmp__` causes Python to use `__cmp__` and *only* `__cmp__`. Instead, `__cmp__` (so really `_cmp` in Cython) should itself try `_richcmp_` if `_cmp_` didn't work.\n\nTo avoid an infinite loop, it's important that only `_cmp` calls `_richcmp_`, we should not change `_cmp_` here.\n\nIssue created by migration from https://trac.sagemath.org/ticket/18322\n\n",
    "created_at": "2015-04-28T16:09:10Z",
    "labels": [
        "component: coercion"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.7",
    "title": "_cmp should try _richcmp_ if _cmp_ failed",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18085",
    "user": "https://github.com/jdemeyer"
}
```
CC:  @videlec

With the current comparison implementation, defining `__cmp__` in a Cython class can actually *break* `cmp()` if `_cmp_` raises `NotImplementedError`. This is because defining `__cmp__` causes Python to use `__cmp__` and *only* `__cmp__`. Instead, `__cmp__` (so really `_cmp` in Cython) should itself try `_richcmp_` if `_cmp_` didn't work.

To avoid an infinite loop, it's important that only `_cmp` calls `_richcmp_`, we should not change `_cmp_` here.

Issue created by migration from https://trac.sagemath.org/ticket/18322





---

archive/issue_comments_243350.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-04-29T09:16:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18085#issuecomment-243350",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_243351.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2015-04-29T09:16:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18085#issuecomment-243351",
    "user": "https://github.com/jdemeyer"
}
```

Last 10 new commits:



---

archive/issue_comments_243352.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-05-06T07:40:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18085#issuecomment-243352",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_243353.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-05-06T07:41:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18085#issuecomment-243353",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_243354.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-05-06T07:52:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18085#issuecomment-243354",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_243355.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-05-06T08:10:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18085#issuecomment-243355",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_243356.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-05-08T09:25:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18085#issuecomment-243356",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_243357.json:
```json
{
    "body": "1. The code of `_cmp_` raises a `NotImplementedError` which has a custom error message which involves string formatting. As this error is catched in a critical part of the code (i.e. `_cmp`) I would either:\n   - remove the message `\"comparison not implemented for %r\"%type(left)`\n   - or use lazy strings\n\n   The second option looks better to me.\n\n2. It would be nice to update this comment:\n\n```\n    ####################################################################\n    # For a derived Cython class, you **must** put the __richcmp__\n    ...\n    # arguments have identical parents.\n    ####################################################################\n```\n\n  with something like: `implementing `_richcmp_` will automatically makes `cmp` works, see the implementation of Element._cmp`.\n\n3. Actually, the current implementation let met think that for elements we should:\n   - implement `_richcmp_` for more speed (e.g. `==` is cheap but `<` is not) or if `_cmp_` does not make sense (e.g. we want to test for equality but raise errors on `<`)\n   - implement `_cmp_` otherwise\n\n   Am I right?\n\nVincent",
    "created_at": "2015-05-08T09:25:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18085#issuecomment-243357",
    "user": "https://github.com/videlec"
}
```

1. The code of `_cmp_` raises a `NotImplementedError` which has a custom error message which involves string formatting. As this error is catched in a critical part of the code (i.e. `_cmp`) I would either:
   - remove the message `"comparison not implemented for %r"%type(left)`
   - or use lazy strings

   The second option looks better to me.

2. It would be nice to update this comment:

```
    ####################################################################
    # For a derived Cython class, you **must** put the __richcmp__
    ...
    # arguments have identical parents.
    ####################################################################
```

  with something like: `implementing `_richcmp_` will automatically makes `cmp` works, see the implementation of Element._cmp`.

3. Actually, the current implementation let met think that for elements we should:
   - implement `_richcmp_` for more speed (e.g. `==` is cheap but `<` is not) or if `_cmp_` does not make sense (e.g. we want to test for equality but raise errors on `<`)
   - implement `_cmp_` otherwise

   Am I right?

Vincent



---

archive/issue_comments_243358.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-08T15:36:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18085#issuecomment-243358",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_243359.json:
```json
{
    "body": "Replying to [comment:8 vdelecroix]:\n> 3. Actually, the current implementation let met think that for elements we should:\n>  - implement `_richcmp_` for more speed (e.g. `==` is cheap but `<` is not) or if `_cmp_` does not make sense (e.g. we want to test for equality but raise errors on `<`)\n>  - implement `_cmp_` otherwise\nI think so, yes.",
    "created_at": "2015-05-08T16:52:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18085#issuecomment-243359",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:8 vdelecroix]:
> 3. Actually, the current implementation let met think that for elements we should:
>  - implement `_richcmp_` for more speed (e.g. `==` is cheap but `<` is not) or if `_cmp_` does not make sense (e.g. we want to test for equality but raise errors on `<`)
>  - implement `_cmp_` otherwise
I think so, yes.



---

archive/issue_comments_243360.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-08T17:00:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18085#issuecomment-243360",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_243361.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-05-08T17:00:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18085#issuecomment-243361",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_243362.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-05-08T21:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18085#issuecomment-243362",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_243363.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-05-09T23:03:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18085#issuecomment-243363",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
