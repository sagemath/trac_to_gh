# Issue 29912: Cygwin: problem with DLL search order when using system Python

archive/issues_029912.json:
```json
{
    "body": "CC:  @dimpase @mkoeppe\n\nI noticed a problem when trying to run the tests for the latest Sage, that the wrong version of `libR.dll` was being loaded, because I have R installed via Sage, but I also have the R package for Cygwin installed.\n\nMy path starts with:\n\n\n```\n/home/embray/src/sagemath/sage/local/lib/R/lib:/home/embray/src/sagemath/sage/local/lib:/home/embray/src/sagemath/sage/build/bin:/home/embray/src/sagemath/sage/src/bin:/home/embray/src/sagemath/sage/local/bin:/usr/local/bin:/usr/bin\n```\n\n\nso when importing `rpy2` it should link with the `libR.dll` that's in `$SAGE_LOCAL/lib/R/lib`.  Normally this has been the case.\n\nBut when using the system Python this is not so.  This is because according to the standard [DLL search path](https://docs.microsoft.com/en-us/previous-versions/7d83bc18(v=vs.140)?redirectedfrom=MSDN) the first place it looks is:\n\n> The directory where the executable module for the current process is located.\n\nWell, when running the system Python that's `/usr/bin` where `python3.7m.exe` lives.  However, that's also where the system's `libR.dll` lives.\n\nThis is just an example, but it's a broader problem: For any DLL linked to by a compiled Python module, it will always privilege the one in `/usr/bin` over a copy provided by Sage.\n\nWhat we might have to do is, at least on Cygwin, when creating the venv it should actually copy the Python executable instead of just symlinking to it.  I believe venv has an option for this. \n\nIssue created by migration from https://trac.sagemath.org/ticket/30149\n\n",
    "created_at": "2020-07-15T13:17:53Z",
    "labels": [
        "component: porting: cygwin",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Cygwin: problem with DLL search order when using system Python",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29912",
    "user": "https://github.com/embray"
}
```
CC:  @dimpase @mkoeppe

I noticed a problem when trying to run the tests for the latest Sage, that the wrong version of `libR.dll` was being loaded, because I have R installed via Sage, but I also have the R package for Cygwin installed.

My path starts with:


```
/home/embray/src/sagemath/sage/local/lib/R/lib:/home/embray/src/sagemath/sage/local/lib:/home/embray/src/sagemath/sage/build/bin:/home/embray/src/sagemath/sage/src/bin:/home/embray/src/sagemath/sage/local/bin:/usr/local/bin:/usr/bin
```


so when importing `rpy2` it should link with the `libR.dll` that's in `$SAGE_LOCAL/lib/R/lib`.  Normally this has been the case.

But when using the system Python this is not so.  This is because according to the standard [DLL search path](https://docs.microsoft.com/en-us/previous-versions/7d83bc18(v=vs.140)?redirectedfrom=MSDN) the first place it looks is:

> The directory where the executable module for the current process is located.

Well, when running the system Python that's `/usr/bin` where `python3.7m.exe` lives.  However, that's also where the system's `libR.dll` lives.

This is just an example, but it's a broader problem: For any DLL linked to by a compiled Python module, it will always privilege the one in `/usr/bin` over a copy provided by Sage.

What we might have to do is, at least on Cygwin, when creating the venv it should actually copy the Python executable instead of just symlinking to it.  I believe venv has an option for this. 

Issue created by migration from https://trac.sagemath.org/ticket/30149





---

archive/issue_comments_424384.json:
```json
{
    "body": "In `build/bin/sage-venv` there are some lines:\n\n\n```\nif os.name == 'nt':\n    # default for Windows\n    use_symlinks = False\nelse:\n    # default for posix\n    # On macOS, definitely need symlinks=True (which matches what we test in build/pkgs/spkg-configure.m4)\n    # or it may fail with 'dyld: Library not loaded: @executable_path/../Python3' on macOS.\n    use_symlinks = True\n```\n\n\nBut this first check is useless because we currently don't support native Windows.  It should say `if sys.platform == 'cygwin'`, or if we really want to be optimistic `if sys.platform in ['win32', 'cygwin']`.",
    "created_at": "2020-07-15T13:24:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29912#issuecomment-424384",
    "user": "https://github.com/embray"
}
```

In `build/bin/sage-venv` there are some lines:


```
if os.name == 'nt':
    # default for Windows
    use_symlinks = False
else:
    # default for posix
    # On macOS, definitely need symlinks=True (which matches what we test in build/pkgs/spkg-configure.m4)
    # or it may fail with 'dyld: Library not loaded: @executable_path/../Python3' on macOS.
    use_symlinks = True
```


But this first check is useless because we currently don't support native Windows.  It should say `if sys.platform == 'cygwin'`, or if we really want to be optimistic `if sys.platform in ['win32', 'cygwin']`.



---

archive/issue_comments_424385.json:
```json
{
    "body": "Thanks for catching this! Are you preparing a branch?",
    "created_at": "2020-07-15T14:43:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29912#issuecomment-424385",
    "user": "https://github.com/mkoeppe"
}
```

Thanks for catching this! Are you preparing a branch?



---

archive/issue_comments_424386.json:
```json
{
    "body": "This seems to have partially fixed the problem, but only partially.  Now there's something *really* bizarre happening, which is that if I run `./sage -python` and do `from sage.all import r; r('\"abc\"')` it loads the correct `libR.dll`.  But if I do just `./sage` and then `r('\"abc\"')` in the Sage shell, it reverts back to the bad behavior.\n\nThis shouldn't be, since in both cases it's still running the same Python interpreter executable.",
    "created_at": "2020-07-15T15:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29912#issuecomment-424386",
    "user": "https://github.com/embray"
}
```

This seems to have partially fixed the problem, but only partially.  Now there's something *really* bizarre happening, which is that if I run `./sage -python` and do `from sage.all import r; r('"abc"')` it loads the correct `libR.dll`.  But if I do just `./sage` and then `r('"abc"')` in the Sage shell, it reverts back to the bad behavior.

This shouldn't be, since in both cases it's still running the same Python interpreter executable.



---

archive/issue_comments_424387.json:
```json
{
    "body": "I cannot for the life of me find any logical explanation for this discrepancy.",
    "created_at": "2020-07-15T15:43:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29912#issuecomment-424387",
    "user": "https://github.com/embray"
}
```

I cannot for the life of me find any logical explanation for this discrepancy.



---

archive/issue_comments_424388.json:
```json
{
    "body": "Tried with strace?",
    "created_at": "2020-07-15T16:19:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29912#issuecomment-424388",
    "user": "https://github.com/mkoeppe"
}
```

Tried with strace?



---

archive/issue_comments_424389.json:
```json
{
    "body": "rpy2 does weird things with loading libR and blas/lapack, they need a correct order of this.\n\ncf https://github.com/rpy2/rpy2/issues/505",
    "created_at": "2020-07-15T17:43:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29912#issuecomment-424389",
    "user": "https://github.com/dimpase"
}
```

rpy2 does weird things with loading libR and blas/lapack, they need a correct order of this.

cf https://github.com/rpy2/rpy2/issues/505



---

archive/issue_comments_424390.json:
```json
{
    "body": "Before getting into the depths of what rpy2 may be doing on Cygwin, I'd suggest to try the rpy2 update first - #29441 is waiting for review",
    "created_at": "2020-07-15T17:46:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29912#issuecomment-424390",
    "user": "https://github.com/mkoeppe"
}
```

Before getting into the depths of what rpy2 may be doing on Cygwin, I'd suggest to try the rpy2 update first - #29441 is waiting for review



---

archive/issue_comments_424391.json:
```json
{
    "body": "This doesn't have anything to directly with rpy2",
    "created_at": "2020-07-16T16:04:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29912#issuecomment-424391",
    "user": "https://github.com/embray"
}
```

This doesn't have anything to directly with rpy2



---

archive/issue_comments_424392.json:
```json
{
    "body": "See #30157",
    "created_at": "2020-07-16T16:19:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29912#issuecomment-424392",
    "user": "https://github.com/embray"
}
```

See #30157



---

archive/issue_comments_424393.json:
```json
{
    "body": "For now I'll create a patch for this issue.  It's actually a totally separate issue from #30157.",
    "created_at": "2020-07-16T16:19:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29912#issuecomment-424393",
    "user": "https://github.com/embray"
}
```

For now I'll create a patch for this issue.  It's actually a totally separate issue from #30157.



---

archive/issue_comments_424394.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-07-16T16:51:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29912#issuecomment-424394",
    "user": "https://github.com/embray"
}
```

New commits:



---

archive/issue_comments_424395.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-07-16T16:51:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29912#issuecomment-424395",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_424396.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-16T17:33:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29912#issuecomment-424396",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_424397.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-28T22:32:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29912",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29912#issuecomment-424397",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
