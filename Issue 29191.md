# Issue 29191: Crash when trying to autocomplete

Issue created by migration from https://trac.sagemath.org/ticket/29428

Original creator: mmasdeu

Original creation time: 2020-03-30 11:16:51

CC:  vdelecroix jdemeyer embray arojas

Keywords: autocompletion, jedi, cython

Working with some custom modules that use cython, Sage crashes. Tracking it down, it appears that the source of the problem lies in the changes introduced in #24681.

The Jedi code tries to call `get_source()` and fails terribly because of that. I understand that #24681 tried to solve a problem, but the one it causes is much worse.

This is running Arch Linux with package sagemath 9.0-12, currently (2020/03/30) up to date.


---

Comment by @mwageringel created at 2020-04-05 13:34:15

`@`mmasdeu: Please provide a small example that leads to the problem. The main branch of Sage does not use jedi yet, so you could install Sage from source as a workaround.


---

Attachment

I uninstalled my extensions and it seems that the problem persists. Here is a MNWE:


```
sage: E = EllipticCurve('11a1')
sage: Et = E.tate_curve(11)
sage: Et.<TAB>
```


After this, nothing shows up. After a couple of seconds, Sage crashes. I attached the crash report.


---

Comment by arojas created at 2020-04-07 21:55:06

I have reverted #24681 in the Arch package. This will eventually hit sage-the-distro when ipython is upgraded, so a different solution needs to be found for the problem in #24681


---

Comment by jhpalmieri created at 2020-04-25 16:59:36

I just installed IPython 7.13 and Jedi 0.17.0, and I don't see this problem. I'm still working out the kinks with the IPython installation, and in particular, the preparser seems to be broken: I get

```
sage: E = EllipticCurve('11a1')                                                           
sage: Et = E.tate_curve(11)                                                               
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-2-375b7dd9888b> in <module>
----> 1 Et = E.tate_curve(11)

...

AttributeError: 'int' object has no attribute 'is_prime'
```

But this works:

```
sage: E = EllipticCurve('11a1')
sage: Et = E.tate_curve(Integer(11))
sage: Et.<tab>
```



---

Comment by jhpalmieri created at 2020-04-25 18:40:39

I actually do see a problem, but not a crash. I'm attaching a screenshot after hitting `Et.<tab>`. (I'm trying this combined with #28197, not on its own.)


---

Comment by jhpalmieri created at 2020-04-25 18:41:11

screen shot after Et.<tab>


---

Attachment

We had a similar problem with polymake/jupymake. Tab completion in IPython runs in a separate thread. This can break packages that are not prepared for threaded operation.


---

Comment by mkoeppe created at 2020-04-25 20:29:15

Replying to [comment:6 mkoeppe]:
> We had a similar problem with polymake/jupymake. Tab completion in IPython runs in a separate thread. This can break packages that are not prepared for threaded operation.
For reference: This happened in #22704, https://git.sagemath.org/sage.git/commit/?id=bcc7c6b88bb6c622988bf3b06579a5560c0181ee


---

Comment by arojas created at 2020-05-06 18:14:02

Replying to [comment:4 jhpalmieri]:
> I just installed IPython 7.13 and Jedi 0.17.0, and I don't see this problem.

I can confirm that this is fixed with jedi 0.17, specifically https://github.com/davidhalter/jedi/commit/e1425de8a437100601f312840d57cc0d4a10e264

So I guess this can be closed, since 0.16 will never be used in Sage.


---

Comment by arojas created at 2020-05-06 18:15:01

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2020-05-06 21:56:19

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2020-05-06 21:56:19

I don't really think we need reviewer names for tickets to be closed, but I'll enter my name anyway.


---

Comment by chapoton created at 2020-06-17 07:12:30

Resolution: invalid
