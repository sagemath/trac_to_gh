# Issue 13712: Fix inspection of interactive Cython code

archive/issues_013712.json:
```json
{
    "body": "Assignee: @jasongrout\n\nCC:  @robertwb\n\nThe following happens with sage-5.6.b2, at least in the debug version from #13864 (I could imagine that the new Cython version from #13896 could be related as well):\n\n```\nsage: cython('''cpdef test_funct(x,y): return''')\nsage: from sage.misc.sageinspect import sage_getfile\nsage: os.path.exists(sage_getfile(test_funct))\nFalse\n```\n\n\nIIRC, it used to work. hence, I suppose some paths have changed.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13916\n\n",
    "created_at": "2013-01-06T12:59:21Z",
    "labels": [
        "component: misc",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.2",
    "title": "Fix inspection of interactive Cython code",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13712",
    "user": "https://github.com/simon-king-jena"
}
```
Assignee: @jasongrout

CC:  @robertwb

The following happens with sage-5.6.b2, at least in the debug version from #13864 (I could imagine that the new Cython version from #13896 could be related as well):

```
sage: cython('''cpdef test_funct(x,y): return''')
sage: from sage.misc.sageinspect import sage_getfile
sage: os.path.exists(sage_getfile(test_funct))
False
```


IIRC, it used to work. hence, I suppose some paths have changed.

Issue created by migration from https://trac.sagemath.org/ticket/13916





---

archive/issue_comments_169884.json:
```json
{
    "body": "Could it be that simply Cython is writing the wrong information into the doc?\n\n```\nsage: _sage_getdoc_unformatted(test_funct)\n'File: _home_simon__sage_temp_linux_sqwp_site_6004_tmp_rJ1Nyc_spyx_0.pyx (starting at line 6)'\n```\n\nBut the file is at\n\n```\n~/.sage/temp/linux_sqwp.site/6004/tmp_rJ1Nyc.spyx\n```\n\nor\n\n```\n~/.sage/temp/linux_sqwp.site/6004/spyx/_home_simon__sage_temp_linux_sqwp_site_6004_tmp_rJ1Nyc_spyx/tmp_rJ1Nyc.spyx\n```\n\n(they coincide bit-wise). Note that even the \".pyx\" information is wrong.",
    "created_at": "2013-01-06T13:17:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13712#issuecomment-169884",
    "user": "https://github.com/simon-king-jena"
}
```

Could it be that simply Cython is writing the wrong information into the doc?

```
sage: _sage_getdoc_unformatted(test_funct)
'File: _home_simon__sage_temp_linux_sqwp_site_6004_tmp_rJ1Nyc_spyx_0.pyx (starting at line 6)'
```

But the file is at

```
~/.sage/temp/linux_sqwp.site/6004/tmp_rJ1Nyc.spyx
```

or

```
~/.sage/temp/linux_sqwp.site/6004/spyx/_home_simon__sage_temp_linux_sqwp_site_6004_tmp_rJ1Nyc_spyx/tmp_rJ1Nyc.spyx
```

(they coincide bit-wise). Note that even the ".pyx" information is wrong.



---

archive/issue_comments_169885.json:
```json
{
    "body": "Actually there *is* a pyx file (I am in a new session now, hence, the names have changed):\n\n```\n~/.sage/temp/linux_sqwp.site/6593/spyx/_home_simon__sage_temp_linux_sqwp_site_6593_tmp_mqjIHk_spyx/_home_simon__sage_temp_linux_sqwp_site_6593_tmp_mqjIHk_spyx_0.pyx\n```\n\n\nThe question is: Do we want to see the spyx file or the pyx file? Anyway, I think I'll manage to make sageinspect find that pyx file.",
    "created_at": "2013-01-06T13:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13712#issuecomment-169885",
    "user": "https://github.com/simon-king-jena"
}
```

Actually there *is* a pyx file (I am in a new session now, hence, the names have changed):

```
~/.sage/temp/linux_sqwp.site/6593/spyx/_home_simon__sage_temp_linux_sqwp_site_6593_tmp_mqjIHk_spyx/_home_simon__sage_temp_linux_sqwp_site_6593_tmp_mqjIHk_spyx_0.pyx
```


The question is: Do we want to see the spyx file or the pyx file? Anyway, I think I'll manage to make sageinspect find that pyx file.



---

archive/issue_comments_169886.json:
```json
{
    "body": "With the attached patch, the following doctest works.\n\n```\n        sage: cython('''cpdef test_funct(x,y): return''')\n        sage: print open(_extract_embedded_position(inspect.getdoc(test_funct))[1]).read()\n        <BLANKLINE>\n        include \"interrupt.pxi\"  # ctrl-c interrupt block support\n        include \"stdsage.pxi\"  # ctrl-c interrupt block support\n        <BLANKLINE>\n        include \"cdefs.pxi\"\n        cpdef test_funct(x,y): return\n```\n\nThe tests of sage/misc/sageinspect.py pass. Needs review!",
    "created_at": "2013-01-06T13:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13712#issuecomment-169886",
    "user": "https://github.com/simon-king-jena"
}
```

With the attached patch, the following doctest works.

```
        sage: cython('''cpdef test_funct(x,y): return''')
        sage: print open(_extract_embedded_position(inspect.getdoc(test_funct))[1]).read()
        <BLANKLINE>
        include "interrupt.pxi"  # ctrl-c interrupt block support
        include "stdsage.pxi"  # ctrl-c interrupt block support
        <BLANKLINE>
        include "cdefs.pxi"
        cpdef test_funct(x,y): return
```

The tests of sage/misc/sageinspect.py pass. Needs review!



---

archive/issue_comments_169887.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-01-06T13:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13712#issuecomment-169887",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_169888.json:
```json
{
    "body": "First, about your patch:\n1. it makes sage_getfile work on the box where I have doctest issues, which is positive ;\n2. but shouldn't os.path.join(SAGE_ROOT,'devel/sage', raw_filename) be os.path.join(SAGE_ROOT, 'devel', 'sage', raw_filename)? You're basically assuming that '/' is the path separator, which is perhaps a portability problem.\n\nOn the box where I patched paths, the source file looks like this:\n\n```\n\ninclude \"sage/ext/stdsage.pxi\"  # ctrl-c interrupt block support\n\ninclude \"cdefs.pxi\"\ncpdef test_funct(x,y): return\n```\n\n\nwhile on another, unpatched, box (again, initial empty line is eaten by trac) it is:\n\n```\ninclude \"interrupt.pxi\"  # ctrl-c interrupt block support\ninclude \"stdsage.pxi\"  # ctrl-c interrupt block support\n\ninclude \"cdefs.pxi\"\ncpdef test_funct(x,y): return\n```\n",
    "created_at": "2013-01-06T14:40:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13712#issuecomment-169888",
    "user": "https://trac.sagemath.org/admin/accounts/users/Snark"
}
```

First, about your patch:
1. it makes sage_getfile work on the box where I have doctest issues, which is positive ;
2. but shouldn't os.path.join(SAGE_ROOT,'devel/sage', raw_filename) be os.path.join(SAGE_ROOT, 'devel', 'sage', raw_filename)? You're basically assuming that '/' is the path separator, which is perhaps a portability problem.

On the box where I patched paths, the source file looks like this:

```

include "sage/ext/stdsage.pxi"  # ctrl-c interrupt block support

include "cdefs.pxi"
cpdef test_funct(x,y): return
```


while on another, unpatched, box (again, initial empty line is eaten by trac) it is:

```
include "interrupt.pxi"  # ctrl-c interrupt block support
include "stdsage.pxi"  # ctrl-c interrupt block support

include "cdefs.pxi"
cpdef test_funct(x,y): return
```




---

archive/issue_comments_169889.json:
```json
{
    "body": "Replying to [comment:5 Snark]:\n> 2. but shouldn't os.path.join(SAGE_ROOT,'devel/sage', raw_filename) be os.path.join(SAGE_ROOT, 'devel', 'sage', raw_filename)? You're basically assuming that '/' is the path separator, which is perhaps a portability problem.\n\nYes, you are right. I'll update the patch in a minute.\n\n> On the box where I patched paths, the source file looks like this:\n> {{{\n> \n> include \"sage/ext/stdsage.pxi\"  # ctrl-c interrupt block support\n> \n> include \"cdefs.pxi\"\n> cpdef test_funct(x,y): return\n> }}}\n> \n> while on another, unpatched, box (again, initial empty line is eaten by trac) it is:\n> {{{\n> include \"interrupt.pxi\"  # ctrl-c interrupt block support\n> include \"stdsage.pxi\"  # ctrl-c interrupt block support\n> \n> include \"cdefs.pxi\"\n> cpdef test_funct(x,y): return\n> }}}\n\nOK. That explains why the line number has changed, because the number of lines in front of the function definition has changed. And I suppose the change is indeed related with your patch from #12728, isn't it?\n\nThe patch from here is self-contained, but one old test and the new test from here will change with #12728. Hence, I suggest to use this ticket as a new dependency for #12728, and you add a patch on #12728 that fixes the doctests.",
    "created_at": "2013-01-06T15:09:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13712#issuecomment-169889",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:5 Snark]:
> 2. but shouldn't os.path.join(SAGE_ROOT,'devel/sage', raw_filename) be os.path.join(SAGE_ROOT, 'devel', 'sage', raw_filename)? You're basically assuming that '/' is the path separator, which is perhaps a portability problem.

Yes, you are right. I'll update the patch in a minute.

> On the box where I patched paths, the source file looks like this:
> {{{
> 
> include "sage/ext/stdsage.pxi"  # ctrl-c interrupt block support
> 
> include "cdefs.pxi"
> cpdef test_funct(x,y): return
> }}}
> 
> while on another, unpatched, box (again, initial empty line is eaten by trac) it is:
> {{{
> include "interrupt.pxi"  # ctrl-c interrupt block support
> include "stdsage.pxi"  # ctrl-c interrupt block support
> 
> include "cdefs.pxi"
> cpdef test_funct(x,y): return
> }}}

OK. That explains why the line number has changed, because the number of lines in front of the function definition has changed. And I suppose the change is indeed related with your patch from #12728, isn't it?

The patch from here is self-contained, but one old test and the new test from here will change with #12728. Hence, I suggest to use this ticket as a new dependency for #12728, and you add a patch on #12728 that fixes the doctests.



---

archive/issue_comments_169890.json:
```json
{
    "body": "Attachment [trac13916_inspect_interactive_cython.patch](tarball://root/attachments/some-uuid/ticket13916/trac13916_inspect_interactive_cython.patch) by @simon-king-jena created at 2013-01-06 15:10:16",
    "created_at": "2013-01-06T15:10:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13712#issuecomment-169890",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment [trac13916_inspect_interactive_cython.patch](tarball://root/attachments/some-uuid/ticket13916/trac13916_inspect_interactive_cython.patch) by @simon-king-jena created at 2013-01-06 15:10:16



---

archive/issue_comments_169891.json:
```json
{
    "body": "The patch is updated, still needs review.",
    "created_at": "2013-01-06T15:12:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13712#issuecomment-169891",
    "user": "https://github.com/simon-king-jena"
}
```

The patch is updated, still needs review.



---

archive/issue_comments_169892.json:
```json
{
    "body": "I found a problem in my own patch, so this trac ticket is independent from #12728.\n\nSimon, your patch looks nice, applies nice and compiles nice ; but since I'm going to get another round of rebuilding and full doctesting sage, I'll report what happens later (I'm not doing that on the arm box, so it shouldn't take two days :-P).",
    "created_at": "2013-01-06T16:00:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13712#issuecomment-169892",
    "user": "https://trac.sagemath.org/admin/accounts/users/Snark"
}
```

I found a problem in my own patch, so this trac ticket is independent from #12728.

Simon, your patch looks nice, applies nice and compiles nice ; but since I'm going to get another round of rebuilding and full doctesting sage, I'll report what happens later (I'm not doing that on the arm box, so it shouldn't take two days :-P).



---

archive/issue_comments_169893.json:
```json
{
    "body": "Replying to [comment:8 Snark]:\n> I found a problem in my own patch, so this trac ticket is independent from #12728.\n> \n> Simon, your patch looks nice, applies nice and compiles nice ; but since I'm going to get another round of rebuilding and full doctesting sage, I'll report what happens later (I'm not doing that on the arm box, so it shouldn't take two days :-P).\n\nNow two weeks are over. Did it work?",
    "created_at": "2013-01-21T10:49:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13712#issuecomment-169893",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:8 Snark]:
> I found a problem in my own patch, so this trac ticket is independent from #12728.
> 
> Simon, your patch looks nice, applies nice and compiles nice ; but since I'm going to get another round of rebuilding and full doctesting sage, I'll report what happens later (I'm not doing that on the arm box, so it shouldn't take two days :-P).

Now two weeks are over. Did it work?



---

archive/issue_comments_169894.json:
```json
{
    "body": "Since the coverage script complains, I'll try to add some new tests in sageinspect.py",
    "created_at": "2013-01-21T10:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13712#issuecomment-169894",
    "user": "https://github.com/simon-king-jena"
}
```

Since the coverage script complains, I'll try to add some new tests in sageinspect.py



---

archive/issue_comments_169895.json:
```json
{
    "body": "PS: The error reported by the patchbot seems unrelated.",
    "created_at": "2013-01-21T10:54:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13712#issuecomment-169895",
    "user": "https://github.com/simon-king-jena"
}
```

PS: The error reported by the patchbot seems unrelated.



---

archive/issue_comments_169896.json:
```json
{
    "body": "PPS: The coverage script reports nonsense. It says that the number of tests did not increase, but the number of functions did increase. But that's plain wrong: My patch does not introduce new functions, it only fixes existing functions. And it does add tests. So, I'll keep it like that, if you don't mind.",
    "created_at": "2013-01-21T10:56:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13712#issuecomment-169896",
    "user": "https://github.com/simon-king-jena"
}
```

PPS: The coverage script reports nonsense. It says that the number of tests did not increase, but the number of functions did increase. But that's plain wrong: My patch does not introduce new functions, it only fixes existing functions. And it does add tests. So, I'll keep it like that, if you don't mind.



---

archive/issue_events_039079.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13712#event-39079"
}
```



---

archive/issue_events_039080.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13712#event-39080"
}
```



---

archive/issue_events_039081.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13712#event-39081"
}
```



---

archive/issue_comments_169897.json:
```json
{
    "body": "Didn't apply cleanly to 6.0+; updated; needs review again.",
    "created_at": "2014-03-14T10:29:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13712#issuecomment-169897",
    "user": "https://github.com/mezzarobba"
}
```

Didn't apply cleanly to 6.0+; updated; needs review again.



---

archive/issue_comments_169898.json:
```json
{
    "body": "Changing keywords from \"\" to \"days57\".",
    "created_at": "2014-04-07T21:11:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13712#issuecomment-169898",
    "user": "https://github.com/vbraun"
}
```

Changing keywords from "" to "days57".



---

archive/issue_comments_169899.json:
```json
{
    "body": "Looks good to me",
    "created_at": "2014-04-07T21:11:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13712#issuecomment-169899",
    "user": "https://github.com/vbraun"
}
```

Looks good to me



---

archive/issue_comments_169900.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-04-07T21:13:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13712#issuecomment-169900",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_169901.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-04-08T10:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13712#issuecomment-169901",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_039082.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-04-08T10:17:37Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13712",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13712#event-39082"
}
```
