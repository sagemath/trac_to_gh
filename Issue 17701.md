# Issue 17701: implement common refinement of fans

Issue created by migration from https://trac.sagemath.org/ticket/17938

Original creator: chapoton

Original creation time: 2015-03-12 10:06:24

CC:  vbraun novoselt jkeitel

Keywords: fan, toric, refinement

Given two fans in the same lattice, compute the common refinement.


---

Comment by chapoton created at 2015-03-12 10:42:49

Changing status from new to needs_review.


---

Comment by chapoton created at 2015-03-12 10:42:49

New commits:


---

Comment by chapoton created at 2015-03-12 10:42:49

Changing priority from major to minor.


---

Comment by git created at 2015-03-14 21:21:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by novoselt created at 2015-03-15 19:01:37

There is nothing difficult with incomplete fans, just need to verify that supports are the same! If you are fine with changes, set to positive review.
----
New commits:


---

Comment by chapoton created at 2015-03-16 08:57:05

Sorry, but I do not understand what you do with the reverse morphism. It seems like you just do nothing in this `if not(self.is_complete())` statement. Does the simple fact of calling `FanMorphism` magically modify `subdivision` ?


---

Comment by novoselt created at 2015-03-16 17:45:55

It better not modify anything in the global namespace!!!

```
sage: F1 = toric_varieties.P2().fan()
sage: F2 = Fan([F1.generating_cone(0)])
sage: F2.common_refinement(F1)
...
   1661         if not self.is_complete():
   1662             # Construct the opposite morphism to ensure support equality
-> 1663             FanMorphism(id, other, self, subdivide=True)
...
ValueError: morphism defined by
[1 0]
[0 1]
does not map
Rational polyhedral fan in 2-d lattice N
into the support of
Rational polyhedral fan in 2-d lattice N!
```

Without constructing the second morphism, it is not obvious that the support of F1 is not strictly bigger than the support of F2. Yet if the second one can be constructed, its domain fan will be exactly the same subdivision, so no need to use it somehow.

Checking equality of supports of non-complete fans is tricky, since the support does not have to be convex, so there is no simple object that can model it. (And that's why we don't have `fan.support()` method - the best model for the support of a general fan is the fan itself as a polyhedral complex.) Another more transparent option is to check if the first constructed morphism is surjective, but looking at the code I suspect it is more time-consuming.


---

Comment by chapoton created at 2015-03-16 20:13:12

Ok, looks good to me. I have just added one more example. If you agree, you can set a positive review. 
----
New commits:


---

Comment by novoselt created at 2015-03-16 20:21:05

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-03-19 03:17:28

Resolution: fixed
