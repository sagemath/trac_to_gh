# Issue 17701: implement common refinement of fans

archive/issues_017701.json:
```json
{
    "body": "CC:  @vbraun @novoselt jkeitel\n\nKeywords: fan, toric, refinement\n\nGiven two fans in the same lattice, compute the common refinement.\n\nIssue created by migration from https://trac.sagemath.org/ticket/17938\n\n",
    "created_at": "2015-03-12T10:06:24Z",
    "labels": [
        "geometry",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.6",
    "title": "implement common refinement of fans",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17701",
    "user": "@fchapoton"
}
```
CC:  @vbraun @novoselt jkeitel

Keywords: fan, toric, refinement

Given two fans in the same lattice, compute the common refinement.

Issue created by migration from https://trac.sagemath.org/ticket/17938





---

archive/issue_comments_236672.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-03-12T10:42:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17701#issuecomment-236672",
    "user": "@fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_236673.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-03-12T10:42:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17701#issuecomment-236673",
    "user": "@fchapoton"
}
```

New commits:



---

archive/issue_comments_236674.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2015-03-12T10:42:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17701#issuecomment-236674",
    "user": "@fchapoton"
}
```

Changing priority from major to minor.



---

archive/issue_comments_236675.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-03-14T21:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17701#issuecomment-236675",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_236676.json:
```json
{
    "body": "There is nothing difficult with incomplete fans, just need to verify that supports are the same! If you are fine with changes, set to positive review.\n----\nNew commits:",
    "created_at": "2015-03-15T19:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17701#issuecomment-236676",
    "user": "@novoselt"
}
```

There is nothing difficult with incomplete fans, just need to verify that supports are the same! If you are fine with changes, set to positive review.
----
New commits:



---

archive/issue_comments_236677.json:
```json
{
    "body": "Sorry, but I do not understand what you do with the reverse morphism. It seems like you just do nothing in this `if not(self.is_complete())` statement. Does the simple fact of calling `FanMorphism` magically modify `subdivision` ?",
    "created_at": "2015-03-16T08:57:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17701#issuecomment-236677",
    "user": "@fchapoton"
}
```

Sorry, but I do not understand what you do with the reverse morphism. It seems like you just do nothing in this `if not(self.is_complete())` statement. Does the simple fact of calling `FanMorphism` magically modify `subdivision` ?



---

archive/issue_comments_236678.json:
```json
{
    "body": "It better not modify anything in the global namespace!!!\n\n```\nsage: F1 = toric_varieties.P2().fan()\nsage: F2 = Fan([F1.generating_cone(0)])\nsage: F2.common_refinement(F1)\n...\n   1661         if not self.is_complete():\n   1662             # Construct the opposite morphism to ensure support equality\n-> 1663             FanMorphism(id, other, self, subdivide=True)\n...\nValueError: morphism defined by\n[1 0]\n[0 1]\ndoes not map\nRational polyhedral fan in 2-d lattice N\ninto the support of\nRational polyhedral fan in 2-d lattice N!\n```\n\nWithout constructing the second morphism, it is not obvious that the support of F1 is not strictly bigger than the support of F2. Yet if the second one can be constructed, its domain fan will be exactly the same subdivision, so no need to use it somehow.\n\nChecking equality of supports of non-complete fans is tricky, since the support does not have to be convex, so there is no simple object that can model it. (And that's why we don't have `fan.support()` method - the best model for the support of a general fan is the fan itself as a polyhedral complex.) Another more transparent option is to check if the first constructed morphism is surjective, but looking at the code I suspect it is more time-consuming.",
    "created_at": "2015-03-16T17:45:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17701#issuecomment-236678",
    "user": "@novoselt"
}
```

It better not modify anything in the global namespace!!!

```
sage: F1 = toric_varieties.P2().fan()
sage: F2 = Fan([F1.generating_cone(0)])
sage: F2.common_refinement(F1)
...
   1661         if not self.is_complete():
   1662             # Construct the opposite morphism to ensure support equality
-> 1663             FanMorphism(id, other, self, subdivide=True)
...
ValueError: morphism defined by
[1 0]
[0 1]
does not map
Rational polyhedral fan in 2-d lattice N
into the support of
Rational polyhedral fan in 2-d lattice N!
```

Without constructing the second morphism, it is not obvious that the support of F1 is not strictly bigger than the support of F2. Yet if the second one can be constructed, its domain fan will be exactly the same subdivision, so no need to use it somehow.

Checking equality of supports of non-complete fans is tricky, since the support does not have to be convex, so there is no simple object that can model it. (And that's why we don't have `fan.support()` method - the best model for the support of a general fan is the fan itself as a polyhedral complex.) Another more transparent option is to check if the first constructed morphism is surjective, but looking at the code I suspect it is more time-consuming.



---

archive/issue_comments_236679.json:
```json
{
    "body": "Ok, looks good to me. I have just added one more example. If you agree, you can set a positive review. \n----\nNew commits:",
    "created_at": "2015-03-16T20:13:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17701#issuecomment-236679",
    "user": "@fchapoton"
}
```

Ok, looks good to me. I have just added one more example. If you agree, you can set a positive review. 
----
New commits:



---

archive/issue_comments_236680.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-03-16T20:21:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17701#issuecomment-236680",
    "user": "@novoselt"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_236681.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-03-19T03:17:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17701#issuecomment-236681",
    "user": "@vbraun"
}
```

Resolution: fixed
