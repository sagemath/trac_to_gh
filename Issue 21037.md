# Issue 21037: frac(x) immediate simplifications

Issue created by migration from https://trac.sagemath.org/ticket/21274

Original creator: rws

Original creation time: 2016-08-18 06:27:15

CC:  mkoeppe

As a followup to #21232 these automatic simplifications should be added:

```
sage: frac(frac(x))
frac(x)
sage: frac(floor(x))  # ceil
0
sage: assume(x, 'integer')
sage: frac(x)
0
sage: assume(x > 0)
sage: frac(tanh(x))
tanh(x)
```




---

Comment by rws created at 2016-09-05 06:07:15

New commits:


---

Comment by rws created at 2016-09-05 06:07:15

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2016-09-06 16:30:35

This all seems to work, but it's handling very specific cases and it would be much nicer if the system knew this:

```
sage: floor(x).is_integer()
True     # wishful
```



---

Comment by rws created at 2016-09-07 05:36:53

Actually the mechanics for this exists (eg https://github.com/pynac/pynac/issues/78) but `floor`, as it is not a `GinacFunction`, needs a different approach in Pynac than the ones implemented in that issue. Best I think is to first review #12121 and then after merge make `floor` a `GinacFunction`.


---

Comment by tscrim created at 2016-09-07 14:13:00

A very micro optimization:

```
sage: %timeit ZZ.zero()
The slowest run took 46.49 times longer than the fastest. This could mean that an intermediate result is being cached.
10000000 loops, best of 3: 61.5 ns per loop
sage: %timeit 0    # Preparsed as Integer(0) with the 0 being a python int
The slowest run took 40.29 times longer than the fastest. This could mean that an intermediate result is being cached.
10000000 loops, best of 3: 71 ns per loop
sage: z = int(0)
sage: %timeit Integer(z)
The slowest run took 53.93 times longer than the fastest. This could mean that an intermediate result is being cached.
10000000 loops, best of 3: 75.2 ns per loop
```



---

Comment by vdelecroix created at 2016-09-19 05:37:17

Why is this part of the function `frac`? The function should not care about simplifying the result in any way. If you want a custom `frac` you would better consider having a `frac` method to symbolic expression (and having the function `frac` calling it).


---

Comment by rws created at 2016-09-19 06:39:50

Very interesting. I completely forgot about these. First, if you look at `functions/*` you'll note a lot of expression arguments handled by custom code in `eval()` member functions, so called special values. We should write a `Expression` member function for all these functions? That would be an even larger class than it is now.

Secondly, I removed the `Expression.sin()` member and the only doctest that fails is the one explicitly calling it. So, it seems to me, other than taste or maybe convenience, there is no reason to have it. Didn't Occam demand not to multiply symbols beyond necessity?

I'm aware of the function `eval()` member being too general for expressions, and I'm constantly moving code into Pynac, so the special handling in `eval()` should be seen as a first step for testing code that is well maintainable because it's Python. If you insist I'll immediately move the `frac` code to C++. But please don't enlarge `Expression` any further and help with efforts to actually make it smaller.


---

Comment by rws created at 2016-09-19 07:46:53

As a further data point SymPy does not have functions as expression members at all, not even `.square()` or `.abs()`.


---

Comment by vdelecroix created at 2016-12-24 09:56:38

The main difference with SymPy is that Sage deals with a lot of different objects. `sqrt` can be called on integers, rationals, polynomials, power series, ... Not only symbolic expression. You really want to minimize type checking in the function to minimize the overhead (see e.g. the kind of discussions we had in #11332).


---

Comment by rws created at 2017-04-13 13:13:42

Changing status from needs_review to needs_work.


---

Comment by rws created at 2017-12-14 14:37:08

Replying to [comment:9 vdelecroix]:
> ... You really want to minimize type checking in the function to minimize the overhead (see e.g. the kind of discussions we had in #11332).

More and more I agree with this, see #24178. Still, I really don't want the symbolic version as `Expression` member but as standalone symbolic function, i.e., in `sage/functions`.
