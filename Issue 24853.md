# Issue 24853: Upgrade pynormaliz to 1.14 or higher (2.0?)

Issue created by migration from Trac.

Original creator: mkoeppe

Original creation time: 2018-04-03 17:43:21

CC:  jipilab @sebasguts moritz vdelecroix winfried mkoeppe tscrim

Keywords: IMA-PolyGeom

Upstream: 
 - https://pypi.python.org/packages/43/00/51d8270091fb3e490ceb372fd562447af158f7cc5f5391966c09dfd9403d/PyNormaliz-1.14.tar.gz#md5=32e03c8356dd1322e355145769022c6e


---

Comment by mkoeppe created at 2018-04-03 17:54:55

Last 10 new commits:


---

Comment by jipilab created at 2018-04-03 19:59:13

New commits:


---

Comment by jipilab created at 2018-04-04 14:31:47

New commits:


---

Comment by git created at 2018-04-04 17:40:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-04-04 19:25:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-04-04 20:02:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2018-04-09 16:25:34

After a discussion with gh-sebasguts: A new version of pynormaliz will be released in the upcoming days, including extended documentation and latest changes to pynormaliz.

In order not to mix things up too much with #25097 and #25091, it should be put as a priority in the reviewing queue...


---

Comment by jipilab created at 2018-04-13 15:38:52

The version numbers are now fixed.


---

Comment by jipilab created at 2018-04-13 16:01:46

I merged the changes done over the week with a fresh branch on top of sage8.2.rc2.

To be tested!
----
New commits:


---

Comment by jipilab created at 2018-04-13 17:29:25

Both compile without issues on debian-stretch.


---

Comment by jipilab created at 2018-07-05 08:56:29

I am current in OsnabrÃ¼ck with Winfried, and perhaps now would be a good time to refresh this ticket, now that the version 1.12 and other update of Normaliz are already in the box...

There will be a new version of Normaliz released in the next few days, so I would wait until the upstream is updated and then change the ticket. I would do the same with pynormaliz and then go ahead to test it.

Further, with that release, it will make it easier to work with the algebraic polytopes ticket.


---

Comment by jipilab created at 2018-07-11 09:56:52

New commits:


---

Comment by jipilab created at 2018-07-11 10:02:24

Changing status from new to needs_review.


---

Comment by jipilab created at 2018-07-11 10:02:24

I guess now this ticket needs proper review and testing.

It is a really good corner stone for the next steps in #25091 and #25097.

Please install on your platforms and check if it compiles...

There are a few new features along with the new versions.


---

Comment by jipilab created at 2018-07-11 10:12:20

Changing status from needs_review to needs_work.


---

Comment by jipilab created at 2018-07-11 10:12:20

I get a segmentation fault while testing 'backend_normaliz.py' while running


```
sage: p = Polyhedron(backend='normaliz')
sage: TestSuite(p).run(skip="_test_pickling")
```


on the empty polyhedron.


---

Comment by jipilab created at 2018-07-11 10:17:23

The traceback I get is pasted below. Something wrong in PyNormaliz with "._test_nonzero_equal()" ?


```
sage: p = Polyhedron(backend='normaliz')
sage: TestSuite(p).run(skip="_test_pickling",verbose=True)
running ._test_category() . . . pass
running ._test_eq() . . . pass
running ._test_new() . . . pass
running ._test_nonzero_equal() . . .------------------------------------------------------------------------
/home/jplabbe/sage/local/lib/python2.7/site-packages/cysignals/signals.so(+0x6ad5)[0x7f4ba65eaad5]
/home/jplabbe/sage/local/lib/python2.7/site-packages/cysignals/signals.so(+0x6b7f)[0x7f4ba65eab7f]
/home/jplabbe/sage/local/lib/python2.7/site-packages/cysignals/signals.so(+0xaf84)[0x7f4ba65eef84]
/lib/x86_64-linux-gnu/libpthread.so.0(+0x110c0)[0x7f4bafb040c0]
/home/jplabbe/sage/local/lib/libnormaliz.so.3(_ZN11libnormaliz6MatrixI10__gmp_exprIA1_12__mpz_structS3_EEC2Emm+0x9)[0x7f48e2c7ba29]
/home/jplabbe/sage/local/lib/libnormaliz.so.3(_ZN11libnormaliz4ConeI10__gmp_exprIA1_12__mpz_structS3_EE25prepare_input_constraintsERKSt3mapINS_4Type9InputTypeESt6vectorIS9_IS4_SaIS4_EESaISB_EESt4lessIS8_ESaISt4pairIKS8_SD_EEE+0x37)[0x7f48e2cd83e7]
/home/jplabbe/sage/local/lib/libnormaliz.so.3(_ZN11libnormaliz4ConeI10__gmp_exprIA1_12__mpz_structS3_EE25process_multi_input_innerERSt3mapINS_4Type9InputTypeESt6vectorIS9_IS4_SaIS4_EESaISB_EESt4lessIS8_ESaISt4pairIKS8_SD_EEE+0x8c5)[0x7f48e2d1ef75]
/home/jplabbe/sage/local/lib/libnormaliz.so.3(_ZN11libnormaliz4ConeI10__gmp_exprIA1_12__mpz_structS3_EE19process_multi_inputERKSt3mapINS_4Type9InputTypeESt6vectorIS9_IS4_SaIS4_EESaISB_EESt4lessIS8_ESaISt4pairIKS8_SD_EEE+0xae)[0x7f48e2d2151e]
```



---

Comment by @sebasguts created at 2018-07-11 11:13:47

Interesting. I will have a look.


---

Comment by Winfried created at 2018-07-11 13:59:08

Please let me know if you think that the problem is in Normaliz and send me the input.


---

Comment by jipilab created at 2018-07-16 08:27:30

Replying to [comment:25 gh-sebasguts]:
> Interesting. I will have a look.

Any idea where the segfault appears?


---

Comment by Winfried created at 2018-07-16 08:38:44

It would be good to see the definition of the empty polytope. Then we can investigate the issue further.


---

Comment by Winfried created at 2018-07-16 09:37:57

The empty polyhedron runs into a Normaliz segmentation fault if the volume is computed. Will be taken care of.


---

Comment by jipilab created at 2018-07-16 09:45:03

I made a `verbose=True` in the `TestSuite` to see where it fails, and in the `_test_nonzero_equal()` it calls `bool(self)` and `self.parent().zero()` which both produce segfaults on their own:


```
sage: P_empty = Polyhedron()
sage: bool(P_empty)
True
sage: p = Polyhedron(vertices=[(1, 1)], rays=[(0, 1)],backend='normaliz',verbose=True)
# Calling PyNormaliz.NmzCone(**{'subspace': [], 'vertices': [This is the Trac macro *1, 1, 1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1, 1, 1-macro), 'cone': [This is the Trac macro *0, 1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#0, 1-macro)})
# ----8<---- Equivalent Normaliz input file ----8<----
amb_space 2
subspace 0
vertices 1
 1 1 1
cone 1
 0 1
# ----8<-------------------8<-------------------8<----
sage: bool(p)
True
sage: p_empty = Polyhedron(backend='normaliz',verbose=True)
sage: bool(p_empty)
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
/usr/local/bin/sage: line 3:  5585 Segmentation fault      ~/sage/./sage $`@`


sage: p_empty = Polyhedron(backend='normaliz',verbose=True)
sage: p_empty.parent()
Polyhedra in ZZ^0
sage: p_empty.parent().zero()
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
/usr/local/bin/sage: line 3:  6354 Segmentation fault      ~/sage/./sage $`@`
```


Note that to create an empty polyhedron with the backend normaliz, no call to normaliz is done. So I do not think that the problem is at this level, but perhaps when dealing with the parents, it tries to call normaliz with something empty and it does not work...


---

Comment by jipilab created at 2018-07-16 10:38:29

I could figure out where the segfault occurs and with which input:


```
# Calling PyNormaliz.NmzCone(**{'inhom_equations': [], 'inhom_inequalities': [This is the Trac macro *0* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#0-macro)})
# ----8<---- Equivalent Normaliz input file ----8<----
amb_space 0
inhom_equations 0
inhom_inequalities 1
 0
# ----8<-------------------8<-------------------8<----
```


The problem occurs in the `_init_from_Hrepresentation`, where we get the normaliz data: `{'inhom_equations': [], 'inhom_inequalities': [This is the Trac macro *0* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#0-macro)}`

Somehow normaliz/pynormaliz does not like that?

I believe that dealing with the empty polyhedron at the normaliz level might help here?


---

Comment by Winfried created at 2018-07-16 10:48:50

The segmentation fault with Volume is not the cause of this problem. It cannot be reproduced with Normaliz itself because amb_space 0 is not a legal value so that Normaliz terminates with an error message.


---

Comment by Winfried created at 2018-07-16 11:50:03


```
amb_space 0
inhom_equations 0
inhom_inequalities 1
 0
```



does NOT define the empty polytope. The origin in the 0-dimensional space satisfies the inequality. If you replace the last0 by -1, you obtain the empty polytope.


---

Comment by jipilab created at 2018-07-16 14:33:03

Replying to [comment:33 Winfried]:
> 
> {{{
> amb_space 0
> inhom_equations 0
> inhom_inequalities 1
>  0
> }}}
> 
> 
> does NOT define the empty polytope. The origin in the 0-dimensional space satisfies the inequality. If you replace the last0 by -1, you obtain the empty polytope.

Oh, interesting, so probably this would be a good way to initialize the empty polyhedron from the H-representation to pass it to normaliz.

I'll check if I can fix that.


---

Comment by mkoeppe created at 2018-07-16 19:00:17

The current `backend_normaliz` handles the empty polyhedron specially (actually sage has one empty polyhedron for each ambient space dimension!)
If this special casing could be removed completely with the current version of normaliz, that would be great!


---

Comment by jipilab created at 2018-07-16 20:08:36

Replying to [comment:35 mkoeppe]:
> The current `backend_normaliz` handles the empty polyhedron specially (actually sage has one empty polyhedron for each ambient space dimension!)
> If this special casing could be removed completely with the current version of normaliz, that would be great!

Agreed! I'll have a look if this would work with the new version.


---

Comment by Winfried created at 2018-07-17 12:01:13

The embedding dimension is an essential parameter in Normaliz. If any simplification is desired, it must be done on the Sage side.

Sebastian and I have tried to correct all problems related to empty polytopes and to embedding dimension 0. Please pull normaliz/master and test again.


---

Comment by mkoeppe created at 2018-07-25 02:09:46

#25707 added a cocoalib package to sage. Should consider adding it as a dependency; but it's currently an experimental package


---

Comment by jipilab created at 2018-07-30 09:29:22

How to properly get the 0-dimensional polytope consisting of the origin only in the 0-dimensional ambient space using the V-representation input consisting of `subspace`, `vertices` and `cone` in normaliz?


```
# Calling PyNormaliz.NmzCone(**{'subspace': [], 'vertices': [This is the Trac macro *1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1-macro), 'cone': []})
# ----8<---- Equivalent Normaliz input file ----8<----
amb_space 0
subspace 0
vertices 1
 1
cone 0
# ----8<-------------------8<-------------------8<----
```


Somehow normaliz does not like the above, which is the format that sage currently gives to normaliz to create the `.zero()` element of the parent.


---

Comment by Winfried created at 2018-07-30 09:40:12

I have run Normaliz (present master branch on GitHub) on this input. No problem in the output:



```
1 lattice points in polytope (module generators)
0 Hilbert basis elements of recession monoid
1 vertices of polyhedron
0 extreme rays of recession cone
1 support hyperplanes of polyhedron (homogenized)

embedding dimension = 1
affine dimension of the polyhedron = 0 (maximal)
rank of recession monoid = 0 (polyhedron is polytope)
internal index = 1

dehomogenization:
1 


module rank = 1

***********************************************************************

1 lattice points in polytope (module generators):
 1

0 Hilbert basis elements of recession monoid:

1 vertices of polyhedron:
 1

0 extreme rays of recession cone:

1 support hyperplanes of polyhedron (homogenized):
 1

```


I think this is correct.The vector [1] is the origin in the 0-dim affine space after homogenization.


---

Comment by jipilab created at 2018-07-30 09:51:37

Ok, I do not have the latest "normaliz" on my computer... 

I do not know exactly how to make sage use a different normaliz than the one installed _within_ sage when doing the usual `sage -i normaliz`.

Anyhow, if it is possible to get the empty polyhedron and the 0-dim polytope in the latest version of normaliz. Then these problems should be fixed. Would it be reasonable to have a tiny release of normaliz soon and we could update this branch?


---

Comment by Winfried created at 2018-07-30 10:48:56

I think the treatment of degenerate situations is o.k. now in normaliz. These minutes I am testing them on Qnormaliz. Once it is o.k., I will malke release 3.6.2.


---

Comment by jipilab created at 2018-07-30 11:36:50

Replying to [comment:43 Winfried]:
> I think the treatment of degenerate situations is o.k. now in normaliz. These minutes I am testing them on Qnormaliz. Once it is o.k., I will malke release 3.6.2.

Great! Thanks a lot!


---

Comment by Winfried created at 2018-07-30 16:05:10

Normaliz 3.6.2 released


---

Comment by git created at 2018-08-30 21:44:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-15 06:31:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-15 06:34:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-15 23:40:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-09-15 23:48:53

What is the status of this? Is it suppose to be in needs review? Is the empty polyhedron handled correctly now?


---

Comment by mkoeppe created at 2018-09-16 00:48:58

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2018-09-16 00:48:58

Empty polyhedron is fixed. Needs review.


---

Comment by tscrim created at 2018-09-16 01:02:44

LGTM overall, but a few methods are missing doctests:

- `_init_from_normaliz_data`
- `_make_normaliz_cone`

Also, `INPUT:` items generally do not end with a period.


---

Comment by git created at 2018-09-16 01:07:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-16 01:19:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-16 01:33:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2018-09-16 01:34:08

Ready for review


---

Comment by tscrim created at 2018-09-16 01:45:06

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-09-16 01:45:06

Thank you. LGTM.


---

Comment by mkoeppe created at 2018-09-16 01:45:55

Thanks for reviewing!


---

Comment by vbraun created at 2018-09-16 13:45:26


```
sage -t --long src/sage/geometry/polyhedron/backend_normaliz.py
**********************************************************************
File "src/sage/geometry/polyhedron/backend_normaliz.py", line 451, in sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz._get_nmzcone_data
Failed example:
    P._get_nmzcone_data()
Exception raised:
    Traceback (most recent call last):
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 659, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1070, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz._get_nmzcone_data[1]>", line 1, in <module>
        P._get_nmzcone_data()
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/geometry/polyhedron/backend_normaliz.py", line 464, in _get_nmzcone_data
        import PyNormaliz
    ImportError: No module named PyNormaliz
**********************************************************************
File "src/sage/geometry/polyhedron/backend_normaliz.py", line 456, in sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz._get_nmzcone_data
Failed example:
    C = Polyhedron(backend='normaliz',rays=[[1,2],[2,1]])
Exception raised:
    Traceback (most recent call last):
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 659, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1070, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz._get_nmzcone_data[2]>", line 1, in <module>
        C = Polyhedron(backend='normaliz',rays=[[Integer(1),Integer(2)],[Integer(2),Integer(1)]])
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/geometry/polyhedron/constructor.py", line 600, in Polyhedron
        return parent(Vrep, Hrep, convert=convert, verbose=verbose)
      File "sage/structure/parent.pyx", line 923, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9706)
        return mor._call_with_args(x, args, kwds)
      File "sage/structure/coerce_maps.pyx", line 164, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (build/cythonized/sage/structure/coerce_maps.c:5112)
        raise
      File "sage/structure/coerce_maps.pyx", line 159, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_with_args (build/cythonized/sage/structure/coerce_maps.c:5000)
        return C._element_constructor(x, *args, **kwds)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/geometry/polyhedron/parent.py", line 517, in _element_constructor_
        return self.element_class(self, Vrep, Hrep, **kwds)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/geometry/polyhedron/backend_normaliz.py", line 156, in __init__
        Polyhedron_base.__init__(self, parent, Vrep, Hrep, **kwds)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/geometry/polyhedron/base.py", line 124, in __init__
        self._init_from_Vrepresentation(vertices, rays, lines, **kwds)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/geometry/polyhedron/backend_normaliz.py", line 263, in _init_from_Vrepresentation
        self._init_from_normaliz_data(data, verbose=verbose)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/geometry/polyhedron/backend_normaliz.py", line 192, in _init_from_normaliz_data
        import PyNormaliz
    ImportError: No module named PyNormaliz
**********************************************************************
File "src/sage/geometry/polyhedron/backend_normaliz.py", line 457, in sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz._get_nmzcone_data
Failed example:
    C._get_nmzcone_data()
Exception raised:
    Traceback (most recent call last):
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 659, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1070, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz._get_nmzcone_data[3]>", line 1, in <module>
        C._get_nmzcone_data()
    NameError: name 'C' is not defined
**********************************************************************
1 item had failures:
   3 of   5 in sage.geometry.polyhedron.backend_normaliz.Polyhedron_normaliz._get_nmzcone_data
    [12 tests, 3 failures, 0.14 s]
----------------------------------------------------------------------
sage -t --long src/sage/geometry/polyhedron/backend_normaliz.py  # 3 doctests failed
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2018-09-16 13:45:26

Changing status from positive_review to needs_work.


---

Comment by git created at 2018-09-16 16:31:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2018-09-16 16:32:33

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2018-09-16 22:32:49

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-09-16 22:32:49

Whoops, forgot to test on a machine that did not have (py)normaliz installed. Sorry Volker.


---

Comment by vbraun created at 2018-09-19 08:09:24

Resolution: fixed
