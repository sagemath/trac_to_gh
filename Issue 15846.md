# Issue 15846: MCQD to compute max cliques

Issue created by migration from https://trac.sagemath.org/ticket/16083

Original creator: ncohen

Original creation time: 2014-04-07 14:15:57

CC:  azi

Jernej reported that this solver was faster than cliquer on some instances.

So we need it `:-P`

Nathann


---

Attachment

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-04-07 14:35:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by azi created at 2014-04-13 10:17:53

Hello,

how do I install the mcqd package? The attached tar.bz2 for one appears to be corrupt..


```
azi@bodysnatcher:/tmp$ mv mcqd-1.0.tar.bz2.1 mcqd-1.0.tar.bz2
azi@bodysnatcher:/tmp$ tar -xf mcqd-1.0.tar.bz2 
bzip2: (stdin) is not a bzip2 file.
```



---

Comment by ncohen created at 2014-04-22 13:46:36

The file looks good to me ...


```
/tmp$ tar -xf mcqd-1.0.tar.bz2 
/tmp$ 
```


Nathann


---

Comment by ncohen created at 2014-05-06 13:24:52

Changing status from new to needs_review.


---

Comment by ncohen created at 2014-05-06 13:24:52

God. I had forgotten to set it to `needs_review`.. That's dangerous `O_O;;;;`


---

Comment by azi created at 2014-05-25 17:05:59

Nathann,

as promised here are my comments !

1. I was not able to test the code since I cannot figure out how to install the module. What am I supposed to do with the tar.bz2?

2. Following are some comments about the code/politics:

   2.1. The program mcqd consists of a single .h file. Since the author of the code agrees that we can use the program in Sage, is there any reason not to simply put this .h file along with the .pyx module? This way we can also tweak the file a bit (I'd like to remove debug stuff and unnecessary verbosity counters that are present in the code)

   2.2 (mcqd.pyx) The variable c0 is a pointer to c. Hence I am wondering, why do you need to allocate memory ? On line 39 you assign the ptr c to it and lose the reference to the allocated space.  

   2.3  (mcqd.pyx) Lines 30-37. Can they be made shorter by using the fact (is it true ????) that sage_free(NULL) is legal?

   2.4 (mcqd.pyx) Can we get rid of the memset by using sage_calloc on c?

   2.5 (mcqd.pyx) At the very end C should be deleted.


---

Comment by ncohen created at 2014-05-26 11:41:28

Yoooooooooooo !

> 1. I was not able to test the code since I cannot figure out how to install the module. What am I supposed to do with the tar.bz2?

Save it in SAGE_ROOT/upstream/ and run "sage -f mcqd" (on the right branch)

>    2.1. The program mcqd consists of a single .h file. Since the author of the code agrees that we can use the program in Sage, is there any reason not to simply put this .h file along with the .pyx module? 

Yes : the code has not been reviewed. And it "may" be updated, which is why we try not to change third-party code.

>    2.2 (mcqd.pyx) The variable c0 is a pointer to c.

?... No, it is not `O_o`

c0 is a pointer to `n*n` booleans.

>    2.3  (mcqd.pyx) Lines 30-37. Can they be made shorter by using the fact (is it true ????) that sage_free(NULL) is legal?

Right. Done

>    2.4 (mcqd.pyx) Can we get rid of the memset by using sage_calloc on c?

Done.

>    2.5 (mcqd.pyx) At the very end C should be deleted.

Why ? This is done automatically, isn't it ? You don't have to dealloc objects when nothing else points toward them.

Nathann


---

Comment by git created at 2014-05-26 11:41:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by azi created at 2014-05-26 13:57:00

Replying to [comment:8 ncohen]:
> Yoooooooooooo !
> 
> > 1. I was not able to test the code since I cannot figure out how to install the module. What am I supposed to do with the tar.bz2?
> 
> Save it in SAGE_ROOT/upstream/ and run "sage -f mcqd" (on the right branch)
Thanks I'll check that out and report back!
> 
> >    2.1. The program mcqd consists of a single .h file. Since the author of the code agrees that we can use the program in Sage, is there any reason not to simply put this .h file along with the .pyx module? 
> 
> Yes : the code has not been reviewed. And it "may" be updated, which is why we try not to change third-party code.
> 
> >    2.2 (mcqd.pyx) The variable c0 is a pointer to c.
> 
> ?... No, it is not `O_o`
Nevermind about that I was talking nonsense.
> 
> c0 is a pointer to `n*n` booleans.
> 
> >    2.3  (mcqd.pyx) Lines 30-37. Can they be made shorter by using the fact (is it true ????) that sage_free(NULL) is legal?
> 
> Right. Done
> 
> >    2.4 (mcqd.pyx) Can we get rid of the memset by using sage_calloc on c?
> 
> Done.
> 
> >    2.5 (mcqd.pyx) At the very end C should be deleted.
> 
> Why ? This is done automatically, isn't it ? You don't have to dealloc objects when nothing else points toward them.
No I am not sure this is done. In C++ there is no garbage collector so whatever you allocate with new you have to dealocate with delete()
> 
> Nathann


---

Comment by git created at 2014-05-26 14:29:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by azi created at 2014-05-26 14:34:29

BTW, are you sure del is good? Shouldn't you use C++'s delete?


---

Comment by ncohen created at 2014-05-26 14:35:45

> BTW, are you sure del is good? Shouldn't you use C++'s delete?

http://docs.cython.org/src/userguide/wrapping_CPlusPlus.html
C++ objects can now be dynamically allocated with new and del keywords.

Nathann


---

Comment by azi created at 2014-05-26 20:45:32

I am still not able to run the code :-(


```
azi@bodysnatcher:~/sage$ sage -f mcqd
Found local metadata for mcqd-1.0
Found local sources at /home/azi/sage/upstream/mcqd-1.0.tar.bz2
.......blahblah............
Finished installing mcqd-1.0.spkg
```

and then


```
azi@bodysnatcher:~/sage$ sage
.........blahblah............
Done updating paths.
sage: G = graphs.PetersenGraph()
sage: G.clique_number(algorithm='mcqd')
---------------------------------------------------------------------------
ImportError                               Traceback (most recent call last)
<ipython-input-2-99d3195b7504> in <module>()
----> 1 G.clique_number(algorithm='mcqd')


ImportError: Please install the mcqd package

```


The new code looks good except for a minor question:

Why you use  double variables for the adjacency matrix? Is there any benefit from allocating a n*n matrix and using a nested for loop to fill it?


---

Comment by azi created at 2014-05-26 20:52:35

Okay, so I was missing the step of running sage -b. Thanks Nathann for the private email.

As for this ticket I'd just like to hear the answer to 

_Why you use double variables for the adjacency matrix? Is there any benefit from allocating a n*n matrix and using a nested for loop to fill it?_ 

(as posted above) and if sage -t works for you then we are good to go!!


---

Comment by ncohen created at 2014-05-27 09:11:50

Yo !

> As for this ticket I'd just like to hear the answer to 
> 
> _Why you use double variables for the adjacency matrix? Is there any benefit from allocating a n*n matrix and using a nested for loop to fill it?_ 

What do you mean by "double variables" ? Do you mean that I allocate both "c" (linear size) and "c0" (quadratic size) ?

If so, that is because what MCQD expects is the vector `c`, which  points toward the entries of `c0`.

Nathann


---

Comment by azi created at 2014-05-27 09:15:27

Yes, I am quite confused by that. Following is how I used to (successfully) call mcqd from a *.pyx file, but I don't seem to be using the same convention as you say. I hope I am not bothering you with this  I'd just like to understand what I was doing here and what you're doing in your code :)))


```
def clique_number_fast(G):
    n = G.order()

    cpdef bool **adj
    cpdef int clorder
    cpdef int *clverts

    adj= <bool **> malloc(sizeof(bool *)*n)
    for i in xrange(n):
        adj[i] = <bool *> calloc(n, sizeof(bool))    
    
    # Warning we are assuming the vertices are labeled from 0...n-1
    for i,j in G.edges(labels=False):
        adj[i][j] = True
        adj[j][i] = True

    cpdef Maxclique *m = new_Maxclique(adj,n,0.025)
    m.mcqdyn(clverts, clorder); 
    # Yes, I am supposed to free the entire array but the above is just an indication of what is causing the error
    for i in xrange(n): free(adj[i])
    
    free(adj)

    return clorder
```



---

Comment by ncohen created at 2014-05-27 09:19:07

Hello !

> Yes, I am quite confused by that. Following is how I used to (successfully) call mcqd from a *.pyx file, but I don't seem to be using the same convention as you say. I hope I am not bothering you with this  I'd just like to understand what I was doing here and what you're doing in your code :)))

I do exactly what you did. The only difference is that I  only do ONE memory allocation while you allocate n vectors (all your `adj[i]`). Now, you should write a check that all vectors have been correctly allocated, and if not deallocate them all, and this is what I wanted to avoid by allocating just one big vector of size n*n and making adj point toward pieces of it.

Nathann


---

Comment by ncohen created at 2014-05-27 09:20:24

> I hope I am not bothering you with this  I'd just like to understand what I was doing here and what you're doing in your code :)))

This is precisely the reviewer's job `:-P`

Nathann


---

Comment by azi created at 2014-05-27 09:27:18

Oh I see it now. OK. 

Then as far as I am concerned the code is good to go once you confirm that sage -t passes through for you!


---

Comment by ncohen created at 2014-05-27 09:29:25

Well, it does in the graph/ folder, and clearly no  other code calls that.

Nathann


---

Comment by azi created at 2014-05-27 09:32:21

Changing status from needs_review to positive_review.


---

Comment by ncohen created at 2014-05-27 09:33:26

Thaaaaaaaaaaaaanks! `:-)`


---

Comment by azi created at 2014-05-27 09:35:19

Actually, thank you for doing all this patches and stuff !!!!!!


---

Comment by ncohen created at 2014-05-27 09:40:35

> Actually, thank you for doing all this patches and stuff !!!!!!

`:-D`

Nathann


---

Comment by vbraun created at 2014-05-29 12:41:51

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2014-05-29 12:41:51


```
sage -t --long src/sage/graphs/mcqd.pyx
**********************************************************************
File "src/sage/graphs/mcqd.pyx", line 15, in sage.graphs.mcqd.mcqd
Failed example:
    from sage.graphs.mcqd import mcqd
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.graphs.mcqd.mcqd[0]>", line 1, in <module>
        from sage.graphs.mcqd import mcqd
    ImportError: No module named mcqd
**********************************************************************
```



---

Comment by git created at 2014-05-29 16:51:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2014-05-29 16:52:16

Sorry.. All the lines except the import statement were tagged with "optional" `:-/`

Nathann


---

Comment by ncohen created at 2014-05-29 16:52:16

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2014-05-30 11:35:44

Resolution: fixed
