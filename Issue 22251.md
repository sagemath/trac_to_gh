# Issue 22251: Make Three.js work offline in notebooks

Issue created by migration from Trac.

Original creator: paulmasson

Original creation time: 2017-03-02 01:38:46

CC:  novoselt egourgoulhon kcrisman tmonteil




---

Comment by paulmasson created at 2017-03-02 23:27:32

Changing status from new to needs_review.


---

Comment by paulmasson created at 2017-03-02 23:27:32

New commits:


---

Comment by paulmasson created at 2017-03-02 23:28:34

Since I'm unsure as to when a new version of the legacy notebook will be available, the ticket could be restricted to getting the viewer working in Jupyter notebooks.


---

Comment by egourgoulhon created at 2017-03-03 07:02:06

Changing priority from major to blocker.


---

Comment by egourgoulhon created at 2017-03-03 12:47:37

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2017-03-03 12:47:37

Replying to [comment:3 paulmasson]:
> Since I'm unsure as to when a new version of the legacy notebook will be available, the ticket could be restricted to getting the viewer working in Jupyter notebooks.

I agree.

Thanks for this ticket; I've tested it in console mode and in Jupyter notebooks, both with and without internet connection. Everything seems OK.


---

Comment by egourgoulhon created at 2017-03-03 17:05:18

Changing status from positive_review to needs_info.


---

Comment by egourgoulhon created at 2017-03-03 17:05:18

I've just noticed some regression with respect to Sage 7.5.1: with the latter, the three.js output could be rendered by http://nbviewer.jupyter.org from a notebook publicly available (for instance stored on GitHub), which is pretty cool! Here is [an example](http://nbviewer.jupyter.org/github/egourgoulhon/SageMathTest/blob/master/Worksheets/sphere_threejs_7.5.1.ipynb). This does no longer work for a notebook produced with the current branch: see the same sphere example [here](http://nbviewer.jupyter.org/github/egourgoulhon/SageMathTest/blob/master/Worksheets/sphere_threejs_7.6.beta5-22488.ipynb). Can this be corrected in the current ticket?


---

Comment by paulmasson created at 2017-03-03 21:06:08

The Three.js backend creates a standalone HTML file that requires `<script>` tags linking to the JavaScript files. The changes in #22389 default this to the local standard package, since that was requested by a couple reviewers. The current ticket changes the `<script>` tags to link to the local standard package via Jupyter's `/nbextensions` directory, which you can see by inspecting the generated output in your brower's console.

If the user knows ahead of time that the generated HTML will be viewed online, where this is no access to the local standard package, there is now a keyword option `online=true` that alters the `<script>` tags to use a publicly available content delivery network (CDN). If you know you will publish a notebook, you can add that keyword to a dictionary of options for all 3D plots.

If the notebook publishing site has an equivalent to `/nbextensions`, then you could alternately copy the two JavaScript files to a directory `/threejs` under it and things would work, but you probably aren't given access like that to their server.

A third option (but a bit messier) is to add two sets of `<script>` tags to the generated HTML. Then the page would fall back on the CDN when the local standard package is unavailable. That would make your notebook publishing process work transparently, but would quietly add a possible "leak" to the Internet that another reviewer wanted me to avoid. Is it worth doing this rather than use the `online=true` keyword?

I can go either way on this, and in fact I really prefer just using the CDN all the time. Input from others would be appreciated.


---

Comment by egourgoulhon created at 2017-03-03 21:54:24

Replying to [comment:7 paulmasson]:
> 
> If the user knows ahead of time that the generated HTML will be viewed online, where this is no access to the local standard package, there is now a keyword option `online=true` that alters the `<script>` tags to use a publicly available content delivery network (CDN). If you know you will publish a notebook, you can add that keyword to a dictionary of options for all 3D plots.

I did not realize this, thanks! [It works!](http://nbviewer.jupyter.org/github/egourgoulhon/SageMathTest/blob/master/Worksheets/sphere_threejs_7.6.beta5-22488-online.ipynb)
> 
> If the notebook publishing site has an equivalent to `/nbextensions`, then you could alternately copy the two JavaScript files to a directory `/threejs` under it and things would work, but you probably aren't given access like that to their server.

Indeed...

> 
> A third option (but a bit messier) is to add two sets of `<script>` tags to the generated HTML. Then the page would fall back on the CDN when the local standard package is unavailable. That would make your notebook publishing process work transparently, but would quietly add a possible "leak" to the Internet that another reviewer wanted me to avoid. Is it worth doing this rather than use the `online=true` keyword?

I would vote for this one, since it sounds awkward to create multiple versions of a notebook or to have to know in advance that you will publish it at some point...
Even if you know that and have added `online=True` everywhere, this becomes very annoying if you work on the notebook and for some reason you don't have any internet connection.


---

Comment by paulmasson created at 2017-03-03 22:18:39

Replying to [comment:9 egourgoulhon]:
> Replying to [comment:7 paulmasson]:
> > A third option (but a bit messier) is to add two sets of `<script>` tags to the generated HTML. Then the page would fall back on the CDN when the local standard package is unavailable. That would make your notebook publishing process work transparently, but would quietly add a possible "leak" to the Internet that another reviewer wanted me to avoid. Is it worth doing this rather than use the `online=true` keyword?
> 
> I would vote for this one, since it sounds awkward to create multiple versions of a notebook or to have to know in advance that you will publish it at some point...
> Even if you know that and have added `online=True` everywhere, this becomes very annoying if you work on the notebook and for some reason you don't have any internet connection. 
Then the question arises as to whether to do this in all cases or just for the Jupyter notebooks. That is:

1) Remove the `online` keyword and always provide two sets of tags in all generated content. For command-line users this would potentially expose some local file system information without their knowledge, but would make the HTML files immediately portable.

2) Keep the `online` keyword to allow command-line users to explicitly generate public online files without any local computer information embedded, but have the two-set fallback for Jupyter notebook users. The `/nbextensions` link is generic and reveals nothing about the local computer.

I favor the latter. And for future reference, can Sage legacy notebooks be published in the same way or do they always stay on the local server?


---

Comment by egourgoulhon created at 2017-03-04 13:24:20

Replying to [comment:10 paulmasson]:
> Then the question arises as to whether to do this in all cases or just for the Jupyter notebooks. That is:
> 
> 1) Remove the `online` keyword and always provide two sets of tags in all generated content. For command-line users this would potentially expose some local file system information without their knowledge, but would make the HTML files immediately portable.
> 
> 2) Keep the `online` keyword to allow command-line users to explicitly generate public online files without any local computer information embedded, but have the two-set fallback for Jupyter notebook users. The `/nbextensions` link is generic and reveals nothing about the local computer.
> 
> I favor the latter.

Yes, this seems a good idea.

> And for future reference, can Sage legacy notebooks be published in the same way or do they always stay on the local server?

Since Jupyter will be the default notebook soon (Sage 8.0, immediately after Sage 7.6), with a converter from legacy notebooks, I don't see the point in publishing legacy notebooks. But probably, this should be discussed in another ticket.


---

Comment by git created at 2017-03-06 22:23:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by paulmasson created at 2017-03-06 22:25:27

This should take care of the outstanding issue. Please try publishing a notebook without the `online` keyword.

I've also added a few double quotes, to prevent a possible future error and to make things read consistently.


---

Comment by paulmasson created at 2017-03-06 22:25:27

Changing status from needs_info to needs_review.


---

Comment by egourgoulhon created at 2017-03-06 23:16:13

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2017-03-06 23:16:13

Replying to [comment:13 paulmasson]:
> This should take care of the outstanding issue. 

Thanks!
>Please try publishing a notebook without the `online` keyword.

[It works!](http://nbviewer.jupyter.org/github/egourgoulhon/SageMathTest/blob/master/Worksheets/sphere_threejs_7.6.beta6-22488-2.ipynb)

> I've also added a few double quotes, to prevent a possible future error and to make things read consistently.

Very good.

I've performed a few other checks (online/offline in console/Jupyter notebook); everything seems OK. Thank you!


---

Comment by vbraun created at 2017-03-08 18:46:01

Resolution: fixed


---

Comment by novoselt created at 2017-03-19 17:20:21

Sorry for not looking at this closer when it was still for review.

I very much dislike the logic for generating different files relying on instance check of the backend. These backend-specific things should be written in the backend files and pulled via the same methods here. So I would very much like to get rid of this line

```
backend = get_display_manager()._backend
```

together with dependent ones and instead have something like

```
scripts = get_display_manager().threejs_scripts(options['online'])
```

with default behaviour of serving CDN links for `True` and failing for `False` but letting individual backends override `False` however they wish. In particular it will allow me to has [SageMathCell](SageMathCell) backend do what is needed without making tweaks to Sage itself. Thoughts?


---

Comment by novoselt created at 2017-03-19 17:22:39

No clue why commit got deleted...


---

Comment by egourgoulhon created at 2017-03-21 11:07:15

Replying to [comment:17 novoselt]:
> No clue why commit got deleted...
I think this is harmless; it seems to occur anytime a comment is added to a closed ticket.


---

Comment by paulmasson created at 2017-03-21 23:52:31

Replying to [comment:16 novoselt]:
> Sorry for not looking at this closer when it was still for review.
> 
> I very much dislike the logic for generating different files relying on instance check of the backend. These backend-specific things should be written in the backend files and pulled via the same methods here. So I would very much like to get rid of this line
> {{{
> backend = get_display_manager()._backend
> }}}
> together with dependent ones and instead have something like
> {{{
> scripts = get_display_manager().threejs_scripts(options['online'])
> }}}
> with default behaviour of serving CDN links for `True` and failing for `False` but letting individual backends override `False` however they wish. In particular it will allow me to has [SageMathCell](SageMathCell) backend do what is needed without making tweaks to Sage itself. Thoughts?
Point well taken. Discussion moved to #22670.


---

Comment by enriqueartal created at 2017-09-24 19:19:06

After these changes threejs does not work any more with jupyterhub. I tried some workarounds whitout success. It is probably difficult to have a solution for both offline jupyter notebook and jupyterhub, but a hint would help. Thanks.


---

Comment by paulmasson created at 2017-09-25 20:31:17

The behavior for Jupyter notebooks includes a fallback to an online CDN when the offline JavaScript files are unavailable. This was tested in Comment 14 above.

Does Jupyterhub block access to the Internet? Are you deliberately blocking Internet access?


---

Comment by enriqueartal created at 2017-09-26 07:25:32

Replying to [comment:21 paulmasson]:
> The behavior for Jupyter notebooks includes a fallback to an online CDN when the offline JavaScript files are unavailable. This was tested in Comment 14 above.
> 
> Does Jupyterhub block access to the Internet? Are you deliberately blocking Internet access?

No, Jupyterhub is not blocking internet access (it is done in order to offer internet access to jupyter notebook); the problem is that it looks for the scripts in "https://ip_address:port/nbextensions/threejs/three.min.js" and it fails to find them (no problem if jupyter is launched locally). I found a workaround redefining the function threejs_offline_scripts (which appears twice in backend_ipython.py) asking jupyter to look for the scripts in rawgit. Maybe a global solution should not be done here but in jupyterhub.
