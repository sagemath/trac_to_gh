# Issue 31025: Implement non zero chunks for sparse bitsets

Issue created by migration from https://trac.sagemath.org/ticket/31262

Original creator: @kliem

Original creation time: 2021-01-18 23:27:27

CC:  stumpc5 tscrim

Keywords: combinatorial polyhedron, sparse bitsets

For very large and challenging computations, most of the elements of the face lattice contain rather few atoms/bits. With little changes to the code, we can just collect the non zero chunks (64,128 or 256 bits).

RoaringBitmap performs better (starting with maybe 100,000 bits, but not with less, as container contain 64k bits), but that would add an extra dependency and make things more complicated.

To avoid code duplications, we also gather some functions in `bitset_intrinsics.h` that work just the same (e.g. intersection and union).
(This actually accounts for most changes by this ticket.)

Before (on #27103):


```
sage: P = polytopes.Birkhoff_polytope(5)                                                                                                                                                                                                                                                                                                                                   
sage: C = CombinatorialPolyhedron(P)                                                                                                                                                                                                                                                                                                                                       
sage: %time _ = C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 468 ms, sys: 0 ns, total: 468 ms
Wall time: 467 ms

sage: P = polytopes.Birkhoff_polytope(5)                                                                                                                                                                                                                                                                                                                                   
sage: C = CombinatorialPolyhedron(P)                                                                                                                                                                                                                                                                                                                                       
sage: %time _ = C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 440 ms, sys: 0 ns, total: 440 ms
Wall time: 439 ms

sage: P = polytopes.hypercube(14)                                                                                                                                                                                                                                                                                                                                          
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time _ = C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 5.13 s, sys: 4.03 ms, total: 5.14 s
Wall time: 5.13 s
sage: P = polytopes.hypercube(15)                                                                                                                                                                                                                                                                                                                                          
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time _ = C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 30 s, sys: 32 ms, total: 30 s
Wall time: 30 s

sage: P = polytopes.permutahedron(6)                                                                                                                                                                                                                                                                                                                                       
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time _ = C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 1.68 ms, sys: 6 µs, total: 1.68 ms
Wall time: 1.69 ms
sage: P = polytopes.permutahedron(7)                                                                                                                                                                                                                                                                                                                                       
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time _ = C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 89.1 ms, sys: 4 µs, total: 89.1 ms
Wall time: 88.9 ms

sage: P = polytopes.permutahedron(8, backend='normaliz')                                                                                                                                                                                                                                                                                                                   
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time _ = C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 14.2 s, sys: 8 ms, total: 14.2 s
Wall time: 14.2 s

sage: P = polytopes.associahedron(['A', 11], backend='normaliz')                                                                                                                                                                                                                                                                                                           
sage: C = CombinatorialPolyhedron(P)                                                                                                                                                                                                                                                                                                                                       
sage: %time _ = C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 24.3 s, sys: 8.01 ms, total: 24.3 s
Wall time: 24.3 s
```


After:


```
# Slight slowdown for few atoms.
sage: P = polytopes.Birkhoff_polytope(5)                                                                                                                                                                                                                                                                                                                                   
sage: C = CombinatorialPolyhedron(P)                                                                                                                                                                                                                                                                                                                                       
sage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 475 ms, sys: 0 ns, total: 475 ms
Wall time: 474 ms
(1, 120, 5040, 50250, 233400, 631700, 1113700, 1367040, 1220550, 817150, 419225, 167200, 52120, 12600, 2300, 300, 25, 1)

sage: P = polytopes.hypercube(14)                                                                                                                                                                                                                                                                                                                                          
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 1.71 s, sys: 0 ns, total: 1.71 s
Wall time: 1.71 s
(1, 16385, 131069, 487383, 1117948, 1769482, 2047331, 1788501, 1200342, 622908, 248963, 75361, 16640, 2470, 197, 1)
sage: P = polytopes.hypercube(15)                                                                                                                                                                                                                                                                                                                                          
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 7.54 s, sys: 4 ms, total: 7.54 s
Wall time: 7.54 s
(1, 32769, 278525, 1105876, 2723539, 4657926, 5866861, 5629624, 4196907, 2454738, 1128127, 404404, 110929, 22386, 3059, 226, 1)

sage: P = polytopes.permutahedron(6)                                                                                                                                                                                                                                                                                                                                       
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 1.45 ms, sys: 0 ns, total: 1.45 ms
Wall time: 1.55 ms
(1, 721, 1987, 1956, 808, 120, 1)
sage: P = polytopes.permutahedron(7)                                                                                                                                                                                                                                                                                                                                       
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 20.8 ms, sys: 27 µs, total: 20.8 ms
Wall time: 20.7 ms
(1, 5041, 16251, 19761, 11144, 2860, 267, 1)
sage: P = polytopes.permutahedron(8, backend='normaliz')                                                                                                                                                                                                                                                                                                                   
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 665 ms, sys: 4 µs, total: 665 ms
Wall time: 664 ms
(1, 40321, 148899, 215690, 154215, 56022, 9489, 572, 1)

# No change for simplicial/simple polytopes.
sage: P = polytopes.associahedron(['A', 11], backend='normaliz')                                                                                                                                                                                                                                                                                                           
sage: C = CombinatorialPolyhedron(P)                                                                                                                                                                                                                                                                                                                                       
sage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 24.3 s, sys: 16.3 ms, total: 24.3 s
Wall time: 24.3 s
(1, 208012, 1144066, 2735810, 3730650, 3197700, 1790712, 659736, 157080, 23100, 1925, 77, 1)
```


This is the last subsequent improvement in comparison to sage 8.9 mentioned in https://arxiv.org/abs/1905.01945.

Follow ups:
- Move things from `geometry/polyhedron/combinatorial_polyhedron` to a more general location.
- Some renamings for lattices in general `face` -> `element`.
- Expose to simplical complexes.
- Expose to lattice of flats of matroids.


---

Comment by @kliem created at 2021-01-18 23:27:36

Changing status from new to needs_review.


---

Comment by @kliem created at 2021-01-19 06:58:54

Changing status from needs_review to needs_work.


---

Comment by @kliem created at 2021-01-19 06:58:54

Failing doctests.


---

Comment by git created at 2021-01-19 11:31:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-01-19 11:31:19

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2021-01-19 12:14:41

Possibly it might make sense to factor this ticket in two:

- One that removes duplicates in `bitset_intrinsics.h`.
- One that actually adds the slight modifications for sparse bitsets.


---

Comment by git created at 2021-01-19 15:09:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-19 15:43:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-01-19 15:45:06

Cleaner code makes things a bit faster, I suppose.


---

Comment by git created at 2021-01-19 18:49:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-01-19 19:30:46

All doctests pass on my side. With the current setup:

- AVX2, AVX, SSE4.1
- AVX, SSE4.1 (only `geometry/polyhedron` and `data_structure/` tested)
- SSE4.1
- no intrinsics.


---

Comment by tscrim created at 2021-01-20 06:12:08

LGTM.


---

Comment by tscrim created at 2021-01-20 06:12:08

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2021-01-20 09:46:21

Thank you.


---

Comment by vbraun created at 2021-01-31 20:53:15

Resolution: fixed
