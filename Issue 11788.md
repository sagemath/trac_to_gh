# Issue 11788: bug in matrix of frobenius when p = 3

archive/issues_011788.json:
```json
{
    "body": "Assignee: @williamstein\n\nThe code for computing the matrix of frobenius when p = 3 does not seem to be implemented:\n\n```\nsage: E = EllipticCurve('83a1')\nsage: EW = E.short_weierstrass_model()\nsage: EW.is_ordinary(3)\nTrue\nsage: EW.matrix_of_frobenius(3)\n---------------------------------------------------------------------------\nNotImplementedError                       Traceback (most recent call last)\n\n/home/jen/<ipython console> in <module>()\n\n/home/jen/sage/sage-4.7.1/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/padics.pyc\nin matrix_of_frobenius(self, p, prec, check, check_hypotheses,\nalgorithm)\n  1521     # todo: implement the p == 3 case\n  1522     if p < 5:\n-> 1523         raise NotImplementedError, \"p (=%s) must be at least 5\" % p\n  1524\n  1525     prec = int(prec)\n\nNotImplementedError: p (=3) must be at least 5\n```\n\nHowever, telling Sage that you're dealing with a hyperelliptic curve calls other code, which seems to run into problems when p = 3:\n\n```\nsage: EW\nElliptic Curve defined by y^2 = x^3 + 1269*x - 10746 over Rational Field\nsage: R.<x> = QQ['x']\nsage: C= HyperellipticCurve(x^3 + 1269*x - 10746)\nsage: C.matrix_of_frobenius(3)\n[                                                      3^-109 +\n2*3^-104 + 3^-102 + 2*3^-101 + 2*3^-100 + 3^-99 + 3^-97 + 3^-92 +\nO(3^-89) 2*3^-101 + 3^-99 + 2*3^-97 + 3^-96 + 2*3^-95 + 2*3^-94 +\n3^-91 + 3^-90 + 2*3^-87 + 2*3^-86 + 2*3^-85 + 3^-84 + 3^-83 + 2*3^-82\n+ O(3^-81)]\n[      3^-110 + 2*3^-109 + 2*3^-107 + 2*3^-106 + 3^-102 + 2*3^-101 +\n3^-100 + 3^-99 + 3^-98 + 3^-97 + 3^-94 + 2*3^-93 + 2*3^-92 + O(3^-90)\n                           2*3^-102 + 3^-101 + 2*3^-96 + 3^-94 +\n2*3^-92 + 3^-91 + 2*3^-89 + 2*3^-88 + 3^-86 + 3^-84 + 3^-83 +\nO(3^-82)]\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/11960\n\n",
    "created_at": "2011-10-28T23:40:07Z",
    "labels": [
        "component: number theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "bug in matrix of frobenius when p = 3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11788",
    "user": "https://github.com/jbalakrishnan"
}
```
Assignee: @williamstein

The code for computing the matrix of frobenius when p = 3 does not seem to be implemented:

```
sage: E = EllipticCurve('83a1')
sage: EW = E.short_weierstrass_model()
sage: EW.is_ordinary(3)
True
sage: EW.matrix_of_frobenius(3)
---------------------------------------------------------------------------
NotImplementedError                       Traceback (most recent call last)

/home/jen/<ipython console> in <module>()

/home/jen/sage/sage-4.7.1/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/padics.pyc
in matrix_of_frobenius(self, p, prec, check, check_hypotheses,
algorithm)
  1521     # todo: implement the p == 3 case
  1522     if p < 5:
-> 1523         raise NotImplementedError, "p (=%s) must be at least 5" % p
  1524
  1525     prec = int(prec)

NotImplementedError: p (=3) must be at least 5
```

However, telling Sage that you're dealing with a hyperelliptic curve calls other code, which seems to run into problems when p = 3:

```
sage: EW
Elliptic Curve defined by y^2 = x^3 + 1269*x - 10746 over Rational Field
sage: R.<x> = QQ['x']
sage: C= HyperellipticCurve(x^3 + 1269*x - 10746)
sage: C.matrix_of_frobenius(3)
[                                                      3^-109 +
2*3^-104 + 3^-102 + 2*3^-101 + 2*3^-100 + 3^-99 + 3^-97 + 3^-92 +
O(3^-89) 2*3^-101 + 3^-99 + 2*3^-97 + 3^-96 + 2*3^-95 + 2*3^-94 +
3^-91 + 3^-90 + 2*3^-87 + 2*3^-86 + 2*3^-85 + 3^-84 + 3^-83 + 2*3^-82
+ O(3^-81)]
[      3^-110 + 2*3^-109 + 2*3^-107 + 2*3^-106 + 3^-102 + 2*3^-101 +
3^-100 + 3^-99 + 3^-98 + 3^-97 + 3^-94 + 2*3^-93 + 2*3^-92 + O(3^-90)
                           2*3^-102 + 3^-101 + 2*3^-96 + 3^-94 +
2*3^-92 + 3^-91 + 2*3^-89 + 2*3^-88 + 3^-86 + 3^-84 + 3^-83 +
O(3^-82)]
```

Issue created by migration from https://trac.sagemath.org/ticket/11960





---

archive/issue_comments_134440.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11788",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11788#issuecomment-134440",
    "user": "https://github.com/jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/issue_events_031661.json:
```json
{
    "actor": "https://github.com/kedlaya",
    "created_at": "2016-03-21T16:37:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11788",
    "milestone": "sage-7.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11788#event-31661"
}
```



---

archive/issue_comments_134441.json:
```json
{
    "body": "I think matrix_of_frobenius is only failing because the short Weierstrass equation has bad reduction at 3. If you manually write down a Weierstrass equation of the form `y^2 = P(x)` with good reduction at 3, everything works:\n\n```\nsage: E = EllipticCurve('83a1')\nsage: E\nElliptic Curve defined by y^2 + x*y + y = x^3 + x^2 + x over Rational Field\nsage: pr.<x> = PolynomialRing(QQ)\nsage: a = x^3 + x^2 + x\nsage: b = x + 1\nsage: C = HyperellipticCurve(a + b^2/4)\nsage: C.matrix_of_frobenius(3)\n[                                2*3 + 3^5 + 2*3^6 + 3^8 + 3^11 + 2*3^12 + 2*3^13 + 2*3^14 + 2*3^15 + 3^16 + 3^18 + 3^19 + O(3^20)               2*3 + 2*3^2 + 2*3^3 + 2*3^7 + 3^8 + 2*3^9 + 2*3^10 + 2*3^11 + 2*3^13 + 3^14 + 3^15 + 2*3^16 + 3^17 + 3^19 + O(3^20)]\n[2*3 + 3^2 + 2*3^5 + 3^6 + 2*3^7 + 2*3^9 + 3^10 + 3^11 + 3^12 + 3^13 + 2*3^14 + 2*3^15 + 2*3^16 + 2*3^17 + 2*3^18 + 3^19 + O(3^20)                     2 + 2*3^2 + 2*3^3 + 2*3^4 + 3^5 + 2*3^7 + 3^8 + 2*3^9 + 2*3^10 + 3^11 + 3^16 + 2*3^17 + 3^18 + 3^19 + O(3^20)]\n```",
    "created_at": "2016-03-21T16:37:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11788",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11788#issuecomment-134441",
    "user": "https://github.com/kedlaya"
}
```

I think matrix_of_frobenius is only failing because the short Weierstrass equation has bad reduction at 3. If you manually write down a Weierstrass equation of the form `y^2 = P(x)` with good reduction at 3, everything works:

```
sage: E = EllipticCurve('83a1')
sage: E
Elliptic Curve defined by y^2 + x*y + y = x^3 + x^2 + x over Rational Field
sage: pr.<x> = PolynomialRing(QQ)
sage: a = x^3 + x^2 + x
sage: b = x + 1
sage: C = HyperellipticCurve(a + b^2/4)
sage: C.matrix_of_frobenius(3)
[                                2*3 + 3^5 + 2*3^6 + 3^8 + 3^11 + 2*3^12 + 2*3^13 + 2*3^14 + 2*3^15 + 3^16 + 3^18 + 3^19 + O(3^20)               2*3 + 2*3^2 + 2*3^3 + 2*3^7 + 3^8 + 2*3^9 + 2*3^10 + 2*3^11 + 2*3^13 + 3^14 + 3^15 + 2*3^16 + 3^17 + 3^19 + O(3^20)]
[2*3 + 3^2 + 2*3^5 + 3^6 + 2*3^7 + 2*3^9 + 3^10 + 3^11 + 3^12 + 3^13 + 2*3^14 + 2*3^15 + 2*3^16 + 2*3^17 + 2*3^18 + 3^19 + O(3^20)                     2 + 2*3^2 + 2*3^3 + 2*3^4 + 3^5 + 2*3^7 + 3^8 + 2*3^9 + 2*3^10 + 3^11 + 3^16 + 2*3^17 + 3^18 + 3^19 + O(3^20)]
```



---

archive/issue_comments_134442.json:
```json
{
    "body": "Changing keywords from \"\" to \"elliptic curves, Weierstrass form, matrix of Frobenius\".",
    "created_at": "2016-03-21T16:38:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11788",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11788#issuecomment-134442",
    "user": "https://github.com/kedlaya"
}
```

Changing keywords from "" to "elliptic curves, Weierstrass form, matrix of Frobenius".



---

archive/issue_comments_134443.json:
```json
{
    "body": "For the record, PARI also has code which does this.",
    "created_at": "2016-03-21T17:00:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11788",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11788#issuecomment-134443",
    "user": "https://github.com/jdemeyer"
}
```

For the record, PARI also has code which does this.



---

archive/issue_comments_134444.json:
```json
{
    "body": "Would it make sense to have `EllipticCurve.matrix_of_frobenius` call out to `HyperellipticCurve.matrix_of_frobenius` and then have the triage among different code options be handled there?",
    "created_at": "2016-05-05T01:09:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11788",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11788#issuecomment-134444",
    "user": "https://github.com/kedlaya"
}
```

Would it make sense to have `EllipticCurve.matrix_of_frobenius` call out to `HyperellipticCurve.matrix_of_frobenius` and then have the triage among different code options be handled there?



---

archive/issue_comments_134445.json:
```json
{
    "body": "Changing keywords from \"elliptic curves, Weierstrass form, matrix of Frobenius\" to \"elliptic curves, Weierstrass form, matrix of Frobenius, sd87\".",
    "created_at": "2017-07-17T17:39:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11788",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11788#issuecomment-134445",
    "user": "https://github.com/roed314"
}
```

Changing keywords from "elliptic curves, Weierstrass form, matrix of Frobenius" to "elliptic curves, Weierstrass form, matrix of Frobenius, sd87".



---

archive/issue_comments_134446.json:
```json
{
    "body": "Added a fix following the suggestion above to call the hyperelliptic code, passing in a Weierstrass equation that has good reduction at 3.\n\n---\nNew commits:",
    "created_at": "2017-07-18T16:43:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11788",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11788#issuecomment-134446",
    "user": "https://github.com/jbalakrishnan"
}
```

Added a fix following the suggestion above to call the hyperelliptic code, passing in a Weierstrass equation that has good reduction at 3.

---
New commits:



---

archive/issue_comments_134447.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-07-18T16:44:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11788",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11788#issuecomment-134447",
    "user": "https://github.com/jbalakrishnan"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_134448.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-07-18T19:55:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11788",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11788#issuecomment-134448",
    "user": "https://github.com/adeines"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_134449.json:
```json
{
    "body": "Looks good.",
    "created_at": "2017-07-18T19:55:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11788",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11788#issuecomment-134449",
    "user": "https://github.com/adeines"
}
```

Looks good.



---

archive/issue_comments_134450.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-07-26T22:13:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11788",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11788#issuecomment-134450",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_031662.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-07-26T22:13:45Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11788",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11788#event-31662"
}
```
