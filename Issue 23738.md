# Issue 23738: docbuild sometimes fails due to non-existing .pyc file

Issue created by migration from https://trac.sagemath.org/ticket/23975

Original creator: jdemeyer

Original creation time: 2017-10-06 08:14:45

CC:  jhpalmieri

Sometimes the following happens:

```
[dochtml] [reference] WARNING: Building reference manual, second pass.
[dochtml] Error building the documentation.
[dochtml] Traceback (most recent call last):
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/runpy.py", line 174, in _run_module_as_main
[dochtml]     "__main__", fname, loader, pkg_name)
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/runpy.py", line 72, in _run_code
[dochtml]     exec code in run_globals
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
[dochtml]     main()
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 1675, in main
[dochtml]     builder()
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 314, in _wrapper
[dochtml]     getattr(get_builder(document), name)(*args, **kwds)
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 505, in _wrapper
[dochtml]     build_many(build_ref_doc, L)
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 260, in build_many
[dochtml]     results.append(target(arg))
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 71, in build_ref_doc
[dochtml]     getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 711, in _wrapper
[dochtml]     for module_name in self.get_new_and_updated_modules():
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 914, in get_new_and_updated_modules
[dochtml]     newtime = os.path.getmtime(sys.modules[module_name].__file__)
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/genericpath.py", line 62, in getmtime
[dochtml]     return os.stat(filename).st_mtime
[dochtml] OSError: [Errno 2] No such file or directory: '/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/manifolds/manifold_homset.pyc'
```


In this case, the `.pyc` file indeed does not exist:

```
$ ls -l /usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/manifolds
total 652
-rw-r--r-- 1 jdemeyer jdemeyer    235 Sep 19 13:17 all.py
-rw-r--r-- 1 jdemeyer jdemeyer 121676 Sep 19 13:17 chart.py
-rw-r--r-- 1 jdemeyer jdemeyer  78225 Sep 19 13:17 continuous_map.py
-rw-r--r-- 1 jdemeyer jdemeyer  44475 Oct  5 12:18 coord_func.py
-rw-r--r-- 1 jdemeyer jdemeyer  54706 Oct  5 12:18 coord_func_symb.py
drwxr-xr-x 2 jdemeyer jdemeyer   4096 Oct  6 09:58 differentiable
-rw-r--r-- 1 jdemeyer jdemeyer     13 Sep 19 13:17 __init__.py
-rw-r--r-- 1 jdemeyer jdemeyer  16196 Sep 19 13:17 manifold_homset.py
-rw-r--r-- 1 jdemeyer jdemeyer  87439 Oct  5 14:25 manifold.py
-rw-r--r-- 1 jdemeyer jdemeyer  35967 Sep 19 13:17 point.py
-rw-r--r-- 1 jdemeyer jdemeyer  21002 Sep 19 13:17 scalarfield_algebra.py
-rw-r--r-- 1 jdemeyer jdemeyer  97995 Oct  5 12:18 scalarfield.py
-rw-r--r-- 1 jdemeyer jdemeyer   4533 Sep 19 13:17 structure.py
-rw-r--r-- 1 jdemeyer jdemeyer  40170 Sep 19 13:17 subset.py
-rw-r--r-- 1 jdemeyer jdemeyer  31947 Oct  5 12:18 utilities.py
```



---

Comment by jdemeyer created at 2017-10-06 09:01:00

Changing priority from major to critical.


---

Comment by jdemeyer created at 2017-10-06 09:01:00

Changing component from documentation to build.


---

Comment by jdemeyer created at 2017-10-06 09:59:46

New commits:


---

Comment by jdemeyer created at 2017-10-06 09:59:46

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2017-10-06 20:28:10

Do you have any suggestions about how to reproduce the problem, or is it just somewhat random?


---

Comment by jhpalmieri created at 2017-10-06 22:42:49

I can see that this branch is doing what it claims. I wish I knew why we deleted these in the first place. Is it perhaps some remnant of what is now `_find_stale_files` (and related) in `sage_setup.clean`?


---

Comment by jdemeyer created at 2017-10-07 07:53:30

Replying to [comment:5 jhpalmieri]:
> Do you have any suggestions about how to reproduce the problem, or is it just somewhat random?

It's not random. Typically, it happens when you are building the documentation and at the same time installing some package.

So, on terminal 1, we run

```
$ make doc
```


And on terminal 2, we run something like

```
$ make database_cremona_ellcurve   # or any other optional package
$ ./sage
```


Starting `./sage` on terminal 2 will cause `sage-location` to run, which will in turn cause the docbuild to fail in terminal 1.


---

Comment by jdemeyer created at 2017-10-07 07:59:24

Replying to [comment:6 jhpalmieri]:
> Is it perhaps some remnant of what is now `_find_stale_files` (and related) in `sage_setup.clean`?

Interestingly, in the very first version of `sage-location` (commit c7e6c5d1c1db3b8562c07e83ff6c36bbb7d36c24), removing the `.pyc` and `.pyo` files was the only thing that `sage-location` did. This is the main function from that 11-year old version:

```python
def update_hardcoded_files(path):
    # The only known files with hard coded paths.
    if os.path.isdir(path):
        for X in os.listdir(path):
            update_hardcoded_files('%s/%s'%(path,X))
    else:
        P = path[-4:]
        if P == '.pyo' or P == '.pyc':
            try:
                os.unlink(path)
            except OSError, msg:
                print msg
```

So I guess they must be deleted because there are hardcoded paths in those files. If so, that is clearly no longer relevant.


---

Comment by jdemeyer created at 2017-10-07 14:49:29

The docbuild regression is recent (since #22588) and very annoying, so I think that this deserves to be a blocker.


---

Comment by jdemeyer created at 2017-10-07 14:49:29

Changing priority from critical to blocker.


---

Comment by jhpalmieri created at 2017-10-07 16:12:07

Okay, following your directions, I can reproduce this (although I just touched `local/lib/sage-force-relocate.txt` rather than install anything), and this fixes the problem. We're pretty close to just deleting `sage-location` altogether at this point.


---

Comment by jhpalmieri created at 2017-10-07 16:12:07

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-10-08 07:08:11

Replying to [comment:10 jhpalmieri]:
> We're pretty close to just deleting `sage-location` altogether at this point.

True!


---

Comment by embray created at 2017-10-09 09:32:04

> It seems that the `.pyc` files are intentionally deleted by `sage-location`. I see no reason for this.

pyc files contain hard-coded paths :/  Better than deleting them would be immediately regenerating them though.


---

Comment by vbraun created at 2017-10-15 09:22:09

Resolution: fixed
