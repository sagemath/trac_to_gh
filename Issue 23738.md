# Issue 23738: docbuild sometimes fails due to non-existing .pyc file

archive/issues_023738.json:
```json
{
    "body": "CC:  jhpalmieri\n\nSometimes the following happens:\n\n```\n[dochtml] [reference] WARNING: Building reference manual, second pass.\n[dochtml] Error building the documentation.\n[dochtml] Traceback (most recent call last):\n[dochtml]   File \"/usr/local/src/sage-config/local/lib/python2.7/runpy.py\", line 174, in _run_module_as_main\n[dochtml]     \"__main__\", fname, loader, pkg_name)\n[dochtml]   File \"/usr/local/src/sage-config/local/lib/python2.7/runpy.py\", line 72, in _run_code\n[dochtml]     exec code in run_globals\n[dochtml]   File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py\", line 2, in <module>\n[dochtml]     main()\n[dochtml]   File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py\", line 1675, in main\n[dochtml]     builder()\n[dochtml]   File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py\", line 314, in _wrapper\n[dochtml]     getattr(get_builder(document), name)(*args, **kwds)\n[dochtml]   File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py\", line 505, in _wrapper\n[dochtml]     build_many(build_ref_doc, L)\n[dochtml]   File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py\", line 260, in build_many\n[dochtml]     results.append(target(arg))\n[dochtml]   File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py\", line 71, in build_ref_doc\n[dochtml]     getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)\n[dochtml]   File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py\", line 711, in _wrapper\n[dochtml]     for module_name in self.get_new_and_updated_modules():\n[dochtml]   File \"/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py\", line 914, in get_new_and_updated_modules\n[dochtml]     newtime = os.path.getmtime(sys.modules[module_name].__file__)\n[dochtml]   File \"/usr/local/src/sage-config/local/lib/python2.7/genericpath.py\", line 62, in getmtime\n[dochtml]     return os.stat(filename).st_mtime\n[dochtml] OSError: [Errno 2] No such file or directory: '/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/manifolds/manifold_homset.pyc'\n```\n\n\nIn this case, the `.pyc` file indeed does not exist:\n\n```\n$ ls -l /usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/manifolds\ntotal 652\n-rw-r--r-- 1 jdemeyer jdemeyer    235 Sep 19 13:17 all.py\n-rw-r--r-- 1 jdemeyer jdemeyer 121676 Sep 19 13:17 chart.py\n-rw-r--r-- 1 jdemeyer jdemeyer  78225 Sep 19 13:17 continuous_map.py\n-rw-r--r-- 1 jdemeyer jdemeyer  44475 Oct  5 12:18 coord_func.py\n-rw-r--r-- 1 jdemeyer jdemeyer  54706 Oct  5 12:18 coord_func_symb.py\ndrwxr-xr-x 2 jdemeyer jdemeyer   4096 Oct  6 09:58 differentiable\n-rw-r--r-- 1 jdemeyer jdemeyer     13 Sep 19 13:17 __init__.py\n-rw-r--r-- 1 jdemeyer jdemeyer  16196 Sep 19 13:17 manifold_homset.py\n-rw-r--r-- 1 jdemeyer jdemeyer  87439 Oct  5 14:25 manifold.py\n-rw-r--r-- 1 jdemeyer jdemeyer  35967 Sep 19 13:17 point.py\n-rw-r--r-- 1 jdemeyer jdemeyer  21002 Sep 19 13:17 scalarfield_algebra.py\n-rw-r--r-- 1 jdemeyer jdemeyer  97995 Oct  5 12:18 scalarfield.py\n-rw-r--r-- 1 jdemeyer jdemeyer   4533 Sep 19 13:17 structure.py\n-rw-r--r-- 1 jdemeyer jdemeyer  40170 Sep 19 13:17 subset.py\n-rw-r--r-- 1 jdemeyer jdemeyer  31947 Oct  5 12:18 utilities.py\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/23975\n\n",
    "created_at": "2017-10-06T08:14:45Z",
    "labels": [
        "documentation",
        "major",
        "bug"
    ],
    "title": "docbuild sometimes fails due to non-existing .pyc file",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23738",
    "user": "jdemeyer"
}
```
CC:  jhpalmieri

Sometimes the following happens:

```
[dochtml] [reference] WARNING: Building reference manual, second pass.
[dochtml] Error building the documentation.
[dochtml] Traceback (most recent call last):
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/runpy.py", line 174, in _run_module_as_main
[dochtml]     "__main__", fname, loader, pkg_name)
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/runpy.py", line 72, in _run_code
[dochtml]     exec code in run_globals
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
[dochtml]     main()
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 1675, in main
[dochtml]     builder()
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 314, in _wrapper
[dochtml]     getattr(get_builder(document), name)(*args, **kwds)
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 505, in _wrapper
[dochtml]     build_many(build_ref_doc, L)
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 260, in build_many
[dochtml]     results.append(target(arg))
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 71, in build_ref_doc
[dochtml]     getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 711, in _wrapper
[dochtml]     for module_name in self.get_new_and_updated_modules():
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 914, in get_new_and_updated_modules
[dochtml]     newtime = os.path.getmtime(sys.modules[module_name].__file__)
[dochtml]   File "/usr/local/src/sage-config/local/lib/python2.7/genericpath.py", line 62, in getmtime
[dochtml]     return os.stat(filename).st_mtime
[dochtml] OSError: [Errno 2] No such file or directory: '/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/manifolds/manifold_homset.pyc'
```


In this case, the `.pyc` file indeed does not exist:

```
$ ls -l /usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/manifolds
total 652
-rw-r--r-- 1 jdemeyer jdemeyer    235 Sep 19 13:17 all.py
-rw-r--r-- 1 jdemeyer jdemeyer 121676 Sep 19 13:17 chart.py
-rw-r--r-- 1 jdemeyer jdemeyer  78225 Sep 19 13:17 continuous_map.py
-rw-r--r-- 1 jdemeyer jdemeyer  44475 Oct  5 12:18 coord_func.py
-rw-r--r-- 1 jdemeyer jdemeyer  54706 Oct  5 12:18 coord_func_symb.py
drwxr-xr-x 2 jdemeyer jdemeyer   4096 Oct  6 09:58 differentiable
-rw-r--r-- 1 jdemeyer jdemeyer     13 Sep 19 13:17 __init__.py
-rw-r--r-- 1 jdemeyer jdemeyer  16196 Sep 19 13:17 manifold_homset.py
-rw-r--r-- 1 jdemeyer jdemeyer  87439 Oct  5 14:25 manifold.py
-rw-r--r-- 1 jdemeyer jdemeyer  35967 Sep 19 13:17 point.py
-rw-r--r-- 1 jdemeyer jdemeyer  21002 Sep 19 13:17 scalarfield_algebra.py
-rw-r--r-- 1 jdemeyer jdemeyer  97995 Oct  5 12:18 scalarfield.py
-rw-r--r-- 1 jdemeyer jdemeyer   4533 Sep 19 13:17 structure.py
-rw-r--r-- 1 jdemeyer jdemeyer  40170 Sep 19 13:17 subset.py
-rw-r--r-- 1 jdemeyer jdemeyer  31947 Oct  5 12:18 utilities.py
```


Issue created by migration from https://trac.sagemath.org/ticket/23975





---

archive/issue_comments_332542.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2017-10-06T09:01:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23738#issuecomment-332542",
    "user": "jdemeyer"
}
```

Changing priority from major to critical.



---

archive/issue_comments_332543.json:
```json
{
    "body": "Changing component from documentation to build.",
    "created_at": "2017-10-06T09:01:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23738#issuecomment-332543",
    "user": "jdemeyer"
}
```

Changing component from documentation to build.



---

archive/issue_comments_332544.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-10-06T09:59:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23738#issuecomment-332544",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_332545.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-10-06T09:59:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23738#issuecomment-332545",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_332546.json:
```json
{
    "body": "Do you have any suggestions about how to reproduce the problem, or is it just somewhat random?",
    "created_at": "2017-10-06T20:28:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23738#issuecomment-332546",
    "user": "jhpalmieri"
}
```

Do you have any suggestions about how to reproduce the problem, or is it just somewhat random?



---

archive/issue_comments_332547.json:
```json
{
    "body": "I can see that this branch is doing what it claims. I wish I knew why we deleted these in the first place. Is it perhaps some remnant of what is now `_find_stale_files` (and related) in `sage_setup.clean`?",
    "created_at": "2017-10-06T22:42:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23738#issuecomment-332547",
    "user": "jhpalmieri"
}
```

I can see that this branch is doing what it claims. I wish I knew why we deleted these in the first place. Is it perhaps some remnant of what is now `_find_stale_files` (and related) in `sage_setup.clean`?



---

archive/issue_comments_332548.json:
```json
{
    "body": "Replying to [comment:5 jhpalmieri]:\n> Do you have any suggestions about how to reproduce the problem, or is it just somewhat random?\n\nIt's not random. Typically, it happens when you are building the documentation and at the same time installing some package.\n\nSo, on terminal 1, we run\n\n```\n$ make doc\n```\n\n\nAnd on terminal 2, we run something like\n\n```\n$ make database_cremona_ellcurve   # or any other optional package\n$ ./sage\n```\n\n\nStarting `./sage` on terminal 2 will cause `sage-location` to run, which will in turn cause the docbuild to fail in terminal 1.",
    "created_at": "2017-10-07T07:53:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23738#issuecomment-332548",
    "user": "jdemeyer"
}
```

Replying to [comment:5 jhpalmieri]:
> Do you have any suggestions about how to reproduce the problem, or is it just somewhat random?

It's not random. Typically, it happens when you are building the documentation and at the same time installing some package.

So, on terminal 1, we run

```
$ make doc
```


And on terminal 2, we run something like

```
$ make database_cremona_ellcurve   # or any other optional package
$ ./sage
```


Starting `./sage` on terminal 2 will cause `sage-location` to run, which will in turn cause the docbuild to fail in terminal 1.



---

archive/issue_comments_332549.json:
```json
{
    "body": "Replying to [comment:6 jhpalmieri]:\n> Is it perhaps some remnant of what is now `_find_stale_files` (and related) in `sage_setup.clean`?\n\nInterestingly, in the very first version of `sage-location` (commit c7e6c5d1c1db3b8562c07e83ff6c36bbb7d36c24), removing the `.pyc` and `.pyo` files was the only thing that `sage-location` did. This is the main function from that 11-year old version:\n\n```python\ndef update_hardcoded_files(path):\n    # The only known files with hard coded paths.\n    if os.path.isdir(path):\n        for X in os.listdir(path):\n            update_hardcoded_files('%s/%s'%(path,X))\n    else:\n        P = path[-4:]\n        if P == '.pyo' or P == '.pyc':\n            try:\n                os.unlink(path)\n            except OSError, msg:\n                print msg\n```\n\nSo I guess they must be deleted because there are hardcoded paths in those files. If so, that is clearly no longer relevant.",
    "created_at": "2017-10-07T07:59:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23738#issuecomment-332549",
    "user": "jdemeyer"
}
```

Replying to [comment:6 jhpalmieri]:
> Is it perhaps some remnant of what is now `_find_stale_files` (and related) in `sage_setup.clean`?

Interestingly, in the very first version of `sage-location` (commit c7e6c5d1c1db3b8562c07e83ff6c36bbb7d36c24), removing the `.pyc` and `.pyo` files was the only thing that `sage-location` did. This is the main function from that 11-year old version:

```python
def update_hardcoded_files(path):
    # The only known files with hard coded paths.
    if os.path.isdir(path):
        for X in os.listdir(path):
            update_hardcoded_files('%s/%s'%(path,X))
    else:
        P = path[-4:]
        if P == '.pyo' or P == '.pyc':
            try:
                os.unlink(path)
            except OSError, msg:
                print msg
```

So I guess they must be deleted because there are hardcoded paths in those files. If so, that is clearly no longer relevant.



---

archive/issue_comments_332550.json:
```json
{
    "body": "The docbuild regression is recent (since #22588) and very annoying, so I think that this deserves to be a blocker.",
    "created_at": "2017-10-07T14:49:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23738#issuecomment-332550",
    "user": "jdemeyer"
}
```

The docbuild regression is recent (since #22588) and very annoying, so I think that this deserves to be a blocker.



---

archive/issue_comments_332551.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2017-10-07T14:49:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23738#issuecomment-332551",
    "user": "jdemeyer"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_332552.json:
```json
{
    "body": "Okay, following your directions, I can reproduce this (although I just touched `local/lib/sage-force-relocate.txt` rather than install anything), and this fixes the problem. We're pretty close to just deleting `sage-location` altogether at this point.",
    "created_at": "2017-10-07T16:12:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23738#issuecomment-332552",
    "user": "jhpalmieri"
}
```

Okay, following your directions, I can reproduce this (although I just touched `local/lib/sage-force-relocate.txt` rather than install anything), and this fixes the problem. We're pretty close to just deleting `sage-location` altogether at this point.



---

archive/issue_comments_332553.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-10-07T16:12:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23738#issuecomment-332553",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_332554.json:
```json
{
    "body": "Replying to [comment:10 jhpalmieri]:\n> We're pretty close to just deleting `sage-location` altogether at this point.\n\nTrue!",
    "created_at": "2017-10-08T07:08:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23738#issuecomment-332554",
    "user": "jdemeyer"
}
```

Replying to [comment:10 jhpalmieri]:
> We're pretty close to just deleting `sage-location` altogether at this point.

True!



---

archive/issue_comments_332555.json:
```json
{
    "body": "> It seems that the `.pyc` files are intentionally deleted by `sage-location`. I see no reason for this.\n\npyc files contain hard-coded paths :/  Better than deleting them would be immediately regenerating them though.",
    "created_at": "2017-10-09T09:32:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23738#issuecomment-332555",
    "user": "embray"
}
```

> It seems that the `.pyc` files are intentionally deleted by `sage-location`. I see no reason for this.

pyc files contain hard-coded paths :/  Better than deleting them would be immediately regenerating them though.



---

archive/issue_comments_332556.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-10-15T09:22:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23738",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23738#issuecomment-332556",
    "user": "vbraun"
}
```

Resolution: fixed
