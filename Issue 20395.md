# Issue 20395: Docs build crashes on Cygwin

Issue created by migration from https://trac.sagemath.org/ticket/20632

Original creator: embray

Original creation time: 2016-05-19 15:33:27

Keywords: windows cygwin docbuild

I'm trying to build the docs on Cygwin and am getting a consistent crash at:


```
... building other docs ...
Build finished.  The built documents can be found in /home/embray/src/sagemath/sage/local/share/doc/sage/inventory/en/reference/arithgroup
      0 [main] python 1856 fork: child -1 - forked process 3808 died unexpectedly, retry 0, exit code 0xC0000005, errno 11
Error building the documentation.
Traceback (most recent call last):
  File "/home/embray/src/sagemath/sage/local/lib/python/runpy.py", line 162, in _run_module_as_main
    "__main__", fname, loader, pkg_name)
  File "/home/embray/src/sagemath/sage/local/lib/python/runpy.py", line 72, in _run_code
    exec code in run_globals
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
    main()
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 1638, in main
    builder()
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 284, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 504, in _wrapper
    x.get(99999)
  File "/home/embray/src/sagemath/sage/local/lib/python/multiprocessing/pool.py", line 567, in get
    raise self._value
EnvironmentError: pkg-config is not installed
```


`0xC0000005` is apparently an access violation.  Not clear yet where it's coming from, but it's probably a Cygwin bug.  The reference to "pkg-config" is especially bizarre.

I'm experimenting with a patch so that if `SAGE_NUM_THREADS=1` the doc build doesn't use multiprocessing *at all* and that seems to be working.  So that might be a worthwhile patch to add anyways.

Then, with such a patch, I can further modify things so that `NUM_THREADS=1` is forced on Cygwin, just as a workaround until and unless I can get to the root of the problem.


---

Comment by embray created at 2016-05-19 15:40:41

It's conceivable I may need to do another `rebaseall` or something.  I haven't tried that yet.


---

Comment by embray created at 2016-05-19 15:52:27

Part way through the single process docs build it died with:


```
OSError: [graphs   ] /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/graphs/digraph.py:docstring of sage.graphs.digraph.DiGraph.reverse_edge:116: WARNING: more than one target found for cross-reference u'edge_label': sage.graphs.generic_graph.GenericGraph.edge_label, sage.combinat.knutson_tao_puzzles.PuzzlePiece.edge_label
```


I restarted the build and it seems to be proceeding past that.  Looks like that xref should be updated to be unambiguous.


---

Comment by embray created at 2016-05-19 15:56:56

Hmm, not sure why that would be happening, but the line in question reads:


```
         on the list returned by :meth:`.edge_label`)::
```


This syntax would seem to automatically imply the `edge_label` method of `GenericGraph` so I don't know why it would think that was ambiguous.


---

Comment by embray created at 2016-05-19 16:01:39

Got another one of those:

```
OSError: [categorie] /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/categories/finite_groups.py:docstring of sage.categories.finite_groups.FiniteGroups.ParentMethods.cardinality:4: WARNING: more than one target found for cross-reference u'order': sage.combinat.diagram_algebras.DiagramAlgebra.order, sage.algebras.quatalg.quaternion_algebra.QuaternionAlgebra_abstract.order, sage.categories.groups.Groups.CartesianProducts.ParentMethods.order, sage.algebras.steenrod.steenrod_algebra.SteenrodAlgebra_generic.order
```


Seems to be a defect in `sphinx.domains.python`, or the code in `docs/common/conf.py` adapted from it, or both...


---

Comment by embray created at 2016-05-19 16:50:43

Yes, I see now. I think this may be a bug in Sphinx (is this known)?

For example, when generating a reference for `DiGraph.edge_label` (which is referenced in the docstring for `DiGraph` as `:meth:`.edge_label``) it comes up with multiple matches: 


```
[(u'sage.combinat.knutson_tao_puzzles.PuzzlePiece.edge_label', (u'sage/combinat/knutson_tao_puzzles', u'method')), (u'sage.graphs.generic_graph.GenericGraph.edge_label', (u'sage/graphs/generic_graph', u'method'))]
```


In this case it should of course use `GenericGraph.edge_label`, but it doesn't recognize that `GenericGraph` is a subclass of `DiGraph` and should be preferred.  Instead this ends up generating an incorrect reference.

A workaround would be to use a more explicit reference.


---

Comment by embray created at 2016-05-20 09:15:39

I added a new ticket about the reference issue in Sphinx, since I think it's technically distinct from the issue I'm having running parallel doc builds on Windows: #20639


---

Comment by embray created at 2016-05-25 15:46:22

Replying to [comment:1 embray]:
> It's conceivable I may need to do another `rebaseall` or something.  I haven't tried that yet.  

Repeated `rebaseall`s don't seem to resolve the issue.  Will need to take a deeper look sometime.  In the meantime I have a patch to not use `multiprocessing.Pool` when `SAGE_NUM_THREADS=1`, and that works around the issue.


---

Comment by embray created at 2016-05-25 15:51:02

Great, now I'm getting

```
[asymptoti] no targets are out of date.
Build finished.  The built documents can be found in /home/embray/src/sagemath/sage/local/share/doc/sage/inventory/en/reference/asymptotic
[calculus ] building [inventory]: targets for 25 source files that are out of date
[calculus ] updating environment: 0 added, 25 changed, 0 removed
[calculus ] reading sources... [  4%] sage/calculus/calculus
/home/embray/src/sagemath/sage/build/bin/sage-logger: line 32: 12444 Segmentation fault      (core dumped) ./sage --docbuild --no-pdf-links all html
Makefile:849: recipe for target 'doc-html' failed
make[2]: *** [doc-html] Error 139
```


This is new.  I never got this last time I built the docs, and they only rebuilt because I switched branches a couple times.


---

Comment by embray created at 2016-05-25 16:03:43

Okay, it's just the same segfault as #20463 so at least nothing new. Don't know why I'm getting it now though, since the patch for it is applied and I can run sage normally just fine.


---

Comment by embray created at 2016-05-26 08:11:44

Not sure how it happened, but I got the `pkg-config` error again from the original description of this ticket, but this time with a useful traceback:


```
Error building the documentation.
Traceback (most recent call last):
  File "/home/embray/src/sagemath/sage/local/lib/python/runpy.py", line 162, in _run_module_as_main
    "__main__", fname, loader, pkg_name)
  File "/home/embray/src/sagemath/sage/local/lib/python/runpy.py", line 72, in _run_code
    exec code in run_globals
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
    main()
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 1637, in main
    builder()
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 313, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 508, in _wrapper
    map_parallel(build_ref_doc, L)
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 142, in map_parallel
    return map(func, args)
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 69, in build_ref_doc
    getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 705, in _wrapper
    self.write_auto_rest_file(module_name.replace(os.path.sep, '.'))
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 970, in write_auto_rest_file
    title = self.get_module_docstring_title(module_name)
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 929, in get_module_docstring_title
    __import__(module_name)
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/misc/cython.py", line 29, in <module>
    cblas_pc = pkgconfig.parse('cblas')
  File "build/bdist.cygwin-2.4.1-x86_64/egg/pkgconfig/pkgconfig.py", line 187, in parse
    for k, v in parse_package(package).items():
  File "build/bdist.cygwin-2.4.1-x86_64/egg/pkgconfig/pkgconfig.py", line 160, in parse_package
    out = _query(package, '--cflags --libs')
  File "build/bdist.cygwin-2.4.1-x86_64/egg/pkgconfig/pkgconfig.py", line 58, in _wrapper
    raise EnvironmentError("pkg-config is not installed")
EnvironmentError: pkg-config is not installed
```



---

Comment by embray created at 2017-04-13 10:07:54

I still haven't had success with parallel docs build on Cygwin; leaving this open for now but clearing the old milestone.


---

Comment by embray created at 2018-04-11 14:43:44

Resolution: worksforme


---

Comment by embray created at 2018-04-11 14:43:44

This was probably related to some other bugs, but I'm not sure anymore.  However, this has not been a problem for some time--since other issues have been fixed the doc build runs fine on Cygwin, even in parallel (though there are still some issues, namely #25089).
