# Issue 13769: Upgrade Maxima past the release 5.29.1

archive/issues_013769.json:
```json
{
    "body": "Assignee: tbd\n\nCC:  snark\n\nThis is a continuation of #13364, and aims at including more upstream bug fixes, which e.g. fix an\n[issue reported on sage-support](http://permalink.gmane.org/gmane.comp.mathematics.sage.support/30644), \nwhich was reported as Maxima bug [2535](https://sourceforge.net/p/maxima/bugs/2535), and marked there as closed in post-5.29.1.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13973\n\n",
    "created_at": "2013-01-19T12:29:28Z",
    "labels": [
        "packages: standard",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "Upgrade Maxima past the release 5.29.1",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13769",
    "user": "dimpase"
}
```
Assignee: tbd

CC:  snark

This is a continuation of #13364, and aims at including more upstream bug fixes, which e.g. fix an
[issue reported on sage-support](http://permalink.gmane.org/gmane.comp.mathematics.sage.support/30644), 
which was reported as Maxima bug [2535](https://sourceforge.net/p/maxima/bugs/2535), and marked there as closed in post-5.29.1.

Issue created by migration from https://trac.sagemath.org/ticket/13973





---

archive/issue_comments_170874.json:
```json
{
    "body": "So for instance going at least as far as the fix for #13733 would be good.",
    "created_at": "2013-01-20T01:39:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170874",
    "user": "kcrisman"
}
```

So for instance going at least as far as the fix for #13733 would be good.



---

archive/issue_comments_170875.json:
```json
{
    "body": "while we are at it, it seems strange to me that `sage/interfaces/maxima_abstract.py` contains a doctest for the maxima version used:\n\n```\nFile \"/localdisk/tmp/sage-5.5/devel/sage-12615b/sage/interfaces/maxima_abstract.py\", line 422:\n    sage: maxima.version()\nExpected:\n    '5.26.0'\nGot:\n    '5.29.1'\n```\n\nWhat really matters is the **functionality** provided, not the actual version?\nDoes Sage check the actual version of each component?\n\nPaul",
    "created_at": "2013-01-23T08:08:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170875",
    "user": "zimmerma"
}
```

while we are at it, it seems strange to me that `sage/interfaces/maxima_abstract.py` contains a doctest for the maxima version used:

```
File "/localdisk/tmp/sage-5.5/devel/sage-12615b/sage/interfaces/maxima_abstract.py", line 422:
    sage: maxima.version()
Expected:
    '5.26.0'
Got:
    '5.29.1'
```

What really matters is the **functionality** provided, not the actual version?
Does Sage check the actual version of each component?

Paul



---

archive/issue_comments_170876.json:
```json
{
    "body": "Replying to [comment:3 zimmerma]:\n> while we are at it, it seems strange to me that `sage/interfaces/maxima_abstract.py` contains a doctest for the maxima version used:\n> {{{\n> File \"/localdisk/tmp/sage-5.5/devel/sage-12615b/sage/interfaces/maxima_abstract.py\", line 422:\n>     sage: maxima.version()\n> Expected:\n>     '5.26.0'\n> Got:\n>     '5.29.1'\n> }}}\n\nseems that http://trac.sagemath.org/sage_trac/attachment/ticket/13364/doctests.2.patch\nwas not installed into the Sage installation you work with.\n\n> What really matters is the **functionality** provided, not the actual version?\n> Does Sage check the actual version of each component?\n\nSage provides versions at least for some other components, e.g. `gap.version()`\n\nSometimes it might be useful; AFAIK some optional packages check this.\n\nDima\n\n\n> \n> Paul",
    "created_at": "2013-01-23T09:45:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170876",
    "user": "dimpase"
}
```

Replying to [comment:3 zimmerma]:
> while we are at it, it seems strange to me that `sage/interfaces/maxima_abstract.py` contains a doctest for the maxima version used:
> {{{
> File "/localdisk/tmp/sage-5.5/devel/sage-12615b/sage/interfaces/maxima_abstract.py", line 422:
>     sage: maxima.version()
> Expected:
>     '5.26.0'
> Got:
>     '5.29.1'
> }}}

seems that http://trac.sagemath.org/sage_trac/attachment/ticket/13364/doctests.2.patch
was not installed into the Sage installation you work with.

> What really matters is the **functionality** provided, not the actual version?
> Does Sage check the actual version of each component?

Sage provides versions at least for some other components, e.g. `gap.version()`

Sometimes it might be useful; AFAIK some optional packages check this.

Dima


> 
> Paul



---

archive/issue_comments_170877.json:
```json
{
    "body": "Dima, I don't object about **providing** a function `maxima_version()`, but **checking** it returns a particular value.\n\nPaul",
    "created_at": "2013-01-23T10:15:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170877",
    "user": "zimmerma"
}
```

Dima, I don't object about **providing** a function `maxima_version()`, but **checking** it returns a particular value.

Paul



---

archive/issue_comments_170878.json:
```json
{
    "body": "Replying to [comment:5 zimmerma]:\n> Dima, I don't object about **providing** a function `maxima_version()`, but **checking** it returns a particular value.\n> \n\nwell, one would like to test Sage functions... How else would you check that it works and returns something meaningful?\n\n> Paul",
    "created_at": "2013-01-23T12:33:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170878",
    "user": "dimpase"
}
```

Replying to [comment:5 zimmerma]:
> Dima, I don't object about **providing** a function `maxima_version()`, but **checking** it returns a particular value.
> 

well, one would like to test Sage functions... How else would you check that it works and returns something meaningful?

> Paul



---

archive/issue_comments_170879.json:
```json
{
    "body": "we could for example check that the version is of the form `x.y.z`, or is greater than or equal to a given number.\n\nPaul",
    "created_at": "2013-01-23T12:37:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170879",
    "user": "zimmerma"
}
```

we could for example check that the version is of the form `x.y.z`, or is greater than or equal to a given number.

Paul



---

archive/issue_comments_170880.json:
```json
{
    "body": "see #14306 (issue fixed in Maxima git)\n\nPaul",
    "created_at": "2013-05-07T08:54:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170880",
    "user": "zimmerma"
}
```

see #14306 (issue fixed in Maxima git)

Paul



---

archive/issue_comments_170881.json:
```json
{
    "body": "Also note that Maxima is now at 5.30.0.",
    "created_at": "2013-05-08T02:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170881",
    "user": "kcrisman"
}
```

Also note that Maxima is now at 5.30.0.



---

archive/issue_comments_170882.json:
```json
{
    "body": "Yes it is at 5.30.0. No check from sage-on-gentoo on whether it works so far because the maxima ecl library building is currently broken for that particular version - an adsf upgrade problem in gentoo.\n\nI second checking the form of the version returned rather than the value. That would make my life easier when R, maxima are upgraded in s-o-g independently of sage itself (and without side effects at leat in doctests).",
    "created_at": "2013-05-08T09:30:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170882",
    "user": "fbissey"
}
```

Yes it is at 5.30.0. No check from sage-on-gentoo on whether it works so far because the maxima ecl library building is currently broken for that particular version - an adsf upgrade problem in gentoo.

I second checking the form of the version returned rather than the value. That would make my life easier when R, maxima are upgraded in s-o-g independently of sage itself (and without side effects at leat in doctests).



---

archive/issue_comments_170883.json:
```json
{
    "body": "I'll try making a new Maxima spkg just to see what happpens...",
    "created_at": "2013-06-13T08:51:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170883",
    "user": "jdemeyer"
}
```

I'll try making a new Maxima spkg just to see what happpens...



---

archive/issue_comments_170884.json:
```json
{
    "body": "This looks problematic:\n\n```\nsage -t devel/sage/sage/calculus/calculus.py\n**********************************************************************\nFile \"devel/sage/sage/calculus/calculus.py\", line 145, in sage.calculus.calculus\nFailed example:\n    e^M\nException raised:\n    Traceback (most recent call last):\n      File \"/mazur/release/merger/sage-5.10.rc2/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 466, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/mazur/release/merger/sage-5.10.rc2/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 825, in execute\n        exec compiled in globs\n      File \"<doctest sage.calculus.calculus[32]>\", line 1, in <module>\n        e**M\n      File \"constants_c.pyx\", line 275, in sage.symbolic.constants_c.E.__pow__ (sage/symbolic/constants_c.cpp:2779)\n      File \"matrix_symbolic_dense.pyx\", line 387, in sage.matrix.matrix_symbolic_dense.Matrix_symbolic_dense.exp (sage/matrix/matrix_symbolic_dense.c:3433)\n      File \"/mazur/release/merger/sage-5.10.rc2/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 199, in __call__\n        return cls(self, x, name=name)\n      File \"/mazur/release/merger/sage-5.10.rc2/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 626, in __init__\n        raise TypeError, x\n    TypeError: ECL says: Error executing code in Maxima: Unable to find the spectral representation\n**********************************************************************\n```\n",
    "created_at": "2013-06-13T09:30:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170884",
    "user": "jdemeyer"
}
```

This looks problematic:

```
sage -t devel/sage/sage/calculus/calculus.py
**********************************************************************
File "devel/sage/sage/calculus/calculus.py", line 145, in sage.calculus.calculus
Failed example:
    e^M
Exception raised:
    Traceback (most recent call last):
      File "/mazur/release/merger/sage-5.10.rc2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 466, in _run
        self.execute(example, compiled, test.globs)
      File "/mazur/release/merger/sage-5.10.rc2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 825, in execute
        exec compiled in globs
      File "<doctest sage.calculus.calculus[32]>", line 1, in <module>
        e**M
      File "constants_c.pyx", line 275, in sage.symbolic.constants_c.E.__pow__ (sage/symbolic/constants_c.cpp:2779)
      File "matrix_symbolic_dense.pyx", line 387, in sage.matrix.matrix_symbolic_dense.Matrix_symbolic_dense.exp (sage/matrix/matrix_symbolic_dense.c:3433)
      File "/mazur/release/merger/sage-5.10.rc2/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 199, in __call__
        return cls(self, x, name=name)
      File "/mazur/release/merger/sage-5.10.rc2/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 626, in __init__
        raise TypeError, x
    TypeError: ECL says: Error executing code in Maxima: Unable to find the spectral representation
**********************************************************************
```




---

archive/issue_comments_170885.json:
```json
{
    "body": "Also\n\n```\nsage -t devel/sage/sage/interfaces/maxima.py  # Time out\n```\n\ndue to a timeout of\n\n```\nsage: maxima('limit(x^a,x,0)')\n```\n\nThis is fixable, it is because of a slightly different output format of assumptions.",
    "created_at": "2013-06-13T09:36:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170885",
    "user": "jdemeyer"
}
```

Also

```
sage -t devel/sage/sage/interfaces/maxima.py  # Time out
```

due to a timeout of

```
sage: maxima('limit(x^a,x,0)')
```

This is fixable, it is because of a slightly different output format of assumptions.



---

archive/issue_comments_170886.json:
```json
{
    "body": "That is awesome, thanks for checking this, Jeroen.",
    "created_at": "2013-06-13T14:13:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170886",
    "user": "kcrisman"
}
```

That is awesome, thanks for checking this, Jeroen.



---

archive/issue_comments_170887.json:
```json
{
    "body": "> This is fixable, it is because of a slightly different output format of assumptions.\nJeroen, while it's true that the error is slightly different in format, I don't think this is the problem (or at least not the whole one).  The other things are still passing doctests, and we never even *get* to the \n\n```\n           if i > 0:\n                v = self._expect.before\n```\n\nbranch, as one can verify by inserting print statements.\n> This looks problematic:\nThis is #2400 again, to some extent.  Not sure why this doesn't work any more.  In Maxima 5.29.1, this is fine.\n\n```\nMaxima 5.29.1 http://maxima.sourceforge.net\nusing Lisp ECL 12.12.1\nDistributed under the GNU Public License. See the file COPYING.\nDedicated to the memory of William Schelter.\nThe function bug_report() provides bug reporting information.\n(%i1) m: matrix([%i*%pi]);\n(%o1)                             [ %i %pi ]\n(%i4) matrixexp(m), keepfloat:true;\n(%o4)                                 - 1\n(%i5) matrixexp(m),keepfloat:false;\n(%o5)                                 - 1\n```\n\n\nwhich is good.  In 5.30, though, we have\n\n\n```\n(%i1) m: matrix([%i*%pi]);\n(%o1)                             [ %i %pi ]\n(%i6) matrixexp(m),keepfloat:true;\n\nUnable to find the spectral representation\n -- an error. To debug this try: debugmode(true);\n(%i7) matrixexp(m),keepfloat:false;\n\nUnable to find the spectral representation\n -- an error. To debug this try: debugmode(true);\n```\n",
    "created_at": "2013-06-18T18:30:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170887",
    "user": "kcrisman"
}
```

> This is fixable, it is because of a slightly different output format of assumptions.
Jeroen, while it's true that the error is slightly different in format, I don't think this is the problem (or at least not the whole one).  The other things are still passing doctests, and we never even *get* to the 

```
           if i > 0:
                v = self._expect.before
```

branch, as one can verify by inserting print statements.
> This looks problematic:
This is #2400 again, to some extent.  Not sure why this doesn't work any more.  In Maxima 5.29.1, this is fine.

```
Maxima 5.29.1 http://maxima.sourceforge.net
using Lisp ECL 12.12.1
Distributed under the GNU Public License. See the file COPYING.
Dedicated to the memory of William Schelter.
The function bug_report() provides bug reporting information.
(%i1) m: matrix([%i*%pi]);
(%o1)                             [ %i %pi ]
(%i4) matrixexp(m), keepfloat:true;
(%o4)                                 - 1
(%i5) matrixexp(m),keepfloat:false;
(%o5)                                 - 1
```


which is good.  In 5.30, though, we have


```
(%i1) m: matrix([%i*%pi]);
(%o1)                             [ %i %pi ]
(%i6) matrixexp(m),keepfloat:true;

Unable to find the spectral representation
 -- an error. To debug this try: debugmode(true);
(%i7) matrixexp(m),keepfloat:false;

Unable to find the spectral representation
 -- an error. To debug this try: debugmode(true);
```




---

archive/issue_comments_170888.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd48\".",
    "created_at": "2013-06-18T18:37:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170888",
    "user": "kcrisman"
}
```

Changing keywords from "" to "sd48".



---

archive/issue_comments_170889.json:
```json
{
    "body": "Note that the spkg changes are not committed.",
    "created_at": "2013-06-18T18:38:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170889",
    "user": "kcrisman"
}
```

Note that the spkg changes are not committed.



---

archive/issue_comments_170890.json:
```json
{
    "body": "Thanks to Barton Willis for this workaround.\n\n```\nThis bug is due to circa January 2013 changes to matrix inversion. A workaround is to set ratmx to true:\n\nMaxima branch_5_30_base_98_g29f9239_dirty http://maxima.sourceforge.net\nusing Lisp Clozure Common Lisp Version 1.9-r15764  (WindowsX8632)\n\n(%i1) matrixexp(matrix([%i*%pi]));\n\nUnable to find the spectral representation\n\n(%i2) matrixexp(matrix([%i*%pi])), ratmx=true;\n(%o2)                                 - 1\n```\n\nI've reported this [here](https://sourceforge.net/p/maxima/bugs/2596/).  I don't know if doing this ratmx thing universally is good, though:\n\n```\n if FALSE will cause determinant and matrix addition, subtraction, and multiplication to be performed in the representation of the matrix elements and will cause the result of matrix inversion to be left in general representation. If it is TRUE, the 4 operations mentioned above will be performed in CRE form and the result of matrix inverse will be in CRE form. Note that this may cause the elements to be expanded (depending on the setting of RATFAC) which might not always be desired.\n```\n",
    "created_at": "2013-06-19T13:44:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170890",
    "user": "kcrisman"
}
```

Thanks to Barton Willis for this workaround.

```
This bug is due to circa January 2013 changes to matrix inversion. A workaround is to set ratmx to true:

Maxima branch_5_30_base_98_g29f9239_dirty http://maxima.sourceforge.net
using Lisp Clozure Common Lisp Version 1.9-r15764  (WindowsX8632)

(%i1) matrixexp(matrix([%i*%pi]));

Unable to find the spectral representation

(%i2) matrixexp(matrix([%i*%pi])), ratmx=true;
(%o2)                                 - 1
```

I've reported this [here](https://sourceforge.net/p/maxima/bugs/2596/).  I don't know if doing this ratmx thing universally is good, though:

```
 if FALSE will cause determinant and matrix addition, subtraction, and multiplication to be performed in the representation of the matrix elements and will cause the result of matrix inversion to be left in general representation. If it is TRUE, the 4 operations mentioned above will be performed in CRE form and the result of matrix inverse will be in CRE form. Note that this may cause the elements to be expanded (depending on the setting of RATFAC) which might not always be desired.
```




---

archive/issue_comments_170891.json:
```json
{
    "body": "5.31 has been released.",
    "created_at": "2013-09-04T22:52:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170891",
    "user": "kcrisman"
}
```

5.31 has been released.



---

archive/issue_comments_170892.json:
```json
{
    "body": "Maxima is now at version 5.33.0.  The bug described in comments 15, 19 and 22 still exists.",
    "created_at": "2014-05-15T21:50:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170892",
    "user": "pbruin"
}
```

Maxima is now at version 5.33.0.  The bug described in comments 15, 19 and 22 still exists.



---

archive/issue_comments_170893.json:
```json
{
    "body": "I found a patch that I think has the same effect as the workaround in comment:22.  I don't have a sourceforge account, so here it is in case there are any Maxima experts here who want to check it and (if it is any good) maybe forward it to the Maxima bug tracking system:\n\n```diff\n--- a/share/linearalgebra/matrixexp.lisp        2013-10-07 04:37:12.000000000 +0100\n+++ b/share/linearalgebra/matrixexp.lisp        2014-05-16 02:16:09.112011893 +0100\n@@ -138,8 +138,8 @@\n           (print `(ratvars = ,$ratvars gcd = '$gcd algebraic = ,$algebraic))\n           (print `(ratfac = ,$ratfac))\n           (merror \"Unable to find the spectrum\")))\n-   \n-    (setq res ($fullratsimp (ncpower (sub (mult z ($ident n)) mat) -1) z))\n+\n+    (setq res ($fullratsimp ($invert (sub (mult z ($ident n)) mat) '$crering) z))\n     (setq m (length sp))\n     (dotimes (i m)\n       (setq zi (nth i sp))\n```\n\nI'll try to see if upgrading to 5.33.0 gives any further unexpected problems.",
    "created_at": "2014-05-16T03:18:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170893",
    "user": "pbruin"
}
```

I found a patch that I think has the same effect as the workaround in comment:22.  I don't have a sourceforge account, so here it is in case there are any Maxima experts here who want to check it and (if it is any good) maybe forward it to the Maxima bug tracking system:

```diff
--- a/share/linearalgebra/matrixexp.lisp        2013-10-07 04:37:12.000000000 +0100
+++ b/share/linearalgebra/matrixexp.lisp        2014-05-16 02:16:09.112011893 +0100
@@ -138,8 +138,8 @@
           (print `(ratvars = ,$ratvars gcd = '$gcd algebraic = ,$algebraic))
           (print `(ratfac = ,$ratfac))
           (merror "Unable to find the spectrum")))
-   
-    (setq res ($fullratsimp (ncpower (sub (mult z ($ident n)) mat) -1) z))
+
+    (setq res ($fullratsimp ($invert (sub (mult z ($ident n)) mat) '$crering) z))
     (setq m (length sp))
     (dotimes (i m)
       (setq zi (nth i sp))
```

I'll try to see if upgrading to 5.33.0 gives any further unexpected problems.



---

archive/issue_comments_170894.json:
```json
{
    "body": "> I found a patch that I think has the same effect as the workaround in comment:22.  I don't have a sourceforge account, so here it is in case there are any Maxima experts here who want to check it and (if it is any good) maybe forward it to the Maxima bug tracking system:\n\nI have added it to the [bug report in question](https://sourceforge.net/p/maxima/bugs/2596/).\n> I'll try to see if upgrading to 5.33.0 gives any further unexpected problems.\nLet's hope not!",
    "created_at": "2014-05-16T13:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170894",
    "user": "kcrisman"
}
```

> I found a patch that I think has the same effect as the workaround in comment:22.  I don't have a sourceforge account, so here it is in case there are any Maxima experts here who want to check it and (if it is any good) maybe forward it to the Maxima bug tracking system:

I have added it to the [bug report in question](https://sourceforge.net/p/maxima/bugs/2596/).
> I'll try to see if upgrading to 5.33.0 gives any further unexpected problems.
Let's hope not!



---

archive/issue_comments_170895.json:
```json
{
    "body": "Thanks!  No major problems so far; there is one integration doctest that does not finish, but Maxima itself returns the answer quickly, so the timeout has to occur in the interface.",
    "created_at": "2014-05-16T14:14:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170895",
    "user": "pbruin"
}
```

Thanks!  No major problems so far; there is one integration doctest that does not finish, but Maxima itself returns the answer quickly, so the timeout has to occur in the interface.



---

archive/issue_comments_170896.json:
```json
{
    "body": "The problematic doctest is the following one from `sage/misc/functional.py`:\n\n```\nsage: f = exp(-x) * sinh(sqrt(x))\nsage: t = integrate(f, x, 0, Infinity)\n```\n\nWith an unpatched Sage 6.2 this does finish, but takes a very long time (2-3 minutes).  The same situation occurs for\n\n```\nsage: maxima('integrate(exp(-x)*sinh(sqrt(x)), x, 0, inf);')\n```\n\n\nThis is surprising given that the following takes less than a second in Maxima (both the one that comes with Sage and a standalone copy, and both versions 5.29.1 and 5.33.0):\n\n```\n(%i1) integrate(exp(-x)*sinh(sqrt(x)), x, 0, inf); \n(%o1) \n    1/4                                              1\n  %e    (2 gamma_incomplete(1, 1) - gamma_incomplete(-, 1) - sqrt(%pi) - 2)\n                                                     2\n- -------------------------------------------------------------------------\n                                      4\n                                    1/4                  1\n     1/4                          %e    gamma_incomplete(-, 1)\n   %e    gamma_incomplete(1, 1)                          2\n + ---------------------------- - ----------------------------\n                2                              4\n     1/4               1/4\n   %e    sqrt(%pi)   %e\n + --------------- - -----\n          4            2\n```\n\nIt would seem to be an interface problem that already exists in some form in Sage 6.2 and manifests itself more relentlessly with the Maxima 5.33.0 spkg I am making.",
    "created_at": "2014-05-16T15:14:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170896",
    "user": "pbruin"
}
```

The problematic doctest is the following one from `sage/misc/functional.py`:

```
sage: f = exp(-x) * sinh(sqrt(x))
sage: t = integrate(f, x, 0, Infinity)
```

With an unpatched Sage 6.2 this does finish, but takes a very long time (2-3 minutes).  The same situation occurs for

```
sage: maxima('integrate(exp(-x)*sinh(sqrt(x)), x, 0, inf);')
```


This is surprising given that the following takes less than a second in Maxima (both the one that comes with Sage and a standalone copy, and both versions 5.29.1 and 5.33.0):

```
(%i1) integrate(exp(-x)*sinh(sqrt(x)), x, 0, inf); 
(%o1) 
    1/4                                              1
  %e    (2 gamma_incomplete(1, 1) - gamma_incomplete(-, 1) - sqrt(%pi) - 2)
                                                     2
- -------------------------------------------------------------------------
                                      4
                                    1/4                  1
     1/4                          %e    gamma_incomplete(-, 1)
   %e    gamma_incomplete(1, 1)                          2
 + ---------------------------- - ----------------------------
                2                              4
     1/4               1/4
   %e    sqrt(%pi)   %e
 + --------------- - -----
          4            2
```

It would seem to be an interface problem that already exists in some form in Sage 6.2 and manifests itself more relentlessly with the Maxima 5.33.0 spkg I am making.



---

archive/issue_comments_170897.json:
```json
{
    "body": "Replying to [comment:32 pbruin]:\n> The problematic doctest is the following one from `sage/misc/functional.py`:\n> {{{\n> sage: f = exp(-x) * sinh(sqrt(x))\n> sage: t = integrate(f, x, 0, Infinity)\n> }}}\n> With an unpatched Sage 6.2 this does finish, but takes a very long time (2-3 minutes).  The same situation occurs for\n> {{{\n> sage: maxima('integrate(exp(-x)*sinh(sqrt(x)), x, 0, inf);')\n> }}}\n> \n> This is surprising given that the following takes less than a second in Maxima (both the one that comes with Sage and a standalone copy, and both versions 5.29.1 and 5.33.0):\n\nI am not at all convinced it is the interface problem. It is more likely the Maxima packages loaded by default in Sage library (see the corr. Sage source files) and not loaded in your test run. When I only `load(abs_integrate)` i Sage's 6.2 Maxima, or don't load anything at all, I get an almost instant answer.\nWhen I load the whole bunch from lines 142-4 of `sage/interfaces/maxima_lib.py`\n\n```\ninit_code = ['display2d : false', 'domain : complex', 'keepfloat : true',\n            'load(to_poly_solve)', 'load(simplify_sum)',\n            'load(abs_integrate)']\n```\n\nit goes much slower.",
    "created_at": "2014-05-16T15:38:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170897",
    "user": "dimpase"
}
```

Replying to [comment:32 pbruin]:
> The problematic doctest is the following one from `sage/misc/functional.py`:
> {{{
> sage: f = exp(-x) * sinh(sqrt(x))
> sage: t = integrate(f, x, 0, Infinity)
> }}}
> With an unpatched Sage 6.2 this does finish, but takes a very long time (2-3 minutes).  The same situation occurs for
> {{{
> sage: maxima('integrate(exp(-x)*sinh(sqrt(x)), x, 0, inf);')
> }}}
> 
> This is surprising given that the following takes less than a second in Maxima (both the one that comes with Sage and a standalone copy, and both versions 5.29.1 and 5.33.0):

I am not at all convinced it is the interface problem. It is more likely the Maxima packages loaded by default in Sage library (see the corr. Sage source files) and not loaded in your test run. When I only `load(abs_integrate)` i Sage's 6.2 Maxima, or don't load anything at all, I get an almost instant answer.
When I load the whole bunch from lines 142-4 of `sage/interfaces/maxima_lib.py`

```
init_code = ['display2d : false', 'domain : complex', 'keepfloat : true',
            'load(to_poly_solve)', 'load(simplify_sum)',
            'load(abs_integrate)']
```

it goes much slower.



---

archive/issue_comments_170898.json:
```json
{
    "body": "Thanks!  In fact it seems to be the `domain : complex` setting that is causing the slowness.",
    "created_at": "2014-05-16T15:44:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170898",
    "user": "pbruin"
}
```

Thanks!  In fact it seems to be the `domain : complex` setting that is causing the slowness.



---

archive/issue_comments_170899.json:
```json
{
    "body": "How about the minimal workaround of temporarily setting `domain: real` in this doctest?",
    "created_at": "2014-05-16T15:55:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170899",
    "user": "pbruin"
}
```

How about the minimal workaround of temporarily setting `domain: real` in this doctest?



---

archive/issue_comments_170900.json:
```json
{
    "body": "Replying to [comment:35 pbruin]:\n> How about the minimal workaround of temporarily setting `domain: real` in this doctest?\n\nsure, this is not the 1st time something like this is needed.",
    "created_at": "2014-05-17T08:27:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170900",
    "user": "dimpase"
}
```

Replying to [comment:35 pbruin]:
> How about the minimal workaround of temporarily setting `domain: real` in this doctest?

sure, this is not the 1st time something like this is needed.



---

archive/issue_comments_170901.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-05-17T11:28:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170901",
    "user": "pbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_170902.json:
```json
{
    "body": "Note about the patches: `maxima_bug_2526.patch`, which fixes http://sourceforge.net/p/maxima/bugs/2526/, is still necessary even though the bug is marked \"closed\" in the Maxima bug tracking system; the commit somehow didn't make it into the Maxima repository.",
    "created_at": "2014-05-17T14:00:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170902",
    "user": "pbruin"
}
```

Note about the patches: `maxima_bug_2526.patch`, which fixes http://sourceforge.net/p/maxima/bugs/2526/, is still necessary even though the bug is marked "closed" in the Maxima bug tracking system; the commit somehow didn't make it into the Maxima repository.



---

archive/issue_comments_170903.json:
```json
{
    "body": "\n```\nsage -t --long src/sage/interfaces/maxima_lib.py\n**********************************************************************\nFile \"src/sage/interfaces/maxima_lib.py\", line 702, in sage.interfaces.maxima_lib.MaximaLib.sr_integral\nFailed example:\n    integrate(cos(x + abs(x)), x)\nExpected:\n    -1/4*(2*x - sin(2*x))*realpart(sgn(x)) + 1/2*x + 1/4*sin(2*x)\nGot:\n    -1/4*(2*x - sin(2*x))*real_part(sgn(x)) + 1/2*x + 1/4*sin(2*x)\n**********************************************************************\n```\n\n\nThis is with Volker's current `develop` branch on github (`d409685`), which includes a few dozens new tickets compared to `6.3.beta1`.",
    "created_at": "2014-05-23T12:46:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170903",
    "user": "mmezzarobba"
}
```


```
sage -t --long src/sage/interfaces/maxima_lib.py
**********************************************************************
File "src/sage/interfaces/maxima_lib.py", line 702, in sage.interfaces.maxima_lib.MaximaLib.sr_integral
Failed example:
    integrate(cos(x + abs(x)), x)
Expected:
    -1/4*(2*x - sin(2*x))*realpart(sgn(x)) + 1/2*x + 1/4*sin(2*x)
Got:
    -1/4*(2*x - sin(2*x))*real_part(sgn(x)) + 1/2*x + 1/4*sin(2*x)
**********************************************************************
```


This is with Volker's current `develop` branch on github (`d409685`), which includes a few dozens new tickets compared to `6.3.beta1`.



---

archive/issue_comments_170904.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-05-23T12:46:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170904",
    "user": "mmezzarobba"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_170905.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-23T13:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170905",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_170906.json:
```json
{
    "body": "Thanks, that must be a consequence of #16224.",
    "created_at": "2014-05-23T13:05:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170906",
    "user": "pbruin"
}
```

Thanks, that must be a consequence of #16224.



---

archive/issue_comments_170907.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-05-23T13:05:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170907",
    "user": "pbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_170908.json:
```json
{
    "body": "> Thanks, that must be a consequence of #16224.\nSo... did we have an incorrect translation of Maxima's `realpart` all along?  Interesting.",
    "created_at": "2014-05-23T13:46:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170908",
    "user": "kcrisman"
}
```

> Thanks, that must be a consequence of #16224.
So... did we have an incorrect translation of Maxima's `realpart` all along?  Interesting.



---

archive/issue_comments_170909.json:
```json
{
    "body": "Is there a reason for no longer using `z...` in the following test?\n\n\n```\n@@ -9231,7 +9231,7 @@ cdef class Expression(CommutativeRingElement):\n             sage: from sage.calculus.calculus import maxima\n             sage: sol = maxima(cos(x)==0).to_poly_solve(x)\n             sage: sol.sage()\n-            [[x == -1/2*pi + 2*pi*z...], [x == 1/2*pi + 2*pi*z...]]\n+            [[x == 1/2*pi + pi*z82]]\n \n         If a returned unsolved expression has a denominator, but the\n         original one did not, this may also be true::\n```\n\n\nThe same comment may apply to `z[0-9]+` in \n\n```\nsrc/sage/interfaces/maxima_lib.py:            [[x == pi*z54]]\nsrc/sage/symbolic/relation.py:        [[x == 1/4*pi + pi*z80, y == -1/4*pi - pi*z80]]\n```\n\n\nThe bugs listed in the description indeed appear to be fixed with the update, **except** #13733, for which I get:\n\n```\nsage: integral(log(cot(x)-1),x,0,pi/4)\n...\nRuntimeError: ECL says: Error executing code in Maxima: PSLOG: internal error.\n```\n\n\nOtherwise looks good to me.",
    "created_at": "2014-05-23T15:11:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170909",
    "user": "mmezzarobba"
}
```

Is there a reason for no longer using `z...` in the following test?


```
@@ -9231,7 +9231,7 @@ cdef class Expression(CommutativeRingElement):
             sage: from sage.calculus.calculus import maxima
             sage: sol = maxima(cos(x)==0).to_poly_solve(x)
             sage: sol.sage()
-            [[x == -1/2*pi + 2*pi*z...], [x == 1/2*pi + 2*pi*z...]]
+            [[x == 1/2*pi + pi*z82]]
 
         If a returned unsolved expression has a denominator, but the
         original one did not, this may also be true::
```


The same comment may apply to `z[0-9]+` in 

```
src/sage/interfaces/maxima_lib.py:            [[x == pi*z54]]
src/sage/symbolic/relation.py:        [[x == 1/4*pi + pi*z80, y == -1/4*pi - pi*z80]]
```


The bugs listed in the description indeed appear to be fixed with the update, **except** #13733, for which I get:

```
sage: integral(log(cot(x)-1),x,0,pi/4)
...
RuntimeError: ECL says: Error executing code in Maxima: PSLOG: internal error.
```


Otherwise looks good to me.



---

archive/issue_comments_170910.json:
```json
{
    "body": "Replying to [comment:45 mmezzarobba]:\n> Is there a reason for no longer using `z...` in the following test?\nMostly readability (since the tests are also part of the documentation); with the `...` it is not clear that it is just a \"serial number\" and not part of a larger expression that has been left out.  Of course it is somewhat random, so it may change once in a while with Maxima upgrades or changes in other doctests in the same file.  I personally think displaying a complete answer is worth the trouble of having to change it every now and then, but if you insist I can change all such examples to `...`.\n> The bugs listed in the description indeed appear to be fixed with the update, **except** #13733, for which I get:\n> {{{\n> sage: integral(log(cot(x)-1),x,0,pi/4)\n> ...\n> RuntimeError: ECL says: Error executing code in Maxima: PSLOG: internal error.\n> }}}\nYou're right; I tested this inside Maxima (`sage --maxima`), but Sage loads additional packages.  In this case the failure is caused by loading `abs_integrate`.  Using 5.33.0:\n\n```\n$ sage --maxima\n...\n(%i1) display2d: false$\n\n(%i2) integrate(log(cot(x)-1),x,0,%pi/4);\n\n(%o2) (%i*li[2]((%i+1)/2)-%i*li[2](-(%i-1)/2))/2\n -(%i*(2*li[2](%i+1)-2*li[2](1-%i))+%pi*log(2))/4\n(%i3) load(abs_integrate)$\n\n(%i4) integrate(log(cot(x)-1),x,0,%pi/4);\n\nlog: encountered log(0).\nlog: encountered log(0).\nlog: encountered log(0).\nlog: encountered log(0).\nlog: encountered log(0).\nlog: encountered log(0).\nlog: encountered log(0).\nlog: encountered log(0).\nlog: encountered log(0).\nPSLOG: internal error.\n -- an error. To debug this try: debugmode(true);\n```\n",
    "created_at": "2014-05-23T17:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170910",
    "user": "pbruin"
}
```

Replying to [comment:45 mmezzarobba]:
> Is there a reason for no longer using `z...` in the following test?
Mostly readability (since the tests are also part of the documentation); with the `...` it is not clear that it is just a "serial number" and not part of a larger expression that has been left out.  Of course it is somewhat random, so it may change once in a while with Maxima upgrades or changes in other doctests in the same file.  I personally think displaying a complete answer is worth the trouble of having to change it every now and then, but if you insist I can change all such examples to `...`.
> The bugs listed in the description indeed appear to be fixed with the update, **except** #13733, for which I get:
> {{{
> sage: integral(log(cot(x)-1),x,0,pi/4)
> ...
> RuntimeError: ECL says: Error executing code in Maxima: PSLOG: internal error.
> }}}
You're right; I tested this inside Maxima (`sage --maxima`), but Sage loads additional packages.  In this case the failure is caused by loading `abs_integrate`.  Using 5.33.0:

```
$ sage --maxima
...
(%i1) display2d: false$

(%i2) integrate(log(cot(x)-1),x,0,%pi/4);

(%o2) (%i*li[2]((%i+1)/2)-%i*li[2](-(%i-1)/2))/2
 -(%i*(2*li[2](%i+1)-2*li[2](1-%i))+%pi*log(2))/4
(%i3) load(abs_integrate)$

(%i4) integrate(log(cot(x)-1),x,0,%pi/4);

log: encountered log(0).
log: encountered log(0).
log: encountered log(0).
log: encountered log(0).
log: encountered log(0).
log: encountered log(0).
log: encountered log(0).
log: encountered log(0).
log: encountered log(0).
PSLOG: internal error.
 -- an error. To debug this try: debugmode(true);
```




---

archive/issue_comments_170911.json:
```json
{
    "body": "Replying to [comment:46 pbruin]:\n> Replying to [comment:45 mmezzarobba]:\n> > Is there a reason for no longer using `z...` in the following test?\n> Mostly readability (since the tests are also part of the documentation); with the `...` it is not clear that it is just a \"serial number\" and not part of a larger expression that has been left out.  Of course it is somewhat random, so it may change once in a while with Maxima upgrades or changes in other doctests in the same file.  I personally think displaying a complete answer is worth the trouble of having to change it every now and then, but if you insist I can change all such examples to `...`.\n\nNo, that's fine with me, I just wanted to make sure that it was intentional.",
    "created_at": "2014-05-23T17:46:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170911",
    "user": "mmezzarobba"
}
```

Replying to [comment:46 pbruin]:
> Replying to [comment:45 mmezzarobba]:
> > Is there a reason for no longer using `z...` in the following test?
> Mostly readability (since the tests are also part of the documentation); with the `...` it is not clear that it is just a "serial number" and not part of a larger expression that has been left out.  Of course it is somewhat random, so it may change once in a while with Maxima upgrades or changes in other doctests in the same file.  I personally think displaying a complete answer is worth the trouble of having to change it every now and then, but if you insist I can change all such examples to `...`.

No, that's fine with me, I just wanted to make sure that it was intentional.



---

archive/issue_comments_170912.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-05-23T17:46:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170912",
    "user": "mmezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_170913.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-05-25T17:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170913",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_170914.json:
```json
{
    "body": "> Note about the patches: `maxima_bug_2526.patch`, which fixes http://sourceforge.net/p/maxima/bugs/2526/, is still necessary even though the bug is marked \"closed\" in the Maxima bug tracking system; the commit somehow didn't make it into the Maxima repository.\n\nOkay, this is [finally in Maxima](http://sourceforge.net/p/maxima/bugs/2526/?limit=10&page=1#4cee), so the next Maxima upgrade will get to remove this patch.",
    "created_at": "2014-06-04T13:40:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170914",
    "user": "kcrisman"
}
```

> Note about the patches: `maxima_bug_2526.patch`, which fixes http://sourceforge.net/p/maxima/bugs/2526/, is still necessary even though the bug is marked "closed" in the Maxima bug tracking system; the commit somehow didn't make it into the Maxima repository.

Okay, this is [finally in Maxima](http://sourceforge.net/p/maxima/bugs/2526/?limit=10&page=1#4cee), so the next Maxima upgrade will get to remove this patch.



---

archive/issue_comments_170915.json:
```json
{
    "body": "#14306 needs review.",
    "created_at": "2014-06-04T13:55:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13769",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13769#issuecomment-170915",
    "user": "kcrisman"
}
```

#14306 needs review.
