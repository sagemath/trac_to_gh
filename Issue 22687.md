# Issue 22687: cleaning of linbox for dense integer matrices

Issue created by migration from https://trac.sagemath.org/ticket/22924

Original creator: vdelecroix

Original creation time: 2017-05-02 06:18:45

CC:  cpernet dlucas

Keywords: linbox

Various cleaning to the linbox interface (`sage.libs.linbox`) and Sage dense integer matrices (`sage.matrix.matrix_integer_dense`).

- implement in pure Cython the interface to linbox in a new file `sage/libs/linbox/linbox_flint_interface.pyx`

- remove all mpz pointers from `Matrix_integer_dense` (that is the attributes
  `bint _initialized_mpz`, `mpz_t * _entrie` and `mpz_t ** _rows`) as
  well as the associated constructors/destructors (`int _init_mpz(self)`, `int _init_mpz_impl(self)`, `int _init_linbox(self)`, `void _dealloc_mpz(self)`)

- fix the following error

```
sage: matrix(ZZ, 2).det(algorithm='padic')
Traceback (most recent call last):
...
ImportError: No module named matrix_integer_dense_hnf
```


- add more examples and tests to the documentation


---

Comment by vdelecroix created at 2017-05-02 06:20:46

New commits:


---

Comment by git created at 2017-05-02 07:40:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-05-02 07:44:43

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2017-05-02 10:53:34

Changing component from PLEASE CHANGE to packages: standard.


---

Comment by git created at 2017-05-03 05:59:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-05-03 11:33:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-05-03 12:16:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-05-03 12:16:56

(rebased on 8.0.b4)


---

Comment by cpernet created at 2017-05-04 06:03:35

Great.
Let's start with a few remarks:
 1. Why do need the dependency on #22886 ? That ticket is stalled and is therefore also blocking this one.
 2. While we are changing a lot of stuff, I wouldn't mind getting rid of these ugly `poly_linbox` method, with a string parameter `typ` that determines whether to compute minpoly or charpoly. We should rather only have the 2 methods `_minpoly_linbox_` and `_charpoly_linbox_`. There is not much duplicated code between these two, especially now after this clean-up.


---

Comment by vdelecroix created at 2017-05-04 06:44:37

Replying to [comment:10 cpernet]:
> Great.

Thanks for having a look!

> Let's start with a few remarks:
>  1. Why do need the dependency on #22886 ? That ticket is stalled and is therefore also blocking this one.

I think that Cython compilation fails otherwise (I am trying again right now on top of 8.0.beta4... will take some time since I need to recompile the whole Sage after playing with #22493).

>  2. While we are changing a lot of stuff, I wouldn't mind getting rid of these ugly `poly_linbox` method, with a string parameter `typ` that determines whether to compute minpoly or charpoly. We should rather only have the 2 methods `_minpoly_linbox_` and `_charpoly_linbox_`. There is not much duplicated code between these two, especially now after this clean-up.

The ticket only intends to clean `matrix_integer_dense.pyx`. The two functions you mention are actually removed from `matrix/matrix_integer_dense.pyx` but kept in `libs/linbox/linbox_flint_interface.pyx` (but note that the argument there is an integer). I can get rid of the following function in the interface

```
# set p to the minpoly or the charpoly of A
cdef inline void linbox_fmpz_mat_poly(fmpz_poly_t p, fmpz_mat_t A, int minpoly)
```

Is that what you want?


---

Comment by cpernet created at 2017-05-04 07:09:11

Replying to [comment:12 vdelecroix]:
>  I can get rid of the following function in the interface
> {{{
> # set p to the minpoly or the charpoly of A
> cdef inline void linbox_fmpz_mat_poly(fmpz_poly_t p, fmpz_mat_t A, int minpoly)
> }}}
> Is that what you want?
Ok sorry for the confusion. My remark indeed applies to the new `libs/linbox_flint_interface.pyx`.
Sure, it should definitely not be exposed through the new interface as it is an internal trick to factor out code. Then I also suggest to avoid this trick and simply write the two methods for the sake of clarity.


---

Comment by git created at 2017-05-04 07:29:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-05-04 07:30:36

No dependency on #22886 anymore (it is needed for cylinbox but it is fine for this ticket).

I cleaned the flint interface a bit more than what you asked for.


---

Comment by vdelecroix created at 2017-05-04 07:39:45

I was wrong (and you were right). There is still `def _poly_linbox(self, typ, var='x'):` as a method of `Matrix_integer_dense`.


---

Comment by vdelecroix created at 2017-05-04 08:00:06

By the way, I am adding tests and LinBox has trouble with the characteristic polynomial of the `0 x 0` matrix

```
sage: matrix([]).charpoly('y', 'linbox')
Traceback (most recent call last):
...
MemoryError: failed to allocate 2305843008945258512 bytes
```

Does it qualify as a bug? For now, I will add a special case in the interface LinBox/flint.

EDIT: and it hangs forever for `minpoly`.


---

Comment by vdelecroix created at 2017-05-04 08:08:22

For `minpoly` it is written

```
        .. NOTE::

           Linbox charpoly disabled on 64-bit machines, since it hangs
           in many cases.
```

However, I do not see where this actually happens in the code. Do you know what this is?


---

Comment by vdelecroix created at 2017-05-04 08:17:41

Un petit timing

```
sage: m = random_matrix(ZZ, 50)
sage: %timeit m._clear_cache(); p = m.charpoly(algorithm='linbox')
100 loops, best of 3: 16.8 ms per loop
sage: %timeit m._clear_cache(); p = m.charpoly(algorithm='flint')
10 loops, best of 3: 44.2 ms per loop
sage: %timeit m._clear_cache(); p = m.charpoly(algorithm='generic')
10 loops, best of 3: 152 ms per loop
```



---

Comment by git created at 2017-05-04 08:18:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2017-05-04 08:19:34

All right: `Matrix_integer_dense` cleaned and interface fixed on corner cases with commit `fde1353`.


---

Comment by vdelecroix created at 2017-05-04 09:37:33

And patchbot is happy (excepted some timeout I am not responsible for).


---

Comment by cpernet created at 2017-05-09 14:44:47

Replying to [comment:18 vdelecroix]:
> For `minpoly` it is written
> {{{
>         .. NOTE::
> 
>            Linbox charpoly disabled on 64-bit machines, since it hangs
>            in many cases.
> }}}
> However, I do not see where this actually happens in the code. Do you know what this is?

It's a super old comment. Some archeology on trac tickets should tell where it comes from but it's safe to remove it.


---

Comment by cpernet created at 2017-05-09 14:47:17

There are a couple of warnings that one could avoid:

```
[sagelib-8.0.beta4] warning: sage/rings/finite_rings/element_givaro.pyx:313:49: local variable 'res' referenced before assignment
[sagelib-8.0.beta4] warning: sage/rings/finite_rings/element_givaro.pyx:389:46: local variable 'res' referenced before assignment
[sagelib-8.0.beta4] warning: sage/rings/finite_rings/element_givaro.pyx:394:42: local variable 'res' referenced before assignment
[sagelib-8.0.beta4] warning: sage/rings/finite_rings/element_givaro.pyx:398:42: local variable 'res' referenced before assignment
[sagelib-8.0.beta4] warning: sage/rings/finite_rings/element_givaro.pyx:498:34: local variable 'g' referenced before assignment
[sagelib-8.0.beta4] warning: sage/rings/finite_rings/element_givaro.pyx:532:32: local variable 'r' referenced before assignment
[sagelib-8.0.beta4] warning: sage/rings/finite_rings/element_givaro.pyx:534:16: local variable 'r' referenced before assignment
[sagelib-8.0.beta4] warning: sage/rings/finite_rings/element_givaro.pyx:562:30: local variable 'r' referenced before assignment
[sagelib-8.0.beta4] warning: sage/rings/finite_rings/element_givaro.pyx:564:16: local variable 'r' referenced before assignment
[sagelib-8.0.beta4] warning: sage/rings/finite_rings/element_givaro.pyx:717:33: local variable 'r' referenced before assignment
[sagelib-8.0.beta4] warning: sage/rings/finite_rings/element_givaro.pyx:736:33: local variable 'r' referenced before assignment
[sagelib-8.0.beta4] warning: sage/rings/finite_rings/element_givaro.pyx:756:35: local variable 'r' referenced before assignment
[sagelib-8.0.beta4] warning: sage/rings/finite_rings/element_givaro.pyx:1110:39: local variable 'r' referenced before assignment
[sagelib-8.0.beta4] warning: sage/rings/finite_rings/element_givaro.pyx:1127:39: local variable 'r' referenced before assignment
[sagelib-8.0.beta4] warning: sage/rings/finite_rings/element_givaro.pyx:1150:39: local variable 'r' referenced before assignment
[sagelib-8.0.beta4] warning: sage/rings/finite_rings/element_givaro.pyx:1167:39: local variable 'r' referenced before assignment
[sagelib-8.0.beta4] warning: sage/rings/finite_rings/element_givaro.pyx:1184:39: local variable 'r' referenced before assignment
[sagelib-8.0.beta4] warning: sage/rings/finite_rings/element_givaro.pyx:1217:35: local variable 'r' referenced before assignment
[sagelib-8.0.beta4] warning: sage/rings/finite_rings/element_givaro.pyx:1218:59: local variable 'r' referenced before assignment
[
```

Basically, the variables are passed as "out" arguments, and cython complains that they are not initialized. It is safe to force their value to 0 at declaration (e.g. `int res = 0;`) and this would silence out the warning.


---

Comment by cpernet created at 2017-05-09 14:52:07

Replying to [comment:17 vdelecroix]:
> By the way, I am adding tests and LinBox has trouble with the characteristic polynomial of the `0 x 0` matrix
> {{{
> sage: matrix([]).charpoly('y', 'linbox')
> Traceback (most recent call last):
> ...
> MemoryError: failed to allocate 2305843008945258512 bytes
> }}}
> Does it qualify as a bug? For now, I will add a special case in the interface LinBox/flint.
> 
> EDIT: and it hangs forever for `minpoly`.

This is definitely a bug. Reported upstream: [https://github.com/linbox-team/linbox/issues/51](https://github.com/linbox-team/linbox/issues/51)


---

Comment by cpernet created at 2017-05-09 15:36:58

In `linbox_flint_interface.pyx` lines 84 and 157, you seem to use the method `size` of `givvector` to get the degree of the corresponding polynomial. While this is very likely to be correct in the current code, the specification do not require that the size of the vector storing the polynomial is ajusted to its degree. One should rather use `Givaro::Poly1Dom::degree()` instead.


---

Comment by vdelecroix created at 2017-05-09 18:41:22

Replying to [comment:25 cpernet]:
> There are a couple of warnings that one could avoid:
> {{{
> [sagelib-8.0.beta4] warning: sage/rings/finite_rings/element_givaro.pyx:313:49: local variable 'res' referenced before assignment
> ...
> }}}
> Basically, the variables are passed as "out" arguments, and cython complains that they are not initialized. It is safe to force their value to 0 at declaration (e.g. `int res = 0;`) and this would silence out the warning.

Yes, but these warnings have nothing to do with this ticket. Feel free to open another one to deal with `rings/finite_rings` (and put me in cc if you do).


---

Comment by vdelecroix created at 2017-05-09 19:29:21

Replying to [comment:27 cpernet]:
> In `linbox_flint_interface.pyx` lines 84 and 157, you seem to use the method `size` of `givvector` to get the degree of the corresponding polynomial. While this is very likely to be correct in the current code, the specification do not require that the size of the vector storing the polynomial is ajusted to its degree. One should rather use `Givaro::Poly1Dom::degree()` instead.

In LinBox code there are two occurrences of `v.size()` in `examples/charpoly.C` for a `const Polynomial &v` (lines 47 and 57). Idem in `examples/minpoly.C` (line 36). Are these also wrong?

How am I supposed to use `degree`? I was able to do it 7 lines in Cython... it looks extremely complicated to get such elementary quantity.

```
cdef GivaroIntegerRing ZZ
cdef GivaroDegree deg
cdef LinBoxIntegerPolynomialRing * R
R = new LinBoxIntegerPolynomialRing(ZZ)
R.degree(deg, q)
del R
cdef size_t length = deg.value() + 1
```



---

Comment by git created at 2017-05-09 19:37:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2017-05-09 19:38:26

I implemented your remarks. Though, I do not think that `6b45893` is reasonable.


---

Comment by cpernet created at 2017-05-09 20:01:15

Replying to [comment:31 vdelecroix]:
> I implemented your remarks. Though, I do not think that `6b45893` is reasonable.

Ok this seems indeed quite tedious. After browsing through the current use of size() for degree in LinBox, I would say it's rather safe to assume that the vector has been resized and therefore that the `size` method would return the degree. I was probably being too pedantic, sorry. I suggest to drop `6b45893`.


---

Comment by cpernet created at 2017-05-09 20:02:30

Replying to [comment:28 vdelecroix]:
> Yes, but these warnings have nothing to do with this ticket. Feel free to open another one to deal with `rings/finite_rings` (and put me in cc if you do).
My bad, I thought they were introduced in your new code. Will open a new ticket


---

Comment by git created at 2017-05-09 20:11:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by cpernet created at 2017-05-09 20:12:05

Also, I see some new code not directly related to the subject of the ticket (e.g. in `_rational_kernel_flint`, `rational_kernel_iml`), but this is rather ok for me as it is documentation improvement on routines related to the ticket).


---

Comment by vdelecroix created at 2017-05-09 20:14:12

Replying to [comment:32 cpernet]:
> Replying to [comment:31 vdelecroix]:
> > I implemented your remarks. Though, I do not think that `6b45893` is reasonable.
> 
> Ok this seems indeed quite tedious. After browsing through the current use of size() for degree in LinBox, I would say it's rather safe to assume that the vector has been resized and therefore that the `size` method would return the degree. I was probably being too pedantic, sorry. I suggest to drop `6b45893`.

I dropped it.

It would be fine for me to use `degree` however it is horribly complicated. Why is there a class `Degree` that is a trivial wrapper around a `int64_t`? Why could we not use `degree` directly as a method of a polynomial?


---

Comment by vdelecroix created at 2017-05-09 20:15:45

Replying to [comment:35 cpernet]:
> Also, I see some new code not directly related to the subject of the ticket (e.g. in `_rational_kernel_flint`, `rational_kernel_iml`), but this is rather ok for me as it is documentation improvement on routines related to the ticket).

It is. `_rational_kernel_iml` now uses `fmpz_mat_to_mpz_array` that was introduced in the ticket.


---

Comment by cpernet created at 2017-05-10 05:37:33

Replying to [comment:28 vdelecroix]:
> Feel free to open another one to deal with `rings/finite_rings` (and put me in cc if you do).
Done in #22966.


---

Comment by cpernet created at 2017-05-10 06:05:07

Let me try an explanation for this mess (which I agree should be simplified):

Replying to [comment:36 vdelecroix]:
> Why is there a class `Degree` that is a trivial wrapper around a `int64_t`? 
I would have said: so as to deal with the degree of the 0 polynomial which is -1 and not size()-1=0 

> Why could we not use `degree` directly as a method of a polynomial?

I assume because in Givaro (and the whole LinBox ecosystem), the container (here `givvector` does not know about the semantic). It is the domain of computation (here `GivPoly1Dom` who does).


---

Comment by vdelecroix created at 2017-05-10 09:04:43

Replying to [comment:39 cpernet]:
> Let me try an explanation for this mess (which I agree should be simplified):
> 
> Replying to [comment:36 vdelecroix]:
> > Why is there a class `Degree` that is a trivial wrapper around a `int64_t`? 
> I would have said: so as to deal with the degree of the 0 polynomial which is -1 and not size()-1=0 

In LinBox you have `size(0) = 1`!? Why would you store the zero at all?

> > Why could we not use `degree` directly as a method of a polynomial?
> 
> I assume because in Givaro (and the whole LinBox ecosystem), the container (here `givvector` does not know about the semantic). It is the domain of computation (here `GivPoly1Dom` who does).

I see. This way is indeed more flexible.


---

Comment by vdelecroix created at 2017-05-10 09:05:07

Tell me if there are other improvements to be done on this ticket.


---

Comment by cpernet created at 2017-05-10 09:26:54

Replying to [comment:40 vdelecroix]:
> > I would have said: so as to deal with the degree of the 0 polynomial which is -1 and not size()-1=0 
> 
> In LinBox you have `size(0) = 1`!? Why would you store the zero at all?

My mistake. Givaro actually resizes the 0 polynomial to an empty vector, so `size-1` is always equal to the degree.

After a discussion with J-G. Dumas on the topic here are a few clarifications:
 * the degree can be accessed in two ways: 
    1. either through `Poly1Dom<..>::degree which silently resize the vector when there are leading zeros.
    2. direcrly by `P.size()-1`  when the programmer knows what she does and does not want to pay the price of a resize.

 So it's fine to do it with `size()-1` as in this ticket, since we know the polynomials handed by LinBox have correct size in this case.
 * The class `Degree` was meant to provide a distinct type than the int64_t returned by size, in order to avoid mixing both approaches. Still the class is not quite satisfactory for the moment (degree (0 + 0)=-2 != -1). This has been fixed upstream in [https://github.com/linbox-team/givaro/commit/756005d0be64c36513c57403b856d93fc43c8010](https://github.com/linbox-team/givaro/commit/756005d0be64c36513c57403b856d93fc43c8010)


---

Comment by cpernet created at 2017-05-10 09:33:06

Changing status from needs_review to positive_review.


---

Comment by cpernet created at 2017-05-10 09:33:06

Ok, the ticket is now fine for me. -> positive review.


---

Comment by cpernet created at 2017-05-10 12:53:51

Changing status from positive_review to needs_work.


---

Comment by cpernet created at 2017-05-10 12:53:51

Sorry, two minor documentation typos to be fixed in `src/sage/libs/linbox/linbox_flint_interface.pyx`: 
 * line 10 "linbox-Sage.C" -> "linbox-sage.C"
 * line 128 "preformed" -> "performed"
Back in needs work.


---

Comment by git created at 2017-05-11 06:33:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2017-05-11 06:34:29

Changing status from needs_work to needs_review.


---

Comment by cpernet created at 2017-05-11 07:02:53

Fine then, back to positive review.


---

Comment by cpernet created at 2017-05-11 07:02:53

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2017-05-11 09:37:44

Thanks for the review!


---

Comment by vbraun created at 2017-05-14 08:20:04

Resolution: fixed
