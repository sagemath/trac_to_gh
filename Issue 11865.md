# Issue 11865: `search_src` and friends shouldn't look in hidden files

Issue created by migration from Trac.

Original creator: ddrake

Original creation time: 2011-11-15 03:04:50

Assignee: jason

I'm currently editing a file in the Sage library, and emacs created a hidden file `.#plot.py` that, until I save `plot.py`, is a broken symlink. When I do `search_def`, I get:

```
IOError: [Errno 2] No such file or directory: '/scratch/sage-4.7.2/devel/sage/sage/plot/.#plot.py'
```

I think `search_src` and friends should just ignore hidden files, since no genuine source file in the Sage library is hidden!


---

Comment by jhpalmieri created at 2011-11-15 03:15:47

I've been annoyed about this too.  Something like this should do it:

```diff
diff --git a/sage/misc/sagedoc.py b/sage/misc/sagedoc.py
--- a/sage/misc/sagedoc.py
+++ b/sage/misc/sagedoc.py
`@``@` -695,6 +695,9 `@``@` You can build this with 'sage -docbuild 
     # done with preparation; ready to start search
     for dirpath, dirs, files in os.walk(os.path.join(base_path, module)):
         for f in files:
+            # if f matches some pattern because it's a temporary file, skip it:
+            if f.startswith('.#'):
+                continue
             if re.search("\.(" + "|".join(exts) + ")$", f):
                 filename = os.path.join(dirpath, f)
                 if re.search(path_re, filename):
```

But maybe a regular expression match for temporary files would be better, perhaps combined with the line "if re.search(...)".  Are there any patterns to ignore besides ".#..."?


---

Comment by ddrake created at 2011-11-15 03:35:23

Replying to [comment:1 jhpalmieri]:
> Are there any patterns to ignore besides ".#..."?

I would ignore all hidden files. Do we only look through `.py` and `.pyx` files? Because emacs also makes a `#plot.py#` file which we should ignore. I know vim makes `.foo.swp` files, and I don't know anything about any other editor.


---

Comment by kini created at 2011-11-15 04:20:18

I notice that `ls -B` (from GNU coreutils anyway) ignores files that end with "~". Not that `ls` has anything to do with `search_src()` in particular, but maybe we should consider ignoring those too since such a universal tool considers them ignore-worthy.


---

Comment by jhpalmieri created at 2011-11-15 04:47:21

As it is, the search functions only look at files ending in `.html` (for `search_doc`) or `['.py', '.pyx', '.pxd']` (for `search_src` and `search_def`).  So we don't need to worry about suffixes, just prefixes.


---

Comment by kini created at 2011-11-15 04:55:56

Ah, good point. Never mind then. This also means that looking for `^#(.*)#$` is unnecessary (emacs seems to produce these too, at least on my machine).


---

Attachment


---

Comment by ddrake created at 2011-11-15 04:59:53

Changing status from new to needs_review.


---

Comment by ddrake created at 2011-11-15 04:59:53

A one-line patch! Please review.

(John, I modified your example. Add yourself to the author field if you like.)

I tested this by creating a dangling symlink; I suppose I can make a doctest to test that, but that doesn't seem all that necessary. Should I do so anyway?


---

Comment by jhpalmieri created at 2011-11-15 18:12:19

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2011-11-15 18:12:19

How could you doctest this?


---

Comment by ddrake created at 2011-11-16 00:45:38

Replying to [comment:7 jhpalmieri]:
> How could you doctest this?

I'm not sure...create a hidden file with an unlikely string in it, do `search_src` for that string? Check it returns nothing? 

OTOH, I feel pretty confident about the code "`not f.startswith('.')`". So it seems reasonable to leave this one as it is.

Thanks for the review!


---

Comment by jdemeyer created at 2011-11-16 20:36:36

Resolution: fixed
