# Issue 15138: Extended Affine Iwahori Hecke Algebras SD40

Issue created by migration from Trac.

Original creator: bump

Original creation time: 2013-11-07 22:27:47

CC:  sage-combinat aschilling nthiery mshimo tscrim

Keywords: days54

This patch implemented Affine Iwahori Hecke Algebras was written during Sage Days 40. The original contributers were Daniel Bump, Dan Orr, Anne Schilling, Mark Shimozono, Nicolas Thiery.


---

Comment by bump created at 2013-11-07 22:33:41

Set assignee to bump.


---

Comment by bump created at 2013-11-07 22:33:41

Changing type from PLEASE CHANGE to enhancement.


---

Attachment

Implements Extended Affine Iwahori Hecke Algebras


---

Comment by aschilling created at 2014-02-04 06:42:39

New commits:


---

Comment by git created at 2014-02-07 18:44:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-02-12 14:44:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mshimo created at 2014-02-12 14:49:46

Doctests now pass


---

Comment by git created at 2014-02-13 04:28:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-03-25 15:01:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2014-04-04 15:55:51

Changing keywords from "days54" to "days54, coxeter".


---

Comment by git created at 2014-04-10 18:36:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-05-15 00:04:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-05-15 19:40:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-05-27 02:49:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-03-18 22:25:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aschilling created at 2015-03-18 22:30:39

Changing status from new to needs_review.


---

Comment by aschilling created at 2015-03-18 22:30:39

Changing keywords from "days54, coxeter" to "days54, coxeter, days64".


---

Comment by git created at 2015-03-18 23:56:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-03-19 00:45:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bump created at 2015-03-20 13:06:23

All tests in combinat/root_system pass.


---

Comment by bump created at 2015-03-24 22:28:24

We should add a line

`sage/combinat/root_system/extended_affine_weyl_group`

to `doc/en/reference/combinat/module_list.rst` to get the documentation
into the reference manual. However if we do this we get an error:


```
OSError: [combinat ] extended_affine_weyl_group.py:docstring of 
ExtendedAffineWeylGroup:11: 
ERROR: The "TOPIC" directive may not be used within topics or body elements.
```


I don't find TOPIC used very much in the sage documentation. I do find it used
in combinat/root_system/plot.py, which is a standalone tutorial. Maybe it
can't be used in a docstring. I hoped that changing TOPIC to RUBRIC would work, 
but I tried it and it doesn't.

I'm leaving the status "needs work" since the documentation needs to compile.

(Maybe the problem is the double colon after TOPIC. I don't have time to
try that now.)


---

Comment by bump created at 2015-03-24 22:28:24

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-03-26 19:30:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bump created at 2015-03-26 19:32:24

Changing status from needs_work to needs_review.


---

Comment by bump created at 2015-03-26 19:37:01

I removed the double colon after TOPIC so that the documentation builds. I also added extended_affine_weyl_group to reference/combinat/module_list and combinat/root_system/__init__.py.

As far as I know the patch is good now and I've changed the status back to needs review.


---

Comment by bump created at 2015-03-27 02:34:03

Changing status from needs_review to needs_work.


---

Comment by bump created at 2015-03-27 02:34:03

Since some docstrings don't have doctests I'm changing the status back to "needs work"


---

Comment by git created at 2015-04-21 04:33:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bump created at 2015-04-28 22:52:10

To facilitate review, here is a link to a build of documentation.

!http://sporadic.stanford.edu/reference1/combinat/sage/combinat/root_system/extended_affine_weyl_group.html


---

Comment by git created at 2015-04-28 22:57:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aschilling created at 2015-04-28 22:58:48

I rebased on the latest development version and will look what else needs to be done to finalize this patch!

Anne


---

Comment by aschilling created at 2015-04-29 03:44:36

Here are some comments on the patch. Mark, can you work on them so we can review them?

- There are several methods in `ExtendedAffineWeylGroup_Class` that do not have documentation or tests.

- I remember that we talked about this at Sage Days 64: can we get rid of `to_ambient` in all the various places?

- `fundamental_groups.py` also does not have full documentation coverage!

- Also

```
pyflakes extended_affine_weyl_group.py
extended_affine_weyl_group.py:940: undefined name 'Infinity'
```


- Many methods in `sage.groups.group_semidirect_product.py` have no documentation.

Best,

Anne


---

Comment by git created at 2015-04-29 03:45:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-05-28 13:39:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-05-31 10:04:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-05-31 18:13:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-01 07:21:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-10 16:46:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aschilling created at 2015-06-11 15:54:00

Hi Mark,

I see that `reflection_to_root` is changed in this branch. Did you rebase it on top of `http://trac.sagemath.org/ticket/18634`?

Anne


---

Comment by git created at 2015-06-11 16:18:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-11 16:37:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-11 17:22:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aschilling created at 2015-06-11 17:25:32

Please add what the INPUT is in the following methods in the extended_affine_weyl_group:

apply_simple_projection
coset_representative
face_data
action
translation_group_morphism
simple_reflection
bruhat_le

There are certain methods that occur multiple times with code that looks only
minimally different (for example in `has_descent` it looks like that only left and
right have changed). Could you explain why one needs the methods in each realization
separately rather than having one general one.

Same in src/sage/groups/group_exp.py. There are methods where some of the input needs to be explained.


---

Comment by aschilling created at 2015-06-12 20:52:01

Changing keywords from "days54, coxeter, days64" to "days54, coxeter, days64, days65".


---

Comment by git created at 2015-06-13 21:13:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mshimo created at 2015-06-13 21:38:35

Since certain methods are much more efficiently computed in certain realizations,
the generic implementation just consists of converting to the favorable
realization, doing the computation there using a custom implementation,
and then converting back. But since converting is often expensive, sometimes
a direct algorithm is given for more than one realization. This is the case for :meth:has_descent.


---

Comment by mshimo created at 2015-06-13 21:38:35

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-06-14 01:17:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aschilling created at 2015-06-14 01:54:03

Hi Mark,

I rebased your patch on top of sage-6.8.beta4. So please pull the changes before you keep editing!

I see this in the diff without a doc test and a comment:

```
diff --git a/src/sage/combinat/root_system/type_affine.py b/src/sage/combinat/root_system/type_affine.py
index f505c47..c19136e 100644
--- a/src/sage/combinat/root_system/type_affine.py
+++ b/src/sage/combinat/root_system/type_affine.py
`@``@` -419,6 +419,14 `@``@` class AmbientSpace(CombinatorialFreeModule):
         return vector(list(vector(classical._plot_projection(classical(x)))) +
                       [x["deltacheck"]])
 
+    def from_vector_notation(self, weight, style="lattice"):
+        """
+        ..TODO:: CHECK THIS STUPID DEFAULT IMPLEMENTATION WITH DAN
+
+        This is in particular used to compute demazure-lusztig characters
+        """
+        return weight
```

Can this be taken out?

When I tried the following, I got an error message

```
sage: E.inject_shorthands()
---------------------------------------------------------------------------
NotImplementedError                       Traceback (most recent call last)
<ipython-input-28-d05fc29a74b6> in <module>()
----> 1 E.inject_shorthands()

/Applications/sage/local/lib/python2.7/site-packages/sage/categories/sets_cat.pyc in inject_shorthands(self, verbose)
   2351                 from sage.misc.misc import inject_variable
   2352                 if not hasattr(self, "_shorthands"):
-> 2353                     raise NotImplementedError("no shorthands defined for {}".format(self))
   2354                 for shorthand in self._shorthands:
   2355                     realization = getattr(self, shorthand)()

NotImplementedError: no shorthands defined for Extended affine Weyl group of type ['A', 2, 1]
```

Do you want shorthands for all the realizations?

Similarly,

```
sage: E.group_generators()
---------------------------------------------------------------------------
NotImplementedError                       Traceback (most recent call last)
<ipython-input-44-d96974f8367c> in <module>()
----> 1 E.group_generators()

/Applications/sage/local/lib/python2.7/site-packages/sage/categories/groups.pyc in group_generators(self)
    108                 return Family(self.gens())
    109             except AttributeError:
--> 110                 raise NotImplementedError("no generators are implemented for this group")
    111 
    112         def monoid_generators(self):

NotImplementedError: no generators are implemented for this group
```


Best,

Anne


---

Comment by aschilling created at 2015-06-14 01:54:37

Changing status from needs_review to needs_work.


---

Comment by mshimo created at 2015-06-14 02:43:28

The rebasing weirdness is coming from someone else's code.

For shorthands, the realizations are created by the methods
PW0(), W0P(), WF(), FW(), PvW0(), and W0Pv().
Um, do you think this is insufficiently short?

Implementing generators is easy and I can add that.


---

Comment by aschilling created at 2015-06-14 02:55:13

Replying to [comment:56 mshimo]:
> The rebasing weirdness is coming from someone else's code.

You mean the method from_vector_notation? It looks like it belongs to
this patch, but it might be super old. Should we take it out?
 
> For shorthands, the realizations are created by the methods
> PW0(), W0P(), WF(), FW(), PvW0(), and W0Pv().
> Um, do you think this is insufficiently short?

Well, I just tried out methods that E.<tab> offered and many of them are not implemented.

> Implementing generators is easy and I can add that.

That would be good!

Dan, could you also do a final review of this patch? I think it is getting close to being ready.
>


---

Comment by bump created at 2015-06-14 13:56:18

I'll have a look.


---

Comment by git created at 2015-06-14 14:29:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-15 00:56:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mshimo created at 2015-06-15 00:59:00

The various realizations should now have a generators method.


---

Comment by git created at 2015-06-15 15:04:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mshimo created at 2015-06-15 15:11:52

I added a list method for the fundamental groups. I am not sure that I did this entirely correctly (that is, implementing the correct part of the category framework).
I just added a method and added finiteness information to the category.


---

Comment by aschilling created at 2015-06-15 15:15:10

Hi Mark,

Does this address my original question about

```
sage: E=ExtendedAffineWeylGroup(['A',2,1])
sage: E.group_generators()
```

or are you fixing something else?

Shall we remove `from_vector_notation`?

Best,

Anne


---

Comment by git created at 2015-06-15 15:58:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mshimo created at 2015-06-15 16:03:28

Get rid of from_vector_notation.

Group generators are not relevant for E.
E is not an actual realization.

E.PW0() is a group and so on.

The list method is related to finiteness
(saying "x in G" makes sense if G is a finite group, and iterating over x in G
uses the list method). I somehow got on the wrong
branch and unfixed some stuff and had to refix it.


---

Comment by mshimo created at 2015-06-15 16:04:49

As far as E.group_generators() is concerned, one could
call the default realization of E and invoke its "generators" method.


---

Comment by git created at 2015-06-15 17:52:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aschilling created at 2015-06-15 17:57:28

Replying to [comment:66 mshimo]:
> Get rid of from_vector_notation.

I got rid of it in my last commit.

> Group generators are not relevant for E.
> E is not an actual realization.
> 
> E.PW0() is a group and so on.

But even for that it does not work for me:

```
sage: E=ExtendedAffineWeylGroup(['A',2,1])
sage: PW0=E.PW0()
sage: PW0.group_generators()
---------------------------------------------------------------------------
NotImplementedError                       Traceback (most recent call last)
<ipython-input-3-d69de239d91b> in <module>()
----> 1 PW0.group_generators()

/Applications/sage/local/lib/python2.7/site-packages/sage/categories/groups.pyc in group_generators(self)
    108                 return Family(self.gens())
    109             except AttributeError:
--> 110                 raise NotImplementedError("no generators are implemented for this group")
    111 
    112         def monoid_generators(self):

NotImplementedError: no generators are implemented for this group
```



---

Comment by mshimo created at 2015-06-15 19:56:25

Sorry, I added a method "generators" not "group_generators". 
I think I did this to be consistent with the lattices
(such as weight lattices), which use "gens" not "group_generators".


---

Comment by aschilling created at 2015-06-15 21:31:12

Replying to [comment:70 mshimo]:
> Sorry, I added a method "generators" not "group_generators". 
> I think I did this to be consistent with the lattices
> (such as weight lattices), which use "gens" not "group_generators".

I would suggest to be consistent with what the category code asks for (in this case group_generators) since this method appears when one hits tab.completion! Otherwise it is confusing to the user.

Other than this, I will leave the final review to Dan!


---

Comment by git created at 2015-06-15 23:52:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mshimo created at 2015-06-15 23:54:16

I fixed the group_generators methods.
Note that I had to mess with sage.categories.finite_groups.


---

Comment by aschilling created at 2015-06-16 02:32:57

Replying to [comment:73 mshimo]:
> I fixed the group_generators methods.
> Note that I had to mess with sage.categories.finite_groups.

Ok, I am satisfied. Dan, could you please do a final review?


---

Comment by nthiery created at 2015-06-16 06:25:24

Replying to [comment:73 mshimo]:
> Note that I had to mess with sage.categories.finite_groups.

I double checked on this, and it is actually a cleanup. If this does not break tests elsewhere, I am happy with that change. Thanks!


---

Comment by nthiery created at 2015-06-16 07:32:59

Hi Mark!

I had a look at the fundamental group code. Thanks for the hard work!

Suggestions:

- Would it be possible to make the code more type-free, in particular
  the initialization? For example, it seems likely to break the
  current version if one uses a relabeled type BC.


- The logic for computing the special nodes would fit more naturally
  in Cartan types rather than here. Please implement that as a method
  `cartan_type.special_nodes()`.

  The special nodes form an orbit under the action of the automorphism
  group of the Dynkin diagram, right? If yes, then it would be enough
  to implement a generic method `CartanType_affine.special_nodes`,
  which would start from the special node as specified by
  `cartan_type.special_node()`, and take its orbit under the
  automorphism group of the Dynkin diagram. It's a small graph, so
  that's cheap enough.

- Maybe add a test that the Cartan type is indeed affine?

- Is the `_element_constructor_` needed at all?

- `lambda i: finite_action_dict[i]` -> `finite_action_dict.__getitem__`

- What about renaming `finite_action_dict`  to `reduced_words`?

- `om` -> `omega` (I believe that's what we use in the crystal code)

  in general, please avoid abbreviations, unless they correspond to
  standard one-letter mathematical notations.

- `..., finite = True)` -> `..., finite=True)`

- The code is currently assuming that the `0` is the "main" special
  node, right?  Please use `cartan_type.special_node()` instead.

- What about fusing the methods `family` and `group_generators`?
  `group_generators` should return a family anyway (unlike `gens`).

- If you put the group in `XXX.FinitelyGenerated()`, the list of
  elements will be recovered from the group generators (of course,
  here we have a more straightforward way of doing it, so that may, or
  not, be how we want to do this).

Thanks!


---

Comment by mshimo created at 2015-06-16 19:16:45

Nicolas, Thanks very much for your comments.

I need to know the reason behind using `cartan_type.special_node()`.

Let's call this the extra special node. For simplicity we assume untwisted
affine type. By deletion we obtain a subsystem of finite type.
If the extra special node is nonzero then the correct behavior is that
the "classical subsystem" should be a relabeling of the
appropriate standard classical subsystem
with 0 as one of the "finite" Dynkin nodes.
This nonstandard classical Dynkin node set will get propagated to
indices of simple roots and fundamental weights and to the
finite Weyl groups.  In particular we could see
t_{\omega_0^\vee} as a nontrivial translation element
and s_0 as an element of the finite Weyl group.
Do we really want this?

--Mark


---

Comment by nthiery created at 2015-06-16 20:59:47

Replying to [comment:77 mshimo]:
> Nicolas, Thanks very much for your comments.

You are welcome!

> I need to know the reason behind using `cartan_type.special_node()`.
> 
> Let's call this the extra special node. For simplicity we assume untwisted
> affine type. By deletion we obtain a subsystem of finite type.
> If the extra special node is nonzero then the correct behavior is that
> the "classical subsystem" should be a relabeling of the
> appropriate standard classical subsystem
> with 0 as one of the "finite" Dynkin nodes.
> This nonstandard classical Dynkin node set will get propagated to
> indices of simple roots and fundamental weights and to the
> finite Weyl groups.  In particular we could see
> t_{\omega_0^\vee} as a nontrivial translation element
> and s_0 as an element of the finite Weyl group.
> Do we really want this?

It's indeed nice to have 0 by default for the special node in the
canonical labeling of the Dynkin diagram, in order to follow the usual
conventions in the literature.

But other than that the code has been designed to be agnostic
w.r.t. the labels of the nodes of the Dynkin diagram. This gives the
user the flexibility to use his preferred labeling, without imposing a
given convention. Also it makes the code robust in potential use cases
like the following:

- The user inputs some Cartan matrix which turns out to be
  affine. There is no reason a priori that 0 will be a special node.
  (note: at some point we will need/want to implement the logic to
  recover some special node).

- We have a big KM Dynkin diagram, and we want to do some calculations
  involving a parabolic subgroup. Typically the corresponding Dynkin
  diagram is disconnected, and the calculation will boil down to the
  connected pieces. Those connected pieces could be affine Dynkin
  diagrams, but with labels like 3,4,5; still we might want to use
  it's fundamental group, etc ...

Cheers,
                               Nicolas


---

Comment by git created at 2015-06-16 22:51:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mshimo created at 2015-06-16 22:52:41

I added an __iter__ method because without it, doing things like ` [x for x in F] `
was not working. I also made F an EnumeratedSet when it is finite.


---

Comment by mshimo created at 2015-06-16 22:53:19

I mean ` __iter__`; the formatting lost the double underscores.


---

Comment by nthiery created at 2015-06-17 07:47:23

Good point. To avoid having both `__iter__` and `__list__` you can just do:


```
def __iter__(self):
    return iter(self.group_generators())
```


Note the use of `iter` rather than `for ... yield` (should be faster).

Also, default list method will already raise an error for you if the set is in `XXX.Infinite()`.

Thanks!


---

Comment by git created at 2015-06-17 12:29:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-17 12:44:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mshimo created at 2015-06-17 12:45:59

I added infinite and finite information to the categories of the extended affine Weyl groups and their fundamental groups. Thanks, Nicolas, for the programming help!


---

Comment by bump created at 2015-06-18 15:28:07

Nicolas, are you satisfied? (Can the status be changed back to needs_review?)


---

Comment by git created at 2015-06-18 16:05:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-18 16:31:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-18 17:07:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mshimo created at 2015-06-18 17:10:48

I think I am done messing with this ticket for now.
I added an explicit an_element method; the default one always gives the identity, which leads to less interesting example elements for doctests. So I did this and fixed the doctests.


---

Comment by git created at 2015-06-18 18:04:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-20 04:13:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by aschilling created at 2015-06-20 04:14:46

Changing status from needs_work to needs_review.


---

Comment by nthiery created at 2015-06-20 06:16:45

Hi Mark!

I have glanced half way through the patch. It's a lot of hard work you
did; thanks! I'll try to go through the over half soon, but won't have
the time for a systematic review, so please someone!

Here are some thoughts that popped up; take them as they just are:
random food for thoughts. If something does not sound applicable, just
ignore it.

- `weyl_groups.py` line 420,453: any reason to remove the test for s2s1s2s1?
- `RootSystem(XXX.cartan_type())` -> `XXX.cartan_type().root_system()`

- `def to_ambient_space_morphism`: you can use
  `sage.misc.c3_controlled.identity`. Yeah, there is no reason why the
  identity function is defined in this module; but at least if we all
  use the same identity function it will be easier to refactor later
  on.

  Variants, if you want a morphism: `End(self).identity()` or `sage:
  self.coerce_map_from(self)`,

- `..warning` -> `.. WARNING`

- In `to_weight_space`: instead of going through a vector, one can use
  `.sum_of_terms([i,self.scalar(alpha[i])] for ...`

  This method is generic and would better be in `WeightSpaceRealizations`.

- `to_ambient`

- `special_nodes`: any reason not to use `return autos.orbit(self.special_node())` ?

- `Nicolas Thiery` -> `Nicolas M. Thiery` for consistency

- Doc of `ExtendedAffineWeylGroup`: use `.. MATH` for the math
  formulas on their own line.

- `... the following lattices:`; idem for `E` below.

- When natural, put the `::` at the end of the sentence.

- Line folding could be more consistent

- There are still quite a few of `ifs` depending on
  twisted/untwisted/GL; any chance to make this more generic?

  For example, to define the special translation covector can't we
  generically use something like `c[special_node] *
  _special_root.associated_coroot()`? I never remember from the top of
  my head whether it's `c` or one of its friends that should be used
  here, but we did things like this in the MacDo code.

  Note that at this point the initialization of
  `ExtendedAffineWeylGroup_class` will probably break on a relabelled
  type BC.

- Do we need the `special_nodes` method on the group and the
  fundamental group? Or could just have it on the cartan type?

- Strip new lines just before and just after the end of the
  documentation string.

- `classical_weyl` -> `classical`? or `classical_weyl_group`?
  I don't remember what we did in similar situations for crystals
  and the like, but please check for consistency.

- `classical_weyl_to_affine_morphism`: the name is misleading since
  the result is not a morphism. Could we have a name like
  `from_classical` or make this an element method `to_affine`?
  Same for the related methods.

- `cardinality` is already provided by `Sets().Infinite()`

- `group_generators` this could in principle go in
  `Groups().WithRealizations()`. If creating the latter just for this
  seems like overkill, you can just add a comment about this.

- `...Realizations.ParentMethods.one`: replacing `PW0` by
  `a_realization` the code would be generic and could go in `Magmas.Unital.Realizations`.

- `Returns` -> `Return`

- `coset_representative, is_grassmanian, ...`: this is the same logic
  as for a usual coxeter group, right? Could we avoid the duplication
  by having a common super category?

- `get_the_index` -> `leading_support`?

- `FundamentalGroup...one`: `0` -> `special_node`

- `an_element`: you can probably use `.last()` (haven't tested)

  - `action`: maybe `representation`? Elsewhere in Sage, `action` is
    usually a method that implements the action itself.

- `root_lattice_realizations`: `Algebras` is now imported twice.


Cheers,
                            Nicolas


---

Comment by tscrim created at 2015-06-20 06:36:56

For Cartan types, it is simply `classical` and for crystals, it is `classical_object` (ex. `classical_weight`).


---

Comment by bump created at 2015-06-21 02:27:35

I looked at the patchbot shortlogs for the first three machines reporting build failure. They all report the same error:


```
OSError: [combinat ] /home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/combinat/root_system/extended_affine_weyl_group.py:docstring of sage.combinat.root_system.extended_affine_weyl_group.ExtendedAffineWeylGroup_Class.WF_to_PW0_func:11: ERROR: Content block expected for the "WARNING" directive; none found.
```


I think the "Since this is used ..." at line 1068 needs to be indented. Other bots are reporting a doctest error in dev_tools.py. 


```
**********************************************************************
File "src/sage/misc/dev_tools.py", line 459, in sage.misc.dev_tools.import_statements
Failed example:
    load_submodules(sage.sets)
Expected:
    load sage.sets.cartesian_product... succeeded
    load sage.sets.set_from_iterator... succeeded
Got:
    load sage.sets.real_set... succeeded
    load sage.sets.set_from_iterator... succeeded
**********************************************************************
```

I suspect this is unrelated to this patch. It may be caused by #18553 which was merged three weeks ago and which touched sage.sets.real_set.py.

However I think the above docstring needs to be fixed and since Nicolas has some comments I'm changing the status back to needs_work.


---

Comment by bump created at 2015-06-21 02:27:49

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-06-21 06:10:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-06-21 06:16:12

The `one()` method added to unital magmas will need a doctest.


---

Comment by mshimo created at 2015-06-21 06:19:36

It wouldn't let me push the fixed version so I made a copy of the existing ticket branch and merged it into my working branch. The result is broken. I am going to try to change the trac branch to a good one.
----
New commits:


---

Comment by mshimo created at 2015-06-21 06:55:48

Last 10 new commits:


---

Comment by mshimo created at 2015-06-21 07:02:07

Ugh. I clearly don't know how to use trac.


---

Comment by aschilling created at 2015-06-22 21:40:49

Replying to [comment:102 mshimo]:
> Ugh. I clearly don't know how to use trac.

What happened? It might happen that one cannot push if there is a change on the server that one has not pulled yet. Otherwise I would not know why this happens.

I get the following failure in sage/categories

```
sage -t realizations.py
**********************************************************************
File "realizations.py", line 44, in sage.categories.realizations.RealizationsCategory
Failed example:
    Groups().Realizations().super_categories()
Expected:
    [Category of groups, Category of realizations of magmas]
Got:
    [Category of groups, Category of realizations of unital magmas]
**********************************************************************
File "realizations.py", line 68, in sage.categories.realizations.Realizations
Failed example:
    Algebras(QQ).Realizations()
Expected:
    Join of Category of algebras over Rational Field and Category of realizations of magmas
Got:
    Join of Category of algebras over Rational Field and Category of realizations of unital magmas
**********************************************************************
2 items had failures:
   1 of   7 in sage.categories.realizations.Realizations
   1 of   5 in sage.categories.realizations.RealizationsCategory
    [27 tests, 2 failures, 0.10 s]
```



---

Comment by bump created at 2015-06-22 23:53:36

There are currently doctests failures in categories/realizations.py and categories/examples/with_realizations.py. These would be fixed by correcting the doctest, viz. replacing 'magmas' by 'unital magmas' in the failing docutests.

There is also a doctest failure in misc/dev_tools.py. In comment:96 I speculated that this was not caused by this patch, but evidently this was wrong. I don't know what caused this doctest to change, but I checked out the git commit 05875d563029eb7231d2cae4b434b99e4742fbbf and confirm that dev_tools tests pass for that version. Currently this patch is rebased atop that commit and I think this proves that it caused the failure. I don't know the mechanism but the test in question seems to be pretty fragile.

There is also a build failure patchbot report (as before) that a WARNING directive is missing a content block. It looks to me as if Mark's changes should have fixed this (the content block is now indented). So I'm puzzled by this (unless the build attempt predated Mark's commit. It is date stamped 6/20.)


---

Comment by git created at 2015-06-23 17:35:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mshimo created at 2015-06-24 22:15:47

Nicolas, aren't you the author of dev_tools? Do you know what is going on with the doctest?


---

Comment by bump created at 2015-06-24 23:00:53

I noticed that the dev_tools doctest that fails is fragile: if you call it from the command line it gives a different result than the doctest.


```

sage: from sage.misc.dev_tools import load_submodules
sage: load_submodules(sage.sets)
load sage.sets.cartesian_product... succeeded
load sage.sets.real_set... succeeded
load sage.sets.set_from_iterator... succeeded

```

Presumably this is because when the doctest is run, sage.sets.real_set has already been loaded.

Since the branch was recently changed to u/mshimo I think Mark is the only one who can make changes now. When it was u/public others could push changes, for example when Anne rebased it.


---

Comment by mshimo created at 2015-06-25 03:13:22

This is part of my misunderstanding of trac. 

I had trouble pushing to the u/public branch; it was forcing a merge
which was creating weird errors that didn't happen in my local branch.
That is why I made a new copy and put it in a new location, apparently unwittingly
making it nonpublic.

I would like to just clobber (replace) the old u/public branch
with the other one. Can I do that? Is it a bad idea?
I just know that my previous attempts to push to that branch, created weird nonrecognizable errors that were not my code's fault.

The alternative is to make a new public branch.


---

Comment by aschilling created at 2015-06-25 05:14:48

Replying to [comment:108 mshimo]:
> This is part of my misunderstanding of trac. 
> 
> I had trouble pushing to the u/public branch; it was forcing a merge
> which was creating weird errors that didn't happen in my local branch.
> That is why I made a new copy and put it in a new location, apparently unwittingly
> making it nonpublic.
> 
> I would like to just clobber (replace) the old u/public branch
> with the other one. Can I do that? Is it a bad idea?
> I just know that my previous attempts to push to that branch, created weird nonrecognizable errors that were not my code's fault.
> 
> The alternative is to make a new public branch.

You should be able to push your local branch to a public one by saying

```
git branch <localname> --set-upstream-to origin/<newremotename>
```

where <newremotename> is something like public/15375 (pick a name different from the old public name just in case). Then you can copy the new branch name in the trac field on the ticket.


---

Comment by nthiery created at 2015-06-25 13:56:27

Replying to [comment:96 bump]:
> Other bots are reporting a doctest error in dev_tools.py. 
> {{{
> **********************************************************************
> File "src/sage/misc/dev_tools.py", line 459, in sage.misc.dev_tools.import_statements
> Failed example:
>     load_submodules(sage.sets)
> Expected:
>     load sage.sets.cartesian_product... succeeded
>     load sage.sets.set_from_iterator... succeeded
> Got:
>     load sage.sets.real_set... succeeded
>     load sage.sets.set_from_iterator... succeeded
> **********************************************************************
> }}}
> I suspect this is unrelated to this patch. It may be caused by #18553 which was merged three weeks ago and which touched sage.sets.real_set.py.

My current bet is that this ticket somehow forces
`sage.sets.cartesian_product` to be loaded upon Sage's startup. Hence,
when running `load_submodules(sage.sets)` it does not appear anymore
as the first entry, and instead the output starts with the next one
which turns out to be `sage.sets.real_set`.

If that's confirmed, a good approach would be to make sure that all
the affine Weyl group code is lazy imported. That's a good property to
have anyway.

Cheers,
                                      Nicolas


---

Comment by git created at 2015-06-25 19:32:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mshimo created at 2015-06-25 19:35:44

The new module sage.categories.groups.group_semidirect_product does import CartesianProduct.
Would that make a difference?
----
New commits:


---

Comment by bump created at 2015-06-29 17:21:28

Replying to [comment:111 nthiery]:

> If that's confirmed, a good approach would be to make sure that all the affine Weyl group code is lazy imported. That's a good property to have anyway.

Mark's last commit did change to lazy import and did not fix the doctest.

> My current bet is that this ticket somehow forces` sage.sets.cartesian_product` to be loaded upon Sage's startup.

I think this may not have to do with what is loaded on startup, but rather what is loaded during other tests coming earlier in the docstring. If this test is moved to the top of the docstring, it will give a different result. See !comment:107.


---

Comment by git created at 2015-06-29 17:38:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mshimo created at 2015-06-29 19:32:30

As you can see from the commit message, I just changed the answer in the doctest
to the answer generated by the current version of sage.


---

Comment by bump created at 2015-06-30 15:58:21

Changing status from needs_work to needs_review.


---

Comment by bump created at 2015-06-30 15:58:21

On my machine it builds and all tests pass. But two buildbots are failing to build with cython errors.

Surely this can have nothing to do with this patch.

I'm changing the status to needs_review. I hesitate to change it to positive_review until the patchbot is happy.


---

Comment by aschilling created at 2015-07-01 07:12:22

Replying to [comment:117 bump]:
> On my machine it builds and all tests pass. But two buildbots are failing to build with cython errors.
> 
> Surely this can have nothing to do with this patch.
> 
> I'm changing the status to needs_review. I hesitate to change it to positive_review until the patchbot is happy.

For me everything builds fine. I ran `sage -testall` and got the following failures

```
sage -t src/sage/groups/perm_gps/permgroup_named.py
**********************************************************************
File "src/sage/groups/perm_gps/permgroup_named.py", line 2609, in sage.groups.perm_gps.permgroup_named.PSL.ramification_module_decomposition_hurwitz_curve
Failed example:
    G.ramification_module_decomposition_hurwitz_curve() # random, optional - database_gap
Exception raised:
    Traceback (most recent call last):
      File "/Applications/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Applications/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.groups.perm_gps.permgroup_named.PSL.ramification_module_decomposition_hurwitz_curve[1]>", line 1, in <module>
        G.ramification_module_decomposition_hurwitz_curve() # random, optional - database_gap
      File "/Applications/sage/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup_named.py", line 2630, in ramification_module_decomposition_hurwitz_curve
        mults = gap.eval("ram_module_hurwitz("+str(q)+")")
      File "/Applications/sage/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 568, in eval
        result = Expect.eval(self, input_line, **kwds)
      File "/Applications/sage/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1239, in eval
        for L in code.split('\n') if L != ''])
      File "/Applications/sage/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 766, in _eval_line
        raise RuntimeError(message)
    RuntimeError: Gap produced error output
    Error, sorry, the GAP Tables Of Marks Library is not installed

       executing ram_module_hurwitz(13);
**********************************************************************
File "src/sage/groups/perm_gps/permgroup_named.py", line 2657, in sage.groups.perm_gps.permgroup_named.PSL.ramification_module_decomposition_modular_curve
Failed example:
    G.ramification_module_decomposition_modular_curve() # random, optional - database_gap
Exception raised:
    Traceback (most recent call last):
      File "/Applications/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Applications/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.groups.perm_gps.permgroup_named.PSL.ramification_module_decomposition_modular_curve[1]>", line 1, in <module>
        G.ramification_module_decomposition_modular_curve() # random, optional - database_gap
      File "/Applications/sage/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup_named.py", line 2674, in ramification_module_decomposition_modular_curve
        mults = gap.eval("ram_module_X("+str(q)+")")
      File "/Applications/sage/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 568, in eval
        result = Expect.eval(self, input_line, **kwds)
      File "/Applications/sage/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1239, in eval
        for L in code.split('\n') if L != ''])
      File "/Applications/sage/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 766, in _eval_line
        raise RuntimeError(message)
    RuntimeError: Gap produced error output
    Error, sorry, the GAP Tables Of Marks Library is not installed

       executing ram_module_X(7);
**********************************************************************
2 items had failures:
   1 of   3 in sage.groups.perm_gps.permgroup_named.PSL.ramification_module_decomposition_hurwitz_curve
   1 of   3 in sage.groups.perm_gps.permgroup_named.PSL.ramification_module_decomposition_modular_curve
    [439 tests, 2 failures, 3.16 s]
----------------------------------------------------------------------
sage -t src/sage/groups/perm_gps/permgroup_named.py  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 3.3 seconds
    cpu time: 2.3 seconds
    cumulative wall time: 3.2 seconds
```


```
sage -t src/sage/tests/gap_packages.py
**********************************************************************
File "src/sage/tests/gap_packages.py", line 15, in sage.tests.gap_packages
Failed example:
    test_packages(['atlasrep', 'tomlib'])    # optional - database_gap
Expected:
      Status   Package    GAP Output
    +--------+----------+------------+
               atlasrep   true
               tomlib     true
Got:
      Status    Package    GAP Output
    +---------+----------+------------+
      Failure   atlasrep   fail
      Failure   tomlib     fail
**********************************************************************
1 item had failures:
   1 of   4 in sage.tests.gap_packages
    [9 tests, 1 failure, 0.18 s]
----------------------------------------------------------------------
sage -t src/sage/tests/gap_packages.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 0.2 seconds
    cpu time: 0.2 seconds
    cumulative wall time: 0.2 seconds
```


I do not think they are related to this branch. So unless there is something else, I guess we can set positive review.


---

Comment by tscrim created at 2015-07-01 09:09:11

In decreasing probability, it looks like your `database_gap` optional spkg is out of date, mis-/not installed, or needs optional GAP packages installed directly into GAP. I'd try running `sage -i database_gap` and `sage -i gap_packages` and then running those tests again to see if they work.


---

Comment by bump created at 2015-07-01 19:23:23

Any conjectures about the patchbot?

I presume that the patchbot merges the patch on top of the develop tip then tries to build. Is that correct? It looks from the log as if it actually tries to merge it with a branch called patchbot/base. There doesn't actually seem to be such a branch in the repository.


---

Comment by aschilling created at 2015-07-01 21:29:15

Thanks Travis, that did the trick. For me all tests pass now.

Replying to [comment:120 bump]:
> Any conjectures about the patchbot?
> 
> I presume that the patchbot merges the patch on top of the develop tip then tries to build. Is that correct? It looks from the log as if it actually tries to merge it with a branch called patchbot/base. There doesn't actually seem to be such a branch in the repository.

On my local computer, I merged in the latest development version sage-6.8.beta6 and everything merged fine. So I think something is wrong with the patchbot.

I am going to set positive review, since we all seem happy with the patch.


---

Comment by bump created at 2015-07-01 21:31:24

Right, I ran all the tests yesterday after a distclean build and there were no failures.

> I am going to set positive review, since we all seem happy with the patch.


---

Comment by aschilling created at 2015-07-01 21:32:56

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-07-02 16:24:47


```
l.165775 \end{gather}
                     \paragraph{Fundamental group of affine Dynkin automorph...

? 
! Emergency stop.
\math`@`cr`@``@``@` ...`@` \`@`ne \add`@`amps \maxfields`@` \omit 
                                                  \kern -\alignsep`@` \iftag`@` ...
l.165775 \end{gather}
                     \paragraph{Fundamental group of affine Dynkin automorph...

!  ==> Fatal error occurred, no output PDF file produced!
Transcript written on combinat.log.
Makefile:55: recipe for target 'combinat.pdf' failed
make[2]: *** [combinat.pdf] Error 1
```



---

Comment by vbraun created at 2015-07-02 16:24:47

Changing status from positive_review to needs_work.


---

Comment by mshimo created at 2015-07-02 18:31:51

The build of pdf documentation fails. It outputs algebra.pdf and then seems to hang.
I have no idea what is going on. I didn't see a log file generated for this.


---

Comment by jdemeyer created at 2015-07-02 19:34:58

Now that this ticket needs_work anyway:

In the 4 files that you're adding in this ticket: please use the standard copyright statement as explained in [http://doc.sagemath.org/html/en/developer/coding_basics.html#headings-of-sage-library-code-files](http://doc.sagemath.org/html/en/developer/coding_basics.html#headings-of-sage-library-code-files)

Currently, two of the files have no copyright statement and two do not state the GPL version.


---

Comment by bump created at 2015-07-02 20:06:51

Here is a log of the results of !`sage --docbuild reference pdf`

http://match.stanford.edu/pdflog

(Temporary URL)


---

Comment by jhpalmieri created at 2015-07-02 20:16:57

By default, a `.. MATH::` block is automatically enclosed in a math environment, so you shouldn't use an environment like `align*` there: it gets turned into something like

```
\begin{gather}
\begin{align*}
...
\end{align*}
\end{gather}
```

which is not valid LaTeX. To avoid the default, you can add `:nowrap:` at the beginning of the math block, or you can use an environment like `aligned` instead. This will fix it, but I would instead choose only one of these two approaches (instead of switching between them, as I've done here):

```diff
diff --git a/src/sage/combinat/root_system/extended_affine_weyl_group.py b/src/sage/combinat/root_system/extended_affine_weyl_group.py
index 7d35cac..56d9e6d 100644
--- a/src/sage/combinat/root_system/extended_affine_weyl_group.py
+++ b/src/sage/combinat/root_system/extended_affine_weyl_group.py
`@``@` -155,6 +155,7 `@``@` def ExtendedAffineWeylGroup(cartan_type, general_linear=None, **print_options):
     There are isomorphisms
 
     .. MATH::
+       :nowrap:
 
         \begin{align*}
             W &\cong M \rtimes W_0 \cong W_0 \ltimes M \\
diff --git a/src/sage/groups/group_semidirect_product.py b/src/sage/groups/group_semidirect_product.py
index 627056f..63b8769 100644
--- a/src/sage/groups/group_semidirect_product.py
+++ b/src/sage/groups/group_semidirect_product.py
`@``@` -152,11 +152,11 `@``@` class GroupSemidirectProduct(CartesianProduct):
         
     .. MATH::
 
-        \begin{align*}
+        \begin{aligned}
         (g_1,h_1)(g_2,h_2) &= g_1 h_1 g_2 h_2 \\
         &= g_1 g_2 g_2^{-1} h_1 g_2 h_2 \\
         &= (g_1g_2, twist(g_2^{-1}, h_1) h_2)
-        \end{align*}
+        \end{aligned}
 
     If ``act_to_right`` is False, the group `G \rtimes H` is specified by a homomorphism `\psi\in \mathrm{Hom}(H,\mathrm{Aut}(G))`
     such that
`@``@` -175,11 +175,11 `@``@` class GroupSemidirectProduct(CartesianProduct):
 
     .. MATH::
 
-        \begin{align*}
+        \begin{aligned}
         (g_1,h_1)(g_2,h_2) &= g_1 h_1 g_2 h_2 \\
         &= g_1 h_1 g_2 h_1^{-1} h_1 h_2 \\
         &= (g_1 twist(h_1,g_2), h_1 h_2)
-        \end{align*}
+        \end{aligned}
 
     If ``prefix0`` (resp. ``prefixl``) is not None then it is used as a wrapper for
     printing elements of ``G`` (resp. ``H``). If ``print_tuple`` is True then elements are printed
```



---

Comment by bump created at 2015-07-02 20:17:19

There is a huge file called !`doc/output/latex/en/reference/combinat/` and at line 165376 we have the following:


```

There are isomorphisms
\begin{gather}
\begin{split}\begin{align*}
    W &\cong M \rtimes W_0 \cong W_0 \ltimes M \\
    E &\cong L \rtimes W_0 \cong W_0 \ltimes L
\end{align*}\end{split}\notag
\end{gather}\paragraph{Fundamental group of affine Dynkin automorphisms}

```


At this point pdflatex barfs.


---

Comment by mshimo created at 2015-07-02 20:49:05

Thanks, Dan, that is very helpful. I will fix the doc.


---

Comment by tscrim created at 2015-07-02 21:23:06

As John had mentioned, you need to change:

```diff
-        \begin{align*}
+        \begin{aligned}
             W &\cong M \rtimes W_0 \cong W_0 \ltimes M \\
             E &\cong L \rtimes W_0 \cong W_0 \ltimes L
-        \end{align*}
+        \begin{aligned}
```

and

```diff
     .. MATH::
 
-        \begin{align*}
+        \begin{aligned}
         (g_1,h_1)(g_2,h_2) &= g_1 h_1 g_2 h_2 \\
         &= g_1 g_2 g_2^{-1} h_1 g_2 h_2 \\
         &= (g_1g_2, twist(g_2^{-1}, h_1) h_2)
-        \end{align*}
+        \end{aligned}
```

Also I believe this needs to be changed (there are 2 of theses):

```diff
     .. MATH::
 
-        g h g^{-1} &= \phi(g)(h).
+        g h g^{-1} = \phi(g)(h).
```



---

Comment by git created at 2015-07-03 06:42:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bump created at 2015-07-03 21:50:24

Sage now builds, reference.pdf builds and all tests pass. I'm setting status back to positive review.


---

Comment by bump created at 2015-07-03 21:50:24

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-07-04 08:19:58

Resolution: fixed
