# Issue 10821: lcalc fails to build with gcc-4.6

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2011-03-08 21:45:34

Assignee: tbd

CC:  rishikesh

lcalc fails to build with the gcc-4.6 version in Fedora 15 alpha:

```
In file included from ../include/Lglobals.h:51:0,
                 from Lglobals.cc:23:
/usr/lib/gcc/x86_64-redhat-linux/4.6.0/../../../../include/c++/4.6.0/limits: In static member function ‘static
 double std::numeric_limits<double>::min()’:
/usr/lib/gcc/x86_64-redhat-linux/4.6.0/../../../../include/c++/4.6.0/limits:1479:83: error: call of overloaded ‘lcalc_to_double(long double)’ is ambiguous
/usr/lib/gcc/x86_64-redhat-linux/4.6.0/../../../../include/c++/4.6.0/limits:1479:83: note: candidates are:
../include/Lcommon.h:18:15: note: double lcalc_to_double(const Double&)
../include/Lcommon.h:29:15: note: double lcalc_to_double(const int&)
../include/Lcommon.h:30:15: note: double lcalc_to_double(const long long int&)
../include/Lcommon.h:31:15: note: double lcalc_to_double(const short int&)
../include/Lcommon.h:32:15: note: double lcalc_to_double(const char&)
../include/Lcommon.h:33:15: note: double lcalc_to_double(const long int&)
../include/Lcommon.h:34:15: note: double lcalc_to_double(const unsigned int&)
../include/Lcommon.h:35:15: note: double lcalc_to_double(const long unsigned int&)
```

The reason is the following code horror from `src/src/include/Lcommon.h` (some editing for clarity):

```
inline double lcalc_to_double(const Double& x) { return x; }
inline double lcalc_to_double(const double& x) { return x; }
//inline double lcalc_to_double(const long double& x) { return x; }
inline double lcalc_to_double(const int& x) { return x; }
inline double lcalc_to_double(const long long& x) { return x; }
inline double lcalc_to_double(const short& x) { return x; }
inline double lcalc_to_double(const char& x) { return x; }
inline double lcalc_to_double(const long int& x) { return x; }
inline double lcalc_to_double(const unsigned int& x) { return x; }
inline double lcalc_to_double(const long unsigned int& x) { return x; }
#define Int(x) (int)(lcalc_to_double(x))
#define Long(x) (Long)(lcalc_to_double(x))
#define double(x) (double)(lcalc_to_double(x))
```

The last three lines are clearly a bad idea to define before including system headers! As a bandaid, I uncommented the `inline double lcalc_to_double(const long double& x)`, and it compiles fine now. But somebody who is familiar with the codebase should really rewrite lcalc to not redefine the `double()` cast, thats just fragile and will sooner or later again fail inside some system headers.

My updated spkg is here: 

http://www.stp.dias.ie/~vbraun/Sage/spkg/lcalc-20100428-1.23.p6.spkg

It would be nice if we could update the spkg before Fedora 15 is released!


---

Comment by drkirkby created at 2011-03-30 08:36:35

> `[Volker Braun wrote]` The reason is the following code horror from src/src/include/Lcommon.h

The poor quality of the lcalc source code appears to have put off one Sage user when she looked at it. To quote her:

"''Unfortunately, lcalc was the part of Sage I intended using - now I think I
will look at other software.''"

http://groups.google.com/group/sage-support/browse_thread/thread/fab46afe7a8ac1c2/e43f31d452dfbfbe?lnk=gst&q=Warning+messages+when+compiling+%27lcalc%27#e43f31d452dfbfbe

I'm also very unimpressed. Even with your changes lcalc generates over 200 compiler warnings from gcc 4.6.0 

Sun Studio would never compile lcalc (see #7065) - I doubt it will do even with your changes. 

Lcalc used to refuse to compile on Solaris with g++ as the Makefile has a compiler option to suppress warnings from the assembler, which works with the GNU assembler, but which the Sun assembler does not understand. (The "`-W`" option was sent directly to the assembler with the g++ option "`-Wa W`".)

Lcalc will not install on HP-UX (#7178). I've never tried on AIX, but I would not be surprised if it failed on that too.  

Your code builds OK with gcc 4.6.0 on OpenSolaris and passes all the doctests. So I'm assuming you want it reviewed, in which case I'll give it a positive review. 

It would really help if you attached a Mercurial patch showing the changes you have made. It makes review easier, and is useful when people look back at tickets. I've attached a patch which shows your changes. 

I've changed the _Reported Upstream_ pull-down on trac from _N/A_ to _Not yet reported upstream. Will do shortly_ as clearly this is an upstream bug. I'll report it to 
Micheal Rubinstein. 

Dave


---

Attachment

Patch for review purposes only - does not need to be applied.


---

Comment by drkirkby created at 2011-03-30 08:37:35

Changing status from new to needs_review.


---

Comment by drkirkby created at 2011-03-30 08:37:44

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-04-05 12:02:15

Has this been reported upstream already?


---

Comment by drkirkby created at 2011-04-05 13:18:52

Replying to [comment:4 jdemeyer]:
> Has this been reported upstream already?

It had not before you reminded me, but I have now done it. I reported it to Michael Rubinstein (mrubinst <<<ATT> uwaterloo.ca) today `@` 1307 GMT. I've changed the "reported upstream" pull-down to reflect this. 

Dave


---

Comment by jdemeyer created at 2011-04-05 15:57:15

Resolution: fixed


---

Comment by drkirkby created at 2011-04-05 19:53:40

I got this from Mike a couple of hours ago, after I suggested he make his latest code available in it's current state, which is clearly not due for release yet. 

----
I'll make that available to you later today, and thanks for keeping me updated about the compile issue.

Best,
Mike
----


---

Comment by jdemeyer created at 2011-04-12 08:35:43

`www.stp.dias.ie` seems to be down, so I'm mirroring the spkg myself.


---

Attachment

Diff for SPKG.txt


---

Comment by jdemeyer created at 2011-05-04 09:32:54

New spkg with updated SPKG.txt, same place: [http://boxen.math.washington.edu/home/jdemeyer/spkg/lcalc-20100428-1.23.p6.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/lcalc-20100428-1.23.p6.spkg)


---

Comment by jdemeyer created at 2011-05-12 15:45:29

Any more feedback from upstream?
