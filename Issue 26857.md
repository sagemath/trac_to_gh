# Issue 26857: Update patches in gap SPKG

Issue created by migration from https://trac.sagemath.org/ticket/27094

Original creator: embray

Original creation time: 2019-01-23 11:51:55

CC:  fbissey

Keywords: gap

A couple of the patches we include in the gap SPKG:

* 0001-a-version-of-the-writeandcheck.patch-from-Sage-that-.patch
* 0003-Prototype-for-GAP_Enter-Leave-macros-to-bracket-use-.patch

were added before they were accepted upstream.  Now they have been accepted, but in significantly different forms:

* https://github.com/gap-system/gap/pull/3102
* https://github.com/gap-system/gap/pull/3096

So these patches should be updated to the upstream versions.

This might be a good opportunity to also backport some other upstream changes--particularly in the libgap API--that will eventually land in GAP 4.10.1.  But that will take a little more work and testing.


---

Comment by embray created at 2019-01-23 11:52:01

Set assignee to embray.


---

Comment by dimpase created at 2019-02-04 11:23:13

Should we wait for GAP 4.10.1 to be released?


---

Comment by embray created at 2019-02-04 13:20:19

That would probably be best, if it is imminent (last I saw I got the impression that it was).


---

Comment by embray created at 2019-02-04 13:21:03

Of course, doing more work on this now would also make for a good test of GAP 4.10.1.  It might be best start even before it's released (using the latest from the 4.10 release branch).


---

Comment by jdemeyer created at 2019-02-14 10:45:17

I'm having a look at this.


---

Comment by jdemeyer created at 2019-02-14 11:32:29

I had two add two more patches to avoid problems. All the patches come from the 4.10 backport branch.
----
New commits:


---

Comment by jdemeyer created at 2019-02-14 11:32:29

Changing status from new to needs_review.


---

Comment by @timokau created at 2019-02-14 12:01:32

Is there a reason to do this now? I'm not strictly opposed to it (since no changes to sage source are required distributions shouldn't be affected). But why replace some tested-and-working patches with some cherry-picks (one of which is >600 lines)? Are there any issues with the old patches?


---

Comment by git created at 2019-02-14 18:06:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-02-14 22:39:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2019-02-15 18:22:03

Replying to [comment:8 gh-timokau]:
> Is there a reason to do this now? I'm not strictly opposed to it (since no changes to sage source are required distributions shouldn't be affected). But why replace some tested-and-working patches with some cherry-picks (one of which is >600 lines)?

1. For testing purposes: libGAP is not widely used, Sage is more or less the only serious user of it. If we find some problems now, it can be fixed before 4.10.1 is released.

2. Packagers always complains when Sage adds Sage-specific patches to a package. Now we replace these by upstream patches, which should be more acceptable for packagers.

3. Any work done on the Sage <-> libGAP interface in the mean time might break with the Sage patches. For example, I plan to do some work on improving the error handling and it makes much more sense to do that based on the official libGAP API rather than the Sage version of it.


---

Comment by jdemeyer created at 2019-02-15 18:23:19

To put it differently: if we have a choice between using Sage-specific patches and using upstream patches, why should we not use the upstream patches?


---

Comment by @timokau created at 2019-02-16 12:53:32

Good points. The only reasons against it I could think of is 

- "the current patches are known to work" (which is outweighed by the benefits of testing the upstream patches) and 

- "potential additional packager work", which would need to be done after the next gap release anyways

Thanks for explaining your reasons.


---

Comment by embray created at 2019-02-18 15:38:19

Looks more or less like what I had in mind.  The next step would be to actually use the new functions added to the API, such as `GAP_CallFuncArray`.  Did you want to do that here, or in a follow-up?


---

Comment by jdemeyer created at 2019-02-18 18:47:56

Replying to [comment:15 embray]:
> Did you want to do that here, or in a follow-up?

Certainly in a follow-up and quite possibly multiple follow-ups.


---

Comment by embray created at 2019-02-20 13:21:07

I want to test this on Cygwin before marking positive_review, but I think it will probably be fine since I worked on most of those patches and developed them against Linux and Cygwin simultaneously.  However, first I need to finish testing your patch for #27267.


---

Comment by fbissey created at 2019-03-04 22:40:15

gap-4.10.1 has been released on github (and there is a full gap distribution tarball with all the packages available) https://github.com/gap-system/gap/releases

But the release has not made it yet to gap website. It is probable that numerous page needs updating before going live.


---

Comment by dimpase created at 2019-03-19 12:04:02

4.10.1 is out now officially.


---

Comment by jdemeyer created at 2019-03-25 10:26:00

Changing type from task to enhancement.


---

Comment by jdemeyer created at 2019-03-25 10:26:00

Changing status from needs_review to needs_work.


---

Comment by embray created at 2019-03-25 10:43:18

Moving all my in-progress tickets to 8.8 milestone.


---

Comment by git created at 2019-03-25 11:13:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-03-25 11:57:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-03-25 12:02:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-03-25 13:11:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2019-03-25 13:33:40

Changing status from needs_work to needs_review.


---

Comment by git created at 2019-03-25 14:29:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-03-26 13:25:36

This should also update `gap_packages`.


---

Comment by dimpase created at 2019-03-26 13:25:36

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2019-03-26 14:03:08

to build, one needs at least (some packages got renamed, with version numbers included now)

```
diff --git a/build/pkgs/gap_packages/checksums.ini b/build/pkgs/gap_packages/checksums.ini
index e64edb6155..9ef8c5ece4 100644
--- a/build/pkgs/gap_packages/checksums.ini
+++ b/build/pkgs/gap_packages/checksums.ini
@@ -1,4 +1,4 @@
-tarball=gap-VERSION.tar.gz
-sha1=ab95077df0775bc39dbf13becdc05818935a53d2
-md5=4d3cd775a7dcf5582b8b4dbc2b484bd4
-cksum=1444102593
+tarball=gap-VERSION.tar.bz2
+sha1=1ac95a8b17102379526962706ae9b334b871899d
+md5=3429dd48d0af97e65f81c06584ccdf7f
+cksum=2060197163
diff --git a/build/pkgs/gap_packages/package-version.txt b/build/pkgs/gap_packages/package-version.txt
index 51a04e6c92..4fb754a607 100644
--- a/build/pkgs/gap_packages/package-version.txt
+++ b/build/pkgs/gap_packages/package-version.txt
@@ -1 +1 @@
-4.10.0.p0
+4.10.1.p0
diff --git a/build/pkgs/gap_packages/spkg-install b/build/pkgs/gap_packages/spkg-install
index d8260b9aa0..464b55267a 100644
--- a/build/pkgs/gap_packages/spkg-install
+++ b/build/pkgs/gap_packages/spkg-install
@@ -24,15 +24,15 @@ sdh_install \
     hecke-* \
     liealgdb-* \
     liepring-* \
-    liering \
-    loops \
+    liering-* \
+    loops-* \
     MapClass-* \
-    polymaking \
+    polymaking-* \
     qpa-* \
     quagroup \
     radiroot-* \
-    repsn \
-    sla \
+    repsn-* \
+    sla-* \
     sonata-* \
     Toric-* \
     utils-* \
```



---

Comment by git created at 2019-03-26 14:29:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2019-03-26 14:30:30

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2019-03-26 14:30:54

Replying to [comment:30 dimpase]:
> to build, one needs at least (some packages got renamed, with version numbers included now)

Thanks! I applied that.


---

Comment by dimpase created at 2019-03-26 19:41:27

OK, great, everything works.


---

Comment by dimpase created at 2019-03-26 19:41:27

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-03-29 12:36:42

Resolution: fixed


---

Comment by embray created at 2019-04-02 14:18:30

Follow-up in #27594 (coincidentally this ticket plus 500)
