# Issue 16115: TransitiveIdeal -> RecursivelyEnumeratedSet in the sage library

Issue created by migration from Trac.

Original creator: slabbe

Original creation time: 2014-05-13 20:02:35

CC:  aschilling ​tscrim

`TransitiveIdeal` and `TransitiveIealGraded` are used in the code of `sage/combinat`, `sage/categories` and `sage/groups` at least. These should be replaced by `RecursivelyEnumeratedSet` for speed improvements and also to avoid issues explained in #6637.

This is a follow up of #6637 where `TransitiveIdeal` and `TransitiveIealGraded` have been deprecated.


---

Comment by slabbe created at 2015-04-03 14:22:30

New commits:


---

Comment by slabbe created at 2015-04-03 14:28:25

Changing keywords from "" to "sd66".


---

Comment by git created at 2015-04-03 14:40:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2015-04-03 14:43:50

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2015-04-10 18:24:51

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-04-10 18:24:51

Salut Sébastien,

Your branch is based on sage-6.5!! Would you mind rebasing on sage-6.6.rc2?

Your iterator for infinite conjugacy classes is wrong

```
sage: a = matrix(ZZ,2,[1,1,0,1])
sage: b = matrix(ZZ,2,[1,0,1,1])
sage: G = MatrixGroup([a,b])
sage: a = G(a)
sage: b = G(b)
sage: C = ConjugacyClass(G, a)
sage: m1 = b * a * ~b
sage: m2 = ~b * a * b
sage: any(x == m1 for x in C)
True
sage: any(x == m2 for x in C)
... can wait forever ...
```

I think that adding also inverses of generators would work. I.e. just replace `self._parent.gens()` with `self._parent.semigroup_generators()`. And please add the above test in the documentation.

Best,
Vincent


---

Comment by git created at 2015-04-12 13:51:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2015-04-12 13:54:13

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2015-04-12 13:54:13

I used `monoid_generators` instead of `semigroup_generators` since it does not contain the identity. It is good because when the group is finite, it just returns the gens without their inverses.

Needs review again!


---

Comment by vdelecroix created at 2015-04-12 15:11:24

Shouldn't you remove the second `todo` in `combinat/backtrack.py`?


---

Comment by git created at 2015-04-12 16:14:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-04-12 21:28:57

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-04-14 20:00:19

Merge conflict, try with 6.7.beta0 when its out


---

Comment by vbraun created at 2015-04-14 20:00:19

Changing status from positive_review to needs_work.


---

Comment by git created at 2015-04-16 12:00:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2015-04-16 12:03:56

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2015-04-16 12:03:56

(the code using `TransitiveIdeal` in the file `finite_semigroups.py` was deleted in 6.7.beta0, that was the reason for the conflict)


---

Comment by vdelecroix created at 2015-04-16 16:38:53

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-04-16 16:38:53

got

```
sage -t --long src/sage/combinat/dyck_word.py
**********************************************************************
File "src/sage/combinat/dyck_word.py", line 3501, in sage.combinat.dyck_word.DyckWords_size.__init__
Failed example:
    TestSuite(DyckWords(4,2)).run()
Expected nothing
--
    The following tests failed: _test_enumerated_set_iter_cardinality
**********************************************************************
```



---

Comment by vdelecroix created at 2015-04-17 15:28:59

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-04-17 15:28:59

Replying to [comment:18 vdelecroix]:
> got
> {{{
> sage -t --long src/sage/combinat/dyck_word.py
> ...
> }}}

Sorry, seems to be a problem on my computer.

Vincent


---

Comment by chapoton created at 2015-04-21 19:17:16

I think that it is necessary to keep the "graded" keyword whenever `TransitiveIdealGraded` was used.
Otherwise, you are losing information, that may never come back.

So I propose to try putting "graded" wherever it already was, and see what happens.


---

Comment by slabbe created at 2015-04-22 08:35:09

Ok, I agree, let's have this discussion. I first tried to replace every occurences of `TransitiveIdealGraded` by `RecursivelyEnumeratedSet(..., structure='graded')`, but then I got infinite loops.

The reason is that if a structure is graded, the enumeration currently done in `RecursivelyEnumeratedSet` saves in memory only two grades (the current one and the precedent one). If the structure is not graded and we use the graded argument for `RecursivelyEnumeratedSet`, then we may get infinite loops and elements that are genereated twice or infinitely often.

I won't have access to my machine until Tuesday for redoing those tests and tell you exactly where were the infinite loops happening...

Meanwhile, I would like to know for each occurences of `TransitiveIdealGraded` in the sage library weather the structure was really graded. I recall that `TransitiveIdealGraded` was not using the graded hypothesis at all since it was saving *all* of the generated elements.

A) There were three files where `TransitiveIdealGraded` was used:

File `src/sage/categories/crystals.py`

```python
class Crystals(Category_singleton):
    class ParentMethods:
        def __iter__(self, index_set=None, max_depth=float('inf')):
            from sage.combinat.backtrack import TransitiveIdealGraded
            from sage.combinat.backtrack import TransitiveIdeal
            # was using both ???

        def subcrystal(self, index_set=None, generators=None, max_depth=float("inf"),
            from sage.combinat.backtrack import TransitiveIdealGraded
```


File `src/sage/categories/highest_weight_crystals.py`

```python
class HighestWeightCrystals(Category_singleton):
    class ParentMethods:
        def __iter__(self, index_set=None, max_depth = float("inf")):
            from sage.combinat.backtrack import TransitiveIdealGraded
```



File `src/sage/combinat/root_system/root_lattice_realizations.py`

```python
from sage.combinat.backtrack import TransitiveIdeal, TransitiveIdealGraded
class RootLatticeRealizations(Category_over_base_ring):
    class ParentMethods:
        `@`cached_method
        def positive_roots(self, index_set=None):
            return TransitiveIdealGraded(attrcall('pred', index_set=index_set),
                                         [self.simple_root(i) for i in index_set])
        def positive_real_roots(self):
            if self.cartan_type().is_finite():
                return tuple(TransitiveIdealGraded(attrcall('pred'), self.simple_roots()))

        `@`cached_method
        def positive_roots_parabolic(self, index_set = None):
            return TransitiveIdealGraded(parabolic_covers, generators)

    class ElementMethods:
        def orbit(self):
            return [x for x in TransitiveIdealGraded(attrcall('simple_reflections'), [self])]

        def greater(self):
            return [x for x in TransitiveIdeal(attrcall('succ'), [self])]

        def smaller(self):
            return [x for x in TransitiveIdeal(attrcall('pred'), [self])]
```


B) For reference, below are the files where only `TransitiveIdeal` was used.

File `src/sage/groups/conjugacy_classes.py`

```python
class ConjugacyClass(Parent):
    `@`cached_method
    def set(self):
        from sage.combinat.backtrack import TransitiveIdeal
```


File `src/sage/combinat/rigged_configurations/kr_tableaux.py`

```python
class KirillovReshetikhinTableaux(CrystalOfWords):
    def __iter__(self):
        from sage.combinat.backtrack import TransitiveIdeal
```


File `src/sage/combinat/rigged_configurations/rigged_configurations.py`

```python
class RiggedConfigurations(Parent, UniqueRepresentation):
    def __iter__(self):
        from sage.combinat.backtrack import TransitiveIdeal
```


File `src/sage/combinat/rigged_configurations/tensor_product_kr_tableaux.py`

```python
class TensorProductOfKirillovReshetikhinTableaux(FullTensorProductOfRegularCrystals):
    def __iter__(self):
        from sage.combinat.backtrack import TransitiveIdeal
```


File `src/sage/combinat/root_system/pieri_factors.py`

```python
from sage.combinat.backtrack import TransitiveIdeal
class PieriFactors(UniqueRepresentation, Parent):
    `@`cached_method
    def elements(self):
        return TransitiveIdeal(attrcall('bruhat_lower_covers'), self.maximal_elements())
```



---

Comment by chapoton created at 2015-04-22 08:38:38

I would say that crystal things are usually graded, but it would be better if crystal people can opt in and say their word about the matter. Travis ? Anne ?


---

Comment by chapoton created at 2015-04-22 14:37:35

I have tried putting 'graded' in src/sage/categories/highest_weight_crystals.py
and it worked fine. I tested the file itself and the combinat/crystals folder.

I have tried putting 'graded' in src/sage/combinat/root_system/root_lattice_realizations.py and it worked fine. I tested the src/sage/combinat/root_system folder. Seems to be quicker by the way.

Let us see if the bot founds a problem with these two changes.
----
New commits:


---

Comment by chapoton created at 2015-04-22 16:05:02

ok, no problem so far, the bot is happy.

There remains only the case of src/sage/categories/crystals.py

Anne, Travis ? What about affine crystals for example ? can we used "graded" ?


---

Comment by chapoton created at 2015-04-22 18:46:26

I can now confirm that the each of the two remaining instances runs into infinite loops
when given the 'graded' argument.

Therefore this ticket is good to go.

If you agree, set this to positive review.


---

Comment by aschilling created at 2015-04-22 18:49:47

Replying to [comment:24 chapoton]:
> ok, no problem so far, the bot is happy.
> 
> There remains only the case of src/sage/categories/crystals.py
> 
> Anne, Travis ? What about affine crystals for example ? can we used "graded" ?

Affine crystals are not necessarily graded. They can be cyclic.


---

Comment by chapoton created at 2015-04-22 19:55:34

Thanks !

And are we safe with using 'graded' for highest weight crystals, as it seems ?

By the way, Anne, have you seen my Fulbright call on sage-combinat-devel ?


---

Comment by aschilling created at 2015-04-22 20:02:32

Replying to [comment:27 chapoton]:
> Thanks !
> 
> And are we safe with using 'graded' for highest weight crystals, as it seems ?

Yes.

> By the way, Anne, have you seen my Fulbright call on sage-combinat-devel ?

I am not sure. For postdocs with a permanent position?


---

Comment by chapoton created at 2015-04-22 20:05:24

> > By the way, Anne, have you seen my Fulbright call on sage-combinat-devel ?
> 
> I am not sure. For postdocs with a permanent position?

Yes, hum. I am afraid that it is like looking for an element in the empty set. But maybe you could have somebody in mind.. Young, with a position, willing to spend time in Lyon, likes algebraic combinatorics. Not so easy to find, indeed.


---

Comment by slabbe created at 2015-04-22 20:48:10

> There remains only the case of src/sage/categories/crystals.py

There was four occurences of `TransitiveIdealGraded` in the file `src/sage/combinat/root_system/root_lattice_realizations.py` but you set `structure='graded'` in only one of them. Can you also check (mathematically + doctests) whether we can add the graded hypothesis for the three others also?


---

Comment by git created at 2015-04-23 06:40:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-04-23 06:42:26

It seems to be ok for two of them, but not for the third one, which is an orbit.

But, damn, tests for this file are so long ...


---

Comment by chapoton created at 2015-04-23 11:44:00

It seems that tests take slightly longer in `root_lattice_realizations.py` with this branch..


---

Comment by slabbe created at 2015-04-28 11:39:45

Replying to [comment:33 chapoton]:
> It seems that tests take slightly longer in `root_lattice_realizations.py` with this branch..

Okay, I will take a look at this.


---

Comment by slabbe created at 2015-04-29 15:03:39

Replying to [comment:33 chapoton]:
> It seems that tests take slightly longer in `root_lattice_realizations.py` with this branch..

Running `sage -t src/sage/combinat/root_system/root_lattice_realizations.py` three times on 6.7.beta3, I get:


```
[575 tests, 10.62 s]
[575 tests, 10.62 s]
[575 tests, 10.70 s]
```


Running the same command three times on the same file with this branch, I get:


```
[575 tests, 10.62 s]
[575 tests, 10.59 s]
[575 tests, 10.59 s]
```


So I can't confirm that tests take any longer with this ticket. Needs review!


---

Comment by chapoton created at 2015-04-29 18:37:23

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2015-04-29 18:37:23

ok, avanti !


---

Comment by vbraun created at 2015-05-01 18:46:02

Resolution: fixed
