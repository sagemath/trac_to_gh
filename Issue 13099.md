# Issue 13099: wrong sign with function Ei and limit

Issue created by migration from Trac.

Original creator: dkrenn

Original creation time: 2012-07-18 20:27:03

Assignee: burcin

CC:  nbruin benjaminfjones dsm

Keywords: Ei limit sign

We have

```
sage: (Ei(-Z)).limit(Z=oo)
Infinity
```

which is wrong, since it should be 0. It seems that there goes something wrong with the `-` sign. This can be also seen here:

```
sage: (Ei(-Z)).limit(Z=1000)   
-Ei(1000)
sage: (Ei(-Z)).limit(Z=1000).n()
-1.97204513714124e431
```

But

```
sage: Ei(-1000).n()
-5.07089306023517e-438
sage: -Ei(1000).n()
-1.97204513714124e431
```

which are the correct results.


---

Comment by kcrisman created at 2012-07-20 02:43:16

Just as a data point, we still get this after #11143, unsurprisingly given that that doesn't touch Maxima.

This is a little weird, since in both Maxima in current Sage and in Maxima 5.27

```
(%i5) limit(expintegral_ei(-z),z,inf);
(%o5)                                  0
```

Further,

```
sage: A = Ei(-Z)._maxima_()
sage: A.limit(Z,'inf')
0
```

Using the Maxima lib version is ok too.

I have a feeling that the following is the problem,

```
sage: sage.interfaces.maxima_lib.sr_to_max(SR(Ei(-Z)))
<ECL: ((%GAMMA_INCOMPLETE) 0 ((MTIMES) |$z| -1))>
```

combined with

```
(%i1) limit(gamma_incomplete(0,-Z),Z,inf);
(%o1)                              infinity
```

So somehow this is completely bypassing the symbol table.  I am out of my depth in our ECL conversions...


---

Comment by kcrisman created at 2012-07-20 02:46:38

Or maybe I'm not.

```
sage.functions.other.Ei : lambda X : [[max_gamma_incomplete], 0, X]
```

which is [here](http://hg.sagemath.org/sage-main/file/9ab4ab6e12d0/sage/interfaces/maxima_lib.py#l1358).  I was kind of wondering about this in #11143, but since that didn't touch that I figured it was okay.  [Mathworld](http://mathworld.wolfram.com/ExponentialIntegral.html) seems to indicate that this conversion isn't quite right (where by "isn't quite right" I mean "wrong"), and who knows what this would imply for complex `Z`.  Yikes.


---

Comment by kcrisman created at 2012-07-20 02:57:57

In fact, this makes no sense whatsoever.  We should change the two lone references to `max_gamma_incomplete` to use the appropriate thing for `Ei` instead.  This dates from the very start of the ECL conversions at #7377.  Unless the Maxima `expintegral_ei` is somehow less powerful than the incomplete gamma?

I'm going to try just eliminating all that.


---

Comment by kcrisman created at 2012-07-20 03:12:31

Huh.

Apply

```diff
diff --git a/sage/interfaces/maxima_lib.py b/sage/interfaces/maxima_lib.py
--- a/sage/interfaces/maxima_lib.py
+++ b/sage/interfaces/maxima_lib.py
`@``@` -1165,7 +1165,6 `@``@`
 max_psi=EclObject("$PSI")
 max_array=EclObject("ARRAY")
 mdiff=EclObject("%DERIVATIVE")
-max_gamma_incomplete=sage_op_dict[sage.functions.other.gamma_inc]
 max_lambert_w=sage_op_dict[sage.functions.log.lambert_w]
 
 def mrat_to_sage(expr):
`@``@` -1358,7 +1357,6 `@``@`
     sage.functions.log.polylog : lambda N,X : [[mqapply],[[max_li, max_array],N],X],
     sage.functions.other.psi1 : lambda X : [[mqapply],[[max_psi, max_array],0],X],
     sage.functions.other.psi2 : lambda N,X : [[mqapply],[[max_psi, max_array],N],X],
-    sage.functions.exp_integral.Ei : lambda X : [[max_gamma_incomplete], 0, X],
     sage.functions.log.lambert_w : lambda N,X : [[max_lambert_w], X] if N==EclObject(0) else [[mqapply],[[max_lambert_w, max_array],N],X]
 }
```

to get

```
sage: var('Z')
Z
sage: (Ei(-Z)).limit(Z=oo)
0
sage: (Ei(-Z)).limit(Z=1000)
Ei(-1000)
sage: (Ei(-Z)).limit(Z=1000).n()
-5.07089306023517e-438
```

Tests look good.


---

Comment by kcrisman created at 2012-07-20 03:15:11

In theory, fixing this doesn't need #11143, but might as well do it on that since it's about the same thing.

Oops, still need to add doctests...


---

Comment by kcrisman created at 2012-07-20 03:30:26

Not that I'm guaranteeing this didn't mess anything else up.  But it seems like a better solution overall than keeping the old hack.


---

Comment by kcrisman created at 2012-07-20 03:30:26

Changing status from new to needs_review.


---

Comment by benjaminfjones created at 2012-07-20 19:38:04

Looks good to me, and nice catch. I think it makes sense to have this ticket depend on 11143 so the doctests can be added to the right place. Hopefully that ticket will make it through the gauntlet soon! 

I noticed missing indentation in the doctest block you added. I'll post a quick reviewer patch. If it looks ok to you, I'll set this to positive review.


---

Comment by benjaminfjones created at 2012-07-20 19:38:45

added indentation to new doctest block


---

Attachment


---

Comment by kcrisman created at 2012-07-20 20:46:14

> I noticed missing indentation in the doctest block you added. I'll post a quick reviewer patch. If it looks ok to you, I'll set this to positive review.

Please do.  I can't believe I indented them wrong - that's what happens when you're doing a patch at 11 PM.  Thanks for catching this.


---

Comment by benjaminfjones created at 2012-07-20 23:25:33

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-08-14 07:04:20

Resolution: fixed
