# Issue 13099: wrong sign with function Ei and limit

archive/issues_013099.json:
```json
{
    "body": "Assignee: burcin\n\nCC:  nbruin benjaminfjones dsm\n\nKeywords: Ei limit sign\n\nWe have\n\n```\nsage: (Ei(-Z)).limit(Z=oo)\nInfinity\n```\n\nwhich is wrong, since it should be 0. It seems that there goes something wrong with the `-` sign. This can be also seen here:\n\n```\nsage: (Ei(-Z)).limit(Z=1000)   \n-Ei(1000)\nsage: (Ei(-Z)).limit(Z=1000).n()\n-1.97204513714124e431\n```\n\nBut\n\n```\nsage: Ei(-1000).n()\n-5.07089306023517e-438\nsage: -Ei(1000).n()\n-1.97204513714124e431\n```\n\nwhich are the correct results.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13271\n\n",
    "created_at": "2012-07-18T20:27:03Z",
    "labels": [
        "symbolics",
        "major",
        "bug"
    ],
    "title": "wrong sign with function Ei and limit",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13099",
    "user": "dkrenn"
}
```
Assignee: burcin

CC:  nbruin benjaminfjones dsm

Keywords: Ei limit sign

We have

```
sage: (Ei(-Z)).limit(Z=oo)
Infinity
```

which is wrong, since it should be 0. It seems that there goes something wrong with the `-` sign. This can be also seen here:

```
sage: (Ei(-Z)).limit(Z=1000)   
-Ei(1000)
sage: (Ei(-Z)).limit(Z=1000).n()
-1.97204513714124e431
```

But

```
sage: Ei(-1000).n()
-5.07089306023517e-438
sage: -Ei(1000).n()
-1.97204513714124e431
```

which are the correct results.

Issue created by migration from https://trac.sagemath.org/ticket/13271





---

archive/issue_comments_159383.json:
```json
{
    "body": "Just as a data point, we still get this after #11143, unsurprisingly given that that doesn't touch Maxima.\n\nThis is a little weird, since in both Maxima in current Sage and in Maxima 5.27\n\n```\n(%i5) limit(expintegral_ei(-z),z,inf);\n(%o5)                                  0\n```\n\nFurther,\n\n```\nsage: A = Ei(-Z)._maxima_()\nsage: A.limit(Z,'inf')\n0\n```\n\nUsing the Maxima lib version is ok too.\n\nI have a feeling that the following is the problem,\n\n```\nsage: sage.interfaces.maxima_lib.sr_to_max(SR(Ei(-Z)))\n<ECL: ((%GAMMA_INCOMPLETE) 0 ((MTIMES) |$z| -1))>\n```\n\ncombined with\n\n```\n(%i1) limit(gamma_incomplete(0,-Z),Z,inf);\n(%o1)                              infinity\n```\n\nSo somehow this is completely bypassing the symbol table.  I am out of my depth in our ECL conversions...",
    "created_at": "2012-07-20T02:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13099#issuecomment-159383",
    "user": "kcrisman"
}
```

Just as a data point, we still get this after #11143, unsurprisingly given that that doesn't touch Maxima.

This is a little weird, since in both Maxima in current Sage and in Maxima 5.27

```
(%i5) limit(expintegral_ei(-z),z,inf);
(%o5)                                  0
```

Further,

```
sage: A = Ei(-Z)._maxima_()
sage: A.limit(Z,'inf')
0
```

Using the Maxima lib version is ok too.

I have a feeling that the following is the problem,

```
sage: sage.interfaces.maxima_lib.sr_to_max(SR(Ei(-Z)))
<ECL: ((%GAMMA_INCOMPLETE) 0 ((MTIMES) |$z| -1))>
```

combined with

```
(%i1) limit(gamma_incomplete(0,-Z),Z,inf);
(%o1)                              infinity
```

So somehow this is completely bypassing the symbol table.  I am out of my depth in our ECL conversions...



---

archive/issue_comments_159384.json:
```json
{
    "body": "Or maybe I'm not.\n\n```\nsage.functions.other.Ei : lambda X : [[max_gamma_incomplete], 0, X]\n```\n\nwhich is [here](http://hg.sagemath.org/sage-main/file/9ab4ab6e12d0/sage/interfaces/maxima_lib.py#l1358).  I was kind of wondering about this in #11143, but since that didn't touch that I figured it was okay.  [Mathworld](http://mathworld.wolfram.com/ExponentialIntegral.html) seems to indicate that this conversion isn't quite right (where by \"isn't quite right\" I mean \"wrong\"), and who knows what this would imply for complex `Z`.  Yikes.",
    "created_at": "2012-07-20T02:46:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13099#issuecomment-159384",
    "user": "kcrisman"
}
```

Or maybe I'm not.

```
sage.functions.other.Ei : lambda X : [[max_gamma_incomplete], 0, X]
```

which is [here](http://hg.sagemath.org/sage-main/file/9ab4ab6e12d0/sage/interfaces/maxima_lib.py#l1358).  I was kind of wondering about this in #11143, but since that didn't touch that I figured it was okay.  [Mathworld](http://mathworld.wolfram.com/ExponentialIntegral.html) seems to indicate that this conversion isn't quite right (where by "isn't quite right" I mean "wrong"), and who knows what this would imply for complex `Z`.  Yikes.



---

archive/issue_comments_159385.json:
```json
{
    "body": "In fact, this makes no sense whatsoever.  We should change the two lone references to `max_gamma_incomplete` to use the appropriate thing for `Ei` instead.  This dates from the very start of the ECL conversions at #7377.  Unless the Maxima `expintegral_ei` is somehow less powerful than the incomplete gamma?\n\nI'm going to try just eliminating all that.",
    "created_at": "2012-07-20T02:57:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13099#issuecomment-159385",
    "user": "kcrisman"
}
```

In fact, this makes no sense whatsoever.  We should change the two lone references to `max_gamma_incomplete` to use the appropriate thing for `Ei` instead.  This dates from the very start of the ECL conversions at #7377.  Unless the Maxima `expintegral_ei` is somehow less powerful than the incomplete gamma?

I'm going to try just eliminating all that.



---

archive/issue_comments_159386.json:
```json
{
    "body": "Huh.\n\nApply\n\n```diff\ndiff --git a/sage/interfaces/maxima_lib.py b/sage/interfaces/maxima_lib.py\n--- a/sage/interfaces/maxima_lib.py\n+++ b/sage/interfaces/maxima_lib.py\n@@ -1165,7 +1165,6 @@\n max_psi=EclObject(\"$PSI\")\n max_array=EclObject(\"ARRAY\")\n mdiff=EclObject(\"%DERIVATIVE\")\n-max_gamma_incomplete=sage_op_dict[sage.functions.other.gamma_inc]\n max_lambert_w=sage_op_dict[sage.functions.log.lambert_w]\n \n def mrat_to_sage(expr):\n@@ -1358,7 +1357,6 @@\n     sage.functions.log.polylog : lambda N,X : [[mqapply],[[max_li, max_array],N],X],\n     sage.functions.other.psi1 : lambda X : [[mqapply],[[max_psi, max_array],0],X],\n     sage.functions.other.psi2 : lambda N,X : [[mqapply],[[max_psi, max_array],N],X],\n-    sage.functions.exp_integral.Ei : lambda X : [[max_gamma_incomplete], 0, X],\n     sage.functions.log.lambert_w : lambda N,X : [[max_lambert_w], X] if N==EclObject(0) else [[mqapply],[[max_lambert_w, max_array],N],X]\n }\n```\n\nto get\n\n```\nsage: var('Z')\nZ\nsage: (Ei(-Z)).limit(Z=oo)\n0\nsage: (Ei(-Z)).limit(Z=1000)\nEi(-1000)\nsage: (Ei(-Z)).limit(Z=1000).n()\n-5.07089306023517e-438\n```\n\nTests look good.",
    "created_at": "2012-07-20T03:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13099#issuecomment-159386",
    "user": "kcrisman"
}
```

Huh.

Apply

```diff
diff --git a/sage/interfaces/maxima_lib.py b/sage/interfaces/maxima_lib.py
--- a/sage/interfaces/maxima_lib.py
+++ b/sage/interfaces/maxima_lib.py
@@ -1165,7 +1165,6 @@
 max_psi=EclObject("$PSI")
 max_array=EclObject("ARRAY")
 mdiff=EclObject("%DERIVATIVE")
-max_gamma_incomplete=sage_op_dict[sage.functions.other.gamma_inc]
 max_lambert_w=sage_op_dict[sage.functions.log.lambert_w]
 
 def mrat_to_sage(expr):
@@ -1358,7 +1357,6 @@
     sage.functions.log.polylog : lambda N,X : [[mqapply],[[max_li, max_array],N],X],
     sage.functions.other.psi1 : lambda X : [[mqapply],[[max_psi, max_array],0],X],
     sage.functions.other.psi2 : lambda N,X : [[mqapply],[[max_psi, max_array],N],X],
-    sage.functions.exp_integral.Ei : lambda X : [[max_gamma_incomplete], 0, X],
     sage.functions.log.lambert_w : lambda N,X : [[max_lambert_w], X] if N==EclObject(0) else [[mqapply],[[max_lambert_w, max_array],N],X]
 }
```

to get

```
sage: var('Z')
Z
sage: (Ei(-Z)).limit(Z=oo)
0
sage: (Ei(-Z)).limit(Z=1000)
Ei(-1000)
sage: (Ei(-Z)).limit(Z=1000).n()
-5.07089306023517e-438
```

Tests look good.



---

archive/issue_comments_159387.json:
```json
{
    "body": "In theory, fixing this doesn't need #11143, but might as well do it on that since it's about the same thing.\n\nOops, still need to add doctests...",
    "created_at": "2012-07-20T03:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13099#issuecomment-159387",
    "user": "kcrisman"
}
```

In theory, fixing this doesn't need #11143, but might as well do it on that since it's about the same thing.

Oops, still need to add doctests...



---

archive/issue_comments_159388.json:
```json
{
    "body": "Not that I'm guaranteeing this didn't mess anything else up.  But it seems like a better solution overall than keeping the old hack.",
    "created_at": "2012-07-20T03:30:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13099#issuecomment-159388",
    "user": "kcrisman"
}
```

Not that I'm guaranteeing this didn't mess anything else up.  But it seems like a better solution overall than keeping the old hack.



---

archive/issue_comments_159389.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-07-20T03:30:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13099#issuecomment-159389",
    "user": "kcrisman"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_159390.json:
```json
{
    "body": "Looks good to me, and nice catch. I think it makes sense to have this ticket depend on 11143 so the doctests can be added to the right place. Hopefully that ticket will make it through the gauntlet soon! \n\nI noticed missing indentation in the doctest block you added. I'll post a quick reviewer patch. If it looks ok to you, I'll set this to positive review.",
    "created_at": "2012-07-20T19:38:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13099#issuecomment-159390",
    "user": "benjaminfjones"
}
```

Looks good to me, and nice catch. I think it makes sense to have this ticket depend on 11143 so the doctests can be added to the right place. Hopefully that ticket will make it through the gauntlet soon! 

I noticed missing indentation in the doctest block you added. I'll post a quick reviewer patch. If it looks ok to you, I'll set this to positive review.



---

archive/issue_comments_159391.json:
```json
{
    "body": "added indentation to new doctest block",
    "created_at": "2012-07-20T19:38:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13099#issuecomment-159391",
    "user": "benjaminfjones"
}
```

added indentation to new doctest block



---

archive/issue_comments_159392.json:
```json
{
    "body": "Attachment",
    "created_at": "2012-07-20T19:40:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13099#issuecomment-159392",
    "user": "benjaminfjones"
}
```

Attachment



---

archive/issue_comments_159393.json:
```json
{
    "body": "> I noticed missing indentation in the doctest block you added. I'll post a quick reviewer patch. If it looks ok to you, I'll set this to positive review.\n\nPlease do.  I can't believe I indented them wrong - that's what happens when you're doing a patch at 11 PM.  Thanks for catching this.",
    "created_at": "2012-07-20T20:46:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13099#issuecomment-159393",
    "user": "kcrisman"
}
```

> I noticed missing indentation in the doctest block you added. I'll post a quick reviewer patch. If it looks ok to you, I'll set this to positive review.

Please do.  I can't believe I indented them wrong - that's what happens when you're doing a patch at 11 PM.  Thanks for catching this.



---

archive/issue_comments_159394.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-07-20T23:25:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13099#issuecomment-159394",
    "user": "benjaminfjones"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_159395.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-08-14T07:04:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13099",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13099#issuecomment-159395",
    "user": "jdemeyer"
}
```

Resolution: fixed
