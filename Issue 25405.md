# Issue 25405: wrong cardinality in PartitionDiagrams

Issue created by migration from Trac.

Original creator: mantepse

Original creation time: 2018-06-23 17:31:17

CC:  alauve tscrim zabrocki

There is a simple bug and a strange behaviour:


```
sage: import sage.combinat.diagram_algebras as da
sage: pd = da.PartitionDiagrams(2.5)
sage: pd.cardinality()
15
sage: len(list(pd))
52
sage: pd.cardinality()
15
sage: len(pd.list())
52
sage: pd.cardinality()
52
```


The implementation of `PartitionDiagrams.cardinality` is a trivial mistake, and easy to fix.  It currently reads:

```
        if self.order in ZZ:
            return bell_number(2*self.order)
        return bell_number(2*(self.order-1/2))
```

but should be

```
        return bell_number(2*self.order)
```


However, I do not understand why, after invoking `PartitionDiagrams(2.5).list()`, the method from `finite_enumerated_sets` is used, and I do not understand why this is not the case when invoking `list(PartitionDiagrams(2.5))`.


---

Comment by mantepse created at 2018-06-23 21:09:45

Changing status from new to needs_review.


---

Comment by mantepse created at 2018-06-23 21:09:45

New commits:


---

Comment by mantepse created at 2018-06-23 21:11:00

I do not know whether the strange behaviour observed in the description is something that needs fixing, nor how to do it, if so...


---

Comment by tscrim created at 2018-06-24 07:43:40

Why does this depend on #25462?

`list(foo)` calls the iterator first before `foo.list()`, so it does not set `cardinality` to `_cardinality_from_list`. This is the correct behavior and nothing strange about it. If there was no bug, you would never notice the difference.


---

Comment by zabrocki created at 2018-06-24 16:37:24

I'm getting doctest failures on lines 1229 and 1587 because of the order of the output.


---

Comment by mantepse created at 2018-06-24 19:57:10

Replying to [comment:4 tscrim]:
> Why does this depend on #25462?

Because after #25462 the output order changes, and there is no point in changing the doctests twice.  But if you wish, I can do this, too.

> `list(foo)` calls the iterator first before `foo.list()`, so it does not set `cardinality` to `_cardinality_from_list`. This is the correct behavior and nothing strange about it. If there was no bug, you would never notice the difference.

OK, great!


---

Comment by mantepse created at 2018-06-24 19:58:13

Replying to [comment:5 zabrocki]:
> I'm getting doctest failures on lines 1229 and 1587 because of the order of the output.

Yes, I do not know how to make this properly depend on #25462.  If you do pull in #25462, the output order will be correct.


---

Comment by embray created at 2018-08-13 09:57:25

I noticed this problem in the tests on Python 3, where the problem becomes more pronounced due to slightly different code paths covered by the tests.


---

Comment by embray created at 2018-08-13 09:58:04

Since this depends on #25462, I'll rebase your branch on top of it.  The rest looks like it makes sense to me.


---

Comment by embray created at 2018-08-13 10:39:01

I rebased this on top of #25462, but I still had to update a couple of the doctests.
----
Last 10 new commits:


---

Comment by mantepse created at 2018-08-13 10:43:05

Warning: please note also #25662... (are you touching `contains`?)


---

Comment by tscrim created at 2018-08-13 10:49:45

Martin, you were the one who tweaked the `__contains__`.

Something closer to bikeshedding, but I would want changed before a positive review is splitting the lines for the `NotImplementedError` messages (to ~80 char/line) and making them more concise:

```diff
-            raise NotImplementedError("from_involution_permutation_triple is only implemented for Brauer diagrams of integer order, not for order %s" %(self.order))
+            raise NotImplementedError("only implemented for integer order,"
+                                      " not for order %s" % (self.order))
```

and same for `symmetric_diagrams`. Similar for the output in the doctests.


---

Comment by embray created at 2018-08-13 11:49:26

I'm a little confused--should this also be tweaked to merge cleanly with #25662?


---

Comment by mantepse created at 2018-08-13 11:57:45

Replying to [comment:14 embray]:
> I'm a little confused--should this also be tweaked to merge cleanly with #25662?

No, if I recall correctly, I made this ticket a dependency of #25662.  So this ticket should go in first, then #25659 (which is independent of this ticket), and finally #25662.
----
New commits:


---

Comment by tscrim created at 2018-08-13 12:05:58

Thank you.


---

Comment by tscrim created at 2018-08-13 12:05:58

Changing status from needs_review to positive_review.


---

Comment by mantepse created at 2018-08-13 12:11:06

Wow, that was quick!


---

Comment by vbraun created at 2018-08-17 21:14:17

Resolution: fixed
