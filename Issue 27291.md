# Issue 27291: Remove the highlighting patch for Sphinx

Issue created by migration from https://trac.sagemath.org/ticket/27528

Original creator: jhpalmieri

Original creation time: 2019-03-22 01:25:15

CC:  @timokau

We can accomplish the same thing through a configuration option, as long as we also silence some docbuilding warnings.


---

Comment by jhpalmieri created at 2019-03-22 01:36:10

We want Sage's doctest blocks (and most other literal blocks) to be typeset as Python console code. Setting the default highlighting language to `pycon` does this, and it means that we can then not use the highlighting patch for Sphinx.

Currently in Sage, there are some blocks which are not highlighted correctly. See [this page](http://doc.sagemath.org/html/en/reference/modules/sage/modules/tutorial_free_modules.html): in the first block (containing `CombinatorialFreeModule?`), the prompt "sage:" is not highlighted. With the proposed change, that block will still not be highlighted the way we want, and in fact it will produce a warning:

```
WARNING: Could not lex literal_block as "pycon". Highlighting skipped.
```

We have set up the docbuilding process so that warnings stop it, so we also need to silence this warning.

There are no doubt some blocks in the Sage code which should not be highlighted using `pycon`, but as things stand in current Sage, Sphinx already tries to highlight them using the `default` lexer, which basically means `python3` with a graceful failure if it can't parse it as Python 3: see [the Sphinx docs](https://www.sphinx-doc.org/en/master/usage/configuration.html#confval-highlight_language). Once we set the highlighting language to something other than `default`, we lose the graceful failure, and so we have to silence the warnings.

In my spot-checking, the current non-Python console blocks fail their highlighting and so have no highlighting at all, and that behavior continues with this branch. At some point we could try to modify those blocks: something like

```
Here is a block::

.. highlight:: rest

    stuff
```

But that can be on another ticket.


---

Comment by jhpalmieri created at 2019-03-22 01:45:33

A few blocks in Sage look like

```
Traceback:
..   <-- should be exactly three dots
more stuff
```

Having 2 or 4 dots means that Sphinx can't handle the highlighting: you can see this [here](http://doc.sagemath.org/html/en/reference/combinat/sage/combinat/shifted_primed_tableau.html#sage.combinat.shifted_primed_tableau.ShiftedPrimedTableau.check), where there are 4 dots instead of 3.

Along the same lines, having extra spaces at the end of `NotImplementedError` causes highlighting to fail [here](http://doc.sagemath.org/html/en/reference/power_series/sage/rings/power_series_ring_element.html#sage.rings.power_series_ring_element.PowerSeries.list).


---

Comment by jhpalmieri created at 2019-03-22 01:52:51

New commits:


---

Comment by jhpalmieri created at 2019-03-22 01:52:51

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2019-03-22 03:18:53

By the way, I've tried this with #26451 (Sphinx 1.8.4), #25680 (Python 3.7.2), and both together. No troubles.


---

Comment by jhpalmieri created at 2019-03-24 05:53:02

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-03-24 22:27:37

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2019-03-24 22:35:41

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2019-03-24 22:46:28

Here is a new approach: I just discovered the IPython lexer, and we should definitely use it rather than Python lexer.


---

Comment by jhpalmieri created at 2019-03-24 23:03:36

A few things to check:
- See http://doc.sagemath.org/html/en/constructions/interface_issues.html for some code blocks for other languages (LaTeX, BibTeX, shell session). These are not currently highlighted, but they will be with this branch. Same goes for various shell session blocks scattered through the developer's guide.
- The first block in the [tour-help](http://doc.sagemath.org/html/en/tutorial/tour_help.html)  section of the tutorial is not currently highlighted, but it will be with this branch.
- double check that `<BLANKLINE>` does not appear in the reference manual. One spot to check: from the main reference manual page, click "Symbolic Calculus" and then "Riemann Mapping". The method "complex_to_spiderweb" (toward the end) has some `<BLANKLINE>`s in the doctest output, and they should be rendered as blank lines in the reference manual.


---

Comment by jhpalmieri created at 2019-03-25 05:14:09

To do on another ticket: go through more of the reST docs and perhaps the reference manual, marking the non-sage-doctest blocks using `.. CODE-BLOCK:: language`. I'll open up a followup ticket eventually.


---

Comment by dimpase created at 2019-03-26 00:12:05

works for me nicely. I looked at few random places in various docs, all good.


---

Comment by dimpase created at 2019-03-26 00:12:05

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2019-03-26 04:19:35

Thank you for the review.

See #27549 for a followup: more code-block cleanup.


---

Comment by jdemeyer created at 2019-03-26 09:18:42

Remember to change the package version if you change patches.


---

Comment by jdemeyer created at 2019-03-26 09:18:42

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2019-03-26 09:34:25

Changing status from needs_work to positive_review.


---

Comment by dimpase created at 2019-03-26 09:34:25

How about we just mark  this ticket to be merged together with #26451 - which does a version bump?


---

Comment by jdemeyer created at 2019-03-26 09:40:35

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2019-03-26 09:41:01

Replying to [comment:16 dimpase]:
> How about we just mark  this ticket to be merged together with #26451 - which does a version bump?

If it can be merged separately, I see no reason to bundle them.


---

Comment by dimpase created at 2019-03-26 09:42:26

Changing status from needs_work to positive_review.


---

Comment by dimpase created at 2019-03-26 09:42:26

What's the point of doing this? To do more work than needed? Let's just merge them together.


---

Comment by jdemeyer created at 2019-03-26 09:43:19

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2019-03-26 09:46:05

New commits:


---

Comment by jdemeyer created at 2019-03-26 09:46:05

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2019-03-26 09:48:44

Sometimes it takes less effort to do the right thing rather than arguing about it...


---

Comment by dimpase created at 2019-03-26 09:59:27

OK


---

Comment by dimpase created at 2019-03-26 09:59:27

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2019-03-26 10:30:06

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2019-03-26 10:30:06

Looking at this diff, it seems that indentation is not correct in a few places, for example

```diff
+  that the user should be aware of.
+
+   .. CODE-BLOCK:: rest
```



---

Comment by jdemeyer created at 2019-03-26 10:57:26

I also have doubts about

```
There are 2 tests in doc/en/developer/coding_in_python.rst that are not being run
```



---

Comment by jdemeyer created at 2019-03-26 10:59:26

And shouldn't the `in2_regex` for `IPythonConsoleLexer` be customized too to match `....: `?


---

Comment by git created at 2019-03-26 12:54:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-03-26 13:09:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-03-26 13:14:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2019-03-26 13:15:05

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2019-03-26 13:16:26

I didn't understand the rationale for making a difference depending on the Python version running the docbuilder: the sources are the same on Python 2 and Python 3, so the documentation should also be the same. So I'm using the default version (which is currently Python 2) always.


---

Comment by jdemeyer created at 2019-03-26 14:00:07

Please review the last 3 commits.


---

Comment by dimpase created at 2019-03-26 14:05:26

Replying to [comment:28 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[a323c09](https://git.sagemath.org/sage.git/commit/?id=a323c0965f3020045900cdb0fcb7702d4ec56f88)||`Fix a few CODE-BLOCK indentations`||

I thought wrong indentations result in sphinx errors...


---

Comment by jhpalmieri created at 2019-03-26 17:40:59

My one objection is that the version for the `pygments` package should not say `.p0` since there are no patches any more. Is there anything to be done about this? (Aside from waiting for the next release, that is.)


---

Comment by jhpalmieri created at 2019-03-26 17:45:07

Replying to [comment:34 dimpase]:
> Replying to [comment:28 git]:
> > Branch pushed to git repo; I updated commit sha1. New commits:
> > ||[a323c09](https://git.sagemath.org/sage.git/commit/?id=a323c0965f3020045900cdb0fcb7702d4ec56f88)||`Fix a few CODE-BLOCK indentations`||
> 
> I thought wrong indentations result in sphinx errors...

Sometimes it just results in Sphinx silently ignoring the directive.


---

Comment by jhpalmieri created at 2019-03-26 18:14:59

Replying to [comment:36 jhpalmieri]:
> Replying to [comment:34 dimpase]:
> > Replying to [comment:28 git]:
> > > Branch pushed to git repo; I updated commit sha1. New commits:
> > > ||[a323c09](https://git.sagemath.org/sage.git/commit/?id=a323c0965f3020045900cdb0fcb7702d4ec56f88)||`Fix a few CODE-BLOCK indentations`||
> > 
> > I thought wrong indentations result in sphinx errors...
> 
> Sometimes it just results in Sphinx silently ignoring the directive.

Actually this case looked like

```
text

 .. CODE-BLOCK:: rest

    more text
```

and Sphinx interpreted the extra space in front of `.. CODE-BLOCK...` just as indentation, so the code block was highlighted correctly, just indented more than it should have been.


---

Comment by jhpalmieri created at 2019-03-26 18:15:23

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2019-03-26 18:15:23

Jeroen, thanks for the fixes. There is probably nothing to be done about the pygments version number.


---

Comment by vbraun created at 2019-03-30 20:38:04

Resolution: fixed
