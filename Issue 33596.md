# Issue 33596: Meta-ticket: improve furo theme

Issue created by migration from https://trac.sagemath.org/ticket/33833

Original creator: @tobiasdiez

Original creation time: 2022-05-10 18:32:45

CC:  klee strogdon ​schilly mkoeppe

In #33601, the furo theme has been introduced for the documentation. Before we can make it the standard theme, the remaining issues need to be fixed:

- Reference manual index page and many sub-pagaes don't have a table of contents on the left ​https://516dfe85b21eafae4f042320e5dcf61ad14fe780--sagemath-tobias.netlify.app/reference/
- Index page is missing/not working ​https://516dfe85b21eafae4f042320e5dcf61ad14fe780--sagemath-tobias.netlify.app/
- sage logo in the side bar should link to the top of the Sage manuals

Feel free to add further issues that you find.


---

Comment by git created at 2022-08-01 07:47:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-08-01 07:48:45

Changing status from new to needs_review.


---

Comment by klee created at 2022-08-01 07:51:29

Changing status from needs_review to needs_info.


---

Comment by mkoeppe created at 2022-08-03 16:21:18

It looks like that after these refinements, the new theme may be ready to become standard. How about a sage-devel vote?


---

Comment by klee created at 2022-08-03 19:13:29

I don't see this a problem:

- Reference manual index page and many sub-pagaes don't have a table of contents on the left ​https://516dfe85b21eafae4f042320e5dcf61ad14fe780--sagemath-tobias.netlify.app/reference/ ​

and removed it.

----
Last 10 new commits:


---

Comment by mkoeppe created at 2022-08-03 19:15:14

Replying to [comment:16 klee]:
> I don't see this a problem:
> 
> - Reference manual index page and many sub-pagaes don't have a table of contents on the left ​https://516dfe85b21eafae4f042320e5dcf61ad14fe780--sagemath-tobias.netlify.app/reference/ ​
> 
> and removed it.

I agree


---

Comment by mkoeppe created at 2022-08-03 19:16:48

Also `build/pkgs/furo/type` should be changed to `standard`


---

Comment by mkoeppe created at 2022-08-03 19:17:36

And added to configure.ac's handling of the `--disable-doc` option


---

Comment by klee created at 2022-08-03 19:18:30

Why there is  `elliptic curves` in the dependencies?  

```
... sage_docbuild elliptic_curves furo
```



---

Comment by klee created at 2022-08-03 19:27:17

Replying to [comment:20 mkoeppe]:
> And added to configure.ac's handling of the `--disable-doc` option

You mean this?

```diff
diff --git a/build/pkgs/furo/type b/build/pkgs/furo/type
index 134d9bc32d..a6a7b9cd72 100644
--- a/build/pkgs/furo/type
+++ b/build/pkgs/furo/type
@@ -1 +1 @@
-optional
+standard
diff --git a/configure.ac b/configure.ac
index 4ab080c611..225ffe43d0 100644
--- a/configure.ac
+++ b/configure.ac
@@ -489,7 +489,7 @@ AC_ARG_ENABLE([doc],
   AS_HELP_STRING([--disable-doc],
                  [disable build of the Sage documentation and packages depending on it]), [
     dnl Disable packages needed for docbuilding
-    for pkg in sage_docbuild alabaster babel snowballstemmer imagesize sphinx sphinxcontrib_devhelp sphinxcontrib_jsmath sphinxcontrib_serializinghtml sphinxcontrib_applehelp sphinxcontrib_htmlhelp sphinxcontrib_qthelp sphinxcontrib_websupport jupyter_sphinx; do
+    for pkg in sage_docbuild alabaster babel snowballstemmer imagesize sphinx sphinxcontrib_devhelp sphinxcontrib_jsmath sphinxcontrib_serializinghtml sphinxcontrib_applehelp sphinxcontrib_htmlhelp sphinxcontrib_qthelp sphinxcontrib_websupport jupyter_sphinx furo; do
       AS_VAR_SET([SAGE_ENABLE_$pkg], [$enableval])
     done
     AS_VAR_IF([enableval], [no], [dnl Disable the docbuild by disabling the install tree for documentation
```



---

Comment by git created at 2022-08-03 19:36:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-03 19:40:19

Yes, this


---

Comment by klee created at 2022-08-03 19:42:32

Setting needs review for testing. May need more work.


---

Comment by klee created at 2022-08-03 19:42:32

Changing status from needs_info to needs_review.


---

Comment by mkoeppe created at 2022-08-03 19:48:20

Replying to [comment:21 klee]:
> Why there is  `elliptic curves` in the dependencies?  
> {{{
> ... sage_docbuild elliptic_curves furo
> }}}
It was added in #33421


---

Comment by klee created at 2022-08-03 19:51:06

Replying to [comment:27 mkoeppe]:
> Replying to [comment:21 klee]:
> > Why there is  `elliptic curves` in the dependencies?  
> > {{{
> > ... sage_docbuild elliptic_curves furo
> > }}}
> It was added in #33421

I see. Thanks.


---

Comment by klee created at 2022-08-03 19:57:13

Replying to [comment:13 mkoeppe]:
> It looks like that after these refinements, the new theme may be ready to become standard. How about a sage-devel vote?

I agree. I will propose it after testing.


---

Comment by mkoeppe created at 2022-08-03 20:58:23

https://2505ea042169d8a179d4b1f28a0c0baeabdd421a--sagemath-tobias.netlify.app/reference/plot3d/sage/plot/plot3d/plot3d.html seems to have lost its jupyter-sphinx magic (#33507)


---

Comment by klee created at 2022-08-03 21:13:28

Replying to [comment:30 mkoeppe]:
> https://2505ea042169d8a179d4b1f28a0c0baeabdd421a--sagemath-tobias.netlify.app/reference/plot3d/sage/plot/plot3d/plot3d.html seems to have lost its jupyter-sphinx magic (#33507)

This is not new. The same with the present doc. I don't know why.


---

Comment by mkoeppe created at 2022-08-03 21:30:23

OK. Not important for this ticket.


---

Comment by lorenz created at 2022-08-04 02:31:58

I think it looks great, thanks for making this.

Minor detail: Some of the vertical spacing (e.g., between a method and its description, or around code blocks) doesn't seem quite right to me. I suggest adding the following CSS rules:

```css
dt { margin-top: 1.25ex; margin-bottom: 1.25ex; }
p, ol, ul { margin-top: .75ex; margin-bottom: .75ex; }
p + .highlight-ipycon {margin-top: .75ex; margin-bottom: 1ex; }
```



---

Comment by klee created at 2022-08-04 03:00:44

Replying to [comment:35 lorenz]:
> I think it looks great, thanks for making this.
> 
> Minor detail: Some of the vertical spacing (e.g., between a method and its description, or around code blocks) doesn't seem quite right to me. 

Would you pinpoint to a precise place from the documentation (following the Build Documentation badge)? I could not find one.

I think we should tweak Furo's styles only if the styling is an obvious defect (meaning "look bad to anyone") and is specifically about Sage. If the defect is a general one, the change request should go to the furo project itself.


---

Comment by lorenz created at 2022-08-04 04:13:10

Any page, really: For example, here

![](jJR0poB.png)

there's ample space around `EXAMPLES:` but the lines `rational_maps()` and `Return ...` are stuck together.

The official Furo examples look the same. I'm surprised noone else seems to find the spacing offensive.

Anyway, it's nitpicking, and indeed not our problem.


---

Attachment

Replying to [comment:37 lorenz]:
> there's ample space around `EXAMPLES:` but the lines `rational_maps()` and `Return ...` are stuck together.

I see. The space between "EXAMPLES:" and "sage: ..." is the sum of the space around "EXAMPLES" and the space (margin + border) around "sage: ...". The reason that we see the added sum of the space seems that the background of "sage: ..." is hard to tell from the page background because of similarity of colors. It seems worse in dark mode than in light mode.

If I increase of the contrast between the backgrounds slightly, then it shows

![](pic1.png)
 
Is this better?

> Anyway, it's nitpicking, and indeed not our problem.

As we have lots of example code, we may regard this as our problem.


---

Comment by dimpase created at 2022-08-04 08:52:47

Replying to [comment:37 lorenz]:
> Any page, really: For example, here
> 
> ![](https://i.imgur.com/jJR0poB.png)

Could you please upload pictures as attachments to the ticket, rather than linking to imgur (which shows a lot of ugly spam if you click on the image)?

Once you attached `jJR0poB.png` (there is a tab for this near the top part of the ticket page), you can do `![](jJR0poB.png)`, to the same effect of displaying the image inline.


---

Comment by git created at 2022-08-04 23:56:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-05 01:47:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Attachment


---

Comment by klee created at 2022-08-05 06:14:31

Be aware that there is going on a voting on the background style on sage-devel.


---

Comment by git created at 2022-08-06 09:55:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-06 12:46:44

Changing status from needs_review to positive_review.


---

Comment by klee created at 2022-08-06 14:06:14

Thank you!


---

Comment by @tobiasdiez created at 2022-08-07 09:38:04

Thanks so much for working on this Kwankyu! Really nice to see that furo is now used as the standard doc theme.


---

Comment by klee created at 2022-08-07 09:50:58

Replying to [comment:47 gh-tobiasdiez]:
> Really nice to see that furo is now used as the standard doc theme.

Yes. I didn't know furo before you introduced it to sage. Thank you.


---

Comment by mkoeppe created at 2022-08-07 23:54:46

Changing priority from major to blocker.


---

Comment by vbraun created at 2022-08-27 23:16:43

Makes doctests depend on internet


---

Comment by vbraun created at 2022-08-27 23:16:43

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2022-08-27 23:18:58

e.g.: http://build.sagemath.org/#/builders/5/builds/6/steps/38/logs/stdio


---

Comment by klee created at 2022-08-27 23:50:29

Replying to [comment:51 vbraun]:
> e.g.: http://build.sagemath.org/#/builders/5/builds/6/steps/38/logs/stdio

I can't see how this is related with this ticket...


---

Comment by vbraun created at 2022-08-28 11:13:26

All I know that it doesn't work with this ticket; Presumably `list_packages` ends up calling `pip_remote_version` on furo for some reason.

You can try for yourself by poisoning the proxy variables, e.g.

```
export ftp_proxy=http://192.0.2.0:5187/
export http_proxy=http://192.0.2.0:5187/
export https_proxy=http://192.0.2.0:5187/
export rsync_proxy=http://192.0.2.0:5187/

./sage -t --long --random-seed=123 src/sage/misc/package.py  # 6 doctests failed
```



---

Comment by strogdon created at 2022-08-29 01:36:00

After exporting the above

```
$ env | grep proxy
ftp_proxy=http://192.0.2.0:5187/
https_proxy=http://192.0.2.0:5187/
http_proxy=http://192.0.2.0:5187/
rsync_proxy=http://192.0.2.0:5187/
```

then with

```diff
diff --git a/src/sage/misc/package.py b/src/sage/misc/package.py
index 849ee71f3f..137eb6013a 100644
--- a/src/sage/misc/package.py
+++ b/src/sage/misc/package.py
@@ -259,7 +259,7 @@ def list_packages(*pkg_types: str, pkg_sources: List[str] = ['normal', 'pip', 's
     EXAMPLES::
 
         sage: from sage.misc.package import list_packages
-        sage: L = list_packages('standard')    # optional - sage_spkg
+        sage: L = list_packages('standard', local=True)    # optional - sage_spkg
         sage: sorted(L.keys())                 # optional - sage_spkg, random
         ['alabaster',
          'arb',
```

I get

```
sage -t --long --warn-long 93.6 --random-seed=123 src/sage/misc/package.py
    [56 tests, 4.07 s]
----------------------------------------------------------------------
All tests passed!
```

I'm not sure what's so special with `furo`? Is it the only pkg of type `pip`?


---

Comment by mkoeppe created at 2022-08-29 01:37:09

I think it's the only standard pip package. We should change it to a normal package.


---

Comment by mkoeppe created at 2022-08-29 01:45:17

This now needs `sphinx-theme-builder` as a build dependency
----
New commits:


---

Comment by mkoeppe created at 2022-08-29 01:54:55

... and this pulls in a number of other dependencies.

So maybe we need to keep it optional after all, and just ask Harald to use it when he builds the documentation...


---

Comment by klee created at 2022-08-29 03:50:31

Replying to [comment:55 mkoeppe]:
> I think it's the only standard pip package. We should change it to a normal package.

Why? The solution of :comment:54 does not suffice?


---

Comment by klee created at 2022-08-29 03:53:20

Ah, I just found

```
by policy, no standard package is allowed to be a pip package.
```

in the developer manual. Then why is that?


---

Comment by mkoeppe created at 2022-08-29 03:53:37

Yes, exactly, the doctest failure is only a symptom of the real problem: We cannot have standard pip packages.


---

Comment by mkoeppe created at 2022-08-29 03:54:34

We build a self-contained source tarball, which contains the tarballs of all standard packages in upstream/

So the source tarball can be installed without internet connectivity.


---

Comment by mkoeppe created at 2022-08-29 03:55:34

Sorry that I forgot about that when I reviewed the ticket!


---

Comment by klee created at 2022-08-29 04:05:08

Replying to [comment:64 mkoeppe]:
> Sorry that I forgot about that when I reviewed the ticket!

The policy should be mentioned here:

https://doc.sagemath.org/html/en/developer/packaging.html#prerequisites-for-new-standard-packages


---

Comment by klee created at 2022-08-29 04:09:59

Then could it be that furo is still the default when we build sage from source?


---

Comment by mkoeppe created at 2022-08-29 04:14:02

We'd need to add the Python packages that are needed for building furo from source. But I'm not sure if that solves the problem completely because one of these dependencies is `nodeenv`, which suggests that the build process may also need to fetch Javascript packages.


---

Comment by mkoeppe created at 2022-08-29 04:16:59

I'd suggest that we back out the change to "standard" from this ticket and pursue the path to make it a standard normal package on a separate ticket


---

Comment by git created at 2022-08-29 04:46:35

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2022-08-29 04:48:38

Anyway here's the branch with all the dependencies - and it does have the problem that I thought:

```
[furo-2022.6.21] Building wheels for collected packages: furo
[furo-2022.6.21]   Building wheel for furo (pyproject.toml): started
[furo-2022.6.21]   Running command Building wheel for furo (pyproject.toml)
[furo-2022.6.21]   [stb] # nodeenv does not exist.
[furo-2022.6.21]   [stb] # Generating new nodeenv with NodeJS 16.15.1!
[furo-2022.6.21]   [stb] $ python -m nodeenv --node=16.15.1 --prebuilt --clean-src
[furo-2022.6.21]   /Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/local/var/lib/sage/venv-pyth
[furo-2022.6.21]   on3.8/var/tmp/sage/build/furo-2022.6.21/src/.nodeenv
[furo-2022.6.21]    * Install prebuilt node (16.15.1) .
[...]
[furo-2022.6.21]   TimeoutError: [Errno 60] Operation timed out
[furo-2022.6.21] 
```


(it's trying to download Node.js from the internet, which fails because our installation poisons the https proxy)


---

Comment by mkoeppe created at 2022-08-29 04:54:21

An alternative direction would be to install furo from a wheel. We don't have a mechanism for that yet, but it would not be very hard to add.

This would avoid the complicated nodeenv business (which is only needed for from-source build of furo).

I've opened #34450 for this


---

Comment by git created at 2022-08-29 05:26:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-08-29 05:27:07

Try this


---

Comment by mkoeppe created at 2022-08-29 05:27:44

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-08-29 05:48:39

Replying to [comment:65 klee]:
> Replying to [comment:64 mkoeppe]:
> > Sorry that I forgot about that when I reviewed the ticket!
> 
> The policy should be mentioned here:
> 
> https://doc.sagemath.org/html/en/developer/packaging.html#prerequisites-for-new-standard-packages

I've added it to the documentation in #34450


---

Comment by klee created at 2022-08-29 13:37:08

Replying to [comment:73 mkoeppe]:
> Try this

With #34421, the branch successfully builds sage and doc in furo theme from scratch.


---

Comment by klee created at 2022-08-29 15:00:58

Changing status from needs_review to positive_review.


---

Comment by klee created at 2022-08-29 15:00:58

It works well. Thank Matthias!
----
New commits:


---

Comment by klee created at 2022-08-29 15:28:18

The branch also passes Volker's test.


---

Comment by mkoeppe created at 2022-08-29 15:30:33

Great, thanks for testing!


---

Comment by vbraun created at 2022-09-07 23:10:35

Resolution: fixed
