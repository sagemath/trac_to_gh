# Issue 32432: Adding upper and lower Bruhat cones of M. Dyer to Coxeter groups

Issue created by migration from https://trac.sagemath.org/ticket/32669

Original creator: @DennisJahn

Original creation time: 2021-10-11 13:05:22

CC:  tscrim

Keywords: Coxeter groups, reflection groups, Bruhat order, Bruhat cones,

To a pair of elements x,y in a Coxeter group W one can associate two polyhedral cones. The 'upper bruhat cone' generated by all roots beta such that s_beta * x covers x and s_beta * x <= y and similarly the 'lower bruhat cone' generated by all beta sucht that y covers s_beta * y and x <= s_beta * y .

These cones were used in https://eudml.org/doc/174610 and https://arxiv.org/abs/2103.03715


---

Comment by git created at 2021-10-13 09:43:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DennisJahn created at 2021-10-13 11:55:20

Changing status from new to needs_review.


---

Comment by chapoton created at 2021-10-13 15:34:20

would examples with WeylGroup or CoxeterGroup work ?


---

Comment by @DennisJahn created at 2021-10-14 07:08:03

The method reflection_to_positive_root() is used. As far as I saw neither WeylGroup nor CoxeterGroup has this method. WeylGroup has furthermore no method to obtain roots roots.


---

Comment by git created at 2021-10-14 07:40:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-14 13:36:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-15 07:19:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-10-15 07:32:55

in Weyl Groups, there is 

```
src/sage/categories/weyl_groups.py:        def reflection_to_root
```



---

Comment by @DennisJahn created at 2021-10-15 08:03:21

I see. Then writing a similar method for Weyl Groups should be possible using reflection_to_root() and then to_ambient()


---

Comment by git created at 2021-10-25 13:38:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-25 14:30:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-11-22 11:43:05

Thank you for your contribuation. I have a rather long list of comments. Most of them are minor issues I think.

A green bot unfortunatly only means that you added the optional tags correctly, as the bots don't have gap3 installed.

- You should probably add your references from the ticket description.
  As pointed in https://doc.sagemath.org/html/en/developer/coding_basics.html#python-code-style
at `REFERENCES` and `ALGORITHM`.

-

```
            wi = self.apply_simple_reflection(i, side = 'right')
            return [(u.apply_simple_reflection(i, side='right'),r.apply_conjugation_by_simple_reflection(i)) for u,r in wi.bruhat_lower_covers_reflections() if not u.has_descent(i, side='right')] + [(wi, self.parent().simple_reflection(i))]
```

  Those lines need some work. `side='right` is a keyword and should therefore not contain spaces.
  The second line is way to long and should be wrapped according to PEP8.
  We are not ultra stright with 79 characters, but it is still good to keep it at that.
  Also it is impossible to understand what this line does like this. So I would propose:

```
            wi = self.apply_simple_reflection(i, side='right')
            return [(u.apply_simple_reflection(i, side='right'),
                     r.apply_conjugation_by_simple_reflection(i))
                    for u, r in wi.bruhat_lower_covers_reflections()
                    if not u.has_descent(i, side='right')] + [
                (wi, self.parent().simple_reflection(i))]
```

  Yes, I know that you did not introduce this ultra-long line, but it is still good to fix it, when touching.
- From the ticket I gather that your changes in `coxeter_group.py` are motivated by a bug. Can you please add a test to `CoxeterGroups` that illustrates what has been fixed now. Something:

```
TESTS:

Check bug discovered in :trac:`32669` is fixed:

    sage: 2 + 2
    4
```

- The description on `bruhat_cone` is hard to read. The first line should just be a brief sentence describing what the function does. No need to contain all definitions.
- This should be reworked:

```diff
+        For ``side`` = ``'upper'``: ``s_beta`` ``x`` covers ``x`` and ``x`` <= ``s_beta`` ``x`` <= ``y``.
+
+        For ``side`` = ``'lower'``: ``y`` covers ``s_beta`` ``y`` and ``x`` <= ``s_beta`` ``y`` <= ``y``.
```

  I don't know what it means. What are those things called: `Upper Bruhat cone` and `Lower Bruhat cone`? If you just call them by names, that already makes the start easier to read. You know you can also use latex in the docstring. Maybe this makes it easier to read:
https://doc.sagemath.org/html/en/developer/coding_basics.html#section-latex-typeset
- The input `x` and `y` needs to be explained.
- Your doctests do not pass:

```
File "src/sage/combinat/root_system/reflection_group_real.py", line 732, in sage.combinat.root_system.reflection_group_real.RealReflectionGroup.bruhat_cone
Failed example:
    W.bruhat_cone(x, y)                                   # optional - gap3
Expected:
    A 2-dimensional polyhedron in ZZ^2 defined as the convex hull of 1 vertex and 2 rays
Got:
    A 2-dimensional polyhedron in QQ^2 defined as the convex hull of 1 vertex and 2 rays
**********************************************************************
File "src/sage/combinat/root_system/reflection_group_real.py", line 738, in sage.combinat.root_system.reflection_group_real.RealReflectionGroup.bruhat_cone
Failed example:
    W.bruhat_cone(x, y, side = 'lower')                   # optional - gap3
Expected:
    A 6-dimensional polyhedron in ZZ^6 defined as the convex hull of 1 vertex and 6 rays
Got:
    A 6-dimensional polyhedron in QQ^6 defined as the convex hull of 1 vertex and 6 rays
```


There are also other failing doctests discovered, because people apparently do not test `gap3` at all:

```
File "src/sage/combinat/root_system/reflection_group_element.pyx", line 72, in sage.combinat.root_system.reflection_group_element.ComplexReflectionGroupElement.__hash__
Failed example:
    WB_hash.intersection(WC_hash)                     # optional - gap3
Expected:
    set()
Got:
    {-9126606217563690753,
     -9111617679337390865,
     -9021783181305004801,
     -9008457096590967825,
     -8825287278071369473,
     -8737678173820754961,
     -8665277549911544081,
     -8446633060280535041,
     -8323654867644563729,
     -8124071536798024977,
     -8116295769124982033,
     -8108062643194285329,
     -8049278353572089345,
     -8046023783577836817,
     -8045847864374923025,
     -8042003968497354753,
     -7957288799848911889,
     ...
```

  However, you did not cause this I think. If we don't fix them here (which definitely needs not to happen), which should open a ticket for them.
  Likewise `src/sage/categories/coxeter_groups.py` does not pass:

```
$ sage -t --long --optional=build,debian,dochtml,e_antic,normaliz,pip,pynormaliz,sage,sage.geometry.polyhedron,sage.rings.real_double,sage_spkg,gap3 src/sage/categories/coxeter_groups.py 
too many failed tests, not using stored timings
Running doctests with ID 2021-11-22-12-29-31-05e09ddd.
Git branch: test_32669
Using --optional=build,debian,dochtml,e_antic,gap3,normaliz,pip,pynormaliz,sage,sage.geometry.polyhedron,sage.rings.real_double,sage_spkg
Doctesting 1 file.
sage -t --long --random-seed=289954757401290987674537126910226284546 src/sage/categories/coxeter_groups.py
**********************************************************************
File "src/sage/categories/coxeter_groups.py", line 240, in sage.categories.coxeter_groups.CoxeterGroups.ParentMethods.braid_group_as_finitely_presented_group
Failed example:
    W.braid_group_as_finitely_presented_group()            # optional - gap3
Exception raised:
    Traceback (most recent call last):
      File "sage/misc/cachefunc.pyx", line 996, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:5998)
        return self.cache[k]
      File "sage/misc/weak_dict.pyx", line 704, in sage.misc.weak_dict.WeakValueDictionary.__getitem__ (build/cythonized/sage/misc/weak_dict.c:3752)
        raise KeyError(k)
    KeyError: ((<class 'sage.combinat.root_system.type_relabel.CartanType'>, ['B', 3], Finite family {1: 5, 2: 'BB', 3: 'AA'}), ())

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.categories.coxeter_groups.CoxeterGroups.ParentMethods.braid_group_as_finitely_presented_group[5]>", line 1, in <module>
        W.braid_group_as_finitely_presented_group()            # optional - gap3
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/categories/coxeter_groups.py", line 251, in braid_group_as_finitely_presented_group
        rels = self.braid_relations()
      File "sage/misc/cachefunc.pyx", line 2310, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12957)
        self.cache = f(self._instance)
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/combinat/root_system/reflection_group_complex.py", line 1392, in braid_relations
        return super(ComplexReflectionGroup,self).braid_relations()
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/categories/coxeter_groups.py", line 215, in braid_relations
        M = self.coxeter_matrix()
      File "sage/misc/cachefunc.pyx", line 2310, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12957)
        self.cache = f(self._instance)
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/combinat/root_system/reflection_group_real.py", line 639, in coxeter_matrix
        return self.cartan_type().coxeter_matrix()
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/combinat/root_system/reflection_group_real.py", line 430, in cartan_type
        return C.relabel(CG.is_isomorphic(G, edge_labels=True, certificate=True)[1])
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/combinat/root_system/cartan_type.py", line 1236, in relabel
        return type_relabel.CartanType(self, relabelling)
      File "sage/misc/classcall_metaclass.pyx", line 320, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1779)
        return cls.classcall(cls, *args, **kwds)
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/combinat/root_system/type_relabel.py", line 57, in __classcall__
        return super(CartanType, cls).__classcall__(cls, type, relabelling)
      File "sage/misc/cachefunc.pyx", line 1001, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6126)
        w = self.f(*args, **kwds)
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/structure/unique_representation.py", line 1007, in __classcall__
        instance = typecall(cls, *args, **options)
      File "sage/misc/classcall_metaclass.pyx", line 482, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2243)
        return (<PyTypeObject*>type).tp_call(cls, args, kwds)
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/combinat/root_system/type_relabel.py", line 179, in __init__
        self._index_set = tuple(sorted(relabelling[i] for i in type.index_set()))
    TypeError: '<' not supported between instances of 'str' and 'int'
**********************************************************************
File "src/sage/categories/coxeter_groups.py", line 288, in sage.categories.coxeter_groups.CoxeterGroups.ParentMethods.braid_orbit
Failed example:
    W.braid_orbit(w.reduced_word())                        # optional - gap3
Exception raised:
    Traceback (most recent call last):
      File "sage/misc/cachefunc.pyx", line 996, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:5998)
        return self.cache[k]
      File "sage/misc/weak_dict.pyx", line 704, in sage.misc.weak_dict.WeakValueDictionary.__getitem__ (build/cythonized/sage/misc/weak_dict.c:3752)
        raise KeyError(k)
    KeyError: ((<class 'sage.combinat.root_system.type_relabel.CartanType'>, ['A', 3], Finite family {1: 'AA', 2: 'BB', 3: 5}), ())

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.categories.coxeter_groups.CoxeterGroups.ParentMethods.braid_orbit[8]>", line 1, in <module>
        W.braid_orbit(w.reduced_word())                        # optional - gap3
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/categories/coxeter_groups.py", line 318, in braid_orbit
        braid_rels = self.braid_relations()
      File "sage/misc/cachefunc.pyx", line 2310, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12957)
        self.cache = f(self._instance)
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/combinat/root_system/reflection_group_complex.py", line 1392, in braid_relations
        return super(ComplexReflectionGroup,self).braid_relations()
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/categories/coxeter_groups.py", line 215, in braid_relations
        M = self.coxeter_matrix()
      File "sage/misc/cachefunc.pyx", line 2310, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12957)
        self.cache = f(self._instance)
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/combinat/root_system/reflection_group_real.py", line 639, in coxeter_matrix
        return self.cartan_type().coxeter_matrix()
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/combinat/root_system/reflection_group_real.py", line 430, in cartan_type
        return C.relabel(CG.is_isomorphic(G, edge_labels=True, certificate=True)[1])
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/combinat/root_system/cartan_type.py", line 1236, in relabel
        return type_relabel.CartanType(self, relabelling)
      File "sage/misc/classcall_metaclass.pyx", line 320, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1779)
        return cls.classcall(cls, *args, **kwds)
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/combinat/root_system/type_relabel.py", line 57, in __classcall__
        return super(CartanType, cls).__classcall__(cls, type, relabelling)
      File "sage/misc/cachefunc.pyx", line 1001, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6126)
        w = self.f(*args, **kwds)
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/structure/unique_representation.py", line 1007, in __classcall__
        instance = typecall(cls, *args, **options)
      File "sage/misc/classcall_metaclass.pyx", line 482, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2243)
        return (<PyTypeObject*>type).tp_call(cls, args, kwds)
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/combinat/root_system/type_relabel.py", line 179, in __init__
        self._index_set = tuple(sorted(relabelling[i] for i in type.index_set()))
    TypeError: '<' not supported between instances of 'int' and 'str'
**********************************************************************
File "src/sage/categories/coxeter_groups.py", line 1538, in sage.categories.coxeter_groups.CoxeterGroups.ElementMethods.reduced_words
Failed example:
    w.reduced_words()                                      # optional - gap3
Exception raised:
    Traceback (most recent call last):
      File "sage/misc/cachefunc.pyx", line 996, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:5998)
        return self.cache[k]
      File "sage/misc/weak_dict.pyx", line 704, in sage.misc.weak_dict.WeakValueDictionary.__getitem__ (build/cythonized/sage/misc/weak_dict.c:3752)
        raise KeyError(k)
    KeyError: ((<class 'sage.combinat.root_system.type_relabel.CartanType'>, ['A', 3], Finite family {1: 'AA', 2: 'BB', 3: 5}), ())

    During handling of the above exception, another exception occurred:

    Traceback (most recent call last):
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.categories.coxeter_groups.CoxeterGroups.ElementMethods.reduced_words[9]>", line 1, in <module>
        w.reduced_words()                                      # optional - gap3
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/categories/coxeter_groups.py", line 1566, in reduced_words
        return self.parent().braid_orbit(self.reduced_word())
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/categories/coxeter_groups.py", line 318, in braid_orbit
        braid_rels = self.braid_relations()
      File "sage/misc/cachefunc.pyx", line 2310, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12957)
        self.cache = f(self._instance)
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/combinat/root_system/reflection_group_complex.py", line 1392, in braid_relations
        return super(ComplexReflectionGroup,self).braid_relations()
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/categories/coxeter_groups.py", line 215, in braid_relations
        M = self.coxeter_matrix()
      File "sage/misc/cachefunc.pyx", line 2310, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (build/cythonized/sage/misc/cachefunc.c:12957)
        self.cache = f(self._instance)
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/combinat/root_system/reflection_group_real.py", line 639, in coxeter_matrix
        return self.cartan_type().coxeter_matrix()
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/combinat/root_system/reflection_group_real.py", line 430, in cartan_type
        return C.relabel(CG.is_isomorphic(G, edge_labels=True, certificate=True)[1])
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/combinat/root_system/cartan_type.py", line 1236, in relabel
        return type_relabel.CartanType(self, relabelling)
      File "sage/misc/classcall_metaclass.pyx", line 320, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1779)
        return cls.classcall(cls, *args, **kwds)
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/combinat/root_system/type_relabel.py", line 57, in __classcall__
        return super(CartanType, cls).__classcall__(cls, type, relabelling)
      File "sage/misc/cachefunc.pyx", line 1001, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6126)
        w = self.f(*args, **kwds)
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/structure/unique_representation.py", line 1007, in __classcall__
        instance = typecall(cls, *args, **options)
      File "sage/misc/classcall_metaclass.pyx", line 482, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2243)
        return (<PyTypeObject*>type).tp_call(cls, args, kwds)
      File "/srv/public/kliem/sage/local/var/lib/sage/venv-python3.7/lib/python3.7/site-packages/sage/combinat/root_system/type_relabel.py", line 179, in __init__
        self._index_set = tuple(sorted(relabelling[i] for i in type.index_set()))
    TypeError: '<' not supported between instances of 'int' and 'str'
**********************************************************************
3 items had failures:
   1 of  11 in sage.categories.coxeter_groups.CoxeterGroups.ElementMethods.reduced_words
   1 of   7 in sage.categories.coxeter_groups.CoxeterGroups.ParentMethods.braid_group_as_finitely_presented_group
   1 of  10 in sage.categories.coxeter_groups.CoxeterGroups.ParentMethods.braid_orbit
    [504 tests, 3 failures, 5.61 s]
```

- It would be good to have doctests that illustrate some actual properties. E.g. you could illustrate the definition.
- In your actual code there are also some very long lines. They could also be wrapped. E.g.:

```diff
-            roots = [self.reflection_to_positive_root(x*r*x.inverse()) for z, r in x.bruhat_upper_covers_reflections() if z.bruhat_le(y)]
+            roots = [self.reflection_to_positive_root(x * r * x.inverse())
+                     for z, r in x.bruhat_upper_covers_reflections()
+                     if z.bruhat_le(y)]
```

- After the `ValueError` there could be an empty line. Likewise an empty line would make sense after `from sage.rings.qqbar import AA as base_ring`, because this is when the `if ... else` is over.


---

Comment by git created at 2021-11-23 12:29:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-23 12:54:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-24 12:28:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-24 13:41:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DennisJahn created at 2021-11-24 14:05:32

Replying to [comment:14 gh-kliem]:

Thank you very much for your detailed feedback.

> * You should probably add your references from the ticket description.

I added the references.

> * Those lines need some work.
> * The second line is way to long and should be wrapped according to PEP8.
> * Also it is impossible to understand what this line does like this.

I changed the lines according to your suggestions.

> * From the ticket I gather that your changes in `coxeter_groups.py` are motivated by a bug. Can you please add a test to `CoxeterGroups` that illustrates what has been fixed now.

I added a test. The bug did only occur for the permutation implementation, so the test is only for this implementation.

> * The description on `bruhat_cone` is hard to read.

There now is a new description using latex but I'm not sure if this description would be better in an `ALGORITHM` section.

> * Your doctests do not pass:

They should pass now.

> * There are also other failing doctests discovered, because people apparently do not test `gap3` at all.

I would prefer opening a new ticket for this. 

> * In your actual code there are also some very long lines.

I wrapped them and added the suggested empty lines.


---

Comment by chapoton created at 2021-11-26 07:51:14

`Tests:` should be `TESTS:`

for arxiv, use the arxiv role, namely `:arxiv:`2103.03715``

the new `raise` must have a doctest

The `else` here is superfluous :

```
+        else:
+            if backend == 'cdd':
```

Removing it would allow to indent the code less


---

Comment by git created at 2021-11-26 10:59:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DennisJahn created at 2021-11-26 11:10:32

Replying to [comment:20 chapoton]:
> `Tests:` should be `TESTS:`
> 
> for arxiv, use the arxiv role, namely `:arxiv:`2103.03715``
> 
> the new `raise` must have a doctest
> 
> The `else` here is superfluous :
> {{{
> +        else:
> +            if backend == 'cdd':
> }}}
> Removing it would allow to indent the code less

Thanks!
I changed/added the parts according to your comment.
The local doctests for `reflection_group_real.py` including `gap3` passed.


---

Comment by chapoton created at 2021-11-26 14:33:49

the new tests for raise are not indented correctly


---

Comment by git created at 2021-11-26 19:07:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DennisJahn created at 2021-11-26 19:10:14

Replying to [comment:23 chapoton]:
> the new tests for raise are not indented correctly

You are correct, I completely missed that.


---

Comment by git created at 2021-11-29 09:11:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2021-11-29 20:34:48

typo in *cooresponding* (at least twice)


---

Comment by git created at 2021-11-30 09:14:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-03 08:41:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2022-03-18 14:20:16

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2022-03-18 14:20:16

red branch, so needs a rebase => needs_work status


---

Comment by git created at 2022-03-22 12:43:02

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2022-03-23 11:56:22

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by @DennisJahn created at 2022-03-24 10:24:32

Changing status from needs_work to needs_review.


---

Comment by @DennisJahn created at 2022-03-24 10:24:32

I did a rebase but I'm not really sure if I did it correctly.
There are three doctests failing but they are on methods I didn't touch.

Setting it back to _needs_review_ for comments and (maybe) a review.


---

Comment by chapoton created at 2022-04-12 06:39:47

Your branch is a little mess, with too many commits. I would suggest to start a new branch afresh. Please just copy-paste your changes atop the latest develop, so that there is only one commit.

I am also not so sure about the "bug" in Coxeter groups. Travis, any opinion ?

And you should rather add doctests not depending on the gap3 package too.


---

Comment by chapoton created at 2022-04-12 07:55:50

It may be a good idea to add an alias

```
reflection_to_positive_root = reflection_to_root
```

in

```
src/sage/categories/weyl_groups.py
```



---

Comment by tscrim created at 2022-04-12 15:34:24

I also think we should not use `gap3` for the doctests. There are plenty of other implementations available.

The “bug” should be on a separate ticket, but I don’t know if it is a bug. Nevertheless, it is likely an improvement because we should be explicit about the side (although it should be consistent).


---

Comment by git created at 2022-04-13 11:28:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DennisJahn created at 2022-04-13 11:38:16

Replying to [comment:36 chapoton]:
> Your branch is a little mess, with too many commits. I would suggest to start a new branch afresh. Please just copy-paste your changes atop the latest develop, so that there is only one commit.

I hope this worked.
 
> I am also not so sure about the "bug" in Coxeter groups. Travis, any opinion ?

The bug only appeared using the _permutation_ implementation. If you run the new doctest with the old function you should see the problem.

> And you should rather add doctests not depending on the gap3 package too.

I'm confused about that. The implementation of ReflectionGroup in reflection_group_real.py heavily depends on gap3 and cannot be used without it. Why should there be doctests without gap3? Is this even possible?


---

Comment by chapoton created at 2022-04-13 12:35:30

Replying to [comment:40 gh-DennisJahn]:
> Replying to [comment:36 chapoton]:
> > Your branch is a little mess, with too many commits. I would suggest to start a new branch afresh. Please just copy-paste your changes atop the latest develop, so that there is only one commit.
> 
> I hope this worked.

No. If you click on the word "Commits" here above, you will see that your branch is still made of very many commits. Maybe I was not clear enough in my suggestion ? Save outside of the the git repository of sage the current status (in your branch) of the 2 files that you have modified. Then use git to start a new branch on top of develop. Then copy back the modified files and commit. Then push here under a new branch name.

> > And you should rather add doctests not depending on the gap3 package too.
> 
> I'm confused about that. The implementation of ReflectionGroup in reflection_group_real.py heavily depends on gap3 and cannot be used without it. Why should there be doctests without gap3? Is this even possible?

Gap3 itself is no longer maintained, and it's rather miraculous that it still works and that one can use it for reflection groups in sage. Using comment:37, your code should work on Weyl groups and be doctested for them.


---

Comment by @DennisJahn created at 2022-04-13 14:19:37

Replying to [comment:41 chapoton]:
> No. If you click on the word "Commits" here above, you will see that your branch is still made of very many commits. Maybe I was not clear enough in my suggestion ? Save outside of the the git repository of sage the current status (in your branch) of the 2 files that you have modified. Then use git to start a new branch on top of develop. Then copy back the modified files and commit. Then push here under a new branch name.

I used 'git reset --hard develop' locally and pushed my modifications after that but that wasn't enough then. I'll try something else.
 
> Gap3 itself is no longer maintained, and it's rather miraculous that it still works and that one can use it for reflection groups in sage. Using comment:37, your code should work on Weyl groups and be doctested for them.

The method bruhat_cone is already implemented for Weyl groups. That was done in #32710.
The purpose of this ticket is to implement it for reflection groups to also include non-crystallographic coxeter groups and further use the implementation for subword complexes in #32681.


---

Comment by git created at 2022-04-14 07:25:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-04-14 07:31:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DennisJahn created at 2022-04-14 07:35:18

Replying to [comment:42 gh-DennisJahn]:

> I used 'git reset --hard develop' locally and pushed my modifications after that but that wasn't enough then. I'll try something else.

Now it should have worked. There are only two entries in the list of commits, one for each modified file.


---

Comment by chapoton created at 2022-04-14 08:13:06

thanks.

Now, I see a lot of code duplication with the existing implementation in Weyl groups found in

```
src/sage/categories/weyl_groups.py
```


In my opinion, it is desirable and should be possible to have only one common implementation.


---

Comment by @DennisJahn created at 2022-04-14 09:01:49

Replying to [comment:46 chapoton]:
> thanks.
> 
> Now, I see a lot of code duplication with the existing implementation in Weyl groups found in
> {{{
> src/sage/categories/weyl_groups.py
> }}}
> 
> In my opinion, it is desirable and should be possible to have only one common implementation.

I would agree but I think we had this discussion already. I can' find it anymore though.

The only parent/super category in common is coxeter groups and there is no implementation of roots or the cartan matrix in there. Furthermore the implementation of roots in Weyl groups is very different from the one in reflection groups.
In Weyl groups their embedding depends on the degree of the group (A4 having 5, E6 and E8 having 8), while in reflection groups it depends on the rank.

I currently have no idea how to combine these worlds.


---

Comment by tscrim created at 2022-04-16 17:40:28

This is still done at the category level, so there should be some other implementation not relying on `gap3`, right?

I don’t understand the point you are making about the implementation of the roots. The data is well-defined and the root systems are isomorphic. I agree with `@`chapoton that we should have one common code that is agnostic to the choice of implementation. If things are not melding together properly, then we need to look at the code and unify it somehow.

Then there is an issue with the permutation implementation about either its internal consistency or with the generic implementation that needs to be fixed. This would sweep the issue under the rug.


---

Comment by @DennisJahn created at 2022-04-19 08:12:32

Replying to [comment:48 tscrim]:
> This is still done at the category level, so there should be some other implementation not relying on `gap3`, right?

The implementation for Weyl groups is done in

```
src/sage/categories/weyl_groups.py
```

at the category level, yes. 
The implementation for this ticket is done in

```
src/sage/combinat/root_system/reflection_group_real.py
```

what is, if I understand correctly, not at the catagory level.

Furthermore, I think, the only super category in common is CoxeterGroups. 
And for reflection groups this seems to be the case only sometimes?
What I mean is that, depending on the input data, sometimes a reflection group is initialized as Coxeter group, but not always.

So my question/problem is: Where should an implementation of 'Bruhat cones' be done such that both, Weyl groups and reflection groups, can use it? 
Wherever that is should be an existing implementation of roots that is compatible with the implementations used for Weyl groups and reflection groups. 

------

> Then there is an issue with the permutation implementation about either its internal consistency or with the generic implementation that needs to be fixed. This would sweep the issue under the rug.

I did not dive fully into this function. It wasn't working and all the other, similar functions used the side='right' flag. So I tried that and then it worked...


---

Comment by stumpc5 created at 2022-09-12 10:45:43

Dear Travis and Frederic, `@`tscrim, `@`chapoton:

Dennis is about to finish his thesis and I would like this code to go in! I do not understand your points that this should go into the category level because neither Coxeter groups (finite or not) or complex reflection groups there come with a root system attached. This code heavily uses root systems, so this is needed.

WeylGroups have this at the category level, that's why it worked for these.

Best,
Christian


---

Comment by chapoton created at 2022-09-12 11:56:45

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2022-09-12 11:56:45

oh, well. Let's move on.


Let me note that to still depend on gap3 in 2022 is a bit sad.


---

Comment by stumpc5 created at 2022-09-12 12:05:23

Thanks Frederic!

> Let me note that to still depend on gap3 in 2022 is a bit sad.

I agree, but Jean Michel is porting it to julia (https://github.com/jmichel7/Gapjm.jl). Once this is done, we can move there!


---

Comment by chapoton created at 2022-09-12 12:53:27

Well, this does not sound like really good news to me.


---

Comment by tscrim created at 2022-09-12 13:15:23

Changing status from positive_review to needs_work.


---

Comment by tscrim created at 2022-09-12 13:15:23

I just have some little doc things though before merging it in:

Please move the references to the master reference file and roughly follow the format there.


```diff
-        - ``x`` - an element in the group `W`
-
-        - ``y`` - an element in the group `W`
-
-        - ``side`` (default: ``'upper'``) -- must be one of the following:
+        - ``x`` -- an element in the group `W`
+        - ``y`` — an element in the group `W`
+        - ``side`` — (default: ``'upper'``) must be one of the following:
```



---

Comment by git created at 2022-09-13 07:50:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DennisJahn created at 2022-09-13 07:51:04

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2022-09-13 07:59:08

Thank you.


---

Comment by tscrim created at 2022-09-13 07:59:08

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-09-20 20:23:16

Resolution: fixed
