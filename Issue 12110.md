# Issue 12110: Fix strcmp() will NULL argument in termcap library

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2012-01-09 10:07:32

Assignee: tbd

If the environment variable `TERMCAP` is set and `TERM` is not set, then calling `tgetent()` from the termcap library produces a Segmentation Fault because it calls `strcmp()` with a NULL argument.


---

Comment by zimmerma created at 2012-01-09 10:21:56

Changing status from new to needs_info.


---

Comment by zimmerma created at 2012-01-09 10:21:56

Jeroen, I cannot reproduce this issue:

```
tiramisu% cat tgetent_test.c
#include <termcap.h>
#include <stdlib.h>

int main(int argc, char** argv)
{
  char* buf = malloc(100000);
  tgetent(buf, "dumb");
}
tiramisu% gcc tgetent_test.c -o tgetent_test -ltermcap
tiramisu% printenv | grep TERM
TERMCAP=1
tiramisu% ./tgetent_test
tiramisu%
```

Paul


---

Comment by zimmerma created at 2012-01-09 10:22:16

Changing keywords from "" to "sd35.5".


---

Comment by jdemeyer created at 2012-01-09 10:33:31

Changing status from needs_info to needs_review.


---

Comment by jdemeyer created at 2012-01-09 10:35:52

The fix in the spkg is

```diff
diff -ru src/termcap.c src.fixed/termcap.c
--- src/termcap.c       2002-02-25 18:59:21.000000000 +0100
+++ src.fixed/termcap.c 2012-01-09 11:04:54.000000000 +0100
`@``@` -460,6 +460,7 `@``@`
   char *tcenv = NULL;          /* TERMCAP value, if it contains :tc=.  */
   char *indirect = NULL;       /* Terminal type in :tc= in TERMCAP value.  */
   int filep;
+  char *term_name;
 
 #ifdef INTERNAL_TERMINAL
   /* For the internal terminal we don't want to read any termcap file,
`@``@` -500,7 +501,8 `@``@`
      it is the entry itself, but only if
      the name the caller requested matches the TERM variable.  */
 
-  if (termcap_name && !filep && !strcmp (name, getenv ("TERM")))
+  term_name = getenv("TERM");
+  if (termcap_name && !filep && term_name && !strcmp (name, term_name))
     {
       indirect = tgetst1 (find_capability (termcap_name, "tc"), (char **) 0);
       if (!indirect)
```



---

Comment by wjp created at 2012-01-09 10:39:45

Did you forget to commit the changes in the spkg?


---

Comment by jdemeyer created at 2012-01-09 10:45:18

Replying to [comment:5 wjp]:
> Did you forget to commit the changes in the spkg?

Yes and no.  I prefer to commit them _after_ positive_review (this leaves a cleaner hg repository if reviewers request small changes).


---

Comment by jdemeyer created at 2012-01-09 13:19:27

Committed changes now.


---

Comment by wjp created at 2012-01-09 13:32:33

I'm not sure how you triggered this error in sage (and therefore if the actual behaviour is really relevant), but are you sure this is the right behaviour when TERM is unset? I'd probably expect an unset TERM to behave the same as an empty TERM. Your suggested change prevents the TERMCAP value from being used at all in this case, I believe.


---

Comment by jdemeyer created at 2012-01-09 13:41:07

Replying to [comment:10 wjp]:
> I'm not sure how you triggered this error in sage (and therefore if the actual behaviour is really relevant)
There is more info at #11970.  It's a combination of the new readline spkg at #11970 and the patch at #12263, and it also depends on the gcc version.

> but are you sure this is the right behaviour when TERM is unset? I'd probably expect an unset TERM to behave the same as an empty TERM.
In practice, this will be the case.  The `tgetent()` code checks whether the argument `char *term` equals the environment variable "TERM".  Normally, `term` will not be the empty string.  But you are certainly right that

```
term_name = getenv("TERM");
if (!term_name)
    term_name = "";
```

would also work.


---

Comment by ppurka created at 2012-01-09 15:45:18

Just a small comment: line 10 of Makefile.patch should say

+# I *commented* this (William), since SAGE install should work as not-root.

My experience with Makefiles is quite elementary, so I can not comment on Makefile.patch. Aside from that, the rest of the changes looks good.


---

Comment by leif created at 2012-01-09 20:22:44

Replying to [comment:13 ppurka]:
> Just a small comment: line 10 of Makefile.patch should say
> 
> +# I *commented* this (William), since SAGE install should work as not-root.
> 
> My experience with Makefiles is quite elementary, so I can not comment on Makefile.patch. Aside from that, the rest of the changes looks good.

Well, William's change(s) are more or less superfluous anyway, so I'd drop them.  (I looked at the spkg a while ago, but the little changes weren't worth a ticket or new spkg.

 * Instead of changing the target `all`, we should use `$MAKE libtermcap.a`, then the info files won't get built, and hence not installed (also *without* commenting out the `for` loop).

 * Commenting out `oldinstalldir=...` isn't necessary, but also wrong; it should either be set to the empty string, or (if we assume nobody builds Sage as root) left as is, since the lines of the receipt that try to install into `/usr/include` are preceded by dashs anyway, i.e. `make` doesn't fail because of lacking file permissions.

In the latter case we wouldn't have to patch the Makefile at all.

(Slightly OT: Should we in general issue a warning -- or abort the build -- if someone builds Sage as root?)




Another minor thing: In `spkg-install`, `-m64` should be *ap*pended, since it should take precedence over whatever a user specified in `CFLAGS`.


---

Comment by jdemeyer created at 2012-01-09 20:28:01

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-01-09 20:28:01

Replying to [comment:14 leif]:
> Well, William's change(s) are more or less superfluous anyway, so I'd drop them.  (I looked at the spkg a while ago, but the little changes weren't worth a ticket or new spkg.
> 
>  * Instead of changing the target `all`, we should use `$MAKE libtermcap.a`, then the info files won't get built, and hence not installed (also *without* commenting out the `for` loop).
> 
>  * Commenting out `oldinstalldir=...` isn't necessary, but also wrong; it should either be set to the empty string, or (if we assume nobody builds Sage as root) left as is, since the lines of the receipt that try to install into `/usr/include` are preceded by dashs anyway, i.e. `make` doesn't fail because of lacking file permissions.
> 
> In the latter case we wouldn't have to patch the Makefile at all.
Maybe you are right, but I don't want to make these minor changes now in this blocker ticket.  If you want to make a follow-up ticket for the above, go ahead.

> Another minor thing: In `spkg-install`, `-m64` should be *ap*pended, since it should take precedence over whatever a user specified in `CFLAGS`.
Done.


---

Comment by jdemeyer created at 2012-01-09 20:31:23

Replying to [comment:13 ppurka]:
> Just a small comment: line 10 of Makefile.patch should say
> 
> +# I *commented* this (William), since SAGE install should work as not-root.
Thanks, I fixed this comment.

> My experience with Makefiles is quite elementary, so I can not comment on Makefile.patch.
Luckily, there is no need to review the Makefile.  This is an old patch which was directly applied to the src/ directory, instead of being applied by `spkg-install`.  I restored the upstream sources and made an explicit patch.  So the file `patches/Makefile.patch` doesn't need to be reviewed for this ticket.


---

Comment by jdemeyer created at 2012-01-09 20:31:23

Changing status from needs_work to needs_review.


---

Comment by leif created at 2012-01-09 20:32:40

Replying to [ticket:12282 jdemeyer]:
> If the environment variable `TERMCAP` is set and `TERM` is not set, then calling `tgetent()` from the termcap library produces a Segmentation Fault because it calls `strcmp()` with a NULL argument.  Sage hits this problem because of readline, see #11970.

Two further remarks:

 * `TERMCAP` is incidentally set by `$SAGE_ROOT/spkg/install` (like a couple of other "abused" environment variables).

 * readline isn't supposed to use _Sage's_ termcap; the p4 at #11970 avoids its use under all circumstances (perhaps unless one manually adds `-L$SAGE_LOCAL/lib/` to `LDFLAGS` or the like).


---

Comment by jdemeyer created at 2012-01-09 20:44:01

Replying to [comment:17 leif]:
> Replying to [ticket:12282 jdemeyer]:
> > If the environment variable `TERMCAP` is set and `TERM` is not set, then calling `tgetent()` from the termcap library produces a Segmentation Fault because it calls `strcmp()` with a NULL argument.  Sage hits this problem because of readline, see #11970.
> 
> Two further remarks:
> 
>  * `TERMCAP` is incidentally set by `$SAGE_ROOT/spkg/install` (like a couple of other "abused" environment variables).
Very true.  Luckily, this problem is restricted to the Sage installation scripts, and not to running Sage (which would be a much more serious problem).

>  * readline isn't supposed to use _Sage's_ termcap;
Why not?  My guess is that we ship `termcap` precisely because `readline` might need it.


---

Comment by leif created at 2012-01-09 21:21:38

Replying to [comment:18 jdemeyer]:
> Replying to [comment:17 leif]:
> >  * readline isn't supposed to use _Sage's_ termcap;
> Why not?  My guess is that we ship `termcap` precisely because `readline` might need it.

No, a few other packages like PARI use it.  If readline would use it, we should also build a shared library (which the package as is doesn't offer), and, more importantly, use _that_ termcap library's headers (`-I$SAGE_LOCAL/include`).

But somebody meanwhile messed up the dependencies in `spkg/standard/deps` as if readline would depend on (Sage's) termcap. 

In principle we could drop the spkg, since there are [newer] replacements on every supported system AFAIK.

----

One more thing: _Chang*e*log_ lacks an _"e"_ in `SPKG.txt`.

I'd rename `Makefile.patch` to `Makefile.in.patch` to avoid confusion.


---

Attachment


---

Comment by jdemeyer created at 2012-01-11 10:21:13

Replying to [comment:19 leif]:
> One more thing: _Chang*e*log_ lacks an _"e"_ in `SPKG.txt`.
> 
> I'd rename `Makefile.patch` to `Makefile.in.patch` to avoid confusion.
I made these changes, needs review.


---

Comment by jdemeyer created at 2012-01-11 10:23:39

Replying to [comment:19 leif]:
> But somebody meanwhile messed up the dependencies in `spkg/standard/deps` as if readline would depend on (Sage's) termcap.
Since #11970, readline does link in Sage's termcap (at least with some compilers/linkers), so I don't think that #12098 was a mistake.


---

Comment by jdemeyer created at 2012-01-11 10:31:04

Replying to [comment:19 leif]:
> No, a few other packages like PARI use it.
PARI certainly doesn't (I find no mention of the string "termcap" in the PARI source tree).

> In principle we could drop the spkg, since there are [newer] replacements on every supported system AFAIK.
If this is true, then I would support this.  I don't know whether your assumption ("replacements on every supported system") is true though.


---

Comment by ppurka created at 2012-01-11 10:51:44

Replying to [comment:22 jdemeyer]:
> Replying to [comment:19 leif]:
> > In principle we could drop the spkg, since there are [newer] replacements on every supported system AFAIK.
> If this is true, then I would support this.  I don't know whether your assumption ("replacements on every supported system") is true though.

This might very well be true. I see this in the README of termcap:

```
However, use of termcap is discouraged.  Termcap is
being phased out in favor of the terminfo-based ncurses library, which
contains an emulation of the termcap library routines in addition to
an excellent curses implementation.  ncurses is available from the
usual GNU archive sites.
```

terminfo seems to be around since 1981. That's a long enough time for all systems to have caught up by now. Other websites:
http://www.catb.org/~esr/terminfo/
http://en.wikipedia.org/wiki/Terminfo


---

Comment by jhpalmieri created at 2012-01-12 06:26:48

Just for fun I removed the termcap spkg and modified spkg/install and spkg/standard/deps accordingly.  All tests passed on sage.math and on OS X 10.6.  I haven't tried on any other platforms.


---

Comment by leif created at 2012-01-12 21:48:47

Replying to [comment:22 jdemeyer]:
> Replying to [comment:19 leif]:
> > No, a few other packages like PARI use it.
> PARI certainly doesn't (I find no mention of the string "termcap" in the PARI source tree).

Look into (e.g.) `pari-*/src/config/get_readline`.

PARI usually looks for readline, and then ncurses, then eventually gives libtermcap a try (for `tgetent()`; but apparently only in conjunction with readline).


---

Comment by GeorgSWeber created at 2012-01-15 15:36:54

Looks good to me.


---

Comment by GeorgSWeber created at 2012-01-15 15:36:54

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-01-15 15:40:49

Many thanks for the review.


---

Comment by jdemeyer created at 2012-01-15 15:40:49

Resolution: fixed


---

Comment by kini created at 2012-01-16 05:20:08

Replying to [comment:6 jdemeyer]:
> Replying to [comment:5 wjp]:
> > Did you forget to commit the changes in the spkg?
> 
> Yes and no.  I prefer to commit them _after_ positive_review (this leaves a cleaner hg repository if reviewers request small changes).

FWIW, you can amend the latest commit in a Mercurial repository by doing the following: `hg qimport -r tip`, make some edits, `hg qrefresh -De` (to update the commit date/time and message), `hg qfinish tip`.


---

Comment by jdemeyer created at 2012-01-16 08:31:11

Replying to [comment:30 kini]:
> FWIW, you can amend the latest commit in a Mercurial repository by doing the following: `hg qimport -r tip`, make some edits, `hg qrefresh -De` (to update the commit date/time and message), `hg qfinish tip`.
I didn't know this, thanks for the "tip".


---

Comment by leif created at 2012-01-16 18:51:48

Replying to [comment:31 jdemeyer]:
> Replying to [comment:30 kini]:
> > FWIW, you can amend the latest commit in a Mercurial repository by doing the following: `hg qimport -r tip`, make some edits, `hg qrefresh -De` (to update the commit date/time and message), `hg qfinish tip`.
> I didn't know this, thanks for the "tip".

FWIW, for a single "uncommit", you can also use `hg rollback`.


---

Comment by kini created at 2012-01-17 04:25:03

Replying to [comment:32 leif]:
> FWIW, for a single "uncommit", you can also use `hg rollback`.

Well, actually `hg rollback` will undo the latest action that was a `commit`, `pull`, `unbundle`, or any other modification to the data store. So that might not be the latest commit, in general. It might not even be under your control if you are allowing users to push to your repository remotely, as someone's push to your repo also counts as something to `rollback`. And it only stores one action to undo, so if any other such actions have been performed since the latest commit, you can no longer use `hg rollback` to uncommit it.


---

Comment by leif created at 2012-01-17 19:07:39

Replying to [comment:33 kini]:
> Replying to [comment:32 leif]:
> > FWIW, for a single "uncommit", you can also use `hg rollback`.
> 
> Well, actually `hg rollback` will undo the latest action that was a `commit`, `pull`, `unbundle`, or any other modification to the data store. So that might not be the latest commit, in general. It might not even be under your control if you are allowing users to push to your repository remotely, as someone's push to your repo also counts as something to `rollback`. And it only stores one action to undo, so if any other such actions have been performed since the latest commit, you can no longer use `hg rollback` to uncommit it.

:-) As always, one should know what one's doing...

I was thinking of (and originally planned to write) smth like

```sh
while true; do
    hg commit -m "foo"
    hg rollback
    # edit
    # reupload spkg
done
```

