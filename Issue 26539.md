# Issue 26539: MonoDict/TripleDict: optimize use of KeyedRef

Issue created by migration from https://trac.sagemath.org/ticket/26776

Original creator: jdemeyer

Original creation time: 2018-11-27 12:52:11

CC:  simonking

Some useful micro-optimizations can be done to how `MonoDict` and `TripleDict` uses `KeyedRef`:

1. Replace `isinstance(x, KeyedRef)` by `type(x) is KeyedRef`.

2. Replace `PyWeakref_GetObject` by `PyWeakref_GET_OBJECT`.

We also add an inline function `is_dead_weakref` for `isinstance(x, KeyedRef) and PyWeakref_GetObject(x) is Py_None` which appears in many places.


---

Comment by jdemeyer created at 2018-11-28 15:16:17

New commits:


---

Comment by jdemeyer created at 2018-11-28 15:16:17

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-11-28 16:08:37

Reviewing some of this code makes me wonder whether we really need all those checks for dead `KeyedRef`s in `get()`. Shouldn't the eraser ensure that no dead references occur?


---

Comment by jdemeyer created at 2018-11-28 16:19:40

In more detail: if we find a dead weakref in `__getitem__` (or `__contains__` which is similar), `lookup()` guarantees that the `id()` of the key in the dict matches the given key. If it's really the same key, then the weakref should not be dead since we have a live reference (passed as argument to `__getitem__`). If it's not the same key, then it must be a recycled `id()`. But that can only happen once the original key has been freed from memory, which happens after the weakref callback, which should remove the entry from the dict.

So I don't see any scenario how a dead weakref could be found in `__getitem__`, but I might be missing something...


---

Comment by jdemeyer created at 2018-11-28 16:33:11

(Note: the reasoning above is for dead keys; dead values could still occur in the middle of a deallocation)


---

Comment by git created at 2018-11-28 20:10:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-11-28 20:11:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-11-29 13:00:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-12-01 12:43:37

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2018-12-02 12:41:53

LGTM.


---

Comment by tscrim created at 2018-12-02 12:41:53

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-12-05 23:56:15

Resolution: fixed
