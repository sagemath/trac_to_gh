# Issue 21116: get rid of guess_category

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2016-08-26 22:39:43

CC:  tscrim nthiery simonking mkoeppe

We remove the quite fragile `guess_category` from `sage.structure.category_object.


---

Comment by vdelecroix created at 2016-08-26 22:40:14

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2016-08-26 22:40:14

New commits:


---

Comment by nthiery created at 2016-08-27 05:25:47

+1 on getting rid of this kludge if we finally can!

About the change `Parent.__init__` -> `Ring.__init__`: if this does not induce complications, I would tend to use the occasion to not have `InfinityRing` inherit from `Ring` and instead pass `category=Rings()` to `Parent.__init__`.

I don't expect a need for pure speed for this parent, right? Of course the elements could still belong to `RingElement`.


---

Comment by tscrim created at 2016-08-27 15:59:25

Replying to [comment:4 nthiery]:
> About the change `Parent.__init__` -> `Ring.__init__`: if this does not induce complications, I would tend to use the occasion to not have `InfinityRing` inherit from `Ring` and instead pass `category=Rings()` to `Parent.__init__`.

Doing that change would remove some functionality from `InfinityRing` (although I highly, highly doubt anyone is creating things like ideals of the infinity ring). Although that would be something

> I don't expect a need for pure speed for this parent, right? Of course the elements could still belong to `RingElement`. 

I believe we have this parent (essentially) nailed in memory at startup because of `oo`. So I don't think this is an issue at the end of the day.


---

Comment by vdelecroix created at 2016-08-27 22:52:23

It does introduce complications: removing the inheritance from `Ring` causes error due to the absence of methods `is_integral_domain` and `is_field`. Some doctests are creating vector/matrices over the infinity ring.


---

Comment by nthiery created at 2016-08-28 06:07:18

Replying to [comment:6 vdelecroix]:
> It does introduce complications: removing the inheritance from `Ring` causes error due to the absence of methods `is_integral_domain` and `is_field`. Some doctests are creating vector/matrices over the infinity ring.

Ah, shoot. That would be easy to fix by moving up those methods to
`Rings`, which anyway we want to do at some point. But then that's
starting to shift beyond the scope of this ticket.

As an intermediate step, one could keep for now the inheritance from
`Ring`, and pass a `category=Rings()` argument to `Parent`.

As you feel like guys!


---

Comment by vdelecroix created at 2016-08-31 14:57:32

I am setting #20686 as a dependency since it is very likely to create merge failures.

Replying to [comment:7 nthiery]:
> Replying to [comment:6 vdelecroix]:
> > It does introduce complications: removing the inheritance from `Ring` causes error due to the absence of methods `is_integral_domain` and `is_field`. Some doctests are creating vector/matrices over the infinity ring.
> 
> Ah, shoot. That would be easy to fix by moving up those methods to
> `Rings`, which anyway we want to do at some point. But then that's
> starting to shift beyond the scope of this ticket.

If you do open a ticket for that, I would be happy to review.

> As an intermediate step, one could keep for now the inheritance from
> `Ring`, and pass a `category=Rings()` argument to `Parent`.

Well be better to get rid of `sage.structure.rings.Ring` in one step.


---

Comment by git created at 2016-09-19 05:46:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2016-09-19 06:03:36

rebased


---

Comment by jdemeyer created at 2016-09-19 16:45:03

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-09-19 16:45:03

Replying to [comment:10 vdelecroix]:
> rebased
...on an old version of Sage.

Still needs rebase.


---

Comment by git created at 2016-10-13 13:14:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2016-10-13 13:15:29

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2016-10-13 13:15:29

rebased on rc1


---

Comment by jdemeyer created at 2016-10-13 13:21:18

If this passes doctests, I have no objections. Nicolas?


---

Comment by jdemeyer created at 2016-10-13 13:26:51

Maybe two details: we should add a check like

```
if not isinstance(category, Category)
    raise TypeError(f"invalid category {category} for {self}")
```

(or at least check that `category is not None`)

And remove the "or None" from the documentation line

```
- ``category`` -- a category, or list or tuple thereof, or ``None``
```



---

Comment by jdemeyer created at 2016-10-13 13:26:51

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2016-10-13 13:34:26

This modification makes Sage crash on startup...

```
TypeError: invalid category None for Parent of MIPVariables
```



---

Comment by vdelecroix created at 2016-10-13 13:35:56

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2016-10-13 13:39:24

Perhaps we should raise a warning? Also, I agree that we should remove `None` from the doc because we should not initialize parents without categories, or have the default be `Sets()`.


---

Comment by jdemeyer created at 2016-10-17 07:47:05

Replying to [comment:18 vdelecroix]:
> This modification makes Sage crash on startup...
> {{{
> TypeError: invalid category None for Parent of MIPVariables
> }}}

That shows to me that this ticket isn't ready. I think we should only remove `guess_category` when everything is actually initialized with a category.


---

Comment by jdemeyer created at 2016-10-17 07:47:05

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2016-10-17 14:34:48

Matthias, do you know if `MIPVariables` needs to be a parent, and if so, could the category for that parent be simply changed to `Sets`?


---

Comment by jdemeyer created at 2016-10-17 15:28:11

Replying to [comment:22 tscrim]:
> Matthias, do you know if `MIPVariables` needs to be a parent

A Sage `Element` class requires a `Parent` class so I guess the answer is "yes" here.

> could the category for that parent be simply changed to `Sets`?

Probably also "yes".


---

Comment by tscrim created at 2016-10-17 18:03:07

So, if I explicit pass `Sets` as the category for that, make `set_generic` have a default category of `Sets`, I still have a can of worms between changing the doctests (trivial) to the more non-trivial parent of interfaces, e.g., I get:

```
TypeError: invalid category None for C library interface to GAP
```


What are people's thoughts on making the default category for `Parent` be `Sets`. At least this seemed to generate less individual issues...


---

Comment by mkoeppe created at 2016-10-17 20:31:05

Replying to [comment:22 tscrim]:
> Matthias, do you know if `MIPVariables` needs to be a parent, and if so, could the category for that parent be simply changed to `Sets`?
A `MIPVariable` is a strange thing at the moment. In particular it is mutable. Currently there is a parent class called `MIPVariableParent`. Not sure where it fits with regards to categories.


---

Comment by vdelecroix created at 2016-10-17 21:09:39

As far as I understand, the only reason why `MIPVariables` is a parent is because it benefits from coercion (like scalar multiplication). And as far as I know, the only way to use coercion is to use the `Category`/`Parent`/`Element` framework.


---

Comment by tscrim created at 2016-10-17 21:32:23

Replying to [comment:26 vdelecroix]:
> As far as I understand, the only reason why `MIPVariables` is a parent is because it benefits from coercion (like scalar multiplication). And as far as I know, the only way to use coercion is to use the `Category`/`Parent`/`Element` framework.

I think we could just lift the necessary parts directly into `MIPVariables` as it is an action, and IIRC, the coercion framework has some support for things that are not parents (e.g., python `int`). That would make a good follow-up ticket.


---

Comment by jdemeyer created at 2017-10-26 11:50:31

I have no idea why, but it seems that the problems on this ticket no longer occur. I am deprecating `guess_category` on #24109, so this ticket can be closed as duplicate.


---

Comment by jdemeyer created at 2017-10-26 12:51:32

Replying to [comment:28 jdemeyer]:
> so this ticket can be closed as duplicate.

...unless you want to keep some of the other changes that you did on this ticket.


---

Comment by tscrim created at 2017-10-27 04:04:37

The only current changes I'd really want to keep are in `rings/infinity.py` so infinity rings properly declare their categories.

Also, from looking at the code for `MIPVariables`, the parent probably should be removed and instead `MIPVariable` just implemented as `__mul__` and `__rmul__` as a subclass of `SageObject`.

Want me to do both of those things here on this ticket and make this independent of #24109?


---

Comment by jdemeyer created at 2017-10-27 10:32:58

Replying to [comment:30 tscrim]:
> Want me to do both of those things here on this ticket and make this independent of #24109?

I don't know who you are asking...

I would say: feel free to do that or to close this ticket.


---

Comment by tscrim created at 2017-10-27 13:11:39

Replying to [comment:31 jdemeyer]:
> Replying to [comment:30 tscrim]:
> > Want me to do both of those things here on this ticket and make this independent of #24109?
> 
> I don't know who you are asking...

More to you since you did #24109.

> I would say: feel free to do that or to close this ticket.

I will go ahead and do that tomorrow (I am now on Australia time) at some point.


---

Comment by tscrim created at 2017-10-29 07:13:12

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-10-29 07:13:12

New branch that removes the parent for MIP variables and does the `Ring.__init__` for initializing the category of infinity rings.
----
New commits:


---

Comment by jdemeyer created at 2017-10-29 07:40:30

`return NotImplemented` instead of `raise TypeError`. Also I would avoid the name `self` in arithmetic slot functions: use `left` and `right` instead of `self` and `m`.


---

Comment by git created at 2017-10-29 08:30:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-10-29 08:31:00

Both good points. Changed.


---

Comment by jdemeyer created at 2017-10-30 15:37:47

Don't use `from sage.matrix.matrix import is_Matrix`. Import it from `sage.structure.element` instead. See #24096


---

Comment by jdemeyer created at 2017-10-30 16:07:13

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-10-30 22:21:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-10-30 22:22:17

Right...somehow I should put 2 and 2 together and get 4, Sage tells me that is true. :P


---

Comment by tscrim created at 2017-10-30 22:22:17

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-10-31 08:10:01

I didn't say that this has to depend on #24096. I only asked to write it in such a way that it doesn't conflict with #24096.


---

Comment by tscrim created at 2017-10-31 08:17:58

I didn't see how that was possible because this moves two calls to `is_Matrix` and their imports (even if it was not consolidated into 1 top-level import). Really #24096 is positively reviewed, so it's not a big deal.


---

Comment by jdemeyer created at 2017-10-31 08:21:09

Replying to [comment:42 tscrim]:
> I didn't see how that was possible because this moves two calls to `is_Matrix` and their imports

OK, I thought that you only _added_ imports in this patch, but you did indeed _move_ an import.


---

Comment by jdemeyer created at 2017-11-28 13:38:31

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-11-28 13:38:31

Merge conflict. Note that you may want to wait until the next beta when #24096 is merged.


---

Comment by git created at 2017-12-30 02:38:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-12-30 02:38:38

Rebased


---

Comment by tscrim created at 2017-12-30 02:38:38

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-12-30 10:36:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2017-12-30 10:38:12

Added an extra doctest for checking about the base ring being taken into account.

I am happy with the current version.


---

Comment by tscrim created at 2017-12-30 21:18:07

LGTM, thanks.


---

Comment by tscrim created at 2017-12-30 21:18:07

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-01-01 14:20:21

Resolution: fixed
