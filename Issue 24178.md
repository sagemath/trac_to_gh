# Issue 24178: py3: fixes to sage.cpython.getattr

archive/issues_024178.json:
```json
{
    "body": "CC:  simonking jdemeyer chapoton\n\nKeywords: getattr\n\nThis makes a few minor fixes to this module for better Python 3 support, but also one change that is potentially impactful.\n\nThe problem with this module on Python 3 is the use of a single reusable `AttributeError` instance for each call of `getattr_from_other_class`.  This was causing quite a bit of havok on Python 3, where exception objects have much more information attached to them--most significantly the traceback object itself (on its `__traceback__` attribute), as well as the `__context__` attribute for exceptions that were raised while handling a different exception (which in turn still has its own traceback attached to it).\n\nSince this global `AttributeError` instance is never deallocated, then following a call to `getattr_from_other_class` if it raises an `AttributeError`, that error's traceback and associated stack frames and their local variables persist until the next `AttributeError`, resulting in various reference leaks, cycles, and also some truly baffling tracebacks.\n\nThis ticket undoes that optimization (originally from #14100).  My own findings were that on Python 2 it at best had a saving of ~0.5\u00b5s, and practically no noticeable improvement on Python 3.  I'm not convinced this is a major bottleneck, as efficient loops should not be raising exceptions in the first place, much less `AttributeError`s.\n\nThat said, I might be missing some context to this and would be open to other solutions.  I do have one other solution that would be just as good in terms of performance, but would unfortunately be much more complicated code-wise so I'd have to be sure it's really worth the trouble...\n\nIssue created by migration from https://trac.sagemath.org/ticket/24415\n\n",
    "created_at": "2017-12-21T13:46:21Z",
    "labels": [
        "python3",
        "major",
        "bug"
    ],
    "title": "py3: fixes to sage.cpython.getattr",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24178",
    "user": "embray"
}
```
CC:  simonking jdemeyer chapoton

Keywords: getattr

This makes a few minor fixes to this module for better Python 3 support, but also one change that is potentially impactful.

The problem with this module on Python 3 is the use of a single reusable `AttributeError` instance for each call of `getattr_from_other_class`.  This was causing quite a bit of havok on Python 3, where exception objects have much more information attached to them--most significantly the traceback object itself (on its `__traceback__` attribute), as well as the `__context__` attribute for exceptions that were raised while handling a different exception (which in turn still has its own traceback attached to it).

Since this global `AttributeError` instance is never deallocated, then following a call to `getattr_from_other_class` if it raises an `AttributeError`, that error's traceback and associated stack frames and their local variables persist until the next `AttributeError`, resulting in various reference leaks, cycles, and also some truly baffling tracebacks.

This ticket undoes that optimization (originally from #14100).  My own findings were that on Python 2 it at best had a saving of ~0.5Âµs, and practically no noticeable improvement on Python 3.  I'm not convinced this is a major bottleneck, as efficient loops should not be raising exceptions in the first place, much less `AttributeError`s.

That said, I might be missing some context to this and would be open to other solutions.  I do have one other solution that would be just as good in terms of performance, but would unfortunately be much more complicated code-wise so I'd have to be sure it's really worth the trouble...

Issue created by migration from https://trac.sagemath.org/ticket/24415





---

archive/issue_comments_338753.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-12-21T13:46:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24178#issuecomment-338753",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_338754.json:
```json
{
    "body": "I added a few fixes, please review.\n----\nNew commits:",
    "created_at": "2018-01-05T10:42:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24178#issuecomment-338754",
    "user": "jdemeyer"
}
```

I added a few fixes, please review.
----
New commits:



---

archive/issue_comments_338755.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-01-05T12:10:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24178#issuecomment-338755",
    "user": "embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_338756.json:
```json
{
    "body": "Thanks--I actually had the same fix to the tests in my python3 branch but forgot to cherry-pick it into this.  The rest LGTM.",
    "created_at": "2018-01-05T12:10:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24178#issuecomment-338756",
    "user": "embray"
}
```

Thanks--I actually had the same fix to the tests in my python3 branch but forgot to cherry-pick it into this.  The rest LGTM.



---

archive/issue_comments_338757.json:
```json
{
    "body": "FWIW if constructing the `AttributeError` is *really* a bottleneck--of which I'm skeptical--I have an experimental rewrite that uses a free list of pre-allocated exception objects to reuse, the end result is basically the same in terms of performance as reusing one instance (unless there's a *really* deep exception stack).  But again, I don't think this is worth optimizing for.",
    "created_at": "2018-01-05T12:13:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24178#issuecomment-338757",
    "user": "embray"
}
```

FWIW if constructing the `AttributeError` is *really* a bottleneck--of which I'm skeptical--I have an experimental rewrite that uses a free list of pre-allocated exception objects to reuse, the end result is basically the same in terms of performance as reusing one instance (unless there's a *really* deep exception stack).  But again, I don't think this is worth optimizing for.



---

archive/issue_comments_338758.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-01-06T11:30:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24178",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24178#issuecomment-338758",
    "user": "vbraun"
}
```

Resolution: fixed
