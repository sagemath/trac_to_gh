# Issue 26105: Improve triconnectivity algorithm: avoid recursive calls

archive/issues_026105.json:
```json
{
    "body": "CC:  @meghanamreddy saiharsh @tscrim\n\nMaximum recursion depth can be reached when applying the `spqr_tree` method on large graphs. We improve the code to avoid recursive calls.\n\nThis is a follow up to #25598.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26342\n\n",
    "created_at": "2018-09-24T16:22:03Z",
    "labels": [
        "component: graph theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "Improve triconnectivity algorithm: avoid recursive calls",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26105",
    "user": "https://github.com/dcoudert"
}
```
CC:  @meghanamreddy saiharsh @tscrim

Maximum recursion depth can be reached when applying the `spqr_tree` method on large graphs. We improve the code to avoid recursive calls.

This is a follow up to #25598.

Issue created by migration from https://trac.sagemath.org/ticket/26342





---

archive/issue_comments_367601.json:
```json
{
    "body": "It remains to remove recursion in `__path_search`. Feel free to do it if you know how :P\n----\nNew commits:",
    "created_at": "2018-09-24T16:26:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26105#issuecomment-367601",
    "user": "https://github.com/dcoudert"
}
```

It remains to remove recursion in `__path_search`. Feel free to do it if you know how :P
----
New commits:



---

archive/issue_comments_367602.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-25T16:31:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26105#issuecomment-367602",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_367603.json:
```json
{
    "body": "It was quite frightening to modify `__path_search`, but I did it ! I tried the new version on quite large graphs and I'm confident on the results.\n\n\n```\nsage: G = graphs.RandomBarabasiAlbert(10000, 3)\nsage: G.order(), G.size()\n(10000, 29991)\nsage: %time T = G.spqr_tree()\nCPU times: user 2.13 s, sys: 68.9 ms, total: 2.2 s\nWall time: 2.2 s\nsage: T.vertices()\n[('R', Multi-graph on 10000 vertices)]\nsage: for u,v in G.edges(labels=False):  # long\n....:     G.add_path([u, G.add_vertex(), v])\n....:     \nsage: G.order(), G.size()\n(39991, 89973)\nsage: %time T = G.spqr_tree()\nCPU times: user 17.8 s, sys: 722 ms, total: 18.5 s\nWall time: 18.7 s\nsage: T\nSPQR-tree of : Graph on 59983 vertices\nsage: from collections import Counter\nsage: Counter(u[0] for u in T)\nCounter({'P': 29991, 'S': 29991, 'R': 1})\nsage: for u,v in G.edges(labels=False): # extremely long\n....:     G.add_path([u, G.add_vertex(), v])\n....:     \nsage: G.order(), G.size()\n(129964, 269919)\nsage: %time T = G.spqr_tree()\nCPU times: user 1min 1s, sys: 5.65 s, total: 1min 7s\nWall time: 1min 8s\nsage: Counter(u[0] for u in T)\nCounter({'S': 119964, 'P': 89973, 'R': 1})\n```\n",
    "created_at": "2018-09-25T16:50:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26105#issuecomment-367603",
    "user": "https://github.com/dcoudert"
}
```

It was quite frightening to modify `__path_search`, but I did it ! I tried the new version on quite large graphs and I'm confident on the results.


```
sage: G = graphs.RandomBarabasiAlbert(10000, 3)
sage: G.order(), G.size()
(10000, 29991)
sage: %time T = G.spqr_tree()
CPU times: user 2.13 s, sys: 68.9 ms, total: 2.2 s
Wall time: 2.2 s
sage: T.vertices()
[('R', Multi-graph on 10000 vertices)]
sage: for u,v in G.edges(labels=False):  # long
....:     G.add_path([u, G.add_vertex(), v])
....:     
sage: G.order(), G.size()
(39991, 89973)
sage: %time T = G.spqr_tree()
CPU times: user 17.8 s, sys: 722 ms, total: 18.5 s
Wall time: 18.7 s
sage: T
SPQR-tree of : Graph on 59983 vertices
sage: from collections import Counter
sage: Counter(u[0] for u in T)
Counter({'P': 29991, 'S': 29991, 'R': 1})
sage: for u,v in G.edges(labels=False): # extremely long
....:     G.add_path([u, G.add_vertex(), v])
....:     
sage: G.order(), G.size()
(129964, 269919)
sage: %time T = G.spqr_tree()
CPU times: user 1min 1s, sys: 5.65 s, total: 1min 7s
Wall time: 1min 8s
sage: Counter(u[0] for u in T)
Counter({'S': 119964, 'P': 89973, 'R': 1})
```




---

archive/issue_comments_367604.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-09-25T16:50:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26105#issuecomment-367604",
    "user": "https://github.com/dcoudert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_367605.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-09-25T23:20:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26105#issuecomment-367605",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_367606.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-09-25T23:22:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26105#issuecomment-367606",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_367607.json:
```json
{
    "body": "I did some trivial Cythonization (declaring obvious variable types), and I also did a bunch of doc improvements/standardizations (although almost all of them you cannot see because they are private methods). It is not surprising that my little Cythonization will make for great speed improvements, it is more of setup for the bigger overhaul (which rightly should be on a separate ticket). If my changes are good, then you can set a positive review.\n\n8.4.beta6:\n\n```\nsage: G = graphs.JankoKharaghaniGraph(936)\nsage: (G.order(), G.size())\n(936, 175500)\nsage: %time T = G.spqr_tree()\nCPU times: user 6.22 s, sys: 96 ms, total: 6.32 s\nWall time: 6.3 s\n```\n\nYour branch:\n\n```\nsage: %time T = G.spqr_tree()\nCPU times: user 6.38 s, sys: 108 ms, total: 6.49 s\nWall time: 6.45 s\n```\n\nMy branch\n\n```\nsage: %time T = G.spqr_tree()\nCPU times: user 6.27 s, sys: 124 ms, total: 6.4 s\nWall time: 6.34 s\n```\n",
    "created_at": "2018-09-25T23:32:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26105#issuecomment-367607",
    "user": "https://github.com/tscrim"
}
```

I did some trivial Cythonization (declaring obvious variable types), and I also did a bunch of doc improvements/standardizations (although almost all of them you cannot see because they are private methods). It is not surprising that my little Cythonization will make for great speed improvements, it is more of setup for the bigger overhaul (which rightly should be on a separate ticket). If my changes are good, then you can set a positive review.

8.4.beta6:

```
sage: G = graphs.JankoKharaghaniGraph(936)
sage: (G.order(), G.size())
(936, 175500)
sage: %time T = G.spqr_tree()
CPU times: user 6.22 s, sys: 96 ms, total: 6.32 s
Wall time: 6.3 s
```

Your branch:

```
sage: %time T = G.spqr_tree()
CPU times: user 6.38 s, sys: 108 ms, total: 6.49 s
Wall time: 6.45 s
```

My branch

```
sage: %time T = G.spqr_tree()
CPU times: user 6.27 s, sys: 124 ms, total: 6.4 s
Wall time: 6.34 s
```




---

archive/issue_comments_367608.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-09-26T04:51:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26105#issuecomment-367608",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_367609.json:
```json
{
    "body": "Thank you Travis for the improvements. I will to do more Cythonization (e.g., using arrays instead of lists, turn the doubly linked list to some C/C++ data structure, etc.) in other tickets. The number of methods without doctest should also be reduced (to 0), which is not obvious for some internal methods. One step at a time ;)",
    "created_at": "2018-09-26T04:51:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26105#issuecomment-367609",
    "user": "https://github.com/dcoudert"
}
```

Thank you Travis for the improvements. I will to do more Cythonization (e.g., using arrays instead of lists, turn the doubly linked list to some C/C++ data structure, etc.) in other tickets. The number of methods without doctest should also be reduced (to 0), which is not obvious for some internal methods. One step at a time ;)



---

archive/issue_comments_367610.json:
```json
{
    "body": "Feel free to cc me and ask questions (I have done a fair bit of cythonization and picked up some tricks). For those helper methods, if you make them `cdef`, then you don't need to give them doctests. :)",
    "created_at": "2018-09-26T04:55:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26105#issuecomment-367610",
    "user": "https://github.com/tscrim"
}
```

Feel free to cc me and ask questions (I have done a fair bit of cythonization and picked up some tricks). For those helper methods, if you make them `cdef`, then you don't need to give them doctests. :)



---

archive/issue_comments_367611.json:
```json
{
    "body": "Noted :P",
    "created_at": "2018-09-26T04:56:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26105#issuecomment-367611",
    "user": "https://github.com/dcoudert"
}
```

Noted :P



---

archive/issue_events_065529.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-09-27T17:41:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26105",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26105#event-65529"
}
```



---

archive/issue_comments_367612.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-09-27T17:41:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26105",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26105#issuecomment-367612",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
