# Issue 26105: Improve triconnectivity algorithm: avoid recursive calls

Issue created by migration from Trac.

Original creator: dcoudert

Original creation time: 2018-09-24 16:22:03

CC:  meghanamreddy saiharsh tscrim

Maximum recursion depth can be reached when applying the `spqr_tree` method on large graphs. We improve the code to avoid recursive calls.

This is a follow up to #25598.


---

Comment by dcoudert created at 2018-09-24 16:26:12

It remains to remove recursion in `__path_search`. Feel free to do it if you know how :P
----
New commits:


---

Comment by git created at 2018-09-25 16:31:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2018-09-25 16:50:41

It was quite frightening to modify `__path_search`, but I did it ! I tried the new version on quite large graphs and I'm confident on the results.


```
sage: G = graphs.RandomBarabasiAlbert(10000, 3)
sage: G.order(), G.size()
(10000, 29991)
sage: %time T = G.spqr_tree()
CPU times: user 2.13 s, sys: 68.9 ms, total: 2.2 s
Wall time: 2.2 s
sage: T.vertices()
[('R', Multi-graph on 10000 vertices)]
sage: for u,v in G.edges(labels=False):  # long
....:     G.add_path([u, G.add_vertex(), v])
....:     
sage: G.order(), G.size()
(39991, 89973)
sage: %time T = G.spqr_tree()
CPU times: user 17.8 s, sys: 722 ms, total: 18.5 s
Wall time: 18.7 s
sage: T
SPQR-tree of : Graph on 59983 vertices
sage: from collections import Counter
sage: Counter(u[0] for u in T)
Counter({'P': 29991, 'S': 29991, 'R': 1})
sage: for u,v in G.edges(labels=False): # extremely long
....:     G.add_path([u, G.add_vertex(), v])
....:     
sage: G.order(), G.size()
(129964, 269919)
sage: %time T = G.spqr_tree()
CPU times: user 1min 1s, sys: 5.65 s, total: 1min 7s
Wall time: 1min 8s
sage: Counter(u[0] for u in T)
Counter({'S': 119964, 'P': 89973, 'R': 1})
```



---

Comment by dcoudert created at 2018-09-25 16:50:41

Changing status from new to needs_review.


---

Comment by git created at 2018-09-25 23:20:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-25 23:22:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2018-09-25 23:32:19

I did some trivial Cythonization (declaring obvious variable types), and I also did a bunch of doc improvements/standardizations (although almost all of them you cannot see because they are private methods). It is not surprising that my little Cythonization will make for great speed improvements, it is more of setup for the bigger overhaul (which rightly should be on a separate ticket). If my changes are good, then you can set a positive review.

8.4.beta6:

```
sage: G = graphs.JankoKharaghaniGraph(936)
sage: (G.order(), G.size())
(936, 175500)
sage: %time T = G.spqr_tree()
CPU times: user 6.22 s, sys: 96 ms, total: 6.32 s
Wall time: 6.3 s
```

Your branch:

```
sage: %time T = G.spqr_tree()
CPU times: user 6.38 s, sys: 108 ms, total: 6.49 s
Wall time: 6.45 s
```

My branch

```
sage: %time T = G.spqr_tree()
CPU times: user 6.27 s, sys: 124 ms, total: 6.4 s
Wall time: 6.34 s
```



---

Comment by dcoudert created at 2018-09-26 04:51:07

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2018-09-26 04:51:07

Thank you Travis for the improvements. I will to do more Cythonization (e.g., using arrays instead of lists, turn the doubly linked list to some C/C++ data structure, etc.) in other tickets. The number of methods without doctest should also be reduced (to 0), which is not obvious for some internal methods. One step at a time ;)


---

Comment by tscrim created at 2018-09-26 04:55:04

Feel free to cc me and ask questions (I have done a fair bit of cythonization and picked up some tricks). For those helper methods, if you make them `cdef`, then you don't need to give them doctests. :)


---

Comment by dcoudert created at 2018-09-26 04:56:27

Noted :P


---

Comment by vbraun created at 2018-09-27 17:41:17

Resolution: fixed
