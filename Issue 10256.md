# Issue 10256: Change malloc to sage_malloc

Issue created by migration from https://trac.sagemath.org/ticket/10257

Original creator: jdemeyer

Original creation time: 2010-11-13 13:45:19

Assignee: tba

Keywords: malloc sage_malloc

In the light of potential future changes to `sage_malloc()`, we should use `sage_malloc()` instead of `malloc()`.


---

Comment by jdemeyer created at 2014-12-14 16:46:11

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2014-12-14 16:46:11

New commits:


---

Comment by git created at 2014-12-18 16:41:37

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2015-02-07 14:00:53

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-02-07 16:07:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-02-07 16:07:41

Changing status from needs_work to needs_review.


---

Comment by mmezzarobba created at 2015-02-08 10:00:50

Also conflicts with #12212


---

Comment by mmezzarobba created at 2015-02-08 10:00:50

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-02-08 21:32:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-02-08 22:07:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-02-08 22:10:36

Changing status from needs_work to needs_review.


---

Comment by mmezzarobba created at 2015-02-09 10:30:47

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-02-17 16:08:49

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-02-17 16:08:49

On OSX:

```
sage -t --long src/sage/modules/vector_rational_dense.pyx
**********************************************************************
File "src/sage/modules/vector_rational_dense.pyx", line 101, in sage.modules.vector_rational_dense.Vector_rational_dense._init
Failed example:
    try:
        Vector_rational_dense(QQ^(2^56))
    except (MemoryError, OverflowError):
        print "allocation failed"
Expected:
    allocation failed
Got:
    python(32767,0x7fff7d747300) malloc: *** mach_vm_map(size=2305843009213693952) failed (error code=3)
    *** error: can't allocate region
    *** set a breakpoint in malloc_error_break to debug
    allocation failed
**********************************************************************
```



---

Comment by jdemeyer created at 2015-02-18 09:10:59

Volker, did you enable specific debugging flags? It looks like `malloc` is just verbosely saying that the allocation failed, it that the default on OS X?


---

Comment by vbraun created at 2015-02-18 10:04:02

Seems to be the default on OSX, I didn't enable any special debugging.


---

Comment by vbraun created at 2015-02-18 10:07:46

See also http://bugs.python.org/issue5614


---

Comment by git created at 2015-02-18 14:28:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-02-18 14:28:53

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2015-02-19 18:15:37

Hello,

Why not using this ?

```
cdef inline void* check_allocarray(size_t nmemb, size_t size) except? NULL:
   """
   Allocate memory for ``nmemb`` elements of size ``size``.
   """
   return check_malloc( mul_overflowcheck(nmemb, size) )


cdef inline void* check_malloc(size_t n) except? NULL:
   """
   Allocate ``n`` bytes of memory.
   """
   if n == 0:
      return NULL
   if n == <size_t>(-1):
      raise MemoryError("cannot allocate %s bytes" % n)
   cdef void* ret = sage_malloc(n)
   if ret == NULL:
      raise MemoryError("failed to allocate %s bytes" % n)
   return ret
```

At least, `check_malloc` should have the test `if n==<size_t>-1` (if not already in `sage_malloc`), and other methods as well.

David.


---

Comment by jdemeyer created at 2015-02-20 11:04:52

Replying to [comment:27 dcoudert]:
> Hello,
> 
> Why not using this ?
> {{{
> cdef inline void* check_allocarray(size_t nmemb, size_t size) except? NULL:
>    """
>    Allocate memory for ``nmemb`` elements of size ``size``.
>    """
>    return check_malloc( mul_overflowcheck(nmemb, size) )
> 
> 
> cdef inline void* check_malloc(size_t n) except? NULL:
>    """
>    Allocate ``n`` bytes of memory.
>    """
>    if n == 0:
>       return NULL
>    if n == <size_t>(-1):
>       raise MemoryError("cannot allocate %s bytes" % n)
>    cdef void* ret = sage_malloc(n)
>    if ret == NULL:
>       raise MemoryError("failed to allocate %s bytes" % n)
>    return ret
> }}}
One reason is that the error message would be less clear this way: any overflow would lead to the same error message. With my code, the error message mentions exactly which allocation failed.

> At least, `check_malloc` should have the test if `n==<size_t>-1` (if not already in `sage_malloc`)
Why? The argument to `malloc()` is a number of bytes. Allocating `<size_t>(-1)` bytes will very likely fail anyway.


---

Comment by dcoudert created at 2015-02-20 12:17:03

Replying to [comment:28 jdemeyer]:
> > At least, `check_malloc` should have the test if `n==<size_t>-1` (if not already in `sage_malloc`)
> Why? The argument to `malloc()` is a number of bytes. Allocating `<size_t>(-1)` bytes will very likely fail anyway.
So we could avoid this test in `check_allocarray`, right?


---

Comment by git created at 2015-02-20 14:38:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2015-02-20 22:35:02

Hello,

After a long compilation, I did a doc build and a `sage -t --long src/sage/` (very very long...).

All tests pass on my MBA with OSX 10.10.

David.


---

Comment by dcoudert created at 2015-02-20 22:35:02

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-02-21 12:40:22

Resolution: fixed
