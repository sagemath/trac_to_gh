# Issue 11619: Introspection for interactively defined classes with metaclass

Issue created by migration from https://trac.sagemath.org/ticket/11791

Original creator: SimonKing

Original creation time: 2011-09-12 15:11:00

Assignee: jason

Keywords: introspection, cython, dynamic metaclass

#11298 provides the possibility to inspect interactive cython code. However, the following case did not work:

```
sage: cython_code = [
....: 'from sage.structure.dynamic_class import dynamic_class',
....: 'from sage.all import cached_function',
....: 'MyMetaclass = dynamic_class("MyMetaclass",(ClasscallMetaclass,))',
....: 'class Bar2:',
....: '    __metaclass__ = MyMetaclass',
....: '    @cached_function',
....: '    def __classcall__(cls, R):',
....: '        return type.__call__(cls, R)',
....: '    def __init__(self,R):',
....: '        self.R = R',
....: '    def __repr__(self):',
....: '        return "[%s]"%self.R',
....: '    def __hash__(self):',
....: '        print "computing the hash"',
....: '        return int(12345)']
sage: sage: cython('\n'.join(cython_code))
sage: Bar2??
```

It would show the code of `ClasscallMetaclass`, not the definition of `Bar2`.

The attached patch fixes it. It is based on cleaning-up `sage_getsourcelines`: That function uses different techniques to get the source lines, and it turns out that they were attempted in a wrong order.

The patch also needs #11768, or it wouldn't apply, and #11734, or sage would not start.


---

Comment by SimonKing created at 2011-09-12 15:16:37

Changing status from new to needs_review.


---

Comment by SimonKing created at 2011-09-12 15:16:37

The attached patch seems to solve the problem. From the doctests:

```
        sage: cython_code = [
        ... 'from sage.structure.dynamic_class import dynamic_class',
        ... 'from sage.all import cached_function',
        ... 'MyMetaclass = dynamic_class("MyMetaclass",(ClasscallMetaclass,))',
        ... 'class Bar2:',
        ... '    __metaclass__ = MyMetaclass',
        ... '    @cached_function',
        ... '    def __classcall__(cls, R):',
        ... '        return type.__call__(cls, R)',
        ... '    def __init__(self,R):',
        ... '        self.R = R',
        ... '    def __repr__(self):',
        ... '        return "[%s]"%self.R',
        ... '    def __hash__(self):',
        ... '        print "computing the hash"',
        ... '        return int(12345)']
        sage: cython('\n'.join(cython_code))
        sage: print ''.join(sage_getsourcelines(Bar2)[0])
        class Bar2:
            __metaclass__ = MyMetaclass
            @cached_function
            def __classcall__(cls, R):
                return type.__call__(cls, R)
            def __init__(self,R):
                self.R = R
            def __repr__(self):
                return "[%s]"%self.R
            def __hash__(self):
                print "computing the hash"
                return int(12345)
```


The tests of `sage.misc.sageinspect` pass with the patch. I did not try full tests yet, but I think it could already be reviewed.


---

Comment by SimonKing created at 2011-09-12 16:15:40

For the record: The tests pass, and the documentation looks fine.

Now it's your turn, whoever is reading it!


---

Comment by SimonKing created at 2011-09-19 13:41:44

Outch! I just realise that my patch adds a doctest that only works on top of #11115! Hence, adding it as a dependency!


---

Comment by davidloeffler created at 2012-03-25 21:21:54

According to patchbot this fails to apply to 5.0.beta10 (there's a conflict in sageinspect.py). Your turn again, Simon, I'm afraid...


---

Comment by davidloeffler created at 2012-03-25 21:21:54

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2012-03-27 08:11:42

The conflict was with #10620 and is trivial: #10620 changed a pair of "s into a pair of 's -- and my old patch did the same.

It is updated and needs review (and so does #11768, by the way).

One question, though: I recall that somebody (Jeroen?) mentioned on sage-devel that one should mark all doc tests requiring a compiler (i.e., doctests using cython) as "optional - gcc". Is that true?  Then the patch needs work.


---

Comment by SimonKing created at 2012-03-27 08:11:42

Changing status from needs_work to needs_review.


---

Attachment

Introspection for classes with dynamic metaclass


---

Comment by SimonKing created at 2012-05-03 11:10:26

In some cases, sage_getfile would still not get the correct file name for interactively defined classes. Hence, the following would not work, even with #9107 applied:

```
age: cython_code = [
... "from sage.structure.unique_representation import UniqueRepresentation",
... "class A1(UniqueRepresentation):",
... "    class B1(UniqueRepresentation):",
... "        class C1: pass",
... "    class B2:",
... "        class C2: pass"]
sage: import os
sage: cython(os.linesep.join(cython_code))
sage: A1.B1.C1??          
```


I fixed the problem and turn it into a new doctest. However, that makes #9107 a new dependency (for making the test work).

I also used that occasion to use the new :trac: directive, and was a bit more careful by using os.extsep instead of '.' and so on.


---

Comment by chapoton created at 2015-04-05 18:40:15

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2015-04-05 18:40:15

Needs a git branch


---

Comment by jdemeyer created at 2015-04-08 20:43:50

Changing component from misc to cython.
