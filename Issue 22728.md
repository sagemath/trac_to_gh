# Issue 22728: Refactor axioms

Issue created by migration from Trac.

Original creator: nthiery

Original creation time: 2017-05-10 03:34:05

CC:  tscrim simonking vbraun jpflori

This ticket brings:

- a catalog of axioms `axioms.XXX`

- improved heuristic for displaying categories with axioms. E.g.:
   {{{
   Category of finite enumerated fields  ->  Category of finite fields
   Category of finite enumerated permutation groups  ->  Category of finite permutation groups
   }}}

   (this is the reason why the commit touches many files)

- axioms as objects rather than plain strings. This had been wished
  for during the review #12973, and some of the code is reminiscent of
  Volker's draft at #15501.

The code is essentially backward compatible, at the price of having
Associative == "Associative", with compatible has values.

The bijection axiom <-> "axiom name" remains mandatory to support the
syntax for implementing axioms in a category.


---

Comment by tscrim created at 2017-05-10 21:38:19

I know it's not ready for review, but something I've been bit by in the past is only defining an `__eq__`. Make sure you define a `__ne__` as `return not (self == other)`.
----
New commits:


---

Comment by git created at 2017-05-10 22:03:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-05-10 22:06:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-05-10 22:10:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-05-10 22:12:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-05-10 22:12:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2017-05-10 22:45:24

Changing status from new to needs_review.


---

Comment by nbruin created at 2017-05-10 22:46:58

If you're going to override "__eq__" and "__hash__" you should probably define the thing to be `CachedRepresentation`. Is there a good reason to be `CachedRepresentation`?

(`CachedRepresentation` has a very nontrivial cost. You should only use it if you need its features)


---

Comment by nthiery created at 2017-05-10 22:56:48

Replying to [comment:12 nbruin]:
> If you're going to override "__eq__" and "__hash__" you should probably define the thing to be `CachedRepresentation`. Is there a good reason to be `CachedRepresentation`?
> 
> (`CachedRepresentation` has a very nontrivial cost. You should only use it if you need its features)

That's a good question. The `__eq__` and `__hash__` are really here just for backward compatibility (supporting the idiom `"Foo" in C.axioms()`). I used `UniqueRepresentation` because that's really what I mean :-) But you are right, it could be more proper to use `CachedRepresentation`.

In terms of speed, I believe the only important thing is fast equality and hash (which calls for Cythonizing them). Axioms will rarely be recreated.

Cheers,
                                    Nicolas


---

Comment by nthiery created at 2017-05-10 23:06:55

Replying to [comment:4 tscrim]:
> I know it's not ready for review, but something I've been bit by in the past is only defining an `__eq__`. Make sure you define a `__ne__` as `return not (self == other)`.

Yeah, I pondered about this. Accepting `"Associative" == axioms.Associative` is really just here as a workaround for backward compatibility; namely to support idiom `"Associative" in C.axioms()` that people apparently have been using. I wondered whether I really wanted to enable more than just the strict minimum.


---

Comment by tscrim created at 2017-05-10 23:11:32

If you want to keep the `__eq__`, then you really need to define a `__ne__` to keep things consistent in case someone wants to test inequality. A slightly contrived example, but say someone has a constructor that accepts an axiom as an arg and they want to do something special when the axiom is not `axioms.Commutative`.

Also, `__init__`, `__repr__`, and `index` of `Axiom` do not have doctests.


---

Comment by tscrim created at 2017-05-10 23:12:28

I'm not really commenting on whether you should define an `__eq__` or not.


---

Comment by tscrim created at 2017-05-10 23:13:11

Also, why does `Axiom` inherit from `SageObject`? What features are you using?


---

Comment by git created at 2017-05-10 23:17:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2017-05-11 02:36:44

Replying to [comment:19 tscrim]:
> Also, why does `Axiom` inherit from `SageObject`? What features are you using?

I believe none at this stage. I just put that by default, mostly for consistency with Category.


---

Comment by git created at 2017-05-11 02:39:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2017-05-16 14:59:32

Hi; any comment on the questions raised in the description?


---

Comment by tscrim created at 2017-05-16 22:26:22

> - Inside the code, do we want to call the catalog of axioms
>   `all_axioms` or `axioms`? The latter is more ambiguous,
>   but consistent with the name exported in global name space.

I say `axioms` both for consistency and naturality.

> - To fetch an existing axiom from a variable containing either the
>   axiom or its name, the current idiom is `all_axioms(name)`; that's
>   somewhat consistent with the `P(xx)` idiom to create elements of a
>   parent. Would we want some other idiom? `all_axioms[name]`?

I would go for the latter since it is a container object and `all_axioms[name]` is how Python handles other container objects, e.g., `dict`.

> - Do we want to implement a `cmp` method for axioms?

No, but rich comparisons are good.

>   - Comparing by string: this could avoid the repeated use of
>     `sorted(...,key=str)` in our documentation
>   - Comparing by index/definition time? This would be plausibly more
>     meaningful (axioms shown in some natural order). And simplify
>     a very tiny bit the one place where this sorting order is used in
>     the code.

Definitely Index/definition time as this will allow us to control the printing in a more straightforward way.

> - Do we want to Cythonize axiom.py? Now? Later?

I am inclined to say Cythonize it to keep the categories as fast as possible. I feel like even if highly optimized, this switch will slow down category creation because the string operations are lightweight and optimized at the machine level. However, I haven't done any timings.

Also, it would be good if you could get rid of the `SageObject` inheritance from `Axiom` so we could `cdef` it, and I don't see axioms fundamentally behaving like other instances of `SageObject`.

> - Do we want to import `all_axioms` from `category_with_axiom` rather than
>   `axiom`? This would avoid a double import in all the files specifying
>   `_base_category_and_axiom`

> - Do we want "additive magmas" to be renamed to "additive-magmas" for consistency?

I don't think the hyphen there is completely grammatically correct, at least it is strange to me. So I'm -1.

> - Do we want to fix the inconsistency below by adding `additive-` in
>   the first output?
> 
>   {{{
>   sage: CommutativeAdditiveGroups()
>   Category of commutative additive groups
>   sage: AdditiveMagmas().AdditiveCommutative()
>   Category of additive-commutative additive magmas
>   }}}

I would like the latter to be

```
Category of commutative additive magmas
```

as this is more concise and easier to parse.

> - To recover the string associated to an axiom in the code, is it fine
>   to use `str(axiom)`, or do we want something more explicit and
>   possibly distinct from printing like `axiom.name()`?

`str(axiom)` is the most natural for me, but it doesn't hurt to have an alias `axiom.name()`.

> - Any better name for `axiom.index()`? It's only used internally,
>   and in a single place; we could also just use `axiom._index`.

I would get rid of it all together and (mildly) break encapsulation here by using `axiom._index`. It is both faster, only done in one place, and is an implementation detail.


---

Comment by mderickx created at 2017-08-31 05:38:10

Looks like there are a lot of things in the comments to still be addressed and merge conflicts that need to be resolved.


---

Comment by mderickx created at 2017-08-31 05:38:10

Changing status from needs_review to needs_work.
