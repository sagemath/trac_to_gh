# Issue 24421: Don't call Maxima with no-variable symbolic relation tests

Issue created by migration from https://trac.sagemath.org/ticket/24658

Original creator: rws

Original creation time: 2018-02-05 07:36:58

CC:  simonking

In the case a relation without variables is to be decided, the procedure is to use Pynac, then RIF and, if it cannot be decided, Maxima. This is fine with expressions containing variables as Maxima can do some proofs. Expressions without variables are handled poorly as the example shows:


```
sage: val = pi - 2286635172367940241408/1029347477390786609545*sqrt(2)
sage: bool(val>0)
True

(%i2) is (%pi-(1116521080257783321*2^(23/2))/1029347477390786609545>0);
(%o2)                                true
```


This ticket changes the procedure to no longer try the unreliable Maxima after RIF has failed in a relation without variables. It will just return Unknown.


---

Comment by rws created at 2018-02-05 08:00:39

New commits:


---

Comment by rws created at 2018-02-05 08:00:39

Changing status from new to needs_review.


---

Comment by SimonKing created at 2018-02-05 09:51:08

It should be easy to review (after all, it is just working around a short-coming of maxima), and to me it looks good. However, I do not feel particularly confident about symbolic expressions (which I normally try to avoid by all means).

Also, I wonder about that change:

```diff
diff --git a/src/sage/symbolic/expression.pyx b/src/sage/symbolic/expression.pyx
index 7130898..0f943d9 100644
--- a/src/sage/symbolic/expression.pyx
+++ b/src/sage/symbolic/expression.pyx
@@ -2612,7 +2612,7 @@ cdef class Expression(CommutativeRingElement):
         The :meth:`~sage.structure.element.Element.is_zero` method
         is more capable::
 
-            sage: t = pi + (pi - 1)*pi - pi^2
+            sage: t = pi + x*pi + (pi - 1 - x)*pi - pi^2
             sage: t.is_trivial_zero()
             False
             sage: t.is_zero()
```

Why did you change it? Apparently in order to have a variable in it. So, without the variable, `t.is_trivial_zero()` would return `True`, right? Which somehow makes sense, actually. I believe one should retain _both_ tests, to show-case that Sage can now detect some more expressions which *are* trivially zero.


---

Comment by SimonKing created at 2018-02-05 09:54:18

PS: Also I think that in the new test `val = pi - 2286635172367940241408/1029347477390786609545*sqrt(2)` (which actually comes out of Ramanujan's formula for pi) the ticket number should be mentioned.


---

Comment by rws created at 2018-02-05 10:00:50

Replying to [comment:5 SimonKing]:
> Also, I wonder about that change:
> {{{
> #!diff
> diff --git a/src/sage/symbolic/expression.pyx b/src/sage/symbolic/expression.pyx
> index 7130898..0f943d9 100644
> --- a/src/sage/symbolic/expression.pyx
> +++ b/src/sage/symbolic/expression.pyx
> `@``@` -2612,7 +2612,7 `@``@` cdef class Expression(CommutativeRingElement):
>          The :meth:`~sage.structure.element.Element.is_zero` method
>          is more capable::
>  
> -            sage: t = pi + (pi - 1)*pi - pi^2
> +            sage: t = pi + x*pi + (pi - 1 - x)*pi - pi^2
>              sage: t.is_trivial_zero()
>              False
>              sage: t.is_zero()
> }}}
> Why did you change it?

Because getting what we want (avoid Maxima numeric) and keeping the doctest would need more involved code, basically checking if there are constants, if so substituting them for variables, and then calling Maxima with that. Note that the changed result is not wrong so I'll add it again.


---

Comment by git created at 2018-02-05 10:14:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2018-02-05 10:16:56

Replying to [comment:5 SimonKing]:
> So, without the variable, `t.is_trivial_zero()` would return `True`, right? Which somehow makes sense, actually. I believe one should retain _both_ tests, to show-case that Sage can now detect some more expressions which *are* trivially zero.

No `is_trivial_zero` test for trivial zero, i.e., `0`.


---

Comment by SimonKing created at 2018-02-05 10:26:52

Hm. `(pi + (pi - 1)*pi - pi^2).is_zero()` returning False goes to far, IMHO.

If I understand correctly, the underlying bug is in Maxima's test for positivity/negativity. Is there a corresponding bug in Maxima's test for being zero as well? If it isn't, then I guess one should return to using Maxima for `is_zero`.


---

Comment by SimonKing created at 2018-02-05 10:32:40

Or, alternatively, `is_zero()` (but not `is_trivial_zero()`) should be cleverer in using RIF:

```
sage: RIF(pi + (pi - 1)*pi - pi^2)>0
False
sage: RIF(pi + (pi - 1)*pi - pi^2)<0
False
sage: RIF(pi + (pi - 1)*pi - pi^2)==0
False
sage: RIF(pi + (pi - 1)*pi - pi^2).is_NaN()
False
```


Thus, we have a real *number* (it is not !NaN) that is neither positive nor negative, and thus it would make sense to treat it as zero, although RIF is careful enough to not assert that it actually _is_ zero.

Or prepend it by a simplification?

```
sage: RIF((pi + (pi - 1)*pi - pi^2).simplify_full()).is_zero()
True
```


After all, presumably `is_zero()` is supposed to invest more work into testing than `is_trivial_zero()`.


---

Comment by rws created at 2018-02-05 13:52:31

Replying to [comment:11 SimonKing]:
> Thus, we have a real *number* (it is not !NaN) that is neither positive nor negative, and thus it would make sense to treat it as zero, although RIF is careful enough to not assert that it actually _is_ zero.

Your own example (`val`) above would then be treated as zero too.

> Or prepend it by a simplification?

That is probably best. One can always construct cases that need long time like `((pi+1)^10000 - pi*(pi+1)^9999 - (pi+1)^9999).simplify_full()`.


---

Comment by git created at 2018-02-05 14:18:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2018-02-05 14:21:11

OK, this looks fine in symbolics, there may be failing doctests elsewhere.


---

Comment by rws created at 2018-02-05 14:46:53

There is a doctest in manifolds that relies on `-arctanh(1/2) + 1/2*log(3) == 0`. That should be resolved by implementing more special values for `atanh`. Surprise, I thought we had them all.


---

Comment by rws created at 2018-02-05 14:56:00

Maxima cannot simplify `arctanh(1/2) - 1/2*log(3)`. The question is do we formulate the doctest differently, or do we implement rewrite of inverse hyperbolic expressions, e.g. for integer and rational number arguments, either immediately or inside `simplify_full`.


---

Comment by rws created at 2018-02-06 09:23:22

The new Pynac has the atanh simpifications and so we depend on that upgrade to fix the manifolds doctest fail.


---

Comment by rws created at 2018-02-06 15:22:55

This one is serious because it does happen only when doctesting, and `bool(SR(...))` does not seem to be involved directly.

```
File "src/sage/structure/parent.pyx", line 1514, in sage.structure.parent.Parent.hom._is_coercion_cached
Failed example:
    R._is_coercion_cached(QQ)
Expected:
    False
Got:
    True
```

It goes away if I replace `QQ` with `QQbar`. I think that the coercion cache is not really erased with creation of a new parent, and the additional call to `test_relation` in this ticket fills it with something. There are doctest calls to `bool(SR(...))` that happen before that doctest in `parent.pyx`, let's see...


---

Comment by rws created at 2018-02-06 15:29:49

Got it, it comes from the doctest `sqrt(2) in CC` in line 1051 of `pynac.pyx`. How can I turn off that it influences the doctest in line 1514?


---

Comment by rws created at 2018-02-06 15:31:34

Replying to [comment:19 rws]:
> Got it, it comes from the doctest `sqrt(2) in CC` in line 1051 of `parent.pyx`. How can I turn off that it influences the doctest in line 1514?


---

Comment by rws created at 2018-02-06 15:32:04

I meant to write `parent.pyx`.


---

Comment by SimonKing created at 2018-02-06 15:58:07

Replying to [comment:18 rws]:
> This one is serious because it does happen only when doctesting, and `bool(SR(...))` does not seem to be involved directly.
> {{{
> File "src/sage/structure/parent.pyx", line 1514, in sage.structure.parent.Parent.hom._is_coercion_cached
> Failed example:
>     R._is_coercion_cached(QQ)
> Expected:
>     False
> Got:
>     True
> }}}

`._is_coercion_cached()` is related with `self._coerce_from_hash`. I think it would be a good idea to create a single underscore method that allows to clear `self._coerce_from_hash` and `self._convert_from_hash`. Proposed name: `_clear_coerce_caches`.

For sanity, I think it would make sense to open a separate ticket for it, which I will do in a few minutes. Then, you can use the new ticket as a dependency and add a `._clear_coerce_caches()` in front of any test that requires a pristine state of the coercion cache.


---

Comment by SimonKing created at 2018-02-06 16:10:43

Aha, I just found that `Parent.init_coerce(False)` would do the job. However, it is a cdef method and hence cannot be directly called.


---

Comment by rws created at 2018-02-07 07:30:04

If you rely on patchbots for review the pynac upgrade needs to be merged by the maintainer first.
----
New commits:


---

Comment by rws created at 2018-02-19 07:35:02

The manifolds test passes now so we trigger the sleeping patchbots.


---

Comment by rws created at 2018-02-19 07:35:02

Changing status from needs_review to needs_work.


---

Comment by rws created at 2018-02-19 07:35:17

Changing status from needs_work to needs_review.


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by embray created at 2019-07-03 11:37:56

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by mkoeppe created at 2020-08-15 21:43:42

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-08-15 21:43:42

This is a clear improvement.


---

Comment by vbraun created at 2020-08-20 22:23:28

Resolution: fixed
