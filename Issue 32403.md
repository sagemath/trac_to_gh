# Issue 32403: series method gives wrong result on (1-x)^-x

archive/issues_032403.json:
```json
{
    "body": "CC:  @davewittemorris @slel\n\nWe have\n\n```\nf = (1-x)^-x\nprint(f.taylor(x,0,5))\nprint(f.series(x,5))\n\n3/4*x^5 + 5/6*x^4 + 1/2*x^3 + x^2 + 1\n1*x^(-1) + 1 + 1*x + 1*x^2 + 1*x^3 + 1*x^4 + Order(x^5)\n```\nwhere the taylor method gives the expected result, but series does not.\n\nIssue created by migration from https://trac.sagemath.org/ticket/32640\n\n",
    "created_at": "2021-10-05T22:09:44Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "series method gives wrong result on (1-x)^-x",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32403",
    "user": "https://github.com/akc"
}
```
CC:  @davewittemorris @slel

We have

```
f = (1-x)^-x
print(f.taylor(x,0,5))
print(f.series(x,5))

3/4*x^5 + 5/6*x^4 + 1/2*x^3 + x^2 + 1
1*x^(-1) + 1 + 1*x + 1*x^2 + 1*x^3 + 1*x^4 + Order(x^5)
```
where the taylor method gives the expected result, but series does not.

Issue created by migration from https://trac.sagemath.org/ticket/32640





---

archive/issue_comments_461694.json:
```json
{
    "body": "Thanks for the bug report.\n\nThe bug is in pynac's `power::useries` method. A power series is stored as a polynomial, together with an offset that represents multiplying by a certain power of `x`. Essentially, the method ignores the exponent's offset during most of the calculation, and then applies an offset to the final result. That is mathematically incorrect, so the method can return wrong answers when the exponent's offset is nonzero.\n\nIn particular, the exponent `-x` is stored as `-1`, with an offset of `1`, which explains why sage gives the wrong answer for the example in the ticket description. Specifically, sage's answer is `x^-1 * (1-x)^-1`.\n\nI should be able to upload a patch to fix this soon.",
    "created_at": "2021-10-06T06:08:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32403#issuecomment-461694",
    "user": "https://github.com/DaveWitteMorris"
}
```

Thanks for the bug report.

The bug is in pynac's `power::useries` method. A power series is stored as a polynomial, together with an offset that represents multiplying by a certain power of `x`. Essentially, the method ignores the exponent's offset during most of the calculation, and then applies an offset to the final result. That is mathematically incorrect, so the method can return wrong answers when the exponent's offset is nonzero.

In particular, the exponent `-x` is stored as `-1`, with an offset of `1`, which explains why sage gives the wrong answer for the example in the ticket description. Specifically, sage's answer is `x^-1 * (1-x)^-1`.

I should be able to upload a patch to fix this soon.



---

archive/issue_comments_461695.json:
```json
{
    "body": "To fix the problem, we `normalize` the power series before exponentiating. This multiplies by the appropriate power of `x` and sets the `offset` to `0`.\n\n---\nNew commits:",
    "created_at": "2021-10-07T03:01:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32403#issuecomment-461695",
    "user": "https://github.com/DaveWitteMorris"
}
```

To fix the problem, we `normalize` the power series before exponentiating. This multiplies by the appropriate power of `x` and sets the `offset` to `0`.

---
New commits:



---

archive/issue_comments_461696.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-10-07T03:01:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32403#issuecomment-461696",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_461697.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-15T10:22:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32403#issuecomment-461697",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_461698.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-12-15T17:44:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32403#issuecomment-461698",
    "user": "https://github.com/DaveWitteMorris"
}
```

Thanks!



---

archive/issue_events_086465.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-12-23T20:26:07Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32403",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32403#event-86465"
}
```



---

archive/issue_comments_461699.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-12-23T20:26:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32403",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32403#issuecomment-461699",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
