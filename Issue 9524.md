# Issue 9524: Nasty bug with polynomial arithmetic and NTL contexts

Issue created by migration from https://trac.sagemath.org/ticket/9524

Original creator: craigcitro

Original creation time: 2010-07-17 07:23:10

Assignee: AlexGhitza

CC:  roed robertwb ylchapuy jpflori defeo

I just ran into the following nasty bug:


```
sage: polygen(GF(49, 'a')) ; polygen(GF(9, 'a'))
x
x
sage: x = polygen(GF(49, 'a'))
sage: -x
2*x
sage: x + 0
x
sage: -x
6*x
```


This is still present in sage-4.5. 

I think I know what the problem is, but I haven't had time to sit down and fix it. It's an issue with the NTL context being correctly restored when switching from 7 to 3 and back. There's a very nice note (by David Roe, I think) in most of the `_p` files in NTL that describes a pattern one must avoid to get context restoration right; unfortunately, the code generated by `sage.rings.polynomial.polynomial_zz_pex.pyx` (via `polynomial_template.pxi`) exactly conforms to this anti-pattern.


---

Comment by mmezzarobba created at 2014-02-02 11:36:47

The problem is still present in sage-6.1 (although the last command now returns `2*x`).


---

Comment by jpflori created at 2014-02-26 23:39:00

There is indeed a bunch of PY_NEW all over the place in `polynomial_template.pxi`.

Anyway IIRC the use of `PY_NEW` is hackish and one should now use the more proper `__new__` (not sure of the underscore pattern) which might be easier to override for NTL specific needs.


---

Comment by jpflori created at 2014-02-26 23:47:41

Or we could just add some `celement_new` which would except for NTL just call `PY_NEW`.


---

Comment by jpflori created at 2014-03-03 20:24:16

The problem is actually different from what was stated in the original description.

In fact, calling PY_NEw or whatever before restoring context was not the (only) rpoblem.
The main problem is that restoring the ZZ_pE context does not restore the "current" prime from the ZZ_p context.


---

Comment by jpflori created at 2014-03-03 20:26:37

Also note, that it is perfectly fine (but maybe not such a good idea) to call PY_NEW without restoring the modulus.
With the way things are currently coded, the PY_NEw call just allocates memory, no C++ constructor is called or anything done which could depend on the current context.


---

Comment by jpflori created at 2014-03-05 20:30:45

Changing status from new to needs_review.


---

Comment by jpflori created at 2014-03-05 20:30:45

New commits:


---

Comment by jpflori created at 2014-03-05 20:30:45

Changing priority from major to critical.


---

Comment by git created at 2014-03-06 16:33:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2014-03-07 09:27:50

It should be possible to define a cpp class storing the two pointers (as the current C struct) with an additional mehod calling the restore method through the two pointers in sage/libs/ntl/whatever.pxd  or .h and implement it directly in an additional sage/libs/ntl/whatever.cpp.
One would have to include the NTL directly, and maybe hack through the hackish name mangling currently done in Sage (I presume the NTL wrapper was written before Pyrex/Cython correctly supported C++).
Not sure it is worth the trouble doing that in Sage.
But this is surely worth a mail to Shoup in case he agrees to add a new method to ZZ_pEContext restoring both the modulus and the characteristic.


---

Comment by jpflori created at 2014-03-07 14:01:07

I've pushed a C++ solution to `u/jpflori/ticket/9524cpp` which is currently broken for two reasons:
* It adds an header in `src/sage/libs/ntl/ZZ_peContext_ptrs.h` which is found by the files needing it in the same folder, but not by files in other folders, e.g. files in the `padics` folder. As a testing hack, just copy it to `local/include`.
* python fails to import/dlopen `polynomial_zz_pex.so` (just try the ticket description test with the C++ branch) because of an undefined reference to the `restore` method of the new `ZZ_pEContext_ptrs` C++ class. Note the symbol is well defined in `ntl_ZZ_pEContext_class.so` (with the same C++ name mangling stuff, and `nm` gives a `D` for it) and can be used from there. I've not coded in C++ for some time, so I must have done somethign wrong. If any better (or just real) C++ coder can give us a clue, that would be very welcome.

Whatsoever, unless someone knows how to easily fix the above two issues, let's get the dirty plain C solution merged.


---

Comment by jpflori created at 2014-03-07 14:48:06

Adding

```
import ctypes   
flags = sys.getdlopenflags()
sys.setdlopenflags(flags | ctypes.RTLD_GLOBAL)
```

to `src/sage/all.py` solves the second issue (which was the more worrying one as far as I'm concerned).
Not sure how much this can hurt (this is the default only on OS X IIRC, see http://docs.python.org/2.5/lib/ctypes-loading-shared-libraries.html.


---

Comment by jpflori created at 2014-03-11 09:20:27

We could also link file that needs it to the p/cython generated so file.
But I have no idea in which order cython builds the so files.
So I think the only proper C++ solution is to build an external so file with what I've put in, and install it in local/ and link to it.
Or that such a class is integrated into NTL directly.
And I think it's overkill, so I won't follow this path anymore.


---

Comment by git created at 2014-03-11 23:38:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2014-03-12 11:16:43

Changing status from needs_review to needs_work.


---

Comment by jpflori created at 2014-03-12 11:16:43

Groumpf it seems I've switched the branches...


---

Comment by git created at 2014-03-12 11:27:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jpflori created at 2014-03-12 22:24:34

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2014-03-13 20:59:34

Looks good to me


---

Comment by roed created at 2014-03-14 04:58:05

Replying to [comment:17 vbraun]:
> Looks good to me

You should probably mark it as positively reviewed.


---

Comment by vbraun created at 2014-03-15 16:22:33

Resolution: fixed


---

Comment by kedlaya created at 2019-12-25 23:55:17

Just spotted this again after a long absence, albeit not reproducibly. This was running 9.0beta9, in the middle of a run of `sage -t src/sage/rings/polynomial/`.

```
**********************************************************************
File "src/sage/rings/polynomial/polynomial_zz_pex.pyx", line 103, in sage.rings.polynomial.polynomial_zz_pex.Polynomial_ZZ_pEX.__init__
Failed example:
    5*x
Expected:
    5*x
Got:
    2*x
**********************************************************************
```

