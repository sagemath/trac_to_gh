# Issue 28691: Fix failure in sageinspect.py

archive/issues_028691.json:
```json
{
    "body": "CC:  simonking @strogdon\n\nAs reported on [sage release](https://groups.google.com/d/msg/sage-release/B8dQGh5-Zz8/Kh2Gxj5HBgAJ), there are problems with introspection using iMac, Mid 2015, macOS 10.14.6 Mojave, with sage build for Python 2. The report contains more examples, but probably fixing the following would be enough:\n\n```\n    cython('''\n    class A:\n        def __init__(self):\n            \"some init doc\"\n            pass\n    class B:\n        \"some class doc\"\n        class A(A):\n            pass\n    ''')\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/lelievre/s/sage2gcc/local/lib/python3.7/site-packages/sage/doctest/forker.py\",\nline 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/lelievre/s/sage2gcc/local/lib/python3.7/site-packages/sage/doctest/forker.py\",\nline 1123, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest\nsage.misc.sageinspect._sage_getsourcelines_name_with_dot[3]>\", line\n10, in <module>\n        ''')\n      File \"sage/misc/lazy_import.pyx\", line 353, in\nsage.misc.lazy_import.LazyImport.__call__\n(build/cythonized/sage/misc/lazy_import.c:3686)\n        return self.get_object()(*args, **kwds)\n      File \"/Users/lelievre/s/sage2gcc/local/lib/python3.7/site-packages/sage/misc/cython.py\",\nline 634, in cython_compile\n        return cython_import_all(tmpfile, get_globals(), **kwds)\n      File \"/Users/lelievre/s/sage2gcc/local/lib/python3.7/site-packages/sage/misc/cython.py\",\nline 524, in cython_import_all\n        m = cython_import(filename, **kwds)\n      File \"/Users/lelievre/s/sage2gcc/local/lib/python3.7/site-packages/sage/misc/cython.py\",\nline 504, in cython_import\n        return builtins.__import__(name)\n    ModuleNotFoundError: No module named\n'_Users_lelievre__sage_temp_Ghost_80496_tmp_2caqjln__pyx_0'\n```\n\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28928\n\n",
    "closed_at": "2021-04-14T17:36:30Z",
    "created_at": "2019-12-30T17:07:52Z",
    "labels": [
        "component: cython",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Fix failure in sageinspect.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28691",
    "user": "https://github.com/slel"
}
```
CC:  simonking @strogdon

As reported on [sage release](https://groups.google.com/d/msg/sage-release/B8dQGh5-Zz8/Kh2Gxj5HBgAJ), there are problems with introspection using iMac, Mid 2015, macOS 10.14.6 Mojave, with sage build for Python 2. The report contains more examples, but probably fixing the following would be enough:

```
    cython('''
    class A:
        def __init__(self):
            "some init doc"
            pass
    class B:
        "some class doc"
        class A(A):
            pass
    ''')
Exception raised:
    Traceback (most recent call last):
      File "/Users/lelievre/s/sage2gcc/local/lib/python3.7/site-packages/sage/doctest/forker.py",
line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/lelievre/s/sage2gcc/local/lib/python3.7/site-packages/sage/doctest/forker.py",
line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest
sage.misc.sageinspect._sage_getsourcelines_name_with_dot[3]>", line
10, in <module>
        ''')
      File "sage/misc/lazy_import.pyx", line 353, in
sage.misc.lazy_import.LazyImport.__call__
(build/cythonized/sage/misc/lazy_import.c:3686)
        return self.get_object()(*args, **kwds)
      File "/Users/lelievre/s/sage2gcc/local/lib/python3.7/site-packages/sage/misc/cython.py",
line 634, in cython_compile
        return cython_import_all(tmpfile, get_globals(), **kwds)
      File "/Users/lelievre/s/sage2gcc/local/lib/python3.7/site-packages/sage/misc/cython.py",
line 524, in cython_import_all
        m = cython_import(filename, **kwds)
      File "/Users/lelievre/s/sage2gcc/local/lib/python3.7/site-packages/sage/misc/cython.py",
line 504, in cython_import
        return builtins.__import__(name)
    ModuleNotFoundError: No module named
'_Users_lelievre__sage_temp_Ghost_80496_tmp_2caqjln__pyx_0'
```




Issue created by migration from https://trac.sagemath.org/ticket/28928





---

archive/issue_comments_404863.json:
```json
{
    "body": "Samuel, I'm puzzled. On the one hand, you say that your Sage is build with Python 2. On the other hand, I see this:\n> {{{\n>       File \"/Users/lelievre/s/sage2gcc/local/lib/python3.7/site-packages/sage/misc/cython.py\",\n> line 524, in cython_import_all\n>         m = cython_import(filename, **kwds)\n>       File \"/Users/lelievre/s/sage2gcc/local/lib/python3.7/site-packages/sage/misc/cython.py\",\n> }}}\n\n\nSo, it is `$SAGE_LOCAL/lib/python3.7`, not `python2.7`. Is it perhaps the case that you upgraded from an old python-2 version to a python-3 version and didn't do `make distclean`?",
    "created_at": "2020-01-03T10:05:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28691#issuecomment-404863",
    "user": "https://github.com/simon-king-jena"
}
```

Samuel, I'm puzzled. On the one hand, you say that your Sage is build with Python 2. On the other hand, I see this:
> {{{
>       File "/Users/lelievre/s/sage2gcc/local/lib/python3.7/site-packages/sage/misc/cython.py",
> line 524, in cython_import_all
>         m = cython_import(filename, **kwds)
>       File "/Users/lelievre/s/sage2gcc/local/lib/python3.7/site-packages/sage/misc/cython.py",
> }}}


So, it is `$SAGE_LOCAL/lib/python3.7`, not `python2.7`. Is it perhaps the case that you upgraded from an old python-2 version to a python-3 version and didn't do `make distclean`?



---

archive/issue_events_073240.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2020-01-06T14:10:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28691",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28691#event-73240"
}
```



---

archive/issue_comments_404864.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28691#issuecomment-404864",
    "user": "https://github.com/embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_404865.json:
```json
{
    "body": "Changing type from enhancement to defect.",
    "created_at": "2020-01-06T14:24:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28691#issuecomment-404865",
    "user": "https://github.com/embray"
}
```

Changing type from enhancement to defect.



---

archive/issue_comments_404866.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2020-01-06T14:24:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28691#issuecomment-404866",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_404867.json:
```json
{
    "body": "This isn't anything to do with sageinspect.py.  It's a failure with the `cython()` function which happens to be used in a few of the doctests in sageinspect.py.  The problem occurs when trying to import the compiled Python module from the tempfile, which is either not found, or is not compiled or linked properly.  The problem does not have to do with introspection.  As I wrote on the mailing list, is it possible to reproduce this failure outside the doctests? \n\nDitto's Simon's confusion about the build.",
    "created_at": "2020-01-06T14:24:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28691#issuecomment-404867",
    "user": "https://github.com/embray"
}
```

This isn't anything to do with sageinspect.py.  It's a failure with the `cython()` function which happens to be used in a few of the doctests in sageinspect.py.  The problem occurs when trying to import the compiled Python module from the tempfile, which is either not found, or is not compiled or linked properly.  The problem does not have to do with introspection.  As I wrote on the mailing list, is it possible to reproduce this failure outside the doctests? 

Ditto's Simon's confusion about the build.



---

archive/issue_comments_404868.json:
```json
{
    "body": "Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.",
    "created_at": "2020-05-01T04:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28691#issuecomment-404868",
    "user": "https://github.com/mkoeppe"
}
```

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.



---

archive/issue_events_073241.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-01T04:28:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28691",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28691#event-73241"
}
```



---

archive/issue_events_073242.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-05-01T04:28:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28691",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28691#event-73242"
}
```



---

archive/issue_events_073243.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28691",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28691#event-73243"
}
```



---

archive/issue_events_073244.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28691",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28691#event-73244"
}
```



---

archive/issue_events_073245.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-10T22:47:05Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28691",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28691#event-73245"
}
```



---

archive/issue_events_073246.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-10T22:47:05Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/28691",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28691#event-73246"
}
```



---

archive/issue_comments_404869.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2021-04-10T22:47:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28691#issuecomment-404869",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_404870.json:
```json
{
    "body": "We can close this ticket as outdated. An almost identical failure has been reported in #31626",
    "created_at": "2021-04-10T22:47:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28691#issuecomment-404870",
    "user": "https://github.com/mkoeppe"
}
```

We can close this ticket as outdated. An almost identical failure has been reported in #31626



---

archive/issue_comments_404871.json:
```json
{
    "body": "Good, I'm glad this was found.",
    "created_at": "2021-04-11T03:35:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28691#issuecomment-404871",
    "user": "https://github.com/strogdon"
}
```

Good, I'm glad this was found.



---

archive/issue_comments_404872.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-11T03:35:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28691#issuecomment-404872",
    "user": "https://github.com/strogdon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_404873.json:
```json
{
    "body": "Sorry for a confusing ticket description mentioning Python 2\nbut including a Python 3 traceback.\n\nLet's close this and focus on #31626.",
    "created_at": "2021-04-14T17:36:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28691#issuecomment-404873",
    "user": "https://github.com/slel"
}
```

Sorry for a confusing ticket description mentioning Python 2
but including a Python 3 traceback.

Let's close this and focus on #31626.



---

archive/issue_events_073247.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2021-04-14T17:36:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28691",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28691#event-73247"
}
```



---

archive/issue_comments_404874.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2021-04-14T17:36:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28691",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28691#issuecomment-404874",
    "user": "https://github.com/slel"
}
```

Resolution: duplicate
