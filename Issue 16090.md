# Issue 16090: new bash script to clean up $SAGE_ROOT/upstream

Issue created by migration from https://trac.sagemath.org/ticket/16327

Original creator: ppurka

Original creation time: 2014-05-11 10:20:39

CC:  jpflori ncohen dimpase mjo

Attached is a new bash script to clean up `$SAGE_ROOT/upstream` that gets cluttered with stale packages.

Usage:


```
$ sage -sh
$ ./sage-clean-upstream --pretend    # to show what it would remove
$ ./sage-clean-upstream              # to actually remove old tar balls
```


If there is interest, then I will try to convert it to a script within sage, which could be called using `sage --clean-upstream`.

The attached log file shows what it would delete on my system, and what files are currently present in `upstream/` on my system.


---

Comment by ppurka created at 2014-05-11 10:21:14

log file showing what would be deleted


---

Attachment

the bash script


---

Attachment

One problem is that currently not all packages have proper versions / "fullnames", cf. `sage-list-packages`.  I.e., e.g. `ver` may be empty and then `pkg_ver="$pkg-$ver"` doesn't work.


---

Comment by leif created at 2014-05-11 14:59:45

P.S.:  Do you plan to handle different branches? :P

(I'd at least check that `master` doesn't reference any of those subject to deletion.)


---

Comment by ppurka created at 2014-05-11 15:07:21

Replying to [comment:1 leif]:
> One problem is that currently not all packages have proper versions / "fullnames", cf. `sage-list-packages`.  I.e., e.g. `ver` may be empty and then `pkg_ver="$pkg-$ver"` doesn't work.

Well, sage-list-packages gives very old versions. I don't see how that is reliable.

```
~» sage -sh
~» sage-list-packages standard
...
sage-5.13 ............................... not installed
sage_root-5.13 .......................... not installed
sage_scripts-5.13 ....................... not installed
sagenb-0.10.7.2 ......................... installed version: 0.10.8.2
...
```


Do you have an example where a package does not have version? I can not find any in my list; but I haven't tried the optional or experimental packages, of course.

```
~/tmp/sage/build/pkgs» for p in *; do
 if [[ ! -f "$p"/package-version.txt ]]; then
  continue
 fi
 if [[ -z "$(<$p/package-version.txt)" ]]; then
  echo "$p has empty version"
 fi
done
~/tmp/sage/build/pkgs»
```


Finally, the script skips those packages that do not have versions in their tarball. In those cases, the `tarball` variable in the inner for loop happens to be of the form `.../upstream/package-*`. The script therefore checks whether the variable `tarball` is actually a file in `upstream/` or not.


---

Comment by ppurka created at 2014-05-11 15:09:34

Replying to [comment:2 leif]:
> P.S.:  Do you plan to handle different branches? :P
> 
> (I'd at least check that `master` doesn't reference any of those subject to deletion.)
Ah! Different branches would be tricky to handle! There would be no information available on the packages in a separate branch, unless we actually change the branch to master and back (or vice versa).


---

Comment by leif created at 2014-05-11 15:12:25

Replying to [comment:3 ppurka]:
> Replying to [comment:1 leif]:
> > One problem is that currently not all packages have proper versions / "fullnames", cf. `sage-list-packages`.  I.e., e.g. `ver` may be empty and then `pkg_ver="$pkg-$ver"` doesn't work.
> 
> Well, sage-list-packages gives very old versions.

I meant to refer to its source code, not its output.


---

Comment by mkoeppe created at 2020-08-17 16:38:58

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-08-17 16:38:58

Outdated spkg or build system ticket, should be closed


---

Comment by ppurka created at 2020-12-28 06:41:17

Hmm.. script still works, after all these years! I will try to look into `sage-list-packages` if I get some time.


---

Comment by mjo created at 2021-08-20 00:00:14

What's the definition of a stale package? You can clean the entire `upstream` directory with


```
$ git clean --dry-run -x upstream/*
Would remove upstream/Babel-2.9.1.tar.gz
Would remove upstream/Cython-0.29.21.tar.gz
Would remove upstream/Pillow-8.1.2.tar.gz
Would remove upstream/PyCygwin-0.1.tar.gz
Would remove upstream/Pygments-2.3.1.tar.gz
Would remove upstream/Send2Trash-1.5.0.tar.gz
Would remove upstream/Sphinx-4.0.1.tar.gz
Would remove upstream/alabaster-0.7.12.tar.gz
Would remove upstream/appnope-0.1.0.tar.gz
Would remove upstream/argon2-cffi-20.1.0.tar.gz
Would remove upstream/attrs-19.3.0.tar.gz
Would remove upstream/backcall-0.1.0.tar.gz
Would remove upstream/bleach-3.1.5.tar.gz
Would remove upstream/certifi-2020.11.8.tar.gz
Would remove upstream/cffi-1.14.5.tar.gz
Would remove upstream/combinatorial_designs-20140630.tar.bz2
Would remove upstream/conway_polynomials-0.5.tar.bz2
Would remove upstream/cycler-0.10.0.tar.gz
Would remove upstream/cypari2-2.1.2.tar.gz
Would remove upstream/cysignals-1.10.3.tar.gz
Would remove upstream/decorator-4.4.2.tar.gz
Would remove upstream/defusedxml-0.6.0.tar.gz
Would remove upstream/docutils-0.17.1.tar.gz
Would remove upstream/elliptic_curves-0.8.1.tar.bz2
Would remove upstream/entrypoints-0.3.tar.gz
Would remove upstream/fpylll-0.5.6.tar.gz
Would remove upstream/gap-4.11.1.tar.gz
Would remove upstream/gmpy2-2.1.0b5.tar.gz
Would remove upstream/graphs-20210214.tar.bz2
Would remove upstream/html5lib-1.0.1.tar.gz
Would remove upstream/imagesize-1.2.0.tar.gz
Would remove upstream/importlib_metadata-4.0.1.tar.gz
Would remove upstream/importlib_resources-5.1.4.tar.gz
Would remove upstream/ipykernel-5.2.1.tar.gz
Would remove upstream/ipython-7.16.1.tar.gz
Would remove upstream/ipython_genutils-0.2.0.tar.gz
Would remove upstream/ipywidgets-7.6.3.tar.gz
Would remove upstream/jedi-0.17.2.tar.gz
Would remove upstream/jinja2-2.11.2.tar.gz
Would remove upstream/jmol-14.29.52.tar.bz2
Would remove upstream/jsonschema-3.2.0.tar.gz
Would remove upstream/jupyter_client-6.1.6.tar.gz
Would remove upstream/jupyter_core-4.6.3.tar.gz
Would remove upstream/jupyter_jsmol-0.2.4.tar.gz
Would remove upstream/kiwisolver-1.0.1.tar.gz
Would remove upstream/lcalc-1.23.tar.bz2
Would remove upstream/linbox-1.6.3.tar.gz
Would remove upstream/markupsafe-1.1.1.tar.gz
Would remove upstream/mathjax-2.7.4.tar.gz
Would remove upstream/matplotlib-3.3.4.tar.gz
Would remove upstream/maxima-5.45.0.tar.gz
Would remove upstream/memory_allocator-0.1.0.tar.gz
Would remove upstream/mirror_list
Would remove upstream/mistune-0.8.4.tar.gz
Would remove upstream/mpmath-1.2.1.tar.gz
Would remove upstream/nbconvert-5.6.1.tar.gz
Would remove upstream/nbformat-5.0.7.tar.gz
Would remove upstream/networkx-2.5.1.tar.gz
Would remove upstream/nose-1.3.7.tar.gz
Would remove upstream/notebook-6.1.1.tar.gz
Would remove upstream/numpy-1.20.3.zip
Would remove upstream/packaging-20.9.tar.gz
Would remove upstream/palp-2.11.tar.gz
Would remove upstream/pandocfilters-1.4.2.tar.gz
Would remove upstream/parso-0.7.0.tar.gz
Would remove upstream/pexpect-4.8.0.tar.gz
Would remove upstream/pickleshare-0.7.5.tar.gz
Would remove upstream/pip-21.1.2.tar.gz
Would remove upstream/pkgconfig-1.5.2.tar.gz
Would remove upstream/pluggy-0.13.1.tar.gz
Would remove upstream/polytopes_db-20170220.tar.bz2
Would remove upstream/pplpy-0.8.6.tar.gz
Would remove upstream/prometheus_client-0.8.0.tar.gz
Would remove upstream/prompt_toolkit-3.0.5.tar.gz
Would remove upstream/psutil-5.2.0.tar.gz
Would remove upstream/ptyprocess-0.5.1.tar.gz
Would remove upstream/py-1.10.0.tar.gz
Would remove upstream/pybind11-2.6.0.tar.gz
Would remove upstream/pycparser-2.20.tar.gz
Would remove upstream/pynac-0.7.29.tar.bz2
Would remove upstream/pyparsing-2.4.7.tar.gz
Would remove upstream/pyrsistent-0.16.0.tar.gz
Would remove upstream/python-dateutil-2.8.1.tar.gz
Would remove upstream/pytz-2020.4.tar.gz
Would remove upstream/pyzmq-22.0.3.tar.gz
Would remove upstream/qepcad-B.1.72.tar.gz
Would remove upstream/ratpoints-2.1.3.tar.bz2
Would remove upstream/requests-2.13.0.tar.gz
Would remove upstream/saclib2.2.7.tar.gz
Would remove upstream/sagenb_export-3.3.tar.gz
Would remove upstream/sagetex-3.5.tar.gz
Would remove upstream/scandir-1.9.0.tar.gz
Would remove upstream/scipy-1.6.3.tar.gz
Would remove upstream/setuptools-56.2.0.tar.gz
Would remove upstream/setuptools_scm-6.0.1.tar.gz
Would remove upstream/simplegeneric-0.8.1.tar.bz2
Would remove upstream/singular-4.2.0p3.tar.gz
Would remove upstream/six-1.15.0.tar.gz
Would remove upstream/snowballstemmer-1.2.1.tar.gz
Would remove upstream/sphinxcontrib-applehelp-1.0.2.tar.gz
Would remove upstream/sphinxcontrib-devhelp-1.0.2.tar.gz
Would remove upstream/sphinxcontrib-htmlhelp-1.0.3.tar.gz
Would remove upstream/sphinxcontrib-jsmath-1.0.1.tar.gz
Would remove upstream/sphinxcontrib-qthelp-1.0.3.tar.gz
Would remove upstream/sphinxcontrib-serializinghtml-1.1.4.tar.gz
Would remove upstream/sphinxcontrib-websupport-1.2.1.tar.gz
Would remove upstream/sympy-1.8.tar.gz
Would remove upstream/terminado-0.8.3.tar.gz
Would remove upstream/testpath-0.4.4.tar.gz
Would remove upstream/thebe-9624e0a0.zip
Would remove upstream/threejs-sage-r122.tar.gz
Would remove upstream/toml-0.10.2.tar.gz
Would remove upstream/tornado-6.0.4.tar.gz
Would remove upstream/traitlets-4.3.3.tar.gz
Would remove upstream/typing_extensions-3.10.0.0.tar.gz
Would remove upstream/tzlocal-2.1.tar.gz
Would remove upstream/vcversioner-2.16.0.0.tar.gz
Would remove upstream/wcwidth-0.1.7.tar.gz
Would remove upstream/webencodings-0.5.1.tar.gz
Would remove upstream/wheel-0.36.2.tar.gz
Would remove upstream/widgetsnbextension-3.5.1.tar.gz
Would remove upstream/zipp-0.5.2.tar.gz
Would remove upstream/zn_poly-0.9.2.tar.gz
```


But as someone else pointed out, there's no easy way to tell which of those are needed by some branch.


---

Comment by ppurka created at 2021-09-01 15:24:01

Replying to [comment:12 mjo]:
> What's the definition of a stale package?
Wow, this ticket is 7 years old now! I am not actively involved nowadays, and I will have to read my script carefully to understand how I had implemented it so many years ago!

Regarding stale package, below is an example - once the newer package is installed we do not have a need for the older one:

```
...tallations/sage/upstream » ls -1 ecl*
ecl-20.4.24.tgz
ecl-21.2.1.tgz
```


> But as someone else pointed out, there's no easy way to tell which of those are needed by some branch.

This is true. There is no easy way out of this. If a developer switches branches between master and some other development branch where a _lot_ of packages have changed then it is really a choice whether the developer wants to keep on running a script like this every other day. Recompiling packages will re-download the files at the worst.

This script was not supposed to be run very frequently. It was supposed to help clean up upstream directory by identifying packages that are no longer needed by the current version of sage.
