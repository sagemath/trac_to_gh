# Issue 24888: dancing links: find all solutions in parallel

archive/issues_024888.json:
```json
{
    "body": "Add `all_solutions` method so that one can do:\n\n\n```python\nsage: S = Subsets(range(4))\nsage: rows = map(list, S)\nsage: dlx = dlx_solver(rows)\nsage: dlx\nDancing links solver for 4 columns and 16 rows\nsage: dlx.number_of_solutions()\n15\nsage: sorted([sorted(s) for s in dlx.all_solutions(ncpus=8)])\n[[1, 2, 3, 4],\n [1, 2, 10],\n [1, 3, 9],\n [1, 4, 8],\n [1, 14],\n [2, 3, 7],\n [2, 4, 6],\n [2, 13],\n [3, 4, 5],\n [3, 12],\n [4, 11],\n [5, 10],\n [6, 9],\n [7, 8],\n [15]]\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/25125\n\n",
    "created_at": "2018-04-09T06:31:19Z",
    "labels": [
        "combinatorics",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "dancing links: find all solutions in parallel",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24888",
    "user": "slabbe"
}
```
Add `all_solutions` method so that one can do:


```python
sage: S = Subsets(range(4))
sage: rows = map(list, S)
sage: dlx = dlx_solver(rows)
sage: dlx
Dancing links solver for 4 columns and 16 rows
sage: dlx.number_of_solutions()
15
sage: sorted([sorted(s) for s in dlx.all_solutions(ncpus=8)])
[[1, 2, 3, 4],
 [1, 2, 10],
 [1, 3, 9],
 [1, 4, 8],
 [1, 14],
 [2, 3, 7],
 [2, 4, 6],
 [2, 13],
 [3, 4, 5],
 [3, 12],
 [4, 11],
 [5, 10],
 [6, 9],
 [7, 8],
 [15]]
```


Issue created by migration from https://trac.sagemath.org/ticket/25125





---

archive/issue_comments_349804.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-04-09T06:33:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349804",
    "user": "slabbe"
}
```

New commits:



---

archive/issue_comments_349805.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-04-09T08:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349805",
    "user": "slabbe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_349806.json:
```json
{
    "body": "spliting -> splitting\n\nadd a test / example for parallel?",
    "created_at": "2018-04-09T09:32:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349806",
    "user": "mantepse"
}
```

spliting -> splitting

add a test / example for parallel?



---

archive/issue_comments_349807.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-09T20:50:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349807",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_349808.json:
```json
{
    "body": "Since tests are often run in parallel, I know Volker does not like when doctests use more than one cpus. Instead I added a sentence explaining how to use `ncpus` argument.\n\nre-needs_review.",
    "created_at": "2018-04-09T20:53:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349808",
    "user": "slabbe"
}
```

Since tests are often run in parallel, I know Volker does not like when doctests use more than one cpus. Instead I added a sentence explaining how to use `ncpus` argument.

re-needs_review.



---

archive/issue_comments_349809.json:
```json
{
    "body": "I think you forgot to set the \"Author\" on this ticket.",
    "created_at": "2018-04-12T17:34:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349809",
    "user": "saraedum"
}
```

I think you forgot to set the "Author" on this ticket.



---

archive/issue_comments_349810.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-04-12T17:41:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349810",
    "user": "saraedum"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_349811.json:
```json
{
    "body": "I think it's a bit weird that the ncpus example does not actually set ncpus>1. It's understandable from your comment on the ticket why you did that but it's not understandable from looking at the code. I think it would be nice to add a comment to the docstring.\n\nWhy do you set `ncpus=1` as a default? Shouldn't the default just be `None`? During doctests that is going to be \"2\" which seems to be Ok for doctesting, see `ncpus.py`.",
    "created_at": "2018-04-12T17:41:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349811",
    "user": "saraedum"
}
```

I think it's a bit weird that the ncpus example does not actually set ncpus>1. It's understandable from your comment on the ticket why you did that but it's not understandable from looking at the code. I think it would be nice to add a comment to the docstring.

Why do you set `ncpus=1` as a default? Shouldn't the default just be `None`? During doctests that is going to be "2" which seems to be Ok for doctesting, see `ncpus.py`.



---

archive/issue_comments_349812.json:
```json
{
    "body": "Replying to [comment:5 slabbe]:\n> I know Volker does not like when doctests use more than one cpus\n\nFor reference, here is the previous discussion on this aspect:\nhttps://trac.sagemath.org/ticket/24424#comment:3\n\nAt #24424, in the end, I wrote `ncpus=2` in the doctests.",
    "created_at": "2018-04-12T19:32:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349812",
    "user": "slabbe"
}
```

Replying to [comment:5 slabbe]:
> I know Volker does not like when doctests use more than one cpus

For reference, here is the previous discussion on this aspect:
https://trac.sagemath.org/ticket/24424#comment:3

At #24424, in the end, I wrote `ncpus=2` in the doctests.



---

archive/issue_comments_349813.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-12T19:48:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349813",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_349814.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-04-12T19:50:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349814",
    "user": "slabbe"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_349815.json:
```json
{
    "body": "If parallelity is what people usually want in #24424 as well, then `None` should be the default there as well I think.",
    "created_at": "2018-04-12T19:51:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349815",
    "user": "saraedum"
}
```

If parallelity is what people usually want in #24424 as well, then `None` should be the default there as well I think.



---

archive/issue_comments_349816.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-04-12T19:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349816",
    "user": "saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_349817.json:
```json
{
    "body": "The docstrings do not really work anymore now. It's not explained what `None` means. Also the example about parallel computation is not really different from the \"non-parallel\" one that is parallel as well.\n==",
    "created_at": "2018-04-12T19:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349817",
    "user": "saraedum"
}
```

The docstrings do not really work anymore now. It's not explained what `None` means. Also the example about parallel computation is not really different from the "non-parallel" one that is parallel as well.
==



---

archive/issue_comments_349818.json:
```json
{
    "body": "Ok, thanks for your comment. I will rework on this in a few days. I need to prepare for a travel.",
    "created_at": "2018-04-12T20:32:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349818",
    "user": "slabbe"
}
```

Ok, thanks for your comment. I will rework on this in a few days. I need to prepare for a travel.



---

archive/issue_comments_349819.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-04-22T14:17:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349819",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_349820.json:
```json
{
    "body": "I rebased the branch on top of rc3.\n\nI improved the sentences before some doctests to avoid problems mentionned by saraedum.\n\nI also rewrote `number_of_solutions` method to be like `one_solution` and `all_solutions` methods. I deleted the `_number_of_solutions_iterator` method. After changing `ncpus=1` to `ncpus=None`, there was an infinite loop because `_number_of_solutions_iterator` was calling `number_of_solutions` which was calling  `_number_of_solutions_iterator` again because `ncpus` was not set to 1 by default. I think the code makes more sense like it is now.\n\nNeeds review.",
    "created_at": "2018-04-22T14:25:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349820",
    "user": "slabbe"
}
```

I rebased the branch on top of rc3.

I improved the sentences before some doctests to avoid problems mentionned by saraedum.

I also rewrote `number_of_solutions` method to be like `one_solution` and `all_solutions` methods. I deleted the `_number_of_solutions_iterator` method. After changing `ncpus=1` to `ncpus=None`, there was an infinite loop because `_number_of_solutions_iterator` was calling `number_of_solutions` which was calling  `_number_of_solutions_iterator` again because `ncpus` was not set to 1 by default. I think the code makes more sense like it is now.

Needs review.



---

archive/issue_comments_349821.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-04-22T14:25:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349821",
    "user": "slabbe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_349822.json:
```json
{
    "body": "Changing keywords from \"\" to \"thursdaysbdx\".",
    "created_at": "2018-05-01T09:08:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349822",
    "user": "slabbe"
}
```

Changing keywords from "" to "thursdaysbdx".



---

archive/issue_comments_349823.json:
```json
{
    "body": "Why\n\n```\n             sage: x = dlx_solver(rows)\n-            sage: x.number_of_solutions()\n+            sage: x.number_of_solutions(ncpus=1)\n             3\n-            sage: x.number_of_solutions()\n+            sage: x.number_of_solutions(ncpus=1)\n             0\n```\n\nIf the behavior with and without `ncpus=1` are different, this should be specified.",
    "created_at": "2018-05-01T14:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349823",
    "user": "vdelecroix"
}
```

Why

```
             sage: x = dlx_solver(rows)
-            sage: x.number_of_solutions()
+            sage: x.number_of_solutions(ncpus=1)
             3
-            sage: x.number_of_solutions()
+            sage: x.number_of_solutions(ncpus=1)
             0
```

If the behavior with and without `ncpus=1` are different, this should be specified.



---

archive/issue_comments_349824.json:
```json
{
    "body": "Why would you split stuff here\n\n```\n+ return sum(val for ((args, kwds), val) in nb_sol(indices))\n```\n\ncan be\n\n```\n+ return sum(x[1] for x in nb_sol(indices))\n```\n",
    "created_at": "2018-05-01T14:40:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349824",
    "user": "vdelecroix"
}
```

Why would you split stuff here

```
+ return sum(val for ((args, kwds), val) in nb_sol(indices))
```

can be

```
+ return sum(x[1] for x in nb_sol(indices))
```




---

archive/issue_comments_349825.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-05-01T16:26:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349825",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_349826.json:
```json
{
    "body": "I found a way to reinitialize the dlx solver.\n\nThe branch was rebased on rc4.\n\nNeeds review.",
    "created_at": "2018-05-01T16:28:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349826",
    "user": "slabbe"
}
```

I found a way to reinitialize the dlx solver.

The branch was rebased on rc4.

Needs review.



---

archive/issue_comments_349827.json:
```json
{
    "body": "[comment:18] still applies.",
    "created_at": "2018-05-01T17:03:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349827",
    "user": "vdelecroix"
}
```

[comment:18] still applies.



---

archive/issue_comments_349828.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-01T19:06:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349828",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_349829.json:
```json
{
    "body": "Replying to [comment:18 vdelecroix]:\n> If the behavior with and without `ncpus=1` are different, this should be specified.\n\nThe behavior is not different anymore. Reinitialization is performed automatically when needed.",
    "created_at": "2018-05-01T19:08:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349829",
    "user": "slabbe"
}
```

Replying to [comment:18 vdelecroix]:
> If the behavior with and without `ncpus=1` are different, this should be specified.

The behavior is not different anymore. Reinitialization is performed automatically when needed.



---

archive/issue_comments_349830.json:
```json
{
    "body": "Replying to [comment:24 slabbe]:\n> Replying to [comment:18 vdelecroix]:\n> > If the behavior with and without `ncpus=1` are different, this should be specified.\n> \n> The behavior is not different anymore. Reinitialization is performed automatically when needed.\n\nThen why modifying the test by specifying `ncpus=1`? You should not remove doctests and it would be better anyway to test with `ncpus=1`, `ncpus=2` and `ncpus=None`.",
    "created_at": "2018-05-02T10:47:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349830",
    "user": "vdelecroix"
}
```

Replying to [comment:24 slabbe]:
> Replying to [comment:18 vdelecroix]:
> > If the behavior with and without `ncpus=1` are different, this should be specified.
> 
> The behavior is not different anymore. Reinitialization is performed automatically when needed.

Then why modifying the test by specifying `ncpus=1`? You should not remove doctests and it would be better anyway to test with `ncpus=1`, `ncpus=2` and `ncpus=None`.



---

archive/issue_comments_349831.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-05-02T10:47:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349831",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_349832.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-05-02T14:01:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349832",
    "user": "slabbe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_349833.json:
```json
{
    "body": "Replying to [comment:25 vdelecroix]:\n> Then why modifying the test by specifying `ncpus=1`? You should not remove doctests and it would be better anyway to test with `ncpus=1`, `ncpus=2` and `ncpus=None`.\n\nBecause before the input was `ncpus=1` :\n\n\n```diff\n-    def number_of_solutions(self, ncpus=1, column=None):\n+    def number_of_solutions(self, ncpus=None, column=None):\n```\n\n\nTherefore, the previous doctest with no input was testing the case when `ncpus=1`. Since the new default value for ncpus is `None`, if I want to *avoid* removing a doctest, I need to specifically set `ncpus=1` in the doctest.\n\nIf `ncpus` is not equal to `1`, then the parallel code applies which uses `restrict` which temporarily creates new dlx solvers which are used only once before being deleted. So to me, there is no need to test with `ncpus=1`, `ncpus=2` and `ncpus=None`.\n\nThus, I rechange the status to needs review. Tell me if you insist on this aspect and if you want me to add those doctests.",
    "created_at": "2018-05-02T14:01:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349833",
    "user": "slabbe"
}
```

Replying to [comment:25 vdelecroix]:
> Then why modifying the test by specifying `ncpus=1`? You should not remove doctests and it would be better anyway to test with `ncpus=1`, `ncpus=2` and `ncpus=None`.

Because before the input was `ncpus=1` :


```diff
-    def number_of_solutions(self, ncpus=1, column=None):
+    def number_of_solutions(self, ncpus=None, column=None):
```


Therefore, the previous doctest with no input was testing the case when `ncpus=1`. Since the new default value for ncpus is `None`, if I want to *avoid* removing a doctest, I need to specifically set `ncpus=1` in the doctest.

If `ncpus` is not equal to `1`, then the parallel code applies which uses `restrict` which temporarily creates new dlx solvers which are used only once before being deleted. So to me, there is no need to test with `ncpus=1`, `ncpus=2` and `ncpus=None`.

Thus, I rechange the status to needs review. Tell me if you insist on this aspect and if you want me to add those doctests.



---

archive/issue_comments_349834.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-05-02T14:08:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349834",
    "user": "vdelecroix"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_349835.json:
```json
{
    "body": "Ho I see.",
    "created_at": "2018-05-02T14:08:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349835",
    "user": "vdelecroix"
}
```

Ho I see.



---

archive/issue_comments_349836.json:
```json
{
    "body": "Thanks to both of you for the review. I am very happy with the state it has reached now.",
    "created_at": "2018-05-02T16:10:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349836",
    "user": "slabbe"
}
```

Thanks to both of you for the review. I am very happy with the state it has reached now.



---

archive/issue_comments_349837.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-05-12T11:46:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349837",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_349838.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2018-05-13T16:35:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349838",
    "user": "vbraun"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_349839.json:
```json
{
    "body": "I'm getting random failures, especially on OSX\n\n```\nsage -t --long src/sage/games/sudoku.py\n**********************************************************************\nFile \"src/sage/games/sudoku.py\", line 549, in sage.games.sudoku.Sudoku.solve\nFailed example:\n    next(h.solve(algorithm='dlx'))\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 562, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 972, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.games.sudoku.Sudoku.solve[3]>\", line 1, in <module>\n        next(h.solve(algorithm='dlx'))\n    StopIteration\n**********************************************************************\n1 item had failures:\n   1 of  14 in sage.games.sudoku.Sudoku.solve\n    [96 tests, 1 failure, 2.38 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/games/sudoku.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n\nor\n\n```\nsage -t --long src/sage/games/sudoku.py\n**********************************************************************\nFile \"src/sage/games/sudoku.py\", line 863, in sage.games.sudoku.Sudoku.dlx.make_row\nFailed example:\n    len(list(h.solve(algorithm='dlx')))  # indirect doctest\nExpected:\n    5\nGot:\n    0\n**********************************************************************\n1 item had failures:\n   1 of   3 in sage.games.sudoku.Sudoku.dlx.make_row\n    [96 tests, 1 failure, 2.40 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/games/sudoku.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n\nTry runnning tests in a loop, e.g.\n\n```\nfor i in `seq 0 1000` ; do ./sage -t --long src/sage/games/sudoku.py ; done\n```\n",
    "created_at": "2018-05-13T16:35:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349839",
    "user": "vbraun"
}
```

I'm getting random failures, especially on OSX

```
sage -t --long src/sage/games/sudoku.py
**********************************************************************
File "src/sage/games/sudoku.py", line 549, in sage.games.sudoku.Sudoku.solve
Failed example:
    next(h.solve(algorithm='dlx'))
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 562, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 972, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.games.sudoku.Sudoku.solve[3]>", line 1, in <module>
        next(h.solve(algorithm='dlx'))
    StopIteration
**********************************************************************
1 item had failures:
   1 of  14 in sage.games.sudoku.Sudoku.solve
    [96 tests, 1 failure, 2.38 s]
----------------------------------------------------------------------
sage -t --long src/sage/games/sudoku.py  # 1 doctest failed
----------------------------------------------------------------------
```

or

```
sage -t --long src/sage/games/sudoku.py
**********************************************************************
File "src/sage/games/sudoku.py", line 863, in sage.games.sudoku.Sudoku.dlx.make_row
Failed example:
    len(list(h.solve(algorithm='dlx')))  # indirect doctest
Expected:
    5
Got:
    0
**********************************************************************
1 item had failures:
   1 of   3 in sage.games.sudoku.Sudoku.dlx.make_row
    [96 tests, 1 failure, 2.40 s]
----------------------------------------------------------------------
sage -t --long src/sage/games/sudoku.py  # 1 doctest failed
----------------------------------------------------------------------
```

Try runnning tests in a loop, e.g.

```
for i in `seq 0 1000` ; do ./sage -t --long src/sage/games/sudoku.py ; done
```




---

archive/issue_comments_349840.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2018-05-13T16:35:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349840",
    "user": "vbraun"
}
```

Changing status from closed to new.



---

archive/issue_comments_349841.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-05-15T13:31:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349841",
    "user": "slabbe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_349842.json:
```json
{
    "body": "On Ubuntu, I can not reproduce the issue.\n\nThe methods I am adding/modifying to the dancing links class are not used by the sudoku solver which uses directly the `search` and  `get_solution` methods. The only thing I changed that may have affected the sudoku thing is the way the `__init__` is done which is now done with the `reinitalize` method. Maybe OSX does not like the line\n\n\n```\nself._x = dancing_links()\n```\n\n\nthat was in the `reinitialize` which was called by the `__init__`? So, I added a new commit which does\n\n\n```\nself._x = dancing_links()\n```\n\n\nonly for the reinitialization and avoids it for `__init__` as it was before. Can somebody with OSX test whether this fixes the issue?\n----\nNew commits:",
    "created_at": "2018-05-15T13:31:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349842",
    "user": "slabbe"
}
```

On Ubuntu, I can not reproduce the issue.

The methods I am adding/modifying to the dancing links class are not used by the sudoku solver which uses directly the `search` and  `get_solution` methods. The only thing I changed that may have affected the sudoku thing is the way the `__init__` is done which is now done with the `reinitalize` method. Maybe OSX does not like the line


```
self._x = dancing_links()
```


that was in the `reinitialize` which was called by the `__init__`? So, I added a new commit which does


```
self._x = dancing_links()
```


only for the reinitialization and avoids it for `__init__` as it was before. Can somebody with OSX test whether this fixes the issue?
----
New commits:



---

archive/issue_comments_349843.json:
```json
{
    "body": "Tests `for i in `seq 0 1000` ; do ./sage -t --long src/sage/games/sudoku.py ; done` has been successfully passed on OSX (High Sierra) with `\u200bd13e0ec`.",
    "created_at": "2018-05-18T15:30:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349843",
    "user": "vklein"
}
```

Tests `for i in `seq 0 1000` ; do ./sage -t --long src/sage/games/sudoku.py ; done` has been successfully passed on OSX (High Sierra) with `​d13e0ec`.



---

archive/issue_comments_349844.json:
```json
{
    "body": "And are you able to reproduce the problem mentionned by Volker with commit a5c4667 ?",
    "created_at": "2018-05-18T19:14:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349844",
    "user": "slabbe"
}
```

And are you able to reproduce the problem mentionned by Volker with commit a5c4667 ?



---

archive/issue_comments_349845.json:
```json
{
    "body": "Yes ! I should have mentioned that.",
    "created_at": "2018-05-22T07:13:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349845",
    "user": "vklein"
}
```

Yes ! I should have mentioned that.



---

archive/issue_comments_349846.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-05-22T11:46:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349846",
    "user": "vklein"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_349847.json:
```json
{
    "body": "\u200bd13e0ec fix the problem.",
    "created_at": "2018-05-22T11:46:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349847",
    "user": "vklein"
}
```

​d13e0ec fix the problem.



---

archive/issue_comments_349848.json:
```json
{
    "body": "Thanks for your help testing on OSX.\n\nS\u00e9bastien",
    "created_at": "2018-05-22T11:56:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349848",
    "user": "slabbe"
}
```

Thanks for your help testing on OSX.

Sébastien



---

archive/issue_comments_349849.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-05-23T21:41:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349849",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_349850.json:
```json
{
    "body": "\n```\nsage -t --long src/sage/combinat/matrices/dancing_links.pyx\n**********************************************************************\nFile \"src/sage/combinat/matrices/dancing_links.pyx\", line 683, in sage.combinat.matrices.dancing_links.dancing_linksWrapper.all_solutions\nFailed example:\n    [sorted(s) for s in S]\nExpected:\n    [[0, 1], [2, 3], [4, 5]]\nGot:\n    [[0, 1], [4, 5], [2, 3]]\n**********************************************************************\n1 item had failures:\n   1 of  16 in sage.combinat.matrices.dancing_links.dancing_linksWrapper.all_solutions\n    [215 tests, 1 failure, 7.16 s]\n```\n",
    "created_at": "2018-05-23T21:41:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349850",
    "user": "vbraun"
}
```


```
sage -t --long src/sage/combinat/matrices/dancing_links.pyx
**********************************************************************
File "src/sage/combinat/matrices/dancing_links.pyx", line 683, in sage.combinat.matrices.dancing_links.dancing_linksWrapper.all_solutions
Failed example:
    [sorted(s) for s in S]
Expected:
    [[0, 1], [2, 3], [4, 5]]
Got:
    [[0, 1], [4, 5], [2, 3]]
**********************************************************************
1 item had failures:
   1 of  16 in sage.combinat.matrices.dancing_links.dancing_linksWrapper.all_solutions
    [215 tests, 1 failure, 7.16 s]
```




---

archive/issue_comments_349851.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-05-24T08:13:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349851",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_349852.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-05-24T09:13:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349852",
    "user": "slabbe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_349853.json:
```json
{
    "body": "Sorry Volker. I was sure that I put sorted everywhere needed, but I forgot one.\n\nRebased on 8.3.beta2.\n\nI added a commit which added the `sorted` where the doctest problem occurs. I also added two other `sorted` elsewhere.\n\nNeeds review.",
    "created_at": "2018-05-24T09:13:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349853",
    "user": "slabbe"
}
```

Sorry Volker. I was sure that I put sorted everywhere needed, but I forgot one.

Rebased on 8.3.beta2.

I added a commit which added the `sorted` where the doctest problem occurs. I also added two other `sorted` elsewhere.

Needs review.



---

archive/issue_comments_349854.json:
```json
{
    "body": "`sage -t -a` works on ubuntu and OSX ( except for ext_rep.py and external.py killed due to abort signal, which is not related to this ticket).",
    "created_at": "2018-05-29T09:24:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349854",
    "user": "vklein"
}
```

`sage -t -a` works on ubuntu and OSX ( except for ext_rep.py and external.py killed due to abort signal, which is not related to this ticket).



---

archive/issue_comments_349855.json:
```json
{
    "body": "Random errors on dancing_links.pyx on OSX.\n\n\n\n```\nsage admin$ for i in `seq 0 50` ; do ./sage -t --long src/sage/combinat/matrices/dancing_links.pyx ; done\n...\nsage -t --long --warn-long 46.8 src/sage/combinat/matrices/dancing_links.pyx\n    [215 tests, 5.41 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 5.5 seconds\n    cpu time: 4.8 seconds\n    cumulative wall time: 5.4 seconds\nmacbookpro-sierra-02:sage admin$ for i in `seq 0 50` ; do ./sage -t --long src/sage/combinat/matrices/dancing_links.pyx ; done\nRunning doctests with ID 2018-05-29-11-30-55-9317aab4.\nGit branch: t/25125/25125\nUsing --optional=gfortran,gmpy2,mpir,python2,sage\nDoctesting 1 file.\nsage -t --long --warn-long 46.8 src/sage/combinat/matrices/dancing_links.pyx\n**********************************************************************\nFile \"src/sage/combinat/matrices/dancing_links.pyx\", line 603, in sage.combinat.matrices.dancing_links.dancing_linksWrapper.one_solution\nFailed example:\n    sorted(d.one_solution())\nExpected:\n    [0, 1]\nGot:\n    [2, 3]\n**********************************************************************\n1 item had failures:\n   1 of  17 in sage.combinat.matrices.dancing_links.dancing_linksWrapper.one_solution\n    [215 tests, 1 failure, 5.46 s]\n----------------------------------------------------------------------\nsage -t --long --warn-long 46.8 src/sage/combinat/matrices/dancing_links.pyx  # 1 doctest failed\n----------------------------------------------------------------------\nTotal time for all tests: 5.6 seconds\n    cpu time: 4.9 seconds\n    cumulative wall time: 5.5 seconds\nRunning doctests with ID 2018-05-29-11-31-04-c04446f2.\nGit branch: t/25125/25125\nUsing --optional=gfortran,gmpy2,mpir,python2,sage\nDoctesting 1 file.\nsage -t --long --warn-long 46.8 src/sage/combinat/matrices/dancing_links.pyx\n**********************************************************************\nFile \"src/sage/combinat/matrices/dancing_links.pyx\", line 634, in sage.combinat.matrices.dancing_links.dancing_linksWrapper.one_solution\nFailed example:\n    sorted(dlx.one_solution())\nExpected:\n    [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]\nGot:\n    [2, 3, 4, 5, 6, 7, 9, 10, 11, 18]\n**********************************************************************\n1 item had failures:\n   1 of  17 in sage.combinat.matrices.dancing_links.dancing_linksWrapper.one_solution\n    [215 tests, 1 failure, 5.42 s]\n----------------------------------------------------------------------\nsage -t --long --warn-long 46.8 src/sage/combinat/matrices/dancing_links.pyx  # 1 doctest failed\n```\n",
    "created_at": "2018-05-29T09:35:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349855",
    "user": "vklein"
}
```

Random errors on dancing_links.pyx on OSX.



```
sage admin$ for i in `seq 0 50` ; do ./sage -t --long src/sage/combinat/matrices/dancing_links.pyx ; done
...
sage -t --long --warn-long 46.8 src/sage/combinat/matrices/dancing_links.pyx
    [215 tests, 5.41 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 5.5 seconds
    cpu time: 4.8 seconds
    cumulative wall time: 5.4 seconds
macbookpro-sierra-02:sage admin$ for i in `seq 0 50` ; do ./sage -t --long src/sage/combinat/matrices/dancing_links.pyx ; done
Running doctests with ID 2018-05-29-11-30-55-9317aab4.
Git branch: t/25125/25125
Using --optional=gfortran,gmpy2,mpir,python2,sage
Doctesting 1 file.
sage -t --long --warn-long 46.8 src/sage/combinat/matrices/dancing_links.pyx
**********************************************************************
File "src/sage/combinat/matrices/dancing_links.pyx", line 603, in sage.combinat.matrices.dancing_links.dancing_linksWrapper.one_solution
Failed example:
    sorted(d.one_solution())
Expected:
    [0, 1]
Got:
    [2, 3]
**********************************************************************
1 item had failures:
   1 of  17 in sage.combinat.matrices.dancing_links.dancing_linksWrapper.one_solution
    [215 tests, 1 failure, 5.46 s]
----------------------------------------------------------------------
sage -t --long --warn-long 46.8 src/sage/combinat/matrices/dancing_links.pyx  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 5.6 seconds
    cpu time: 4.9 seconds
    cumulative wall time: 5.5 seconds
Running doctests with ID 2018-05-29-11-31-04-c04446f2.
Git branch: t/25125/25125
Using --optional=gfortran,gmpy2,mpir,python2,sage
Doctesting 1 file.
sage -t --long --warn-long 46.8 src/sage/combinat/matrices/dancing_links.pyx
**********************************************************************
File "src/sage/combinat/matrices/dancing_links.pyx", line 634, in sage.combinat.matrices.dancing_links.dancing_linksWrapper.one_solution
Failed example:
    sorted(dlx.one_solution())
Expected:
    [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
Got:
    [2, 3, 4, 5, 6, 7, 9, 10, 11, 18]
**********************************************************************
1 item had failures:
   1 of  17 in sage.combinat.matrices.dancing_links.dancing_linksWrapper.one_solution
    [215 tests, 1 failure, 5.42 s]
----------------------------------------------------------------------
sage -t --long --warn-long 46.8 src/sage/combinat/matrices/dancing_links.pyx  # 1 doctest failed
```




---

archive/issue_comments_349856.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-05-29T09:35:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349856",
    "user": "vklein"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_349857.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-30T19:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349857",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_349858.json:
```json
{
    "body": "Thanks for your carefull review Vincent K. We avoided a nuisance to Volker.\n\nThe failures you found come from the fact that we change the `ncpus=1` to `ncpus=None` in the `one_solution` method which made deterministic doctests become not deterministic. If the doctest is run with more than one cpu, than the first solution found depend on the speed of the computation made on each cpus.\n\nI made the doctests for `one_solution` independent of the first solution found.\n\nI also added a bunch of `sorted` (even for list of size one!) to prevents other similar problem.\n\nHopefully, these were the last non deterministic doctests to be fixed.\n\nNeeds review.",
    "created_at": "2018-05-30T19:54:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349858",
    "user": "slabbe"
}
```

Thanks for your carefull review Vincent K. We avoided a nuisance to Volker.

The failures you found come from the fact that we change the `ncpus=1` to `ncpus=None` in the `one_solution` method which made deterministic doctests become not deterministic. If the doctest is run with more than one cpu, than the first solution found depend on the speed of the computation made on each cpus.

I made the doctests for `one_solution` independent of the first solution found.

I also added a bunch of `sorted` (even for list of size one!) to prevents other similar problem.

Hopefully, these were the last non deterministic doctests to be fixed.

Needs review.



---

archive/issue_comments_349859.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-05-30T19:54:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349859",
    "user": "slabbe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_349860.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-06-01T14:02:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349860",
    "user": "vklein"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_349861.json:
```json
{
    "body": "All tests passed (with several iteration of `sage -t ...dancing_links.pyx`) both on unbuntu and osx.",
    "created_at": "2018-06-01T14:02:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349861",
    "user": "vklein"
}
```

All tests passed (with several iteration of `sage -t ...dancing_links.pyx`) both on unbuntu and osx.



---

archive/issue_comments_349862.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-06-02T16:11:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24888#issuecomment-349862",
    "user": "vbraun"
}
```

Resolution: fixed
