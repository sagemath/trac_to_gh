# Issue 33880: Segfault for char polys of matrices over cyclotomic fields on macOS

Issue created by migration from https://trac.sagemath.org/ticket/34117

Original creator: dunfield

Original creation time: 2022-07-05 20:50:25

CC:  culler dimpase

With Sage 9.6 on macOS 11.6.5, I get:

```
sage: K = CyclotomicField(5)
sage: A = matrix(K, [[1, 2], [3, 4]])
sage: A.charpoly()
[...]
Unhandled SIGSEGV: A segmentation fault occurred.
```

This problem seems specific to `CyclotomicFields` and does not occur for `QuadraticFields` or even `NumberFields` that are obviously isomorphic to a `CyclotomicField`. There is specialized code in the cyclotomic case, in `sage.matrix.matrix_cyclo_dense.pyx:_charpoly_multimodular`:

```
sage: K = CyclotomicField(5)
sage: A = matrix(K, [[1, 2], [3, 4]])
sage: A._charpoly_multimodular()
[...]
Unhandled SIGSEGV: A segmentation fault occurred.
```



This problem does not occur with Sage 9.6 on Linux, but does manifest in Sage 9.5 on macOS.



See also [https://github.com/3-manifolds/Sage_macOS/issues/43](https://github.com/3-manifolds/Sage_macOS/issues/43).


---

Comment by @DaveWitteMorris created at 2022-07-05 21:06:13

FWIW, I am not getting a crash with 9.7b3 on macOS 11.5.2. The answer `x^2 - 5*x - 2` is returned almost immediately.


---

Comment by culler created at 2022-07-07 03:57:14

Unfortunately, with my x86_64 build of Sage 9.7.beta3 on macOS, which uses no Homebrew or other external libraries, I am seeing the same crash as with 9.6.  And since cysignals prevents generation of a crash log I do not currently know where the crash occurs.


---

Comment by culler created at 2022-07-07 14:16:09

This crash occurs in primecount.  A stack trace is shown below.

Indeed, on both Sage 9.6 and 9.7.beta3 the following command produces a segfault:


```
sage: prime_pi(5)
```


(EDITED) Also, passing a large value to prime_pi does not produce a segfault, as one might guess from the fact that the crash occurs in pi_cache"



```
sage: prime_pi(1000000)
78498
```


According to the "Counting Primes" documentation page:\\
  Dima Pasechnik (2021): removed buggy cython code, replaced it with calls to\\
  primecount/primecountpy spkg

In order to obtain the stack trace below I patched cysignals to make it not catch the SIG_SEGV signal.  While I agree with all of the invective in the cysignals code about how Apple screwed things up by requiring extra permissions to use a debugger, I do not agree with the way cysignals handled this screw-up.  While it is not possible for sage to run gdb to generate a stack trace after a segfualt, if the segfault is processed by Apple's handler, instead of cysignals' no-op handler, at least a crash dump is logged (sometimes).  An unreliable crash dump is a huge improvement over an immediate exit with no information.  So I think cysignals should stop handling SIG_SEGV on macOS.


```
0   libprimecount.7.1.dylib       	0x000000015b841550 primecount::pi_cache(long long, bool) + 0
1   primecount.cpython-310-darwin.so	0x000000015b801ab5 0x15b7fc000 + 23221
2   primecount.cpython-310-darwin.so	0x000000015b801510 0x15b7fc000 + 21776
3   multi_modular.cpython-310-darwin.so	0x000000015b0ad097 0x15b0a4000 + 37015
4   multi_modular.cpython-310-darwin.so	0x000000015b0aee6b 0x15b0a4000 + 44651
5   libpython3.10.dylib           	0x000000010d9f26d4 0x10d950000 + 665300
6   matrix_integer_dense.cpython-310-darwin.so	0x000000015abe3b47 0x15abe0000 + 15175
7   matrix_integer_dense.cpython-310-darwin.so	0x000000015abe5986 0x15abe0000 + 22918
8   matrix_cyclo_dense.cpython-310-darwin.so	0x000000015cf5c4d0 0x15cf34000 + 165072
9   libpython3.10.dylib           	0x000000010d9dce1a 0x10d950000 + 577050
10  matrix_cyclo_dense.cpython-310-darwin.so	0x000000015cf50a62 0x15cf34000 + 117346

```



---

Comment by culler created at 2022-07-07 16:37:46

In `PiTable.cpp` the static table PiTable::pi_t is a


```
/// Compressed PrimePi(x) lookup table for x < 64 * 240.
```


I note that 64*240 = 15360 lies between 15000 and 16000.  So it would appear that any lookup into that table produces a segfault.

I also notice that the signature of py_cache allows passing negative indices into the table.


```
int64_t pi_cache(int64_t x, bool print = is_print());
```


Of course passing a negative value would produce a segfault regardless of the signature.
However I notice that any negative value, even one with large absolute value like -1000000, produces a segfault.  So that suggests that all negative values are used directly as indices into the pi_cache table without checking the sign.  That seems unwise.


---

Comment by culler created at 2022-07-07 17:07:38

There is a question, when prime_pi(x) is called with x <= 0, whether it should raise a `ValueError` or return 0. The answer depends on whether you think that negative prime integers exist. And that depends on whether you think that the integers should be treated differently from other principle ideal domains.  For a definitive answer to that question, see
https://primes.utm.edu/notes/faq/negative_primes.html

My opinion is that it should return 0 and that the docstring should be modified to read:


```
The prime counting function, which counts the number of positive primes less
than or equal to a given value.
```



---

Comment by dimpase created at 2022-07-07 17:30:12

What version of primecount? (it can come from Homebrew or Conda, or built from source)

And what C++/Xcode version?


---

Comment by dimpase created at 2022-07-07 17:32:36

Can you reproduce this with a standalone primecount executable?


---

Comment by dimpase created at 2022-07-07 17:33:42

if so, please do the upstream bug report


---

Comment by mkoeppe created at 2022-07-07 18:17:51

I can't reproduce it either on macOS 12.4 (Intel) with primesieve and primecount from SPKG


---

Comment by mkoeppe created at 2022-07-07 19:01:32

Anyway, here's an update to the most recent primesieve/primecount versions
----
New commits:


---

Comment by culler created at 2022-07-07 19:21:50

Replying to [comment:7 dimpase]:
> What version of primecount? (it can come from Homebrew or Conda, or built from source)

As I said, the build for the Sage_macOS binary distribution is very careful to use NO external libraries whatsoever.  Both primecount and primesieve and everything else, including gfortran, is built from source as provided in the Sage repository.


```
sage % cat build/pkgs/primecount/package-version.txt 
7.1
```



```
sage % cat build/pkgs/primesieve/package-version.txt
7.6
```



> 
> And what C++/Xcode version?



```
% xcodebuild -version 
Xcode 13.2.1
Build version 13C100

```



```
% gcc --version
Configured with: --prefix=/Applications/Xcode.app/Contents/Developer/usr --with-gxx-include-dir=/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/c++/4.2.1
Apple clang version 13.0.0 (clang-1300.0.29.30)
Target: x86_64-apple-darwin20.6.0
Thread model: posix
InstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin

```



---

Comment by culler created at 2022-07-07 19:23:54

Replying to [comment:8 dimpase]:
> Can you reproduce this with a standalone primecount executable? 

No. The standalone version works fine for me.  I used the current latest release, though, which is primecount 7.4 and primesieve 8.0.


---

Comment by culler created at 2022-07-07 19:27:33

Replying to [comment:10 mkoeppe]:
> I can't reproduce it either on macOS 12.4 (Intel) with primesieve and primecount from SPKG

Are you using any Homebrew libraries for your build?


---

Comment by mkoeppe created at 2022-07-07 19:28:37

Replying to [comment:15 culler]:
> Replying to [comment:10 mkoeppe]:
> > I can't reproduce it either on macOS 12.4 (Intel) with primesieve and primecount from SPKG
> 
> Are you using any Homebrew libraries for your build?

Yes, but primecount/primesieve have no dependencies


---

Comment by dunfield created at 2022-07-07 22:13:18

Replying to [comment:16 mkoeppe]:
> > Are you using any Homebrew libraries for your build?
> 
> Yes, but primecount/primesieve have no dependencies 

They do link against `libc++`, so conceivably that could be a homebrew version rather than the system one.  With Marc's build, I see:

```
$ otool -L libprimecount.dylib
libprimecount.dylib:
	@rpath/libprimecount.7.1.dylib (compatibility version 7.0.0, current version 7.1.0)
	@rpath/libprimesieve.9.dylib (compatibility version 9.0.0, current version 9.6.0)
	/usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 1200.3.0)
	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1311.0.0)
```



---

Comment by mkoeppe created at 2022-07-07 22:24:24

Homebrew doesn't secretly switch out the toolchain. The output on my system looks similar (but I seem to have a newer version of Xcode)

```
otool -L local/lib/libprimecount.dylib                                                                                    git:t/34115/tox_yml__refactor_using_reusable_workflows
local/lib/libprimecount.dylib:
	@rpath/libprimecount.7.dylib (compatibility version 7.0.0, current version 7.1.0)
	@rpath/libprimesieve.9.dylib (compatibility version 9.0.0, current version 9.6.0)
	/usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 1300.23.0)
	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1311.100.3)
```



---

Comment by dimpase created at 2022-07-08 08:33:49

Replying to [comment:18 mkoeppe]:
> Homebrew doesn't secretly switch out the toolchain. 
Just in case, it has its own llvm/clang toolchain, which can be used, cf. #32207


---

Comment by dimpase created at 2022-07-08 09:38:46

Changing status from new to needs_review.


---

Comment by dimpase created at 2022-07-08 09:59:44

The branch is good - whether it fixes the issue reported, is not known to me, but I think this should be merged anyway.


---

Comment by dimpase created at 2022-07-08 09:59:44

Changing status from needs_review to positive_review.


---

Comment by culler created at 2022-07-08 10:26:41

Thanks for your help Dima and Matthias.  I have now located the problem and it is a bug in part of the build process for the macOS binary app.  The app has to rewrite load paths in all of the binary files in Sage in order to make them relocatable.  The primecount libraries and executables have an unusual load path setup, which is not recognized by my current rewriting script.  Being unable to load a shared library should not be reported as a segfault, but in this case it is.


---

Comment by mkoeppe created at 2022-07-08 17:53:15

Changing status from positive_review to needs_info.


---

Comment by mkoeppe created at 2022-07-08 17:53:44

I've moved the upgrade to #34132.


---

Comment by dimpase created at 2022-07-08 18:39:06

I understand it's otherwise no problem


---

Comment by dimpase created at 2022-07-08 18:39:06

Changing status from needs_info to positive_review.


---

Comment by slelievre created at 2022-07-14 13:43:27

Resolution: invalid
