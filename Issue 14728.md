# Issue 14728: FloatingPoint exception when multiplying matrix over QQ by vector over SR

Issue created by migration from Trac.

Original creator: dkrenn

Original creation time: 2013-07-24 15:24:27

Keywords: matrix, vector, mutliplication, floatingpoint exception

The input

```
Z=1/3
def matrix_entry(s,r):  
    result = 0
    result += Z^(s-r)
    return result
A = matrix([[matrix_entry(s,r) for r in range(1,22)] for s in range(1,22)])
v = vector([(2/3)^s+x*(2/3+4/9*(2/3)^30)^s for s in range(1,22)])
A*v
```

gives

```
Traceback (click to the left of this block for traceback)
...
RuntimeError: Floating point exception
```

Since the matrix has entries in `QQ` and the vector entries in the symbolic ring, there should not be any floating point operations involved.

The example starts to work if you take smaller matrices or other entries.


---

Comment by jdemeyer created at 2014-06-27 10:39:55

Works for me:

```
sage: Z=1/3
sage: def matrix_entry(s,r):  
....:         result = 0
....:         result += Z^(s-r)
....:         return result
....: 
sage: A = matrix([[matrix_entry(s,r) for r in range(1,22)] for s in range(1,22)])
sage: v = vector([(2/3)^s+x*(2/3+4/9*(2/3)^30)^s for s in range(1,22)])
sage: A*v
[...huge output...]
```



---

Comment by jdemeyer created at 2014-06-27 10:39:55

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2014-06-27 10:40:00

Changing status from needs_review to positive_review.


---

Comment by nbruin created at 2014-06-27 14:56:47

Changing status from positive_review to needs_info.


---

Comment by nbruin created at 2014-06-27 14:56:47

but not for me. The error I get is coming from the following maxima statement, which seems to reliably fail in 5.29.1 and 5.30.0 (shipped with fedora, running on SBCL):

```
(%i1) is (notequal(84644440725961403098463183554485799389772425728699536724546678651368471662755793858191462623325951275455550962101277270763335324980423888503086416881487600951168887632284102290001262851926718316596582705934285641705714110547524777517804311041930987129930496818273454551255885915706318740821679919000000000000000000000*x/422165920314471048721358275854632323285179941428330150821135511815100042994592631347355397175387243022779234708963662480477375868719044084318634583443223137428890926160543699705457864438134730545535596936604372279922247951010042249163649352110753480952771747316504857000652757440826179465253453626540111934123296968384641+2097152/10460353203,0));

Maxima encountered a Lisp error:

 #<a ARITHMETIC-ERROR>

```

On SBCL the error message given is a bit more informative:

```
Maxima encountered a Lisp error:

 Too large to be represented as a DOUBLE-FLOAT:
  40361614573460294293624488618128680891882145752286690103791560483631358939531227997871142684615111959197783928919447551137607252588474220515769203606361198878845638099805880684853202272380217703150073388068335362294060759805452717551138072510686391415562866601120688701274817426541480417643394431591033935546875
```


which is probably correct. It may well be that a very new sage version avoids this code path, but 6.3b1 still has the problem. I'm for now reverting the status of the ticket to a more open one. Once we can confirm the problem is really gone and it's not just Jeroen's magic FPU, we can close this ticket.

Even if sage doesn't trigger this error anymore, it definitely seems an error upstream, so we may want to test and report if this problem hasn't been addressed in maxima's latest release.


---

Comment by jdemeyer created at 2014-06-27 15:01:26

It was probably fixed by the Maxima upgrade: #13973


---

Comment by nbruin created at 2014-06-27 17:59:47

Replying to [comment:4 jdemeyer]:
> It was probably fixed by the Maxima upgrade: #13973
Not for me:

```
Maxima 5.33.0 http://maxima.sourceforge.net
using Lisp ECL 12.12.1
Distributed under the GNU Public License. See the file COPYING.
Dedicated to the memory of William Schelter.
The function bug_report() provides bug reporting information.
(%i1) is (notequal(84644440725961403098463183554485799389772425728699536724546678651368471662755793858191462623325951275455550962101277270763335324980423888503086416881487600951168887632284102290001262851926718316596582705934285641705714110547524777517804311041930987129930496818273454551255885915706318740821679919000000000000000000000*x/422165920314471048721358275854632323285179941428330150821135511815100042994592631347355397175387243022779234708963662480477375868719044084318634583443223137428890926160543699705457864438134730545535596936604372279922247951010042249163649352110753480952771747316504857000652757440826179465253453626540111934123296968384641+2097152/10460353203,0));

Maxima encountered a Lisp error:

 #<a ARITHMETIC-ERROR>
```

I confirm that on 6.3.beta4 I'm not getting the error reported on this ticket, so it seems that sage now avoids this issue. The bug is still there in maxima, though, and it may well be possible to trigger it in a different way from sage.


---

Comment by nbruin created at 2014-06-29 04:21:11

Since there does seem to be an upstream issue here, even though it doesn't seem to affect sage directly:

https://sourceforge.net/p/maxima/bugs/2768/


---

Comment by robert_dodier created at 2014-08-21 20:20:22

Fixed by Maxima commit 1c6327b11 (to appear in Maxima 5.34, due for release in a few weeks).


---

Comment by pbruin created at 2014-09-05 08:20:07

Should be reviewed by someone who can reproduce the problem without #16908 (I can't).


---

Comment by pbruin created at 2014-09-06 10:37:12

> *NOTE:*
> The way to trigger the bug from sage is now:
> {{{
> sage: f=84644440725961403098463183554485799389772425728699536724546678651368471662755793858191462623325951275455550962101277270763335324980423888503086416881487600951168887632284102290001262851926718316596582705934285641705714110547524777517804311041930987129930496818273454551255885915706318740821679919000000000000000000000*x/422165920314471048721358275854632323285179941428330150821135511815100042994592631347355397175387243022779234708963662480477375868719044084318634583443223137428890926160543699705457864438134730545535596936604372279922247951010042249163649352110753480952771747316504857000652757440826179465253453626540111934123296968384641+2097152/10460353203;
> sage: maxima_calculus(f)==0
> FloatingPointError
> }}}
This is an error I can reproduce with 5.33.0 and that seems to be gone in 5.34.0.


---

Comment by jdemeyer created at 2014-09-10 14:41:43

Changing status from needs_info to positive_review.


---

Comment by jdemeyer created at 2014-09-10 14:41:43

Fixed by #16908.


---

Comment by vbraun created at 2014-09-15 14:55:32

Resolution: fixed
