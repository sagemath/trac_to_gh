# Issue 14728: FloatingPoint exception when multiplying matrix over QQ by vector over SR

archive/issues_014728.json:
```json
{
    "body": "Keywords: matrix, vector, mutliplication, floatingpoint exception\n\nThe input\n\n```\nZ=1/3\ndef matrix_entry(s,r):  \n    result = 0\n    result += Z^(s-r)\n    return result\nA = matrix([[matrix_entry(s,r) for r in range(1,22)] for s in range(1,22)])\nv = vector([(2/3)^s+x*(2/3+4/9*(2/3)^30)^s for s in range(1,22)])\nA*v\n```\n\ngives\n\n```\nTraceback (click to the left of this block for traceback)\n...\nRuntimeError: Floating point exception\n```\n\nSince the matrix has entries in `QQ` and the vector entries in the symbolic ring, there should not be any floating point operations involved.\n\nThe example starts to work if you take smaller matrices or other entries.\n\nIssue created by migration from https://trac.sagemath.org/ticket/14965\n\n",
    "created_at": "2013-07-24T15:24:27Z",
    "labels": [
        "linear algebra",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "FloatingPoint exception when multiplying matrix over QQ by vector over SR",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14728",
    "user": "dkrenn"
}
```
Keywords: matrix, vector, mutliplication, floatingpoint exception

The input

```
Z=1/3
def matrix_entry(s,r):  
    result = 0
    result += Z^(s-r)
    return result
A = matrix([[matrix_entry(s,r) for r in range(1,22)] for s in range(1,22)])
v = vector([(2/3)^s+x*(2/3+4/9*(2/3)^30)^s for s in range(1,22)])
A*v
```

gives

```
Traceback (click to the left of this block for traceback)
...
RuntimeError: Floating point exception
```

Since the matrix has entries in `QQ` and the vector entries in the symbolic ring, there should not be any floating point operations involved.

The example starts to work if you take smaller matrices or other entries.

Issue created by migration from https://trac.sagemath.org/ticket/14965





---

archive/issue_comments_187721.json:
```json
{
    "body": "Works for me:\n\n```\nsage: Z=1/3\nsage: def matrix_entry(s,r):  \n....:         result = 0\n....:         result += Z^(s-r)\n....:         return result\n....: \nsage: A = matrix([[matrix_entry(s,r) for r in range(1,22)] for s in range(1,22)])\nsage: v = vector([(2/3)^s+x*(2/3+4/9*(2/3)^30)^s for s in range(1,22)])\nsage: A*v\n[...huge output...]\n```\n",
    "created_at": "2014-06-27T10:39:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14728#issuecomment-187721",
    "user": "jdemeyer"
}
```

Works for me:

```
sage: Z=1/3
sage: def matrix_entry(s,r):  
....:         result = 0
....:         result += Z^(s-r)
....:         return result
....: 
sage: A = matrix([[matrix_entry(s,r) for r in range(1,22)] for s in range(1,22)])
sage: v = vector([(2/3)^s+x*(2/3+4/9*(2/3)^30)^s for s in range(1,22)])
sage: A*v
[...huge output...]
```




---

archive/issue_comments_187722.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-06-27T10:39:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14728#issuecomment-187722",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_187723.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-06-27T10:40:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14728#issuecomment-187723",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_187724.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2014-06-27T14:56:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14728#issuecomment-187724",
    "user": "nbruin"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_187725.json:
```json
{
    "body": "but not for me. The error I get is coming from the following maxima statement, which seems to reliably fail in 5.29.1 and 5.30.0 (shipped with fedora, running on SBCL):\n\n```\n(%i1) is (notequal(84644440725961403098463183554485799389772425728699536724546678651368471662755793858191462623325951275455550962101277270763335324980423888503086416881487600951168887632284102290001262851926718316596582705934285641705714110547524777517804311041930987129930496818273454551255885915706318740821679919000000000000000000000*x/422165920314471048721358275854632323285179941428330150821135511815100042994592631347355397175387243022779234708963662480477375868719044084318634583443223137428890926160543699705457864438134730545535596936604372279922247951010042249163649352110753480952771747316504857000652757440826179465253453626540111934123296968384641+2097152/10460353203,0));\n\nMaxima encountered a Lisp error:\n\n #<a ARITHMETIC-ERROR>\n\n```\n\nOn SBCL the error message given is a bit more informative:\n\n```\nMaxima encountered a Lisp error:\n\n Too large to be represented as a DOUBLE-FLOAT:\n  40361614573460294293624488618128680891882145752286690103791560483631358939531227997871142684615111959197783928919447551137607252588474220515769203606361198878845638099805880684853202272380217703150073388068335362294060759805452717551138072510686391415562866601120688701274817426541480417643394431591033935546875\n```\n\n\nwhich is probably correct. It may well be that a very new sage version avoids this code path, but 6.3b1 still has the problem. I'm for now reverting the status of the ticket to a more open one. Once we can confirm the problem is really gone and it's not just Jeroen's magic FPU, we can close this ticket.\n\nEven if sage doesn't trigger this error anymore, it definitely seems an error upstream, so we may want to test and report if this problem hasn't been addressed in maxima's latest release.",
    "created_at": "2014-06-27T14:56:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14728#issuecomment-187725",
    "user": "nbruin"
}
```

but not for me. The error I get is coming from the following maxima statement, which seems to reliably fail in 5.29.1 and 5.30.0 (shipped with fedora, running on SBCL):

```
(%i1) is (notequal(84644440725961403098463183554485799389772425728699536724546678651368471662755793858191462623325951275455550962101277270763335324980423888503086416881487600951168887632284102290001262851926718316596582705934285641705714110547524777517804311041930987129930496818273454551255885915706318740821679919000000000000000000000*x/422165920314471048721358275854632323285179941428330150821135511815100042994592631347355397175387243022779234708963662480477375868719044084318634583443223137428890926160543699705457864438134730545535596936604372279922247951010042249163649352110753480952771747316504857000652757440826179465253453626540111934123296968384641+2097152/10460353203,0));

Maxima encountered a Lisp error:

 #<a ARITHMETIC-ERROR>

```

On SBCL the error message given is a bit more informative:

```
Maxima encountered a Lisp error:

 Too large to be represented as a DOUBLE-FLOAT:
  40361614573460294293624488618128680891882145752286690103791560483631358939531227997871142684615111959197783928919447551137607252588474220515769203606361198878845638099805880684853202272380217703150073388068335362294060759805452717551138072510686391415562866601120688701274817426541480417643394431591033935546875
```


which is probably correct. It may well be that a very new sage version avoids this code path, but 6.3b1 still has the problem. I'm for now reverting the status of the ticket to a more open one. Once we can confirm the problem is really gone and it's not just Jeroen's magic FPU, we can close this ticket.

Even if sage doesn't trigger this error anymore, it definitely seems an error upstream, so we may want to test and report if this problem hasn't been addressed in maxima's latest release.



---

archive/issue_comments_187726.json:
```json
{
    "body": "It was probably fixed by the Maxima upgrade: #13973",
    "created_at": "2014-06-27T15:01:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14728#issuecomment-187726",
    "user": "jdemeyer"
}
```

It was probably fixed by the Maxima upgrade: #13973



---

archive/issue_comments_187727.json:
```json
{
    "body": "Replying to [comment:4 jdemeyer]:\n> It was probably fixed by the Maxima upgrade: #13973\nNot for me:\n\n```\nMaxima 5.33.0 http://maxima.sourceforge.net\nusing Lisp ECL 12.12.1\nDistributed under the GNU Public License. See the file COPYING.\nDedicated to the memory of William Schelter.\nThe function bug_report() provides bug reporting information.\n(%i1) is (notequal(84644440725961403098463183554485799389772425728699536724546678651368471662755793858191462623325951275455550962101277270763335324980423888503086416881487600951168887632284102290001262851926718316596582705934285641705714110547524777517804311041930987129930496818273454551255885915706318740821679919000000000000000000000*x/422165920314471048721358275854632323285179941428330150821135511815100042994592631347355397175387243022779234708963662480477375868719044084318634583443223137428890926160543699705457864438134730545535596936604372279922247951010042249163649352110753480952771747316504857000652757440826179465253453626540111934123296968384641+2097152/10460353203,0));\n\nMaxima encountered a Lisp error:\n\n #<a ARITHMETIC-ERROR>\n```\n\nI confirm that on 6.3.beta4 I'm not getting the error reported on this ticket, so it seems that sage now avoids this issue. The bug is still there in maxima, though, and it may well be possible to trigger it in a different way from sage.",
    "created_at": "2014-06-27T17:59:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14728#issuecomment-187727",
    "user": "nbruin"
}
```

Replying to [comment:4 jdemeyer]:
> It was probably fixed by the Maxima upgrade: #13973
Not for me:

```
Maxima 5.33.0 http://maxima.sourceforge.net
using Lisp ECL 12.12.1
Distributed under the GNU Public License. See the file COPYING.
Dedicated to the memory of William Schelter.
The function bug_report() provides bug reporting information.
(%i1) is (notequal(84644440725961403098463183554485799389772425728699536724546678651368471662755793858191462623325951275455550962101277270763335324980423888503086416881487600951168887632284102290001262851926718316596582705934285641705714110547524777517804311041930987129930496818273454551255885915706318740821679919000000000000000000000*x/422165920314471048721358275854632323285179941428330150821135511815100042994592631347355397175387243022779234708963662480477375868719044084318634583443223137428890926160543699705457864438134730545535596936604372279922247951010042249163649352110753480952771747316504857000652757440826179465253453626540111934123296968384641+2097152/10460353203,0));

Maxima encountered a Lisp error:

 #<a ARITHMETIC-ERROR>
```

I confirm that on 6.3.beta4 I'm not getting the error reported on this ticket, so it seems that sage now avoids this issue. The bug is still there in maxima, though, and it may well be possible to trigger it in a different way from sage.



---

archive/issue_comments_187728.json:
```json
{
    "body": "Since there does seem to be an upstream issue here, even though it doesn't seem to affect sage directly:\n\nhttps://sourceforge.net/p/maxima/bugs/2768/",
    "created_at": "2014-06-29T04:21:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14728#issuecomment-187728",
    "user": "nbruin"
}
```

Since there does seem to be an upstream issue here, even though it doesn't seem to affect sage directly:

https://sourceforge.net/p/maxima/bugs/2768/



---

archive/issue_comments_187729.json:
```json
{
    "body": "Fixed by Maxima commit 1c6327b11 (to appear in Maxima 5.34, due for release in a few weeks).",
    "created_at": "2014-08-21T20:20:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14728#issuecomment-187729",
    "user": "robert_dodier"
}
```

Fixed by Maxima commit 1c6327b11 (to appear in Maxima 5.34, due for release in a few weeks).



---

archive/issue_comments_187730.json:
```json
{
    "body": "Should be reviewed by someone who can reproduce the problem without #16908 (I can't).",
    "created_at": "2014-09-05T08:20:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14728#issuecomment-187730",
    "user": "pbruin"
}
```

Should be reviewed by someone who can reproduce the problem without #16908 (I can't).



---

archive/issue_comments_187731.json:
```json
{
    "body": "> **NOTE:**\n> The way to trigger the bug from sage is now:\n> {{{\n> sage: f=84644440725961403098463183554485799389772425728699536724546678651368471662755793858191462623325951275455550962101277270763335324980423888503086416881487600951168887632284102290001262851926718316596582705934285641705714110547524777517804311041930987129930496818273454551255885915706318740821679919000000000000000000000*x/422165920314471048721358275854632323285179941428330150821135511815100042994592631347355397175387243022779234708963662480477375868719044084318634583443223137428890926160543699705457864438134730545535596936604372279922247951010042249163649352110753480952771747316504857000652757440826179465253453626540111934123296968384641+2097152/10460353203;\n> sage: maxima_calculus(f)==0\n> FloatingPointError\n> }}}\nThis is an error I can reproduce with 5.33.0 and that seems to be gone in 5.34.0.",
    "created_at": "2014-09-06T10:37:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14728#issuecomment-187731",
    "user": "pbruin"
}
```

> **NOTE:**
> The way to trigger the bug from sage is now:
> {{{
> sage: f=84644440725961403098463183554485799389772425728699536724546678651368471662755793858191462623325951275455550962101277270763335324980423888503086416881487600951168887632284102290001262851926718316596582705934285641705714110547524777517804311041930987129930496818273454551255885915706318740821679919000000000000000000000*x/422165920314471048721358275854632323285179941428330150821135511815100042994592631347355397175387243022779234708963662480477375868719044084318634583443223137428890926160543699705457864438134730545535596936604372279922247951010042249163649352110753480952771747316504857000652757440826179465253453626540111934123296968384641+2097152/10460353203;
> sage: maxima_calculus(f)==0
> FloatingPointError
> }}}
This is an error I can reproduce with 5.33.0 and that seems to be gone in 5.34.0.



---

archive/issue_comments_187732.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2014-09-10T14:41:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14728#issuecomment-187732",
    "user": "jdemeyer"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_comments_187733.json:
```json
{
    "body": "Fixed by #16908.",
    "created_at": "2014-09-10T14:41:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14728#issuecomment-187733",
    "user": "jdemeyer"
}
```

Fixed by #16908.



---

archive/issue_comments_187734.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-09-15T14:55:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14728",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14728#issuecomment-187734",
    "user": "vbraun"
}
```

Resolution: fixed
