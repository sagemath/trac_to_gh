# Issue 32242: Remove monkey patching of inspect.isfunction in sage.__init__

archive/issues_032242.json:
```json
{
    "body": "CC:  chapoton klee jhpalmieri mjo\n\n\"Monkey-patch `inspect.isfunction()` to support Cython functions.\" \n\nIntroduced in 2018 (8.3.beta2) in #25373 (for #24994).\n\nHowever, this change has been rejected by upstream (https://bugs.python.org/issue30071, https://www.python.org/dev/peps/pep-0575/, https://www.python.org/dev/peps/pep-0579/, https://www.python.org/dev/peps/pep-0580/), so we should remove the monkey-patching and find a better solution.\n\n(To be checked whether https://www.python.org/dev/peps/pep-0590, superseding some of the above rejected PEPs, offers help.)\n\nIssue created by migration from https://trac.sagemath.org/ticket/32479\n\n",
    "created_at": "2021-09-05T23:53:29Z",
    "labels": [
        "refactoring",
        "major",
        "enhancement"
    ],
    "title": "Remove monkey patching of inspect.isfunction in sage.__init__",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32242",
    "user": "mkoeppe"
}
```
CC:  chapoton klee jhpalmieri mjo

"Monkey-patch `inspect.isfunction()` to support Cython functions." 

Introduced in 2018 (8.3.beta2) in #25373 (for #24994).

However, this change has been rejected by upstream (https://bugs.python.org/issue30071, https://www.python.org/dev/peps/pep-0575/, https://www.python.org/dev/peps/pep-0579/, https://www.python.org/dev/peps/pep-0580/), so we should remove the monkey-patching and find a better solution.

(To be checked whether https://www.python.org/dev/peps/pep-0590, superseding some of the above rejected PEPs, offers help.)

Issue created by migration from https://trac.sagemath.org/ticket/32479





---

archive/issue_comments_460415.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-06T00:22:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460415",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_460416.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-06T00:28:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460416",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_460417.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-06T01:00:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460417",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_460418.json:
```json
{
    "body": "Setting to \"needs review\" so that the patchbot runs",
    "created_at": "2021-09-06T01:19:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460418",
    "user": "mkoeppe"
}
```

Setting to "needs review" so that the patchbot runs



---

archive/issue_comments_460419.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-09-06T01:19:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460419",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_460420.json:
```json
{
    "body": "\n```\nsage -t --long --random-seed=0 src/sage/misc/sagedoc.py  # 8 doctests failed\nsage -t --long --random-seed=0 src/sage/misc/rest_index_of_methods.py  # 1 doctest failed\nsage -t --long --random-seed=0 src/sage/docs/conf.py  # 1 doctest failed\n```\n",
    "created_at": "2021-09-07T04:35:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460420",
    "user": "mkoeppe"
}
```


```
sage -t --long --random-seed=0 src/sage/misc/sagedoc.py  # 8 doctests failed
sage -t --long --random-seed=0 src/sage/misc/rest_index_of_methods.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/docs/conf.py  # 1 doctest failed
```




---

archive/issue_comments_460421.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-09-07T04:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460421",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_460422.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-07T05:34:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460422",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_460423.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-07T05:41:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460423",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_460424.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-09-07T05:42:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460424",
    "user": "mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_460425.json:
```json
{
    "body": "There are a few uses of `inspect.isfunction` in `sage_docbuild`. I don't know if these should be replaced by `sage.misc.sageinspect.is_function_or_cython_function`\n\n```\nsrc/sage_docbuild/ext/sage_autodoc.py:        return (inspect.isfunction(member) or inspect.isbuiltin(member)\nsrc/sage_docbuild/ext/sage_autodoc.py:                not(inspect.ismethod(initmeth) or inspect.isfunction(initmeth)):\nsrc/sage_docbuild/ext/sage_autodoc.py:        return inspect.isfunction(obj) or inspect.isbuiltin(obj) or inspect.ismethod(obj)\n```\n",
    "created_at": "2021-09-07T05:44:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460425",
    "user": "mkoeppe"
}
```

There are a few uses of `inspect.isfunction` in `sage_docbuild`. I don't know if these should be replaced by `sage.misc.sageinspect.is_function_or_cython_function`

```
src/sage_docbuild/ext/sage_autodoc.py:        return (inspect.isfunction(member) or inspect.isbuiltin(member)
src/sage_docbuild/ext/sage_autodoc.py:                not(inspect.ismethod(initmeth) or inspect.isfunction(initmeth)):
src/sage_docbuild/ext/sage_autodoc.py:        return inspect.isfunction(obj) or inspect.isbuiltin(obj) or inspect.ismethod(obj)
```




---

archive/issue_comments_460426.json:
```json
{
    "body": "I would also like to get rid of these uses of `inspect.isfunction` in plotting code.\n\n```\nsrc/sage/plot/plot3d/plot3d.py:    if inspect.isfunction(func):\nsrc/sage/plot/plot_field.py:    if isfunction(f):\nsrc/sage/plot/streamline_plot.py:        if isfunction(f_g):\n```\n\nHelp on this would be welcome",
    "created_at": "2021-09-07T05:58:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460426",
    "user": "mkoeppe"
}
```

I would also like to get rid of these uses of `inspect.isfunction` in plotting code.

```
src/sage/plot/plot3d/plot3d.py:    if inspect.isfunction(func):
src/sage/plot/plot_field.py:    if isfunction(f):
src/sage/plot/streamline_plot.py:        if isfunction(f_g):
```

Help on this would be welcome



---

archive/issue_comments_460427.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-09T00:00:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460427",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_460428.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-09T00:19:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460428",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_460429.json:
```json
{
    "body": "Well, comment:14, comment:15 are refinements that can be done in follow-up tickets.\n\nReady for review",
    "created_at": "2021-09-09T00:19:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460429",
    "user": "mkoeppe"
}
```

Well, comment:14, comment:15 are refinements that can be done in follow-up tickets.

Ready for review



---

archive/issue_comments_460430.json:
```json
{
    "body": "What's an example of a cython function that isn't `callable()`?",
    "created_at": "2021-09-09T00:34:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460430",
    "user": "mjo"
}
```

What's an example of a cython function that isn't `callable()`?



---

archive/issue_comments_460431.json:
```json
{
    "body": "Replying to [comment:20 mjo]:\n> What's an example of a cython function that isn't `callable()`?\n\nIn other words, what goes wrong if you change the plot/sagedoc code to use `callable()` too? The only difference I see is that methods are `callable()` but the new `is_function_or_cython_function()` will return `False` on them. I don't see a moral problem with plotting a class method, though. And the sagedoc code is also checking for methods.",
    "created_at": "2021-09-09T00:47:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460431",
    "user": "mjo"
}
```

Replying to [comment:20 mjo]:
> What's an example of a cython function that isn't `callable()`?

In other words, what goes wrong if you change the plot/sagedoc code to use `callable()` too? The only difference I see is that methods are `callable()` but the new `is_function_or_cython_function()` will return `False` on them. I don't see a moral problem with plotting a class method, though. And the sagedoc code is also checking for methods.



---

archive/issue_comments_460432.json:
```json
{
    "body": "Note that \n\n```\nsage: type(x)                                                                                                                                                 \n<class 'sage.symbolic.expression.Expression'>\nsage: callable(x)                                                                                                                                             \nTrue\nsage: import inspect                                                                                                                                          \nsage: inspect.isfunction(x)                                                                                                                                   \nFalse\nsage: from sage.misc.sageinspect import is_function_or_cython_function                                                                                        \nsage: is_function_or_cython_function(x)                                                                                                                       \nFalse\n```\n\n... so `callable` would not be the right replacement for the uses in `sage.plot`.\n\nRegarding `sagedoc` I really don't have an idea about the code (in particular I look at the formatted documentation too rarely to be sure that changes don't break anything). Hence this safe replacement.",
    "created_at": "2021-09-09T01:06:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460432",
    "user": "mkoeppe"
}
```

Note that 

```
sage: type(x)                                                                                                                                                 
<class 'sage.symbolic.expression.Expression'>
sage: callable(x)                                                                                                                                             
True
sage: import inspect                                                                                                                                          
sage: inspect.isfunction(x)                                                                                                                                   
False
sage: from sage.misc.sageinspect import is_function_or_cython_function                                                                                        
sage: is_function_or_cython_function(x)                                                                                                                       
False
```

... so `callable` would not be the right replacement for the uses in `sage.plot`.

Regarding `sagedoc` I really don't have an idea about the code (in particular I look at the formatted documentation too rarely to be sure that changes don't break anything). Hence this safe replacement.



---

archive/issue_comments_460433.json:
```json
{
    "body": "(All Cython functions are `callable` but not all objects that are `callable` satisfy `is_function_or_cython_function`.)",
    "created_at": "2021-09-09T01:07:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460433",
    "user": "mkoeppe"
}
```

(All Cython functions are `callable` but not all objects that are `callable` satisfy `is_function_or_cython_function`.)



---

archive/issue_comments_460434.json:
```json
{
    "body": "Ok, let's just merge the easy part then (I don't really want to look at plots either).\n\nThis bit in `integration.pyx` would be cleaner/faster with `hasattr()` I think:\n\n\n```python\ntry:\n    vars = func.arguments()\nexcept AttributeError:\n    try:\n        vars = func.variables()\n    except AttributeError:\n        vars = sage_getargspec(func)[0]\n```\n\n\nMismatched parentheses in docstring:\n\n\n```python\n\"\"\"\nThink twice before using this function (or any function from the\n``inspect`` or ``sage.misc.sageinspect`` modules.  Most uses of\n``isfunction`` in ordinary library code can be replaced by ``callable``.\n\"\"\"\n```\n\n\nYou could also use Sphinx cross-module references there. Finally,\n\n\n```python\n\"\"\"\nVerify that ipywidgets can correctly determine signatures of Cython\nfunctions::\n\n    sage: from ipywidgets.widgets.interaction import signature\n    sage: from sage.dynamics.complex_dynamics.mandel_julia_helper import fast_mandelbrot_plot\n    sage: signature(fast_mandelbrot_plot)  # random\n    <IPython.utils._signatures.Signature object at 0x7f3ec8274e10>\n\"\"\"\n```\n\n\nI think that should go under a new `TESTS::` block, since it's verifying some internal detail that a user reading the reference manual won't care about.",
    "created_at": "2021-09-09T11:41:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460434",
    "user": "mjo"
}
```

Ok, let's just merge the easy part then (I don't really want to look at plots either).

This bit in `integration.pyx` would be cleaner/faster with `hasattr()` I think:


```python
try:
    vars = func.arguments()
except AttributeError:
    try:
        vars = func.variables()
    except AttributeError:
        vars = sage_getargspec(func)[0]
```


Mismatched parentheses in docstring:


```python
"""
Think twice before using this function (or any function from the
``inspect`` or ``sage.misc.sageinspect`` modules.  Most uses of
``isfunction`` in ordinary library code can be replaced by ``callable``.
"""
```


You could also use Sphinx cross-module references there. Finally,


```python
"""
Verify that ipywidgets can correctly determine signatures of Cython
functions::

    sage: from ipywidgets.widgets.interaction import signature
    sage: from sage.dynamics.complex_dynamics.mandel_julia_helper import fast_mandelbrot_plot
    sage: signature(fast_mandelbrot_plot)  # random
    <IPython.utils._signatures.Signature object at 0x7f3ec8274e10>
"""
```


I think that should go under a new `TESTS::` block, since it's verifying some internal detail that a user reading the reference manual won't care about.



---

archive/issue_comments_460435.json:
```json
{
    "body": "Replying to [comment:24 mjo]:\n> Ok, let's just merge the easy part then (I don't really want to look at plots either).\n> \n> This bit in `integration.pyx` would be cleaner/faster with `hasattr()`\n\nI haven't timed this particular one in Cython but at least in plain Python `try: except:` is faster than doing the attribute access a second time.",
    "created_at": "2021-09-09T15:14:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460435",
    "user": "mkoeppe"
}
```

Replying to [comment:24 mjo]:
> Ok, let's just merge the easy part then (I don't really want to look at plots either).
> 
> This bit in `integration.pyx` would be cleaner/faster with `hasattr()`

I haven't timed this particular one in Cython but at least in plain Python `try: except:` is faster than doing the attribute access a second time.



---

archive/issue_comments_460436.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-09T16:17:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460436",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_460437.json:
```json
{
    "body": "Ok then.",
    "created_at": "2021-09-09T16:25:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460437",
    "user": "mjo"
}
```

Ok then.



---

archive/issue_comments_460438.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-09T16:25:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460438",
    "user": "mjo"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_460439.json:
```json
{
    "body": "Thanks for reviewing!",
    "created_at": "2021-09-09T16:28:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460439",
    "user": "mkoeppe"
}
```

Thanks for reviewing!



---

archive/issue_comments_460440.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2021-09-09T16:30:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460440",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_460441.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2021-09-09T16:30:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460441",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_460442.json:
```json
{
    "body": "Merged #31420 to remove the trivial merge conflict in `src/sage/__init__.py`.",
    "created_at": "2021-09-09T16:31:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460442",
    "user": "mkoeppe"
}
```

Merged #31420 to remove the trivial merge conflict in `src/sage/__init__.py`.



---

archive/issue_comments_460443.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-09T16:31:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460443",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_460444.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-09-19T09:58:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32242#issuecomment-460444",
    "user": "vbraun"
}
```

Resolution: fixed
