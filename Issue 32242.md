# Issue 32242: Remove monkey patching of inspect.isfunction in sage.__init__

Issue created by migration from https://trac.sagemath.org/ticket/32479

Original creator: mkoeppe

Original creation time: 2021-09-05 23:53:29

CC:  chapoton klee jhpalmieri mjo

"Monkey-patch `inspect.isfunction()` to support Cython functions." 

Introduced in 2018 (8.3.beta2) in #25373 (for #24994).

However, this change has been rejected by upstream (https://bugs.python.org/issue30071, https://www.python.org/dev/peps/pep-0575/, https://www.python.org/dev/peps/pep-0579/, https://www.python.org/dev/peps/pep-0580/), so we should remove the monkey-patching and find a better solution.

(To be checked whether https://www.python.org/dev/peps/pep-0590, superseding some of the above rejected PEPs, offers help.)


---

Comment by git created at 2021-09-06 00:22:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-06 00:28:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-06 01:00:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-06 01:19:17

Setting to "needs review" so that the patchbot runs


---

Comment by mkoeppe created at 2021-09-06 01:19:17

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-09-07 04:35:43


```
sage -t --long --random-seed=0 src/sage/misc/sagedoc.py  # 8 doctests failed
sage -t --long --random-seed=0 src/sage/misc/rest_index_of_methods.py  # 1 doctest failed
sage -t --long --random-seed=0 src/sage/docs/conf.py  # 1 doctest failed
```



---

Comment by mkoeppe created at 2021-09-07 04:36:03

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-09-07 05:34:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-07 05:41:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-07 05:42:14

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-09-07 05:44:26

There are a few uses of `inspect.isfunction` in `sage_docbuild`. I don't know if these should be replaced by `sage.misc.sageinspect.is_function_or_cython_function`

```
src/sage_docbuild/ext/sage_autodoc.py:        return (inspect.isfunction(member) or inspect.isbuiltin(member)
src/sage_docbuild/ext/sage_autodoc.py:                not(inspect.ismethod(initmeth) or inspect.isfunction(initmeth)):
src/sage_docbuild/ext/sage_autodoc.py:        return inspect.isfunction(obj) or inspect.isbuiltin(obj) or inspect.ismethod(obj)
```



---

Comment by mkoeppe created at 2021-09-07 05:58:37

I would also like to get rid of these uses of `inspect.isfunction` in plotting code.

```
src/sage/plot/plot3d/plot3d.py:    if inspect.isfunction(func):
src/sage/plot/plot_field.py:    if isfunction(f):
src/sage/plot/streamline_plot.py:        if isfunction(f_g):
```

Help on this would be welcome


---

Comment by git created at 2021-09-09 00:00:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-09 00:19:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-09 00:19:59

Well, comment:14, comment:15 are refinements that can be done in follow-up tickets.

Ready for review


---

Comment by mjo created at 2021-09-09 00:34:43

What's an example of a cython function that isn't `callable()`?


---

Comment by mjo created at 2021-09-09 00:47:33

Replying to [comment:20 mjo]:
> What's an example of a cython function that isn't `callable()`?

In other words, what goes wrong if you change the plot/sagedoc code to use `callable()` too? The only difference I see is that methods are `callable()` but the new `is_function_or_cython_function()` will return `False` on them. I don't see a moral problem with plotting a class method, though. And the sagedoc code is also checking for methods.


---

Comment by mkoeppe created at 2021-09-09 01:06:11

Note that 

```
sage: type(x)                                                                                                                                                 
<class 'sage.symbolic.expression.Expression'>
sage: callable(x)                                                                                                                                             
True
sage: import inspect                                                                                                                                          
sage: inspect.isfunction(x)                                                                                                                                   
False
sage: from sage.misc.sageinspect import is_function_or_cython_function                                                                                        
sage: is_function_or_cython_function(x)                                                                                                                       
False
```

... so `callable` would not be the right replacement for the uses in `sage.plot`.

Regarding `sagedoc` I really don't have an idea about the code (in particular I look at the formatted documentation too rarely to be sure that changes don't break anything). Hence this safe replacement.


---

Comment by mkoeppe created at 2021-09-09 01:07:44

(All Cython functions are `callable` but not all objects that are `callable` satisfy `is_function_or_cython_function`.)


---

Comment by mjo created at 2021-09-09 11:41:34

Ok, let's just merge the easy part then (I don't really want to look at plots either).

This bit in `integration.pyx` would be cleaner/faster with `hasattr()` I think:


```python
try:
    vars = func.arguments()
except AttributeError:
    try:
        vars = func.variables()
    except AttributeError:
        vars = sage_getargspec(func)[0]
```


Mismatched parentheses in docstring:


```python
"""
Think twice before using this function (or any function from the
``inspect`` or ``sage.misc.sageinspect`` modules.  Most uses of
``isfunction`` in ordinary library code can be replaced by ``callable``.
"""
```


You could also use Sphinx cross-module references there. Finally,


```python
"""
Verify that ipywidgets can correctly determine signatures of Cython
functions::

    sage: from ipywidgets.widgets.interaction import signature
    sage: from sage.dynamics.complex_dynamics.mandel_julia_helper import fast_mandelbrot_plot
    sage: signature(fast_mandelbrot_plot)  # random
    <IPython.utils._signatures.Signature object at 0x7f3ec8274e10>
"""
```


I think that should go under a new `TESTS::` block, since it's verifying some internal detail that a user reading the reference manual won't care about.


---

Comment by mkoeppe created at 2021-09-09 15:14:42

Replying to [comment:24 mjo]:
> Ok, let's just merge the easy part then (I don't really want to look at plots either).
> 
> This bit in `integration.pyx` would be cleaner/faster with `hasattr()`

I haven't timed this particular one in Cython but at least in plain Python `try: except:` is faster than doing the attribute access a second time.


---

Comment by git created at 2021-09-09 16:17:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2021-09-09 16:25:32

Ok then.


---

Comment by mjo created at 2021-09-09 16:25:32

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-09-09 16:28:24

Thanks for reviewing!


---

Comment by git created at 2021-09-09 16:30:26

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2021-09-09 16:30:26

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2021-09-09 16:31:01

Merged #31420 to remove the trivial merge conflict in `src/sage/__init__.py`.


---

Comment by mkoeppe created at 2021-09-09 16:31:01

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-09-19 09:58:23

Resolution: fixed
