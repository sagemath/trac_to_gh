# Issue 17276: Allow Sage to build and run on old Macs on last time

Issue created by migration from https://trac.sagemath.org/ticket/17513

Original creator: kcrisman

Original creation time: 2014-12-16 02:12:19

Modulo gcc 4.9, of course, though in principle one could ask for a message asking to build gcc 4.7 first.

We need the following
* This is not supported by at least some shells.

```
if [[ "$1" =~ "--notebook="* || "$1" =~ "-n="* || "$1" =~ "-notebook="* ]]; then
    sage-cleaner &>/dev/null &
    exec sage-notebook "$@"
fi
```

  including

```
$ bash --version
GNU bash, version 2.05b.0(1)-release (powerpc-apple-darwin8.0)
Copyright (C) 2002 Free Software Foundation, Inc.
```

* Need to put back in the pyzmq patch to avoid `-arch` flag on our gcc, at least for very old indeed Mac - #17510.
* iml upgrade seems to have removed something for this system. We can add something along the lines of

```
EXTRA_BLAS=""
if [ $UNAME = "Darwin" ]; then
    # copy cblas headers from gsl
    cp ../patches/gsl_cblas.h cblas.h
    EXTRA_BLAS="--with-cblas=-lgslcblas"
fi
```

  to fix this.
* Do something about #16044, even if it is to tacitly let it build on this platform without having to do `make -k`.


---

Comment by kcrisman created at 2015-01-05 17:27:58

Not formal patch for iml, but at least for very old Darwin

```diff
 EXTRA_BLAS=""
 if [ $UNAME = "Darwin" ]; then
     # copy cblas headers from gsl
     cp ../patches/gsl_cblas.h cblas.h
-    EXTRA_BLAS="--with-cblas=-lcblas"
+    EXTRA_BLAS="--with-cblas=-lgslcblas"
 fi
```



---

Comment by kcrisman created at 2015-01-06 14:40:11

Fix from [sage-devel](https://groups.google.com/forum/#!topic/sage-devel/veJDjWespUc):


```
if [ "${1:0:11}" = "--notebook=" ] || [ "${1:0:10}" = "-notebook=" ] || [ "${1:0:3}" = "-n=" ]; then
```



---

Comment by kcrisman created at 2015-01-06 16:56:11

For reference

```diff
diff --git a/src/bin/sage b/src/bin/sage
index ca07760..a5d2dae 100755
--- a/src/bin/sage
+++ b/src/bin/sage
@@ -641,7 +641,7 @@ build_sage() {
     sage-build "$@" || exit $?
 }
 
-if [[ "$1" =~ "--notebook="* || "$1" =~ "-n="* || "$1" =~ "-notebook="* ]]; then
+if [ "${1:0:11}" = "--notebook=" ] || [ "${1:0:10}" = "-notebook=" ] || [ "${1:0:3}" = "-n=" ]; then
     sage-cleaner &>/dev/null &
     exec sage-notebook "$@"
 fi
```



---

Comment by kcrisman created at 2015-01-06 16:57:53

And

```diff
diff --git a/build/pkgs/iml/spkg-install b/build/pkgs/iml/spkg-install
index 7940695..1241f3e 100755
--- a/build/pkgs/iml/spkg-install
+++ b/build/pkgs/iml/spkg-install
@@ -35,7 +35,7 @@ EXTRA_BLAS=""
 if [ $UNAME = "Darwin" ]; then
     # copy cblas headers from gsl
     cp ../patches/gsl_cblas.h cblas.h
-    EXTRA_BLAS="--with-cblas=-lcblas"
+    EXTRA_BLAS="--with-cblas=-lgslcblas"
 fi
 
 ./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" \
```



---

Comment by jpflori created at 2015-01-13 18:12:04

For old Darwin isn't `IML_CONFIGURE="--with-cblas=-lcblas -latlas` ok?
(Copying the header should not be necessary.)


---

Comment by kcrisman created at 2015-01-13 18:52:04

Probably, I was just going for minimal changes to current files for my own ease.   It is very, very slow to try this for me because I have to have access to the machines _and_ nothing better to do _and_ then it takes a while to do it because they are old.


---

Comment by jpflori created at 2015-01-14 16:03:06

Oh, maybe `-lblas` is needed.
See 

```
if conf['PPC?']:   # OSX 10.4 PPC linker needs help to find the accelerate blas
        veclib_dir = '/System/Library/Frameworks/Accelerate.framework/' + \
            'Versions/A/Frameworks/vecLib.framework/Versions/A'
        for lib in [ 'libBLAS.dylib', 'libLAPACK.dylib']:
            ln(os.path.join(veclib_dir, lib),
               os.path.join(conf['SAGE_LOCAL'], 'lib', lib))
```

in our ATLAS install script.


---

Comment by jdemeyer created at 2015-09-08 12:53:49

Changing component from build to porting.


---

Comment by jdemeyer created at 2015-09-08 12:53:49

If anybody going to work on this? Otherwise we might as well close it. This ticket is only becoming more and more obsolete...


---

Comment by kcrisman created at 2015-09-08 13:11:52

Still got an eMac sitting in my office waiting for me to fire up again... I had a very busy spring and summer with very little Sage time.  With some luck this fall will be different.  You are right about the obsolescence but let's just see.


---

Comment by kcrisman created at 2015-09-10 14:37:01

#17466 suggests maybe there is no fix needed any more on IML.  I will check that out.


---

Comment by kcrisman created at 2015-10-16 01:52:05

I think I have given up.  I did make the Sage 6.4.1 binaries and that should make people happy for a while, so I guess one could even say I was partly successful with this ticket.

Everything is still documented here in case someone else wanted to try for a newer Sage, also - I really don't think it would be that hard except for the gcc issue.  Apparently #19370 fixes #16044, which is nice.  I'm not sure if #17510 is only for this platform or not.


---

Comment by kcrisman created at 2015-10-16 01:52:05

Changing status from new to needs_review.


---

Comment by kcrisman created at 2015-10-16 01:52:35

I'll ask for another reviewer on this to confirm the sad closure.


---

Comment by jdemeyer created at 2015-10-16 07:14:16

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-10-17 19:38:57

Resolution: wontfix
