# Issue 17276: Allow Sage to build and run on old Macs on last time

archive/issues_017276.json:
```json
{
    "body": "Modulo gcc 4.9, of course, though in principle one could ask for a message asking to build gcc 4.7 first.\n\nWe need the following\n* This is not supported by at least some shells.\n\n```\nif [[ \"$1\" =~ \"--notebook=\"* || \"$1\" =~ \"-n=\"* || \"$1\" =~ \"-notebook=\"* ]]; then\n    sage-cleaner &>/dev/null &\n    exec sage-notebook \"$@\"\nfi\n```\n\n  including\n\n```\n$ bash --version\nGNU bash, version 2.05b.0(1)-release (powerpc-apple-darwin8.0)\nCopyright (C) 2002 Free Software Foundation, Inc.\n```\n\n* Need to put back in the pyzmq patch to avoid `-arch` flag on our gcc, at least for very old indeed Mac - #17510.\n* iml upgrade seems to have removed something for this system. We can add something along the lines of\n\n```\nEXTRA_BLAS=\"\"\nif [ $UNAME = \"Darwin\" ]; then\n    # copy cblas headers from gsl\n    cp ../patches/gsl_cblas.h cblas.h\n    EXTRA_BLAS=\"--with-cblas=-lgslcblas\"\nfi\n```\n\n  to fix this.\n* Do something about #16044, even if it is to tacitly let it build on this platform without having to do `make -k`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/17513\n\n",
    "created_at": "2014-12-16T02:12:19Z",
    "labels": [
        "build",
        "minor",
        "bug"
    ],
    "title": "Allow Sage to build and run on old Macs on last time",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17276",
    "user": "kcrisman"
}
```
Modulo gcc 4.9, of course, though in principle one could ask for a message asking to build gcc 4.7 first.

We need the following
* This is not supported by at least some shells.

```
if [[ "$1" =~ "--notebook="* || "$1" =~ "-n="* || "$1" =~ "-notebook="* ]]; then
    sage-cleaner &>/dev/null &
    exec sage-notebook "$@"
fi
```

  including

```
$ bash --version
GNU bash, version 2.05b.0(1)-release (powerpc-apple-darwin8.0)
Copyright (C) 2002 Free Software Foundation, Inc.
```

* Need to put back in the pyzmq patch to avoid `-arch` flag on our gcc, at least for very old indeed Mac - #17510.
* iml upgrade seems to have removed something for this system. We can add something along the lines of

```
EXTRA_BLAS=""
if [ $UNAME = "Darwin" ]; then
    # copy cblas headers from gsl
    cp ../patches/gsl_cblas.h cblas.h
    EXTRA_BLAS="--with-cblas=-lgslcblas"
fi
```

  to fix this.
* Do something about #16044, even if it is to tacitly let it build on this platform without having to do `make -k`.

Issue created by migration from https://trac.sagemath.org/ticket/17513





---

archive/issue_comments_230043.json:
```json
{
    "body": "Not formal patch for iml, but at least for very old Darwin\n\n```diff\n EXTRA_BLAS=\"\"\n if [ $UNAME = \"Darwin\" ]; then\n     # copy cblas headers from gsl\n     cp ../patches/gsl_cblas.h cblas.h\n-    EXTRA_BLAS=\"--with-cblas=-lcblas\"\n+    EXTRA_BLAS=\"--with-cblas=-lgslcblas\"\n fi\n```\n",
    "created_at": "2015-01-05T17:27:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17276#issuecomment-230043",
    "user": "kcrisman"
}
```

Not formal patch for iml, but at least for very old Darwin

```diff
 EXTRA_BLAS=""
 if [ $UNAME = "Darwin" ]; then
     # copy cblas headers from gsl
     cp ../patches/gsl_cblas.h cblas.h
-    EXTRA_BLAS="--with-cblas=-lcblas"
+    EXTRA_BLAS="--with-cblas=-lgslcblas"
 fi
```




---

archive/issue_comments_230044.json:
```json
{
    "body": "Fix from [sage-devel](https://groups.google.com/forum/#!topic/sage-devel/veJDjWespUc):\n\n\n```\nif [ \"${1:0:11}\" = \"--notebook=\" ] || [ \"${1:0:10}\" = \"-notebook=\" ] || [ \"${1:0:3}\" = \"-n=\" ]; then\n```\n",
    "created_at": "2015-01-06T14:40:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17276#issuecomment-230044",
    "user": "kcrisman"
}
```

Fix from [sage-devel](https://groups.google.com/forum/#!topic/sage-devel/veJDjWespUc):


```
if [ "${1:0:11}" = "--notebook=" ] || [ "${1:0:10}" = "-notebook=" ] || [ "${1:0:3}" = "-n=" ]; then
```




---

archive/issue_comments_230045.json:
```json
{
    "body": "For reference\n\n```diff\ndiff --git a/src/bin/sage b/src/bin/sage\nindex ca07760..a5d2dae 100755\n--- a/src/bin/sage\n+++ b/src/bin/sage\n@@ -641,7 +641,7 @@ build_sage() {\n     sage-build \"$@\" || exit $?\n }\n \n-if [[ \"$1\" =~ \"--notebook=\"* || \"$1\" =~ \"-n=\"* || \"$1\" =~ \"-notebook=\"* ]]; then\n+if [ \"${1:0:11}\" = \"--notebook=\" ] || [ \"${1:0:10}\" = \"-notebook=\" ] || [ \"${1:0:3}\" = \"-n=\" ]; then\n     sage-cleaner &>/dev/null &\n     exec sage-notebook \"$@\"\n fi\n```\n",
    "created_at": "2015-01-06T16:56:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17276#issuecomment-230045",
    "user": "kcrisman"
}
```

For reference

```diff
diff --git a/src/bin/sage b/src/bin/sage
index ca07760..a5d2dae 100755
--- a/src/bin/sage
+++ b/src/bin/sage
@@ -641,7 +641,7 @@ build_sage() {
     sage-build "$@" || exit $?
 }
 
-if [[ "$1" =~ "--notebook="* || "$1" =~ "-n="* || "$1" =~ "-notebook="* ]]; then
+if [ "${1:0:11}" = "--notebook=" ] || [ "${1:0:10}" = "-notebook=" ] || [ "${1:0:3}" = "-n=" ]; then
     sage-cleaner &>/dev/null &
     exec sage-notebook "$@"
 fi
```




---

archive/issue_comments_230046.json:
```json
{
    "body": "And\n\n```diff\ndiff --git a/build/pkgs/iml/spkg-install b/build/pkgs/iml/spkg-install\nindex 7940695..1241f3e 100755\n--- a/build/pkgs/iml/spkg-install\n+++ b/build/pkgs/iml/spkg-install\n@@ -35,7 +35,7 @@ EXTRA_BLAS=\"\"\n if [ $UNAME = \"Darwin\" ]; then\n     # copy cblas headers from gsl\n     cp ../patches/gsl_cblas.h cblas.h\n-    EXTRA_BLAS=\"--with-cblas=-lcblas\"\n+    EXTRA_BLAS=\"--with-cblas=-lgslcblas\"\n fi\n \n ./configure --prefix=\"$SAGE_LOCAL\" --libdir=\"$SAGE_LOCAL/lib\" \\\n```\n",
    "created_at": "2015-01-06T16:57:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17276#issuecomment-230046",
    "user": "kcrisman"
}
```

And

```diff
diff --git a/build/pkgs/iml/spkg-install b/build/pkgs/iml/spkg-install
index 7940695..1241f3e 100755
--- a/build/pkgs/iml/spkg-install
+++ b/build/pkgs/iml/spkg-install
@@ -35,7 +35,7 @@ EXTRA_BLAS=""
 if [ $UNAME = "Darwin" ]; then
     # copy cblas headers from gsl
     cp ../patches/gsl_cblas.h cblas.h
-    EXTRA_BLAS="--with-cblas=-lcblas"
+    EXTRA_BLAS="--with-cblas=-lgslcblas"
 fi
 
 ./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" \
```




---

archive/issue_comments_230047.json:
```json
{
    "body": "For old Darwin isn't `IML_CONFIGURE=\"--with-cblas=-lcblas -latlas` ok?\n(Copying the header should not be necessary.)",
    "created_at": "2015-01-13T18:12:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17276#issuecomment-230047",
    "user": "jpflori"
}
```

For old Darwin isn't `IML_CONFIGURE="--with-cblas=-lcblas -latlas` ok?
(Copying the header should not be necessary.)



---

archive/issue_comments_230048.json:
```json
{
    "body": "Probably, I was just going for minimal changes to current files for my own ease.   It is very, very slow to try this for me because I have to have access to the machines *and* nothing better to do *and* then it takes a while to do it because they are old.",
    "created_at": "2015-01-13T18:52:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17276#issuecomment-230048",
    "user": "kcrisman"
}
```

Probably, I was just going for minimal changes to current files for my own ease.   It is very, very slow to try this for me because I have to have access to the machines *and* nothing better to do *and* then it takes a while to do it because they are old.



---

archive/issue_comments_230049.json:
```json
{
    "body": "Oh, maybe `-lblas` is needed.\nSee \n\n```\nif conf['PPC?']:   # OSX 10.4 PPC linker needs help to find the accelerate blas\n        veclib_dir = '/System/Library/Frameworks/Accelerate.framework/' + \\\n            'Versions/A/Frameworks/vecLib.framework/Versions/A'\n        for lib in [ 'libBLAS.dylib', 'libLAPACK.dylib']:\n            ln(os.path.join(veclib_dir, lib),\n               os.path.join(conf['SAGE_LOCAL'], 'lib', lib))\n```\n\nin our ATLAS install script.",
    "created_at": "2015-01-14T16:03:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17276#issuecomment-230049",
    "user": "jpflori"
}
```

Oh, maybe `-lblas` is needed.
See 

```
if conf['PPC?']:   # OSX 10.4 PPC linker needs help to find the accelerate blas
        veclib_dir = '/System/Library/Frameworks/Accelerate.framework/' + \
            'Versions/A/Frameworks/vecLib.framework/Versions/A'
        for lib in [ 'libBLAS.dylib', 'libLAPACK.dylib']:
            ln(os.path.join(veclib_dir, lib),
               os.path.join(conf['SAGE_LOCAL'], 'lib', lib))
```

in our ATLAS install script.



---

archive/issue_comments_230050.json:
```json
{
    "body": "Changing component from build to porting.",
    "created_at": "2015-09-08T12:53:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17276#issuecomment-230050",
    "user": "jdemeyer"
}
```

Changing component from build to porting.



---

archive/issue_comments_230051.json:
```json
{
    "body": "If anybody going to work on this? Otherwise we might as well close it. This ticket is only becoming more and more obsolete...",
    "created_at": "2015-09-08T12:53:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17276#issuecomment-230051",
    "user": "jdemeyer"
}
```

If anybody going to work on this? Otherwise we might as well close it. This ticket is only becoming more and more obsolete...



---

archive/issue_comments_230052.json:
```json
{
    "body": "Still got an eMac sitting in my office waiting for me to fire up again... I had a very busy spring and summer with very little Sage time.  With some luck this fall will be different.  You are right about the obsolescence but let's just see.",
    "created_at": "2015-09-08T13:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17276#issuecomment-230052",
    "user": "kcrisman"
}
```

Still got an eMac sitting in my office waiting for me to fire up again... I had a very busy spring and summer with very little Sage time.  With some luck this fall will be different.  You are right about the obsolescence but let's just see.



---

archive/issue_comments_230053.json:
```json
{
    "body": "#17466 suggests maybe there is no fix needed any more on IML.  I will check that out.",
    "created_at": "2015-09-10T14:37:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17276#issuecomment-230053",
    "user": "kcrisman"
}
```

#17466 suggests maybe there is no fix needed any more on IML.  I will check that out.



---

archive/issue_comments_230054.json:
```json
{
    "body": "I think I have given up.  I did make the Sage 6.4.1 binaries and that should make people happy for a while, so I guess one could even say I was partly successful with this ticket.\n\nEverything is still documented here in case someone else wanted to try for a newer Sage, also - I really don't think it would be that hard except for the gcc issue.  Apparently #19370 fixes #16044, which is nice.  I'm not sure if #17510 is only for this platform or not.",
    "created_at": "2015-10-16T01:52:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17276#issuecomment-230054",
    "user": "kcrisman"
}
```

I think I have given up.  I did make the Sage 6.4.1 binaries and that should make people happy for a while, so I guess one could even say I was partly successful with this ticket.

Everything is still documented here in case someone else wanted to try for a newer Sage, also - I really don't think it would be that hard except for the gcc issue.  Apparently #19370 fixes #16044, which is nice.  I'm not sure if #17510 is only for this platform or not.



---

archive/issue_comments_230055.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-10-16T01:52:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17276#issuecomment-230055",
    "user": "kcrisman"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_230056.json:
```json
{
    "body": "I'll ask for another reviewer on this to confirm the sad closure.",
    "created_at": "2015-10-16T01:52:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17276#issuecomment-230056",
    "user": "kcrisman"
}
```

I'll ask for another reviewer on this to confirm the sad closure.



---

archive/issue_comments_230057.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-10-16T07:14:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17276#issuecomment-230057",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_230058.json:
```json
{
    "body": "Resolution: wontfix",
    "created_at": "2015-10-17T19:38:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17276",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17276#issuecomment-230058",
    "user": "vbraun"
}
```

Resolution: wontfix
