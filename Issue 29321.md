# Issue 29321: Autogenerated parts of installation guide

Issue created by migration from https://trac.sagemath.org/ticket/29558

Original creator: jhpalmieri

Original creation time: 2020-04-23 22:32:51

CC:  mkoeppe dimpase embray

- Add a homebrew section, which requires producing good autogenerated homebrew files
- Clean up the cygwin autogenerated files



---

Comment by jhpalmieri created at 2020-04-23 22:35:23

Regarding a homebrew section: I am having problems with figuring out how to autogenerate the files `homebrew.txt` and `homebrew-optional.txt`. If I just add `homebrew` to the list of `SYSTEM`s in `src/doc/bootstrap`, I end up with this for `homebrew.txt`:

```
    $ brew install boost freetype gcc gd git gmp gpatch gsl libmpc libpng mpfi mpfr openblas pcre pkg-config ppl python3 r readline sqlite xz yasm zeromq zlib
# Afterwards: 
# To automatically take care of homebrew messages regarding 
# keg-only packages for the current shell session:
# $ source /Users/palmieri/Desktop/Sage_stuff/git/sage/.homebrew-build-env
# Add this to your shell profile if you want it to persist between shell sessions.
```

I really just want the first line, and then I can add the rest by hand. Along the same lines, the files for `cygwin` are a little broken. `cygwin.txt` looks like

```
    $ # first install apt-cyg from https://github.com/transcode-open/apt-cyg
apt-cyg install R binutils bzip2 cddlib-devel cddlib-tools curl findutils gcc-core gcc-core gcc-fortran gcc-fortran gcc-g++ gcc-g++ git glpk libatomic_ops-devel libboost-devel libbz2-devel libcrypt-devel libcurl-devel libffi-devel libflint-devel libfreetype-devel libgd-devel libglpk-devel libgmp-devel libgsl-devel libiconv-devel liblapack-devel liblzma-devel libmpc-devel libmpfr-devel libncurses-devel libntl-devel libopenblas libpcre-devel libreadline-devel libsqlite3-devel libtirpc-devel libzmq-devel m4 make patch perl perl-ExtUtils-MakeMaker python37 python37-devel python37-urllib tar which xz yasm zlib-devel
```

and the resulting output in the installation guide doesn't look perfect.

Is the URL `https://github.com/transcode-open/apt-cyg` stable enough that it should just be included in the text? Then we would really want this to just say `$ apt-cyg install R ...`.


---

Comment by jhpalmieri created at 2020-04-23 22:37:50

Here is a very rough draft, but it has the flaws mentioned in comment:1.
----
New commits:


---

Comment by mkoeppe created at 2020-04-23 22:48:04

`build/bin/sage-print-system-package-command` could certainly be made more flexible in what it prints in order to support prettier output.


---

Comment by jhpalmieri created at 2020-04-23 22:58:18

I'm not a whiz at shell scripts. My current attempt works, but maybe there are better ways:

```diff
diff --git a/build/bin/sage-print-system-package-command b/build/bin/sage-print-system-package-command
index 7802d447df..38b7966bcd 100755
--- a/build/bin/sage-print-system-package-command
+++ b/build/bin/sage-print-system-package-command
@@ -26,27 +26,35 @@ if [ -n "$system_packages" ]; then
             ;;
         homebrew*:install)
             echo "brew install $system_packages"
-            echo "# Afterwards: "
+            if [ -z "$SAGE_STRIP_COMMENTS" ]; then
+                echo "# Afterwards: "
+            fi
             ;;
         slackware*:install)
             echo "sudo slackpkg install $system_packages"
             ;;
         cygwin*:install)
-            echo "# first install apt-cyg from https://github.com/transcode-open/apt-cyg"
+            if [ -z "$SAGE_STRIP_COMMENTS" ]; then
+                echo "# first install apt-cyg from https://github.com/transcode-open/apt-cyg"
+            fi
             echo "apt-cyg install $system_packages"
             ;;
         *)
-            echo "# $command the following packages: $system_packages"
+            if [ -z "$SAGE_STRIP_COMMENTS" ]; then
+                echo "# $command the following packages: $system_packages"
+            fi
             ;;
     esac
 fi
 # Messages that should go out even if not packages need to be installed
 case $system:$command in
     homebrew*:install)
-        echo "# To automatically take care of homebrew messages regarding "
-        echo "# keg-only packages for the current shell session:"
-        [ -n "$SAGE_ROOT" ] || SAGE_ROOT=.
-        echo "# $ source $SAGE_ROOT/.homebrew-build-env"
-        echo "# Add this to your shell profile if you want it to persist between shell sessions."
+        if [ -z "$SAGE_STRIP_COMMENTS" ]; then
+            echo "# To automatically take care of homebrew messages regarding "
+            echo "# keg-only packages for the current shell session:"
+            [ -n "$SAGE_ROOT" ] || SAGE_ROOT=.
+            echo "# $ source $SAGE_ROOT/.homebrew-build-env"
+            echo "# Add this to your shell profile if you want it to persist between shell sessions."
+        fi
         ;;
 esac
diff --git a/src/doc/bootstrap b/src/doc/bootstrap
index 3ac1f5b767..283798635b 100755
--- a/src/doc/bootstrap
+++ b/src/doc/bootstrap
@@ -46,6 +46,6 @@ for SYSTEM in arch debian fedora cygwin homebrew; do
         fi
     done
     echo >&2 $0:$LINENO: installing "$OUTPUT_DIR"/$SYSTEM.txt and "$OUTPUT_DIR"/$SYSTEM-optional.txt
-    echo "$PROMPT$(sage-print-system-package-command $SYSTEM install $(echo $(echo $SYSTEM_PACKAGES | xargs -n 1 echo | sort)))" > "$OUTPUT_DIR"/$SYSTEM.txt
-    echo "$PROMPT$(sage-print-system-package-command $SYSTEM install $(echo $(echo $OPTIONAL_SYSTEM_PACKAGES | xargs -n 1 echo | sort)))" > "$OUTPUT_DIR"/$SYSTEM-optional.txt
+    echo "$PROMPT$(SAGE_STRIP_COMMENTS=yes sage-print-system-package-command $SYSTEM install $(echo $(echo $SYSTEM_PACKAGES | xargs -n 1 echo | sort)))" > "$OUTPUT_DIR"/$SYSTEM.txt
+    echo "$PROMPT$(SAGE_STRIP_COMMENTS=yes sage-print-system-package-command $SYSTEM install $(echo $(echo $OPTIONAL_SYSTEM_PACKAGES | xargs -n 1 echo | sort)))" > "$OUTPUT_DIR"/$SYSTEM-optional.txt
 done
```



---

Comment by git created at 2020-04-23 23:06:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2020-04-23 23:06:50

(No changes to `sage-print-system-package-command` in the branch yet, just minor changes.)


---

Comment by mkoeppe created at 2020-04-24 00:00:32

For `sage-print-system-package-command`, maybe better to split `install` into `prepare` and `install` and `setup-env` or something like this, instead of using an environment variable


---

Comment by mkoeppe created at 2020-04-24 00:01:16

I'll give it a shot


---

Comment by mkoeppe created at 2020-04-24 01:30:12

Take a look if this version works for you
----
New commits:


---

Comment by mkoeppe created at 2020-04-24 01:35:59

Replying to [comment:1 jhpalmieri]:
> Is the URL `https://github.com/transcode-open/apt-cyg` stable enough that it should just be included in the text? Then we would really want this to just say `$ apt-cyg install R ...`.

I don't really know. `@`embray added this part.


---

Comment by jhpalmieri created at 2020-04-24 01:54:13

Replying to [comment:13 mkoeppe]:
> Replying to [comment:1 jhpalmieri]:
> > Is the URL `https://github.com/transcode-open/apt-cyg` stable enough that it should just be included in the text? Then we would really want this to just say `$ apt-cyg install R ...`.
> 
> I don't really know. `@`embray added this part.

I realized this actually doesn't matter: the document already includes instructions for installing `apt-cyg`.


---

Comment by mkoeppe created at 2020-04-24 02:14:31

Changing priority from major to blocker.


---

Comment by jhpalmieri created at 2020-04-24 02:22:21

Changing priority from blocker to major.


---

Comment by jhpalmieri created at 2020-04-24 02:22:21

Did the addition of the line

```
OPTIONAL_SYSTEM_PACKAGES=
```

cut down on the repetitions in the commands? I'm not seeing nearly as much as I did before, and I can't figure out why.


---

Comment by jhpalmieri created at 2020-04-24 02:32:36

Changing priority from major to blocker.


---

Comment by jhpalmieri created at 2020-04-24 02:37:28

I'm happy with this. How about you?
----
New commits:


---

Comment by jhpalmieri created at 2020-04-24 02:37:53

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-04-24 04:05:01

Replying to [comment:16 jhpalmieri]:
> Did the addition of the line
> {{{
> OPTIONAL_SYSTEM_PACKAGES=
> }}}
> cut down on the repetitions in the commands? I'm not seeing nearly as much as I did before, and I can't figure out why.
Yes, that's right. I actually had thought that was fixed before.


---

Comment by mkoeppe created at 2020-04-24 04:06:09

Looks good to me.


---

Comment by mkoeppe created at 2020-04-24 04:06:09

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-04-25 21:35:10

Resolution: fixed
