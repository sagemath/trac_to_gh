# Issue 18138: Drop the NetworkX graph backend

Issue created by migration from https://trac.sagemath.org/ticket/18375

Original creator: ncohen

Original creation time: 2015-05-06 19:49:34

CC:  dcoudert borassi vdelecroix

This branch deprecates the `NetworkX` backend for graphs. Indeed, while it made
sense to keep a `NetworkXGraphBackend` when Sage's default data structure
switched from `networkx` to `c_graphs`, we do not *need* it anymore.

This does not mean that Sage should not have a `NetworkX` data structure (though
there is little use). On the other hand, `NetworkX` is the only reason why we
have a `Backend` layer in Sage's graph data structures, as all others are
`CGraph` backends.

Thus, in order to simplify the hierarchy of classes for graph data structures,
it is easier to uniformize our data structures first. When this series of
patches will be finished and when the graph backends will be in a clearer and
simpler state, it will be possible to implement a new `NetworkX` backend.

It makes little sense, however, to rewrite the current networkx backend as a
`c_graph` backend when it will have to be rewritten again later during the
refactoring.

Technical info:

- The main problem in this branch was the handling of (old) graph pickles. As
  the classes themselves are being deprecated, the `__setstate__` functions
  detect whenever an attribute uses a deprecated class, and in this case convert
  it into a non-deprecated data structure (sparse graph, by default).

- Two `random_stress` functions are removed, as they work by comparing the
  behaviour of `c_graph` and `networkx` backend. This is not as terrible as it
  sounds, for graphs are tested extensively in many places of Sage (I am often
  surprised to find out where they are used when code breaks)


---

Comment by ncohen created at 2015-05-06 19:51:51

Changing status from new to needs_review.


---

Comment by git created at 2015-05-06 19:53:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-05-07 05:20:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-05-08 22:05:41

You do not like these `random_stress` functions?


---

Comment by ncohen created at 2015-05-09 06:08:44

> You do not like these `random_stress` functions?

Not much. They could have used more doc. But more importantly, they do not work without a networkx backend.


---

Comment by dcoudert created at 2015-05-26 18:28:01

I did long tests on the graph module and it is OK. The doc also builds properly.

Should I test something else to ensure that this patch is working well? In particular, how can I test the pickle stuff.


---

Comment by kcrisman created at 2015-05-27 00:54:27

Dumb questions that I get scared about when I see this ticket:  What if people are working with NX stuff and want to use them in Sage easily?  Does this make this impossible?  Also, are you suggesting dropping NX as a standard package (assuming it still is one)?


---

Comment by ncohen created at 2015-05-27 07:57:53

> Dumb questions that I get scared about when I see this ticket:  What if people are working with NX stuff and want to use them in Sage easily?  Does this make this impossible?  Also, are you suggesting dropping NX as a standard package (assuming it still is one)?

This ticket removes a feature you probably did not know even existed:


```
sage: Graph([(1,2),(3,4)])._backend
<type 'sage.graphs.base.sparse_graph.SparseGraphBackend'>
sage: Graph([(1,2),(3,4)],implementation="networkx")._backend
<class 'sage.graphs.base.graph_backends.NetworkXGraphBackend'>
```


The 'networkx' backend only means that inside of the graph class, at a level you are not supposed to reach except when you write low-level graph functions, the graph is stored as a netowrkx object.

That changes nothing to the fact that networkx is still available in Sage. You can import it, call it, and still get a networkx copy of your graphs with `Graph.networkx_graph()`. And Sage itself still uses networkx in many places: the stupidest example of that is `graphs.CompleteGraph`. Believe it or not, in order to build a complete graph Sage calls networkx' function `networkx.complete_graph(n)`.

Nathann


---

Comment by ncohen created at 2015-05-27 07:59:46

> Should I test something else to ensure that this patch is working well? In particular, how can I test the pickle stuff.

It gets tested automatically. It is done in `sage.structure.sage_object`. You can also do it manually with:


```
sage: sage.structure.sage_object.unpickle_all()
```


Nathann


---

Comment by dcoudert created at 2015-05-27 11:12:33

I did a ./sage -t --long src/sage/  and all tests pass.

I also tried

```
sage: sage.structure.sage_object.unpickle_all()
/Users/dcoudert/sage/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:3035: DeprecationWarning: You unpickled an object which relies on an old data structure. Save it again to update it, for it may break in the future.
See http://trac.sagemath.org/18375 for details.
  exec(code_obj, self.user_global_ns, self.user_ns)
/Users/dcoudert/sage/src/bin/sage-ipython:1: DeprecationWarning: You unpickled an object which relies on an old data structure. Save it again to update it, for it may break in the future.
See http://trac.sagemath.org/1000 for details.
  #!/usr/bin/env python
/Users/dcoudert/sage/src/bin/sage-ipython:1: DeprecationWarning: OrderedAlphabet is deprecated; use Alphabet instead.
See http://trac.sagemath.org/8920 for details.
  #!/usr/bin/env python
/Users/dcoudert/sage/src/bin/sage-ipython:1: DeprecationWarning: gen_py.pari is deprecated, use sage.libs.pari.all.pari instead
See http://trac.sagemath.org/17451 for details.
  #!/usr/bin/env python
/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/rings/finite_rings/constructor.py:632: DeprecationWarning: The "pari_mod" finite field implementation is deprecated
See http://trac.sagemath.org/17297 for details.
  K = FiniteField_ext_pari(order, name, modulus)
/Users/dcoudert/sage/src/bin/sage-ipython:1: DeprecationWarning: MatrixSpace_ZZ_2x2 is deprecated. Please use MatrixSpace(ZZ,2) instead
See http://trac.sagemath.org/17824 for details.
  #!/usr/bin/env python
Successfully unpickled 586 objects.
Failed to unpickle 0 objects.
```


So the patch is working well.

However, in the doc, on page /reference/graphs/sage/graphs/base/overview.html  the section `The backends` could be updated, at least to mention that the networkx backend is deprecated.


---

Comment by dcoudert created at 2015-05-27 11:12:33

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2015-05-27 11:32:50

> However, in the doc, on page /reference/graphs/sage/graphs/base/overview.html  the section `The backends` could be updated, at least to mention that the networkx backend is deprecated.

Arg. Right.

Nathann


---

Comment by git created at 2015-05-27 11:43:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-05-27 11:44:38

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2015-05-27 11:44:38

I updated the doc, which does not mention the netowrkx backend anymore. Note that it is not "deprecated", but totally dropped. Users will still see a deprecation warning for a year, but in the backscene the CGraph backend is the one that will be used.

Nathann


---

Comment by dcoudert created at 2015-05-27 12:08:11

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2015-05-27 12:08:11

For me the patch is now good to go.


---

Comment by ncohen created at 2015-05-27 12:13:44

Thanks !


---

Comment by kcrisman created at 2015-05-27 12:40:30

> This ticket removes a feature you probably did not know even existed:
> The 'networkx' backend only means that inside of the graph class, at a level you are not supposed to reach except when you write low-level graph functions, the graph is stored as a netowrkx object.
Okay, I am fine with that - actually I _did_ know that feature existed.
> Believe it or not, in order to build a complete graph Sage calls networkx' function `networkx.complete_graph(n)`.
Yes, in fact I think there are other places where that occurs :)  Thanks for the clarification!


---

Comment by vbraun created at 2015-05-27 22:09:32

Resolution: fixed
