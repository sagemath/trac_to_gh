# Issue 14392: Make a new optional spkg for pari's large seadata data

Issue created by migration from https://trac.sagemath.org/ticket/14596

Original creator: cremona

Original creation time: 2013-05-16 08:23:20

Assignee: tbd

Keywords: pari optional spkg

It would be useful to have an optional spkg to make it easy to install the optional pari large seadata package.  This is used in point counting on elliptic curves over large prime fields (primes over 350 bits), and consists of data precomputed by David Kohel for his Magma Echidna package.

One merely has to download http://pari.math.u-bordeaux.fr/pub/pari/packages/seadata.tgz and unpack it into SAGE_ROOT/local/share/pari/seadata so the spkg will be very easy.

A little harder would be to catch cases where the default installation fails and output a helpful message to the user suggesting that installing this additional package would be a good idea.  At 19MB we probably do not want to include this as standard, since there may be some Sage users who will never want to count points on elliptic curves.


---

Comment by jdemeyer created at 2013-05-16 08:38:03

How about shipping _all_ PARI databases in one package (including `elldata`, `seadata`, `galpol` and `nftables`), analogous to how it's done for GAP?

Upstream package list: [http://pari.math.u-bordeaux.fr/packages.html](http://pari.math.u-bordeaux.fr/packages.html)


---

Comment by cremona created at 2013-05-16 09:11:23

Replying to [comment:1 jdemeyer]:
> How about shipping _all_ PARI databases in one package (including `elldata`, `seadata`, `galpol` and `nftables`), analogous to how it's done for GAP?
> 
> Upstream package list: [http://pari.math.u-bordeaux.fr/packages.html](http://pari.math.u-bordeaux.fr/packages.html)

We may as well I suppose, though elldata is another 33MB and only duplicates (partially) our own optional database.  However, why should someone not be able to use a fully functional gp with all extras from Sage?  Let's do it.  In the first instance, let's just make the spkg and make no changes at all to the Sage library.


---

Comment by jdemeyer created at 2013-05-16 09:15:07

Replying to [comment:2 cremona]:
> We may as well I suppose, though elldata is another 33MB and only duplicates (partially) our own optional database.
Yes, it duplicates your database, but in PARI format as opposed to Sage format.


---

Comment by jdemeyer created at 2013-05-16 09:18:03

I'll work on this.


---

Comment by leif created at 2013-05-16 10:46:14

Replying to [comment:1 jdemeyer]:
> How about shipping _all_ PARI databases in one package (including `elldata`, `seadata`, `galpol` and `nftables`), analogous to how it's done for GAP?

I wouldn't put all of them into one huge Sage package (unfortunately we don't have meta packages [yet]); I was even thinking of omitting `sea0` (and `sea2`) from `databases_pari_seadata[-large].spkg`, say.


---

Comment by leif created at 2013-05-16 10:50:07

P.S.:  We could also provide a few _functions_ in Sage to (download and) install the necessary parts.


---

Comment by cremona created at 2013-05-16 11:13:03

Replying to [comment:7 leif]:
> P.S.:  We could also provide a few _functions_ in Sage to (download and) install the necessary parts.

I think this is too complicated.  Only seadata and elldata are of any size, and they are not that big, and this will be optional.

re PS: no, we should avoid functions which only work when Sage is running on an online machine.  It could hardly be simpler than

```
sage: install_package("pari-optional-packages")
}}} 
anyway!


---

Comment by leif created at 2013-05-16 11:55:02

Replying to [comment:8 cremona]:
> re PS: no, we should avoid functions which only work when Sage is running on an online machine.

Well, we could e.g. build PARI's `elldata` from your data shipped with Sage (or the larger Sage optional package [if it is already installed]).

I.e., not all functions would need internet access (although installing from a local/near copy would work as well anyway).  And the main point of the "no internet access" rule is that it should not _unexpectedly_ happen, which certainly isn't the case when you attempt to install something (without previously having downloaded it).   




> It could hardly be simpler than
> {{{
> sage: install_package("pari-optional-packages")
> }}} 
> anyway!

Oh, that [always] works without internet access? ;-)


---

Attachment


---

Comment by jdemeyer created at 2013-05-17 10:41:53

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2013-05-17 18:59:23

Any chance for a review? The `spkg-install` is totally trivial (just copy some files), so a review can be easy.

I know that a lot of improvements are still possible, but this should do the job.


---

Comment by leif created at 2013-05-17 19:37:02

`spkg-check` looks a bit funny.   First, it depends on the Sage library, second, it uses `-tp`, and even runs the tests in verbose mode (without any additional message referring to the database(s) subject to installation).




Since this is an optional spkg, I'd not rely on `SAGE_SRC` (and `SAGE_SHARE`, which you don't use [yet]) being defined, both being relatively new, but use `${SAGE_SRC:-${SAGE_ROOT}/devel/sage}` etc. instead, or do

```sh
[[ -z "$SAGE_SRC" ]] && SAGE_SRC="${SAGE_ROOT}/devel/sage"

[[ -z "$SAGE_SHARE" ]] && SAGE_SHARE="${SAGE_LOCAL}/share"
```


(Then I'd use `"${SAGE_SHARE}/pari/" as the destination directory.)

I'd also rather use `gp` in `spkg-check`, or do some simpler sanity check on the installed files.


---

Comment by leif created at 2013-05-17 19:54:17

Oh, we even have `GP_DATA_DIR` defined in `sage-env`.


---

Comment by jdemeyer created at 2013-05-17 19:58:10

Replying to [comment:12 leif]:
> First, it depends on the Sage library, second, it uses `-tp`, and even runs the tests in verbose mode
3 true statements, but is any of them a problem?


---

Comment by leif created at 2013-05-17 20:23:50

Also, the `cp` (without `-f`) will fail if the user decided to make the already installed databases read-only (which IMHO isn't _that_ unreasonable).


---

Comment by leif created at 2013-05-17 20:39:17

Replying to [comment:14 jdemeyer]:
> Replying to [comment:12 leif]:
> > First, it depends on the Sage library, second, it uses `-tp`, and even runs the tests in verbose mode
> 3 true statements, but is any of them a problem?

Well, why use `-p`?  Why verbose?  Especially the combination seems weird.

(Hopefully the doctesting framework doesn't parse the `--long` into a number of threads, don't know.)

If installing it with `SAGE_CHECK=yes` (probably not specifically set for that installation) requires the Sage library (or likewise, perhaps `gp`), you can't (successfully) install it in advance.

IMHO unnecessary pitfalls.


---

Comment by jdemeyer created at 2013-05-17 22:02:05

Replying to [comment:15 leif]:
> Also, the `cp` (without `-f`) will fail if the user decided to make the already installed databases read-only
Sure, and it *should* fail in such a case.


---

Comment by jdemeyer created at 2013-05-17 22:07:23

Replying to [comment:16 leif]:
> Well, why use `-p`?
Because I expect

```
env SAGE_CHECK=yes MAKE="make -j20" ./sage -i database_pari
```

to use 20 threads, both for installing (which is pointless for this spkg) and for testing.

> Why verbose?
Because one test takes an annoyingly long time (about 2 minutes), and with `--verbose` you will at least see something happening, at least the message "# long time" should be seen. But I can certainly change this if it means positive_review.

> Hopefully the doctesting framework doesn't parse the `--long` into a number of threads
No, it doesn't.

> If installing it with `SAGE_CHECK=yes` requires the Sage library (or likewise, perhaps `gp`), you can't (successfully) install it in advance.
Another true statement... many optional packages cannot be installed "in advance", so why would this be a problem?


---

Comment by jdemeyer created at 2013-05-17 22:55:24

spkg contents


---

Attachment

I made a few small changes: removed `--verbose` testing, use `GP_DATA_DIR` environment variable, check that all used variables are defined.


---

Comment by cremona created at 2013-05-19 17:31:34

I checked that the spkg builds ok and the patch applies to sage-5.10.beta3.  Unfortunately when I then did "make ptestlong" it decided that it needed to build GCC from scratch (which was not the case when I built Sage originally) and after that it needed to rebuild all the rest of Sage (roughly) so the test has not even started yet a couple of hours later.

I don't know why this happened but it is clearly not the fault of anything on this ticket.


---

Comment by cremona created at 2013-05-19 18:43:41

Replying to [comment:20 cremona]:
> I checked that the spkg builds ok and the patch applies to sage-5.10.beta3.  Unfortunately when I then did "make ptestlong" it decided that it needed to build GCC from scratch (which was not the case when I built Sage originally) and after that it needed to rebuild all the rest of Sage (roughly) so the test has not even started yet a couple of hours later.
> 
> I don't know why this happened but it is clearly not the fault of anything on this ticket.

All tests pass, and I also tested installing the spkg with SAGE_CHECK=yes, and doctesting the patched file before and after installing the spkg.  Positive review.


---

Comment by jdemeyer created at 2013-05-19 20:01:26

Replying to [comment:20 cremona]:
> I checked that the spkg builds ok and the patch applies to sage-5.10.beta3.  Unfortunately when I then did "make ptestlong" it decided that it needed to build GCC from scratch (which was not the case when I built Sage originally) and after that it needed to rebuild all the rest of Sage (roughly) so the test has not even started yet a couple of hours later.
Perhaps you can send me the file `logs/install.log` so I can have a look for a possible explanation.


---

Comment by jdemeyer created at 2013-05-19 20:01:44

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-05-20 08:52:27

Resolution: fixed


---

Comment by schilly created at 2013-05-20 09:53:21

spkg is on the mirror and on its way around the planet :)
