# Issue 24436: Add a method to clear coercion caches of a parent

Issue created by migration from https://trac.sagemath.org/ticket/24673

Original creator: SimonKing

Original creation time: 2018-02-06 16:02:39

In #24658, there was a side-effect of one doctest on another doctest. The latter test was about whether a certain coercion is initially not cached, and the first test made it so that the coercion was cached before the second test started.

Proposal: Add a method `Parent._clear_coercion_caches()` that clears both `self._coerce_from_hash` and `self._convert_from_hash`.


---

Comment by jdemeyer created at 2018-02-06 16:11:56

A lot of coercion-related things are stored in the coercion model itself, not in the parent. So clearing the caches in the parent may not be sufficient.


---

Comment by SimonKing created at 2018-02-06 16:12:28

Probably it boils down to calling `self.init_coerce(False)`, which would erase all previously cached stuff.

HOWEVER: Such a method could seriously break the coercions in Sage and thus should be used very carefully.


---

Comment by SimonKing created at 2018-02-06 16:14:32

Replying to [comment:1 jdemeyer]:
> A lot of coercion-related things are stored in the coercion model itself, not in the parent. So clearing the caches in the parent may not be sufficient.

Yes, but one can always call `coercion_model.reset_cache()`. The difference is that there is no such  method (besides a cdef'd one) for parents to clear their caches.


---

Comment by SimonKing created at 2018-02-06 16:43:12

Or perhaps one should first think of the purpose of the to-be-added method. The only purpose is to prevent `R.is_coercion_cached(S)` to give an unexpected answer in some doctest. So, perhaps it would be safer to have a method `R._clear_from_coerce_cache(S)`, that ONLY removes `S` from `._coerce_from_hash` and `._convert_from_hash`.

I think cleaning further caches, especially `._coerce_from_list`, is not needed to fulfil its purpose, as `._coerce_from_list` is only filled by `.register_coercion()`, which is supposed to be only called during initialisation of a parent.


---

Comment by SimonKing created at 2018-02-06 22:43:23

New commits:


---

Comment by SimonKing created at 2018-02-06 22:43:23

Changing status from new to needs_review.


---

Comment by rws created at 2018-02-07 07:11:04

LGTM, thanks.


---

Comment by rws created at 2018-02-07 07:11:04

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-02-12 22:30:03

Resolution: fixed
