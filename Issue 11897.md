# Issue 11897: fix doctesting of .sage files

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2011-11-21 22:52:08

Assignee: mvngu

CC:  leif jdemeyer

Keywords: doctest

Trac #9739 broke doctesting of .sage files (as in `sage -t my_file.sage`).  The attached patch fixes this.

The problem was that before #9739, doctesting `file.sage` produced two Python files: a preparsed version of `file.sage`, and a file with the doctesting framework and the doctests, but not the actual Python/Sage code -- it just included a line like `from file import *`.  In #9739, we missed this, and we just produced one Python file, the second one, so the original Python/Sage code is nowhere to be found, and thus not importable.

At the same time, this patch fixes a small bug in the function `delete_tmpfiles`: the function used to quit completely if it couldn't find some file in the list `tmpfiles`.  Now if if can't find the file, it skips it and goes on to the next one.


---

Comment by jhpalmieri created at 2011-11-21 22:53:27

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2011-11-22 14:08:32

Could you make a doctest (maybe in `sage/tests/doctest.py`) doing the following:

 1. Create a temporary file doctest.sage with some function and a doctest testing that function.  (using [http://docs.python.org/library/tempfile.html#tempfile.NamedTemporaryFile](http://docs.python.org/library/tempfile.html#tempfile.NamedTemporaryFile))
 2. Use `test_executable` from `sage/tests/cmdline.py` to execute `sage -t the_temporary_file_created_in_step_1.sage`.
 3. Check that this executable returned with exit status 0.

Also, it would be good to update the last section of `doc/en/developer/doctesting.rst`.


---

Comment by jdemeyer created at 2011-11-22 14:08:32

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2011-11-22 19:39:26

Okay, here are new patches which add documentation to the `sage-doctest` script, update `doc/en/developer/doctesting.rst`, and add doctests to `tests/cmdline.py`.  (Is it okay to add to `cmdline.py` instead of creating a new file `doctest.py`?)


---

Comment by jhpalmieri created at 2011-11-22 19:39:26

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2011-11-22 19:39:41

scripts repo


---

Attachment


---

Comment by fwclarke created at 2012-03-21 19:57:41

I'd give this a positive review, but for the fact that it won't apply on sage-5.0.beta8 (the problem being with `cmdline.py`).  But patching that file by hand, everything seems to work as it should.

Replying to [comment:3 jhpalmieri]:
> Is it okay to add to `cmdline.py` instead of creating a new file `doctest.py`?
It looks like the sensible place to me.


---

Comment by fwclarke created at 2012-03-21 19:57:41

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2012-03-21 20:06:32

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2012-03-21 20:06:32

Here's a rebased patch.


---

Comment by fwclarke created at 2012-03-22 09:14:25

It's fine now.  Positive review.


---

Comment by fwclarke created at 2012-03-22 09:14:25

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-03-22 09:22:54

Just wondering: why

```
    sage: ret == 128 
    True 
```

instead of the more simple

```
    sage: ret
    128
```



---

Comment by jhpalmieri created at 2012-03-22 15:37:19

I don't think there's a good reason. I'll change it to

```
    sage: ret
    128
```

(Same with a few `ret == 0` tests.)


---

Comment by jhpalmieri created at 2012-03-22 15:37:35

Sage library


---

Attachment


---

Comment by jdemeyer created at 2012-03-28 10:04:00

Resolution: fixed


---

Comment by leif created at 2012-04-03 22:12:45

See #12805 for a follow-up, fixing left-over `tmp/` subdirectories which prohibited the deletion of otherwise empty temporary doctesting directories.


---

Comment by nthiery created at 2012-04-09 20:00:31

Thanks for fixing this! That was a pain in the neck.
