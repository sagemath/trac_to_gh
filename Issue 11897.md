# Issue 11897: fix doctesting of .sage files

archive/issues_011897.json:
```json
{
    "body": "Assignee: mvngu\n\nCC:  leif jdemeyer\n\nKeywords: doctest\n\nTrac #9739 broke doctesting of .sage files (as in `sage -t my_file.sage`).  The attached patch fixes this.\n\nThe problem was that before #9739, doctesting `file.sage` produced two Python files: a preparsed version of `file.sage`, and a file with the doctesting framework and the doctests, but not the actual Python/Sage code -- it just included a line like `from file import *`.  In #9739, we missed this, and we just produced one Python file, the second one, so the original Python/Sage code is nowhere to be found, and thus not importable.\n\nAt the same time, this patch fixes a small bug in the function `delete_tmpfiles`: the function used to quit completely if it couldn't find some file in the list `tmpfiles`.  Now if if can't find the file, it skips it and goes on to the next one.\n\nIssue created by migration from https://trac.sagemath.org/ticket/12069\n\n",
    "created_at": "2011-11-21T22:52:08Z",
    "labels": [
        "doctest coverage",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "fix doctesting of .sage files",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11897",
    "user": "jhpalmieri"
}
```
Assignee: mvngu

CC:  leif jdemeyer

Keywords: doctest

Trac #9739 broke doctesting of .sage files (as in `sage -t my_file.sage`).  The attached patch fixes this.

The problem was that before #9739, doctesting `file.sage` produced two Python files: a preparsed version of `file.sage`, and a file with the doctesting framework and the doctests, but not the actual Python/Sage code -- it just included a line like `from file import *`.  In #9739, we missed this, and we just produced one Python file, the second one, so the original Python/Sage code is nowhere to be found, and thus not importable.

At the same time, this patch fixes a small bug in the function `delete_tmpfiles`: the function used to quit completely if it couldn't find some file in the list `tmpfiles`.  Now if if can't find the file, it skips it and goes on to the next one.

Issue created by migration from https://trac.sagemath.org/ticket/12069





---

archive/issue_comments_136316.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-11-21T22:53:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11897#issuecomment-136316",
    "user": "jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_136317.json:
```json
{
    "body": "Could you make a doctest (maybe in `sage/tests/doctest.py`) doing the following:\n\n1. Create a temporary file doctest.sage with some function and a doctest testing that function.  (using [http://docs.python.org/library/tempfile.html#tempfile.NamedTemporaryFile](http://docs.python.org/library/tempfile.html#tempfile.NamedTemporaryFile))\n2. Use `test_executable` from `sage/tests/cmdline.py` to execute `sage -t the_temporary_file_created_in_step_1.sage`.\n3. Check that this executable returned with exit status 0.\n\nAlso, it would be good to update the last section of `doc/en/developer/doctesting.rst`.",
    "created_at": "2011-11-22T14:08:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11897#issuecomment-136317",
    "user": "jdemeyer"
}
```

Could you make a doctest (maybe in `sage/tests/doctest.py`) doing the following:

1. Create a temporary file doctest.sage with some function and a doctest testing that function.  (using [http://docs.python.org/library/tempfile.html#tempfile.NamedTemporaryFile](http://docs.python.org/library/tempfile.html#tempfile.NamedTemporaryFile))
2. Use `test_executable` from `sage/tests/cmdline.py` to execute `sage -t the_temporary_file_created_in_step_1.sage`.
3. Check that this executable returned with exit status 0.

Also, it would be good to update the last section of `doc/en/developer/doctesting.rst`.



---

archive/issue_comments_136318.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-11-22T14:08:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11897#issuecomment-136318",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_136319.json:
```json
{
    "body": "Okay, here are new patches which add documentation to the `sage-doctest` script, update `doc/en/developer/doctesting.rst`, and add doctests to `tests/cmdline.py`.  (Is it okay to add to `cmdline.py` instead of creating a new file `doctest.py`?)",
    "created_at": "2011-11-22T19:39:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11897#issuecomment-136319",
    "user": "jhpalmieri"
}
```

Okay, here are new patches which add documentation to the `sage-doctest` script, update `doc/en/developer/doctesting.rst`, and add doctests to `tests/cmdline.py`.  (Is it okay to add to `cmdline.py` instead of creating a new file `doctest.py`?)



---

archive/issue_comments_136320.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-11-22T19:39:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11897#issuecomment-136320",
    "user": "jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_136321.json:
```json
{
    "body": "scripts repo",
    "created_at": "2011-11-22T19:39:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11897#issuecomment-136321",
    "user": "jhpalmieri"
}
```

scripts repo



---

archive/issue_comments_136322.json:
```json
{
    "body": "Attachment [trac_12069-doctest.patch](tarball://root/attachments/some-uuid/ticket12069/trac_12069-doctest.patch) by jhpalmieri created at 2011-11-22 19:42:31",
    "created_at": "2011-11-22T19:42:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11897#issuecomment-136322",
    "user": "jhpalmieri"
}
```

Attachment [trac_12069-doctest.patch](tarball://root/attachments/some-uuid/ticket12069/trac_12069-doctest.patch) by jhpalmieri created at 2011-11-22 19:42:31



---

archive/issue_comments_136323.json:
```json
{
    "body": "I'd give this a positive review, but for the fact that it won't apply on sage-5.0.beta8 (the problem being with `cmdline.py`).  But patching that file by hand, everything seems to work as it should.\n\nReplying to [comment:3 jhpalmieri]:\n> Is it okay to add to `cmdline.py` instead of creating a new file `doctest.py`?\nIt looks like the sensible place to me.",
    "created_at": "2012-03-21T19:57:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11897#issuecomment-136323",
    "user": "fwclarke"
}
```

I'd give this a positive review, but for the fact that it won't apply on sage-5.0.beta8 (the problem being with `cmdline.py`).  But patching that file by hand, everything seems to work as it should.

Replying to [comment:3 jhpalmieri]:
> Is it okay to add to `cmdline.py` instead of creating a new file `doctest.py`?
It looks like the sensible place to me.



---

archive/issue_comments_136324.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-03-21T19:57:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11897#issuecomment-136324",
    "user": "fwclarke"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_136325.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-03-21T20:06:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11897#issuecomment-136325",
    "user": "jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_136326.json:
```json
{
    "body": "Here's a rebased patch.",
    "created_at": "2012-03-21T20:06:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11897#issuecomment-136326",
    "user": "jhpalmieri"
}
```

Here's a rebased patch.



---

archive/issue_comments_136327.json:
```json
{
    "body": "It's fine now.  Positive review.",
    "created_at": "2012-03-22T09:14:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11897#issuecomment-136327",
    "user": "fwclarke"
}
```

It's fine now.  Positive review.



---

archive/issue_comments_136328.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-03-22T09:14:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11897#issuecomment-136328",
    "user": "fwclarke"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_136329.json:
```json
{
    "body": "Just wondering: why\n\n```\n    sage: ret == 128 \n    True \n```\n\ninstead of the more simple\n\n```\n    sage: ret\n    128\n```\n",
    "created_at": "2012-03-22T09:22:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11897#issuecomment-136329",
    "user": "jdemeyer"
}
```

Just wondering: why

```
    sage: ret == 128 
    True 
```

instead of the more simple

```
    sage: ret
    128
```




---

archive/issue_comments_136330.json:
```json
{
    "body": "I don't think there's a good reason. I'll change it to\n\n```\n    sage: ret\n    128\n```\n\n(Same with a few `ret == 0` tests.)",
    "created_at": "2012-03-22T15:37:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11897#issuecomment-136330",
    "user": "jhpalmieri"
}
```

I don't think there's a good reason. I'll change it to

```
    sage: ret
    128
```

(Same with a few `ret == 0` tests.)



---

archive/issue_comments_136331.json:
```json
{
    "body": "Sage library",
    "created_at": "2012-03-22T15:37:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11897#issuecomment-136331",
    "user": "jhpalmieri"
}
```

Sage library



---

archive/issue_comments_136332.json:
```json
{
    "body": "Attachment [trac_12069-sage.patch](tarball://root/attachments/some-uuid/ticket12069/trac_12069-sage.patch) by jdemeyer created at 2012-03-28 10:04:00",
    "created_at": "2012-03-28T10:04:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11897#issuecomment-136332",
    "user": "jdemeyer"
}
```

Attachment [trac_12069-sage.patch](tarball://root/attachments/some-uuid/ticket12069/trac_12069-sage.patch) by jdemeyer created at 2012-03-28 10:04:00



---

archive/issue_comments_136333.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-03-28T10:04:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11897#issuecomment-136333",
    "user": "jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_136334.json:
```json
{
    "body": "See #12805 for a follow-up, fixing left-over `tmp/` subdirectories which prohibited the deletion of otherwise empty temporary doctesting directories.",
    "created_at": "2012-04-03T22:12:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11897#issuecomment-136334",
    "user": "leif"
}
```

See #12805 for a follow-up, fixing left-over `tmp/` subdirectories which prohibited the deletion of otherwise empty temporary doctesting directories.



---

archive/issue_comments_136335.json:
```json
{
    "body": "Thanks for fixing this! That was a pain in the neck.",
    "created_at": "2012-04-09T20:00:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11897",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11897#issuecomment-136335",
    "user": "nthiery"
}
```

Thanks for fixing this! That was a pain in the neck.
