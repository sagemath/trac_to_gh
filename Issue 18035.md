# Issue 18035: unset MACOSX_DEPLOYMENT_TARGET, rather than sometimes setting a bogus value

Issue created by migration from Trac.

Original creator: github/bukzor

Original creation time: 2015-04-21 17:45:51

CC:  fbissey

See: http://trac.sagemath.org/ticket/18254#comment:32

https://github.com/sagemath/sage/pull/38


---

Comment by github created at 2015-04-21 17:45:52

Changing status from new to needs_review.


---

Comment by git created at 2015-04-21 17:46:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kcrisman created at 2015-05-12 19:26:09

Changing component from PLEASE CHANGE to porting.


---

Comment by kcrisman created at 2015-05-12 19:26:09

Changing type from PLEASE CHANGE to defect.


---

Comment by jhpalmieri created at 2015-05-13 00:28:33

Given [http://trac.sagemath.org/ticket/18254#comment:43](http://trac.sagemath.org/ticket/18254#comment:43), this needs to be at least "needs work", if not "wontfix": it doesn't address the issues at #7095 which resulted in setting `MACOSX_DEPLOYMENT_TARGET`.


---

Comment by jhpalmieri created at 2015-05-13 00:28:33

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2019-11-23 16:03:54

old stuff, do you agree that this can be closed ?


---

Comment by chapoton created at 2019-11-23 16:03:54

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2019-11-23 19:44:14

We need to keep setting `MACOSX_DEPLOYMENT_TARGET`: I just build Sage without, and I hit the docteset failures mentioned at #18524. Is it worth keeping this ticket around to remind us to check? It is a little strange to be using `MACOSX_DEPLOYMENT_TARGET=10.9` with a much later version of OS X.


---

Comment by kcrisman created at 2019-11-24 02:58:31

Regarding the latter comment, this is from [this commit](https://github.com/sagemath/sage/commit/d3f5e995393794d56bc73bd05faebfaa784a2afe) which says

```
        # various packages have still have issues with
        # two digit OS X versions
```

rather than something about libtool.  Unfortunately I couldn't find the ticket this was from.  Did the packages which cause problems along these lines ever get enumerated?  The ones listed at ticket:17204, reviewed by none other than jhpalmieri, seem to all have to do with `libtool`.   (Though I get 

```
$ libtool -V
Apple Inc. version cctools-886
```

so who knows whether the bug is fixed there.)  Anyway, it could be worth testing whether setting sane deployments now works for 10.12, say.


---

Comment by jhpalmieri created at 2019-11-25 23:29:33

Right now I have access to computers running OS X 10.14 and 10.15. On both, using `MACOSX_DEPLOYMENT_TARGET=10.14` works, while `10.15` fails. (`MACOSX_VERSION` is 18 or 19 on these machines, so the formula `MACOSX_DEPLOYMENT_TARGET=10.$[$MACOSX_VERSION-4]` (which we only use if `MACOSX_VERSION` is 13 or lower) wouldn't work in this case. But maybe we could bump it up to 10.14.

When I says that `10.15` fails, I mean that it leads to a lot of doctest failures. I think that they all arise from `pari`, so I'm testing to see if we can just set `MACOSX_DEPLOYMENT_TARGET` for `pari`, not globally. 

Either approach would have to be tested on older versions of OS X, though.


---

Comment by jhpalmieri created at 2019-11-26 23:34:58

To confirm: I can set `MACOSX_DEPLOYMENT_TARGET` just in the `spkg-install` file for `pari`, not globally. I am having problems debugging this from the `pari` end, though: I can build `pari` on its own without setting `MACOSX_DEPLOYMENT_TARGET` just fine.


---

Comment by mkoeppe created at 2020-01-15 21:00:39

We should get rid of this - after 4+ years.

```
if [ $MACOSX_VERSION -ge 14 ]; then
    # various packages have still have issues with
    # two digit OS X versions
    MACOSX_DEPLOYMENT_TARGET=10.9
```

Moreover, there should be a way for the user to override it (as noted already on #16312).


---

Comment by mkoeppe created at 2020-01-15 21:00:39

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by jhpalmieri created at 2021-02-04 04:05:28

Here is a branch, only tested so far on OS X Big Sur. Sage builds for me with its own Python, with homebrew's Python, or with the system `/usr/bin/python3`. Doctests pass (except for unrelated errors) with the first two; with `/usr/bin/python3`, I get a lot of failures because of messages

```
ld: warning: dylib (/usr/local/lib/libmpfr.dylib) was built for newer macOS version (11.0) than being linked (10.14.6)
```

(Significantly, those messages are not printed in the first two cases, which is a good sign.)


---

Comment by jhpalmieri created at 2021-02-04 04:06:48

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2021-02-04 04:06:48

Changing component from porting to packages: standard.


---

Comment by jhpalmieri created at 2021-02-04 04:06:48

Last 10 new commits:


---

Comment by jhpalmieri created at 2021-02-04 04:13:36

Only the last commit is for this ticket; the rest come from #31227.


---

Comment by jhpalmieri created at 2021-02-04 19:05:49

Replying to [comment:13 jhpalmieri]:
> Here is a branch, only tested so far on OS X Big Sur. Sage builds for me with its own Python, with homebrew's Python, or with the system `/usr/bin/python3`. Doctests pass (except for unrelated errors) with the first two; with `/usr/bin/python3`, I get a lot of failures because of messages
> {{{
> ld: warning: dylib (/usr/local/lib/libmpfr.dylib) was built for newer macOS version (11.0) than being linked (10.14.6)
> }}}
> (Significantly, those messages are not printed in the first two cases, which is a good sign.)

I have the same experience with Catalina. On both Big Sur and Catalina, I can avoid the doctest failures by using

```
% MACOSX_DEPLOYMENT_TARGET=X make ptestlong
```

where `X` is a suitable number for the operating system (either 11.0 or 10.15).

I do not have access to any older versions of the MacOS.


---

Comment by chapoton created at 2021-03-22 15:52:53

red branch => needs work


---

Comment by chapoton created at 2021-03-22 15:52:53

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-03-23 00:11:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-03-23 00:50:23

Rebased.


---

Comment by jhpalmieri created at 2021-03-23 00:50:30

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2021-03-23 00:59:30

It appears that there is still one instance of `MACOSX_DEPLOYMENT_TARGET` in `built/pkgs/scipy/spkg-install.in`. I don't think it is on purpose.


---

Comment by mkoeppe created at 2021-03-23 01:06:06

#31326?


---

Comment by fbissey created at 2021-03-23 01:07:31

Replying to [comment:26 mkoeppe]:
> #31326?

That'll do. Should it be in the summary for completness?


---

Comment by mkoeppe created at 2021-03-27 00:22:08

Another approach would be to use the `MACOSX_DEPLOYMENT_TARGET` that the configured system `python3` uses, because that's a lower bound for the target that we can build for using that Python. 

This can be obtained by `python3 -m sysconfig | grep MACOSX_DEPLOYMENT_TARGET`. (See also #31567)


---

Comment by jhpalmieri created at 2021-03-29 01:28:36

If we're not building a `bdist`, why should we have to set `MACOSX_DEPLOYMENT_TARGET` at all? My recollection is that we did this to work around some bugs in various spkgs, but if we can build without setting it, shouldn't we?


---

Comment by mkoeppe created at 2021-03-29 01:51:27

I agree, for normal builds, not setting `MACOSX_DEPLOYMENT_TARGET` at all will be fine.

This ticket would need to go through testing on all supported platforms again -- do you want this change in 9.3?


---

Comment by jhpalmieri created at 2021-03-29 02:04:54

9.4 is a fine milestone. It's been a problem for so long that it is not crucial to fix it right away.


---

Comment by mkoeppe created at 2021-05-08 15:57:14

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-05-27 20:30:38

Resolution: fixed
