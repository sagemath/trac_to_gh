# Issue 10123: Graph drawing has issues with edge labels

archive/issues_010123.json:
```json
{
    "body": "Assignee: jason, ncohen, rlm\n\nCC:  jason\n\nKeywords: graph drawing, edge labels\n\nThe following code should produce a drawing of the\nFrucht graph with edges labeled 0 upto 17.\nHowever, labels 16 and 17 are missing, while\n15 is misplaced. The edge labels are set correctly\n(as the last line shows), they only don't show up.\nThe weird thing is that other graphs work OK (at least those I tried).\n\n{{\nsage:   G=graphs.FruchtGraph()\nsage:   E=G.edges()\nsage:   for i in range(len(E)):\n....:           G.set_edge_label(E[i][0],E[i][1],i)\n....:\nsage:   G.show(edge_labels=True)\nsage:   print G.edges()\n}}\n\nIt seems it happens rather rarely, so I'm not sure if it's \nan issue with this graph's constructor or with the graph drawing\nalgorithm. Anyway, it would be nice to have this feature reliable, \nI find it very useful.\n\nIssue created by migration from https://trac.sagemath.org/ticket/10124\n\n",
    "created_at": "2010-10-12T22:49:06Z",
    "labels": [
        "graph theory",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7",
    "title": "Graph drawing has issues with edge labels",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10123",
    "user": "rs"
}
```
Assignee: jason, ncohen, rlm

CC:  jason

Keywords: graph drawing, edge labels

The following code should produce a drawing of the
Frucht graph with edges labeled 0 upto 17.
However, labels 16 and 17 are missing, while
15 is misplaced. The edge labels are set correctly
(as the last line shows), they only don't show up.
The weird thing is that other graphs work OK (at least those I tried).

{{
sage:   G=graphs.FruchtGraph()
sage:   E=G.edges()
sage:   for i in range(len(E)):
....:           G.set_edge_label(E[i][0],E[i][1],i)
....:
sage:   G.show(edge_labels=True)
sage:   print G.edges()
}}

It seems it happens rather rarely, so I'm not sure if it's 
an issue with this graph's constructor or with the graph drawing
algorithm. Anyway, it would be nice to have this feature reliable, 
I find it very useful.

Issue created by migration from https://trac.sagemath.org/ticket/10124





---

archive/issue_comments_102278.json:
```json
{
    "body": "Attachment [trac_10124_fix_edge_label_locations.patch](tarball://root/attachments/some-uuid/ticket10124/trac_10124_fix_edge_label_locations.patch) by dsm created at 2011-02-27 04:25:40",
    "created_at": "2011-02-27T04:25:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10123#issuecomment-102278",
    "user": "dsm"
}
```

Attachment [trac_10124_fix_edge_label_locations.patch](tarball://root/attachments/some-uuid/ticket10124/trac_10124_fix_edge_label_locations.patch) by dsm created at 2011-02-27 04:25:40



---

archive/issue_comments_102279.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-02-27T04:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10123#issuecomment-102279",
    "user": "dsm"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_102280.json:
```json
{
    "body": "This turns out to be because the edge label locations are computed by\n\n\n```\n[(self._pos[a][0]+self._pos[b][0])/2, (self._pos[a][1]+self._pos[b][1])/2]\n```\n\n\nso if the positions are Python integers (as happens for many of the graphs in graph_generators.py), the\ndivisions will truncate and the labels wind up in the wrong locations.\n\nThis can be fixed by replacing 2 with 2., but that's pretty fragile, as there are other instances in graph_plot.py\nwhere it looks like the same problem can occur:\n\n\n```\n                    p1 = self._pos[a]\n                    p2 = self._pos[b]\n                    M = ((p1[0]+p2[0])/2, (p1[1]+p2[1])/2) # midpoint\n                    if not p1[1] == p2[1]:\n                        S = (p1[0]-p2[0])/(p2[1]-p1[1]) # perp slope\n```\n\n\nMoreover, since the user could be using a custom layout method, we\ncan't guarantee that the positions are floats on that side.  So it\nseems the most robust solution is to ensure that _pos contains\nfloats in graph_plot itself.  This only takes between 1-10 ms for a graph\nwith 1000 nodes which takes seconds to plot, so the added time is\nnegligible.\n\nI've attached a patch which\n\n(1) modifies set_pos, which is always called by GraphPlot.__init__, to ensure\nthat _pos contains float values; this suffices to handle both the\noriginal case and some related multiedge bugs\n\n(2) float-protects real divisions throughout the file (some are\ngenuinely integer divisions meant to be truncating,\ne.g. len(local_labels)/2, where dealing with the possible remainder of\n1 is handled explicitly), even where I don't know for certain that \nthere's a realized path which could break.  This way even if _pos\nwere somehow changed after construction, set_edges would still behave\nas intended.\n\n(3) adds doctests to set_pos, set_edges, and\n_polar_hack_for_multidigraph to verify the new behaviour.  Coming up\nwith a doctest for set_edges was a bit of a challenge, so if there's\na more natural way to do the test it should probably be replaced.\n\n(4) fixes a typo.\n\nThe patch passes all tests in graphs and beneath; am running testall long now.",
    "created_at": "2011-02-27T04:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10123#issuecomment-102280",
    "user": "dsm"
}
```

This turns out to be because the edge label locations are computed by


```
[(self._pos[a][0]+self._pos[b][0])/2, (self._pos[a][1]+self._pos[b][1])/2]
```


so if the positions are Python integers (as happens for many of the graphs in graph_generators.py), the
divisions will truncate and the labels wind up in the wrong locations.

This can be fixed by replacing 2 with 2., but that's pretty fragile, as there are other instances in graph_plot.py
where it looks like the same problem can occur:


```
                    p1 = self._pos[a]
                    p2 = self._pos[b]
                    M = ((p1[0]+p2[0])/2, (p1[1]+p2[1])/2) # midpoint
                    if not p1[1] == p2[1]:
                        S = (p1[0]-p2[0])/(p2[1]-p1[1]) # perp slope
```


Moreover, since the user could be using a custom layout method, we
can't guarantee that the positions are floats on that side.  So it
seems the most robust solution is to ensure that _pos contains
floats in graph_plot itself.  This only takes between 1-10 ms for a graph
with 1000 nodes which takes seconds to plot, so the added time is
negligible.

I've attached a patch which

(1) modifies set_pos, which is always called by GraphPlot.__init__, to ensure
that _pos contains float values; this suffices to handle both the
original case and some related multiedge bugs

(2) float-protects real divisions throughout the file (some are
genuinely integer divisions meant to be truncating,
e.g. len(local_labels)/2, where dealing with the possible remainder of
1 is handled explicitly), even where I don't know for certain that 
there's a realized path which could break.  This way even if _pos
were somehow changed after construction, set_edges would still behave
as intended.

(3) adds doctests to set_pos, set_edges, and
_polar_hack_for_multidigraph to verify the new behaviour.  Coming up
with a doctest for set_edges was a bit of a challenge, so if there's
a more natural way to do the test it should probably be replaced.

(4) fixes a typo.

The patch passes all tests in graphs and beneath; am running testall long now.



---

archive/issue_comments_102281.json:
```json
{
    "body": "Replying to [comment:3 dsm]:\n\n> The patch passes all tests in graphs and beneath; am running testall long now.\n\nWorks for me with 4.6.2.rc0.  Still have the usual \"Detected SAGE64\" noise, etc., but no new failures.",
    "created_at": "2011-02-27T12:38:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10123#issuecomment-102281",
    "user": "dsm"
}
```

Replying to [comment:3 dsm]:

> The patch passes all tests in graphs and beneath; am running testall long now.

Works for me with 4.6.2.rc0.  Still have the usual "Detected SAGE64" noise, etc., but no new failures.



---

archive/issue_comments_102282.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-03-27T10:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10123#issuecomment-102282",
    "user": "ncohen"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_102283.json:
```json
{
    "body": "Hello ! `:-)`\n\nThis can get in as soon as you can add another semicolumn at the end of \n\n```\nin some cases where they weren't due to truncating division (trac #10124): \n```\n\n\nNathann",
    "created_at": "2011-03-27T10:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10123#issuecomment-102283",
    "user": "ncohen"
}
```

Hello ! `:-)`

This can get in as soon as you can add another semicolumn at the end of 

```
in some cases where they weren't due to truncating division (trac #10124): 
```


Nathann



---

archive/issue_comments_102284.json:
```json
{
    "body": "Aargh, these colons will be the death of me.\u00a0 But it looks like there are a lot of colon problems: there are several \"EXAMPLE:\" / \"EXAMPLES:\" cases with code immediately after, and shouldn't those have two as well?",
    "created_at": "2011-03-30T06:54:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10123#issuecomment-102284",
    "user": "dsm"
}
```

Aargh, these colons will be the death of me.  But it looks like there are a lot of colon problems: there are several "EXAMPLE:" / "EXAMPLES:" cases with code immediately after, and shouldn't those have two as well?



---

archive/issue_comments_102285.json:
```json
{
    "body": "Replying to [comment:6 dsm]:\n> Aargh, these colons will be the death of me.\u00a0 But it looks like there are a lot of colon problems: there are several \"EXAMPLE:\" / \"EXAMPLES:\" cases with code immediately after, and shouldn't those have two as well?  \n\nYep, each time you have some code there should be a double column before. If not, it does not appear nicely in the documentation when you build it\n\n```\nsage -docbuild reference html\n```\n\nthough I think they are still tested by ``sage -t``...  If you feel like fixing those you meet..... `:-)`\n\nNathann",
    "created_at": "2011-03-30T09:20:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10123#issuecomment-102285",
    "user": "ncohen"
}
```

Replying to [comment:6 dsm]:
> Aargh, these colons will be the death of me.  But it looks like there are a lot of colon problems: there are several "EXAMPLE:" / "EXAMPLES:" cases with code immediately after, and shouldn't those have two as well?  

Yep, each time you have some code there should be a double column before. If not, it does not appear nicely in the documentation when you build it

```
sage -docbuild reference html
```

though I think they are still tested by ``sage -t``...  If you feel like fixing those you meet..... `:-)`

Nathann



---

archive/issue_comments_102286.json:
```json
{
    "body": "version with (hopefully) fixed colons",
    "created_at": "2011-04-06T14:31:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10123#issuecomment-102286",
    "user": "dsm"
}
```

version with (hopefully) fixed colons



---

archive/issue_comments_102287.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-04-06T15:04:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10123#issuecomment-102287",
    "user": "dsm"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_102288.json:
```json
{
    "body": "Attachment [trac_10124_fix_edge_label_locations_v2.patch](tarball://root/attachments/some-uuid/ticket10124/trac_10124_fix_edge_label_locations_v2.patch) by dsm created at 2011-04-06 15:04:23",
    "created_at": "2011-04-06T15:04:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10123#issuecomment-102288",
    "user": "dsm"
}
```

Attachment [trac_10124_fix_edge_label_locations_v2.patch](tarball://root/attachments/some-uuid/ticket10124/trac_10124_fix_edge_label_locations_v2.patch) by dsm created at 2011-04-06 15:04:23



---

archive/issue_comments_102289.json:
```json
{
    "body": "Theeeeeeeeen it's good to go `:-)`\n\nNathann",
    "created_at": "2011-04-06T15:21:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10123#issuecomment-102289",
    "user": "ncohen"
}
```

Theeeeeeeeen it's good to go `:-)`

Nathann



---

archive/issue_comments_102290.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-04-06T15:21:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10123#issuecomment-102290",
    "user": "ncohen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_102291.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-04-13T15:17:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10123",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10123#issuecomment-102291",
    "user": "jdemeyer"
}
```

Resolution: fixed
