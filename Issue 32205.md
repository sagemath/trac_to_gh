# Issue 32205: ./configure: Make --with-sage-venv the default

archive/issues_032205.json:
```json
{
    "body": "CC:  @dimpase @jhpalmieri\n\nSince Sage 9.4, it is possible to use an installation tree for Python packages separate from SAGE_LOCAL:\nhttps://wiki.sagemath.org/ReleaseTours/sage-9.4#For_developers:_..2Fconfigure_--prefix.3DSAGE_LOCAL_--with-sage-venv.3DSAGE_VENV\n\nIn this ticket we make `--with-sage-venv[=yes]` the default, which will mean:\n- set `SAGE_VENV` to `SAGE_LOCAL/var/lib/sage/venv-PYTHONVERSION`\n\n  By keying the name to the Python version, we ensure that if the system python version changes, we create a fresh venv and automatically rebuild all Python packages, eliminating problems such as the one reported in https://groups.google.com/g/sage-devel/c/hZPHxqn_Cyk/m/fOAZCUWHAQAJ\n\n- at `config.status` time, create a symbolic link `SAGE_ROOT/venv -> SAGE_VENV` (overwriting an existing symbolic link)\n\n  The link is for easy access by users and is not used otherwise. Instead of `local/lib/python3/site-packages/` or `local/bin/sage`, use `venv/local/lib/python3/site-packages/` etc.\n\n  For symmetry, we also create a symbolic link `SAGE_ROOT/prefix -> SAGE_LOCAL`. (This generalizes what is already done by `tox local`.)\n\nUsers will still be able to restore the previous behavior by using `--with-sage-venv=no`, or use a specific path as in `--with-sage-venv=/path/to/venv`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/32442\n\n",
    "created_at": "2021-08-31T19:59:32Z",
    "labels": [
        "component: build: configure"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "./configure: Make --with-sage-venv the default",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32205",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @dimpase @jhpalmieri

Since Sage 9.4, it is possible to use an installation tree for Python packages separate from SAGE_LOCAL:
https://wiki.sagemath.org/ReleaseTours/sage-9.4#For_developers:_..2Fconfigure_--prefix.3DSAGE_LOCAL_--with-sage-venv.3DSAGE_VENV

In this ticket we make `--with-sage-venv[=yes]` the default, which will mean:
- set `SAGE_VENV` to `SAGE_LOCAL/var/lib/sage/venv-PYTHONVERSION`

  By keying the name to the Python version, we ensure that if the system python version changes, we create a fresh venv and automatically rebuild all Python packages, eliminating problems such as the one reported in https://groups.google.com/g/sage-devel/c/hZPHxqn_Cyk/m/fOAZCUWHAQAJ

- at `config.status` time, create a symbolic link `SAGE_ROOT/venv -> SAGE_VENV` (overwriting an existing symbolic link)

  The link is for easy access by users and is not used otherwise. Instead of `local/lib/python3/site-packages/` or `local/bin/sage`, use `venv/local/lib/python3/site-packages/` etc.

  For symmetry, we also create a symbolic link `SAGE_ROOT/prefix -> SAGE_LOCAL`. (This generalizes what is already done by `tox local`.)

Users will still be able to restore the previous behavior by using `--with-sage-venv=no`, or use a specific path as in `--with-sage-venv=/path/to/venv`.

Issue created by migration from https://trac.sagemath.org/ticket/32442





---

archive/issue_comments_459568.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-09-11T03:33:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459568",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_459569.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-09-11T03:33:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459569",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_459570.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-15T23:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459570",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_459571.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-16T00:30:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459571",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_459572.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-27T04:15:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459572",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_459573.json:
```json
{
    "body": "After running `make distclean && ./configure`:\n\n```\n% git status\nOn branch t/32442/__configure__make___with_sage_venv_the_default\nYour branch is up to date with 'trac/u/mkoeppe/__configure__make___with_sage_venv_the_default'.\n\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n\tvenv\n\nnothing added to commit but untracked files present (use \"git add\" to track)\n```\n",
    "created_at": "2021-09-27T20:34:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459573",
    "user": "https://github.com/jhpalmieri"
}
```

After running `make distclean && ./configure`:

```
% git status
On branch t/32442/__configure__make___with_sage_venv_the_default
Your branch is up to date with 'trac/u/mkoeppe/__configure__make___with_sage_venv_the_default'.

Untracked files:
  (use "git add <file>..." to include in what will be committed)
	venv

nothing added to commit but untracked files present (use "git add" to track)
```




---

archive/issue_comments_459574.json:
```json
{
    "body": "Oh, and `venv` is a symlink pointing to `local`.",
    "created_at": "2021-09-27T20:35:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459574",
    "user": "https://github.com/jhpalmieri"
}
```

Oh, and `venv` is a symlink pointing to `local`.



---

archive/issue_comments_459575.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-27T20:49:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459575",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_459576.json:
```json
{
    "body": "Thanks for catching this!",
    "created_at": "2021-09-27T20:49:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459576",
    "user": "https://github.com/mkoeppe"
}
```

Thanks for catching this!



---

archive/issue_comments_459577.json:
```json
{
    "body": "Replying to [comment:12 jhpalmieri]:\n> Oh, and `venv` is a symlink pointing to `local`.\n\nYes, in an incremental build, nothing should change (except that this symlink is created).\n\nAfter a `make distclean`, the new behavior will show",
    "created_at": "2021-09-27T20:51:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459577",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:12 jhpalmieri]:
> Oh, and `venv` is a symlink pointing to `local`.

Yes, in an incremental build, nothing should change (except that this symlink is created).

After a `make distclean`, the new behavior will show



---

archive/issue_comments_459578.json:
```json
{
    "body": "Oh, now I see that you said you did `make distclean`...",
    "created_at": "2021-09-27T20:52:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459578",
    "user": "https://github.com/mkoeppe"
}
```

Oh, now I see that you said you did `make distclean`...



---

archive/issue_comments_459579.json:
```json
{
    "body": "Maybe this has been going on with `venv` builds for a while, but the symlinks look messed up to me: my `local` directory looks like\n\n```\n% ls -l local\ntotal 0\ndrwxr-xr-x  148 jpalmier  staff  4736 Sep 27 16:21 bin\ndrwxr-xr-x    2 jpalmier  staff    64 Sep 27 16:09 etc\ndrwxr-xr-x   47 jpalmier  staff  1504 Sep 27 16:21 include\ndrwxr-xr-x   73 jpalmier  staff  2336 Sep 27 16:44 lib\nlrwxr-xr-x    1 jpalmier  staff     3 Sep 27 16:09 lib64 -> lib\ndrwxr-xr-x    4 jpalmier  staff   128 Sep 27 16:21 libexec\nlrwxr-xr-x    1 jpalmier  staff     5 Sep 27 16:09 local -> local\ndrwxr-xr-x   34 jpalmier  staff  1088 Sep 27 16:21 share\ndrwxr-xr-x    5 jpalmier  staff   160 Sep 27 16:13 var\nlrwxr-xr-x    1 jpalmier  staff    33 Sep 27 16:09 venv-python3.9 -> local/var/lib/sage/venv-python3.9\n```\n\nIn particular, `local/local` points to itself, and so `venv-python3.9` doesn't point anywhere. `venv-python3.9` should probably point to `../local/....`. I don't know what the `local` symlink is supposed to do.\n\nEverything still builds, so this is obviously not crucial, but it doesn't look right.",
    "created_at": "2021-09-28T17:06:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459579",
    "user": "https://github.com/jhpalmieri"
}
```

Maybe this has been going on with `venv` builds for a while, but the symlinks look messed up to me: my `local` directory looks like

```
% ls -l local
total 0
drwxr-xr-x  148 jpalmier  staff  4736 Sep 27 16:21 bin
drwxr-xr-x    2 jpalmier  staff    64 Sep 27 16:09 etc
drwxr-xr-x   47 jpalmier  staff  1504 Sep 27 16:21 include
drwxr-xr-x   73 jpalmier  staff  2336 Sep 27 16:44 lib
lrwxr-xr-x    1 jpalmier  staff     3 Sep 27 16:09 lib64 -> lib
drwxr-xr-x    4 jpalmier  staff   128 Sep 27 16:21 libexec
lrwxr-xr-x    1 jpalmier  staff     5 Sep 27 16:09 local -> local
drwxr-xr-x   34 jpalmier  staff  1088 Sep 27 16:21 share
drwxr-xr-x    5 jpalmier  staff   160 Sep 27 16:13 var
lrwxr-xr-x    1 jpalmier  staff    33 Sep 27 16:09 venv-python3.9 -> local/var/lib/sage/venv-python3.9
```

In particular, `local/local` points to itself, and so `venv-python3.9` doesn't point anywhere. `venv-python3.9` should probably point to `../local/....`. I don't know what the `local` symlink is supposed to do.

Everything still builds, so this is obviously not crucial, but it doesn't look right.



---

archive/issue_comments_459580.json:
```json
{
    "body": "Yes, that doesn't look right. Could you post `config.log` please?",
    "created_at": "2021-09-28T17:09:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459580",
    "user": "https://github.com/mkoeppe"
}
```

Yes, that doesn't look right. Could you post `config.log` please?



---

archive/issue_comments_459581.json:
```json
{
    "body": "Attachment [config.log](tarball://root/attachments/some-uuid/ticket32442/config.log) by @jhpalmieri created at 2021-09-28 17:10:59",
    "created_at": "2021-09-28T17:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459581",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [config.log](tarball://root/attachments/some-uuid/ticket32442/config.log) by @jhpalmieri created at 2021-09-28 17:10:59



---

archive/issue_comments_459582.json:
```json
{
    "body": "This was after `make distclean && ./configure && make ptestlong`.",
    "created_at": "2021-09-28T17:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459582",
    "user": "https://github.com/jhpalmieri"
}
```

This was after `make distclean && ./configure && make ptestlong`.



---

archive/issue_comments_459583.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-28T20:37:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459583",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_459584.json:
```json
{
    "body": "Try with this version please",
    "created_at": "2021-09-28T20:38:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459584",
    "user": "https://github.com/mkoeppe"
}
```

Try with this version please



---

archive/issue_comments_459585.json:
```json
{
    "body": "I've started, and I now only see one symlink in `local`: `lib64 -> lib`. At the top level, I see `prefix -> local` and `venv -> local/var/lib/sage/venv-python3.9`.\n\nBy the way, `make distclean` should probably remove the top-level symlink `venv`. As it is, running `make distclean` first runs `./configure` (at least some of the time) which creates `venv`.",
    "created_at": "2021-09-28T20:56:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459585",
    "user": "https://github.com/jhpalmieri"
}
```

I've started, and I now only see one symlink in `local`: `lib64 -> lib`. At the top level, I see `prefix -> local` and `venv -> local/var/lib/sage/venv-python3.9`.

By the way, `make distclean` should probably remove the top-level symlink `venv`. As it is, running `make distclean` first runs `./configure` (at least some of the time) which creates `venv`.



---

archive/issue_comments_459586.json:
```json
{
    "body": "`make distclean` should also remove `prefix`.",
    "created_at": "2021-09-28T20:59:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459586",
    "user": "https://github.com/jhpalmieri"
}
```

`make distclean` should also remove `prefix`.



---

archive/issue_comments_459587.json:
```json
{
    "body": "Replying to [comment:22 jhpalmieri]:\n> I've started, and I now only see one symlink in `local`: `lib64 -> lib`. At the top level, I see `prefix -> local` and `venv -> local/var/lib/sage/venv-python3.9`.\n\nGreat, this is the intended layout.",
    "created_at": "2021-09-28T22:15:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459587",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:22 jhpalmieri]:
> I've started, and I now only see one symlink in `local`: `lib64 -> lib`. At the top level, I see `prefix -> local` and `venv -> local/var/lib/sage/venv-python3.9`.

Great, this is the intended layout.



---

archive/issue_comments_459588.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-28T22:21:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459588",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_459589.json:
```json
{
    "body": "How is it decided which documentation goes in `local/share/doc` and which goes in `venv/share/doc`? For example, `pplpy` and `sage` are `local/share/doc`, although their corresponding installation files are in `venv/var/lib/sage/installed`.",
    "created_at": "2021-09-29T03:42:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459589",
    "user": "https://github.com/jhpalmieri"
}
```

How is it decided which documentation goes in `local/share/doc` and which goes in `venv/share/doc`? For example, `pplpy` and `sage` are `local/share/doc`, although their corresponding installation files are in `venv/var/lib/sage/installed`.



---

archive/issue_comments_459590.json:
```json
{
    "body": "I haven't really paid attention to the documentation. There is no attempt to actively install documentation in `venv`. The installation of the documentation is not really done by these Python packages themselves but rather by our Sage-specific install scripts. `build/pkgs/pplpy/spkg-postinst.in` directly refers to `SAGE_SHARE` (= `local/share`) for the installation location. I'd say a more systematic consideration of this issue would be something for #29868.",
    "created_at": "2021-09-29T04:11:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459590",
    "user": "https://github.com/mkoeppe"
}
```

I haven't really paid attention to the documentation. There is no attempt to actively install documentation in `venv`. The installation of the documentation is not really done by these Python packages themselves but rather by our Sage-specific install scripts. `build/pkgs/pplpy/spkg-postinst.in` directly refers to `SAGE_SHARE` (= `local/share`) for the installation location. I'd say a more systematic consideration of this issue would be something for #29868.



---

archive/issue_comments_459591.json:
```json
{
    "body": "On the other hand, `networkx` and `sagetex` put their docs in the venv location. Not a big deal and we can certainly deal with it on another ticket.",
    "created_at": "2021-09-29T16:20:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459591",
    "user": "https://github.com/jhpalmieri"
}
```

On the other hand, `networkx` and `sagetex` put their docs in the venv location. Not a big deal and we can certainly deal with it on another ticket.



---

archive/issue_comments_459592.json:
```json
{
    "body": "Thanks for investigating. These two Python packages install their documentation by themselves on `setup.py install` (and similar), we are not doing anything Sage-specific there. Perhaps at some point we'll get around to moving #27164 forward...",
    "created_at": "2021-09-29T16:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459592",
    "user": "https://github.com/mkoeppe"
}
```

Thanks for investigating. These two Python packages install their documentation by themselves on `setup.py install` (and similar), we are not doing anything Sage-specific there. Perhaps at some point we'll get around to moving #27164 forward...



---

archive/issue_comments_459593.json:
```json
{
    "body": "Can you explain the change in `Makefile.in`? In what circumstances would the package tree directory not exist?",
    "created_at": "2021-09-29T22:13:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459593",
    "user": "https://github.com/jhpalmieri"
}
```

Can you explain the change in `Makefile.in`? In what circumstances would the package tree directory not exist?



---

archive/issue_comments_459594.json:
```json
{
    "body": "I think that `./configure --help` should be changed from\n\n```\n  --with-sage-venv={auto,yes,no,SAGE_VENV}\n```\n\nto\n\n```\n  --with-sage-venv={auto (default),yes,no,SAGE_VENV}\n```\n",
    "created_at": "2021-09-29T22:13:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459594",
    "user": "https://github.com/jhpalmieri"
}
```

I think that `./configure --help` should be changed from

```
  --with-sage-venv={auto,yes,no,SAGE_VENV}
```

to

```
  --with-sage-venv={auto (default),yes,no,SAGE_VENV}
```




---

archive/issue_comments_459595.json:
```json
{
    "body": "In this line from configure.ac:\n\n```\n    eval SAGE_VENV=\"$SAGE_VENV\"dnl eval so as to evaluate the embedded ${SAGE_LOCAL}\n```\n\nthe placement of `dnl...` doesn't fit the style of the rest of the file. I honestly don't care. Is there any point to change it?",
    "created_at": "2021-09-29T22:15:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459595",
    "user": "https://github.com/jhpalmieri"
}
```

In this line from configure.ac:

```
    eval SAGE_VENV="$SAGE_VENV"dnl eval so as to evaluate the embedded ${SAGE_LOCAL}
```

the placement of `dnl...` doesn't fit the style of the rest of the file. I honestly don't care. Is there any point to change it?



---

archive/issue_comments_459596.json:
```json
{
    "body": "Replying to [comment:30 jhpalmieri]:\n> Can you explain the change in `Makefile.in`? In what circumstances would the package tree directory not exist?\n\nRunning `make SCRIPTPACKAGE-clean` or `./sage -f SCRIPTPACKAGE` right after running `./configure` (or before any package is installed into the venv)",
    "created_at": "2021-09-29T22:18:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459596",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:30 jhpalmieri]:
> Can you explain the change in `Makefile.in`? In what circumstances would the package tree directory not exist?

Running `make SCRIPTPACKAGE-clean` or `./sage -f SCRIPTPACKAGE` right after running `./configure` (or before any package is installed into the venv)



---

archive/issue_comments_459597.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-29T22:24:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459597",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_459598.json:
```json
{
    "body": "Replying to [comment:32 jhpalmieri]:\n> the placement of `dnl...` doesn't fit the style of the rest of the file. I honestly don't care. Is there any point to change it?\nIt's correct as is, to suppress unnecessary whitespace in the generated file. There are lots of other places in our autoconf scripts that are not quite so careful about this, in the end it does not matter so much",
    "created_at": "2021-09-29T22:26:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459598",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:32 jhpalmieri]:
> the placement of `dnl...` doesn't fit the style of the rest of the file. I honestly don't care. Is there any point to change it?
It's correct as is, to suppress unnecessary whitespace in the generated file. There are lots of other places in our autoconf scripts that are not quite so careful about this, in the end it does not matter so much



---

archive/issue_comments_459599.json:
```json
{
    "body": "I think this is ready to go, but I will ask one more question \u2014\u00a0probably not a question for this ticket, just a general venv question: how do I use a venv? I built Sage using homebrew's Python 3.9, and I wanted to see what happened with /usr/bin/python3, which is version 3.8. But just doing `./configure --with-python=/usr/bin/python3` doesn't accomplish anything because `local/bin/python3` is still a symlink pointing to homebrew's Python. What do I need to do to convince Sage to use a different Python, therefore creating a different `venv`, while keeping the other `venv`? Do I need to manually remove the Python symlink?",
    "created_at": "2021-09-29T23:11:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459599",
    "user": "https://github.com/jhpalmieri"
}
```

I think this is ready to go, but I will ask one more question — probably not a question for this ticket, just a general venv question: how do I use a venv? I built Sage using homebrew's Python 3.9, and I wanted to see what happened with /usr/bin/python3, which is version 3.8. But just doing `./configure --with-python=/usr/bin/python3` doesn't accomplish anything because `local/bin/python3` is still a symlink pointing to homebrew's Python. What do I need to do to convince Sage to use a different Python, therefore creating a different `venv`, while keeping the other `venv`? Do I need to manually remove the Python symlink?



---

archive/issue_comments_459600.json:
```json
{
    "body": "Replying to [comment:36 jhpalmieri]:\n> But just doing `./configure --with-python=/usr/bin/python3` doesn't accomplish anything because `local/bin/python3` is still a symlink pointing to homebrew's Python.\n\nTry `./configure --with-python=/usr/bin/python3 --with-sage-venv=yes`",
    "created_at": "2021-09-29T23:13:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459600",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:36 jhpalmieri]:
> But just doing `./configure --with-python=/usr/bin/python3` doesn't accomplish anything because `local/bin/python3` is still a symlink pointing to homebrew's Python.

Try `./configure --with-python=/usr/bin/python3 --with-sage-venv=yes`



---

archive/issue_comments_459601.json:
```json
{
    "body": "Should `--with-sage-venv=auto` detect whether this is an incremental build from an earlier build using `--with-sage-venv=auto`, i.e. whether SAGE_ENV matches `local/var/lib/sage/venv-SOMEPYTHONVERSION`? And if so, then should it use the appropriate possibly new directory for the venv? Otherwise the ticket description's \"we ensure that if the system python version changes (either because of system updates or explicit reconfiguration), we create a fresh venv\" is not accurate: this will only happen if the user says `--with-sage-venv=yes`, if I understand correctly.",
    "created_at": "2021-09-29T23:39:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459601",
    "user": "https://github.com/jhpalmieri"
}
```

Should `--with-sage-venv=auto` detect whether this is an incremental build from an earlier build using `--with-sage-venv=auto`, i.e. whether SAGE_ENV matches `local/var/lib/sage/venv-SOMEPYTHONVERSION`? And if so, then should it use the appropriate possibly new directory for the venv? Otherwise the ticket description's "we ensure that if the system python version changes (either because of system updates or explicit reconfiguration), we create a fresh venv" is not accurate: this will only happen if the user says `--with-sage-venv=yes`, if I understand correctly.



---

archive/issue_comments_459602.json:
```json
{
    "body": "If you start from a distclean source tree, the default `--with-sage-venv=auto` does not create a python3 in `local/bin/`. So it will work as advertised.\n\nI think you are testing with a tree that has python3 in `local/bin/`, either from a build before this ticket, or from a defective earlier version of this ticket.",
    "created_at": "2021-09-29T23:57:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459602",
    "user": "https://github.com/mkoeppe"
}
```

If you start from a distclean source tree, the default `--with-sage-venv=auto` does not create a python3 in `local/bin/`. So it will work as advertised.

I think you are testing with a tree that has python3 in `local/bin/`, either from a build before this ticket, or from a defective earlier version of this ticket.



---

archive/issue_comments_459603.json:
```json
{
    "body": "I think you're right, I think it's working the way it's supposed to. Let me test one or two more things.",
    "created_at": "2021-09-30T00:03:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459603",
    "user": "https://github.com/jhpalmieri"
}
```

I think you're right, I think it's working the way it's supposed to. Let me test one or two more things.



---

archive/issue_comments_459604.json:
```json
{
    "body": "Can this be fixed? I did\n\n```\n% ./configure   # use homebrew's Python 3.9\n% make ptestlong\n...\nall tests passed\n% ./configure --with-python=/usr/bin/python3   # Python 3.8\n% make\n% ./sage -tp src/sage_setup\n...\nsage -t --warn-long 107.1 --random-seed=0 src/sage_setup/clean.py  # 1 doctest failed\nsage -t --warn-long 107.1 --random-seed=0 src/sage_setup/find.py  # 2 doctests failed\n```\n\nDetails:\n\n```\nFile \"src/sage_setup/clean.py\", line 96, in sage_setup.clean._find_stale_files\nFailed example:\n    for f in stale_iter:\n        if f.endswith(skip_extensions): continue\n        if '/ext_data/' in f: continue\n        print('Found stale file: ' + f)\nExpected nothing\nGot:\n    Found stale file: /Users/palmieri/Library/Caches/com.apple.python/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/all_cmdline.cpython-38.pyc\n    Found stale file: /Users/palmieri/Library/Caches/com.apple.python/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/version.cpython-38.pyc\n...\n [many lines like this]\n```\n\nand\n\n```\nFile \"src/sage_setup/find.py\", line 365, in sage_setup.find.installed_files_by_module\nFailed example:\n    f1\nExpected:\n    'sage/structure/__init__.py'\nGot:\n    '/Users/palmieri/Library/Caches/com.apple.python/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/structure/__init__.cpython-38.pyc'\n**********************************************************************\nFile \"src/sage_setup/find.py\", line 367, in sage_setup.find.installed_files_by_module\nFailed example:\n    f2\nExpected:\n    'sage/structure/....pyc'\nGot:\n    'sage/structure/__init__.py'\n```\n",
    "created_at": "2021-09-30T04:46:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459604",
    "user": "https://github.com/jhpalmieri"
}
```

Can this be fixed? I did

```
% ./configure   # use homebrew's Python 3.9
% make ptestlong
...
all tests passed
% ./configure --with-python=/usr/bin/python3   # Python 3.8
% make
% ./sage -tp src/sage_setup
...
sage -t --warn-long 107.1 --random-seed=0 src/sage_setup/clean.py  # 1 doctest failed
sage -t --warn-long 107.1 --random-seed=0 src/sage_setup/find.py  # 2 doctests failed
```

Details:

```
File "src/sage_setup/clean.py", line 96, in sage_setup.clean._find_stale_files
Failed example:
    for f in stale_iter:
        if f.endswith(skip_extensions): continue
        if '/ext_data/' in f: continue
        print('Found stale file: ' + f)
Expected nothing
Got:
    Found stale file: /Users/palmieri/Library/Caches/com.apple.python/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/all_cmdline.cpython-38.pyc
    Found stale file: /Users/palmieri/Library/Caches/com.apple.python/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/version.cpython-38.pyc
...
 [many lines like this]
```

and

```
File "src/sage_setup/find.py", line 365, in sage_setup.find.installed_files_by_module
Failed example:
    f1
Expected:
    'sage/structure/__init__.py'
Got:
    '/Users/palmieri/Library/Caches/com.apple.python/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta2/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/structure/__init__.cpython-38.pyc'
**********************************************************************
File "src/sage_setup/find.py", line 367, in sage_setup.find.installed_files_by_module
Failed example:
    f2
Expected:
    'sage/structure/....pyc'
Got:
    'sage/structure/__init__.py'
```




---

archive/issue_comments_459605.json:
```json
{
    "body": "This is #31314",
    "created_at": "2021-09-30T04:58:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459605",
    "user": "https://github.com/mkoeppe"
}
```

This is #31314



---

archive/issue_comments_459606.json:
```json
{
    "body": "Okay, then I think this is ready.",
    "created_at": "2021-09-30T17:30:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459606",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, then I think this is ready.



---

archive/issue_comments_459607.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-30T17:30:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459607",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_459608.json:
```json
{
    "body": "Thank you!",
    "created_at": "2021-09-30T17:41:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459608",
    "user": "https://github.com/mkoeppe"
}
```

Thank you!



---

archive/issue_comments_459609.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-10-04T21:15:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459609",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_459610.json:
```json
{
    "body": "Breaks build on Debian 9:\n\n```\nTesting importing of various modules...\nctypes module imported OK\nmath module imported OK\nhashlib module imported OK\ncrypt module imported OK\nsocket module imported OK\nzlib module imported OK\nTraceback (most recent call last):\n  File \"<string>\", line 1, in <module>\n  File \"/home/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.7/var/tmp/sage/build/python3-3.9.7/src/Lib/sqlite3/__init__.py\", line 23, in <module>\n    from sqlite3.dbapi2 import *\n  File \"/home/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.7/var/tmp/sage/build/python3-3.9.7/src/Lib/sqlite3/dbapi2.py\", line 27, in <module>\n    from _sqlite3 import *\nModuleNotFoundError: No module named '_sqlite3'\nsqlite3 module failed to import\nssl module imported OK\nError: One or more modules failed to import.\nreal\t1m25.694s\nuser\t2m0.796s\nsys\t0m10.188s\n************************************************************************\nError building package python3-3.9.7\n************************************************************************\n```\n",
    "created_at": "2021-10-04T21:15:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459610",
    "user": "https://github.com/vbraun"
}
```

Breaks build on Debian 9:

```
Testing importing of various modules...
ctypes module imported OK
math module imported OK
hashlib module imported OK
crypt module imported OK
socket module imported OK
zlib module imported OK
Traceback (most recent call last):
  File "<string>", line 1, in <module>
  File "/home/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.7/var/tmp/sage/build/python3-3.9.7/src/Lib/sqlite3/__init__.py", line 23, in <module>
    from sqlite3.dbapi2 import *
  File "/home/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.7/var/tmp/sage/build/python3-3.9.7/src/Lib/sqlite3/dbapi2.py", line 27, in <module>
    from _sqlite3 import *
ModuleNotFoundError: No module named '_sqlite3'
sqlite3 module failed to import
ssl module imported OK
Error: One or more modules failed to import.
real	1m25.694s
user	2m0.796s
sys	0m10.188s
************************************************************************
Error building package python3-3.9.7
************************************************************************
```




---

archive/issue_comments_459611.json:
```json
{
    "body": "Build log please",
    "created_at": "2021-10-04T21:20:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459611",
    "user": "https://github.com/mkoeppe"
}
```

Build log please



---

archive/issue_comments_459612.json:
```json
{
    "body": "I was able to reproduce this using `tox -e docker-debian-stretch-minimal`.",
    "created_at": "2021-10-12T01:33:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459612",
    "user": "https://github.com/mkoeppe"
}
```

I was able to reproduce this using `tox -e docker-debian-stretch-minimal`.



---

archive/issue_comments_459613.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-12T03:06:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459613",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_459614.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-10-12T03:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459614",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_459615.json:
```json
{
    "body": "When I run `tox -e docker-debian-stretch-minimal`, where are the package log files?",
    "created_at": "2021-10-13T17:20:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459615",
    "user": "https://github.com/jhpalmieri"
}
```

When I run `tox -e docker-debian-stretch-minimal`, where are the package log files?



---

archive/issue_comments_459616.json:
```json
{
    "body": "They are in the Docker container. \nAt the end of the build, tox will tell you name and/or sha256 hash of the image built.\nYou can to `docker run -it IMAGE bash` to enter the container and then it's all in /sage/logs",
    "created_at": "2021-10-13T17:24:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459616",
    "user": "https://github.com/mkoeppe"
}
```

They are in the Docker container. 
At the end of the build, tox will tell you name and/or sha256 hash of the image built.
You can to `docker run -it IMAGE bash` to enter the container and then it's all in /sage/logs



---

archive/issue_comments_459617.json:
```json
{
    "body": "Okay, before this latest change I see the Python problem, as well as:\n\n```\n* package:         python3-3.9.7\n  last build time: Oct 13 17:49\n  log file:        /sage/logs/pkgs/python3-3.9.7.log\n\n* package:         fplll-5.4.1\n  last build time: Oct 13 18:01\n  log file:        /sage/logs/pkgs/fplll-5.4.1.log\n  build directory: /sage/local/var/tmp/sage/build/fplll-5.4.1\n\n* package:         cmake-3.21.0\n  last build time: Oct 13 18:04\n  log file:        /sage/logs/pkgs/cmake-3.21.0.log\n  build directory: /sage/local/var/tmp/sage/build/cmake-3.21.0\n\n* package:         gfortran-10.3.0\n  last build time: Oct 13 18:14\n  log file:        /sage/logs/pkgs/gfortran-10.3.0.log\n  build directory: /sage/local/var/tmp/sage/build/gfortran-10.3.0\n```\n\nThe other failures appear to be unrelated to this ticket: I get them with the `develop` branch.",
    "created_at": "2021-10-13T19:25:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459617",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, before this latest change I see the Python problem, as well as:

```
* package:         python3-3.9.7
  last build time: Oct 13 17:49
  log file:        /sage/logs/pkgs/python3-3.9.7.log

* package:         fplll-5.4.1
  last build time: Oct 13 18:01
  log file:        /sage/logs/pkgs/fplll-5.4.1.log
  build directory: /sage/local/var/tmp/sage/build/fplll-5.4.1

* package:         cmake-3.21.0
  last build time: Oct 13 18:04
  log file:        /sage/logs/pkgs/cmake-3.21.0.log
  build directory: /sage/local/var/tmp/sage/build/cmake-3.21.0

* package:         gfortran-10.3.0
  last build time: Oct 13 18:14
  log file:        /sage/logs/pkgs/gfortran-10.3.0.log
  build directory: /sage/local/var/tmp/sage/build/gfortran-10.3.0
```

The other failures appear to be unrelated to this ticket: I get them with the `develop` branch.



---

archive/issue_comments_459618.json:
```json
{
    "body": "Replying to [comment:52 jhpalmieri]:\n> The other failures appear to be related to this ticket: I get them with the `develop` branch.\nDid you mean to write \"unrelated to this ticket\"?",
    "created_at": "2021-10-13T19:32:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459618",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:52 jhpalmieri]:
> The other failures appear to be related to this ticket: I get them with the `develop` branch.
Did you mean to write "unrelated to this ticket"?



---

archive/issue_comments_459619.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-10-13T21:18:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459619",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_459620.json:
```json
{
    "body": "Yes, sorry, unrelated. I've edited to make it clearer in case anyone looks at this later. With the most recent branch here, Python builds correctly. I think that's good enough for another positive review.",
    "created_at": "2021-10-13T21:18:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459620",
    "user": "https://github.com/jhpalmieri"
}
```

Yes, sorry, unrelated. I've edited to make it clearer in case anyone looks at this later. With the most recent branch here, Python builds correctly. I think that's good enough for another positive review.



---

archive/issue_comments_459621.json:
```json
{
    "body": "Thank you!\n\nBy the way, I cannot reproduce the failures with the other packages, and they also built correctly on GH Actions https://github.com/sagemath/sage/runs/3863930628?check_suite_focus=true",
    "created_at": "2021-10-13T21:22:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459621",
    "user": "https://github.com/mkoeppe"
}
```

Thank you!

By the way, I cannot reproduce the failures with the other packages, and they also built correctly on GH Actions https://github.com/sagemath/sage/runs/3863930628?check_suite_focus=true



---

archive/issue_comments_459622.json:
```json
{
    "body": "Maybe the issue was that my Docker was out of date, or maybe it was a memory issue. I upgraded Docker and allocated more RAM to it, and now those packages build.",
    "created_at": "2021-10-13T23:20:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459622",
    "user": "https://github.com/jhpalmieri"
}
```

Maybe the issue was that my Docker was out of date, or maybe it was a memory issue. I upgraded Docker and allocated more RAM to it, and now those packages build.



---

archive/issue_comments_459623.json:
```json
{
    "body": "I do get another failure, though; don't know if it's related to this ticket. With `tox -e docker-debian-stretch-minimal`, I get:\n\n```\ngcc version 6.3.0 20170516 (Debian 6.3.0-18+deb9u1) \n****************************************************\nPackage 'setuptools' is currently not installed\nNo legacy uninstaller found for 'setuptools'; nothing to do\npython3: error while loading shared libraries: libpython3.9.so.1.0: cannot open shared object file: No such file or directory\n********************************************************************************\nError building / installing setuptools for Python\n********************************************************************************\n\nreal\t0m0.021s\nuser\t0m0.011s\nsys\t0m0.010s\n************************************************************************\nError installing package setuptools-58.0.2\n************************************************************************\nPlease email sage-devel (http://groups.google.com/group/sage-devel)\nexplaining the problem and including the log files\n  /sage/logs/pkgs/setuptools-58.0.2.log\nand\n  /sage/config.log\nDescribe your computer, operating system, etc.\nIf you want to try to fix the problem yourself, *don't* just cd to\n/sage/local/var/lib/sage/venv-python3.9.7/var/tmp/sage/build/setuptools-58.0.2 and type 'make' or whatever is appropriate.\nInstead, the following commands setup all environment variables\ncorrectly and load a subshell for you to debug the error:\n  (cd '/sage/local/var/lib/sage/venv-python3.9.7/var/tmp/sage/build/setuptools-58.0.2' && '/sage/sage' --buildsh)\nWhen you are done debugging, you can type \"exit\" to leave the subshell.\n```\n",
    "created_at": "2021-10-14T00:20:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459623",
    "user": "https://github.com/jhpalmieri"
}
```

I do get another failure, though; don't know if it's related to this ticket. With `tox -e docker-debian-stretch-minimal`, I get:

```
gcc version 6.3.0 20170516 (Debian 6.3.0-18+deb9u1) 
****************************************************
Package 'setuptools' is currently not installed
No legacy uninstaller found for 'setuptools'; nothing to do
python3: error while loading shared libraries: libpython3.9.so.1.0: cannot open shared object file: No such file or directory
********************************************************************************
Error building / installing setuptools for Python
********************************************************************************

real	0m0.021s
user	0m0.011s
sys	0m0.010s
************************************************************************
Error installing package setuptools-58.0.2
************************************************************************
Please email sage-devel (http://groups.google.com/group/sage-devel)
explaining the problem and including the log files
  /sage/logs/pkgs/setuptools-58.0.2.log
and
  /sage/config.log
Describe your computer, operating system, etc.
If you want to try to fix the problem yourself, *don't* just cd to
/sage/local/var/lib/sage/venv-python3.9.7/var/tmp/sage/build/setuptools-58.0.2 and type 'make' or whatever is appropriate.
Instead, the following commands setup all environment variables
correctly and load a subshell for you to debug the error:
  (cd '/sage/local/var/lib/sage/venv-python3.9.7/var/tmp/sage/build/setuptools-58.0.2' && '/sage/sage' --buildsh)
When you are done debugging, you can type "exit" to leave the subshell.
```




---

archive/issue_comments_459624.json:
```json
{
    "body": "There is a file `SAGE_ROOT/venv/local/lib/libpython3.9.so.1.0`. If I run `./sage --python` then I get the same error.",
    "created_at": "2021-10-14T00:22:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459624",
    "user": "https://github.com/jhpalmieri"
}
```

There is a file `SAGE_ROOT/venv/local/lib/libpython3.9.so.1.0`. If I run `./sage --python` then I get the same error.



---

archive/issue_comments_459625.json:
```json
{
    "body": "Yes, I see this error now too.",
    "created_at": "2021-10-14T01:56:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459625",
    "user": "https://github.com/mkoeppe"
}
```

Yes, I see this error now too.



---

archive/issue_comments_459626.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-10-14T01:58:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459626",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_459627.json:
```json
{
    "body": "Looks like on Linux I need to set the linker flags differently.",
    "created_at": "2021-10-14T02:01:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459627",
    "user": "https://github.com/mkoeppe"
}
```

Looks like on Linux I need to set the linker flags differently.



---

archive/issue_comments_459628.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-14T02:30:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459628",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_459629.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-10-14T05:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459629",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_459630.json:
```json
{
    "body": "This fixes it for me; this time I ran a complete build",
    "created_at": "2021-10-14T05:44:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459630",
    "user": "https://github.com/mkoeppe"
}
```

This fixes it for me; this time I ran a complete build



---

archive/issue_comments_459631.json:
```json
{
    "body": "This ticket (at 2101b8cccc) is already on Volker's branch.\nI've opened #32698 for the fix.",
    "created_at": "2021-10-14T22:41:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459631",
    "user": "https://github.com/mkoeppe"
}
```

This ticket (at 2101b8cccc) is already on Volker's branch.
I've opened #32698 for the fix.



---

archive/issue_comments_459632.json:
```json
{
    "body": "This works for me with a few different builds (standard build on my machine and a few tox builds via Docker).",
    "created_at": "2021-10-15T03:22:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459632",
    "user": "https://github.com/jhpalmieri"
}
```

This works for me with a few different builds (standard build on my machine and a few tox builds via Docker).



---

archive/issue_comments_459633.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-10-15T03:22:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459633",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_459634.json:
```json
{
    "body": "This was merged along with #32698",
    "created_at": "2021-10-19T22:01:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459634",
    "user": "https://github.com/mkoeppe"
}
```

This was merged along with #32698



---

archive/issue_comments_459635.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-10-19T22:01:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32205",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32205#issuecomment-459635",
    "user": "https://github.com/mkoeppe"
}
```

Resolution: fixed
