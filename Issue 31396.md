# Issue 31396: Simplify VectorField.__call__

Issue created by migration from https://trac.sagemath.org/ticket/31633

Original creator: egourgoulhon

Original creation time: 2021-04-09 16:53:49

CC:  tscrim @mjungmath

Keywords: vector field, scalar field

The method `VectorField.__call__` implements the action _v(f)_ of a vector field _v_ on a scalar field _f_, as a derivation. It is reimplemented here to simply return _df(v)_, i.e. the differential of _f_ acting on _v_ as a 1-form. Actually, the current code of this method contains the comment:

```
        #!# Could it be simply
        # return scalar.differential()(self)
        # ?
```

git blame reveals that this comment dates back to 2015. It is time to make the change, thereby simplifying the code and avoiding some code duplication. 


---

Comment by egourgoulhon created at 2021-04-09 16:56:54

Changing status from new to needs_review.


---

Comment by egourgoulhon created at 2021-04-09 16:56:54

New commits:


---

Comment by @mjungmath created at 2021-04-09 18:21:43

Nice! It's good to reduce code and get rid of duplication!

Two things:

- What exactly caused the change

   {{{#!diff
     sage: isinstance(Tp, FiniteRankFreeModule)
     True
     sage: sorted(Tp.bases(), key=str)
-    [Basis (d/dr,d/dph) on the Tangent space at Point p on the Euclidean plane E^2,
-     Basis (e_r,e_ph) on the Tangent space at Point p on the Euclidean plane E^2,
+    [Basis (e_r,e_ph) on the Tangent space at Point p on the Euclidean plane E^2,
      Basis (e_x,e_y) on the Tangent space at Point p on the Euclidean plane E^2]
   }}}

- It is possible to combine raw strings and f-strings:

   {{{#!diff
-                latex_name = r"{}\left({}\right)".format(self._latex_name,
-                                                         scalar._latex_name)
+                latex_name = fr"{self._latex_name}\left({scalar._latex_name}\right)"
   }}}


---

Comment by git created at 2021-04-09 19:59:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-04-09 20:27:45

Replying to [comment:2 gh-mjungmath]:

Thanks for your comments.

> 
> - What exactly caused the change
> 
>    {{{#!diff
>      sage: isinstance(Tp, FiniteRankFreeModule)
>      True
>      sage: sorted(Tp.bases(), key=str)
> -    [Basis (d/dr,d/dph) on the Tangent space at Point p on the Euclidean plane E^2,
> -     Basis (e_r,e_ph) on the Tangent space at Point p on the Euclidean plane E^2,
> +    [Basis (e_r,e_ph) on the Tangent space at Point p on the Euclidean plane E^2,
>       Basis (e_x,e_y) on the Tangent space at Point p on the Euclidean plane E^2]
>    }}}
> 

It's because in the previous `VectorFieldParal.__call__` code, the computation was performed as v<sup>i</sup> df/dx<sup>i</sup> in all possible coordinate frames d/dx<sup>i</sup>, thereby triggering the evaluation of v in these frames. In the new code, the computation is performed as (df)<sub>i</sub> v<sup>i</sup> in a single frame (and not necessarily a coordinate one). In the specific example above, `v(F)` in line 577 of `src/doc/en/thematic_tutorials/vector_calculus/vector_calc_plane.rst` triggered the computation of v in the coordinate frame `(d/dr, d/dph)`; this was done in line 1779 of the old (i.e. 9.3.rc2) file `vectorfield.py`:

```
                self_r.comp(chart._frame)
```

Then `vp = v.at(p)` in line 634 of `vector_calc_plane.rst` created the basis `(d/dr, d/dph)` in `Tp`; this was done by `frame.at(point)` in line 2109 of `tensorfield_paral.py`:

```
            comp_resu = resu.add_comp(frame.at(point))
```

This explains why `Tp` had the extra basis `(d/dr, d/dph)` with the old code. It was a side effect of an unnecessary calculation in the old `VectorFieldParal.__call__`.



> - It is possible to combine raw strings and f-strings:
> 
>    {{{#!diff
> -                latex_name = r"{}\left({}\right)".format(self._latex_name,
> -                                                         scalar._latex_name)
> +                latex_name = fr"{self._latex_name}\left({scalar._latex_name}\right)"
>    }}}

Done in the last commit.


---

Comment by @mjungmath created at 2021-04-09 20:52:47

Replying to [comment:4 egourgoulhon]:
> It's because in the previous `VectorFieldParal.__call__` code, the computation was performed as v<sup>i</sup> df/dx<sup>i</sup> in all possible coordinate frames d/dx<sup>i</sup>, thereby triggering the evaluation of v in these frames. In the new code, the computation is performed as (df)<sub>i</sub> v<sup>i</sup> in a single frame (and not necessarily a coordinate one). In the specific example above, `v(F)` in line 577 of `src/doc/en/thematic_tutorials/vector_calculus/vector_calc_plane.rst` triggered the computation of v in the coordinate frame `(d/dr, d/dph)`; this was done in line 1779 of the old (i.e. 9.3.rc2) file `vectorfield.py`:
> {{{
>                 self_r.comp(chart._frame)
> }}}
> Then `vp = v.at(p)` in line 634 of `vector_calc_plane.rst` created the basis `(d/dr, d/dph)` in `Tp`; this was done by `frame.at(point)` in line 2109 of `tensorfield_paral.py`:
> {{{
>             comp_resu = resu.add_comp(frame.at(point))
> }}}
> This explains why `Tp` had the extra basis `(d/dr, d/dph)` with the old code. It was a side effect of an unnecessary calculation in the old `VectorFieldParal.__call__`.

That's indeed an improvement. Sweet!

> > - It is possible to combine raw strings and f-strings:
> > 
> >    {{{#!diff
> > -                latex_name = r"{}\left({}\right)".format(self._latex_name,
> > -                                                         scalar._latex_name)
> > +                latex_name = fr"{self._latex_name}\left({scalar._latex_name}\right)"
> >    }}}
> 
> Done in the last commit.

Great. I'll give it a positive review as soon as patchbot is green.


---

Comment by @mjungmath created at 2021-04-09 22:37:58

Patchbot green. LGTM.


---

Comment by @mjungmath created at 2021-04-09 22:37:58

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2021-04-10 09:10:47

Thank you for the review!


---

Comment by vbraun created at 2021-06-06 13:18:17

Resolution: fixed
