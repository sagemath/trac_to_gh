# Issue 31396: Simplify VectorField.__call__

archive/issues_031396.json:
```json
{
    "body": "CC:  tscrim @mjungmath\n\nKeywords: vector field, scalar field\n\nThe method `VectorField.__call__` implements the action *v(f)* of a vector field *v* on a scalar field *f*, as a derivation. It is reimplemented here to simply return *df(v)*, i.e. the differential of *f* acting on *v* as a 1-form. Actually, the current code of this method contains the comment:\n\n```\n        #!# Could it be simply\n        # return scalar.differential()(self)\n        # ?\n```\n\ngit blame reveals that this comment dates back to 2015. It is time to make the change, thereby simplifying the code and avoiding some code duplication. \n\nIssue created by migration from https://trac.sagemath.org/ticket/31633\n\n",
    "created_at": "2021-04-09T16:53:49Z",
    "labels": [
        "manifolds",
        "major",
        "enhancement"
    ],
    "title": "Simplify VectorField.__call__",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31396",
    "user": "egourgoulhon"
}
```
CC:  tscrim @mjungmath

Keywords: vector field, scalar field

The method `VectorField.__call__` implements the action *v(f)* of a vector field *v* on a scalar field *f*, as a derivation. It is reimplemented here to simply return *df(v)*, i.e. the differential of *f* acting on *v* as a 1-form. Actually, the current code of this method contains the comment:

```
        #!# Could it be simply
        # return scalar.differential()(self)
        # ?
```

git blame reveals that this comment dates back to 2015. It is time to make the change, thereby simplifying the code and avoiding some code duplication. 

Issue created by migration from https://trac.sagemath.org/ticket/31633





---

archive/issue_comments_449145.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-09T16:56:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31396#issuecomment-449145",
    "user": "egourgoulhon"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_449146.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-04-09T16:56:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31396#issuecomment-449146",
    "user": "egourgoulhon"
}
```

New commits:



---

archive/issue_comments_449147.json:
```json
{
    "body": "Nice! It's good to reduce code and get rid of duplication!\n\nTwo things:\n\n- What exactly caused the change\n\n   {{{#!diff\n     sage: isinstance(Tp, FiniteRankFreeModule)\n     True\n     sage: sorted(Tp.bases(), key=str)\n-    [Basis (d/dr,d/dph) on the Tangent space at Point p on the Euclidean plane E^2,\n-     Basis (e_r,e_ph) on the Tangent space at Point p on the Euclidean plane E^2,\n+    [Basis (e_r,e_ph) on the Tangent space at Point p on the Euclidean plane E^2,\n      Basis (e_x,e_y) on the Tangent space at Point p on the Euclidean plane E^2]\n   }}}\n\n- It is possible to combine raw strings and f-strings:\n\n   {{{#!diff\n-                latex_name = r\"{}\\left({}\\right)\".format(self._latex_name,\n-                                                         scalar._latex_name)\n+                latex_name = fr\"{self._latex_name}\\left({scalar._latex_name}\\right)\"\n   }}}",
    "created_at": "2021-04-09T18:21:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31396#issuecomment-449147",
    "user": "@mjungmath"
}
```

Nice! It's good to reduce code and get rid of duplication!

Two things:

- What exactly caused the change

   {{{#!diff
     sage: isinstance(Tp, FiniteRankFreeModule)
     True
     sage: sorted(Tp.bases(), key=str)
-    [Basis (d/dr,d/dph) on the Tangent space at Point p on the Euclidean plane E^2,
-     Basis (e_r,e_ph) on the Tangent space at Point p on the Euclidean plane E^2,
+    [Basis (e_r,e_ph) on the Tangent space at Point p on the Euclidean plane E^2,
      Basis (e_x,e_y) on the Tangent space at Point p on the Euclidean plane E^2]
   }}}

- It is possible to combine raw strings and f-strings:

   {{{#!diff
-                latex_name = r"{}\left({}\right)".format(self._latex_name,
-                                                         scalar._latex_name)
+                latex_name = fr"{self._latex_name}\left({scalar._latex_name}\right)"
   }}}



---

archive/issue_comments_449148.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-09T19:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31396#issuecomment-449148",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_449149.json:
```json
{
    "body": "Replying to [comment:2 gh-mjungmath]:\n\nThanks for your comments.\n\n> \n> - What exactly caused the change\n> \n>    {{{#!diff\n>      sage: isinstance(Tp, FiniteRankFreeModule)\n>      True\n>      sage: sorted(Tp.bases(), key=str)\n> -    [Basis (d/dr,d/dph) on the Tangent space at Point p on the Euclidean plane E^2,\n> -     Basis (e_r,e_ph) on the Tangent space at Point p on the Euclidean plane E^2,\n> +    [Basis (e_r,e_ph) on the Tangent space at Point p on the Euclidean plane E^2,\n>       Basis (e_x,e_y) on the Tangent space at Point p on the Euclidean plane E^2]\n>    }}}\n> \n\nIt's because in the previous `VectorFieldParal.__call__` code, the computation was performed as v<sup>i</sup> df/dx<sup>i</sup> in all possible coordinate frames d/dx<sup>i</sup>, thereby triggering the evaluation of v in these frames. In the new code, the computation is performed as (df)<sub>i</sub> v<sup>i</sup> in a single frame (and not necessarily a coordinate one). In the specific example above, `v(F)` in line 577 of `src/doc/en/thematic_tutorials/vector_calculus/vector_calc_plane.rst` triggered the computation of v in the coordinate frame `(d/dr, d/dph)`; this was done in line 1779 of the old (i.e. 9.3.rc2) file `vectorfield.py`:\n\n```\n                self_r.comp(chart._frame)\n```\n\nThen `vp = v.at(p)` in line 634 of `vector_calc_plane.rst` created the basis `(d/dr, d/dph)` in `Tp`; this was done by `frame.at(point)` in line 2109 of `tensorfield_paral.py`:\n\n```\n            comp_resu = resu.add_comp(frame.at(point))\n```\n\nThis explains why `Tp` had the extra basis `(d/dr, d/dph)` with the old code. It was a side effect of an unnecessary calculation in the old `VectorFieldParal.__call__`.\n\n\n\n> - It is possible to combine raw strings and f-strings:\n> \n>    {{{#!diff\n> -                latex_name = r\"{}\\left({}\\right)\".format(self._latex_name,\n> -                                                         scalar._latex_name)\n> +                latex_name = fr\"{self._latex_name}\\left({scalar._latex_name}\\right)\"\n>    }}}\n\nDone in the last commit.",
    "created_at": "2021-04-09T20:27:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31396#issuecomment-449149",
    "user": "egourgoulhon"
}
```

Replying to [comment:2 gh-mjungmath]:

Thanks for your comments.

> 
> - What exactly caused the change
> 
>    {{{#!diff
>      sage: isinstance(Tp, FiniteRankFreeModule)
>      True
>      sage: sorted(Tp.bases(), key=str)
> -    [Basis (d/dr,d/dph) on the Tangent space at Point p on the Euclidean plane E^2,
> -     Basis (e_r,e_ph) on the Tangent space at Point p on the Euclidean plane E^2,
> +    [Basis (e_r,e_ph) on the Tangent space at Point p on the Euclidean plane E^2,
>       Basis (e_x,e_y) on the Tangent space at Point p on the Euclidean plane E^2]
>    }}}
> 

It's because in the previous `VectorFieldParal.__call__` code, the computation was performed as v<sup>i</sup> df/dx<sup>i</sup> in all possible coordinate frames d/dx<sup>i</sup>, thereby triggering the evaluation of v in these frames. In the new code, the computation is performed as (df)<sub>i</sub> v<sup>i</sup> in a single frame (and not necessarily a coordinate one). In the specific example above, `v(F)` in line 577 of `src/doc/en/thematic_tutorials/vector_calculus/vector_calc_plane.rst` triggered the computation of v in the coordinate frame `(d/dr, d/dph)`; this was done in line 1779 of the old (i.e. 9.3.rc2) file `vectorfield.py`:

```
                self_r.comp(chart._frame)
```

Then `vp = v.at(p)` in line 634 of `vector_calc_plane.rst` created the basis `(d/dr, d/dph)` in `Tp`; this was done by `frame.at(point)` in line 2109 of `tensorfield_paral.py`:

```
            comp_resu = resu.add_comp(frame.at(point))
```

This explains why `Tp` had the extra basis `(d/dr, d/dph)` with the old code. It was a side effect of an unnecessary calculation in the old `VectorFieldParal.__call__`.



> - It is possible to combine raw strings and f-strings:
> 
>    {{{#!diff
> -                latex_name = r"{}\left({}\right)".format(self._latex_name,
> -                                                         scalar._latex_name)
> +                latex_name = fr"{self._latex_name}\left({scalar._latex_name}\right)"
>    }}}

Done in the last commit.



---

archive/issue_comments_449150.json:
```json
{
    "body": "Replying to [comment:4 egourgoulhon]:\n> It's because in the previous `VectorFieldParal.__call__` code, the computation was performed as v<sup>i</sup> df/dx<sup>i</sup> in all possible coordinate frames d/dx<sup>i</sup>, thereby triggering the evaluation of v in these frames. In the new code, the computation is performed as (df)<sub>i</sub> v<sup>i</sup> in a single frame (and not necessarily a coordinate one). In the specific example above, `v(F)` in line 577 of `src/doc/en/thematic_tutorials/vector_calculus/vector_calc_plane.rst` triggered the computation of v in the coordinate frame `(d/dr, d/dph)`; this was done in line 1779 of the old (i.e. 9.3.rc2) file `vectorfield.py`:\n> {{{\n>                 self_r.comp(chart._frame)\n> }}}\n> Then `vp = v.at(p)` in line 634 of `vector_calc_plane.rst` created the basis `(d/dr, d/dph)` in `Tp`; this was done by `frame.at(point)` in line 2109 of `tensorfield_paral.py`:\n> {{{\n>             comp_resu = resu.add_comp(frame.at(point))\n> }}}\n> This explains why `Tp` had the extra basis `(d/dr, d/dph)` with the old code. It was a side effect of an unnecessary calculation in the old `VectorFieldParal.__call__`.\n\nThat's indeed an improvement. Sweet!\n\n> > - It is possible to combine raw strings and f-strings:\n> > \n> >    {{{#!diff\n> > -                latex_name = r\"{}\\left({}\\right)\".format(self._latex_name,\n> > -                                                         scalar._latex_name)\n> > +                latex_name = fr\"{self._latex_name}\\left({scalar._latex_name}\\right)\"\n> >    }}}\n> \n> Done in the last commit.\n\nGreat. I'll give it a positive review as soon as patchbot is green.",
    "created_at": "2021-04-09T20:52:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31396#issuecomment-449150",
    "user": "@mjungmath"
}
```

Replying to [comment:4 egourgoulhon]:
> It's because in the previous `VectorFieldParal.__call__` code, the computation was performed as v<sup>i</sup> df/dx<sup>i</sup> in all possible coordinate frames d/dx<sup>i</sup>, thereby triggering the evaluation of v in these frames. In the new code, the computation is performed as (df)<sub>i</sub> v<sup>i</sup> in a single frame (and not necessarily a coordinate one). In the specific example above, `v(F)` in line 577 of `src/doc/en/thematic_tutorials/vector_calculus/vector_calc_plane.rst` triggered the computation of v in the coordinate frame `(d/dr, d/dph)`; this was done in line 1779 of the old (i.e. 9.3.rc2) file `vectorfield.py`:
> {{{
>                 self_r.comp(chart._frame)
> }}}
> Then `vp = v.at(p)` in line 634 of `vector_calc_plane.rst` created the basis `(d/dr, d/dph)` in `Tp`; this was done by `frame.at(point)` in line 2109 of `tensorfield_paral.py`:
> {{{
>             comp_resu = resu.add_comp(frame.at(point))
> }}}
> This explains why `Tp` had the extra basis `(d/dr, d/dph)` with the old code. It was a side effect of an unnecessary calculation in the old `VectorFieldParal.__call__`.

That's indeed an improvement. Sweet!

> > - It is possible to combine raw strings and f-strings:
> > 
> >    {{{#!diff
> > -                latex_name = r"{}\left({}\right)".format(self._latex_name,
> > -                                                         scalar._latex_name)
> > +                latex_name = fr"{self._latex_name}\left({scalar._latex_name}\right)"
> >    }}}
> 
> Done in the last commit.

Great. I'll give it a positive review as soon as patchbot is green.



---

archive/issue_comments_449151.json:
```json
{
    "body": "Patchbot green. LGTM.",
    "created_at": "2021-04-09T22:37:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31396#issuecomment-449151",
    "user": "@mjungmath"
}
```

Patchbot green. LGTM.



---

archive/issue_comments_449152.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-09T22:37:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31396#issuecomment-449152",
    "user": "@mjungmath"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_449153.json:
```json
{
    "body": "Thank you for the review!",
    "created_at": "2021-04-10T09:10:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31396#issuecomment-449153",
    "user": "egourgoulhon"
}
```

Thank you for the review!



---

archive/issue_comments_449154.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-06-06T13:18:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31396#issuecomment-449154",
    "user": "vbraun"
}
```

Resolution: fixed
