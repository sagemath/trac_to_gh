# Issue 17157: TypeError in Expression.simplify_hypergeometric()

archive/issues_017157.json:
```json
{
    "body": "CC:  @rwst\n\nWhen calling `simplify_hypergeometric()` on an expression with two variables, sometimes a `TypeError` is thrown:\n\n\n```\nsage: y = SR.symbol('y')\nsage: f = x*y + x + y\nsage: f.simplify_hypergeometric()\n```\n\n\nproduces,\n\n\n```\nTypeError                                 Traceback (most recent call last)\n<ipython-input-4-9e70db185ac4> in <module>()\n----> 1 f.simplify_hypergeometric()\n\n/home/mjo/src/sage.git/local/lib/python2.7/site-packages/sage/symbolic/expression.so in sage.symbolic.expression.Expression.simplify_hypergeometric (build/cythonized/sage/symbolic/expression.cpp:40840)()\n\nTypeError: op_add expected 2 arguments, got 3\n```\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/17394\n\n",
    "created_at": "2014-11-25T14:42:19Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.7",
    "title": "TypeError in Expression.simplify_hypergeometric()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17157",
    "user": "https://github.com/orlitzky"
}
```
CC:  @rwst

When calling `simplify_hypergeometric()` on an expression with two variables, sometimes a `TypeError` is thrown:


```
sage: y = SR.symbol('y')
sage: f = x*y + x + y
sage: f.simplify_hypergeometric()
```


produces,


```
TypeError                                 Traceback (most recent call last)
<ipython-input-4-9e70db185ac4> in <module>()
----> 1 f.simplify_hypergeometric()

/home/mjo/src/sage.git/local/lib/python2.7/site-packages/sage/symbolic/expression.so in sage.symbolic.expression.Expression.simplify_hypergeometric (build/cythonized/sage/symbolic/expression.cpp:40840)()

TypeError: op_add expected 2 arguments, got 3
```



Issue created by migration from https://trac.sagemath.org/ticket/17394





---

archive/issue_comments_227820.json:
```json
{
    "body": "It's simply this:\n\n```\nsage: A=SR(x+y+x*y)\nsage: A.operator()(*A.operands())\nTypeError: op_add expected 2 arguments, got 3\nsage: A.operator()\nsage: A.operator()\n<built-in function add>\n```\n\nWe should probably not use the built-in function add to mark addition etc., but instead use a variadic version. Same would apply to mul. This issue arises in a lot of places. See for instance `maxima_lib.add_vararg`. It's probably a change that would need to be made in pynac somewhere.\n\nOther point:\n\n```\nop(*map(lambda o: o.simplify_hypergeometric(algorithm), ops))\n```\n\nis both more compactly and more efficiently expressed in python by\n\n```\nop(*(o.simplify_hypergeometric(algorithm) for o in ops))\n```\n\nCompare:\n\n\n```\nsage: def l(*args):\n....:         return list(args)\n....: \nsage: %timeit l( *[a.bit_length() for a in xrange(100)] )\n100000 loops, best of 3: 10.2 \u00b5s per loop\nsage: %timeit l( *(a.bit_length() for a in xrange(100)) )\n100000 loops, best of 3: 12.9 \u00b5s per loop\nsage: %timeit l( *map(lambda a: a.bit_length(), xrange(100)) )\n10000 loops, best of 3: 17.9 \u00b5s per loop\n```\n\n\nBasically: don't use \"map\" in python unless it's considerably more convenient than the corresponding list comprehension.",
    "created_at": "2014-11-25T20:43:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-227820",
    "user": "https://github.com/nbruin"
}
```

It's simply this:

```
sage: A=SR(x+y+x*y)
sage: A.operator()(*A.operands())
TypeError: op_add expected 2 arguments, got 3
sage: A.operator()
sage: A.operator()
<built-in function add>
```

We should probably not use the built-in function add to mark addition etc., but instead use a variadic version. Same would apply to mul. This issue arises in a lot of places. See for instance `maxima_lib.add_vararg`. It's probably a change that would need to be made in pynac somewhere.

Other point:

```
op(*map(lambda o: o.simplify_hypergeometric(algorithm), ops))
```

is both more compactly and more efficiently expressed in python by

```
op(*(o.simplify_hypergeometric(algorithm) for o in ops))
```

Compare:


```
sage: def l(*args):
....:         return list(args)
....: 
sage: %timeit l( *[a.bit_length() for a in xrange(100)] )
100000 loops, best of 3: 10.2 µs per loop
sage: %timeit l( *(a.bit_length() for a in xrange(100)) )
100000 loops, best of 3: 12.9 µs per loop
sage: %timeit l( *map(lambda a: a.bit_length(), xrange(100)) )
10000 loops, best of 3: 17.9 µs per loop
```


Basically: don't use "map" in python unless it's considerably more convenient than the corresponding list comprehension.



---

archive/issue_comments_227821.json:
```json
{
    "body": "Replying to [comment:1 nbruin]:\n> We should probably not use the built-in function add to mark addition etc., but instead use a variadic version. Same would apply to mul. This issue arises in a lot of places. See for instance `maxima_lib.add_vararg`. It's probably a change that would need to be made in pynac somewhere.\n\nNo, it's all in `Expression::operator()`:\n\n```\n        import operator\n        if is_a_add(self._gobj):\n            return operator.add",
    "created_at": "2015-05-08T06:29:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-227821",
    "user": "https://github.com/rwst"
}
```

Replying to [comment:1 nbruin]:
> We should probably not use the built-in function add to mark addition etc., but instead use a variadic version. Same would apply to mul. This issue arises in a lot of places. See for instance `maxima_lib.add_vararg`. It's probably a change that would need to be made in pynac somewhere.

No, it's all in `Expression::operator()`:

```
        import operator
        if is_a_add(self._gobj):
            return operator.add



---

archive/issue_comments_227822.json:
```json
{
    "body": "Replying to [comment:3 rws]:\n> Replying to [comment:1 nbruin]:\n> > It's probably a change that would need to be made in pynac somewhere.\n> No, it's all in `Expression::operator()`:\nI don't understand the comment. Do you mean \"no, that line of code is not in pynac\" or do you mean \"no we cannot/won't make that change\" or something else?\n\nIt seems to me you have just located the exact place where the change would need to be made and hence brought this ticket closer to resolution. We would then need to accommodate that change in a lot of other places too, but it probably means code can become simpler in a lot of spots.",
    "created_at": "2015-05-08T15:25:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-227822",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:3 rws]:
> Replying to [comment:1 nbruin]:
> > It's probably a change that would need to be made in pynac somewhere.
> No, it's all in `Expression::operator()`:
I don't understand the comment. Do you mean "no, that line of code is not in pynac" or do you mean "no we cannot/won't make that change" or something else?

It seems to me you have just located the exact place where the change would need to be made and hence brought this ticket closer to resolution. We would then need to accommodate that change in a lot of other places too, but it probably means code can become simpler in a lot of spots.



---

archive/issue_comments_227823.json:
```json
{
    "body": "Replying to [comment:4 nbruin]:\n> Replying to [comment:3 rws]:\n> > Replying to [comment:1 nbruin]:\n> > > It's probably a change that would need to be made in pynac somewhere.\n> > No, it's all in `Expression::operator()`:\n> I don't understand the comment. Do you mean \"no, that line of code is not in pynac\" or do you mean \"no we cannot/won't make that change\" or something else?\n> \n> It seems to me you have just located the exact place where the change would need to be made and hence brought this ticket closer to resolution. We would then need to accommodate that change in a lot of other places too, but it probably means code can become simpler in a lot of spots.\n\n**edit:** ah, I see. You mean `sage.symbolic.expression.Expression.operator`. The double colon made me think it was `C++` (and `search_src` doesn't give a hit either, so I was assuming the line appeared in external code). So we can just fix this!",
    "created_at": "2015-05-08T18:03:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-227823",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:4 nbruin]:
> Replying to [comment:3 rws]:
> > Replying to [comment:1 nbruin]:
> > > It's probably a change that would need to be made in pynac somewhere.
> > No, it's all in `Expression::operator()`:
> I don't understand the comment. Do you mean "no, that line of code is not in pynac" or do you mean "no we cannot/won't make that change" or something else?
> 
> It seems to me you have just located the exact place where the change would need to be made and hence brought this ticket closer to resolution. We would then need to accommodate that change in a lot of other places too, but it probably means code can become simpler in a lot of spots.

**edit:** ah, I see. You mean `sage.symbolic.expression.Expression.operator`. The double colon made me think it was `C++` (and `search_src` doesn't give a hit either, so I was assuming the line appeared in external code). So we can just fix this!



---

archive/issue_comments_227824.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-05-08T19:45:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-227824",
    "user": "https://github.com/nbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_227825.json:
```json
{
    "body": "This should do the trick",
    "created_at": "2015-05-08T19:45:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-227825",
    "user": "https://github.com/nbruin"
}
```

This should do the trick



---

archive/issue_comments_227826.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-08T19:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-227826",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_227827.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-08T21:17:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-227827",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_227828.json:
```json
{
    "body": "Looks okay. Patchbot has doctest failures in `combinat/finite_state_machine_generators.py` however.",
    "created_at": "2015-05-09T06:46:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-227828",
    "user": "https://github.com/rwst"
}
```

Looks okay. Patchbot has doctest failures in `combinat/finite_state_machine_generators.py` however.



---

archive/issue_comments_227829.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-05-09T06:46:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-227829",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_227830.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-05-09T07:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-227830",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_227831.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-05-09T07:17:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-227831",
    "user": "https://github.com/nbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_227832.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-05-09T07:52:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-227832",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_227833.json:
```json
{
    "body": "Is fine now, thanks.",
    "created_at": "2015-05-09T07:52:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-227833",
    "user": "https://github.com/rwst"
}
```

Is fine now, thanks.



---

archive/issue_comments_227834.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-05-09T23:03:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17157#issuecomment-227834",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
