# Issue 17157: TypeError in Expression.simplify_hypergeometric()

Issue created by migration from https://trac.sagemath.org/ticket/17394

Original creator: mjo

Original creation time: 2014-11-25 14:42:19

CC:  rws

When calling `simplify_hypergeometric()` on an expression with two variables, sometimes a `TypeError` is thrown:


```
sage: y = SR.symbol('y')
sage: f = x*y + x + y
sage: f.simplify_hypergeometric()
```


produces,


```
TypeError                                 Traceback (most recent call last)
<ipython-input-4-9e70db185ac4> in <module>()
----> 1 f.simplify_hypergeometric()

/home/mjo/src/sage.git/local/lib/python2.7/site-packages/sage/symbolic/expression.so in sage.symbolic.expression.Expression.simplify_hypergeometric (build/cythonized/sage/symbolic/expression.cpp:40840)()

TypeError: op_add expected 2 arguments, got 3
```




---

Comment by nbruin created at 2014-11-25 20:43:54

It's simply this:

```
sage: A=SR(x+y+x*y)
sage: A.operator()(*A.operands())
TypeError: op_add expected 2 arguments, got 3
sage: A.operator()
sage: A.operator()
<built-in function add>
```

We should probably not use the built-in function add to mark addition etc., but instead use a variadic version. Same would apply to mul. This issue arises in a lot of places. See for instance `maxima_lib.add_vararg`. It's probably a change that would need to be made in pynac somewhere.

Other point:

```
op(*map(lambda o: o.simplify_hypergeometric(algorithm), ops))
```

is both more compactly and more efficiently expressed in python by

```
op(*(o.simplify_hypergeometric(algorithm) for o in ops))
```

Compare:


```
sage: def l(*args):
....:         return list(args)
....: 
sage: %timeit l( *[a.bit_length() for a in xrange(100)] )
100000 loops, best of 3: 10.2 µs per loop
sage: %timeit l( *(a.bit_length() for a in xrange(100)) )
100000 loops, best of 3: 12.9 µs per loop
sage: %timeit l( *map(lambda a: a.bit_length(), xrange(100)) )
10000 loops, best of 3: 17.9 µs per loop
```


Basically: don't use "map" in python unless it's considerably more convenient than the corresponding list comprehension.


---

Comment by rws created at 2015-05-08 06:29:47

Replying to [comment:1 nbruin]:
> We should probably not use the built-in function add to mark addition etc., but instead use a variadic version. Same would apply to mul. This issue arises in a lot of places. See for instance `maxima_lib.add_vararg`. It's probably a change that would need to be made in pynac somewhere.

No, it's all in `Expression::operator()`:

```
        import operator
        if is_a_add(self._gobj):
            return operator.add


---

Comment by nbruin created at 2015-05-08 15:25:13

Replying to [comment:3 rws]:
> Replying to [comment:1 nbruin]:
> > It's probably a change that would need to be made in pynac somewhere.
> No, it's all in `Expression::operator()`:
I don't understand the comment. Do you mean "no, that line of code is not in pynac" or do you mean "no we cannot/won't make that change" or something else?

It seems to me you have just located the exact place where the change would need to be made and hence brought this ticket closer to resolution. We would then need to accommodate that change in a lot of other places too, but it probably means code can become simpler in a lot of spots.


---

Comment by nbruin created at 2015-05-08 18:03:13

Replying to [comment:4 nbruin]:
> Replying to [comment:3 rws]:
> > Replying to [comment:1 nbruin]:
> > > It's probably a change that would need to be made in pynac somewhere.
> > No, it's all in `Expression::operator()`:
> I don't understand the comment. Do you mean "no, that line of code is not in pynac" or do you mean "no we cannot/won't make that change" or something else?
> 
> It seems to me you have just located the exact place where the change would need to be made and hence brought this ticket closer to resolution. We would then need to accommodate that change in a lot of other places too, but it probably means code can become simpler in a lot of spots.

*edit:* ah, I see. You mean `sage.symbolic.expression.Expression.operator`. The double colon made me think it was `C++` (and `search_src` doesn't give a hit either, so I was assuming the line appeared in external code). So we can just fix this!


---

Comment by nbruin created at 2015-05-08 19:45:11

Changing status from new to needs_review.


---

Comment by nbruin created at 2015-05-08 19:45:11

This should do the trick


---

Comment by git created at 2015-05-08 19:46:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-05-08 21:17:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2015-05-09 06:46:26

Looks okay. Patchbot has doctest failures in `combinat/finite_state_machine_generators.py` however.


---

Comment by rws created at 2015-05-09 06:46:26

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-05-09 07:17:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nbruin created at 2015-05-09 07:17:42

Changing status from needs_work to needs_review.


---

Comment by rws created at 2015-05-09 07:52:04

Changing status from needs_review to positive_review.


---

Comment by rws created at 2015-05-09 07:52:04

Is fine now, thanks.


---

Comment by vbraun created at 2015-05-09 23:03:15

Resolution: fixed
