# Issue 18124: CategoryObject: always cache gens_dict

Issue created by migration from https://trac.sagemath.org/ticket/18361

Original creator: jdemeyer

Original creation time: 2015-05-04 07:54:57

The `cdef class CategoryObject` has this strange method:

```
    def gens_dict(self):
         r"""
         Return a dictionary whose entries are ``{var_name:variable,...}``.
         """
         if HAS_DICTIONARY(self):
            try:
                if self._gens_dict is not None:
                    return self._gens_dict
            except AttributeError:
                pass
         v = {}
         for x in self.gens():
             v[str(x)] = x
         if HAS_DICTIONARY(self):
            self._gens_dict = v
         return v
```

which provides caching only for Python subclasses. This should be a Cython attribute instead.


---

Comment by jdemeyer created at 2015-05-04 08:38:46

New commits:


---

Comment by jdemeyer created at 2015-05-04 08:38:46

Changing status from new to needs_review.


---

Comment by mmezzarobba created at 2015-05-04 19:04:59

Changing status from needs_review to needs_work.


---

Comment by mmezzarobba created at 2015-05-04 19:04:59

The patchbot complains about the usual example involving `dir(Parent)` in `coercion_and_categories.rst`.


---

Comment by git created at 2015-05-05 06:01:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-05-05 06:03:15

Thanks. The patchbot is (temporarily) down, so I cannot see if there are other failures.


---

Comment by jdemeyer created at 2015-05-05 06:03:15

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-05-05 07:57:26

The class `ParentWithGens` is deprecated! There is no need for an attribute `_gens_dict` on all category objects. Why `Partitions` or `Integers` should have a method `gens` or `_gens_dict` attribute? I am very against this change.

Vincent


---

Comment by vdelecroix created at 2015-05-05 07:57:26

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2015-05-05 08:13:50

Replying to [comment:7 vdelecroix]:
> The class `ParentWithGens` is deprecated! There is no need for an attribute `_gens_dict` on all category objects.
Then why is there a `gens_dict()` method on all category objects?

It makes absolutely no sense to have a method on class `A` whose results are cached in a subclass `B`.

If you prefer, I can move the whole `gens_dict()` method, but that's a more drastic change.


---

Comment by vdelecroix created at 2015-05-05 08:21:42

Replying to [comment:8 jdemeyer]:
> Replying to [comment:7 vdelecroix]:
> > The class `ParentWithGens` is deprecated! There is no need for an attribute `_gens_dict` on all category objects.
> Then why is there a `gens_dict()` method on all category objects?

This is indeed the problem!

> If you prefer, I can move the whole `gens_dict()` method, but that's a more drastic change.

Yes please. I found that doing what you proposed is just worse in the direction of cleaning `Element/CategoryObject/Parent`.


---

Comment by jdemeyer created at 2015-05-05 08:23:04

Replying to [comment:8 jdemeyer]:
> If you prefer, I can move the whole `gens_dict()` method, but that's a more drastic change.
That doesn't work:

```
sage -t src/sage/rings/polynomial/pbori.pyx
**********************************************************************
File "src/sage/rings/polynomial/pbori.pyx", line 4067, in sage.rings.polynomial.pbori.BooleanPolynomial.subs
Failed example:
    f.subs(x=1)
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.polynomial.pbori.BooleanPolynomial.subs[2]>", line 1, in <module>
        f.subs(x=Integer(1))
      File "sage/rings/polynomial/pbori.pyx", line 4115, in sage.rings.polynomial.pbori.BooleanPolynomial.subs (build/cythonized/sage/rings/polynomial/pbori.cpp:32460)
        gdict = P._monom_monoid.gens_dict()
      File "sage/structure/parent.pyx", line 840, in sage.structure.parent.Parent.__getattr__ (build/cythonized/sage/structure/parent.c:7903)
        attr = getattr_from_other_class(self, self._category.parent_class, name)
      File "sage/structure/misc.pyx", line 253, in sage.structure.misc.getattr_from_other_class (build/cythonized/sage/structure/misc.c:1583)
        raise dummy_attribute_error
    AttributeError: 'BooleanMonomialMonoid_with_category' object has no attribute 'gens_dict'
**********************************************************************
```



---

Comment by jdemeyer created at 2015-05-05 08:34:41

Changing status from needs_info to needs_review.


---

Comment by jdemeyer created at 2015-05-05 08:34:41

Replying to [comment:7 vdelecroix]:
> The class `ParentWithGens` is deprecated! There is no need for an attribute `_gens_dict` on all category objects. Why `Partitions` or `Integers` should have a method `gens` or `_gens_dict` attribute?

On the other hand, does it really hurt to have this extra attribute? We already have these attributes on `CategoryObject`:

```
cdef class CategoryObject(SageObject):
    cdef _generators
    cdef _category
    cdef public _base
    cdef public _cdata
    cdef public _names # will be _printer
    cdef public _factory_data
    cdef object __weakref__
    cdef long _hash_value
```


The point is: `CategoryObject` already has functions dealing with generators, such as the `_populate_generators_()` method. So why not `gens_dict()` then?

And my proposed patch is actually compatible with the deprecation of `ParentWithGens`, since it _removes_ something from `ParentWithGens`.


---

Comment by git created at 2015-05-05 08:46:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-05-05 13:37:35

Let me remind that this ticket is not about the proper place to put the `gens_dict()` method, but just about doing the caching properly.


---

Comment by jdemeyer created at 2015-05-13 05:37:58

Would you prefer to remove the caching completely in `gens_dict()`?


---

Comment by vdelecroix created at 2015-05-13 07:06:04

Replying to [comment:14 jdemeyer]:
> Would you prefer to remove the caching completely in `gens_dict()`?

+1 to me. Building a dictionary is very fast. I had a quick look through the source code. And no functions relies on it for critical computations (mostly it is to build a polynomial from a string). Note that the fastest way I found to allocate a dictionary is through `dict.fromkeys`.

Could you also remove the custom implementation in `PolynomialRing` as the following seems to work

```
sage: Parent.gens_dict(QQ['x'])
{'x': x}
sage: Parent.gens_dict(QQ['x,y'])
{'x': x, 'y': y}
```


Vincent


---

Comment by vdelecroix created at 2015-05-13 07:06:15

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-05-19 12:36:54

Replying to [comment:15 vdelecroix]:
> Could you also remove the custom implementation in `PolynomialRing`
No, I disagree. The reason is that the `PolynomialRing` implementation is much more elegant than the generic `CategoryObject` implementation. If I could (but I cannot), I would keep _only_ the `PolynomialRing` implementation.


---

Comment by git created at 2015-05-19 12:57:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-05-19 12:59:59

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-05-20 19:53:51

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-05-21 18:30:45

Resolution: fixed
