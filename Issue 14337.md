# Issue 14337: Family over enumerated set has wrong category

archive/issues_014337.json:
```json
{
    "body": "Assignee: @nthiery\n\nKeywords: Family, Category of finite enumerated sets\n\nThis happens with Sage 5.10beta1:\n\n\n```\nsage: P=Permutations()\nsage: print P.category()\nCategory of sets\nsage: print P.cardinality()\n+Infinity\nsage: F=Family(Permutations(), lambda i:i)\nsage: print F.category()\nCategory of finite enumerated sets\n```\n\n\nBut clearly `F` is not finite...\n\nIssue created by migration from https://trac.sagemath.org/ticket/14541\n\n",
    "created_at": "2013-05-06T19:00:45Z",
    "labels": [
        "categories",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Family over enumerated set has wrong category",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14337",
    "user": "@cnassau"
}
```
Assignee: @nthiery

Keywords: Family, Category of finite enumerated sets

This happens with Sage 5.10beta1:


```
sage: P=Permutations()
sage: print P.category()
Category of sets
sage: print P.cardinality()
+Infinity
sage: F=Family(Permutations(), lambda i:i)
sage: print F.category()
Category of finite enumerated sets
```


But clearly `F` is not finite...

Issue created by migration from https://trac.sagemath.org/ticket/14541





---

archive/issue_comments_181104.json:
```json
{
    "body": "Thanks for the report!\n\nHmm, that's annoying indeed. This stems from the fact that `Permutations` still uses the old CombinatorialClass, and for those it's not so easy to detect easily whether they are known to be finite.\n\nAs a workaround, line 832 of Family, when the input is a CombinatorialClass, we could ask whether x.cardinality() != infinity. The risk is to trigger the enumeration of the elements of the combinatorial class which might take a while ... Or check if cardinality actually is implemented (i.e. is not the default _cardinality_from_iterator), and if yes call it.\n\nOf course, the proper fix would be to revamp permutations to be an enumerated set like has been done recently for tableaux.\n\nWould you be willing to handle any of the above?",
    "created_at": "2013-05-06T22:18:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14337#issuecomment-181104",
    "user": "@nthiery"
}
```

Thanks for the report!

Hmm, that's annoying indeed. This stems from the fact that `Permutations` still uses the old CombinatorialClass, and for those it's not so easy to detect easily whether they are known to be finite.

As a workaround, line 832 of Family, when the input is a CombinatorialClass, we could ask whether x.cardinality() != infinity. The risk is to trigger the enumeration of the elements of the combinatorial class which might take a while ... Or check if cardinality actually is implemented (i.e. is not the default _cardinality_from_iterator), and if yes call it.

Of course, the proper fix would be to revamp permutations to be an enumerated set like has been done recently for tableaux.

Would you be willing to handle any of the above?



---

archive/issue_comments_181105.json:
```json
{
    "body": "I actually don't care about `Permutations()` a lot - I just picked those to come up with an easily reproducible problem. I should have given this example:\n\n\n```\nsage: X=CombinatorialFreeModule(ZZ,ZZ)\nsage: print X\nFree module generated by Integer Ring over Integer Ring\nsage: print X.basis().category()\nCategory of enumerated sets\nsage: TX = tensor((X,))\nsage: print TX.basis().category()\nCategory of finite enumerated sets\n```\n\n\nI believe I fixed this in #13979 for Sage 5.7.b4 (which was neither merged nor even considered).",
    "created_at": "2013-05-07T09:30:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14337#issuecomment-181105",
    "user": "@cnassau"
}
```

I actually don't care about `Permutations()` a lot - I just picked those to come up with an easily reproducible problem. I should have given this example:


```
sage: X=CombinatorialFreeModule(ZZ,ZZ)
sage: print X
Free module generated by Integer Ring over Integer Ring
sage: print X.basis().category()
Category of enumerated sets
sage: TX = tensor((X,))
sage: print TX.basis().category()
Category of finite enumerated sets
```


I believe I fixed this in #13979 for Sage 5.7.b4 (which was neither merged nor even considered).



---

archive/issue_comments_181106.json:
```json
{
    "body": "Replying to [comment:1 nthiery]:\n> As a workaround, line 832 of Family, when the input is a CombinatorialClass, we could ask whether x.cardinality() != infinity. The risk is to trigger the enumeration of the elements of the combinatorial class which might take a while ... Or check if cardinality actually is implemented (i.e. is not the default _cardinality_from_iterator), and if yes call it.\n\nThis sounds like a solution that might fix the issue that I'm seeing with my (still nascent) Steenrod algebra module package. I'll try to prepare a patch along these lines.",
    "created_at": "2013-05-07T10:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14337#issuecomment-181106",
    "user": "@cnassau"
}
```

Replying to [comment:1 nthiery]:
> As a workaround, line 832 of Family, when the input is a CombinatorialClass, we could ask whether x.cardinality() != infinity. The risk is to trigger the enumeration of the elements of the combinatorial class which might take a while ... Or check if cardinality actually is implemented (i.e. is not the default _cardinality_from_iterator), and if yes call it.

This sounds like a solution that might fix the issue that I'm seeing with my (still nascent) Steenrod algebra module package. I'll try to prepare a patch along these lines.



---

archive/issue_comments_181107.json:
```json
{
    "body": "Attachment [14541.patch](tarball://root/attachments/some-uuid/ticket14541/14541.patch) by @cnassau created at 2013-05-07 15:01:57\n\nThe attached patch changes the category initialization of `LazyFamily` objects: if the keys `K` are an instance of `CombinatorialClass` the category choice now depends on \"`K.cardinality() < Infinity`\" in the obvious way.\n\n(I have not tried to inspect the keys `K` further, because I could not find a `CombinatorialClass` without custom `cardinality` method.)\n\nI have also added another exception to `LazyFamily.cardinality()`: the code used to check for `AttributeError` and `NotImplementedError`, but `CartesianProduct(...).__len__` raises a `TypeError` instead. I've added a doctest that fails otherwise.",
    "created_at": "2013-05-07T15:01:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14337#issuecomment-181107",
    "user": "@cnassau"
}
```

Attachment [14541.patch](tarball://root/attachments/some-uuid/ticket14541/14541.patch) by @cnassau created at 2013-05-07 15:01:57

The attached patch changes the category initialization of `LazyFamily` objects: if the keys `K` are an instance of `CombinatorialClass` the category choice now depends on "`K.cardinality() < Infinity`" in the obvious way.

(I have not tried to inspect the keys `K` further, because I could not find a `CombinatorialClass` without custom `cardinality` method.)

I have also added another exception to `LazyFamily.cardinality()`: the code used to check for `AttributeError` and `NotImplementedError`, but `CartesianProduct(...).__len__` raises a `TypeError` instead. I've added a doctest that fails otherwise.



---

archive/issue_comments_181108.json:
```json
{
    "body": "Changing keywords from \"Family, Category of finite enumerated sets\" to \"Family, Category of finite enumerated sets, CartesianProduct\".",
    "created_at": "2013-05-07T15:09:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14337#issuecomment-181108",
    "user": "@cnassau"
}
```

Changing keywords from "Family, Category of finite enumerated sets" to "Family, Category of finite enumerated sets, CartesianProduct".



---

archive/issue_comments_181109.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-05-07T15:09:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14337#issuecomment-181109",
    "user": "@cnassau"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_181110.json:
```json
{
    "body": "The bug reported has been fixed in the meantime by #14772 : permutations do not use `CombinatorialClass` anymore.\nThis does not fix the general problem however, and indeed one should not force the computation of the cardinality of this set unless this operations has been explicitly requested.\n\nThus, I upload a git branch which just removes `CombinatorialClass` from the list of exceptions. There is apparently no reason why all instances of `CombinatorialClass` should represent finite sets.\n\n(and I personally don't even see why an uncountable set should be said to be \"enumerable\", but that's another problem)\n\nNathann",
    "created_at": "2013-12-25T20:19:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14337#issuecomment-181110",
    "user": "@nathanncohen"
}
```

The bug reported has been fixed in the meantime by #14772 : permutations do not use `CombinatorialClass` anymore.
This does not fix the general problem however, and indeed one should not force the computation of the cardinality of this set unless this operations has been explicitly requested.

Thus, I upload a git branch which just removes `CombinatorialClass` from the list of exceptions. There is apparently no reason why all instances of `CombinatorialClass` should represent finite sets.

(and I personally don't even see why an uncountable set should be said to be "enumerable", but that's another problem)

Nathann



---

archive/issue_comments_181111.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-12-25T21:09:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14337#issuecomment-181111",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_181112.json:
```json
{
    "body": "patchbot:\n\n```\nsage -t --long src/sage/combinat/free_module.py  # 1 doctest failed\n```\n",
    "created_at": "2014-05-13T06:22:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14337#issuecomment-181112",
    "user": "@rwst"
}
```

patchbot:

```
sage -t --long src/sage/combinat/free_module.py  # 1 doctest failed
```




---

archive/issue_comments_181113.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-05-13T06:22:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14337#issuecomment-181113",
    "user": "@rwst"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_181114.json:
```json
{
    "body": "Okay  Ralf, I don't know how to fix that. I give up. If you understand category code please give it a try, I don't.\n\nNathann",
    "created_at": "2014-05-13T07:34:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14337#issuecomment-181114",
    "user": "@nathanncohen"
}
```

Okay  Ralf, I don't know how to fix that. I give up. If you understand category code please give it a try, I don't.

Nathann



---

archive/issue_comments_181115.json:
```json
{
    "body": "The first and second issues are fixed\n\n```\nsage: F = Family(Permutations(), lambda i: i)\nsage: F.category()\nCategory of infinite enumerated sets\nsage: Family(cartesian_product([ZZ,ZZ]),lambda (x,y) : (x+y,x-y)).cardinality()\n+Infinity\n```\n\nHowever, the last issue is still outstanding:\n\n```\nsage: X=CombinatorialFreeModule(ZZ,ZZ)\nsage: X.basis().category()\nCategory of infinite enumerated sets\nsage: TX = tensor((X,))\nsage: TX.basis().cardinality()\n+Infinity\nsage: TX.basis().category()\nCategory of finite enumerated sets\n```\n\nThis seems to be due to falling into a default of finite (enumerated) sets instead of just pulling the information from the category of the keys:\n\n```\nsage: TX.basis().keys()\nImage of Cartesian product of Integer Ring by <type 'tuple'>\nsage: TX.basis().keys().category()\nCategory of sets\n```\n\n\nAlso, the stopgap field is to be used for ticket(s) for the stopgaps.",
    "created_at": "2016-07-09T16:20:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14337#issuecomment-181115",
    "user": "@tscrim"
}
```

The first and second issues are fixed

```
sage: F = Family(Permutations(), lambda i: i)
sage: F.category()
Category of infinite enumerated sets
sage: Family(cartesian_product([ZZ,ZZ]),lambda (x,y) : (x+y,x-y)).cardinality()
+Infinity
```

However, the last issue is still outstanding:

```
sage: X=CombinatorialFreeModule(ZZ,ZZ)
sage: X.basis().category()
Category of infinite enumerated sets
sage: TX = tensor((X,))
sage: TX.basis().cardinality()
+Infinity
sage: TX.basis().category()
Category of finite enumerated sets
```

This seems to be due to falling into a default of finite (enumerated) sets instead of just pulling the information from the category of the keys:

```
sage: TX.basis().keys()
Image of Cartesian product of Integer Ring by <type 'tuple'>
sage: TX.basis().keys().category()
Category of sets
```


Also, the stopgap field is to be used for ticket(s) for the stopgaps.



---

archive/issue_comments_181116.json:
```json
{
    "body": "The remaining issue is a dup of #18849",
    "created_at": "2022-08-10T19:29:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14337#issuecomment-181116",
    "user": "@mkoeppe"
}
```

The remaining issue is a dup of #18849



---

archive/issue_comments_181117.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-08-10T19:30:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14337",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14337#issuecomment-181117",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to needs_review.
