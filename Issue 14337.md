# Issue 14337: Family over enumerated set has wrong category

Issue created by migration from Trac.

Original creator: cnassau

Original creation time: 2013-05-06 19:00:45

Assignee: nthiery

Keywords: Family, Category of finite enumerated sets

This happens with Sage 5.10beta1:


```
sage: P=Permutations()
sage: print P.category()
Category of sets
sage: print P.cardinality()
+Infinity
sage: F=Family(Permutations(), lambda i:i)
sage: print F.category()
Category of finite enumerated sets
```


But clearly `F` is not finite...


---

Comment by nthiery created at 2013-05-06 22:18:47

Thanks for the report!

Hmm, that's annoying indeed. This stems from the fact that `Permutations` still uses the old CombinatorialClass, and for those it's not so easy to detect easily whether they are known to be finite.

As a workaround, line 832 of Family, when the input is a CombinatorialClass, we could ask whether x.cardinality() != infinity. The risk is to trigger the enumeration of the elements of the combinatorial class which might take a while ... Or check if cardinality actually is implemented (i.e. is not the default _cardinality_from_iterator), and if yes call it.

Of course, the proper fix would be to revamp permutations to be an enumerated set like has been done recently for tableaux.

Would you be willing to handle any of the above?


---

Comment by cnassau created at 2013-05-07 09:30:53

I actually don't care about `Permutations()` a lot - I just picked those to come up with an easily reproducible problem. I should have given this example:


```
sage: X=CombinatorialFreeModule(ZZ,ZZ)
sage: print X
Free module generated by Integer Ring over Integer Ring
sage: print X.basis().category()
Category of enumerated sets
sage: TX = tensor((X,))
sage: print TX.basis().category()
Category of finite enumerated sets
```


I believe I fixed this in #13979 for Sage 5.7.b4 (which was neither merged nor even considered).


---

Comment by cnassau created at 2013-05-07 10:25:23

Replying to [comment:1 nthiery]:
> As a workaround, line 832 of Family, when the input is a CombinatorialClass, we could ask whether x.cardinality() != infinity. The risk is to trigger the enumeration of the elements of the combinatorial class which might take a while ... Or check if cardinality actually is implemented (i.e. is not the default _cardinality_from_iterator), and if yes call it.

This sounds like a solution that might fix the issue that I'm seeing with my (still nascent) Steenrod algebra module package. I'll try to prepare a patch along these lines.


---

Attachment

The attached patch changes the category initialization of `LazyFamily` objects: if the keys `K` are an instance of `CombinatorialClass` the category choice now depends on "`K.cardinality() < Infinity`" in the obvious way.

(I have not tried to inspect the keys `K` further, because I could not find a `CombinatorialClass` without custom `cardinality` method.)

I have also added another exception to `LazyFamily.cardinality()`: the code used to check for `AttributeError` and `NotImplementedError`, but `CartesianProduct(...).__len__` raises a `TypeError` instead. I've added a doctest that fails otherwise.


---

Comment by cnassau created at 2013-05-07 15:09:01

Changing keywords from "Family, Category of finite enumerated sets" to "Family, Category of finite enumerated sets, CartesianProduct".


---

Comment by cnassau created at 2013-05-07 15:09:01

Changing status from new to needs_review.


---

Comment by ncohen created at 2013-12-25 20:19:19

The bug reported has been fixed in the meantime by #14772 : permutations do not use `CombinatorialClass` anymore.
This does not fix the general problem however, and indeed one should not force the computation of the cardinality of this set unless this operations has been explicitly requested.

Thus, I upload a git branch which just removes `CombinatorialClass` from the list of exceptions. There is apparently no reason why all instances of `CombinatorialClass` should represent finite sets.

(and I personally don't even see why an uncountable set should be said to be "enumerable", but that's another problem)

Nathann


---

Comment by git created at 2013-12-25 21:09:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-05-13 06:22:52

patchbot:

```
sage -t --long src/sage/combinat/free_module.py  # 1 doctest failed
```



---

Comment by rws created at 2014-05-13 06:22:52

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2014-05-13 07:34:58

Okay  Ralf, I don't know how to fix that. I give up. If you understand category code please give it a try, I don't.

Nathann


---

Comment by tscrim created at 2016-07-09 16:20:37

The first and second issues are fixed

```
sage: F = Family(Permutations(), lambda i: i)
sage: F.category()
Category of infinite enumerated sets
sage: Family(cartesian_product([ZZ,ZZ]),lambda (x,y) : (x+y,x-y)).cardinality()
+Infinity
```

However, the last issue is still outstanding:

```
sage: X=CombinatorialFreeModule(ZZ,ZZ)
sage: X.basis().category()
Category of infinite enumerated sets
sage: TX = tensor((X,))
sage: TX.basis().cardinality()
+Infinity
sage: TX.basis().category()
Category of finite enumerated sets
```

This seems to be due to falling into a default of finite (enumerated) sets instead of just pulling the information from the category of the keys:

```
sage: TX.basis().keys()
Image of Cartesian product of Integer Ring by <type 'tuple'>
sage: TX.basis().keys().category()
Category of sets
```


Also, the stopgap field is to be used for ticket(s) for the stopgaps.


---

Comment by mkoeppe created at 2022-08-10 19:29:57

The remaining issue is a dup of #18849


---

Comment by mkoeppe created at 2022-08-10 19:30:30

Changing status from needs_work to needs_review.
