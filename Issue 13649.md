# Issue 13649: Correct FreeModule.coordinates() to match specification

Issue created by migration from https://trac.sagemath.org/ticket/13853

Original creator: Bouillaguet

Original creation time: 2012-12-19 23:03:55

Assignee: jason, was

CC:  jason

The docstring of the `FreeModule.coordinates` method advertizes a `check` parameters, which defaults to `True`, and whose effect is in principle to check that the arguments belongs to the module. If not, an `ArithmeticError` is said to be raised.

The actual implementation deviates in several ways.

* The `check` parameter does not check that the argument belongs to the module. It checks that the argument belongs to the ambient vector space of the module. The coordinates returned are coordinates in the ambient vector space.

```
sage: M = ZZ^3
sage: v = vector(ZZ, [1/2,0,1])
sage: v in M
False
sage: M.coordinates(v)
[1/2, 0, 1]
```

According to the docstring, the call to `M.coordinates(v)` should have failed with an `ArithmeticError` exception

* When the method fails, it does not fail with the right exception.

```
sage: M = ZZ^3
sage: M.coordinates( [sqrt(2), 1, 1] )
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
...
TypeError: unable to convert sqrt(2) to a rational
```

According to the spec, it should have failed with an `ArithmeticError` exception.


**Proposed Solution** : modify the function so that its behavior match the specification, by rejecting things that are not in the module itself with an `ArithmeticError` exception

Arguments AGAINST modifying the specification to match the present behavior are:
 * The ambient vector space does not always exist (e.g. when the ring is not a PID)
 * When it does, the present functionnality is still available through `M.ambient_vector_space().coordinates()`


---

Comment by Bouillaguet created at 2013-01-02 23:10:04

Changing status from new to needs_review.


---

Comment by tkluck created at 2013-02-28 16:53:36

> Arguments AGAINST modifying the specification to match the present behavior are:
> * The ambient vector space does not always exist (e.g. when the ring is not a PID)
> * When it does, the present functionnality is still available through `M.vector_space().coordinates()`
I feel these are actually very good arguments. Could you explain why you chose to update the code instead of the documentation?

I haven't looked at your patch yet.


---

Comment by Bouillaguet created at 2013-02-28 18:26:00

Replying to [comment:4 tkluck]:
> I feel these are actually very good arguments. Could you explain why you chose to update the code instead of the documentation?

I you think that these are good arguments, then why ask me the reason for which I followed them?

I chose to make the code implement the actual specification, because it is reasonable and makes sense. Modifying the spec in conformance with what the actual implementation does would be more complicated and would make less sense (for instance : "this function returns a vector over the fraction field of the base ring"... but what if the said fraction field does not exist?).


---

Comment by tkluck created at 2013-03-01 00:25:15

Replying to [comment:5 Bouillaguet]:
> Replying to [comment:4 tkluck]:
> > I feel these are actually very good arguments. Could you explain why you chose to update the code instead of the documentation?
> 
> I you think that these are good arguments, then why ask me the reason for which I followed them?
> 
Sorry, I misunderstood your explanation. I would have spotted that if I read the patch. I will review this for you.


---

Comment by tkluck created at 2013-03-11 15:04:21

I tested your patch. Overall, it looks very good. I like the attention to detail evident from including a doctest such as

```
Wrong arguments are presumably caught with a ``TypeError`` exception:: 
	 
    sage: (ZZ^3).coordinates( QQ ) 
    Traceback (most recent call last): 
    ... 
    TypeError: can't initialize vector from nonzero non-list 
```


I tried the examples you gave in the bug description. The first one:

```
sage: M = ZZ^3
sage: v = vector(ZZ, [1/2,0,1])
sage: v in M
False
sage: M.coordinates(v)
[1/2, 0, 1]
```

already fails with a `TypeError` in the call to `vector`. However, after replacing `ZZ` by `QQ`, and with your patch applied, the call to `M.coordinates` gives the desired `ArithmeticError`.

Your second example still gives the same `TypeError`. Maybe that needs some work, but I don't mind either way. I'll set it to needs-work, but I would be willing to give a positive review if you would just document the fact that it could also raise a `TypeError` (depending on "how badly" the coordinate is outside of the base ring).

There should be a space after the comma in 

```
sage/modules/free_module.py:

    except (TypeError,ArithmeticError): 
```



---

Comment by tkluck created at 2013-03-11 15:04:21

Changing status from needs_review to needs_work.


---

Comment by Bouillaguet created at 2013-03-12 09:12:36

Must be rebased on top of #13780


---

Comment by Bouillaguet created at 2013-03-12 10:56:13

Changing status from needs_work to needs_review.


---

Comment by Bouillaguet created at 2013-03-12 10:56:13

Hi Timo,

Thanks for your comments. I think I adressed them. I agree that a `TypeError` is in order for ``sqrt(2)``.

I updated the patch


---

Attachment


---

Comment by git created at 2013-12-22 09:47:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-04-05 13:47:51

Changing status from needs_review to positive_review.


---

Comment by rws created at 2014-04-05 13:47:51

Rebased on 6.2.beta6. Long tests pass in number_field/, geometry/, modular/, modules/.
----
New commits:


---

Comment by tscrim created at 2014-04-06 17:18:47

Changing status from positive_review to needs_work.


---

Comment by tscrim created at 2014-04-06 17:18:47

From looking at the diff, it seems like doctests were removed. Also, we should try to use python3 syntax whenever possible (in particular, raising an error should be `raise ValueError("this is the message")`).


---

Comment by rws created at 2014-04-07 09:12:29

Agree. While the one in `coordinate_vector()` was a duplicate of one in `coordinates()`, others were unique and shouldn't have been deleted. Another thing to look for by the reviewer.
