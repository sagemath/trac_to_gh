# Issue 13649: Correct FreeModule.coordinates() to match specification

archive/issues_013649.json:
```json
{
    "body": "Assignee: jason, was\n\nCC:  @jasongrout\n\nThe docstring of the `FreeModule.coordinates` method advertizes a `check` parameters, which defaults to `True`, and whose effect is in principle to check that the arguments belongs to the module. If not, an `ArithmeticError` is said to be raised.\n\nThe actual implementation deviates in several ways.\n\n* The `check` parameter does not check that the argument belongs to the module. It checks that the argument belongs to the ambient vector space of the module. The coordinates returned are coordinates in the ambient vector space.\n\n```\nsage: M = ZZ^3\nsage: v = vector(ZZ, [1/2,0,1])\nsage: v in M\nFalse\nsage: M.coordinates(v)\n[1/2, 0, 1]\n```\nAccording to the docstring, the call to `M.coordinates(v)` should have failed with an `ArithmeticError` exception\n\n* When the method fails, it does not fail with the right exception.\n\n```\nsage: M = ZZ^3\nsage: M.coordinates( [sqrt(2), 1, 1] )\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n...\nTypeError: unable to convert sqrt(2) to a rational\n```\nAccording to the spec, it should have failed with an `ArithmeticError` exception.\n\n\n**Proposed Solution** : modify the function so that its behavior match the specification, by rejecting things that are not in the module itself with an `ArithmeticError` exception\n\nArguments AGAINST modifying the specification to match the present behavior are:\n* The ambient vector space does not always exist (e.g. when the ring is not a PID)\n* When it does, the present functionnality is still available through `M.ambient_vector_space().coordinates()`\n\nIssue created by migration from https://trac.sagemath.org/ticket/13853\n\n",
    "created_at": "2012-12-19T23:03:55Z",
    "labels": [
        "component: linear algebra",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Correct FreeModule.coordinates() to match specification",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13649",
    "user": "https://trac.sagemath.org/admin/accounts/users/Bouillaguet"
}
```
Assignee: jason, was

CC:  @jasongrout

The docstring of the `FreeModule.coordinates` method advertizes a `check` parameters, which defaults to `True`, and whose effect is in principle to check that the arguments belongs to the module. If not, an `ArithmeticError` is said to be raised.

The actual implementation deviates in several ways.

* The `check` parameter does not check that the argument belongs to the module. It checks that the argument belongs to the ambient vector space of the module. The coordinates returned are coordinates in the ambient vector space.

```
sage: M = ZZ^3
sage: v = vector(ZZ, [1/2,0,1])
sage: v in M
False
sage: M.coordinates(v)
[1/2, 0, 1]
```
According to the docstring, the call to `M.coordinates(v)` should have failed with an `ArithmeticError` exception

* When the method fails, it does not fail with the right exception.

```
sage: M = ZZ^3
sage: M.coordinates( [sqrt(2), 1, 1] )
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
...
TypeError: unable to convert sqrt(2) to a rational
```
According to the spec, it should have failed with an `ArithmeticError` exception.


**Proposed Solution** : modify the function so that its behavior match the specification, by rejecting things that are not in the module itself with an `ArithmeticError` exception

Arguments AGAINST modifying the specification to match the present behavior are:
* The ambient vector space does not always exist (e.g. when the ring is not a PID)
* When it does, the present functionnality is still available through `M.ambient_vector_space().coordinates()`

Issue created by migration from https://trac.sagemath.org/ticket/13853





---

archive/issue_comments_168684.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-01-02T23:10:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13649#issuecomment-168684",
    "user": "https://trac.sagemath.org/admin/accounts/users/Bouillaguet"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_168685.json:
```json
{
    "body": "> Arguments AGAINST modifying the specification to match the present behavior are:\n> * The ambient vector space does not always exist (e.g. when the ring is not a PID)\n> * When it does, the present functionnality is still available through `M.vector_space().coordinates()`\n \nI feel these are actually very good arguments. Could you explain why you chose to update the code instead of the documentation?\n\nI haven't looked at your patch yet.",
    "created_at": "2013-02-28T16:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13649#issuecomment-168685",
    "user": "https://github.com/tkluck"
}
```

> Arguments AGAINST modifying the specification to match the present behavior are:
> * The ambient vector space does not always exist (e.g. when the ring is not a PID)
> * When it does, the present functionnality is still available through `M.vector_space().coordinates()`
 
I feel these are actually very good arguments. Could you explain why you chose to update the code instead of the documentation?

I haven't looked at your patch yet.



---

archive/issue_comments_168686.json:
```json
{
    "body": "Replying to [comment:4 tkluck]:\n> I feel these are actually very good arguments. Could you explain why you chose to update the code instead of the documentation?\n\n\nI you think that these are good arguments, then why ask me the reason for which I followed them?\n\nI chose to make the code implement the actual specification, because it is reasonable and makes sense. Modifying the spec in conformance with what the actual implementation does would be more complicated and would make less sense (for instance : \"this function returns a vector over the fraction field of the base ring\"... but what if the said fraction field does not exist?).",
    "created_at": "2013-02-28T18:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13649#issuecomment-168686",
    "user": "https://trac.sagemath.org/admin/accounts/users/Bouillaguet"
}
```

Replying to [comment:4 tkluck]:
> I feel these are actually very good arguments. Could you explain why you chose to update the code instead of the documentation?


I you think that these are good arguments, then why ask me the reason for which I followed them?

I chose to make the code implement the actual specification, because it is reasonable and makes sense. Modifying the spec in conformance with what the actual implementation does would be more complicated and would make less sense (for instance : "this function returns a vector over the fraction field of the base ring"... but what if the said fraction field does not exist?).



---

archive/issue_comments_168687.json:
```json
{
    "body": "Replying to [comment:5 Bouillaguet]:\n> Replying to [comment:4 tkluck]:\n> > I feel these are actually very good arguments. Could you explain why you chose to update the code instead of the documentation?\n\n> \n> I you think that these are good arguments, then why ask me the reason for which I followed them?\n> \n\nSorry, I misunderstood your explanation. I would have spotted that if I read the patch. I will review this for you.",
    "created_at": "2013-03-01T00:25:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13649#issuecomment-168687",
    "user": "https://github.com/tkluck"
}
```

Replying to [comment:5 Bouillaguet]:
> Replying to [comment:4 tkluck]:
> > I feel these are actually very good arguments. Could you explain why you chose to update the code instead of the documentation?

> 
> I you think that these are good arguments, then why ask me the reason for which I followed them?
> 

Sorry, I misunderstood your explanation. I would have spotted that if I read the patch. I will review this for you.



---

archive/issue_comments_168688.json:
```json
{
    "body": "I tested your patch. Overall, it looks very good. I like the attention to detail evident from including a doctest such as\n\n```\nWrong arguments are presumably caught with a ``TypeError`` exception:: \n\t \n    sage: (ZZ^3).coordinates( QQ ) \n    Traceback (most recent call last): \n    ... \n    TypeError: can't initialize vector from nonzero non-list \n```\n\nI tried the examples you gave in the bug description. The first one:\n\n```\nsage: M = ZZ^3\nsage: v = vector(ZZ, [1/2,0,1])\nsage: v in M\nFalse\nsage: M.coordinates(v)\n[1/2, 0, 1]\n```\nalready fails with a `TypeError` in the call to `vector`. However, after replacing `ZZ` by `QQ`, and with your patch applied, the call to `M.coordinates` gives the desired `ArithmeticError`.\n\nYour second example still gives the same `TypeError`. Maybe that needs some work, but I don't mind either way. I'll set it to needs-work, but I would be willing to give a positive review if you would just document the fact that it could also raise a `TypeError` (depending on \"how badly\" the coordinate is outside of the base ring).\n\nThere should be a space after the comma in \n\n```\nsage/modules/free_module.py:\n\n    except (TypeError,ArithmeticError): \n```",
    "created_at": "2013-03-11T15:04:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13649#issuecomment-168688",
    "user": "https://github.com/tkluck"
}
```

I tested your patch. Overall, it looks very good. I like the attention to detail evident from including a doctest such as

```
Wrong arguments are presumably caught with a ``TypeError`` exception:: 
	 
    sage: (ZZ^3).coordinates( QQ ) 
    Traceback (most recent call last): 
    ... 
    TypeError: can't initialize vector from nonzero non-list 
```

I tried the examples you gave in the bug description. The first one:

```
sage: M = ZZ^3
sage: v = vector(ZZ, [1/2,0,1])
sage: v in M
False
sage: M.coordinates(v)
[1/2, 0, 1]
```
already fails with a `TypeError` in the call to `vector`. However, after replacing `ZZ` by `QQ`, and with your patch applied, the call to `M.coordinates` gives the desired `ArithmeticError`.

Your second example still gives the same `TypeError`. Maybe that needs some work, but I don't mind either way. I'll set it to needs-work, but I would be willing to give a positive review if you would just document the fact that it could also raise a `TypeError` (depending on "how badly" the coordinate is outside of the base ring).

There should be a space after the comma in 

```
sage/modules/free_module.py:

    except (TypeError,ArithmeticError): 
```



---

archive/issue_comments_168689.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-03-11T15:04:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13649#issuecomment-168689",
    "user": "https://github.com/tkluck"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_168690.json:
```json
{
    "body": "Must be rebased on top of #13780",
    "created_at": "2013-03-12T09:12:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13649#issuecomment-168690",
    "user": "https://trac.sagemath.org/admin/accounts/users/Bouillaguet"
}
```

Must be rebased on top of #13780



---

archive/issue_comments_168691.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-03-12T10:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13649#issuecomment-168691",
    "user": "https://trac.sagemath.org/admin/accounts/users/Bouillaguet"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_168692.json:
```json
{
    "body": "Hi Timo,\n\nThanks for your comments. I think I adressed them. I agree that a `TypeError` is in order for ``sqrt(2)``.\n\nI updated the patch",
    "created_at": "2013-03-12T10:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13649#issuecomment-168692",
    "user": "https://trac.sagemath.org/admin/accounts/users/Bouillaguet"
}
```

Hi Timo,

Thanks for your comments. I think I adressed them. I agree that a `TypeError` is in order for ``sqrt(2)``.

I updated the patch



---

archive/issue_events_038873.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13649#event-38873"
}
```



---

archive/issue_comments_168693.json:
```json
{
    "body": "Attachment [13853_fix_modules_coordinates.patch](tarball://root/attachments/some-uuid/ticket13853/13853_fix_modules_coordinates.patch) by @jdemeyer created at 2013-08-13 15:35:53",
    "created_at": "2013-08-13T15:35:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13649#issuecomment-168693",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [13853_fix_modules_coordinates.patch](tarball://root/attachments/some-uuid/ticket13853/13853_fix_modules_coordinates.patch) by @jdemeyer created at 2013-08-13 15:35:53



---

archive/issue_comments_168694.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-12-22T09:47:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13649#issuecomment-168694",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_038874.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13649#event-38874"
}
```



---

archive/issue_events_038875.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13649#event-38875"
}
```



---

archive/issue_comments_168695.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-04-05T13:47:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13649#issuecomment-168695",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_168696.json:
```json
{
    "body": "Rebased on 6.2.beta6. Long tests pass in number_field/, geometry/, modular/, modules/.\n\n---\nNew commits:",
    "created_at": "2014-04-05T13:47:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13649#issuecomment-168696",
    "user": "https://github.com/rwst"
}
```

Rebased on 6.2.beta6. Long tests pass in number_field/, geometry/, modular/, modules/.

---
New commits:



---

archive/issue_comments_168697.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2014-04-06T17:18:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13649#issuecomment-168697",
    "user": "https://github.com/tscrim"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_168698.json:
```json
{
    "body": "From looking at the diff, it seems like doctests were removed. Also, we should try to use python3 syntax whenever possible (in particular, raising an error should be `raise ValueError(\"this is the message\")`).",
    "created_at": "2014-04-06T17:18:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13649#issuecomment-168698",
    "user": "https://github.com/tscrim"
}
```

From looking at the diff, it seems like doctests were removed. Also, we should try to use python3 syntax whenever possible (in particular, raising an error should be `raise ValueError("this is the message")`).



---

archive/issue_comments_168699.json:
```json
{
    "body": "Agree. While the one in `coordinate_vector()` was a duplicate of one in `coordinates()`, others were unique and shouldn't have been deleted. Another thing to look for by the reviewer.",
    "created_at": "2014-04-07T09:12:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13649#issuecomment-168699",
    "user": "https://github.com/rwst"
}
```

Agree. While the one in `coordinate_vector()` was a duplicate of one in `coordinates()`, others were unique and shouldn't have been deleted. Another thing to look for by the reviewer.



---

archive/issue_events_038876.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13649#event-38876"
}
```



---

archive/issue_events_038877.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13649#event-38877"
}
```



---

archive/issue_events_038878.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13649#event-38878"
}
```



---

archive/issue_events_038879.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13649",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13649#event-38879"
}
```
