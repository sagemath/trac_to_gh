# Issue 30339: Python 3.6: Fix locale/encoding issues

Issue created by migration from https://trac.sagemath.org/ticket/30576

Original creator: mkoeppe

Original creation time: 2020-09-15 15:18:32

CC:  arojas dimpase slelievre mjo fbissey embray chapoton

Follow-up from #29033, #30053.

And a failure building the documentation on `ubuntu-bionic-standard` (using `/usr/bin/python3.6`, https://github.com/mkoeppe/sage/runs/1106251169):

```
  [dochtml]   UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 2661: ordinal not in range(128)
  [dochtml] Full log file: logs/dochtml.log
Makefile:1876: recipe for target 'doc-html' failed
```



---

Comment by slabbe created at 2020-09-15 15:33:46

Posting my branch containing few changes that need to be done in order to build doc with ubuntu 18.04 bionic and python 3.6.

The changes are not sufficient. Other similar issues arise when sphinx is running...
----
New commits:


---

Comment by slabbe created at 2020-09-16 08:44:24

Two comments here:

 - fixing the issues in the posted branch took a while because there are many `try - except` clauses in the doc-building which eat up all of the useful tracebacks.
 - I think the remaining issues are just WARNINGS that breaks the docbuild because we decided at some point in the past to consider WARNINGS as errors (which is fine). I base this observation on some hacky modifications I did in the `src/sage_setup/docbuild/sphinxbuild.py`. To confirm this, do you know if there is a way to build sage documentation by considering warnings just as warnings?


---

Comment by dimpase created at 2020-09-16 09:46:08

Warnings one keeps getting are errors in processing function arguments, i.e. in introspecting Python code. Ignoring them would give you a broken doc.

```
error while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.complete_primary_decomposition: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)
```


I think the problems come from a new(ish) sphinx which is run as a backend for our custom docbuilder, and anyway the move from Python 3.6 to 3.7 was somewhat big as far as utf-8 support is concerned.

I really think that fully supporting 3.6 is hard, and we have better things to do. Python has solved this problem by moving to 3.7, let's not reinvent the wheel here.


---

Comment by git created at 2020-09-16 23:48:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2020-09-17 07:05:44

Replying to [comment:3 dimpase]:
> Warnings one keeps getting are errors in processing function arguments, i.e. in introspecting Python code. Ignoring them would give you a broken doc.
> {{{
> error while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.complete_primary_decomposition: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)
> }}}

There are 2 things I don't understand here:

 - 4774 is an integer which is larger then the length of the string of the doc of `complete_primary_decomposition` method


```
sage: len(sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular
....: _repr.complete_primary_decomposition.__doc__)                             
3284
```


 - when I look at the html documentation of that method (after building the doc while ignoring the warnings with some hacky changes in `sphinxbuild.py`), I see no problem


---

Comment by slabbe created at 2020-09-17 08:30:23

>  - when I look at the html documentation of that method (after building the doc while ignoring the warnings with some hacky changes in `sphinxbuild.py`), I see no problem

With the current branch with no hacky changes, I can build the documentation with the flag `--keep-going`:


```
MAKE='make -j8' make build
MAKE='make -j8' ./sage --docbuild --no-pdf-links --keep-going all html
```


I am now trying to see what is wrong with the output doc...


---

Attachment


---

Comment by slabbe created at 2020-09-17 14:49:20

the command

```
MAKE='make -j8' build/bin/sage-logger -p './sage --docbuild --no-pdf-links --keep-going all html ' logs/dochtml-keepgoing.log
cd logs
grep error dochtml-keepgoing.log > error.log
```

gives relatively few errors (see 112 lines error.log attached). Very often it is the same error, for example, 60 of them are related to crystals code either `can't decode byte 0xe2 in position 6257` or `can't decode byte 0xc3 in position 3272` or `can't decode byte 0xcc in position 7825`.

I still do no know to which doc string these positions are refering to.


---

Comment by slelievre created at 2020-09-17 15:20:40

Hint:

```
$ python3 -q
>>> b'\xe2'.decode('latin1')
'â'
>>> b'\xc3'.decode('latin1')
'Ã'
>>> b'\xcc'.decode('latin1')
'Ì'
>>>
```



---

Comment by slabbe created at 2020-09-17 15:32:15

But these symbols do not occur in the crystals code:

```
$ cd SAGE_ROOT
$ git grep Ã *.py *pyx
$ git grep â *.py *pyx
src/sage/combinat/ncsf_qsym/tutorial.py:MacMahon, Knuth, Kreweras, Glânffrwd Thomas, Stanley. In 1984, Gessel
$ git grep Ì *.py *pyx
```



---

Comment by mkoeppe created at 2020-09-22 23:41:00

Changing priority from major to critical.


---

Comment by git created at 2020-09-22 23:57:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-09-23 00:18:00

Changing status from new to needs_review.


---

Comment by slabbe created at 2020-09-23 10:58:07

On Ubuntu 18.04, after uninstalling python3.8 so that python3.6 gets picked up by `./configure`:

```
## -------------------------------------------------------- ##                        
## Checking whether SageMath should install SPKG python3... ##                        ## -------------------------------------------------------- ##                        
configure:30688: checking whether any of sqlite libpng bzip2 xz libffi is installed as
 or will be installed as SPKG                                                         
configure:30697: result: no                                                           
configure:30707: checking for python3 >= 3.6, < 3.9 with modules sqlite3, ctypes, math
, hashlib, crypt, readline, socket, zlib, distutils.core                              
configure:30713: result:                                                              
configure:30728: checking ... whether /usr/bin/python3.6 is good                                                                      
configure:30921: result: yes                                                          
configure:30923: checking for python3 >= 3.6, < 3.9 with modules sqlite3, ctypes, math
, hashlib, crypt, readline, socket, zlib, distutils.core                              
configure:30982: result: /usr/bin/python3.6                                           
configure:30997: will use system package and not install SPKG python3    
```

I confirm that `make doc` now works ok. From me, it is a positive review.

I let someone change the status to positive review if no problem occurs on the github actions side.


---

Comment by mkoeppe created at 2020-09-23 12:02:15

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-09-23 12:02:15

Thanks for testing!

Also `ubuntu-bionic-standard` on GH Action is fixed (https://github.com/mkoeppe/sage/runs/1152418788). The failures seen in https://github.com/mkoeppe/sage/actions/runs/267855732 (for example for `ubuntu-bionic-minimal`) come from an unrelated ticket that I merged in the same branch.


---

Comment by vbraun created at 2020-09-27 09:10:02

Resolution: fixed
