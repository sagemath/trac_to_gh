# Issue 25383: Test failure in sage.rings.complex_arb on Cygwin

archive/issues_025383.json:
```json
{
    "body": "CC:  @fredrik-johansson\n\nKeywords: arb\n\n\n```\nFile \"src/sage/rings/complex_arb.pyx\", line 789, in sage.rings.complex_arb.ComplexBallField.?\nFailed example:\n    pol.roots(multiplicities=False, proof=False)\nExpected:\n    doctest:...\n    UserWarning: roots may have been lost...\n    [[0.001000000 +/- 2.52e-10] + [+/- 2.05e-10]*I,\n     [0.00100000 +/- 1.56e-10] + [+/- 1.27e-10]*I,\n     [18.20524201487994 +/- 1.22e-15] + [+/- 5.75e-37]*I,\n     [-14.72907378354557 +/- 4.63e-15] + [10.70100790294238 +/- 2.16e-15]*I,\n     [-14.72907378354557 +/- 4.63e-15] + [-10.70100790294238 +/- 2.16e-15]*I,\n     [5.625452776105595 +/- 2.29e-16] + [17.31459450084417 +/- 4.09e-15]*I,\n     [5.625452776105595 +/- 2.29e-16] + [-17.31459450084417 +/- 4.09e-15]*I]\nGot:\n    doctest:warning\n...\n    :\n    UserWarning: roots may have been lost\n    [[0.001000000 +/- 2.52e-10] + [+/- 2.05e-10]*I,\n     [0.00100000 +/- 1.56e-10] + [+/- 1.27e-10]*I,\n     [18.20524201487994 +/- 1.22e-15] + [+/- 5.75e-37]*I,\n     [-14.72907378354557 +/- 4.63e-15] + [10.70100790294238 +/- 2.16e-15]*I,\n     [-14.72907378354557 +/- 4.63e-15] + [-10.70100790294238 +/- 2.16e-15]*I,\n     [5.625452776105595 +/- 2.29e-16] + [-17.31459450084417 +/- 4.09e-15]*I,\n     [5.625452776105595 +/- 2.29e-16] + [17.31459450084417 +/- 4.09e-15]*I]\n```\n\n\nThe *only* difference (and I had to stare a while to see this) was in the sort order of the last 2 roots:\n\n\n```\n     [5.625452776105595 +/- 2.29e-16] + [17.31459450084417 +/- 4.09e-15]*I,\n     [5.625452776105595 +/- 2.29e-16] + [-17.31459450084417 +/- 4.09e-15]*I\n```\n\n\nvs\n\n\n```\n[5.625452776105595 +/- 2.29e-16] + [-17.31459450084417 +/- 4.09e-15]*I,\n[5.625452776105595 +/- 2.29e-16] + [17.31459450084417 +/- 4.09e-15]*I\n```\n\n\nwhere the only difference between the two is the sign on the complex part.\n\nThis failure, unsurprisingly, appears to be a possible problem with\narb; specifically the function _arb_vec_sort_pretty:\nhttps://github.com/fredrik-johansson/arb/blob/f4dda0f34f30cb8cbfe3b18eafc9e5e8480a88da/acb/vec_sort_pretty.c#L48\n\nI'm not sure why it only appears to be affecting me on Cygwin...\n\nIssue created by migration from https://trac.sagemath.org/ticket/25620\n\n",
    "created_at": "2018-06-20T14:31:36Z",
    "labels": [
        "component: porting: cygwin",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "Test failure in sage.rings.complex_arb on Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25383",
    "user": "https://github.com/embray"
}
```
CC:  @fredrik-johansson

Keywords: arb


```
File "src/sage/rings/complex_arb.pyx", line 789, in sage.rings.complex_arb.ComplexBallField.?
Failed example:
    pol.roots(multiplicities=False, proof=False)
Expected:
    doctest:...
    UserWarning: roots may have been lost...
    [[0.001000000 +/- 2.52e-10] + [+/- 2.05e-10]*I,
     [0.00100000 +/- 1.56e-10] + [+/- 1.27e-10]*I,
     [18.20524201487994 +/- 1.22e-15] + [+/- 5.75e-37]*I,
     [-14.72907378354557 +/- 4.63e-15] + [10.70100790294238 +/- 2.16e-15]*I,
     [-14.72907378354557 +/- 4.63e-15] + [-10.70100790294238 +/- 2.16e-15]*I,
     [5.625452776105595 +/- 2.29e-16] + [17.31459450084417 +/- 4.09e-15]*I,
     [5.625452776105595 +/- 2.29e-16] + [-17.31459450084417 +/- 4.09e-15]*I]
Got:
    doctest:warning
...
    :
    UserWarning: roots may have been lost
    [[0.001000000 +/- 2.52e-10] + [+/- 2.05e-10]*I,
     [0.00100000 +/- 1.56e-10] + [+/- 1.27e-10]*I,
     [18.20524201487994 +/- 1.22e-15] + [+/- 5.75e-37]*I,
     [-14.72907378354557 +/- 4.63e-15] + [10.70100790294238 +/- 2.16e-15]*I,
     [-14.72907378354557 +/- 4.63e-15] + [-10.70100790294238 +/- 2.16e-15]*I,
     [5.625452776105595 +/- 2.29e-16] + [-17.31459450084417 +/- 4.09e-15]*I,
     [5.625452776105595 +/- 2.29e-16] + [17.31459450084417 +/- 4.09e-15]*I]
```


The *only* difference (and I had to stare a while to see this) was in the sort order of the last 2 roots:


```
     [5.625452776105595 +/- 2.29e-16] + [17.31459450084417 +/- 4.09e-15]*I,
     [5.625452776105595 +/- 2.29e-16] + [-17.31459450084417 +/- 4.09e-15]*I
```


vs


```
[5.625452776105595 +/- 2.29e-16] + [-17.31459450084417 +/- 4.09e-15]*I,
[5.625452776105595 +/- 2.29e-16] + [17.31459450084417 +/- 4.09e-15]*I
```


where the only difference between the two is the sign on the complex part.

This failure, unsurprisingly, appears to be a possible problem with
arb; specifically the function _arb_vec_sort_pretty:
https://github.com/fredrik-johansson/arb/blob/f4dda0f34f30cb8cbfe3b18eafc9e5e8480a88da/acb/vec_sort_pretty.c#L48

I'm not sure why it only appears to be affecting me on Cygwin...

Issue created by migration from https://trac.sagemath.org/ticket/25620





---

archive/issue_comments_357533.json:
```json
{
    "body": "qsort() is not guaranteed to be a stable sort. I guess the two roots compare equal under arb's comparison function, and the qsort() implementations don't sort them in the same order.\n\nFredrik, assuming this is correct, would it make sense to use a total order in vec_cort_pretty()? Or should we work around the issue in sage?",
    "created_at": "2018-06-21T08:57:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25383#issuecomment-357533",
    "user": "https://github.com/mezzarobba"
}
```

qsort() is not guaranteed to be a stable sort. I guess the two roots compare equal under arb's comparison function, and the qsort() implementations don't sort them in the same order.

Fredrik, assuming this is correct, would it make sense to use a total order in vec_cort_pretty()? Or should we work around the issue in sage?



---

archive/issue_comments_357534.json:
```json
{
    "body": "It makes sense to fix the comparison function.",
    "created_at": "2018-06-21T09:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25383#issuecomment-357534",
    "user": "https://github.com/fredrik-johansson"
}
```

It makes sense to fix the comparison function.



---

archive/issue_comments_357535.json:
```json
{
    "body": "Even so, it would be just as easy to supply a workaround in Sage as well.  That said, perhaps the workaround is not high priority if the only affected platform is Cygwin.  Perhaps the only reason it's affecting Cygwin is due to differences in the qsort implementation.",
    "created_at": "2018-06-21T12:52:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25383#issuecomment-357535",
    "user": "https://github.com/embray"
}
```

Even so, it would be just as easy to supply a workaround in Sage as well.  That said, perhaps the workaround is not high priority if the only affected platform is Cygwin.  Perhaps the only reason it's affecting Cygwin is due to differences in the qsort implementation.



---

archive/issue_comments_357536.json:
```json
{
    "body": "FWIW, I am seeing this consistently (since 8.3-b0, including 8.3-b8) on macOS 10.11.6.  If I hack the source to reverse the last two entries in the root list, tests pass.",
    "created_at": "2018-07-01T20:44:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25383#issuecomment-357536",
    "user": "https://trac.sagemath.org/admin/accounts/users/justin"
}
```

FWIW, I am seeing this consistently (since 8.3-b0, including 8.3-b8) on macOS 10.11.6.  If I hack the source to reverse the last two entries in the root list, tests pass.



---

archive/issue_comments_357537.json:
```json
{
    "body": "Not returning the answer in the desired sort order isn't exactly blocker material. I'm happy to merge if you provide a timely fix, of courese.",
    "created_at": "2018-07-09T11:01:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25383#issuecomment-357537",
    "user": "https://github.com/vbraun"
}
```

Not returning the answer in the desired sort order isn't exactly blocker material. I'm happy to merge if you provide a timely fix, of courese.



---

archive/issue_comments_357538.json:
```json
{
    "body": "I believe any failing test or regression should be considered a blocker.  How can you guarantee useful continuous integration tests if every run fails?  Do I have to check the test results every time to see if something other than a known failure failed?\n\nIf nothing else, until and unless Sage's test suite has a way of marking known failures to be ignored this should be a blocker.",
    "created_at": "2018-07-09T11:14:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25383#issuecomment-357538",
    "user": "https://github.com/embray"
}
```

I believe any failing test or regression should be considered a blocker.  How can you guarantee useful continuous integration tests if every run fails?  Do I have to check the test results every time to see if something other than a known failure failed?

If nothing else, until and unless Sage's test suite has a way of marking known failures to be ignored this should be a blocker.



---

archive/issue_comments_357539.json:
```json
{
    "body": "Side note: it's one thing if it's just an occasional random failure if it's rare.  It's another if something fails consistently on some platforms.  A very simple fix to this would be to either change the code to provide additional sorting at the Python level, or change the test to not care (I'm fine with either).  But unless it's passing it should be a blocker.",
    "created_at": "2018-07-09T11:15:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25383#issuecomment-357539",
    "user": "https://github.com/embray"
}
```

Side note: it's one thing if it's just an occasional random failure if it's rare.  It's another if something fails consistently on some platforms.  A very simple fix to this would be to either change the code to provide additional sorting at the Python level, or change the test to not care (I'm fine with either).  But unless it's passing it should be a blocker.



---

archive/issue_comments_357540.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-07-09T16:03:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25383#issuecomment-357540",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_357541.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-07-09T16:03:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25383#issuecomment-357541",
    "user": "https://github.com/mezzarobba"
}
```

New commits:



---

archive/issue_comments_357542.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-07-09T17:33:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25383#issuecomment-357542",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_357543.json:
```json
{
    "body": "LGTM.",
    "created_at": "2018-07-09T17:33:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25383#issuecomment-357543",
    "user": "https://github.com/tscrim"
}
```

LGTM.



---

archive/issue_comments_357544.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-07-09T23:48:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25383#issuecomment-357544",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_357545.json:
```json
{
    "body": "Thanks--such a fix is good enough for me.",
    "created_at": "2018-07-10T10:43:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25383",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25383#issuecomment-357545",
    "user": "https://github.com/embray"
}
```

Thanks--such a fix is good enough for me.
