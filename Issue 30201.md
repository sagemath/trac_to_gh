# Issue 30201: Improve face iterator for almost simple/simplicial polytopes

archive/issues_030201.json:
```json
{
    "body": "CC:  @jplab @laisrast @tscrim\n\nKeywords: simple, simplicial, face iterator, polytope\n\n#30040 improved the face iterator for simple/simplicial polytopes.\n\nActually, the same trick can be applied for simple faces. (Note that the iterator treats simplicial polytopes dually).\n\nIf a face is simple then any intersections of it's facets is one of it's ridges or empty.\n\nAs this helps only sporadically, we cannot afford to compute for each face if it is simple. However, a cheap certificate of a face being simple is that it only contains \"simple vertices\" (with vertex figure a simplex).\n\nNow, at initialization the face iterator computes those \"simple vertices\" and checks inclusion of each face to determine if it is simple (if at least 10 percent of the vertices are simple). If a face is simple, we can skip the costly inclusion checks.\n\nBefore this ticket:\n\n\n```\nsage: P = polytopes.permutahedron(7)                                                                                                                                                                                                                                                                                                                                       \nsage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              \nsage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      \nsage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   \nCPU times: user 257 ms, sys: 7 \u00b5s, total: 257 ms\nWall time: 257 ms\n(1, 5041, 16251, 19761, 11144, 2860, 267, 1)\n\nsage: P = polytopes.associahedron(['A',7])                                                                                                                                                                                                                                                                                                                                 \nsage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              \nsage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      \nsage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   \nCPU times: user 13.5 ms, sys: 0 ns, total: 13.5 ms\nWall time: 13.4 ms\n(1, 1431, 5977, 10177, 9040, 4440, 1163, 134, 1)\nsage: P = polytopes.hypercube(12)                                                                                                                                                                                                                                                                                                                                          \nsage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              \nsage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      \nsage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   \nCPU times: user 419 ms, sys: 17 \u00b5s, total: 419 ms\nWall time: 419 ms\n(1, 4097, 28669, 92125, 180037, 238755, 226776, 158466, 82170, 31350, 8525, 1529, 145, 1)\n\n```\n\n\n\n```\nsage: P = polytopes.permutahedron(7)                                                                                                                                                                                                                                                                                                                                       \nsage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              \nsage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      \nsage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   \nCPU times: user 79.5 ms, sys: 0 ns, total: 79.5 ms\nWall time: 79.3 ms\n(1, 5041, 16251, 19761, 11144, 2860, 267, 1)\n\nsage: P = polytopes.associahedron(['A',7])                                                                                                                                                                                                                                                                                                                                 \nsage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              \nsage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      \nsage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   \nCPU times: user 9.85 ms, sys: 0 ns, total: 9.85 ms\nWall time: 9.72 ms\n(1, 1431, 5977, 10177, 9040, 4440, 1163, 134, 1)\n\nsage: P = polytopes.hypercube(12)                                                                                                                                                                                                                                                                                                                                          \nsage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              \nsage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      \nsage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   \nCPU times: user 391 ms, sys: 0 ns, total: 391 ms\nWall time: 391 ms\n(1, 4097, 28669, 92125, 180037, 238755, 226776, 158466, 82170, 31350, 8525, 1529, 145, 1)\n```\n\n\nNote that for the last instance, there isn't a significant amount of simple vertices so the old approach is chosen.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30438\n\n",
    "created_at": "2020-08-25T11:45:16Z",
    "labels": [
        "component: geometry"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Improve face iterator for almost simple/simplicial polytopes",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30201",
    "user": "https://github.com/kliem"
}
```
CC:  @jplab @laisrast @tscrim

Keywords: simple, simplicial, face iterator, polytope

#30040 improved the face iterator for simple/simplicial polytopes.

Actually, the same trick can be applied for simple faces. (Note that the iterator treats simplicial polytopes dually).

If a face is simple then any intersections of it's facets is one of it's ridges or empty.

As this helps only sporadically, we cannot afford to compute for each face if it is simple. However, a cheap certificate of a face being simple is that it only contains "simple vertices" (with vertex figure a simplex).

Now, at initialization the face iterator computes those "simple vertices" and checks inclusion of each face to determine if it is simple (if at least 10 percent of the vertices are simple). If a face is simple, we can skip the costly inclusion checks.

Before this ticket:


```
sage: P = polytopes.permutahedron(7)                                                                                                                                                                                                                                                                                                                                       
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 257 ms, sys: 7 µs, total: 257 ms
Wall time: 257 ms
(1, 5041, 16251, 19761, 11144, 2860, 267, 1)

sage: P = polytopes.associahedron(['A',7])                                                                                                                                                                                                                                                                                                                                 
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 13.5 ms, sys: 0 ns, total: 13.5 ms
Wall time: 13.4 ms
(1, 1431, 5977, 10177, 9040, 4440, 1163, 134, 1)
sage: P = polytopes.hypercube(12)                                                                                                                                                                                                                                                                                                                                          
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 419 ms, sys: 17 µs, total: 419 ms
Wall time: 419 ms
(1, 4097, 28669, 92125, 180037, 238755, 226776, 158466, 82170, 31350, 8525, 1529, 145, 1)

```



```
sage: P = polytopes.permutahedron(7)                                                                                                                                                                                                                                                                                                                                       
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 79.5 ms, sys: 0 ns, total: 79.5 ms
Wall time: 79.3 ms
(1, 5041, 16251, 19761, 11144, 2860, 267, 1)

sage: P = polytopes.associahedron(['A',7])                                                                                                                                                                                                                                                                                                                                 
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 9.85 ms, sys: 0 ns, total: 9.85 ms
Wall time: 9.72 ms
(1, 1431, 5977, 10177, 9040, 4440, 1163, 134, 1)

sage: P = polytopes.hypercube(12)                                                                                                                                                                                                                                                                                                                                          
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 391 ms, sys: 0 ns, total: 391 ms
Wall time: 391 ms
(1, 4097, 28669, 92125, 180037, 238755, 226776, 158466, 82170, 31350, 8525, 1529, 145, 1)
```


Note that for the last instance, there isn't a significant amount of simple vertices so the old approach is chosen.

Issue created by migration from https://trac.sagemath.org/ticket/30438





---

archive/issue_comments_429969.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2020-08-25T12:01:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30201",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30201#issuecomment-429969",
    "user": "https://github.com/kliem"
}
```

Last 10 new commits:



---

archive/issue_comments_429970.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-25T12:08:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30201",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30201#issuecomment-429970",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_429971.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-08-25T12:09:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30201",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30201#issuecomment-429971",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_429972.json:
```json
{
    "body": "A remark to cythonizing and compiling:\n\n- Current version:\n\n```diff\n+            foo = self.atoms.data\n+            atoms_face_length = self.atoms.face_length\n+\n+            counter = 0\n+            for j in range(self.atoms.n_faces):\n+                if count_atoms(foo[j], atoms_face_length) == self.structure.dimension:\n+                    counter += 1\n+                    self.structure.simple_vertices[j//64] |= vertex_to_bit_dictionary(j % 64)\n```\n\n- Much slower:\n\n```diff\n+            counter = 0\n+            for j in range(self.atoms.n_faces):\n+                if count_atoms(self.atoms.data[j], self.atoms.face_length) == self.structure.dimension:\n+                    counter += 1\n+                    self.structure.simple_vertices[j//64] |= vertex_to_bit_dictionary(j % 64)\n```\n\n- As fast as the current version:\n\n```diff\n+            counter = 0\n+            for j in range(self.atoms.n_faces):\n+                if count_atoms(self.atoms.data[j], self.atoms.face_length) == self.structure.dimension:\n+                    counter += 1\n+                    self.structure.simple_vertices[j//64] |= vertex_to_bit_dictionary(j % 64)\n+\n+            for j in range(self.atoms.n_faces):\n+                if count_atoms(self.atoms.data[j], self.atoms.face_length) == self.structure.dimension:\n+                    self.structure.simple_vertices[j//64] |= vertex_to_bit_dictionary(j % 64)\n```\n\n\nI guess looking up `self.atoms` takes significant amount of time. What is suprising is that when you add a useless loop, things speed up. Either by cythonizing or compiling (I didn't check) it is figured, that we need the properties of `self.atoms` more often and this is optimized then.\n\nPerhaps even more suprising. When you add\n\n```\n# cython: profile=True\n# cython: linetrace=True\n# distutils: define_macros=CYTHON_TRACE_NOGIL=1\n# distutils: define_macros=CYTHON_TRACE=1\n```\n\nto the beginning of `base.pyx` the second version is just as fast. Makes it hard to profile where the difference in performance is, when it goes away when profiling.",
    "created_at": "2020-08-25T12:23:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30201",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30201#issuecomment-429972",
    "user": "https://github.com/kliem"
}
```

A remark to cythonizing and compiling:

- Current version:

```diff
+            foo = self.atoms.data
+            atoms_face_length = self.atoms.face_length
+
+            counter = 0
+            for j in range(self.atoms.n_faces):
+                if count_atoms(foo[j], atoms_face_length) == self.structure.dimension:
+                    counter += 1
+                    self.structure.simple_vertices[j//64] |= vertex_to_bit_dictionary(j % 64)
```

- Much slower:

```diff
+            counter = 0
+            for j in range(self.atoms.n_faces):
+                if count_atoms(self.atoms.data[j], self.atoms.face_length) == self.structure.dimension:
+                    counter += 1
+                    self.structure.simple_vertices[j//64] |= vertex_to_bit_dictionary(j % 64)
```

- As fast as the current version:

```diff
+            counter = 0
+            for j in range(self.atoms.n_faces):
+                if count_atoms(self.atoms.data[j], self.atoms.face_length) == self.structure.dimension:
+                    counter += 1
+                    self.structure.simple_vertices[j//64] |= vertex_to_bit_dictionary(j % 64)
+
+            for j in range(self.atoms.n_faces):
+                if count_atoms(self.atoms.data[j], self.atoms.face_length) == self.structure.dimension:
+                    self.structure.simple_vertices[j//64] |= vertex_to_bit_dictionary(j % 64)
```


I guess looking up `self.atoms` takes significant amount of time. What is suprising is that when you add a useless loop, things speed up. Either by cythonizing or compiling (I didn't check) it is figured, that we need the properties of `self.atoms` more often and this is optimized then.

Perhaps even more suprising. When you add

```
# cython: profile=True
# cython: linetrace=True
# distutils: define_macros=CYTHON_TRACE_NOGIL=1
# distutils: define_macros=CYTHON_TRACE=1
```

to the beginning of `base.pyx` the second version is just as fast. Makes it hard to profile where the difference in performance is, when it goes away when profiling.



---

archive/issue_comments_429973.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-28T14:44:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30201",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30201#issuecomment-429973",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_429974.json:
```json
{
    "body": "Changes from #30040.\n----\nLast 10 new commits:",
    "created_at": "2020-08-30T08:02:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30201",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30201#issuecomment-429974",
    "user": "https://github.com/kliem"
}
```

Changes from #30040.
----
Last 10 new commits:



---

archive/issue_comments_429975.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-09-02T01:38:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30201",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30201#issuecomment-429975",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_429976.json:
```json
{
    "body": "needs rebase",
    "created_at": "2020-09-02T01:38:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30201",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30201#issuecomment-429976",
    "user": "https://github.com/mkoeppe"
}
```

needs rebase



---

archive/issue_comments_429977.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-09-02T07:04:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30201",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30201#issuecomment-429977",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_429978.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-09-02T07:05:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30201",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30201#issuecomment-429978",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_429979.json:
```json
{
    "body": "I want to redesign some of the setup before making everything more complicated.\n\nMore precisely, creating strucutures `face_struct` and `faces_list_struct` that take care of the details. Then this overly long argument list of `get_next_level` will just reduce to three arguments or so. This would also make future changes easier including the transition to `bitsets.pxi`.",
    "created_at": "2020-09-07T17:28:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30201",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30201#issuecomment-429979",
    "user": "https://github.com/kliem"
}
```

I want to redesign some of the setup before making everything more complicated.

More precisely, creating strucutures `face_struct` and `faces_list_struct` that take care of the details. Then this overly long argument list of `get_next_level` will just reduce to three arguments or so. This would also make future changes easier including the transition to `bitsets.pxi`.



---

archive/issue_comments_429980.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-09-07T17:28:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30201",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30201#issuecomment-429980",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_429981.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30201",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30201#issuecomment-429981",
    "user": "https://github.com/mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_429982.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30201",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30201#issuecomment-429982",
    "user": "https://github.com/mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.
