# Issue 30201: Improve face iterator for almost simple/simplicial polytopes

Issue created by migration from https://trac.sagemath.org/ticket/30438

Original creator: @kliem

Original creation time: 2020-08-25 11:45:16

CC:  jipilab @laisrast tscrim

Keywords: simple, simplicial, face iterator, polytope

#30040 improved the face iterator for simple/simplicial polytopes.

Actually, the same trick can be applied for simple faces. (Note that the iterator treats simplicial polytopes dually).

If a face is simple then any intersections of it's facets is one of it's ridges or empty.

As this helps only sporadically, we cannot afford to compute for each face if it is simple. However, a cheap certificate of a face being simple is that it only contains "simple vertices" (with vertex figure a simplex).

Now, at initialization the face iterator computes those "simple vertices" and checks inclusion of each face to determine if it is simple (if at least 10 percent of the vertices are simple). If a face is simple, we can skip the costly inclusion checks.

Before this ticket:


```
sage: P = polytopes.permutahedron(7)                                                                                                                                                                                                                                                                                                                                       
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 257 ms, sys: 7 µs, total: 257 ms
Wall time: 257 ms
(1, 5041, 16251, 19761, 11144, 2860, 267, 1)

sage: P = polytopes.associahedron(['A',7])                                                                                                                                                                                                                                                                                                                                 
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 13.5 ms, sys: 0 ns, total: 13.5 ms
Wall time: 13.4 ms
(1, 1431, 5977, 10177, 9040, 4440, 1163, 134, 1)
sage: P = polytopes.hypercube(12)                                                                                                                                                                                                                                                                                                                                          
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 419 ms, sys: 17 µs, total: 419 ms
Wall time: 419 ms
(1, 4097, 28669, 92125, 180037, 238755, 226776, 158466, 82170, 31350, 8525, 1529, 145, 1)

```



```
sage: P = polytopes.permutahedron(7)                                                                                                                                                                                                                                                                                                                                       
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 79.5 ms, sys: 0 ns, total: 79.5 ms
Wall time: 79.3 ms
(1, 5041, 16251, 19761, 11144, 2860, 267, 1)

sage: P = polytopes.associahedron(['A',7])                                                                                                                                                                                                                                                                                                                                 
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 9.85 ms, sys: 0 ns, total: 9.85 ms
Wall time: 9.72 ms
(1, 1431, 5977, 10177, 9040, 4440, 1163, 134, 1)

sage: P = polytopes.hypercube(12)                                                                                                                                                                                                                                                                                                                                          
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                                                                                                                                                                                                              
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                                                                                                                                                                                                                      
sage: %time C.f_vector()                                                                                                                                                                                                                                                                                                                                                   
CPU times: user 391 ms, sys: 0 ns, total: 391 ms
Wall time: 391 ms
(1, 4097, 28669, 92125, 180037, 238755, 226776, 158466, 82170, 31350, 8525, 1529, 145, 1)
```


Note that for the last instance, there isn't a significant amount of simple vertices so the old approach is chosen.


---

Comment by @kliem created at 2020-08-25 12:01:20

Last 10 new commits:


---

Comment by git created at 2020-08-25 12:08:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-08-25 12:09:51

Changing status from new to needs_review.


---

Comment by @kliem created at 2020-08-25 12:23:30

A remark to cythonizing and compiling:

- Current version:

```diff
+            foo = self.atoms.data
+            atoms_face_length = self.atoms.face_length
+
+            counter = 0
+            for j in range(self.atoms.n_faces):
+                if count_atoms(foo[j], atoms_face_length) == self.structure.dimension:
+                    counter += 1
+                    self.structure.simple_vertices[j//64] |= vertex_to_bit_dictionary(j % 64)
```

- Much slower:

```diff
+            counter = 0
+            for j in range(self.atoms.n_faces):
+                if count_atoms(self.atoms.data[j], self.atoms.face_length) == self.structure.dimension:
+                    counter += 1
+                    self.structure.simple_vertices[j//64] |= vertex_to_bit_dictionary(j % 64)
```

- As fast as the current version:

```diff
+            counter = 0
+            for j in range(self.atoms.n_faces):
+                if count_atoms(self.atoms.data[j], self.atoms.face_length) == self.structure.dimension:
+                    counter += 1
+                    self.structure.simple_vertices[j//64] |= vertex_to_bit_dictionary(j % 64)
+
+            for j in range(self.atoms.n_faces):
+                if count_atoms(self.atoms.data[j], self.atoms.face_length) == self.structure.dimension:
+                    self.structure.simple_vertices[j//64] |= vertex_to_bit_dictionary(j % 64)
```


I guess looking up `self.atoms` takes significant amount of time. What is suprising is that when you add a useless loop, things speed up. Either by cythonizing or compiling (I didn't check) it is figured, that we need the properties of `self.atoms` more often and this is optimized then.

Perhaps even more suprising. When you add

```
# cython: profile=True
# cython: linetrace=True
# distutils: define_macros=CYTHON_TRACE_NOGIL=1
# distutils: define_macros=CYTHON_TRACE=1
```

to the beginning of `base.pyx` the second version is just as fast. Makes it hard to profile where the difference in performance is, when it goes away when profiling.


---

Comment by git created at 2020-08-28 14:44:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-08-30 08:02:25

Changes from #30040.
----
Last 10 new commits:


---

Comment by mkoeppe created at 2020-09-02 01:38:31

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-09-02 01:38:31

needs rebase


---

Comment by git created at 2020-09-02 07:04:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-09-02 07:05:36

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2020-09-07 17:28:54

I want to redesign some of the setup before making everything more complicated.

More precisely, creating strucutures `face_struct` and `faces_list_struct` that take care of the details. Then this overly long argument list of `get_next_level` will just reduce to three arguments or so. This would also make future changes easier including the transition to `bitsets.pxi`.


---

Comment by @kliem created at 2020-09-07 17:28:54

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.
