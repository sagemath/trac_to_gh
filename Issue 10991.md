# Issue 10991: Add some patches to PARI

Issue created by migration from https://trac.sagemath.org/ticket/11130

Original creator: jdemeyer

Original creation time: 2011-04-05 15:01:00

Assignee: tbd

CC:  mstreng dimpase jpflori

Keywords: pari spkg

We need to add bugfixes for
 1. [http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1147](http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1147) (#9334)
 1. [http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1153](http://pari.math.u-bordeaux.fr/cgi-bin/bugreport.cgi?bug=1153) (#10195)


---

Comment by jdemeyer created at 2011-04-05 16:42:59

Changing status from new to needs_work.


---

Comment by cremona created at 2011-04-23 10:00:24

I am currently testing this.  To avoid duplication of effort, I'll fix things I find in the elliptic_curves directory only.


---

Comment by cremona created at 2011-04-23 11:54:15

After (1) Building a fresh 4.7.alpha5 from scratch, (2) installing the spkg lined here with "sage -f", (3) applying the patch here to the sage library and (4) running "sage -b", I find that the Sage build will not start up properly:

```
ImportError                               Traceback (most recent call last)
...

/home/jec/sage-4.7.alpha5.11130/local/lib/python2.6/site-packages/sage/misc/functional.py in <module>()
     36 
     37 
---> 38 from sage.rings.complex_double import CDF
     39 from sage.rings.real_double import RDF, RealDoubleElement
     40 

/home/jec/sage-4.7.alpha5.11130/local/bin/gen.pxd in init sage.rings.complex_double (sage/rings/complex_double.c:15178)()

ImportError: /home/jec/sage-4.7.alpha5.11130/local/lib/python2.6/site-packages/sage/libs/pari/gen.so: undefined symbol: defaultOut
Error importing ipy_profile_sage - perhaps you should run %upgrade?
WARNING: Loading of ipy_profile_sage failed.
```

so I cannot test anything.  

Did I do something wrong?


---

Comment by jdemeyer created at 2011-04-24 19:05:44

Replying to [comment:18 cremona]:
> Did I do something wrong?

This ticket depends on #11230.


---

Comment by cremona created at 2011-04-24 19:31:16

Replying to [comment:19 jdemeyer]:
> Replying to [comment:18 cremona]:
> > Did I do something wrong?
> 
> This ticket depends on #11230.

I see!  I'll have some time to spend on this tomorrow (Monday) so I'll have another go.


---

Comment by jdemeyer created at 2011-04-25 11:01:40

Changing assignee from tbd to jdemeyer.


---

Comment by jdemeyer created at 2011-04-25 13:27:20

Replying to [comment:17 cremona]:
> I am currently testing this.  To avoid duplication of effort, I'll fix things I find in the elliptic_curves directory only.

Sounds good, I will look at everything else.


---

Attachment

Applies after previous


---

Comment by cremona created at 2011-04-25 17:49:59

I added a patch which fixes the doctest failures in sage/rings/polynomial/polynomial_quotient_ring.py .  In all cases the new output was equivalent to the old.

There are now just some failures in sage/schemes/elliptic_curves/ell_rational_field.py  (2 doctests failed) and sage/schemes/elliptic_curves/ell_number_field.py (1 doctests failed).


---

Comment by cremona created at 2011-04-25 18:00:58

Changing status from needs_work to needs_review.


---

Comment by cremona created at 2011-04-25 18:00:58

ell_rational_field.py: only one failure, looks completely trivial but will be left until #11005 to be fixed.

ell_number_field.py: one failure, even more trivial:  the final output is exactly the same as it was but the verbose output is a little different, so this can be easily cleaned up at #11005.

As far as I am concerned this needs *no more work* on this ticket, but I'll delay marking it positive review until the same is possible at #11005.  Still, it certainly gets "needs review" on that basis.


---

Comment by jdemeyer created at 2011-04-25 18:11:07

This patch should also be tested on various systems first, PARI is known to produce different results on 32-bit and 64-bit systems.


---

Comment by cremona created at 2011-04-25 19:20:13

Replying to [comment:25 jdemeyer]:
> This patch should also be tested on various systems first, PARI is known to produce different results on 32-bit and 64-bit systems.

Good point.  I can test it on my 32-bit laptop.


---

Comment by jdemeyer created at 2011-04-26 08:38:33

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-04-26 08:38:33

In `sage/rings/number_field/number_field.py`, there is a test which fails _only_ when `-long` is *not* used.


---

Comment by jdemeyer created at 2011-04-26 15:22:50

New patch fixes the long time issue (by setting a random seed explicitly).  I will test on a Mac OS X 10.4 32-bit PPC system.


---

Comment by cremona created at 2011-04-26 20:04:21

Testing now on a 32-bit ubuntu system.


---

Comment by cremona created at 2011-04-26 21:40:21

Replying to [comment:34 cremona]:
> Testing now on a 32-bit ubuntu system.
... which gave several more failures:

```
	sage -t  devel/sage-main/sage/rings/number_field/number_field.py # 1 doctests failed
	sage -t  devel/sage-main/sage/schemes/elliptic_curves/ell_number_field.py # 2 doctests failed
	sage -t  devel/sage-main/sage/schemes/elliptic_curves/ell_rational_field.py # 1 doctests failed
	sage -t  devel/sage-main/sage/rings/number_field/number_field_element.pyx # 1 doctests failed
	sage -t  devel/sage-main/sage/rings/polynomial/polynomial_quotient_ring.py # 3 doctests failed
	sage -t  devel/sage-main/sage/rings/integer.pyx # 1 doctests failed
```


Details:

```
sage -t  "devel/sage-main/sage/rings/number_field/number_field.py"
**********************************************************************
File "/home/john/sage-4.7.alpha5/devel/sage-main/sage/rings/number_field/number_field.py", line 3616:
    sage: L.factor(a + 1)
Expected:
    (Fractional ideal (1/2*a*b + a + 1/2)) * (Fractional ideal (-1/2*b - 1/2*a + 1))
Got:
    (Fractional ideal (-1/2*a*b - a - 1/2)) * (Fractional ideal (1/2*b + 1/2*a - 1))
```

is trivial,

```
sage -t  "devel/sage-main/sage/rings/number_field/number_field_element.pyx"
**********************************************************************
File "/home/john/sage-4.7.alpha5/devel/sage-main/sage/rings/number_field/number_field_element.pyx", line 1142:
    sage: t = (2*a + b)._rnfisnorm(L); t[1]
Expected:
    (b - 2)*a + 2*b - 3
Got:
    (-4*b - 5)*a + 5*b + 6
```

needs looking at, 

```
sage -t  "devel/sage-main/sage/rings/polynomial/polynomial_quotient_ring.py"
```

are just like the ones I fixed before on the other machine, and

```
sage -t  "devel/sage-main/sage/rings/integer.pyx"           
**********************************************************************
File "/home/john/sage-4.7.alpha5/devel/sage-main/sage/rings/integer.pyx", line 4389:
    sage: 7._bnfisnorm(CyclotomicField(7))
Expected:
    (-zeta7 + 1, 1)
Got:
    (-zeta7^5 + zeta7^4, 1)
```

is also trivial (multiplying by a power of zeta does not change the norm!).

That's all I have time for today, so I hope things look similar on the other 32-bit system being tested.


---

Attachment

Apply after previous


---

Comment by cremona created at 2011-04-27 21:49:14

I have added a new patch (which affects 4 files in sage/rings) after which all doctests pass on both 32- and 64-bit, apart from the simon-related ones.

That means that it is time to check #11005 on top of all this.


---

Comment by jdemeyer created at 2011-05-10 07:37:26

lcalc fails to build with the new PARI:

```
Lcommandline.cc: In function 'int main(int, char**)':
Lcommandline.cc:476:54: error: 'allocatemoremem' was not declared in this scope
Lcommandline.cc:403:16: warning: unused variable 'C' [-Wunused-variable]
Lcommandline.cc:38:9: warning: unused variable 'i' [-Wunused-variable]
In file included from ../include/L.h:537:0,
                 from ../include/Lcommandline.h:36,
                 from Lcommandline.cc:31:
../include/Lvalue.h: In member function 'Complex L_function<ttype>::find_delta(Complex, Double) [with ttype = int, Complex = std::complex<double>, Double = double]':
Lcommandline.cc:463:50:   instantiated from here
../include/Lvalue.h:37:21: warning: unused variable 'f2' [-Wunused-variable]
make[1]: *** [Lcommandline.o] Error 1
make[1]: Leaving directory `/usr/local/src/sage-4.7.alpha5/spkg/build/lcalc-20100428-1.23.p6/src/src'
make: *** [all] Error 2
Error building lcalc 'make'
```



---

Comment by cremona created at 2011-05-10 08:36:01

Replying to [comment:41 jdemeyer]:
> lcalc fails to build with the new PARI:

Mike Rubenstein needs to be made aware of this.


---

Comment by fbissey created at 2011-05-10 12:16:26

What about genus2reduction? I am assuming John already made sure eclib is working.


---

Comment by cremona created at 2011-05-10 13:06:16

Replying to [comment:43 fbissey]:
> What about genus2reduction? I am assuming John already made sure eclib is working.

A reasonable assumption, but...for a while now I have used Sage's Pari and NTL builds rather than building them myself independently, so I cannot yet confirm.  (However, eclib's use of Pari is minimal, it's only for integer factorization.)

I am also preparing a new version of eclib, so I will combine these two tasks, though I don't have any time for this this week.


---

Comment by jdemeyer created at 2011-05-10 15:04:34

Replying to [comment:42 cremona]:
> Replying to [comment:41 jdemeyer]:
> > lcalc fails to build with the new PARI:
> 
> Mike Rubenstein needs to be made aware of this.

First I will see if I can fix the error and then send the patches to him.


---

Comment by jdemeyer created at 2011-05-10 15:29:48

See #11321 for lcalc.


---

Comment by jdemeyer created at 2011-05-15 14:39:26

I built Sage completely from scratch with the new PARI and lcalc packages, everything works.  All tests pass except for the ones related to simon_two_descent.


---

Comment by cremona created at 2011-05-18 15:34:50

Replying to [comment:48 jdemeyer]:
> I built Sage completely from scratch with the new PARI and lcalc packages, everything works.  All tests pass except for the ones related to simon_two_descent.

So is the "Needs work" just because this ticket is dependent on #11005?  I am planning to look now at the doctest failures relating to the Simon scripts and fix them, so that this ticket can then be closed, and the additional work needed on #11005 can depend on this.


---

Comment by jdemeyer created at 2011-05-18 16:45:13

Replying to [comment:49 cremona]:
>  I am planning to look now at the doctest failures relating to the Simon scripts and fix them, so that this ticket can then be closed, and the additional work needed on #11005 can depend on this.

That's precisely what I proposed.


---

Comment by cremona created at 2011-05-19 16:22:14

Replying to [comment:50 jdemeyer]:
> Replying to [comment:49 cremona]:
> >  I am planning to look now at the doctest failures relating to the Simon scripts and fix them, so that this ticket can then be closed, and the additional work needed on #11005 can depend on this.
> 
> That's precisely what I proposed.

OK, so that's what I am working on doing.  Patch up shortly.  However, I ran into something awkward:  the script ellQ.gp in data/extcode/pari/simon crashed randomly in the function ellredgen (using this new pari version).  I saw that the offending lines had been changed in the newer ellQ.gp as found in #11005, so I made the same changes.  This sorts the problem, but it means that for this ticket to be finished we need to also make a small patch to extcode.  Any problems with that?


---

Comment by cremona created at 2011-05-19 16:26:48

Apply to sage library after previous


---

Attachment

Apply to extcode repository


---

Comment by cremona created at 2011-05-19 16:28:37

Changing status from needs_work to needs_review.


---

Comment by cremona created at 2011-05-30 15:51:18

Is the only thing stopping this going forward the latest reviewer patch?


---

Comment by jdemeyer created at 2011-05-31 08:09:14

As far as I know, *all* patches and spkgs still need review.  I can review your patches (but give me some time).


---

Comment by cremona created at 2011-05-31 08:26:05

Replying to [comment:56 jdemeyer]:
> As far as I know, *all* patches and spkgs still need review.  I can review your patches (but give me some time).

Well I considered that I had reviewed (positively) everything except my last patch fixing the Simon doctests so that's the only thing left needing a review (from you perhaps, especially as you made some extra fixes for 32/64 bit issues).


---

Comment by jdemeyer created at 2011-05-31 08:31:27

Also lcalc (#11321) needs review.


---

Comment by kcrisman created at 2011-06-16 07:29:41

The part of the ticket that fixes #10240 is okay, I think.


---

Comment by jdemeyer created at 2011-06-22 19:52:47

Changing status from needs_review to needs_work.


---

Comment by kcrisman created at 2011-06-30 14:57:02

See #10240 for a request to merge that in 4.7.2 (or whatever the next version is) if this isn't getting merged quickly.


---

Comment by leif created at 2011-07-16 16:47:08

See #11605 for a PARI 2.4.3.alpha.*p7* spkg with minor but important fixes to `spkg-install` (and some corrections in `SPKG.txt`). I've meanwhile based this on Dima's p6 (which just adds a small, harmless change for Cygwin) from #10240. 

(Haven't yet looked at _this_ ticket / spkg here at all.)


---

Comment by jdemeyer created at 2011-07-19 10:34:38

Needs to be rebased to sage-2.4.3.alpha7.spkg (#11605).


---

Comment by jdemeyer created at 2011-07-26 10:29:51

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2011-07-26 11:15:39

The spkg does not build on Mac OS X because of an upstream bug.  There is a fix in PARI svn revision 13318 which I should add to this spkg.


---

Comment by jdemeyer created at 2011-07-26 11:15:39

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-07-26 11:16:57

My comment refered to a Mac OS X 10.4 PPC machine, other machines might still work.


---

Comment by jdemeyer created at 2011-07-26 21:26:52

New spkg fixing the OS X issue: [http://boxen.math.washington.edu/home/jdemeyer/spkg/pari-2.5.0.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/pari-2.5.0.p2.spkg)


---

Comment by jdemeyer created at 2011-07-26 21:26:52

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2011-07-26 21:34:57

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-07-26 21:34:57

Never mind, still doesn't work.  Need to also add revision 13330.


---

Comment by jdemeyer created at 2011-08-02 09:58:19

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2011-08-02 09:58:19

New version which *does* build on OS X 10.4, same location: [http://boxen.math.washington.edu/home/jdemeyer/spkg/pari-2.5.0.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/pari-2.5.0.p2.spkg)


---

Attachment

Diff for the pari spkg, for reviewing only


---

Comment by jdemeyer created at 2011-08-02 10:12:27

Changing priority from major to critical.


---

Comment by jdemeyer created at 2011-08-02 10:12:27

I did a small rebase of [attachment:11130_sagelib.patch] regarding sage/matrix/matrix2.pyx


---

Comment by cremona created at 2011-08-02 10:24:48

Changing status from needs_review to needs_info.


---

Comment by cremona created at 2011-08-02 10:24:48

Before I set about applying everything and testing, which I will do, can you tell me which Sage version I should be patching against?  I have 4.7.1.rc1, is that the best?  Or plain 4.7?


---

Comment by jdemeyer created at 2011-08-02 10:29:39

Replying to [comment:75 cremona]:
> Before I set about applying everything and testing, which I will do, can you tell me which Sage version I should be patching against?  I have 4.7.1.rc1, is that the best?  Or plain 4.7?

sage-4.7.1.rc1 for sure.

I am also preparing a Sage tarball with all spkgs and patches already applied, it should appear in [http://boxen.math.washington.edu/home/jdemeyer/release/sage-4.7.1.rc1-pari-2.5.0/](http://boxen.math.washington.edu/home/jdemeyer/release/sage-4.7.1.rc1-pari-2.5.0/)


---

Comment by jdemeyer created at 2011-08-02 10:29:39

Changing status from needs_info to needs_review.


---

Comment by cremona created at 2011-08-02 10:58:32

Replying to [comment:76 jdemeyer]:
> Replying to [comment:75 cremona]:
> > Before I set about applying everything and testing, which I will do, can you tell me which Sage version I should be patching against?  I have 4.7.1.rc1, is that the best?  Or plain 4.7?
> 
> sage-4.7.1.rc1 for sure.

OK, I am testing against that right now... John

> 
> I am also preparing a Sage tarball with all spkgs and patches already applied, it should appear in [http://boxen.math.washington.edu/home/jdemeyer/release/sage-4.7.1.rc1-pari-2.5.0/](http://boxen.math.washington.edu/home/jdemeyer/release/sage-4.7.1.rc1-pari-2.5.0/)


---

Comment by cremona created at 2011-08-02 11:36:58

Starting with a clean 4.7.1.rc1 (I think) I successfully applied both spkgs (using SAGE_CHECK=yes) and 5 patches to sagelib and 1 to data/extcode, and did sage -ba.

Sage now starts up OK but I'm having a lot of problems with any more testing.  For example, moving into devel/sage and doing "../../sage -tp 20 ./sage"  results in very many errors, looks like in every file, like this:

```
Traceback (most recent call last):
  File "/home/jec/.sage//tmp/facade_sets.py", line 2, in <module>
    from sage.all_cmdline import *; 
  File "/home/jec/sage-4.7.1.rc1/local/lib/python/site-packages/sage/all_cmdline.py", line 24, in <module>
    raise ValueError, msg
ValueError: Attempted relative import in non-package
```

I checked (using bash's history) that I had remembered to hg qpush each patch.

Does this make any sense? I suppose I could rebuild 4.7.1.rc1 from scratch.


---

Comment by kcrisman created at 2011-08-02 16:46:33

hen trying to install this on Cygwin, I get a lot of errors while trying to create the binary gp-2.5.exe along the lines of the following three types.

```
.../libpari.a(default.o): In function `sd_prompt':
.../default.c:962: multiple definition of `_sd_prompt'
gp.o:.../gp/gp.c:2359: first defined here
```

and

```
gp.o:gp.c:(.text+0x9e2): undefined reference to `_err_printf'
```

(lots of this kind of thing, for many functions), and 

```
.../libpari.a(mp.o): In function `umodiu':
.../kernel/gmp/mp.c::567: undefined reference to `__imp____gmpn_mod_1'
```

The latter type I've already seen while trying to ./sage -f the previous Pari (2.4.3.alpha.px), but I haven't seen the first kind or second kind before.   Something similar to the third one I've seen in some build notes of William's as being a problem with gmp being -I'ed before some other include directories, and the first one looks like one of these "double inclusion" problems.


---

Comment by leif created at 2011-08-02 17:48:05

Replying to [comment:79 kcrisman]:
> When trying to install this on Cygwin, I get a lot of errors while trying to create the binary gp-2.5.exe along the lines of the following three types.

```
.../libpari.a(default.o): In function `sd_prompt':
.../default.c:962: multiple definition of `_sd_prompt'
gp.o:.../gp/gp.c:2359: first defined here
```


Looks as if you're _somehow<sup>TM</sup>_ mixing the old PARI (at least the static library `libpari.a`) with the new one; PARI 2.5.0 doesn't have an `sd_prompt()` function in `default.c` at all.


> and

```
gp.o:gp.c:(.text+0x9e2): undefined reference to `_err_printf'
```


... while this function doesn't exist in the older PARI.


> (lots of this kind of thing, for many functions), and 

```
.../libpari.a(mp.o): In function `umodiu':
.../kernel/gmp/mp.c::567: undefined reference to `__imp____gmpn_mod_1'
```

> The latter type I've already seen while trying to ./sage -f the previous Pari (2.4.3.alpha.px), but I haven't seen the first kind or second kind before.   Something similar to the third one I've seen in some build notes of William's as being a problem with gmp being -I'ed before some other include directories, and the first one looks like one of these "double inclusion" problems.


---

Comment by jdemeyer created at 2011-08-02 19:39:20

Replying to [comment:78 cremona]:
> ValueError: Attempted relative import in non-package

I have no idea why this happens.  Can you try to build [http://boxen.math.washington.edu/home/jdemeyer/release/sage-4.7.1.rc1-pari-2.5.0/sage-4.7.1.rc1-pari-2.5.0.tar](http://boxen.math.washington.edu/home/jdemeyer/release/sage-4.7.1.rc1-pari-2.5.0/sage-4.7.1.rc1-pari-2.5.0.tar) from scratch and test that?  If this works, probably you did something wrong in merging the spkgs/patches.


---

Comment by kcrisman created at 2011-08-03 00:13:13

> Looks as if you're _somehow<sup>TM</sup>_ mixing the old PARI (at least the static library `libpari.a`) with the new one; PARI 2.5.0 doesn't have an `sd_prompt()` function in `default.c` at all.

Interestingly, it works fine from scratch (building)!  Sorry for the noise, if noise it was.

Is there something about Pari that you shouldn't build it twice in the same location?  I notice that it removes and replaces various things in `$SAGE_LOCAL` before it's all done, so maybe that could happen.  In principle, one should be able to `./sage -f` a new version, have something break, and then be able to `./sage -f` the original version and have everything fine.  Or not even HAVE to `./sage -f` the original version.  The fact that this doesn't work is not good - shouldn't we only copy things over/delete things after the build has successfully completed?


---

Comment by fbissey created at 2011-08-03 01:28:07

Replying to [comment:82 kcrisman]:
> 
> > Looks as if you're _somehow<sup>TM</sup>_ mixing the old PARI (at least the static library `libpari.a`) with the new one; PARI 2.5.0 doesn't have an `sd_prompt()` function in `default.c` at all.
> 
> Interestingly, it works fine from scratch (building)!  Sorry for the noise, if noise it was.
> 
> Is there something about Pari that you shouldn't build it twice in the same location?  I notice that it removes and replaces various things in `$SAGE_LOCAL` before it's all done, so maybe that could happen.  In principle, one should be able to `./sage -f` a new version, have something break, and then be able to `./sage -f` the original version and have everything fine.  Or not even HAVE to `./sage -f` the original version.  The fact that this doesn't work is not good - shouldn't we only copy things over/delete things after the build has successfully completed?  


Well the gp executable is linked against libpari and there is a danger that the old one will be used when linking if you are not careful enough. It should be ok in principle but the precaution of removing previous libpari is a good one.


---

Comment by fbissey created at 2011-08-03 01:53:39

Just a quick question to confirm: do we need to apply the patch to extcode without worrying about #11005? It is not a dependency of this bug.


---

Comment by leif created at 2011-08-03 04:01:30

Replying to [comment:83 fbissey]:
> Replying to [comment:82 kcrisman]:
> > 
> > > Looks as if you're _somehow<sup>TM</sup>_ mixing the old PARI (at least the static library `libpari.a`) with the new one; PARI 2.5.0 doesn't have an `sd_prompt()` function in `default.c` at all.
> > 
> > Interestingly, it works fine from scratch (building)!  Sorry for the noise, if noise it was.
> > 
> > Is there something about Pari that you shouldn't build it twice in the same location?  I notice that it removes and replaces various things in `$SAGE_LOCAL` before it's all done, so maybe that could happen.

The PARI spkg doesn't delete anything of previous installs in advance. (The `.alpha`*`.p5`* though had a bug which caused the install script not to exit with an error if `make` failed. Also, on Cygwin `make -k` ("keep going") was used, but that shouldn't matter here, and has been removed in the 2.5.0 spkgs.)

> > In principle, one should be able to `./sage -f` a new version, have something break, and then be able to `./sage -f` the original version and have everything fine.  Or not even HAVE to `./sage -f` the original version.

Both _should<sup>TM</sup>_ be possible, at least unless the build succeeds but the actual installation fails at some point, in which case the former method should still work.

> > The fact that this doesn't work is not good - shouldn't we only copy things over/delete things after the build has successfully completed?

That's what we do.
 
> Well the gp executable is linked against libpari and there is a danger that the old one will be used when linking if you are not careful enough. It should be ok in principle but the precaution of removing previous libpari is a good one.

Things are a little different on Cygwin, since _the Sage Cygwin developers_ ;-) copy the DLL also to `$SAGE_LOCAL/bin` such that `gp` will find its _shared_ library also there.

PARI (2.4.3) *pre*pends its build path (with `-L`) when using `-lpari`, except for when it links `gp`[`-2.4`] "in place", but this happens _after_ the new shared library (`.so*`, `*.dll` on Cygwin) has been copied and new symbolic links have been created. The new _static_ library is built and copied later though, but that shouldn't matter unless `gp` is statically linked on Cygwin, which shouldn't be the case.

If despite that something weird happens, this is IMHO limited to Cygwin; you may attach your spkg install logs (`$SAGE_ROOT/spkg/logs/pari-*.log`) such that we can check this.

We also didn't have problems with upgrading *to* 2.4.3 btw., except that initially some dependencies of Sage's extension modules were missing such that those didn't get rebuilt in the first place (and used the old ones with a different version they had been linked to earlier).


---

Comment by cremona created at 2011-08-03 08:14:06

Replying to [comment:81 jdemeyer]:
> Replying to [comment:78 cremona]:
> > ValueError: Attempted relative import in non-package
> 
> I have no idea why this happens.  Can you try to build [http://boxen.math.washington.edu/home/jdemeyer/release/sage-4.7.1.rc1-pari-2.5.0/sage-4.7.1.rc1-pari-2.5.0.tar](http://boxen.math.washington.edu/home/jdemeyer/release/sage-4.7.1.rc1-pari-2.5.0/sage-4.7.1.rc1-pari-2.5.0.tar) from scratch and test that?  If this works, probably you did something wrong in merging the spkgs/patches.

I'm downloading that now and will report back.


---

Comment by cremona created at 2011-08-03 10:56:05

Replying to [comment:86 cremona]:
> Replying to [comment:81 jdemeyer]:
> > Replying to [comment:78 cremona]:
> > > ValueError: Attempted relative import in non-package
> > 
> > I have no idea why this happens.  Can you try to build [http://boxen.math.washington.edu/home/jdemeyer/release/sage-4.7.1.rc1-pari-2.5.0/sage-4.7.1.rc1-pari-2.5.0.tar](http://boxen.math.washington.edu/home/jdemeyer/release/sage-4.7.1.rc1-pari-2.5.0/sage-4.7.1.rc1-pari-2.5.0.tar) from scratch and test that?  If this works, probably you did something wrong in merging the spkgs/patches.
> 
> I'm downloading that now and will report back.

Built with no problems.  But "make ptestlong" failed 100% just as before.  The install and ptestlong logs are at http://www.warwick.ac.uk/staff/J.E.Cremona/ptestlong.log and http://www.warwick.ac.uk/staff/J.E.Cremona/install.log


---

Comment by jdemeyer created at 2011-08-03 11:34:02

Replying to [comment:87 cremona]:
> Built with no problems.  But "make ptestlong" failed 100% just as before.  The install and ptestlong logs are at http://www.warwick.ac.uk/staff/J.E.Cremona/ptestlong.log and http://www.warwick.ac.uk/staff/J.E.Cremona/install.log

The strange thing is that the traceback you get seems totally unrelated to PARI.


---

Comment by cremona created at 2011-08-03 12:03:59

Replying to [comment:88 jdemeyer]:
> Replying to [comment:87 cremona]:
> > Built with no problems.  But "make ptestlong" failed 100% just as before.  The install and ptestlong logs are at http://www.warwick.ac.uk/staff/J.E.Cremona/ptestlong.log and http://www.warwick.ac.uk/staff/J.E.Cremona/install.log
> 
> The strange thing is that the traceback you get seems totally unrelated to PARI.

I know, it is mad.  After this happened with my 4.7.1.rc1 yesterday I wanted to review something else, so I did that using my 4.7.1.rc0 which was untouched, and found the exact same errors arising whenever I tried "sage -t".  This is on a machine I have been using for Sage development and testing for a year, on which no-one but me installs stuff.

Here are some possibly relevant environment variables (not changed recently):

SAGE_PARALLEL_SPKG_BUILD=yes
SHELL=/bin/bash
LD_LIBRARY_PATH=:/usr/local/lib:/home/jec/sage-current/local/lib

The reason for the LD_LIBRARY_PATH is that I use Sage's built libraries for other work (libntl and libpari);  but seeting that to just /usr/local/lib made no difference anyway.


---

Comment by leif created at 2011-08-03 12:38:56

Same happens with just `./sage -t ...` or `make test[long]`, i.e. non-parallel?

We had strange errors with `ptest[long]` or `./sage -tp N ...` when `SAGE_PATH` was set (even to the empty string).


---

Comment by cremona created at 2011-08-03 13:19:06

Replying to [comment:90 leif]:
> Same happens with just `./sage -t ...` or `make test[long]`, i.e. non-parallel?
> 
> We had strange errors with `ptest[long]` or `./sage -tp N ...` when `SAGE_PATH` was set (even to the empty string).

That is not set:

```
jec@fermat%env | grep SAGE
SAGE_PARALLEL_SPKG_BUILD=yes
```


make testlong was no better, neither is testing a single file (e.g. ./sage -t devel/sage/sage/rings/infinity.py).  Sage does start up properly.

Looking at the actual error message (why not?) I see that it complains that the line 

```
from sage.all_cmdline import *;
```

which is presumably included in the testing framework, causes sage.all_cmdline.py to be imported, and then in line 24 of that file the line 24:

```
   raise ValueError, msg
```

raises the error, with the message coming from a few lines above where there is a try/except block containing

```
    from sage.all import *
    from sage.calculus.predefined import x
    preparser(on=True)
```

and this is causing some kind of circular import.

Anyway, by 4.7 build which I have been using for weeks, and which passed all the tests when I built it, now gives rise to exactly the same problem.  So this is nothing to do with any of the code on this ticket, but instead something weird that has happened with my Sage installations.

Here's an idea: I have several background jobs running sage;  is it possible that this is the problem?  They will also be writing to ~/.sage.  I'll try again when they have finished.


---

Comment by leif created at 2011-08-03 13:37:05

Replying to [comment:91 cremona]:
> Here's an idea: I have several background jobs running sage;  is it possible that this is the problem?  They will also be writing to ~/.sage.  I'll try again when they have finished.

Well, easily checked:

```sh
$ env DOT_SAGE=/tmp ./sage -t devel/sage/sage/rings/infinity.py
```



---

Comment by fbissey created at 2011-08-03 22:36:31

considering the amount of broken test you have, does sage even start properly without wanting to test it.


---

Comment by cremona created at 2011-08-04 08:29:04

Replying to [comment:93 fbissey]:
> considering the amount of broken test you have, does sage even start properly without wanting to test it.
Yes, all the version I have start and run fine, but none of them cab run any tests.  I have never seen this before, but it's something to do with my setup (and several sage jobs running in the background on the same machine) so we should probably not fill up more of this ticket with it -- as long as someone else can do some testing!


---

Comment by fbissey created at 2011-08-05 02:32:15

Build against current 4.7.2_alpha0 on linux amd64. No problem that can be attributed to pari after running the long tests.


---

Comment by cremona created at 2011-08-12 08:21:44

Replying to [comment:94 cremona]:
> Replying to [comment:93 fbissey]:
> > considering the amount of broken test you have, does sage even start properly without wanting to test it.
> Yes, all the version I have start and run fine, but none of them cab run any tests.  I have never seen this before, but it's something to do with my setup (and several sage jobs running in the background on the same machine) so we should probably not fill up more of this ticket with it -- as long as someone else can do some testing!

By deleting most of my ~/.sage I successfully ran all the tests (i.e. make ptestlong completed successfully).  This is on 64-bit ubuntu.

Sorry for the noise -- is there any reason not to give this a positive review and get it into the 4.7.2 series as soon as possible?


---

Comment by was created at 2011-08-24 23:45:36

Changing keywords from "pari spkg" to "pari spkg sd32".


---

Comment by jdemeyer created at 2011-09-19 13:03:45

One doctest failure with sage-4.7.2.alpha2, fix included in new [attachment:11130_sagelib.patch]:

```
sage -t  -long -force_lib devel/sage/sage/rings/number_field/number_field_ideal.py
**********************************************************************
File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.2.alpha2-pari-2.5.0/devel/sage-main/sage/rings/number_field/number_field_ideal.py", line 1097:
    sage: [P._S_ideal_class_log(S) for P in K.primes_above(11)]
Expected:
    [[5, 2], [1, 1]]
Got:
    [[3, 2], [3, 1]]
**********************************************************************
```



---

Comment by jdemeyer created at 2011-09-21 08:59:26

Positive review for [attachment:trac_11130-doctest-poly.patch] and [attachment:11130_sagelib32.patch].  To make things simpler, I have folded these two patches into my [attachment:11130_sagelib.patch] (in any case, the commit message of one of your patches needed to be fixed).  Together with John's earlier review of my [attachment:11130_sagelib.patch], this one patch now has positive review.


---

Comment by jdemeyer created at 2011-09-21 09:54:28

Changing status from needs_review to needs_work.


---

Attachment

John, your patch changes the _functionality_ of the `simon_two_descent()` function by adding a new option ``store_gens``.  I have two problems with this:

 1. I think a ticket related to upgrading PARI is not the correct place to make such a change (or at least, it should be justified why).
 1. I don't like how `store_gens` changes the output of the function.  The name op this option does not imply that the output would be changed.  I can agree that you store the saturated points (as before), but why also _return_ the saturated points?  This is a real functional change.


---

Attachment

cremona's patch without the store_gens option and with some minor fixes


---

Attachment


---

Comment by jdemeyer created at 2011-09-21 11:39:53

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2011-09-21 11:44:18

I have a added a new patch [attachment:11130-sagelib-simon-v2.patch] which has parts of John Cremona's patch (those parts get positive review from me) with some minor fixes added.


---

Attachment


---

Comment by cremona created at 2011-09-26 09:50:34

Sorry for delay, I was on holiday.

The point about not adding new functionality on this specific ticket is a good one.  It was so long ago I had to look at my own patch to see what you were talking about!  I think I added that at someone's suggestion that after a successful 2-descent using simon_two_descent it was silly not to keep the point found.  This will be requested again at some point, so perhaps a new ticket should be made for it before we forget,

But *nothing* should be done which delays this ticket finally getting closed!


---

Comment by jdemeyer created at 2011-09-26 14:04:06

Replying to [comment:106 cremona]:
> Sorry for delay, I was on holiday.

No apologies needed, I have also been away for a while...

John, it would be great if you could review the remaining patches here.  They get positive_review from me, but since they contain a mixture of code of you and of me, you should also look at them.


---

Comment by cremona created at 2011-09-26 14:41:56

Starting with a build of 4.7.2.alpha1 (the latest I have built) I applied both spkgs OK, then the first two patches ok, but the third patch 11130_reviewer32.patch had 2 failed hunks.  It looks trivial, but as they are listed the patches do no apply cleanly.


---

Comment by cremona created at 2011-09-26 14:41:56

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-09-26 15:10:15

Replying to [comment:108 cremona]:
> Starting with a build of 4.7.2.alpha1 (the latest I have built) I applied both spkgs OK, then the first two patches ok, but the third patch 11130_reviewer32.patch had 2 failed hunks.  It looks trivial, but as they are listed the patches do no apply cleanly.

The patches do apply to sage-4.7.2.*alpha2*.  Alternatively, try applying the patch from #11540 (merged in sage-4.7.2.alpha2) first.


---

Comment by jdemeyer created at 2011-09-26 15:17:38

Changing status from needs_work to needs_review.


---

Comment by cremona created at 2011-09-26 15:44:16

Replying to [comment:109 jdemeyer]:
> 
> The patches do apply to sage-4.7.2.*alpha2*.  Alternatively, try applying the patch from #11540 (merged in sage-4.7.2.alpha2) first.

Sorry, I missed alpha2.  I'll build that now and try again.


---

Comment by cremona created at 2011-09-26 20:57:40

OK, so with a freshly built 4.7.2.alpha2, I successfully installed both new spkgs and all patches, and rebuilt Sage using -ba.  Now doing a full test.

Question:  in the extcode patch we refer to version 2.4.4 -- should that be 2.5.0?

I'll be ready with a positive review as soon as the testing is done (assuming success!).


---

Comment by jdemeyer created at 2011-09-26 21:20:40

Replying to [comment:112 cremona]:
> Question:  in the extcode patch we refer to version 2.4.4 -- should that be 2.5.0?
The patch was created for PARI version 2.4.4 but by now there is version 2.5.0.  So in fact both numbers are correct.  Since 2.4.4 is the first affected version, I say we use that version number.


---

Comment by cremona created at 2011-09-26 21:40:52

Replying to [comment:113 jdemeyer]:
> Replying to [comment:112 cremona]:
> > Question:  in the extcode patch we refer to version 2.4.4 -- should that be 2.5.0?
> The patch was created for PARI version 2.4.4 but by now there is version 2.5.0.  So in fact both numbers are correct.  Since 2.4.4 is the first affected version, I say we use that version number.

OK -- and all tests pass (on a 64-bit machine) so I'll give this a positive review.  I'll also do a 32-bit test tomorrow.


---

Comment by cremona created at 2011-09-26 21:40:52

Changing status from needs_review to positive_review.


---

Comment by davidloeffler created at 2011-09-27 13:57:42

Just a remark: I tried this out on Solaris, and all seems well -- it builds fine and the selection of tests that I ran (including everything in `sage/rings/number_field`,`sage/libs/pari` and `sage/interfaces/gp`) all worked.


---

Comment by cremona created at 2011-09-28 11:00:50

Successfully built and applied everything on 32-bit linux, now testing.


---

Comment by cremona created at 2011-09-29 08:16:00

Replying to [comment:116 cremona]:
> Successfully built and applied everything on 32-bit linux, now testing.

All tests pass (SuSE linux 32-bit).


---

Comment by davidloeffler created at 2011-09-29 09:13:21

I'm confused: is #11321 a prerequisite for this ticket, or not? I'm puzzled because these two tickets are listed as prerequisites for each other, and yet this one is at "positive review" and the other at "needs review". Is the proposal to close this ticket and merge the lcalc 1.23.p8 spkg from #11321, but not the two subsequent patches on that ticket, and the "needs review" there applies to the subsequent patches? Or are we going to wait for a p9 spkg at #11321, in which case we would probably need to test everything here over again?


---

Comment by jdemeyer created at 2011-09-29 09:33:12

Replying to [comment:118 davidloeffler]:
> I'm confused: is #11321 a prerequisite for this ticket, or not?
Yes, it is.
> I'm puzzled because these two tickets are listed as prerequisites for each other.
That's correct.  These two tickets need to be merged together, one will not work without the other.  leif wants to change #11321 such that it does not depend on this ticket, but I think that's unnecessary.

> Is the proposal to close this ticket and merge the lcalc 1.23.p8 spkg from #11321, but not the two subsequent patches on that ticket, and the "needs review" there applies to the subsequent patches?
needs_review on that ticket applies to everything.  I created the .p8, leif raised some concerns about the .p8 and is proposing a .p9 but it doesn't materialize.

> Or are we going to wait for a p9 spkg at #11321, in which case we would probably need to test everything here over again?
As far as I'm concerned, we can merge the .p8 as it is but it still needs_review.  I don't believe leif's concerns are serious enough that they should prevent the spkg from being merged.


---

Comment by jdemeyer created at 2011-10-04 08:41:22

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2011-10-04 08:42:55

Changing status from needs_work to needs_review.


---

Comment by mstreng created at 2011-10-05 16:02:44

Wouldn't it be more natural to change the output of the doctest in [attachment:11130-4.7.2.alpha3.patch] instead of the input?


---

Comment by jdemeyer created at 2011-10-05 16:12:22

Replying to [comment:124 mstreng]:
> Wouldn't it be more natural to change the output of the doctest in [attachment:11130-4.7.2.alpha3.patch] instead of the input?

I guess in this case, it does not really matter.  I went for a minimal change.

With the test added, all short and long doctests pass on sage.math (x86_64 GNU/Linux).


---

Comment by jdemeyer created at 2011-10-06 09:44:12

New lcalc package at #11321 needs review.


---

Comment by jdemeyer created at 2011-10-08 09:28:57

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-10-08 09:34:29

Fix doctest for sage-4.7.2.alpha3


---

Comment by jdemeyer created at 2011-10-08 09:37:20

Changing status from needs_work to needs_review.


---

Attachment

New patch, tested on 32-bit x86 Linux, 64-bit x86_64 Linux, OS X 10.4 PPC.


---

Comment by ddrake created at 2011-10-25 01:33:51

I'm trying to apply all the spkgs and patches in this ticket so I can review #11948, but I can't build the Sage library. With everything applied, I get, after `./sage -b`:

```
[...]
gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -O3 -Wall -Wstrict-prototypes -fPIC -I/home/drake/s/sage-4.7.2.rc0/local/include -I/home/drake/s/sage-4.7.2.rc0/local/include/csage -I/home/drake/s/sage-4.7.2.rc0/devel/sage/sage/ext -I/home/drake/s/sage-4.7.2.rc0/local/include/python2.6 -c sage/rings/real_mpfr.c -o build/temp.linux-x86_64-2.6/sage/rings/real_mpfr.o -w
error: command 'gcc' failed with exit status 1
```


If I just rerun `./sage -b` (surely that will fix it, right? :), I get

```
gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -O3 -Wall -Wstrict-prototypes -fPIC -I/home/drake/s/sage-4.7.2.rc0/local/lib/python/site-packages/numpy/core/include -I/home/drake/s/sage-4.7.2.rc0/local/include -I/home/drake/s/sage-4.7.2.rc0/local/include/csage -I/home/drake/s/sage-4.7.2.rc0/devel/sage/sage/ext -I/home/drake/s/sage-4.7.2.rc0/local/include/python2.6 -c sage/rings/polynomial/real_roots.c -o build/temp.linux-x86_64-2.6/sage/rings/polynomial/real_roots.o -w
sage/libs/pari/gen.c: In function ‘__pyx_pf_4sage_4libs_4pari_3gen_3gen_81Ser’:
sage/libs/pari/gen.c:12094: error: too many arguments to function ‘gtoser’
error: command 'gcc' failed with exit status 1
```


This is with 4.7.2.rc0 on amd64 Ubuntu 10.04.


---

Comment by jdemeyer created at 2011-10-25 06:43:30

Sorry to ask the obvious, but can you double-check that you applied the new PARI spkg and all patches here?


---

Comment by ddrake created at 2011-10-25 07:48:21

Replying to [comment:133 jdemeyer]:
> Sorry to ask the obvious, but can you double-check that you applied the new PARI spkg and all patches here?

No need to apologize...I was certain I did everything right, but I just tried again, and Sage built and is well on its way to passing all "ptestlong" tests. So I must have made a mistake above; sorry for the noise.


---

Comment by was created at 2011-10-30 04:38:02

Changing status from needs_review to positive_review.


---

Comment by was created at 2011-10-30 04:38:02

The new patch works for me (for the 64-bit test).  And I was definitely able to apply the patches and pari spkg here and get a working Sage.


---

Comment by jdemeyer created at 2011-11-03 16:14:43

Milestone sage-4.7.3 deleted


---

Comment by jdemeyer created at 2011-11-05 13:38:27

Fix 32-bit doctest for sage-4.8.alpha1


---

Attachment

Added an additional patch [attachment:11130-4.8.alpha1.patch].  Not sure how this extra doctest failure happened, but in any case this trivial patch fixes it.  It simply sets the 32-bit result equal to the 64-bit result.  I hope nobody minds if I leave the positive_review (not to drag this ticket longer than necessary).


---

Comment by cremona created at 2011-11-05 13:52:27

Replying to [comment:141 jdemeyer]:
> Added an additional patch [attachment:11130-4.8.alpha1.patch].  Not sure how this extra doctest failure happened, but in any case this trivial patch fixes it.  It simply sets the 32-bit result equal to the 64-bit result.  I hope nobody minds if I leave the positive_review (not to drag this ticket longer than necessary).

Fine with me.  The 32/64 bit differences in pari are such a nuisance, as I have told Karim more than once...


---

Comment by jdemeyer created at 2011-11-07 10:11:21

Resolution: fixed
