# Issue 32981: Use CPU time for --warn-long and a low default limit for non-long tests

archive/issues_032744.json:
```json
{
    "body": "As discussed in #32973, the default value of `--warn-long` is roughly a minute, independent of the `--long` flag, and is only enabled when timing information from previous test runs is available. Our developers' guide suggests that even a \"long time\" test should complete in under five seconds:\n\nhttps://doc.sagemath.org/html/en/developer/doctesting.html#optional-arguments\n\nThis ticket addresses two problems:\n\n1. The timing information is often unavailable. We should still warn about long tests in that case.\n2. The default of 60 CPU-equivalent seconds is much too high when `--long` is not in use.\n\nBoth of these issues stem from using the \"wall time\" to measure how long a test has run. Wall time is inherently unstable; if you're watching a movie, the tests will take longer. On a slower computer, the tests will take longer. Et cetera. The use of timing information from previous runs and the obscenely high `--warn-long` limit partially address that.\n\nSo in targeting our two issues, we first aim to switch the timing reports and `--warn-long` flag to use CPU time instead of wall time. CPU time is more reliable, since it only reports time actually spent working on the problem. (It's still sensitive to things like physical CPU time and `CFLAGS`; those will be addressed in #33022). With CPU time being used, the timings will be much more consistent, allowing us to lower the default value of `--warn-long` to 10 CPU-seconds when `--long` was not given.\n\nThe main difficulty is in accounting for CPU time spent in pexpect subprocesses. We don't `wait()` for those and they may not terminate, so the OS's usual methods of retrieving child process statistics don't work for them. At present we have a PID-based solution that works quickly on Linux/BSD, but something similar for macOS would be nice.\n\nCC:  @vbraun @tornaria\n\nWork_Issues: cputime by PID on macOS\n\nReviewer: https://github.com/sagemath/sage/actions/runs/1992568379\n\nAuthor: Michael Orlitzky\n\nBranch: u/mjo/ticket/32981\n\nStatus: needs_work\n\nCommit: d7d2cffd9913bb0dc511a24534316f7d458d2e45\n\nIssue created by migration from https://trac.sagemath.org/ticket/32981\n\n",
    "created_at": "2021-12-06T12:58:24Z",
    "labels": [
        "component: doctest framework",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Use CPU time for --warn-long and a low default limit for non-long tests",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32981",
    "user": "https://github.com/orlitzky"
}
```
As discussed in #32973, the default value of `--warn-long` is roughly a minute, independent of the `--long` flag, and is only enabled when timing information from previous test runs is available. Our developers' guide suggests that even a "long time" test should complete in under five seconds:

https://doc.sagemath.org/html/en/developer/doctesting.html#optional-arguments

This ticket addresses two problems:

1. The timing information is often unavailable. We should still warn about long tests in that case.
2. The default of 60 CPU-equivalent seconds is much too high when `--long` is not in use.

Both of these issues stem from using the "wall time" to measure how long a test has run. Wall time is inherently unstable; if you're watching a movie, the tests will take longer. On a slower computer, the tests will take longer. Et cetera. The use of timing information from previous runs and the obscenely high `--warn-long` limit partially address that.

So in targeting our two issues, we first aim to switch the timing reports and `--warn-long` flag to use CPU time instead of wall time. CPU time is more reliable, since it only reports time actually spent working on the problem. (It's still sensitive to things like physical CPU time and `CFLAGS`; those will be addressed in #33022). With CPU time being used, the timings will be much more consistent, allowing us to lower the default value of `--warn-long` to 10 CPU-seconds when `--long` was not given.

The main difficulty is in accounting for CPU time spent in pexpect subprocesses. We don't `wait()` for those and they may not terminate, so the OS's usual methods of retrieving child process statistics don't work for them. At present we have a PID-based solution that works quickly on Linux/BSD, but something similar for macOS would be nice.

CC:  @vbraun @tornaria

Work_Issues: cputime by PID on macOS

Reviewer: https://github.com/sagemath/sage/actions/runs/1992568379

Author: Michael Orlitzky

Branch: u/mjo/ticket/32981

Status: needs_work

Commit: d7d2cffd9913bb0dc511a24534316f7d458d2e45

Issue created by migration from https://trac.sagemath.org/ticket/32981





---

archive/issue_comments_466464.json:
```json
{
    "body": "<a id='comment:1'></a>Volker, any idea why we used wall time for the limit rather than CPU time? It's making it a bit awkward to pick a multiplier when no timing information is available (which is usually the case for me).",
    "created_at": "2021-12-06T13:18:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466464",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:1'></a>Volker, any idea why we used wall time for the limit rather than CPU time? It's making it a bit awkward to pick a multiplier when no timing information is available (which is usually the case for me).



---

archive/issue_comments_466465.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-12-08T14:37:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466465",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_466466.json:
```json
{
    "body": "<a id='comment:3'></a>This is a bit too lenient IMO... allowing 15s for a non-long test when no timing information is available. Still, it's an improvement.",
    "created_at": "2021-12-08T14:38:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466466",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:3'></a>This is a bit too lenient IMO... allowing 15s for a non-long test when no timing information is available. Still, it's an improvement.



---

archive/issue_comments_466467.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-12-08T14:38:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466467",
    "user": "https://github.com/orlitzky"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_466468.json:
```json
{
    "body": "<a id='comment:4'></a>I'm just going to put in the effort to switch this to CPU time, which makes a lot more sense for a time measurement that needs to be consistent across machines.",
    "created_at": "2021-12-08T17:42:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466468",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:4'></a>I'm just going to put in the effort to switch this to CPU time, which makes a lot more sense for a time measurement that needs to be consistent across machines.



---

archive/issue_comments_466469.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-12-08T17:42:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466469",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_466470.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-12-08T21:08:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466470",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_466471.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-12-08T21:09:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466471",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_466472.json:
```json
{
    "body": "<a id='comment:6'></a>New commits:",
    "created_at": "2021-12-08T21:09:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466472",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:6'></a>New commits:



---

archive/issue_events_087133.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-10T00:37:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32981#event-87133"
}
```



---

archive/issue_comments_466473.json:
```json
{
    "body": "<a id='comment:9'></a>One reason for using wall time instead of CPU time might be that it works better for computations that use external processes like Pexpect:\n\n```\nsage: R = PolynomialRing(GF(101), 'x', 8)\n....: J = sage.rings.ideal.Cyclic(R)\n....: %time gb = J.groebner_basis(algorithm='singular')\nCPU times: user 917 ms, sys: 52.6 ms, total: 969 ms\nWall time: 33.2 s\n```",
    "created_at": "2022-02-08T21:47:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466473",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:9'></a>One reason for using wall time instead of CPU time might be that it works better for computations that use external processes like Pexpect:

```
sage: R = PolynomialRing(GF(101), 'x', 8)
....: J = sage.rings.ideal.Cyclic(R)
....: %time gb = J.groebner_basis(algorithm='singular')
CPU times: user 917 ms, sys: 52.6 ms, total: 969 ms
Wall time: 33.2 s
```



---

archive/issue_comments_466474.json:
```json
{
    "body": "<a id='comment:10'></a>Maybe measure both and pay attention to wall time only if it is much longer than CPU time. I don't know if \"much longer\" should be a raw time (5 seconds longer) or a multiple (10 times as long). We want informative messages, so this doesn't have to be flawless.",
    "created_at": "2022-02-08T22:05:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466474",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:10'></a>Maybe measure both and pay attention to wall time only if it is much longer than CPU time. I don't know if "much longer" should be a raw time (5 seconds longer) or a multiple (10 times as long). We want informative messages, so this doesn't have to be flawless.



---

archive/issue_comments_466475.json:
```json
{
    "body": "<a id='comment:11'></a>Well.. that's embarrassing. I'll have to think about it.",
    "created_at": "2022-02-08T22:15:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466475",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:11'></a>Well.. that's embarrassing. I'll have to think about it.



---

archive/issue_comments_466476.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-02-08T22:15:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466476",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_466477.json:
```json
{
    "body": "<a id='comment:12'></a>Oh, we just have to pass `subprocesses=True` inside the doctest timer. I guess nobody noticed until now because the cputime wasn't reported anyway. I'll update the branch once I'm sure it works correctly.",
    "created_at": "2022-02-08T22:31:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466477",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:12'></a>Oh, we just have to pass `subprocesses=True` inside the doctest timer. I guess nobody noticed until now because the cputime wasn't reported anyway. I'll update the branch once I'm sure it works correctly.



---

archive/issue_comments_466478.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-02-09T15:53:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466478",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_466479.json:
```json
{
    "body": "<a id='comment:14'></a>That fixed the immediate problem, but caused several more. Doctesting the doctest framework using the sage pexpect interface to itself is pretty fragile, who would've thought...",
    "created_at": "2022-02-09T16:26:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466479",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:14'></a>That fixed the immediate problem, but caused several more. Doctesting the doctest framework using the sage pexpect interface to itself is pretty fragile, who would've thought...



---

archive/issue_comments_466480.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-09T21:26:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466480",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_466481.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-02-10T00:05:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466481",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_466482.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-02-10T14:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466482",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_466483.json:
```json
{
    "body": "<a id='comment:18'></a>Well, at least I know why Volker chose to use walltime now. Several times yesterday I almost quit and wandered into the woods.\n\nUsing the existing `cputime(subprocesses=True)` isn't going to work. Our pexpect interfaces are flaky, and we have a lot of doctests that check for low-level \"incidental\" details that appear when using them. Moreover most don't actually implement `cputime()`. And that's just for standard packages -- the optional ones should be much worse.\n\nI was able to get the tests passing, but only by introducing twice as many WTFs as I discovered. I wouldn't commit such an atrocity, nor do I have the time to properly investigate and fix all of the underlying issues. Instead, I've reverted back to where the branch was two days ago, and added a commit that reliably computes the cputime for all subprocesses.... but only on Linux/BSD. The same information is probably available on macOS, but I don't have it in front of me to poke around.\n\nWhile platform-specific code is lame, I think this may be a reasonable trade-off, especially if we can get it working on macOS. We only need **someone** to notice & fix long tests, not **everyone**. And the missing information can only hurt for (a) pexpect tests, that (b) happen to run long. So it's not like the entire test suite will have incorrect timing information on e.g. Cygwin.",
    "created_at": "2022-02-10T15:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466483",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:18'></a>Well, at least I know why Volker chose to use walltime now. Several times yesterday I almost quit and wandered into the woods.

Using the existing `cputime(subprocesses=True)` isn't going to work. Our pexpect interfaces are flaky, and we have a lot of doctests that check for low-level "incidental" details that appear when using them. Moreover most don't actually implement `cputime()`. And that's just for standard packages -- the optional ones should be much worse.

I was able to get the tests passing, but only by introducing twice as many WTFs as I discovered. I wouldn't commit such an atrocity, nor do I have the time to properly investigate and fix all of the underlying issues. Instead, I've reverted back to where the branch was two days ago, and added a commit that reliably computes the cputime for all subprocesses.... but only on Linux/BSD. The same information is probably available on macOS, but I don't have it in front of me to poke around.

While platform-specific code is lame, I think this may be a reasonable trade-off, especially if we can get it working on macOS. We only need **someone** to notice & fix long tests, not **everyone**. And the missing information can only hurt for (a) pexpect tests, that (b) happen to run long. So it's not like the entire test suite will have incorrect timing information on e.g. Cygwin.



---

archive/issue_comments_466484.json:
```json
{
    "body": "<a id='comment:19'></a>If only there were a Python package for that...",
    "created_at": "2022-02-10T18:25:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466484",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'></a>If only there were a Python package for that...



---

archive/issue_comments_466485.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:19 mkoeppe]:\n> If only there were a Python package for that...\n\n\nIf you're referring to psutil, it's mainly a C package and consists of nothing BUT platform-specific code. The version we had was almost five years out of date and required a huge unmaintained patch that was rejected entirely by upstream. I'll take the ten lines we have now instead.\n\nWorst case, we can get the information from the OSX kernel with a another five lines of code.",
    "created_at": "2022-02-10T19:00:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466485",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:20'></a>Replying to [comment:19 mkoeppe]:
> If only there were a Python package for that...


If you're referring to psutil, it's mainly a C package and consists of nothing BUT platform-specific code. The version we had was almost five years out of date and required a huge unmaintained patch that was rejected entirely by upstream. I'll take the ten lines we have now instead.

Worst case, we can get the information from the OSX kernel with a another five lines of code.



---

archive/issue_comments_466486.json:
```json
{
    "body": "<a id='comment:22'></a>The information we need can be obtained from `proc_pidinfo(pid, PROC_PIDTASKINFO,...)` in libproc on macOS. I found a gist that might serve as inspiration:\n\n  https://gist.github.com/nguyen-phillip/de66b0ea2144e20ddd844c41c9d93eb9\n\nIn theory all we need to do is get a `proc_taskinfo` struct from that call, and read its `pti_total_user` and `pti_total_system` fields. But I don't have a mac to test on so someone else will have to take this step.",
    "created_at": "2022-02-10T19:54:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466486",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:22'></a>The information we need can be obtained from `proc_pidinfo(pid, PROC_PIDTASKINFO,...)` in libproc on macOS. I found a gist that might serve as inspiration:

  https://gist.github.com/nguyen-phillip/de66b0ea2144e20ddd844c41c9d93eb9

In theory all we need to do is get a `proc_taskinfo` struct from that call, and read its `pti_total_user` and `pti_total_system` fields. But I don't have a mac to test on so someone else will have to take this step.



---

archive/issue_comments_466487.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:20 mjo]:\n> The version we had was almost five years out of date and required a huge unmaintained patch \n\n\nWe needed the patch for Cygwin only. We could just use an upgraded psutil and do whatever is needed for Cygwin in the Sage library.",
    "created_at": "2022-02-10T20:25:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466487",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:23'></a>Replying to [comment:20 mjo]:
> The version we had was almost five years out of date and required a huge unmaintained patch 


We needed the patch for Cygwin only. We could just use an upgraded psutil and do whatever is needed for Cygwin in the Sage library.



---

archive/issue_comments_466488.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:23 mkoeppe]:\n> Replying to [comment:20 mjo]:\n> > The version we had was almost five years out of date and required a huge unmaintained patch \n\n> \n> We needed the patch for Cygwin only. We could just use an upgraded psutil and do whatever is needed for Cygwin in the Sage library.\n\n\nYes but if mkoeppe ever gets hit by a bus, the rest of us will be crushed under 25 hours/day of package upgrades and maintenance. I appreciate all you do, but there's a huge cost to every additional dependency measured over the years.",
    "created_at": "2022-02-10T21:16:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466488",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:24'></a>Replying to [comment:23 mkoeppe]:
> Replying to [comment:20 mjo]:
> > The version we had was almost five years out of date and required a huge unmaintained patch 

> 
> We needed the patch for Cygwin only. We could just use an upgraded psutil and do whatever is needed for Cygwin in the Sage library.


Yes but if mkoeppe ever gets hit by a bus, the rest of us will be crushed under 25 hours/day of package upgrades and maintenance. I appreciate all you do, but there's a huge cost to every additional dependency measured over the years.



---

archive/issue_comments_466489.json:
```json
{
    "body": "<a id='comment:25'></a>It's a well-maintained package and using it beats maintaining Sage-specific system code ... which is not even written yet ...",
    "created_at": "2022-02-10T21:20:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466489",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'></a>It's a well-maintained package and using it beats maintaining Sage-specific system code ... which is not even written yet ...



---

archive/issue_comments_466490.json:
```json
{
    "body": "<a id='comment:26'></a>There's a point after which I agree, but assuming that the package itself causes zero problems: every distro needs to package it and keep it upgraded, and every user needs to install it every time they build sage (wasting time, space, and bandwidth), and every upstream release usually gets a ticket->branch->test->review cycle within sage itself.\n\nThe total amount of code we're talking about is less than the text files in `build/pkgs/psutil` contained. It's in a non-critical location in a pseudo-private, non-user-facing function. We'll go years without ever thinking about it.",
    "created_at": "2022-02-10T21:40:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466490",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:26'></a>There's a point after which I agree, but assuming that the package itself causes zero problems: every distro needs to package it and keep it upgraded, and every user needs to install it every time they build sage (wasting time, space, and bandwidth), and every upstream release usually gets a ticket->branch->test->review cycle within sage itself.

The total amount of code we're talking about is less than the text files in `build/pkgs/psutil` contained. It's in a non-critical location in a pseudo-private, non-user-facing function. We'll go years without ever thinking about it.



---

archive/issue_comments_466491.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:26 mjo]:\n> every distro needs to package\n\n\nhttps://repology.org/project/python:psutil/versions",
    "created_at": "2022-02-10T21:43:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466491",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'></a>Replying to [comment:26 mjo]:
> every distro needs to package


https://repology.org/project/python:psutil/versions



---

archive/issue_comments_466492.json:
```json
{
    "body": "<a id='comment:28'></a>Replying to [comment:27 mkoeppe]:\n> \n> https://repology.org/project/python:psutil/versions\n\n\nThat's not the hard part. The Gentoo package is available on amd64, arm, arm64, hppa, ppc, ppc64, sparc, x86, alpha, ia64, riscv, m68k, mips, and s390. Every new version has to be tested, and stabilized, and most introduce new bugs that have to be triaged, upstreamed, patched, etc. If psutil is not used by sage, I don't have to care about any of that. If it is, I often have to step in to ensure that the distro package is compatible with that sage expects. Repeat two-hundred-some times on however-many distros and you have a never-ending stream of work.",
    "created_at": "2022-02-10T21:51:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466492",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:28'></a>Replying to [comment:27 mkoeppe]:
> 
> https://repology.org/project/python:psutil/versions


That's not the hard part. The Gentoo package is available on amd64, arm, arm64, hppa, ppc, ppc64, sparc, x86, alpha, ia64, riscv, m68k, mips, and s390. Every new version has to be tested, and stabilized, and most introduce new bugs that have to be triaged, upstreamed, patched, etc. If psutil is not used by sage, I don't have to care about any of that. If it is, I often have to step in to ensure that the distro package is compatible with that sage expects. Repeat two-hundred-some times on however-many distros and you have a never-ending stream of work.



---

archive/issue_comments_466493.json:
```json
{
    "body": "<a id='comment:29'></a>https://gitweb.gentoo.org/repo/gentoo.git/log/dev-python/psutil doesn't look particularly dramatic",
    "created_at": "2022-02-10T22:01:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466493",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:29'></a>https://gitweb.gentoo.org/repo/gentoo.git/log/dev-python/psutil doesn't look particularly dramatic



---

archive/issue_comments_466494.json:
```json
{
    "body": "<a id='comment:30'></a>You'd get a better idea from the bug tracker, but I don't know what point we're arguing. Sage was stuck on the same version of psutil for five years. That naturally did not require much maintenance either within sage or without.",
    "created_at": "2022-02-10T22:18:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466494",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:30'></a>You'd get a better idea from the bug tracker, but I don't know what point we're arguing. Sage was stuck on the same version of psutil for five years. That naturally did not require much maintenance either within sage or without.



---

archive/issue_comments_466495.json:
```json
{
    "body": "<a id='comment:31'></a>You were trying to argue that somehow creating new homegrown platform-dependent code is a better strategy than just using an existing upstream project (for which we have no particular version requirements and never had).",
    "created_at": "2022-02-11T00:10:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466495",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:31'></a>You were trying to argue that somehow creating new homegrown platform-dependent code is a better strategy than just using an existing upstream project (for which we have no particular version requirements and never had).



---

archive/issue_comments_466496.json:
```json
{
    "body": "<a id='comment:32'></a>headline: man who doesn't do dishes thinks it's more elegant to use a different spoon for each ravioli",
    "created_at": "2022-02-11T01:49:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466496",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:32'></a>headline: man who doesn't do dishes thinks it's more elegant to use a different spoon for each ravioli



---

archive/issue_comments_466497.json:
```json
{
    "body": "<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-03-12T18:48:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466497",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_466498.json:
```json
{
    "body": "<a id='comment:34'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-03-12T18:54:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466498",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:34'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_466499.json:
```json
{
    "body": "<a id='comment:35'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-03-14T14:22:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466499",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:35'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_466500.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-03-26T01:31:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466500",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_466501.json:
```json
{
    "body": "<a id='comment:36'></a>I ran this on GH but the actions page has been failing to load for a week. I've reported it to GH and a fix is \"being worked on.\" Aside from that, I think it's ready for review.\n\nIn the spirit of \"do no harm,\" I have avoided outputting CPU time statistics wherever possible to avoid outputting confusing numbers on macOS. Nevertheless, in context, the lack of fast CPU time for subprocesses on macOS is not a deal-breaker: the only situation where it will be missed is if a subprocess takes a lot of CPU and would normally violate the `--warn-long` limit, and instead appears to run fast on macOS. But the status quo is that using wall time already makes `--warn-long` useless; and false negatives are not harmful. If the purpose of `--warn-long` is to prevent slow tests from being added to sage, then we only need `--warn-long` to trigger *somewhere* (e.g. the patchbots), and not *everywhere*. Overlooking the occasional warning for certain tests on one platform isn't contrary to that goal, and in any case is not worse than what we already have -- no usable warnings at all.\n\nOf course I'll open a follow-up ticket for adding the macOS accounting should anyone care to do it.",
    "created_at": "2022-03-26T01:31:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466501",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:36'></a>I ran this on GH but the actions page has been failing to load for a week. I've reported it to GH and a fix is "being worked on." Aside from that, I think it's ready for review.

In the spirit of "do no harm," I have avoided outputting CPU time statistics wherever possible to avoid outputting confusing numbers on macOS. Nevertheless, in context, the lack of fast CPU time for subprocesses on macOS is not a deal-breaker: the only situation where it will be missed is if a subprocess takes a lot of CPU and would normally violate the `--warn-long` limit, and instead appears to run fast on macOS. But the status quo is that using wall time already makes `--warn-long` useless; and false negatives are not harmful. If the purpose of `--warn-long` is to prevent slow tests from being added to sage, then we only need `--warn-long` to trigger *somewhere* (e.g. the patchbots), and not *everywhere*. Overlooking the occasional warning for certain tests on one platform isn't contrary to that goal, and in any case is not worse than what we already have -- no usable warnings at all.

Of course I'll open a follow-up ticket for adding the macOS accounting should anyone care to do it.



---

archive/issue_comments_466502.json:
```json
{
    "body": "<a id='comment:37'></a>In theory, it would be good to understand how pytest deals with such issues, as we are aiming to switch to pytest, right?",
    "created_at": "2022-03-26T11:32:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466502",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:37'></a>In theory, it would be good to understand how pytest deals with such issues, as we are aiming to switch to pytest, right?



---

archive/issue_comments_466503.json:
```json
{
    "body": "<a id='comment:38'></a>Replying to [comment:37 dimpase]:\n> In theory, it would be good to understand how pytest deals with such issues, as we are aiming to switch to pytest, right?\n\n\nIt uses wall time for its timeouts and slow test warnings.",
    "created_at": "2022-03-26T11:54:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466503",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:38'></a>Replying to [comment:37 dimpase]:
> In theory, it would be good to understand how pytest deals with such issues, as we are aiming to switch to pytest, right?


It uses wall time for its timeouts and slow test warnings.



---

archive/issue_comments_466504.json:
```json
{
    "body": "<a id='comment:39'></a>FWIW the GH action results are now visible and look OK.",
    "created_at": "2022-03-30T01:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466504",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:39'></a>FWIW the GH action results are now visible and look OK.



---

archive/issue_events_087134.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-17T19:59:27Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32981#event-87134"
}
```



---

archive/issue_events_087135.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-17T19:59:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32981#event-87135"
}
```



---

archive/issue_comments_466505.json:
```json
{
    "body": "<a id='comment:41'></a>a rebase is due",
    "created_at": "2022-06-09T08:51:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466505",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:41'></a>a rebase is due



---

archive/issue_comments_466506.json:
```json
{
    "body": "<a id='comment:42'></a>I've lost interest.",
    "created_at": "2022-06-09T12:59:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466506",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:42'></a>I've lost interest.



---

archive/issue_comments_466507.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-06-09T12:59:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32981#issuecomment-466507",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_events_087136.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32981#event-87136"
}
```



---

archive/issue_events_087137.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32981",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32981#event-87137"
}
```
