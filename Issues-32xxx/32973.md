# Issue 32973: Increase default test timeout

archive/issues_032736.json:
```json
{
    "body": "Having just run through the default (non `--long`) test suite for the first time in a while, I've hit...\n\n```\nsage -t --random-seed=... src/sage/manifolds/differentiable/tensorfield.py\n    [1019 tests, 364.13 s]\n```\n\nwhich runs afoul of our default timeout in `src/sage/doctest/control.py`:\n\n```\noptions.timeout = int(os.getenv('SAGE_TIMEOUT', 5 * 60))\n```\n\nThere's nothing wrong in that file; it just has a lot of tests. Even after #32967, I think it would be safer to go straight to 7 minutes, because the runtime is more or less nondecreasing.\n\n\n**Branch:** [u/mjo/ticket/32973](https://github.com/sagemath/sagetrac-mirror/tree/u/mjo/ticket/32973)\n\n**Commit:** [c3b012418a22a06dc2a300c33d17009b4ddffde4](https://github.com/sagemath/sagetrac-mirror/commit/c3b012418a22a06dc2a300c33d17009b4ddffde4)\n\n**Author:** Michael Orlitzky\n\n**Status:** needs_review\n\nIssue created by migration from https://trac.sagemath.org/ticket/32973\n\n",
    "created_at": "2021-12-04T13:47:43Z",
    "labels": [
        "component: doctest framework",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Increase default test timeout",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32973",
    "user": "https://github.com/orlitzky"
}
```
Having just run through the default (non `--long`) test suite for the first time in a while, I've hit...

```
sage -t --random-seed=... src/sage/manifolds/differentiable/tensorfield.py
    [1019 tests, 364.13 s]
```

which runs afoul of our default timeout in `src/sage/doctest/control.py`:

```
options.timeout = int(os.getenv('SAGE_TIMEOUT', 5 * 60))
```

There's nothing wrong in that file; it just has a lot of tests. Even after #32967, I think it would be safer to go straight to 7 minutes, because the runtime is more or less nondecreasing.


**Branch:** [u/mjo/ticket/32973](https://github.com/sagemath/sagetrac-mirror/tree/u/mjo/ticket/32973)

**Commit:** [c3b012418a22a06dc2a300c33d17009b4ddffde4](https://github.com/sagemath/sagetrac-mirror/commit/c3b012418a22a06dc2a300c33d17009b4ddffde4)

**Author:** Michael Orlitzky

**Status:** needs_review

Issue created by migration from https://trac.sagemath.org/ticket/32973





---

archive/issue_comments_657515.json:
```json
{
    "body": "<a id='comment:1'></a>\nWhat about having a \"hard\" timeout of 7 minutes, but keep a \"soft\" timeout of 5m (or less?)\n\nMeaning: tests run to the end for 7 minutes, but files taking more than 5 are reported at the end as \"taking too long\". In effect, this means the whole file is doctested, but it still shows as an error/warning at the end.",
    "created_at": "2021-12-05T22:02:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657515",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:1'></a>
What about having a "hard" timeout of 7 minutes, but keep a "soft" timeout of 5m (or less?)

Meaning: tests run to the end for 7 minutes, but files taking more than 5 are reported at the end as "taking too long". In effect, this means the whole file is doctested, but it still shows as an error/warning at the end.



---

archive/issue_comments_657516.json:
```json
{
    "body": "<a id='comment:2'></a>\nReplying to [tornaria](#comment%3A1):\n> What about having a \"hard\" timeout of 7 minutes, but keep a \"soft\" timeout of 5m (or less?)\n> \n> Meaning: tests run to the end for 7 minutes, but files taking more than 5 are reported at the end as \"taking too long\". In effect, this means the whole file is doctested, but it still shows as an error/warning at the end.\n\n\nI don't think a warning about *files* that take a long time is too useful, because what would we do to fix them?\n\nWe have `--warn-long` to warn us about individual doctests that take a long time. But the time it takes to test a file is roughly proportional to the number of tests it contains, or (even more roughly) proportional to the length of the file itself. There's nothing wrong with a large file per se, or with a lot of tests, so there's really nothing inherently wrong with a file that takes a long time to test as a whole.\n\nAs far as I know, the `--timeout` value (as opposed to the `--warn-long` value) is just there to prevent the patchbots from getting stuck in an infinite loop. So it can be excessively high without hurting anything. The value of `--warn-long`, on the other hand, should be low enough to catch inefficient tests that can be fixed.\n\nSo, ultimately, I think we should be setting the default timeouts so that `make ptest` and `make ptestlong` reliably pass on the slowest machine that anyone actually uses. I still regularly use a Thinkpad x61s, so I may be that guy, although even that old laptop is x64.",
    "created_at": "2021-12-05T23:20:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657516",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:2'></a>
Replying to [tornaria](#comment%3A1):
> What about having a "hard" timeout of 7 minutes, but keep a "soft" timeout of 5m (or less?)
> 
> Meaning: tests run to the end for 7 minutes, but files taking more than 5 are reported at the end as "taking too long". In effect, this means the whole file is doctested, but it still shows as an error/warning at the end.


I don't think a warning about *files* that take a long time is too useful, because what would we do to fix them?

We have `--warn-long` to warn us about individual doctests that take a long time. But the time it takes to test a file is roughly proportional to the number of tests it contains, or (even more roughly) proportional to the length of the file itself. There's nothing wrong with a large file per se, or with a lot of tests, so there's really nothing inherently wrong with a file that takes a long time to test as a whole.

As far as I know, the `--timeout` value (as opposed to the `--warn-long` value) is just there to prevent the patchbots from getting stuck in an infinite loop. So it can be excessively high without hurting anything. The value of `--warn-long`, on the other hand, should be low enough to catch inefficient tests that can be fixed.

So, ultimately, I think we should be setting the default timeouts so that `make ptest` and `make ptestlong` reliably pass on the slowest machine that anyone actually uses. I still regularly use a Thinkpad x61s, so I may be that guy, although even that old laptop is x64.



---

archive/issue_comments_657517.json:
```json
{
    "body": "<a id='comment:3'></a>\nWhat you say makes perfect sense, thanks for the explanation.\n\nI was worried that a slow doctest like in #32964 would be missed. In my experience it only occasionally timed out on i686 and it never gave any warning on x86_64. Maybe this just means the `--warn-long` default is set too high. It does not seem reasonable that a particular file times out because of a single very slow test, but there's no warning for this single test (I can imagine the culprit being not necessarily the last test that was run.)",
    "created_at": "2021-12-06T00:16:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657517",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:3'></a>
What you say makes perfect sense, thanks for the explanation.

I was worried that a slow doctest like in #32964 would be missed. In my experience it only occasionally timed out on i686 and it never gave any warning on x86_64. Maybe this just means the `--warn-long` default is set too high. It does not seem reasonable that a particular file times out because of a single very slow test, but there's no warning for this single test (I can imagine the culprit being not necessarily the last test that was run.)



---

archive/issue_comments_657518.json:
```json
{
    "body": "<a id='comment:4'></a>\nIt does look like `warn_long` is set too high when `--long` is not given; 60s if I'm not mistaken. I'll see if that can't be improved too.\n\nBut I think the main reason that I found #32964 and others like it is because nobody else is running the test suite without `--long`. All of the patchbots and GH actions run `ptestlong`. I accidentally ran it without `--long` one day so now I'm finding all the bugs..",
    "created_at": "2021-12-06T00:36:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657518",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:4'></a>
It does look like `warn_long` is set too high when `--long` is not given; 60s if I'm not mistaken. I'll see if that can't be improved too.

But I think the main reason that I found #32964 and others like it is because nobody else is running the test suite without `--long`. All of the patchbots and GH actions run `ptestlong`. I accidentally ran it without `--long` one day so now I'm finding all the bugs..



---

archive/issue_comments_657519.json:
```json
{
    "body": "<a id='comment:5'></a>\nI've gone all the way to 10 minutes. With `make ptest` on my desktop (AMD Phenom II X4), tensorfield.py already approaches eight minutes (~460s). If I watch a movie or browse the web simultaneously it gets worse.\n\nI still plan to check the timings on my laptop, probably tonight, to make sure that 10 is enough.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c3b012418a22a06dc2a300c33d17009b4ddffde4\">c3b0124</a></td><td><code>Trac #32973: increase the default test timeout to ten minutes.</code></td></tr></table>\n",
    "created_at": "2021-12-06T12:34:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657519",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:5'></a>
I've gone all the way to 10 minutes. With `make ptest` on my desktop (AMD Phenom II X4), tensorfield.py already approaches eight minutes (~460s). If I watch a movie or browse the web simultaneously it gets worse.

I still plan to check the timings on my laptop, probably tonight, to make sure that 10 is enough.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c3b012418a22a06dc2a300c33d17009b4ddffde4">c3b0124</a></td><td><code>Trac #32973: increase the default test timeout to ten minutes.</code></td></tr></table>




---

archive/issue_comments_657520.json:
```json
{
    "body": "**Branch:** [u/mjo/ticket/32973](https://github.com/sagemath/sagetrac-mirror/tree/u/mjo/ticket/32973)",
    "created_at": "2021-12-06T12:34:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657520",
    "user": "https://github.com/orlitzky"
}
```

**Branch:** [u/mjo/ticket/32973](https://github.com/sagemath/sagetrac-mirror/tree/u/mjo/ticket/32973)



---

archive/issue_comments_657521.json:
```json
{
    "body": "**Commit:** [c3b012418a22a06dc2a300c33d17009b4ddffde4](https://github.com/sagemath/sagetrac-mirror/commit/c3b012418a22a06dc2a300c33d17009b4ddffde4)",
    "created_at": "2021-12-06T12:34:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657521",
    "user": "https://github.com/orlitzky"
}
```

**Commit:** [c3b012418a22a06dc2a300c33d17009b4ddffde4](https://github.com/sagemath/sagetrac-mirror/commit/c3b012418a22a06dc2a300c33d17009b4ddffde4)



---

archive/issue_comments_657522.json:
```json
{
    "body": "**Author:** Michael Orlitzky",
    "created_at": "2021-12-06T12:34:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657522",
    "user": "https://github.com/orlitzky"
}
```

**Author:** Michael Orlitzky



---

archive/issue_comments_657523.json:
```json
{
    "body": "<a id='comment:6'></a>\nThe laptop (Core II duo @ 1.8ghz) actually fares better than my desktop, but with fewer threads (2 vs 4). So ten minutes looks like a good number.",
    "created_at": "2021-12-07T12:53:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657523",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:6'></a>
The laptop (Core II duo @ 1.8ghz) actually fares better than my desktop, but with fewer threads (2 vs 4). So ten minutes looks like a good number.



---

archive/issue_comments_657524.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2021-12-07T12:53:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657524",
    "user": "https://github.com/orlitzky"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_657525.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [mjo](#comment%3A4):\n> It does look like `warn_long` is set too high when `--long` is not given; 60s if I'm not mistaken. I'll see if that can't be improved too.\n\n\nOn my desktop is set to ~ 36s (it varies a little bit).\n\n> But I think the main reason that I found #32964 and others like it is because nobody else is running the test suite without `--long`. All of the patchbots and GH actions run `ptestlong`. I accidentally ran it without `--long` one day so now I'm finding all the bugs..\n\n\nIn the void package I'm running the test suite using `./sage -tp $JOBS --all`. But the output is very long. A summary of errors shows up at the end so one knows what to look for, but the slow doctest warning is not.\n\nIt might be useful if:\n\na. The slow doctest warning is summarized at the end (just mentioning the file is useful enough so one can search for it in the log).\n\nb. There's an option so that the check exits with an error on warnings so this is catched by the CI.\n\nc.  Even if test is run with `--long`, the doctests that are NOT labeled long still emit a warning if they take more time than the warn_long time.",
    "created_at": "2021-12-08T13:28:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657525",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:7'></a>
Replying to [mjo](#comment%3A4):
> It does look like `warn_long` is set too high when `--long` is not given; 60s if I'm not mistaken. I'll see if that can't be improved too.


On my desktop is set to ~ 36s (it varies a little bit).

> But I think the main reason that I found #32964 and others like it is because nobody else is running the test suite without `--long`. All of the patchbots and GH actions run `ptestlong`. I accidentally ran it without `--long` one day so now I'm finding all the bugs..


In the void package I'm running the test suite using `./sage -tp $JOBS --all`. But the output is very long. A summary of errors shows up at the end so one knows what to look for, but the slow doctest warning is not.

It might be useful if:

a. The slow doctest warning is summarized at the end (just mentioning the file is useful enough so one can search for it in the log).

b. There's an option so that the check exits with an error on warnings so this is catched by the CI.

c.  Even if test is run with `--long`, the doctests that are NOT labeled long still emit a warning if they take more time than the warn_long time.



---

archive/issue_comments_657526.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [mjo](#comment%3A5):\n> **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c3b012418a22a06dc2a300c33d17009b4ddffde4\">c3b0124</a></td><td><code>Trac #32973: increase the default test timeout to ten minutes.</code></td></tr></table>\n\n\nLGTM, although I should mention that I have a box where `sage --tp 32 --all` takes < 4m wall time so a rogue test taking 10 minutes to time out will double the wait :-)\n\nMaybe the time can be adaptive (based on `second_on_modern_computer()`?) like the time for `--warn-long` is.",
    "created_at": "2021-12-08T13:57:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657526",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:8'></a>
Replying to [mjo](#comment%3A5):
> **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c3b012418a22a06dc2a300c33d17009b4ddffde4">c3b0124</a></td><td><code>Trac #32973: increase the default test timeout to ten minutes.</code></td></tr></table>


LGTM, although I should mention that I have a box where `sage --tp 32 --all` takes < 4m wall time so a rogue test taking 10 minutes to time out will double the wait :-)

Maybe the time can be adaptive (based on `second_on_modern_computer()`?) like the time for `--warn-long` is.



---

archive/issue_comments_657527.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [tornaria](#comment%3A7):\n> \n> On my desktop is set to ~ 36s (it varies a little bit).\n> \n\n\nThere is some voodoo that happens in `sage/doctest/control.py` to determine that value. Currently, if your machine has stored timing information from previous test runs, and if not too many of those tests failed, then sixty times `second_on_modern_computer()` is used. But even that number is based on a quad core i7 from 2014. And if you don't have timing information, or you have too many test failures, it uses no `--warn-long` value at all.\n\nMy problem is that I usually have too many test failures for it to use the stored timings (testing development branches and package upgrades all the time), so it gives me no `--warn-long` at all. I've tried to fix this in #32981, but without `second_on_modern_computer()`, I'm really just guessing at the limit. A CPU-time limit would be a lot easier, but normal users won't know WTF that is.\n\n> \n> It might be useful if:\n> \n> c.  Even if test is run with `--long`, the doctests that are NOT labeled long still emit a warning if they take more time than the warn_long time.\n> \n\n\nI think this one already happens? The other two are good ideas, I opened #32995 for those.",
    "created_at": "2021-12-08T14:26:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657527",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:9'></a>
Replying to [tornaria](#comment%3A7):
> 
> On my desktop is set to ~ 36s (it varies a little bit).
> 


There is some voodoo that happens in `sage/doctest/control.py` to determine that value. Currently, if your machine has stored timing information from previous test runs, and if not too many of those tests failed, then sixty times `second_on_modern_computer()` is used. But even that number is based on a quad core i7 from 2014. And if you don't have timing information, or you have too many test failures, it uses no `--warn-long` value at all.

My problem is that I usually have too many test failures for it to use the stored timings (testing development branches and package upgrades all the time), so it gives me no `--warn-long` at all. I've tried to fix this in #32981, but without `second_on_modern_computer()`, I'm really just guessing at the limit. A CPU-time limit would be a lot easier, but normal users won't know WTF that is.

> 
> It might be useful if:
> 
> c.  Even if test is run with `--long`, the doctests that are NOT labeled long still emit a warning if they take more time than the warn_long time.
> 


I think this one already happens? The other two are good ideas, I opened #32995 for those.



---

archive/issue_comments_657528.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [tornaria](#comment%3A8):\n> Replying to [mjo](#comment%3A5):\n> > **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c3b012418a22a06dc2a300c33d17009b4ddffde4\">c3b0124</a></td><td><code>Trac #32973: increase the default test timeout to ten minutes.</code></td></tr></table>\n\n> \n> LGTM, although I should mention that I have a box where `sage --tp 32 --all` takes < 4m wall time so a rogue test taking 10 minutes to time out will double the wait :-)\n> \n> Maybe the time can be adaptive (based on `second_on_modern_computer()`?) like the time for `--warn-long` is.\n\n\nWe would still need a fallback if the timing information isn't usable -- if `second_on_modern_computer()` throws an error. In this case we use this limit for its intended purpose so infrequently that I don't think it's worth the extra trouble; we can just use the fallback value and skip the CPU timing heuristic.\n\nI'm sure it happened once but I don't recall any instances where someone, accidentally or otherwise, uploaded a branch with dangerous code and sent it to the patchbots.",
    "created_at": "2021-12-08T14:33:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657528",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:10'></a>
Replying to [tornaria](#comment%3A8):
> Replying to [mjo](#comment%3A5):
> > **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c3b012418a22a06dc2a300c33d17009b4ddffde4">c3b0124</a></td><td><code>Trac #32973: increase the default test timeout to ten minutes.</code></td></tr></table>

> 
> LGTM, although I should mention that I have a box where `sage --tp 32 --all` takes < 4m wall time so a rogue test taking 10 minutes to time out will double the wait :-)
> 
> Maybe the time can be adaptive (based on `second_on_modern_computer()`?) like the time for `--warn-long` is.


We would still need a fallback if the timing information isn't usable -- if `second_on_modern_computer()` throws an error. In this case we use this limit for its intended purpose so infrequently that I don't think it's worth the extra trouble; we can just use the fallback value and skip the CPU timing heuristic.

I'm sure it happened once but I don't recall any instances where someone, accidentally or otherwise, uploaded a branch with dangerous code and sent it to the patchbots.



---

archive/issue_comments_657529.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [mjo](#comment%3A9):\n> Replying to [tornaria](#comment%3A7):\n> > \n> > On my desktop is set to ~ 36s (it varies a little bit).\n> > \n\n> \n> There is some voodoo that happens in `sage/doctest/control.py` to determine that value. Currently, if your machine has stored timing information from previous test runs, and if not too many of those tests failed, then sixty times `second_on_modern_computer()` is used. But even that number is based on a quad core i7 from 2014. And if you don't have timing information, or you have too many test failures, it uses no `--warn-long` value at all.\n\n\nAha! That's it. I run tests on a clean chroot with a just built sagemath. Hence the warn_long time defaults to infinity which is bad. Can we make the default to a sane value? Even 60s would be small enough to catch #32964 on a fast machine but maybe it should be smaller.\n\nIt's kind of weird that doctesting needs `second_on_modern_computer()` but the latter needs doctesting. I like reproducible builds so I try to always build and run on a clean chroot.\n\n> My problem is that I usually have too many test failures for it to use the stored timings (testing development branches and package upgrades all the time), so it gives me no `--warn-long` at all. I've tried to fix this in #32981, but without `second_on_modern_computer()`, I'm really just guessing at the limit. A CPU-time limit would be a lot easier, but normal users won't know WTF that is.\n\n\nThere ought to be a simple way to get a good enough approximation to second_on_modern_computer() that is usable when stats have not been collected. This is just a timeout not for benchmarks so anything approximate enough that gives a reasonable small value on a fast computer while still allowing enough time on slower computers would be good. Then both warn_long and the per-file timeout can be multiple of that so both fast computers and slow computers are happy. And it can still be \"more precise\" when doctest timings are available. I mean: just bogomips may be good enough for this purpose (i.e. better than infinity or constant).\n\n> > c.  Even if test is run with `--long`, the doctests that are NOT labeled long still emit a warning if they take more time than the warn_long time.\n  \n> I think this one already happens? The other two are good ideas, I opened #32995 for those.\n\nI didn't check so it may be true.",
    "created_at": "2021-12-08T15:05:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657529",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:11'></a>
Replying to [mjo](#comment%3A9):
> Replying to [tornaria](#comment%3A7):
> > 
> > On my desktop is set to ~ 36s (it varies a little bit).
> > 

> 
> There is some voodoo that happens in `sage/doctest/control.py` to determine that value. Currently, if your machine has stored timing information from previous test runs, and if not too many of those tests failed, then sixty times `second_on_modern_computer()` is used. But even that number is based on a quad core i7 from 2014. And if you don't have timing information, or you have too many test failures, it uses no `--warn-long` value at all.


Aha! That's it. I run tests on a clean chroot with a just built sagemath. Hence the warn_long time defaults to infinity which is bad. Can we make the default to a sane value? Even 60s would be small enough to catch #32964 on a fast machine but maybe it should be smaller.

It's kind of weird that doctesting needs `second_on_modern_computer()` but the latter needs doctesting. I like reproducible builds so I try to always build and run on a clean chroot.

> My problem is that I usually have too many test failures for it to use the stored timings (testing development branches and package upgrades all the time), so it gives me no `--warn-long` at all. I've tried to fix this in #32981, but without `second_on_modern_computer()`, I'm really just guessing at the limit. A CPU-time limit would be a lot easier, but normal users won't know WTF that is.


There ought to be a simple way to get a good enough approximation to second_on_modern_computer() that is usable when stats have not been collected. This is just a timeout not for benchmarks so anything approximate enough that gives a reasonable small value on a fast computer while still allowing enough time on slower computers would be good. Then both warn_long and the per-file timeout can be multiple of that so both fast computers and slow computers are happy. And it can still be "more precise" when doctest timings are available. I mean: just bogomips may be good enough for this purpose (i.e. better than infinity or constant).

> > c.  Even if test is run with `--long`, the doctests that are NOT labeled long still emit a warning if they take more time than the warn_long time.
  
> I think this one already happens? The other two are good ideas, I opened #32995 for those.

I didn't check so it may be true.



---

archive/issue_comments_657530.json:
```json
{
    "body": "<a id='comment:12'></a>\nTL;DR the effective default for `second_on_modern_computer()` is\n- infinity (for warn_long)\n- constant (for timeout)\nI propose:\n- change all the `RuntimeError`s in `second_on_omodern_computer()` by something nonconstant (e.g. a multiple of 1/bogomips)\n- set the default test timeout as a multiple of `second_on_modern_computer()`",
    "created_at": "2021-12-08T15:13:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657530",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:12'></a>
TL;DR the effective default for `second_on_modern_computer()` is
- infinity (for warn_long)
- constant (for timeout)
I propose:
- change all the `RuntimeError`s in `second_on_omodern_computer()` by something nonconstant (e.g. a multiple of 1/bogomips)
- set the default test timeout as a multiple of `second_on_modern_computer()`



---

archive/issue_comments_657531.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [tornaria](#comment%3A12):\n> TL;DR the effective default for `second_on_modern_computer()` is\n> - infinity (for warn_long)\n> - constant (for timeout)\n> I propose:\n> - change all the `RuntimeError`s in `second_on_omodern_computer()` by something nonconstant (e.g. a multiple of 1/bogomips)\n> - set the default test timeout as a multiple of `second_on_modern_computer()`\n\n\nThis is good solution, but the devil is in the details. BogoMIPS won't be available on Windows, for example. What else can we use?\n\nThe whole thing is really a mess: when you allow sage to choose your `--warn-long` value, it's essentially trying to use `second_on_modern_computer()` to turn the wall-time default into a meaningful CPU-time value. But why does `--warn-long` take a wall-time measurement in the first place? Users may not know about CPU time... but I don't really see how specifying a wall-time is useful: it has to be converted into CPU time to work on other machines.\n\nThe `--timeout` value, on the other hand, has to be wall-time, because the doctest runner looks at the wall time to see if the process should be killed yet. Ugh. But at least no harm is done here if we set the value too high.",
    "created_at": "2021-12-08T17:07:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657531",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:13'></a>
Replying to [tornaria](#comment%3A12):
> TL;DR the effective default for `second_on_modern_computer()` is
> - infinity (for warn_long)
> - constant (for timeout)
> I propose:
> - change all the `RuntimeError`s in `second_on_omodern_computer()` by something nonconstant (e.g. a multiple of 1/bogomips)
> - set the default test timeout as a multiple of `second_on_modern_computer()`


This is good solution, but the devil is in the details. BogoMIPS won't be available on Windows, for example. What else can we use?

The whole thing is really a mess: when you allow sage to choose your `--warn-long` value, it's essentially trying to use `second_on_modern_computer()` to turn the wall-time default into a meaningful CPU-time value. But why does `--warn-long` take a wall-time measurement in the first place? Users may not know about CPU time... but I don't really see how specifying a wall-time is useful: it has to be converted into CPU time to work on other machines.

The `--timeout` value, on the other hand, has to be wall-time, because the doctest runner looks at the wall time to see if the process should be killed yet. Ugh. But at least no harm is done here if we set the value too high.



---

archive/issue_comments_657532.json:
```json
{
    "body": "<a id='comment:14'></a>\nI've switched `--warn-long` to CPU time in #32981. That should nicely fix half of the mess, leaving only the question of how to use `second_on_modern_computer()` to adjust the timeout.",
    "created_at": "2021-12-08T21:12:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657532",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:14'></a>
I've switched `--warn-long` to CPU time in #32981. That should nicely fix half of the mess, leaving only the question of how to use `second_on_modern_computer()` to adjust the timeout.



---

archive/issue_comments_657533.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [mjo](#comment%3A13):\n> Replying to [tornaria](#comment%3A12):\n> >  - change all the `RuntimeError`s in `second_on_omodern_computer()` by something nonconstant (e.g. a multiple of 1/bogomips)\n\n\n> This is good solution, but the devil is in the details. BogoMIPS won't be available on Windows, for example. What else can we use?\n\n\nI meant any stupid benchmark, whatever it is I don't think it's very important. This is just so the default timeout can be reasonably small on fast cpus while being large enough on your slow computer. First silly thing that I could think of:\n\n```\ndef secs_approx():\n  def _work():\n    import time\n    start = time.process_time()\n    p = 2**16+1\n    a = 1\n    for i in range(1,p):\n        a = a * i % p\n    assert a+1 == p\n    return time.process_time() - start\n  return round(100 * min((_work() for i in range(5))), 2)\n\nprint(\"seconds_on_modern_computer approximation =\", secs_approx())\n```\n\nThis gives me:\n- 1.43 on a Xeon E5520 @ 2.27GHz (nehalem)\n- 0.81 on a i7-3930K @ 3.20GHz (sandy bridge e)\n- 0.66 on a Xeon Gold 6240 @ 2.60GHz (cascade lake)\n- 0.64 on a i7-9700 @ 3.00GHz (coffee lake)\n\nWhat do you get? Does it look like a reasonable approximation to `seconds_on_modern_computer()`?\n\nWould K * secs_approx() be a reasonable timeout? I'm guessing your slow cpu (core 2?) will give more than 2 so K = 300 or less should give you more than 10 minutes while giving 3 minutes or less on recent cpus.\n\n> The whole thing is really a mess: when you allow sage to choose your `--warn-long` value, it's essentially trying to use `second_on_modern_computer()` to turn the wall-time default into a meaningful CPU-time value.\n\n\nI fail to see how this is a wall vs cpu time issue. I agree 100% on your switch to cputime, but this is orthogonal: different cpus can do different amounts of work in the same cpu time.\n\nThe stupid benchmark above is trying to do a \"fixed amount of work\" (whatever that means) and measuring the cputime taken gives a rough conversion factor between cpu time and work.\n\n> The `--timeout` value, on the other hand, has to be wall-time, because the doctest runner looks at the wall time to see if the process should be killed yet. Ugh. But at least no harm is done here if we set the value too high.\n\n\nFair enough, that's ok on the assumption that each doctest runs in a single thread. AFAIK the doctest runner parallelizes by running multiple independent doctests in parallel and OMP_NUM_THREADS is set to 1 (or 2?). It's still useful to have a reasonable approximate conversion factor as above that depends on the cpu (not on number of threads) so the timeout on a core 2 is still 10 minutes wall time but the timeout on a coffe lake is 2-3 minutes at most.\n\nNOTE: my suggestion above is a REALLY dumb proxy for seconds_on_modern_computer(). We could keep the factor calculated using doctest stats if available. OTOH: this is also broken since the doctest stats are stored in $HOME/.sage without hostname; my $HOME is shared between my nehalem and my coffee lake and the doctest times have a factor of 2 between them so using my stupid benchmark might be better in some cases (I do like to build on coffee lake then test on nehalem so I know if there are illegal instructions).\n\nIt might be better to do it in cython (with a larger value of p) to get a more meaningful value (i.e. closer to what sage actually does), but I bet this is already good enough.",
    "created_at": "2021-12-09T01:53:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657533",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:15'></a>
Replying to [mjo](#comment%3A13):
> Replying to [tornaria](#comment%3A12):
> >  - change all the `RuntimeError`s in `second_on_omodern_computer()` by something nonconstant (e.g. a multiple of 1/bogomips)


> This is good solution, but the devil is in the details. BogoMIPS won't be available on Windows, for example. What else can we use?


I meant any stupid benchmark, whatever it is I don't think it's very important. This is just so the default timeout can be reasonably small on fast cpus while being large enough on your slow computer. First silly thing that I could think of:

```
def secs_approx():
  def _work():
    import time
    start = time.process_time()
    p = 2**16+1
    a = 1
    for i in range(1,p):
        a = a * i % p
    assert a+1 == p
    return time.process_time() - start
  return round(100 * min((_work() for i in range(5))), 2)

print("seconds_on_modern_computer approximation =", secs_approx())
```

This gives me:
- 1.43 on a Xeon E5520 @ 2.27GHz (nehalem)
- 0.81 on a i7-3930K @ 3.20GHz (sandy bridge e)
- 0.66 on a Xeon Gold 6240 @ 2.60GHz (cascade lake)
- 0.64 on a i7-9700 @ 3.00GHz (coffee lake)

What do you get? Does it look like a reasonable approximation to `seconds_on_modern_computer()`?

Would K * secs_approx() be a reasonable timeout? I'm guessing your slow cpu (core 2?) will give more than 2 so K = 300 or less should give you more than 10 minutes while giving 3 minutes or less on recent cpus.

> The whole thing is really a mess: when you allow sage to choose your `--warn-long` value, it's essentially trying to use `second_on_modern_computer()` to turn the wall-time default into a meaningful CPU-time value.


I fail to see how this is a wall vs cpu time issue. I agree 100% on your switch to cputime, but this is orthogonal: different cpus can do different amounts of work in the same cpu time.

The stupid benchmark above is trying to do a "fixed amount of work" (whatever that means) and measuring the cputime taken gives a rough conversion factor between cpu time and work.

> The `--timeout` value, on the other hand, has to be wall-time, because the doctest runner looks at the wall time to see if the process should be killed yet. Ugh. But at least no harm is done here if we set the value too high.


Fair enough, that's ok on the assumption that each doctest runs in a single thread. AFAIK the doctest runner parallelizes by running multiple independent doctests in parallel and OMP_NUM_THREADS is set to 1 (or 2?). It's still useful to have a reasonable approximate conversion factor as above that depends on the cpu (not on number of threads) so the timeout on a core 2 is still 10 minutes wall time but the timeout on a coffe lake is 2-3 minutes at most.

NOTE: my suggestion above is a REALLY dumb proxy for seconds_on_modern_computer(). We could keep the factor calculated using doctest stats if available. OTOH: this is also broken since the doctest stats are stored in $HOME/.sage without hostname; my $HOME is shared between my nehalem and my coffee lake and the doctest times have a factor of 2 between them so using my stupid benchmark might be better in some cases (I do like to build on coffee lake then test on nehalem so I know if there are illegal instructions).

It might be better to do it in cython (with a larger value of p) to get a more meaningful value (i.e. closer to what sage actually does), but I bet this is already good enough.



---

archive/issue_comments_657534.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [mjo](#comment%3A9):\n> > c.  Even if test is run with `--long`, the doctests that are NOT labeled long still emit a warning if they take more time than the warn_long time.\n> > \n  \n> \n> I think this one already happens? The other two are good ideas, I opened #32995 for those.\n\n\nAfter your patch in #32981, doctests warn if > 10s when not using `--long` but they only warn if > 60s when using `--long`. Hence you will still miss doctests taking 30s if you only run using `--long`.\n\nI would expect that \"non-long\" doctests warn at the same default time regardless of `--long`. Arguably, there could be a different time value to trigger warnings on \"long\" doctests.\n\nMaybe:\n- keep `warn_long` configurable as now and default to 10s as in your patch, and apply to non-long doctests regardless of `--long`\n- for long doctests: either don't warn (they are labeled long, after all) or else have a hardcoded value at 60s (there could be another configuration option, but isn't that overdoing it?).\n\nAlso IMHO all default values should be multiples of `seconds_on_modern_computer()`.",
    "created_at": "2021-12-09T02:07:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657534",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:16'></a>
Replying to [mjo](#comment%3A9):
> > c.  Even if test is run with `--long`, the doctests that are NOT labeled long still emit a warning if they take more time than the warn_long time.
> > 
  
> 
> I think this one already happens? The other two are good ideas, I opened #32995 for those.


After your patch in #32981, doctests warn if > 10s when not using `--long` but they only warn if > 60s when using `--long`. Hence you will still miss doctests taking 30s if you only run using `--long`.

I would expect that "non-long" doctests warn at the same default time regardless of `--long`. Arguably, there could be a different time value to trigger warnings on "long" doctests.

Maybe:
- keep `warn_long` configurable as now and default to 10s as in your patch, and apply to non-long doctests regardless of `--long`
- for long doctests: either don't warn (they are labeled long, after all) or else have a hardcoded value at 60s (there could be another configuration option, but isn't that overdoing it?).

Also IMHO all default values should be multiples of `seconds_on_modern_computer()`.



---

archive/issue_comments_657535.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [tornaria](#comment%3A15):\n> \n> I meant any stupid benchmark, whatever it is I don't think it's very important. This is just so the default timeout can be reasonably small on fast cpus while being large enough on your slow computer. First silly thing that I could think of:\n\n>\n> ...\n> \n> This gives me:\n>  ...\n> \n> What do you get? Does it look like a reasonable approximation to `seconds_on_modern_computer()`?\n\n\nI get between 1.4 and 1.5 on my desktop (the slower of the two).\n\n \n> Would K * secs_approx() be a reasonable timeout? I'm guessing your slow cpu (core 2?) will give more than 2 so K = 300 or less should give you more than 10 minutes while giving 3 minutes or less on recent cpus.\n\n\nDisclaimer: I still think this is overkill for the timeout value, which is intentionally used maybe once a decade. But yes, in general, I think the idea of a fixed amount of work (rather than a fixed amount of time) is preferable.\n\n\n> > The whole thing is really a mess: when you allow sage to choose your `--warn-long` value, it's essentially trying to use `second_on_modern_computer()` to turn the wall-time default into a meaningful CPU-time value.\n\n> \n> I fail to see how this is a wall vs cpu time issue. I agree 100% on your switch to cputime, but this is orthogonal: different cpus can do different amounts of work in the same cpu time.\n\n\nI know, but wall time is simply the worst. I can mess up the wall time by e.g. running the computation at 2am when daylight savings time switches on/off. CPU time is still flawed, but is always going to be a better metric than wall-time.\n\n> The stupid benchmark above is trying to do a \"fixed amount of work\" (whatever that means) and measuring the cputime taken gives a rough conversion factor between cpu time and work.\n\n\nThere are some things we'll never be able to account for. New versions of python may change how much work is involved in the \"fixed\" amount of work. Many sage doctests depend on Cython or C libraries whose efficiency depends on CFLAGS, the linker used, etc. Python itself (being written in C) is subject to the same uncertainties.\n\nStill, I think if we're careful, we can do a lot better than the existing `second_on_modern_computer()`.",
    "created_at": "2021-12-14T16:14:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657535",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:17'></a>
Replying to [tornaria](#comment%3A15):
> 
> I meant any stupid benchmark, whatever it is I don't think it's very important. This is just so the default timeout can be reasonably small on fast cpus while being large enough on your slow computer. First silly thing that I could think of:

>
> ...
> 
> This gives me:
>  ...
> 
> What do you get? Does it look like a reasonable approximation to `seconds_on_modern_computer()`?


I get between 1.4 and 1.5 on my desktop (the slower of the two).

 
> Would K * secs_approx() be a reasonable timeout? I'm guessing your slow cpu (core 2?) will give more than 2 so K = 300 or less should give you more than 10 minutes while giving 3 minutes or less on recent cpus.


Disclaimer: I still think this is overkill for the timeout value, which is intentionally used maybe once a decade. But yes, in general, I think the idea of a fixed amount of work (rather than a fixed amount of time) is preferable.


> > The whole thing is really a mess: when you allow sage to choose your `--warn-long` value, it's essentially trying to use `second_on_modern_computer()` to turn the wall-time default into a meaningful CPU-time value.

> 
> I fail to see how this is a wall vs cpu time issue. I agree 100% on your switch to cputime, but this is orthogonal: different cpus can do different amounts of work in the same cpu time.


I know, but wall time is simply the worst. I can mess up the wall time by e.g. running the computation at 2am when daylight savings time switches on/off. CPU time is still flawed, but is always going to be a better metric than wall-time.

> The stupid benchmark above is trying to do a "fixed amount of work" (whatever that means) and measuring the cputime taken gives a rough conversion factor between cpu time and work.


There are some things we'll never be able to account for. New versions of python may change how much work is involved in the "fixed" amount of work. Many sage doctests depend on Cython or C libraries whose efficiency depends on CFLAGS, the linker used, etc. Python itself (being written in C) is subject to the same uncertainties.

Still, I think if we're careful, we can do a lot better than the existing `second_on_modern_computer()`.



---

archive/issue_comments_657536.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [tornaria](#comment%3A16):\n> \n> Maybe:\n> - keep `warn_long` configurable as now and default to 10s as in your patch, and apply to non-long doctests regardless of `--long`\n> - for long doctests: either don't warn (they are labeled long, after all) or else have a hardcoded value at 60s (there could be another configuration option, but isn't that overdoing it?).\n> \n\n\nI think a separate option is the best way to do it cleanly. We'll probably wind up with less code that way than if we add a bunch of special cases to guess at what should happen. (These options are for developers only, so I'm not too worried about overcomplicating the UI.) I added another item to #32995 for this.\n\n> Also IMHO all default values should be multiples of `seconds_on_modern_computer()`.\n\n\nYes, this makes more sense for `--warn-long` than it does for `--timeout`. I've opened #33022 specifically for it.\n\nI propose the following:\n\n1. Merge this and #32981 to get things working again, if non-optimally.\n2. In #33022, we can replace `second_on_modern_computer()` with something that works better, and reintroduce it after it has been tested on enough platforms (basically I just want to see what numbers it comes up with on the GH actions.) Having done #32981 first, the multiplier will affect the CPU time and not wall time -- as it should be.\n3. Use #32995 for the separate long and non-long limits, or whatever else we decide to do to solve that problem.",
    "created_at": "2021-12-14T16:33:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32973#issuecomment-657536",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:18'></a>
Replying to [tornaria](#comment%3A16):
> 
> Maybe:
> - keep `warn_long` configurable as now and default to 10s as in your patch, and apply to non-long doctests regardless of `--long`
> - for long doctests: either don't warn (they are labeled long, after all) or else have a hardcoded value at 60s (there could be another configuration option, but isn't that overdoing it?).
> 


I think a separate option is the best way to do it cleanly. We'll probably wind up with less code that way than if we add a bunch of special cases to guess at what should happen. (These options are for developers only, so I'm not too worried about overcomplicating the UI.) I added another item to #32995 for this.

> Also IMHO all default values should be multiples of `seconds_on_modern_computer()`.


Yes, this makes more sense for `--warn-long` than it does for `--timeout`. I've opened #33022 specifically for it.

I propose the following:

1. Merge this and #32981 to get things working again, if non-optimally.
2. In #33022, we can replace `second_on_modern_computer()` with something that works better, and reintroduce it after it has been tested on enough platforms (basically I just want to see what numbers it comes up with on the GH actions.) Having done #32981 first, the multiplier will affect the CPU time and not wall time -- as it should be.
3. Use #32995 for the separate long and non-long limits, or whatever else we decide to do to solve that problem.



---

archive/issue_events_097997.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-10T00:37:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32973#event-97997"
}
```



---

archive/issue_events_097998.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32973#event-97998"
}
```



---

archive/issue_events_097999.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32973#event-97999"
}
```



---

archive/issue_events_098000.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32973#event-98000"
}
```



---

archive/issue_events_098001.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32973",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32973#event-98001"
}
```
