# Issue 32490: multiplication_by_m_isogeny is only correct up to automorphism

archive/issues_032253.json:
```json
{
    "body": "This is wrong:\n\n```sage\nsage: E = EllipticCurve(QQbar, [1,0])\nsage: E.multiplication_by_m_isogeny(1).rational_maps()\n(x, -y)\n```\n\n```sage\nsage: E = EllipticCurve(GF(127), [1,0])\nsage: P = E.random_point()\nsage: E.multiplication_by_m_isogeny(5)(P)\n(15 : 56 : 1)\nsage: 5*P\n(15 : 71 : 1)\nsage: -5*P\n(15 : 56 : 1)\nsage: E.multiplication_by_m(5) == (-E.multiplication_by_m_isogeny(5)).rational_maps()\nTrue\n```\n\nIt isn't *consistently* wrong:\n\n```sage\nsage: E = EllipticCurve(QQ, [1,0])\nsage: E.multiplication_by_m_isogeny(1).rational_maps()\n(x, y)\n```\n\n---\n\nThe trouble is that the method first constructs **an** isogeny with the correct kernel and codomain, then sets the precomputed rational maps. However, the isomorphism to the prescribed codomain is not unique, and picking the wrong one means the resulting isogeny is off by an automorphism\u2009\u2014\u2009most commonly `[-1]`.\n\nThe patch is not pretty, but it seems to fix the issue for now and shouldn't cause any significant slowdowns.\nOnce (if) #32388 gets in, we should probably instead use an `EllipticCurveHom` subclass specifically for scalar multiplications that imitates a normal isogeny but with different internals. I do have a draft of this ready and it's not only much cleaner, but also resolves part of #8014.\n\nCC:  @JohnCremona @defeo\n\nBranch/Commit: ead071d9b09047a6f0d867ed9be21b85d0e9b854\n\nReviewer: Travis Scrimshaw\n\nAuthor: Lorenz Panny\n\nDependencies: #32388\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32490\n\n",
    "closed_at": "2021-10-23T22:58:33Z",
    "created_at": "2021-09-08T03:42:27Z",
    "labels": [
        "component: elliptic curves",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "multiplication_by_m_isogeny is only correct up to automorphism",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32490",
    "user": "https://github.com/yyyyx4"
}
```
This is wrong:

```sage
sage: E = EllipticCurve(QQbar, [1,0])
sage: E.multiplication_by_m_isogeny(1).rational_maps()
(x, -y)
```

```sage
sage: E = EllipticCurve(GF(127), [1,0])
sage: P = E.random_point()
sage: E.multiplication_by_m_isogeny(5)(P)
(15 : 56 : 1)
sage: 5*P
(15 : 71 : 1)
sage: -5*P
(15 : 56 : 1)
sage: E.multiplication_by_m(5) == (-E.multiplication_by_m_isogeny(5)).rational_maps()
True
```

It isn't *consistently* wrong:

```sage
sage: E = EllipticCurve(QQ, [1,0])
sage: E.multiplication_by_m_isogeny(1).rational_maps()
(x, y)
```

---

The trouble is that the method first constructs **an** isogeny with the correct kernel and codomain, then sets the precomputed rational maps. However, the isomorphism to the prescribed codomain is not unique, and picking the wrong one means the resulting isogeny is off by an automorphism — most commonly `[-1]`.

The patch is not pretty, but it seems to fix the issue for now and shouldn't cause any significant slowdowns.
Once (if) #32388 gets in, we should probably instead use an `EllipticCurveHom` subclass specifically for scalar multiplications that imitates a normal isogeny but with different internals. I do have a draft of this ready and it's not only much cleaner, but also resolves part of #8014.

CC:  @JohnCremona @defeo

Branch/Commit: ead071d9b09047a6f0d867ed9be21b85d0e9b854

Reviewer: Travis Scrimshaw

Author: Lorenz Panny

Dependencies: #32388

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/32490





---

archive/issue_comments_459987.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-09-08T09:50:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32490#issuecomment-459987",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_459988.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2021-09-08T09:50:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32490#issuecomment-459988",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_459989.json:
```json
{
    "body": "<a id='comment:3'></a>Based on your description, it seems like the thing to do would be to make #32388 a dependency since it generally seems to be better. You can then use this ticket as motivation for #32388 if that is necessary.",
    "created_at": "2021-09-13T01:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32490#issuecomment-459989",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:3'></a>Based on your description, it seems like the thing to do would be to make #32388 a dependency since it generally seems to be better. You can then use this ticket as motivation for #32388 if that is necessary.



---

archive/issue_comments_459990.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:3 tscrim]:\n> Based on your description, it seems like the thing to do would be to make #32388 a dependency since it generally seems to be better.\n\n\nI was worried that #32388 might take a while to get in, which could cause this (in principle, totally unrelated) bug to remain unfixed for no good reason if there was a dependency. Hence why I figured the best way to proceed would be to first apply this minimal bugfix and pursue the longer-term solution based on `EllipticCurveHom` later.",
    "created_at": "2021-09-13T04:44:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32490#issuecomment-459990",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:4'></a>Replying to [comment:3 tscrim]:
> Based on your description, it seems like the thing to do would be to make #32388 a dependency since it generally seems to be better.


I was worried that #32388 might take a while to get in, which could cause this (in principle, totally unrelated) bug to remain unfixed for no good reason if there was a dependency. Hence why I figured the best way to proceed would be to first apply this minimal bugfix and pursue the longer-term solution based on `EllipticCurveHom` later.



---

archive/issue_comments_459991.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-13T04:58:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32490#issuecomment-459991",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_459992.json:
```json
{
    "body": "<a id='comment:5'></a>Then let's get the bug-fix in.",
    "created_at": "2021-09-13T04:58:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32490#issuecomment-459992",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>Then let's get the bug-fix in.



---

archive/issue_comments_459993.json:
```json
{
    "body": "<a id='comment:6'></a>Now that #32388 is also green, this will almost certainly cause test failures when both are merged (since this currently uses a method deprecated in #32388). What's the recommended way of dealing with this? Should I rebase this onto #32388 using the new syntax and add a dependency after all?",
    "created_at": "2021-09-17T02:59:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32490#issuecomment-459993",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:6'></a>Now that #32388 is also green, this will almost certainly cause test failures when both are merged (since this currently uses a method deprecated in #32388). What's the recommended way of dealing with this? Should I rebase this onto #32388 using the new syntax and add a dependency after all?



---

archive/issue_comments_459994.json:
```json
{
    "body": "<a id='comment:7'></a>Sounds like you should make this depend on #32388.",
    "created_at": "2021-09-17T06:14:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32490#issuecomment-459994",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>Sounds like you should make this depend on #32388.



---

archive/issue_comments_459995.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. Last 10 new commits:",
    "created_at": "2021-09-17T08:52:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32490#issuecomment-459995",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. Last 10 new commits:



---

archive/issue_comments_459996.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2021-09-17T08:52:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32490#issuecomment-459996",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_459997.json:
```json
{
    "body": "<a id='comment:9'></a>Rebased and adapted to the new syntax. (Only the last commit is relevant here; the rest are from #32388.)",
    "created_at": "2021-09-17T08:56:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32490#issuecomment-459997",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:9'></a>Rebased and adapted to the new syntax. (Only the last commit is relevant here; the rest are from #32388.)



---

archive/issue_comments_459998.json:
```json
{
    "body": "<a id='comment:10'></a>LGTM. Thanks.",
    "created_at": "2021-09-21T04:32:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32490#issuecomment-459998",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:10'></a>LGTM. Thanks.



---

archive/issue_comments_459999.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-21T04:32:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32490#issuecomment-459999",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_460000.json:
```json
{
    "body": "<a id='comment:11'></a>Bumping priority since this bug can lead to mathematical errors.",
    "created_at": "2021-10-23T03:39:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32490#issuecomment-460000",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:11'></a>Bumping priority since this bug can lead to mathematical errors.



---

archive/issue_comments_460001.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-10-23T22:58:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32490#issuecomment-460001",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_086187.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-10-23T22:58:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32490",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32490#event-86187"
}
```
