# Issue 32095: DiFUB algorithm fails on some random graph

archive/issues_031858.json:
```json
{
    "assignees": [],
    "body": "\n```\nsage -t --long --random-seed=4 src/sage/graphs/digraph.py\n**********************************************************************\nFile \"src/sage/graphs/digraph.py\", line 2475, in sage.graphs.digraph.DiGraph.?\nFailed example:\n    d1 == d2\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n1 item had failures:\n   1 of 166 in sage.graphs.digraph.DiGraph.?\n    [530 tests, 1 failure, 1.70 s]\n```\n\n```\nsage: set_random_seed(4)                                                                                                                                                                                                                                                       \nsage: G = graphs.RandomGNP(40, 0.4).to_directed()                                                                                                                                                                                                                              \nsage: G.diameter()                                                                                                                                                                                                                                                             \n3\nsage: d1 = G.diameter(algorithm='DiFUB', by_weight=True)                                                                                                                                                                                                                       \nsage: d1                                                                                                                                                                                                                                                                       \n2.0\n```\n\nYet, `DiFUB` claims to be exact.\n\nKeywords: **graphs, diameter**\n\nBranch/Commit: **[1d25896](https://github.com/sagemath/sagetrac-mirror/commit/1d258966e84e3339245e31c0eb286f9cee6a6f35)**\n\nReviewer: **Jonathan Kliem**\n\nAuthor: **David Coudert**\n\nComponent: **graph theory**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/32095_\n\n",
    "closed_at": "2021-07-23T20:10:58Z",
    "created_at": "2021-07-01T18:54:00Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20graph%20theory",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "DiFUB algorithm fails on some random graph",
    "type": "issue",
    "updated_at": "2021-07-23T20:10:58Z",
    "url": "https://github.com/sagemath/sage/issues/32095",
    "user": "https://github.com/kliem"
}
```

```
sage -t --long --random-seed=4 src/sage/graphs/digraph.py
**********************************************************************
File "src/sage/graphs/digraph.py", line 2475, in sage.graphs.digraph.DiGraph.?
Failed example:
    d1 == d2
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of 166 in sage.graphs.digraph.DiGraph.?
    [530 tests, 1 failure, 1.70 s]
```

```
sage: set_random_seed(4)                                                                                                                                                                                                                                                       
sage: G = graphs.RandomGNP(40, 0.4).to_directed()                                                                                                                                                                                                                              
sage: G.diameter()                                                                                                                                                                                                                                                             
3
sage: d1 = G.diameter(algorithm='DiFUB', by_weight=True)                                                                                                                                                                                                                       
sage: d1                                                                                                                                                                                                                                                                       
2.0
```

Yet, `DiFUB` claims to be exact.

Keywords: **graphs, diameter**

Branch/Commit: **[1d25896](https://github.com/sagemath/sagetrac-mirror/commit/1d258966e84e3339245e31c0eb286f9cee6a6f35)**

Reviewer: **Jonathan Kliem**

Author: **David Coudert**

Component: **graph theory**

_Issue created by migration from https://trac.sagemath.org/ticket/32095_





---

archive/issue_events_442734.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-07-01T18:54:00Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-442734"
}
```



---

archive/issue_events_442735.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-07-01T18:54:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20graph%20theory",
    "label_color": "0000ff",
    "label_name": "c: graph theory",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-442735"
}
```



---

archive/issue_events_442736.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-07-01T18:54:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-442736"
}
```



---

archive/issue_events_442737.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-07-01T18:54:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-442737"
}
```



---

archive/issue_comments_517016.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\n`DiFUB` is an exact algorithm, and actually the default algorithm for unweighted digraphs is `DiFUB` as implemented in `distances_all_pairs.pyx`.\n\nApparently there is a bug in the implementation of `DiFUB` with boost (`base/boost_graph.pyx`). I will have a look.",
    "created_at": "2021-07-01T21:34:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-517016",
    "user": "https://github.com/dcoudert"
}
```

<div id="comment:1" align="right">comment:1</div>

`DiFUB` is an exact algorithm, and actually the default algorithm for unweighted digraphs is `DiFUB` as implemented in `distances_all_pairs.pyx`.

Apparently there is a bug in the implementation of `DiFUB` with boost (`base/boost_graph.pyx`). I will have a look.



---

archive/issue_events_442738.json:
```json
{
    "actor": "https://github.com/dcoudert",
    "created_at": "2021-07-03T09:30:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-442738"
}
```



---

archive/issue_comments_517017.json:
```json
{
    "body": "Branch: **[public/graphs/32095_fix_DiFUB_with_boost](https://github.com/sagemath/sagetrac-mirror/tree/public/graphs/32095_fix_DiFUB_with_boost)**",
    "created_at": "2021-07-03T09:30:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-517017",
    "user": "https://github.com/dcoudert"
}
```

Branch: **[public/graphs/32095_fix_DiFUB_with_boost](https://github.com/sagemath/sagetrac-mirror/tree/public/graphs/32095_fix_DiFUB_with_boost)**



---

archive/issue_comments_517018.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nit was an incorrect use of method `sorted`.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/89c210e1d8fc7bb83c4c2ae501774531e67df463\">89c210e</a></td><td><code>trac #32095: sorted is not inplace</code></td></tr></table>\n",
    "created_at": "2021-07-03T09:30:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-517018",
    "user": "https://github.com/dcoudert"
}
```

<div id="comment:2" align="right">comment:2</div>

it was an incorrect use of method `sorted`.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/89c210e1d8fc7bb83c4c2ae501774531e67df463">89c210e</a></td><td><code>trac #32095: sorted is not inplace</code></td></tr></table>




---

archive/issue_comments_517019.json:
```json
{
    "body": "Author: **David Coudert**",
    "created_at": "2021-07-03T09:30:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-517019",
    "user": "https://github.com/dcoudert"
}
```

Author: **David Coudert**



---

archive/issue_comments_517020.json:
```json
{
    "body": "Commit: **[89c210e](https://github.com/sagemath/sagetrac-mirror/commit/89c210e1d8fc7bb83c4c2ae501774531e67df463)**",
    "created_at": "2021-07-03T09:30:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-517020",
    "user": "https://github.com/dcoudert"
}
```

Commit: **[89c210e](https://github.com/sagemath/sagetrac-mirror/commit/89c210e1d8fc7bb83c4c2ae501774531e67df463)**



---

archive/issue_comments_517021.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nOk, this is good to go. Thanks for the quick fix. One needs to be carefull with setting `set_random_seed(4)`, but this is ok at the end of a test block. The next block will get the initial seed again.",
    "created_at": "2021-07-03T09:45:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-517021",
    "user": "https://github.com/kliem"
}
```

<div id="comment:3" align="right">comment:3</div>

Ok, this is good to go. Thanks for the quick fix. One needs to be carefull with setting `set_random_seed(4)`, but this is ok at the end of a test block. The next block will get the initial seed again.



---

archive/issue_events_442739.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-07-03T09:46:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-442739"
}
```



---

archive/issue_events_442740.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-07-03T09:46:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-442740"
}
```



---

archive/issue_comments_517022.json:
```json
{
    "body": "Reviewer: **Jonathan Kliem**",
    "created_at": "2021-07-03T09:46:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-517022",
    "user": "https://github.com/kliem"
}
```

Reviewer: **Jonathan Kliem**



---

archive/issue_comments_517023.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nIf you prefer, we can use the graph6 string.",
    "created_at": "2021-07-03T09:57:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-517023",
    "user": "https://github.com/dcoudert"
}
```

<div id="comment:5" align="right">comment:5</div>

If you prefer, we can use the graph6 string.



---

archive/issue_comments_517024.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nIt would be nice. At the moment things are stable and the next doctest is run with the correct seed. However, this doctest needs to be always the last (involving randomness) in this block.",
    "created_at": "2021-07-03T10:09:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-517024",
    "user": "https://github.com/kliem"
}
```

<div id="comment:6" align="right">comment:6</div>

It would be nice. At the moment things are stable and the next doctest is run with the correct seed. However, this doctest needs to be always the last (involving randomness) in this block.



---

archive/issue_comments_517025.json:
```json
{
    "body": "<div id=\"comment:7\"></div>\n\nBranch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1d258966e84e3339245e31c0eb286f9cee6a6f35\">1d25896</a></td><td><code>trac #32095: avoid using set_random_seed</code></td></tr></table>\n",
    "created_at": "2021-07-03T10:20:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-517025",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:7"></div>

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1d258966e84e3339245e31c0eb286f9cee6a6f35">1d25896</a></td><td><code>trac #32095: avoid using set_random_seed</code></td></tr></table>




---

archive/issue_comments_517026.json:
```json
{
    "body": "Changed commit from **[89c210e](https://github.com/sagemath/sagetrac-mirror/commit/89c210e1d8fc7bb83c4c2ae501774531e67df463)** to **[1d25896](https://github.com/sagemath/sagetrac-mirror/commit/1d258966e84e3339245e31c0eb286f9cee6a6f35)**",
    "created_at": "2021-07-03T10:20:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-517026",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[89c210e](https://github.com/sagemath/sagetrac-mirror/commit/89c210e1d8fc7bb83c4c2ae501774531e67df463)** to **[1d25896](https://github.com/sagemath/sagetrac-mirror/commit/1d258966e84e3339245e31c0eb286f9cee6a6f35)**



---

archive/issue_events_442741.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2021-07-03T10:20:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-442741"
}
```



---

archive/issue_events_442742.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2021-07-03T10:20:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-442742"
}
```



---

archive/issue_comments_517027.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nShould be better this way.",
    "created_at": "2021-07-03T10:21:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-517027",
    "user": "https://github.com/dcoudert"
}
```

<div id="comment:8" align="right">comment:8</div>

Should be better this way.



---

archive/issue_events_442743.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-07-03T11:01:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-442743"
}
```



---

archive/issue_events_442744.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-07-03T11:01:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-442744"
}
```



---

archive/issue_comments_517028.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nYes, that is better. It also fixes the graph in case that random graphs change at some point.",
    "created_at": "2021-07-03T11:01:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-517028",
    "user": "https://github.com/kliem"
}
```

<div id="comment:9" align="right">comment:9</div>

Yes, that is better. It also fixes the graph in case that random graphs change at some point.



---

archive/issue_events_442745.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-07-23T20:10:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-442745"
}
```



---

archive/issue_events_442746.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "4441acd8bd39711c2eff8dc379e505b3f52b000f",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-07-23T20:10:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-442746"
}
```



---

archive/issue_comments_517029.json:
```json
{
    "body": "Changed branch from **[public/graphs/32095_fix_DiFUB_with_boost](https://github.com/sagemath/sagetrac-mirror/tree/public/graphs/32095_fix_DiFUB_with_boost)** to **[1d25896](https://github.com/sagemath/sagetrac-mirror/commit/1d258966e84e3339245e31c0eb286f9cee6a6f35)**",
    "created_at": "2021-07-23T20:10:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-517029",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/graphs/32095_fix_DiFUB_with_boost](https://github.com/sagemath/sagetrac-mirror/tree/public/graphs/32095_fix_DiFUB_with_boost)** to **[1d25896](https://github.com/sagemath/sagetrac-mirror/commit/1d258966e84e3339245e31c0eb286f9cee6a6f35)**
