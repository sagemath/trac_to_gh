# Issue 32095: DiFUB algorithm fails on some random graph

archive/issues_031858.json:
```json
{
    "assignees": [],
    "body": "\n```\nsage -t --long --random-seed=4 src/sage/graphs/digraph.py\n**********************************************************************\nFile \"src/sage/graphs/digraph.py\", line 2475, in sage.graphs.digraph.DiGraph.?\nFailed example:\n    d1 == d2\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n1 item had failures:\n   1 of 166 in sage.graphs.digraph.DiGraph.?\n    [530 tests, 1 failure, 1.70 s]\n```\n\n```\nsage: set_random_seed(4)                                                                                                                                                                                                                                                       \nsage: G = graphs.RandomGNP(40, 0.4).to_directed()                                                                                                                                                                                                                              \nsage: G.diameter()                                                                                                                                                                                                                                                             \n3\nsage: d1 = G.diameter(algorithm='DiFUB', by_weight=True)                                                                                                                                                                                                                       \nsage: d1                                                                                                                                                                                                                                                                       \n2.0\n```\n\nYet, `DiFUB` claims to be exact.\n\nKeywords: **graphs, diameter**\n\nBranch/Commit: **[1d25896](https://github.com/sagemath/sagetrac-mirror/commit/1d258966e84e3339245e31c0eb286f9cee6a6f35)**\n\nReviewer: **Jonathan Kliem**\n\nAuthor: **David Coudert**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/32095_\n\n",
    "closed_at": "2021-07-23T20:10:58Z",
    "created_at": "2021-07-01T18:54:00Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20graph%20theory",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "DiFUB algorithm fails on some random graph",
    "type": "issue",
    "updated_at": "2021-07-23T20:10:58Z",
    "url": "https://github.com/sagemath/sage/issues/32095",
    "user": "https://github.com/kliem"
}
```

```
sage -t --long --random-seed=4 src/sage/graphs/digraph.py
**********************************************************************
File "src/sage/graphs/digraph.py", line 2475, in sage.graphs.digraph.DiGraph.?
Failed example:
    d1 == d2
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of 166 in sage.graphs.digraph.DiGraph.?
    [530 tests, 1 failure, 1.70 s]
```

```
sage: set_random_seed(4)                                                                                                                                                                                                                                                       
sage: G = graphs.RandomGNP(40, 0.4).to_directed()                                                                                                                                                                                                                              
sage: G.diameter()                                                                                                                                                                                                                                                             
3
sage: d1 = G.diameter(algorithm='DiFUB', by_weight=True)                                                                                                                                                                                                                       
sage: d1                                                                                                                                                                                                                                                                       
2.0
```

Yet, `DiFUB` claims to be exact.

Keywords: **graphs, diameter**

Branch/Commit: **[1d25896](https://github.com/sagemath/sagetrac-mirror/commit/1d258966e84e3339245e31c0eb286f9cee6a6f35)**

Reviewer: **Jonathan Kliem**

Author: **David Coudert**

_Issue created by migration from https://trac.sagemath.org/ticket/32095_





---

archive/issue_events_424448.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-07-01T18:54:00Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-424448"
}
```



---

archive/issue_events_424449.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-07-01T18:54:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20graph%20theory",
    "label_color": "0000ff",
    "label_name": "component: graph theory",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-424449"
}
```



---

archive/issue_events_424450.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-07-01T18:54:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-424450"
}
```



---

archive/issue_events_424451.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-07-01T18:54:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-424451"
}
```



---

archive/issue_comments_519942.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\n`DiFUB` is an exact algorithm, and actually the default algorithm for unweighted digraphs is `DiFUB` as implemented in `distances_all_pairs.pyx`.\n\nApparently there is a bug in the implementation of `DiFUB` with boost (`base/boost_graph.pyx`). I will have a look.",
    "created_at": "2021-07-01T21:34:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-519942",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:1'>Comment 1:</a>
`DiFUB` is an exact algorithm, and actually the default algorithm for unweighted digraphs is `DiFUB` as implemented in `distances_all_pairs.pyx`.

Apparently there is a bug in the implementation of `DiFUB` with boost (`base/boost_graph.pyx`). I will have a look.



---

archive/issue_events_424452.json:
```json
{
    "actor": "https://github.com/dcoudert",
    "created_at": "2021-07-03T09:30:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-424452"
}
```



---

archive/issue_comments_519943.json:
```json
{
    "body": "Branch: **[public/graphs/32095_fix_DiFUB_with_boost](https://github.com/sagemath/sagetrac-mirror/tree/public/graphs/32095_fix_DiFUB_with_boost)**",
    "created_at": "2021-07-03T09:30:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-519943",
    "user": "https://github.com/dcoudert"
}
```

Branch: **[public/graphs/32095_fix_DiFUB_with_boost](https://github.com/sagemath/sagetrac-mirror/tree/public/graphs/32095_fix_DiFUB_with_boost)**



---

archive/issue_comments_519944.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nit was an incorrect use of method `sorted`.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/89c210e1d8fc7bb83c4c2ae501774531e67df463\">89c210e</a></td><td><code>trac #32095: sorted is not inplace</code></td></tr></table>\n",
    "created_at": "2021-07-03T09:30:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-519944",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:2'>Comment 2:</a>
it was an incorrect use of method `sorted`.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/89c210e1d8fc7bb83c4c2ae501774531e67df463">89c210e</a></td><td><code>trac #32095: sorted is not inplace</code></td></tr></table>




---

archive/issue_comments_519945.json:
```json
{
    "body": "Author: **David Coudert**",
    "created_at": "2021-07-03T09:30:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-519945",
    "user": "https://github.com/dcoudert"
}
```

Author: **David Coudert**



---

archive/issue_comments_519946.json:
```json
{
    "body": "Commit: **[89c210e](https://github.com/sagemath/sagetrac-mirror/commit/89c210e1d8fc7bb83c4c2ae501774531e67df463)**",
    "created_at": "2021-07-03T09:30:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-519946",
    "user": "https://github.com/dcoudert"
}
```

Commit: **[89c210e](https://github.com/sagemath/sagetrac-mirror/commit/89c210e1d8fc7bb83c4c2ae501774531e67df463)**



---

archive/issue_comments_519947.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nOk, this is good to go. Thanks for the quick fix. One needs to be carefull with setting `set_random_seed(4)`, but this is ok at the end of a test block. The next block will get the initial seed again.",
    "created_at": "2021-07-03T09:45:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-519947",
    "user": "https://github.com/kliem"
}
```

<a id='comment:3'>Comment 3:</a>
Ok, this is good to go. Thanks for the quick fix. One needs to be carefull with setting `set_random_seed(4)`, but this is ok at the end of a test block. The next block will get the initial seed again.



---

archive/issue_events_424453.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-07-03T09:46:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-424453"
}
```



---

archive/issue_events_424454.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-07-03T09:46:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-424454"
}
```



---

archive/issue_comments_519948.json:
```json
{
    "body": "Reviewer: **Jonathan Kliem**",
    "created_at": "2021-07-03T09:46:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-519948",
    "user": "https://github.com/kliem"
}
```

Reviewer: **Jonathan Kliem**



---

archive/issue_comments_519949.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nIf you prefer, we can use the graph6 string.",
    "created_at": "2021-07-03T09:57:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-519949",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:5'>Comment 5:</a>
If you prefer, we can use the graph6 string.



---

archive/issue_comments_519950.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nIt would be nice. At the moment things are stable and the next doctest is run with the correct seed. However, this doctest needs to be always the last (involving randomness) in this block.",
    "created_at": "2021-07-03T10:09:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-519950",
    "user": "https://github.com/kliem"
}
```

<a id='comment:6'>Comment 6:</a>
It would be nice. At the moment things are stable and the next doctest is run with the correct seed. However, this doctest needs to be always the last (involving randomness) in this block.



---

archive/issue_comments_519951.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nBranch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1d258966e84e3339245e31c0eb286f9cee6a6f35\">1d25896</a></td><td><code>trac #32095: avoid using set_random_seed</code></td></tr></table>\n",
    "created_at": "2021-07-03T10:20:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-519951",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:7'>Comment 7:</a>
Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1d258966e84e3339245e31c0eb286f9cee6a6f35">1d25896</a></td><td><code>trac #32095: avoid using set_random_seed</code></td></tr></table>




---

archive/issue_comments_519952.json:
```json
{
    "body": "Changed commit from **[89c210e](https://github.com/sagemath/sagetrac-mirror/commit/89c210e1d8fc7bb83c4c2ae501774531e67df463)** to **[1d25896](https://github.com/sagemath/sagetrac-mirror/commit/1d258966e84e3339245e31c0eb286f9cee6a6f35)**",
    "created_at": "2021-07-03T10:20:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-519952",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[89c210e](https://github.com/sagemath/sagetrac-mirror/commit/89c210e1d8fc7bb83c4c2ae501774531e67df463)** to **[1d25896](https://github.com/sagemath/sagetrac-mirror/commit/1d258966e84e3339245e31c0eb286f9cee6a6f35)**



---

archive/issue_events_424455.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2021-07-03T10:20:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-424455"
}
```



---

archive/issue_events_424456.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2021-07-03T10:20:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-424456"
}
```



---

archive/issue_comments_519953.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nShould be better this way.",
    "created_at": "2021-07-03T10:21:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-519953",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:8'>Comment 8:</a>
Should be better this way.



---

archive/issue_events_424457.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-07-03T11:01:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-424457"
}
```



---

archive/issue_events_424458.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-07-03T11:01:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-424458"
}
```



---

archive/issue_comments_519954.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nYes, that is better. It also fixes the graph in case that random graphs change at some point.",
    "created_at": "2021-07-03T11:01:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-519954",
    "user": "https://github.com/kliem"
}
```

<a id='comment:9'>Comment 9:</a>
Yes, that is better. It also fixes the graph in case that random graphs change at some point.



---

archive/issue_events_424459.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-07-23T20:10:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-424459"
}
```



---

archive/issue_events_424460.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "4441acd8bd39711c2eff8dc379e505b3f52b000f",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-07-23T20:10:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32095#event-424460"
}
```



---

archive/issue_comments_519955.json:
```json
{
    "body": "Changed branch from **[public/graphs/32095_fix_DiFUB_with_boost](https://github.com/sagemath/sagetrac-mirror/tree/public/graphs/32095_fix_DiFUB_with_boost)** to **[1d25896](https://github.com/sagemath/sagetrac-mirror/commit/1d258966e84e3339245e31c0eb286f9cee6a6f35)**",
    "created_at": "2021-07-23T20:10:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32095",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32095#issuecomment-519955",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/graphs/32095_fix_DiFUB_with_boost](https://github.com/sagemath/sagetrac-mirror/tree/public/graphs/32095_fix_DiFUB_with_boost)** to **[1d25896](https://github.com/sagemath/sagetrac-mirror/commit/1d258966e84e3339245e31c0eb286f9cee6a6f35)**
