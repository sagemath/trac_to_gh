# Issue 32607: compatibility with gsl 2.7

archive/issues_032370.json:
```json
{
    "body": "GSL 2.7 changes the definition of `gsl_complex`; see https://groups.google.com/g/sage-devel/c/yQ67Wy0gp58/m/jr6f7xtcBQAJ and #32587.\n\nThis patch changes the library code to use the macros provided by GSL instead of directly accessing the data structure, which should make things work with GSL 2.7 as well as older versions.\n\nCC:  @mkoeppe\n\nKeywords: gsl\n\nBranch/Commit: 6633bc4ddd66e982fc3484f399cf62e50e36fd61\n\nReviewer: Matthias Koeppe\n\nAuthor: Lorenz Panny\n\nDependencies: #32659\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32607\n\n",
    "closed_at": "2021-10-20T23:00:55Z",
    "created_at": "2021-10-02T02:23:47Z",
    "labels": [
        "component: interfaces",
        "critical"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "compatibility with gsl 2.7",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32607",
    "user": "https://github.com/yyyyx4"
}
```
GSL 2.7 changes the definition of `gsl_complex`; see https://groups.google.com/g/sage-devel/c/yQ67Wy0gp58/m/jr6f7xtcBQAJ and #32587.

This patch changes the library code to use the macros provided by GSL instead of directly accessing the data structure, which should make things work with GSL 2.7 as well as older versions.

CC:  @mkoeppe

Keywords: gsl

Branch/Commit: 6633bc4ddd66e982fc3484f399cf62e50e36fd61

Reviewer: Matthias Koeppe

Author: Lorenz Panny

Dependencies: #32659

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/32607





---

archive/issue_comments_649690.json:
```json
{
    "body": "Changing commit from \"\" to \"6633bc4ddd66e982fc3484f399cf62e50e36fd61\"",
    "created_at": "2021-10-02T02:24:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649690",
    "user": "https://github.com/yyyyx4"
}
```

Changing commit from "" to "6633bc4ddd66e982fc3484f399cf62e50e36fd61"



---

archive/issue_comments_649691.json:
```json
{
    "body": "<a id='comment:1'></a>\nNew commits:\n|                                                                                                                                          |                                               |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|\n|[6633bc4](https://github.com/sagemath/sagetrac-mirror/commit/6633bc4ddd66e982fc3484f399cf62e50e36fd61)|`use GSL macros for compatibility with gsl 2.7`|",
    "created_at": "2021-10-02T02:24:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649691",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:1'></a>
New commits:
|                                                                                                                                          |                                               |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------|
|[6633bc4](https://github.com/sagemath/sagetrac-mirror/commit/6633bc4ddd66e982fc3484f399cf62e50e36fd61)|`use GSL macros for compatibility with gsl 2.7`|



---

archive/issue_comments_649692.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-10-02T02:24:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649692",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_649693.json:
```json
{
    "body": "Changing branch from \"\" to \"public/32607\"",
    "created_at": "2021-10-02T02:24:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649693",
    "user": "https://github.com/yyyyx4"
}
```

Changing branch from "" to "public/32607"



---

archive/issue_comments_649694.json:
```json
{
    "body": "Changing author from \"\" to \"Lorenz Panny\"",
    "created_at": "2021-10-02T02:24:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649694",
    "user": "https://github.com/yyyyx4"
}
```

Changing author from "" to "Lorenz Panny"



---

archive/issue_comments_649695.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-10-02T04:58:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649695",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_649696.json:
```json
{
    "body": "<a id='comment:2'></a>\nmultiple errors in the patchbot run",
    "created_at": "2021-10-02T04:58:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649696",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>
multiple errors in the patchbot run



---

archive/issue_comments_649697.json:
```json
{
    "body": "<a id='comment:3'></a>\nThe bot seems to be running old versions of some these files. In particular, the most common error is\n\n```\n      File \"sage/ext/interpreters/wrapper_cdf.pyx\", line 17, in sage.ext.interpreters.wrapper_cdf.dz_to_CDE (build/cythonized/sage/ext/interpreters/wrapper_cdf.c:3144)\n        z._complex.real = creal(dz)\n    AttributeError: 'dict' object has no attribute 'real'\n```\n\n\u2014 but line 17 of `wrapper_cdf.pyx` was changed in this patch (indirectly via `sage_setup/autogen/interpreters/specs/cdf.py`) to something different from what the error message shows.\n\nI suppose the bot should be instructed to regenerate `wrapper_cdf.pyx` somehow?",
    "created_at": "2021-10-02T05:26:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649697",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:3'></a>
The bot seems to be running old versions of some these files. In particular, the most common error is

```
      File "sage/ext/interpreters/wrapper_cdf.pyx", line 17, in sage.ext.interpreters.wrapper_cdf.dz_to_CDE (build/cythonized/sage/ext/interpreters/wrapper_cdf.c:3144)
        z._complex.real = creal(dz)
    AttributeError: 'dict' object has no attribute 'real'
```

â€” but line 17 of `wrapper_cdf.pyx` was changed in this patch (indirectly via `sage_setup/autogen/interpreters/specs/cdf.py`) to something different from what the error message shows.

I suppose the bot should be instructed to regenerate `wrapper_cdf.pyx` somehow?



---

archive/issue_comments_649698.json:
```json
{
    "body": "<a id='comment:4'></a>\nThen the patchbot won't be helpful after all. Next step: Portability testing on GH Actions",
    "created_at": "2021-10-02T05:32:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649698",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>
Then the patchbot won't be helpful after all. Next step: Portability testing on GH Actions



---

archive/issue_comments_649699.json:
```json
{
    "body": "<a id='comment:5'></a>\nhttps://github.com/kgywlytnch/sagetrac-mirror/actions/runs/1301872704\n\nDid I do this right? The failures seem unrelated to what we're doing here.",
    "created_at": "2021-10-07T02:24:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649699",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:5'></a>
https://github.com/kgywlytnch/sagetrac-mirror/actions/runs/1301872704

Did I do this right? The failures seem unrelated to what we're doing here.



---

archive/issue_comments_649700.json:
```json
{
    "body": "<a id='comment:6'></a>\nYes, looking good. In particular works without failure on `ubuntu-bionic-standard`, where it's using system GSL 2.4+dfsg-6",
    "created_at": "2021-10-07T02:35:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649700",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>
Yes, looking good. In particular works without failure on `ubuntu-bionic-standard`, where it's using system GSL 2.4+dfsg-6



---

archive/issue_comments_649701.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Matthias Koeppe\"",
    "created_at": "2021-10-07T02:35:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649701",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "Matthias Koeppe"



---

archive/issue_comments_649702.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-10-07T02:35:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649702",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_649703.json:
```json
{
    "body": "<a id='comment:9'></a>\n\n```\nsage: complex_plot(sqrt(x), (-5, 5), (-5, 5))\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\nAttributeError: 'dict' object has no attribute 'real'\nException ignored in: 'sage.ext.interpreters.wrapper_cdf.CDE_to_dz'\nTraceback (most recent call last):\n  File \"/home/release/Sage/local/lib64/python3.9/site-packages/sage/misc/decorators.py\", line 491, in wrapper\n    return func(*args, **options)\nAttributeError: 'dict' object has no attribute 'real'\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n<ipython-input-1-248579947237> in <module>\n----> 1 complex_plot(sqrt(x), (-Integer(5), Integer(5)), (-Integer(5), Integer(5)))\n\n~/Sage/local/lib64/python3.9/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4052)()\n    360             True\n    361         \"\"\"\n--> 362         return self.get_object()(*args, **kwds)\n    363 \n    364     def __repr__(self):\n\n~/Sage/local/lib64/python3.9/site-packages/sage/misc/decorators.py in wrapper(*args, **kwds)\n    489                 options['__original_opts'] = kwds\n    490             options.update(kwds)\n--> 491             return func(*args, **options)\n    492 \n    493         #Add the options specified by @options to the signature of the wrapped\n\n~/Sage/local/lib64/python3.9/site-packages/sage/plot/complex_plot.pyx in sage.plot.complex_plot.complex_plot (build/cythonized/sage/plot/complex_plot.c:5949)()\n    398         for x in srange(*x_range, include_endpoint=True):\n    399             sig_check()\n--> 400             row.append(f(new_CDF_element(x, y)))\n    401         z_values.append(row)\n    402 \n\n~/Sage/local/lib64/python3.9/site-packages/sage/ext/interpreters/wrapper_cdf.pyx in sage.ext.interpreters.wrapper_cdf.Wrapper_cdf.__call__ (build/cythonized/sage/ext/interpreters/wrapper_cdf.c:4068)()\n    108         for i from 0 <= i < len(args):\n    109             self._args[i] = CDE_to_dz(args[i])\n--> 110         return dz_to_CDE(interp_cdf(c_args\n    111             , self._constants\n    112             , self._py_constants\n\n~/Sage/local/lib64/python3.9/site-packages/sage/ext/interpreters/wrapper_cdf.pyx in sage.ext.interpreters.wrapper_cdf.dz_to_CDE (build/cythonized/sage/ext/interpreters/wrapper_cdf.c:3142)()\n     15 cdef inline ComplexDoubleElement dz_to_CDE(double_complex dz):\n     16     cdef ComplexDoubleElement z = <ComplexDoubleElement>ComplexDoubleElement.__new__(ComplexDoubleElement)\n---> 17     z._complex.real = creal(dz)\n     18     z._complex.imag = cimag(dz)\n     19     return z\n\nAttributeError: 'dict' object has no attribute 'real'\n```",
    "created_at": "2021-10-09T12:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649703",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:9'></a>

```
sage: complex_plot(sqrt(x), (-5, 5), (-5, 5))
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
AttributeError: 'dict' object has no attribute 'real'
Exception ignored in: 'sage.ext.interpreters.wrapper_cdf.CDE_to_dz'
Traceback (most recent call last):
  File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/misc/decorators.py", line 491, in wrapper
    return func(*args, **options)
AttributeError: 'dict' object has no attribute 'real'
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-1-248579947237> in <module>
----> 1 complex_plot(sqrt(x), (-Integer(5), Integer(5)), (-Integer(5), Integer(5)))

~/Sage/local/lib64/python3.9/site-packages/sage/misc/lazy_import.pyx in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:4052)()
    360             True
    361         """
--> 362         return self.get_object()(*args, **kwds)
    363 
    364     def __repr__(self):

~/Sage/local/lib64/python3.9/site-packages/sage/misc/decorators.py in wrapper(*args, **kwds)
    489                 options['__original_opts'] = kwds
    490             options.update(kwds)
--> 491             return func(*args, **options)
    492 
    493         #Add the options specified by @options to the signature of the wrapped

~/Sage/local/lib64/python3.9/site-packages/sage/plot/complex_plot.pyx in sage.plot.complex_plot.complex_plot (build/cythonized/sage/plot/complex_plot.c:5949)()
    398         for x in srange(*x_range, include_endpoint=True):
    399             sig_check()
--> 400             row.append(f(new_CDF_element(x, y)))
    401         z_values.append(row)
    402 

~/Sage/local/lib64/python3.9/site-packages/sage/ext/interpreters/wrapper_cdf.pyx in sage.ext.interpreters.wrapper_cdf.Wrapper_cdf.__call__ (build/cythonized/sage/ext/interpreters/wrapper_cdf.c:4068)()
    108         for i from 0 <= i < len(args):
    109             self._args[i] = CDE_to_dz(args[i])
--> 110         return dz_to_CDE(interp_cdf(c_args
    111             , self._constants
    112             , self._py_constants

~/Sage/local/lib64/python3.9/site-packages/sage/ext/interpreters/wrapper_cdf.pyx in sage.ext.interpreters.wrapper_cdf.dz_to_CDE (build/cythonized/sage/ext/interpreters/wrapper_cdf.c:3142)()
     15 cdef inline ComplexDoubleElement dz_to_CDE(double_complex dz):
     16     cdef ComplexDoubleElement z = <ComplexDoubleElement>ComplexDoubleElement.__new__(ComplexDoubleElement)
---> 17     z._complex.real = creal(dz)
     18     z._complex.imag = cimag(dz)
     19     return z

AttributeError: 'dict' object has no attribute 'real'
```



---

archive/issue_comments_649704.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-10-09T12:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649704",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_649705.json:
```json
{
    "body": "<a id='comment:10'></a>\n... that's the issue with incremental builds, same as[comment:3](#comment%3A3)",
    "created_at": "2021-10-09T17:28:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649705",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>
... that's the issue with incremental builds, same as[comment:3](#comment%3A3)



---

archive/issue_comments_649706.json:
```json
{
    "body": "<a id='comment:11'></a>\nhmm well that sounds like a problem with the dependencies, is it fixable?",
    "created_at": "2021-10-09T19:55:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649706",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:11'></a>
hmm well that sounds like a problem with the dependencies, is it fixable?



---

archive/issue_comments_649707.json:
```json
{
    "body": "<a id='comment:12'></a>\nThe relevant code is in `src/sage_setup/autogen/interpreters/__init__.py`, I haven't looked at the details",
    "created_at": "2021-10-09T20:46:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649707",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>
The relevant code is in `src/sage_setup/autogen/interpreters/__init__.py`, I haven't looked at the details



---

archive/issue_comments_649708.json:
```json
{
    "body": "<a id='comment:13'></a>\nI am working on a fix.",
    "created_at": "2021-10-09T22:53:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649708",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>
I am working on a fix.



---

archive/issue_comments_649709.json:
```json
{
    "body": "<a id='comment:14'></a>\nFixed in #32659",
    "created_at": "2021-10-10T04:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649709",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>
Fixed in #32659



---

archive/issue_comments_649710.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#32659\"",
    "created_at": "2021-10-10T04:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649710",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "" to "#32659"



---

archive/issue_comments_649711.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-10-10T04:32:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649711",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_649712.json:
```json
{
    "body": "Changing branch from \"public/32607\" to \"6633bc4ddd66e982fc3484f399cf62e50e36fd61\"",
    "created_at": "2021-10-20T23:00:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649712",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/32607" to "6633bc4ddd66e982fc3484f399cf62e50e36fd61"



---

archive/issue_events_097170.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-10-20T23:00:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32607#event-97170"
}
```



---

archive/issue_comments_649713.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-10-20T23:00:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32607",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32607#issuecomment-649713",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
