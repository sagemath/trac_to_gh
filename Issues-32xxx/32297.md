# Issue 32297: Abel-Jacobi map on Riemann surfaces

archive/issues_032060.json:
```json
{
    "body": "This ticket will add the functionality of an Abel-Jacobi map method to Riemann surfaces, and in doing so add some necessary additional functionality (such as the ability to reduce a vector over the period lattice).\n\nIn cases where improper integrals arise, a double-exponential quadrature gets used. Contrary to the Gauss-Legendre integrator that is normally used, this is not a rigorous one. Future versions should probably use a series expansion at the problematic point and then optimize the radius to be used between cost of series expansion and Gauss-Legendre (with path splitting).\n\nAssignee: @DisneyHogg\n\nCC:  @nbruin\n\nBranch/Commit: c8dff33ab174483247969e59eec03ffb5de4b27c\n\nReviewer: Nils Bruin, Travis Scrimshaw\n\nAuthor: Linden Disney-Hogg\n\nDependencies: #31996\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32297\n\n",
    "closed_at": "2022-09-25T16:34:24Z",
    "created_at": "2021-07-29T09:45:30Z",
    "labels": [
        "component: algebraic geometry"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Abel-Jacobi map on Riemann surfaces",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32297",
    "user": "https://github.com/DisneyHogg"
}
```
This ticket will add the functionality of an Abel-Jacobi map method to Riemann surfaces, and in doing so add some necessary additional functionality (such as the ability to reduce a vector over the period lattice).

In cases where improper integrals arise, a double-exponential quadrature gets used. Contrary to the Gauss-Legendre integrator that is normally used, this is not a rigorous one. Future versions should probably use a series expansion at the problematic point and then optimize the radius to be used between cost of series expansion and Gauss-Legendre (with path splitting).

Assignee: @DisneyHogg

CC:  @nbruin

Branch/Commit: c8dff33ab174483247969e59eec03ffb5de4b27c

Reviewer: Nils Bruin, Travis Scrimshaw

Author: Linden Disney-Hogg

Dependencies: #31996

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/32297





---

archive/issue_comments_488695.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-\n+This ticket will add the functionality of an Abel-Jacobi map method to Riemann surfaces, and in doing so add some necessary additional functionality (such as the ability to reduce a vector over the period lattice). Tickets #31996 and #32289 will need to be merged when they are ready, as functionality developed in these will be required, namely tools required for line integrals of differentials. \n \n Type: PLEASE CHANGE\n \n```\n",
    "created_at": "2021-07-29T09:53:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488695",
    "user": "https://github.com/DisneyHogg"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,4 @@
-
+This ticket will add the functionality of an Abel-Jacobi map method to Riemann surfaces, and in doing so add some necessary additional functionality (such as the ability to reduce a vector over the period lattice). Tickets #31996 and #32289 will need to be merged when they are ready, as functionality developed in these will be required, namely tools required for line integrals of differentials. 
 
 Type: PLEASE CHANGE
 
```




---

archive/issue_comments_488696.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2021-07-29T09:53:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488696",
    "user": "https://github.com/DisneyHogg"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_488697.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to algebraic geometry.",
    "created_at": "2021-07-29T09:53:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488697",
    "user": "https://github.com/DisneyHogg"
}
```

Changing component from PLEASE CHANGE to algebraic geometry.



---

archive/issue_comments_488698.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2021-07-29T09:53:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488698",
    "user": "https://github.com/DisneyHogg"
}
```

Changing priority from major to minor.



---

archive/issue_comments_488699.json:
```json
{
    "body": "Set assignee to @DisneyHogg.",
    "created_at": "2021-07-29T09:53:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488699",
    "user": "https://github.com/DisneyHogg"
}
```

Set assignee to @DisneyHogg.



---

archive/issue_events_085647.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-10T17:30:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32297#event-85647"
}
```



---

archive/issue_comments_488700.json:
```json
{
    "body": "<a id='comment:4'></a>Ticket #32289 is no longer a depdency due to the structure of the code.\n\n---\nLast 10 new commits:",
    "created_at": "2021-08-12T09:23:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488700",
    "user": "https://github.com/DisneyHogg"
}
```

<a id='comment:4'></a>Ticket #32289 is no longer a depdency due to the structure of the code.

---
Last 10 new commits:



---

archive/issue_comments_488701.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-12T13:05:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488701",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488702.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-12T13:30:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488702",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488703.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-13T09:35:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488703",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488704.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-13T16:11:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488704",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488705.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-08-13T16:13:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488705",
    "user": "https://github.com/DisneyHogg"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_488706.json:
```json
{
    "body": "<a id='comment:10'></a>I noticed on some examples that the new code introduces a *lot* of \"branch\" points. I'm a little concerned this may affects performance adversely in various cases:\n- the present code computes homotopy continuations along *all* edges, so we have to compute much more of them\n- the newly introduced points may push paths much closer to problematic points than they previously were, so it may make some continuations take longer than they did before.\n\nUsually, integration takes more function evaluations than the homotopy continuations, so in many cases the penalty will not be so severe, but I don't know to what extent that will hold true.\n\nI see several options to mitigate this issue:\n- we could refactor the class so that the branch locus selection mechanism is more easily customizable and then subclass a separate \"RiemannSurfaceForAbelJacobiMap\" which can then implement the additional integration techniques required for computing, and initialize this richer skeleton\n- we could put specify (with a flag) what kind of branch locus should be used and, based on that, the code later can choose what features are available (roughly equivalent to the solution above, but solved with a different software technique)\n- we could extract a subgraph that is sufficient to support the full homology: just cycles around the *actual* branch points. That's enough to for our purpose. The other points are just there to avoid unfortunate behaviour.\n\nIn the last one, we'd have more upfront work, because we're extracting our graph from a larger Voronoi graph (but that's fairly cheap to compute) and our integration paths may be pushed and broken up (and hence be less optimal? are they optimal now?). If we could come up with a good estimated cost function (length over sum of distances of branch points to line segment?) we could try and select \"shortest cycles\". Otherwise perhaps just take the voronoi cells that belong to the actual branch points, with possibly some extra edges to make the thing connected.\n\nThere is something to say to equip the path builder with the general infrastructure to specify the points we must have cycles around, together with other points that are to be avoided. \n\nThe main part is: there are plenty of applications of Riemann matrices that do not involve computing Abel-Jacobi maps, so we should not deteriorate the performance of that (without choice) in favour of Abel-Jacobi maps.",
    "created_at": "2021-08-13T17:51:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488706",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:10'></a>I noticed on some examples that the new code introduces a *lot* of "branch" points. I'm a little concerned this may affects performance adversely in various cases:
- the present code computes homotopy continuations along *all* edges, so we have to compute much more of them
- the newly introduced points may push paths much closer to problematic points than they previously were, so it may make some continuations take longer than they did before.

Usually, integration takes more function evaluations than the homotopy continuations, so in many cases the penalty will not be so severe, but I don't know to what extent that will hold true.

I see several options to mitigate this issue:
- we could refactor the class so that the branch locus selection mechanism is more easily customizable and then subclass a separate "RiemannSurfaceForAbelJacobiMap" which can then implement the additional integration techniques required for computing, and initialize this richer skeleton
- we could put specify (with a flag) what kind of branch locus should be used and, based on that, the code later can choose what features are available (roughly equivalent to the solution above, but solved with a different software technique)
- we could extract a subgraph that is sufficient to support the full homology: just cycles around the *actual* branch points. That's enough to for our purpose. The other points are just there to avoid unfortunate behaviour.

In the last one, we'd have more upfront work, because we're extracting our graph from a larger Voronoi graph (but that's fairly cheap to compute) and our integration paths may be pushed and broken up (and hence be less optimal? are they optimal now?). If we could come up with a good estimated cost function (length over sum of distances of branch points to line segment?) we could try and select "shortest cycles". Otherwise perhaps just take the voronoi cells that belong to the actual branch points, with possibly some extra edges to make the thing connected.

There is something to say to equip the path builder with the general infrastructure to specify the points we must have cycles around, together with other points that are to be avoided. 

The main part is: there are plenty of applications of Riemann matrices that do not involve computing Abel-Jacobi maps, so we should not deteriorate the performance of that (without choice) in favour of Abel-Jacobi maps.



---

archive/issue_comments_488707.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:10 nbruin]:\nI had noticed the additional strain having a larger skeleton caused. A simpler solution might be to revert to the previous case of not including ramification points of the differentials in the branch locus, as a quick test shows that this doesn't stop the Abel-Jacobi map from working on any of the current cases. One would then need to just put in a check, analogous to the one currently around line 3110, that makes sure that if the path to the currently chosen vertex would pass too close to a ramification point, another vertex is chosen.",
    "created_at": "2021-08-14T00:48:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488707",
    "user": "https://github.com/DisneyHogg"
}
```

<a id='comment:11'></a>Replying to [comment:10 nbruin]:
I had noticed the additional strain having a larger skeleton caused. A simpler solution might be to revert to the previous case of not including ramification points of the differentials in the branch locus, as a quick test shows that this doesn't stop the Abel-Jacobi map from working on any of the current cases. One would then need to just put in a check, analogous to the one currently around line 3110, that makes sure that if the path to the currently chosen vertex would pass too close to a ramification point, another vertex is chosen.



---

archive/issue_comments_488708.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:11 gh-DisneyHogg]:\n> Replying to [comment:10 nbruin]:\n> I had noticed the additional strain having a larger skeleton caused. A simpler solution might be to revert to the previous case of not including ramification points of the differentials in the branch locus, as a quick test shows that this doesn't stop the Abel-Jacobi map from working on any of the current cases. One would then need to just put in a check, analogous to the one currently around line 3110, that makes sure that if the path to the currently chosen vertex would pass too close to a ramification point, another vertex is chosen. \n\n\nThat seems like a good idea. I assume you'll actually be using this code, so refining such strategies if necessary later is a good idea. First getting a basic, functional version in is a good first step.",
    "created_at": "2021-08-14T04:34:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488708",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:12'></a>Replying to [comment:11 gh-DisneyHogg]:
> Replying to [comment:10 nbruin]:
> I had noticed the additional strain having a larger skeleton caused. A simpler solution might be to revert to the previous case of not including ramification points of the differentials in the branch locus, as a quick test shows that this doesn't stop the Abel-Jacobi map from working on any of the current cases. One would then need to just put in a check, analogous to the one currently around line 3110, that makes sure that if the path to the currently chosen vertex would pass too close to a ramification point, another vertex is chosen. 


That seems like a good idea. I assume you'll actually be using this code, so refining such strategies if necessary later is a good idea. First getting a basic, functional version in is a good first step.



---

archive/issue_comments_488709.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-16T10:19:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488709",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488710.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-16T10:24:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488710",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488711.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-21T11:32:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488711",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488712.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-30T13:49:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488712",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488713.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-08T14:11:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488713",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488714.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:18 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> |                                                                                                                                           |                       |\n> |-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------|\n> |[c449417](https://git.sagemath.org/sage.git/commit/?id=c44941741db4edbf488fa8d72af6a5481dab34b5)|`Error bound improved.`|\n\n\nSee comments 57, 58 and 60 of #31996 for context.",
    "created_at": "2021-09-08T14:12:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488714",
    "user": "https://github.com/DisneyHogg"
}
```

<a id='comment:19'></a>Replying to [comment:18 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> |                                                                                                                                           |                       |
> |-------------------------------------------------------------------------------------------------------------------------------------------|-----------------------|
> |[c449417](https://git.sagemath.org/sage.git/commit/?id=c44941741db4edbf488fa8d72af6a5481dab34b5)|`Error bound improved.`|


See comments 57, 58 and 60 of #31996 for context.



---

archive/issue_comments_488715.json:
```json
{
    "body": "<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-26T10:14:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488715",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488716.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-03T16:13:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488716",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488717.json:
```json
{
    "body": "<a id='comment:22'></a>The code is currently not reliable when integrating out to infinity. Consider the following code doing the AJ integral to the point above infinity where the fibre coordinate tends to infinity on Klein's curve\n\n```\nR.<x,y> = QQ[]\nf = x^3*y + y^3 + x\nS = RiemannSurface(f)\nfor i in [0,2]:\n    AJ, _ = S._integrate_differentials_iteratively(([Infinity, i], S._CC(2-I)), True)\n    print(AJ, \"\\n\")\n```\nThe fibre values above the path on these two integrals has the opposite sign, hence as the cohomology basis is `[1, y, x]` with denominator `x<sup>3+3*y</sup>2`, we expect the `0,2` elements of the two values `AJ` to be the same (which is what we see) and the `1` element to have opposite sign (which isn't true). The error is of about 0.02%. \nOne can check that this is numerical instability, for example by considering the case where we take `S._prec=100`, and then the output of `initialise(z, i)` is not the same (up to sign) for the two integrals. Perhaps the method for computing the AJ map to infinity needs to be rethought, or a method to mitigate these instabilities needs to be devised.",
    "created_at": "2021-11-08T16:56:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488717",
    "user": "https://github.com/DisneyHogg"
}
```

<a id='comment:22'></a>The code is currently not reliable when integrating out to infinity. Consider the following code doing the AJ integral to the point above infinity where the fibre coordinate tends to infinity on Klein's curve

```
R.<x,y> = QQ[]
f = x^3*y + y^3 + x
S = RiemannSurface(f)
for i in [0,2]:
    AJ, _ = S._integrate_differentials_iteratively(([Infinity, i], S._CC(2-I)), True)
    print(AJ, "\n")
```
The fibre values above the path on these two integrals has the opposite sign, hence as the cohomology basis is `[1, y, x]` with denominator `x<sup>3+3*y</sup>2`, we expect the `0,2` elements of the two values `AJ` to be the same (which is what we see) and the `1` element to have opposite sign (which isn't true). The error is of about 0.02%. 
One can check that this is numerical instability, for example by considering the case where we take `S._prec=100`, and then the output of `initialise(z, i)` is not the same (up to sign) for the two integrals. Perhaps the method for computing the AJ map to infinity needs to be rethought, or a method to mitigate these instabilities needs to be devised.



---

archive/issue_comments_488718.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-02T12:27:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488718",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_085648.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T20:21:36Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32297#event-85648"
}
```



---

archive/issue_events_085649.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T20:21:36Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32297#event-85649"
}
```



---

archive/issue_comments_488719.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-02T11:42:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488719",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488720.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-04-07T06:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488720",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_488721.json:
```json
{
    "body": "<a id='comment:26'></a>Needs rebase.",
    "created_at": "2022-04-07T06:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488721",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:26'></a>Needs rebase.



---

archive/issue_comments_488722.json:
```json
{
    "body": "<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-04-13T11:16:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488722",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488723.json:
```json
{
    "body": "<a id='comment:28'></a>Rebased, and tests passing.",
    "created_at": "2022-04-13T12:01:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488723",
    "user": "https://github.com/DisneyHogg"
}
```

<a id='comment:28'></a>Rebased, and tests passing.



---

archive/issue_comments_488724.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-04-13T12:01:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488724",
    "user": "https://github.com/DisneyHogg"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_488725.json:
```json
{
    "body": "<a id='comment:29'></a>please fix the patchbot red plugins",
    "created_at": "2022-04-13T18:16:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488725",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:29'></a>please fix the patchbot red plugins



---

archive/issue_comments_488726.json:
```json
{
    "body": "<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-04-14T09:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488726",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488727.json:
```json
{
    "body": "<a id='comment:31'></a>Patchbot plugin now passing",
    "created_at": "2022-04-14T10:08:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488727",
    "user": "https://github.com/DisneyHogg"
}
```

<a id='comment:31'></a>Patchbot plugin now passing



---

archive/issue_comments_488728.json:
```json
{
    "body": "<a id='comment:32'></a>not yet:\n\n```\n+src/sage/schemes/riemann_surfaces/riemann_surface.py:3327:25 undefined name 'g'\n+src/sage/schemes/riemann_surfaces/riemann_surface.py:3464:9 local variable 'Pz' is assigned to but never used\n+src/sage/schemes/riemann_surfaces/riemann_surface.py:3465:9 local variable 'Pw' is assigned to but never used\n```\nand\n\n```\n++        Returns a representative of the Abel-Jacobi map of a divisor with basepoint\n++        Returns a list of the of places above the branch locus. This must be\n```\nwhere Returns should be Return",
    "created_at": "2022-04-14T11:02:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488728",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:32'></a>not yet:

```
+src/sage/schemes/riemann_surfaces/riemann_surface.py:3327:25 undefined name 'g'
+src/sage/schemes/riemann_surfaces/riemann_surface.py:3464:9 local variable 'Pz' is assigned to but never used
+src/sage/schemes/riemann_surfaces/riemann_surface.py:3465:9 local variable 'Pw' is assigned to but never used
```
and

```
++        Returns a representative of the Abel-Jacobi map of a divisor with basepoint
++        Returns a list of the of places above the branch locus. This must be
```
where Returns should be Return



---

archive/issue_comments_488729.json:
```json
{
    "body": "<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-04-14T11:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488729",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488730.json:
```json
{
    "body": "<a id='comment:34'></a>Made those changes, how did you discover these errors? I am using `tox -- sage/schemes/riemann_surfaces/riemann_surface.py` to run the tests, should I be using something else?",
    "created_at": "2022-04-14T11:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488730",
    "user": "https://github.com/DisneyHogg"
}
```

<a id='comment:34'></a>Made those changes, how did you discover these errors? I am using `tox -- sage/schemes/riemann_surfaces/riemann_surface.py` to run the tests, should I be using something else?



---

archive/issue_comments_488731.json:
```json
{
    "body": "<a id='comment:35'></a>they are displayed when you click on the round icon for the patchbot reports (here, top left). Then there are smaller round icons on the right of each reports.",
    "created_at": "2022-04-14T11:19:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488731",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:35'></a>they are displayed when you click on the round icon for the patchbot reports (here, top left). Then there are smaller round icons on the right of each reports.



---

archive/issue_comments_488732.json:
```json
{
    "body": "<a id='comment:36'></a>50 seconds is not a reasonable time for a doctest",
    "created_at": "2022-04-16T10:05:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488732",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:36'></a>50 seconds is not a reasonable time for a doctest



---

archive/issue_comments_488733.json:
```json
{
    "body": "<a id='comment:37'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-04-27T11:19:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488733",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:37'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488734.json:
```json
{
    "body": "<a id='comment:38'></a>Build and test is failing, but seemingly only because of test in `parallel/map_reduce.py`, but running `sage -t --random-seed=21747910571368870053030460862137931549 sage/parallel/map_reduce.py` ony my machine doesn't reproduce the errors.",
    "created_at": "2022-04-27T15:16:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488734",
    "user": "https://github.com/DisneyHogg"
}
```

<a id='comment:38'></a>Build and test is failing, but seemingly only because of test in `parallel/map_reduce.py`, but running `sage -t --random-seed=21747910571368870053030460862137931549 sage/parallel/map_reduce.py` ony my machine doesn't reproduce the errors.



---

archive/issue_comments_488735.json:
```json
{
    "body": "<a id='comment:39'></a>`@`nbruin What else mathematically needs to be checked with this code. I can do the remaining technical stuff, but I don't know the math here.",
    "created_at": "2022-05-01T23:46:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488735",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:39'></a>`@`nbruin What else mathematically needs to be checked with this code. I can do the remaining technical stuff, but I don't know the math here.



---

archive/issue_events_085650.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32297#event-85650"
}
```



---

archive/issue_events_085651.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32297#event-85651"
}
```



---

archive/issue_comments_488736.json:
```json
{
    "body": "<a id='comment:41'></a>needs rebase\n\nand what about comment:36 ?",
    "created_at": "2022-05-31T09:59:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488736",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:41'></a>needs rebase

and what about comment:36 ?



---

archive/issue_comments_488737.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-05-31T09:59:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488737",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_488738.json:
```json
{
    "body": "<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-18T12:38:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488738",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488739.json:
```json
{
    "body": "<a id='comment:43'></a>Code rebased and all checks passing, so needs review.",
    "created_at": "2022-08-19T07:13:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488739",
    "user": "https://github.com/DisneyHogg"
}
```

<a id='comment:43'></a>Code rebased and all checks passing, so needs review.



---

archive/issue_comments_488740.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-08-19T07:13:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488740",
    "user": "https://github.com/DisneyHogg"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_488741.json:
```json
{
    "body": "<a id='comment:44'></a>(this is a longer comment concerning ideas that should probably be transferred to follow-up tickets)\n\nThis largely looks great! I envision that this code would mainly be used \"the other way around\" as far as curves and riemann surfaces are concerned:\n\n```\nR.<x,y> = QQ[]\nf = (y^2- (x-1)*(x-3)*(x-4)*(x-6)*(x-11))\nC = Curve(f)\nKC= C.function_field()\nS = C.riemann_surface(prec=100)\nKC = Curve(S.f).function_field()\nDx=KC(x).divisor()\nDxm1=KC(x-1).divisor()\nv=S.abel_jacobi(S.divisor_to_divisor_list(Dx-Dxm1))\n```\nbut that works just fine. I think we'll need a better error message for problems with support at infinity, though:\n\n```\nsage: S.divisor_to_divisor_list(Dx)\nTypeError: Could not find a mapping of the passed element to this ring.\n```\nthat should be a `ValueError: conversion of places at infinity not implemented yet`.\n\nThe extended example at the top of the file illustrates all the main features of the current implementation, though: that should allow anyone to get started with this.\n\nI do think that in the near future it would be really desirable that `S.abel_jacobi` also accepts \"function field divisors\" itself, where it can then just call `divisor_to_divisor_list` itself: it's pretty clear that in the near-to-medium future, function field divisors are going to be the most functional data type (perhaps \"curve\" divisors develop, but we need Cartier divisors here, so the function field is not a bad place to park them), so it would be good if `abel_jacobi` accepted that.\n\nThere are presently some `Curve(self.f)` calls in `places_at_branch_locus`, `strong_approximation`, `divisor_to_divisor_list` [notably, NOT in the actual workhorse routines!]. That's possibly a quite costly thing to call and, interestingly, it's not `UniqueRepresentation`!. So\n\n```\nsage: C1=Curve(f)\nsage: C2=Curve(f)\nsage: C1 is C2\nFalse\n```\nso I suspect that a riemann surface should have a possibility of linking back to a curve, which could be just Curve(self.f). However, when called via `C.riemann_surface()`, it should probably link back to the original curve; meaning that `C.riemann_surface` should do some post-processing (or riemann_surface would need to sprout yet another technical optional argument to pass it the curve to link back to)\n\nInterestingly enough, the function field ARE `UniqueRepresentation`, so\n\n```\nsage: C1.function_field() is C2.function_field()\nTrue\n```\nbut I think that by just linking back to the curve, we'll not be creating reference cycles that make objects immortal (which is always a real risk with a `UniqueRepresentation` object that links to an object that (even weakly!) links back to it.",
    "created_at": "2022-08-23T00:57:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488741",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:44'></a>(this is a longer comment concerning ideas that should probably be transferred to follow-up tickets)

This largely looks great! I envision that this code would mainly be used "the other way around" as far as curves and riemann surfaces are concerned:

```
R.<x,y> = QQ[]
f = (y^2- (x-1)*(x-3)*(x-4)*(x-6)*(x-11))
C = Curve(f)
KC= C.function_field()
S = C.riemann_surface(prec=100)
KC = Curve(S.f).function_field()
Dx=KC(x).divisor()
Dxm1=KC(x-1).divisor()
v=S.abel_jacobi(S.divisor_to_divisor_list(Dx-Dxm1))
```
but that works just fine. I think we'll need a better error message for problems with support at infinity, though:

```
sage: S.divisor_to_divisor_list(Dx)
TypeError: Could not find a mapping of the passed element to this ring.
```
that should be a `ValueError: conversion of places at infinity not implemented yet`.

The extended example at the top of the file illustrates all the main features of the current implementation, though: that should allow anyone to get started with this.

I do think that in the near future it would be really desirable that `S.abel_jacobi` also accepts "function field divisors" itself, where it can then just call `divisor_to_divisor_list` itself: it's pretty clear that in the near-to-medium future, function field divisors are going to be the most functional data type (perhaps "curve" divisors develop, but we need Cartier divisors here, so the function field is not a bad place to park them), so it would be good if `abel_jacobi` accepted that.

There are presently some `Curve(self.f)` calls in `places_at_branch_locus`, `strong_approximation`, `divisor_to_divisor_list` [notably, NOT in the actual workhorse routines!]. That's possibly a quite costly thing to call and, interestingly, it's not `UniqueRepresentation`!. So

```
sage: C1=Curve(f)
sage: C2=Curve(f)
sage: C1 is C2
False
```
so I suspect that a riemann surface should have a possibility of linking back to a curve, which could be just Curve(self.f). However, when called via `C.riemann_surface()`, it should probably link back to the original curve; meaning that `C.riemann_surface` should do some post-processing (or riemann_surface would need to sprout yet another technical optional argument to pass it the curve to link back to)

Interestingly enough, the function field ARE `UniqueRepresentation`, so

```
sage: C1.function_field() is C2.function_field()
True
```
but I think that by just linking back to the curve, we'll not be creating reference cycles that make objects immortal (which is always a real risk with a `UniqueRepresentation` object that links to an object that (even weakly!) links back to it.



---

archive/issue_comments_488742.json:
```json
{
    "body": "<a id='comment:45'></a>Math review:\n\nI've done some basic checks and it looks like the implementation is fundamentally OK. There could of course be numerical stability problems lurking somewhere, but the only chance of getting these out is by exposing the code. So: positive review from me.\n\nAlso, considering doctest times:\n\n```\n$ sage -t src/sage/schemes/riemann_surfaces/riemann_surface.pyAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 13.3 seconds\n    cpu time: 12.6 seconds\n    cumulative wall time: 13.2 seconds\n$ sage -t --long src/sage/schemes/riemann_surfaces/riemann_surface.py\n----------------------------------------------------------------------\nTotal time for all tests: 23.6 seconds\n    cpu time: 22.9 seconds\n    cumulative wall time: 23.5 seconds\n```\nI think the tests for `long` are still quite decent, so I'd be in favour of dropping the `long` modifier on (many of) the tests, so that regular coverage is a bit better.",
    "created_at": "2022-08-23T01:02:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488742",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:45'></a>Math review:

I've done some basic checks and it looks like the implementation is fundamentally OK. There could of course be numerical stability problems lurking somewhere, but the only chance of getting these out is by exposing the code. So: positive review from me.

Also, considering doctest times:

```
$ sage -t src/sage/schemes/riemann_surfaces/riemann_surface.pyAll tests passed!
----------------------------------------------------------------------
Total time for all tests: 13.3 seconds
    cpu time: 12.6 seconds
    cumulative wall time: 13.2 seconds
$ sage -t --long src/sage/schemes/riemann_surfaces/riemann_surface.py
----------------------------------------------------------------------
Total time for all tests: 23.6 seconds
    cpu time: 22.9 seconds
    cumulative wall time: 23.5 seconds
```
I think the tests for `long` are still quite decent, so I'd be in favour of dropping the `long` modifier on (many of) the tests, so that regular coverage is a bit better.



---

archive/issue_comments_488743.json:
```json
{
    "body": "<a id='comment:46'></a>Replying to [comment:44 nbruin]:\n> that should be a `ValueError: conversion of places at infinity not implemented yet`.\n\n\nSeems like a textbook `NotImplementedError`. `;)`",
    "created_at": "2022-08-23T01:16:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488743",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:46'></a>Replying to [comment:44 nbruin]:
> that should be a `ValueError: conversion of places at infinity not implemented yet`.


Seems like a textbook `NotImplementedError`. `;)`



---

archive/issue_comments_488744.json:
```json
{
    "body": "<a id='comment:48'></a>OK, made some minor edits addressing most of the comments in [comment:46]\n\n---\nNew commits:",
    "created_at": "2022-08-23T21:57:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488744",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:48'></a>OK, made some minor edits addressing most of the comments in [comment:46]

---
New commits:



---

archive/issue_comments_488745.json:
```json
{
    "body": "<a id='comment:49'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-27T19:40:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488745",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:49'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488746.json:
```json
{
    "body": "<a id='comment:50'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-30T18:29:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488746",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:50'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488747.json:
```json
{
    "body": "<a id='comment:51'></a>Ticket looks like it's really ready for review now and since it adds significant functionality, reset priority to the (default) \"major\". I hope we can get it in!",
    "created_at": "2022-08-30T18:32:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488747",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:51'></a>Ticket looks like it's really ready for review now and since it adds significant functionality, reset priority to the (default) "major". I hope we can get it in!



---

archive/issue_comments_488748.json:
```json
{
    "body": "<a id='comment:52'></a>A bit [xkcd style commits](https://xkcd.com/1296/) there. `:P`\n\nSome code comments (I don't know the math; I will leave that to Nils):\n\n```diff\n-the literature.::\n+the literature::\n```\nas it displays as `the literature.:` in the compiled doc.\n\nSpacing would be nice here (but not required): ``2D=K`::` -> ``2D = K`::`\n\n```diff\n     INPUT:\n \n-    - ``item`` -- value to minimise the distance to over the list.\n-\n-    - ``List`` -- list. List to look for closest element in.\n+    - ``item`` -- value to minimize the distance to over the list\n+    - ``lst`` -- list to look for closest element in\n```\nWe generally have American spelling within Sage doc; inputs items are generally not sentences; Python naming conventions say variable names should (generally) follow `lower_case`; and we should not use `list` as a variable. Similar changes elsewhere in the doc; e.g.,\n\n```diff\n-    - ``minpoly`` -- a polynomial in two variables, where the first variables\n-       corresponds to the base coordinate on the Riemann surface.\n-\n-    - ``z0`` -- complex number of infinity. The point about which to\n-      reparameterise.\n+    - ``minpoly`` -- a polynomial in two variables, where the first variables\n+       corresponds to the base coordinate on the Riemann surface\n+    - ``z0`` -- complex number of infinity; the point about which to\n+      reparameterize\n```\n\n```diff\n-        - ``upstairs_edge`` -- tuple. ``((z_start, sb), (z_end,))`` giving the\n-          start and end values of the base coordinate along the straight-line\n-          path and the starting branch.\n-\n-        - ``initial_continuation`` -- list (default: None).  Output of\n-          ``homotopy_continuation`` initialising the continuation data.\n+        - ``upstairs_edge`` -- tuple ``((z_start, sb), (z_end,))`` giving the\n+          start and end values of the base coordinate along the straight-line\n+          path and the starting branch\n+        - ``initial_continuation`` -- list (optional); output of\n+          ``homotopy_continuation`` initialising the continuation data\n```\n\nThis seems wasteful with creating the transient list:\n\n```python\n    dists = [(item-l).abs() for l in List]\n    return dists.index(min(dists))\n```\nAlthough probably implementing the check manually using a `for` loop might be slower because of Python's general speed.\n\nPEP8 and variable name:\n\n```diff\n-Inf = bool(z0==z0.parent()(Infinity))\n+is_inf = bool(z0 == z0.parent()(Infinity))\n```\nalthough I would normally expect `is_inf = (z0 == Infinity)` to work more generally because of coercion (maybe even be marginally faster).\n\n``self._dfdw`` -> ```self._dfdw```\n\n```diff\n-        ONE = self._RR(1)\n-        LAMBDA = self._RR.pi()/2\n+        one = self._RR.one()\n+        la = self._RR.pi() / 2\n```\n\nWhy is this a function:\n\n```python\n            def error_handle(out):\n                raise ConvergenceError(\"Newton iteration fails to converge\")\n```\nIt seems like everything you do when `error_handle` is set to this will result in an error. I think the code logic around this for `_integrate_differentials_iteratively` needs to be improved to make it clear when errors should happen (or at least provide some comments).\n\nSome general PEP8 stuff (like noted about) with spaces around various operators.\n\n```diff\n-if not K==QQ:\n+ if K is not QQ:\n```\n\nNot necessary, but it is faster:\n\n```diff\n-if D==0:\n+if not D:\n```\n(If not changed, PEP8 spacing around `==`.)\n\n```diff\n-            print(dl)\n-            raise ValueError(\"Numerical instability, list of wrong degree\")\n+            raise ValueError(\"numerical instability, list of wrong degree\")\n```\nIt is not good to print stuff (what if someone wants to catch this error then do something?) -- if you want to include it, then add it to the error message; we follow Python's convention for error messages starting with a lower case letter.\n\nI think this is faster:\n\n```diff\n-                        ys += [ny[0] for ny in nys]\n-                        rys += [(v*m*n, (r, y)) for y, n in nys]\n+                        ys.extend(ny[0] for ny in nys)\n+                        rys.extend((v*m*n, (r, y)) for y, n in nys)\n```\nat least it seems more explicitly to not create a temporary list to me.\n\nWhen returning something from a (public) ``@`cached_method`, it should be immutable. In particular, pass `immutable=True` to the graph constructor.\n\nNo need to build a transient list:\n\n```diff\n-            epsilon = min([abs(self._wvalues[i1][i] - self._wvalues[i1][n-j-1])\n-                           for i in range(n) for j in range(n-i-1)])/3\n+            val = self._wvalues[i1]\n+            epsilon = min(abs(val[i] - val[n-j-1])\n+                          for i in range(n) for j in range(n-i-1)) / 3\n```\nThis also avoids the additional lookups to `self._wvalues` (which while quick, they can really add up).\n\nI might have more later, but this should be most of them I think.",
    "created_at": "2022-08-31T00:31:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488748",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:52'></a>A bit [xkcd style commits](https://xkcd.com/1296/) there. `:P`

Some code comments (I don't know the math; I will leave that to Nils):

```diff
-the literature.::
+the literature::
```
as it displays as `the literature.:` in the compiled doc.

Spacing would be nice here (but not required): ``2D=K`::` -> ``2D = K`::`

```diff
     INPUT:
 
-    - ``item`` -- value to minimise the distance to over the list.
-
-    - ``List`` -- list. List to look for closest element in.
+    - ``item`` -- value to minimize the distance to over the list
+    - ``lst`` -- list to look for closest element in
```
We generally have American spelling within Sage doc; inputs items are generally not sentences; Python naming conventions say variable names should (generally) follow `lower_case`; and we should not use `list` as a variable. Similar changes elsewhere in the doc; e.g.,

```diff
-    - ``minpoly`` -- a polynomial in two variables, where the first variables
-       corresponds to the base coordinate on the Riemann surface.
-
-    - ``z0`` -- complex number of infinity. The point about which to
-      reparameterise.
+    - ``minpoly`` -- a polynomial in two variables, where the first variables
+       corresponds to the base coordinate on the Riemann surface
+    - ``z0`` -- complex number of infinity; the point about which to
+      reparameterize
```

```diff
-        - ``upstairs_edge`` -- tuple. ``((z_start, sb), (z_end,))`` giving the
-          start and end values of the base coordinate along the straight-line
-          path and the starting branch.
-
-        - ``initial_continuation`` -- list (default: None).  Output of
-          ``homotopy_continuation`` initialising the continuation data.
+        - ``upstairs_edge`` -- tuple ``((z_start, sb), (z_end,))`` giving the
+          start and end values of the base coordinate along the straight-line
+          path and the starting branch
+        - ``initial_continuation`` -- list (optional); output of
+          ``homotopy_continuation`` initialising the continuation data
```

This seems wasteful with creating the transient list:

```python
    dists = [(item-l).abs() for l in List]
    return dists.index(min(dists))
```
Although probably implementing the check manually using a `for` loop might be slower because of Python's general speed.

PEP8 and variable name:

```diff
-Inf = bool(z0==z0.parent()(Infinity))
+is_inf = bool(z0 == z0.parent()(Infinity))
```
although I would normally expect `is_inf = (z0 == Infinity)` to work more generally because of coercion (maybe even be marginally faster).

``self._dfdw`` -> ```self._dfdw```

```diff
-        ONE = self._RR(1)
-        LAMBDA = self._RR.pi()/2
+        one = self._RR.one()
+        la = self._RR.pi() / 2
```

Why is this a function:

```python
            def error_handle(out):
                raise ConvergenceError("Newton iteration fails to converge")
```
It seems like everything you do when `error_handle` is set to this will result in an error. I think the code logic around this for `_integrate_differentials_iteratively` needs to be improved to make it clear when errors should happen (or at least provide some comments).

Some general PEP8 stuff (like noted about) with spaces around various operators.

```diff
-if not K==QQ:
+ if K is not QQ:
```

Not necessary, but it is faster:

```diff
-if D==0:
+if not D:
```
(If not changed, PEP8 spacing around `==`.)

```diff
-            print(dl)
-            raise ValueError("Numerical instability, list of wrong degree")
+            raise ValueError("numerical instability, list of wrong degree")
```
It is not good to print stuff (what if someone wants to catch this error then do something?) -- if you want to include it, then add it to the error message; we follow Python's convention for error messages starting with a lower case letter.

I think this is faster:

```diff
-                        ys += [ny[0] for ny in nys]
-                        rys += [(v*m*n, (r, y)) for y, n in nys]
+                        ys.extend(ny[0] for ny in nys)
+                        rys.extend((v*m*n, (r, y)) for y, n in nys)
```
at least it seems more explicitly to not create a temporary list to me.

When returning something from a (public) ``@`cached_method`, it should be immutable. In particular, pass `immutable=True` to the graph constructor.

No need to build a transient list:

```diff
-            epsilon = min([abs(self._wvalues[i1][i] - self._wvalues[i1][n-j-1])
-                           for i in range(n) for j in range(n-i-1)])/3
+            val = self._wvalues[i1]
+            epsilon = min(abs(val[i] - val[n-j-1])
+                          for i in range(n) for j in range(n-i-1)) / 3
```
This also avoids the additional lookups to `self._wvalues` (which while quick, they can really add up).

I might have more later, but this should be most of them I think.



---

archive/issue_comments_488749.json:
```json
{
    "body": "<a id='comment:53'></a>Replying to [comment:52 tscrim]:\n> A bit [xkcd style commits](https://xkcd.com/1296/) there. `:P`\n\n:-? I thought that last commit fully documented the change that was made :-)\n\n> {{{\n> +    - ``minpoly`` -- a polynomial in two variables, where the first variables\n> +       corresponds to the base coordinate on the Riemann surface\n> +    - ``z0`` -- complex number of infinity; the point about which to\n> +      reparameterize\n> }}}\n\nAND `number of infinity` -> `number or infinity`\n\nThanks Travis!",
    "created_at": "2022-08-31T23:13:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488749",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:53'></a>Replying to [comment:52 tscrim]:
> A bit [xkcd style commits](https://xkcd.com/1296/) there. `:P`

:-? I thought that last commit fully documented the change that was made :-)

> {{{
> +    - ``minpoly`` -- a polynomial in two variables, where the first variables
> +       corresponds to the base coordinate on the Riemann surface
> +    - ``z0`` -- complex number of infinity; the point about which to
> +      reparameterize
> }}}

AND `number of infinity` -> `number or infinity`

Thanks Travis!



---

archive/issue_comments_488750.json:
```json
{
    "body": "<a id='comment:54'></a>Replying to [comment:53 nbruin]:\n\n> > {{{\n> > +    - ``minpoly`` -- a polynomial in two variables, where the first variables\n> > +       corresponds to the base coordinate on the Riemann surface\n> > +    - ``z0`` -- complex number of infinity; the point about which to\n> > +      reparameterize\n> > }}}\n\n> AND `number of infinity` -> `number or infinity`\n\nI was wondering about that, but I figured it was my na\u00efvet\u00e9 with the topic.\n\n> Thanks Travis!\n\n\nNo problem.",
    "created_at": "2022-09-01T09:14:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488750",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:54'></a>Replying to [comment:53 nbruin]:

> > {{{
> > +    - ``minpoly`` -- a polynomial in two variables, where the first variables
> > +       corresponds to the base coordinate on the Riemann surface
> > +    - ``z0`` -- complex number of infinity; the point about which to
> > +      reparameterize
> > }}}

> AND `number of infinity` -> `number or infinity`

I was wondering about that, but I figured it was my navet with the topic.

> Thanks Travis!


No problem.



---

archive/issue_comments_488751.json:
```json
{
    "body": "<a id='comment:56'></a>Think I addressed all the comments from Travis, anything I've missed?",
    "created_at": "2022-09-01T13:48:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488751",
    "user": "https://github.com/DisneyHogg"
}
```

<a id='comment:56'></a>Think I addressed all the comments from Travis, anything I've missed?



---

archive/issue_comments_488752.json:
```json
{
    "body": "<a id='comment:57'></a>The doc of `find_closest_element` is now wrong (`List` -> `lst`).\n\n`homotopy_continuation` and `simple_vector_line_integral` have a period at the end of their `INPUT:`. Many others (e.g., `_bounding_data`) also should be changed following my comment above.\n\nThere are still a lot of PEP8 spacing things to fix (in particular around operators).\n\nYou\u2019ve not addressed the `error_handle` question.",
    "created_at": "2022-09-01T23:09:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488752",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:57'></a>The doc of `find_closest_element` is now wrong (`List` -> `lst`).

`homotopy_continuation` and `simple_vector_line_integral` have a period at the end of their `INPUT:`. Many others (e.g., `_bounding_data`) also should be changed following my comment above.

There are still a lot of PEP8 spacing things to fix (in particular around operators).

Youve not addressed the `error_handle` question.



---

archive/issue_comments_488753.json:
```json
{
    "body": "<a id='comment:58'></a>Replying to [comment:57 tscrim]:\n\n> There are still a lot of PEP8 spacing things to fix (in particular around operators).\n\n\nTip for Linden: run the code through [black](https://black.readthedocs.io/en/stable/) and be done with it. It transfers all code-formatting taste questions to whatever the writer of `black` has converged on and the rule set there is fairly acceptable to quite a few people.\n\nI've just checked what it does to `riemann_surface.py` and it looks acceptable. It improves a bunch of formatting that's really hard to find otherwise. It does change a few things for the worse, but not to an unacceptable level to me (`a**2` is really better to me than `a ** 2`, but the latter can be what PEP-8 recommends) -- and it gets the PEP-8 crowd of your back! (that's the main design reason of black in the first place: to obviate the need for formatting style discussions)\n\n> You\u2019ve not addressed the `error_handle` question.\n\n\nI've looked at that and it seems like a reasonable coding solution to me. The alternative is to write out, in all four places where it's called:\n\n```\nif raise_error:\n    raise ConvergenceError(\"Newton iteration fails to converge\")\nelse:\n    outg.append(newg) #or whatever statement is required\n```\nYou can probably argue a long time about the merits and drawbacks of the different solutions (or the functionality in the first place), but given that it's used in four different places, I don't think it counts as egregiously bad/smart coding style. It could even be argued to be elegant.\n\nIn general, I'd be a little reticent in imposing coding styles on our contributors, so I'd leave it to the author in this case.\n\nOn option for reviewers would be, if they have trouble understanding the logic of code that may be acceptable, they could ask for additional comments on the mechanism? That could entice the author to abandon the apparently convoluted paradigm or at least lead to better documented code.",
    "created_at": "2022-09-02T00:23:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488753",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:58'></a>Replying to [comment:57 tscrim]:

> There are still a lot of PEP8 spacing things to fix (in particular around operators).


Tip for Linden: run the code through [black](https://black.readthedocs.io/en/stable/) and be done with it. It transfers all code-formatting taste questions to whatever the writer of `black` has converged on and the rule set there is fairly acceptable to quite a few people.

I've just checked what it does to `riemann_surface.py` and it looks acceptable. It improves a bunch of formatting that's really hard to find otherwise. It does change a few things for the worse, but not to an unacceptable level to me (`a**2` is really better to me than `a ** 2`, but the latter can be what PEP-8 recommends) -- and it gets the PEP-8 crowd of your back! (that's the main design reason of black in the first place: to obviate the need for formatting style discussions)

> Youve not addressed the `error_handle` question.


I've looked at that and it seems like a reasonable coding solution to me. The alternative is to write out, in all four places where it's called:

```
if raise_error:
    raise ConvergenceError("Newton iteration fails to converge")
else:
    outg.append(newg) #or whatever statement is required
```
You can probably argue a long time about the merits and drawbacks of the different solutions (or the functionality in the first place), but given that it's used in four different places, I don't think it counts as egregiously bad/smart coding style. It could even be argued to be elegant.

In general, I'd be a little reticent in imposing coding styles on our contributors, so I'd leave it to the author in this case.

On option for reviewers would be, if they have trouble understanding the logic of code that may be acceptable, they could ask for additional comments on the mechanism? That could entice the author to abandon the apparently convoluted paradigm or at least lead to better documented code.



---

archive/issue_comments_488754.json:
```json
{
    "body": "<a id='comment:59'></a>Replying to [comment:58 nbruin]:\n> Replying to [comment:57 tscrim]:\n> \n> > There are still a lot of PEP8 spacing things to fix (in particular around operators).\n\n>\n> (`a**2` is really better to me than `a ** 2`, but the latter can be what PEP-8 recommends)\n\n\nThis one really bugs me too.\n\nThere are some things where you don\u2019t need to add spaces; in particular, anytime you are not the out-most operator (which technically includes `()` and `[]` brackets). So something like `(x+y) * z` is fine by PEP8.\n\n> > You\u2019ve not addressed the `error_handle` question.\n\n> \n> I've looked at that and it seems like a reasonable coding solution to me. The alternative is to write out, in all four places where it's called:\n> \n> ```\n> if raise_error:\n>     raise ConvergenceError(\"Newton iteration fails to converge\")\n> else:\n>     outg.append(newg) #or whatever statement is required\n> ```\n> You can probably argue a long time about the merits and drawbacks of the different solutions (or the functionality in the first place), but given that it's used in four different places, I don't think it counts as egregiously bad/smart coding style. It could even be argued to be elegant.\n\n\nThe most confusing one for me is at the very end, when all of the computation is done, if `raise_error` is `True`, then you will just raise an error. It seems like the function should be doing something, but in one case it just raises an error, in the other it is an no-op. (The name is also misleading as it suggests that it is meant to handle an error.) Of course, it should never get to the end and return in the earlier `for` loop when `raise_errors=True`, but it is less clear that this is the intended behavior.\n\nAn unrelated thing, but you can use an `else:` statement after the `for` loop to handle the case when it runs through without an issue (this means less needless checks if you reach the end of the list).\n\n> In general, I'd be a little reticent in imposing coding styles on our contributors, so I'd leave it to the author in this case.\n\n\nI agree with this statement in general.\n\n> On option for reviewers would be, if they have trouble understanding the logic of code that may be acceptable, they could ask for additional comments on the mechanism? That could entice the author to abandon the apparently convoluted paradigm or at least lead to better documented code.\n\n\nIt would be nice to have some more comments for this.",
    "created_at": "2022-09-02T06:08:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488754",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:59'></a>Replying to [comment:58 nbruin]:
> Replying to [comment:57 tscrim]:
> 
> > There are still a lot of PEP8 spacing things to fix (in particular around operators).

>
> (`a**2` is really better to me than `a ** 2`, but the latter can be what PEP-8 recommends)


This one really bugs me too.

There are some things where you dont need to add spaces; in particular, anytime you are not the out-most operator (which technically includes `()` and `[]` brackets). So something like `(x+y) * z` is fine by PEP8.

> > Youve not addressed the `error_handle` question.

> 
> I've looked at that and it seems like a reasonable coding solution to me. The alternative is to write out, in all four places where it's called:
> 
> ```
> if raise_error:
>     raise ConvergenceError("Newton iteration fails to converge")
> else:
>     outg.append(newg) #or whatever statement is required
> ```
> You can probably argue a long time about the merits and drawbacks of the different solutions (or the functionality in the first place), but given that it's used in four different places, I don't think it counts as egregiously bad/smart coding style. It could even be argued to be elegant.


The most confusing one for me is at the very end, when all of the computation is done, if `raise_error` is `True`, then you will just raise an error. It seems like the function should be doing something, but in one case it just raises an error, in the other it is an no-op. (The name is also misleading as it suggests that it is meant to handle an error.) Of course, it should never get to the end and return in the earlier `for` loop when `raise_errors=True`, but it is less clear that this is the intended behavior.

An unrelated thing, but you can use an `else:` statement after the `for` loop to handle the case when it runs through without an issue (this means less needless checks if you reach the end of the list).

> In general, I'd be a little reticent in imposing coding styles on our contributors, so I'd leave it to the author in this case.


I agree with this statement in general.

> On option for reviewers would be, if they have trouble understanding the logic of code that may be acceptable, they could ask for additional comments on the mechanism? That could entice the author to abandon the apparently convoluted paradigm or at least lead to better documented code.


It would be nice to have some more comments for this.



---

archive/issue_comments_488755.json:
```json
{
    "body": "<a id='comment:60'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-04T15:10:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488755",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:60'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488756.json:
```json
{
    "body": "<a id='comment:61'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-04T15:26:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488756",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:61'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488757.json:
```json
{
    "body": "<a id='comment:62'></a>Added a bit more explanation about `raise_error` use at the end\n\n> (The name is also misleading as it suggests that it is meant to handle an error.) \n\n\nHappy to use another name if you have one in mind. The name was more to explain that in the event the function is called really a failure to converge has occurred, and so this should raise an error, unless the user explicitly gives the flag not to in which case the computation can continue.",
    "created_at": "2022-09-04T15:27:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488757",
    "user": "https://github.com/DisneyHogg"
}
```

<a id='comment:62'></a>Added a bit more explanation about `raise_error` use at the end

> (The name is also misleading as it suggests that it is meant to handle an error.) 


Happy to use another name if you have one in mind. The name was more to explain that in the event the function is called really a failure to converge has occurred, and so this should raise an error, unless the user explicitly gives the flag not to in which case the computation can continue.



---

archive/issue_comments_488758.json:
```json
{
    "body": "<a id='comment:63'></a>IMO the function should be something that takes no inputs named something list `check_raise_error()` that is called before you proceed. (At which point, I would wonder why not just put the `if` statement in directly.) The function doesn\u2019t do anything with its input, which is a code smell IMO. For example, would you find the argument in this function strange?\n\n```python\ndef two_two(foo):\n    return 2 + 2\n```\n(Of course, there can be reasons, mainly compatibility with other functions.) Another sign that something could be improved is that you have to have such a long comment to explain a short and simple function.\n\nAnyways, as Nils said, this is basically bikeshedding and I\u2019ve said my piece. It\u2019s not worth holding up your (very good) work over this.",
    "created_at": "2022-09-05T00:39:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488758",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:63'></a>IMO the function should be something that takes no inputs named something list `check_raise_error()` that is called before you proceed. (At which point, I would wonder why not just put the `if` statement in directly.) The function doesnt do anything with its input, which is a code smell IMO. For example, would you find the argument in this function strange?

```python
def two_two(foo):
    return 2 + 2
```
(Of course, there can be reasons, mainly compatibility with other functions.) Another sign that something could be improved is that you have to have such a long comment to explain a short and simple function.

Anyways, as Nils said, this is basically bikeshedding and Ive said my piece. Its not worth holding up your (very good) work over this.



---

archive/issue_comments_488759.json:
```json
{
    "body": "<a id='comment:64'></a>I guess Travis would rather not pass the argument through the (configurable) error handler, so you'd end up with\n\n```\n    outg.append( raise_convergence_error_if_requested() or newg)\n```\nwhere we have (if no error needs to be raised)\n\n```\n    def raise_convergence_error_if_requested():\n        return False\n```\nbut since `raise_convergence_error_if_requested` is only used in this phrase, it makes sense to define\n\n```\n    def raise_convergence_error_if_requested_or_return_value(out):\n        if raise_error:\n            raise ConvergenceError()\n        else\n            return out\n```\nand then you see that `raise_error` is constant per invocation, so you can pull the branching through the def. Indeed in the `raise_error` branch, the value of out isn't used, but that's due a refactoring operation. You could write `def ...(*args)` and then `return args[0]` to avoid the \"code smell\" (which is properly explained with the refactoring), but that is ugly in its own way.\n\nI guess one issue is that scoped function definitions aren't generally covered in a 1st year programming course, so if your target audience is people with an understanding of programming equivalent to that, they can probably not easily read your code. That would be one reason to only use such a refactoring when it gives you a clear advantage. In this case: if statements are quite fast in python, particularly for a variable like `raise_error` that ends up as a closure variable. Function calls, on the other hand, have a LOT of overhead. So the refactoring probably doesn't really save you much (it's not a time-critical code path anyway)\n\nI think the main draw-back of wrapping up the error raising in a function call is that it pollutes the backtrace: there's an extra level, so you have to look one level up to see the true raise location. So there's a benefit to not wrapping the raise at all (plus saving function call overhead -- in a non-time-critical path, though)\n\nOh and it looks like the branch needs rebasing.",
    "created_at": "2022-09-05T16:41:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488759",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:64'></a>I guess Travis would rather not pass the argument through the (configurable) error handler, so you'd end up with

```
    outg.append( raise_convergence_error_if_requested() or newg)
```
where we have (if no error needs to be raised)

```
    def raise_convergence_error_if_requested():
        return False
```
but since `raise_convergence_error_if_requested` is only used in this phrase, it makes sense to define

```
    def raise_convergence_error_if_requested_or_return_value(out):
        if raise_error:
            raise ConvergenceError()
        else
            return out
```
and then you see that `raise_error` is constant per invocation, so you can pull the branching through the def. Indeed in the `raise_error` branch, the value of out isn't used, but that's due a refactoring operation. You could write `def ...(*args)` and then `return args[0]` to avoid the "code smell" (which is properly explained with the refactoring), but that is ugly in its own way.

I guess one issue is that scoped function definitions aren't generally covered in a 1st year programming course, so if your target audience is people with an understanding of programming equivalent to that, they can probably not easily read your code. That would be one reason to only use such a refactoring when it gives you a clear advantage. In this case: if statements are quite fast in python, particularly for a variable like `raise_error` that ends up as a closure variable. Function calls, on the other hand, have a LOT of overhead. So the refactoring probably doesn't really save you much (it's not a time-critical code path anyway)

I think the main draw-back of wrapping up the error raising in a function call is that it pollutes the backtrace: there's an extra level, so you have to look one level up to see the true raise location. So there's a benefit to not wrapping the raise at all (plus saving function call overhead -- in a non-time-critical path, though)

Oh and it looks like the branch needs rebasing.



---

archive/issue_comments_488760.json:
```json
{
    "body": "<a id='comment:65'></a>That\u2019s a good point about the traceback from a user viewpoint, as I was thinking mostly as a developer reading the code on its own. Putting the `if` statement in the function would alleviate this as it would be clear that there was a logic statement involved. It would also dissipate the code smell as well.\n\nThe rebase needs to be done before I do a final check.",
    "created_at": "2022-09-07T04:30:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488760",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:65'></a>Thats a good point about the traceback from a user viewpoint, as I was thinking mostly as a developer reading the code on its own. Putting the `if` statement in the function would alleviate this as it would be clear that there was a logic statement involved. It would also dissipate the code smell as well.

The rebase needs to be done before I do a final check.



---

archive/issue_comments_488761.json:
```json
{
    "body": "<a id='comment:66'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-07T09:12:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488761",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:66'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488762.json:
```json
{
    "body": "<a id='comment:67'></a>Rebased, and edited to use separate `if` statements at each point where `error_handle` was being used previously. All tox checks passing.",
    "created_at": "2022-09-07T09:13:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488762",
    "user": "https://github.com/DisneyHogg"
}
```

<a id='comment:67'></a>Rebased, and edited to use separate `if` statements at each point where `error_handle` was being used previously. All tox checks passing.



---

archive/issue_comments_488763.json:
```json
{
    "body": "<a id='comment:68'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-07T10:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488763",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:68'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488764.json:
```json
{
    "body": "<a id='comment:69'></a>Thank you for the changes. Just a few last little things:\n\nTo make it a little more readable and nicer display (to me, so you can ignore the ones you disagree with):\n\n```diff\n-    On the curve given by `w^2-z^3+1=0`, we have differential\n+    On the curve given by `w^2 - z^3 + 1 = 0`, we have differential\n     `\\frac{dz}{2w} = \\frac{dz}{2\\sqrt{z^3-1}}`\n-    with minimal polynomial `g^2(z^3-1)-1/4=0`. We can make the substitution\n-    `\\bar{z}=z^{-1}` to parameterise the differential about `z=\\Infty` as\n-    `\\frac{-\\bar{z}^{-2} d\\bar{z}}{2\\sqrt{\\bar{z}^{-3}-1}} = \\frac{-d\\bar{z}}{2\\sqrt{\\bar{z}(1-\\bar{z}^3)}}`.\n+    with minimal polynomial `g^2(z^3-1) - 1/4 = 0`. We can make the substitution\n+    `\\bar{z} = z^{-1}` to parameterize the differential about `z = \\infty` as\n+\n+    .. MATH::\n+\n+        \\frac{-\\bar{z}^{-2} d\\bar{z}}{2\\sqrt{\\bar{z}^{-3} - 1}} = \\frac{-d\\bar{z}}{2\\sqrt{\\bar{z} (1 - \\bar{z}^3)}}.\n+\n     Hence the transformed differential should have minimal polynomial\n-    `\\bar{g}^2\\bar{z}(1-\\bar{z}^3)-1/4=0`, and we can check this::\n+    `\\bar{g}^2 \\bar{z} (1 - \\bar{z}^3) - 1/4 = 0`, and we can check this::\n```\n\nPEP8:\n\n```diff\n-        sage: reparameterize_differential_minpoly(minpoly, 0)(*minpoly.parent().gens())==minpoly\n+        sage: reparameterize_differential_minpoly(minpoly, 0)(*minpoly.parent().gens()) == minpoly\n         True\n```\n\n```diff\n-        sage: q = 1/10\n-        sage: f = y^2-(x^2-2*x+1+q^2)*(x^2+2*x+1+q^2)\n+        sage: q = 1 / 10\n+        sage: f = y^2 - (x^2 - 2*x + 1 + q^2) * (x^2 + 2*x + 1 + q^2)\n         sage: p = 500\n```\n\nPEP8 allows things like this:\n\n```diff\n-        mt = F(minpoly(F.gen(0) ** (-1), -F.gen(0) ** (+2) * F.gen(1)))\n+        mt = F(minpoly(F.gen(0)**(-1), -F.gen(0)**2 * F.gen(1)))\n```\n\nThis test is either worthless or extremely brittle:\n\n```\n         sage: ct2/ct1  # random\n         0.19453288941244148\n```\nMarking it as random doesn't mean much to a user (your documentation already does that) or as a test (to a developer checking for regressions). Now you could test that this was `< 1` if you mark it `# long time`, but depends on system load. I would just get rid of the timing aspects of this and just do\n\n```\n        sage: q = 1 / 10\n        sage: f = y^2 - (x^2 - 2*x + 1 + q^2) * (x^2 + 2*x + 1 + q^2)\n        sage: p = 500\n        sage: Sh = RiemannSurface(f, prec=p, integration_method='heuristic')\n        sage: Sr = RiemannSurface(f, prec=p, integration_method='rigorous')\n        sage: Rh = Sh.riemann_matrix()  # long time (8 seconds)\n        sage: nodes.cache.clear()\n        sage: Rr = Sr.riemann_matrix()  # long time (1 seconds)\n```\n\nTrivial thing: Your last argument in `def __init__(` has a comma.\n\n```diff\n+        if not (integration_method == \"heuristic\" or integration_method == \"rigorous\"):\n-            raise ValueError(\"Invalid integration method\")\n+            raise ValueError(\"invalid integration method\")\n         self._integration_method = integration_method\n         self._R = f.parent()\n         if len(self._R.gens()) != 2:\n-            raise ValueError(\"only bivariate polynomials supported.\")\n+            raise ValueError('only bivariate polynomials supported')\n         if f.degree() <= 1:\n-            raise ValueError(\"equation must be of degree at least 2.\")\n+            raise ValueError('equation must be of degree at least 2')\n```\n(The last two are reverting to what was there before.)\n\nIt is okay to have things longer than 80 chars/line, especially when it significantly improves readability:\n\n```diff\n-            self.branch_locus += self._CCz(fac(self._CCz.gen(), 0)).roots(\n-                multiplicities=False\n-            )\n+            self.branch_locus += self._CCz(fac(self._CCz.gen(), 0)).roots(multiplicities=False)\n```\nI also find this more readable before:\n\n```diff\n-            epsilon = (\n-                min([abs(currw[i] - currw[j]) for i in range(1, n) for j in range(i)])\n-                / 3\n-            )\n+            epsilon = min(abs(currw[i] - currw[j]) for i in range(1,n) for j in range(i)) / 3\n```\n(Note also the remove of the unnecessary inner list and the PEP8 space around `/`.)\nSimilarly\n\n```diff\n-        loops = [\n-            self.voronoi_diagram.regions[i][:]\n-            for i in self.voronoi_diagram.point_region\n-        ]\n+        loops = [self.voronoi_diagram.regions[i][:]\n+                 for i in self.voronoi_diagram.point_region]\n```\nThere are lots of these (some of this might be my C++ background and wanting to think of them as code blocks).\n\n```diff\n         - ``edge`` -- a tuple ``(z_start, z_end)`` indicating the straight line\n-          over which to perform the homotopy continutation.\n+          over which to perform the homotopy continutation\n```\n\n```diff\n-        - ``exact`` -- logical (default: False). Whether to return the minimal\n-          polynomials over the exact base ring, or whether to return them over\n-          ``self._CC``.\n+        - ``exact`` -- boolean (default: ``False``); whether to return the\n+          minimal polynomials over the exact base ring or over ``self._CC``\n```\n\n```diff\n     def curve(self):\n         r\"\"\"\n-        Return the curve from which this Riemann surface is obtained\n+        Return the curve from which this Riemann surface is obtained.\n```\n\n```diff\n         - ``divisor`` -- an element of ``Curve(self.f).function_field().divisor_group()``\n-\n-        - ``S`` -- list. A list of places to avoid.\n+        - ``S`` -- list of places to avoid\n```\n\nOf course, it probably isn't worth too much of your time to change too many of these code readability things. It just creates a much larger diff that makes it harder to see what changes you made for this ticket. However, it isn't code I particularly care about (or expect to read/maintain much). So I think you can feel free to ignore many of those comments.",
    "created_at": "2022-09-08T01:35:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488764",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:69'></a>Thank you for the changes. Just a few last little things:

To make it a little more readable and nicer display (to me, so you can ignore the ones you disagree with):

```diff
-    On the curve given by `w^2-z^3+1=0`, we have differential
+    On the curve given by `w^2 - z^3 + 1 = 0`, we have differential
     `\frac{dz}{2w} = \frac{dz}{2\sqrt{z^3-1}}`
-    with minimal polynomial `g^2(z^3-1)-1/4=0`. We can make the substitution
-    `\bar{z}=z^{-1}` to parameterise the differential about `z=\Infty` as
-    `\frac{-\bar{z}^{-2} d\bar{z}}{2\sqrt{\bar{z}^{-3}-1}} = \frac{-d\bar{z}}{2\sqrt{\bar{z}(1-\bar{z}^3)}}`.
+    with minimal polynomial `g^2(z^3-1) - 1/4 = 0`. We can make the substitution
+    `\bar{z} = z^{-1}` to parameterize the differential about `z = \infty` as
+
+    .. MATH::
+
+        \frac{-\bar{z}^{-2} d\bar{z}}{2\sqrt{\bar{z}^{-3} - 1}} = \frac{-d\bar{z}}{2\sqrt{\bar{z} (1 - \bar{z}^3)}}.
+
     Hence the transformed differential should have minimal polynomial
-    `\bar{g}^2\bar{z}(1-\bar{z}^3)-1/4=0`, and we can check this::
+    `\bar{g}^2 \bar{z} (1 - \bar{z}^3) - 1/4 = 0`, and we can check this::
```

PEP8:

```diff
-        sage: reparameterize_differential_minpoly(minpoly, 0)(*minpoly.parent().gens())==minpoly
+        sage: reparameterize_differential_minpoly(minpoly, 0)(*minpoly.parent().gens()) == minpoly
         True
```

```diff
-        sage: q = 1/10
-        sage: f = y^2-(x^2-2*x+1+q^2)*(x^2+2*x+1+q^2)
+        sage: q = 1 / 10
+        sage: f = y^2 - (x^2 - 2*x + 1 + q^2) * (x^2 + 2*x + 1 + q^2)
         sage: p = 500
```

PEP8 allows things like this:

```diff
-        mt = F(minpoly(F.gen(0) ** (-1), -F.gen(0) ** (+2) * F.gen(1)))
+        mt = F(minpoly(F.gen(0)**(-1), -F.gen(0)**2 * F.gen(1)))
```

This test is either worthless or extremely brittle:

```
         sage: ct2/ct1  # random
         0.19453288941244148
```
Marking it as random doesn't mean much to a user (your documentation already does that) or as a test (to a developer checking for regressions). Now you could test that this was `< 1` if you mark it `# long time`, but depends on system load. I would just get rid of the timing aspects of this and just do

```
        sage: q = 1 / 10
        sage: f = y^2 - (x^2 - 2*x + 1 + q^2) * (x^2 + 2*x + 1 + q^2)
        sage: p = 500
        sage: Sh = RiemannSurface(f, prec=p, integration_method='heuristic')
        sage: Sr = RiemannSurface(f, prec=p, integration_method='rigorous')
        sage: Rh = Sh.riemann_matrix()  # long time (8 seconds)
        sage: nodes.cache.clear()
        sage: Rr = Sr.riemann_matrix()  # long time (1 seconds)
```

Trivial thing: Your last argument in `def __init__(` has a comma.

```diff
+        if not (integration_method == "heuristic" or integration_method == "rigorous"):
-            raise ValueError("Invalid integration method")
+            raise ValueError("invalid integration method")
         self._integration_method = integration_method
         self._R = f.parent()
         if len(self._R.gens()) != 2:
-            raise ValueError("only bivariate polynomials supported.")
+            raise ValueError('only bivariate polynomials supported')
         if f.degree() <= 1:
-            raise ValueError("equation must be of degree at least 2.")
+            raise ValueError('equation must be of degree at least 2')
```
(The last two are reverting to what was there before.)

It is okay to have things longer than 80 chars/line, especially when it significantly improves readability:

```diff
-            self.branch_locus += self._CCz(fac(self._CCz.gen(), 0)).roots(
-                multiplicities=False
-            )
+            self.branch_locus += self._CCz(fac(self._CCz.gen(), 0)).roots(multiplicities=False)
```
I also find this more readable before:

```diff
-            epsilon = (
-                min([abs(currw[i] - currw[j]) for i in range(1, n) for j in range(i)])
-                / 3
-            )
+            epsilon = min(abs(currw[i] - currw[j]) for i in range(1,n) for j in range(i)) / 3
```
(Note also the remove of the unnecessary inner list and the PEP8 space around `/`.)
Similarly

```diff
-        loops = [
-            self.voronoi_diagram.regions[i][:]
-            for i in self.voronoi_diagram.point_region
-        ]
+        loops = [self.voronoi_diagram.regions[i][:]
+                 for i in self.voronoi_diagram.point_region]
```
There are lots of these (some of this might be my C++ background and wanting to think of them as code blocks).

```diff
         - ``edge`` -- a tuple ``(z_start, z_end)`` indicating the straight line
-          over which to perform the homotopy continutation.
+          over which to perform the homotopy continutation
```

```diff
-        - ``exact`` -- logical (default: False). Whether to return the minimal
-          polynomials over the exact base ring, or whether to return them over
-          ``self._CC``.
+        - ``exact`` -- boolean (default: ``False``); whether to return the
+          minimal polynomials over the exact base ring or over ``self._CC``
```

```diff
     def curve(self):
         r"""
-        Return the curve from which this Riemann surface is obtained
+        Return the curve from which this Riemann surface is obtained.
```

```diff
         - ``divisor`` -- an element of ``Curve(self.f).function_field().divisor_group()``
-
-        - ``S`` -- list. A list of places to avoid.
+        - ``S`` -- list of places to avoid
```

Of course, it probably isn't worth too much of your time to change too many of these code readability things. It just creates a much larger diff that makes it harder to see what changes you made for this ticket. However, it isn't code I particularly care about (or expect to read/maintain much). So I think you can feel free to ignore many of those comments.



---

archive/issue_comments_488765.json:
```json
{
    "body": "<a id='comment:70'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-08T12:24:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488765",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:70'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488766.json:
```json
{
    "body": "<a id='comment:71'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-09T10:17:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488766",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:71'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488767.json:
```json
{
    "body": "<a id='comment:72'></a>Now passing all checks, remaining errors in Lint are from different modules, ready to be reviewed and accepted.",
    "created_at": "2022-09-12T16:38:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488767",
    "user": "https://github.com/DisneyHogg"
}
```

<a id='comment:72'></a>Now passing all checks, remaining errors in Lint are from different modules, ready to be reviewed and accepted.



---

archive/issue_comments_488768.json:
```json
{
    "body": "<a id='comment:73'></a>Honestly, I am not sure you fully understand the PEP8 style guidelines as you have introduced some violations of it with your readability changes (nor do they fix some of the IMO most egregious things in pursuit of 80 chars/line, which should not be viewed so strictly, especially nowadays). However, it\u2019s not such a big deal for me, and if Nils is fine with them, then we can make this a positive review.\n\nOne question, is #32289 actually a dependency? You have a discrepancy between the ticket description and the listed dependencies.",
    "created_at": "2022-09-12T23:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488768",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:73'></a>Honestly, I am not sure you fully understand the PEP8 style guidelines as you have introduced some violations of it with your readability changes (nor do they fix some of the IMO most egregious things in pursuit of 80 chars/line, which should not be viewed so strictly, especially nowadays). However, its not such a big deal for me, and if Nils is fine with them, then we can make this a positive review.

One question, is #32289 actually a dependency? You have a discrepancy between the ticket description and the listed dependencies.



---

archive/issue_comments_488769.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n+This ticket will add the functionality of an Abel-Jacobi map method to Riemann surfaces, and in doing so add some necessary additional functionality (such as the ability to reduce a vector over the period lattice).\n \n+In cases where improper integrals arise, a double-exponential quadrature gets used. Contrary to the Gauss-Legendre integrator that is normally used, this is not a rigorous one. Future versions should probably use a series expansion at the problematic point and then optimize the radius to be used between cost of series expansion and Gauss-Legendre (with path splitting).\n \n Type: PLEASE CHANGE\n \n```\n",
    "created_at": "2022-09-13T01:12:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488769",
    "user": "https://github.com/nbruin"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,6 @@
+This ticket will add the functionality of an Abel-Jacobi map method to Riemann surfaces, and in doing so add some necessary additional functionality (such as the ability to reduce a vector over the period lattice).
 
+In cases where improper integrals arise, a double-exponential quadrature gets used. Contrary to the Gauss-Legendre integrator that is normally used, this is not a rigorous one. Future versions should probably use a series expansion at the problematic point and then optimize the radius to be used between cost of series expansion and Gauss-Legendre (with path splitting).
 
 Type: PLEASE CHANGE
 
```




---

archive/issue_comments_488770.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-09-13T01:12:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488770",
    "user": "https://github.com/nbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_488771.json:
```json
{
    "body": "<a id='comment:74'></a>Cool! The line I remember best from PEP-8 is \"A Foolish Consistency is the Hobgoblin of Little Minds\", so ... fine with me! I think at this point we're better off with the code and it is in an eminently readable form, where further moving of whitespace is not going to make a considerable difference in maintainability. For perfect compliance, we should just run it through \"black\".",
    "created_at": "2022-09-13T01:12:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488771",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:74'></a>Cool! The line I remember best from PEP-8 is "A Foolish Consistency is the Hobgoblin of Little Minds", so ... fine with me! I think at this point we're better off with the code and it is in an eminently readable form, where further moving of whitespace is not going to make a considerable difference in maintainability. For perfect compliance, we should just run it through "black".



---

archive/issue_comments_488772.json:
```json
{
    "body": "<a id='comment:75'></a>Cheers for the positive review, Travis perhaps if code style may slow down other tickets in the future, is it worth us opening a ticket in order to add more detail to https://doc.sagemath.org/html/en/developer/coding_basics.html, maybe linking to black or some other python code formatter?",
    "created_at": "2022-09-13T08:17:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488772",
    "user": "https://github.com/DisneyHogg"
}
```

<a id='comment:75'></a>Cheers for the positive review, Travis perhaps if code style may slow down other tickets in the future, is it worth us opening a ticket in order to add more detail to https://doc.sagemath.org/html/en/developer/coding_basics.html, maybe linking to black or some other python code formatter?



---

archive/issue_comments_488773.json:
```json
{
    "body": "<a id='comment:76'></a>Well, most of it is located right there with more detailed in the (albeit slightly long) PEP8 link.\n\nIt is one of those things that getting into the coding style habits makes it go a lot faster.\n\nWhen I first started out, I complained about not being able to put any comments signifying the end of code blocks. I had to remove them all, even though I had a few 7 deep nests of functions, for-loops, and if-statements dropping back many steps. It was really very helpful to have them, and I wish they could have stayed. I really dislike Python\u2019s lack of brackets\u2026",
    "created_at": "2022-09-13T11:43:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488773",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:76'></a>Well, most of it is located right there with more detailed in the (albeit slightly long) PEP8 link.

It is one of those things that getting into the coding style habits makes it go a lot faster.

When I first started out, I complained about not being able to put any comments signifying the end of code blocks. I had to remove them all, even though I had a few 7 deep nests of functions, for-loops, and if-statements dropping back many steps. It was really very helpful to have them, and I wish they could have stayed. I really dislike Pythons lack of brackets



---

archive/issue_events_085652.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32297#event-85652"
}
```



---

archive/issue_events_085653.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32297#event-85653"
}
```



---

archive/issue_comments_488774.json:
```json
{
    "body": "<a id='comment:78'></a>Merge failure on top of:\n\n12756f654c7 Trac #29619: Matrix and Components should have a sparse iterator\n\ncb51da16e9b Trac #17965: Uniformize the API to compute the inverse of an element\n\na833b0e9c81 Trac #34491: Upgrade igraph to 0.9.10\n\n7747f43b0d1 Trac #34467: fix random doctest failure in EllipticCurveHom_velusqrt\n\ncba244ef373 Trac #34466: fix various linter errors\n\n5d89d36f1f9 Trac #34228: tox -e docker-...-incremental\n\n627b2bdfe92 Updated [SageMath](SageMath) version to 9.7\n\n\n\nreviewer '' does not look right",
    "created_at": "2022-09-19T22:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488774",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:78'></a>Merge failure on top of:

12756f654c7 Trac #29619: Matrix and Components should have a sparse iterator

cb51da16e9b Trac #17965: Uniformize the API to compute the inverse of an element

a833b0e9c81 Trac #34491: Upgrade igraph to 0.9.10

7747f43b0d1 Trac #34467: fix random doctest failure in EllipticCurveHom_velusqrt

cba244ef373 Trac #34466: fix various linter errors

5d89d36f1f9 Trac #34228: tox -e docker-...-incremental

627b2bdfe92 Updated [SageMath](SageMath) version to 9.7



reviewer '' does not look right



---

archive/issue_comments_488775.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-09-19T22:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488775",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_488776.json:
```json
{
    "body": "<a id='comment:79'></a>`@`linden: you got caught in Volker's merge queue: he's working on a branch that's not quite available. Eventually his queue will be pushed an be available as a `develop` and then you can rebase. I don't think a good solution for this lag has been found yet.\n\n`@`travis: I guess the reviewer field needs to be filled in. Given the history on the ticket I assume it's OK if your name is entered there? You did a lot of checking and gave a lot of feedback to get this ticket into shape. Ideally you'd fill it in yourself :-).",
    "created_at": "2022-09-19T23:38:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488776",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:79'></a>`@`linden: you got caught in Volker's merge queue: he's working on a branch that's not quite available. Eventually his queue will be pushed an be available as a `develop` and then you can rebase. I don't think a good solution for this lag has been found yet.

`@`travis: I guess the reviewer field needs to be filled in. Given the history on the ticket I assume it's OK if your name is entered there? You did a lot of checking and gave a lot of feedback to get this ticket into shape. Ideally you'd fill it in yourself :-).



---

archive/issue_comments_488777.json:
```json
{
    "body": "<a id='comment:80'></a>Done.",
    "created_at": "2022-09-20T02:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488777",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:80'></a>Done.



---

archive/issue_comments_488778.json:
```json
{
    "body": "<a id='comment:81'></a>Actually, it looks like the sole reason for the \"Merge Failure\" was \"reviewer does not look right\". That's been fixed now, so putting it back to positive review.",
    "created_at": "2022-09-21T20:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488778",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:81'></a>Actually, it looks like the sole reason for the "Merge Failure" was "reviewer does not look right". That's been fixed now, so putting it back to positive review.



---

archive/issue_comments_488779.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2022-09-21T20:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488779",
    "user": "https://github.com/nbruin"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_488780.json:
```json
{
    "body": "<a id='comment:82'></a>Replying to [comment:79 Nils Bruin]:\n\nThanks for looking at this, if the ticket needs any more work do highlight it to me, but it seems to all be ok now",
    "created_at": "2022-09-22T09:04:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488780",
    "user": "https://github.com/DisneyHogg"
}
```

<a id='comment:82'></a>Replying to [comment:79 Nils Bruin]:

Thanks for looking at this, if the ticket needs any more work do highlight it to me, but it seems to all be ok now



---

archive/issue_comments_488781.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-09-25T16:34:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32297#issuecomment-488781",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_085654.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-09-25T16:34:24Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32297",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32297#event-85654"
}
```
