# Issue 32414: Meta-ticket: New modules providing abstract base classes to enable modularization

archive/issues_032177.json:
```json
{
    "body": "`git grep 'import.* is_[A-Z]'` (or `git grep 'import.*is_[A-Z]' | grep -E -v 'is_(Ring|Matrix)[^A-Z]'  | grep -v 'sage:'`) reveals a common pattern in our code: We import a module just to check whether a user-provided object belongs to a class defined by that module.\nThis pattern is an obstacle to modularization.\n\nThe ongoing effort (#12824, https://groups.google.com/g/sage-devel/c/wEzb0awmyN0, #13370, #14329, #15076, #15098, #15333, #18173, #24443, #24525, #27593, #28470, #32347) to replace this pattern by importing the class and `isinstance` does not help in this regard:\nThe module providing the class must be installed so that the import does not fail.\n\nThis can of course be worked around by `try... except` around `import`, as done for example in #32455, but we should avoid cluttering the code with this type of workaround.\n\nInstead we propose to create stub classes (abstract base classes) in `sage.structure.element`, `sage.structure.parent`, and/or `sage.PAC.KAGE.abc`, and make the actual implementation classes subclasses (mostly, unique direct subclasses). This pattern already exists in the Sage code for a few existing classes:\n- `sage.structure.element` defines a base class `Matrix` (for purposes of the coercion system) and a function `is_Matrix` (see #32347)\n- `sage.structure.parent` defines a base class `Set_generic`; using it with `isinstance` has replaced use of the earlier `is_Set` function (#24443, #28470)\n\nWe add the following new classes:\n- #32566/#32610/#32612: `sage.rings.abc` defines base class `RealDoubleField` for `sage.rings.real_double.RealDoubleField_class` etc.\n\n- #32606: Replace `is_IntegerModRing` by `isinstance` with new class `sage.rings.abc.IntegerModRing`\n\n- #32660: Add `sage.rings.abc.AlgebraicField` etc., deprecate `is_AlgebraicField`\n\n- #32750: `sage.rings.abc`: Add `pAdicRing`, `pAdicField`; deprecate `is_pAdic...`\n\n- #32638/#32665: in `sage.structure.element`, a class `Expression`\n  - the existing class `sage.symbolic.expression.Expression` will be its only subclass\n  - deprecate `is_Expression`, `is_SymbolicEquation`, `is_CallableSymbolicExpression`, `is_SymbolicVariable`; replace uses by `isinstance(x, Expression)` and a method call (may need a new method `is_callable`)\n\n- #32637: in `sage.geometry.abc`, a class `Polyhedron`\n  - `Polyhedron_base` will be its only direct subclass\n\n- #32709: `sage.structure.element`: Add ABCs `Polynomial`, `MPolynomial` for `isinstance` testing\n\n- #34804 Deprecate `sage.interfaces` `is_...Element` functions\n\n- #32664 Deprecate `is_FiniteField`, make `sage.rings.finite_rings` a namespace package\n\n\nTechnical limitation: If a `sage.PAC.KAGE.abc` module is intended to provide the new classes, then `sage.PAC.KAGE` must be prepared to become a native namespace package. (See Meta-ticket #32501: Clear out `__init__.py` files in preparation for namespace packages)\n\nAs of this ticket, **each of the new abstract base classes is intended to have a unique direct implementation subclass.** #32637 adds doctests to document and enforce this design. Attempting to define new hierarchies of abstract base classes is beyond the scope of this ticket. Also, the new classes do not define any methods.\n\nTickets not needed for modularization, but removing `is_` functions in favor of `isinstance` for uniformity of the codebase:\n- #32738 Deprecate `is_Algebra`, `is_FreeAlgebra`, `is_QuaternionAlgebra`, `is_SymmetricFunctionAlgebra`\n- #34307 Deprecate `is_Polyhedron`, `is_Cone`, `is_LatticePolytope`\n\n\n\nCC:  @tscrim @fchapoton @kliem\n\nStatus: new\n\nIssue created by migration from https://trac.sagemath.org/ticket/32414\n\n",
    "created_at": "2021-08-24T18:41:40Z",
    "labels": [
        "component: refactoring"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Meta-ticket: New modules providing abstract base classes to enable modularization",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32414",
    "user": "https://github.com/mkoeppe"
}
```
`git grep 'import.* is_[A-Z]'` (or `git grep 'import.*is_[A-Z]' | grep -E -v 'is_(Ring|Matrix)[^A-Z]'  | grep -v 'sage:'`) reveals a common pattern in our code: We import a module just to check whether a user-provided object belongs to a class defined by that module.
This pattern is an obstacle to modularization.

The ongoing effort (#12824, https://groups.google.com/g/sage-devel/c/wEzb0awmyN0, #13370, #14329, #15076, #15098, #15333, #18173, #24443, #24525, #27593, #28470, #32347) to replace this pattern by importing the class and `isinstance` does not help in this regard:
The module providing the class must be installed so that the import does not fail.

This can of course be worked around by `try... except` around `import`, as done for example in #32455, but we should avoid cluttering the code with this type of workaround.

Instead we propose to create stub classes (abstract base classes) in `sage.structure.element`, `sage.structure.parent`, and/or `sage.PAC.KAGE.abc`, and make the actual implementation classes subclasses (mostly, unique direct subclasses). This pattern already exists in the Sage code for a few existing classes:
- `sage.structure.element` defines a base class `Matrix` (for purposes of the coercion system) and a function `is_Matrix` (see #32347)
- `sage.structure.parent` defines a base class `Set_generic`; using it with `isinstance` has replaced use of the earlier `is_Set` function (#24443, #28470)

We add the following new classes:
- #32566/#32610/#32612: `sage.rings.abc` defines base class `RealDoubleField` for `sage.rings.real_double.RealDoubleField_class` etc.

- #32606: Replace `is_IntegerModRing` by `isinstance` with new class `sage.rings.abc.IntegerModRing`

- #32660: Add `sage.rings.abc.AlgebraicField` etc., deprecate `is_AlgebraicField`

- #32750: `sage.rings.abc`: Add `pAdicRing`, `pAdicField`; deprecate `is_pAdic...`

- #32638/#32665: in `sage.structure.element`, a class `Expression`
  - the existing class `sage.symbolic.expression.Expression` will be its only subclass
  - deprecate `is_Expression`, `is_SymbolicEquation`, `is_CallableSymbolicExpression`, `is_SymbolicVariable`; replace uses by `isinstance(x, Expression)` and a method call (may need a new method `is_callable`)

- #32637: in `sage.geometry.abc`, a class `Polyhedron`
  - `Polyhedron_base` will be its only direct subclass

- #32709: `sage.structure.element`: Add ABCs `Polynomial`, `MPolynomial` for `isinstance` testing

- #34804 Deprecate `sage.interfaces` `is_...Element` functions

- #32664 Deprecate `is_FiniteField`, make `sage.rings.finite_rings` a namespace package


Technical limitation: If a `sage.PAC.KAGE.abc` module is intended to provide the new classes, then `sage.PAC.KAGE` must be prepared to become a native namespace package. (See Meta-ticket #32501: Clear out `__init__.py` files in preparation for namespace packages)

As of this ticket, **each of the new abstract base classes is intended to have a unique direct implementation subclass.** #32637 adds doctests to document and enforce this design. Attempting to define new hierarchies of abstract base classes is beyond the scope of this ticket. Also, the new classes do not define any methods.

Tickets not needed for modularization, but removing `is_` functions in favor of `isinstance` for uniformity of the codebase:
- #32738 Deprecate `is_Algebra`, `is_FreeAlgebra`, `is_QuaternionAlgebra`, `is_SymmetricFunctionAlgebra`
- #34307 Deprecate `is_Polyhedron`, `is_Cone`, `is_LatticePolytope`



CC:  @tscrim @fchapoton @kliem

Status: new

Issue created by migration from https://trac.sagemath.org/ticket/32414





---

archive/issue_comments_459011.json:
```json
{
    "body": "<a id='comment:1'></a>I find this in general bothering that there are tons of modules etc. being imported (even at startup), just because some `isinstance` check.\n\n- The best I can come up with for the second is the following:\n\n```\n_Polyhedron_base = None\n\nclass _dummy:\n    pass\n\ndef is_polyhedron(P):\n    global _Polyhedron_base\n    if _Polyhedron_base is not None:\n        return isinstance(P, _Polyhedron_base)\n    try:\n        from sage.geometry.polyhedron.base import Polyhedron_base\n        _Polyhedron_base = Polyhedron_base\n        return isinstance(P, Polyhedron_base)\n    except ImportError:\n        _Polyhedron_base = _dummy\n        return False\n```\n\n  Apparently its a slow down of about 50 percent, when the import is found, otherwise much more.\n\n- The first thing is even faster (`isinstance(P, Polyhedron_containment_check)` is about 75 percent of `isinstance(P, Polyhedron_base)`), but I don't know how much another stupid inheritance slows down the actual class.\n\n  I would prefer a unique name scheme that can be used throughout sage. `_base` is already in use. Could as well be the original class name with a leading underscore to discourage people to use it for anything else, e.g. `_Polyhedron_base`, `_Expression`.",
    "created_at": "2021-08-24T21:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32414#issuecomment-459011",
    "user": "https://github.com/kliem"
}
```

<a id='comment:1'></a>I find this in general bothering that there are tons of modules etc. being imported (even at startup), just because some `isinstance` check.

- The best I can come up with for the second is the following:

```
_Polyhedron_base = None

class _dummy:
    pass

def is_polyhedron(P):
    global _Polyhedron_base
    if _Polyhedron_base is not None:
        return isinstance(P, _Polyhedron_base)
    try:
        from sage.geometry.polyhedron.base import Polyhedron_base
        _Polyhedron_base = Polyhedron_base
        return isinstance(P, Polyhedron_base)
    except ImportError:
        _Polyhedron_base = _dummy
        return False
```

  Apparently its a slow down of about 50 percent, when the import is found, otherwise much more.

- The first thing is even faster (`isinstance(P, Polyhedron_containment_check)` is about 75 percent of `isinstance(P, Polyhedron_base)`), but I don't know how much another stupid inheritance slows down the actual class.

  I would prefer a unique name scheme that can be used throughout sage. `_base` is already in use. Could as well be the original class name with a leading underscore to discourage people to use it for anything else, e.g. `_Polyhedron_base`, `_Expression`.



---

archive/issue_comments_459012.json:
```json
{
    "body": "<a id='comment:6'></a>Thanks for these thoughts and experiments. I also prefer the approach using new base classes; and also I have learned more about the multiyear effort to get rid of `is_...` methods. I have updated the ticket description accordingly",
    "created_at": "2021-08-24T23:06:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32414#issuecomment-459012",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>Thanks for these thoughts and experiments. I also prefer the approach using new base classes; and also I have learned more about the multiyear effort to get rid of `is_...` methods. I have updated the ticket description accordingly



---

archive/issue_comments_459013.json:
```json
{
    "body": "<a id='comment:10'></a>Here's an attempt for `Polyhedron`. Still need to do some trick to make the constructor's docstring available\n\n---\nNew commits:",
    "created_at": "2021-08-25T01:18:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32414#issuecomment-459013",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>Here's an attempt for `Polyhedron`. Still need to do some trick to make the constructor's docstring available

---
New commits:



---

archive/issue_comments_459014.json:
```json
{
    "body": "<a id='comment:12'></a>For getting the docstring I have tried to make `__doc__` a property, but this approach does not seem to work for Cython classes...",
    "created_at": "2021-08-29T01:04:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32414#issuecomment-459014",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>For getting the docstring I have tried to make `__doc__` a property, but this approach does not seem to work for Cython classes...



---

archive/issue_comments_459015.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-29T01:04:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32414#issuecomment-459015",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_459016.json:
```json
{
    "body": "<a id='comment:14'></a>I think I'll need some help from Cython experts here...",
    "created_at": "2021-09-03T19:20:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32414#issuecomment-459016",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>I think I'll need some help from Cython experts here...



---

archive/issue_comments_459017.json:
```json
{
    "body": "<a id='comment:15'></a>I think you're running into the fact that the Python special double underscore methods are handled in a special way. I don't know too much about how that's done, but that that is my recollection.",
    "created_at": "2021-09-03T21:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32414#issuecomment-459017",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:15'></a>I think you're running into the fact that the Python special double underscore methods are handled in a special way. I don't know too much about how that's done, but that that is my recollection.



---

archive/issue_comments_459018.json:
```json
{
    "body": "<a id='comment:16'></a>A different approach would be to keep the base class / constructor in `sage.geometry.polyhedron.constructor` (similar to the branch of #26366) and to assign this module to the distribution `sagemath-categories`.",
    "created_at": "2021-09-08T03:00:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32414#issuecomment-459018",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>A different approach would be to keep the base class / constructor in `sage.geometry.polyhedron.constructor` (similar to the branch of #26366) and to assign this module to the distribution `sagemath-categories`.



---

archive/issue_comments_459019.json:
```json
{
    "body": "<a id='comment:21'></a>Revised the description - no longer attempt for the abc and the constructor to be the same object. This removes all of the technical difficulties discussed above.",
    "created_at": "2021-09-26T17:13:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32414",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32414#issuecomment-459019",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'></a>Revised the description - no longer attempt for the abc and the constructor to be the same object. This removes all of the technical difficulties discussed above.



---

archive/issue_events_085996.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:11:26Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32414",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32414#event-85996"
}
```



---

archive/issue_events_085997.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-01T21:16:35Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32414",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32414#event-85997"
}
```



---

archive/issue_events_085998.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-01T21:16:35Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32414",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32414#event-85998"
}
```



---

archive/issue_events_085999.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32414",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32414#event-85999"
}
```



---

archive/issue_events_086000.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32414",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32414#event-86000"
}
```
