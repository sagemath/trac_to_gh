# Issue 32080: Apply some upstream NumPy patches for CPU detection

archive/issues_031843.json:
```json
{
    "body": "Followup to #32021\n\nBranch: u/jhpalmieri/numpy-cpu-patches\n\nDependencies: #32488\n\nCommit: f7dd6ddd7281ab918c9e868aa875a3f5c2bea91f\n\nResolution: invalid\n\nIssue created by migration from https://trac.sagemath.org/ticket/32080\n\n",
    "closed_at": "2021-09-10T17:33:19Z",
    "created_at": "2021-06-28T23:51:07Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Apply some upstream NumPy patches for CPU detection",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32080",
    "user": "https://github.com/jhpalmieri"
}
```
Followup to #32021

Branch: u/jhpalmieri/numpy-cpu-patches

Dependencies: #32488

Commit: f7dd6ddd7281ab918c9e868aa875a3f5c2bea91f

Resolution: invalid

Issue created by migration from https://trac.sagemath.org/ticket/32080





---

archive/issue_comments_454510.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-28T23:51:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32080#issuecomment-454510",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_454511.json:
```json
{
    "body": "<a id='comment:3'></a>New commits:",
    "created_at": "2021-06-29T00:07:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32080#issuecomment-454511",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:3'></a>New commits:



---

archive/issue_comments_454512.json:
```json
{
    "body": "<a id='comment:5'></a>The `cygwin-standard` build of this ticket (https://github.com/mkoeppe/sage/runs/2947289812?check_suite_focus=true) failed \nbecause of a mistake in my CI scripts. I'm pushing the necessary changes to #32021 so that we can test it properly.",
    "created_at": "2021-07-06T18:20:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32080#issuecomment-454512",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>The `cygwin-standard` build of this ticket (https://github.com/mkoeppe/sage/runs/2947289812?check_suite_focus=true) failed 
because of a mistake in my CI scripts. I'm pushing the necessary changes to #32021 so that we can test it properly.



---

archive/issue_events_084918.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-09T21:07:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32080",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32080#event-84918"
}
```



---

archive/issue_events_084919.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-09-09T17:52:54Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32080",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32080#event-84919"
}
```



---

archive/issue_events_084920.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-09-09T17:52:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32080",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32080#event-84920"
}
```



---

archive/issue_comments_454513.json:
```json
{
    "body": "<a id='comment:9'></a>- 19074 was merged in https://github.com/numpy/numpy/releases/tag/v1.21.0rc1\n- 19365 was merged in https://github.com/numpy/numpy/releases/tag/v1.21.1 \n\nSo the upgrade to #32488 makes these patches obsolete. \n\nThe question whether this change:\n\n```\n--- a/build/pkgs/numpy/spkg-install.in\n+++ b/build/pkgs/numpy/spkg-install.in\n@@ -22,10 +22,6 @@ python3 ../lapack_conf.py\n export FFLAGS=\"$FFLAGS -fPIC\"\n export FCFLAGS=\"$FCFLAGS -fPIC\"\n \n-# Numpy 1.20.3 enables some intrinsics on machines without support with `-march=native`.\n-# We disable it until this is fixed.\n-export CFLAGS=\"$CFLAGS_NON_NATIVE\"\n-\n export NUMPY_FCONFIG=\"config_fc --noopt --noarch\"\n if [ \"$SAGE_FAT_BINARY\" = \"yes\" ]; then\n     export NUMPY_FCONFIG=\"--cpu-baseline=NONE\"\n```\nshould be done can be reopened after #32488, #32434, #32424 have been resolved.",
    "created_at": "2021-09-09T17:52:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32080#issuecomment-454513",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>- 19074 was merged in https://github.com/numpy/numpy/releases/tag/v1.21.0rc1
- 19365 was merged in https://github.com/numpy/numpy/releases/tag/v1.21.1 

So the upgrade to #32488 makes these patches obsolete. 

The question whether this change:

```
--- a/build/pkgs/numpy/spkg-install.in
+++ b/build/pkgs/numpy/spkg-install.in
@@ -22,10 +22,6 @@ python3 ../lapack_conf.py
 export FFLAGS="$FFLAGS -fPIC"
 export FCFLAGS="$FCFLAGS -fPIC"
 
-# Numpy 1.20.3 enables some intrinsics on machines without support with `-march=native`.
-# We disable it until this is fixed.
-export CFLAGS="$CFLAGS_NON_NATIVE"
-
 export NUMPY_FCONFIG="config_fc --noopt --noarch"
 if [ "$SAGE_FAT_BINARY" = "yes" ]; then
     export NUMPY_FCONFIG="--cpu-baseline=NONE"
```
should be done can be reopened after #32488, #32434, #32424 have been resolved.



---

archive/issue_comments_454514.json:
```json
{
    "body": "<a id='comment:10'></a>Okay, I will leave the decision about whether to remove `export CFLAGS=\"$CFLAGS_NON_NATIVE\"` to others. I don't know anything about NumPy or how this might affect its performance.",
    "created_at": "2021-09-10T15:56:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32080#issuecomment-454514",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:10'></a>Okay, I will leave the decision about whether to remove `export CFLAGS="$CFLAGS_NON_NATIVE"` to others. I don't know anything about NumPy or how this might affect its performance.



---

archive/issue_comments_454515.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-10T15:56:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32080#issuecomment-454515",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_084921.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-09-10T17:33:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32080",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32080#event-84921"
}
```



---

archive/issue_comments_454516.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2021-09-10T17:33:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32080",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32080#issuecomment-454516",
    "user": "https://github.com/mkoeppe"
}
```

Resolution: invalid
