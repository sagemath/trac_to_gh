# Issue 32640: Fix f.series(x, n) to match f.taylor(x, 0, n) for f = (1-x)^-x

archive/issues_032403.json:
```json
{
    "body": "We have in Sage 9.5.beta3:\n\n```\nsage: f = (1-x)^-x\nsage: f.taylor(x, 0, 5)  # correct\n3/4*x^5 + 5/6*x^4 + 1/2*x^3 + x^2 + 1\nsage: f.series(x, 5)  # incorrect\n1*x^(-1) + 1 + 1*x + 1*x^2 + 1*x^3 + 1*x^4 + Order(x^5)\n```\n\nCC:  @davewittemorris @slel\n\nBranch/Commit: [d66eb4486dfdc544278cf1ccd38ae9f5fd4af248](https://github.com/sagemath/sagetrac-mirror/commit/d66eb4486dfdc544278cf1ccd38ae9f5fd4af248)\n\nReviewer: Marc Mezzarobba\n\nAuthor: Dave Morris\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32640\n\n",
    "closed_at": "2021-12-23T20:26:07Z",
    "created_at": "2021-10-05T22:09:44Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Fix f.series(x, n) to match f.taylor(x, 0, n) for f = (1-x)^-x",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32640",
    "user": "https://github.com/akc"
}
```
We have in Sage 9.5.beta3:

```
sage: f = (1-x)^-x
sage: f.taylor(x, 0, 5)  # correct
3/4*x^5 + 5/6*x^4 + 1/2*x^3 + x^2 + 1
sage: f.series(x, 5)  # incorrect
1*x^(-1) + 1 + 1*x + 1*x^2 + 1*x^3 + 1*x^4 + Order(x^5)
```

CC:  @davewittemorris @slel

Branch/Commit: [d66eb4486dfdc544278cf1ccd38ae9f5fd4af248](https://github.com/sagemath/sagetrac-mirror/commit/d66eb4486dfdc544278cf1ccd38ae9f5fd4af248)

Reviewer: Marc Mezzarobba

Author: Dave Morris

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/32640





---

archive/issue_comments_650331.json:
```json
{
    "body": "<a id='comment:2'></a>\nThanks for the bug report.\n\nThe bug is in pynac's `power::useries` method. A power series is stored as a polynomial, together with an offset that represents multiplying by a certain power of `x`. Essentially, the method ignores the exponent's offset during most of the calculation, and then applies an offset to the final result. That is mathematically incorrect, so the method can return wrong answers when the exponent's offset is nonzero.\n\nIn particular, the exponent `-x` is stored as `-1`, with an offset of `1`, which explains why sage gives the wrong answer for the example in the ticket description. Specifically, sage's answer is `x^-1 * (1-x)^-1`.\n\nI should be able to upload a patch to fix this soon.",
    "created_at": "2021-10-06T06:08:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32640#issuecomment-650331",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:2'></a>
Thanks for the bug report.

The bug is in pynac's `power::useries` method. A power series is stored as a polynomial, together with an offset that represents multiplying by a certain power of `x`. Essentially, the method ignores the exponent's offset during most of the calculation, and then applies an offset to the final result. That is mathematically incorrect, so the method can return wrong answers when the exponent's offset is nonzero.

In particular, the exponent `-x` is stored as `-1`, with an offset of `1`, which explains why sage gives the wrong answer for the example in the ticket description. Specifically, sage's answer is `x^-1 * (1-x)^-1`.

I should be able to upload a patch to fix this soon.



---

archive/issue_comments_650332.json:
```json
{
    "body": "Changing branch from \"\" to \"public/32640\"",
    "created_at": "2021-10-07T02:57:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32640#issuecomment-650332",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing branch from "" to "public/32640"



---

archive/issue_comments_650333.json:
```json
{
    "body": "Changing commit from \"\" to \"d66eb4486dfdc544278cf1ccd38ae9f5fd4af248\"",
    "created_at": "2021-10-07T03:01:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32640#issuecomment-650333",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing commit from "" to "d66eb4486dfdc544278cf1ccd38ae9f5fd4af248"



---

archive/issue_comments_650334.json:
```json
{
    "body": "<a id='comment:4'></a>\nTo fix the problem, we `normalize` the power series before exponentiating. This multiplies by the appropriate power of `x` and sets the `offset` to `0`.\n\n---\nNew commits:\n|                                                                                                                                          |                                   |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------|\n|[03f1ddb](https://github.com/sagemath/sagetrac-mirror/commit/03f1ddb83aba75cde0afe9d647d9b02fcbe2f8e9)|`trac 32640 normalize power series`|\n|[d66eb44](https://github.com/sagemath/sagetrac-mirror/commit/d66eb4486dfdc544278cf1ccd38ae9f5fd4af248)|`add doctest`|",
    "created_at": "2021-10-07T03:01:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32640#issuecomment-650334",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:4'></a>
To fix the problem, we `normalize` the power series before exponentiating. This multiplies by the appropriate power of `x` and sets the `offset` to `0`.

---
New commits:
|                                                                                                                                          |                                   |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------|
|[03f1ddb](https://github.com/sagemath/sagetrac-mirror/commit/03f1ddb83aba75cde0afe9d647d9b02fcbe2f8e9)|`trac 32640 normalize power series`|
|[d66eb44](https://github.com/sagemath/sagetrac-mirror/commit/d66eb4486dfdc544278cf1ccd38ae9f5fd4af248)|`add doctest`|



---

archive/issue_comments_650335.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-10-07T03:01:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32640#issuecomment-650335",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_650336.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,11 +1,9 @@\n-We have\n+We have in Sage 9.5.beta3:\n \n ```\n-f = (1-x)^-x\n-print(f.taylor(x,0,5))\n-print(f.series(x,5))\n-\n+sage: f = (1-x)^-x\n+sage: f.taylor(x, 0, 5)  # correct\n 3/4*x^5 + 5/6*x^4 + 1/2*x^3 + x^2 + 1\n+sage: f.series(x, 5)  # incorrect\n 1*x^(-1) + 1 + 1*x + 1*x^2 + 1*x^3 + 1*x^4 + Order(x^5)\n ```\n-where the taylor method gives the expected result, but series does not.\n``````\n",
    "created_at": "2021-10-22T11:01:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32640#issuecomment-650336",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,11 +1,9 @@
-We have
+We have in Sage 9.5.beta3:
 
 ```
-f = (1-x)^-x
-print(f.taylor(x,0,5))
-print(f.series(x,5))
-
+sage: f = (1-x)^-x
+sage: f.taylor(x, 0, 5)  # correct
 3/4*x^5 + 5/6*x^4 + 1/2*x^3 + x^2 + 1
+sage: f.series(x, 5)  # incorrect
 1*x^(-1) + 1 + 1*x + 1*x^2 + 1*x^3 + 1*x^4 + Order(x^5)
 ```
-where the taylor method gives the expected result, but series does not.
``````




---

archive/issue_comments_650337.json:
```json
{
    "body": "Changing author from \"\" to \"Dave Morris\"",
    "created_at": "2021-10-22T11:01:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32640#issuecomment-650337",
    "user": "https://github.com/slel"
}
```

Changing author from "" to "Dave Morris"



---

archive/issue_events_097237.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/32640",
    "rename": {
        "from": "series method gives wrong result on (1-x)^-x",
        "to": "Fix f.series(x, n) to match f.taylor(x, 0, n) for f = (1-x)^-x"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32640#event-97237"
}
```



---

archive/issue_comments_650338.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-15T10:22:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32640#issuecomment-650338",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_650339.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Marc Mezzarobba\"",
    "created_at": "2021-12-15T10:22:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32640#issuecomment-650339",
    "user": "https://github.com/mezzarobba"
}
```

Changing reviewer from "" to "Marc Mezzarobba"



---

archive/issue_comments_650340.json:
```json
{
    "body": "<a id='comment:7'></a>\nThanks!",
    "created_at": "2021-12-15T17:44:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32640#issuecomment-650340",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:7'></a>
Thanks!



---

archive/issue_events_097238.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-12-23T20:26:07Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32640",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32640#event-97238"
}
```



---

archive/issue_comments_650341.json:
```json
{
    "body": "Changing branch from \"public/32640\" to \"d66eb4486dfdc544278cf1ccd38ae9f5fd4af248\"",
    "created_at": "2021-12-23T20:26:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32640#issuecomment-650341",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/32640" to "d66eb4486dfdc544278cf1ccd38ae9f5fd4af248"



---

archive/issue_comments_650342.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-12-23T20:26:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32640",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32640#issuecomment-650342",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
