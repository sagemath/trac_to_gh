# Issue 32329: Needing to interrupt when computing integral for answer

archive/issues_032092.json:
```json
{
    "body": "If I explicitly pass `algorithm='giac'`, I get the answer, but without it, it hangs until I interrupt it:\n\n```\nsage: t = var('t')\nsage: bxp = ((2 - cos(3*t))*cos(t)).diff(t)\nsage: byp = ((3 - 2*sin(2*t))*sin(t)).diff(t)\nsage: th = arctan(byp / bxp)\nsage: k = th.diff(t).simplify_full()\nsage: k  # exact value not so important\n6*(32*sin(t)^7 + 24*cos(t)*sin(t)^4 - 44*sin(t)^5 + 8*(cos(t) + 2)*sin(t)^3 \n   - 29*cos(t)*sin(t)^2 + 5*cos(t) - 1)/(256*sin(t)^8 - 720*sin(t)^6\n      - 4*(16*cos(t) - 153)*sin(t)^4 - 72*cos(t)*sin(t)^3\n      + (40*cos(t) - 159)*sin(t)^2 + 48*cos(t)*sin(t) - 9)\nsage: integral(k, t, 0, 2*pi, algorithm='giac')\n2*pi\nsage: integral(k, t, 0, 2*pi)  # this is also running giac\n^C2*pi\n```\n\nCC:  @antonio-rojas @mwageringel @edgarcosta\n\nBranch/Commit: 2198826a19b07884912364e786f31d8e992172c3\n\nReviewer: Travis Scrimshaw\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32329\n\n",
    "closed_at": "2021-09-05T21:38:32Z",
    "created_at": "2021-08-03T03:21:50Z",
    "labels": [
        "component: calculus",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Needing to interrupt when computing integral for answer",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32329",
    "user": "https://github.com/tscrim"
}
```
If I explicitly pass `algorithm='giac'`, I get the answer, but without it, it hangs until I interrupt it:

```
sage: t = var('t')
sage: bxp = ((2 - cos(3*t))*cos(t)).diff(t)
sage: byp = ((3 - 2*sin(2*t))*sin(t)).diff(t)
sage: th = arctan(byp / bxp)
sage: k = th.diff(t).simplify_full()
sage: k  # exact value not so important
6*(32*sin(t)^7 + 24*cos(t)*sin(t)^4 - 44*sin(t)^5 + 8*(cos(t) + 2)*sin(t)^3 
   - 29*cos(t)*sin(t)^2 + 5*cos(t) - 1)/(256*sin(t)^8 - 720*sin(t)^6
      - 4*(16*cos(t) - 153)*sin(t)^4 - 72*cos(t)*sin(t)^3
      + (40*cos(t) - 159)*sin(t)^2 + 48*cos(t)*sin(t) - 9)
sage: integral(k, t, 0, 2*pi, algorithm='giac')
2*pi
sage: integral(k, t, 0, 2*pi)  # this is also running giac
^C2*pi
```

CC:  @antonio-rojas @mwageringel @edgarcosta

Branch/Commit: 2198826a19b07884912364e786f31d8e992172c3

Reviewer: Travis Scrimshaw

Author: Frédéric Chapoton

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/32329





---

archive/issue_comments_489339.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,14 +1,12 @@\n If I explicitly pass \\`algorthm='giac'\\`, I get the answer, but without it, it hangs until I interrupt it:\n \n \\`\\`\\`\n-sage: E.<x,y> = EuclideanSpace(2) \n-....: R.<t> = RealLine()                                                                  \n-sage: beta = E.curve(((2 - cos(3*t))*cos(t), (3 - 2*sin(2*t))*sin(t)), (t, 0, 2*pi))\n-sage: bp = beta.tangent_vector_field()\n-sage: bxp, byp = bp[:]\n-sage: th = arctan(byp / bxp).expr()\n-sage: k = th.diff(t).simplify_full()\n-sage: k\n+sage: t = var('t')                                                                        \n+sage: bxp = ((2 - cos(3*t))*cos(t)).diff(t)                                               \n+sage: byp = ((3 - 2*sin(2*t))*sin(t)).diff(t)                                             \n+sage: th = arctan(byp / bxp)                                                              \n+sage: k = th.diff(t).simplify_full()                                                      \n+sage: k                                                                                   \n 6*(32*sin(t)^7 + 24*cos(t)*sin(t)^4 - 44*sin(t)^5 + 8*(cos(t) + 2)*sin(t)^3 - 29*cos(t)*sin(t)^2 + 5*cos(t) - 1)/(256*sin(t)^8 - 720*sin(t)^6 - 4*(16*cos(t) - 153)*sin(t)^4 - 72*cos(t)*sin(t)^3 + (40*cos(t) - 159)*sin(t)^2 + 48*cos(t)*sin(t) - 9)\n sage: integral(k, t, 0, 2*pi, algorithm='giac')\n 2*pi\n```\n",
    "created_at": "2021-08-03T03:23:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32329#issuecomment-489339",
    "user": "https://github.com/tscrim"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,14 +1,12 @@
 If I explicitly pass \`algorthm='giac'\`, I get the answer, but without it, it hangs until I interrupt it:
 
 \`\`\`
-sage: E.<x,y> = EuclideanSpace(2) 
-....: R.<t> = RealLine()                                                                  
-sage: beta = E.curve(((2 - cos(3*t))*cos(t), (3 - 2*sin(2*t))*sin(t)), (t, 0, 2*pi))
-sage: bp = beta.tangent_vector_field()
-sage: bxp, byp = bp[:]
-sage: th = arctan(byp / bxp).expr()
-sage: k = th.diff(t).simplify_full()
-sage: k
+sage: t = var('t')                                                                        
+sage: bxp = ((2 - cos(3*t))*cos(t)).diff(t)                                               
+sage: byp = ((3 - 2*sin(2*t))*sin(t)).diff(t)                                             
+sage: th = arctan(byp / bxp)                                                              
+sage: k = th.diff(t).simplify_full()                                                      
+sage: k                                                                                   
 6*(32*sin(t)^7 + 24*cos(t)*sin(t)^4 - 44*sin(t)^5 + 8*(cos(t) + 2)*sin(t)^3 - 29*cos(t)*sin(t)^2 + 5*cos(t) - 1)/(256*sin(t)^8 - 720*sin(t)^6 - 4*(16*cos(t) - 153)*sin(t)^4 - 72*cos(t)*sin(t)^3 + (40*cos(t) - 159)*sin(t)^2 + 48*cos(t)*sin(t) - 9)
 sage: integral(k, t, 0, 2*pi, algorithm='giac')
 2*pi
```




---

archive/issue_comments_489340.json:
```json
{
    "body": "<a id='comment:2'></a>hmmm. Are you sure it hangs when calling giac ?\n\n- fricas gives 0\n- maxima takes a long time and then ?\n- sympy takes a long times and then ?",
    "created_at": "2021-08-03T07:08:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32329#issuecomment-489340",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:2'></a>hmmm. Are you sure it hangs when calling giac ?

- fricas gives 0
- maxima takes a long time and then ?
- sympy takes a long times and then ?



---

archive/issue_comments_489341.json:
```json
{
    "body": "<a id='comment:3'></a>It definitely makes a call to giac because if I just run without specifying the algorithm, when I quite sage it exists saying quiting giac. It isn't so much the call to giac but the no specified algorithm case that is hanging somewhere. I would feel better even if there was a trace back, but there is none.",
    "created_at": "2021-08-03T07:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32329#issuecomment-489341",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:3'></a>It definitely makes a call to giac because if I just run without specifying the algorithm, when I quite sage it exists saying quiting giac. It isn't so much the call to giac but the no specified algorithm case that is hanging somewhere. I would feel better even if there was a trace back, but there is none.



---

archive/issue_comments_489342.json:
```json
{
    "body": "<a id='comment:4'></a>indeed, this `^C2*pi` appears when one CTRL-C just after hitting enter..",
    "created_at": "2021-08-03T09:19:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32329#issuecomment-489342",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:4'></a>indeed, this `^C2*pi` appears when one CTRL-C just after hitting enter..



---

archive/issue_comments_489343.json:
```json
{
    "body": "<a id='comment:5'></a>I have added a print in the code and we see something.\n\nStuck in maxima integrator after 13 minutes. Control-c-ing stops maxima and immediatly launches giac, which answer immediatly.\n\n```\nsage: integral(k, t, 0, 2*pi)                                                   \n<function maxima_integrator at 0x7f972b28b790>\n^C<function giac_integrator at 0x7f972b28b9d0>\n2*pi\n```",
    "created_at": "2021-08-03T11:27:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32329#issuecomment-489343",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:5'></a>I have added a print in the code and we see something.

Stuck in maxima integrator after 13 minutes. Control-c-ing stops maxima and immediatly launches giac, which answer immediatly.

```
sage: integral(k, t, 0, 2*pi)                                                   
<function maxima_integrator at 0x7f972b28b790>
^C<function giac_integrator at 0x7f972b28b9d0>
2*pi
```



---

archive/issue_comments_489344.json:
```json
{
    "body": "<a id='comment:6'></a>I see. Thank you for looking into it. I think that is bad behavior as you would have to ctrl-c multiple times for each the integrator if it takes too long. We are probably catching too many types of errors. `:/`",
    "created_at": "2021-08-04T00:27:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32329#issuecomment-489344",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>I see. Thank you for looking into it. I think that is bad behavior as you would have to ctrl-c multiple times for each the integrator if it takes too long. We are probably catching too many types of errors. `:/`



---

archive/issue_comments_489345.json:
```json
{
    "body": "<a id='comment:7'></a>Well, here is what we catch in src/sage/symbolic/integration/integral.py\n\n```\n            except (NotImplementedError, TypeError,\n                    AttributeError, RuntimeError):\n```\nmaybe catching `RuntimeError` is wrong ?",
    "created_at": "2021-08-04T08:54:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32329#issuecomment-489345",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:7'></a>Well, here is what we catch in src/sage/symbolic/integration/integral.py

```
            except (NotImplementedError, TypeError,
                    AttributeError, RuntimeError):
```
maybe catching `RuntimeError` is wrong ?



---

archive/issue_comments_489346.json:
```json
{
    "body": "<a id='comment:8'></a>That shouldn't catch a `KeyboardInterrupt`: https://docs.python.org/3/library/exceptions.html\n\nWhat is happening is when we do the keyboard interrupt, the maxima integrator is converting that into a `RuntimeError`, which is then caught:\n\n```\nsage: integral(k, t, 0, 2*pi, algorithm='maxima')\n<ctrl-C>\nRuntimeError: ECL says: Console interrupt.\n\nsage: integral(k, t, 0, 2*pi, algorithm='sympy')\n<ctrl-C>\nKeyboardInterrupt:\n```\nSo perhaps what we can do is check to see if the message contains `\"Console interrupt\"`? If so, then we just raise the error?\n\nAlthough I guess I should be slightly happy we have this bug. Otherwise I wouldn't have thought to change the integrator and continue thinking it is just too complicated to do symbolically. So it allows me to write a great example for my class.",
    "created_at": "2021-08-05T09:12:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32329#issuecomment-489346",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:8'></a>That shouldn't catch a `KeyboardInterrupt`: https://docs.python.org/3/library/exceptions.html

What is happening is when we do the keyboard interrupt, the maxima integrator is converting that into a `RuntimeError`, which is then caught:

```
sage: integral(k, t, 0, 2*pi, algorithm='maxima')
<ctrl-C>
RuntimeError: ECL says: Console interrupt.

sage: integral(k, t, 0, 2*pi, algorithm='sympy')
<ctrl-C>
KeyboardInterrupt:
```
So perhaps what we can do is check to see if the message contains `"Console interrupt"`? If so, then we just raise the error?

Although I guess I should be slightly happy we have this bug. Otherwise I wouldn't have thought to change the integrator and continue thinking it is just too complicated to do symbolically. So it allows me to write a great example for my class.



---

archive/issue_comments_489347.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,21 @@\n+If I explicitly pass \\`algorthm='giac'\\`, I get the answer, but without it, it hangs until I interrupt it:\n \n+\\`\\`\\`\n+sage: t = var('t')\n+sage: bxp = ((2 - cos(3*t))*cos(t)).diff(t)\n+sage: byp = ((3 - 2*sin(2*t))*sin(t)).diff(t)\n+sage: th = arctan(byp / bxp)\n+sage: k = th.diff(t).simplify_full()\n+sage: k  # exact value not so important\n+6*(32*sin(t)^7 + 24*cos(t)*sin(t)^4 - 44*sin(t)^5 + 8*(cos(t) + 2)*sin(t)^3 \n+   - 29*cos(t)*sin(t)^2 + 5*cos(t) - 1)/(256*sin(t)^8 - 720*sin(t)^6\n+      - 4*(16*cos(t) - 153)*sin(t)^4 - 72*cos(t)*sin(t)^3\n+      + (40*cos(t) - 159)*sin(t)^2 + 48*cos(t)*sin(t) - 9)\n+sage: integral(k, t, 0, 2*pi, algorithm='giac')\n+2*pi\n+sage: integral(k, t, 0, 2*pi)  # this is also running giac\n+^C2*pi\n+\\`\\`\\`\n \n Comment: 1\n \n```\n",
    "created_at": "2021-08-05T09:12:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32329#issuecomment-489347",
    "user": "https://github.com/tscrim"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,21 @@
+If I explicitly pass \`algorthm='giac'\`, I get the answer, but without it, it hangs until I interrupt it:
 
+\`\`\`
+sage: t = var('t')
+sage: bxp = ((2 - cos(3*t))*cos(t)).diff(t)
+sage: byp = ((3 - 2*sin(2*t))*sin(t)).diff(t)
+sage: th = arctan(byp / bxp)
+sage: k = th.diff(t).simplify_full()
+sage: k  # exact value not so important
+6*(32*sin(t)^7 + 24*cos(t)*sin(t)^4 - 44*sin(t)^5 + 8*(cos(t) + 2)*sin(t)^3 
+   - 29*cos(t)*sin(t)^2 + 5*cos(t) - 1)/(256*sin(t)^8 - 720*sin(t)^6
+      - 4*(16*cos(t) - 153)*sin(t)^4 - 72*cos(t)*sin(t)^3
+      + (40*cos(t) - 159)*sin(t)^2 + 48*cos(t)*sin(t) - 9)
+sage: integral(k, t, 0, 2*pi, algorithm='giac')
+2*pi
+sage: integral(k, t, 0, 2*pi)  # this is also running giac
+^C2*pi
+\`\`\`
 
 Comment: 1
 
```




---

archive/issue_comments_489348.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-08-05T15:07:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32329#issuecomment-489348",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_489349.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,21 @@\n+If I explicitly pass \\`algorithm='giac'\\`, I get the answer, but without it, it hangs until I interrupt it:\n \n+\\`\\`\\`\n+sage: t = var('t')\n+sage: bxp = ((2 - cos(3*t))*cos(t)).diff(t)\n+sage: byp = ((3 - 2*sin(2*t))*sin(t)).diff(t)\n+sage: th = arctan(byp / bxp)\n+sage: k = th.diff(t).simplify_full()\n+sage: k  # exact value not so important\n+6*(32*sin(t)^7 + 24*cos(t)*sin(t)^4 - 44*sin(t)^5 + 8*(cos(t) + 2)*sin(t)^3 \n+   - 29*cos(t)*sin(t)^2 + 5*cos(t) - 1)/(256*sin(t)^8 - 720*sin(t)^6\n+      - 4*(16*cos(t) - 153)*sin(t)^4 - 72*cos(t)*sin(t)^3\n+      + (40*cos(t) - 159)*sin(t)^2 + 48*cos(t)*sin(t) - 9)\n+sage: integral(k, t, 0, 2*pi, algorithm='giac')\n+2*pi\n+sage: integral(k, t, 0, 2*pi)  # this is also running giac\n+^C2*pi\n+\\`\\`\\`\n \n Comment: 1\n \n```\n",
    "created_at": "2021-08-05T15:07:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32329#issuecomment-489349",
    "user": "https://github.com/fchapoton"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,21 @@
+If I explicitly pass \`algorithm='giac'\`, I get the answer, but without it, it hangs until I interrupt it:
 
+\`\`\`
+sage: t = var('t')
+sage: bxp = ((2 - cos(3*t))*cos(t)).diff(t)
+sage: byp = ((3 - 2*sin(2*t))*sin(t)).diff(t)
+sage: th = arctan(byp / bxp)
+sage: k = th.diff(t).simplify_full()
+sage: k  # exact value not so important
+6*(32*sin(t)^7 + 24*cos(t)*sin(t)^4 - 44*sin(t)^5 + 8*(cos(t) + 2)*sin(t)^3 
+   - 29*cos(t)*sin(t)^2 + 5*cos(t) - 1)/(256*sin(t)^8 - 720*sin(t)^6
+      - 4*(16*cos(t) - 153)*sin(t)^4 - 72*cos(t)*sin(t)^3
+      + (40*cos(t) - 159)*sin(t)^2 + 48*cos(t)*sin(t) - 9)
+sage: integral(k, t, 0, 2*pi, algorithm='giac')
+2*pi
+sage: integral(k, t, 0, 2*pi)  # this is also running giac
+^C2*pi
+\`\`\`
 
 Comment: 1
 
```




---

archive/issue_comments_489350.json:
```json
{
    "body": "<a id='comment:9'></a>Here is a proposed fix, that raise `KeyboardInterrupt` instead of `RuntimeError` when ECL is interrupted by a CTRL-C.\n\n---\nNew commits:",
    "created_at": "2021-08-05T15:07:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32329#issuecomment-489350",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:9'></a>Here is a proposed fix, that raise `KeyboardInterrupt` instead of `RuntimeError` when ECL is interrupted by a CTRL-C.

---
New commits:



---

archive/issue_comments_489351.json:
```json
{
    "body": "<a id='comment:10'></a>Thank you, LGTM.\n\nI am bumping this to 9.5 in case we have another 9.4.rc round and this could be subtle enough of a change for someone's code (although I doubt it) that it should get some more proper beta testing.",
    "created_at": "2021-08-05T22:26:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32329#issuecomment-489351",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:10'></a>Thank you, LGTM.

I am bumping this to 9.5 in case we have another 9.4.rc round and this could be subtle enough of a change for someone's code (although I doubt it) that it should get some more proper beta testing.



---

archive/issue_events_085756.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2021-08-05T22:26:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32329",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32329#event-85756"
}
```



---

archive/issue_comments_489352.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-08-05T22:26:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32329#issuecomment-489352",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_489353.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-09-05T21:38:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32329",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32329#issuecomment-489353",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_085757.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-09-05T21:38:32Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32329",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32329#event-85757"
}
```
