# Issue 32580: {ubuntu-trusty, debian-jessie, linuxmint-17, fedora-{26,27,28}}-standard: system openssl too old for python3

archive/issues_032343.json:
```json
{
    "body": "Following [https://www.python.org/dev/peps/pep-0644/ PEP 644](https://www.python.org/dev/peps/pep-0644/ PEP 644), python requires OpenSSL 1.1.1 or newer. This was planned to be included in Python 3.10, but apparently Python 3.9.7 (the version of our spkg after #32443) has already broken compatibility with some older openssl releases. For example `ubuntu-trusty` uses 1.0.1f.\nhttps://github.com/sagemath/sage/runs/3712854824?check_suite_focus=true\n\nAlso python's own configure script does not notice that this version of SSL does not work, but then building the `_ssl` extension fails:\n\n```\nbuilding '_ssl' extension\ngcc -pthread -fPIC -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -O2 -g -march=native -std=c99 -Wextra -Wno-unused-result -Wno-unused-parameter -Wno-missing-field-initializers -Werror=implicit-function-declaration -fvisibility=hidden -I./Include/internal -I./Include -I/sage/local/include -I. -I/usr/local/include -I/sage/local/var/tmp/sage/build/python3-3.9.7/src/Include -I/sage/local/var/tmp/sage/build/python3-3.9.7/src -c /sage/local/var/tmp/sage/build/python3-3.9.7/src/Modules/_ssl.c -o build/temp.linux-x86_64-3.9/sage/local/var/tmp/sage/build/python3-3.9.7/src/Modules/_ssl.o\n/sage/local/var/tmp/sage/build/python3-3.9.7/src/Modules/_ssl.c: In function '_ssl__SSLContext_impl':\n/sage/local/var/tmp/sage/build/python3-3.9.7/src/Modules/_ssl.c:3116:27: error: implicit declaration of function 'SSLv3_method'; did you mean 'SSLv23_method'? [-Werror=implicit-function-declaration]\n         ctx = SSL_CTX_new(SSLv3_method());\n                           ^~~~~~~~~~~~\n                           SSLv23_method\n/sage/local/var/tmp/sage/build/python3-3.9.7/src/Modules/_ssl.c:3116:27: warning: passing argument 1 of 'SSL_CTX_new' makes pointer from integer without a cast [-Wint-conversion]\nIn file included from /sage/local/var/tmp/sage/build/python3-3.9.7/src/Modules/_ssl.c:59:0:\n/usr/include/openssl/ssl.h:1341:17: note: expected 'const SSL_METHOD * {aka const struct ssl_method_st *}' but argument is of type 'int'\n __owur SSL_CTX *SSL_CTX_new(const SSL_METHOD *meth);\n                 ^~~~~~~~~~~\n```\n\nWe should update `build/pkgs/openssl/spkg-configure.m4` to detect that we have a suitable version. Currently there is no version check whatsoever.\n\n\n\n\nCC:  tmonteil @dimpase @orlitzky @jhpalmieri @kliem\n\nReviewer: Jonathan Kliem\n\nAuthor: Matthias Koeppe\n\nBranch: 38c0d54e761b242b381ea9d4899be9ed40ac4236\n\nCommit: 38c0d54e761b242b381ea9d4899be9ed40ac4236\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32580\n\n",
    "closed_at": "2021-10-09T11:10:17Z",
    "created_at": "2021-09-28T16:35:07Z",
    "labels": [
        "component: packages: standard",
        "critical"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "{ubuntu-trusty, debian-jessie, linuxmint-17, fedora-{26,27,28}}-standard: system openssl too old for python3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32580",
    "user": "https://github.com/mkoeppe"
}
```
Following [https://www.python.org/dev/peps/pep-0644/ PEP 644](https://www.python.org/dev/peps/pep-0644/ PEP 644), python requires OpenSSL 1.1.1 or newer. This was planned to be included in Python 3.10, but apparently Python 3.9.7 (the version of our spkg after #32443) has already broken compatibility with some older openssl releases. For example `ubuntu-trusty` uses 1.0.1f.
https://github.com/sagemath/sage/runs/3712854824?check_suite_focus=true

Also python's own configure script does not notice that this version of SSL does not work, but then building the `_ssl` extension fails:

```
building '_ssl' extension
gcc -pthread -fPIC -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -O2 -g -march=native -std=c99 -Wextra -Wno-unused-result -Wno-unused-parameter -Wno-missing-field-initializers -Werror=implicit-function-declaration -fvisibility=hidden -I./Include/internal -I./Include -I/sage/local/include -I. -I/usr/local/include -I/sage/local/var/tmp/sage/build/python3-3.9.7/src/Include -I/sage/local/var/tmp/sage/build/python3-3.9.7/src -c /sage/local/var/tmp/sage/build/python3-3.9.7/src/Modules/_ssl.c -o build/temp.linux-x86_64-3.9/sage/local/var/tmp/sage/build/python3-3.9.7/src/Modules/_ssl.o
/sage/local/var/tmp/sage/build/python3-3.9.7/src/Modules/_ssl.c: In function '_ssl__SSLContext_impl':
/sage/local/var/tmp/sage/build/python3-3.9.7/src/Modules/_ssl.c:3116:27: error: implicit declaration of function 'SSLv3_method'; did you mean 'SSLv23_method'? [-Werror=implicit-function-declaration]
         ctx = SSL_CTX_new(SSLv3_method());
                           ^~~~~~~~~~~~
                           SSLv23_method
/sage/local/var/tmp/sage/build/python3-3.9.7/src/Modules/_ssl.c:3116:27: warning: passing argument 1 of 'SSL_CTX_new' makes pointer from integer without a cast [-Wint-conversion]
In file included from /sage/local/var/tmp/sage/build/python3-3.9.7/src/Modules/_ssl.c:59:0:
/usr/include/openssl/ssl.h:1341:17: note: expected 'const SSL_METHOD * {aka const struct ssl_method_st *}' but argument is of type 'int'
 __owur SSL_CTX *SSL_CTX_new(const SSL_METHOD *meth);
                 ^~~~~~~~~~~
```

We should update `build/pkgs/openssl/spkg-configure.m4` to detect that we have a suitable version. Currently there is no version check whatsoever.




CC:  tmonteil @dimpase @orlitzky @jhpalmieri @kliem

Reviewer: Jonathan Kliem

Author: Matthias Koeppe

Branch: 38c0d54e761b242b381ea9d4899be9ed40ac4236

Commit: 38c0d54e761b242b381ea9d4899be9ed40ac4236

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/32580





---

archive/issue_comments_460963.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-09-28T16:35:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32580",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32580#issuecomment-460963",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_460964.json:
```json
{
    "body": "<a id='comment:4'></a>There aren't enough of us to support every package combination on every distro going back a decade. This is most thoroughly solved by setting `--with-system-python3=force` (or better yet, by deleting the SPKG) and documenting how to install a newer version of python3 with Nix, Conda, or unofficial deb/RPMs.\n\nFor Ubuntu, there's a PPA that provides them:\n\nhttps://launchpad.net/~deadsnakes/+archive/ubuntu/ppa",
    "created_at": "2021-09-28T17:25:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32580",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32580#issuecomment-460964",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:4'></a>There aren't enough of us to support every package combination on every distro going back a decade. This is most thoroughly solved by setting `--with-system-python3=force` (or better yet, by deleting the SPKG) and documenting how to install a newer version of python3 with Nix, Conda, or unofficial deb/RPMs.

For Ubuntu, there's a PPA that provides them:

https://launchpad.net/~deadsnakes/+archive/ubuntu/ppa



---

archive/issue_comments_460965.json:
```json
{
    "body": "<a id='comment:5'></a>We have ticket for this standard reaction, #32074. Let's please not repeat it on every ticket.",
    "created_at": "2021-09-28T17:29:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32580",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32580#issuecomment-460965",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>We have ticket for this standard reaction, #32074. Let's please not repeat it on every ticket.



---

archive/issue_comments_460966.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-09-28T18:41:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32580",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32580#issuecomment-460966",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_460967.json:
```json
{
    "body": "<a id='comment:9'></a>Tested as follows:\n- on homebrew, correctly accepts openssl\n- `tox -e docker-ubuntu-trusty-standard -- config.status` ... correctly rejects openssl\n \n---\nNew commits:",
    "created_at": "2021-09-28T18:41:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32580",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32580#issuecomment-460967",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>Tested as follows:
- on homebrew, correctly accepts openssl
- `tox -e docker-ubuntu-trusty-standard -- config.status` ... correctly rejects openssl
 
---
New commits:



---

archive/issue_comments_460968.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-28T19:17:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32580",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32580#issuecomment-460968",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_460969.json:
```json
{
    "body": "<a id='comment:11'></a>`tox -e docker-ubuntu-focal-standard -- config.status` now notices that openssl is not required",
    "created_at": "2021-09-28T19:18:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32580",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32580#issuecomment-460969",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>`tox -e docker-ubuntu-focal-standard -- config.status` now notices that openssl is not required



---

archive/issue_comments_460970.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-09-30T20:42:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32580",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32580#issuecomment-460970",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_460971.json:
```json
{
    "body": "<a id='comment:13'></a>\n```diff\n-            #if OPENSSL_VERSION_NUMBER < 0x10100010L\n+            #if OPENSSL_VERSION_NUMBER < 0x10101000L\n```\n\nOnce done, you can set it on positive review on my behalf.",
    "created_at": "2021-09-30T20:42:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32580",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32580#issuecomment-460971",
    "user": "https://github.com/kliem"
}
```

<a id='comment:13'></a>
```diff
-            #if OPENSSL_VERSION_NUMBER < 0x10100010L
+            #if OPENSSL_VERSION_NUMBER < 0x10101000L
```

Once done, you can set it on positive review on my behalf.



---

archive/issue_comments_460972.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-30T22:09:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32580",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32580#issuecomment-460972",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_460973.json:
```json
{
    "body": "<a id='comment:15'></a>Thanks for catching this, you are right",
    "created_at": "2021-09-30T22:09:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32580",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32580#issuecomment-460973",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>Thanks for catching this, you are right



---

archive/issue_comments_460974.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-09-30T22:10:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32580",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32580#issuecomment-460974",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_460975.json:
```json
{
    "body": "<a id='comment:17'></a>Well it did confuse me, when I was testing it. I have openssl 1.1.1 and raising the requirement to 1.1.2 did not do anything.",
    "created_at": "2021-09-30T22:14:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32580",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32580#issuecomment-460975",
    "user": "https://github.com/kliem"
}
```

<a id='comment:17'></a>Well it did confuse me, when I was testing it. I have openssl 1.1.1 and raising the requirement to 1.1.2 did not do anything.



---

archive/issue_comments_460976.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-10-09T11:10:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32580",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32580#issuecomment-460976",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_086355.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-10-09T11:10:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32580",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32580#event-86355"
}
```
