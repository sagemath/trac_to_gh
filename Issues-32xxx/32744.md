# Issue 32744: composite elliptic-curve isogenies

archive/issues_032507.json:
```json
{
    "body": "CC:  @defeo @JohnCremona @loefflerd\n\nKeywords: elliptic curve isogenies\n\nThis patch introduces two important improvements for isogeny-minded users:\n\n1. Implement `EllipticCurveHom_composite`, a type of elliptic-curve morphism that's fundamentally a formal composite map, but designed to behave almost exactly like `EllipticCurveIsogeny`. Leaving the isogeny decomposed can be exponentially more efficient in some scenarios (such as in cryptography).\n\n2. Implement \"factored\" isogenies, that is, construction of an isogeny from a smooth-order kernel subgroup in time logarithmic in the degree (whereas `EllipticCurveIsogeny` is linear in the degree).\n\nThe new code is marked as experimental and not used anywhere by default, but adventurous users can opt-in by calling `EllipticCurveHom_composite.make_default()` or passing `algorithm=\"factored\"` to `E.isogeny()`. Changes to the existing codebase are intentionally kept minimal.\n\nHere's a diff without the dependency:\n\n- https://git.sagemath.org/sage.git/diff?id2=444330c857ee57a22e7e7e974cb63478b1535398&id=72ab0b8cdc18b15ea893a3db914419631252de23\n\nMost of the algorithms are straightforward, except perhaps for equality testing: This relies on the fact that distinct isogenies cannot act the same on \"too many\" points (the bound is four times the degree). See also #31850.\n\nIssue created by migration from https://trac.sagemath.org/ticket/32744\n\n",
    "closed_at": "2022-01-12T17:17:36Z",
    "created_at": "2021-10-23T05:29:46Z",
    "labels": [
        "component: elliptic curves"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "composite elliptic-curve isogenies",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32744",
    "user": "https://github.com/yyyyx4"
}
```
CC:  @defeo @JohnCremona @loefflerd

Keywords: elliptic curve isogenies

This patch introduces two important improvements for isogeny-minded users:

1. Implement `EllipticCurveHom_composite`, a type of elliptic-curve morphism that's fundamentally a formal composite map, but designed to behave almost exactly like `EllipticCurveIsogeny`. Leaving the isogeny decomposed can be exponentially more efficient in some scenarios (such as in cryptography).

2. Implement "factored" isogenies, that is, construction of an isogeny from a smooth-order kernel subgroup in time logarithmic in the degree (whereas `EllipticCurveIsogeny` is linear in the degree).

The new code is marked as experimental and not used anywhere by default, but adventurous users can opt-in by calling `EllipticCurveHom_composite.make_default()` or passing `algorithm="factored"` to `E.isogeny()`. Changes to the existing codebase are intentionally kept minimal.

Here's a diff without the dependency:

- https://git.sagemath.org/sage.git/diff?id2=444330c857ee57a22e7e7e974cb63478b1535398&id=72ab0b8cdc18b15ea893a3db914419631252de23

Most of the algorithms are straightforward, except perhaps for equality testing: This relies on the fact that distinct isogenies cannot act the same on "too many" points (the bound is four times the degree). See also #31850.

Issue created by migration from https://trac.sagemath.org/ticket/32744





---

archive/issue_comments_463061.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-10-23T05:54:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32744#issuecomment-463061",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_463062.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-29T05:38:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32744#issuecomment-463062",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_463063.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-30T03:25:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32744#issuecomment-463063",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_463064.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-30T03:44:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32744#issuecomment-463064",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_463065.json:
```json
{
    "body": "I've been using this code privately for a while now and it's very useful to me. I'm sure it would also be useful to others who work on similar things, so I think it would be really nice to get this into the 9.5 release. Can I convince anyone to review?\n\n(To reemphasize, the code in this ticket is marked experimental and explicitly opt-in. The changes in the dependency #32502 should be strictly backwards compatible as well. Therefore, applying this shouldn't cause any real harm even if things are terribly broken.)",
    "created_at": "2021-12-17T07:37:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32744#issuecomment-463065",
    "user": "https://github.com/yyyyx4"
}
```

I've been using this code privately for a while now and it's very useful to me. I'm sure it would also be useful to others who work on similar things, so I think it would be really nice to get this into the 9.5 release. Can I convince anyone to review?

(To reemphasize, the code in this ticket is marked experimental and explicitly opt-in. The changes in the dependency #32502 should be strictly backwards compatible as well. Therefore, applying this shouldn't cause any real harm even if things are terribly broken.)



---

archive/issue_comments_463066.json:
```json
{
    "body": "I am looking at it right now.  If I do have suggestions, I'll try hard to make it so that they can be implemented in a later ticket.  Thanks for doing this.",
    "created_at": "2021-12-17T10:30:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32744#issuecomment-463066",
    "user": "https://github.com/JohnCremona"
}
```

I am looking at it right now.  If I do have suggestions, I'll try hard to make it so that they can be implemented in a later ticket.  Thanks for doing this.



---

archive/issue_comments_463067.json:
```json
{
    "body": "In the richcmp method, the code for curves over number fields does not do what the docstring says, and as written returns True/False if for just one point of infinite order (defined over the base field or a quadratic extension) the maps have the same image.  I don't think this is what is intended.\n\nHow about: test a whole lot of random points, return False if they disagree on any, otherwise (if all the points pass this) do the harder work of comparing rational maps.  I think the number of points to test should depend on the degree, 100 is rather overkill since over number fields it is very unlikely to see large degrees (the record in the LMFDB now is 147, see http://www.lmfdb.org/EllipticCurve/6.6.453789.1/1.1/a/).  I should 10 would be plenty (before reverting to the exact test).\n\nTask for the future: in computing the isogeny class C of an elliptic curve E over QQ, or over a number field, I only use prime degree isogenies, so while C.matrix() shows the full matrix of all pairwise degrees, C.isogenies() has a 0 (just a placeholder) in position (i,j) when the isogeny from the i'th to the j'th curve is not of prime degree.  Using this new functionality we'll be able to fill those in too.  But not on this ticket.",
    "created_at": "2021-12-17T10:50:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32744#issuecomment-463067",
    "user": "https://github.com/JohnCremona"
}
```

In the richcmp method, the code for curves over number fields does not do what the docstring says, and as written returns True/False if for just one point of infinite order (defined over the base field or a quadratic extension) the maps have the same image.  I don't think this is what is intended.

How about: test a whole lot of random points, return False if they disagree on any, otherwise (if all the points pass this) do the harder work of comparing rational maps.  I think the number of points to test should depend on the degree, 100 is rather overkill since over number fields it is very unlikely to see large degrees (the record in the LMFDB now is 147, see http://www.lmfdb.org/EllipticCurve/6.6.453789.1/1.1/a/).  I should 10 would be plenty (before reverting to the exact test).

Task for the future: in computing the isogeny class C of an elliptic curve E over QQ, or over a number field, I only use prime degree isogenies, so while C.matrix() shows the full matrix of all pairwise degrees, C.isogenies() has a 0 (just a placeholder) in position (i,j) when the isogeny from the i'th to the j'th curve is not of prime degree.  Using this new functionality we'll be able to fill those in too.  But not on this ticket.



---

archive/issue_comments_463068.json:
```json
{
    "body": "Thank you, John!\n\nReplying to [comment:9 cremona]:\n> In the richcmp method, the code for curves over number fields does not do what the docstring says, and as written returns True/False if for just one point of infinite order (defined over the base field or a quadratic extension) the maps have the same image.  I don't think this is what is intended.\n\n\nMy reasoning was that the isogenies `f,g` to be compared are both group homomorphisms, hence if they agree on a single point `P` of infinite order, this extends to the entire subgroup generated by that point. Therefore, the difference `f-g` has infinite kernel (containing `<P>`), which implies `f-g = 0` since (non-zero) isogenies have finite kernel by definition. Is this incorrect?",
    "created_at": "2021-12-17T12:26:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32744#issuecomment-463068",
    "user": "https://github.com/yyyyx4"
}
```

Thank you, John!

Replying to [comment:9 cremona]:
> In the richcmp method, the code for curves over number fields does not do what the docstring says, and as written returns True/False if for just one point of infinite order (defined over the base field or a quadratic extension) the maps have the same image.  I don't think this is what is intended.


My reasoning was that the isogenies `f,g` to be compared are both group homomorphisms, hence if they agree on a single point `P` of infinite order, this extends to the entire subgroup generated by that point. Therefore, the difference `f-g` has infinite kernel (containing `<P>`), which implies `f-g = 0` since (non-zero) isogenies have finite kernel by definition. Is this incorrect?



---

archive/issue_comments_463069.json:
```json
{
    "body": "Your are certainly right, apologies for not seeing that. I had thought that you were avoiding points of finite order just to stay away from the kernel.  It would have been nice to have had a comment to the effect that \"if two isogenies agree on a point of infinite order then they must be equal\", just as you explained, but never mind.",
    "created_at": "2021-12-17T14:04:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32744#issuecomment-463069",
    "user": "https://github.com/JohnCremona"
}
```

Your are certainly right, apologies for not seeing that. I had thought that you were avoiding points of finite order just to stay away from the kernel.  It would have been nice to have had a comment to the effect that "if two isogenies agree on a point of infinite order then they must be equal", just as you explained, but never mind.



---

archive/issue_comments_463070.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-17T14:04:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32744#issuecomment-463070",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_463071.json:
```json
{
    "body": "Changing keywords from \"\" to \"elliptic curve isogenies\".",
    "created_at": "2021-12-17T14:04:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32744#issuecomment-463071",
    "user": "https://github.com/JohnCremona"
}
```

Changing keywords from "" to "elliptic curve isogenies".



---

archive/issue_comments_463072.json:
```json
{
    "body": "Thanks a lot for your time!\n\nOne question: Did you look at the entire diff including #32502, or just the changes made on top of #32502? In the first case, I think you can also set #32502 to \"positive review\".",
    "created_at": "2021-12-18T03:44:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32744#issuecomment-463072",
    "user": "https://github.com/yyyyx4"
}
```

Thanks a lot for your time!

One question: Did you look at the entire diff including #32502, or just the changes made on top of #32502? In the first case, I think you can also set #32502 to "positive review".



---

archive/issue_comments_463073.json:
```json
{
    "body": "I only looked at the diffs for this ticket.  So I will go and look at the dependent ticket #32502 as well (probably not today though).",
    "created_at": "2021-12-18T12:35:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32744#issuecomment-463073",
    "user": "https://github.com/JohnCremona"
}
```

I only looked at the diffs for this ticket.  So I will go and look at the dependent ticket #32502 as well (probably not today though).



---

archive/issue_events_086666.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-01-12T17:17:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32744",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32744#event-86666"
}
```



---

archive/issue_comments_463074.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-01-12T17:17:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32744",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32744#issuecomment-463074",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
