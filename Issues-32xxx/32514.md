# Issue 32514: Fix file permission doctest in src/sage/misc/persist.pyx in cygwin or as root

archive/issues_032277.json:
```json
{
    "body": "... as seen on GH Actions tests in 9.5.beta1\nhttps://github.com/sagemath/sage/runs/3593002892?check_suite_focus=true\n\n```\nage -t --random-seed=0 src/sage/misc/persist.pyx\n**********************************************************************\nFile \"src/sage/misc/persist.pyx\", line 1018, in sage.misc.persist.picklejar\nFailed example:\n    if uid==0:\n        raise OSError('You must not run the doctests as root, geez!')\n    elif sys.platform == 'cygwin':\n        raise OSError(\"This won't always behave on Cygwin depending on permission handling configuration.\")\n    else:\n        sage.misc.persist.picklejar(1, dir + '/noaccess')\nExpected:\n    Traceback (most recent call last):\n    ...\n    PermissionError: ...\nGot:\n    <BLANKLINE>\n    Traceback (most recent call last):\n      File \"/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 704, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1098, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.misc.persist.picklejar[7]>\", line 2, in <module>\n        raise OSError('You must not run the doctests as root, geez!')\n    OSError: You must not run the doctests as root, geez!\n**********************************************************************\n```\n\n\nThe patronizing message \"You must not run the doctests as root\" should be removed altogether\n\nThe failure is likely caused by the changes in #32326\n\n\n\n**CC:**  @fchapoton @orlitzky @slel\n\n**Keywords:** permission\n\n**Branch/Commit:** [a2893e5cf7a3920f5d49b5e65e13929abc76edb9](https://github.com/sagemath/sagetrac-mirror/commit/a2893e5cf7a3920f5d49b5e65e13929abc76edb9)\n\n**Reviewer:** Michael Orlitzky\n\n**Author:** Matthias Koeppe\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32514\n\n",
    "closed_at": "2021-09-25T23:17:53Z",
    "created_at": "2021-09-14T20:07:51Z",
    "labels": [
        "component: doctest coverage",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Fix file permission doctest in src/sage/misc/persist.pyx in cygwin or as root",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32514",
    "user": "https://github.com/mkoeppe"
}
```
... as seen on GH Actions tests in 9.5.beta1
https://github.com/sagemath/sage/runs/3593002892?check_suite_focus=true

```
age -t --random-seed=0 src/sage/misc/persist.pyx
**********************************************************************
File "src/sage/misc/persist.pyx", line 1018, in sage.misc.persist.picklejar
Failed example:
    if uid==0:
        raise OSError('You must not run the doctests as root, geez!')
    elif sys.platform == 'cygwin':
        raise OSError("This won't always behave on Cygwin depending on permission handling configuration.")
    else:
        sage.misc.persist.picklejar(1, dir + '/noaccess')
Expected:
    Traceback (most recent call last):
    ...
    PermissionError: ...
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 704, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1098, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.persist.picklejar[7]>", line 2, in <module>
        raise OSError('You must not run the doctests as root, geez!')
    OSError: You must not run the doctests as root, geez!
**********************************************************************
```


The patronizing message "You must not run the doctests as root" should be removed altogether

The failure is likely caused by the changes in #32326



**CC:**  @fchapoton @orlitzky @slel

**Keywords:** permission

**Branch/Commit:** [a2893e5cf7a3920f5d49b5e65e13929abc76edb9](https://github.com/sagemath/sagetrac-mirror/commit/a2893e5cf7a3920f5d49b5e65e13929abc76edb9)

**Reviewer:** Michael Orlitzky

**Author:** Matthias Koeppe

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/32514





---

archive/issue_comments_648074.json:
```json
{
    "body": "**Branch:** [u/mkoeppe/src_sage_misc_persist_pyx__fix_doctest_error_when_run_as_root](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/src_sage_misc_persist_pyx__fix_doctest_error_when_run_as_root)",
    "created_at": "2021-09-17T17:11:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32514#issuecomment-648074",
    "user": "https://github.com/mkoeppe"
}
```

**Branch:** [u/mkoeppe/src_sage_misc_persist_pyx__fix_doctest_error_when_run_as_root](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/src_sage_misc_persist_pyx__fix_doctest_error_when_run_as_root)



---

archive/issue_comments_648075.json:
```json
{
    "body": "**Author:** Matthias Koeppe",
    "created_at": "2021-09-17T17:12:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32514#issuecomment-648075",
    "user": "https://github.com/mkoeppe"
}
```

**Author:** Matthias Koeppe



---

archive/issue_comments_648076.json:
```json
{
    "body": "<a id='comment:2'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2b3ac0905d71390d62ba73d9b7c961f50262812a\">2b3ac09</a></td><td><code>src/sage/misc/persist.pyx: Fix doctest so it works when run as root</code></td></tr></table>\n",
    "created_at": "2021-09-17T17:12:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32514#issuecomment-648076",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2b3ac0905d71390d62ba73d9b7c961f50262812a">2b3ac09</a></td><td><code>src/sage/misc/persist.pyx: Fix doctest so it works when run as root</code></td></tr></table>




---

archive/issue_comments_648077.json:
```json
{
    "body": "**Commit:** [2b3ac0905d71390d62ba73d9b7c961f50262812a](https://github.com/sagemath/sagetrac-mirror/commit/2b3ac0905d71390d62ba73d9b7c961f50262812a)",
    "created_at": "2021-09-17T17:12:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32514#issuecomment-648077",
    "user": "https://github.com/mkoeppe"
}
```

**Commit:** [2b3ac0905d71390d62ba73d9b7c961f50262812a](https://github.com/sagemath/sagetrac-mirror/commit/2b3ac0905d71390d62ba73d9b7c961f50262812a)



---

archive/issue_comments_648078.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2021-09-17T17:12:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32514#issuecomment-648078",
    "user": "https://github.com/mkoeppe"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_648079.json:
```json
{
    "body": "<a id='comment:3'></a>\nThe test suite *shouldn't* be run as root, but that's not the place to enforce it. Can you make that doctest save/restore the original permissions rather than setting them to 0755 unconditionally (which is too permissive)? Otherwise LGTM.",
    "created_at": "2021-09-18T11:18:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32514#issuecomment-648079",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:3'></a>
The test suite *shouldn't* be run as root, but that's not the place to enforce it. Can you make that doctest save/restore the original permissions rather than setting them to 0755 unconditionally (which is too permissive)? Otherwise LGTM.



---

archive/issue_comments_648080.json:
```json
{
    "body": "**Reviewer:** Michael Orlitzky",
    "created_at": "2021-09-18T11:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32514#issuecomment-648080",
    "user": "https://github.com/orlitzky"
}
```

**Reviewer:** Michael Orlitzky



---

archive/issue_comments_648081.json:
```json
{
    "body": "**Changing commit** from \"[2b3ac0905d71390d62ba73d9b7c961f50262812a](https://github.com/sagemath/sagetrac-mirror/commit/2b3ac0905d71390d62ba73d9b7c961f50262812a)\" to \"[a2893e5cf7a3920f5d49b5e65e13929abc76edb9](https://github.com/sagemath/sagetrac-mirror/commit/a2893e5cf7a3920f5d49b5e65e13929abc76edb9)\".",
    "created_at": "2021-09-18T16:53:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32514#issuecomment-648081",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[2b3ac0905d71390d62ba73d9b7c961f50262812a](https://github.com/sagemath/sagetrac-mirror/commit/2b3ac0905d71390d62ba73d9b7c961f50262812a)" to "[a2893e5cf7a3920f5d49b5e65e13929abc76edb9](https://github.com/sagemath/sagetrac-mirror/commit/a2893e5cf7a3920f5d49b5e65e13929abc76edb9)".



---

archive/issue_comments_648082.json:
```json
{
    "body": "<a id='comment:5'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a2893e5cf7a3920f5d49b5e65e13929abc76edb9\">a2893e5</a></td><td><code>src/sage/misc/persist.pyx: In doctest, restore original mode instead of 755</code></td></tr></table>\n",
    "created_at": "2021-09-18T16:53:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32514#issuecomment-648082",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a2893e5cf7a3920f5d49b5e65e13929abc76edb9">a2893e5</a></td><td><code>src/sage/misc/persist.pyx: In doctest, restore original mode instead of 755</code></td></tr></table>




---

archive/issue_comments_648083.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2021-09-18T18:06:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32514#issuecomment-648083",
    "user": "https://github.com/orlitzky"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_648084.json:
```json
{
    "body": "<a id='comment:6'></a>\nthanks",
    "created_at": "2021-09-18T18:06:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32514#issuecomment-648084",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:6'></a>
thanks



---

archive/issue_comments_648085.json:
```json
{
    "body": "<a id='comment:7'></a>\nThanks for reviewing!",
    "created_at": "2021-09-18T18:07:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32514#issuecomment-648085",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>
Thanks for reviewing!



---

archive/issue_comments_648086.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"permission\".",
    "created_at": "2021-09-23T12:07:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32514#issuecomment-648086",
    "user": "https://github.com/slel"
}
```

**Changing keywords** from "" to "permission".



---

archive/issue_events_096959.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/32514",
    "rename": {
        "from": "src/sage/misc/persist.pyx: Fix doctest error when run as root",
        "to": "Fix file permission doctest in src/sage/misc/persist.pyx in cygwin or as root"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32514#event-96959"
}
```



---

archive/issue_comments_648087.json:
```json
{
    "body": "<a id='comment:8'></a>\nThis fixes the only failing doctest I saw\nin Sage 9.5.beta1 (Cygwin 3.2.0, Windows 10).",
    "created_at": "2021-09-23T12:07:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32514#issuecomment-648087",
    "user": "https://github.com/slel"
}
```

<a id='comment:8'></a>
This fixes the only failing doctest I saw
in Sage 9.5.beta1 (Cygwin 3.2.0, Windows 10).



---

archive/issue_comments_648088.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2021-09-25T23:17:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32514#issuecomment-648088",
    "user": "https://github.com/vbraun"
}
```

**Resolution:** fixed



---

archive/issue_events_096960.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-09-25T23:17:53Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32514",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32514#event-96960"
}
```



---

archive/issue_comments_648089.json:
```json
{
    "body": "**Changing branch** from \"[u/mkoeppe/src_sage_misc_persist_pyx__fix_doctest_error_when_run_as_root](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/src_sage_misc_persist_pyx__fix_doctest_error_when_run_as_root)\" to \"[a2893e5cf7a3920f5d49b5e65e13929abc76edb9](https://github.com/sagemath/sagetrac-mirror/commit/a2893e5cf7a3920f5d49b5e65e13929abc76edb9)\".",
    "created_at": "2021-09-25T23:17:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32514",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32514#issuecomment-648089",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/mkoeppe/src_sage_misc_persist_pyx__fix_doctest_error_when_run_as_root](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/src_sage_misc_persist_pyx__fix_doctest_error_when_run_as_root)" to "[a2893e5cf7a3920f5d49b5e65e13929abc76edb9](https://github.com/sagemath/sagetrac-mirror/commit/a2893e5cf7a3920f5d49b5e65e13929abc76edb9)".
