# Issue 32927: build/pkgs/sagelib: Invoke install cleaner explicitly, remove it from pkgs/sagemath-standard/setup.py

archive/issues_032690.json:
```json
{
    "body": "Unless `./configure --enable-editable` is used, the Sage library is installed directly into `site-packages` using `setup.py install`, and at the end of `sage_setup`'s custom `sage_install_and_clean` invokes the installation cleaner, which removes \"stale\" installed files.\n\nThe installation cleaner is problematic when we start to install optional modules in the `sage.*` namespace via separate distributions such as **sagemath-tdlib** (#29864). \n- `pkgs/sagemath-standard/setup.py` will no longer enable optional Cython modules based on which optional packages are installed\n- but the installation cleaner needs to know about these optional Cython modules so it does not remove them right after their installation.\n\nIn this ticket we solve this problem by removing the use of the installation cleaner from `pkgs/sagemath-standard/setup.py`. Instead we invoke it separately at the end of the installation script `build/pkgs/sagelib/spkg-install`.\n\n\n(An alternative solution, replacing this installation procedure by a standard installation procedure using wheels, as proposed in #32874, would make `sage -b` much slower. Also, the idea of just making `./configure --enable-editable` the default, #32406, has met skepticism.)\n\n\nCC:  @kiwifb @jhpalmieri\n\nWork_Issues: Do not build_ext\n\nReviewer: Kwankyu Lee\n\nBranch: u/mkoeppe/pkgs_sagemath_standard_setup_py__move_distributions_logic_to_a_new_package_sagemath_optional\n\nDependencies: #32874\n\nCommit: edd0ea1df972480984837a1aa4d54bb3ede6ab62\n\nResolution: invalid\n\nIssue created by migration from https://trac.sagemath.org/ticket/32927\n\n",
    "closed_at": "2022-11-14T19:36:43Z",
    "created_at": "2021-11-24T07:09:16Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "build/pkgs/sagelib: Invoke install cleaner explicitly, remove it from pkgs/sagemath-standard/setup.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32927",
    "user": "https://github.com/mkoeppe"
}
```
Unless `./configure --enable-editable` is used, the Sage library is installed directly into `site-packages` using `setup.py install`, and at the end of `sage_setup`'s custom `sage_install_and_clean` invokes the installation cleaner, which removes "stale" installed files.

The installation cleaner is problematic when we start to install optional modules in the `sage.*` namespace via separate distributions such as **sagemath-tdlib** (#29864). 
- `pkgs/sagemath-standard/setup.py` will no longer enable optional Cython modules based on which optional packages are installed
- but the installation cleaner needs to know about these optional Cython modules so it does not remove them right after their installation.

In this ticket we solve this problem by removing the use of the installation cleaner from `pkgs/sagemath-standard/setup.py`. Instead we invoke it separately at the end of the installation script `build/pkgs/sagelib/spkg-install`.


(An alternative solution, replacing this installation procedure by a standard installation procedure using wheels, as proposed in #32874, would make `sage -b` much slower. Also, the idea of just making `./configure --enable-editable` the default, #32406, has met skepticism.)


CC:  @kiwifb @jhpalmieri

Work_Issues: Do not build_ext

Reviewer: Kwankyu Lee

Branch: u/mkoeppe/pkgs_sagemath_standard_setup_py__move_distributions_logic_to_a_new_package_sagemath_optional

Dependencies: #32874

Commit: edd0ea1df972480984837a1aa4d54bb3ede6ab62

Resolution: invalid

Issue created by migration from https://trac.sagemath.org/ticket/32927





---

archive/issue_comments_498004.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n ... which generates `install-requires` on `setup.py egg_info` (or `prepare_metadata_for_build_wheel`/`prepare_metadata_for_build_editable`).\n+\n+As an alternative, we could also have `configure` generate a `requirements.txt` with `@` links into `SAGE_ROOT/pkgs/`\n \n Comment: 1\n \n```\n",
    "created_at": "2021-11-26T01:00:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498004",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,6 @@
 ... which generates `install-requires` on `setup.py egg_info` (or `prepare_metadata_for_build_wheel`/`prepare_metadata_for_build_editable`).
+
+As an alternative, we could also have `configure` generate a `requirements.txt` with `@` links into `SAGE_ROOT/pkgs/`
 
 Comment: 1
 
```




---

archive/issue_comments_498005.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,9 @@\n+... which generates `install-requires` on `setup.py egg_info` (or `prepare_metadata_for_build_wheel`/`prepare_metadata_for_build_editable`).\n+\n+(As an alternative, we could also have `configure` generate a `requirements.txt` with `@` links into `SAGE_ROOT/pkgs/`.)\n+\n+We also move the installation cleaner from `pkgs/sagemath-standard/setup.py` to this package.\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2021-11-26T22:53:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498005",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,9 @@
+... which generates `install-requires` on `setup.py egg_info` (or `prepare_metadata_for_build_wheel`/`prepare_metadata_for_build_editable`).
+
+(As an alternative, we could also have `configure` generate a `requirements.txt` with `@` links into `SAGE_ROOT/pkgs/`.)
+
+We also move the installation cleaner from `pkgs/sagemath-standard/setup.py` to this package.
+
 
 
 Comment: 1
```




---

archive/issue_comments_498006.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,4 @@\n+We move the installation cleaner from `pkgs/sagemath-standard/setup.py` to a new location. It is only to be used by sage-the-distribution.\n \n \n Comment: 1\n```\n",
    "created_at": "2021-11-27T21:04:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498006",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,4 @@
+We move the installation cleaner from `pkgs/sagemath-standard/setup.py` to a new location. It is only to be used by sage-the-distribution.
 
 
 Comment: 1
```




---

archive/issue_comments_498007.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,7 @@\n+We move the installation cleaner from `pkgs/sagemath-standard/setup.py` to a new location. It is only to be used by sage-the-distribution.\n+\n+This is also a preparation for namespace packages. \n+The installation cleaner should only be run once, when all namespace packages filling the namespace `sage.*` are installed.\n \n \n Comment: 1\n```\n",
    "created_at": "2021-11-27T21:15:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498007",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,7 @@
+We move the installation cleaner from `pkgs/sagemath-standard/setup.py` to a new location. It is only to be used by sage-the-distribution.
+
+This is also a preparation for namespace packages. 
+The installation cleaner should only be run once, when all namespace packages filling the namespace `sage.*` are installed.
 
 
 Comment: 1
```




---

archive/issue_comments_498008.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,13 @@\n+Unless `./configure --enable-editable` is used, the Sage library is installed directly into `site-packages` using `setup.py install`, and at the end of `sage_setup`'s custom `sage_install_and_clean` invokes the installation cleaner, which removes \"stale\" installed files.\n+\n+The installation cleaner is problematic when we start to install optional modules in the `sage.*` namespace via separate distributions such as **sagemath-tdlib**. \n+- `pkgs/sagemath-standard/setup.py` will no longer enable optional Cython modules based on which optional packages are installed\n+- but the installation cleaner needs to know about these optional Cython modules so it does not remove them right after their installation.\n+\n+In this ticket we solve this problem by removing the use of the installation cleaner from `pkgs/sagemath-standard/setup.py`. Instead we invoke it separately at the end of the installation script `build/pkgs/sagelib/spkg-install`.\n+\n+\n+(An alternative solution, replacing this installation procedure by a standard installation procedure using wheels, as proposed in #32874, would make `sage -b` much slower.)\n \n \n Comment: 1\n```\n",
    "created_at": "2021-11-27T21:39:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498008",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,13 @@
+Unless `./configure --enable-editable` is used, the Sage library is installed directly into `site-packages` using `setup.py install`, and at the end of `sage_setup`'s custom `sage_install_and_clean` invokes the installation cleaner, which removes "stale" installed files.
+
+The installation cleaner is problematic when we start to install optional modules in the `sage.*` namespace via separate distributions such as **sagemath-tdlib**. 
+- `pkgs/sagemath-standard/setup.py` will no longer enable optional Cython modules based on which optional packages are installed
+- but the installation cleaner needs to know about these optional Cython modules so it does not remove them right after their installation.
+
+In this ticket we solve this problem by removing the use of the installation cleaner from `pkgs/sagemath-standard/setup.py`. Instead we invoke it separately at the end of the installation script `build/pkgs/sagelib/spkg-install`.
+
+
+(An alternative solution, replacing this installation procedure by a standard installation procedure using wheels, as proposed in #32874, would make `sage -b` much slower.)
 
 
 Comment: 1
```




---

archive/issue_events_087012.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-11-27T21:39:16Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32927#event-87012"
}
```



---

archive/issue_comments_498009.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,13 @@\n+Unless `./configure --enable-editable` is used, the Sage library is installed directly into `site-packages` using `setup.py install`, and at the end of `sage_setup`'s custom `sage_install_and_clean` invokes the installation cleaner, which removes \"stale\" installed files.\n+\n+The installation cleaner is problematic when we start to install optional modules in the `sage.*` namespace via separate distributions such as **sagemath-tdlib**. \n+- `pkgs/sagemath-standard/setup.py` will no longer enable optional Cython modules based on which optional packages are installed\n+- but the installation cleaner needs to know about these optional Cython modules so it does not remove them right after their installation.\n+\n+In this ticket we solve this problem by removing the use of the installation cleaner from `pkgs/sagemath-standard/setup.py`. Instead we invoke it separately at the end of the installation script `build/pkgs/sagelib/spkg-install`.\n+\n+\n+(An alternative solution, replacing this installation procedure by a standard installation procedure using wheels, as proposed in #32874, would make `sage -b` much slower. Also, the idea of just making `./configure --enable-editable` the default, #32406, has met skepticism.)\n \n \n Comment: 1\n```\n",
    "created_at": "2021-11-27T21:40:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498009",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,13 @@
+Unless `./configure --enable-editable` is used, the Sage library is installed directly into `site-packages` using `setup.py install`, and at the end of `sage_setup`'s custom `sage_install_and_clean` invokes the installation cleaner, which removes "stale" installed files.
+
+The installation cleaner is problematic when we start to install optional modules in the `sage.*` namespace via separate distributions such as **sagemath-tdlib**. 
+- `pkgs/sagemath-standard/setup.py` will no longer enable optional Cython modules based on which optional packages are installed
+- but the installation cleaner needs to know about these optional Cython modules so it does not remove them right after their installation.
+
+In this ticket we solve this problem by removing the use of the installation cleaner from `pkgs/sagemath-standard/setup.py`. Instead we invoke it separately at the end of the installation script `build/pkgs/sagelib/spkg-install`.
+
+
+(An alternative solution, replacing this installation procedure by a standard installation procedure using wheels, as proposed in #32874, would make `sage -b` much slower. Also, the idea of just making `./configure --enable-editable` the default, #32406, has met skepticism.)
 
 
 Comment: 1
```




---

archive/issue_comments_498010.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-11-27T21:41:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498010",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_498011.json:
```json
{
    "body": "<a id='comment:8'></a>Last 10 new commits:",
    "created_at": "2021-11-27T21:41:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498011",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>Last 10 new commits:



---

archive/issue_events_087013.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:53:12Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32927#event-87013"
}
```



---

archive/issue_events_087014.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:53:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32927#event-87014"
}
```



---

archive/issue_comments_498012.json:
```json
{
    "body": "<a id='comment:9'></a>Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498012",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.



---

archive/issue_comments_498013.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-23T06:08:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498013",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_498014.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-23T06:14:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498014",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_498015.json:
```json
{
    "body": "<a id='comment:14'></a>Is this installing a nested package? The kind of stuff that we finally ditched with R/rpy a few years ago.",
    "created_at": "2022-02-06T23:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498015",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:14'></a>Is this installing a nested package? The kind of stuff that we finally ditched with R/rpy a few years ago.



---

archive/issue_comments_498016.json:
```json
{
    "body": "<a id='comment:15'></a>No, the distribution in `build/pkgs/sagelib/install-cleaner/` does not install anything and is not nested in anything. If it's clearer, I can also move it to `pkgs/install-cleaner/`",
    "created_at": "2022-02-07T00:04:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498016",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>No, the distribution in `build/pkgs/sagelib/install-cleaner/` does not install anything and is not nested in anything. If it's clearer, I can also move it to `pkgs/install-cleaner/`



---

archive/issue_comments_498017.json:
```json
{
    "body": "<a id='comment:16'></a>I think that may be best. But I must say so far I am a bit confused. I do not see where that \"install-cleaner\" is ever used. Is it just functionality you are keeping in reserve for now or for a dependent ticket?",
    "created_at": "2022-02-07T00:11:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498017",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:16'></a>I think that may be best. But I must say so far I am a bit confused. I do not see where that "install-cleaner" is ever used. Is it just functionality you are keeping in reserve for now or for a dependent ticket?



---

archive/issue_comments_498018.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,13 @@\n+Unless `./configure --enable-editable` is used, the Sage library is installed directly into `site-packages` using `setup.py install`, and at the end of `sage_setup`'s custom `sage_install_and_clean` invokes the installation cleaner, which removes \"stale\" installed files.\n+\n+The installation cleaner is problematic when we start to install optional modules in the `sage.*` namespace via separate distributions such as **sagemath-stdlib**. \n+- `pkgs/sagemath-standard/setup.py` will no longer enable optional Cython modules based on which optional packages are installed\n+- but the installation cleaner needs to know about these optional Cython modules so it does not remove them right after their installation.\n+\n+In this ticket we solve this problem by removing the use of the installation cleaner from `pkgs/sagemath-standard/setup.py`. Instead we invoke it separately at the end of the installation script `build/pkgs/sagelib/spkg-install`.\n+\n+\n+(An alternative solution, replacing this installation procedure by a standard installation procedure using wheels, as proposed in #32874, would make `sage -b` much slower. Also, the idea of just making `./configure --enable-editable` the default, #32406, has met skepticism.)\n \n \n Comment: 1\n```\n",
    "created_at": "2022-02-07T00:11:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498018",
    "user": "https://github.com/kiwifb"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,13 @@
+Unless `./configure --enable-editable` is used, the Sage library is installed directly into `site-packages` using `setup.py install`, and at the end of `sage_setup`'s custom `sage_install_and_clean` invokes the installation cleaner, which removes "stale" installed files.
+
+The installation cleaner is problematic when we start to install optional modules in the `sage.*` namespace via separate distributions such as **sagemath-stdlib**. 
+- `pkgs/sagemath-standard/setup.py` will no longer enable optional Cython modules based on which optional packages are installed
+- but the installation cleaner needs to know about these optional Cython modules so it does not remove them right after their installation.
+
+In this ticket we solve this problem by removing the use of the installation cleaner from `pkgs/sagemath-standard/setup.py`. Instead we invoke it separately at the end of the installation script `build/pkgs/sagelib/spkg-install`.
+
+
+(An alternative solution, replacing this installation procedure by a standard installation procedure using wheels, as proposed in #32874, would make `sage -b` much slower. Also, the idea of just making `./configure --enable-editable` the default, #32406, has met skepticism.)
 
 
 Comment: 1
```




---

archive/issue_comments_498019.json:
```json
{
    "body": "<a id='comment:17'></a>It's invoked by `build/pkgs/sagelib/spkg-install`",
    "created_at": "2022-02-07T00:13:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498019",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>It's invoked by `build/pkgs/sagelib/spkg-install`



---

archive/issue_comments_498020.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-07T02:58:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498020",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_498021.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-02-07T03:05:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498021",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_498022.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,13 @@\n+Unless `./configure --enable-editable` is used, the Sage library is installed directly into `site-packages` using `setup.py install`, and at the end of `sage_setup`'s custom `sage_install_and_clean` invokes the installation cleaner, which removes \"stale\" installed files.\n+\n+The installation cleaner is problematic when we start to install optional modules in the `sage.*` namespace via separate distributions such as **sagemath-tdlib**. \n+- `pkgs/sagemath-standard/setup.py` will no longer enable optional Cython modules based on which optional packages are installed\n+- but the installation cleaner needs to know about these optional Cython modules so it does not remove them right after their installation.\n+\n+In this ticket we solve this problem by removing the use of the installation cleaner from `pkgs/sagemath-standard/setup.py`. Instead we invoke it separately at the end of the installation script `build/pkgs/sagelib/spkg-install`.\n+\n+\n+(An alternative solution, replacing this installation procedure by a standard installation procedure using wheels, as proposed in #32874, would make `sage -b` much slower. Also, the idea of just making `./configure --enable-editable` the default, #32406, has met skepticism.)\n \n \n Comment: 1\n```\n",
    "created_at": "2022-02-07T03:06:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498022",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,13 @@
+Unless `./configure --enable-editable` is used, the Sage library is installed directly into `site-packages` using `setup.py install`, and at the end of `sage_setup`'s custom `sage_install_and_clean` invokes the installation cleaner, which removes "stale" installed files.
+
+The installation cleaner is problematic when we start to install optional modules in the `sage.*` namespace via separate distributions such as **sagemath-tdlib**. 
+- `pkgs/sagemath-standard/setup.py` will no longer enable optional Cython modules based on which optional packages are installed
+- but the installation cleaner needs to know about these optional Cython modules so it does not remove them right after their installation.
+
+In this ticket we solve this problem by removing the use of the installation cleaner from `pkgs/sagemath-standard/setup.py`. Instead we invoke it separately at the end of the installation script `build/pkgs/sagelib/spkg-install`.
+
+
+(An alternative solution, replacing this installation procedure by a standard installation procedure using wheels, as proposed in #32874, would make `sage -b` much slower. Also, the idea of just making `./configure --enable-editable` the default, #32406, has met skepticism.)
 
 
 Comment: 1
```




---

archive/issue_comments_498023.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,13 @@\n+Unless `./configure --enable-editable` is used, the Sage library is installed directly into `site-packages` using `setup.py install`, and at the end of `sage_setup`'s custom `sage_install_and_clean` invokes the installation cleaner, which removes \"stale\" installed files.\n+\n+The installation cleaner is problematic when we start to install optional modules in the `sage.*` namespace via separate distributions such as **sagemath-tdlib** (#29864). \n+- `pkgs/sagemath-standard/setup.py` will no longer enable optional Cython modules based on which optional packages are installed\n+- but the installation cleaner needs to know about these optional Cython modules so it does not remove them right after their installation.\n+\n+In this ticket we solve this problem by removing the use of the installation cleaner from `pkgs/sagemath-standard/setup.py`. Instead we invoke it separately at the end of the installation script `build/pkgs/sagelib/spkg-install`.\n+\n+\n+(An alternative solution, replacing this installation procedure by a standard installation procedure using wheels, as proposed in #32874, would make `sage -b` much slower. Also, the idea of just making `./configure --enable-editable` the default, #32406, has met skepticism.)\n \n \n Comment: 1\n```\n",
    "created_at": "2022-02-07T03:06:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498023",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,13 @@
+Unless `./configure --enable-editable` is used, the Sage library is installed directly into `site-packages` using `setup.py install`, and at the end of `sage_setup`'s custom `sage_install_and_clean` invokes the installation cleaner, which removes "stale" installed files.
+
+The installation cleaner is problematic when we start to install optional modules in the `sage.*` namespace via separate distributions such as **sagemath-tdlib** (#29864). 
+- `pkgs/sagemath-standard/setup.py` will no longer enable optional Cython modules based on which optional packages are installed
+- but the installation cleaner needs to know about these optional Cython modules so it does not remove them right after their installation.
+
+In this ticket we solve this problem by removing the use of the installation cleaner from `pkgs/sagemath-standard/setup.py`. Instead we invoke it separately at the end of the installation script `build/pkgs/sagelib/spkg-install`.
+
+
+(An alternative solution, replacing this installation procedure by a standard installation procedure using wheels, as proposed in #32874, would make `sage -b` much slower. Also, the idea of just making `./configure --enable-editable` the default, #32406, has met skepticism.)
 
 
 Comment: 1
```




---

archive/issue_comments_498024.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-07T03:25:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498024",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_498025.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:17 mkoeppe]:\n> It's invoked by `build/pkgs/sagelib/spkg-install`\n\n\nOh yes I see. Like it says, that's not a bit I am usually concerned with downstream.",
    "created_at": "2022-02-07T04:36:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498025",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:23'></a>Replying to [comment:17 mkoeppe]:
> It's invoked by `build/pkgs/sagelib/spkg-install`


Oh yes I see. Like it says, that's not a bit I am usually concerned with downstream.



---

archive/issue_comments_498026.json:
```json
{
    "body": "<a id='comment:24'></a>Yes, the only effect of this ticket on downstream packaging is that sagemath-standard's `setup.py` no longer does weird things with `site-packages`.",
    "created_at": "2022-02-07T04:38:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498026",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>Yes, the only effect of this ticket on downstream packaging is that sagemath-standard's `setup.py` no longer does weird things with `site-packages`.



---

archive/issue_comments_498027.json:
```json
{
    "body": "<a id='comment:25'></a>If I was doing a bit of archeology on the sage-on-gentoo repo I think I would find bits where I suppressed some of that clean up. I seem to have let go of that part recently.",
    "created_at": "2022-02-07T04:41:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498027",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:25'></a>If I was doing a bit of archeology on the sage-on-gentoo repo I think I would find bits where I suppressed some of that clean up. I seem to have let go of that part recently.



---

archive/issue_events_087015.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T20:27:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32927#event-87015"
}
```



---

archive/issue_events_087016.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T20:27:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32927#event-87016"
}
```



---

archive/issue_comments_498028.json:
```json
{
    "body": "<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-06-09T21:28:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498028",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_498029.json:
```json
{
    "body": "<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-06-12T02:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498029",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_498030.json:
```json
{
    "body": "<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-06-12T20:01:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498030",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_events_087017.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32927#event-87017"
}
```



---

archive/issue_events_087018.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32927#event-87018"
}
```



---

archive/issue_comments_498031.json:
```json
{
    "body": "<a id='comment:34'></a>Not needed with #32874",
    "created_at": "2022-09-26T05:54:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498031",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'></a>Not needed with #32874



---

archive/issue_comments_498032.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-09-26T05:54:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498032",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_events_087019.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-26T05:54:41Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32927#event-87019"
}
```



---

archive/issue_events_087020.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-26T05:54:41Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32927#event-87020"
}
```



---

archive/issue_comments_498033.json:
```json
{
    "body": "<a id='comment:35'></a>Before we close this ticket, to clarify why this approach was abandoned, let me ask a couple of questions:\n\nWould `setup install` work when optional distributions that contain namespace packages were installed?\n\nWould `legacy-install-cleaner` work when optional distributions that contain namespace packages were installed?\n\nIf answers to both are yes, then the branch of this ticket could be an alternative to #32874?",
    "created_at": "2022-10-14T04:17:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498033",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:35'></a>Before we close this ticket, to clarify why this approach was abandoned, let me ask a couple of questions:

Would `setup install` work when optional distributions that contain namespace packages were installed?

Would `legacy-install-cleaner` work when optional distributions that contain namespace packages were installed?

If answers to both are yes, then the branch of this ticket could be an alternative to #32874?



---

archive/issue_comments_498034.json:
```json
{
    "body": "<a id='comment:36'></a>Well, the branch here would have been a temporary solution, good enough until external packages arrive that fill the namespace `sage.*` and are maintained out of tree. Then #30152 would have been the next step, but I did not have an implementation strategy for it.",
    "created_at": "2022-10-14T23:26:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498034",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:36'></a>Well, the branch here would have been a temporary solution, good enough until external packages arrive that fill the namespace `sage.*` and are maintained out of tree. Then #30152 would have been the next step, but I did not have an implementation strategy for it.



---

archive/issue_comments_498035.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-10-15T02:45:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498035",
    "user": "https://github.com/kwankyu"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_498036.json:
```json
{
    "body": "<a id='comment:37'></a>Okay. Thanks.",
    "created_at": "2022-10-15T02:45:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498036",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:37'></a>Okay. Thanks.



---

archive/issue_comments_498037.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2022-11-14T19:36:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32927#issuecomment-498037",
    "user": "https://github.com/mkoeppe"
}
```

Resolution: invalid



---

archive/issue_events_087021.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-11-14T19:36:43Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32927",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32927#event-87021"
}
```
