# Issue 32262: docbuild errors out with "cannot copy static file FileExistsError"

archive/issues_032025.json:
```json
{
    "body": "There is apparently a race condition in docbuild which leads to \n\n```\n  [dochtml]   [reference]     topology: 1937 js index entries\n  [dochtml]   [reference]     valuations: 973 js index entries\n  [dochtml]   [reference] ... done (64387 js index entries)\n  [dochtml]   [reference] copying static files... failed\n  [dochtml]   [reference] WARNING: cannot copy static file FileExistsError(17, 'File exists')\n  [dochtml]   [reference] dumping search index in English (code: en)... done\n  [dochtml]   [reference] The HTML pages are in .tox/local-homebrew-macos-standard/local/share/doc/sage/html/en/reference.\n  [dochtml]   Error building the documentation.\n  [dochtml]   Traceback (most recent call last):\n  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/homebrew/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py\", line 197, in _run_module_as_main\n  [dochtml]       return _run_code(code, main_globals, None,\n  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/homebrew/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py\", line 87, in _run_code\n  [dochtml]       exec(code, run_globals)\n  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__main__.py\", line 2, in <module>\n  [dochtml]       main()\n  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 1813, in main\n  [dochtml]       builder()\n  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 133, in f\n  [dochtml]       runsphinx()\n  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py\", line 323, in runsphinx\n  [dochtml]       sys.stderr.raise_errors()\n  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py\", line 258, in raise_errors\n  [dochtml]       raise OSError(self._error)\n  [dochtml]   OSError: WARNING: cannot copy static file FileExistsError(17, 'File exists')\n  [dochtml]   \n  [dochtml]       Note: incremental documentation builds sometimes cause spurious\n  [dochtml]       error messages. To be certain that these are real errors, run\n  [dochtml]       \"make doc-clean\" first and try again.\n  [dochtml]   make[3]: *** [doc-html--reference_top] Error 1\n  [dochtml]   make[2]: *** [doc-html-reference] Error 2\n  [dochtml]   make[2]: Target `doc-html' not remade because of errors.\n  [dochtml] Full log file: /Users/runner/work/sagetrac-mirror/sagetrac-mirror/logs/dochtml.log\nmake[1]: *** [doc-html] Error 2\n```\non many GH Action runs on #31580, e.g.\nhttps://github.com/sagemath/sagetrac-mirror/runs/3104375540 (this is `docker (ubuntu-bionic, standard)`)\nhttps://github.com/sagemath/sagetrac-mirror/runs/3104375098 (this is `local-macos (homebrew-macos-python3_xcode, standard, default, macos-11.0)`)\n\nalso reproducible locally on macOS/Homebrew with `make -j8`.\n\nNo failure with `make -j1`.\n\nThis is observed with the latest beta on Linux and macOS after #31948\n\nReported on sage-dev: https://groups.google.com/g/sage-devel/c/ts6u19KpapA/m/22BdxXZhBAAJ\n\nCC:  @jhpalmieri @isuruf\n\nUpstream: Fixed upstream, but not in a stable release.\n\nDependencies: #31580\n\nResolution: invalid\n\nIssue created by migration from https://trac.sagemath.org/ticket/32262\n\n",
    "closed_at": "2021-09-10T04:50:10Z",
    "created_at": "2021-07-22T02:03:00Z",
    "labels": [
        "component: build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "docbuild errors out with \"cannot copy static file FileExistsError\"",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32262",
    "user": "https://github.com/kwankyu"
}
```
There is apparently a race condition in docbuild which leads to 

```
  [dochtml]   [reference]     topology: 1937 js index entries
  [dochtml]   [reference]     valuations: 973 js index entries
  [dochtml]   [reference] ... done (64387 js index entries)
  [dochtml]   [reference] copying static files... failed
  [dochtml]   [reference] WARNING: cannot copy static file FileExistsError(17, 'File exists')
  [dochtml]   [reference] dumping search index in English (code: en)... done
  [dochtml]   [reference] The HTML pages are in .tox/local-homebrew-macos-standard/local/share/doc/sage/html/en/reference.
  [dochtml]   Error building the documentation.
  [dochtml]   Traceback (most recent call last):
  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/homebrew/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 197, in _run_module_as_main
  [dochtml]       return _run_code(code, main_globals, None,
  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/homebrew/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 87, in _run_code
  [dochtml]       exec(code, run_globals)
  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__main__.py", line 2, in <module>
  [dochtml]       main()
  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1813, in main
  [dochtml]       builder()
  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 133, in f
  [dochtml]       runsphinx()
  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py", line 323, in runsphinx
  [dochtml]       sys.stderr.raise_errors()
  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py", line 258, in raise_errors
  [dochtml]       raise OSError(self._error)
  [dochtml]   OSError: WARNING: cannot copy static file FileExistsError(17, 'File exists')
  [dochtml]   
  [dochtml]       Note: incremental documentation builds sometimes cause spurious
  [dochtml]       error messages. To be certain that these are real errors, run
  [dochtml]       "make doc-clean" first and try again.
  [dochtml]   make[3]: *** [doc-html--reference_top] Error 1
  [dochtml]   make[2]: *** [doc-html-reference] Error 2
  [dochtml]   make[2]: Target `doc-html' not remade because of errors.
  [dochtml] Full log file: /Users/runner/work/sagetrac-mirror/sagetrac-mirror/logs/dochtml.log
make[1]: *** [doc-html] Error 2
```
on many GH Action runs on #31580, e.g.
https://github.com/sagemath/sagetrac-mirror/runs/3104375540 (this is `docker (ubuntu-bionic, standard)`)
https://github.com/sagemath/sagetrac-mirror/runs/3104375098 (this is `local-macos (homebrew-macos-python3_xcode, standard, default, macos-11.0)`)

also reproducible locally on macOS/Homebrew with `make -j8`.

No failure with `make -j1`.

This is observed with the latest beta on Linux and macOS after #31948

Reported on sage-dev: https://groups.google.com/g/sage-devel/c/ts6u19KpapA/m/22BdxXZhBAAJ

CC:  @jhpalmieri @isuruf

Upstream: Fixed upstream, but not in a stable release.

Dependencies: #31580

Resolution: invalid

Issue created by migration from https://trac.sagemath.org/ticket/32262





---

archive/issue_comments_488342.json:
```json
{
    "body": "<a id='comment:1'></a>This is just a gut feeling but I suspect the issue is related with the option `--no-prune-empty-dirs` in these lines\n\n```diff\n+\t$(MAKE) SAGE_DOCBUILD_OPTS=\"$(SAGE_DOCBUILD_OPTS) --no-prune-empty-dirs\" $(foreach doc, $(OTHER_DOCS), doc-inventory--$(subst /,-,$(doc)))\n+\t$(MAKE) SAGE_DOCBUILD_OPTS=\"$(SAGE_DOCBUILD_OPTS) --no-prune-empty-dirs\" doc-inventory--reference_top\n```\n\nThe other issue in #32043 may be related with this.",
    "created_at": "2021-07-22T02:10:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488342",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:1'></a>This is just a gut feeling but I suspect the issue is related with the option `--no-prune-empty-dirs` in these lines

```diff
+	$(MAKE) SAGE_DOCBUILD_OPTS="$(SAGE_DOCBUILD_OPTS) --no-prune-empty-dirs" $(foreach doc, $(OTHER_DOCS), doc-inventory--$(subst /,-,$(doc)))
+	$(MAKE) SAGE_DOCBUILD_OPTS="$(SAGE_DOCBUILD_OPTS) --no-prune-empty-dirs" doc-inventory--reference_top
```

The other issue in #32043 may be related with this.



---

archive/issue_comments_488343.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-This is observed with the latest beta on Linux and macOS:\n+After #31948, this is observed with the latest beta on Linux and macOS:\n \n ```\n ...\n```\n",
    "created_at": "2021-07-22T02:11:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488343",
    "user": "https://github.com/kwankyu"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,4 @@
-This is observed with the latest beta on Linux and macOS:
+After #31948, this is observed with the latest beta on Linux and macOS:
 
 ```
 ...
```




---

archive/issue_comments_488344.json:
```json
{
    "body": "<a id='comment:3'></a>`git grep -i static src/sage_docbuild/` reveals several places that would be worth inspecting.",
    "created_at": "2021-07-22T02:51:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488344",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>`git grep -i static src/sage_docbuild/` reveals several places that would be worth inspecting.



---

archive/issue_comments_488345.json:
```json
{
    "body": "<a id='comment:4'></a>This is where the error is raised: in `sphinx/builders/html/__init__.py`\n\n```python\n    def copy_html_static_files(self, context: Dict) -> None:\n        def onerror(filename: str, error: Exception) -> None:\n            logger.warning(__('Failed to copy a file in html_static_file: %s: %r'),\n                           filename, error)\n\n        excluded = Matcher(self.config.exclude_patterns + [\"**/.*\"])\n        for entry in self.config.html_static_path:\n            copy_asset(path.join(self.confdir, entry),\n                       path.join(self.outdir, '_static'),\n                       excluded, context=context, renderer=self.templates, onerror=onerror)\n\n    def copy_html_logo(self) -> None:\n        if self.config.html_logo and not isurl(self.config.html_logo):\n            copy_asset(path.join(self.confdir, self.config.html_logo),\n                       path.join(self.outdir, '_static'))\n\n    def copy_html_favicon(self) -> None:\n        if self.config.html_favicon and not isurl(self.config.html_favicon):\n            copy_asset(path.join(self.confdir, self.config.html_favicon),\n                       path.join(self.outdir, '_static'))\n\n    def copy_static_files(self) -> None:\n        try:\n            with progress_message(__('copying static files')):\n                ensuredir(path.join(self.outdir, '_static'))\n\n                # prepare context for templates\n                context = self.globalcontext.copy()\n                if self.indexer is not None:\n                    context.update(self.indexer.context_for_searchtool())\n\n                self.create_pygments_style_file()\n                self.copy_translation_js()\n                self.copy_stemmer_js()\n                self.copy_theme_static_files(context)\n                self.copy_html_static_files(context)\n                self.copy_html_logo()\n                self.copy_html_favicon()\n        except OSError as err:\n            logger.warning(__('cannot copy static file %r'), err)  \n```",
    "created_at": "2021-07-22T04:15:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488345",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:4'></a>This is where the error is raised: in `sphinx/builders/html/__init__.py`

```python
    def copy_html_static_files(self, context: Dict) -> None:
        def onerror(filename: str, error: Exception) -> None:
            logger.warning(__('Failed to copy a file in html_static_file: %s: %r'),
                           filename, error)

        excluded = Matcher(self.config.exclude_patterns + ["**/.*"])
        for entry in self.config.html_static_path:
            copy_asset(path.join(self.confdir, entry),
                       path.join(self.outdir, '_static'),
                       excluded, context=context, renderer=self.templates, onerror=onerror)

    def copy_html_logo(self) -> None:
        if self.config.html_logo and not isurl(self.config.html_logo):
            copy_asset(path.join(self.confdir, self.config.html_logo),
                       path.join(self.outdir, '_static'))

    def copy_html_favicon(self) -> None:
        if self.config.html_favicon and not isurl(self.config.html_favicon):
            copy_asset(path.join(self.confdir, self.config.html_favicon),
                       path.join(self.outdir, '_static'))

    def copy_static_files(self) -> None:
        try:
            with progress_message(__('copying static files')):
                ensuredir(path.join(self.outdir, '_static'))

                # prepare context for templates
                context = self.globalcontext.copy()
                if self.indexer is not None:
                    context.update(self.indexer.context_for_searchtool())

                self.create_pygments_style_file()
                self.copy_translation_js()
                self.copy_stemmer_js()
                self.copy_theme_static_files(context)
                self.copy_html_static_files(context)
                self.copy_html_logo()
                self.copy_html_favicon()
        except OSError as err:
            logger.warning(__('cannot copy static file %r'), err)  
```



---

archive/issue_comments_488346.json:
```json
{
    "body": "<a id='comment:5'></a>What is the command to reproduce the bug?",
    "created_at": "2021-07-22T04:26:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488346",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:5'></a>What is the command to reproduce the bug?



---

archive/issue_comments_488347.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-07-22T05:45:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488347",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_488348.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:5 klee]:\n> What is the command to reproduce the bug?\n\ntry building the branch of #31580 with `make -jX` (for X=8, say?) on macOS or Ubuntu.\n\nI've opened a duplicate ticket (oops) #32263 with a bit more info.",
    "created_at": "2021-07-22T06:50:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488348",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>Replying to [comment:5 klee]:
> What is the command to reproduce the bug?

try building the branch of #31580 with `make -jX` (for X=8, say?) on macOS or Ubuntu.

I've opened a duplicate ticket (oops) #32263 with a bit more info.



---

archive/issue_comments_488349.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,51 @@\n+There is apparently a race condition in docbuild which leads to \n \n+```\n+  [dochtml]   [reference]     topology: 1937 js index entries\n+  [dochtml]   [reference]     valuations: 973 js index entries\n+  [dochtml]   [reference] ... done (64387 js index entries)\n+  [dochtml]   [reference] copying static files... failed\n+  [dochtml]   [reference] WARNING: cannot copy static file FileExistsError(17, 'File exists')\n+  [dochtml]   [reference] dumping search index in English (code: en)... done\n+  [dochtml]   [reference] The HTML pages are in .tox/local-homebrew-macos-standard/local/share/doc/sage/html/en/reference.\n+  [dochtml]   Error building the documentation.\n+  [dochtml]   Traceback (most recent call last):\n+  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/homebrew/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py\", line 197, in _run_module_as_main\n+  [dochtml]       return _run_code(code, main_globals, None,\n+  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/homebrew/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py\", line 87, in _run_code\n+  [dochtml]       exec(code, run_globals)\n+  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__main__.py\", line 2, in <module>\n+  [dochtml]       main()\n+  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 1813, in main\n+  [dochtml]       builder()\n+  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 133, in f\n+  [dochtml]       runsphinx()\n+  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py\", line 323, in runsphinx\n+  [dochtml]       sys.stderr.raise_errors()\n+  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py\", line 258, in raise_errors\n+  [dochtml]       raise OSError(self._error)\n+  [dochtml]   OSError: WARNING: cannot copy static file FileExistsError(17, 'File exists')\n+  [dochtml]   \n+  [dochtml]       Note: incremental documentation builds sometimes cause spurious\n+  [dochtml]       error messages. To be certain that these are real errors, run\n+  [dochtml]       \"make doc-clean\" first and try again.\n+  [dochtml]   make[3]: *** [doc-html--reference_top] Error 1\n+  [dochtml]   make[2]: *** [doc-html-reference] Error 2\n+  [dochtml]   make[2]: Target `doc-html' not remade because of errors.\n+  [dochtml] Full log file: /Users/runner/work/sagetrac-mirror/sagetrac-mirror/logs/dochtml.log\n+make[1]: *** [doc-html] Error 2\n+```\n+on many GH Action runs on #31580, e.g.\n+https://github.com/sagemath/sagetrac-mirror/runs/3104375540 (this is `docker (ubuntu-bionic, standard)`)\n+https://github.com/sagemath/sagetrac-mirror/runs/3104375098 (this is `local-macos (homebrew-macos-python3_xcode, standard, default, macos-11.0)`)\n+\n+also reproducible locally on macOS/Homebrew with `make -j8`.\n+\n+No failure with `make -j1`.\n+\n+This is observed with the latest beta on Linux and macOS after #31948\n+\n+Reported on sage-dev: https://groups.google.com/g/sage-devel/c/ts6u19KpapA/m/22BdxXZhBAAJ\n \n Comment: 1\n \n```\n",
    "created_at": "2021-07-22T06:55:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488349",
    "user": "https://github.com/kwankyu"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,51 @@
+There is apparently a race condition in docbuild which leads to 
 
+```
+  [dochtml]   [reference]     topology: 1937 js index entries
+  [dochtml]   [reference]     valuations: 973 js index entries
+  [dochtml]   [reference] ... done (64387 js index entries)
+  [dochtml]   [reference] copying static files... failed
+  [dochtml]   [reference] WARNING: cannot copy static file FileExistsError(17, 'File exists')
+  [dochtml]   [reference] dumping search index in English (code: en)... done
+  [dochtml]   [reference] The HTML pages are in .tox/local-homebrew-macos-standard/local/share/doc/sage/html/en/reference.
+  [dochtml]   Error building the documentation.
+  [dochtml]   Traceback (most recent call last):
+  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/homebrew/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 197, in _run_module_as_main
+  [dochtml]       return _run_code(code, main_globals, None,
+  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/homebrew/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 87, in _run_code
+  [dochtml]       exec(code, run_globals)
+  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__main__.py", line 2, in <module>
+  [dochtml]       main()
+  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1813, in main
+  [dochtml]       builder()
+  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 133, in f
+  [dochtml]       runsphinx()
+  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py", line 323, in runsphinx
+  [dochtml]       sys.stderr.raise_errors()
+  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py", line 258, in raise_errors
+  [dochtml]       raise OSError(self._error)
+  [dochtml]   OSError: WARNING: cannot copy static file FileExistsError(17, 'File exists')
+  [dochtml]   
+  [dochtml]       Note: incremental documentation builds sometimes cause spurious
+  [dochtml]       error messages. To be certain that these are real errors, run
+  [dochtml]       "make doc-clean" first and try again.
+  [dochtml]   make[3]: *** [doc-html--reference_top] Error 1
+  [dochtml]   make[2]: *** [doc-html-reference] Error 2
+  [dochtml]   make[2]: Target `doc-html' not remade because of errors.
+  [dochtml] Full log file: /Users/runner/work/sagetrac-mirror/sagetrac-mirror/logs/dochtml.log
+make[1]: *** [doc-html] Error 2
+```
+on many GH Action runs on #31580, e.g.
+https://github.com/sagemath/sagetrac-mirror/runs/3104375540 (this is `docker (ubuntu-bionic, standard)`)
+https://github.com/sagemath/sagetrac-mirror/runs/3104375098 (this is `local-macos (homebrew-macos-python3_xcode, standard, default, macos-11.0)`)
+
+also reproducible locally on macOS/Homebrew with `make -j8`.
+
+No failure with `make -j1`.
+
+This is observed with the latest beta on Linux and macOS after #31948
+
+Reported on sage-dev: https://groups.google.com/g/sage-devel/c/ts6u19KpapA/m/22BdxXZhBAAJ
 
 Comment: 1
 
```




---

archive/issue_comments_488350.json:
```json
{
    "body": "<a id='comment:10'></a>This seems tied to #31580: I can only reproduce it with that branch. (I've also tried with the two dependencies for #31580, individually and together, but I don't get this error.) I don't know why upgrading matplotlib would have this effect on docbuilding, though.",
    "created_at": "2021-07-25T23:33:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488350",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:10'></a>This seems tied to #31580: I can only reproduce it with that branch. (I've also tried with the two dependencies for #31580, individually and together, but I don't get this error.) I don't know why upgrading matplotlib would have this effect on docbuilding, though.



---

archive/issue_comments_488351.json:
```json
{
    "body": "<a id='comment:11'></a>Investigating this, I find somethings strange. \n\nMy sage uses system python 3.9 but Sphinx building the doc uses sage's own python 3.9. Is this normal? How can I run manually sage's own python?\n\nThe bug appeared after `make doc-clean` but after a few(or one?) `make -j8`, it disappeared. \n\n#27754 made special tweaks for mac regarding parallel building. Might be related...",
    "created_at": "2021-07-26T02:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488351",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:11'></a>Investigating this, I find somethings strange. 

My sage uses system python 3.9 but Sphinx building the doc uses sage's own python 3.9. Is this normal? How can I run manually sage's own python?

The bug appeared after `make doc-clean` but after a few(or one?) `make -j8`, it disappeared. 

#27754 made special tweaks for mac regarding parallel building. Might be related...



---

archive/issue_comments_488352.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:10 jhpalmieri]:\n> This seems tied to #31580: I can only reproduce it with that branch. (I've also tried with the two dependencies for #31580, individually and together, but I don't get this error.) I don't know why upgrading matplotlib would have this effect on docbuilding, though.\n\n\nRight. Now I saw the crawling bug. Somehow matplotlib writes a file named `_static` with content \n\n```\n/*\n * plot_directive.css\n * ~~~~~~~~~~~~\n *\n * Stylesheet controlling images created using the `plot` directive within\n * Sphinx.\n *\n * :copyright: Copyright 2020-* by the Matplotlib development team.\n * :license: Matplotlib, see LICENSE for details.\n *\n */\n\nimg.plot-directive {\n    border: 0;\n    max-width: 100%;\n}\n```\ninto the directory `local/share/doc/sage/html/en/reference`. Later when Sphinx tries to create a directory named `_static` (into which static html-related files are copied) in the same place, it booms with `FileExistsError` (essentially a name clash). Someone should explain how and why matplotlib write the file `_static` there.",
    "created_at": "2021-07-26T06:54:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488352",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:12'></a>Replying to [comment:10 jhpalmieri]:
> This seems tied to #31580: I can only reproduce it with that branch. (I've also tried with the two dependencies for #31580, individually and together, but I don't get this error.) I don't know why upgrading matplotlib would have this effect on docbuilding, though.


Right. Now I saw the crawling bug. Somehow matplotlib writes a file named `_static` with content 

```
/*
 * plot_directive.css
 * ~~~~~~~~~~~~
 *
 * Stylesheet controlling images created using the `plot` directive within
 * Sphinx.
 *
 * :copyright: Copyright 2020-* by the Matplotlib development team.
 * :license: Matplotlib, see LICENSE for details.
 *
 */

img.plot-directive {
    border: 0;
    max-width: 100%;
}
```
into the directory `local/share/doc/sage/html/en/reference`. Later when Sphinx tries to create a directory named `_static` (into which static html-related files are copied) in the same place, it booms with `FileExistsError` (essentially a name clash). Someone should explain how and why matplotlib write the file `_static` there.



---

archive/issue_comments_488353.json:
```json
{
    "body": "<a id='comment:13'></a>In\n\nhttps://matplotlib.org/stable/_modules/matplotlib/sphinxext/plot_directive.html\n\nFind\n\n```python\ndef _copy_css_file(app, exc):\n    if exc is None and app.builder.format == 'html':\n        src = cbook._get_data_path('plot_directive/plot_directive.css')\n        dst = app.outdir / Path('_static')\n        shutil.copy(src, dst)\n```",
    "created_at": "2021-07-26T10:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488353",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:13'></a>In

https://matplotlib.org/stable/_modules/matplotlib/sphinxext/plot_directive.html

Find

```python
def _copy_css_file(app, exc):
    if exc is None and app.builder.format == 'html':
        src = cbook._get_data_path('plot_directive/plot_directive.css')
        dst = app.outdir / Path('_static')
        shutil.copy(src, dst)
```



---

archive/issue_comments_488354.json:
```json
{
    "body": "<a id='comment:14'></a>Ah, hence Sphinx needs to create `_static` directory before matplotlib does..",
    "created_at": "2021-07-26T10:56:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488354",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:14'></a>Ah, hence Sphinx needs to create `_static` directory before matplotlib does..



---

archive/issue_comments_488355.json:
```json
{
    "body": "<a id='comment:15'></a>I think that this function is called by Sphinx+matplotlib when it invokes (or uses?) the `plot_directive` extension in `src/sage/docs/conf.py` (https://github.com/sagemath/sage/blob/develop/src/sage/docs/conf.py). See in particular line 26 and the `sphinx_plot` function.",
    "created_at": "2021-07-26T20:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488355",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:15'></a>I think that this function is called by Sphinx+matplotlib when it invokes (or uses?) the `plot_directive` extension in `src/sage/docs/conf.py` (https://github.com/sagemath/sage/blob/develop/src/sage/docs/conf.py). See in particular line 26 and the `sphinx_plot` function.



---

archive/issue_comments_488356.json:
```json
{
    "body": "<a id='comment:16'></a>Now I see that the issue of this ticket is caused by abandoning `AllBuilder` in `sage_docbuild/__init__.py` when #31948 made a move to `make`-based docbuilding. The class `AllBuilder` creates the necessary `_static` directory, but `make` does not do it. See this\n\n```python\nclass AllBuilder(object):\n    \"\"\"\n    A class used to build all of the documentation.\n    \"\"\"\n    ...\n    def _wrapper(self, name, *args, **kwds):\n        \"\"\"\n        This is the function which goes through all of the documents\n        and does the actual building.\n        \"\"\"\n        ...\n        logger.warning(\"Building reference manual, second pass.\\n\")\n        sage_makedirs(os.path.join(SAGE_DOC, \"html\", \"en\", \"reference\", \"_static\"))\n        for document in refs:\n            getattr(get_builder(document), name)(*args, **kwds)   \n```\n\nI think the issue of #32043 is similarly caused by #31948 by not invoking `ReferenceTopBuilder` in the `make`-based docbuilding.\n\nI leave the necessary work to fix these to the experts on the `make` files.",
    "created_at": "2021-07-27T06:34:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488356",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:16'></a>Now I see that the issue of this ticket is caused by abandoning `AllBuilder` in `sage_docbuild/__init__.py` when #31948 made a move to `make`-based docbuilding. The class `AllBuilder` creates the necessary `_static` directory, but `make` does not do it. See this

```python
class AllBuilder(object):
    """
    A class used to build all of the documentation.
    """
    ...
    def _wrapper(self, name, *args, **kwds):
        """
        This is the function which goes through all of the documents
        and does the actual building.
        """
        ...
        logger.warning("Building reference manual, second pass.\n")
        sage_makedirs(os.path.join(SAGE_DOC, "html", "en", "reference", "_static"))
        for document in refs:
            getattr(get_builder(document), name)(*args, **kwds)   
```

I think the issue of #32043 is similarly caused by #31948 by not invoking `ReferenceTopBuilder` in the `make`-based docbuilding.

I leave the necessary work to fix these to the experts on the `make` files.



---

archive/issue_comments_488357.json:
```json
{
    "body": "<a id='comment:17'></a>My experiments show the opposite: if creating `_static` explicitly is not done, i.e\n\n```diff\n--- a/src/sage_docbuild/__init__.py\n+++ b/src/sage_docbuild/__init__.py\n@@ -345,7 +345,7 @@ class AllBuilder(object):\n             getattr(get_builder(document), 'inventory')(*args, **kwds)\n \n         logger.warning(\"Building reference manual, second pass.\\n\")\n-        sage_makedirs(os.path.join(SAGE_DOC, \"html\", \"en\", \"reference\", \"_static\"))\n+        # sage_makedirs(os.path.join(SAGE_DOC, \"html\", \"en\", \"reference\", \"_static\"))\n         for document in refs:\n             getattr(get_builder(document), name)(*args, **kwds)\n```\nthen docs build. Indeed, in the big picture doing things in the docs directory should be left to `sphinx` as much as possible.\n`matplotlib` creates `_static` via a `sphinx` extension, so this should be OK, as opposed to brute-forcing it like it's done in that line.",
    "created_at": "2021-07-27T13:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488357",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:17'></a>My experiments show the opposite: if creating `_static` explicitly is not done, i.e

```diff
--- a/src/sage_docbuild/__init__.py
+++ b/src/sage_docbuild/__init__.py
@@ -345,7 +345,7 @@ class AllBuilder(object):
             getattr(get_builder(document), 'inventory')(*args, **kwds)
 
         logger.warning("Building reference manual, second pass.\n")
-        sage_makedirs(os.path.join(SAGE_DOC, "html", "en", "reference", "_static"))
+        # sage_makedirs(os.path.join(SAGE_DOC, "html", "en", "reference", "_static"))
         for document in refs:
             getattr(get_builder(document), name)(*args, **kwds)
```
then docs build. Indeed, in the big picture doing things in the docs directory should be left to `sphinx` as much as possible.
`matplotlib` creates `_static` via a `sphinx` extension, so this should be OK, as opposed to brute-forcing it like it's done in that line.



---

archive/issue_comments_488358.json:
```json
{
    "body": "<a id='comment:18'></a>oops, no, I take comment:17 back. The patch there has no effect.\n\nOn the other hand, I really don't see why the builder should explicitly mess around with the sphinx's directory.",
    "created_at": "2021-07-27T14:02:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488358",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:18'></a>oops, no, I take comment:17 back. The patch there has no effect.

On the other hand, I really don't see why the builder should explicitly mess around with the sphinx's directory.



---

archive/issue_comments_488359.json:
```json
{
    "body": "<a id='comment:19'></a>I think the fault lies with `matplotlib`: in the code in comment:13, they assume that the `_static` directory exists. When it doesn't, then at least on my machine, it creates a *file* `_static` containing the `plot_directive` content, rather than creating `_static/plot_directive.css`.\n\nThe following (where we forcibly create the `_static` directory when building any sub-component of the reference manual before matplotlib does anything) seems to fix it for me:\n\n```diff\ndiff --git a/src/sage_docbuild/__init__.py b/src/sage_docbuild/__init__.py\nindex b63e53539e..41140f4e1e 100644\n--- a/src/sage_docbuild/__init__.py\n+++ b/src/sage_docbuild/__init__.py\n@@ -783,6 +783,7 @@ class ReferenceSubBuilder(DocBuilder):\n         \"\"\"\n         # Force regeneration of all modules if the inherited\n         # and/or underscored members options have changed.\n+        sage_makedirs(os.path.join(SAGE_DOC, \"html\", \"en\", \"reference\", \"_static\"))\n         cache = self.get_cache()\n         force = False\n         try:\n```",
    "created_at": "2021-07-27T16:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488359",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:19'></a>I think the fault lies with `matplotlib`: in the code in comment:13, they assume that the `_static` directory exists. When it doesn't, then at least on my machine, it creates a *file* `_static` containing the `plot_directive` content, rather than creating `_static/plot_directive.css`.

The following (where we forcibly create the `_static` directory when building any sub-component of the reference manual before matplotlib does anything) seems to fix it for me:

```diff
diff --git a/src/sage_docbuild/__init__.py b/src/sage_docbuild/__init__.py
index b63e53539e..41140f4e1e 100644
--- a/src/sage_docbuild/__init__.py
+++ b/src/sage_docbuild/__init__.py
@@ -783,6 +783,7 @@ class ReferenceSubBuilder(DocBuilder):
         """
         # Force regeneration of all modules if the inherited
         # and/or underscored members options have changed.
+        sage_makedirs(os.path.join(SAGE_DOC, "html", "en", "reference", "_static"))
         cache = self.get_cache()
         force = False
         try:
```



---

archive/issue_comments_488360.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:19 jhpalmieri]:\n> I think the fault lies with `matplotlib`: in the code in comment:13, they assume that the `_static` directory exists. When it doesn't, then at least on my machine, it creates a *file* `_static` containing the `plot_directive` content, rather than creating `_static/plot_directive.css`.\n> \n> The following (where we forcibly create the `_static` directory when building any sub-component of the reference manual before matplotlib does anything) seems to fix it for me:\n> \n> ```\n> #!diff\n> diff --git a/src/sage_docbuild/__init__.py b/src/sage_docbuild/__init__.py\n> index b63e53539e..41140f4e1e 100644\n> --- a/src/sage_docbuild/__init__.py\n> +++ b/src/sage_docbuild/__init__.py\n> @@ -783,6 +783,7 @@ class ReferenceSubBuilder(DocBuilder):\n>          \"\"\"\n>          # Force regeneration of all modules if the inherited\n>          # and/or underscored members options have changed.\n> +        sage_makedirs(os.path.join(SAGE_DOC, \"html\", \"en\", \"reference\", \"_static\"))\n>          cache = self.get_cache()\n>          force = False\n>          try:\n> ```\n\n\nyes, looks like an upstream bug. Would it be better to patch matplotlib?\nAnyway, I've left them a comment: https://github.com/matplotlib/matplotlib/commit/25b5ead4639181a2dbcbac83bbeafa92099c6573#r54046428",
    "created_at": "2021-07-27T17:03:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488360",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:20'></a>Replying to [comment:19 jhpalmieri]:
> I think the fault lies with `matplotlib`: in the code in comment:13, they assume that the `_static` directory exists. When it doesn't, then at least on my machine, it creates a *file* `_static` containing the `plot_directive` content, rather than creating `_static/plot_directive.css`.
> 
> The following (where we forcibly create the `_static` directory when building any sub-component of the reference manual before matplotlib does anything) seems to fix it for me:
> 
> ```
> #!diff
> diff --git a/src/sage_docbuild/__init__.py b/src/sage_docbuild/__init__.py
> index b63e53539e..41140f4e1e 100644
> --- a/src/sage_docbuild/__init__.py
> +++ b/src/sage_docbuild/__init__.py
> @@ -783,6 +783,7 @@ class ReferenceSubBuilder(DocBuilder):
>          """
>          # Force regeneration of all modules if the inherited
>          # and/or underscored members options have changed.
> +        sage_makedirs(os.path.join(SAGE_DOC, "html", "en", "reference", "_static"))
>          cache = self.get_cache()
>          force = False
>          try:
> ```


yes, looks like an upstream bug. Would it be better to patch matplotlib?
Anyway, I've left them a comment: https://github.com/matplotlib/matplotlib/commit/25b5ead4639181a2dbcbac83bbeafa92099c6573#r54046428



---

archive/issue_comments_488361.json:
```json
{
    "body": "<a id='comment:21'></a>Thank you for reporting that upstream.\n\nI prefer avoiding patches to other packages if possible. If there ends up being a `matplotlib` fix, we can backport that. I also think that the change in comment:19 in how we use Sphinx won't hurt.",
    "created_at": "2021-07-27T17:27:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488361",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:21'></a>Thank you for reporting that upstream.

I prefer avoiding patches to other packages if possible. If there ends up being a `matplotlib` fix, we can backport that. I also think that the change in comment:19 in how we use Sphinx won't hurt.



---

archive/issue_comments_488362.json:
```json
{
    "body": "<a id='comment:22'></a>Should I create a branch with my proposed change?",
    "created_at": "2021-07-27T21:48:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488362",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:22'></a>Should I create a branch with my proposed change?



---

archive/issue_comments_488363.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:18 dimpase]:\n> oops, no, I take comment:17 back. The patch there has no effect.\n> \n> On the other hand, I really don't see why the builder should explicitly mess around with the sphinx's directory. \n\n\nAs far as I understand, sphinx builder (`StandaloneHTMLBuilder` in `sphinx/builders/html/__init__.py`) creates the `_static` directory. As Sage uses a custom builder, it is the builder's duty to create the directory.",
    "created_at": "2021-07-28T01:12:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488363",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:23'></a>Replying to [comment:18 dimpase]:
> oops, no, I take comment:17 back. The patch there has no effect.
> 
> On the other hand, I really don't see why the builder should explicitly mess around with the sphinx's directory. 


As far as I understand, sphinx builder (`StandaloneHTMLBuilder` in `sphinx/builders/html/__init__.py`) creates the `_static` directory. As Sage uses a custom builder, it is the builder's duty to create the directory.



---

archive/issue_comments_488364.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:22 jhpalmieri]:\n> Should I create a branch with my proposed change?\n\n\n`ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.\n\nThe `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work?",
    "created_at": "2021-07-28T01:37:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488364",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:24'></a>Replying to [comment:22 jhpalmieri]:
> Should I create a branch with my proposed change?


`ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.

The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work?



---

archive/issue_comments_488365.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [comment:24 klee]:\n> Replying to [comment:22 jhpalmieri]:\n> > Should I create a branch with my proposed change?\n\n> \n> `ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.\n> \n> The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work? \n\n\nEverything needs to be tested, but someone could want to build only `en/reference/topology` without building the whole reference manual. Or do that and then build the whole manual later, by which point it's too late to create `_static`: any part of the reference manual which uses the matplotlib `plot_directive` extension will lead to this problem, so I think we need to address it at a pretty low level.\n\nWe didn't run into this before because it's a new Sphinx extension which happens to have a bug (now with a fix at https://github.com/matplotlib/matplotlib/pull/20748).",
    "created_at": "2021-07-28T02:10:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488365",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:25'></a>Replying to [comment:24 klee]:
> Replying to [comment:22 jhpalmieri]:
> > Should I create a branch with my proposed change?

> 
> `ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.
> 
> The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work? 


Everything needs to be tested, but someone could want to build only `en/reference/topology` without building the whole reference manual. Or do that and then build the whole manual later, by which point it's too late to create `_static`: any part of the reference manual which uses the matplotlib `plot_directive` extension will lead to this problem, so I think we need to address it at a pretty low level.

We didn't run into this before because it's a new Sphinx extension which happens to have a bug (now with a fix at https://github.com/matplotlib/matplotlib/pull/20748).



---

archive/issue_comments_488366.json:
```json
{
    "body": "<a id='comment:26'></a>Or maybe we did run into it before: I remember years ago having problems with the `graphviz` Sphinx extension and the `_static` directory, and I wonder if it was the same thing.",
    "created_at": "2021-07-28T02:11:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488366",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:26'></a>Or maybe we did run into it before: I remember years ago having problems with the `graphviz` Sphinx extension and the `_static` directory, and I wonder if it was the same thing.



---

archive/issue_comments_488367.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:25 jhpalmieri]:\n> Replying to [comment:24 klee]:\n> > Replying to [comment:22 jhpalmieri]:\n> > > Should I create a branch with my proposed change?\n\n> > \n> > `ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.\n> > \n> > The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work? \n\n> \n> Everything needs to be tested, but someone could want to build only `en/reference/topology` without building the whole reference manual. Or do that and then build the whole manual later, by which point it's too late to create `_static`: any part of the reference manual which uses the matplotlib `plot_directive` extension will lead to this problem, so I think we need to address it at a pretty low level.\n\n\nAlso, people may invoke docbuilding using `sage --docbuild ...` rather than `make doc`, so I think we have to address it outside of the makefile.",
    "created_at": "2021-07-28T02:17:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488367",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:27'></a>Replying to [comment:25 jhpalmieri]:
> Replying to [comment:24 klee]:
> > Replying to [comment:22 jhpalmieri]:
> > > Should I create a branch with my proposed change?

> > 
> > `ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.
> > 
> > The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work? 

> 
> Everything needs to be tested, but someone could want to build only `en/reference/topology` without building the whole reference manual. Or do that and then build the whole manual later, by which point it's too late to create `_static`: any part of the reference manual which uses the matplotlib `plot_directive` extension will lead to this problem, so I think we need to address it at a pretty low level.


Also, people may invoke docbuilding using `sage --docbuild ...` rather than `make doc`, so I think we have to address it outside of the makefile.



---

archive/issue_comments_488368.json:
```json
{
    "body": "<a id='comment:28'></a>Replying to [comment:27 jhpalmieri]:\n> Replying to [comment:25 jhpalmieri]:\n> > Replying to [comment:24 klee]:\n> > > Replying to [comment:22 jhpalmieri]:\n> > > > Should I create a branch with my proposed change?\n\n> > > \n> > > `ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.\n> > > \n> > > The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work? \n\n> > \n> > Everything needs to be tested, but someone could want to build only `en/reference/topology` without building the whole reference manual. Or do that and then build the whole manual later, by which point it's too late to create `_static`: any part of the reference manual which uses the matplotlib `plot_directive` extension will lead to this problem, so I think we need to address it at a pretty low level.\n\n> \n> Also, people may invoke docbuilding using `sage --docbuild ...` rather than `make doc`, so I think we have to address it outside of the makefile.\n\n\nIsn't it the initial `make`-ing of Sage that also includes docbuilding that we now try to fix? After successful initial make, there is no problem.",
    "created_at": "2021-07-28T03:37:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488368",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:28'></a>Replying to [comment:27 jhpalmieri]:
> Replying to [comment:25 jhpalmieri]:
> > Replying to [comment:24 klee]:
> > > Replying to [comment:22 jhpalmieri]:
> > > > Should I create a branch with my proposed change?

> > > 
> > > `ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.
> > > 
> > > The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work? 

> > 
> > Everything needs to be tested, but someone could want to build only `en/reference/topology` without building the whole reference manual. Or do that and then build the whole manual later, by which point it's too late to create `_static`: any part of the reference manual which uses the matplotlib `plot_directive` extension will lead to this problem, so I think we need to address it at a pretty low level.

> 
> Also, people may invoke docbuilding using `sage --docbuild ...` rather than `make doc`, so I think we have to address it outside of the makefile.


Isn't it the initial `make`-ing of Sage that also includes docbuilding that we now try to fix? After successful initial make, there is no problem.



---

archive/issue_comments_488369.json:
```json
{
    "body": "<a id='comment:29'></a>If someone does `make build` and then `sage --docbuild ...`, it should work.",
    "created_at": "2021-07-28T05:26:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488369",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:29'></a>If someone does `make build` and then `sage --docbuild ...`, it should work.



---

archive/issue_comments_488370.json:
```json
{
    "body": "<a id='comment:30'></a>Replying to [comment:29 jhpalmieri]:\n> If someone does `make build` and then `sage --docbuild ...`, it should work.\n\n\nOkay. Then I have no better idea where the fix should be placed.",
    "created_at": "2021-07-28T07:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488370",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:30'></a>Replying to [comment:29 jhpalmieri]:
> If someone does `make build` and then `sage --docbuild ...`, it should work.


Okay. Then I have no better idea where the fix should be placed.



---

archive/issue_comments_488371.json:
```json
{
    "body": "<a id='comment:31'></a>To fix this particular issue I'm going to add the patch https://github.com/matplotlib/matplotlib/pull/20748 already produced by Matplotlib in #31580",
    "created_at": "2021-07-28T08:58:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488371",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:31'></a>To fix this particular issue I'm going to add the patch https://github.com/matplotlib/matplotlib/pull/20748 already produced by Matplotlib in #31580



---

archive/issue_comments_488372.json:
```json
{
    "body": "<a id='comment:32'></a>Replying to [comment:31 dimpase]:\n> To fix this particular issue I'm going to add the patch https://github.com/matplotlib/matplotlib/pull/20748 already produced by Matplotlib in #31580\n\n\nGood. Then there's nothing to do here.",
    "created_at": "2021-07-28T09:23:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488372",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:32'></a>Replying to [comment:31 dimpase]:
> To fix this particular issue I'm going to add the patch https://github.com/matplotlib/matplotlib/pull/20748 already produced by Matplotlib in #31580


Good. Then there's nothing to do here.



---

archive/issue_comments_488373.json:
```json
{
    "body": "<a id='comment:33'></a>I think that conda builds its own matplotlib. If this is right, then until this fix is included in matplotlib, we either shouldn't merge #31580 or we should accept that the documentation won't build in parallel on conda.",
    "created_at": "2021-07-28T16:13:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488373",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:33'></a>I think that conda builds its own matplotlib. If this is right, then until this fix is included in matplotlib, we either shouldn't merge #31580 or we should accept that the documentation won't build in parallel on conda.



---

archive/issue_comments_488374.json:
```json
{
    "body": "<a id='comment:34'></a>I've left a comment for Isuru on https://github.com/matplotlib/matplotlib/pull/20748",
    "created_at": "2021-07-28T22:10:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488374",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:34'></a>I've left a comment for Isuru on https://github.com/matplotlib/matplotlib/pull/20748



---

archive/issue_comments_488375.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-07-28T22:10:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488375",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_events_085495.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-01T23:52:57Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32262#event-85495"
}
```



---

archive/issue_comments_488376.json:
```json
{
    "body": "<a id='comment:36'></a>matplotlib 3.4.3 is out and appears to have the fix (https://github.com/matplotlib/matplotlib/pull/20751)",
    "created_at": "2021-09-07T23:44:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488376",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:36'></a>matplotlib 3.4.3 is out and appears to have the fix (https://github.com/matplotlib/matplotlib/pull/20751)



---

archive/issue_comments_488377.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-08T00:06:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488377",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_488378.json:
```json
{
    "body": "<a id='comment:37'></a>Let's close this, then.",
    "created_at": "2021-09-08T00:06:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488378",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:37'></a>Let's close this, then.



---

archive/issue_comments_488379.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2021-09-10T04:50:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32262#issuecomment-488379",
    "user": "https://github.com/mkoeppe"
}
```

Resolution: invalid



---

archive/issue_events_085496.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-09-10T04:50:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32262",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32262#event-85496"
}
```
