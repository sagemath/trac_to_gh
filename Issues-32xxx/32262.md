# Issue 32262: docbuild errors out with "cannot copy static file FileExistsError"

archive/issues_032025.json:
```json
{
    "assignees": [],
    "body": "There is apparently a race condition in docbuild which leads to \n\n```\n  [dochtml]   [reference]     topology: 1937 js index entries\n  [dochtml]   [reference]     valuations: 973 js index entries\n  [dochtml]   [reference] ... done (64387 js index entries)\n  [dochtml]   [reference] copying static files... failed\n  [dochtml]   [reference] WARNING: cannot copy static file FileExistsError(17, 'File exists')\n  [dochtml]   [reference] dumping search index in English (code: en)... done\n  [dochtml]   [reference] The HTML pages are in .tox/local-homebrew-macos-standard/local/share/doc/sage/html/en/reference.\n  [dochtml]   Error building the documentation.\n  [dochtml]   Traceback (most recent call last):\n  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/homebrew/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py\", line 197, in _run_module_as_main\n  [dochtml]       return _run_code(code, main_globals, None,\n  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/homebrew/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py\", line 87, in _run_code\n  [dochtml]       exec(code, run_globals)\n  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__main__.py\", line 2, in <module>\n  [dochtml]       main()\n  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 1813, in main\n  [dochtml]       builder()\n  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 133, in f\n  [dochtml]       runsphinx()\n  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py\", line 323, in runsphinx\n  [dochtml]       sys.stderr.raise_errors()\n  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py\", line 258, in raise_errors\n  [dochtml]       raise OSError(self._error)\n  [dochtml]   OSError: WARNING: cannot copy static file FileExistsError(17, 'File exists')\n  [dochtml]   \n  [dochtml]       Note: incremental documentation builds sometimes cause spurious\n  [dochtml]       error messages. To be certain that these are real errors, run\n  [dochtml]       \"make doc-clean\" first and try again.\n  [dochtml]   make[3]: *** [doc-html--reference_top] Error 1\n  [dochtml]   make[2]: *** [doc-html-reference] Error 2\n  [dochtml]   make[2]: Target `doc-html' not remade because of errors.\n  [dochtml] Full log file: /Users/runner/work/sagetrac-mirror/sagetrac-mirror/logs/dochtml.log\nmake[1]: *** [doc-html] Error 2\n```\non many GH Action runs on #31580, e.g.\nhttps://github.com/sagemath/sagetrac-mirror/runs/3104375540 (this is `docker (ubuntu-bionic, standard)`)\nhttps://github.com/sagemath/sagetrac-mirror/runs/3104375098 (this is `local-macos (homebrew-macos-python3_xcode, standard, default, macos-11.0)`)\n\nalso reproducible locally on macOS/Homebrew with `make -j8`.\n\nNo failure with `make -j1`.\n\nThis is observed with the latest beta on Linux and macOS after #31948\n\nReported on sage-dev: https://groups.google.com/g/sage-devel/c/ts6u19KpapA/m/22BdxXZhBAAJ\n\nDepends on #31580\n\nUpstream: **Fixed upstream, but not in a stable release.**\n\nCC:  @jhpalmieri @isuruf\n\nComponent: **build**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/32262_\n\n",
    "closed_at": "2021-09-10T04:50:10Z",
    "created_at": "2021-07-22T02:03:00Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/c%3A%20build",
        "https://github.com/sagemath/sage/labels/invalid"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "docbuild errors out with \"cannot copy static file FileExistsError\"",
    "type": "issue",
    "updated_at": "2021-09-10T04:50:10Z",
    "url": "https://github.com/sagemath/sage/issues/32262",
    "user": "https://github.com/kwankyu"
}
```
There is apparently a race condition in docbuild which leads to 

```
  [dochtml]   [reference]     topology: 1937 js index entries
  [dochtml]   [reference]     valuations: 973 js index entries
  [dochtml]   [reference] ... done (64387 js index entries)
  [dochtml]   [reference] copying static files... failed
  [dochtml]   [reference] WARNING: cannot copy static file FileExistsError(17, 'File exists')
  [dochtml]   [reference] dumping search index in English (code: en)... done
  [dochtml]   [reference] The HTML pages are in .tox/local-homebrew-macos-standard/local/share/doc/sage/html/en/reference.
  [dochtml]   Error building the documentation.
  [dochtml]   Traceback (most recent call last):
  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/homebrew/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 197, in _run_module_as_main
  [dochtml]       return _run_code(code, main_globals, None,
  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/homebrew/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 87, in _run_code
  [dochtml]       exec(code, run_globals)
  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__main__.py", line 2, in <module>
  [dochtml]       main()
  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1813, in main
  [dochtml]       builder()
  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 133, in f
  [dochtml]       runsphinx()
  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py", line 323, in runsphinx
  [dochtml]       sys.stderr.raise_errors()
  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py", line 258, in raise_errors
  [dochtml]       raise OSError(self._error)
  [dochtml]   OSError: WARNING: cannot copy static file FileExistsError(17, 'File exists')
  [dochtml]   
  [dochtml]       Note: incremental documentation builds sometimes cause spurious
  [dochtml]       error messages. To be certain that these are real errors, run
  [dochtml]       "make doc-clean" first and try again.
  [dochtml]   make[3]: *** [doc-html--reference_top] Error 1
  [dochtml]   make[2]: *** [doc-html-reference] Error 2
  [dochtml]   make[2]: Target `doc-html' not remade because of errors.
  [dochtml] Full log file: /Users/runner/work/sagetrac-mirror/sagetrac-mirror/logs/dochtml.log
make[1]: *** [doc-html] Error 2
```
on many GH Action runs on #31580, e.g.
https://github.com/sagemath/sagetrac-mirror/runs/3104375540 (this is `docker (ubuntu-bionic, standard)`)
https://github.com/sagemath/sagetrac-mirror/runs/3104375098 (this is `local-macos (homebrew-macos-python3_xcode, standard, default, macos-11.0)`)

also reproducible locally on macOS/Homebrew with `make -j8`.

No failure with `make -j1`.

This is observed with the latest beta on Linux and macOS after #31948

Reported on sage-dev: https://groups.google.com/g/sage-devel/c/ts6u19KpapA/m/22BdxXZhBAAJ

Depends on #31580

Upstream: **Fixed upstream, but not in a stable release.**

CC:  @jhpalmieri @isuruf

Component: **build**

_Issue created by migration from https://trac.sagemath.org/ticket/32262_





---

archive/issue_events_441757.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2021-07-22T02:03:00Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32262#event-441757"
}
```



---

archive/issue_events_441758.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2021-07-22T02:03:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "0000b0",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32262#event-441758"
}
```



---

archive/issue_events_441759.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2021-07-22T02:03:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32262#event-441759"
}
```



---

archive/issue_events_441760.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2021-07-22T02:03:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32262#event-441760"
}
```



---

archive/issue_comments_519591.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nThis is just a gut feeling but I suspect the issue is related with the option `--no-prune-empty-dirs` in these lines\n\n```diff\n+\t$(MAKE) SAGE_DOCBUILD_OPTS=\"$(SAGE_DOCBUILD_OPTS) --no-prune-empty-dirs\" $(foreach doc, $(OTHER_DOCS), doc-inventory--$(subst /,-,$(doc)))\n+\t$(MAKE) SAGE_DOCBUILD_OPTS=\"$(SAGE_DOCBUILD_OPTS) --no-prune-empty-dirs\" doc-inventory--reference_top\n```\n\nThe other issue in #32043 may be related with this.",
    "created_at": "2021-07-22T02:10:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519591",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:1" align="right">comment:1</div>

This is just a gut feeling but I suspect the issue is related with the option `--no-prune-empty-dirs` in these lines

```diff
+	$(MAKE) SAGE_DOCBUILD_OPTS="$(SAGE_DOCBUILD_OPTS) --no-prune-empty-dirs" $(foreach doc, $(OTHER_DOCS), doc-inventory--$(subst /,-,$(doc)))
+	$(MAKE) SAGE_DOCBUILD_OPTS="$(SAGE_DOCBUILD_OPTS) --no-prune-empty-dirs" doc-inventory--reference_top
```

The other issue in #32043 may be related with this.



---

archive/issue_comments_519592.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-This is observed with the latest beta on Linux and macOS:\n+After #31948, this is observed with the latest beta on Linux and macOS:\n \n ```\n ...\n``````\n",
    "created_at": "2021-07-22T02:11:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519592",
    "user": "https://github.com/kwankyu"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-This is observed with the latest beta on Linux and macOS:
+After #31948, this is observed with the latest beta on Linux and macOS:
 
 ```
 ...
``````




---

archive/issue_comments_519593.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\n`git grep -i static src/sage_docbuild/` reveals several places that would be worth inspecting.",
    "created_at": "2021-07-22T02:51:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519593",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:3" align="right">comment:3</div>

`git grep -i static src/sage_docbuild/` reveals several places that would be worth inspecting.



---

archive/issue_comments_519594.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nThis is where the error is raised: in `sphinx/builders/html/__init__.py`\n\n```python\n    def copy_html_static_files(self, context: Dict) -> None:\n        def onerror(filename: str, error: Exception) -> None:\n            logger.warning(__('Failed to copy a file in html_static_file: %s: %r'),\n                           filename, error)\n\n        excluded = Matcher(self.config.exclude_patterns + [\"**/.*\"])\n        for entry in self.config.html_static_path:\n            copy_asset(path.join(self.confdir, entry),\n                       path.join(self.outdir, '_static'),\n                       excluded, context=context, renderer=self.templates, onerror=onerror)\n\n    def copy_html_logo(self) -> None:\n        if self.config.html_logo and not isurl(self.config.html_logo):\n            copy_asset(path.join(self.confdir, self.config.html_logo),\n                       path.join(self.outdir, '_static'))\n\n    def copy_html_favicon(self) -> None:\n        if self.config.html_favicon and not isurl(self.config.html_favicon):\n            copy_asset(path.join(self.confdir, self.config.html_favicon),\n                       path.join(self.outdir, '_static'))\n\n    def copy_static_files(self) -> None:\n        try:\n            with progress_message(__('copying static files')):\n                ensuredir(path.join(self.outdir, '_static'))\n\n                # prepare context for templates\n                context = self.globalcontext.copy()\n                if self.indexer is not None:\n                    context.update(self.indexer.context_for_searchtool())\n\n                self.create_pygments_style_file()\n                self.copy_translation_js()\n                self.copy_stemmer_js()\n                self.copy_theme_static_files(context)\n                self.copy_html_static_files(context)\n                self.copy_html_logo()\n                self.copy_html_favicon()\n        except OSError as err:\n            logger.warning(__('cannot copy static file %r'), err)  \n```",
    "created_at": "2021-07-22T04:15:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519594",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:4" align="right">comment:4</div>

This is where the error is raised: in `sphinx/builders/html/__init__.py`

```python
    def copy_html_static_files(self, context: Dict) -> None:
        def onerror(filename: str, error: Exception) -> None:
            logger.warning(__('Failed to copy a file in html_static_file: %s: %r'),
                           filename, error)

        excluded = Matcher(self.config.exclude_patterns + ["**/.*"])
        for entry in self.config.html_static_path:
            copy_asset(path.join(self.confdir, entry),
                       path.join(self.outdir, '_static'),
                       excluded, context=context, renderer=self.templates, onerror=onerror)

    def copy_html_logo(self) -> None:
        if self.config.html_logo and not isurl(self.config.html_logo):
            copy_asset(path.join(self.confdir, self.config.html_logo),
                       path.join(self.outdir, '_static'))

    def copy_html_favicon(self) -> None:
        if self.config.html_favicon and not isurl(self.config.html_favicon):
            copy_asset(path.join(self.confdir, self.config.html_favicon),
                       path.join(self.outdir, '_static'))

    def copy_static_files(self) -> None:
        try:
            with progress_message(__('copying static files')):
                ensuredir(path.join(self.outdir, '_static'))

                # prepare context for templates
                context = self.globalcontext.copy()
                if self.indexer is not None:
                    context.update(self.indexer.context_for_searchtool())

                self.create_pygments_style_file()
                self.copy_translation_js()
                self.copy_stemmer_js()
                self.copy_theme_static_files(context)
                self.copy_html_static_files(context)
                self.copy_html_logo()
                self.copy_html_favicon()
        except OSError as err:
            logger.warning(__('cannot copy static file %r'), err)  
```



---

archive/issue_comments_519595.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nWhat is the command to reproduce the bug?",
    "created_at": "2021-07-22T04:26:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519595",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:5" align="right">comment:5</div>

What is the command to reproduce the bug?



---

archive/issue_events_441761.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-22T05:45:11Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32262#event-441761"
}
```



---

archive/issue_events_441762.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-22T05:45:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32262#event-441762"
}
```



---

archive/issue_comments_519596.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@kwankyu](#comment%3A5):\n> What is the command to reproduce the bug?\n\ntry building the branch of #31580 with `make -jX` (for X=8, say?) on macOS or Ubuntu.\n\nI've opened a duplicate ticket (oops) #32263 with a bit more info.",
    "created_at": "2021-07-22T06:50:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519596",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@kwankyu](#comment%3A5):
> What is the command to reproduce the bug?

try building the branch of #31580 with `make -jX` (for X=8, say?) on macOS or Ubuntu.

I've opened a duplicate ticket (oops) #32263 with a bit more info.



---

archive/issue_comments_519597.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,30 +1,48 @@\n-After #31948, this is observed with the latest beta on Linux and macOS:\n+There is apparently a race condition in docbuild which leads to \n \n ```\n-...\n-[dochtml] [reference] valuations: 1 todos, 14 index, 0 citations, 13 modules\n-[dochtml] [reference] ... done (499 todos, 2531 index, 1644 citations,\n-2153 modules)\n-[dochtml] [reference] preparing documents... skipping loading of indexes... done\n-[dochtml] [reference] Merging js index files...\n-[dochtml] [reference] algebras: 4424 js index entries\n-[dochtml] [reference] arithgroup: 1204 js index entries\n-...\n+  [dochtml]   [reference]     topology: 1937 js index entries\n+  [dochtml]   [reference]     valuations: 973 js index entries\n+  [dochtml]   [reference] ... done (64387 js index entries)\n+  [dochtml]   [reference] copying static files... failed\n+  [dochtml]   [reference] WARNING: cannot copy static file FileExistsError(17, 'File exists')\n+  [dochtml]   [reference] dumping search index in English (code: en)... done\n+  [dochtml]   [reference] The HTML pages are in .tox/local-homebrew-macos-standard/local/share/doc/sage/html/en/reference.\n+  [dochtml]   Error building the documentation.\n+  [dochtml]   Traceback (most recent call last):\n+  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/homebrew/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py\", line 197, in _run_module_as_main\n+  [dochtml]       return _run_code(code, main_globals, None,\n+  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/homebrew/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py\", line 87, in _run_code\n+  [dochtml]       exec(code, run_globals)\n+  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__main__.py\", line 2, in <module>\n+  [dochtml]       main()\n+  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 1813, in main\n+  [dochtml]       builder()\n+  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__init__.py\", line 133, in f\n+  [dochtml]       runsphinx()\n+  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py\", line 323, in runsphinx\n+  [dochtml]       sys.stderr.raise_errors()\n+  [dochtml]     File \"/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py\", line 258, in raise_errors\n+  [dochtml]       raise OSError(self._error)\n+  [dochtml]   OSError: WARNING: cannot copy static file FileExistsError(17, 'File exists')\n+  [dochtml]   \n+  [dochtml]       Note: incremental documentation builds sometimes cause spurious\n+  [dochtml]       error messages. To be certain that these are real errors, run\n+  [dochtml]       \"make doc-clean\" first and try again.\n+  [dochtml]   make[3]: *** [doc-html--reference_top] Error 1\n+  [dochtml]   make[2]: *** [doc-html-reference] Error 2\n+  [dochtml]   make[2]: Target `doc-html' not remade because of errors.\n+  [dochtml] Full log file: /Users/runner/work/sagetrac-mirror/sagetrac-mirror/logs/dochtml.log\n+make[1]: *** [doc-html] Error 2\n+```\n+on many GH Action runs on #31580, e.g.\n+https://github.com/sagemath/sagetrac-mirror/runs/3104375540 (this is `docker (ubuntu-bionic, standard)`)\n+https://github.com/sagemath/sagetrac-mirror/runs/3104375098 (this is `local-macos (homebrew-macos-python3_xcode, standard, default, macos-11.0)`)\n \n-[dochtml] [reference] topology: 1937 js index entries\n-[dochtml] [reference] valuations: 973 js index entries\n-[dochtml] [reference] ... done (64387 js index entries)\n-[dochtml] [reference] copying static files... failed\n-[dochtml] [reference] WARNING: cannot copy static file\n-FileExistsError(17, 'File exists')\n-[dochtml] [reference] dumping search index in English (code: en)... done\n-[dochtml] [reference] The HTML pages are in\n-local/share/doc/sage/html/en/reference.\n-[dochtml] Error building the documentation.\n-```\n-but\n+also reproducible locally on macOS/Homebrew with `make -j8`.\n \n-```\n-make -j1\n-```\n-allows the docs to build (slowly)\n+No failure with `make -j1`.\n+\n+This is observed with the latest beta on Linux and macOS after #31948\n+\n+Reported on sage-dev: https://groups.google.com/g/sage-devel/c/ts6u19KpapA/m/22BdxXZhBAAJ\n``````\n",
    "created_at": "2021-07-22T06:55:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519597",
    "user": "https://github.com/kwankyu"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,30 +1,48 @@
-After #31948, this is observed with the latest beta on Linux and macOS:
+There is apparently a race condition in docbuild which leads to 
 
 ```
-...
-[dochtml] [reference] valuations: 1 todos, 14 index, 0 citations, 13 modules
-[dochtml] [reference] ... done (499 todos, 2531 index, 1644 citations,
-2153 modules)
-[dochtml] [reference] preparing documents... skipping loading of indexes... done
-[dochtml] [reference] Merging js index files...
-[dochtml] [reference] algebras: 4424 js index entries
-[dochtml] [reference] arithgroup: 1204 js index entries
-...
+  [dochtml]   [reference]     topology: 1937 js index entries
+  [dochtml]   [reference]     valuations: 973 js index entries
+  [dochtml]   [reference] ... done (64387 js index entries)
+  [dochtml]   [reference] copying static files... failed
+  [dochtml]   [reference] WARNING: cannot copy static file FileExistsError(17, 'File exists')
+  [dochtml]   [reference] dumping search index in English (code: en)... done
+  [dochtml]   [reference] The HTML pages are in .tox/local-homebrew-macos-standard/local/share/doc/sage/html/en/reference.
+  [dochtml]   Error building the documentation.
+  [dochtml]   Traceback (most recent call last):
+  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/homebrew/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 197, in _run_module_as_main
+  [dochtml]       return _run_code(code, main_globals, None,
+  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/homebrew/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/runpy.py", line 87, in _run_code
+  [dochtml]       exec(code, run_globals)
+  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__main__.py", line 2, in <module>
+  [dochtml]       main()
+  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 1813, in main
+  [dochtml]       builder()
+  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/__init__.py", line 133, in f
+  [dochtml]       runsphinx()
+  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py", line 323, in runsphinx
+  [dochtml]       sys.stderr.raise_errors()
+  [dochtml]     File "/Users/runner/work/sagetrac-mirror/sagetrac-mirror/.tox/local-homebrew-macos-standard/local/lib/python3.9/site-packages/sage_docbuild/sphinxbuild.py", line 258, in raise_errors
+  [dochtml]       raise OSError(self._error)
+  [dochtml]   OSError: WARNING: cannot copy static file FileExistsError(17, 'File exists')
+  [dochtml]   
+  [dochtml]       Note: incremental documentation builds sometimes cause spurious
+  [dochtml]       error messages. To be certain that these are real errors, run
+  [dochtml]       "make doc-clean" first and try again.
+  [dochtml]   make[3]: *** [doc-html--reference_top] Error 1
+  [dochtml]   make[2]: *** [doc-html-reference] Error 2
+  [dochtml]   make[2]: Target `doc-html' not remade because of errors.
+  [dochtml] Full log file: /Users/runner/work/sagetrac-mirror/sagetrac-mirror/logs/dochtml.log
+make[1]: *** [doc-html] Error 2
+```
+on many GH Action runs on #31580, e.g.
+https://github.com/sagemath/sagetrac-mirror/runs/3104375540 (this is `docker (ubuntu-bionic, standard)`)
+https://github.com/sagemath/sagetrac-mirror/runs/3104375098 (this is `local-macos (homebrew-macos-python3_xcode, standard, default, macos-11.0)`)
 
-[dochtml] [reference] topology: 1937 js index entries
-[dochtml] [reference] valuations: 973 js index entries
-[dochtml] [reference] ... done (64387 js index entries)
-[dochtml] [reference] copying static files... failed
-[dochtml] [reference] WARNING: cannot copy static file
-FileExistsError(17, 'File exists')
-[dochtml] [reference] dumping search index in English (code: en)... done
-[dochtml] [reference] The HTML pages are in
-local/share/doc/sage/html/en/reference.
-[dochtml] Error building the documentation.
-```
-but
+also reproducible locally on macOS/Homebrew with `make -j8`.
 
-```
-make -j1
-```
-allows the docs to build (slowly)
+No failure with `make -j1`.
+
+This is observed with the latest beta on Linux and macOS after #31948
+
+Reported on sage-dev: https://groups.google.com/g/sage-devel/c/ts6u19KpapA/m/22BdxXZhBAAJ
``````




---

archive/issue_comments_519598.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nThis seems tied to #31580: I can only reproduce it with that branch. (I've also tried with the two dependencies for #31580, individually and together, but I don't get this error.) I don't know why upgrading matplotlib would have this effect on docbuilding, though.",
    "created_at": "2021-07-25T23:33:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519598",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:10" align="right">comment:10</div>

This seems tied to #31580: I can only reproduce it with that branch. (I've also tried with the two dependencies for #31580, individually and together, but I don't get this error.) I don't know why upgrading matplotlib would have this effect on docbuilding, though.



---

archive/issue_comments_519599.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nInvestigating this, I find somethings strange. \n\nMy sage uses system python 3.9 but Sphinx building the doc uses sage's own python 3.9. Is this normal? How can I run manually sage's own python?\n\nThe bug appeared after `make doc-clean` but after a few(or one?) `make -j8`, it disappeared. \n\n#27754 made special tweaks for mac regarding parallel building. Might be related...",
    "created_at": "2021-07-26T02:10:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519599",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:11" align="right">comment:11</div>

Investigating this, I find somethings strange. 

My sage uses system python 3.9 but Sphinx building the doc uses sage's own python 3.9. Is this normal? How can I run manually sage's own python?

The bug appeared after `make doc-clean` but after a few(or one?) `make -j8`, it disappeared. 

#27754 made special tweaks for mac regarding parallel building. Might be related...



---

archive/issue_comments_519600.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@jhpalmieri](#comment%3A10):\n> This seems tied to #31580: I can only reproduce it with that branch. (I've also tried with the two dependencies for #31580, individually and together, but I don't get this error.) I don't know why upgrading matplotlib would have this effect on docbuilding, though.\n\nRight. Now I saw the crawling bug. Somehow matplotlib writes a file named `_static` with content \n\n```\n/*\n * plot_directive.css\n * ~~~~~~~~~~~~\n *\n * Stylesheet controlling images created using the `plot` directive within\n * Sphinx.\n *\n * :copyright: Copyright 2020-* by the Matplotlib development team.\n * :license: Matplotlib, see LICENSE for details.\n *\n */\n\nimg.plot-directive {\n    border: 0;\n    max-width: 100%;\n}\n```\ninto the directory `local/share/doc/sage/html/en/reference`. Later when Sphinx tries to create a directory named `_static` (into which static html-related files are copied) in the same place, it booms with `FileExistsError` (essentially a name clash). Someone should explain how and why matplotlib write the file `_static` there.",
    "created_at": "2021-07-26T06:54:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519600",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@jhpalmieri](#comment%3A10):
> This seems tied to #31580: I can only reproduce it with that branch. (I've also tried with the two dependencies for #31580, individually and together, but I don't get this error.) I don't know why upgrading matplotlib would have this effect on docbuilding, though.

Right. Now I saw the crawling bug. Somehow matplotlib writes a file named `_static` with content 

```
/*
 * plot_directive.css
 * ~~~~~~~~~~~~
 *
 * Stylesheet controlling images created using the `plot` directive within
 * Sphinx.
 *
 * :copyright: Copyright 2020-* by the Matplotlib development team.
 * :license: Matplotlib, see LICENSE for details.
 *
 */

img.plot-directive {
    border: 0;
    max-width: 100%;
}
```
into the directory `local/share/doc/sage/html/en/reference`. Later when Sphinx tries to create a directory named `_static` (into which static html-related files are copied) in the same place, it booms with `FileExistsError` (essentially a name clash). Someone should explain how and why matplotlib write the file `_static` there.



---

archive/issue_comments_519601.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nIn\n\nhttps://matplotlib.org/stable/_modules/matplotlib/sphinxext/plot_directive.html\n\nFind\n\n```python\ndef _copy_css_file(app, exc):\n    if exc is None and app.builder.format == 'html':\n        src = cbook._get_data_path('plot_directive/plot_directive.css')\n        dst = app.outdir / Path('_static')\n        shutil.copy(src, dst)\n```",
    "created_at": "2021-07-26T10:51:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519601",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:13" align="right">comment:13</div>

In

https://matplotlib.org/stable/_modules/matplotlib/sphinxext/plot_directive.html

Find

```python
def _copy_css_file(app, exc):
    if exc is None and app.builder.format == 'html':
        src = cbook._get_data_path('plot_directive/plot_directive.css')
        dst = app.outdir / Path('_static')
        shutil.copy(src, dst)
```



---

archive/issue_comments_519602.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nAh, hence Sphinx needs to create `_static` directory before matplotlib does..",
    "created_at": "2021-07-26T10:56:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519602",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:14" align="right">comment:14</div>

Ah, hence Sphinx needs to create `_static` directory before matplotlib does..



---

archive/issue_comments_519603.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nI think that this function is called by Sphinx+matplotlib when it invokes (or uses?) the `plot_directive` extension in `src/sage/docs/conf.py` (https://github.com/sagemath/sage/blob/develop/src/sage/docs/conf.py). See in particular line 26 and the `sphinx_plot` function.",
    "created_at": "2021-07-26T20:29:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519603",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:15" align="right">comment:15</div>

I think that this function is called by Sphinx+matplotlib when it invokes (or uses?) the `plot_directive` extension in `src/sage/docs/conf.py` (https://github.com/sagemath/sage/blob/develop/src/sage/docs/conf.py). See in particular line 26 and the `sphinx_plot` function.



---

archive/issue_comments_519604.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nNow I see that the issue of this ticket is caused by abandoning `AllBuilder` in `sage_docbuild/__init__.py` when #31948 made a move to `make`-based docbuilding. The class `AllBuilder` creates the necessary `_static` directory, but `make` does not do it. See this\n\n```python\nclass AllBuilder(object):\n    \"\"\"\n    A class used to build all of the documentation.\n    \"\"\"\n    ...\n    def _wrapper(self, name, *args, **kwds):\n        \"\"\"\n        This is the function which goes through all of the documents\n        and does the actual building.\n        \"\"\"\n        ...\n        logger.warning(\"Building reference manual, second pass.\\n\")\n        sage_makedirs(os.path.join(SAGE_DOC, \"html\", \"en\", \"reference\", \"_static\"))\n        for document in refs:\n            getattr(get_builder(document), name)(*args, **kwds)   \n```\n\nI think the issue of #32043 is similarly caused by #31948 by not invoking `ReferenceTopBuilder` in the `make`-based docbuilding.\n\nI leave the necessary work to fix these to the experts on the `make` files.",
    "created_at": "2021-07-27T06:34:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519604",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:16" align="right">comment:16</div>

Now I see that the issue of this ticket is caused by abandoning `AllBuilder` in `sage_docbuild/__init__.py` when #31948 made a move to `make`-based docbuilding. The class `AllBuilder` creates the necessary `_static` directory, but `make` does not do it. See this

```python
class AllBuilder(object):
    """
    A class used to build all of the documentation.
    """
    ...
    def _wrapper(self, name, *args, **kwds):
        """
        This is the function which goes through all of the documents
        and does the actual building.
        """
        ...
        logger.warning("Building reference manual, second pass.\n")
        sage_makedirs(os.path.join(SAGE_DOC, "html", "en", "reference", "_static"))
        for document in refs:
            getattr(get_builder(document), name)(*args, **kwds)   
```

I think the issue of #32043 is similarly caused by #31948 by not invoking `ReferenceTopBuilder` in the `make`-based docbuilding.

I leave the necessary work to fix these to the experts on the `make` files.



---

archive/issue_comments_519605.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nMy experiments show the opposite: if creating `_static` explicitly is not done, i.e\n\n```diff\n--- a/src/sage_docbuild/__init__.py\n+++ b/src/sage_docbuild/__init__.py\n@@ -345,7 +345,7 @@ class AllBuilder(object):\n             getattr(get_builder(document), 'inventory')(*args, **kwds)\n \n         logger.warning(\"Building reference manual, second pass.\\n\")\n-        sage_makedirs(os.path.join(SAGE_DOC, \"html\", \"en\", \"reference\", \"_static\"))\n+        # sage_makedirs(os.path.join(SAGE_DOC, \"html\", \"en\", \"reference\", \"_static\"))\n         for document in refs:\n             getattr(get_builder(document), name)(*args, **kwds)\n```\nthen docs build. Indeed, in the big picture doing things in the docs directory should be left to `sphinx` as much as possible.\n`matplotlib` creates `_static` via a `sphinx` extension, so this should be OK, as opposed to brute-forcing it like it's done in that line.",
    "created_at": "2021-07-27T13:18:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519605",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:17" align="right">comment:17</div>

My experiments show the opposite: if creating `_static` explicitly is not done, i.e

```diff
--- a/src/sage_docbuild/__init__.py
+++ b/src/sage_docbuild/__init__.py
@@ -345,7 +345,7 @@ class AllBuilder(object):
             getattr(get_builder(document), 'inventory')(*args, **kwds)
 
         logger.warning("Building reference manual, second pass.\n")
-        sage_makedirs(os.path.join(SAGE_DOC, "html", "en", "reference", "_static"))
+        # sage_makedirs(os.path.join(SAGE_DOC, "html", "en", "reference", "_static"))
         for document in refs:
             getattr(get_builder(document), name)(*args, **kwds)
```
then docs build. Indeed, in the big picture doing things in the docs directory should be left to `sphinx` as much as possible.
`matplotlib` creates `_static` via a `sphinx` extension, so this should be OK, as opposed to brute-forcing it like it's done in that line.



---

archive/issue_comments_519606.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\noops, no, I take [comment:17](#comment%3A17) back. The patch there has no effect.\n\nOn the other hand, I really don't see why the builder should explicitly mess around with the sphinx's directory.",
    "created_at": "2021-07-27T14:02:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519606",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:18" align="right">comment:18</div>

oops, no, I take [comment:17](#comment%3A17) back. The patch there has no effect.

On the other hand, I really don't see why the builder should explicitly mess around with the sphinx's directory.



---

archive/issue_comments_519607.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nI think the fault lies with `matplotlib`: in the code in [comment:13](#comment%3A13), they assume that the `_static` directory exists. When it doesn't, then at least on my machine, it creates a *file* `_static` containing the `plot_directive` content, rather than creating `_static/plot_directive.css`.\n\nThe following (where we forcibly create the `_static` directory when building any sub-component of the reference manual before matplotlib does anything) seems to fix it for me:\n\n```diff\ndiff --git a/src/sage_docbuild/__init__.py b/src/sage_docbuild/__init__.py\nindex b63e53539e..41140f4e1e 100644\n--- a/src/sage_docbuild/__init__.py\n+++ b/src/sage_docbuild/__init__.py\n@@ -783,6 +783,7 @@ class ReferenceSubBuilder(DocBuilder):\n         \"\"\"\n         # Force regeneration of all modules if the inherited\n         # and/or underscored members options have changed.\n+        sage_makedirs(os.path.join(SAGE_DOC, \"html\", \"en\", \"reference\", \"_static\"))\n         cache = self.get_cache()\n         force = False\n         try:\n```",
    "created_at": "2021-07-27T16:20:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519607",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:19" align="right">comment:19</div>

I think the fault lies with `matplotlib`: in the code in [comment:13](#comment%3A13), they assume that the `_static` directory exists. When it doesn't, then at least on my machine, it creates a *file* `_static` containing the `plot_directive` content, rather than creating `_static/plot_directive.css`.

The following (where we forcibly create the `_static` directory when building any sub-component of the reference manual before matplotlib does anything) seems to fix it for me:

```diff
diff --git a/src/sage_docbuild/__init__.py b/src/sage_docbuild/__init__.py
index b63e53539e..41140f4e1e 100644
--- a/src/sage_docbuild/__init__.py
+++ b/src/sage_docbuild/__init__.py
@@ -783,6 +783,7 @@ class ReferenceSubBuilder(DocBuilder):
         """
         # Force regeneration of all modules if the inherited
         # and/or underscored members options have changed.
+        sage_makedirs(os.path.join(SAGE_DOC, "html", "en", "reference", "_static"))
         cache = self.get_cache()
         force = False
         try:
```



---

archive/issue_comments_519608.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@jhpalmieri](#comment%3A19):\n> I think the fault lies with `matplotlib`: in the code in [comment:13](#comment%3A13), they assume that the `_static` directory exists. When it doesn't, then at least on my machine, it creates a *file* `_static` containing the `plot_directive` content, rather than creating `_static/plot_directive.css`.\n> \n> The following (where we forcibly create the `_static` directory when building any sub-component of the reference manual before matplotlib does anything) seems to fix it for me:\n> \n> ```diff\n> diff --git a/src/sage_docbuild/__init__.py b/src/sage_docbuild/__init__.py\n> index b63e53539e..41140f4e1e 100644\n> --- a/src/sage_docbuild/__init__.py\n> +++ b/src/sage_docbuild/__init__.py\n> @@ -783,6 +783,7 @@ class ReferenceSubBuilder(DocBuilder):\n>          \"\"\"\n>          # Force regeneration of all modules if the inherited\n>          # and/or underscored members options have changed.\n> +        sage_makedirs(os.path.join(SAGE_DOC, \"html\", \"en\", \"reference\", \"_static\"))\n>          cache = self.get_cache()\n>          force = False\n>          try:\n> ```\n\nyes, looks like an upstream bug. Would it be better to patch matplotlib?\nAnyway, I've left them a comment: https://github.com/matplotlib/matplotlib/commit/25b5ead4639181a2dbcbac83bbeafa92099c6573#r54046428",
    "created_at": "2021-07-27T17:03:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519608",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@jhpalmieri](#comment%3A19):
> I think the fault lies with `matplotlib`: in the code in [comment:13](#comment%3A13), they assume that the `_static` directory exists. When it doesn't, then at least on my machine, it creates a *file* `_static` containing the `plot_directive` content, rather than creating `_static/plot_directive.css`.
> 
> The following (where we forcibly create the `_static` directory when building any sub-component of the reference manual before matplotlib does anything) seems to fix it for me:
> 
> ```diff
> diff --git a/src/sage_docbuild/__init__.py b/src/sage_docbuild/__init__.py
> index b63e53539e..41140f4e1e 100644
> --- a/src/sage_docbuild/__init__.py
> +++ b/src/sage_docbuild/__init__.py
> @@ -783,6 +783,7 @@ class ReferenceSubBuilder(DocBuilder):
>          """
>          # Force regeneration of all modules if the inherited
>          # and/or underscored members options have changed.
> +        sage_makedirs(os.path.join(SAGE_DOC, "html", "en", "reference", "_static"))
>          cache = self.get_cache()
>          force = False
>          try:
> ```

yes, looks like an upstream bug. Would it be better to patch matplotlib?
Anyway, I've left them a comment: https://github.com/matplotlib/matplotlib/commit/25b5ead4639181a2dbcbac83bbeafa92099c6573#r54046428



---

archive/issue_comments_519609.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nThank you for reporting that upstream.\n\nI prefer avoiding patches to other packages if possible. If there ends up being a `matplotlib` fix, we can backport that. I also think that the change in [comment:19](#comment%3A19) in how we use Sphinx won't hurt.",
    "created_at": "2021-07-27T17:27:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519609",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:21" align="right">comment:21</div>

Thank you for reporting that upstream.

I prefer avoiding patches to other packages if possible. If there ends up being a `matplotlib` fix, we can backport that. I also think that the change in [comment:19](#comment%3A19) in how we use Sphinx won't hurt.



---

archive/issue_comments_519610.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nShould I create a branch with my proposed change?",
    "created_at": "2021-07-27T21:48:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519610",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:22" align="right">comment:22</div>

Should I create a branch with my proposed change?



---

archive/issue_comments_519611.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@dimpase](#comment%3A18):\n> oops, no, I take [comment:17](#comment%3A17) back. The patch there has no effect.\n> \n> On the other hand, I really don't see why the builder should explicitly mess around with the sphinx's directory. \n\nAs far as I understand, sphinx builder (`StandaloneHTMLBuilder` in `sphinx/builders/html/__init__.py`) creates the `_static` directory. As Sage uses a custom builder, it is the builder's duty to create the directory.",
    "created_at": "2021-07-28T01:12:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519611",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@dimpase](#comment%3A18):
> oops, no, I take [comment:17](#comment%3A17) back. The patch there has no effect.
> 
> On the other hand, I really don't see why the builder should explicitly mess around with the sphinx's directory. 

As far as I understand, sphinx builder (`StandaloneHTMLBuilder` in `sphinx/builders/html/__init__.py`) creates the `_static` directory. As Sage uses a custom builder, it is the builder's duty to create the directory.



---

archive/issue_comments_519612.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@jhpalmieri](#comment%3A22):\n> Should I create a branch with my proposed change?\n\n`ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.\n\nThe `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work?",
    "created_at": "2021-07-28T01:37:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519612",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@jhpalmieri](#comment%3A22):
> Should I create a branch with my proposed change?

`ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.

The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work?



---

archive/issue_comments_519613.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@kwankyu](#comment%3A24):\n> Replying to [@jhpalmieri](#comment%3A22):\n> > Should I create a branch with my proposed change?\n\n> \n> `ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.\n> \n> The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work? \n\nEverything needs to be tested, but someone could want to build only `en/reference/topology` without building the whole reference manual. Or do that and then build the whole manual later, by which point it's too late to create `_static`: any part of the reference manual which uses the matplotlib `plot_directive` extension will lead to this problem, so I think we need to address it at a pretty low level.\n\nWe didn't run into this before because it's a new Sphinx extension which happens to have a bug (now with a fix at https://github.com/matplotlib/matplotlib/pull/20748).",
    "created_at": "2021-07-28T02:10:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519613",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@kwankyu](#comment%3A24):
> Replying to [@jhpalmieri](#comment%3A22):
> > Should I create a branch with my proposed change?

> 
> `ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.
> 
> The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work? 

Everything needs to be tested, but someone could want to build only `en/reference/topology` without building the whole reference manual. Or do that and then build the whole manual later, by which point it's too late to create `_static`: any part of the reference manual which uses the matplotlib `plot_directive` extension will lead to this problem, so I think we need to address it at a pretty low level.

We didn't run into this before because it's a new Sphinx extension which happens to have a bug (now with a fix at https://github.com/matplotlib/matplotlib/pull/20748).



---

archive/issue_comments_519614.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nOr maybe we did run into it before: I remember years ago having problems with the `graphviz` Sphinx extension and the `_static` directory, and I wonder if it was the same thing.",
    "created_at": "2021-07-28T02:11:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519614",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:26" align="right">comment:26</div>

Or maybe we did run into it before: I remember years ago having problems with the `graphviz` Sphinx extension and the `_static` directory, and I wonder if it was the same thing.



---

archive/issue_comments_519615.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@jhpalmieri](#comment%3A25):\n> Replying to [@kwankyu](#comment%3A24):\n> > Replying to [@jhpalmieri](#comment%3A22):\n> > > Should I create a branch with my proposed change?\n\n> > \n> > `ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.\n> > \n> > The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work? \n\n> \n> Everything needs to be tested, but someone could want to build only `en/reference/topology` without building the whole reference manual. Or do that and then build the whole manual later, by which point it's too late to create `_static`: any part of the reference manual which uses the matplotlib `plot_directive` extension will lead to this problem, so I think we need to address it at a pretty low level.\n\nAlso, people may invoke docbuilding using `sage --docbuild ...` rather than `make doc`, so I think we have to address it outside of the makefile.",
    "created_at": "2021-07-28T02:17:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519615",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@jhpalmieri](#comment%3A25):
> Replying to [@kwankyu](#comment%3A24):
> > Replying to [@jhpalmieri](#comment%3A22):
> > > Should I create a branch with my proposed change?

> > 
> > `ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.
> > 
> > The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work? 

> 
> Everything needs to be tested, but someone could want to build only `en/reference/topology` without building the whole reference manual. Or do that and then build the whole manual later, by which point it's too late to create `_static`: any part of the reference manual which uses the matplotlib `plot_directive` extension will lead to this problem, so I think we need to address it at a pretty low level.

Also, people may invoke docbuilding using `sage --docbuild ...` rather than `make doc`, so I think we have to address it outside of the makefile.



---

archive/issue_comments_519616.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@jhpalmieri](#comment%3A27):\n> Replying to [@jhpalmieri](#comment%3A25):\n> > Replying to [@kwankyu](#comment%3A24):\n> > > Replying to [@jhpalmieri](#comment%3A22):\n> > > > Should I create a branch with my proposed change?\n\n> > > \n> > > `ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.\n> > > \n> > > The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work? \n\n> > \n> > Everything needs to be tested, but someone could want to build only `en/reference/topology` without building the whole reference manual. Or do that and then build the whole manual later, by which point it's too late to create `_static`: any part of the reference manual which uses the matplotlib `plot_directive` extension will lead to this problem, so I think we need to address it at a pretty low level.\n\n> \n> Also, people may invoke docbuilding using `sage --docbuild ...` rather than `make doc`, so I think we have to address it outside of the makefile.\n\nIsn't it the initial `make`-ing of Sage that also includes docbuilding that we now try to fix? After successful initial make, there is no problem.",
    "created_at": "2021-07-28T03:37:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519616",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@jhpalmieri](#comment%3A27):
> Replying to [@jhpalmieri](#comment%3A25):
> > Replying to [@kwankyu](#comment%3A24):
> > > Replying to [@jhpalmieri](#comment%3A22):
> > > > Should I create a branch with my proposed change?

> > > 
> > > `ReferenceSubBuilder` is concerned in processing subcomponents of the reference manual. I don't think it is the right place to care about creating `_static` directory.
> > > 
> > > The `make` files have taken the job of `AllBuilder`, which did the work of creating the directory. Then why not the `make` files take over the work? 

> > 
> > Everything needs to be tested, but someone could want to build only `en/reference/topology` without building the whole reference manual. Or do that and then build the whole manual later, by which point it's too late to create `_static`: any part of the reference manual which uses the matplotlib `plot_directive` extension will lead to this problem, so I think we need to address it at a pretty low level.

> 
> Also, people may invoke docbuilding using `sage --docbuild ...` rather than `make doc`, so I think we have to address it outside of the makefile.

Isn't it the initial `make`-ing of Sage that also includes docbuilding that we now try to fix? After successful initial make, there is no problem.



---

archive/issue_comments_519617.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nIf someone does `make build` and then `sage --docbuild ...`, it should work.",
    "created_at": "2021-07-28T05:26:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519617",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:29" align="right">comment:29</div>

If someone does `make build` and then `sage --docbuild ...`, it should work.



---

archive/issue_comments_519618.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nReplying to [@jhpalmieri](#comment%3A29):\n> If someone does `make build` and then `sage --docbuild ...`, it should work.\n\nOkay. Then I have no better idea where the fix should be placed.",
    "created_at": "2021-07-28T07:05:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519618",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:30" align="right">comment:30</div>

Replying to [@jhpalmieri](#comment%3A29):
> If someone does `make build` and then `sage --docbuild ...`, it should work.

Okay. Then I have no better idea where the fix should be placed.



---

archive/issue_comments_519619.json:
```json
{
    "body": "Upstream: **Fixed upstream, but not in a stable release.**",
    "created_at": "2021-07-28T08:58:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519619",
    "user": "https://github.com/dimpase"
}
```

Upstream: **Fixed upstream, but not in a stable release.**



---

archive/issue_comments_519620.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nTo fix this particular issue I'm going to add the patch https://github.com/matplotlib/matplotlib/pull/20748 already produced by Matplotlib in #31580",
    "created_at": "2021-07-28T08:58:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519620",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:31" align="right">comment:31</div>

To fix this particular issue I'm going to add the patch https://github.com/matplotlib/matplotlib/pull/20748 already produced by Matplotlib in #31580



---

archive/issue_comments_519621.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nReplying to [@dimpase](#comment%3A31):\n> To fix this particular issue I'm going to add the patch https://github.com/matplotlib/matplotlib/pull/20748 already produced by Matplotlib in #31580\n\nGood. Then there's nothing to do here.",
    "created_at": "2021-07-28T09:23:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519621",
    "user": "https://github.com/kwankyu"
}
```

<div id="comment:32" align="right">comment:32</div>

Replying to [@dimpase](#comment%3A31):
> To fix this particular issue I'm going to add the patch https://github.com/matplotlib/matplotlib/pull/20748 already produced by Matplotlib in #31580

Good. Then there's nothing to do here.



---

archive/issue_comments_519622.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nI think that conda builds its own matplotlib. If this is right, then until this fix is included in matplotlib, we either shouldn't merge #31580 or we should accept that the documentation won't build in parallel on conda.",
    "created_at": "2021-07-28T16:13:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519622",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:33" align="right">comment:33</div>

I think that conda builds its own matplotlib. If this is right, then until this fix is included in matplotlib, we either shouldn't merge #31580 or we should accept that the documentation won't build in parallel on conda.



---

archive/issue_comments_519623.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nI've left a comment for Isuru on https://github.com/matplotlib/matplotlib/pull/20748",
    "created_at": "2021-07-28T22:10:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519623",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:34" align="right">comment:34</div>

I've left a comment for Isuru on https://github.com/matplotlib/matplotlib/pull/20748



---

archive/issue_events_441763.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-07-28T22:10:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32262#event-441763"
}
```



---

archive/issue_events_441764.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-01T23:52:57Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32262#event-441764"
}
```



---

archive/issue_comments_519624.json:
```json
{
    "body": "Dependencies: **#31580**",
    "created_at": "2021-08-01T23:52:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519624",
    "user": "https://github.com/mkoeppe"
}
```

Dependencies: **#31580**



---

archive/issue_comments_519625.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nmatplotlib 3.4.3 is out and appears to have the fix (https://github.com/matplotlib/matplotlib/pull/20751)",
    "created_at": "2021-09-07T23:44:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519625",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:36" align="right">comment:36</div>

matplotlib 3.4.3 is out and appears to have the fix (https://github.com/matplotlib/matplotlib/pull/20751)



---

archive/issue_events_441765.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2021-09-08T00:06:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32262#event-441765"
}
```



---

archive/issue_events_441766.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2021-09-08T00:06:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32262#event-441766"
}
```



---

archive/issue_comments_519626.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nLet's close this, then.",
    "created_at": "2021-09-08T00:06:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32262#issuecomment-519626",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:37" align="right">comment:37</div>

Let's close this, then.



---

archive/issue_events_441767.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-09-10T04:50:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32262#event-441767"
}
```



---

archive/issue_events_441768.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-09-10T04:50:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/32262",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32262#event-441768"
}
```
