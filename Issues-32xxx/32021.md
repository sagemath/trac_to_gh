# Issue 32021: numpy 1.20* inconsistent in recognising CPU features

archive/issues_031784.json:
```json
{
    "assignees": [],
    "body": "typically this looks like the following:\nhttps://groups.google.com/d/msgid/sage-devel/763f8650-9803-4bba-a0ec-46744204fc22n%40googlegroups.com?utm_medium=email&utm_source=footer\n\n```\n[sagelib-9.4.beta2]   File \"/home/chapoton/sage/local/lib/python3.8/site-packages/numpy/core/overrides.py\", line 7, in <module>\n[sagelib-9.4.beta2]     from numpy.core._multiarray_umath import (\n[sagelib-9.4.beta2] RuntimeError: NumPy was built with baseline optimizations: \n[sagelib-9.4.beta2] (SSE SSE2 SSE3 SSSE3 SSE41 POPCNT SSE42) but your machine doesn't support:\n[sagelib-9.4.beta2] (POPCNT).\n```\n\nCC:  @kliem @dcoudert @fchapoton\n\nBranch/Commit: **[a7eef1b](https://github.com/sagemath/sagetrac-mirror/commit/a7eef1b2357cd3862facf64edb81abdafbda6923)**\n\nReviewer: **John Palmieri, Matthias Koeppe**\n\nAuthor: **Jonathan Kliem**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/32021_\n\n",
    "closed_at": "2021-07-18T22:53:27Z",
    "created_at": "2021-06-21T12:35:11Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20build",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "numpy 1.20* inconsistent in recognising CPU features",
    "type": "issue",
    "updated_at": "2021-07-18T22:53:27Z",
    "url": "https://github.com/sagemath/sage/issues/32021",
    "user": "https://github.com/dimpase"
}
```
typically this looks like the following:
https://groups.google.com/d/msgid/sage-devel/763f8650-9803-4bba-a0ec-46744204fc22n%40googlegroups.com?utm_medium=email&utm_source=footer

```
[sagelib-9.4.beta2]   File "/home/chapoton/sage/local/lib/python3.8/site-packages/numpy/core/overrides.py", line 7, in <module>
[sagelib-9.4.beta2]     from numpy.core._multiarray_umath import (
[sagelib-9.4.beta2] RuntimeError: NumPy was built with baseline optimizations: 
[sagelib-9.4.beta2] (SSE SSE2 SSE3 SSSE3 SSE41 POPCNT SSE42) but your machine doesn't support:
[sagelib-9.4.beta2] (POPCNT).
```

CC:  @kliem @dcoudert @fchapoton

Branch/Commit: **[a7eef1b](https://github.com/sagemath/sagetrac-mirror/commit/a7eef1b2357cd3862facf64edb81abdafbda6923)**

Reviewer: **John Palmieri, Matthias Koeppe**

Author: **Jonathan Kliem**

_Issue created by migration from https://trac.sagemath.org/ticket/32021_





---

archive/issue_events_409199.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-06-21T12:35:11Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32021#event-409199"
}
```



---

archive/issue_events_409200.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-06-21T12:35:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32021#event-409200"
}
```



---

archive/issue_events_409201.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-06-21T12:41:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32021#event-409201"
}
```



---

archive/issue_events_409202.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-06-21T12:41:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20build",
    "label_color": "000080",
    "label_name": "component: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32021#event-409202"
}
```



---

archive/issue_comments_518501.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nSee also https://groups.google.com/g/sage-release/c/lmUFq4d7is0/m/uKRsE9KoBQAJ\n\nIt could be that builds in question actually took a prebuilt on another machine numpy, then it's a numpy bug, I guess, to install an incompatible binary.",
    "created_at": "2021-06-21T12:45:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518501",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:2'>Comment 2:</a>
See also https://groups.google.com/g/sage-release/c/lmUFq4d7is0/m/uKRsE9KoBQAJ

It could be that builds in question actually took a prebuilt on another machine numpy, then it's a numpy bug, I guess, to install an incompatible binary.



---

archive/issue_events_409203.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-21T15:57:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32021#event-409203"
}
```



---

archive/issue_comments_518502.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nI see this when building from scratch on an iMac Pro, OS X 10.15.7, with various homebrew packages installed. `numpy` is built from scratch and says\n\n```\n########### EXT COMPILER OPTIMIZATION ###########\nPlatform      : \n  Architecture: x64\n  Compiler    : gcc\n\nCPU baseline  : \n  Requested   : 'native'\n  Enabled     : SSE SSE2 SSE3 SSSE3 SSE41 POPCNT SSE42 AVX F16C FMA3 AVX2 AVX512F AVX512CD AVX512_SKX\n  Flags       : -msse -msse2 -msse3 -mssse3 -msse4.1 -mpopcnt -msse4.2 -mavx -mf16c -mfma -mavx2 -mavx512f -mavx512cd -mavx512vl -mavx512bw -mavx512dq\n  Extra checks: AVX512F_REDUCE AVX512BW_MASK AVX512DQ_MASK\n\nCPU dispatch  : \n  Requested   : 'max -xop -fma4'\n  Enabled     : AVX512_KNL AVX512_CLX AVX512_CNL AVX512_ICL\n  Generated   : none\nCCompilerOpt._cache_write[796] : write cache to path -> /Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta2/local/var/tmp/sage/build/numpy-1.20.3/src/build/temp.macosx-10.15-x86_64-3.9/ccompiler_opt_cache_ext.py\n\n########### CLIB COMPILER OPTIMIZATION ###########\nPlatform      : \n  Architecture: x64\n  Compiler    : gcc\n\nCPU baseline  : \n  Requested   : 'native'\n  Enabled     : SSE SSE2 SSE3 SSSE3 SSE41 POPCNT SSE42 AVX F16C FMA3 AVX2 AVX512F AVX512CD AVX512_SKX\n  Flags       : -msse -msse2 -msse3 -mssse3 -msse4.1 -mpopcnt -msse4.2 -mavx -mf16c -mfma -mavx2 -mavx512f -mavx512cd -mavx512vl -mavx512bw -mavx512dq\n  Extra checks: AVX512F_REDUCE AVX512BW_MASK AVX512DQ_MASK\n\nCPU dispatch  : \n  Requested   : 'max -xop -fma4'\n  Enabled     : AVX512_KNL AVX512_CLX AVX512_CNL AVX512_ICL\n  Generated   : none\n```\n`scipy` fails with\n\n```\n    RuntimeError: NumPy was built with baseline optimizations:\n    (SSE SSE2 SSE3 SSSE3 SSE41 POPCNT SSE42 AVX F16C FMA3 AVX2 AVX512F AVX512CD AVX512_SKX) but your machine doesn't support:\n    (AVX512F).\n```\nI notice that we deleted related `numpy` patches in the latest update, presumably because they were included into the source code. There must have been other changes in the source that broke something else.",
    "created_at": "2021-06-21T22:21:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518502",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:5'>Comment 5:</a>
I see this when building from scratch on an iMac Pro, OS X 10.15.7, with various homebrew packages installed. `numpy` is built from scratch and says

```
########### EXT COMPILER OPTIMIZATION ###########
Platform      : 
  Architecture: x64
  Compiler    : gcc

CPU baseline  : 
  Requested   : 'native'
  Enabled     : SSE SSE2 SSE3 SSSE3 SSE41 POPCNT SSE42 AVX F16C FMA3 AVX2 AVX512F AVX512CD AVX512_SKX
  Flags       : -msse -msse2 -msse3 -mssse3 -msse4.1 -mpopcnt -msse4.2 -mavx -mf16c -mfma -mavx2 -mavx512f -mavx512cd -mavx512vl -mavx512bw -mavx512dq
  Extra checks: AVX512F_REDUCE AVX512BW_MASK AVX512DQ_MASK

CPU dispatch  : 
  Requested   : 'max -xop -fma4'
  Enabled     : AVX512_KNL AVX512_CLX AVX512_CNL AVX512_ICL
  Generated   : none
CCompilerOpt._cache_write[796] : write cache to path -> /Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta2/local/var/tmp/sage/build/numpy-1.20.3/src/build/temp.macosx-10.15-x86_64-3.9/ccompiler_opt_cache_ext.py

########### CLIB COMPILER OPTIMIZATION ###########
Platform      : 
  Architecture: x64
  Compiler    : gcc

CPU baseline  : 
  Requested   : 'native'
  Enabled     : SSE SSE2 SSE3 SSSE3 SSE41 POPCNT SSE42 AVX F16C FMA3 AVX2 AVX512F AVX512CD AVX512_SKX
  Flags       : -msse -msse2 -msse3 -mssse3 -msse4.1 -mpopcnt -msse4.2 -mavx -mf16c -mfma -mavx2 -mavx512f -mavx512cd -mavx512vl -mavx512bw -mavx512dq
  Extra checks: AVX512F_REDUCE AVX512BW_MASK AVX512DQ_MASK

CPU dispatch  : 
  Requested   : 'max -xop -fma4'
  Enabled     : AVX512_KNL AVX512_CLX AVX512_CNL AVX512_ICL
  Generated   : none
```
`scipy` fails with

```
    RuntimeError: NumPy was built with baseline optimizations:
    (SSE SSE2 SSE3 SSSE3 SSE41 POPCNT SSE42 AVX F16C FMA3 AVX2 AVX512F AVX512CD AVX512_SKX) but your machine doesn't support:
    (AVX512F).
```
I notice that we deleted related `numpy` patches in the latest update, presumably because they were included into the source code. There must have been other changes in the source that broke something else.



---

archive/issue_comments_518503.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nI cannot build Sage on this machine right now; does that this ticket a blocker, or is it too architecture-specific? (I can build on some other OS X machines just fine.)",
    "created_at": "2021-06-21T22:33:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518503",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:6'>Comment 6:</a>
I cannot build Sage on this machine right now; does that this ticket a blocker, or is it too architecture-specific? (I can build on some other OS X machines just fine.)



---

archive/issue_comments_518504.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nIf you add `--cpu-baseline=\"sse2\"` to `spkg-install. Will this work? Similar to #31565.",
    "created_at": "2021-06-22T11:32:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518504",
    "user": "https://github.com/kliem"
}
```

<a id='comment:7'>Comment 7:</a>
If you add `--cpu-baseline="sse2"` to `spkg-install. Will this work? Similar to #31565.



---

archive/issue_comments_518505.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nReplying to [@jhpalmieri](#comment%3A6):\n> I cannot build Sage on this machine right now; does that this ticket a blocker, or is it too architecture-specific? (I can build on some other OS X machines just fine.)\n\nCan you do a standalone build of scipy+numpy on that machine?\nOr does it fail in the same way?",
    "created_at": "2021-06-22T12:36:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518505",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'>Comment 8:</a>
Replying to [@jhpalmieri](#comment%3A6):
> I cannot build Sage on this machine right now; does that this ticket a blocker, or is it too architecture-specific? (I can build on some other OS X machines just fine.)

Can you do a standalone build of scipy+numpy on that machine?
Or does it fail in the same way?



---

archive/issue_comments_518506.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nReplying to [@dimpase](#comment%3A8):\n> Replying to [@jhpalmieri](#comment%3A6):\n> > I cannot build Sage on this machine right now; does that this ticket a blocker, or is it too architecture-specific? (I can build on some other OS X machines just fine.)\n\n> \n> Can you do a standalone build of scipy+numpy on that machine?\n> Or does it fail in the same way?\n\nI can't easily mimic the Sage install. If I just unpack the zip file for `numpy` and run `python3 setup.py build -j 4 install --prefix $HOME/.local`, it complains about `blas` stuff:\n\n```\nRuntimeError: Found /usr/lib/libcblas.dylib, but that file is a symbolic link to the MacOS Accelerate framework, which is not supported by NumPy. You must configure the build to use a different optimized library, or disable the use of optimized BLAS and LAPACK by setting the environment variables NPY_BLAS_ORDER=\"\" and NPY_LAPACK_ORDER=\"\" before building NumPy.\n```\nI tried running Sage's `lapack_conf.py`, but it complained about not finding cblas. `numpy` installed after `export NPY_BLAS_ORDER=\"\"` and `export NPY_LAPACK_ORDER=\"\"`, but `scipy` did not.\n\nSo I don't understand how to build numpy+scipy on this machine.",
    "created_at": "2021-06-22T15:16:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518506",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:9'>Comment 9:</a>
Replying to [@dimpase](#comment%3A8):
> Replying to [@jhpalmieri](#comment%3A6):
> > I cannot build Sage on this machine right now; does that this ticket a blocker, or is it too architecture-specific? (I can build on some other OS X machines just fine.)

> 
> Can you do a standalone build of scipy+numpy on that machine?
> Or does it fail in the same way?

I can't easily mimic the Sage install. If I just unpack the zip file for `numpy` and run `python3 setup.py build -j 4 install --prefix $HOME/.local`, it complains about `blas` stuff:

```
RuntimeError: Found /usr/lib/libcblas.dylib, but that file is a symbolic link to the MacOS Accelerate framework, which is not supported by NumPy. You must configure the build to use a different optimized library, or disable the use of optimized BLAS and LAPACK by setting the environment variables NPY_BLAS_ORDER="" and NPY_LAPACK_ORDER="" before building NumPy.
```
I tried running Sage's `lapack_conf.py`, but it complained about not finding cblas. `numpy` installed after `export NPY_BLAS_ORDER=""` and `export NPY_LAPACK_ORDER=""`, but `scipy` did not.

So I don't understand how to build numpy+scipy on this machine.



---

archive/issue_comments_518507.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nReplying to [@kliem](#comment%3A7):\n> If you add `--cpu-baseline=\"sse2\"` to `spkg-install. Will this work? Similar to #31565.\n\nI tried\n\n```diff\ndiff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in\nindex 1237d059d3..5d45f176ae 100644\n--- a/build/pkgs/numpy/spkg-install.in\n+++ b/build/pkgs/numpy/spkg-install.in\n@@ -22,7 +22,7 @@ python3 ../lapack_conf.py\n export FFLAGS=\"$FFLAGS -fPIC\"\n export FCFLAGS=\"$FCFLAGS -fPIC\"\n \n-export NUMPY_FCONFIG=\"config_fc --noopt --noarch\"\n+export NUMPY_FCONFIG=\"config_fc --noopt --noarch --cpu-baseline=\\\"sse2\\\"\"\n \n ################################################\n \n```\nbut this isn't the right syntax:\n\n```\nusage: setup.py [global_opts] cmd1 [cmd1_opts] [cmd2 [cmd2_opts] ...]\n   or: setup.py --help [cmd1 cmd2 ...]\n   or: setup.py --help-commands\n   or: setup.py cmd --help\n\nerror: option --cpu-baseline not recognized\n```\nCan you provide more guidance?",
    "created_at": "2021-06-22T15:27:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518507",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:10'>Comment 10:</a>
Replying to [@kliem](#comment%3A7):
> If you add `--cpu-baseline="sse2"` to `spkg-install. Will this work? Similar to #31565.

I tried

```diff
diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in
index 1237d059d3..5d45f176ae 100644
--- a/build/pkgs/numpy/spkg-install.in
+++ b/build/pkgs/numpy/spkg-install.in
@@ -22,7 +22,7 @@ python3 ../lapack_conf.py
 export FFLAGS="$FFLAGS -fPIC"
 export FCFLAGS="$FCFLAGS -fPIC"
 
-export NUMPY_FCONFIG="config_fc --noopt --noarch"
+export NUMPY_FCONFIG="config_fc --noopt --noarch --cpu-baseline=\"sse2\""
 
 ################################################
 
```
but this isn't the right syntax:

```
usage: setup.py [global_opts] cmd1 [cmd1_opts] [cmd2 [cmd2_opts] ...]
   or: setup.py --help [cmd1 cmd2 ...]
   or: setup.py --help-commands
   or: setup.py cmd --help

error: option --cpu-baseline not recognized
```
Can you provide more guidance?



---

archive/issue_comments_518508.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nReplying to [@jhpalmieri](#comment%3A10):\n> Replying to [@kliem](#comment%3A7):\n> > If you add `--cpu-baseline=\"sse2\"` to `spkg-install. Will this work? Similar to #31565.\n\n> \n> I tried\n> \n> ```diff\n> diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in\n> index 1237d059d3..5d45f176ae 100644\n> --- a/build/pkgs/numpy/spkg-install.in\n> +++ b/build/pkgs/numpy/spkg-install.in\n> @@ -22,7 +22,7 @@ python3 ../lapack_conf.py\n>  export FFLAGS=\"$FFLAGS -fPIC\"\n>  export FCFLAGS=\"$FCFLAGS -fPIC\"\n>  \n> -export NUMPY_FCONFIG=\"config_fc --noopt --noarch\"\n> +export NUMPY_FCONFIG=\"config_fc --noopt --noarch --cpu-baseline=\\\"sse2\\\"\"\n>  \n>  ################################################\n>  \n> ```\n> but this isn't the right syntax:\n> \n> ```\n> usage: setup.py [global_opts] cmd1 [cmd1_opts] [cmd2 [cmd2_opts] ...]\n>    or: setup.py --help [cmd1 cmd2 ...]\n>    or: setup.py --help-commands\n>    or: setup.py cmd --help\n> \n> error: option --cpu-baseline not recognized\n> ```\n> Can you provide more guidance?\n\nThanks for catching this. Actually you need to do it during a different command:\n\n```diff\ndiff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in\nindex 1237d059d3..c261d89444 100644\n--- a/build/pkgs/numpy/spkg-install.in\n+++ b/build/pkgs/numpy/spkg-install.in\n@@ -28,4 +28,4 @@ export NUMPY_FCONFIG=\"config_fc --noopt --noarch\"\n \n sdh_setup_bdist_wheel ${NUMPY_FCONFIG}\n \n-sdh_store_and_pip_install_wheel .\n+sdh_store_and_pip_install_wheel . --cpu-baseline=\"sse2\"\n```\nA cleaner solution and also a good solution for a branch might be to disable `-march=native` via\n\n```\nexport CFLAGS=\"$CFLAGS_NON_NATIVE\"\n```\nNumpy will still compile intrinsics to be dispatched on runtime. (And even if it isn't the case, the policy was that `-march=native` should only be enabled as long as this does not effect portability). Either way it appears to be a numpy bug, because it detects your architecture wrongly.\n\nI hope one of those things work.\n\nEdited: See comment below",
    "created_at": "2021-06-22T18:22:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518508",
    "user": "https://github.com/kliem"
}
```

<a id='comment:11'>Comment 11:</a>
Replying to [@jhpalmieri](#comment%3A10):
> Replying to [@kliem](#comment%3A7):
> > If you add `--cpu-baseline="sse2"` to `spkg-install. Will this work? Similar to #31565.

> 
> I tried
> 
> ```diff
> diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in
> index 1237d059d3..5d45f176ae 100644
> --- a/build/pkgs/numpy/spkg-install.in
> +++ b/build/pkgs/numpy/spkg-install.in
> @@ -22,7 +22,7 @@ python3 ../lapack_conf.py
>  export FFLAGS="$FFLAGS -fPIC"
>  export FCFLAGS="$FCFLAGS -fPIC"
>  
> -export NUMPY_FCONFIG="config_fc --noopt --noarch"
> +export NUMPY_FCONFIG="config_fc --noopt --noarch --cpu-baseline=\"sse2\""
>  
>  ################################################
>  
> ```
> but this isn't the right syntax:
> 
> ```
> usage: setup.py [global_opts] cmd1 [cmd1_opts] [cmd2 [cmd2_opts] ...]
>    or: setup.py --help [cmd1 cmd2 ...]
>    or: setup.py --help-commands
>    or: setup.py cmd --help
> 
> error: option --cpu-baseline not recognized
> ```
> Can you provide more guidance?

Thanks for catching this. Actually you need to do it during a different command:

```diff
diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in
index 1237d059d3..c261d89444 100644
--- a/build/pkgs/numpy/spkg-install.in
+++ b/build/pkgs/numpy/spkg-install.in
@@ -28,4 +28,4 @@ export NUMPY_FCONFIG="config_fc --noopt --noarch"
 
 sdh_setup_bdist_wheel ${NUMPY_FCONFIG}
 
-sdh_store_and_pip_install_wheel .
+sdh_store_and_pip_install_wheel . --cpu-baseline="sse2"
```
A cleaner solution and also a good solution for a branch might be to disable `-march=native` via

```
export CFLAGS="$CFLAGS_NON_NATIVE"
```
Numpy will still compile intrinsics to be dispatched on runtime. (And even if it isn't the case, the policy was that `-march=native` should only be enabled as long as this does not effect portability). Either way it appears to be a numpy bug, because it detects your architecture wrongly.

I hope one of those things work.

Edited: See comment below



---

archive/issue_comments_518509.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nActually you don't want `cpu-dispatch` but `cpu-baseline` as before.",
    "created_at": "2021-06-22T18:23:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518509",
    "user": "https://github.com/kliem"
}
```

<a id='comment:12'>Comment 12:</a>
Actually you don't want `cpu-dispatch` but `cpu-baseline` as before.



---

archive/issue_comments_518510.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nReplying to [@kliem](#comment%3A11):\n> Thanks for catching this. Actually you need to do it during a different command:\n> \n> ```diff\n> diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in\n> index 1237d059d3..c261d89444 100644\n> --- a/build/pkgs/numpy/spkg-install.in\n> +++ b/build/pkgs/numpy/spkg-install.in\n> @@ -28,4 +28,4 @@ export NUMPY_FCONFIG=\"config_fc --noopt --noarch\"\n>  \n>  sdh_setup_bdist_wheel ${NUMPY_FCONFIG}\n>  \n> -sdh_store_and_pip_install_wheel .\n> +sdh_store_and_pip_install_wheel . --cpu-baseline=\"sse2\"\n> ```\n\nThis doesn't work, unfortunately:\n\n```\nError: sdh_store_wheel requires .  as only argument\n```\nCan we build numpy using other of Sage's helpers which accept arguments?\n\n> A cleaner solution and also a good solution for a branch might be to disable `-march=native` via\n> \n> ```\n> export CFLAGS=\"$CFLAGS_NON_NATIVE\"\n> ```\n\nI tried various options including\n\n```diff\ndiff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in\nindex 1237d059d3..88aee50f6a 100644\n--- a/build/pkgs/numpy/spkg-install.in\n+++ b/build/pkgs/numpy/spkg-install.in\n@@ -6,6 +6,9 @@ if [ `uname` = \"Darwin\" ]; then\n     unset ATLAS\n     unset BLAS\n     unset LAPACK\n+    export CFLAGS=\"$CFLAGS_NON_NATIVE\"\n+    export FCFLAGS=\"$FCFLAGS_NON_NATIVE\"\n+    export FFLAGS=\"$FFLAGS_NON_NATIVE\"\n else\n     export {ATLAS,PTATLAS,OPENBLAS,MKL,MKLROOT}=None\n     export LDFLAGS=\"${LDFLAGS} -shared\"\n```\nbut they didn't change the \"COMPILER OPTIMIZATION\" summaries when building `numpy` and they did not allow `scipy` to build.",
    "created_at": "2021-06-22T18:42:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518510",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:13'>Comment 13:</a>
Replying to [@kliem](#comment%3A11):
> Thanks for catching this. Actually you need to do it during a different command:
> 
> ```diff
> diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in
> index 1237d059d3..c261d89444 100644
> --- a/build/pkgs/numpy/spkg-install.in
> +++ b/build/pkgs/numpy/spkg-install.in
> @@ -28,4 +28,4 @@ export NUMPY_FCONFIG="config_fc --noopt --noarch"
>  
>  sdh_setup_bdist_wheel ${NUMPY_FCONFIG}
>  
> -sdh_store_and_pip_install_wheel .
> +sdh_store_and_pip_install_wheel . --cpu-baseline="sse2"
> ```

This doesn't work, unfortunately:

```
Error: sdh_store_wheel requires .  as only argument
```
Can we build numpy using other of Sage's helpers which accept arguments?

> A cleaner solution and also a good solution for a branch might be to disable `-march=native` via
> 
> ```
> export CFLAGS="$CFLAGS_NON_NATIVE"
> ```

I tried various options including

```diff
diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in
index 1237d059d3..88aee50f6a 100644
--- a/build/pkgs/numpy/spkg-install.in
+++ b/build/pkgs/numpy/spkg-install.in
@@ -6,6 +6,9 @@ if [ `uname` = "Darwin" ]; then
     unset ATLAS
     unset BLAS
     unset LAPACK
+    export CFLAGS="$CFLAGS_NON_NATIVE"
+    export FCFLAGS="$FCFLAGS_NON_NATIVE"
+    export FFLAGS="$FFLAGS_NON_NATIVE"
 else
     export {ATLAS,PTATLAS,OPENBLAS,MKL,MKLROOT}=None
     export LDFLAGS="${LDFLAGS} -shared"
```
but they didn't change the "COMPILER OPTIMIZATION" summaries when building `numpy` and they did not allow `scipy` to build.



---

archive/issue_comments_518511.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nYou are exactly right. The previous place was the correct place to use it.\n\n```\nexport NUMPY_FCONFIG=\"config_fc --noopt --noarch --cpu-baseline=\\\"sse2\\\"\"\n```\n\nHowever:\n\n> The command arguments are available in build, build_clib, and build_ext. if build_clib or build_ext are not specified by the user, the arguments of build will be used instead, which also holds the default values.\n\nSo this does not work for `bdist_wheel` and this is what we use. Apparently, when build with wheel it just gets optimized regardless?",
    "created_at": "2021-06-22T19:52:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518511",
    "user": "https://github.com/kliem"
}
```

<a id='comment:14'>Comment 14:</a>
You are exactly right. The previous place was the correct place to use it.

```
export NUMPY_FCONFIG="config_fc --noopt --noarch --cpu-baseline=\"sse2\""
```

However:

> The command arguments are available in build, build_clib, and build_ext. if build_clib or build_ext are not specified by the user, the arguments of build will be used instead, which also holds the default values.

So this does not work for `bdist_wheel` and this is what we use. Apparently, when build with wheel it just gets optimized regardless?



---

archive/issue_comments_518512.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nReplying to [@jhpalmieri](#comment%3A13):\n> Replying to [@kliem](#comment%3A11):\n> > Thanks for catching this. Actually you need to do it during a different command:\n> > \n> > ```diff\n> > diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in\n> > index 1237d059d3..c261d89444 100644\n> > --- a/build/pkgs/numpy/spkg-install.in\n> > +++ b/build/pkgs/numpy/spkg-install.in\n> > @@ -28,4 +28,4 @@ export NUMPY_FCONFIG=\"config_fc --noopt --noarch\"\n> >  \n> >  sdh_setup_bdist_wheel ${NUMPY_FCONFIG}\n> >  \n> > -sdh_store_and_pip_install_wheel .\n> > +sdh_store_and_pip_install_wheel . --cpu-baseline=\"sse2\"\n> > ```\n\n> \n> This doesn't work, unfortunately:\n> \n> ```\n> Error: sdh_store_wheel requires .  as only argument\n> ```\n> Can we build numpy using other of Sage's helpers which accept arguments?\n> \n> > A cleaner solution and also a good solution for a branch might be to disable `-march=native` via\n> > \n> > ```\n> > export CFLAGS=\"$CFLAGS_NON_NATIVE\"\n> > ```\n\n> \n> I tried various options including\n> \n> ```diff\n> diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in\n> index 1237d059d3..88aee50f6a 100644\n> --- a/build/pkgs/numpy/spkg-install.in\n> +++ b/build/pkgs/numpy/spkg-install.in\n> @@ -6,6 +6,9 @@ if [ `uname` = \"Darwin\" ]; then\n>      unset ATLAS\n>      unset BLAS\n>      unset LAPACK\n> +    export CFLAGS=\"$CFLAGS_NON_NATIVE\"\n> +    export FCFLAGS=\"$FCFLAGS_NON_NATIVE\"\n> +    export FFLAGS=\"$FFLAGS_NON_NATIVE\"\n>  else\n>      export {ATLAS,PTATLAS,OPENBLAS,MKL,MKLROOT}=None\n>      export LDFLAGS=\"${LDFLAGS} -shared\"\n> ```\n> but they didn't change the \"COMPILER OPTIMIZATION\" summaries when building `numpy` and they did not allow `scipy` to build.\n\nAs Matthias K\u00f6ppe pointed out you can do the following change:\n\n```diff\ndiff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in\nindex 1237d059d3..ef2a322ecb 100644\n--- a/build/pkgs/numpy/spkg-install.in\n+++ b/build/pkgs/numpy/spkg-install.in\n@@ -26,6 +26,6 @@ export NUMPY_FCONFIG=\"config_fc --noopt --noarch\"\n \n ################################################\n \n-sdh_setup_bdist_wheel ${NUMPY_FCONFIG}\n+sdh_setup_bdist_wheel build ${NUMPY_FCONFIG}\n \n sdh_store_and_pip_install_wheel .\n```\n\nOnce you have done this, you can add all the previous options (added to `NUMPY_FCONFIG`):\n- `cpu-baseline=min`,\n- `cpu-dispatch`\n- try again `export CFLAGS=CFLAGS_NON_NATIVE`.\n\nActually you can cancel the numpy built once it starts compiling to immediatly see the optimization options as in [comment:5](#comment%3A5)",
    "created_at": "2021-06-22T20:41:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518512",
    "user": "https://github.com/kliem"
}
```

<a id='comment:15'>Comment 15:</a>
Replying to [@jhpalmieri](#comment%3A13):
> Replying to [@kliem](#comment%3A11):
> > Thanks for catching this. Actually you need to do it during a different command:
> > 
> > ```diff
> > diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in
> > index 1237d059d3..c261d89444 100644
> > --- a/build/pkgs/numpy/spkg-install.in
> > +++ b/build/pkgs/numpy/spkg-install.in
> > @@ -28,4 +28,4 @@ export NUMPY_FCONFIG="config_fc --noopt --noarch"
> >  
> >  sdh_setup_bdist_wheel ${NUMPY_FCONFIG}
> >  
> > -sdh_store_and_pip_install_wheel .
> > +sdh_store_and_pip_install_wheel . --cpu-baseline="sse2"
> > ```

> 
> This doesn't work, unfortunately:
> 
> ```
> Error: sdh_store_wheel requires .  as only argument
> ```
> Can we build numpy using other of Sage's helpers which accept arguments?
> 
> > A cleaner solution and also a good solution for a branch might be to disable `-march=native` via
> > 
> > ```
> > export CFLAGS="$CFLAGS_NON_NATIVE"
> > ```

> 
> I tried various options including
> 
> ```diff
> diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in
> index 1237d059d3..88aee50f6a 100644
> --- a/build/pkgs/numpy/spkg-install.in
> +++ b/build/pkgs/numpy/spkg-install.in
> @@ -6,6 +6,9 @@ if [ `uname` = "Darwin" ]; then
>      unset ATLAS
>      unset BLAS
>      unset LAPACK
> +    export CFLAGS="$CFLAGS_NON_NATIVE"
> +    export FCFLAGS="$FCFLAGS_NON_NATIVE"
> +    export FFLAGS="$FFLAGS_NON_NATIVE"
>  else
>      export {ATLAS,PTATLAS,OPENBLAS,MKL,MKLROOT}=None
>      export LDFLAGS="${LDFLAGS} -shared"
> ```
> but they didn't change the "COMPILER OPTIMIZATION" summaries when building `numpy` and they did not allow `scipy` to build.

As Matthias Köppe pointed out you can do the following change:

```diff
diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in
index 1237d059d3..ef2a322ecb 100644
--- a/build/pkgs/numpy/spkg-install.in
+++ b/build/pkgs/numpy/spkg-install.in
@@ -26,6 +26,6 @@ export NUMPY_FCONFIG="config_fc --noopt --noarch"
 
 ################################################
 
-sdh_setup_bdist_wheel ${NUMPY_FCONFIG}
+sdh_setup_bdist_wheel build ${NUMPY_FCONFIG}
 
 sdh_store_and_pip_install_wheel .
```

Once you have done this, you can add all the previous options (added to `NUMPY_FCONFIG`):
- `cpu-baseline=min`,
- `cpu-dispatch`
- try again `export CFLAGS=CFLAGS_NON_NATIVE`.

Actually you can cancel the numpy built once it starts compiling to immediatly see the optimization options as in [comment:5](#comment%3A5)



---

archive/issue_comments_518513.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nSorry, I'm still not getting it. I made the change suggested in [comment:15](#comment%3A15), adding \"build\" to the command. If I use\n\n```\nexport NUMPY_FCONFIG=\"config_fc --noopt --noarch --cpu-baseline=\\\"sse2\\\"\"\n```\nI still get \"error: option --cpu-baseline not recognized\". Same with `--cpu-dispatch` if it's at the end. If I instead use\n\n```\nexport NUMPY_FCONFIG=\"--cpu-baseline=\\\"sse2\\\" config_fc --noopt --noarch\"\n```\nthen numpy builds but with no apparent difference to the outcome, and scipy still fails. This happens whether or not I include `CFLAGS=\"$CFLAGS_NON_NATIVE\"`. Note that no matter what I try, the following appears several times in the log file:\n\n```\nCCompilerOpt.__init__[2103] : native flag is specified through environment variables. force cpu-baseline='native'\n```\nI don't know if that's relevant.",
    "created_at": "2021-06-22T22:12:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518513",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:16'>Comment 16:</a>
Sorry, I'm still not getting it. I made the change suggested in [comment:15](#comment%3A15), adding "build" to the command. If I use

```
export NUMPY_FCONFIG="config_fc --noopt --noarch --cpu-baseline=\"sse2\""
```
I still get "error: option --cpu-baseline not recognized". Same with `--cpu-dispatch` if it's at the end. If I instead use

```
export NUMPY_FCONFIG="--cpu-baseline=\"sse2\" config_fc --noopt --noarch"
```
then numpy builds but with no apparent difference to the outcome, and scipy still fails. This happens whether or not I include `CFLAGS="$CFLAGS_NON_NATIVE"`. Note that no matter what I try, the following appears several times in the log file:

```
CCompilerOpt.__init__[2103] : native flag is specified through environment variables. force cpu-baseline='native'
```
I don't know if that's relevant.



---

archive/issue_comments_518514.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nThis worked for me, until we find something better:\n\n```diff\ndiff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in\nindex 1237d059d3..50aa1529b3 100644\n--- a/build/pkgs/numpy/spkg-install.in\n+++ b/build/pkgs/numpy/spkg-install.in\n@@ -22,6 +22,8 @@ python3 ../lapack_conf.py\n export FFLAGS=\"$FFLAGS -fPIC\"\n export FCFLAGS=\"$FCFLAGS -fPIC\"\n \n+export CFLAGS=\" -march=skylake\"\n+\n export NUMPY_FCONFIG=\"config_fc --noopt --noarch\"\n \n ################################################\n```",
    "created_at": "2021-06-23T02:02:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518514",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:17'>Comment 17:</a>
This worked for me, until we find something better:

```diff
diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in
index 1237d059d3..50aa1529b3 100644
--- a/build/pkgs/numpy/spkg-install.in
+++ b/build/pkgs/numpy/spkg-install.in
@@ -22,6 +22,8 @@ python3 ../lapack_conf.py
 export FFLAGS="$FFLAGS -fPIC"
 export FCFLAGS="$FCFLAGS -fPIC"
 
+export CFLAGS=" -march=skylake"
+
 export NUMPY_FCONFIG="config_fc --noopt --noarch"
 
 ################################################
```



---

archive/issue_comments_518515.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nhttps://github.com/numpy/numpy/issues/19067",
    "created_at": "2021-06-23T07:44:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518515",
    "user": "https://github.com/sheerluck"
}
```

<a id='comment:18'>Comment 18:</a>
https://github.com/numpy/numpy/issues/19067



---

archive/issue_comments_518516.json:
```json
{
    "body": "<a id='comment:19'>Comment 19:</a>\nReplying to [@sheerluck](#comment%3A18):\n> https://github.com/numpy/numpy/issues/19067\n\ngood catch!\n\nJohn, does the patch from there, \nhttps://patch-diff.githubusercontent.com/raw/numpy/numpy/pull/19074.diff\nfix your issue?",
    "created_at": "2021-06-23T08:03:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518516",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:19'>Comment 19:</a>
Replying to [@sheerluck](#comment%3A18):
> https://github.com/numpy/numpy/issues/19067

good catch!

John, does the patch from there, 
https://patch-diff.githubusercontent.com/raw/numpy/numpy/pull/19074.diff
fix your issue?



---

archive/issue_comments_518517.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nReplying to [@dimpase](#comment%3A19):\n> Replying to [@sheerluck](#comment%3A18):\n> > https://github.com/numpy/numpy/issues/19067\n\n> \n> good catch!\n> \n> John, does the patch from there, \n> https://patch-diff.githubusercontent.com/raw/numpy/numpy/pull/19074.diff\n> fix your issue?\n\nUnfortunately not. I see the same summary as in [comment:5](#comment%3A5), and `scipy` fails to build.",
    "created_at": "2021-06-23T18:12:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518517",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:20'>Comment 20:</a>
Replying to [@dimpase](#comment%3A19):
> Replying to [@sheerluck](#comment%3A18):
> > https://github.com/numpy/numpy/issues/19067

> 
> good catch!
> 
> John, does the patch from there, 
> https://patch-diff.githubusercontent.com/raw/numpy/numpy/pull/19074.diff
> fix your issue?

Unfortunately not. I see the same summary as in [comment:5](#comment%3A5), and `scipy` fails to build.



---

archive/issue_comments_518518.json:
```json
{
    "body": "<a id='comment:21'>Comment 21:</a>\nBy the way, where is `CFLAGS_NON_NATIVE` set? If I put `echo $CFLAGS` and `echo $CFLAGS_NON_NATIVE` in `spkg-install.in`, they both print the same thing:\n\n```\n-O2 -g -march=native\n```\nI'm not sure what \"NON_NATIVE\" means, but is it odd that it includes `-march=native`? If I explicitly do `export CFLAGS=\"-O2 -g\"`, then `scipy` builds.",
    "created_at": "2021-06-23T18:20:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518518",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:21'>Comment 21:</a>
By the way, where is `CFLAGS_NON_NATIVE` set? If I put `echo $CFLAGS` and `echo $CFLAGS_NON_NATIVE` in `spkg-install.in`, they both print the same thing:

```
-O2 -g -march=native
```
I'm not sure what "NON_NATIVE" means, but is it odd that it includes `-march=native`? If I explicitly do `export CFLAGS="-O2 -g"`, then `scipy` builds.



---

archive/issue_comments_518519.json:
```json
{
    "body": "<a id='comment:22'>Comment 22:</a>\nDo you have default `CFLAGS`? User settings take precedence over those. `CFLAGS_NON_NATIVE` means we don't add `-march=native`. That's what I figured is going on by the way.\n\nIf you don't have `CFLAGS` set by default than this is a bug.",
    "created_at": "2021-06-23T18:34:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518519",
    "user": "https://github.com/kliem"
}
```

<a id='comment:22'>Comment 22:</a>
Do you have default `CFLAGS`? User settings take precedence over those. `CFLAGS_NON_NATIVE` means we don't add `-march=native`. That's what I figured is going on by the way.

If you don't have `CFLAGS` set by default than this is a bug.



---

archive/issue_comments_518520.json:
```json
{
    "body": "<a id='comment:23'>Comment 23:</a>\nThe configured flags are in `sage/build/bin/sage-build-env-config`.\n\nIn `sage/build/bin/sage/sage-build-env` we set the flags.\nPriorities are in this order:\n1. Whatever is currently set.\n2. During configuration.\n3. Sage's default.\n\n`CFLAGS_NON_NATIVE` only is meaningful for the third one. Otherwise you choice will be set everywhere regardless (some packages might add something).",
    "created_at": "2021-06-23T18:40:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518520",
    "user": "https://github.com/kliem"
}
```

<a id='comment:23'>Comment 23:</a>
The configured flags are in `sage/build/bin/sage-build-env-config`.

In `sage/build/bin/sage/sage-build-env` we set the flags.
Priorities are in this order:
1. Whatever is currently set.
2. During configuration.
3. Sage's default.

`CFLAGS_NON_NATIVE` only is meaningful for the third one. Otherwise you choice will be set everywhere regardless (some packages might add something).



---

archive/issue_comments_518521.json:
```json
{
    "body": "<a id='comment:24'>Comment 24:</a>\nI inserted more `echo` commands. `echo $CFLAGS_NON_NATIVE` returns `-O2 -g` when I print in `sage-spkg`, but it returns `-O2 -g -march=native` when this echo command is the first thing in numpy's `spkg-install.in` script. That is, my numpy log file looks like:\n\n```\n...\nPackage 'numpy' is currently not installed\nUninstalling 'numpy' with legacy uninstaller\n!!!!!!!!!!!!!!!!\nPRINTED BY sage-spkg\ncflags: -O2 -g -march=native\nnon-native: -O2 -g\n!!!!!!!!!!!!!!!!\n!!!!!!!!!!!!!!!!\nPRINTED BY NUMPY's spkg-install.in\ncflags: -O2 -g -march=native\nnon-native: -O2 -g -march=native\n!!!!!!!!!!!!!!!!\n...\n```\nAfter the installation is complete, one more echo command in `sage-spkg` returns `-O2 -g` again.\n\n---\n\nThe problem seems to be that we (in the full script `spkg-install`, created from `spkg-install.in`) also run the script `build/bin/sage-build-env`, and the line\n\n```\n    export CFLAGS_NON_NATIVE=\"$ORIGINAL_CFLAGS\"\n```\nproduces the wrong answer.",
    "created_at": "2021-06-23T20:37:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518521",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:24'>Comment 24:</a>
I inserted more `echo` commands. `echo $CFLAGS_NON_NATIVE` returns `-O2 -g` when I print in `sage-spkg`, but it returns `-O2 -g -march=native` when this echo command is the first thing in numpy's `spkg-install.in` script. That is, my numpy log file looks like:

```
...
Package 'numpy' is currently not installed
Uninstalling 'numpy' with legacy uninstaller
!!!!!!!!!!!!!!!!
PRINTED BY sage-spkg
cflags: -O2 -g -march=native
non-native: -O2 -g
!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!
PRINTED BY NUMPY's spkg-install.in
cflags: -O2 -g -march=native
non-native: -O2 -g -march=native
!!!!!!!!!!!!!!!!
...
```
After the installation is complete, one more echo command in `sage-spkg` returns `-O2 -g` again.

---

The problem seems to be that we (in the full script `spkg-install`, created from `spkg-install.in`) also run the script `build/bin/sage-build-env`, and the line

```
    export CFLAGS_NON_NATIVE="$ORIGINAL_CFLAGS"
```
produces the wrong answer.



---

archive/issue_comments_518522.json:
```json
{
    "body": "<a id='comment:25'>Comment 25:</a>\nOne question would be, since `sage-spkg` already has the lines\n\n```\n. sage-build-env-config\n. sage-build-env\n```\nwhy does it also need to write this into `spkg-install`:\n\n```\nfor lib in \"\\$SAGE_ROOT/build/bin/sage-dist-helpers\" \"\\$SAGE_SRC/bin/sage-env-config\" \"\\$SAGE_SRC/bin/sage-env\" \"\\$SAGE_ROOT/build/bin/sage-build-env-config\" \"\\$SAGE_ROOT/build/bin/sage-build-env\"; do\n    source \"\\$lib\"\n    if [ \\$? -ne 0 ]; then\n        echo >&2 \"Error: failed to source \\$lib\"\n        echo >&2 \"Is \\$SAGE_ROOT the correct SAGE_ROOT?\"\n        exit 1\n    fi\ndone\n```\nShould we omit `sage-build-env-config` and `sage-build-env` from this list?",
    "created_at": "2021-06-23T20:44:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518522",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:25'>Comment 25:</a>
One question would be, since `sage-spkg` already has the lines

```
. sage-build-env-config
. sage-build-env
```
why does it also need to write this into `spkg-install`:

```
for lib in "\$SAGE_ROOT/build/bin/sage-dist-helpers" "\$SAGE_SRC/bin/sage-env-config" "\$SAGE_SRC/bin/sage-env" "\$SAGE_ROOT/build/bin/sage-build-env-config" "\$SAGE_ROOT/build/bin/sage-build-env"; do
    source "\$lib"
    if [ \$? -ne 0 ]; then
        echo >&2 "Error: failed to source \$lib"
        echo >&2 "Is \$SAGE_ROOT the correct SAGE_ROOT?"
        exit 1
    fi
done
```
Should we omit `sage-build-env-config` and `sage-build-env` from this list?



---

archive/issue_comments_518523.json:
```json
{
    "body": "<a id='comment:26'>Comment 26:</a>\nI think the idea is that these wrapped scripts can also be executed manually",
    "created_at": "2021-06-23T21:13:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518523",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:26'>Comment 26:</a>
I think the idea is that these wrapped scripts can also be executed manually



---

archive/issue_comments_518524.json:
```json
{
    "body": "<a id='comment:27'>Comment 27:</a>\nSage builds on this machine with these changes:\n\n```diff\ndiff --git a/build/bin/sage-spkg b/build/bin/sage-spkg\nindex c92f315f36..561e8f5cce 100755\n--- a/build/bin/sage-spkg\n+++ b/build/bin/sage-spkg\n@@ -525,7 +525,7 @@ export PKG_NAME=\"$PKG_NAME\"\n export PKG_BASE=\"$PKG_BASE\"\n export PKG_VER=\"$PKG_VER\"\n \n-for lib in \"\\$SAGE_ROOT/build/bin/sage-dist-helpers\" \"\\$SAGE_SRC/bin/sage-env-config\" \"\\$SAGE_SRC/bin/sage-env\" \"\\$SAGE_ROOT/build/bin/sage-build-env-config\" \"\\$SAGE_ROOT/build/bin/sage-build-env\"; do\n+for lib in \"\\$SAGE_ROOT/build/bin/sage-dist-helpers\" \"\\$SAGE_SRC/bin/sage-env-config\" \"\\$SAGE_SRC/bin/sage-env\"; do\n     source \"\\$lib\"\n     if [ \\$? -ne 0 ]; then\n         echo >&2 \"Error: failed to source \\$lib\"\ndiff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in\nindex 1237d059d3..0eb81094db 100644\n--- a/build/pkgs/numpy/spkg-install.in\n+++ b/build/pkgs/numpy/spkg-install.in\n@@ -22,6 +22,8 @@ python3 ../lapack_conf.py\n export FFLAGS=\"$FFLAGS -fPIC\"\n export FCFLAGS=\"$FCFLAGS -fPIC\"\n \n+export CFLAGS=\"$CFLAGS_NON_NATIVE\"\n+\n export NUMPY_FCONFIG=\"config_fc --noopt --noarch\"\n \n ################################################\n```",
    "created_at": "2021-06-23T21:16:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518524",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:27'>Comment 27:</a>
Sage builds on this machine with these changes:

```diff
diff --git a/build/bin/sage-spkg b/build/bin/sage-spkg
index c92f315f36..561e8f5cce 100755
--- a/build/bin/sage-spkg
+++ b/build/bin/sage-spkg
@@ -525,7 +525,7 @@ export PKG_NAME="$PKG_NAME"
 export PKG_BASE="$PKG_BASE"
 export PKG_VER="$PKG_VER"
 
-for lib in "\$SAGE_ROOT/build/bin/sage-dist-helpers" "\$SAGE_SRC/bin/sage-env-config" "\$SAGE_SRC/bin/sage-env" "\$SAGE_ROOT/build/bin/sage-build-env-config" "\$SAGE_ROOT/build/bin/sage-build-env"; do
+for lib in "\$SAGE_ROOT/build/bin/sage-dist-helpers" "\$SAGE_SRC/bin/sage-env-config" "\$SAGE_SRC/bin/sage-env"; do
     source "\$lib"
     if [ \$? -ne 0 ]; then
         echo >&2 "Error: failed to source \$lib"
diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in
index 1237d059d3..0eb81094db 100644
--- a/build/pkgs/numpy/spkg-install.in
+++ b/build/pkgs/numpy/spkg-install.in
@@ -22,6 +22,8 @@ python3 ../lapack_conf.py
 export FFLAGS="$FFLAGS -fPIC"
 export FCFLAGS="$FCFLAGS -fPIC"
 
+export CFLAGS="$CFLAGS_NON_NATIVE"
+
 export NUMPY_FCONFIG="config_fc --noopt --noarch"
 
 ################################################
```



---

archive/issue_comments_518525.json:
```json
{
    "body": "<a id='comment:28'>Comment 28:</a>\nReplying to [@mkoeppe](#comment%3A26):\n> I think the idea is that these wrapped scripts can also be executed manually\n\nI guess they should be written so that they're idempotent.",
    "created_at": "2021-06-23T21:17:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518525",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:28'>Comment 28:</a>
Replying to [@mkoeppe](#comment%3A26):
> I think the idea is that these wrapped scripts can also be executed manually

I guess they should be written so that they're idempotent.



---

archive/issue_comments_518526.json:
```json
{
    "body": "<a id='comment:29'>Comment 29:</a>\nYes, that is what I was about to suggest.",
    "created_at": "2021-06-23T21:17:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518526",
    "user": "https://github.com/kliem"
}
```

<a id='comment:29'>Comment 29:</a>
Yes, that is what I was about to suggest.



---

archive/issue_comments_518527.json:
```json
{
    "body": "<a id='comment:30'>Comment 30:</a>\nThis may be a good occasion to move all `if`'s from `sage-build-env-config` to `sage-build-env`.",
    "created_at": "2021-06-23T21:25:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518527",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'>Comment 30:</a>
This may be a good occasion to move all `if`'s from `sage-build-env-config` to `sage-build-env`.



---

archive/issue_comments_518528.json:
```json
{
    "body": "<a id='comment:31'>Comment 31:</a>\nI fear that I may have derailed the ticket from its original purpose. The patch in [comment:19](#comment%3A19) looks quite relevant to that so maybe we should include it, even though it doesn't fix the problem on my machine. Separate ticket for changes to `sage-build-env` and `sage-build-env-config`?",
    "created_at": "2021-06-23T21:39:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518528",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:31'>Comment 31:</a>
I fear that I may have derailed the ticket from its original purpose. The patch in [comment:19](#comment%3A19) looks quite relevant to that so maybe we should include it, even though it doesn't fix the problem on my machine. Separate ticket for changes to `sage-build-env` and `sage-build-env-config`?



---

archive/issue_comments_518529.json:
```json
{
    "body": "Author: **Jonathan Kliem**",
    "created_at": "2021-06-23T21:45:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518529",
    "user": "https://github.com/kliem"
}
```

Author: **Jonathan Kliem**



---

archive/issue_comments_518530.json:
```json
{
    "body": "Commit: **[b3e2a53](https://github.com/sagemath/sagetrac-mirror/commit/b3e2a534bd6f4d3d164b0bf8ad0ab33b64cd282f)**",
    "created_at": "2021-06-23T21:45:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518530",
    "user": "https://github.com/kliem"
}
```

Commit: **[b3e2a53](https://github.com/sagemath/sagetrac-mirror/commit/b3e2a534bd6f4d3d164b0bf8ad0ab33b64cd282f)**



---

archive/issue_events_409204.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-06-23T21:45:29Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32021#event-409204"
}
```



---

archive/issue_events_409205.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-06-23T21:45:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32021#event-409205"
}
```



---

archive/issue_comments_518531.json:
```json
{
    "body": "Branch: **[public/32021](https://github.com/sagemath/sagetrac-mirror/tree/public/32021)**",
    "created_at": "2021-06-23T21:45:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518531",
    "user": "https://github.com/kliem"
}
```

Branch: **[public/32021](https://github.com/sagemath/sagetrac-mirror/tree/public/32021)**



---

archive/issue_comments_518532.json:
```json
{
    "body": "<a id='comment:32'>Comment 32:</a>\nFeel free to add yourself as the author. I don't know at this point, who really is the author here.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/07a66e0d63b9236e6f0b6a672f7b45328d3c1fb5\">07a66e0</a></td><td><code>header guard for sage-build-env</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ba795b53f50b0b6a9002cf4f60bc74584985ea48\">ba795b5</a></td><td><code>move ifs from sage-build-env-config to sage-build-env</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b3e2a534bd6f4d3d164b0bf8ad0ab33b64cd282f\">b3e2a53</a></td><td><code>disable march=native for numpy</code></td></tr></table>\n",
    "created_at": "2021-06-23T21:45:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518532",
    "user": "https://github.com/kliem"
}
```

<a id='comment:32'>Comment 32:</a>
Feel free to add yourself as the author. I don't know at this point, who really is the author here.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/07a66e0d63b9236e6f0b6a672f7b45328d3c1fb5">07a66e0</a></td><td><code>header guard for sage-build-env</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ba795b53f50b0b6a9002cf4f60bc74584985ea48">ba795b5</a></td><td><code>move ifs from sage-build-env-config to sage-build-env</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b3e2a534bd6f4d3d164b0bf8ad0ab33b64cd282f">b3e2a53</a></td><td><code>disable march=native for numpy</code></td></tr></table>




---

archive/issue_comments_518533.json:
```json
{
    "body": "<a id='comment:33'>Comment 33:</a>\nBy the way, I don't know if `numpy` is right or if `scipy` is right about my machine: maybe `scipy` is wrong when it says that `AVX512F` is not supported? How to know for sure?",
    "created_at": "2021-06-23T21:46:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518533",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:33'>Comment 33:</a>
By the way, I don't know if `numpy` is right or if `scipy` is right about my machine: maybe `scipy` is wrong when it says that `AVX512F` is not supported? How to know for sure?



---

archive/issue_comments_518534.json:
```json
{
    "body": "<a id='comment:34'>Comment 34:</a>\n`lscpu` or `echo | gcc -dM -E - -march=native`.",
    "created_at": "2021-06-23T21:48:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518534",
    "user": "https://github.com/kliem"
}
```

<a id='comment:34'>Comment 34:</a>
`lscpu` or `echo | gcc -dM -E - -march=native`.



---

archive/issue_comments_518535.json:
```json
{
    "body": "Changed commit from **[b3e2a53](https://github.com/sagemath/sagetrac-mirror/commit/b3e2a534bd6f4d3d164b0bf8ad0ab33b64cd282f)** to **[9c87b65](https://github.com/sagemath/sagetrac-mirror/commit/9c87b6571ec5bb9a4dce5f2761906b0110e2709a)**",
    "created_at": "2021-06-23T21:51:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518535",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[b3e2a53](https://github.com/sagemath/sagetrac-mirror/commit/b3e2a534bd6f4d3d164b0bf8ad0ab33b64cd282f)** to **[9c87b65](https://github.com/sagemath/sagetrac-mirror/commit/9c87b6571ec5bb9a4dce5f2761906b0110e2709a)**



---

archive/issue_comments_518536.json:
```json
{
    "body": "<a id='comment:35'>Comment 35:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9c87b6571ec5bb9a4dce5f2761906b0110e2709a\">9c87b65</a></td><td><code>correct explanation as popcnt wasnt the problem here</code></td></tr></table>\n",
    "created_at": "2021-06-23T21:51:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518536",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:35'>Comment 35:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9c87b6571ec5bb9a4dce5f2761906b0110e2709a">9c87b65</a></td><td><code>correct explanation as popcnt wasnt the problem here</code></td></tr></table>




---

archive/issue_comments_518537.json:
```json
{
    "body": "<a id='comment:36'>Comment 36:</a>\nIf I run `echo | gcc -dM -E - -march=native`, it prints many things including\n\n```\n#define __AVX512F__ 1\n```\nOS X doesn't include `lscpu`, but if I run `sysctl -a | grep machdep.cpu`, it tells me\n\n```\nmachdep.cpu.leaf7_features: RDWRFSGS TSC_THREAD_OFFSET BMI1 HLE AVX2 FDPEO SMEP BMI2 ERMS INVPCID RTM PQM FPU_CSDS MPX PQE AVX512F AVX512DQ RDSEED ADX SMAP CLFSOPT CLWB IPT AVX512CD AVX512BW AVX512VL MDCLEAR TSXFA IBRS STIBP L1DF SSBD\n```\nDoes this mean that `AVX512F` is a feature, so `scipy` is wrong?",
    "created_at": "2021-06-23T21:55:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518537",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:36'>Comment 36:</a>
If I run `echo | gcc -dM -E - -march=native`, it prints many things including

```
#define __AVX512F__ 1
```
OS X doesn't include `lscpu`, but if I run `sysctl -a | grep machdep.cpu`, it tells me

```
machdep.cpu.leaf7_features: RDWRFSGS TSC_THREAD_OFFSET BMI1 HLE AVX2 FDPEO SMEP BMI2 ERMS INVPCID RTM PQM FPU_CSDS MPX PQE AVX512F AVX512DQ RDSEED ADX SMAP CLFSOPT CLWB IPT AVX512CD AVX512BW AVX512VL MDCLEAR TSXFA IBRS STIBP L1DF SSBD
```
Does this mean that `AVX512F` is a feature, so `scipy` is wrong?



---

archive/issue_comments_518538.json:
```json
{
    "body": "<a id='comment:37'>Comment 37:</a>\nThat does look like scipy is wrong.",
    "created_at": "2021-06-23T21:58:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518538",
    "user": "https://github.com/kliem"
}
```

<a id='comment:37'>Comment 37:</a>
That does look like scipy is wrong.



---

archive/issue_comments_518539.json:
```json
{
    "body": "<a id='comment:38'>Comment 38:</a>\nThe error arises when doing `import numpy` in Python, which `scipy` must try to do early in its build process. So it's not really `scipy`, it's within `numpy`. I don't know how to track this down.",
    "created_at": "2021-06-23T22:07:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518539",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:38'>Comment 38:</a>
The error arises when doing `import numpy` in Python, which `scipy` must try to do early in its build process. So it's not really `scipy`, it's within `numpy`. I don't know how to track this down.



---

archive/issue_comments_518540.json:
```json
{
    "body": "<a id='comment:39'>Comment 39:</a>\nIt happens here:\n\nhttps://github.com/numpy/numpy/blob/623bc1fae1d47df24e7f1e29321d0c0ba2771ce0/numpy/core/src/common/npy_cpu_features.c.src\n\nAround line 160. For some reason this check does not work for AVX512F in your case. So yes, this is a numpy bug.",
    "created_at": "2021-06-23T22:09:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518540",
    "user": "https://github.com/kliem"
}
```

<a id='comment:39'>Comment 39:</a>
It happens here:

https://github.com/numpy/numpy/blob/623bc1fae1d47df24e7f1e29321d0c0ba2771ce0/numpy/core/src/common/npy_cpu_features.c.src

Around line 160. For some reason this check does not work for AVX512F in your case. So yes, this is a numpy bug.



---

archive/issue_comments_518541.json:
```json
{
    "body": "<a id='comment:40'>Comment 40:</a>\nI opened https://github.com/numpy/numpy/issues/19319.",
    "created_at": "2021-06-23T22:47:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518541",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:40'>Comment 40:</a>
I opened https://github.com/numpy/numpy/issues/19319.



---

archive/issue_comments_518542.json:
```json
{
    "body": "<a id='comment:41'>Comment 41:</a>\nWith this patch, I'm able to compile on a Intel MacBook Air with macOS 10.15.7. I will run doctests asap.",
    "created_at": "2021-06-24T07:01:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518542",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:41'>Comment 41:</a>
With this patch, I'm able to compile on a Intel MacBook Air with macOS 10.15.7. I will run doctests asap.



---

archive/issue_comments_518543.json:
```json
{
    "body": "<a id='comment:42'>Comment 42:</a>\nWorks for me, too, and doctests pass as well.",
    "created_at": "2021-06-24T17:17:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518543",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:42'>Comment 42:</a>
Works for me, too, and doctests pass as well.



---

archive/issue_comments_518544.json:
```json
{
    "body": "<a id='comment:43'>Comment 43:</a>\nI would like someone with more familiarity with the build scripts to look over those changes. Also, there is now a NumPy bugfix for my particular problem: https://github.com/numpy/numpy/pull/19362. I think that it is safest to use `export CFLAGS=\"$CFLAGS_NON_NATIVE\"` for now when building NumPy and not worry about using this patch, but at some point we should investigate whether they've fixed all of the relevant problems.",
    "created_at": "2021-06-28T18:58:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518544",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:43'>Comment 43:</a>
I would like someone with more familiarity with the build scripts to look over those changes. Also, there is now a NumPy bugfix for my particular problem: https://github.com/numpy/numpy/pull/19362. I think that it is safest to use `export CFLAGS="$CFLAGS_NON_NATIVE"` for now when building NumPy and not worry about using this patch, but at some point we should investigate whether they've fixed all of the relevant problems.



---

archive/issue_comments_518545.json:
```json
{
    "body": "<a id='comment:44'>Comment 44:</a>\nThis PR has been backported to 1.21.x as https://github.com/numpy/numpy/pull/19365, but there is no indication whether it will also be backported to 1.20.x. Have you tried whether the patch applies?",
    "created_at": "2021-06-28T19:07:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518545",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:44'>Comment 44:</a>
This PR has been backported to 1.21.x as https://github.com/numpy/numpy/pull/19365, but there is no indication whether it will also be backported to 1.20.x. Have you tried whether the patch applies?



---

archive/issue_comments_518546.json:
```json
{
    "body": "<a id='comment:45'>Comment 45:</a>\n`src/bin/sage-env-config.in` uses `SAGE_ENV_CONFIG_SOURCED` and `src/bin/sage-env` uses `SAGE_ENV_SOURCED`, so probably `SAGE_HAS_RUN_SAGE_BUILD_ENV` should be renamed to follow the same pattern.\n\nOtherwise the changes to `sage-build-env`, `sage-build-env-config.in` look good to me. Thanks for simplifying the latter!\n\nI would probably prefer to use the upstream fix, if easily possible, rather than the workaround with weaker CFLAGS.",
    "created_at": "2021-06-28T19:17:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518546",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:45'>Comment 45:</a>
`src/bin/sage-env-config.in` uses `SAGE_ENV_CONFIG_SOURCED` and `src/bin/sage-env` uses `SAGE_ENV_SOURCED`, so probably `SAGE_HAS_RUN_SAGE_BUILD_ENV` should be renamed to follow the same pattern.

Otherwise the changes to `sage-build-env`, `sage-build-env-config.in` look good to me. Thanks for simplifying the latter!

I would probably prefer to use the upstream fix, if easily possible, rather than the workaround with weaker CFLAGS.



---

archive/issue_comments_518547.json:
```json
{
    "body": "<a id='comment:46'>Comment 46:</a>\nThe upstream fix will work for me (if it applies to 1.20.3 \u2014\u00a0I haven't tested yet), but I don't know if it will work for the issue cited in the ticket description.",
    "created_at": "2021-06-28T19:48:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518547",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:46'>Comment 46:</a>
The upstream fix will work for me (if it applies to 1.20.3 — I haven't tested yet), but I don't know if it will work for the issue cited in the ticket description.



---

archive/issue_comments_518548.json:
```json
{
    "body": "<a id='comment:47'>Comment 47:</a>\nThe patch from [comment:18](#comment%3A18) might work for this. As we have a working branch, the reasonable thing would be to open another ticket that tries to apply both patches to fix the problem?",
    "created_at": "2021-06-28T20:50:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518548",
    "user": "https://github.com/kliem"
}
```

<a id='comment:47'>Comment 47:</a>
The patch from [comment:18](#comment%3A18) might work for this. As we have a working branch, the reasonable thing would be to open another ticket that tries to apply both patches to fix the problem?



---

archive/issue_comments_518549.json:
```json
{
    "body": "<a id='comment:48'>Comment 48:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/56ffafb6af3cba4d7d203962ffa772fc9366f9c1\">56ffafb</a></td><td><code>more consistent header guard name</code></td></tr></table>\n",
    "created_at": "2021-06-28T20:54:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518549",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:48'>Comment 48:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/56ffafb6af3cba4d7d203962ffa772fc9366f9c1">56ffafb</a></td><td><code>more consistent header guard name</code></td></tr></table>




---

archive/issue_comments_518550.json:
```json
{
    "body": "Changed commit from **[9c87b65](https://github.com/sagemath/sagetrac-mirror/commit/9c87b6571ec5bb9a4dce5f2761906b0110e2709a)** to **[56ffafb](https://github.com/sagemath/sagetrac-mirror/commit/56ffafb6af3cba4d7d203962ffa772fc9366f9c1)**",
    "created_at": "2021-06-28T20:54:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518550",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[9c87b65](https://github.com/sagemath/sagetrac-mirror/commit/9c87b6571ec5bb9a4dce5f2761906b0110e2709a)** to **[56ffafb](https://github.com/sagemath/sagetrac-mirror/commit/56ffafb6af3cba4d7d203962ffa772fc9366f9c1)**



---

archive/issue_comments_518551.json:
```json
{
    "body": "<a id='comment:49'>Comment 49:</a>\nThe upstream patch applies and Sage builds with it. I like the idea of opening another ticket with the two patches and also attempting to remove `export CFLAGS=\"$CFLAGS_NON_NATIVE\"`.",
    "created_at": "2021-06-28T21:32:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518551",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:49'>Comment 49:</a>
The upstream patch applies and Sage builds with it. I like the idea of opening another ticket with the two patches and also attempting to remove `export CFLAGS="$CFLAGS_NON_NATIVE"`.



---

archive/issue_comments_518552.json:
```json
{
    "body": "<a id='comment:50'>Comment 50:</a>\nReplying to [@jhpalmieri](#comment%3A49):\n> The upstream patch applies and Sage builds with it. I like the idea of opening another ticket with the two patches and also attempting to remove `export CFLAGS=\"$CFLAGS_NON_NATIVE\"`.\n\nSee #32080.",
    "created_at": "2021-06-29T00:06:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518552",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:50'>Comment 50:</a>
Replying to [@jhpalmieri](#comment%3A49):
> The upstream patch applies and Sage builds with it. I like the idea of opening another ticket with the two patches and also attempting to remove `export CFLAGS="$CFLAGS_NON_NATIVE"`.

See #32080.



---

archive/issue_comments_518553.json:
```json
{
    "body": "Changed commit from **[56ffafb](https://github.com/sagemath/sagetrac-mirror/commit/56ffafb6af3cba4d7d203962ffa772fc9366f9c1)** to **[a7eef1b](https://github.com/sagemath/sagetrac-mirror/commit/a7eef1b2357cd3862facf64edb81abdafbda6923)**",
    "created_at": "2021-07-06T18:21:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518553",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[56ffafb](https://github.com/sagemath/sagetrac-mirror/commit/56ffafb6af3cba4d7d203962ffa772fc9366f9c1)** to **[a7eef1b](https://github.com/sagemath/sagetrac-mirror/commit/a7eef1b2357cd3862facf64edb81abdafbda6923)**



---

archive/issue_comments_518554.json:
```json
{
    "body": "<a id='comment:51'>Comment 51:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f02780fcbf9dad55c7d5bfc1edf75b04bb6add6d\">f02780f</a></td><td><code>.github/workflows/ci-cygwin-*: Repair passing '--enable-fat-binary' to configure</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a7eef1b2357cd3862facf64edb81abdafbda6923\">a7eef1b</a></td><td><code>Merge tag '9.4.beta4' into t/32021/public/32021</code></td></tr></table>\n",
    "created_at": "2021-07-06T18:21:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518554",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:51'>Comment 51:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f02780fcbf9dad55c7d5bfc1edf75b04bb6add6d">f02780f</a></td><td><code>.github/workflows/ci-cygwin-*: Repair passing '--enable-fat-binary' to configure</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a7eef1b2357cd3862facf64edb81abdafbda6923">a7eef1b</a></td><td><code>Merge tag '9.4.beta4' into t/32021/public/32021</code></td></tr></table>




---

archive/issue_comments_518555.json:
```json
{
    "body": "<a id='comment:52'>Comment 52:</a>\nI've pushed a fix for the Cygwin CI script (see #32080).",
    "created_at": "2021-07-06T18:21:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518555",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:52'>Comment 52:</a>
I've pushed a fix for the Cygwin CI script (see #32080).



---

archive/issue_comments_518556.json:
```json
{
    "body": "Reviewer: **https://github.com/mkoeppe/sage/actions/runs/1005406512**",
    "created_at": "2021-07-06T18:22:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518556",
    "user": "https://github.com/mkoeppe"
}
```

Reviewer: **https://github.com/mkoeppe/sage/actions/runs/1005406512**



---

archive/issue_comments_518557.json:
```json
{
    "body": "<a id='comment:54'>Comment 54:</a>\nIt's all fine with me. I am willing to trust Matthias' bot for the Cygwin stuff, but I would be happier if someone else could verify the problem and solution. I've taken a look at the changes to `sage-build-env` and `sage-build-env-config.in` and they make sense, but again, I would like more people to look at it.\n\nGiven those caveats, positive review from me.",
    "created_at": "2021-07-07T18:46:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518557",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:54'>Comment 54:</a>
It's all fine with me. I am willing to trust Matthias' bot for the Cygwin stuff, but I would be happier if someone else could verify the problem and solution. I've taken a look at the changes to `sage-build-env` and `sage-build-env-config.in` and they make sense, but again, I would like more people to look at it.

Given those caveats, positive review from me.



---

archive/issue_comments_518558.json:
```json
{
    "body": "Changed reviewer from **https://github.com/mkoeppe/sage/actions/runs/1005406512** to **John Palmieri, https://github.com/mkoeppe/sage/actions/runs/1005406512, ...**",
    "created_at": "2021-07-07T18:46:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518558",
    "user": "https://github.com/jhpalmieri"
}
```

Changed reviewer from **https://github.com/mkoeppe/sage/actions/runs/1005406512** to **John Palmieri, https://github.com/mkoeppe/sage/actions/runs/1005406512, ...**



---

archive/issue_comments_518559.json:
```json
{
    "body": "<a id='comment:55'>Comment 55:</a>\nprobably this should be tested with a pynac fix for Cygwin - otherwise there are errors installing pynac.",
    "created_at": "2021-07-07T19:33:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518559",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:55'>Comment 55:</a>
probably this should be tested with a pynac fix for Cygwin - otherwise there are errors installing pynac.



---

archive/issue_comments_518560.json:
```json
{
    "body": "<a id='comment:56'>Comment 56:</a>\nLooks good enough for me on Cygwin. The pynac problem is unrelated.\n\nLet's get this in.",
    "created_at": "2021-07-07T20:01:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518560",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:56'>Comment 56:</a>
Looks good enough for me on Cygwin. The pynac problem is unrelated.

Let's get this in.



---

archive/issue_comments_518561.json:
```json
{
    "body": "Changed reviewer from **John Palmieri, https://github.com/mkoeppe/sage/actions/runs/1005406512, ...** to **John Palmieri, Matthias Koeppe**",
    "created_at": "2021-07-07T20:01:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518561",
    "user": "https://github.com/mkoeppe"
}
```

Changed reviewer from **John Palmieri, https://github.com/mkoeppe/sage/actions/runs/1005406512, ...** to **John Palmieri, Matthias Koeppe**



---

archive/issue_events_409206.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-07T20:01:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32021#event-409206"
}
```



---

archive/issue_events_409207.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-07T20:01:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32021#event-409207"
}
```



---

archive/issue_comments_518562.json:
```json
{
    "body": "Changed branch from **[public/32021](https://github.com/sagemath/sagetrac-mirror/tree/public/32021)** to **[a7eef1b](https://github.com/sagemath/sagetrac-mirror/commit/a7eef1b2357cd3862facf64edb81abdafbda6923)**",
    "created_at": "2021-07-18T22:53:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32021#issuecomment-518562",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/32021](https://github.com/sagemath/sagetrac-mirror/tree/public/32021)** to **[a7eef1b](https://github.com/sagemath/sagetrac-mirror/commit/a7eef1b2357cd3862facf64edb81abdafbda6923)**



---

archive/issue_events_409208.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-07-18T22:53:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32021#event-409208"
}
```



---

archive/issue_events_409209.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "1ef30425a1b835d60e2a9a2b3449f697418206bf",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-07-18T22:53:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/32021",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32021#event-409209"
}
```
