# Issue 32021: numpy 1.20* inconsistent in recognising CPU features

archive/issues_031784.json:
```json
{
    "body": "typically this looks like the following:\nhttps://groups.google.com/d/msgid/sage-devel/763f8650-9803-4bba-a0ec-46744204fc22n%40googlegroups.com?utm_medium=email&utm_source=footer\n\n```\n[sagelib-9.4.beta2]   File \"/home/chapoton/sage/local/lib/python3.8/site-packages/numpy/core/overrides.py\", line 7, in <module>\n[sagelib-9.4.beta2]     from numpy.core._multiarray_umath import (\n[sagelib-9.4.beta2] RuntimeError: NumPy was built with baseline optimizations: \n[sagelib-9.4.beta2] (SSE SSE2 SSE3 SSSE3 SSE41 POPCNT SSE42) but your machine doesn't support:\n[sagelib-9.4.beta2] (POPCNT).\n```\n\nCC:  @kliem @dcoudert @fchapoton\n\nBranch/Commit: a7eef1b2357cd3862facf64edb81abdafbda6923\n\nReviewer: John Palmieri, Matthias Koeppe\n\nAuthor: Jonathan Kliem\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32021\n\n",
    "closed_at": "2021-07-18T22:53:27Z",
    "created_at": "2021-06-21T12:35:11Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "numpy 1.20* inconsistent in recognising CPU features",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32021",
    "user": "https://github.com/dimpase"
}
```
typically this looks like the following:
https://groups.google.com/d/msgid/sage-devel/763f8650-9803-4bba-a0ec-46744204fc22n%40googlegroups.com?utm_medium=email&utm_source=footer

```
[sagelib-9.4.beta2]   File "/home/chapoton/sage/local/lib/python3.8/site-packages/numpy/core/overrides.py", line 7, in <module>
[sagelib-9.4.beta2]     from numpy.core._multiarray_umath import (
[sagelib-9.4.beta2] RuntimeError: NumPy was built with baseline optimizations: 
[sagelib-9.4.beta2] (SSE SSE2 SSE3 SSSE3 SSE41 POPCNT SSE42) but your machine doesn't support:
[sagelib-9.4.beta2] (POPCNT).
```

CC:  @kliem @dcoudert @fchapoton

Branch/Commit: a7eef1b2357cd3862facf64edb81abdafbda6923

Reviewer: John Palmieri, Matthias Koeppe

Author: Jonathan Kliem

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/32021





---

archive/issue_comments_637179.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2021-06-21T12:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637179",
    "user": "https://github.com/dimpase"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_637180.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to build.",
    "created_at": "2021-06-21T12:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637180",
    "user": "https://github.com/dimpase"
}
```

Changing component from PLEASE CHANGE to build.



---

archive/issue_comments_637181.json:
```json
{
    "body": "<a id='comment:2'></a>See also https://groups.google.com/g/sage-release/c/lmUFq4d7is0/m/uKRsE9KoBQAJ\n\nIt could be that builds in question actually took a prebuilt on another machine numpy, then it's a numpy bug, I guess, to install an incompatible binary.",
    "created_at": "2021-06-21T12:45:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637181",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:2'></a>See also https://groups.google.com/g/sage-release/c/lmUFq4d7is0/m/uKRsE9KoBQAJ

It could be that builds in question actually took a prebuilt on another machine numpy, then it's a numpy bug, I guess, to install an incompatible binary.



---

archive/issue_comments_637182.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2021-06-21T15:57:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637182",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_637183.json:
```json
{
    "body": "<a id='comment:5'></a>I see this when building from scratch on an iMac Pro, OS X 10.15.7, with various homebrew packages installed. `numpy` is built from scratch and says\n\n```\n########### EXT COMPILER OPTIMIZATION ###########\nPlatform      : \n  Architecture: x64\n  Compiler    : gcc\n\nCPU baseline  : \n  Requested   : 'native'\n  Enabled     : SSE SSE2 SSE3 SSSE3 SSE41 POPCNT SSE42 AVX F16C FMA3 AVX2 AVX512F AVX512CD AVX512_SKX\n  Flags       : -msse -msse2 -msse3 -mssse3 -msse4.1 -mpopcnt -msse4.2 -mavx -mf16c -mfma -mavx2 -mavx512f -mavx512cd -mavx512vl -mavx512bw -mavx512dq\n  Extra checks: AVX512F_REDUCE AVX512BW_MASK AVX512DQ_MASK\n\nCPU dispatch  : \n  Requested   : 'max -xop -fma4'\n  Enabled     : AVX512_KNL AVX512_CLX AVX512_CNL AVX512_ICL\n  Generated   : none\nCCompilerOpt._cache_write[796] : write cache to path -> /Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta2/local/var/tmp/sage/build/numpy-1.20.3/src/build/temp.macosx-10.15-x86_64-3.9/ccompiler_opt_cache_ext.py\n\n########### CLIB COMPILER OPTIMIZATION ###########\nPlatform      : \n  Architecture: x64\n  Compiler    : gcc\n\nCPU baseline  : \n  Requested   : 'native'\n  Enabled     : SSE SSE2 SSE3 SSSE3 SSE41 POPCNT SSE42 AVX F16C FMA3 AVX2 AVX512F AVX512CD AVX512_SKX\n  Flags       : -msse -msse2 -msse3 -mssse3 -msse4.1 -mpopcnt -msse4.2 -mavx -mf16c -mfma -mavx2 -mavx512f -mavx512cd -mavx512vl -mavx512bw -mavx512dq\n  Extra checks: AVX512F_REDUCE AVX512BW_MASK AVX512DQ_MASK\n\nCPU dispatch  : \n  Requested   : 'max -xop -fma4'\n  Enabled     : AVX512_KNL AVX512_CLX AVX512_CNL AVX512_ICL\n  Generated   : none\n```\n`scipy` fails with\n\n```\n    RuntimeError: NumPy was built with baseline optimizations:\n    (SSE SSE2 SSE3 SSSE3 SSE41 POPCNT SSE42 AVX F16C FMA3 AVX2 AVX512F AVX512CD AVX512_SKX) but your machine doesn't support:\n    (AVX512F).\n```\nI notice that we deleted related `numpy` patches in the latest update, presumably because they were included into the source code. There must have been other changes in the source that broke something else.",
    "created_at": "2021-06-21T22:21:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637183",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:5'></a>I see this when building from scratch on an iMac Pro, OS X 10.15.7, with various homebrew packages installed. `numpy` is built from scratch and says

```
########### EXT COMPILER OPTIMIZATION ###########
Platform      : 
  Architecture: x64
  Compiler    : gcc

CPU baseline  : 
  Requested   : 'native'
  Enabled     : SSE SSE2 SSE3 SSSE3 SSE41 POPCNT SSE42 AVX F16C FMA3 AVX2 AVX512F AVX512CD AVX512_SKX
  Flags       : -msse -msse2 -msse3 -mssse3 -msse4.1 -mpopcnt -msse4.2 -mavx -mf16c -mfma -mavx2 -mavx512f -mavx512cd -mavx512vl -mavx512bw -mavx512dq
  Extra checks: AVX512F_REDUCE AVX512BW_MASK AVX512DQ_MASK

CPU dispatch  : 
  Requested   : 'max -xop -fma4'
  Enabled     : AVX512_KNL AVX512_CLX AVX512_CNL AVX512_ICL
  Generated   : none
CCompilerOpt._cache_write[796] : write cache to path -> /Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.4.beta2/local/var/tmp/sage/build/numpy-1.20.3/src/build/temp.macosx-10.15-x86_64-3.9/ccompiler_opt_cache_ext.py

########### CLIB COMPILER OPTIMIZATION ###########
Platform      : 
  Architecture: x64
  Compiler    : gcc

CPU baseline  : 
  Requested   : 'native'
  Enabled     : SSE SSE2 SSE3 SSSE3 SSE41 POPCNT SSE42 AVX F16C FMA3 AVX2 AVX512F AVX512CD AVX512_SKX
  Flags       : -msse -msse2 -msse3 -mssse3 -msse4.1 -mpopcnt -msse4.2 -mavx -mf16c -mfma -mavx2 -mavx512f -mavx512cd -mavx512vl -mavx512bw -mavx512dq
  Extra checks: AVX512F_REDUCE AVX512BW_MASK AVX512DQ_MASK

CPU dispatch  : 
  Requested   : 'max -xop -fma4'
  Enabled     : AVX512_KNL AVX512_CLX AVX512_CNL AVX512_ICL
  Generated   : none
```
`scipy` fails with

```
    RuntimeError: NumPy was built with baseline optimizations:
    (SSE SSE2 SSE3 SSSE3 SSE41 POPCNT SSE42 AVX F16C FMA3 AVX2 AVX512F AVX512CD AVX512_SKX) but your machine doesn't support:
    (AVX512F).
```
I notice that we deleted related `numpy` patches in the latest update, presumably because they were included into the source code. There must have been other changes in the source that broke something else.



---

archive/issue_comments_637184.json:
```json
{
    "body": "<a id='comment:6'></a>I cannot build Sage on this machine right now; does that this ticket a blocker, or is it too architecture-specific? (I can build on some other OS X machines just fine.)",
    "created_at": "2021-06-21T22:33:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637184",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:6'></a>I cannot build Sage on this machine right now; does that this ticket a blocker, or is it too architecture-specific? (I can build on some other OS X machines just fine.)



---

archive/issue_comments_637185.json:
```json
{
    "body": "<a id='comment:7'></a>If you add `--cpu-baseline=\"sse2\"` to `spkg-install. Will this work? Similar to #31565.",
    "created_at": "2021-06-22T11:32:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637185",
    "user": "https://github.com/kliem"
}
```

<a id='comment:7'></a>If you add `--cpu-baseline="sse2"` to `spkg-install. Will this work? Similar to #31565.



---

archive/issue_comments_637186.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:6 jhpalmieri]:\n> I cannot build Sage on this machine right now; does that this ticket a blocker, or is it too architecture-specific? (I can build on some other OS X machines just fine.)\n\n\nCan you do a standalone build of scipy+numpy on that machine?\nOr does it fail in the same way?",
    "created_at": "2021-06-22T12:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637186",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>Replying to [comment:6 jhpalmieri]:
> I cannot build Sage on this machine right now; does that this ticket a blocker, or is it too architecture-specific? (I can build on some other OS X machines just fine.)


Can you do a standalone build of scipy+numpy on that machine?
Or does it fail in the same way?



---

archive/issue_comments_637187.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 dimpase]:\n> Replying to [comment:6 jhpalmieri]:\n> > I cannot build Sage on this machine right now; does that this ticket a blocker, or is it too architecture-specific? (I can build on some other OS X machines just fine.)\n\n> \n> Can you do a standalone build of scipy+numpy on that machine?\n> Or does it fail in the same way?\n\n\nI can't easily mimic the Sage install. If I just unpack the zip file for `numpy` and run `python3 setup.py build -j 4 install --prefix $HOME/.local`, it complains about `blas` stuff:\n\n```\nRuntimeError: Found /usr/lib/libcblas.dylib, but that file is a symbolic link to the MacOS Accelerate framework, which is not supported by NumPy. You must configure the build to use a different optimized library, or disable the use of optimized BLAS and LAPACK by setting the environment variables NPY_BLAS_ORDER=\"\" and NPY_LAPACK_ORDER=\"\" before building NumPy.\n```\nI tried running Sage's `lapack_conf.py`, but it complained about not finding cblas. `numpy` installed after `export NPY_BLAS_ORDER=\"\"` and `export NPY_LAPACK_ORDER=\"\"`, but `scipy` did not.\n\nSo I don't understand how to build numpy+scipy on this machine.",
    "created_at": "2021-06-22T15:16:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637187",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:9'></a>Replying to [comment:8 dimpase]:
> Replying to [comment:6 jhpalmieri]:
> > I cannot build Sage on this machine right now; does that this ticket a blocker, or is it too architecture-specific? (I can build on some other OS X machines just fine.)

> 
> Can you do a standalone build of scipy+numpy on that machine?
> Or does it fail in the same way?


I can't easily mimic the Sage install. If I just unpack the zip file for `numpy` and run `python3 setup.py build -j 4 install --prefix $HOME/.local`, it complains about `blas` stuff:

```
RuntimeError: Found /usr/lib/libcblas.dylib, but that file is a symbolic link to the MacOS Accelerate framework, which is not supported by NumPy. You must configure the build to use a different optimized library, or disable the use of optimized BLAS and LAPACK by setting the environment variables NPY_BLAS_ORDER="" and NPY_LAPACK_ORDER="" before building NumPy.
```
I tried running Sage's `lapack_conf.py`, but it complained about not finding cblas. `numpy` installed after `export NPY_BLAS_ORDER=""` and `export NPY_LAPACK_ORDER=""`, but `scipy` did not.

So I don't understand how to build numpy+scipy on this machine.



---

archive/issue_comments_637188.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:7 gh-kliem]:\n> If you add `--cpu-baseline=\"sse2\"` to `spkg-install. Will this work? Similar to #31565.\n\n\nI tried\n\n```diff\ndiff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in\nindex 1237d059d3..5d45f176ae 100644\n--- a/build/pkgs/numpy/spkg-install.in\n+++ b/build/pkgs/numpy/spkg-install.in\n@@ -22,7 +22,7 @@ python3 ../lapack_conf.py\n export FFLAGS=\"$FFLAGS -fPIC\"\n export FCFLAGS=\"$FCFLAGS -fPIC\"\n \n-export NUMPY_FCONFIG=\"config_fc --noopt --noarch\"\n+export NUMPY_FCONFIG=\"config_fc --noopt --noarch --cpu-baseline=\\\"sse2\\\"\"\n \n ################################################\n \n```\nbut this isn't the right syntax:\n\n```\nusage: setup.py [global_opts] cmd1 [cmd1_opts] [cmd2 [cmd2_opts] ...]\n   or: setup.py --help [cmd1 cmd2 ...]\n   or: setup.py --help-commands\n   or: setup.py cmd --help\n\nerror: option --cpu-baseline not recognized\n```\nCan you provide more guidance?",
    "created_at": "2021-06-22T15:27:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637188",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:10'></a>Replying to [comment:7 gh-kliem]:
> If you add `--cpu-baseline="sse2"` to `spkg-install. Will this work? Similar to #31565.


I tried

```diff
diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in
index 1237d059d3..5d45f176ae 100644
--- a/build/pkgs/numpy/spkg-install.in
+++ b/build/pkgs/numpy/spkg-install.in
@@ -22,7 +22,7 @@ python3 ../lapack_conf.py
 export FFLAGS="$FFLAGS -fPIC"
 export FCFLAGS="$FCFLAGS -fPIC"
 
-export NUMPY_FCONFIG="config_fc --noopt --noarch"
+export NUMPY_FCONFIG="config_fc --noopt --noarch --cpu-baseline=\"sse2\""
 
 ################################################
 
```
but this isn't the right syntax:

```
usage: setup.py [global_opts] cmd1 [cmd1_opts] [cmd2 [cmd2_opts] ...]
   or: setup.py --help [cmd1 cmd2 ...]
   or: setup.py --help-commands
   or: setup.py cmd --help

error: option --cpu-baseline not recognized
```
Can you provide more guidance?



---

archive/issue_comments_637189.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:10 jhpalmieri]:\n> Replying to [comment:7 gh-kliem]:\n> > If you add `--cpu-baseline=\"sse2\"` to `spkg-install. Will this work? Similar to #31565.\n\n> \n> I tried\n> \n> ```\n> #!diff\n> diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in\n> index 1237d059d3..5d45f176ae 100644\n> --- a/build/pkgs/numpy/spkg-install.in\n> +++ b/build/pkgs/numpy/spkg-install.in\n> @@ -22,7 +22,7 @@ python3 ../lapack_conf.py\n>  export FFLAGS=\"$FFLAGS -fPIC\"\n>  export FCFLAGS=\"$FCFLAGS -fPIC\"\n>  \n> -export NUMPY_FCONFIG=\"config_fc --noopt --noarch\"\n> +export NUMPY_FCONFIG=\"config_fc --noopt --noarch --cpu-baseline=\\\"sse2\\\"\"\n>  \n>  ################################################\n>  \n> ```\n> but this isn't the right syntax:\n> \n> ```\n> usage: setup.py [global_opts] cmd1 [cmd1_opts] [cmd2 [cmd2_opts] ...]\n>    or: setup.py --help [cmd1 cmd2 ...]\n>    or: setup.py --help-commands\n>    or: setup.py cmd --help\n> \n> error: option --cpu-baseline not recognized\n> ```\n> Can you provide more guidance?\n\n\nThanks for catching this. Actually you need to do it during a different command:\n\n```diff\ndiff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in\nindex 1237d059d3..c261d89444 100644\n--- a/build/pkgs/numpy/spkg-install.in\n+++ b/build/pkgs/numpy/spkg-install.in\n@@ -28,4 +28,4 @@ export NUMPY_FCONFIG=\"config_fc --noopt --noarch\"\n \n sdh_setup_bdist_wheel ${NUMPY_FCONFIG}\n \n-sdh_store_and_pip_install_wheel .\n+sdh_store_and_pip_install_wheel . --cpu-baseline=\"sse2\"\n```\nA cleaner solution and also a good solution for a branch might be to disable `-march=native` via\n\n```\nexport CFLAGS=\"$CFLAGS_NON_NATIVE\"\n```\nNumpy will still compile intrinsics to be dispatched on runtime. (And even if it isn't the case, the policy was that `-march=native` should only be enabled as long as this does not effect portability). Either way it appears to be a numpy bug, because it detects your architecture wrongly.\n\nI hope one of those things work.\n\nEdited: See comment below",
    "created_at": "2021-06-22T18:22:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637189",
    "user": "https://github.com/kliem"
}
```

<a id='comment:11'></a>Replying to [comment:10 jhpalmieri]:
> Replying to [comment:7 gh-kliem]:
> > If you add `--cpu-baseline="sse2"` to `spkg-install. Will this work? Similar to #31565.

> 
> I tried
> 
> ```
> #!diff
> diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in
> index 1237d059d3..5d45f176ae 100644
> --- a/build/pkgs/numpy/spkg-install.in
> +++ b/build/pkgs/numpy/spkg-install.in
> @@ -22,7 +22,7 @@ python3 ../lapack_conf.py
>  export FFLAGS="$FFLAGS -fPIC"
>  export FCFLAGS="$FCFLAGS -fPIC"
>  
> -export NUMPY_FCONFIG="config_fc --noopt --noarch"
> +export NUMPY_FCONFIG="config_fc --noopt --noarch --cpu-baseline=\"sse2\""
>  
>  ################################################
>  
> ```
> but this isn't the right syntax:
> 
> ```
> usage: setup.py [global_opts] cmd1 [cmd1_opts] [cmd2 [cmd2_opts] ...]
>    or: setup.py --help [cmd1 cmd2 ...]
>    or: setup.py --help-commands
>    or: setup.py cmd --help
> 
> error: option --cpu-baseline not recognized
> ```
> Can you provide more guidance?


Thanks for catching this. Actually you need to do it during a different command:

```diff
diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in
index 1237d059d3..c261d89444 100644
--- a/build/pkgs/numpy/spkg-install.in
+++ b/build/pkgs/numpy/spkg-install.in
@@ -28,4 +28,4 @@ export NUMPY_FCONFIG="config_fc --noopt --noarch"
 
 sdh_setup_bdist_wheel ${NUMPY_FCONFIG}
 
-sdh_store_and_pip_install_wheel .
+sdh_store_and_pip_install_wheel . --cpu-baseline="sse2"
```
A cleaner solution and also a good solution for a branch might be to disable `-march=native` via

```
export CFLAGS="$CFLAGS_NON_NATIVE"
```
Numpy will still compile intrinsics to be dispatched on runtime. (And even if it isn't the case, the policy was that `-march=native` should only be enabled as long as this does not effect portability). Either way it appears to be a numpy bug, because it detects your architecture wrongly.

I hope one of those things work.

Edited: See comment below



---

archive/issue_comments_637190.json:
```json
{
    "body": "<a id='comment:12'></a>Actually you don't want `cpu-dispatch` but `cpu-baseline` as before.",
    "created_at": "2021-06-22T18:23:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637190",
    "user": "https://github.com/kliem"
}
```

<a id='comment:12'></a>Actually you don't want `cpu-dispatch` but `cpu-baseline` as before.



---

archive/issue_comments_637191.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:11 gh-kliem]:\n> Thanks for catching this. Actually you need to do it during a different command:\n> \n> \n> ```diff\n> diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in\n> index 1237d059d3..c261d89444 100644\n> --- a/build/pkgs/numpy/spkg-install.in\n> +++ b/build/pkgs/numpy/spkg-install.in\n> @@ -28,4 +28,4 @@ export NUMPY_FCONFIG=\"config_fc --noopt --noarch\"\n>  \n>  sdh_setup_bdist_wheel ${NUMPY_FCONFIG}\n>  \n> -sdh_store_and_pip_install_wheel .\n> +sdh_store_and_pip_install_wheel . --cpu-baseline=\"sse2\"\n> ```\n\n\nThis doesn't work, unfortunately:\n\n```\nError: sdh_store_wheel requires .  as only argument\n```\nCan we build numpy using other of Sage's helpers which accept arguments?\n\n> A cleaner solution and also a good solution for a branch might be to disable `-march=native` via\n> \n> ```\n> export CFLAGS=\"$CFLAGS_NON_NATIVE\"\n> ```\n\n\nI tried various options including\n\n```diff\ndiff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in\nindex 1237d059d3..88aee50f6a 100644\n--- a/build/pkgs/numpy/spkg-install.in\n+++ b/build/pkgs/numpy/spkg-install.in\n@@ -6,6 +6,9 @@ if [ `uname` = \"Darwin\" ]; then\n     unset ATLAS\n     unset BLAS\n     unset LAPACK\n+    export CFLAGS=\"$CFLAGS_NON_NATIVE\"\n+    export FCFLAGS=\"$FCFLAGS_NON_NATIVE\"\n+    export FFLAGS=\"$FFLAGS_NON_NATIVE\"\n else\n     export {ATLAS,PTATLAS,OPENBLAS,MKL,MKLROOT}=None\n     export LDFLAGS=\"${LDFLAGS} -shared\"\n```\nbut they didn't change the \"COMPILER OPTIMIZATION\" summaries when building `numpy` and they did not allow `scipy` to build.",
    "created_at": "2021-06-22T18:42:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637191",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:13'></a>Replying to [comment:11 gh-kliem]:
> Thanks for catching this. Actually you need to do it during a different command:
> 
> 
> ```diff
> diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in
> index 1237d059d3..c261d89444 100644
> --- a/build/pkgs/numpy/spkg-install.in
> +++ b/build/pkgs/numpy/spkg-install.in
> @@ -28,4 +28,4 @@ export NUMPY_FCONFIG="config_fc --noopt --noarch"
>  
>  sdh_setup_bdist_wheel ${NUMPY_FCONFIG}
>  
> -sdh_store_and_pip_install_wheel .
> +sdh_store_and_pip_install_wheel . --cpu-baseline="sse2"
> ```


This doesn't work, unfortunately:

```
Error: sdh_store_wheel requires .  as only argument
```
Can we build numpy using other of Sage's helpers which accept arguments?

> A cleaner solution and also a good solution for a branch might be to disable `-march=native` via
> 
> ```
> export CFLAGS="$CFLAGS_NON_NATIVE"
> ```


I tried various options including

```diff
diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in
index 1237d059d3..88aee50f6a 100644
--- a/build/pkgs/numpy/spkg-install.in
+++ b/build/pkgs/numpy/spkg-install.in
@@ -6,6 +6,9 @@ if [ `uname` = "Darwin" ]; then
     unset ATLAS
     unset BLAS
     unset LAPACK
+    export CFLAGS="$CFLAGS_NON_NATIVE"
+    export FCFLAGS="$FCFLAGS_NON_NATIVE"
+    export FFLAGS="$FFLAGS_NON_NATIVE"
 else
     export {ATLAS,PTATLAS,OPENBLAS,MKL,MKLROOT}=None
     export LDFLAGS="${LDFLAGS} -shared"
```
but they didn't change the "COMPILER OPTIMIZATION" summaries when building `numpy` and they did not allow `scipy` to build.



---

archive/issue_comments_637192.json:
```json
{
    "body": "<a id='comment:14'></a>You are exactly right. The previous place was the correct place to use it.\n\n```\nexport NUMPY_FCONFIG=\"config_fc --noopt --noarch --cpu-baseline=\\\"sse2\\\"\"\n```\n\nHowever:\n\n> The command arguments are available in build, build_clib, and build_ext. if build_clib or build_ext are not specified by the user, the arguments of build will be used instead, which also holds the default values.\n\n\nSo this does not work for `bdist_wheel` and this is what we use. Apparently, when build with wheel it just gets optimized regardless?",
    "created_at": "2021-06-22T19:52:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637192",
    "user": "https://github.com/kliem"
}
```

<a id='comment:14'></a>You are exactly right. The previous place was the correct place to use it.

```
export NUMPY_FCONFIG="config_fc --noopt --noarch --cpu-baseline=\"sse2\""
```

However:

> The command arguments are available in build, build_clib, and build_ext. if build_clib or build_ext are not specified by the user, the arguments of build will be used instead, which also holds the default values.


So this does not work for `bdist_wheel` and this is what we use. Apparently, when build with wheel it just gets optimized regardless?



---

archive/issue_comments_637193.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:13 jhpalmieri]:\n> Replying to [comment:11 gh-kliem]:\n> > Thanks for catching this. Actually you need to do it during a different command:\n> > \n> > \n> > ```diff\n> > diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in\n> > index 1237d059d3..c261d89444 100644\n> > --- a/build/pkgs/numpy/spkg-install.in\n> > +++ b/build/pkgs/numpy/spkg-install.in\n> > @@ -28,4 +28,4 @@ export NUMPY_FCONFIG=\"config_fc --noopt --noarch\"\n> >  \n> >  sdh_setup_bdist_wheel ${NUMPY_FCONFIG}\n> >  \n> > -sdh_store_and_pip_install_wheel .\n> > +sdh_store_and_pip_install_wheel . --cpu-baseline=\"sse2\"\n> > ```\n\n> \n> This doesn't work, unfortunately:\n> \n> ```\n> Error: sdh_store_wheel requires .  as only argument\n> ```\n> Can we build numpy using other of Sage's helpers which accept arguments?\n> \n> > A cleaner solution and also a good solution for a branch might be to disable `-march=native` via\n> > \n> > ```\n> > export CFLAGS=\"$CFLAGS_NON_NATIVE\"\n> > ```\n\n> \n> I tried various options including\n> \n> ```\n> #!diff\n> diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in\n> index 1237d059d3..88aee50f6a 100644\n> --- a/build/pkgs/numpy/spkg-install.in\n> +++ b/build/pkgs/numpy/spkg-install.in\n> @@ -6,6 +6,9 @@ if [ `uname` = \"Darwin\" ]; then\n>      unset ATLAS\n>      unset BLAS\n>      unset LAPACK\n> +    export CFLAGS=\"$CFLAGS_NON_NATIVE\"\n> +    export FCFLAGS=\"$FCFLAGS_NON_NATIVE\"\n> +    export FFLAGS=\"$FFLAGS_NON_NATIVE\"\n>  else\n>      export {ATLAS,PTATLAS,OPENBLAS,MKL,MKLROOT}=None\n>      export LDFLAGS=\"${LDFLAGS} -shared\"\n> ```\n> but they didn't change the \"COMPILER OPTIMIZATION\" summaries when building `numpy` and they did not allow `scipy` to build.\n\n\nAs Matthias K\u00f6ppe pointed out you can do the following change:\n\n```diff\ndiff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in\nindex 1237d059d3..ef2a322ecb 100644\n--- a/build/pkgs/numpy/spkg-install.in\n+++ b/build/pkgs/numpy/spkg-install.in\n@@ -26,6 +26,6 @@ export NUMPY_FCONFIG=\"config_fc --noopt --noarch\"\n \n ################################################\n \n-sdh_setup_bdist_wheel ${NUMPY_FCONFIG}\n+sdh_setup_bdist_wheel build ${NUMPY_FCONFIG}\n \n sdh_store_and_pip_install_wheel .\n```\n\nOnce you have done this, you can add all the previous options (added to `NUMPY_FCONFIG`):\n- `cpu-baseline=min`,\n- `cpu-dispatch`\n- try again `export CFLAGS=CFLAGS_NON_NATIVE`.\n\nActually you can cancel the numpy built once it starts compiling to immediatly see the optimization options as in comment:5",
    "created_at": "2021-06-22T20:41:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637193",
    "user": "https://github.com/kliem"
}
```

<a id='comment:15'></a>Replying to [comment:13 jhpalmieri]:
> Replying to [comment:11 gh-kliem]:
> > Thanks for catching this. Actually you need to do it during a different command:
> > 
> > 
> > ```diff
> > diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in
> > index 1237d059d3..c261d89444 100644
> > --- a/build/pkgs/numpy/spkg-install.in
> > +++ b/build/pkgs/numpy/spkg-install.in
> > @@ -28,4 +28,4 @@ export NUMPY_FCONFIG="config_fc --noopt --noarch"
> >  
> >  sdh_setup_bdist_wheel ${NUMPY_FCONFIG}
> >  
> > -sdh_store_and_pip_install_wheel .
> > +sdh_store_and_pip_install_wheel . --cpu-baseline="sse2"
> > ```

> 
> This doesn't work, unfortunately:
> 
> ```
> Error: sdh_store_wheel requires .  as only argument
> ```
> Can we build numpy using other of Sage's helpers which accept arguments?
> 
> > A cleaner solution and also a good solution for a branch might be to disable `-march=native` via
> > 
> > ```
> > export CFLAGS="$CFLAGS_NON_NATIVE"
> > ```

> 
> I tried various options including
> 
> ```
> #!diff
> diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in
> index 1237d059d3..88aee50f6a 100644
> --- a/build/pkgs/numpy/spkg-install.in
> +++ b/build/pkgs/numpy/spkg-install.in
> @@ -6,6 +6,9 @@ if [ `uname` = "Darwin" ]; then
>      unset ATLAS
>      unset BLAS
>      unset LAPACK
> +    export CFLAGS="$CFLAGS_NON_NATIVE"
> +    export FCFLAGS="$FCFLAGS_NON_NATIVE"
> +    export FFLAGS="$FFLAGS_NON_NATIVE"
>  else
>      export {ATLAS,PTATLAS,OPENBLAS,MKL,MKLROOT}=None
>      export LDFLAGS="${LDFLAGS} -shared"
> ```
> but they didn't change the "COMPILER OPTIMIZATION" summaries when building `numpy` and they did not allow `scipy` to build.


As Matthias KÃ¶ppe pointed out you can do the following change:

```diff
diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in
index 1237d059d3..ef2a322ecb 100644
--- a/build/pkgs/numpy/spkg-install.in
+++ b/build/pkgs/numpy/spkg-install.in
@@ -26,6 +26,6 @@ export NUMPY_FCONFIG="config_fc --noopt --noarch"
 
 ################################################
 
-sdh_setup_bdist_wheel ${NUMPY_FCONFIG}
+sdh_setup_bdist_wheel build ${NUMPY_FCONFIG}
 
 sdh_store_and_pip_install_wheel .
```

Once you have done this, you can add all the previous options (added to `NUMPY_FCONFIG`):
- `cpu-baseline=min`,
- `cpu-dispatch`
- try again `export CFLAGS=CFLAGS_NON_NATIVE`.

Actually you can cancel the numpy built once it starts compiling to immediatly see the optimization options as in comment:5



---

archive/issue_comments_637194.json:
```json
{
    "body": "<a id='comment:16'></a>Sorry, I'm still not getting it. I made the change suggested in comment:15, adding \"build\" to the command. If I use\n\n```\nexport NUMPY_FCONFIG=\"config_fc --noopt --noarch --cpu-baseline=\\\"sse2\\\"\"\n```\nI still get \"error: option --cpu-baseline not recognized\". Same with `--cpu-dispatch` if it's at the end. If I instead use\n\n```\nexport NUMPY_FCONFIG=\"--cpu-baseline=\\\"sse2\\\" config_fc --noopt --noarch\"\n```\nthen numpy builds but with no apparent difference to the outcome, and scipy still fails. This happens whether or not I include `CFLAGS=\"$CFLAGS_NON_NATIVE\"`. Note that no matter what I try, the following appears several times in the log file:\n\n```\nCCompilerOpt.__init__[2103] : native flag is specified through environment variables. force cpu-baseline='native'\n```\nI don't know if that's relevant.",
    "created_at": "2021-06-22T22:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637194",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:16'></a>Sorry, I'm still not getting it. I made the change suggested in comment:15, adding "build" to the command. If I use

```
export NUMPY_FCONFIG="config_fc --noopt --noarch --cpu-baseline=\"sse2\""
```
I still get "error: option --cpu-baseline not recognized". Same with `--cpu-dispatch` if it's at the end. If I instead use

```
export NUMPY_FCONFIG="--cpu-baseline=\"sse2\" config_fc --noopt --noarch"
```
then numpy builds but with no apparent difference to the outcome, and scipy still fails. This happens whether or not I include `CFLAGS="$CFLAGS_NON_NATIVE"`. Note that no matter what I try, the following appears several times in the log file:

```
CCompilerOpt.__init__[2103] : native flag is specified through environment variables. force cpu-baseline='native'
```
I don't know if that's relevant.



---

archive/issue_comments_637195.json:
```json
{
    "body": "<a id='comment:17'></a>This worked for me, until we find something better:\n\n```diff\ndiff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in\nindex 1237d059d3..50aa1529b3 100644\n--- a/build/pkgs/numpy/spkg-install.in\n+++ b/build/pkgs/numpy/spkg-install.in\n@@ -22,6 +22,8 @@ python3 ../lapack_conf.py\n export FFLAGS=\"$FFLAGS -fPIC\"\n export FCFLAGS=\"$FCFLAGS -fPIC\"\n \n+export CFLAGS=\" -march=skylake\"\n+\n export NUMPY_FCONFIG=\"config_fc --noopt --noarch\"\n \n ################################################\n```",
    "created_at": "2021-06-23T02:02:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637195",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:17'></a>This worked for me, until we find something better:

```diff
diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in
index 1237d059d3..50aa1529b3 100644
--- a/build/pkgs/numpy/spkg-install.in
+++ b/build/pkgs/numpy/spkg-install.in
@@ -22,6 +22,8 @@ python3 ../lapack_conf.py
 export FFLAGS="$FFLAGS -fPIC"
 export FCFLAGS="$FCFLAGS -fPIC"
 
+export CFLAGS=" -march=skylake"
+
 export NUMPY_FCONFIG="config_fc --noopt --noarch"
 
 ################################################
```



---

archive/issue_comments_637196.json:
```json
{
    "body": "<a id='comment:18'></a>https://github.com/numpy/numpy/issues/19067",
    "created_at": "2021-06-23T07:44:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637196",
    "user": "https://github.com/sheerluck"
}
```

<a id='comment:18'></a>https://github.com/numpy/numpy/issues/19067



---

archive/issue_comments_637197.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:18 gh-sheerluck]:\n> https://github.com/numpy/numpy/issues/19067\n\n\ngood catch!\n\nJohn, does the patch from there, \nhttps://patch-diff.githubusercontent.com/raw/numpy/numpy/pull/19074.diff\nfix your issue?",
    "created_at": "2021-06-23T08:03:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637197",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:19'></a>Replying to [comment:18 gh-sheerluck]:
> https://github.com/numpy/numpy/issues/19067


good catch!

John, does the patch from there, 
https://patch-diff.githubusercontent.com/raw/numpy/numpy/pull/19074.diff
fix your issue?



---

archive/issue_comments_637198.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:19 dimpase]:\n> Replying to [comment:18 gh-sheerluck]:\n> > https://github.com/numpy/numpy/issues/19067\n\n> \n> good catch!\n> \n> John, does the patch from there, \n> https://patch-diff.githubusercontent.com/raw/numpy/numpy/pull/19074.diff\n> fix your issue?\n\n\nUnfortunately not. I see the same summary as in comment:5, and `scipy` fails to build.",
    "created_at": "2021-06-23T18:12:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637198",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:20'></a>Replying to [comment:19 dimpase]:
> Replying to [comment:18 gh-sheerluck]:
> > https://github.com/numpy/numpy/issues/19067

> 
> good catch!
> 
> John, does the patch from there, 
> https://patch-diff.githubusercontent.com/raw/numpy/numpy/pull/19074.diff
> fix your issue?


Unfortunately not. I see the same summary as in comment:5, and `scipy` fails to build.



---

archive/issue_comments_637199.json:
```json
{
    "body": "<a id='comment:21'></a>By the way, where is `CFLAGS_NON_NATIVE` set? If I put `echo $CFLAGS` and `echo $CFLAGS_NON_NATIVE` in `spkg-install.in`, they both print the same thing:\n\n```\n-O2 -g -march=native\n```\nI'm not sure what \"NON_NATIVE\" means, but is it odd that it includes `-march=native`? If I explicitly do `export CFLAGS=\"-O2 -g\"`, then `scipy` builds.",
    "created_at": "2021-06-23T18:20:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637199",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:21'></a>By the way, where is `CFLAGS_NON_NATIVE` set? If I put `echo $CFLAGS` and `echo $CFLAGS_NON_NATIVE` in `spkg-install.in`, they both print the same thing:

```
-O2 -g -march=native
```
I'm not sure what "NON_NATIVE" means, but is it odd that it includes `-march=native`? If I explicitly do `export CFLAGS="-O2 -g"`, then `scipy` builds.



---

archive/issue_comments_637200.json:
```json
{
    "body": "<a id='comment:22'></a>Do you have default `CFLAGS`? User settings take precedence over those. `CFLAGS_NON_NATIVE` means we don't add `-march=native`. That's what I figured is going on by the way.\n\nIf you don't have `CFLAGS` set by default than this is a bug.",
    "created_at": "2021-06-23T18:34:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637200",
    "user": "https://github.com/kliem"
}
```

<a id='comment:22'></a>Do you have default `CFLAGS`? User settings take precedence over those. `CFLAGS_NON_NATIVE` means we don't add `-march=native`. That's what I figured is going on by the way.

If you don't have `CFLAGS` set by default than this is a bug.



---

archive/issue_comments_637201.json:
```json
{
    "body": "<a id='comment:23'></a>The configured flags are in `sage/build/bin/sage-build-env-config`.\n\nIn `sage/build/bin/sage/sage-build-env` we set the flags.\nPriorities are in this order:\n1. Whatever is currently set.\n2. During configuration.\n3. Sage's default.\n\n`CFLAGS_NON_NATIVE` only is meaningful for the third one. Otherwise you choice will be set everywhere regardless (some packages might add something).",
    "created_at": "2021-06-23T18:40:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637201",
    "user": "https://github.com/kliem"
}
```

<a id='comment:23'></a>The configured flags are in `sage/build/bin/sage-build-env-config`.

In `sage/build/bin/sage/sage-build-env` we set the flags.
Priorities are in this order:
1. Whatever is currently set.
2. During configuration.
3. Sage's default.

`CFLAGS_NON_NATIVE` only is meaningful for the third one. Otherwise you choice will be set everywhere regardless (some packages might add something).



---

archive/issue_comments_637202.json:
```json
{
    "body": "<a id='comment:24'></a>I inserted more `echo` commands. `echo $CFLAGS_NON_NATIVE` returns `-O2 -g` when I print in `sage-spkg`, but it returns `-O2 -g -march=native` when this echo command is the first thing in numpy's `spkg-install.in` script. That is, my numpy log file looks like:\n\n```\n...\nPackage 'numpy' is currently not installed\nUninstalling 'numpy' with legacy uninstaller\n!!!!!!!!!!!!!!!!\nPRINTED BY sage-spkg\ncflags: -O2 -g -march=native\nnon-native: -O2 -g\n!!!!!!!!!!!!!!!!\n!!!!!!!!!!!!!!!!\nPRINTED BY NUMPY's spkg-install.in\ncflags: -O2 -g -march=native\nnon-native: -O2 -g -march=native\n!!!!!!!!!!!!!!!!\n...\n```\nAfter the installation is complete, one more echo command in `sage-spkg` returns `-O2 -g` again.\n\n---\n\nThe problem seems to be that we (in the full script `spkg-install`, created from `spkg-install.in`) also run the script `build/bin/sage-build-env`, and the line\n\n```\n    export CFLAGS_NON_NATIVE=\"$ORIGINAL_CFLAGS\"\n```\nproduces the wrong answer.",
    "created_at": "2021-06-23T20:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637202",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:24'></a>I inserted more `echo` commands. `echo $CFLAGS_NON_NATIVE` returns `-O2 -g` when I print in `sage-spkg`, but it returns `-O2 -g -march=native` when this echo command is the first thing in numpy's `spkg-install.in` script. That is, my numpy log file looks like:

```
...
Package 'numpy' is currently not installed
Uninstalling 'numpy' with legacy uninstaller
!!!!!!!!!!!!!!!!
PRINTED BY sage-spkg
cflags: -O2 -g -march=native
non-native: -O2 -g
!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!
PRINTED BY NUMPY's spkg-install.in
cflags: -O2 -g -march=native
non-native: -O2 -g -march=native
!!!!!!!!!!!!!!!!
...
```
After the installation is complete, one more echo command in `sage-spkg` returns `-O2 -g` again.

---

The problem seems to be that we (in the full script `spkg-install`, created from `spkg-install.in`) also run the script `build/bin/sage-build-env`, and the line

```
    export CFLAGS_NON_NATIVE="$ORIGINAL_CFLAGS"
```
produces the wrong answer.



---

archive/issue_comments_637203.json:
```json
{
    "body": "<a id='comment:25'></a>One question would be, since `sage-spkg` already has the lines\n\n```\n. sage-build-env-config\n. sage-build-env\n```\nwhy does it also need to write this into `spkg-install`:\n\n```\nfor lib in \"\\$SAGE_ROOT/build/bin/sage-dist-helpers\" \"\\$SAGE_SRC/bin/sage-env-config\" \"\\$SAGE_SRC/bin/sage-env\" \"\\$SAGE_ROOT/build/bin/sage-build-env-config\" \"\\$SAGE_ROOT/build/bin/sage-build-env\"; do\n    source \"\\$lib\"\n    if [ \\$? -ne 0 ]; then\n        echo >&2 \"Error: failed to source \\$lib\"\n        echo >&2 \"Is \\$SAGE_ROOT the correct SAGE_ROOT?\"\n        exit 1\n    fi\ndone\n```\nShould we omit `sage-build-env-config` and `sage-build-env` from this list?",
    "created_at": "2021-06-23T20:44:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637203",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:25'></a>One question would be, since `sage-spkg` already has the lines

```
. sage-build-env-config
. sage-build-env
```
why does it also need to write this into `spkg-install`:

```
for lib in "\$SAGE_ROOT/build/bin/sage-dist-helpers" "\$SAGE_SRC/bin/sage-env-config" "\$SAGE_SRC/bin/sage-env" "\$SAGE_ROOT/build/bin/sage-build-env-config" "\$SAGE_ROOT/build/bin/sage-build-env"; do
    source "\$lib"
    if [ \$? -ne 0 ]; then
        echo >&2 "Error: failed to source \$lib"
        echo >&2 "Is \$SAGE_ROOT the correct SAGE_ROOT?"
        exit 1
    fi
done
```
Should we omit `sage-build-env-config` and `sage-build-env` from this list?



---

archive/issue_comments_637204.json:
```json
{
    "body": "<a id='comment:26'></a>I think the idea is that these wrapped scripts can also be executed manually",
    "created_at": "2021-06-23T21:13:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637204",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:26'></a>I think the idea is that these wrapped scripts can also be executed manually



---

archive/issue_comments_637205.json:
```json
{
    "body": "<a id='comment:27'></a>Sage builds on this machine with these changes:\n\n```diff\ndiff --git a/build/bin/sage-spkg b/build/bin/sage-spkg\nindex c92f315f36..561e8f5cce 100755\n--- a/build/bin/sage-spkg\n+++ b/build/bin/sage-spkg\n@@ -525,7 +525,7 @@ export PKG_NAME=\"$PKG_NAME\"\n export PKG_BASE=\"$PKG_BASE\"\n export PKG_VER=\"$PKG_VER\"\n \n-for lib in \"\\$SAGE_ROOT/build/bin/sage-dist-helpers\" \"\\$SAGE_SRC/bin/sage-env-config\" \"\\$SAGE_SRC/bin/sage-env\" \"\\$SAGE_ROOT/build/bin/sage-build-env-config\" \"\\$SAGE_ROOT/build/bin/sage-build-env\"; do\n+for lib in \"\\$SAGE_ROOT/build/bin/sage-dist-helpers\" \"\\$SAGE_SRC/bin/sage-env-config\" \"\\$SAGE_SRC/bin/sage-env\"; do\n     source \"\\$lib\"\n     if [ \\$? -ne 0 ]; then\n         echo >&2 \"Error: failed to source \\$lib\"\ndiff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in\nindex 1237d059d3..0eb81094db 100644\n--- a/build/pkgs/numpy/spkg-install.in\n+++ b/build/pkgs/numpy/spkg-install.in\n@@ -22,6 +22,8 @@ python3 ../lapack_conf.py\n export FFLAGS=\"$FFLAGS -fPIC\"\n export FCFLAGS=\"$FCFLAGS -fPIC\"\n \n+export CFLAGS=\"$CFLAGS_NON_NATIVE\"\n+\n export NUMPY_FCONFIG=\"config_fc --noopt --noarch\"\n \n ################################################\n```",
    "created_at": "2021-06-23T21:16:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637205",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:27'></a>Sage builds on this machine with these changes:

```diff
diff --git a/build/bin/sage-spkg b/build/bin/sage-spkg
index c92f315f36..561e8f5cce 100755
--- a/build/bin/sage-spkg
+++ b/build/bin/sage-spkg
@@ -525,7 +525,7 @@ export PKG_NAME="$PKG_NAME"
 export PKG_BASE="$PKG_BASE"
 export PKG_VER="$PKG_VER"
 
-for lib in "\$SAGE_ROOT/build/bin/sage-dist-helpers" "\$SAGE_SRC/bin/sage-env-config" "\$SAGE_SRC/bin/sage-env" "\$SAGE_ROOT/build/bin/sage-build-env-config" "\$SAGE_ROOT/build/bin/sage-build-env"; do
+for lib in "\$SAGE_ROOT/build/bin/sage-dist-helpers" "\$SAGE_SRC/bin/sage-env-config" "\$SAGE_SRC/bin/sage-env"; do
     source "\$lib"
     if [ \$? -ne 0 ]; then
         echo >&2 "Error: failed to source \$lib"
diff --git a/build/pkgs/numpy/spkg-install.in b/build/pkgs/numpy/spkg-install.in
index 1237d059d3..0eb81094db 100644
--- a/build/pkgs/numpy/spkg-install.in
+++ b/build/pkgs/numpy/spkg-install.in
@@ -22,6 +22,8 @@ python3 ../lapack_conf.py
 export FFLAGS="$FFLAGS -fPIC"
 export FCFLAGS="$FCFLAGS -fPIC"
 
+export CFLAGS="$CFLAGS_NON_NATIVE"
+
 export NUMPY_FCONFIG="config_fc --noopt --noarch"
 
 ################################################
```



---

archive/issue_comments_637206.json:
```json
{
    "body": "<a id='comment:28'></a>Replying to [comment:26 mkoeppe]:\n> I think the idea is that these wrapped scripts can also be executed manually\n\n\nI guess they should be written so that they're idempotent.",
    "created_at": "2021-06-23T21:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637206",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:28'></a>Replying to [comment:26 mkoeppe]:
> I think the idea is that these wrapped scripts can also be executed manually


I guess they should be written so that they're idempotent.



---

archive/issue_comments_637207.json:
```json
{
    "body": "<a id='comment:29'></a>Yes, that is what I was about to suggest.",
    "created_at": "2021-06-23T21:17:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637207",
    "user": "https://github.com/kliem"
}
```

<a id='comment:29'></a>Yes, that is what I was about to suggest.



---

archive/issue_comments_637208.json:
```json
{
    "body": "<a id='comment:30'></a>This may be a good occasion to move all `if`'s from `sage-build-env-config` to `sage-build-env`.",
    "created_at": "2021-06-23T21:25:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637208",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'></a>This may be a good occasion to move all `if`'s from `sage-build-env-config` to `sage-build-env`.



---

archive/issue_comments_637209.json:
```json
{
    "body": "<a id='comment:31'></a>I fear that I may have derailed the ticket from its original purpose. The patch in comment:19 looks quite relevant to that so maybe we should include it, even though it doesn't fix the problem on my machine. Separate ticket for changes to `sage-build-env` and `sage-build-env-config`?",
    "created_at": "2021-06-23T21:39:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637209",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:31'></a>I fear that I may have derailed the ticket from its original purpose. The patch in comment:19 looks quite relevant to that so maybe we should include it, even though it doesn't fix the problem on my machine. Separate ticket for changes to `sage-build-env` and `sage-build-env-config`?



---

archive/issue_comments_637210.json:
```json
{
    "body": "Changing author from \"\" to \"Jonathan Kliem\"",
    "created_at": "2021-06-23T21:45:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637210",
    "user": "https://github.com/kliem"
}
```

Changing author from "" to "Jonathan Kliem"



---

archive/issue_comments_637211.json:
```json
{
    "body": "Changing commit from \"\" to \"b3e2a534bd6f4d3d164b0bf8ad0ab33b64cd282f\"",
    "created_at": "2021-06-23T21:45:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637211",
    "user": "https://github.com/kliem"
}
```

Changing commit from "" to "b3e2a534bd6f4d3d164b0bf8ad0ab33b64cd282f"



---

archive/issue_comments_637212.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2021-06-23T21:45:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637212",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_637213.json:
```json
{
    "body": "Changing branch from \"\" to \"public/32021\"",
    "created_at": "2021-06-23T21:45:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637213",
    "user": "https://github.com/kliem"
}
```

Changing branch from "" to "public/32021"



---

archive/issue_comments_637214.json:
```json
{
    "body": "<a id='comment:32'></a>Feel free to add yourself as the author. I don't know at this point, who really is the author here.\n\n---\nNew commits:",
    "created_at": "2021-06-23T21:45:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637214",
    "user": "https://github.com/kliem"
}
```

<a id='comment:32'></a>Feel free to add yourself as the author. I don't know at this point, who really is the author here.

---
New commits:



---

archive/issue_comments_637215.json:
```json
{
    "body": "<a id='comment:33'></a>By the way, I don't know if `numpy` is right or if `scipy` is right about my machine: maybe `scipy` is wrong when it says that `AVX512F` is not supported? How to know for sure?",
    "created_at": "2021-06-23T21:46:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637215",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:33'></a>By the way, I don't know if `numpy` is right or if `scipy` is right about my machine: maybe `scipy` is wrong when it says that `AVX512F` is not supported? How to know for sure?



---

archive/issue_comments_637216.json:
```json
{
    "body": "<a id='comment:34'></a>`lscpu` or `echo | gcc -dM -E - -march=native`.",
    "created_at": "2021-06-23T21:48:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637216",
    "user": "https://github.com/kliem"
}
```

<a id='comment:34'></a>`lscpu` or `echo | gcc -dM -E - -march=native`.



---

archive/issue_comments_637217.json:
```json
{
    "body": "Changing commit from \"b3e2a534bd6f4d3d164b0bf8ad0ab33b64cd282f\" to \"9c87b6571ec5bb9a4dce5f2761906b0110e2709a\"",
    "created_at": "2021-06-23T21:51:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637217",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "b3e2a534bd6f4d3d164b0bf8ad0ab33b64cd282f" to "9c87b6571ec5bb9a4dce5f2761906b0110e2709a"



---

archive/issue_comments_637218.json:
```json
{
    "body": "<a id='comment:35'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-23T21:51:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637218",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:35'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_637219.json:
```json
{
    "body": "<a id='comment:36'></a>If I run `echo | gcc -dM -E - -march=native`, it prints many things including\n\n```\n#define __AVX512F__ 1\n```\nOS X doesn't include `lscpu`, but if I run `sysctl -a | grep machdep.cpu`, it tells me\n\n```\nmachdep.cpu.leaf7_features: RDWRFSGS TSC_THREAD_OFFSET BMI1 HLE AVX2 FDPEO SMEP BMI2 ERMS INVPCID RTM PQM FPU_CSDS MPX PQE AVX512F AVX512DQ RDSEED ADX SMAP CLFSOPT CLWB IPT AVX512CD AVX512BW AVX512VL MDCLEAR TSXFA IBRS STIBP L1DF SSBD\n```\nDoes this mean that `AVX512F` is a feature, so `scipy` is wrong?",
    "created_at": "2021-06-23T21:55:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637219",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:36'></a>If I run `echo | gcc -dM -E - -march=native`, it prints many things including

```
#define __AVX512F__ 1
```
OS X doesn't include `lscpu`, but if I run `sysctl -a | grep machdep.cpu`, it tells me

```
machdep.cpu.leaf7_features: RDWRFSGS TSC_THREAD_OFFSET BMI1 HLE AVX2 FDPEO SMEP BMI2 ERMS INVPCID RTM PQM FPU_CSDS MPX PQE AVX512F AVX512DQ RDSEED ADX SMAP CLFSOPT CLWB IPT AVX512CD AVX512BW AVX512VL MDCLEAR TSXFA IBRS STIBP L1DF SSBD
```
Does this mean that `AVX512F` is a feature, so `scipy` is wrong?



---

archive/issue_comments_637220.json:
```json
{
    "body": "<a id='comment:37'></a>That does look like scipy is wrong.",
    "created_at": "2021-06-23T21:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637220",
    "user": "https://github.com/kliem"
}
```

<a id='comment:37'></a>That does look like scipy is wrong.



---

archive/issue_comments_637221.json:
```json
{
    "body": "<a id='comment:38'></a>The error arises when doing `import numpy` in Python, which `scipy` must try to do early in its build process. So it's not really `scipy`, it's within `numpy`. I don't know how to track this down.",
    "created_at": "2021-06-23T22:07:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637221",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:38'></a>The error arises when doing `import numpy` in Python, which `scipy` must try to do early in its build process. So it's not really `scipy`, it's within `numpy`. I don't know how to track this down.



---

archive/issue_comments_637222.json:
```json
{
    "body": "<a id='comment:39'></a>It happens here:\n\nhttps://github.com/numpy/numpy/blob/623bc1fae1d47df24e7f1e29321d0c0ba2771ce0/numpy/core/src/common/npy_cpu_features.c.src\n\nAround line 160. For some reason this check does not work for AVX512F in your case. So yes, this is a numpy bug.",
    "created_at": "2021-06-23T22:09:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637222",
    "user": "https://github.com/kliem"
}
```

<a id='comment:39'></a>It happens here:

https://github.com/numpy/numpy/blob/623bc1fae1d47df24e7f1e29321d0c0ba2771ce0/numpy/core/src/common/npy_cpu_features.c.src

Around line 160. For some reason this check does not work for AVX512F in your case. So yes, this is a numpy bug.



---

archive/issue_comments_637223.json:
```json
{
    "body": "<a id='comment:40'></a>I opened https://github.com/numpy/numpy/issues/19319.",
    "created_at": "2021-06-23T22:47:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637223",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:40'></a>I opened https://github.com/numpy/numpy/issues/19319.



---

archive/issue_comments_637224.json:
```json
{
    "body": "<a id='comment:41'></a>With this patch, I'm able to compile on a Intel MacBook Air with macOS 10.15.7. I will run doctests asap.",
    "created_at": "2021-06-24T07:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637224",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:41'></a>With this patch, I'm able to compile on a Intel MacBook Air with macOS 10.15.7. I will run doctests asap.



---

archive/issue_comments_637225.json:
```json
{
    "body": "<a id='comment:42'></a>Works for me, too, and doctests pass as well.",
    "created_at": "2021-06-24T17:17:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637225",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:42'></a>Works for me, too, and doctests pass as well.



---

archive/issue_comments_637226.json:
```json
{
    "body": "<a id='comment:43'></a>I would like someone with more familiarity with the build scripts to look over those changes. Also, there is now a NumPy bugfix for my particular problem: https://github.com/numpy/numpy/pull/19362. I think that it is safest to use `export CFLAGS=\"$CFLAGS_NON_NATIVE\"` for now when building NumPy and not worry about using this patch, but at some point we should investigate whether they've fixed all of the relevant problems.",
    "created_at": "2021-06-28T18:58:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637226",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:43'></a>I would like someone with more familiarity with the build scripts to look over those changes. Also, there is now a NumPy bugfix for my particular problem: https://github.com/numpy/numpy/pull/19362. I think that it is safest to use `export CFLAGS="$CFLAGS_NON_NATIVE"` for now when building NumPy and not worry about using this patch, but at some point we should investigate whether they've fixed all of the relevant problems.



---

archive/issue_comments_637227.json:
```json
{
    "body": "<a id='comment:44'></a>This PR has been backported to 1.21.x as https://github.com/numpy/numpy/pull/19365, but there is no indication whether it will also be backported to 1.20.x. Have you tried whether the patch applies?",
    "created_at": "2021-06-28T19:07:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637227",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:44'></a>This PR has been backported to 1.21.x as https://github.com/numpy/numpy/pull/19365, but there is no indication whether it will also be backported to 1.20.x. Have you tried whether the patch applies?



---

archive/issue_comments_637228.json:
```json
{
    "body": "<a id='comment:45'></a>`src/bin/sage-env-config.in` uses `SAGE_ENV_CONFIG_SOURCED` and `src/bin/sage-env` uses `SAGE_ENV_SOURCED`, so probably `SAGE_HAS_RUN_SAGE_BUILD_ENV` should be renamed to follow the same pattern.\n\nOtherwise the changes to `sage-build-env`, `sage-build-env-config.in` look good to me. Thanks for simplifying the latter!\n\nI would probably prefer to use the upstream fix, if easily possible, rather than the workaround with weaker CFLAGS.",
    "created_at": "2021-06-28T19:17:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637228",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:45'></a>`src/bin/sage-env-config.in` uses `SAGE_ENV_CONFIG_SOURCED` and `src/bin/sage-env` uses `SAGE_ENV_SOURCED`, so probably `SAGE_HAS_RUN_SAGE_BUILD_ENV` should be renamed to follow the same pattern.

Otherwise the changes to `sage-build-env`, `sage-build-env-config.in` look good to me. Thanks for simplifying the latter!

I would probably prefer to use the upstream fix, if easily possible, rather than the workaround with weaker CFLAGS.



---

archive/issue_comments_637229.json:
```json
{
    "body": "<a id='comment:46'></a>The upstream fix will work for me (if it applies to 1.20.3 \u2014\u00a0I haven't tested yet), but I don't know if it will work for the issue cited in the ticket description.",
    "created_at": "2021-06-28T19:48:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637229",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:46'></a>The upstream fix will work for me (if it applies to 1.20.3 âÂ I haven't tested yet), but I don't know if it will work for the issue cited in the ticket description.



---

archive/issue_comments_637230.json:
```json
{
    "body": "<a id='comment:47'></a>The patch from comment:18 might work for this. As we have a working branch, the reasonable thing would be to open another ticket that tries to apply both patches to fix the problem?",
    "created_at": "2021-06-28T20:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637230",
    "user": "https://github.com/kliem"
}
```

<a id='comment:47'></a>The patch from comment:18 might work for this. As we have a working branch, the reasonable thing would be to open another ticket that tries to apply both patches to fix the problem?



---

archive/issue_comments_637231.json:
```json
{
    "body": "<a id='comment:48'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-28T20:54:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637231",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:48'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_637232.json:
```json
{
    "body": "Changing commit from \"9c87b6571ec5bb9a4dce5f2761906b0110e2709a\" to \"56ffafb6af3cba4d7d203962ffa772fc9366f9c1\"",
    "created_at": "2021-06-28T20:54:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637232",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "9c87b6571ec5bb9a4dce5f2761906b0110e2709a" to "56ffafb6af3cba4d7d203962ffa772fc9366f9c1"



---

archive/issue_comments_637233.json:
```json
{
    "body": "<a id='comment:49'></a>The upstream patch applies and Sage builds with it. I like the idea of opening another ticket with the two patches and also attempting to remove `export CFLAGS=\"$CFLAGS_NON_NATIVE\"`.",
    "created_at": "2021-06-28T21:32:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637233",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:49'></a>The upstream patch applies and Sage builds with it. I like the idea of opening another ticket with the two patches and also attempting to remove `export CFLAGS="$CFLAGS_NON_NATIVE"`.



---

archive/issue_comments_637234.json:
```json
{
    "body": "<a id='comment:50'></a>Replying to [comment:49 jhpalmieri]:\n> The upstream patch applies and Sage builds with it. I like the idea of opening another ticket with the two patches and also attempting to remove `export CFLAGS=\"$CFLAGS_NON_NATIVE\"`.\n\n\nSee #32080.",
    "created_at": "2021-06-29T00:06:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637234",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:50'></a>Replying to [comment:49 jhpalmieri]:
> The upstream patch applies and Sage builds with it. I like the idea of opening another ticket with the two patches and also attempting to remove `export CFLAGS="$CFLAGS_NON_NATIVE"`.


See #32080.



---

archive/issue_comments_637235.json:
```json
{
    "body": "Changing commit from \"56ffafb6af3cba4d7d203962ffa772fc9366f9c1\" to \"a7eef1b2357cd3862facf64edb81abdafbda6923\"",
    "created_at": "2021-07-06T18:21:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637235",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "56ffafb6af3cba4d7d203962ffa772fc9366f9c1" to "a7eef1b2357cd3862facf64edb81abdafbda6923"



---

archive/issue_comments_637236.json:
```json
{
    "body": "<a id='comment:51'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-06T18:21:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637236",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:51'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_637237.json:
```json
{
    "body": "<a id='comment:52'></a>I've pushed a fix for the Cygwin CI script (see #32080).",
    "created_at": "2021-07-06T18:21:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637237",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:52'></a>I've pushed a fix for the Cygwin CI script (see #32080).



---

archive/issue_comments_637238.json:
```json
{
    "body": "Changing reviewer from \"\" to \"https://github.com/mkoeppe/sage/actions/runs/1005406512\"",
    "created_at": "2021-07-06T18:22:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637238",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "https://github.com/mkoeppe/sage/actions/runs/1005406512"



---

archive/issue_comments_637239.json:
```json
{
    "body": "<a id='comment:54'></a>It's all fine with me. I am willing to trust Matthias' bot for the Cygwin stuff, but I would be happier if someone else could verify the problem and solution. I've taken a look at the changes to `sage-build-env` and `sage-build-env-config.in` and they make sense, but again, I would like more people to look at it.\n\nGiven those caveats, positive review from me.",
    "created_at": "2021-07-07T18:46:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637239",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:54'></a>It's all fine with me. I am willing to trust Matthias' bot for the Cygwin stuff, but I would be happier if someone else could verify the problem and solution. I've taken a look at the changes to `sage-build-env` and `sage-build-env-config.in` and they make sense, but again, I would like more people to look at it.

Given those caveats, positive review from me.



---

archive/issue_comments_637240.json:
```json
{
    "body": "Changing reviewer from \"https://github.com/mkoeppe/sage/actions/runs/1005406512\" to \"John Palmieri, https://github.com/mkoeppe/sage/actions/runs/1005406512, ...\"",
    "created_at": "2021-07-07T18:46:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637240",
    "user": "https://github.com/jhpalmieri"
}
```

Changing reviewer from "https://github.com/mkoeppe/sage/actions/runs/1005406512" to "John Palmieri, https://github.com/mkoeppe/sage/actions/runs/1005406512, ..."



---

archive/issue_comments_637241.json:
```json
{
    "body": "<a id='comment:55'></a>probably this should be tested with a pynac fix for Cygwin - otherwise there are errors installing pynac.",
    "created_at": "2021-07-07T19:33:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637241",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:55'></a>probably this should be tested with a pynac fix for Cygwin - otherwise there are errors installing pynac.



---

archive/issue_comments_637242.json:
```json
{
    "body": "<a id='comment:56'></a>Looks good enough for me on Cygwin. The pynac problem is unrelated.\n\nLet's get this in.",
    "created_at": "2021-07-07T20:01:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637242",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:56'></a>Looks good enough for me on Cygwin. The pynac problem is unrelated.

Let's get this in.



---

archive/issue_comments_637243.json:
```json
{
    "body": "Changing reviewer from \"John Palmieri, https://github.com/mkoeppe/sage/actions/runs/1005406512, ...\" to \"John Palmieri, Matthias Koeppe\"",
    "created_at": "2021-07-07T20:01:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637243",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "John Palmieri, https://github.com/mkoeppe/sage/actions/runs/1005406512, ..." to "John Palmieri, Matthias Koeppe"



---

archive/issue_comments_637244.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-07T20:01:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637244",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_637245.json:
```json
{
    "body": "Changing branch from \"public/32021\" to \"a7eef1b2357cd3862facf64edb81abdafbda6923\"",
    "created_at": "2021-07-18T22:53:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637245",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/32021" to "a7eef1b2357cd3862facf64edb81abdafbda6923"



---

archive/issue_comments_637246.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-18T22:53:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32021#issuecomment-637246",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_084707.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-07-18T22:53:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32021",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32021#event-84707"
}
```
