# Issue 32485: Extend substitute_function syntax

archive/issues_032248.json:
```json
{
    "body": "This ticket extends the syntax of `substitute_function` so that it is consistent with the syntax for the ordinary `substitute` method. This allows for substituting multiple functions,\n\n```\nsage: f,g,h = function('f g h')\nsage: x,y = var('x y')\nsage: (f(x) + g(y)).substitute_function({f: h, g: h})\nh(x) + h(y)\n```\n\nexchanging two functions directly without having to do a three-way swap,\n\n```\nsage: (f(x) + g(y)).substitute_function({f: g, g: f})\nf(y) + g(x)\n```\n\nand substituting a concrete expression for symbolic functions with a more direct syntax than before,\n\n```\nsage: expr = (diff(f(x),x))\nsage: expr.substitute_function(f(x) == y*x^2)\n2*x*y\n```\n\n(previously, one needed to introduce a new function to do this\n\n```\nsage: f2(x) = y*x^2\nsage: expr.substitute_function(f,f2)\n2*x*y\n```\n)\n\nThere are still two issues with the implementation at the moment, for which I'd like to get feedback:\n\n1. Should we deprecate the old syntax `substitute_function(f,g)`? This would be more consistent with `substitute`, but would probably lead to a lot of warnings for users.\n2. Finding functions by name and checking whether some object is a function is a bit tricky in sagemath. Currently, the functions doing that are imported from `sage.calculus.calculus`, but it might make sense to factor them out there and put them in a more suitable place.\n\nCC:  @orlitzky @EmmanuelCharpentier\n\nBranch/Commit: [ace72a041d4de4a6708c7f45d8c0ce652290d0c5](https://github.com/sagemath/sagetrac-mirror/commit/ace72a041d4de4a6708c7f45d8c0ce652290d0c5)\n\nReviewer: Matthias Koeppe\n\nAuthor: Marius Gerbershagen\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32485\n\n",
    "closed_at": "2021-09-19T09:58:20Z",
    "created_at": "2021-09-07T17:22:32Z",
    "labels": [
        "component: symbolics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Extend substitute_function syntax",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32485",
    "user": "https://github.com/spaghettisalat"
}
```
This ticket extends the syntax of `substitute_function` so that it is consistent with the syntax for the ordinary `substitute` method. This allows for substituting multiple functions,

```
sage: f,g,h = function('f g h')
sage: x,y = var('x y')
sage: (f(x) + g(y)).substitute_function({f: h, g: h})
h(x) + h(y)
```

exchanging two functions directly without having to do a three-way swap,

```
sage: (f(x) + g(y)).substitute_function({f: g, g: f})
f(y) + g(x)
```

and substituting a concrete expression for symbolic functions with a more direct syntax than before,

```
sage: expr = (diff(f(x),x))
sage: expr.substitute_function(f(x) == y*x^2)
2*x*y
```

(previously, one needed to introduce a new function to do this

```
sage: f2(x) = y*x^2
sage: expr.substitute_function(f,f2)
2*x*y
```
)

There are still two issues with the implementation at the moment, for which I'd like to get feedback:

1. Should we deprecate the old syntax `substitute_function(f,g)`? This would be more consistent with `substitute`, but would probably lead to a lot of warnings for users.
2. Finding functions by name and checking whether some object is a function is a bit tricky in sagemath. Currently, the functions doing that are imported from `sage.calculus.calculus`, but it might make sense to factor them out there and put them in a more suitable place.

CC:  @orlitzky @EmmanuelCharpentier

Branch/Commit: [ace72a041d4de4a6708c7f45d8c0ce652290d0c5](https://github.com/sagemath/sagetrac-mirror/commit/ace72a041d4de4a6708c7f45d8c0ce652290d0c5)

Reviewer: Matthias Koeppe

Author: Marius Gerbershagen

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/32485





---

archive/issue_comments_647400.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-09-07T17:22:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32485#issuecomment-647400",
    "user": "https://github.com/spaghettisalat"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_647401.json:
```json
{
    "body": "Replying to [ticket:32485 gh-spaghettisalat]:\n> 2. Finding functions by name and checking whether some object is a function is a bit tricky in sagemath. Currently, the functions doing that are imported from `sage.calculus.calculus`, but it might make sense to factor them out there and put them in a more suitable place.\n\n\nIndeed. There are some related tickets that could use some input/help: #32227, #32479",
    "created_at": "2021-09-07T18:41:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32485#issuecomment-647401",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [ticket:32485 gh-spaghettisalat]:
> 2. Finding functions by name and checking whether some object is a function is a bit tricky in sagemath. Currently, the functions doing that are imported from `sage.calculus.calculus`, but it might make sense to factor them out there and put them in a more suitable place.


Indeed. There are some related tickets that could use some input/help: #32227, #32479



---

archive/issue_comments_647402.json:
```json
{
    "body": "<a id='comment:3'></a>\nThe class `SubstituteFunction` is part of the public API and so if you change the signature of `__init__`, it needs to accept the old input as well.",
    "created_at": "2021-09-07T18:53:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32485#issuecomment-647402",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>
The class `SubstituteFunction` is part of the public API and so if you change the signature of `__init__`, it needs to accept the old input as well.



---

archive/issue_comments_647403.json:
```json
{
    "body": "Changing commit from \"b1e9ef29fe2a66f3535dca9a836776848e8ce076\" to \"912988532cec477cc9cb5c6ff9564f93fa752e03\"",
    "created_at": "2021-09-08T19:19:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32485#issuecomment-647403",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "b1e9ef29fe2a66f3535dca9a836776848e8ce076" to "912988532cec477cc9cb5c6ff9564f93fa752e03"



---

archive/issue_comments_647404.json:
```json
{
    "body": "<a id='comment:4'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                                         |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------|\n|[9129885](https://github.com/sagemath/sagetrac-mirror/commit/912988532cec477cc9cb5c6ff9564f93fa752e03)|`symbolic expressions: extend substitute_function syntax`|",
    "created_at": "2021-09-08T19:19:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32485#issuecomment-647404",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                                         |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------|
|[9129885](https://github.com/sagemath/sagetrac-mirror/commit/912988532cec477cc9cb5c6ff9564f93fa752e03)|`symbolic expressions: extend substitute_function syntax`|



---

archive/issue_comments_647405.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [mkoeppe](#comment%3A3):\n> The class `SubstituteFunction` is part of the public API and so if you change the signature of `__init__`, it needs to accept the old input as well.\n\n\nFixed, we now also allow the old syntax for `SubstituteFunction`.",
    "created_at": "2021-09-08T19:21:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32485#issuecomment-647405",
    "user": "https://github.com/spaghettisalat"
}
```

<a id='comment:5'></a>
Replying to [mkoeppe](#comment%3A3):
> The class `SubstituteFunction` is part of the public API and so if you change the signature of `__init__`, it needs to accept the old input as well.


Fixed, we now also allow the old syntax for `SubstituteFunction`.



---

archive/issue_comments_647406.json:
```json
{
    "body": "<a id='comment:6'></a>\nCode like this:\n\n```\n+        try:\n+            new = self.substitutions[operator]\n+            return new(*[self(_) for _ in ex.operands()])\n+        except KeyError:\n             return super(SubstituteFunction, self).composition(ex, operator)\n```\nI would suggest to rewrite using `try...except...else` so that only the line `new = self.substitutions[operator]` is in the protected block",
    "created_at": "2021-09-09T03:03:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32485#issuecomment-647406",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>
Code like this:

```
+        try:
+            new = self.substitutions[operator]
+            return new(*[self(_) for _ in ex.operands()])
+        except KeyError:
             return super(SubstituteFunction, self).composition(ex, operator)
```
I would suggest to rewrite using `try...except...else` so that only the line `new = self.substitutions[operator]` is in the protected block



---

archive/issue_comments_647407.json:
```json
{
    "body": "<a id='comment:7'></a>\n\n```\n+        if len(args) == 2:\n+            self.substitutions = {args[0]: args[1]}\n+        else:\n+            self.substitutions = args[0]\n```\nit should probably raise a `TypeError` if `len(args)` is neither 1 nor 2",
    "created_at": "2021-09-09T03:04:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32485#issuecomment-647407",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>

```
+        if len(args) == 2:
+            self.substitutions = {args[0]: args[1]}
+        else:
+            self.substitutions = args[0]
```
it should probably raise a `TypeError` if `len(args)` is neither 1 nor 2



---

archive/issue_comments_647408.json:
```json
{
    "body": "<a id='comment:8'></a>\n\n```\n+        Check that the old syntax still works::\n             sage: s = SubstituteFunction(foo(x), foo, bar)\n```\nI think this needs a blank line in between",
    "created_at": "2021-09-09T03:05:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32485#issuecomment-647408",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>

```
+        Check that the old syntax still works::
             sage: s = SubstituteFunction(foo(x), foo, bar)
```
I think this needs a blank line in between



---

archive/issue_comments_647409.json:
```json
{
    "body": "<a id='comment:9'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                                         |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------|\n|[ace72a0](https://github.com/sagemath/sagetrac-mirror/commit/ace72a041d4de4a6708c7f45d8c0ce652290d0c5)|`symbolic expressions: extend substitute_function syntax`|",
    "created_at": "2021-09-10T17:51:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32485#issuecomment-647409",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                                         |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------|
|[ace72a0](https://github.com/sagemath/sagetrac-mirror/commit/ace72a041d4de4a6708c7f45d8c0ce652290d0c5)|`symbolic expressions: extend substitute_function syntax`|



---

archive/issue_comments_647410.json:
```json
{
    "body": "Changing commit from \"912988532cec477cc9cb5c6ff9564f93fa752e03\" to \"ace72a041d4de4a6708c7f45d8c0ce652290d0c5\"",
    "created_at": "2021-09-10T17:51:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32485#issuecomment-647410",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "912988532cec477cc9cb5c6ff9564f93fa752e03" to "ace72a041d4de4a6708c7f45d8c0ce652290d0c5"



---

archive/issue_comments_647411.json:
```json
{
    "body": "<a id='comment:10'></a>\nI have addressed all comments.",
    "created_at": "2021-09-10T17:52:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32485#issuecomment-647411",
    "user": "https://github.com/spaghettisalat"
}
```

<a id='comment:10'></a>
I have addressed all comments.



---

archive/issue_comments_647412.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Matthias Koeppe\"",
    "created_at": "2021-09-10T18:12:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32485#issuecomment-647412",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "Matthias Koeppe"



---

archive/issue_comments_647413.json:
```json
{
    "body": "<a id='comment:11'></a>\nLGTM. When the patchbot indicator is green, you can set to positive review",
    "created_at": "2021-09-10T18:12:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32485#issuecomment-647413",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>
LGTM. When the patchbot indicator is green, you can set to positive review



---

archive/issue_comments_647414.json:
```json
{
    "body": "<a id='comment:12'></a>\nThe failure on one of the patchbot looks unrelated. Also the pyflakes warning is unrelated. Good to go.",
    "created_at": "2021-09-10T23:14:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32485#issuecomment-647414",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>
The failure on one of the patchbot looks unrelated. Also the pyflakes warning is unrelated. Good to go.



---

archive/issue_comments_647415.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-10T23:14:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32485#issuecomment-647415",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_647416.json:
```json
{
    "body": "Changing branch from \"public/extend-substitute_function-syntax\" to \"ace72a041d4de4a6708c7f45d8c0ce652290d0c5\"",
    "created_at": "2021-09-19T09:58:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32485#issuecomment-647416",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/extend-substitute_function-syntax" to "ace72a041d4de4a6708c7f45d8c0ce652290d0c5"



---

archive/issue_events_096909.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-09-19T09:58:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32485",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32485#event-96909"
}
```



---

archive/issue_comments_647417.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-09-19T09:58:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32485",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32485#issuecomment-647417",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
