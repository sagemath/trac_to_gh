# Issue 32527: urllib needs a SSL context to work with openssl 3.x

archive/issues_032290.json:
```json
{
    "body": "Whith OpenSSL 3.x installed from Sage, we get the following error:\n\n```\nsage: oeis(42)\n<repr(<sage.databases.oeis.OEISSequence at 0x7f1fd4483e50>) failed: OSError: <urlopen error [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1129)>\nError fetching https://oeis.org/search?q=A000042&n=1&fmt=text.>\n```\n\nThis is due to the fact that we do not pass any SSL context to urllib.\n\nThe current branch also force https in the URL that are fetched by Sage, except:\n- `src/sage/finance/stock.py` which is broken anyway #25473\n- `src/sage/combinat/matrices/hadamard_matrix.py` since `http://neilsloane.com/hadamard/` does not provide https connections\n- `src/sage/combinat/designs/ext_rep.py` since neither `http://designtheory.org` nor `http://www.maths.qmul.ac.uk/~lsoicher/designtheory.org/` provide https connections.\n\n\nBranch/Commit: 1d88693ddf1758ae4fa7ccb6949161b52200e591\n\nReviewer: Matthias Koeppe\n\nAuthor: Thierry Monteil\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32527\n\n",
    "closed_at": "2021-09-25T23:17:41Z",
    "created_at": "2021-09-16T22:06:24Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "urllib needs a SSL context to work with openssl 3.x",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32527",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```
Whith OpenSSL 3.x installed from Sage, we get the following error:

```
sage: oeis(42)
<repr(<sage.databases.oeis.OEISSequence at 0x7f1fd4483e50>) failed: OSError: <urlopen error [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1129)>
Error fetching https://oeis.org/search?q=A000042&n=1&fmt=text.>
```

This is due to the fact that we do not pass any SSL context to urllib.

The current branch also force https in the URL that are fetched by Sage, except:
- `src/sage/finance/stock.py` which is broken anyway #25473
- `src/sage/combinat/matrices/hadamard_matrix.py` since `http://neilsloane.com/hadamard/` does not provide https connections
- `src/sage/combinat/designs/ext_rep.py` since neither `http://designtheory.org` nor `http://www.maths.qmul.ac.uk/~lsoicher/designtheory.org/` provide https connections.


Branch/Commit: 1d88693ddf1758ae4fa7ccb6949161b52200e591

Reviewer: Matthias Koeppe

Author: Thierry Monteil

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/32527





---

archive/issue_comments_648112.json:
```json
{
    "body": "<a id='comment:1'></a>I think this is the same problem that we faced in #29418/#30950 (for `sage-system-python`)",
    "created_at": "2021-09-16T22:24:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32527#issuecomment-648112",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>I think this is the same problem that we faced in #29418/#30950 (for `sage-system-python`)



---

archive/issue_comments_648113.json:
```json
{
    "body": "<a id='comment:2'></a>OK, will look at those tickets too.",
    "created_at": "2021-09-16T22:40:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32527#issuecomment-648113",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:2'></a>OK, will look at those tickets too.



---

archive/issue_comments_648114.json:
```json
{
    "body": "Changing branch from \"\" to \"u/tmonteil/urllib_needs_a_ssl_context_to_work_with_openssl_3_x\"",
    "created_at": "2021-09-17T15:21:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32527#issuecomment-648114",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Changing branch from "" to "u/tmonteil/urllib_needs_a_ssl_context_to_work_with_openssl_3_x"



---

archive/issue_comments_648115.json:
```json
{
    "body": "<a id='comment:4'></a>New commits:",
    "created_at": "2021-09-17T15:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32527#issuecomment-648115",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:4'></a>New commits:



---

archive/issue_comments_648116.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-09-17T15:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32527#issuecomment-648116",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_648117.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -8,6 +8,12 @@\n \n This is due to the fact that we do not pass any SSL context to urllib.\n \n+The current branch also force https in the URL that are fetched by Sage, except:\n+- `src/sage/finance/stock.py` which is broken anyway #25473\n+- `src/sage/combinat/matrices/hadamard_matrix.py` since `http://neilsloane.com/hadamard/` does not provide https connections\n+- `src/sage/combinat/designs/ext_rep.py` since neither `http://designtheory.org` nor `http://www.maths.qmul.ac.uk/~lsoicher/designtheory.org/` provide https connections.\n+\n+\n Author: Thierry Monteil\n \n Comment: 1\n``````\n",
    "created_at": "2021-09-17T15:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32527#issuecomment-648117",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -8,6 +8,12 @@
 
 This is due to the fact that we do not pass any SSL context to urllib.
 
+The current branch also force https in the URL that are fetched by Sage, except:
+- `src/sage/finance/stock.py` which is broken anyway #25473
+- `src/sage/combinat/matrices/hadamard_matrix.py` since `http://neilsloane.com/hadamard/` does not provide https connections
+- `src/sage/combinat/designs/ext_rep.py` since neither `http://designtheory.org` nor `http://www.maths.qmul.ac.uk/~lsoicher/designtheory.org/` provide https connections.
+
+
 Author: Thierry Monteil
 
 Comment: 1
``````




---

archive/issue_comments_648118.json:
```json
{
    "body": "Changing commit from \"\" to \"01c63814b4756555805769a0281b16b18336d1b2\"",
    "created_at": "2021-09-17T15:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32527#issuecomment-648118",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Changing commit from "" to "01c63814b4756555805769a0281b16b18336d1b2"



---

archive/issue_comments_648119.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-09-17T15:36:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32527#issuecomment-648119",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_648120.json:
```json
{
    "body": "Changing commit from \"01c63814b4756555805769a0281b16b18336d1b2\" to \"1d88693ddf1758ae4fa7ccb6949161b52200e591\"",
    "created_at": "2021-09-17T15:36:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32527#issuecomment-648120",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "01c63814b4756555805769a0281b16b18336d1b2" to "1d88693ddf1758ae4fa7ccb6949161b52200e591"



---

archive/issue_comments_648121.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Matthias Koeppe\"",
    "created_at": "2021-09-17T16:59:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32527#issuecomment-648121",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "Matthias Koeppe"



---

archive/issue_comments_648122.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-17T16:59:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32527#issuecomment-648122",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_648123.json:
```json
{
    "body": "<a id='comment:6'></a>This seems to work well, tested locally with `./sage -tp --optional=sage,internet src/sage/arith/misc.py src/sage/combinat/designs/covering_design.py src/sage/databases/ src/sage/doctest/external.py src/sage/graphs/isgci.py src/sage/interfaces/mathematica.py src/sage/misc/ src/sage/repl`\n\nThere are a bunch of failures\n\n```\nsage -t --random-seed=0 src/sage/databases/oeis.py  # 4 doctests failed\nsage -t --random-seed=0 src/sage/databases/findstat.py  # 4 doctests failed\n```\nthat come from absurdly rigid doctests. Fixing them is outside of the scope of this ticket.",
    "created_at": "2021-09-17T16:59:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32527#issuecomment-648123",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>This seems to work well, tested locally with `./sage -tp --optional=sage,internet src/sage/arith/misc.py src/sage/combinat/designs/covering_design.py src/sage/databases/ src/sage/doctest/external.py src/sage/graphs/isgci.py src/sage/interfaces/mathematica.py src/sage/misc/ src/sage/repl`

There are a bunch of failures

```
sage -t --random-seed=0 src/sage/databases/oeis.py  # 4 doctests failed
sage -t --random-seed=0 src/sage/databases/findstat.py  # 4 doctests failed
```
that come from absurdly rigid doctests. Fixing them is outside of the scope of this ticket.



---

archive/issue_comments_648124.json:
```json
{
    "body": "<a id='comment:7'></a>Thanks for the review. Also tested on a bare VM with only Sage-shipped packages (including Python 3 and Openssl 3.0.0).",
    "created_at": "2021-09-17T17:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32527#issuecomment-648124",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:7'></a>Thanks for the review. Also tested on a bare VM with only Sage-shipped packages (including Python 3 and Openssl 3.0.0).



---

archive/issue_comments_648125.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-09-25T23:17:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32527#issuecomment-648125",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_086242.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-09-25T23:17:41Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32527",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32527#event-86242"
}
```



---

archive/issue_comments_648126.json:
```json
{
    "body": "Changing branch from \"u/tmonteil/urllib_needs_a_ssl_context_to_work_with_openssl_3_x\" to \"1d88693ddf1758ae4fa7ccb6949161b52200e591\"",
    "created_at": "2021-09-25T23:17:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32527",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32527#issuecomment-648126",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/tmonteil/urllib_needs_a_ssl_context_to_work_with_openssl_3_x" to "1d88693ddf1758ae4fa7ccb6949161b52200e591"
