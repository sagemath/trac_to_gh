# Issue 32209: Allow evaluation of morphisms of schemes on points over different rings

archive/issues_031972.json:
```json
{
    "body": "In SageMath 9.3, consider the following setting:\n\n```\nsage: S.<x,y> = AffineSpace(ZZ, 2)\nsage: T.<u,v> = AffineSpace(ZZ, 2)\nsage: h = T.hom([u + v, u * v], S); h\nScheme morphism:\n  From: Affine Space of dimension 2 over Integer Ring\n  To:   Affine Space of dimension 2 over Integer Ring\n  Defn: Defined on coordinates by sending (u, v) to\n        (u + v, u*v)\n```\nThe morphism `h` cannot be evaluated on points over **F**<sub>4</sub>:\n\n```\nsage: F.<a> = GF(4)\nsage: P = T(F)(1, a)\nsage: h(P)\nTraceback (most recent call last):\n...\nTypeError: not in prime subfield\nsage: h.change_ring(F)(P)\nTraceback (most recent call last):\n...\nTypeError: (1, a) fails to convert into the map's domain Affine Space of dimension 2 over Finite Field in a of size 2^2,but a `pushforward` method is not properly implemented\n```\nThere is no error when the coordinates are in the prime field, but the coordinates of the resulting point are in **Z** instead of **F**<sub>4</sub>:\n\n```\nsage: Q = T(F)(1, 0)\nsage: Q.domain()\nSpectrum of Finite Field in a of size 2^2\nsage: h(Q)\n(1, 0)\nsage: h(Q).domain()\nSpectrum of Integer Ring\n```\n\n\n**Branch/Commit:** [d0c30c0b1b871d024629c306bd0d297f7456e11e](https://github.com/sagemath/sagetrac-mirror/commit/d0c30c0b1b871d024629c306bd0d297f7456e11e)\n\n**Reviewer:** Lorenz Panny\n\n**Author:** Peter Bruin\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32209\n\n",
    "closed_at": "2022-02-12T22:05:38Z",
    "created_at": "2021-07-16T11:56:53Z",
    "labels": [
        "component: algebraic geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Allow evaluation of morphisms of schemes on points over different rings",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32209",
    "user": "https://github.com/pjbruin"
}
```
In SageMath 9.3, consider the following setting:

```
sage: S.<x,y> = AffineSpace(ZZ, 2)
sage: T.<u,v> = AffineSpace(ZZ, 2)
sage: h = T.hom([u + v, u * v], S); h
Scheme morphism:
  From: Affine Space of dimension 2 over Integer Ring
  To:   Affine Space of dimension 2 over Integer Ring
  Defn: Defined on coordinates by sending (u, v) to
        (u + v, u*v)
```
The morphism `h` cannot be evaluated on points over **F**<sub>4</sub>:

```
sage: F.<a> = GF(4)
sage: P = T(F)(1, a)
sage: h(P)
Traceback (most recent call last):
...
TypeError: not in prime subfield
sage: h.change_ring(F)(P)
Traceback (most recent call last):
...
TypeError: (1, a) fails to convert into the map's domain Affine Space of dimension 2 over Finite Field in a of size 2^2,but a `pushforward` method is not properly implemented
```
There is no error when the coordinates are in the prime field, but the coordinates of the resulting point are in **Z** instead of **F**<sub>4</sub>:

```
sage: Q = T(F)(1, 0)
sage: Q.domain()
Spectrum of Finite Field in a of size 2^2
sage: h(Q)
(1, 0)
sage: h(Q).domain()
Spectrum of Integer Ring
```


**Branch/Commit:** [d0c30c0b1b871d024629c306bd0d297f7456e11e](https://github.com/sagemath/sagetrac-mirror/commit/d0c30c0b1b871d024629c306bd0d297f7456e11e)

**Reviewer:** Lorenz Panny

**Author:** Peter Bruin

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/32209





---

archive/issue_events_095982.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/32209",
    "rename": {
        "from": "Allow evaluation of morphisms of affine schemes on points over different rings",
        "to": "Allow evaluation of morphisms of schemes on points over different rings"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32209#event-95982"
}
```



---

archive/issue_comments_641490.json:
```json
{
    "body": "**Author:** Peter Bruin",
    "created_at": "2021-07-16T18:08:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32209",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32209#issuecomment-641490",
    "user": "https://github.com/pjbruin"
}
```

**Author:** Peter Bruin



---

archive/issue_comments_641491.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2021-07-17T12:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32209",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32209#issuecomment-641491",
    "user": "https://github.com/pjbruin"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_641492.json:
```json
{
    "body": "**Branch:** [u/pbruin/32209-scheme_morphisms](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/32209-scheme_morphisms)",
    "created_at": "2021-07-17T12:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32209",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32209#issuecomment-641492",
    "user": "https://github.com/pjbruin"
}
```

**Branch:** [u/pbruin/32209-scheme_morphisms](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/32209-scheme_morphisms)



---

archive/issue_comments_641493.json:
```json
{
    "body": "**Commit:** [608f2f492f1b1b69f38d78cf878184f26493892e](https://github.com/sagemath/sagetrac-mirror/commit/608f2f492f1b1b69f38d78cf878184f26493892e)",
    "created_at": "2021-07-17T12:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32209",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32209#issuecomment-641493",
    "user": "https://github.com/pjbruin"
}
```

**Commit:** [608f2f492f1b1b69f38d78cf878184f26493892e](https://github.com/sagemath/sagetrac-mirror/commit/608f2f492f1b1b69f38d78cf878184f26493892e)



---

archive/issue_events_095983.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-09T21:07:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32209",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32209#event-95983"
}
```



---

archive/issue_comments_641494.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2021-08-31T08:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32209",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32209#issuecomment-641494",
    "user": "https://github.com/yyyyx4"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_641495.json:
```json
{
    "body": "<a id='comment:4'></a>\nWith the patch, a morphism of affine schemes now happily returns values at points which clearly do not lie in its domain:\n\n```sage\nsage: S.<x,y> = AffineSpace(ZZ, 2)\nsage: T.<u,v> = AffineSpace(ZZ, 2)\nsage: C = Curve(x**2+y**2-1)\nsage: f = C.hom([x,y],T)\nsage: P = S([123,456])\nsage: f.domain().defining_polynomial()(*P)\n223064\nsage: f(P)\n(123, 456)\n```\n\nThe following change should fix this according to my very limited testing. It is inspired by the projective case (which did already seem to detect points outside the domain).\n\n```diff\n--- b/src/sage/schemes/affine/affine_morphism.py\n+++ b/src/sage/schemes/affine/affine_morphism.py\n@@ -262,7 +262,7 @@ class SchemeMorphism_polynomial_affine_space(SchemeMorphism_polynomial):\n         \"\"\"\n         from sage.schemes.affine.affine_point import SchemeMorphism_point_affine\n         if check:\n-            if not isinstance(x, SchemeMorphism_point_affine):\n+            if not isinstance(x, SchemeMorphism_point_affine) or self.domain() != x.codomain():\n                 try:\n                     x = self.domain()(x)\n                 except (TypeError, NotImplementedError):\n```",
    "created_at": "2021-08-31T08:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32209",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32209#issuecomment-641495",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:4'></a>
With the patch, a morphism of affine schemes now happily returns values at points which clearly do not lie in its domain:

```sage
sage: S.<x,y> = AffineSpace(ZZ, 2)
sage: T.<u,v> = AffineSpace(ZZ, 2)
sage: C = Curve(x**2+y**2-1)
sage: f = C.hom([x,y],T)
sage: P = S([123,456])
sage: f.domain().defining_polynomial()(*P)
223064
sage: f(P)
(123, 456)
```

The following change should fix this according to my very limited testing. It is inspired by the projective case (which did already seem to detect points outside the domain).

```diff
--- b/src/sage/schemes/affine/affine_morphism.py
+++ b/src/sage/schemes/affine/affine_morphism.py
@@ -262,7 +262,7 @@ class SchemeMorphism_polynomial_affine_space(SchemeMorphism_polynomial):
         """
         from sage.schemes.affine.affine_point import SchemeMorphism_point_affine
         if check:
-            if not isinstance(x, SchemeMorphism_point_affine):
+            if not isinstance(x, SchemeMorphism_point_affine) or self.domain() != x.codomain():
                 try:
                     x = self.domain()(x)
                 except (TypeError, NotImplementedError):
```



---

archive/issue_events_095984.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32209",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32209#event-95984"
}
```



---

archive/issue_events_095985.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32209",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32209#event-95985"
}
```



---

archive/issue_comments_641496.json:
```json
{
    "body": "**Changing commit** from \"[608f2f492f1b1b69f38d78cf878184f26493892e](https://github.com/sagemath/sagetrac-mirror/commit/608f2f492f1b1b69f38d78cf878184f26493892e)\" to \"[d0c30c0b1b871d024629c306bd0d297f7456e11e](https://github.com/sagemath/sagetrac-mirror/commit/d0c30c0b1b871d024629c306bd0d297f7456e11e)\".",
    "created_at": "2022-02-03T12:46:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32209",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32209#issuecomment-641496",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[608f2f492f1b1b69f38d78cf878184f26493892e](https://github.com/sagemath/sagetrac-mirror/commit/608f2f492f1b1b69f38d78cf878184f26493892e)" to "[d0c30c0b1b871d024629c306bd0d297f7456e11e](https://github.com/sagemath/sagetrac-mirror/commit/d0c30c0b1b871d024629c306bd0d297f7456e11e)".



---

archive/issue_comments_641497.json:
```json
{
    "body": "<a id='comment:6'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d0c30c0b1b871d024629c306bd0d297f7456e11e\">d0c30c0</a></td><td><code>Trac 32209: additional check</code></td></tr></table>\n",
    "created_at": "2022-02-03T12:46:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32209",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32209#issuecomment-641497",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d0c30c0b1b871d024629c306bd0d297f7456e11e">d0c30c0</a></td><td><code>Trac 32209: additional check</code></td></tr></table>




---

archive/issue_comments_641498.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2022-02-03T12:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32209",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32209#issuecomment-641498",
    "user": "https://github.com/pjbruin"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_641499.json:
```json
{
    "body": "<a id='comment:7'></a>\nThanks for noticing!  This looks like a good fix to me.",
    "created_at": "2022-02-03T12:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32209",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32209#issuecomment-641499",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:7'></a>
Thanks for noticing!  This looks like a good fix to me.



---

archive/issue_comments_641500.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2022-02-04T11:03:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32209",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32209#issuecomment-641500",
    "user": "https://github.com/yyyyx4"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_641501.json:
```json
{
    "body": "**Reviewer:** Lorenz Panny",
    "created_at": "2022-02-04T11:03:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32209",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32209#issuecomment-641501",
    "user": "https://github.com/yyyyx4"
}
```

**Reviewer:** Lorenz Panny



---

archive/issue_comments_641502.json:
```json
{
    "body": "**Changing branch** from \"[u/pbruin/32209-scheme_morphisms](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/32209-scheme_morphisms)\" to \"[d0c30c0b1b871d024629c306bd0d297f7456e11e](https://github.com/sagemath/sagetrac-mirror/commit/d0c30c0b1b871d024629c306bd0d297f7456e11e)\".",
    "created_at": "2022-02-12T22:05:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32209",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32209#issuecomment-641502",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/pbruin/32209-scheme_morphisms](https://github.com/sagemath/sagetrac-mirror/tree/u/pbruin/32209-scheme_morphisms)" to "[d0c30c0b1b871d024629c306bd0d297f7456e11e](https://github.com/sagemath/sagetrac-mirror/commit/d0c30c0b1b871d024629c306bd0d297f7456e11e)".



---

archive/issue_comments_641503.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2022-02-12T22:05:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32209",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32209#issuecomment-641503",
    "user": "https://github.com/vbraun"
}
```

**Resolution:** fixed



---

archive/issue_events_095986.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-02-12T22:05:38Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32209",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32209#event-95986"
}
```
