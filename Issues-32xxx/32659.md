# Issue 32659: sdh_pip_install: Force reinstallation of built wheels; add sage_setup source deps

archive/issues_032422.json:
```json
{
    "body": "After #32492, we may get \n\n```\n[sage_conf-9.5.beta2] sage-conf is already installed with the same version as the provided wheel. Use --force-reinstall to force an installation of the wheel.\n```\nBecause of this behavior of pip, some configuration changes made in `configure` will not be updated in an incremental build. Likewise for other Python packages when we add a patch, or for `sage-setup` when we edit files there (as happened in #32607).\n\nHowever, as discussed in https://github.com/pypa/pip/issues/8711, the `pip install` option `--force-reinstall` does too much -- it also reinstalls all dependencies, which we definitely do not want.\n\nInstead, we just use `pip uninstall` before `pip install`.\n\nWe also add some dependencies on source files to `sage_setup`. This is also for #32607.\n\nCC:  @jhpalmieri @vbraun @yyyyx4\n\nReviewer: Lorenz Panny\n\nAuthor: Matthias Koeppe\n\nBranch: d4357816318a05645edfd169c6f2b08108074fb1\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32659\n\n",
    "closed_at": "2021-10-20T23:01:04Z",
    "created_at": "2021-10-09T23:03:51Z",
    "labels": [
        "component: build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "sdh_pip_install: Force reinstallation of built wheels; add sage_setup source deps",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32659",
    "user": "https://github.com/mkoeppe"
}
```
After #32492, we may get 

```
[sage_conf-9.5.beta2] sage-conf is already installed with the same version as the provided wheel. Use --force-reinstall to force an installation of the wheel.
```
Because of this behavior of pip, some configuration changes made in `configure` will not be updated in an incremental build. Likewise for other Python packages when we add a patch, or for `sage-setup` when we edit files there (as happened in #32607).

However, as discussed in https://github.com/pypa/pip/issues/8711, the `pip install` option `--force-reinstall` does too much -- it also reinstalls all dependencies, which we definitely do not want.

Instead, we just use `pip uninstall` before `pip install`.

We also add some dependencies on source files to `sage_setup`. This is also for #32607.

CC:  @jhpalmieri @vbraun @yyyyx4

Reviewer: Lorenz Panny

Author: Matthias Koeppe

Branch: d4357816318a05645edfd169c6f2b08108074fb1

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/32659





---

archive/issue_comments_650646.json:
```json
{
    "body": "<a id='comment:1'></a>\nA solution provided by https://github.com/pypa/pip/pull/9147 (was merged in pip 20.3) is to use a specification `sage-conf `@` file:///.....` (see https://github.com/pypa/pip/issues/8711#issuecomment-731618898), which will ensure reinstallation.",
    "created_at": "2021-10-09T23:12:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650646",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>
A solution provided by https://github.com/pypa/pip/pull/9147 (was merged in pip 20.3) is to use a specification `sage-conf `@` file:///.....` (see https://github.com/pypa/pip/issues/8711#issuecomment-731618898), which will ensure reinstallation.



---

archive/issue_comments_650647.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/sdh_pip_install__force_reinstallation_of_built_wheels\"",
    "created_at": "2021-10-09T23:48:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650647",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/sdh_pip_install__force_reinstallation_of_built_wheels"



---

archive/issue_comments_650648.json:
```json
{
    "body": "Changing commit from \"\" to \"5855e54a27cc5474699e35ccf87515e89fff2509\"",
    "created_at": "2021-10-09T23:50:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650648",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "" to "5855e54a27cc5474699e35ccf87515e89fff2509"



---

archive/issue_comments_650649.json:
```json
{
    "body": "<a id='comment:3'></a>\nUnfortunately this does not fix the issue:\n\n```\n[sage_setup-9.5.beta2] Processing /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/wheels/sage_setup-9.5b2-py3-none-any.whl\n[sage_setup-9.5.beta2] Requirement already satisfied: pkgconfig in /Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.9/site-packages (from sage_setup@ file:///Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/wheels/sage_setup-9.5b2-py3-none-any.whl) (1.5.5)\n[sage_setup-9.5.beta2] sage-setup is already installed with the same version as the provided wheel. Use --force-reinstall to force an installation of the wheel.\n```\n\n---\nNew commits:\n|                                                                                                                                          |                                                                                  |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|\n|[5855e54](https://git.sagemath.org/sage.git/commit?id=5855e54a27cc5474699e35ccf87515e89fff2509)|`build/bin/sage-pip-install: Use pip install \"distribution `@` file:///wheelfile\"`|",
    "created_at": "2021-10-09T23:50:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650649",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>
Unfortunately this does not fix the issue:

```
[sage_setup-9.5.beta2] Processing /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/wheels/sage_setup-9.5b2-py3-none-any.whl
[sage_setup-9.5.beta2] Requirement already satisfied: pkgconfig in /Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.9/site-packages (from sage_setup@ file:///Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/wheels/sage_setup-9.5b2-py3-none-any.whl) (1.5.5)
[sage_setup-9.5.beta2] sage-setup is already installed with the same version as the provided wheel. Use --force-reinstall to force an installation of the wheel.
```

---
New commits:
|                                                                                                                                          |                                                                                  |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|
|[5855e54](https://git.sagemath.org/sage.git/commit?id=5855e54a27cc5474699e35ccf87515e89fff2509)|`build/bin/sage-pip-install: Use pip install "distribution `@` file:///wheelfile"`|



---

archive/issue_comments_650650.json:
```json
{
    "body": "<a id='comment:4'></a>\nThis behavior of pip is subject to current discussion/development - \n\nUn-deprecate source distribution re-installation behaviour \nhttps://github.com/pypa/pip/pull/10543\n\nRewrite direct URL reinstallation logic by uranusjr \nhttps://github.com/pypa/pip/pull/10564\n\nUpdating remote links with new URLs for PEP508 functionallity \nhttps://github.com/pypa/pip/issues/5780",
    "created_at": "2021-10-09T23:52:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650650",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>
This behavior of pip is subject to current discussion/development - 

Un-deprecate source distribution re-installation behaviour 
https://github.com/pypa/pip/pull/10543

Rewrite direct URL reinstallation logic by uranusjr 
https://github.com/pypa/pip/pull/10564

Updating remote links with new URLs for PEP508 functionallity 
https://github.com/pypa/pip/issues/5780



---

archive/issue_comments_650651.json:
```json
{
    "body": "<a id='comment:5'></a>\nAnother possible workaround is proposed in https://github.com/pypa/pip/issues/8711#issuecomment-669760276",
    "created_at": "2021-10-09T23:55:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650651",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>
Another possible workaround is proposed in https://github.com/pypa/pip/issues/8711#issuecomment-669760276



---

archive/issue_comments_650652.json:
```json
{
    "body": "<a id='comment:6'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                                          |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------|\n|[9c620c4](https://git.sagemath.org/sage.git/commit/?id=9c620c49a89714c5e10cb54126cf59ab782d458d)|`build/bin/sage-pip-install: Add a query suffix to the file:/// URL in an attempt to force reinstallation`|",
    "created_at": "2021-10-10T00:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650652",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                                          |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------|
|[9c620c4](https://git.sagemath.org/sage.git/commit/?id=9c620c49a89714c5e10cb54126cf59ab782d458d)|`build/bin/sage-pip-install: Add a query suffix to the file:/// URL in an attempt to force reinstallation`|



---

archive/issue_comments_650653.json:
```json
{
    "body": "Changing commit from \"5855e54a27cc5474699e35ccf87515e89fff2509\" to \"9c620c49a89714c5e10cb54126cf59ab782d458d\"",
    "created_at": "2021-10-10T00:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650653",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "5855e54a27cc5474699e35ccf87515e89fff2509" to "9c620c49a89714c5e10cb54126cf59ab782d458d"



---

archive/issue_comments_650654.json:
```json
{
    "body": "<a id='comment:7'></a>\nUnfortunately also that does not fix the issue:\n\n```\n[sage_setup-9.5.beta2] Requirement already satisfied: pkgconfig in /Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.9/site-packages (from sage_setup@ file:///Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/wheels/sage_setup-9.5b2-py3-none-any.whl?hash=sha256:285343dcfde7ad2e51f630591faba468aad4875ee0f15398346642092a8e842b) (1.5.5)\n[sage_setup-9.5.beta2] sage-setup is already installed with the same version as the provided wheel. Use --force-reinstall to force an installation of the wheel.\n```",
    "created_at": "2021-10-10T00:21:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650654",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>
Unfortunately also that does not fix the issue:

```
[sage_setup-9.5.beta2] Requirement already satisfied: pkgconfig in /Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.9/site-packages (from sage_setup@ file:///Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/wheels/sage_setup-9.5b2-py3-none-any.whl?hash=sha256:285343dcfde7ad2e51f630591faba468aad4875ee0f15398346642092a8e842b) (1.5.5)
[sage_setup-9.5.beta2] sage-setup is already installed with the same version as the provided wheel. Use --force-reinstall to force an installation of the wheel.
```



---

archive/issue_comments_650655.json:
```json
{
    "body": "<a id='comment:8'></a>\nAlso another approach, providing a `--hash` (via a requirements file) fails.\n\n```diff\ndiff --git a/build/bin/sage-dist-helpers b/build/bin/sage-dist-helpers\nindex 4a8862d50f..e7b8fc8677 100644\n--- a/build/bin/sage-dist-helpers\n+++ b/build/bin/sage-dist-helpers\n@@ -271,7 +271,20 @@ sdh_store_wheel() {\n     mkdir -p \"${SAGE_DESTDIR}${SAGE_SPKG_WHEELS}\" && \\\n         $sudo mv \"$wheel\" \"${SAGE_DESTDIR}${SAGE_SPKG_WHEELS}/\" || \\\n         sdh_die \"Error storing $wheel\"\n+    wheel_basename=\"${wheel##*/}\"\n     wheel=\"${SAGE_DESTDIR}${SAGE_SPKG_WHEELS}/${wheel##*/}\"\n+    # Trac #32659: pip no longer reinstalls local wheels if the version is the same.\n+    # Because neither (1) applying patches nor (2) local changes (in the case\n+    # of sage-conf, sage-setup, etc.) bump the version number, we need to\n+    # override this behavior.  The pip install option --force-reinstall does too\n+    # much -- it also reinstalls all dependencies, which we do not want.\n+    # We override it by specifying the hash -- but this can only be done using a\n+    # requirements file, not using flags on the command line,\n+    # https://github.com/pypa/pip/issues/3257\n+    distname=\"${wheel_basename%%-*}\"\n+    hasharg=$(python3 -m pip hash \"$wheel\" | sed -n /--hash=/p)\n+    requirements_file=\"${SAGE_DESTDIR}${SAGE_SPKG_WHEELS}/requirements-$distname.txt\"\n+    echo \"$distname @ file://$wheel $hasharg\" | $sudo tee $requirements_file > /dev/null\n }\n \n sdh_store_and_pip_install_wheel() {\n@@ -306,7 +319,7 @@ sdh_store_and_pip_install_wheel() {\n         local sudo=\"\"\n         local root=\"\"\n     fi\n-    $sudo sage-pip-install $root $pip_options \"$wheel\" || \\\n+    $sudo sage-pip-install $root $pip_options -v -v -v -r \"$requirements_file\" || \\\n         sdh_die \"Error installing ${wheel##*/}\"\n     if [ -n \"${SAGE_PKG_DIR}\" ]; then\n         # Record name of installed distribution name for uninstallation.\n```\nIt still says:\n\n```\n[sage_setup-9.5.beta2] sage-setup is already installed with the same version as the provided wheel. Use --force-reinstall to force an installation of the wheel.\n```",
    "created_at": "2021-10-10T02:30:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650655",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>
Also another approach, providing a `--hash` (via a requirements file) fails.

```diff
diff --git a/build/bin/sage-dist-helpers b/build/bin/sage-dist-helpers
index 4a8862d50f..e7b8fc8677 100644
--- a/build/bin/sage-dist-helpers
+++ b/build/bin/sage-dist-helpers
@@ -271,7 +271,20 @@ sdh_store_wheel() {
     mkdir -p "${SAGE_DESTDIR}${SAGE_SPKG_WHEELS}" && \
         $sudo mv "$wheel" "${SAGE_DESTDIR}${SAGE_SPKG_WHEELS}/" || \
         sdh_die "Error storing $wheel"
+    wheel_basename="${wheel##*/}"
     wheel="${SAGE_DESTDIR}${SAGE_SPKG_WHEELS}/${wheel##*/}"
+    # Trac #32659: pip no longer reinstalls local wheels if the version is the same.
+    # Because neither (1) applying patches nor (2) local changes (in the case
+    # of sage-conf, sage-setup, etc.) bump the version number, we need to
+    # override this behavior.  The pip install option --force-reinstall does too
+    # much -- it also reinstalls all dependencies, which we do not want.
+    # We override it by specifying the hash -- but this can only be done using a
+    # requirements file, not using flags on the command line,
+    # https://github.com/pypa/pip/issues/3257
+    distname="${wheel_basename%%-*}"
+    hasharg=$(python3 -m pip hash "$wheel" | sed -n /--hash=/p)
+    requirements_file="${SAGE_DESTDIR}${SAGE_SPKG_WHEELS}/requirements-$distname.txt"
+    echo "$distname @ file://$wheel $hasharg" | $sudo tee $requirements_file > /dev/null
 }
 
 sdh_store_and_pip_install_wheel() {
@@ -306,7 +319,7 @@ sdh_store_and_pip_install_wheel() {
         local sudo=""
         local root=""
     fi
-    $sudo sage-pip-install $root $pip_options "$wheel" || \
+    $sudo sage-pip-install $root $pip_options -v -v -v -r "$requirements_file" || \
         sdh_die "Error installing ${wheel##*/}"
     if [ -n "${SAGE_PKG_DIR}" ]; then
         # Record name of installed distribution name for uninstallation.
```
It still says:

```
[sage_setup-9.5.beta2] sage-setup is already installed with the same version as the provided wheel. Use --force-reinstall to force an installation of the wheel.
```



---

archive/issue_comments_650656.json:
```json
{
    "body": "<a id='comment:9'></a>\nI think we will need either https://github.com/pypa/pip/pull/10564 (and use `--upgrade` with `pip install`); or go back to `pip uninstall` before `pip install` (a simple version of what was removed in #31816).",
    "created_at": "2021-10-10T04:03:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650656",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>
I think we will need either https://github.com/pypa/pip/pull/10564 (and use `--upgrade` with `pip install`); or go back to `pip uninstall` before `pip install` (a simple version of what was removed in #31816).



---

archive/issue_comments_650657.json:
```json
{
    "body": "Changing commit from \"9c620c49a89714c5e10cb54126cf59ab782d458d\" to \"b5a89ad82614300cef196fb0d4eed4a07a591235\"",
    "created_at": "2021-10-10T04:26:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650657",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "9c620c49a89714c5e10cb54126cf59ab782d458d" to "b5a89ad82614300cef196fb0d4eed4a07a591235"



---

archive/issue_comments_650658.json:
```json
{
    "body": "<a id='comment:10'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                                                                                                   |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------|\n|[2d852ad](https://git.sagemath.org/sage.git/commit/?id=2d852ad84c878ec529300db0e2825f1460b2e0bc)|`build/bin/sage-dist-helpers (sdh_pip_uninstall): Use build/bin/sage-pip-uninstall, resurrected in simplified form`|\n|[b5a89ad](https://git.sagemath.org/sage.git/commit/?id=b5a89ad82614300cef196fb0d4eed4a07a591235)|`build/bin/sage-dist-helpers (sdh_store_and_pip_install_wheel): Uninstall before installing, to ensure the wheel is installed even if the version is the same`|",
    "created_at": "2021-10-10T04:26:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650658",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                                                                                                   |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------|
|[2d852ad](https://git.sagemath.org/sage.git/commit/?id=2d852ad84c878ec529300db0e2825f1460b2e0bc)|`build/bin/sage-dist-helpers (sdh_pip_uninstall): Use build/bin/sage-pip-uninstall, resurrected in simplified form`|
|[b5a89ad](https://git.sagemath.org/sage.git/commit/?id=b5a89ad82614300cef196fb0d4eed4a07a591235)|`build/bin/sage-dist-helpers (sdh_store_and_pip_install_wheel): Uninstall before installing, to ensure the wheel is installed even if the version is the same`|



---

archive/issue_comments_650659.json:
```json
{
    "body": "Changing commit from \"b5a89ad82614300cef196fb0d4eed4a07a591235\" to \"30a272e613ecf63b12702bc7fa1d630f2502ce83\"",
    "created_at": "2021-10-10T04:27:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650659",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "b5a89ad82614300cef196fb0d4eed4a07a591235" to "30a272e613ecf63b12702bc7fa1d630f2502ce83"



---

archive/issue_comments_650660.json:
```json
{
    "body": "<a id='comment:11'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                           |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------|\n|[30a272e](https://git.sagemath.org/sage.git/commit/?id=30a272e613ecf63b12702bc7fa1d630f2502ce83)|`build/pkgs/sage_setup/dependencies: Add interpreter specs as dependencies`|",
    "created_at": "2021-10-10T04:27:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650660",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                           |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------|
|[30a272e](https://git.sagemath.org/sage.git/commit/?id=30a272e613ecf63b12702bc7fa1d630f2502ce83)|`build/pkgs/sage_setup/dependencies: Add interpreter specs as dependencies`|



---

archive/issue_comments_650661.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2021-10-10T04:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650661",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_comments_650662.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-10-10T04:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650662",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_650663.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -7,4 +7,6 @@\n \n However, as discussed in https://github.com/pypa/pip/issues/8711, the `pip install` option `--force-reinstall` does too much -- it also reinstalls all dependencies, which we definitely do not want.\n \n+Instead, we just use `pip uninstall` before `pip install`.\n \n+We also add some dependencies on source files to `sage_setup`. This is also for #32607.\n``````\n",
    "created_at": "2021-10-10T04:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650663",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -7,4 +7,6 @@
 
 However, as discussed in https://github.com/pypa/pip/issues/8711, the `pip install` option `--force-reinstall` does too much -- it also reinstalls all dependencies, which we definitely do not want.
 
+Instead, we just use `pip uninstall` before `pip install`.
 
+We also add some dependencies on source files to `sage_setup`. This is also for #32607.
``````




---

archive/issue_comments_650664.json:
```json
{
    "body": "<a id='comment:14'></a>\nA new pip version is out (#32671); it makes some changes closely related to this issue but does not solve anything.\n\nNeeds review",
    "created_at": "2021-10-12T02:05:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650664",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>
A new pip version is out (#32671); it makes some changes closely related to this issue but does not solve anything.

Needs review



---

archive/issue_comments_650665.json:
```json
{
    "body": "<a id='comment:15'></a>\nIs it intended that `sdh_store_and_pip_install_wheel` invokes `python3 -m pip uninstall` rather than `sage-pip-uninstall`?",
    "created_at": "2021-10-18T03:36:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650665",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:15'></a>
Is it intended that `sdh_store_and_pip_install_wheel` invokes `python3 -m pip uninstall` rather than `sage-pip-uninstall`?



---

archive/issue_comments_650666.json:
```json
{
    "body": "Changing commit from \"30a272e613ecf63b12702bc7fa1d630f2502ce83\" to \"d4357816318a05645edfd169c6f2b08108074fb1\"",
    "created_at": "2021-10-18T03:51:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650666",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "30a272e613ecf63b12702bc7fa1d630f2502ce83" to "d4357816318a05645edfd169c6f2b08108074fb1"



---

archive/issue_comments_650667.json:
```json
{
    "body": "<a id='comment:16'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                       |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------|\n|[d435781](https://git.sagemath.org/sage.git/commit/?id=d4357816318a05645edfd169c6f2b08108074fb1)|`build/bin/sage-dist-helpers (sdh_store_and_pip_install_wheel): Use sage-pip-uninstall`|",
    "created_at": "2021-10-18T03:51:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650667",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                       |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------|
|[d435781](https://git.sagemath.org/sage.git/commit/?id=d4357816318a05645edfd169c6f2b08108074fb1)|`build/bin/sage-dist-helpers (sdh_store_and_pip_install_wheel): Use sage-pip-uninstall`|



---

archive/issue_comments_650668.json:
```json
{
    "body": "<a id='comment:17'></a>\nLooks like I introduced `sage-pip-uninstall` to avoid a duplication but then forgot to use it in one of the two cases",
    "created_at": "2021-10-18T03:52:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650668",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>
Looks like I introduced `sage-pip-uninstall` to avoid a duplication but then forgot to use it in one of the two cases



---

archive/issue_comments_650669.json:
```json
{
    "body": "<a id='comment:18'></a>\nThanks, looks good to me.",
    "created_at": "2021-10-18T10:54:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650669",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:18'></a>
Thanks, looks good to me.



---

archive/issue_comments_650670.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Lorenz Panny\"",
    "created_at": "2021-10-18T10:54:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650670",
    "user": "https://github.com/yyyyx4"
}
```

Changing reviewer from "" to "Lorenz Panny"



---

archive/issue_comments_650671.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-10-18T10:54:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650671",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_650672.json:
```json
{
    "body": "<a id='comment:19'></a>\nThanks for reviewing!",
    "created_at": "2021-10-18T16:09:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650672",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'></a>
Thanks for reviewing!



---

archive/issue_comments_650673.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-10-20T23:01:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650673",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_086495.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-10-20T23:01:04Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32659#event-86495"
}
```



---

archive/issue_comments_650674.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/sdh_pip_install__force_reinstallation_of_built_wheels\" to \"d4357816318a05645edfd169c6f2b08108074fb1\"",
    "created_at": "2021-10-20T23:01:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650674",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mkoeppe/sdh_pip_install__force_reinstallation_of_built_wheels" to "d4357816318a05645edfd169c6f2b08108074fb1"



---

archive/issue_comments_650675.json:
```json
{
    "body": "Changing commit from \"d4357816318a05645edfd169c6f2b08108074fb1\" to \"\"",
    "created_at": "2022-09-30T21:29:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650675",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "d4357816318a05645edfd169c6f2b08108074fb1" to ""



---

archive/issue_comments_650676.json:
```json
{
    "body": "Replying to [ticket:32659 Matthias K\u00f6ppe]:\n> However, as discussed in https://github.com/pypa/pip/issues/8711, the `pip install` option `--force-reinstall` does too much -- it also reinstalls all dependencies, which we definitely do not want.\n\n\nThis discussion is still ongoing and has moved to https://github.com/pypa/pip/pull/10564 (most recent activity: June 2022)",
    "created_at": "2022-09-30T21:29:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32659",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32659#issuecomment-650676",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [ticket:32659 Matthias Köppe]:
> However, as discussed in https://github.com/pypa/pip/issues/8711, the `pip install` option `--force-reinstall` does too much -- it also reinstalls all dependencies, which we definitely do not want.


This discussion is still ongoing and has moved to https://github.com/pypa/pip/pull/10564 (most recent activity: June 2022)
