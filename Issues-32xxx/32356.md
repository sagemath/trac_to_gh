# Issue 32356: enhance conversion of piecewise functions to giac

archive/issues_032119.json:
```json
{
    "body": "alas, the backward conversion is more complicated, because we lack a symbolic AND function\n\nBranch/Commit: [1fe11ebe81dc4b399b975b048e89aa58a2689f98](https://github.com/sagemath/sagetrac-mirror/commit/1fe11ebe81dc4b399b975b048e89aa58a2689f98)\n\nReviewer: Matthias Koeppe\n\nAuthor: Fr\u00e9d\u00e9ric Chapoton\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32356\n\n",
    "closed_at": "2021-09-07T20:52:13Z",
    "created_at": "2021-08-10T09:58:36Z",
    "labels": [
        "component: calculus"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "enhance conversion of piecewise functions to giac",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32356",
    "user": "https://github.com/fchapoton"
}
```
alas, the backward conversion is more complicated, because we lack a symbolic AND function

Branch/Commit: [1fe11ebe81dc4b399b975b048e89aa58a2689f98](https://github.com/sagemath/sagetrac-mirror/commit/1fe11ebe81dc4b399b975b048e89aa58a2689f98)

Reviewer: Matthias Koeppe

Author: Frédéric Chapoton

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/32356





---

archive/issue_comments_644363.json:
```json
{
    "body": "Changing branch from \"\" to \"u/chapoton/32356\"",
    "created_at": "2021-08-10T09:59:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32356#issuecomment-644363",
    "user": "https://github.com/fchapoton"
}
```

Changing branch from "" to "u/chapoton/32356"



---

archive/issue_comments_644364.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-08-10T09:59:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32356#issuecomment-644364",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_644365.json:
```json
{
    "body": "Changing commit from \"\" to \"8f577a5f77cd74eb5ceb765ad28506e1a280cab6\"",
    "created_at": "2021-08-10T09:59:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32356#issuecomment-644365",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "" to "8f577a5f77cd74eb5ceb765ad28506e1a280cab6"



---

archive/issue_comments_644366.json:
```json
{
    "body": "<a id='comment:2'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                   |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|\n|[8f577a5](https://github.com/sagemath/sagetrac-mirror/commit/8f577a5f77cd74eb5ceb765ad28506e1a280cab6)|`enhance conversion of piecewise functions to giac`|",
    "created_at": "2021-08-10T09:59:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32356#issuecomment-644366",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                   |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|
|[8f577a5](https://github.com/sagemath/sagetrac-mirror/commit/8f577a5f77cd74eb5ceb765ad28506e1a280cab6)|`enhance conversion of piecewise functions to giac`|



---

archive/issue_events_096541.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-10T17:30:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32356",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32356#event-96541"
}
```



---

archive/issue_comments_644367.json:
```json
{
    "body": "Replying to [ticket:32356 chapoton]:\n> alas, the backward conversion is more complicated, because we lack a symbolic AND function\n... more precisely because our piecewise functions only accept `RealSet` as domains for the pieces, not arbitrary sets...",
    "created_at": "2021-08-10T17:41:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32356#issuecomment-644367",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [ticket:32356 chapoton]:
> alas, the backward conversion is more complicated, because we lack a symbolic AND function
... more precisely because our piecewise functions only accept `RealSet` as domains for the pieces, not arbitrary sets...



---

archive/issue_comments_644368.json:
```json
{
    "body": "Changing commit from \"8f577a5f77cd74eb5ceb765ad28506e1a280cab6\" to \"1fe11ebe81dc4b399b975b048e89aa58a2689f98\"",
    "created_at": "2021-08-12T19:42:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32356#issuecomment-644368",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "8f577a5f77cd74eb5ceb765ad28506e1a280cab6" to "1fe11ebe81dc4b399b975b048e89aa58a2689f98"



---

archive/issue_comments_644369.json:
```json
{
    "body": "<a id='comment:5'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                      |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------|\n|[1fe11eb](https://github.com/sagemath/sagetrac-mirror/commit/1fe11ebe81dc4b399b975b048e89aa58a2689f98)|`fix pyflakes warning`|",
    "created_at": "2021-08-12T19:42:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32356#issuecomment-644369",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                      |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------|
|[1fe11eb](https://github.com/sagemath/sagetrac-mirror/commit/1fe11ebe81dc4b399b975b048e89aa58a2689f98)|`fix pyflakes warning`|



---

archive/issue_comments_644370.json:
```json
{
    "body": "<a id='comment:6'></a>\nDo you know what condition expressions can occur in giac piecewise?",
    "created_at": "2021-08-12T20:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32356#issuecomment-644370",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>
Do you know what condition expressions can occur in giac piecewise?



---

archive/issue_comments_644371.json:
```json
{
    "body": "<a id='comment:7'></a>\nWe could start by converting back conditions coming from sage. They take the typical form \"x > 0 and x < 4\". The connector \"**and**\" is not recognized by our symbolic ring parser.\n\nHere is an example:\n\n```\nsage: S = RealSet([0,4])                                                          \nsage: S._giac_condition_(x)                                                     \n'((0 <= sageVARx) and (sageVARx <= 4))'\nsage: giac(S._giac_condition_(x))                                               \n((sageVARx>=0) and (4>=sageVARx))\n```\nand a more general one, with **or**:\n\n```\nsage: S = RealSet([0,4],[6,9])                                                    \nsage: S._giac_condition_(x)                                                     \n'((0 <= sageVARx) and (sageVARx <= 4)) or ((6 <= sageVARx) and (sageVARx <= 9))'\nsage: giac(_)                                                                   \n((((sageVARx>=0) and (4>=sageVARx))) or (((sageVARx>=6) and (9>=sageVARx))))\n```",
    "created_at": "2021-08-13T07:06:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32356#issuecomment-644371",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:7'></a>
We could start by converting back conditions coming from sage. They take the typical form "x > 0 and x < 4". The connector "**and**" is not recognized by our symbolic ring parser.

Here is an example:

```
sage: S = RealSet([0,4])                                                          
sage: S._giac_condition_(x)                                                     
'((0 <= sageVARx) and (sageVARx <= 4))'
sage: giac(S._giac_condition_(x))                                               
((sageVARx>=0) and (4>=sageVARx))
```
and a more general one, with **or**:

```
sage: S = RealSet([0,4],[6,9])                                                    
sage: S._giac_condition_(x)                                                     
'((0 <= sageVARx) and (sageVARx <= 4)) or ((6 <= sageVARx) and (sageVARx <= 9))'
sage: giac(_)                                                                   
((((sageVARx>=0) and (4>=sageVARx))) or (((sageVARx>=6) and (9>=sageVARx))))
```



---

archive/issue_comments_644372.json:
```json
{
    "body": "<a id='comment:8'></a>\nWith #31911:\n\n```\nsage: g = giac('((0 <= sageVARx) and (sageVARx <= 4))')                                                                                                                      \nsage: g._sage_()                                                                                                                                                             \nand_symbolic(x >= 0, 4 >= x)\n```",
    "created_at": "2021-08-14T03:11:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32356#issuecomment-644372",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>
With #31911:

```
sage: g = giac('((0 <= sageVARx) and (sageVARx <= 4))')                                                                                                                      
sage: g._sage_()                                                                                                                                                             
and_symbolic(x >= 0, 4 >= x)
```



---

archive/issue_comments_644373.json:
```json
{
    "body": "<a id='comment:9'></a>\nAnd:\n\n```\nsage: g = giac('((0 <= sageVARx) and (sageVARx <= 4)) or ((6 <= sageVARx) and (sageVARx <= 9))')                                                                             \nsage: g._sage_()                                                                                                                                                             \nor_symbolic(and_symbolic(x >= 0, 4 >= x), and_symbolic(x >= 6, 9 >= x))\n```",
    "created_at": "2021-08-14T03:38:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32356#issuecomment-644373",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>
And:

```
sage: g = giac('((0 <= sageVARx) and (sageVARx <= 4)) or ((6 <= sageVARx) and (sageVARx <= 9))')                                                                             
sage: g._sage_()                                                                                                                                                             
or_symbolic(and_symbolic(x >= 0, 4 >= x), and_symbolic(x >= 6, 9 >= x))
```



---

archive/issue_comments_644374.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-08-14T05:01:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32356#issuecomment-644374",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_644375.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Matthias Koeppe\"",
    "created_at": "2021-08-14T05:01:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32356#issuecomment-644375",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "Matthias Koeppe"



---

archive/issue_comments_644376.json:
```json
{
    "body": "<a id='comment:11'></a>\nNitpicking suggestions, feel free to ignore.\n\nApply pep8 spacing in examples to promote good habits:\n\n```diff\n-                sage: integral(ex,x,0,100,algorithm='giac')\n+                sage: integral(ex, x, 0, 100, algorithm='giac')\n                 199/100\n-                sage: integral(ex,x,algorithm='giac')\n+                sage: integral(ex, x, algorithm='giac')\n+                piecewise(x|-->x on [0, 1], x|-->-1/x + 2 on (1, +oo); x)\n```\n\n```diff\n-            sage: RealSet((0,1), [2,3])._giac_condition_(x)\n+            sage: RealSet((0, 1), [2, 3])._giac_condition_(x)\n```\n\n```diff\n-            sage: RealSet(6,6)._giac_condition_(x)\n+            sage: RealSet(6, 6)._giac_condition_(x)\n             'false'\n-            sage: RealSet([6,6])._giac_condition_(x)\n+            sage: RealSet([6, 6])._giac_condition_(x)\n             'sageVARx == 6'\n```\n\nNo need to wrap if we stay under the 80 character limit:\n\n```diff\n-            args = [(domain._giac_condition_(variable),\n-                     func._giac_init_())\n+            args = [(domain._giac_condition_(variable), func._giac_init_())\n                     for domain, func in parameters]\n```\n\n```diff\n+        return ' or '.join(it._giac_condition_(x)\n+                           for it in self._intervals)\n+        return ' or '.join(it._giac_condition_(x) for it in self._intervals)\n```\n\nUse f-strings:\n\n```diff\n+        return \"((\" + lower_condition + \") and (\" + upper_condition + \"))\"\n+        return f\"(({lower_condition}) and ({upper_condition}))\"\n```",
    "created_at": "2021-08-15T09:04:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32356#issuecomment-644376",
    "user": "https://github.com/slel"
}
```

<a id='comment:11'></a>
Nitpicking suggestions, feel free to ignore.

Apply pep8 spacing in examples to promote good habits:

```diff
-                sage: integral(ex,x,0,100,algorithm='giac')
+                sage: integral(ex, x, 0, 100, algorithm='giac')
                 199/100
-                sage: integral(ex,x,algorithm='giac')
+                sage: integral(ex, x, algorithm='giac')
+                piecewise(x|-->x on [0, 1], x|-->-1/x + 2 on (1, +oo); x)
```

```diff
-            sage: RealSet((0,1), [2,3])._giac_condition_(x)
+            sage: RealSet((0, 1), [2, 3])._giac_condition_(x)
```

```diff
-            sage: RealSet(6,6)._giac_condition_(x)
+            sage: RealSet(6, 6)._giac_condition_(x)
             'false'
-            sage: RealSet([6,6])._giac_condition_(x)
+            sage: RealSet([6, 6])._giac_condition_(x)
             'sageVARx == 6'
```

No need to wrap if we stay under the 80 character limit:

```diff
-            args = [(domain._giac_condition_(variable),
-                     func._giac_init_())
+            args = [(domain._giac_condition_(variable), func._giac_init_())
                     for domain, func in parameters]
```

```diff
+        return ' or '.join(it._giac_condition_(x)
+                           for it in self._intervals)
+        return ' or '.join(it._giac_condition_(x) for it in self._intervals)
```

Use f-strings:

```diff
+        return "((" + lower_condition + ") and (" + upper_condition + "))"
+        return f"(({lower_condition}) and ({upper_condition}))"
```



---

archive/issue_comments_644377.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-09-07T20:52:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32356#issuecomment-644377",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_644378.json:
```json
{
    "body": "Changing branch from \"u/chapoton/32356\" to \"1fe11ebe81dc4b399b975b048e89aa58a2689f98\"",
    "created_at": "2021-09-07T20:52:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32356",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32356#issuecomment-644378",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/chapoton/32356" to "1fe11ebe81dc4b399b975b048e89aa58a2689f98"



---

archive/issue_events_096542.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-09-07T20:52:13Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32356",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32356#event-96542"
}
```
