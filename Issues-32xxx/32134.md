# Issue 32134: Fix order of characters in modular/local_comp/local_comp.py doctests

archive/issues_031897.json:
```json
{
    "body": "CC:  @dimpase @kliem @slel\n\nThis doctest in `src/sage/modular/local_comp/local_comp.py`\nfails on several patchbots:\n\n```\nsage -t --long --random-seed=0 src/sage/modular/local_comp/local_comp.py\n**********************************************************************\nFile \"src/sage/modular/local_comp/local_comp.py\", line 653, in sage.modular.local_comp.local_comp.PrimitiveSupercuspidal.characters\nFailed example:\n    set(Pi.characters())\nExpected:\n    {Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> 1/3*j0^2*d - 1/3*j0^3, 5 |--> 5,\n     Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> -1/3*j0^2*d, 5 |--> 5}\nGot:\n    {Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> -1/3*j0^2*d, 5 |--> 5,\n     Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> 1/3*j0^2*d - 1/3*j0^3, 5 |--> 5}\n**********************************************************************\n```\n\nTicket #29977 provides a hotfix.\nHere we aim for a better fix.\n\nThe test used to display `Pi.characters()`,\nof type `Sequence`, directly.\n\nThe display order for the two characters in this\nexample changed, possibly due to a change in PARI.\n\nThe example was changed in #30801 to use Python sets\nin an attempt to fix the display order, but that\nfailed and patchbots kept failing on that.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32134\n\n",
    "closed_at": "2021-08-29T09:38:17Z",
    "created_at": "2021-07-05T14:05:14Z",
    "labels": [
        "component: doctest framework",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Fix order of characters in modular/local_comp/local_comp.py doctests",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32134",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```
CC:  @dimpase @kliem @slel

This doctest in `src/sage/modular/local_comp/local_comp.py`
fails on several patchbots:

```
sage -t --long --random-seed=0 src/sage/modular/local_comp/local_comp.py
**********************************************************************
File "src/sage/modular/local_comp/local_comp.py", line 653, in sage.modular.local_comp.local_comp.PrimitiveSupercuspidal.characters
Failed example:
    set(Pi.characters())
Expected:
    {Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> 1/3*j0^2*d - 1/3*j0^3, 5 |--> 5,
     Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> -1/3*j0^2*d, 5 |--> 5}
Got:
    {Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> -1/3*j0^2*d, 5 |--> 5,
     Character of unramified extension Q_5(s)* (s^2 + 4*s + 2 = 0), of level 1, mapping s |--> 1/3*j0^2*d - 1/3*j0^3, 5 |--> 5}
**********************************************************************
```

Ticket #29977 provides a hotfix.
Here we aim for a better fix.

The test used to display `Pi.characters()`,
of type `Sequence`, directly.

The display order for the two characters in this
example changed, possibly due to a change in PARI.

The example was changed in #30801 to use Python sets
in an attempt to fix the display order, but that
failed and patchbots kept failing on that.


Issue created by migration from https://trac.sagemath.org/ticket/32134





---

archive/issue_comments_455200.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-07-05T14:10:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455200",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

New commits:



---

archive/issue_comments_455201.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-07-05T14:10:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455201",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_455202.json:
```json
{
    "body": "see #29977",
    "created_at": "2021-07-05T15:40:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455202",
    "user": "https://github.com/fchapoton"
}
```

see #29977



---

archive/issue_comments_455203.json:
```json
{
    "body": "Replying to [comment:3 chapoton]:\n> see #29977\n\n\nI created this ticket because that particular issue has no link with random seeds, which is the purpose of #29977, see the comment ticket:29977#comment:28",
    "created_at": "2021-07-05T16:04:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455203",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Replying to [comment:3 chapoton]:
> see #29977


I created this ticket because that particular issue has no link with random seeds, which is the purpose of #29977, see the comment ticket:29977#comment:28



---

archive/issue_comments_455204.json:
```json
{
    "body": "The \"set\" were added very recently in #30801",
    "created_at": "2021-07-05T16:19:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455204",
    "user": "https://github.com/fchapoton"
}
```

The "set" were added very recently in #30801



---

archive/issue_comments_455205.json:
```json
{
    "body": "Btw, you don't use lists:\n\n```\nsage: f = Newforms(GammaH(25, [6]), 3, names='j')[0]                            \nsage: Pi = LocalComponent(f, 5)                                                 \nsage: type(Pi.characters())                                                     \n<class 'sage.structure.sequence.Sequence_generic'>\n```",
    "created_at": "2021-07-05T16:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455205",
    "user": "https://github.com/kliem"
}
```

Btw, you don't use lists:

```
sage: f = Newforms(GammaH(25, [6]), 3, names='j')[0]                            
sage: Pi = LocalComponent(f, 5)                                                 
sage: type(Pi.characters())                                                     
<class 'sage.structure.sequence.Sequence_generic'>
```



---

archive/issue_comments_455206.json:
```json
{
    "body": "Why is replacing one apparently unstable order with another apparently unstable order a good fix?\nI didn't add `set()` just for fun in #30801.",
    "created_at": "2021-07-06T09:59:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455206",
    "user": "https://github.com/dimpase"
}
```

Why is replacing one apparently unstable order with another apparently unstable order a good fix?
I didn't add `set()` just for fun in #30801.



---

archive/issue_comments_455207.json:
```json
{
    "body": "That is exactly why I didn't want to put it on positive review. I would really prefer `sorted` with `key=str`. That appears to be stable and if we think it's not pretty, we can figure out something nicer later.",
    "created_at": "2021-07-06T10:14:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455207",
    "user": "https://github.com/kliem"
}
```

That is exactly why I didn't want to put it on positive review. I would really prefer `sorted` with `key=str`. That appears to be stable and if we think it's not pretty, we can figure out something nicer later.



---

archive/issue_comments_455208.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-07-06T10:14:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455208",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_455209.json:
```json
{
    "body": "Replying to [comment:8 gh-kliem]:\n> I would really prefer `sorted` with `key=str`.\n\n+1",
    "created_at": "2021-07-06T13:00:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455209",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:8 gh-kliem]:
> I would really prefer `sorted` with `key=str`.

+1



---

archive/issue_comments_455210.json:
```json
{
    "body": "I would also vote for a hotfix using the order given\nby string representations.\n\nThen we can calmly investigate what causes the different\ndisplay order, and find a nicer fix.",
    "created_at": "2021-07-06T13:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455210",
    "user": "https://github.com/slel"
}
```

I would also vote for a hotfix using the order given
by string representations.

Then we can calmly investigate what causes the different
display order, and find a nicer fix.



---

archive/issue_comments_455211.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-07-06T13:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455211",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_455212.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-07-06T13:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455212",
    "user": "https://github.com/kliem"
}
```

Changing priority from major to critical.



---

archive/issue_comments_455213.json:
```json
{
    "body": "Moving this up to critical, as the issue reduces patchbot capacity by 50 percent and slows down review process of all tickets.\n\n---\nNew commits:",
    "created_at": "2021-07-06T13:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455213",
    "user": "https://github.com/kliem"
}
```

Moving this up to critical, as the issue reduces patchbot capacity by 50 percent and slows down review process of all tickets.

---
New commits:



---

archive/issue_comments_455214.json:
```json
{
    "body": "this is in part collides with #29977",
    "created_at": "2021-07-06T14:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455214",
    "user": "https://github.com/dimpase"
}
```

this is in part collides with #29977



---

archive/issue_comments_455215.json:
```json
{
    "body": "Replying to [comment:6 gh-kliem]:\n> Btw, you don't use lists:\n> \n> \n> ```\n> sage: f = Newforms(GammaH(25, [6]), 3, names='j')[0]                            \n> sage: Pi = LocalComponent(f, 5)                                                 \n> sage: type(Pi.characters())                                                     \n> <class 'sage.structure.sequence.Sequence_generic'>\n> ```\n\n\nIndeed.\n\nReplying to [comment:7 dimpase]:\n> Why is replacing one apparently unstable order with another apparently unstable order a good fix?\n> I didn't add `set()` just for fun in #30801.\n\n\nI was asking the same question, but I did not see any evidence (i might have missed something though). If the raw use of `Pi.characters()` is only *apparently* unstable, then i am not in favor to work around it, which is why i asked, otherwise we might end up sorting every Sage doctest. If there is a configuration that does not provide that order, which one it is ? If this is about the 32 vs 64 bit architecture, then why not specify it with two dedicated doctests ?\n\nReplying to [comment:11 slelievre]:\n> I would also vote for a hotfix using the order given\n> by string representations.\n> \n> Then we can calmly investigate what causes the different\n> display order, and find a nicer fix.\n\n\nOK, then could you please all try the [straightforward branch](https://git.sagemath.org/sage.git/log/?h=u/tmonteil/doctests_in_src_sage_modular_local_comp_local_comp_py_make_patchbots_fail) and tell if is passes on your various computers, so that we could see whether it can break and understand the cause (for example, it seems not related to the choice of the random seed).",
    "created_at": "2021-07-06T14:25:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455215",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Replying to [comment:6 gh-kliem]:
> Btw, you don't use lists:
> 
> 
> ```
> sage: f = Newforms(GammaH(25, [6]), 3, names='j')[0]                            
> sage: Pi = LocalComponent(f, 5)                                                 
> sage: type(Pi.characters())                                                     
> <class 'sage.structure.sequence.Sequence_generic'>
> ```


Indeed.

Replying to [comment:7 dimpase]:
> Why is replacing one apparently unstable order with another apparently unstable order a good fix?
> I didn't add `set()` just for fun in #30801.


I was asking the same question, but I did not see any evidence (i might have missed something though). If the raw use of `Pi.characters()` is only *apparently* unstable, then i am not in favor to work around it, which is why i asked, otherwise we might end up sorting every Sage doctest. If there is a configuration that does not provide that order, which one it is ? If this is about the 32 vs 64 bit architecture, then why not specify it with two dedicated doctests ?

Replying to [comment:11 slelievre]:
> I would also vote for a hotfix using the order given
> by string representations.
> 
> Then we can calmly investigate what causes the different
> display order, and find a nicer fix.


OK, then could you please all try the [straightforward branch](https://git.sagemath.org/sage.git/log/?h=u/tmonteil/doctests_in_src_sage_modular_local_comp_local_comp_py_make_patchbots_fail) and tell if is passes on your various computers, so that we could see whether it can break and understand the cause (for example, it seems not related to the choice of the random seed).



---

archive/issue_comments_455216.json:
```json
{
    "body": "Replying to [comment:14 tmonteil]:\n> Replying to [comment:6 gh-kliem]:\n> > Btw, you don't use lists:\n> > \n> > \n> > ```\n> > sage: f = Newforms(GammaH(25, [6]), 3, names='j')[0]                            \n> > sage: Pi = LocalComponent(f, 5)                                                 \n> > sage: type(Pi.characters())                                                     \n> > <class 'sage.structure.sequence.Sequence_generic'>\n> > ```\n\n> \n> Indeed.\n> \n> Replying to [comment:7 dimpase]:\n> > Why is replacing one apparently unstable order with another apparently unstable order a good fix?\n> > I didn't add `set()` just for fun in #30801.\n\n> \n> I was asking the same question, but I did not see any evidence (i might have missed something though). If the raw use of `Pi.characters()` is only *apparently* unstable, then i am not in favor to work around it, which is why i asked, otherwise we might end up sorting every Sage doctest. If there is a configuration that does not provide that order, which one it is ? If this is about the 32 vs 64 bit architecture, then why not specify it with two dedicated doctests ?\n> \n> Replying to [comment:11 slelievre]:\n> > I would also vote for a hotfix using the order given\n> > by string representations.\n> > \n> > Then we can calmly investigate what causes the different\n> > display order, and find a nicer fix.\n\n> \n> OK, then could you please all try the [straightforward branch](https://git.sagemath.org/sage.git/log/?h=u/tmonteil/doctests_in_src_sage_modular_local_comp_local_comp_py_make_patchbots_fail) and tell if is passes on your various computers, so that we could see whether it can break and understand the cause (for example, it seems not related to the choice of the random seed).\n\n\nhttps://github.com/kliem/sage/pull/47/checks\n\nAs #29977 is now positively review, we can now also go back to your branch and see whether this works.",
    "created_at": "2021-07-06T14:45:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455216",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:14 tmonteil]:
> Replying to [comment:6 gh-kliem]:
> > Btw, you don't use lists:
> > 
> > 
> > ```
> > sage: f = Newforms(GammaH(25, [6]), 3, names='j')[0]                            
> > sage: Pi = LocalComponent(f, 5)                                                 
> > sage: type(Pi.characters())                                                     
> > <class 'sage.structure.sequence.Sequence_generic'>
> > ```

> 
> Indeed.
> 
> Replying to [comment:7 dimpase]:
> > Why is replacing one apparently unstable order with another apparently unstable order a good fix?
> > I didn't add `set()` just for fun in #30801.

> 
> I was asking the same question, but I did not see any evidence (i might have missed something though). If the raw use of `Pi.characters()` is only *apparently* unstable, then i am not in favor to work around it, which is why i asked, otherwise we might end up sorting every Sage doctest. If there is a configuration that does not provide that order, which one it is ? If this is about the 32 vs 64 bit architecture, then why not specify it with two dedicated doctests ?
> 
> Replying to [comment:11 slelievre]:
> > I would also vote for a hotfix using the order given
> > by string representations.
> > 
> > Then we can calmly investigate what causes the different
> > display order, and find a nicer fix.

> 
> OK, then could you please all try the [straightforward branch](https://git.sagemath.org/sage.git/log/?h=u/tmonteil/doctests_in_src_sage_modular_local_comp_local_comp_py_make_patchbots_fail) and tell if is passes on your various computers, so that we could see whether it can break and understand the cause (for example, it seems not related to the choice of the random seed).


https://github.com/kliem/sage/pull/47/checks

As #29977 is now positively review, we can now also go back to your branch and see whether this works.



---

archive/issue_comments_455217.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-07-29T11:52:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455217",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_455218.json:
```json
{
    "body": "Does this make bots happy?",
    "created_at": "2021-07-29T15:38:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455218",
    "user": "https://github.com/dimpase"
}
```

Does this make bots happy?



---

archive/issue_comments_455219.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-29T15:38:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455219",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_455220.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2021-07-29T15:48:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455220",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_455221.json:
```json
{
    "body": "Replying to [comment:18 dimpase]:\n> Does this make bots happy?\n\n\nI think we have to let 32bit bots to work on it. I will work on setting one up later in the summer. Let us keep this ticket to \"needs review\" so that bots can work on it.\n\nI encourage everybody to try this branch to see if something wrong appears.",
    "created_at": "2021-07-29T15:48:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455221",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Replying to [comment:18 dimpase]:
> Does this make bots happy?


I think we have to let 32bit bots to work on it. I will work on setting one up later in the summer. Let us keep this ticket to "needs review" so that bots can work on it.

I encourage everybody to try this branch to see if something wrong appears.



---

archive/issue_comments_455222.json:
```json
{
    "body": "it works on 32-bit too.",
    "created_at": "2021-08-14T20:04:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455222",
    "user": "https://github.com/dimpase"
}
```

it works on 32-bit too.



---

archive/issue_comments_455223.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-08-14T20:04:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455223",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_085065.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32134#event-85065"
}
```



---

archive/issue_comments_455224.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-08-29T09:38:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32134#issuecomment-455224",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_085066.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-08-29T09:38:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32134",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32134#event-85066"
}
```
