# Issue 32127: gosper_iterator of continued fractions is unstable

archive/issues_031890.json:
```json
{
    "assignees": [],
    "body": "\n```\nsage -t --long --random-seed=5058 src/sage/rings/continued_fraction_gosper.py\n**********************************************************************\nFile \"src/sage/rings/continued_fraction_gosper.py\", line 63, in sage.rings.continued_fraction_gosper.gosper_iterator.__init__\nFailed example:\n    continued_fraction((preperiod, period), x.value()) == continued_fraction((a*x.value()+b)/(c*x.value()+d))\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/lib/python3.9/site-packages/sage/doctest/forker.py\", line 714, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1133, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.rings.continued_fraction_gosper.gosper_iterator.__init__[8]>\", line 1, in <module>\n        continued_fraction((preperiod, period), x.value()) == continued_fraction((a*x.value()+b)/(c*x.value()+d))\n      File \"/usr/lib/python3.9/site-packages/sage/rings/continued_fraction.py\", line 2618, in continued_fraction\n        x1, x2 = check_and_reduce_pair(x1, x2)\n      File \"/usr/lib/python3.9/site-packages/sage/rings/continued_fraction.py\", line 2257, in check_and_reduce_pair\n        raise ValueError(\"the elements of the period cannot be negative\")\n    ValueError: the elements of the period cannot be negative\n```\nwhich comes from this example and apparently should not return negative values:\n\n```\nsage: a, b, c, d = 6, -9, -2, 3\nsage: from sage.rings.continued_fraction_gosper import gosper_iterator\nsage: x = continued_fraction(([1,2],[3,4])); i = iter(gosper_iterator(a,b,c,d,x))\nsage: list(i)\n[-3]\n```\nNote that `(6,-9) == -3 * (-2,3)`.\n\nIn #29979, a doctest was marked `not tested` because of this.\n\nCC:  @kliem @videlec\n\nComponent: **number theory**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/32127_\n\n",
    "created_at": "2021-07-04T15:02:19Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20number%20theory",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "gosper_iterator of continued fractions is unstable",
    "type": "issue",
    "updated_at": "2022-09-19T18:58:47Z",
    "url": "https://github.com/sagemath/sage/issues/32127",
    "user": "https://github.com/mwageringel"
}
```

```
sage -t --long --random-seed=5058 src/sage/rings/continued_fraction_gosper.py
**********************************************************************
File "src/sage/rings/continued_fraction_gosper.py", line 63, in sage.rings.continued_fraction_gosper.gosper_iterator.__init__
Failed example:
    continued_fraction((preperiod, period), x.value()) == continued_fraction((a*x.value()+b)/(c*x.value()+d))
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.continued_fraction_gosper.gosper_iterator.__init__[8]>", line 1, in <module>
        continued_fraction((preperiod, period), x.value()) == continued_fraction((a*x.value()+b)/(c*x.value()+d))
      File "/usr/lib/python3.9/site-packages/sage/rings/continued_fraction.py", line 2618, in continued_fraction
        x1, x2 = check_and_reduce_pair(x1, x2)
      File "/usr/lib/python3.9/site-packages/sage/rings/continued_fraction.py", line 2257, in check_and_reduce_pair
        raise ValueError("the elements of the period cannot be negative")
    ValueError: the elements of the period cannot be negative
```
which comes from this example and apparently should not return negative values:

```
sage: a, b, c, d = 6, -9, -2, 3
sage: from sage.rings.continued_fraction_gosper import gosper_iterator
sage: x = continued_fraction(([1,2],[3,4])); i = iter(gosper_iterator(a,b,c,d,x))
sage: list(i)
[-3]
```
Note that `(6,-9) == -3 * (-2,3)`.

In #29979, a doctest was marked `not tested` because of this.

CC:  @kliem @videlec

Component: **number theory**

_Issue created by migration from https://trac.sagemath.org/ticket/32127_





---

archive/issue_events_443127.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2021-07-04T15:02:19Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/32127",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32127#event-443127"
}
```



---

archive/issue_events_443128.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2021-07-04T15:02:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32127",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20number%20theory",
    "label_color": "0000ff",
    "label_name": "c: number theory",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32127#event-443128"
}
```



---

archive/issue_events_443129.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2021-07-04T15:02:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32127",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32127#event-443129"
}
```



---

archive/issue_events_443130.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2021-07-04T15:02:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32127",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32127#event-443130"
}
```



---

archive/issue_comments_517554.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nSee also [[#29979 comment:27](https://github.com/sagemath/sage/issues/29979#comment:27)].",
    "created_at": "2021-07-05T18:32:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32127#issuecomment-517554",
    "user": "https://github.com/mwageringel"
}
```

<div id="comment:1" align="right">comment:1</div>

See also [[#29979 comment:27](https://github.com/sagemath/sage/issues/29979#comment:27)].



---

archive/issue_events_443131.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:16:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/32127",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32127#event-443131"
}
```



---

archive/issue_events_443132.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:16:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/32127",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32127#event-443132"
}
```



---

archive/issue_comments_517555.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -30,3 +30,4 @@\n ```\n Note that `(6,-9) == -3 * (-2,3)`.\n \n+In #29979, a doctest was marked `not tested` because of this.\n``````\n",
    "created_at": "2021-09-05T08:04:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32127",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32127#issuecomment-517555",
    "user": "https://github.com/mwageringel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -30,3 +30,4 @@
 ```
 Note that `(6,-9) == -3 * (-2,3)`.
 
+In #29979, a doctest was marked `not tested` because of this.
``````




---

archive/issue_events_443133.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:11:26Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/32127",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32127#event-443133"
}
```



---

archive/issue_events_443134.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:11:26Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/32127",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32127#event-443134"
}
```



---

archive/issue_events_443135.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/32127",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32127#event-443135"
}
```



---

archive/issue_events_443136.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/32127",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32127#event-443136"
}
```



---

archive/issue_events_443137.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/32127",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32127#event-443137"
}
```



---

archive/issue_events_443138.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/32127",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32127#event-443138"
}
```
