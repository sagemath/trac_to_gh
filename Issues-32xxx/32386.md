# Issue 32386: Merge pynac sources as src/sage/symbolic/ginac

archive/issues_032149.json:
```json
{
    "body": "Pynac has a compile-time dependency on the Python library but is not installed using Python package infrastructure. This is problematic because Python users cannot install it using standard Python tools - for example for testing different Python versions.\n\nPynac has no other uses than as the core of the symbolic expressions facility of Sage; and cannot even be tested without Sage.\n\nWe merge Pynac (i.e., the directory https://github.com/pynac/pynac/tree/master/ginac) into the Sage library as `src/sage/symbolic/ginac`. It is not a very big package - one flat directory with 100 *.h and *.cpp files, a total of 50kLOC. (The existing !Python/Cython symbolics code in `sage.symbolic`, `sage.calculus`, `sage.functions` is about 60kLOC.)\n\nThe Pynac sources are compiled like other C++ sources that are already in the Sage source tree. They are linked into a single Python extension module, `sage.symbolic.expression`. All other extension modules that used to link to pynac (`sage.libs.pynac.pynac`, `sage.symbolic.function`, `sage.symbolic.series` etc.) are \n- either refactored so that they only `import` helper functions provided by `sage.symbolic.expression` instead of having to `cimport` Pynac functions directly (see #32391, #32407)\n- or merged into the extension module `sage.symbolic.expression` (via Cython `include` statements, not by copy-paste of source code, to keep the diff small)\n\nThis solves the same issues that #30534 tried to address, which ran into unresolved technical difficulties.\n\nIt will also make it easier for Sage developers to make changes to Pynac and the related symbolic implementation.\n\nFollow-up: #32387 Remove pynac spkg\n\n\nCC:  @kliem @kiwifb @antonio-rojas @davewittemorris @slel @dimpase @tscrim @egourgoulhon @nbruin\n\nReviewer: Dima Pasechnik\n\nAuthor: Matthias Koeppe, Jonathan Kliem\n\nBranch: 0d0b58f65c0ca01d51756798d6910efb5f26f47c\n\nDependencies: #32391, #32407, #32461\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32386\n\n",
    "closed_at": "2021-09-15T22:06:00Z",
    "created_at": "2021-08-16T17:27:13Z",
    "labels": [
        "component: symbolics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Merge pynac sources as src/sage/symbolic/ginac",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32386",
    "user": "https://github.com/mkoeppe"
}
```
Pynac has a compile-time dependency on the Python library but is not installed using Python package infrastructure. This is problematic because Python users cannot install it using standard Python tools - for example for testing different Python versions.

Pynac has no other uses than as the core of the symbolic expressions facility of Sage; and cannot even be tested without Sage.

We merge Pynac (i.e., the directory https://github.com/pynac/pynac/tree/master/ginac) into the Sage library as `src/sage/symbolic/ginac`. It is not a very big package - one flat directory with 100 *.h and *.cpp files, a total of 50kLOC. (The existing !Python/Cython symbolics code in `sage.symbolic`, `sage.calculus`, `sage.functions` is about 60kLOC.)

The Pynac sources are compiled like other C++ sources that are already in the Sage source tree. They are linked into a single Python extension module, `sage.symbolic.expression`. All other extension modules that used to link to pynac (`sage.libs.pynac.pynac`, `sage.symbolic.function`, `sage.symbolic.series` etc.) are 
- either refactored so that they only `import` helper functions provided by `sage.symbolic.expression` instead of having to `cimport` Pynac functions directly (see #32391, #32407)
- or merged into the extension module `sage.symbolic.expression` (via Cython `include` statements, not by copy-paste of source code, to keep the diff small)

This solves the same issues that #30534 tried to address, which ran into unresolved technical difficulties.

It will also make it easier for Sage developers to make changes to Pynac and the related symbolic implementation.

Follow-up: #32387 Remove pynac spkg


CC:  @kliem @kiwifb @antonio-rojas @davewittemorris @slel @dimpase @tscrim @egourgoulhon @nbruin

Reviewer: Dima Pasechnik

Author: Matthias Koeppe, Jonathan Kliem

Branch: 0d0b58f65c0ca01d51756798d6910efb5f26f47c

Dependencies: #32391, #32407, #32461

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/32386





---

archive/issue_comments_490213.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,11 +2,14 @@\n \n Pynac has no other uses than as the core of the symbolic expressions facility of Sage; and cannot even be tested without Sage.\n \n-We merge Pynac (i.e., the directory https://github.com/pynac/pynac/tree/master/ginac) into the Sage library as `src/sage/symbolics/ginac`. It is not a very big package - one flat directory with 100 *.h and *.cpp files, a total of 50kLOC.\n+We merge Pynac (i.e., the directory https://github.com/pynac/pynac/tree/master/ginac) into the Sage library as `src/sage/symbolic/ginac`. It is not a very big package - one flat directory with 100 *.h and *.cpp files, a total of 50kLOC.\n \n This will solve the same issues that #30534 tried to address, which ran into unresolved technical difficulties.\n \n It will also make it easier for Sage developers to make changes to Pynac.\n+\n+\n+\n \n Summary: Merge pynac as src/sage/symbolics/ginac\n \n``````\n",
    "created_at": "2021-08-16T17:29:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490213",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,11 +2,14 @@
 
 Pynac has no other uses than as the core of the symbolic expressions facility of Sage; and cannot even be tested without Sage.
 
-We merge Pynac (i.e., the directory https://github.com/pynac/pynac/tree/master/ginac) into the Sage library as `src/sage/symbolics/ginac`. It is not a very big package - one flat directory with 100 *.h and *.cpp files, a total of 50kLOC.
+We merge Pynac (i.e., the directory https://github.com/pynac/pynac/tree/master/ginac) into the Sage library as `src/sage/symbolic/ginac`. It is not a very big package - one flat directory with 100 *.h and *.cpp files, a total of 50kLOC.
 
 This will solve the same issues that #30534 tried to address, which ran into unresolved technical difficulties.
 
 It will also make it easier for Sage developers to make changes to Pynac.
+
+
+
 
 Summary: Merge pynac as src/sage/symbolics/ginac
 
``````




---

archive/issue_comments_490214.json:
```json
{
    "body": "<a id='comment:3'></a>I ran `git filter-branch -f --tree-filter 'rm -f Makefile.am; mkdir -p src/sage/symbolic/ginac; mv *.* src/sage/symbolic/ginac/; :' -- --all` on pynac 0.7.29 and merged it here, thus preserving the relevant history\n\n---\nLast 10 new commits:",
    "created_at": "2021-08-16T18:17:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490214",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>I ran `git filter-branch -f --tree-filter 'rm -f Makefile.am; mkdir -p src/sage/symbolic/ginac; mv *.* src/sage/symbolic/ginac/; :' -- --all` on pynac 0.7.29 and merged it here, thus preserving the relevant history

---
Last 10 new commits:



---

archive/issue_comments_490215.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-16T18:29:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490215",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490216.json:
```json
{
    "body": "<a id='comment:5'></a>Next: Move stuff from `sage.libs.pynac` to `sage.symbolic.ginac`, leaving some deprecated reimports behind. \n\nHelp from Cython experts very welcome...",
    "created_at": "2021-08-16T18:32:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490216",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>Next: Move stuff from `sage.libs.pynac` to `sage.symbolic.ginac`, leaving some deprecated reimports behind. 

Help from Cython experts very welcome...



---

archive/issue_comments_490217.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-16T19:16:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490217",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490218.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-16T19:30:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490218",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490219.json:
```json
{
    "body": "<a id='comment:8'></a>This version compiles OK",
    "created_at": "2021-08-16T19:31:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490219",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>This version compiles OK



---

archive/issue_comments_490220.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-16T20:02:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490220",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490221.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-16T20:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490221",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490222.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-08-16T20:17:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490222",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_490223.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,14 @@\n+Pynac has a compile-time dependency on the Python library but is not installed using Python package infrastructure. This is problematic because Python users cannot install it using standard Python tools - for example for testing different Python versions.\n+\n+Pynac has no other uses than as the core of the symbolic expressions facility of Sage; and cannot even be tested without Sage.\n+\n+We merge Pynac (i.e., the directory https://github.com/pynac/pynac/tree/master/ginac) into the Sage library as `src/sage/symbolic/ginac`. It is not a very big package - one flat directory with 100 *.h and *.cpp files, a total of 50kLOC. (The existing Python/Cython symbolics code in `sage.symbolic`, `sage.calculus`, `sage.functions` is about 60kLOC.)\n+\n+This will solve the same issues that #30534 tried to address, which ran into unresolved technical difficulties.\n+\n+It will also make it easier for Sage developers to make changes to Pynac.\n+\n+\n \n \n Summary: Merge pynac as src/sage/symbolics/ginac\n``````\n",
    "created_at": "2021-08-16T20:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490223",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,14 @@
+Pynac has a compile-time dependency on the Python library but is not installed using Python package infrastructure. This is problematic because Python users cannot install it using standard Python tools - for example for testing different Python versions.
+
+Pynac has no other uses than as the core of the symbolic expressions facility of Sage; and cannot even be tested without Sage.
+
+We merge Pynac (i.e., the directory https://github.com/pynac/pynac/tree/master/ginac) into the Sage library as `src/sage/symbolic/ginac`. It is not a very big package - one flat directory with 100 *.h and *.cpp files, a total of 50kLOC. (The existing Python/Cython symbolics code in `sage.symbolic`, `sage.calculus`, `sage.functions` is about 60kLOC.)
+
+This will solve the same issues that #30534 tried to address, which ran into unresolved technical difficulties.
+
+It will also make it easier for Sage developers to make changes to Pynac.
+
+
 
 
 Summary: Merge pynac as src/sage/symbolics/ginac
``````




---

archive/issue_comments_490224.json:
```json
{
    "body": "<a id='comment:14'></a>This mostly works but I'm getting a few timeouts/crashes that I'm not sure about\n\n```\nsage -t --random-seed=0 src/sage/schemes/elliptic_curves/ell_number_field.py  # Timed out\nsage -t --random-seed=0 src/sage/manifolds/differentiable/degenerate_submanifold.py  # 1 doctest failed\nsage -t --random-seed=0 src/sage/manifolds/differentiable/tensorfield.py  # Timed out\nsage -t --random-seed=0 src/sage/plot/plot3d/parametric_plot3d.py  # Timed out\nsage -t --random-seed=0 src/sage/plot/plot3d/plot3d.py  # Timed out\nsage -t --random-seed=0 src/sage/plot/plot3d/base.pyx  # Timed out\nsage -t --random-seed=0 src/sage/plot/plot3d/implicit_plot3d.py  # Timed out\nsage -t --random-seed=0 src/sage/symbolic/relation.py  # Timed out\nsage -t --random-seed=0 src/sage/symbolic/expression.pyx  # Killed due to illegal instruction\nsage -t --random-seed=0 src/sage/symbolic/pynac_constant.pyx  # 18 doctests failed\n```",
    "created_at": "2021-08-16T21:06:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490224",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>This mostly works but I'm getting a few timeouts/crashes that I'm not sure about

```
sage -t --random-seed=0 src/sage/schemes/elliptic_curves/ell_number_field.py  # Timed out
sage -t --random-seed=0 src/sage/manifolds/differentiable/degenerate_submanifold.py  # 1 doctest failed
sage -t --random-seed=0 src/sage/manifolds/differentiable/tensorfield.py  # Timed out
sage -t --random-seed=0 src/sage/plot/plot3d/parametric_plot3d.py  # Timed out
sage -t --random-seed=0 src/sage/plot/plot3d/plot3d.py  # Timed out
sage -t --random-seed=0 src/sage/plot/plot3d/base.pyx  # Timed out
sage -t --random-seed=0 src/sage/plot/plot3d/implicit_plot3d.py  # Timed out
sage -t --random-seed=0 src/sage/symbolic/relation.py  # Timed out
sage -t --random-seed=0 src/sage/symbolic/expression.pyx  # Killed due to illegal instruction
sage -t --random-seed=0 src/sage/symbolic/pynac_constant.pyx  # 18 doctests failed
```



---

archive/issue_comments_490225.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-16T21:13:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490225",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490226.json:
```json
{
    "body": "<a id='comment:16'></a>The crash is from this doctest:\n\n```\n>>> m = var('m')\n>>> assume(m, 'integer')\n>>> (I**m).real_part()\n```\nwhich seems to lead to an infinite recursion through `GiNaC::power::real_part()`",
    "created_at": "2021-08-16T21:39:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490226",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>The crash is from this doctest:

```
>>> m = var('m')
>>> assume(m, 'integer')
>>> (I**m).real_part()
```
which seems to lead to an infinite recursion through `GiNaC::power::real_part()`



---

archive/issue_comments_490227.json:
```json
{
    "body": "<a id='comment:17'></a>Oh, this is #28357 and I forgot to apply `realpartloop.patch`",
    "created_at": "2021-08-16T21:47:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490227",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>Oh, this is #28357 and I forgot to apply `realpartloop.patch`



---

archive/issue_comments_490228.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-16T21:54:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490228",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490229.json:
```json
{
    "body": "<a id='comment:19'></a>Ready for testing and review. (I think the patchbot will not run because `build/pkgs/pynac/` is removed by the ticket.)",
    "created_at": "2021-08-16T22:11:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490229",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'></a>Ready for testing and review. (I think the patchbot will not run because `build/pkgs/pynac/` is removed by the ticket.)



---

archive/issue_comments_490230.json:
```json
{
    "body": "<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-16T22:14:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490230",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490231.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:19 mkoeppe]:\n> Ready for testing and review. (I think the patchbot will not run because `build/pkgs/pynac/` is removed by the ticket.)\n\n\nThat's a bit inconvenient. Such a massive change needs all the bot runs it can get.",
    "created_at": "2021-08-16T22:20:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490231",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:21'></a>Replying to [comment:19 mkoeppe]:
> Ready for testing and review. (I think the patchbot will not run because `build/pkgs/pynac/` is removed by the ticket.)


That's a bit inconvenient. Such a massive change needs all the bot runs it can get.



---

archive/issue_comments_490232.json:
```json
{
    "body": "<a id='comment:22'></a>I can of course move the pynac removal to a follow-up ticket",
    "created_at": "2021-08-16T22:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490232",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'></a>I can of course move the pynac removal to a follow-up ticket



---

archive/issue_comments_490233.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-08-16T22:32:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490233",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_490234.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,14 @@\n+Pynac has a compile-time dependency on the Python library but is not installed using Python package infrastructure. This is problematic because Python users cannot install it using standard Python tools - for example for testing different Python versions.\n+\n+Pynac has no other uses than as the core of the symbolic expressions facility of Sage; and cannot even be tested without Sage.\n+\n+We merge Pynac (i.e., the directory https://github.com/pynac/pynac/tree/master/ginac) into the Sage library as `src/sage/symbolic/ginac`. It is not a very big package - one flat directory with 100 *.h and *.cpp files, a total of 50kLOC. (The existing Python/Cython symbolics code in `sage.symbolic`, `sage.calculus`, `sage.functions` is about 60kLOC.)\n+\n+This will solve the same issues that #30534 tried to address, which ran into unresolved technical difficulties.\n+\n+It will also make it easier for Sage developers to make changes to Pynac.\n+\n+Follow-up: #32387 Remove pynac spkg\n \n \n Summary: Merge pynac as src/sage/symbolics/ginac\n``````\n",
    "created_at": "2021-08-16T22:33:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490234",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,14 @@
+Pynac has a compile-time dependency on the Python library but is not installed using Python package infrastructure. This is problematic because Python users cannot install it using standard Python tools - for example for testing different Python versions.
+
+Pynac has no other uses than as the core of the symbolic expressions facility of Sage; and cannot even be tested without Sage.
+
+We merge Pynac (i.e., the directory https://github.com/pynac/pynac/tree/master/ginac) into the Sage library as `src/sage/symbolic/ginac`. It is not a very big package - one flat directory with 100 *.h and *.cpp files, a total of 50kLOC. (The existing Python/Cython symbolics code in `sage.symbolic`, `sage.calculus`, `sage.functions` is about 60kLOC.)
+
+This will solve the same issues that #30534 tried to address, which ran into unresolved technical difficulties.
+
+It will also make it easier for Sage developers to make changes to Pynac.
+
+Follow-up: #32387 Remove pynac spkg
 
 
 Summary: Merge pynac as src/sage/symbolics/ginac
``````




---

archive/issue_comments_490235.json:
```json
{
    "body": "<a id='comment:25'></a>My previous tests were on macOS. On Linux this fails with \n\n```\n  File \"sage/symbolic/pynac.pyx\", line 1, in init sage.symbolic.pynac (build/cythonized/sage/symbolic/pynac.cpp:31348)\nImportError: /home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/symbolic/expression.cpython-37m-x86_64-linux-gnu.so: undefined symbol: _ZTIN5GiNaC5basicE\n```\n(as reported by a patchbot; also verified using `tox -e docker-ubuntu-focal-standard`)",
    "created_at": "2021-08-17T00:16:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490235",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'></a>My previous tests were on macOS. On Linux this fails with 

```
  File "sage/symbolic/pynac.pyx", line 1, in init sage.symbolic.pynac (build/cythonized/sage/symbolic/pynac.cpp:31348)
ImportError: /home/sagemath/sage-9.1/local/lib/python3.7/site-packages/sage/symbolic/expression.cpython-37m-x86_64-linux-gnu.so: undefined symbol: _ZTIN5GiNaC5basicE
```
(as reported by a patchbot; also verified using `tox -e docker-ubuntu-focal-standard`)



---

archive/issue_comments_490236.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-08-17T00:16:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490236",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_490237.json:
```json
{
    "body": "<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-17T01:42:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490237",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490238.json:
```json
{
    "body": "<a id='comment:27'></a>This problem with linking can likely be solved by merging all *.pyx files that `cimport` from `sage.symbolic.pynac` into one (taking care of the ones in `ring.pyx` by refactoring)\n\n```\n$ git grep pynac.*cimport\nsrc/sage/symbolic/comparison.pyx:from sage.symbolic.pynac cimport (\nsrc/sage/symbolic/expression.pxd:from sage.symbolic.pynac cimport GEx\nsrc/sage/symbolic/expression.pyx:from sage.symbolic.pynac cimport *\nsrc/sage/symbolic/function.pyx:from sage.symbolic.pynac cimport (\nsrc/sage/symbolic/getitem.pyx:from sage.symbolic.pynac cimport GEx\nsrc/sage/symbolic/pynac.pyx:from .pynac_constant cimport PynacConstant\nsrc/sage/symbolic/pynac_constant.pxd:from .pynac cimport GConstant\nsrc/sage/symbolic/pynac_constant.pyx:from .pynac cimport (\nsrc/sage/symbolic/ring.pyx:from sage.symbolic.pynac cimport (GEx, GExprSeq, GExVector, GSymbol,\nsrc/sage/symbolic/series.pyx:from sage.symbolic.pynac cimport GEx, g_is_a_terminating_series, g_series_var, series_to_poly\nsrc/sage/symbolic/substitution_map.pxd:from sage.symbolic.pynac cimport GExMap\nsrc/sage/symbolic/substitution_map.pyx:from sage.symbolic.pynac cimport make_pair, GEx, GExPair\n```\nI don't know if there's a better solution.",
    "created_at": "2021-08-17T01:52:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490238",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'></a>This problem with linking can likely be solved by merging all *.pyx files that `cimport` from `sage.symbolic.pynac` into one (taking care of the ones in `ring.pyx` by refactoring)

```
$ git grep pynac.*cimport
src/sage/symbolic/comparison.pyx:from sage.symbolic.pynac cimport (
src/sage/symbolic/expression.pxd:from sage.symbolic.pynac cimport GEx
src/sage/symbolic/expression.pyx:from sage.symbolic.pynac cimport *
src/sage/symbolic/function.pyx:from sage.symbolic.pynac cimport (
src/sage/symbolic/getitem.pyx:from sage.symbolic.pynac cimport GEx
src/sage/symbolic/pynac.pyx:from .pynac_constant cimport PynacConstant
src/sage/symbolic/pynac_constant.pxd:from .pynac cimport GConstant
src/sage/symbolic/pynac_constant.pyx:from .pynac cimport (
src/sage/symbolic/ring.pyx:from sage.symbolic.pynac cimport (GEx, GExprSeq, GExVector, GSymbol,
src/sage/symbolic/series.pyx:from sage.symbolic.pynac cimport GEx, g_is_a_terminating_series, g_series_var, series_to_poly
src/sage/symbolic/substitution_map.pxd:from sage.symbolic.pynac cimport GExMap
src/sage/symbolic/substitution_map.pyx:from sage.symbolic.pynac cimport make_pair, GEx, GExPair
```
I don't know if there's a better solution.



---

archive/issue_comments_490239.json:
```json
{
    "body": "<a id='comment:28'></a>I will take a look, if I can resolve this.",
    "created_at": "2021-08-17T07:56:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490239",
    "user": "https://github.com/kliem"
}
```

<a id='comment:28'></a>I will take a look, if I can resolve this.



---

archive/issue_comments_490240.json:
```json
{
    "body": "<a id='comment:29'></a>New commits:",
    "created_at": "2021-08-17T10:19:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490240",
    "user": "https://github.com/kliem"
}
```

<a id='comment:29'></a>New commits:



---

archive/issue_comments_490241.json:
```json
{
    "body": "<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-17T13:40:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490241",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490242.json:
```json
{
    "body": "<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-17T15:04:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490242",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490243.json:
```json
{
    "body": "<a id='comment:32'></a>I basically have this working by specifying:\n\n```diff\ndiff --git a/src/sage/symbolic/series.pyx b/src/sage/symbolic/series.pyx\nindex 0e395ae4b4..d93cccc50b 100644\n--- a/src/sage/symbolic/series.pyx\n+++ b/src/sage/symbolic/series.pyx\n@@ -1,3 +1,4 @@\n+# distutils: extra_link_args = /srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/symbolic/pynac.cpython-37m-x86_64-linux-gnu.so\n \"\"\"\n Symbolic Series\n```\n\nto all of those files (and the one doctest in `sage/symbolic/pynac.pxd` that raises an `ImportError` currently).\n\nSo this is basically working, but the correct linking is missing.\n\nWe could create an extra file `sage/symbolic/linked_pynac.pxd`, which just consists of\n\n```\n# distutils: extra_link_args = ...\nfrom sage.symbolic/pynac cimport *\n```\n\nthen there is no need to specify this extra distutils thing in every file that cimports pynac.",
    "created_at": "2021-08-17T15:11:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490243",
    "user": "https://github.com/kliem"
}
```

<a id='comment:32'></a>I basically have this working by specifying:

```diff
diff --git a/src/sage/symbolic/series.pyx b/src/sage/symbolic/series.pyx
index 0e395ae4b4..d93cccc50b 100644
--- a/src/sage/symbolic/series.pyx
+++ b/src/sage/symbolic/series.pyx
@@ -1,3 +1,4 @@
+# distutils: extra_link_args = /srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/symbolic/pynac.cpython-37m-x86_64-linux-gnu.so
 """
 Symbolic Series
```

to all of those files (and the one doctest in `sage/symbolic/pynac.pxd` that raises an `ImportError` currently).

So this is basically working, but the correct linking is missing.

We could create an extra file `sage/symbolic/linked_pynac.pxd`, which just consists of

```
# distutils: extra_link_args = ...
from sage.symbolic/pynac cimport *
```

then there is no need to specify this extra distutils thing in every file that cimports pynac.



---

archive/issue_comments_490244.json:
```json
{
    "body": "<a id='comment:33'></a>Once more thing: The headers in `pkgs/sagemath-standard/build/cythonized/` are not cleaned up. Can this be fixed somehow or is this just going to stay this way? (This is probably the reason, why you did not notice the missing headers that were fixed in ||[01dfef3](https://git.sagemath.org/sage.git/commit?id=01dfef3756a4da5fc01355f10954dea69fbf01f6)||`missing headers`||",
    "created_at": "2021-08-17T15:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490244",
    "user": "https://github.com/kliem"
}
```

<a id='comment:33'></a>Once more thing: The headers in `pkgs/sagemath-standard/build/cythonized/` are not cleaned up. Can this be fixed somehow or is this just going to stay this way? (This is probably the reason, why you did not notice the missing headers that were fixed in ||[01dfef3](https://git.sagemath.org/sage.git/commit?id=01dfef3756a4da5fc01355f10954dea69fbf01f6)||`missing headers`||



---

archive/issue_comments_490245.json:
```json
{
    "body": "<a id='comment:34'></a>I don't like the change https://git.sagemath.org/sage.git/commit/?id=70bcddf168950f477c2b56fca725e668a1236fb6 (simpler inclusion of headers); putting stuff in the include search path can lead to shadowing headers of other libraries",
    "created_at": "2021-08-17T17:48:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490245",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'></a>I don't like the change https://git.sagemath.org/sage.git/commit/?id=70bcddf168950f477c2b56fca725e668a1236fb6 (simpler inclusion of headers); putting stuff in the include search path can lead to shadowing headers of other libraries



---

archive/issue_comments_490246.json:
```json
{
    "body": "<a id='comment:35'></a>Thanks for the investigation and fixes.\n\nI think I would be reluctant to use the `extra_link_args` workaround -- it will requires changes to the build system because now building one extension module would depend on another extension module.\n\nIn any case, I'd think that your successful experiment indicates the approach of merging everything that needs to `cimport` stuff from ginac/ into one extension module would work.",
    "created_at": "2021-08-17T17:54:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490246",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:35'></a>Thanks for the investigation and fixes.

I think I would be reluctant to use the `extra_link_args` workaround -- it will requires changes to the build system because now building one extension module would depend on another extension module.

In any case, I'd think that your successful experiment indicates the approach of merging everything that needs to `cimport` stuff from ginac/ into one extension module would work.



---

archive/issue_comments_490247.json:
```json
{
    "body": "<a id='comment:36'></a>Replying to [comment:33 gh-kliem]:\n> Once more thing: The headers in `pkgs/sagemath-standard/build/cythonized/` are not cleaned up. \n\nDo we already have a ticket for this? If not, please open one\n\nHowever, I think we should move away from the custom build system of Sage. I have opened #32390 for the next step in this.",
    "created_at": "2021-08-17T18:06:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490247",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:36'></a>Replying to [comment:33 gh-kliem]:
> Once more thing: The headers in `pkgs/sagemath-standard/build/cythonized/` are not cleaned up. 

Do we already have a ticket for this? If not, please open one

However, I think we should move away from the custom build system of Sage. I have opened #32390 for the next step in this.



---

archive/issue_comments_490248.json:
```json
{
    "body": "<a id='comment:37'></a>Replying to [comment:27 mkoeppe]:\n> This problem with linking can likely be solved by merging all *.pyx files that `cimport` from `sage.symbolic.pynac` into one (taking care of the ones in `ring.pyx` by refactoring)\n\n\nFor cleaning up `ring.pyx`, I have opened #32391.",
    "created_at": "2021-08-17T18:17:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490248",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:37'></a>Replying to [comment:27 mkoeppe]:
> This problem with linking can likely be solved by merging all *.pyx files that `cimport` from `sage.symbolic.pynac` into one (taking care of the ones in `ring.pyx` by refactoring)


For cleaning up `ring.pyx`, I have opened #32391.



---

archive/issue_comments_490249.json:
```json
{
    "body": "<a id='comment:38'></a>Replying to [comment:37 mkoeppe]:\n> Replying to [comment:27 mkoeppe]:\n> > This problem with linking can likely be solved by merging all *.pyx files that `cimport` from `sage.symbolic.pynac` into one (taking care of the ones in `ring.pyx` by refactoring)\n\n> \n> For cleaning up `ring.pyx`, I have opened #32391.\n\n\nWe would still lose ability to use it directly in cython at all. E.g. the doctest in `pynac.pxd` would fail.\n\nAt the moment, I'm building this branch with `./configure --enable-editable` and will report whether this resolves anything.",
    "created_at": "2021-08-17T18:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490249",
    "user": "https://github.com/kliem"
}
```

<a id='comment:38'></a>Replying to [comment:37 mkoeppe]:
> Replying to [comment:27 mkoeppe]:
> > This problem with linking can likely be solved by merging all *.pyx files that `cimport` from `sage.symbolic.pynac` into one (taking care of the ones in `ring.pyx` by refactoring)

> 
> For cleaning up `ring.pyx`, I have opened #32391.


We would still lose ability to use it directly in cython at all. E.g. the doctest in `pynac.pxd` would fail.

At the moment, I'm building this branch with `./configure --enable-editable` and will report whether this resolves anything.



---

archive/issue_comments_490250.json:
```json
{
    "body": "<a id='comment:39'></a>Replying to [comment:34 mkoeppe]:\n> I don't like the change https://git.sagemath.org/sage.git/commit/?id=70bcddf168950f477c2b56fca725e668a1236fb6 (simpler inclusion of headers); putting stuff in the include search path can lead to shadowing headers of other libraries\n\n\n`from ... cimport ...` should usually just work out of the box. But of course one can also spell out all those header (e.g. with a cython alias).\n\nThen again, if we decide to put it all into one large `pyx` and not cimport things from `ginac` directly, the commit isn't necessary at all.",
    "created_at": "2021-08-17T18:51:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490250",
    "user": "https://github.com/kliem"
}
```

<a id='comment:39'></a>Replying to [comment:34 mkoeppe]:
> I don't like the change https://git.sagemath.org/sage.git/commit/?id=70bcddf168950f477c2b56fca725e668a1236fb6 (simpler inclusion of headers); putting stuff in the include search path can lead to shadowing headers of other libraries


`from ... cimport ...` should usually just work out of the box. But of course one can also spell out all those header (e.g. with a cython alias).

Then again, if we decide to put it all into one large `pyx` and not cimport things from `ginac` directly, the commit isn't necessary at all.



---

archive/issue_comments_490251.json:
```json
{
    "body": "<a id='comment:40'></a>Replying to [comment:38 gh-kliem]:\n> Replying to [comment:37 mkoeppe]:\n> > Replying to [comment:27 mkoeppe]:\n> > > This problem with linking can likely be solved by merging all *.pyx files that `cimport` from `sage.symbolic.pynac` into one (taking care of the ones in `ring.pyx` by refactoring)\n\n> > \n> > For cleaning up `ring.pyx`, I have opened #32391.\n\n> \n> We would still lose ability to use it directly in cython at all. E.g. the doctest in `pynac.pxd` would fail.\n\n\nI wouldn't be too concerned about this. I'd be surprised if there's any user code in the wild that does that; and if at all necessary, it can be mitigated by adding some missing methods at a higher level.",
    "created_at": "2021-08-17T19:00:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490251",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:40'></a>Replying to [comment:38 gh-kliem]:
> Replying to [comment:37 mkoeppe]:
> > Replying to [comment:27 mkoeppe]:
> > > This problem with linking can likely be solved by merging all *.pyx files that `cimport` from `sage.symbolic.pynac` into one (taking care of the ones in `ring.pyx` by refactoring)

> > 
> > For cleaning up `ring.pyx`, I have opened #32391.

> 
> We would still lose ability to use it directly in cython at all. E.g. the doctest in `pynac.pxd` would fail.


I wouldn't be too concerned about this. I'd be surprised if there's any user code in the wild that does that; and if at all necessary, it can be mitigated by adding some missing methods at a higher level.



---

archive/issue_comments_490252.json:
```json
{
    "body": "<a id='comment:41'></a>Ok, same problem with `./configure --enable-editable`.\n\nBtw, this is exactly our problem and there is no proper solution to it. So instead of adding a custom one, I agree that it would be easier, to move all the `cdef extern from ...` into one large `pyx` and only `cimport` the cython wrappers. This is the way, your meant to do it anyway.",
    "created_at": "2021-08-17T19:03:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490252",
    "user": "https://github.com/kliem"
}
```

<a id='comment:41'></a>Ok, same problem with `./configure --enable-editable`.

Btw, this is exactly our problem and there is no proper solution to it. So instead of adding a custom one, I agree that it would be easier, to move all the `cdef extern from ...` into one large `pyx` and only `cimport` the cython wrappers. This is the way, your meant to do it anyway.



---

archive/issue_comments_490253.json:
```json
{
    "body": "<a id='comment:42'></a>A simple way of doing this might be to rename files like `series.pxd` to `series.pxi` and `series.pyx` to `series_impl.pxi` and then to `include` them into the target extension module (`pynac.pxd`, `pynac.pyx`?)",
    "created_at": "2021-08-17T19:11:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490253",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:42'></a>A simple way of doing this might be to rename files like `series.pxd` to `series.pxi` and `series.pyx` to `series_impl.pxi` and then to `include` them into the target extension module (`pynac.pxd`, `pynac.pyx`?)



---

archive/issue_comments_490254.json:
```json
{
    "body": "<a id='comment:43'></a>Using `pxi` is outdated, I was told. But maybe using something outdated is more desirable than having huge files.",
    "created_at": "2021-08-17T19:21:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490254",
    "user": "https://github.com/kliem"
}
```

<a id='comment:43'></a>Using `pxi` is outdated, I was told. But maybe using something outdated is more desirable than having huge files.



---

archive/issue_comments_490255.json:
```json
{
    "body": "<a id='comment:44'></a>That's probably just from the warning at https://cython.readthedocs.io/en/latest/src/userguide/language_basics.html?highlight=include#the-include-statement-and-include-files; but if I'm not mistaken, this just refers to a particular use case of \"pxi\" that was superseded by \"pxd\". I don't see any indication that the mechanism of `include` is intended to be removed in Cython.",
    "created_at": "2021-08-17T19:25:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490255",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:44'></a>That's probably just from the warning at https://cython.readthedocs.io/en/latest/src/userguide/language_basics.html?highlight=include#the-include-statement-and-include-files; but if I'm not mistaken, this just refers to a particular use case of "pxi" that was superseded by "pxd". I don't see any indication that the mechanism of `include` is intended to be removed in Cython.



---

archive/issue_comments_490256.json:
```json
{
    "body": "<a id='comment:46'></a>It would look like this (currently does not compile because I haven't done the changes to `ring.pyx`)\n\n---\nNew commits:",
    "created_at": "2021-08-17T20:04:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490256",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:46'></a>It would look like this (currently does not compile because I haven't done the changes to `ring.pyx`)

---
New commits:



---

archive/issue_comments_490257.json:
```json
{
    "body": "<a id='comment:47'></a>(cherry-picked some of your changes onto this branch)",
    "created_at": "2021-08-17T20:06:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490257",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:47'></a>(cherry-picked some of your changes onto this branch)



---

archive/issue_comments_490258.json:
```json
{
    "body": "<a id='comment:48'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-17T21:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490258",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:48'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490259.json:
```json
{
    "body": "<a id='comment:49'></a>or perhaps better like this.",
    "created_at": "2021-08-17T21:45:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490259",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:49'></a>or perhaps better like this.



---

archive/issue_comments_490260.json:
```json
{
    "body": "<a id='comment:50'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-18T00:21:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490260",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:50'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490261.json:
```json
{
    "body": "<a id='comment:51'></a>Forgive me for asking a na\u00efve question, but isn't this going against the modularization you are trying to have Sage do? I fully understand the reason for bringing it in (which should make it easier to bug-fix), but doesn't this make Sage more monolithic?",
    "created_at": "2021-08-18T04:19:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490261",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:51'></a>Forgive me for asking a naïve question, but isn't this going against the modularization you are trying to have Sage do? I fully understand the reason for bringing it in (which should make it easier to bug-fix), but doesn't this make Sage more monolithic?



---

archive/issue_comments_490262.json:
```json
{
    "body": "<a id='comment:52'></a>Replying to [comment:51 tscrim]:\n> isn't this going against the modularization you are trying to have Sage do? I fully understand the reason for bringing it in (which should make it easier to bug-fix), but doesn't this make Sage more monolithic?\n\n\nThis is a natural question. \n\nThe pynac library just does not make sense as a module. It is the basis of the implementation of SR elements and as such there is no way to build Sage symbolics without it. \n\nIn the modularization plan of #29705, we would instead create a distribution package `sagemath-symbolics`, containing the integrated pynac from the present ticket and most of `sage.symbolic`, `sage.calculus`, `sage.functions`, and parts of `sage.interfaces`. This will make sense as a module because there are many parts of Sage that (fortunately!) do not depend at all on Sage symbolics, or only depend on it for some smaller features. For example, `sage.graphs` has 0 imports from `sage.symbolic`, `sage.combinat` just a handful, etc.",
    "created_at": "2021-08-18T17:53:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490262",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:52'></a>Replying to [comment:51 tscrim]:
> isn't this going against the modularization you are trying to have Sage do? I fully understand the reason for bringing it in (which should make it easier to bug-fix), but doesn't this make Sage more monolithic?


This is a natural question. 

The pynac library just does not make sense as a module. It is the basis of the implementation of SR elements and as such there is no way to build Sage symbolics without it. 

In the modularization plan of #29705, we would instead create a distribution package `sagemath-symbolics`, containing the integrated pynac from the present ticket and most of `sage.symbolic`, `sage.calculus`, `sage.functions`, and parts of `sage.interfaces`. This will make sense as a module because there are many parts of Sage that (fortunately!) do not depend at all on Sage symbolics, or only depend on it for some smaller features. For example, `sage.graphs` has 0 imports from `sage.symbolic`, `sage.combinat` just a handful, etc.



---

archive/issue_comments_490263.json:
```json
{
    "body": "<a id='comment:53'></a>Thank you for the explanation. So wouldn't it make sense to instead take the symbolics stuff out from Sage in one go rather than this two step process of add in pynac just to remove it later? Or is this just meant to be a stop-gap until it comes time to split everything?",
    "created_at": "2021-08-22T02:06:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490263",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:53'></a>Thank you for the explanation. So wouldn't it make sense to instead take the symbolics stuff out from Sage in one go rather than this two step process of add in pynac just to remove it later? Or is this just meant to be a stop-gap until it comes time to split everything?



---

archive/issue_comments_490264.json:
```json
{
    "body": "<a id='comment:54'></a>Replying to [comment:53 tscrim]:\n> So wouldn't it make sense to instead take the symbolics stuff out from Sage in one go rather than this two step process of add in pynac just to remove it later? Or is this just meant to be a stop-gap until it comes time to split everything?\n\n\nThe modularization plan does not involve \"taking ... stuff out from Sage\" at all. It will all remain in the same git repository, and also `src/sage` will remain monolithic.\n\nModularization is achieved by preparing sub-distributions defined using one of several possible mechanisms. Take a look at `sagemath-objects` from #29865 (https://pypi.org/project/sagemath-objects/), for example: It defines a sub-distribution using a `MANIFEST` file. Via the Python 3 \"native namespace packages\" mechanism, (after some work in #31420, #28925), these distributions can be installed cleanly next to each other and provide the shared `sage.*` namespace.",
    "created_at": "2021-08-22T02:30:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490264",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:54'></a>Replying to [comment:53 tscrim]:
> So wouldn't it make sense to instead take the symbolics stuff out from Sage in one go rather than this two step process of add in pynac just to remove it later? Or is this just meant to be a stop-gap until it comes time to split everything?


The modularization plan does not involve "taking ... stuff out from Sage" at all. It will all remain in the same git repository, and also `src/sage` will remain monolithic.

Modularization is achieved by preparing sub-distributions defined using one of several possible mechanisms. Take a look at `sagemath-objects` from #29865 (https://pypi.org/project/sagemath-objects/), for example: It defines a sub-distribution using a `MANIFEST` file. Via the Python 3 "native namespace packages" mechanism, (after some work in #31420, #28925), these distributions can be installed cleanly next to each other and provide the shared `sage.*` namespace.



---

archive/issue_comments_490265.json:
```json
{
    "body": "<a id='comment:56'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2021-08-22T22:33:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490265",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:56'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_490266.json:
```json
{
    "body": "<a id='comment:57'></a>It remains to remove the import cycle `sage.symbolic.ring` -> `sage.symbolic.expression` -> `sage.symbolic.function` -> `sage.symbolic.ring`",
    "created_at": "2021-08-22T22:34:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490266",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:57'></a>It remains to remove the import cycle `sage.symbolic.ring` -> `sage.symbolic.expression` -> `sage.symbolic.function` -> `sage.symbolic.ring`



---

archive/issue_comments_490267.json:
```json
{
    "body": "<a id='comment:58'></a>Ah, okay, I was thinking the modularization meant splitting Sage up into different subprojects that would have a main link that would be the actual Sage. However, it is a little different than that. I don't completely understand how all of this works and some of the benefits, but it doesn't seem to be as fragmented as I was thinking. Thank you.",
    "created_at": "2021-08-23T00:31:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490267",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:58'></a>Ah, okay, I was thinking the modularization meant splitting Sage up into different subprojects that would have a main link that would be the actual Sage. However, it is a little different than that. I don't completely understand how all of this works and some of the benefits, but it doesn't seem to be as fragmented as I was thinking. Thank you.



---

archive/issue_comments_490268.json:
```json
{
    "body": "<a id='comment:59'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-23T00:45:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490268",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:59'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490269.json:
```json
{
    "body": "<a id='comment:60'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-23T00:53:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490269",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:60'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490270.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,18 @@\n+Pynac has a compile-time dependency on the Python library but is not installed using Python package infrastructure. This is problematic because Python users cannot install it using standard Python tools - for example for testing different Python versions.\n+\n+Pynac has no other uses than as the core of the symbolic expressions facility of Sage; and cannot even be tested without Sage.\n+\n+We merge Pynac (i.e., the directory https://github.com/pynac/pynac/tree/master/ginac) into the Sage library as `src/sage/symbolic/ginac`. It is not a very big package - one flat directory with 100 *.h and *.cpp files, a total of 50kLOC. (The existing !Python/Cython symbolics code in `sage.symbolic`, `sage.calculus`, `sage.functions` is about 60kLOC.)\n+\n+The Pynac sources are compiled like other C++ sources that are already in the Sage source tree. They are linked into a single Python extension module, `sage.symbolic.expression`. All other extension modules that used to link to pynac (`sage.libs.pynac.pynac`, `sage.symbolic.function`, `sage.symbolic.series` etc.) are \n+- either refactored so that they only `import` helper functions provided by `sage.symbolic.expression` instead of having to `cimport` Pynac functions directly (see #32391, #32407)\n+- or merged into the extension module `sage.symbolic.expression` (via Cython `include` statements, not by copy-paste of source code, to keep the diff small)\n+\n+This solves the same issues that #30534 tried to address, which ran into unresolved technical difficulties.\n+\n+It will also make it easier for Sage developers to make changes to Pynac and the related symbolic implementation.\n+\n+Follow-up: #32387 Remove pynac spkg\n \n \n Summary: Merge pynac as src/sage/symbolics/ginac\n``````\n",
    "created_at": "2021-08-23T01:14:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490270",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,18 @@
+Pynac has a compile-time dependency on the Python library but is not installed using Python package infrastructure. This is problematic because Python users cannot install it using standard Python tools - for example for testing different Python versions.
+
+Pynac has no other uses than as the core of the symbolic expressions facility of Sage; and cannot even be tested without Sage.
+
+We merge Pynac (i.e., the directory https://github.com/pynac/pynac/tree/master/ginac) into the Sage library as `src/sage/symbolic/ginac`. It is not a very big package - one flat directory with 100 *.h and *.cpp files, a total of 50kLOC. (The existing !Python/Cython symbolics code in `sage.symbolic`, `sage.calculus`, `sage.functions` is about 60kLOC.)
+
+The Pynac sources are compiled like other C++ sources that are already in the Sage source tree. They are linked into a single Python extension module, `sage.symbolic.expression`. All other extension modules that used to link to pynac (`sage.libs.pynac.pynac`, `sage.symbolic.function`, `sage.symbolic.series` etc.) are 
+- either refactored so that they only `import` helper functions provided by `sage.symbolic.expression` instead of having to `cimport` Pynac functions directly (see #32391, #32407)
+- or merged into the extension module `sage.symbolic.expression` (via Cython `include` statements, not by copy-paste of source code, to keep the diff small)
+
+This solves the same issues that #30534 tried to address, which ran into unresolved technical difficulties.
+
+It will also make it easier for Sage developers to make changes to Pynac and the related symbolic implementation.
+
+Follow-up: #32387 Remove pynac spkg
 
 
 Summary: Merge pynac as src/sage/symbolics/ginac
``````




---

archive/issue_comments_490271.json:
```json
{
    "body": "<a id='comment:62'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-23T01:33:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490271",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:62'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490272.json:
```json
{
    "body": "<a id='comment:63'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-23T02:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490272",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:63'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490273.json:
```json
{
    "body": "<a id='comment:64'></a>Still struggling with an import cycle `sage.symbolic.ring` -> `sage.symbolic.expression` -> `sage.symbolic.ring`",
    "created_at": "2021-08-23T02:05:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490273",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:64'></a>Still struggling with an import cycle `sage.symbolic.ring` -> `sage.symbolic.expression` -> `sage.symbolic.ring`



---

archive/issue_comments_490274.json:
```json
{
    "body": "<a id='comment:65'></a>Help welcome",
    "created_at": "2021-08-23T02:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490274",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:65'></a>Help welcome



---

archive/issue_comments_490275.json:
```json
{
    "body": "<a id='comment:66'></a>I recall that `i`, a.k.a. `I`, is really close the the center of the import troubles.",
    "created_at": "2021-08-23T07:08:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490275",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:66'></a>I recall that `i`, a.k.a. `I`, is really close the the center of the import troubles.



---

archive/issue_comments_490276.json:
```json
{
    "body": "<a id='comment:67'></a>New commits:",
    "created_at": "2021-08-23T10:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490276",
    "user": "https://github.com/kliem"
}
```

<a id='comment:67'></a>New commits:



---

archive/issue_comments_490277.json:
```json
{
    "body": "<a id='comment:68'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2021-08-23T10:51:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490277",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:68'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_490278.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-08-23T10:56:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490278",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_490279.json:
```json
{
    "body": "<a id='comment:69'></a>Seems to work now.",
    "created_at": "2021-08-23T10:56:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490279",
    "user": "https://github.com/kliem"
}
```

<a id='comment:69'></a>Seems to work now.



---

archive/issue_comments_490280.json:
```json
{
    "body": "<a id='comment:70'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-23T15:19:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490280",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:70'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490281.json:
```json
{
    "body": "<a id='comment:71'></a>Cool, thanks very much!!",
    "created_at": "2021-08-23T16:34:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490281",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:71'></a>Cool, thanks very much!!



---

archive/issue_comments_490282.json:
```json
{
    "body": "<a id='comment:72'></a>I'm getting\n\n```\nsage -t --random-seed=0 src/sage/functions/prime_pi.pyx\n**********************************************************************\nFile \"src/sage/functions/prime_pi.pyx\", line 17, in sage.functions.prime_pi\nFailed example:\n    loads(dumps(z)) == z\nExpected:\n    True\nGot:\n    False\n```",
    "created_at": "2021-08-23T16:35:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490282",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:72'></a>I'm getting

```
sage -t --random-seed=0 src/sage/functions/prime_pi.pyx
**********************************************************************
File "src/sage/functions/prime_pi.pyx", line 17, in sage.functions.prime_pi
Failed example:
    loads(dumps(z)) == z
Expected:
    True
Got:
    False
```



---

archive/issue_comments_490283.json:
```json
{
    "body": "<a id='comment:73'></a>It will also need to be checked that the deferred imports (such as those introduced in my commit 3153781) do not lead to speed regressions",
    "created_at": "2021-08-23T16:38:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490283",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:73'></a>It will also need to be checked that the deferred imports (such as those introduced in my commit 3153781) do not lead to speed regressions



---

archive/issue_comments_490284.json:
```json
{
    "body": "<a id='comment:74'></a>Also I don't think we need `src/sage/symbolic/pynac.py` -- the module `sage.symbolic.pynac` only had a short-lived existence here in this branch.\nDid you mean to add these `lazy_import` to `src/sage/libs/pynac/pynac.py`?",
    "created_at": "2021-08-23T16:49:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490284",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:74'></a>Also I don't think we need `src/sage/symbolic/pynac.py` -- the module `sage.symbolic.pynac` only had a short-lived existence here in this branch.
Did you mean to add these `lazy_import` to `src/sage/libs/pynac/pynac.py`?



---

archive/issue_comments_490285.json:
```json
{
    "body": "<a id='comment:76'></a>New commits:",
    "created_at": "2021-08-23T17:54:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490285",
    "user": "https://github.com/kliem"
}
```

<a id='comment:76'></a>New commits:



---

archive/issue_comments_490286.json:
```json
{
    "body": "<a id='comment:77'></a>Replying to [comment:72 mkoeppe]:\n> I'm getting\n> \n> ```\n> sage -t --random-seed=0 src/sage/functions/prime_pi.pyx\n> **********************************************************************\n> File \"src/sage/functions/prime_pi.pyx\", line 17, in sage.functions.prime_pi\n> Failed example:\n>     loads(dumps(z)) == z\n> Expected:\n>     True\n> Got:\n>     False\n> ```\n\n\nFixed.",
    "created_at": "2021-08-23T17:54:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490286",
    "user": "https://github.com/kliem"
}
```

<a id='comment:77'></a>Replying to [comment:72 mkoeppe]:
> I'm getting
> 
> ```
> sage -t --random-seed=0 src/sage/functions/prime_pi.pyx
> **********************************************************************
> File "src/sage/functions/prime_pi.pyx", line 17, in sage.functions.prime_pi
> Failed example:
>     loads(dumps(z)) == z
> Expected:
>     True
> Got:
>     False
> ```


Fixed.



---

archive/issue_comments_490287.json:
```json
{
    "body": "<a id='comment:79'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-23T18:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490287",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:79'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490288.json:
```json
{
    "body": "<a id='comment:80'></a>If we want to deprecate these reimports like you do here...\n\n```\n+++ b/src/sage/symbolic/series.py\n@@ -0,0 +1,2 @@\n+from sage.misc.lazy_import import lazy_import\n+lazy_import('sage.symbolic.expression', 'SymbolicSeries', deprecation=32386)\n```\n... then we should probably also do this in `substitution_map.py` (and perhaps other places).",
    "created_at": "2021-08-23T18:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490288",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:80'></a>If we want to deprecate these reimports like you do here...

```
+++ b/src/sage/symbolic/series.py
@@ -0,0 +1,2 @@
+from sage.misc.lazy_import import lazy_import
+lazy_import('sage.symbolic.expression', 'SymbolicSeries', deprecation=32386)
```
... then we should probably also do this in `substitution_map.py` (and perhaps other places).



---

archive/issue_comments_490289.json:
```json
{
    "body": "<a id='comment:81'></a>I tried to get all places. I didn't do `substitution_map.py` because, you had already added the reimport.\n\nI did those lazy imports here, so that people importing python functions from places where they used to be, get a proper deprecation warning:\n\nhttps://git.sagemath.org/sage.git/commit/?h=2d2153446fc3bb4d2d17d32cc770c0efc5121ecf&id=5b557c68dd722ae8063334b23a595f9b1482a5d7",
    "created_at": "2021-08-23T19:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490289",
    "user": "https://github.com/kliem"
}
```

<a id='comment:81'></a>I tried to get all places. I didn't do `substitution_map.py` because, you had already added the reimport.

I did those lazy imports here, so that people importing python functions from places where they used to be, get a proper deprecation warning:

https://git.sagemath.org/sage.git/commit/?h=2d2153446fc3bb4d2d17d32cc770c0efc5121ecf&id=5b557c68dd722ae8063334b23a595f9b1482a5d7



---

archive/issue_comments_490290.json:
```json
{
    "body": "<a id='comment:82'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-23T19:00:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490290",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:82'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490291.json:
```json
{
    "body": "<a id='comment:83'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-23T22:44:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490291",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:83'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490292.json:
```json
{
    "body": "<a id='comment:84'></a>Replying to [comment:73 mkoeppe]:\n> It will also need to be checked that the deferred imports (such as those introduced in my commit 3153781) do not lead to speed regressions\n\n\nA quick comparison using `./sage -tp --long src/sage/symbolic/ src/sage/functions/ src/sage/calculus/ src/sage/manifolds/` shows a serious slowdown around +30% with this branch",
    "created_at": "2021-08-24T00:42:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490292",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:84'></a>Replying to [comment:73 mkoeppe]:
> It will also need to be checked that the deferred imports (such as those introduced in my commit 3153781) do not lead to speed regressions


A quick comparison using `./sage -tp --long src/sage/symbolic/ src/sage/functions/ src/sage/calculus/ src/sage/manifolds/` shows a serious slowdown around +30% with this branch



---

archive/issue_comments_490293.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-08-24T00:42:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490293",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_490294.json:
```json
{
    "body": "<a id='comment:85'></a>I cannot reproduce these timings any more; perhaps this was just from CPU throttling.",
    "created_at": "2021-08-24T03:52:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490294",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:85'></a>I cannot reproduce these timings any more; perhaps this was just from CPU throttling.



---

archive/issue_comments_490295.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-08-24T03:53:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490295",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_490296.json:
```json
{
    "body": "<a id='comment:87'></a>New commits:",
    "created_at": "2021-08-24T11:42:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490296",
    "user": "https://github.com/kliem"
}
```

<a id='comment:87'></a>New commits:



---

archive/issue_comments_490297.json:
```json
{
    "body": "<a id='comment:89'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-24T18:01:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490297",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:89'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490298.json:
```json
{
    "body": "<a id='comment:90'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-24T21:05:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490298",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:90'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490299.json:
```json
{
    "body": "<a id='comment:91'></a>If I understand well, that means that when sage 9.5 enters Debian pynac can be let go.\n\nIs that right?\n\n(Asking as the one responsible for pynac in Debian: [package tracker](https://tracker.debian.org/pkg/pynac))",
    "created_at": "2021-08-25T06:56:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490299",
    "user": "https://trac.sagemath.org/admin/accounts/users/Snark"
}
```

<a id='comment:91'></a>If I understand well, that means that when sage 9.5 enters Debian pynac can be let go.

Is that right?

(Asking as the one responsible for pynac in Debian: [package tracker](https://tracker.debian.org/pkg/pynac))



---

archive/issue_comments_490300.json:
```json
{
    "body": "<a id='comment:92'></a>Replying to [comment:91 Snark]:\n> If I understand well, that means that when sage 9.5 enters Debian pynac can be let go.\n> \n> Is that right?\n> \n> (Asking as the one responsible for pynac in Debian: [package tracker](https://tracker.debian.org/pkg/pynac))\n\n\nYes, you understand well.",
    "created_at": "2021-08-25T08:03:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490300",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:92'></a>Replying to [comment:91 Snark]:
> If I understand well, that means that when sage 9.5 enters Debian pynac can be let go.
> 
> Is that right?
> 
> (Asking as the one responsible for pynac in Debian: [package tracker](https://tracker.debian.org/pkg/pynac))


Yes, you understand well.



---

archive/issue_comments_490301.json:
```json
{
    "body": "<a id='comment:93'></a>\n```\nsage -t --long --random-seed=0 src/sage/misc/sageinspect.py\n**********************************************************************\nFile \"src/sage/misc/sageinspect.py\", line 2263, in sage.misc.sageinspect.sage_getsourcelines\nFailed example:\n    lines, lineno = sage_getsourcelines(x); lines[0:2]\nExpected:\n    ['cdef class Expression(CommutativeRingElement):\\n',\n     '    cpdef object pyobject(self):\\n']\nGot:\n    ['cdef class Expression(CommutativeRingElement):\\n', '\\n']\n```",
    "created_at": "2021-08-25T15:57:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490301",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:93'></a>
```
sage -t --long --random-seed=0 src/sage/misc/sageinspect.py
**********************************************************************
File "src/sage/misc/sageinspect.py", line 2263, in sage.misc.sageinspect.sage_getsourcelines
Failed example:
    lines, lineno = sage_getsourcelines(x); lines[0:2]
Expected:
    ['cdef class Expression(CommutativeRingElement):\n',
     '    cpdef object pyobject(self):\n']
Got:
    ['cdef class Expression(CommutativeRingElement):\n', '\n']
```



---

archive/issue_comments_490302.json:
```json
{
    "body": "<a id='comment:94'></a>Fixed that test in `sageinspect.py`.\n\n---\nNew commits:",
    "created_at": "2021-08-25T17:25:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490302",
    "user": "https://github.com/kliem"
}
```

<a id='comment:94'></a>Fixed that test in `sageinspect.py`.

---
New commits:



---

archive/issue_comments_490303.json:
```json
{
    "body": "<a id='comment:95'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-25T21:26:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490303",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:95'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490304.json:
```json
{
    "body": "<a id='comment:96'></a>Coverage is still an issue, e.g. `new_Expression_from_pyobject` doesn't even have a docstring.",
    "created_at": "2021-08-25T21:27:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490304",
    "user": "https://github.com/kliem"
}
```

<a id='comment:96'></a>Coverage is still an issue, e.g. `new_Expression_from_pyobject` doesn't even have a docstring.



---

archive/issue_comments_490305.json:
```json
{
    "body": "<a id='comment:98'></a>I've solved this by consolidating two similar functions into one \n\n---\nNew commits:",
    "created_at": "2021-08-25T23:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490305",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:98'></a>I've solved this by consolidating two similar functions into one 

---
New commits:



---

archive/issue_comments_490306.json:
```json
{
    "body": "<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-26T18:24:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490306",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:0'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490307.json:
```json
{
    "body": "<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-26T19:37:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490307",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_490308.json:
```json
{
    "body": "<a id='comment:2'></a>The portability tests on GH Actions ran through successfully. \n\nReady for review",
    "created_at": "2021-08-27T23:06:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490308",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>The portability tests on GH Actions ran through successfully. 

Ready for review



---

archive/issue_comments_490309.json:
```json
{
    "body": "<a id='comment:4'></a>there is a failing test:\n\n```\ne023915d474 (Markus Wageringel   2021-06-15 19:54:54 +0200 340)     sage: result = integral(sinh(x^2+sqrt(x-1)),x)  # long time (15s on sage.math, 2012)\ne023915d474 (Markus Wageringel   2021-06-15 19:54:54 +0200 341)     ...\ne023915d474 (Markus Wageringel   2021-06-15 19:54:54 +0200 342)     sage: result\nd0c52e4aa36 (Jean-Pierre Flori   2013-05-27 15:36:24 +0200 343)     integrate(sinh(x^2 + sqrt(x - 1)), x)\n```\nline 342 needs `# long time` tag.",
    "created_at": "2021-09-03T16:33:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490309",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>there is a failing test:

```
e023915d474 (Markus Wageringel   2021-06-15 19:54:54 +0200 340)     sage: result = integral(sinh(x^2+sqrt(x-1)),x)  # long time (15s on sage.math, 2012)
e023915d474 (Markus Wageringel   2021-06-15 19:54:54 +0200 341)     ...
e023915d474 (Markus Wageringel   2021-06-15 19:54:54 +0200 342)     sage: result
d0c52e4aa36 (Jean-Pierre Flori   2013-05-27 15:36:24 +0200 343)     integrate(sinh(x^2 + sqrt(x - 1)), x)
```
line 342 needs `# long time` tag.



---

archive/issue_comments_490310.json:
```json
{
    "body": "<a id='comment:5'></a>Unrelated to this ticket but yes",
    "created_at": "2021-09-03T17:18:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490310",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>Unrelated to this ticket but yes



---

archive/issue_comments_490311.json:
```json
{
    "body": "<a id='comment:6'></a>opened #32461 for this",
    "created_at": "2021-09-03T17:24:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490311",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>opened #32461 for this



---

archive/issue_comments_490312.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-03T19:29:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490312",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_490313.json:
```json
{
    "body": "<a id='comment:7'></a>lgtm",
    "created_at": "2021-09-03T19:29:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490313",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'></a>lgtm



---

archive/issue_comments_490314.json:
```json
{
    "body": "<a id='comment:8'></a>Thank you!",
    "created_at": "2021-09-03T19:53:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490314",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>Thank you!



---

archive/issue_comments_490315.json:
```json
{
    "body": "<a id='comment:9'></a>should #32461  be a dependency here?",
    "created_at": "2021-09-04T08:45:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490315",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>should #32461  be a dependency here?



---

archive/issue_comments_490316.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2021-09-13T23:39:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490316",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_490317.json:
```json
{
    "body": "<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2021-09-13T23:39:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490317",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_490318.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-13T23:40:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490318",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_490319.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-09-15T22:06:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490319",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_085937.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-09-15T22:06:00Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32386#event-85937"
}
```



---

archive/issue_comments_490320.json:
```json
{
    "body": "<a id='comment:114'></a>Replying to [comment:73 mkoeppe]:\n> It will also need to be checked that the deferred imports (such as those introduced in my commit 3153781) do not lead to speed regressions\n\n\nFWIW, the change performed here did not introduced any speed regression in the rather demanding [Kerr spacetime notebook](https://nbviewer.jupyter.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_Kerr.ipynb), which involves parallelized (8 threads) heavy symbolic computations. On the contrary, it seems there is some little speed up :-) On my i7-8665U laptop:\n- Sage 9.4: 461 s \n- Sage 9.5.beta2: 449 s",
    "created_at": "2021-09-28T19:37:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490320",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:114'></a>Replying to [comment:73 mkoeppe]:
> It will also need to be checked that the deferred imports (such as those introduced in my commit 3153781) do not lead to speed regressions


FWIW, the change performed here did not introduced any speed regression in the rather demanding [Kerr spacetime notebook](https://nbviewer.jupyter.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_Kerr.ipynb), which involves parallelized (8 threads) heavy symbolic computations. On the contrary, it seems there is some little speed up :-) On my i7-8665U laptop:
- Sage 9.4: 461 s 
- Sage 9.5.beta2: 449 s



---

archive/issue_comments_490321.json:
```json
{
    "body": "<a id='comment:5'></a>Thanks for testing!",
    "created_at": "2021-09-28T19:38:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32386",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32386#issuecomment-490321",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>Thanks for testing!
