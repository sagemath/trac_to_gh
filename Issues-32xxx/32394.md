# Issue 32394: Can't calculate derivative exception while sympifying of two arguments function derivative

archive/issues_032157.json:
```json
{
    "body": "Starting with a partial derivative\nof a function of two variables:\n\n```\nsage: v_x, j_x, x, y = var(\"v_x, j_x, x, y\")\nsage: F = function(\"F\")(x, y)\nsage: expression = F.diff(x, 3).diff(y, 1).subs(x == j_x + v_x)\nsage: expression\nD[0, 0, 0, 1](F)(j_x + v_x, y)\n```\nand trying to \"simpify\" it (convert it to Sympy),\nI have met the following exception:\n\n```\nsage: ex = expression._sympy_()\nf_sympy F(j_x + v_x, y)\n\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-32-da30dd17641c> in <module>\n----> 1 ex = expression._sympy_()\n\n/usr3/articles/sagemath_docker_build/sage/local/lib/python3.9/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._sympy_ (build/cythonized/sage/symbolic/expression.cpp:12810)()\n   1786         \"\"\"\n   1787         from sage.symbolic.expression_conversions import sympy_converter\n-> 1788         return sympy_converter(self)\n   1789 \n   1790     def _fricas_init_(self):\n\n/usr3/articles/sagemath_docker_build/sage/local/lib/python3.9/site-packages/sage/symbolic/expression_conversions.py in __call__(self, ex)\n    711                           super().__call__(ex))\n    712         #print(\"ex\", ex)\n--> 713         return super().__call__(ex)\n    714 \n    715     def pyobject(self, ex, obj):\n\n/usr3/articles/sagemath_docker_build/sage/local/lib/python3.9/site-packages/sage/symbolic/expression_conversions.py in __call__(self, ex)\n    219             return self.relation(ex, operator)\n    220         elif isinstance(operator, FDerivativeOperator):\n--> 221             return self.derivative(ex, operator)\n    222         elif operator == tuple:\n    223             return self.tuple(ex)\n\n/usr3/articles/sagemath_docker_build/sage/local/lib/python3.9/site-packages/sage/symbolic/expression_conversions.py in derivative(self, ex, operator)\n    938         f_sympy = f._sympy_()(*_args)\n    939         print(\"f_sympy\", f_sympy)\n--> 940         result = f_sympy.diff(*sympy_arg)\n    941         if subs_new:\n    942             return sympy.Subs(result, subs_new, subs_old)\n\n/usr3/articles/sagemath_docker_build/sage/local/lib/python3.9/site-packages/sympy/core/expr.py in diff(self, *symbols, **assumptions)\n   3500     def diff(self, *symbols, **assumptions):\n   3501         assumptions.setdefault(\"evaluate\", True)\n-> 3502         return _derivative_dispatch(self, *symbols, **assumptions)\n   3503 \n   3504     ###########################################################################\n\n/usr3/articles/sagemath_docker_build/sage/local/lib/python3.9/site-packages/sympy/core/function.py in _derivative_dispatch(expr, *variables, **kwargs)\n   1945         from sympy.tensor.array.array_derivatives import ArrayDerivative\n   1946         return ArrayDerivative(expr, *variables, **kwargs)\n-> 1947     return Derivative(expr, *variables, **kwargs)\n   1948 \n   1949 \n\n/usr3/articles/sagemath_docker_build/sage/local/lib/python3.9/site-packages/sympy/core/function.py in __new__(cls, expr, *variables, **kwargs)\n   1371             if not v._diff_wrt:\n   1372                 __ = ''  # filler to make error message neater\n-> 1373                 raise ValueError(filldedent('''\n   1374                     Can't calculate derivative wrt %s.%s''' % (v,\n   1375                     __)))\n\nValueError: \nCan't calculate derivative wrt j_x + v_x.\n```\n\nMaybe the exception raised by the Sympy library\ncan be handled in Sage?\n\n**Assignee:** @daju1\n\n**CC:**  @EmmanuelCharpentier @slel @frederichan-IMJPRG @nbruin @mkoeppe\n\n**Branch:** [u/gh-daju1/can_t_calculate_derivative_exception_while_sympifying_of_two_arguments_function_derivative](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-daju1/can_t_calculate_derivative_exception_while_sympifying_of_two_arguments_function_derivative)\n\n**Commit:** [5c1eb31683821179a4f9702d8dde048f644be1a5](https://github.com/sagemath/sagetrac-mirror/commit/5c1eb31683821179a4f9702d8dde048f644be1a5)\n\n**Upstream:** Fixed upstream, in a later stable release.\n\n**Author:** Alexey Drozdov\n\n**Status:** needs_review\n\nIssue created by migration from https://trac.sagemath.org/ticket/32394\n\n",
    "created_at": "2021-08-17T20:23:41Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Can't calculate derivative exception while sympifying of two arguments function derivative",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32394",
    "user": "https://github.com/daju1"
}
```
Starting with a partial derivative
of a function of two variables:

```
sage: v_x, j_x, x, y = var("v_x, j_x, x, y")
sage: F = function("F")(x, y)
sage: expression = F.diff(x, 3).diff(y, 1).subs(x == j_x + v_x)
sage: expression
D[0, 0, 0, 1](F)(j_x + v_x, y)
```
and trying to "simpify" it (convert it to Sympy),
I have met the following exception:

```
sage: ex = expression._sympy_()
f_sympy F(j_x + v_x, y)

---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-32-da30dd17641c> in <module>
----> 1 ex = expression._sympy_()

/usr3/articles/sagemath_docker_build/sage/local/lib/python3.9/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._sympy_ (build/cythonized/sage/symbolic/expression.cpp:12810)()
   1786         """
   1787         from sage.symbolic.expression_conversions import sympy_converter
-> 1788         return sympy_converter(self)
   1789 
   1790     def _fricas_init_(self):

/usr3/articles/sagemath_docker_build/sage/local/lib/python3.9/site-packages/sage/symbolic/expression_conversions.py in __call__(self, ex)
    711                           super().__call__(ex))
    712         #print("ex", ex)
--> 713         return super().__call__(ex)
    714 
    715     def pyobject(self, ex, obj):

/usr3/articles/sagemath_docker_build/sage/local/lib/python3.9/site-packages/sage/symbolic/expression_conversions.py in __call__(self, ex)
    219             return self.relation(ex, operator)
    220         elif isinstance(operator, FDerivativeOperator):
--> 221             return self.derivative(ex, operator)
    222         elif operator == tuple:
    223             return self.tuple(ex)

/usr3/articles/sagemath_docker_build/sage/local/lib/python3.9/site-packages/sage/symbolic/expression_conversions.py in derivative(self, ex, operator)
    938         f_sympy = f._sympy_()(*_args)
    939         print("f_sympy", f_sympy)
--> 940         result = f_sympy.diff(*sympy_arg)
    941         if subs_new:
    942             return sympy.Subs(result, subs_new, subs_old)

/usr3/articles/sagemath_docker_build/sage/local/lib/python3.9/site-packages/sympy/core/expr.py in diff(self, *symbols, **assumptions)
   3500     def diff(self, *symbols, **assumptions):
   3501         assumptions.setdefault("evaluate", True)
-> 3502         return _derivative_dispatch(self, *symbols, **assumptions)
   3503 
   3504     ###########################################################################

/usr3/articles/sagemath_docker_build/sage/local/lib/python3.9/site-packages/sympy/core/function.py in _derivative_dispatch(expr, *variables, **kwargs)
   1945         from sympy.tensor.array.array_derivatives import ArrayDerivative
   1946         return ArrayDerivative(expr, *variables, **kwargs)
-> 1947     return Derivative(expr, *variables, **kwargs)
   1948 
   1949 

/usr3/articles/sagemath_docker_build/sage/local/lib/python3.9/site-packages/sympy/core/function.py in __new__(cls, expr, *variables, **kwargs)
   1371             if not v._diff_wrt:
   1372                 __ = ''  # filler to make error message neater
-> 1373                 raise ValueError(filldedent('''
   1374                     Can't calculate derivative wrt %s.%s''' % (v,
   1375                     __)))

ValueError: 
Can't calculate derivative wrt j_x + v_x.
```

Maybe the exception raised by the Sympy library
can be handled in Sage?

**Assignee:** @daju1

**CC:**  @EmmanuelCharpentier @slel @frederichan-IMJPRG @nbruin @mkoeppe

**Branch:** [u/gh-daju1/can_t_calculate_derivative_exception_while_sympifying_of_two_arguments_function_derivative](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-daju1/can_t_calculate_derivative_exception_while_sympifying_of_two_arguments_function_derivative)

**Commit:** [5c1eb31683821179a4f9702d8dde048f644be1a5](https://github.com/sagemath/sagetrac-mirror/commit/5c1eb31683821179a4f9702d8dde048f644be1a5)

**Upstream:** Fixed upstream, in a later stable release.

**Author:** Alexey Drozdov

**Status:** needs_review

Issue created by migration from https://trac.sagemath.org/ticket/32394





---

archive/issue_events_097009.json:
```json
{
    "actor": "https://github.com/daju1",
    "created_at": "2021-08-17T20:30:24Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32394#event-97009"
}
```



---

archive/issue_comments_616050.json:
```json
{
    "body": "**Branch:** [u/gh-daju1/can_t_calculate_derivative_exception_while_sympifying_of_two_arguments_function_derivative](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-daju1/can_t_calculate_derivative_exception_while_sympifying_of_two_arguments_function_derivative)",
    "created_at": "2021-08-19T07:30:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32394#issuecomment-616050",
    "user": "https://github.com/daju1"
}
```

**Branch:** [u/gh-daju1/can_t_calculate_derivative_exception_while_sympifying_of_two_arguments_function_derivative](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-daju1/can_t_calculate_derivative_exception_while_sympifying_of_two_arguments_function_derivative)



---

archive/issue_comments_616051.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2021-08-19T07:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32394#issuecomment-616051",
    "user": "https://github.com/daju1"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_616052.json:
```json
{
    "body": "**Commit:** [15f557849e0570a652973edb2db2f1d4201d1f5d](https://github.com/sagemath/sagetrac-mirror/commit/15f557849e0570a652973edb2db2f1d4201d1f5d)",
    "created_at": "2021-08-19T07:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32394#issuecomment-616052",
    "user": "https://github.com/daju1"
}
```

**Commit:** [15f557849e0570a652973edb2db2f1d4201d1f5d](https://github.com/sagemath/sagetrac-mirror/commit/15f557849e0570a652973edb2db2f1d4201d1f5d)



---

archive/issue_comments_616053.json:
```json
{
    "body": "<a id='comment:3'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/15f557849e0570a652973edb2db2f1d4201d1f5d\">15f5578</a></td><td><code>Trac #32394: Can't calculate derivative exception while sympifying of two arguments function derivative if agrument is a sum or a mul</code></td></tr></table>\n",
    "created_at": "2021-08-19T07:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32394#issuecomment-616053",
    "user": "https://github.com/daju1"
}
```

<a id='comment:3'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/15f557849e0570a652973edb2db2f1d4201d1f5d">15f5578</a></td><td><code>Trac #32394: Can't calculate derivative exception while sympifying of two arguments function derivative if agrument is a sum or a mul</code></td></tr></table>




---

archive/issue_comments_616054.json:
```json
{
    "body": "**Author:** gh-daju1",
    "created_at": "2021-08-19T07:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32394#issuecomment-616054",
    "user": "https://github.com/daju1"
}
```

**Author:** gh-daju1



---

archive/issue_comments_616055.json:
```json
{
    "body": "**Changing upstream** from \"N/A\" to \"Fixed upstream, in a later stable release.\".",
    "created_at": "2021-08-19T07:48:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32394#issuecomment-616055",
    "user": "https://github.com/daju1"
}
```

**Changing upstream** from "N/A" to "Fixed upstream, in a later stable release.".



---

archive/issue_comments_616056.json:
```json
{
    "body": "**Assignee:** @daju1",
    "created_at": "2021-08-19T07:49:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32394#issuecomment-616056",
    "user": "https://github.com/daju1"
}
```

**Assignee:** @daju1



---

archive/issue_comments_616057.json:
```json
{
    "body": "<a id='comment:7'></a>\nAdditional issue found if \n\n```\nsage: x, y = var(\"x, y\")\nsage: F = function(\"F\")(x, y)\nsage: expression = F.diff(x, 3).diff(y, 1).subs(x == 1.5)\nsage: expression\nD[0, 0, 0, 1](F)(1.50000000000000, y)\n```\nbut\n\n```\nsage: ex = expression._sympy_()\n```\ngives\n\n```\nValueError: \nCan't calculate derivative wrt 1.50000000000000.\n```",
    "created_at": "2021-08-19T08:50:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32394#issuecomment-616057",
    "user": "https://github.com/daju1"
}
```

<a id='comment:7'></a>
Additional issue found if 

```
sage: x, y = var("x, y")
sage: F = function("F")(x, y)
sage: expression = F.diff(x, 3).diff(y, 1).subs(x == 1.5)
sage: expression
D[0, 0, 0, 1](F)(1.50000000000000, y)
```
but

```
sage: ex = expression._sympy_()
```
gives

```
ValueError: 
Can't calculate derivative wrt 1.50000000000000.
```



---

archive/issue_comments_616058.json:
```json
{
    "body": "**Changing commit** from \"[15f557849e0570a652973edb2db2f1d4201d1f5d](https://github.com/sagemath/sagetrac-mirror/commit/15f557849e0570a652973edb2db2f1d4201d1f5d)\" to \"[5c1eb31683821179a4f9702d8dde048f644be1a5](https://github.com/sagemath/sagetrac-mirror/commit/5c1eb31683821179a4f9702d8dde048f644be1a5)\".",
    "created_at": "2021-08-19T09:32:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32394#issuecomment-616058",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[15f557849e0570a652973edb2db2f1d4201d1f5d](https://github.com/sagemath/sagetrac-mirror/commit/15f557849e0570a652973edb2db2f1d4201d1f5d)" to "[5c1eb31683821179a4f9702d8dde048f644be1a5](https://github.com/sagemath/sagetrac-mirror/commit/5c1eb31683821179a4f9702d8dde048f644be1a5)".



---

archive/issue_comments_616059.json:
```json
{
    "body": "<a id='comment:8'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5c1eb31683821179a4f9702d8dde048f644be1a5\">5c1eb31</a></td><td><code>Trac #32394: Can't calculate derivative exception while sympifying of function derivative if its agrument is a number</code></td></tr></table>\n",
    "created_at": "2021-08-19T09:32:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32394#issuecomment-616059",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5c1eb31683821179a4f9702d8dde048f644be1a5">5c1eb31</a></td><td><code>Trac #32394: Can't calculate derivative exception while sympifying of function derivative if its agrument is a number</code></td></tr></table>




---

archive/issue_comments_616060.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -3,7 +3,7 @@\n ```\n sage: v_x, j_x, x, y = var(\"v_x, j_x, x, y\")\n sage: F = function(\"F\")(x, y)\n-sage: expression = F(x, y).diff(x, 3).diff(y, 1).subs(x == j_x + v_x)\n+sage: expression = F.diff(x, 3).diff(y, 1).subs(x == j_x + v_x)\n sage: expression\n D[0, 0, 0, 1](F)(j_x + v_x, y)\n ```\n``````\n",
    "created_at": "2021-08-19T09:35:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32394#issuecomment-616060",
    "user": "https://github.com/daju1"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -3,7 +3,7 @@
 ```
 sage: v_x, j_x, x, y = var("v_x, j_x, x, y")
 sage: F = function("F")(x, y)
-sage: expression = F(x, y).diff(x, 3).diff(y, 1).subs(x == j_x + v_x)
+sage: expression = F.diff(x, 3).diff(y, 1).subs(x == j_x + v_x)
 sage: expression
 D[0, 0, 0, 1](F)(j_x + v_x, y)
 ```
``````




---

archive/issue_events_097010.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32394#event-97010"
}
```



---

archive/issue_events_097011.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32394#event-97011"
}
```



---

archive/issue_events_097012.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:53:12Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32394#event-97012"
}
```



---

archive/issue_events_097013.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:53:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32394#event-97013"
}
```



---

archive/issue_comments_616061.json:
```json
{
    "body": "<a id='comment:11'></a>\nStalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32394#issuecomment-616061",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>
Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.



---

archive/issue_comments_616062.json:
```json
{
    "body": "**Changing author** from \"gh-daju1\" to \"Alexey Drozdov\".",
    "created_at": "2022-03-01T22:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32394#issuecomment-616062",
    "user": "https://github.com/slel"
}
```

**Changing author** from "gh-daju1" to "Alexey Drozdov".



---

archive/issue_comments_616063.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,5 @@\n-While sympifying of two arguments function derivative\n+Starting with a partial derivative\n+of a function of two variables:\n \n ```\n sage: v_x, j_x, x, y = var(\"v_x, j_x, x, y\")\n@@ -7,8 +8,8 @@\n sage: expression\n D[0, 0, 0, 1](F)(j_x + v_x, y)\n ```\n-\n-I have met the following Exception\n+and trying to \"simpify\" it (convert it to Sympy),\n+I have met the following exception:\n \n ```\n sage: ex = expression._sympy_()\n@@ -70,7 +71,7 @@\n \n ValueError: \n Can't calculate derivative wrt j_x + v_x.\n-\n ```\n \n-Exception raised inside sympy library. But may be we can handle this situation inside sage?\n+Maybe the exception raised by the Sympy library\n+can be handled in Sage?\n``````\n",
    "created_at": "2022-03-01T22:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32394#issuecomment-616063",
    "user": "https://github.com/slel"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,5 @@
-While sympifying of two arguments function derivative
+Starting with a partial derivative
+of a function of two variables:
 
 ```
 sage: v_x, j_x, x, y = var("v_x, j_x, x, y")
@@ -7,8 +8,8 @@
 sage: expression
 D[0, 0, 0, 1](F)(j_x + v_x, y)
 ```
-
-I have met the following Exception
+and trying to "simpify" it (convert it to Sympy),
+I have met the following exception:
 
 ```
 sage: ex = expression._sympy_()
@@ -70,7 +71,7 @@
 
 ValueError: 
 Can't calculate derivative wrt j_x + v_x.
-
 ```
 
-Exception raised inside sympy library. But may be we can handle this situation inside sage?
+Maybe the exception raised by the Sympy library
+can be handled in Sage?
``````




---

archive/issue_comments_616064.json:
```json
{
    "body": "<a id='comment:13'></a>\nI'm not sure that deriving with respect to the sum of two arguments makes sense. Consider :\n\n```\nsage: g=function(\"g\")\nsage: g(a, b, c).diff(a)\ndiff(g(a, b, c), a)\nsage: g(a, b, c).diff(a+b)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-53-1221c21f3a0d> in <module>\n----> 1 g(a, b, c).diff(a+b)\n\n/usr/local/sage-9/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.derivative (build/cythonized/sage/symbolic/expression.cpp:54855)()\n   4633             ValueError: No differentiation variable specified.\n   4634         \"\"\"\n-> 4635         return multi_derivative(self, args)\n   4636 \n   4637     diff = differentiate = derivative\n\n/usr/local/sage-9/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/misc/derivative.pyx in sage.misc.derivative.multi_derivative (build/cythonized/sage/misc/derivative.c:3281)()\n    220 \n    221     for arg in derivative_parse(args):\n--> 222         F = F._derivative(arg)\n    223     return F\n    224 \n\n/usr/local/sage-9/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._derivative (build/cythonized/sage/symbolic/expression.cpp:55328)()\n   4701         cdef Expression symbol = self.coerce_in(symb)\n   4702         if not is_a_symbol(symbol._gobj):\n-> 4703             raise TypeError(\"argument symb must be a symbol\")\n   4704         cdef GEx x\n   4705         sig_on()\n\nTypeError: argument symb must be a symbol\n```\n\nIn our case :\n\n```\nsage: F.diff(x,3).diff(y,1).subs({x:j_x+v_x})\nD[0, 0, 0, 1](F)(j_x + v_x, y)\n```\n\nSo far, so good. But note that this is a *three-argument* function :\n\n```\nsage: F.diff(x,3).diff(y,1).subs({x:j_x+v_x}).arguments()\n(j_x, v_x, y)\n```\n\nand, as exemplified above, deriving wrt the sum of two of them has no easy meaning...\n\nWould this :\n\n```\nsage: F.diff(x,3).diff(y,1)._sympy_().subs({x._sympy_():j_x._sympy_()+v_x._sympy_()})\nSubs(Derivative(F(x, y), (x, 3), y), x, j_x + v_x)\n```\n\naccomplish what you meant ?",
    "created_at": "2022-03-02T10:31:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32394#issuecomment-616064",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:13'></a>
I'm not sure that deriving with respect to the sum of two arguments makes sense. Consider :

```
sage: g=function("g")
sage: g(a, b, c).diff(a)
diff(g(a, b, c), a)
sage: g(a, b, c).diff(a+b)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-53-1221c21f3a0d> in <module>
----> 1 g(a, b, c).diff(a+b)

/usr/local/sage-9/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.derivative (build/cythonized/sage/symbolic/expression.cpp:54855)()
   4633             ValueError: No differentiation variable specified.
   4634         """
-> 4635         return multi_derivative(self, args)
   4636 
   4637     diff = differentiate = derivative

/usr/local/sage-9/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/misc/derivative.pyx in sage.misc.derivative.multi_derivative (build/cythonized/sage/misc/derivative.c:3281)()
    220 
    221     for arg in derivative_parse(args):
--> 222         F = F._derivative(arg)
    223     return F
    224 

/usr/local/sage-9/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._derivative (build/cythonized/sage/symbolic/expression.cpp:55328)()
   4701         cdef Expression symbol = self.coerce_in(symb)
   4702         if not is_a_symbol(symbol._gobj):
-> 4703             raise TypeError("argument symb must be a symbol")
   4704         cdef GEx x
   4705         sig_on()

TypeError: argument symb must be a symbol
```

In our case :

```
sage: F.diff(x,3).diff(y,1).subs({x:j_x+v_x})
D[0, 0, 0, 1](F)(j_x + v_x, y)
```

So far, so good. But note that this is a *three-argument* function :

```
sage: F.diff(x,3).diff(y,1).subs({x:j_x+v_x}).arguments()
(j_x, v_x, y)
```

and, as exemplified above, deriving wrt the sum of two of them has no easy meaning...

Would this :

```
sage: F.diff(x,3).diff(y,1)._sympy_().subs({x._sympy_():j_x._sympy_()+v_x._sympy_()})
Subs(Derivative(F(x, y), (x, 3), y), x, j_x + v_x)
```

accomplish what you meant ?



---

archive/issue_events_097014.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32394#event-97014"
}
```



---

archive/issue_events_097015.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32394#event-97015"
}
```



---

archive/attachments_021547.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "Ticket 32394 Can't calculate derivative wrt j_x + v_x.ipynb",
    "asset_url": "tarball://root/attachments/some-uuid/ticket32394/Ticket 32394 Can't calculate derivative wrt j_x + v_x.ipynb",
    "created_at": "2022-07-24T11:51:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.ipynb",
    "user": "https://github.com/daju1"
}
```



---

archive/issue_comments_616065.json:
```json
{
    "body": "",
    "created_at": "2022-07-24T11:51:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32394#issuecomment-616065",
    "user": "https://github.com/daju1"
}
```





---

archive/issue_comments_616066.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [charpent](#comment%3A13):\n> I'm not sure that deriving with respect to the sum of two arguments makes sense. Consider :\n> \n> ```\n> sage: g=function(\"g\")\n> sage: g(a, b, c).diff(a)\n> diff(g(a, b, c), a)\n> sage: g(a, b, c).diff(a+b)\n> ---------------------------------------------------------------------------\n> TypeError                                 Traceback (most recent call last)\n> <ipython-input-53-1221c21f3a0d> in <module>\n> ----> 1 g(a, b, c).diff(a+b)\n> \n> /usr/local/sage-9/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.derivative (build/cythonized/sage/symbolic/expression.cpp:54855)()\n>    4633             ValueError: No differentiation variable specified.\n>    4634         \"\"\"\n> -> 4635         return multi_derivative(self, args)\n>    4636 \n>    4637     diff = differentiate = derivative\n> \n> /usr/local/sage-9/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/misc/derivative.pyx in sage.misc.derivative.multi_derivative (build/cythonized/sage/misc/derivative.c:3281)()\n>     220 \n>     221     for arg in derivative_parse(args):\n> --> 222         F = F._derivative(arg)\n>     223     return F\n>     224 \n> \n> /usr/local/sage-9/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._derivative (build/cythonized/sage/symbolic/expression.cpp:55328)()\n>    4701         cdef Expression symbol = self.coerce_in(symb)\n>    4702         if not is_a_symbol(symbol._gobj):\n> -> 4703             raise TypeError(\"argument symb must be a symbol\")\n>    4704         cdef GEx x\n>    4705         sig_on()\n> \n> TypeError: argument symb must be a symbol\n> ```\n> \n> In our case :\n> \n> ```\n> sage: F.diff(x,3).diff(y,1).subs({x:j_x+v_x})\n> D[0, 0, 0, 1](F)(j_x + v_x, y)\n> ```\n> \n> So far, so good. But note that this is a *three-argument* function :\n> \n> ```\n> sage: F.diff(x,3).diff(y,1).subs({x:j_x+v_x}).arguments()\n> (j_x, v_x, y)\n> ```\n> \n> and, as exemplified above, deriving wrt the sum of two of them has no easy meaning...\n> \n> Would this :\n> \n> ```\n> sage: F.diff(x,3).diff(y,1)._sympy_().subs({x._sympy_():j_x._sympy_()+v_x._sympy_()})\n> Subs(Derivative(F(x, y), (x, 3), y), x, j_x + v_x)\n> ```\n> \n> accomplish what you meant ?\n\n\nHi, charpent. Please see recently added attachment to understand what I want. I have two functions. First of them:\n\n```\nR_px = euler_maclaurin_R_p(F, x, a_x, b_x,p, f_diff_symb_p=F.diff(x,p))\n```\n\nby executing the following code\n\n```\n                R_p = (-1)^(p+1)*integral(symbolic_sum(f.subs(symb == vx+jx).diff(vx,p)*B(x=vx,p=p)/fact(n=p), \\\n                                              jx, a, b-1, hold=hold_sum), \\\n                                          (vx,0,1), hold=hold_int)\n```\n\ngives:\n\n\n```\nR_px = integrate(sum(1/12*(2*v_x^3 - 3*v_x^2 + v_x)*D[0, 0, 0](F)(j_x + v_x, y), j_x, n_x, b_x - 1), v_x, 0, 1)\n```\n\nHere please note that deriving is really wrt v_x. As for me when I need to have sum of derivatives it is no defference how to derive: wrt v_x or wrt (j_x + v_x) which means just x in the interval from some integer to that integer + 1.\n\nBut the second function\n\n```\nsumy_R_px = sum_dfdx_bernoulis(R_px, y, a_y, b_y, p)\n```\n\n\ngives Exception here: \n\n\n```\n/tmp/ipykernel_21688/1831337102.py in sum_dfdx_bernoulis(f, symb, a, b, p)\n      5     dfdx_a_bernoullis = []\n      6     for k in range(Integer(1),Integer(1)+p):\n----> 7         dfdx_a_bernoullis += [(f.diff(symb,k-Integer(1)))*(bernoulli(k)/factorial(k))]\n      8 \n      9     sum_dfdx_a_bernoullis = sum(dfdx_a_bernoullis)\n```\n\neven if symb is y",
    "created_at": "2022-07-24T12:03:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32394#issuecomment-616066",
    "user": "https://github.com/daju1"
}
```

<a id='comment:15'></a>
Replying to [charpent](#comment%3A13):
> I'm not sure that deriving with respect to the sum of two arguments makes sense. Consider :
> 
> ```
> sage: g=function("g")
> sage: g(a, b, c).diff(a)
> diff(g(a, b, c), a)
> sage: g(a, b, c).diff(a+b)
> ---------------------------------------------------------------------------
> TypeError                                 Traceback (most recent call last)
> <ipython-input-53-1221c21f3a0d> in <module>
> ----> 1 g(a, b, c).diff(a+b)
> 
> /usr/local/sage-9/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.derivative (build/cythonized/sage/symbolic/expression.cpp:54855)()
>    4633             ValueError: No differentiation variable specified.
>    4634         """
> -> 4635         return multi_derivative(self, args)
>    4636 
>    4637     diff = differentiate = derivative
> 
> /usr/local/sage-9/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/misc/derivative.pyx in sage.misc.derivative.multi_derivative (build/cythonized/sage/misc/derivative.c:3281)()
>     220 
>     221     for arg in derivative_parse(args):
> --> 222         F = F._derivative(arg)
>     223     return F
>     224 
> 
> /usr/local/sage-9/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._derivative (build/cythonized/sage/symbolic/expression.cpp:55328)()
>    4701         cdef Expression symbol = self.coerce_in(symb)
>    4702         if not is_a_symbol(symbol._gobj):
> -> 4703             raise TypeError("argument symb must be a symbol")
>    4704         cdef GEx x
>    4705         sig_on()
> 
> TypeError: argument symb must be a symbol
> ```
> 
> In our case :
> 
> ```
> sage: F.diff(x,3).diff(y,1).subs({x:j_x+v_x})
> D[0, 0, 0, 1](F)(j_x + v_x, y)
> ```
> 
> So far, so good. But note that this is a *three-argument* function :
> 
> ```
> sage: F.diff(x,3).diff(y,1).subs({x:j_x+v_x}).arguments()
> (j_x, v_x, y)
> ```
> 
> and, as exemplified above, deriving wrt the sum of two of them has no easy meaning...
> 
> Would this :
> 
> ```
> sage: F.diff(x,3).diff(y,1)._sympy_().subs({x._sympy_():j_x._sympy_()+v_x._sympy_()})
> Subs(Derivative(F(x, y), (x, 3), y), x, j_x + v_x)
> ```
> 
> accomplish what you meant ?


Hi, charpent. Please see recently added attachment to understand what I want. I have two functions. First of them:

```
R_px = euler_maclaurin_R_p(F, x, a_x, b_x,p, f_diff_symb_p=F.diff(x,p))
```

by executing the following code

```
                R_p = (-1)^(p+1)*integral(symbolic_sum(f.subs(symb == vx+jx).diff(vx,p)*B(x=vx,p=p)/fact(n=p), \
                                              jx, a, b-1, hold=hold_sum), \
                                          (vx,0,1), hold=hold_int)
```

gives:


```
R_px = integrate(sum(1/12*(2*v_x^3 - 3*v_x^2 + v_x)*D[0, 0, 0](F)(j_x + v_x, y), j_x, n_x, b_x - 1), v_x, 0, 1)
```

Here please note that deriving is really wrt v_x. As for me when I need to have sum of derivatives it is no defference how to derive: wrt v_x or wrt (j_x + v_x) which means just x in the interval from some integer to that integer + 1.

But the second function

```
sumy_R_px = sum_dfdx_bernoulis(R_px, y, a_y, b_y, p)
```


gives Exception here: 


```
/tmp/ipykernel_21688/1831337102.py in sum_dfdx_bernoulis(f, symb, a, b, p)
      5     dfdx_a_bernoullis = []
      6     for k in range(Integer(1),Integer(1)+p):
----> 7         dfdx_a_bernoullis += [(f.diff(symb,k-Integer(1)))*(bernoulli(k)/factorial(k))]
      8 
      9     sum_dfdx_a_bernoullis = sum(dfdx_a_bernoullis)
```

even if symb is y



---

archive/attachments_021548.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "Ticket 32394 Can't calculate derivative wrt pi sqrt.ipynb",
    "asset_url": "tarball://root/attachments/some-uuid/ticket32394/Ticket 32394 Can't calculate derivative wrt pi sqrt.ipynb",
    "created_at": "2022-08-01T16:19:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.ipynb",
    "user": "https://github.com/daju1"
}
```



---

archive/issue_comments_616067.json:
```json
{
    "body": "",
    "created_at": "2022-08-01T16:19:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32394#issuecomment-616067",
    "user": "https://github.com/daju1"
}
```





---

archive/issue_comments_616068.json:
```json
{
    "body": "<a id='comment:16'></a>\nAnother case found which is related with current ticket, inside the attached Jupiter notebook, bellow:\n\n```\nu, a, k_m = var(\"u, a, k_m\")\nn_x, n_y, a_x, a_y, b_x, b_y = var(\"n_x, n_y, a_x, a_y, b_x, b_y\")\np = 4\nf = function('f')(var(\"k_km\"))\nFu = lambda u, n_x, n_y, a, k_m : sqrt(n_x^2 + n_y^2 + u^2)*f(k_km=pi*sqrt(n_x^2 + n_y^2 + u^2)/(a*k_m))\nFu(u, n_x, n_y, a, k_m)\n```\n\n```\nsqrt(n_x^2 + n_y^2 + u^2)*f(pi*sqrt(n_x^2 + n_y^2 + u^2)/(a*k_m))\n```\n\n```\ndef sum_dfdx_bernoulis(f,symb,a,b,p):\n    if logging:\n        print(\"f\", f)\n        print(\"symb,a,b\", symb, a, b)\n    dfdx_a_bernoullis = []\n    for k in range(1,1+p):\n        dfdx_a_bernoullis += [(f.diff(symb,k-1))*(bernoulli(k)/factorial(k))]\n        \n    sum_dfdx_a_bernoullis = sum(dfdx_a_bernoullis)\n\n    if logging:\n        print(\"sum_dfdx_a_bernoullis\", sum_dfdx_a_bernoullis)\n        print(\"sum_dfdx_a_bernoullis(a)\", sum_dfdx_a_bernoullis.subs(symb == a))\n        if Infinity != b:\n            print(\"sum_dfdx_a_bernoullis(b)\", sum_dfdx_a_bernoullis.subs(symb == b))\n\n    s = - sum_dfdx_a_bernoullis.subs(symb == a)\n    if Infinity != b:\n        s += sum_dfdx_a_bernoullis.subs(symb == b)\n    return s\n```\n\n```\nlogging = True\nsum_int_Fu = sum_dfdx_bernoulis(integrate(Fu(u, n_x, n_y, a, k_m),(n_x, a_x, b_x), algorithm=\"sympy\"),  n_y, a_y, b_y, p)\nprint(\"sum_int_Fu=\",sum_int_Fu)\n```\n\n```\nf integrate(sqrt(n_x^2 + n_y^2 + u^2)*f(pi*sqrt(n_x^2 + n_y^2 + u^2)/(a*k_m)), n_x, a_x, b_x)\nsymb,a,b n_y a_y b_y\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-6-7e52451d50cb> in <module>\n      1 logging = True\n----> 2 sum_int_Fu = sum_dfdx_bernoulis(integrate(Fu(u, n_x, n_y, a, k_m),(n_x, a_x, b_x), algorithm=\"sympy\"),  n_y, a_y, b_y, p)\n      3 print(\"sum_int_Fu=\",sum_int_Fu)\n      4 display(Math(latex(sum_int_Fu)))\n\n<ipython-input-5-9d1e47158c9f> in sum_dfdx_bernoulis(f, symb, a, b, p)\n      5     dfdx_a_bernoullis = []\n      6     for k in range(Integer(1),Integer(1)+p):\n----> 7         dfdx_a_bernoullis += [(f.diff(symb,k-Integer(1)))*(bernoulli(k)/factorial(k))]\n      8 \n      9     sum_dfdx_a_bernoullis = sum(dfdx_a_bernoullis)\n\n/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.derivative (build/cythonized/sage/symbolic/expression.cpp:26932)()\n   4273             ValueError: No differentiation variable specified.\n   4274         \"\"\"\n-> 4275         return multi_derivative(self, args)\n   4276 \n   4277     diff = differentiate = derivative\n\n/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/misc/derivative.pyx in sage.misc.derivative.multi_derivative (build/cythonized/sage/misc/derivative.c:3177)()\n    220 \n    221     for arg in derivative_parse(args):\n--> 222         F = F._derivative(arg)\n    223     return F\n    224 \n\n/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._derivative (build/cythonized/sage/symbolic/expression.cpp:27455)()\n   4345         sig_on()\n   4346         try:\n-> 4347             x = self._gobj.diff(ex_to_symbol(symbol._gobj), deg)\n   4348         finally:\n   4349             sig_off()\n\n/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/integration/integral.py in _tderivative_(self, f, x, a, b, diff_param)\n    288         if not x.has(diff_param):\n    289             # integration variable != differentiation variable\n--> 290             ans = definite_integral(f.diff(diff_param), x, a, b)\n    291         else:\n    292             ans = SR.zero()\n\n/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/function.pyx in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:12501)()\n   1152             res = self._evalf_try_(*args)\n   1153             if res is None:\n-> 1154                 res = super(BuiltinFunction, self).__call__(\n   1155                         *args, coerce=coerce, hold=hold)\n   1156 \n\n/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/function.pyx in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.cpp:7034)()\n    595             for i from 0 <= i < len(args):\n    596                 vec.push_back((<Expression>args[i])._gobj)\n--> 597             res = g_function_evalv(self._serial, vec, hold)\n    598         elif self._nargs == 1:\n    599             res = g_function_eval1(self._serial,\n\n/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/function.pyx in sage.symbolic.function.BuiltinFunction._evalf_or_eval_ (build/cythonized/sage/symbolic/function.cpp:13657)()\n   1240         res = self._evalf_try_(*args)\n   1241         if res is None:\n-> 1242             return self._eval0_(*args)\n   1243         else:\n   1244             return res\n\n/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/integration/integral.py in _eval_(self, f, x, a, b)\n    221         for integrator in self.integrators:\n    222             try:\n--> 223                 A = integrator(*args)\n    224             except (NotImplementedError, TypeError,\n    225                     AttributeError, RuntimeError):\n\n/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/integration/external.py in sympy_integrator(expression, v, a, b)\n     61     \"\"\"\n     62     import sympy\n---> 63     ex = expression._sympy_()\n     64     v = v._sympy_()\n     65     if a is None:\n\n/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._sympy_ (build/cythonized/sage/symbolic/expression.cpp:12437)()\n   1705         \"\"\"\n   1706         from sage.symbolic.expression_conversions import sympy_converter\n-> 1707         return sympy_converter(self)\n   1708 \n   1709     def _fricas_init_(self):\n\n/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in __call__(self, ex)\n    216                 div = self.get_fake_div(ex)\n    217                 return self.arithmetic(div, div.operator())\n--> 218             return self.arithmetic(ex, operator)\n    219         elif operator in relation_operators:\n    220             return self.relation(ex, operator)\n\n/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in arithmetic(self, ex, operator)\n    718         import sympy\n    719         operator = arithmetic_operators[operator]\n--> 720         ops = [sympy.sympify(self(a), evaluate=False) for a in ex.operands()]\n    721         if operator == \"+\":\n    722             return sympy.Add(*ops)\n\n/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in <listcomp>(.0)\n    718         import sympy\n    719         operator = arithmetic_operators[operator]\n--> 720         ops = [sympy.sympify(self(a), evaluate=False) for a in ex.operands()]\n    721         if operator == \"+\":\n    722             return sympy.Add(*ops)\n\n/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in __call__(self, ex)\n    216                 div = self.get_fake_div(ex)\n    217                 return self.arithmetic(div, div.operator())\n--> 218             return self.arithmetic(ex, operator)\n    219         elif operator in relation_operators:\n    220             return self.relation(ex, operator)\n\n/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in arithmetic(self, ex, operator)\n    718         import sympy\n    719         operator = arithmetic_operators[operator]\n--> 720         ops = [sympy.sympify(self(a), evaluate=False) for a in ex.operands()]\n    721         if operator == \"+\":\n    722             return sympy.Add(*ops)\n\n/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in <listcomp>(.0)\n    718         import sympy\n    719         operator = arithmetic_operators[operator]\n--> 720         ops = [sympy.sympify(self(a), evaluate=False) for a in ex.operands()]\n    721         if operator == \"+\":\n    722             return sympy.Add(*ops)\n\n/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in __call__(self, ex)\n    220             return self.relation(ex, operator)\n    221         elif isinstance(operator, FDerivativeOperator):\n--> 222             return self.derivative(ex, operator)\n    223         elif operator == tuple:\n    224             return self.tuple(ex)\n\n/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in derivative(self, ex, operator)\n    913 \n    914         f_sympy = f._sympy_()(*_args)\n--> 915         result = f_sympy.diff(*sympy_arg)\n    916         if subs_new:\n    917             return sympy.Subs(result, subs_new, subs_old)\n\n/opt/sagemath-9.2/local/lib/python3.7/site-packages/sympy/core/expr.py in diff(self, *symbols, **assumptions)\n   3385     def diff(self, *symbols, **assumptions):\n   3386         assumptions.setdefault(\"evaluate\", True)\n-> 3387         return Derivative(self, *symbols, **assumptions)\n   3388 \n   3389     ###########################################################################\n\n/opt/sagemath-9.2/local/lib/python3.7/site-packages/sympy/core/function.py in __new__(cls, expr, *variables, **kwargs)\n   1328                 raise ValueError(filldedent('''\n   1329                     Can't calculate derivative wrt %s.%s''' % (v,\n-> 1330                     __)))\n   1331 \n   1332         # We make a special case for 0th derivative, because there is no\n\nValueError: \nCan't calculate derivative wrt pi*sqrt(n_x**2 + n_y**2 +\nu**2)/(a*k_m).\n\n```\n\n\n\nAlso I see that commits provided by me inside current ticket fix this example",
    "created_at": "2022-08-01T16:27:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32394#issuecomment-616068",
    "user": "https://github.com/daju1"
}
```

<a id='comment:16'></a>
Another case found which is related with current ticket, inside the attached Jupiter notebook, bellow:

```
u, a, k_m = var("u, a, k_m")
n_x, n_y, a_x, a_y, b_x, b_y = var("n_x, n_y, a_x, a_y, b_x, b_y")
p = 4
f = function('f')(var("k_km"))
Fu = lambda u, n_x, n_y, a, k_m : sqrt(n_x^2 + n_y^2 + u^2)*f(k_km=pi*sqrt(n_x^2 + n_y^2 + u^2)/(a*k_m))
Fu(u, n_x, n_y, a, k_m)
```

```
sqrt(n_x^2 + n_y^2 + u^2)*f(pi*sqrt(n_x^2 + n_y^2 + u^2)/(a*k_m))
```

```
def sum_dfdx_bernoulis(f,symb,a,b,p):
    if logging:
        print("f", f)
        print("symb,a,b", symb, a, b)
    dfdx_a_bernoullis = []
    for k in range(1,1+p):
        dfdx_a_bernoullis += [(f.diff(symb,k-1))*(bernoulli(k)/factorial(k))]
        
    sum_dfdx_a_bernoullis = sum(dfdx_a_bernoullis)

    if logging:
        print("sum_dfdx_a_bernoullis", sum_dfdx_a_bernoullis)
        print("sum_dfdx_a_bernoullis(a)", sum_dfdx_a_bernoullis.subs(symb == a))
        if Infinity != b:
            print("sum_dfdx_a_bernoullis(b)", sum_dfdx_a_bernoullis.subs(symb == b))

    s = - sum_dfdx_a_bernoullis.subs(symb == a)
    if Infinity != b:
        s += sum_dfdx_a_bernoullis.subs(symb == b)
    return s
```

```
logging = True
sum_int_Fu = sum_dfdx_bernoulis(integrate(Fu(u, n_x, n_y, a, k_m),(n_x, a_x, b_x), algorithm="sympy"),  n_y, a_y, b_y, p)
print("sum_int_Fu=",sum_int_Fu)
```

```
f integrate(sqrt(n_x^2 + n_y^2 + u^2)*f(pi*sqrt(n_x^2 + n_y^2 + u^2)/(a*k_m)), n_x, a_x, b_x)
symb,a,b n_y a_y b_y
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-6-7e52451d50cb> in <module>
      1 logging = True
----> 2 sum_int_Fu = sum_dfdx_bernoulis(integrate(Fu(u, n_x, n_y, a, k_m),(n_x, a_x, b_x), algorithm="sympy"),  n_y, a_y, b_y, p)
      3 print("sum_int_Fu=",sum_int_Fu)
      4 display(Math(latex(sum_int_Fu)))

<ipython-input-5-9d1e47158c9f> in sum_dfdx_bernoulis(f, symb, a, b, p)
      5     dfdx_a_bernoullis = []
      6     for k in range(Integer(1),Integer(1)+p):
----> 7         dfdx_a_bernoullis += [(f.diff(symb,k-Integer(1)))*(bernoulli(k)/factorial(k))]
      8 
      9     sum_dfdx_a_bernoullis = sum(dfdx_a_bernoullis)

/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.derivative (build/cythonized/sage/symbolic/expression.cpp:26932)()
   4273             ValueError: No differentiation variable specified.
   4274         """
-> 4275         return multi_derivative(self, args)
   4276 
   4277     diff = differentiate = derivative

/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/misc/derivative.pyx in sage.misc.derivative.multi_derivative (build/cythonized/sage/misc/derivative.c:3177)()
    220 
    221     for arg in derivative_parse(args):
--> 222         F = F._derivative(arg)
    223     return F
    224 

/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._derivative (build/cythonized/sage/symbolic/expression.cpp:27455)()
   4345         sig_on()
   4346         try:
-> 4347             x = self._gobj.diff(ex_to_symbol(symbol._gobj), deg)
   4348         finally:
   4349             sig_off()

/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/integration/integral.py in _tderivative_(self, f, x, a, b, diff_param)
    288         if not x.has(diff_param):
    289             # integration variable != differentiation variable
--> 290             ans = definite_integral(f.diff(diff_param), x, a, b)
    291         else:
    292             ans = SR.zero()

/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/function.pyx in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:12501)()
   1152             res = self._evalf_try_(*args)
   1153             if res is None:
-> 1154                 res = super(BuiltinFunction, self).__call__(
   1155                         *args, coerce=coerce, hold=hold)
   1156 

/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/function.pyx in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.cpp:7034)()
    595             for i from 0 <= i < len(args):
    596                 vec.push_back((<Expression>args[i])._gobj)
--> 597             res = g_function_evalv(self._serial, vec, hold)
    598         elif self._nargs == 1:
    599             res = g_function_eval1(self._serial,

/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/function.pyx in sage.symbolic.function.BuiltinFunction._evalf_or_eval_ (build/cythonized/sage/symbolic/function.cpp:13657)()
   1240         res = self._evalf_try_(*args)
   1241         if res is None:
-> 1242             return self._eval0_(*args)
   1243         else:
   1244             return res

/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/integration/integral.py in _eval_(self, f, x, a, b)
    221         for integrator in self.integrators:
    222             try:
--> 223                 A = integrator(*args)
    224             except (NotImplementedError, TypeError,
    225                     AttributeError, RuntimeError):

/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/integration/external.py in sympy_integrator(expression, v, a, b)
     61     """
     62     import sympy
---> 63     ex = expression._sympy_()
     64     v = v._sympy_()
     65     if a is None:

/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression._sympy_ (build/cythonized/sage/symbolic/expression.cpp:12437)()
   1705         """
   1706         from sage.symbolic.expression_conversions import sympy_converter
-> 1707         return sympy_converter(self)
   1708 
   1709     def _fricas_init_(self):

/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in __call__(self, ex)
    216                 div = self.get_fake_div(ex)
    217                 return self.arithmetic(div, div.operator())
--> 218             return self.arithmetic(ex, operator)
    219         elif operator in relation_operators:
    220             return self.relation(ex, operator)

/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in arithmetic(self, ex, operator)
    718         import sympy
    719         operator = arithmetic_operators[operator]
--> 720         ops = [sympy.sympify(self(a), evaluate=False) for a in ex.operands()]
    721         if operator == "+":
    722             return sympy.Add(*ops)

/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in <listcomp>(.0)
    718         import sympy
    719         operator = arithmetic_operators[operator]
--> 720         ops = [sympy.sympify(self(a), evaluate=False) for a in ex.operands()]
    721         if operator == "+":
    722             return sympy.Add(*ops)

/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in __call__(self, ex)
    216                 div = self.get_fake_div(ex)
    217                 return self.arithmetic(div, div.operator())
--> 218             return self.arithmetic(ex, operator)
    219         elif operator in relation_operators:
    220             return self.relation(ex, operator)

/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in arithmetic(self, ex, operator)
    718         import sympy
    719         operator = arithmetic_operators[operator]
--> 720         ops = [sympy.sympify(self(a), evaluate=False) for a in ex.operands()]
    721         if operator == "+":
    722             return sympy.Add(*ops)

/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in <listcomp>(.0)
    718         import sympy
    719         operator = arithmetic_operators[operator]
--> 720         ops = [sympy.sympify(self(a), evaluate=False) for a in ex.operands()]
    721         if operator == "+":
    722             return sympy.Add(*ops)

/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in __call__(self, ex)
    220             return self.relation(ex, operator)
    221         elif isinstance(operator, FDerivativeOperator):
--> 222             return self.derivative(ex, operator)
    223         elif operator == tuple:
    224             return self.tuple(ex)

/opt/sagemath-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression_conversions.py in derivative(self, ex, operator)
    913 
    914         f_sympy = f._sympy_()(*_args)
--> 915         result = f_sympy.diff(*sympy_arg)
    916         if subs_new:
    917             return sympy.Subs(result, subs_new, subs_old)

/opt/sagemath-9.2/local/lib/python3.7/site-packages/sympy/core/expr.py in diff(self, *symbols, **assumptions)
   3385     def diff(self, *symbols, **assumptions):
   3386         assumptions.setdefault("evaluate", True)
-> 3387         return Derivative(self, *symbols, **assumptions)
   3388 
   3389     ###########################################################################

/opt/sagemath-9.2/local/lib/python3.7/site-packages/sympy/core/function.py in __new__(cls, expr, *variables, **kwargs)
   1328                 raise ValueError(filldedent('''
   1329                     Can't calculate derivative wrt %s.%s''' % (v,
-> 1330                     __)))
   1331 
   1332         # We make a special case for 0th derivative, because there is no

ValueError: 
Can't calculate derivative wrt pi*sqrt(n_x**2 + n_y**2 +
u**2)/(a*k_m).

```



Also I see that commits provided by me inside current ticket fix this example



---

archive/issue_events_097016.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32394#event-97016"
}
```



---

archive/issue_events_097017.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32394",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32394#event-97017"
}
```
