# Issue 32726: quaternion ideals' .scale() incorrectly copies cached left and right orders

archive/issues_032489.json:
```json
{
    "body": "The method `QuaternionFractionalIdeal_rational.scale()` always copies over the existing left and right orders of `self` to the scaled ideal. This is incorrect when the scaling factor does not lie in the center of the algebra, as demonstrated by this example:\n\n```sage\nsage: Quat.<i,j,k> = QuaternionAlgebra(-1,-19)\nsage: a = 1+2*i+3*j+4*k\nsage: I = Quat.maximal_order().unit_ideal()\nsage: I.right_order()\nOrder of Quaternion Algebra (-1, -19) with base ring Rational Field with basis (1/2 + 1/2*j, 1/2*i + 1/2*k, j, k)\nsage: I.scale(a).right_order()\nOrder of Quaternion Algebra (-1, -19) with base ring Rational Field with basis (1/2 + 1/2*j, 1/2*i + 1/2*k, j, k)\nsage: J = Quat.ideal(I.scale(a).basis(), check=False)\nsage: J == I.scale(a)\nTrue\nsage: J.right_order()\nOrder of Quaternion Algebra (-1, -19) with base ring Rational Field with basis (1/2 + 1/10*j + 109/5*k, 1/48*i + 1/120*j + 8411/240*k, 1/5*j + 218/5*k, 120*k)\n```\n\nThe patch fixes this by only copying over the cached orders when scaling on the other side, or when scaling by an element of `QQ`.\n\nCC:  @pjbruin\n\nBranch/Commit: 4310b6cd1626145b94b3e8446850350c734e8487\n\nStopgaps: mathematically_wrong\n\nReviewer: Michael Orlitzky\n\nAuthor: Lorenz Panny\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32726\n\n",
    "closed_at": "2022-01-31T23:31:19Z",
    "created_at": "2021-10-20T06:52:32Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "quaternion ideals' .scale() incorrectly copies cached left and right orders",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32726",
    "user": "https://github.com/yyyyx4"
}
```
The method `QuaternionFractionalIdeal_rational.scale()` always copies over the existing left and right orders of `self` to the scaled ideal. This is incorrect when the scaling factor does not lie in the center of the algebra, as demonstrated by this example:

```sage
sage: Quat.<i,j,k> = QuaternionAlgebra(-1,-19)
sage: a = 1+2*i+3*j+4*k
sage: I = Quat.maximal_order().unit_ideal()
sage: I.right_order()
Order of Quaternion Algebra (-1, -19) with base ring Rational Field with basis (1/2 + 1/2*j, 1/2*i + 1/2*k, j, k)
sage: I.scale(a).right_order()
Order of Quaternion Algebra (-1, -19) with base ring Rational Field with basis (1/2 + 1/2*j, 1/2*i + 1/2*k, j, k)
sage: J = Quat.ideal(I.scale(a).basis(), check=False)
sage: J == I.scale(a)
True
sage: J.right_order()
Order of Quaternion Algebra (-1, -19) with base ring Rational Field with basis (1/2 + 1/10*j + 109/5*k, 1/48*i + 1/120*j + 8411/240*k, 1/5*j + 218/5*k, 120*k)
```

The patch fixes this by only copying over the cached orders when scaling on the other side, or when scaling by an element of `QQ`.

CC:  @pjbruin

Branch/Commit: 4310b6cd1626145b94b3e8446850350c734e8487

Stopgaps: mathematically_wrong

Reviewer: Michael Orlitzky

Author: Lorenz Panny

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/32726





---

archive/issue_comments_652104.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-10-20T08:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32726#issuecomment-652104",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_652105.json:
```json
{
    "body": "Changing branch from \"\" to \"public/32726\"",
    "created_at": "2021-10-20T08:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32726#issuecomment-652105",
    "user": "https://github.com/yyyyx4"
}
```

Changing branch from "" to "public/32726"



---

archive/issue_comments_652106.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-The method `QuaternionFractionalIdeal_rational.scale()` simply copies over the existing left and right orders of `self` to the scaled ideal. This is incorrect when the scaling factor does not lie in the center of the algebra, as demonstrated by this example:\n+The method `QuaternionFractionalIdeal_rational.scale()` always copies over the existing left and right orders of `self` to the scaled ideal. This is incorrect when the scaling factor does not lie in the center of the algebra, as demonstrated by this example:\n \n ```sage\n sage: Quat.<i,j,k> = QuaternionAlgebra(-1,-19)\n@@ -14,3 +14,5 @@\n sage: J.right_order()\n Order of Quaternion Algebra (-1, -19) with base ring Rational Field with basis (1/2 + 1/10*j + 109/5*k, 1/48*i + 1/120*j + 8411/240*k, 1/5*j + 218/5*k, 120*k)\n ```\n+\n+The patch fixes this by only copying over the cached orders when scaling on the other side, or when scaling by an element of `QQ`.\n``````\n",
    "created_at": "2021-10-20T08:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32726#issuecomment-652106",
    "user": "https://github.com/yyyyx4"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-The method `QuaternionFractionalIdeal_rational.scale()` simply copies over the existing left and right orders of `self` to the scaled ideal. This is incorrect when the scaling factor does not lie in the center of the algebra, as demonstrated by this example:
+The method `QuaternionFractionalIdeal_rational.scale()` always copies over the existing left and right orders of `self` to the scaled ideal. This is incorrect when the scaling factor does not lie in the center of the algebra, as demonstrated by this example:
 
 ```sage
 sage: Quat.<i,j,k> = QuaternionAlgebra(-1,-19)
@@ -14,3 +14,5 @@
 sage: J.right_order()
 Order of Quaternion Algebra (-1, -19) with base ring Rational Field with basis (1/2 + 1/10*j + 109/5*k, 1/48*i + 1/120*j + 8411/240*k, 1/5*j + 218/5*k, 120*k)
 ```
+
+The patch fixes this by only copying over the cached orders when scaling on the other side, or when scaling by an element of `QQ`.
``````




---

archive/issue_comments_652107.json:
```json
{
    "body": "Changing author from \"\" to \"Lorenz Panny\"",
    "created_at": "2021-10-20T08:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32726#issuecomment-652107",
    "user": "https://github.com/yyyyx4"
}
```

Changing author from "" to "Lorenz Panny"



---

archive/issue_comments_652108.json:
```json
{
    "body": "Changing commit from \"\" to \"ef98f79ed0230473314c66b2996312c925c4dfb5\"",
    "created_at": "2021-10-20T08:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32726#issuecomment-652108",
    "user": "https://github.com/yyyyx4"
}
```

Changing commit from "" to "ef98f79ed0230473314c66b2996312c925c4dfb5"



---

archive/issue_comments_652109.json:
```json
{
    "body": "<a id='comment:2'></a>\nBumping priority since this bug can lead to mathematical errors.",
    "created_at": "2021-10-21T02:59:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32726#issuecomment-652109",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:2'></a>
Bumping priority since this bug can lead to mathematical errors.



---

archive/issue_events_086638.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:53:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32726",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32726#event-86638"
}
```



---

archive/issue_comments_652110.json:
```json
{
    "body": "<a id='comment:3'></a>\nStalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32726#issuecomment-652110",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>
Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.



---

archive/issue_comments_652111.json:
```json
{
    "body": "Changing commit from \"ef98f79ed0230473314c66b2996312c925c4dfb5\" to \"4310b6cd1626145b94b3e8446850350c734e8487\"",
    "created_at": "2022-01-18T09:03:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32726#issuecomment-652111",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "ef98f79ed0230473314c66b2996312c925c4dfb5" to "4310b6cd1626145b94b3e8446850350c734e8487"



---

archive/issue_comments_652112.json:
```json
{
    "body": "<a id='comment:4'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                       |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------|\n|[4310b6c](https://git.sagemath.org/sage.git/commit/?id=4310b6cd1626145b94b3e8446850350c734e8487)|`Merge tag '9.5.rc2' into public/32726`|",
    "created_at": "2022-01-18T09:03:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32726#issuecomment-652112",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                       |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------|
|[4310b6c](https://git.sagemath.org/sage.git/commit/?id=4310b6cd1626145b94b3e8446850350c734e8487)|`Merge tag '9.5.rc2' into public/32726`|



---

archive/issue_comments_652113.json:
```json
{
    "body": "<a id='comment:5'></a>\nThis looks OK to me but I'm not an expert so I have two questions:\n\n1. I guess scaling on the right doesn't affect the left order, and vice-versa?\n2. Is it OK to assume that the base ring is `QQ`?",
    "created_at": "2022-01-23T21:50:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32726#issuecomment-652113",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:5'></a>
This looks OK to me but I'm not an expert so I have two questions:

1. I guess scaling on the right doesn't affect the left order, and vice-versa?
2. Is it OK to assume that the base ring is `QQ`?



---

archive/issue_comments_652114.json:
```json
{
    "body": "<a id='comment:6'></a>\nThanks for having a look.\n\n1. Yes; the left order of `I` is `{x in the algebra | x\u00b7I \u2286 I}`. Scaling happens element-wise, so these inclusions are preserved under right scaling. Similarly on the other side.\n2. Yes; the class `QuaternionFractionalIdeal_rational` is specific to `QQ`.",
    "created_at": "2022-01-24T02:40:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32726#issuecomment-652114",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:6'></a>
Thanks for having a look.

1. Yes; the left order of `I` is `{x in the algebra | x·I ⊆ I}`. Scaling happens element-wise, so these inclusions are preserved under right scaling. Similarly on the other side.
2. Yes; the class `QuaternionFractionalIdeal_rational` is specific to `QQ`.



---

archive/issue_comments_652115.json:
```json
{
    "body": "<a id='comment:7'></a>\nLGTM then, thanks.",
    "created_at": "2022-01-24T12:49:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32726#issuecomment-652115",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:7'></a>
LGTM then, thanks.



---

archive/issue_comments_652116.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-01-24T12:49:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32726#issuecomment-652116",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_652117.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Michael Orlitzky\"",
    "created_at": "2022-01-24T12:49:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32726#issuecomment-652117",
    "user": "https://github.com/orlitzky"
}
```

Changing reviewer from "" to "Michael Orlitzky"



---

archive/issue_comments_652118.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-01-31T23:31:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32726#issuecomment-652118",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_652119.json:
```json
{
    "body": "Changing branch from \"public/32726\" to \"4310b6cd1626145b94b3e8446850350c734e8487\"",
    "created_at": "2022-01-31T23:31:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32726",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32726#issuecomment-652119",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/32726" to "4310b6cd1626145b94b3e8446850350c734e8487"



---

archive/issue_events_086639.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-01-31T23:31:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32726",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32726#event-86639"
}
```
