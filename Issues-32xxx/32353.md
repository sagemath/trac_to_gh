# Issue 32353: Guide for parents with immutable elements

archive/issues_032116.json:
```json
{
    "body": "This ticket aims to solve the issue that arose in the thread\n\nhttps://groups.google.com/g/sage-devel/c/DNrbtItMVmQ\n\n(related tickets #29101, #30302, #30239, #23436, #14681, #13811, #19813) by implementing parents with immutable elements, which exist side by side with their twin parents with mutable elements. \n\nThe following table serves as a guide for the implementation:\n\n|V=VectorSpace(R, 2, mutable=True)|new element  | W=VectorSpace(R, 2, mutable=False)| new element |\n|:---------------------------------:|:-------------:|:-----------------------------------:|:-------------:|\n| v, v                             |             | w, w'                              |             |\n| v+v'                             | O           | w+w'                               |             |\n| v+w, w+v                         | O           |                                    |             |\n| V(v)                             | O           | W(w)                               | X           |\n| V(w)                             | O           | W(v)                               | O           |\n| V(0)                             | O           | W(0)                               | X           |\n| V.zero()                         | O           | W.zero()                           | X           |\n| V([2,3])                         | O           | W([2,3])                           | O           |\n| vector(v)                        | O           | vector(w)                          | X           |\n| vector(R, 2)                     | O           |                                    |             |\n| vector(R, [2,3])                 | O           | vector(R, [2,3], mutable=False)    | O           |\n| copy(v)                          | O           | copy(w)                            | O           |\n| v.mutable()                      | X           | w.immutable()                      | X           |\n| w.mutable()                      | O           | v.immutable()                      | O           |\nIn the table, elements on the left belongs to V; elements on the right to W.\n\nMost parents in Sage have immutable elements and hence don't accept `mutable` argument. Parents that accept `mutable` argument defaults to `mutable=True`.\n\nParents that accept `mutable` argument are: VectorSpace, MatrixSpace, FreeModule, Graph \n\n**CC:**  @kliem @mjungmath @tscrim @egourgoulhon\n\nIssue created by migration from https://trac.sagemath.org/ticket/32353\n\n",
    "created_at": "2021-08-10T02:00:44Z",
    "labels": [
        "component: algebra",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "title": "Guide for parents with immutable elements",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/32353",
    "user": "https://github.com/kwankyu"
}
```
This ticket aims to solve the issue that arose in the thread

https://groups.google.com/g/sage-devel/c/DNrbtItMVmQ

(related tickets #29101, #30302, #30239, #23436, #14681, #13811, #19813) by implementing parents with immutable elements, which exist side by side with their twin parents with mutable elements. 

The following table serves as a guide for the implementation:

|V=VectorSpace(R, 2, mutable=True)|new element  | W=VectorSpace(R, 2, mutable=False)| new element |
|:---------------------------------:|:-------------:|:-----------------------------------:|:-------------:|
| v, v                             |             | w, w'                              |             |
| v+v'                             | O           | w+w'                               |             |
| v+w, w+v                         | O           |                                    |             |
| V(v)                             | O           | W(w)                               | X           |
| V(w)                             | O           | W(v)                               | O           |
| V(0)                             | O           | W(0)                               | X           |
| V.zero()                         | O           | W.zero()                           | X           |
| V([2,3])                         | O           | W([2,3])                           | O           |
| vector(v)                        | O           | vector(w)                          | X           |
| vector(R, 2)                     | O           |                                    |             |
| vector(R, [2,3])                 | O           | vector(R, [2,3], mutable=False)    | O           |
| copy(v)                          | O           | copy(w)                            | O           |
| v.mutable()                      | X           | w.immutable()                      | X           |
| w.mutable()                      | O           | v.immutable()                      | O           |
In the table, elements on the left belongs to V; elements on the right to W.

Most parents in Sage have immutable elements and hence don't accept `mutable` argument. Parents that accept `mutable` argument defaults to `mutable=True`.

Parents that accept `mutable` argument are: VectorSpace, MatrixSpace, FreeModule, Graph 

**CC:**  @kliem @mjungmath @tscrim @egourgoulhon

Issue created by migration from https://trac.sagemath.org/ticket/32353





---

archive/issue_events_290839.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2021-08-10T02:03:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "label": "component: algebra",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32353#event-290839"
}
```



---

archive/issue_events_290840.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2021-08-10T02:03:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "label": "enhancement",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32353#event-290840"
}
```



---

archive/issue_comments_524024.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,6 +1,8 @@\n This ticket aims to solve the issue that arose in the thread\n \n https://groups.google.com/g/sage-devel/c/DNrbtItMVmQ\n+\n+and tickets #29101, #30302, #30239\n \n by implementing parents with mutable elements, which exist side by side with their immutable twin parents. \n \n``````\n",
    "created_at": "2021-08-10T02:06:21Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524024",
    "user": "https://github.com/kwankyu"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,6 +1,8 @@
 This ticket aims to solve the issue that arose in the thread
 
 https://groups.google.com/g/sage-devel/c/DNrbtItMVmQ
+
+and tickets #29101, #30302, #30239
 
 by implementing parents with mutable elements, which exist side by side with their immutable twin parents. 
 
``````




---

archive/issue_comments_524025.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -4,7 +4,7 @@\n \n and tickets #29101, #30302, #30239\n \n-by implementing parents with mutable elements, which exist side by side with their immutable twin parents. \n+by implementing parents with mutable elements, which exist side by side with their twin parents with immutable elements. \n \n The following table serves as a guide for the implementation:\n \n``````\n",
    "created_at": "2021-08-10T02:07:12Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524025",
    "user": "https://github.com/kwankyu"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -4,7 +4,7 @@
 
 and tickets #29101, #30302, #30239
 
-by implementing parents with mutable elements, which exist side by side with their immutable twin parents. 
+by implementing parents with mutable elements, which exist side by side with their twin parents with immutable elements. 
 
 The following table serves as a guide for the implementation:
 
``````




---

archive/issue_comments_524026.json:
```json
{
    "body": "<a id='comment:4'></a>\nFeel free to modify the table as needed.",
    "created_at": "2021-08-10T02:09:36Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524026",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:4'></a>
Feel free to modify the table as needed.



---

archive/issue_comments_524027.json:
```json
{
    "body": "<a id='comment:5'></a>\n`mutable_elements` would be better?",
    "created_at": "2021-08-10T02:13:48Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524027",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:5'></a>
`mutable_elements` would be better?



---

archive/issue_comments_524028.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,9 +2,7 @@\n \n https://groups.google.com/g/sage-devel/c/DNrbtItMVmQ\n \n-and tickets #29101, #30302, #30239\n-\n-by implementing parents with mutable elements, which exist side by side with their twin parents with immutable elements. \n+(related tickets #29101, #30302, #30239) by implementing parents with mutable elements, which exist side by side with their twin parents with immutable elements. \n \n The following table serves as a guide for the implementation:\n \n``````\n",
    "created_at": "2021-08-10T02:14:36Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524028",
    "user": "https://github.com/kwankyu"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,9 +2,7 @@
 
 https://groups.google.com/g/sage-devel/c/DNrbtItMVmQ
 
-and tickets #29101, #30302, #30239
-
-by implementing parents with mutable elements, which exist side by side with their twin parents with immutable elements. 
+(related tickets #29101, #30302, #30239) by implementing parents with mutable elements, which exist side by side with their twin parents with immutable elements. 
 
 The following table serves as a guide for the implementation:
 
``````




---

archive/issue_comments_524029.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -19,7 +19,7 @@\n | vector(v)                        | O           | vector(w)                          | X           |\n | vector(w)                        | O           | vector(v)                          | O           |\n | vector(R, 2)                     | O           |                                    |             |\n-| vector(R, [2,3])                 | O           | vector(R, [2,3])                   | O           |\n+| vector(R, [2,3])                 | O           |                                    |             |\n | copy(v)                          | O           | copy(w)                            | O           |\n | v.mutable()                      | X           | w.immutable()                      | X           |\n | w.mutable()                      | O           | v.immutable()                      | O           |\n``````\n",
    "created_at": "2021-08-10T02:20:17Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524029",
    "user": "https://github.com/kwankyu"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -19,7 +19,7 @@
 | vector(v)                        | O           | vector(w)                          | X           |
 | vector(w)                        | O           | vector(v)                          | O           |
 | vector(R, 2)                     | O           |                                    |             |
-| vector(R, [2,3])                 | O           | vector(R, [2,3])                   | O           |
+| vector(R, [2,3])                 | O           |                                    |             |
 | copy(v)                          | O           | copy(w)                            | O           |
 | v.mutable()                      | X           | w.immutable()                      | X           |
 | w.mutable()                      | O           | v.immutable()                      | O           |
``````




---

archive/issue_comments_524030.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -17,7 +17,6 @@\n | V.zero()                         | O           | W.zero()                           | X           |\n | V([2,3])                         | O           | W([2,3])                           | O           |\n | vector(v)                        | O           | vector(w)                          | X           |\n-| vector(w)                        | O           | vector(v)                          | O           |\n | vector(R, 2)                     | O           |                                    |             |\n | vector(R, [2,3])                 | O           |                                    |             |\n | copy(v)                          | O           | copy(w)                            | O           |\n``````\n",
    "created_at": "2021-08-10T02:21:11Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524030",
    "user": "https://github.com/kwankyu"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -17,7 +17,6 @@
 | V.zero()                         | O           | W.zero()                           | X           |
 | V([2,3])                         | O           | W([2,3])                           | O           |
 | vector(v)                        | O           | vector(w)                          | X           |
-| vector(w)                        | O           | vector(v)                          | O           |
 | vector(R, 2)                     | O           |                                    |             |
 | vector(R, [2,3])                 | O           |                                    |             |
 | copy(v)                          | O           | copy(w)                            | O           |
``````




---

archive/issue_comments_524031.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -18,7 +18,7 @@\n | V([2,3])                         | O           | W([2,3])                           | O           |\n | vector(v)                        | O           | vector(w)                          | X           |\n | vector(R, 2)                     | O           |                                    |             |\n-| vector(R, [2,3])                 | O           |                                    |             |\n+| vector(R, [2,3])                 | O           | vector(R, [2,3], mutable=False)    |             |\n | copy(v)                          | O           | copy(w)                            | O           |\n | v.mutable()                      | X           | w.immutable()                      | X           |\n | w.mutable()                      | O           | v.immutable()                      | O           |\n``````\n",
    "created_at": "2021-08-10T02:22:50Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524031",
    "user": "https://github.com/kwankyu"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -18,7 +18,7 @@
 | V([2,3])                         | O           | W([2,3])                           | O           |
 | vector(v)                        | O           | vector(w)                          | X           |
 | vector(R, 2)                     | O           |                                    |             |
-| vector(R, [2,3])                 | O           |                                    |             |
+| vector(R, [2,3])                 | O           | vector(R, [2,3], mutable=False)    |             |
 | copy(v)                          | O           | copy(w)                            | O           |
 | v.mutable()                      | X           | w.immutable()                      | X           |
 | w.mutable()                      | O           | v.immutable()                      | O           |
``````




---

archive/issue_comments_524032.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -18,7 +18,7 @@\n | V([2,3])                         | O           | W([2,3])                           | O           |\n | vector(v)                        | O           | vector(w)                          | X           |\n | vector(R, 2)                     | O           |                                    |             |\n-| vector(R, [2,3])                 | O           | vector(R, [2,3], mutable=False)    |             |\n+| vector(R, [2,3])                 | O           | vector(R, [2,3], mutable=False)    | O           |\n | copy(v)                          | O           | copy(w)                            | O           |\n | v.mutable()                      | X           | w.immutable()                      | X           |\n | w.mutable()                      | O           | v.immutable()                      | O           |\n``````\n",
    "created_at": "2021-08-10T02:23:15Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524032",
    "user": "https://github.com/kwankyu"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -18,7 +18,7 @@
 | V([2,3])                         | O           | W([2,3])                           | O           |
 | vector(v)                        | O           | vector(w)                          | X           |
 | vector(R, 2)                     | O           |                                    |             |
-| vector(R, [2,3])                 | O           | vector(R, [2,3], mutable=False)    |             |
+| vector(R, [2,3])                 | O           | vector(R, [2,3], mutable=False)    | O           |
 | copy(v)                          | O           | copy(w)                            | O           |
 | v.mutable()                      | X           | w.immutable()                      | X           |
 | w.mutable()                      | O           | v.immutable()                      | O           |
``````




---

archive/issue_comments_524033.json:
```json
{
    "body": "<a id='comment:11'></a>\nPerhaps we don't need `vector(R, [2,3], mutable=False)` if we can get the same vector by `vector(R, [2,3]).immutable()`.",
    "created_at": "2021-08-10T02:29:52Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524033",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:11'></a>
Perhaps we don't need `vector(R, [2,3], mutable=False)` if we can get the same vector by `vector(R, [2,3]).immutable()`.



---

archive/issue_comments_524034.json:
```json
{
    "body": "<a id='comment:12'></a>\nNice chart! Thanks. A few comments:\n- I'd be hesitant using `mutable` as an attribute on the parent for this. It can be mistaken for referring to the parent itself (which must be immutable in most cases). It's nice that it corresponds with the keyword on `vector`, though (where `mutable` is definitely fine), so perhaps we can live with it. Alternatives like `mutable_elements` or `mutable_vectors` look verbose and painful.\n- I'd expect `vector(R,[2,3]).immutable()` to return an immutable copy. The keyword on the constructor is to imply that `set_immutable()` is called on it. A passthrough function like\n\n```\ndef imm(v):\n    v.setImmutable()\n    return v\n```\nwould do the trick, but at the expense of violating the (soft) principle that routines with side-effects should normally return `None`.",
    "created_at": "2021-08-10T02:50:58Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524034",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:12'></a>
Nice chart! Thanks. A few comments:
- I'd be hesitant using `mutable` as an attribute on the parent for this. It can be mistaken for referring to the parent itself (which must be immutable in most cases). It's nice that it corresponds with the keyword on `vector`, though (where `mutable` is definitely fine), so perhaps we can live with it. Alternatives like `mutable_elements` or `mutable_vectors` look verbose and painful.
- I'd expect `vector(R,[2,3]).immutable()` to return an immutable copy. The keyword on the constructor is to imply that `set_immutable()` is called on it. A passthrough function like

```
def imm(v):
    v.setImmutable()
    return v
```
would do the trick, but at the expense of violating the (soft) principle that routines with side-effects should normally return `None`.



---

archive/issue_comments_524035.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [nbruin](#comment%3A12):\n> I'd be hesitant using `mutable` as an attribute on the parent for this. It can be mistaken for referring to the parent itself (which must be immutable in most cases). It's nice that it corresponds with the keyword on `vector`, though (where `mutable` is definitely fine), so perhaps we can live with it. Alternatives like `mutable_elements` or `mutable_vectors` look verbose and painful.\n\nSo your conclusion is ... to live with `mutable`? `mutable_vectors` is not an alternative since we want one consistent keyword for both VectorSpace and MatrixSpace. `mutable_elts` is a bit shorter alternative. \n\n\n> - I'd expect `vector(R,[2,3]).immutable()` to return an immutable copy. \n\nYes.\n\n> The keyword on the constructor is to imply that `set_immutable()` is called on it. \n\nYou are referring to `vector(R, [2,3], mutable=False)`? I think this first retrieves W and then construct an element of W. So this would be more efficient than `vector(R, [2,3]).immutable()`, which first constructs a vector in V and then convert it to an element of W. \n\nHere I am getting confused between switching immutability flag for a vector and changing its parent between V and W...\n\n> A passthrough function like\n> \n> ```\n> def imm(v):\n>     v.setImmutable()\n>     return v\n> ```\n> would do the trick, but at the expense of violating the (soft) principle that routines with side-effects should normally return `None`.\n\nIf you want, perhaps we can have both (method and function).",
    "created_at": "2021-08-10T04:16:00Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524035",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:13'></a>
Replying to [nbruin](#comment%3A12):
> I'd be hesitant using `mutable` as an attribute on the parent for this. It can be mistaken for referring to the parent itself (which must be immutable in most cases). It's nice that it corresponds with the keyword on `vector`, though (where `mutable` is definitely fine), so perhaps we can live with it. Alternatives like `mutable_elements` or `mutable_vectors` look verbose and painful.

So your conclusion is ... to live with `mutable`? `mutable_vectors` is not an alternative since we want one consistent keyword for both VectorSpace and MatrixSpace. `mutable_elts` is a bit shorter alternative. 


> - I'd expect `vector(R,[2,3]).immutable()` to return an immutable copy. 

Yes.

> The keyword on the constructor is to imply that `set_immutable()` is called on it. 

You are referring to `vector(R, [2,3], mutable=False)`? I think this first retrieves W and then construct an element of W. So this would be more efficient than `vector(R, [2,3]).immutable()`, which first constructs a vector in V and then convert it to an element of W. 

Here I am getting confused between switching immutability flag for a vector and changing its parent between V and W...

> A passthrough function like
> 
> ```
> def imm(v):
>     v.setImmutable()
>     return v
> ```
> would do the trick, but at the expense of violating the (soft) principle that routines with side-effects should normally return `None`.

If you want, perhaps we can have both (method and function).



---

archive/issue_comments_524036.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [klee](#comment%3A13):\n> You are referring to `vector(R, [2,3], mutable=False)`? I think this first retrieves W and then construct an element of W. So this would be more efficient than `vector(R, [2,3]).immutable()`, which first constructs a vector in V and then convert it to an element of W. \n> \n> Here I am getting confused between switching immutability flag for a vector and changing its parent between V and W...\n\nI don't think the proposal (up to now) included switching parents based on whether an element is immutable or not. The way I understand it, `V` can have elements that are mutable as well as elements that are immutable. That's the state of affairs now, and I don't think we'd want to change that without a good reason.\n\nAs far as I'm concerned, `W` can also have elements of either mutability state. However, elements in W would by default be immutable, and then they cannot change. However, `W._element_constructor([1,2,3],mutable=True)` could just return a mutable element. I think we're just trying to specify the behaviour of `W.element_constructor` if a `mutable` optional parameter is not given. In that case, the \"default\" setting should take effect, and that is where V and W and different.\n\nI'm pretty sure we should not be changing the parent of `v` when executing `v.set_immutable()`.",
    "created_at": "2021-08-10T04:49:51Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524036",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:14'></a>
Replying to [klee](#comment%3A13):
> You are referring to `vector(R, [2,3], mutable=False)`? I think this first retrieves W and then construct an element of W. So this would be more efficient than `vector(R, [2,3]).immutable()`, which first constructs a vector in V and then convert it to an element of W. 
> 
> Here I am getting confused between switching immutability flag for a vector and changing its parent between V and W...

I don't think the proposal (up to now) included switching parents based on whether an element is immutable or not. The way I understand it, `V` can have elements that are mutable as well as elements that are immutable. That's the state of affairs now, and I don't think we'd want to change that without a good reason.

As far as I'm concerned, `W` can also have elements of either mutability state. However, elements in W would by default be immutable, and then they cannot change. However, `W._element_constructor([1,2,3],mutable=True)` could just return a mutable element. I think we're just trying to specify the behaviour of `W.element_constructor` if a `mutable` optional parameter is not given. In that case, the "default" setting should take effect, and that is where V and W and different.

I'm pretty sure we should not be changing the parent of `v` when executing `v.set_immutable()`.



---

archive/issue_comments_524037.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [nbruin](#comment%3A14):\n> However, `W._element_constructor([1,2,3],mutable=True)` could just return a mutable element. \n\nSo the returned vector is a mutable element of `W`? Then the last line of the chart is wrong. \n\nHow about the third? How would `v+w` or `w+v` behave?",
    "created_at": "2021-08-10T05:16:46Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524037",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:15'></a>
Replying to [nbruin](#comment%3A14):
> However, `W._element_constructor([1,2,3],mutable=True)` could just return a mutable element. 

So the returned vector is a mutable element of `W`? Then the last line of the chart is wrong. 

How about the third? How would `v+w` or `w+v` behave?



---

archive/issue_comments_524038.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [klee](#comment%3A15):\n> Replying to [nbruin](#comment%3A14):\n> > However, `W._element_constructor([1,2,3],mutable=True)` could just return a mutable element. \n\n> \n> So the returned vector is a mutable element of `W`? Then the last line of the chart is wrong. \n\nYes, or an error, depending on whether \"immutable_elt\" parents still allow mutable elements as well. It would be strange to get an element with parent V if you just explicitly asked for an element with parent W. So I'd say the last line in the chart is indeed wrong.\n\nWhat the parent of `vector(R, [2,3])` should be is really up for grabs. Perhaps indeed take as cue that whatever the \"mutable\" flag says should be the default on the parent (so that, say, a scalar multiple of the vector again has the property as prescribed)\n\n> How about the third? How would `v+w` or `w+v` behave?\n\nThat's the stickiest. This is for the coercion system to decide. Ideally, there is a coercion arrow in only one direction (so: mutable coerces into immutable or vice versa, but not both). Then there is only one choice that the coercion system can come up with.",
    "created_at": "2021-08-10T06:40:50Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524038",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:16'></a>
Replying to [klee](#comment%3A15):
> Replying to [nbruin](#comment%3A14):
> > However, `W._element_constructor([1,2,3],mutable=True)` could just return a mutable element. 

> 
> So the returned vector is a mutable element of `W`? Then the last line of the chart is wrong. 

Yes, or an error, depending on whether "immutable_elt" parents still allow mutable elements as well. It would be strange to get an element with parent V if you just explicitly asked for an element with parent W. So I'd say the last line in the chart is indeed wrong.

What the parent of `vector(R, [2,3])` should be is really up for grabs. Perhaps indeed take as cue that whatever the "mutable" flag says should be the default on the parent (so that, say, a scalar multiple of the vector again has the property as prescribed)

> How about the third? How would `v+w` or `w+v` behave?

That's the stickiest. This is for the coercion system to decide. Ideally, there is a coercion arrow in only one direction (so: mutable coerces into immutable or vice versa, but not both). Then there is only one choice that the coercion system can come up with.



---

archive/issue_comments_524039.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [nbruin](#comment%3A16):\n> That's the stickiest. This is for the coercion system to decide. Ideally, there is a coercion arrow in only one direction (so: mutable coerces into immutable or vice versa, but not both). Then there is only one choice that the coercion system can come up with.\n\nI feel that this mutable/immutable dual parents idea will not mix well with the current immutability flags for individual vectors.  \n\nTo work out the idea of this ticket, I would rather redefine `set_immutable()` as a method that changes the parent from V to W, and I would define a coercion map from W to V. I guess this may be implemented without serious performance penalty.",
    "created_at": "2021-08-10T08:02:31Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524039",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:17'></a>
Replying to [nbruin](#comment%3A16):
> That's the stickiest. This is for the coercion system to decide. Ideally, there is a coercion arrow in only one direction (so: mutable coerces into immutable or vice versa, but not both). Then there is only one choice that the coercion system can come up with.

I feel that this mutable/immutable dual parents idea will not mix well with the current immutability flags for individual vectors.  

To work out the idea of this ticket, I would rather redefine `set_immutable()` as a method that changes the parent from V to W, and I would define a coercion map from W to V. I guess this may be implemented without serious performance penalty.



---

archive/issue_comments_524040.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [klee](#comment%3A17):\n> I feel that this mutable/immutable dual parents idea will not mix well with the current immutability flags for individual vectors.  \n> \n> To work out the idea of this ticket, I would rather redefine `set_immutable()` as a method that changes the parent from V to W, and I would define a coercion map from W to V. I guess this may be implemented without serious performance penalty.\n\nYou can definitely do this, but it would be a much more comprehensive rewrite and one with much more serious impact on the rest of sage (and on existing code). If elements being mutable or not is a property of the parent rather than of the element, and the changing of mutability status is accomplished by changing the parent on the object itself, then it would seem the most natural arrow would exist from V to W. It would mean that for v in V and w in W, the result v+w would lie in W and (as a side effect!) that afterwards v now lies in w too. This makes it quite efficient to add mutable and immutable vectors, but makes immutability quite infectious.\n\nOne could also stipulate that coercion goes from V to W but that coercion does make a copy. In that case computing v+w is more expensive, the result lies in W, and afterwards v still lies in V. In that case, `v.set_immutable()` can be defined to \"mutate\" the vector into an element of W.\n\nIf coercion goes from W to V then the expensive route is the only option. \"Expensive\" here really means \"a cost that is fully expected\". Normally, coercion does make a copy. It's just that we have more vector spaces with the proposal here.\n\nI think the reality is that the practical proposal of \"immutability on demand\" -- set an element to immutable when it is requested, for instance if its hash is asked -- will win out because it's easier to implement and less disruptive to existing code: it only changes behaviour in cases that are currently an error (although, with pervasive try/except clauses in python, changing when an error is raised can be more disruptive than you think)",
    "created_at": "2021-08-10T16:13:55Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524040",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:18'></a>
Replying to [klee](#comment%3A17):
> I feel that this mutable/immutable dual parents idea will not mix well with the current immutability flags for individual vectors.  
> 
> To work out the idea of this ticket, I would rather redefine `set_immutable()` as a method that changes the parent from V to W, and I would define a coercion map from W to V. I guess this may be implemented without serious performance penalty.

You can definitely do this, but it would be a much more comprehensive rewrite and one with much more serious impact on the rest of sage (and on existing code). If elements being mutable or not is a property of the parent rather than of the element, and the changing of mutability status is accomplished by changing the parent on the object itself, then it would seem the most natural arrow would exist from V to W. It would mean that for v in V and w in W, the result v+w would lie in W and (as a side effect!) that afterwards v now lies in w too. This makes it quite efficient to add mutable and immutable vectors, but makes immutability quite infectious.

One could also stipulate that coercion goes from V to W but that coercion does make a copy. In that case computing v+w is more expensive, the result lies in W, and afterwards v still lies in V. In that case, `v.set_immutable()` can be defined to "mutate" the vector into an element of W.

If coercion goes from W to V then the expensive route is the only option. "Expensive" here really means "a cost that is fully expected". Normally, coercion does make a copy. It's just that we have more vector spaces with the proposal here.

I think the reality is that the practical proposal of "immutability on demand" -- set an element to immutable when it is requested, for instance if its hash is asked -- will win out because it's easier to implement and less disruptive to existing code: it only changes behaviour in cases that are currently an error (although, with pervasive try/except clauses in python, changing when an error is raised can be more disruptive than you think)



---

archive/issue_comments_524041.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [nbruin](#comment%3A18):\n\n> Normally, coercion does make a copy. It's just that we have more vector spaces with the proposal here.\n\nCurrently V is the default. Hence to make coercion less frequent, I think the coercion should go from W to V. Why is it natural going from V to W?\n\n> I think the reality is that the practical proposal of \"immutability on demand\" -- set an element to immutable when it is requested, for instance if its hash is asked -- will win out because it's easier to implement and less disruptive to existing code: it only changes behaviour in cases that are currently an error (although, with pervasive try/except clauses in python, changing when an error is raised can be more disruptive than you think)\n\nI am ok, actually prefer to live with one mutable vector space and just to have `vector.immutable()` to explicitly demand v set immutable.",
    "created_at": "2021-08-11T01:39:40Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524041",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:20'></a>
Replying to [nbruin](#comment%3A18):

> Normally, coercion does make a copy. It's just that we have more vector spaces with the proposal here.

Currently V is the default. Hence to make coercion less frequent, I think the coercion should go from W to V. Why is it natural going from V to W?

> I think the reality is that the practical proposal of "immutability on demand" -- set an element to immutable when it is requested, for instance if its hash is asked -- will win out because it's easier to implement and less disruptive to existing code: it only changes behaviour in cases that are currently an error (although, with pervasive try/except clauses in python, changing when an error is raised can be more disruptive than you think)

I am ok, actually prefer to live with one mutable vector space and just to have `vector.immutable()` to explicitly demand v set immutable.



---

archive/issue_events_290841.json:
```json
{
    "actor": "https://github.com/kwankyu",
    "created_at": "2021-08-11T01:42:54Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "rename": {
        "from": "Guide for parents with mutable elements",
        "to": "Guide for parents with immutable elements"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32353#event-290841"
}
```



---

archive/issue_comments_524042.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,7 +2,7 @@\n \n https://groups.google.com/g/sage-devel/c/DNrbtItMVmQ\n \n-(related tickets #29101, #30302, #30239) by implementing parents with mutable elements, which exist side by side with their twin parents with immutable elements. \n+(related tickets #29101, #30302, #30239) by implementing parents with immutable elements, which exist side by side with their twin parents with mutable elements. \n \n The following table serves as a guide for the implementation:\n \n``````\n",
    "created_at": "2021-08-11T01:42:54Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524042",
    "user": "https://github.com/kwankyu"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,7 +2,7 @@
 
 https://groups.google.com/g/sage-devel/c/DNrbtItMVmQ
 
-(related tickets #29101, #30302, #30239) by implementing parents with mutable elements, which exist side by side with their twin parents with immutable elements. 
+(related tickets #29101, #30302, #30239) by implementing parents with immutable elements, which exist side by side with their twin parents with mutable elements. 
 
 The following table serves as a guide for the implementation:
 
``````




---

archive/issue_comments_524043.json:
```json
{
    "body": "<a id='comment:22'></a>\nNotice that the tensor/manifolds module usually provides mutable elements by default. That is because bases (frames) can be added dynamically and give different expressions.",
    "created_at": "2021-08-11T10:25:43Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524043",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:22'></a>
Notice that the tensor/manifolds module usually provides mutable elements by default. That is because bases (frames) can be added dynamically and give different expressions.



---

archive/issue_events_290842.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-11T22:19:14Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32353#event-290842"
}
```



---

archive/issue_events_290843.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-11T22:19:14Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32353#event-290843"
}
```



---

archive/issue_comments_524044.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,7 +2,7 @@\n \n https://groups.google.com/g/sage-devel/c/DNrbtItMVmQ\n \n-(related tickets #29101, #30302, #30239) by implementing parents with immutable elements, which exist side by side with their twin parents with mutable elements. \n+(related tickets #29101, #30302, #30239, #23436) by implementing parents with immutable elements, which exist side by side with their twin parents with mutable elements. \n \n The following table serves as a guide for the implementation:\n \n``````\n",
    "created_at": "2021-09-01T04:02:22Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524044",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,7 +2,7 @@
 
 https://groups.google.com/g/sage-devel/c/DNrbtItMVmQ
 
-(related tickets #29101, #30302, #30239) by implementing parents with immutable elements, which exist side by side with their twin parents with mutable elements. 
+(related tickets #29101, #30302, #30239, #23436) by implementing parents with immutable elements, which exist side by side with their twin parents with mutable elements. 
 
 The following table serves as a guide for the implementation:
 
``````




---

archive/issue_comments_524045.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,7 +2,7 @@\n \n https://groups.google.com/g/sage-devel/c/DNrbtItMVmQ\n \n-(related tickets #29101, #30302, #30239, #23436) by implementing parents with immutable elements, which exist side by side with their twin parents with mutable elements. \n+(related tickets #29101, #30302, #30239, #23436, #14681) by implementing parents with immutable elements, which exist side by side with their twin parents with mutable elements. \n \n The following table serves as a guide for the implementation:\n \n``````\n",
    "created_at": "2021-09-01T04:25:17Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524045",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,7 +2,7 @@
 
 https://groups.google.com/g/sage-devel/c/DNrbtItMVmQ
 
-(related tickets #29101, #30302, #30239, #23436) by implementing parents with immutable elements, which exist side by side with their twin parents with mutable elements. 
+(related tickets #29101, #30302, #30239, #23436, #14681) by implementing parents with immutable elements, which exist side by side with their twin parents with mutable elements. 
 
 The following table serves as a guide for the implementation:
 
``````




---

archive/issue_comments_524046.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,7 +2,7 @@\n \n https://groups.google.com/g/sage-devel/c/DNrbtItMVmQ\n \n-(related tickets #29101, #30302, #30239, #23436, #14681) by implementing parents with immutable elements, which exist side by side with their twin parents with mutable elements. \n+(related tickets #29101, #30302, #30239, #23436, #14681, #13811, #19813) by implementing parents with immutable elements, which exist side by side with their twin parents with mutable elements. \n \n The following table serves as a guide for the implementation:\n \n``````\n",
    "created_at": "2021-09-01T05:32:13Z",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32353#issuecomment-524046",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,7 +2,7 @@
 
 https://groups.google.com/g/sage-devel/c/DNrbtItMVmQ
 
-(related tickets #29101, #30302, #30239, #23436, #14681) by implementing parents with immutable elements, which exist side by side with their twin parents with mutable elements. 
+(related tickets #29101, #30302, #30239, #23436, #14681, #13811, #19813) by implementing parents with immutable elements, which exist side by side with their twin parents with mutable elements. 
 
 The following table serves as a guide for the implementation:
 
``````




---

archive/issue_events_290844.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32353#event-290844"
}
```



---

archive/issue_events_290845.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32353#event-290845"
}
```



---

archive/issue_events_290846.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T00:06:20Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32353#event-290846"
}
```



---

archive/issue_events_290847.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T00:06:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32353#event-290847"
}
```



---

archive/issue_events_290848.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32353#event-290848"
}
```



---

archive/issue_events_290849.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/32353",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32353#event-290849"
}
```
