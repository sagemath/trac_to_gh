# Issue 32703: GH Actions (macOS): Run a job for "make build-local" first, cache image for job "make build"

archive/issues_032466.json:
```json
{
    "body": "We revise the GH Actions workflows to use a 2-stage build:\nIn the first stage, run `make build-local`, and store `SAGE_LOCAL` as a build artifact. In the second stage, download the build artifact and run more building and testing.\n\n(+) On top of the artifact containing the full SAGE_LOCAL, we can test several ways to build the Python parts\n- Sage distribution, classic\n- Sage distribution with `configure --enable-editable`\n- Sage distribution with `configure --enable-system-site-packages` (#29665)\n- the configurations from pkgs/**sagemath-standard**/tox.ini\n- build/install of modularized distributions such as pkgs/**sage-categories** (#29865), pkgs/**sagemath-standard-no-symbolics** (#32601)\n\n(+) Tests of optional and experimental packages can be streamlined, as we avoid rebuilding their dependencies that are standard packages.\n\n(+) Splitting the job into two would also help with the configurations for which we scrape at the 6 hour time limit\n\n(-) Unfortunately, because [because \"needs\" cannot depend on \"matrix\"](https://github.community/t/needs-based-on-matrix/132400), the jobs for building/testing Python packages would not start before all jobs building `SAGE_LOCAL` for all platforms are completed\n\nIn this ticket, we only change all existing `macos` workflows to a 2-stage workflow, integrating the separate workflows for optional and experimental packages.\n\nAs of this ticket, we rely on the bottleneck of the available parallel jobs on GH Actions to ensure that the 2nd stages of a configuration are run after the 1st stage of that configuration. Experience with this workflow will show whether this suffices.\n\nWe also update the macOS/Xcode versions according to what's available on GH Actions and switch the `homebrew` builds to faster `homebrew-usrlocal` variants, which can use bottles for all available packages.\n\n\n\nCC:  @tobiasdiez @kliem @orlitzky @isuruf\n\nBranch/Commit: edb4364000d32c72f057bad0faa81d9ba2a79b9b\n\nReviewer: Dima Pasechnik\n\nAuthor: Matthias Koeppe\n\nDependencies: #32113, #32947\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32703\n\n",
    "closed_at": "2022-01-01T00:23:33Z",
    "created_at": "2021-10-16T19:03:25Z",
    "labels": [
        "component: porting",
        "critical"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "GH Actions (macOS): Run a job for \"make build-local\" first, cache image for job \"make build\"",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32703",
    "user": "https://github.com/mkoeppe"
}
```
We revise the GH Actions workflows to use a 2-stage build:
In the first stage, run `make build-local`, and store `SAGE_LOCAL` as a build artifact. In the second stage, download the build artifact and run more building and testing.

(+) On top of the artifact containing the full SAGE_LOCAL, we can test several ways to build the Python parts
- Sage distribution, classic
- Sage distribution with `configure --enable-editable`
- Sage distribution with `configure --enable-system-site-packages` (#29665)
- the configurations from pkgs/**sagemath-standard**/tox.ini
- build/install of modularized distributions such as pkgs/**sage-categories** (#29865), pkgs/**sagemath-standard-no-symbolics** (#32601)

(+) Tests of optional and experimental packages can be streamlined, as we avoid rebuilding their dependencies that are standard packages.

(+) Splitting the job into two would also help with the configurations for which we scrape at the 6 hour time limit

(-) Unfortunately, because [because "needs" cannot depend on "matrix"](https://github.community/t/needs-based-on-matrix/132400), the jobs for building/testing Python packages would not start before all jobs building `SAGE_LOCAL` for all platforms are completed

In this ticket, we only change all existing `macos` workflows to a 2-stage workflow, integrating the separate workflows for optional and experimental packages.

As of this ticket, we rely on the bottleneck of the available parallel jobs on GH Actions to ensure that the 2nd stages of a configuration are run after the 1st stage of that configuration. Experience with this workflow will show whether this suffices.

We also update the macOS/Xcode versions according to what's available on GH Actions and switch the `homebrew` builds to faster `homebrew-usrlocal` variants, which can use bottles for all available packages.



CC:  @tobiasdiez @kliem @orlitzky @isuruf

Branch/Commit: edb4364000d32c72f057bad0faa81d9ba2a79b9b

Reviewer: Dima Pasechnik

Author: Matthias Koeppe

Dependencies: #32113, #32947

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/32703





---

archive/issue_comments_494550.json:
```json
{
    "body": "<a id='comment:4'></a>Last 10 new commits:",
    "created_at": "2021-10-17T01:38:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494550",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>Last 10 new commits:



---

archive/issue_comments_494551.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-17T05:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494551",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_494552.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-17T18:29:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494552",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_494553.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-17T23:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494553",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_494554.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-18T19:36:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494554",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_494555.json:
```json
{
    "body": "<a id='comment:11'></a>working well now",
    "created_at": "2021-10-19T16:01:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494555",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>working well now



---

archive/issue_comments_494556.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-19T17:04:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494556",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_494557.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-10-19T17:08:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494557",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_494558.json:
```json
{
    "body": "<a id='comment:14'></a>If I understand the changes (and the output) correctly, then currently stage 1 and 2 run parallel. For example, some stage 2 runs (e.g https://github.com/mkoeppe/sage/runs/3935018795?check_suite_focus=true) fail since they try to download a non-existing artifact. Maybe something like https://github.com/marketplace/actions/wait-for-check helps.",
    "created_at": "2021-10-19T17:23:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494558",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:14'></a>If I understand the changes (and the output) correctly, then currently stage 1 and 2 run parallel. For example, some stage 2 runs (e.g https://github.com/mkoeppe/sage/runs/3935018795?check_suite_focus=true) fail since they try to download a non-existing artifact. Maybe something like https://github.com/marketplace/actions/wait-for-check helps.



---

archive/issue_comments_494559.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 gh-tobiasdiez]:\n> If I understand the changes (and the output) correctly, then currently stage 1 and 2 run parallel.\n\n\nYes, in theory. But in practice we only get 5 parallel jobs on macOS and we launch many more jobs...\n\n> For example, some stage 2 runs (e.g https://github.com/mkoeppe/sage/runs/3935018795?check_suite_focus=true) fail since they try to download a non-existing artifact.\n\n\nWell, they failed because the previous stage failed.",
    "created_at": "2021-10-19T17:35:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494559",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>Replying to [comment:14 gh-tobiasdiez]:
> If I understand the changes (and the output) correctly, then currently stage 1 and 2 run parallel.


Yes, in theory. But in practice we only get 5 parallel jobs on macOS and we launch many more jobs...

> For example, some stage 2 runs (e.g https://github.com/mkoeppe/sage/runs/3935018795?check_suite_focus=true) fail since they try to download a non-existing artifact.


Well, they failed because the previous stage failed.



---

archive/issue_comments_494560.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:14 gh-tobiasdiez]:\n> Maybe something like https://github.com/marketplace/actions/wait-for-check helps.\n\n\nThanks for the pointer, we can look into using something like this",
    "created_at": "2021-10-19T17:36:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494560",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>Replying to [comment:14 gh-tobiasdiez]:
> Maybe something like https://github.com/marketplace/actions/wait-for-check helps.


Thanks for the pointer, we can look into using something like this



---

archive/issue_comments_494561.json:
```json
{
    "body": "<a id='comment:17'></a>Testing with integrated builds for the optional packages now at https://github.com/mkoeppe/sage/actions/runs/1360303527",
    "created_at": "2021-10-19T17:43:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494561",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>Testing with integrated builds for the optional packages now at https://github.com/mkoeppe/sage/actions/runs/1360303527



---

archive/issue_comments_494562.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:15 mkoeppe]:\n> Replying to [comment:14 gh-tobiasdiez]:\n> > If I understand the changes (and the output) correctly, then currently stage 1 and 2 run parallel.\n\n> \n> Yes, in theory. But in practice we only get 5 parallel jobs on macOS and we launch many more jobs...\n\n\nOkay, but isn't this a very fragile design? Imagine that you have exactly 5 matrix cases. So all of the stage 1 tasks start at the same time. Now if the last case exists slightly before the other 4, then the stage 2 for the other 4 may be invoked and now fail as their stage 1 is not yet finished. Also this would limit everything to mac, as on linux you have way more runners.",
    "created_at": "2021-10-19T21:06:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494562",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:18'></a>Replying to [comment:15 mkoeppe]:
> Replying to [comment:14 gh-tobiasdiez]:
> > If I understand the changes (and the output) correctly, then currently stage 1 and 2 run parallel.

> 
> Yes, in theory. But in practice we only get 5 parallel jobs on macOS and we launch many more jobs...


Okay, but isn't this a very fragile design? Imagine that you have exactly 5 matrix cases. So all of the stage 1 tasks start at the same time. Now if the last case exists slightly before the other 4, then the stage 2 for the other 4 may be invoked and now fail as their stage 1 is not yet finished. Also this would limit everything to mac, as on linux you have way more runners.



---

archive/issue_comments_494563.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:18 gh-tobiasdiez]:\n> Okay, but isn't this a very fragile design? \n\n\nYes",
    "created_at": "2021-10-19T21:09:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494563",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'></a>Replying to [comment:18 gh-tobiasdiez]:
> Okay, but isn't this a very fragile design? 


Yes



---

archive/issue_comments_494564.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:18 gh-tobiasdiez]:\n> on linux you have way more runners.\n\n\nwe also have way more jobs...",
    "created_at": "2021-10-19T21:14:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494564",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>Replying to [comment:18 gh-tobiasdiez]:
> on linux you have way more runners.


we also have way more jobs...



---

archive/issue_comments_494565.json:
```json
{
    "body": "<a id='comment:21'></a>Then I would suggest using two jobs that wait using \"needs\" and accept the disadvantages that go with it. \n\n> Unfortunately, because \u200bbecause \"needs\" cannot depend on \"matrix\", the jobs for building/testing Python packages would not start before all jobs building SAGE_LOCAL for all platforms are completed \n\n\nI think this is also a more flexible design as the stage two matrix will probably have more options in the future (e.g. editable install, with/without prebuild wheels from pypi, pipenv).\nIn fact, for maximal flexibility do you think it makes sense too split it further into 3 stages:\n- Built all non-python packages (min/standard/max)\n- Built all python packages (standard, editable, prebuild wheels, pipenv)\n- Run doctests",
    "created_at": "2021-10-20T07:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494565",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:21'></a>Then I would suggest using two jobs that wait using "needs" and accept the disadvantages that go with it. 

> Unfortunately, because ​because "needs" cannot depend on "matrix", the jobs for building/testing Python packages would not start before all jobs building SAGE_LOCAL for all platforms are completed 


I think this is also a more flexible design as the stage two matrix will probably have more options in the future (e.g. editable install, with/without prebuild wheels from pypi, pipenv).
In fact, for maximal flexibility do you think it makes sense too split it further into 3 stages:
- Built all non-python packages (min/standard/max)
- Built all python packages (standard, editable, prebuild wheels, pipenv)
- Run doctests



---

archive/issue_comments_494566.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-20T16:03:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494566",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_494567.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-20T16:07:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494567",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_494568.json:
```json
{
    "body": "<a id='comment:24'></a>Yes, in stage 2 we can have all of these variants, next to the runs for the optional packages added in 313dc82\n\nWhether the doctest needs a separate stage remains to be seen; I think having it as part of the stage 2 builds will easily fit into the 6 hour limit in all variants.",
    "created_at": "2021-10-20T16:44:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494568",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>Yes, in stage 2 we can have all of these variants, next to the runs for the optional packages added in 313dc82

Whether the doctest needs a separate stage remains to be seen; I think having it as part of the stage 2 builds will easily fit into the 6 hour limit in all variants.



---

archive/issue_comments_494569.json:
```json
{
    "body": "<a id='comment:25'></a>Optional packages working well now - https://github.com/mkoeppe/sage/actions/runs/1364372711",
    "created_at": "2021-10-21T02:21:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494569",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'></a>Optional packages working well now - https://github.com/mkoeppe/sage/actions/runs/1364372711



---

archive/issue_comments_494570.json:
```json
{
    "body": "<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-10-21T19:45:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494570",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_494571.json:
```json
{
    "body": "<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-21T19:49:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494571",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_494572.json:
```json
{
    "body": "<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-21T19:54:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494572",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_494573.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -9,8 +9,15 @@\n \n (-) Unfortunately, because [because \"needs\" cannot depend on \"matrix\"](https://github.community/t/needs-based-on-matrix/132400), the jobs for building/testing Python packages would not start before all jobs building `SAGE_LOCAL` for all platforms are completed\n \n+In this ticket, we change all existing `macos` workflows to a 2-stage workflow, integrating the separate workflows for optional and experimental packages.\n+\n+As of this ticket, we rely on the bottleneck of the available parallel jobs on GH Actions to ensure that the 2nd stages of a configuration are run after the 1st stage of that configuration. Experience with this workflow will show whether this suffices.\n+\n References\n - https://evilmartians.com/chronicles/build-images-on-github-actions-with-docker-layer-caching\n+\n+\n+\n \n Comment: 1\n \n```\n",
    "created_at": "2021-10-21T19:57:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494573",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -9,8 +9,15 @@
 
 (-) Unfortunately, because [because "needs" cannot depend on "matrix"](https://github.community/t/needs-based-on-matrix/132400), the jobs for building/testing Python packages would not start before all jobs building `SAGE_LOCAL` for all platforms are completed
 
+In this ticket, we change all existing `macos` workflows to a 2-stage workflow, integrating the separate workflows for optional and experimental packages.
+
+As of this ticket, we rely on the bottleneck of the available parallel jobs on GH Actions to ensure that the 2nd stages of a configuration are run after the 1st stage of that configuration. Experience with this workflow will show whether this suffices.
+
 References
 - https://evilmartians.com/chronicles/build-images-on-github-actions-with-docker-layer-caching
+
+
+
 
 Comment: 1
 
```




---

archive/issue_comments_494574.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-10-21T19:57:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494574",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_494575.json:
```json
{
    "body": "<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-10-21T20:00:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494575",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_494576.json:
```json
{
    "body": "<a id='comment:32'></a>Rebased away from #31535.",
    "created_at": "2021-10-21T20:00:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494576",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:32'></a>Rebased away from #31535.



---

archive/issue_comments_494577.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,27 @@\n+We revise the GH Actions workflows to use a 2-stage build:\n+In the first stage, run `make build-local`, and store `SAGE_LOCAL` as a build artifact. In the second stage, download the build artifact and run more building and testing.\n+\n+(+) On top of the artifact containing the full SAGE_LOCAL, we can test several ways to build the Python parts\n+- Sage distribution, classic\n+- Sage distribution with `configure --enable-editable`\n+- Sage distribution with `configure --enable-system-site-packages` (#29665)\n+- the configurations from pkgs/**sagemath-standard**/tox.ini\n+- build/install of modularized distributions such as pkgs/**sage-categories** (#29865), pkgs/**sagemath-standard-no-symbolics** (#32601)\n+\n+(+) Tests of optional and experimental packages can be streamlined, as we avoid rebuilding their dependencies that are standard packages.\n+\n+(+) Splitting the job into two would also help with the configurations for which we scrape at the 6 hour time limit\n+\n+(-) Unfortunately, because [because \"needs\" cannot depend on \"matrix\"](https://github.community/t/needs-based-on-matrix/132400), the jobs for building/testing Python packages would not start before all jobs building `SAGE_LOCAL` for all platforms are completed\n+\n+In this ticket, we only change all existing `macos` workflows to a 2-stage workflow, integrating the separate workflows for optional and experimental packages.\n+\n+As of this ticket, we rely on the bottleneck of the available parallel jobs on GH Actions to ensure that the 2nd stages of a configuration are run after the 1st stage of that configuration. Experience with this workflow will show whether this suffices.\n+\n+References\n+- https://evilmartians.com/chronicles/build-images-on-github-actions-with-docker-layer-caching\n+\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2021-10-21T20:07:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494577",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,27 @@
+We revise the GH Actions workflows to use a 2-stage build:
+In the first stage, run `make build-local`, and store `SAGE_LOCAL` as a build artifact. In the second stage, download the build artifact and run more building and testing.
+
+(+) On top of the artifact containing the full SAGE_LOCAL, we can test several ways to build the Python parts
+- Sage distribution, classic
+- Sage distribution with `configure --enable-editable`
+- Sage distribution with `configure --enable-system-site-packages` (#29665)
+- the configurations from pkgs/**sagemath-standard**/tox.ini
+- build/install of modularized distributions such as pkgs/**sage-categories** (#29865), pkgs/**sagemath-standard-no-symbolics** (#32601)
+
+(+) Tests of optional and experimental packages can be streamlined, as we avoid rebuilding their dependencies that are standard packages.
+
+(+) Splitting the job into two would also help with the configurations for which we scrape at the 6 hour time limit
+
+(-) Unfortunately, because [because "needs" cannot depend on "matrix"](https://github.community/t/needs-based-on-matrix/132400), the jobs for building/testing Python packages would not start before all jobs building `SAGE_LOCAL` for all platforms are completed
+
+In this ticket, we only change all existing `macos` workflows to a 2-stage workflow, integrating the separate workflows for optional and experimental packages.
+
+As of this ticket, we rely on the bottleneck of the available parallel jobs on GH Actions to ensure that the 2nd stages of a configuration are run after the 1st stage of that configuration. Experience with this workflow will show whether this suffices.
+
+References
+- https://evilmartians.com/chronicles/build-images-on-github-actions-with-docker-layer-caching
+
+
 
 
 Comment: 1
```




---

archive/issue_comments_494578.json:
```json
{
    "body": "<a id='comment:34'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-12-19T01:26:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494578",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:34'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_494579.json:
```json
{
    "body": "<a id='comment:35'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-19T02:12:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494579",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:35'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_494580.json:
```json
{
    "body": "<a id='comment:37'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-19T03:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494580",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:37'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_494581.json:
```json
{
    "body": "<a id='comment:38'></a>Looks like homebrew's `gcc` package no longer installs an unversioned `gfortran` binary\n\nhttps://github.com/mkoeppe/sage/runs/4572338375?check_suite_focus=true",
    "created_at": "2021-12-20T00:51:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494581",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:38'></a>Looks like homebrew's `gcc` package no longer installs an unversioned `gfortran` binary

https://github.com/mkoeppe/sage/runs/4572338375?check_suite_focus=true



---

archive/issue_comments_494582.json:
```json
{
    "body": "<a id='comment:39'></a>Also conda install fails early\n\nhttps://github.com/mkoeppe/sage/runs/4572338435?check_suite_focus=true",
    "created_at": "2021-12-20T00:52:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494582",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:39'></a>Also conda install fails early

https://github.com/mkoeppe/sage/runs/4572338435?check_suite_focus=true



---

archive/issue_comments_494583.json:
```json
{
    "body": "<a id='comment:40'></a>Replying to [comment:39 mkoeppe]:\n> Also conda install fails early\n> \n> https://github.com/mkoeppe/sage/runs/4572338435?check_suite_focus=true\n\n\n(same as #32113#comment:17)",
    "created_at": "2021-12-20T06:55:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494583",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:40'></a>Replying to [comment:39 mkoeppe]:
> Also conda install fails early
> 
> https://github.com/mkoeppe/sage/runs/4572338435?check_suite_focus=true


(same as #32113#comment:17)



---

archive/issue_comments_494584.json:
```json
{
    "body": "<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2021-12-21T03:29:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494584",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_494585.json:
```json
{
    "body": "<a id='comment:43'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-21T03:36:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494585",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:43'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_494586.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-12-21T04:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494586",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_494587.json:
```json
{
    "body": "<a id='comment:47'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-21T07:49:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494587",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:47'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_494588.json:
```json
{
    "body": "<a id='comment:48'></a>I know we already touch upon this point, but can you please expand on\n> Unfortunately, because \u200bbecause \"needs\" cannot depend on \"matrix\", the jobs for building/testing Python packages would not start before all jobs building SAGE_LOCAL for all platforms are completed \n\n\nThat is, why do you prefer the \"custom stage build\" over having a \"local-macos-stage2\" job that depends via \"needs\" on \"local-macos-stage1\", where each of these jobs defines an appropriate matrix. In particular, I don't understand the \"all platforms\" part, as ubuntu and macos are in different jobs, right? It appears to me that with the current design also stage 1 builds are executed before any stage 2 is executed, so the only difference is that you can already have 4 or so stage 2 builds running while the last stage 1 build finishes. I guess for the overall build time this shouldn't make much of a difference anyway, as these 4 runners would be busy with other workflows then (or are free to execute builds of other stuff in the sagemath org).",
    "created_at": "2021-12-21T16:25:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494588",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:48'></a>I know we already touch upon this point, but can you please expand on
> Unfortunately, because ​because "needs" cannot depend on "matrix", the jobs for building/testing Python packages would not start before all jobs building SAGE_LOCAL for all platforms are completed 


That is, why do you prefer the "custom stage build" over having a "local-macos-stage2" job that depends via "needs" on "local-macos-stage1", where each of these jobs defines an appropriate matrix. In particular, I don't understand the "all platforms" part, as ubuntu and macos are in different jobs, right? It appears to me that with the current design also stage 1 builds are executed before any stage 2 is executed, so the only difference is that you can already have 4 or so stage 2 builds running while the last stage 1 build finishes. I guess for the overall build time this shouldn't make much of a difference anyway, as these 4 runners would be busy with other workflows then (or are free to execute builds of other stuff in the sagemath org).



---

archive/issue_comments_494589.json:
```json
{
    "body": "<a id='comment:49'></a>Replying to [comment:48 gh-tobiasdiez]:\n> That is, why do you prefer the \"custom stage build\" over having a \"local-macos-stage2\" job that depends via \"needs\" on \"local-macos-stage1\", where each of these jobs defines an appropriate matrix.\n\n\nTo avoid copy-paste",
    "created_at": "2021-12-21T16:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494589",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:49'></a>Replying to [comment:48 gh-tobiasdiez]:
> That is, why do you prefer the "custom stage build" over having a "local-macos-stage2" job that depends via "needs" on "local-macos-stage1", where each of these jobs defines an appropriate matrix.


To avoid copy-paste



---

archive/issue_comments_494590.json:
```json
{
    "body": "<a id='comment:50'></a>Replying to [comment:48 gh-tobiasdiez]:\n>  I don't understand the \"all platforms\" part, as ubuntu and macos are in different jobs, right?\n\n\nYes, that's right, within each job; and in this ticket, only for macos.",
    "created_at": "2021-12-21T16:30:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494590",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:50'></a>Replying to [comment:48 gh-tobiasdiez]:
>  I don't understand the "all platforms" part, as ubuntu and macos are in different jobs, right?


Yes, that's right, within each job; and in this ticket, only for macos.



---

archive/issue_comments_494591.json:
```json
{
    "body": "<a id='comment:51'></a>Replying to [comment:49 mkoeppe]:\n> Replying to [comment:48 gh-tobiasdiez]:\n> > That is, why do you prefer the \"custom stage build\" over having a \"local-macos-stage2\" job that depends via \"needs\" on \"local-macos-stage1\", where each of these jobs defines an appropriate matrix.\n\n> \n> To avoid copy-paste\n\n\nGithub recently made it possible to reuse workflows: https://docs.github.com/en/actions/learn-github-actions/reusing-workflows\nThus you could extract the current local-macos job into a new workflow and pass the right \"tox\" command as an argument (determined by the matrix + step).",
    "created_at": "2021-12-21T16:40:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494591",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:51'></a>Replying to [comment:49 mkoeppe]:
> Replying to [comment:48 gh-tobiasdiez]:
> > That is, why do you prefer the "custom stage build" over having a "local-macos-stage2" job that depends via "needs" on "local-macos-stage1", where each of these jobs defines an appropriate matrix.

> 
> To avoid copy-paste


Github recently made it possible to reuse workflows: https://docs.github.com/en/actions/learn-github-actions/reusing-workflows
Thus you could extract the current local-macos job into a new workflow and pass the right "tox" command as an argument (determined by the matrix + step).



---

archive/issue_comments_494592.json:
```json
{
    "body": "<a id='comment:52'></a>Thanks for the pointer!! I've added this to #29060 for welcome future refactoring - but this won't make it into Sage 9.5",
    "created_at": "2021-12-21T16:45:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494592",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:52'></a>Thanks for the pointer!! I've added this to #29060 for welcome future refactoring - but this won't make it into Sage 9.5



---

archive/issue_comments_494593.json:
```json
{
    "body": "<a id='comment:53'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-21T17:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494593",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:53'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_494594.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,25 @@\n+We revise the GH Actions workflows to use a 2-stage build:\n+In the first stage, run `make build-local`, and store `SAGE_LOCAL` as a build artifact. In the second stage, download the build artifact and run more building and testing.\n+\n+(+) On top of the artifact containing the full SAGE_LOCAL, we can test several ways to build the Python parts\n+- Sage distribution, classic\n+- Sage distribution with `configure --enable-editable`\n+- Sage distribution with `configure --enable-system-site-packages` (#29665)\n+- the configurations from pkgs/**sagemath-standard**/tox.ini\n+- build/install of modularized distributions such as pkgs/**sage-categories** (#29865), pkgs/**sagemath-standard-no-symbolics** (#32601)\n+\n+(+) Tests of optional and experimental packages can be streamlined, as we avoid rebuilding their dependencies that are standard packages.\n+\n+(+) Splitting the job into two would also help with the configurations for which we scrape at the 6 hour time limit\n+\n+(-) Unfortunately, because [because \"needs\" cannot depend on \"matrix\"](https://github.community/t/needs-based-on-matrix/132400), the jobs for building/testing Python packages would not start before all jobs building `SAGE_LOCAL` for all platforms are completed\n+\n+In this ticket, we only change all existing `macos` workflows to a 2-stage workflow, integrating the separate workflows for optional and experimental packages.\n+\n+As of this ticket, we rely on the bottleneck of the available parallel jobs on GH Actions to ensure that the 2nd stages of a configuration are run after the 1st stage of that configuration. Experience with this workflow will show whether this suffices.\n+\n+We also update the macOS/Xcode versions according to what's available on GH Actions and switch the `homebrew` builds to faster `homebrew-usrlocal` variants, which can use bottles for all available packages.\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2021-12-21T17:29:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494594",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,25 @@
+We revise the GH Actions workflows to use a 2-stage build:
+In the first stage, run `make build-local`, and store `SAGE_LOCAL` as a build artifact. In the second stage, download the build artifact and run more building and testing.
+
+(+) On top of the artifact containing the full SAGE_LOCAL, we can test several ways to build the Python parts
+- Sage distribution, classic
+- Sage distribution with `configure --enable-editable`
+- Sage distribution with `configure --enable-system-site-packages` (#29665)
+- the configurations from pkgs/**sagemath-standard**/tox.ini
+- build/install of modularized distributions such as pkgs/**sage-categories** (#29865), pkgs/**sagemath-standard-no-symbolics** (#32601)
+
+(+) Tests of optional and experimental packages can be streamlined, as we avoid rebuilding their dependencies that are standard packages.
+
+(+) Splitting the job into two would also help with the configurations for which we scrape at the 6 hour time limit
+
+(-) Unfortunately, because [because "needs" cannot depend on "matrix"](https://github.community/t/needs-based-on-matrix/132400), the jobs for building/testing Python packages would not start before all jobs building `SAGE_LOCAL` for all platforms are completed
+
+In this ticket, we only change all existing `macos` workflows to a 2-stage workflow, integrating the separate workflows for optional and experimental packages.
+
+As of this ticket, we rely on the bottleneck of the available parallel jobs on GH Actions to ensure that the 2nd stages of a configuration are run after the 1st stage of that configuration. Experience with this workflow will show whether this suffices.
+
+We also update the macOS/Xcode versions according to what's available on GH Actions and switch the `homebrew` builds to faster `homebrew-usrlocal` variants, which can use bottles for all available packages.
+
 
 
 Comment: 1
```




---

archive/issue_comments_494595.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-23T14:45:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494595",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_494596.json:
```json
{
    "body": "<a id='comment:55'></a>OK,macOS runs on GH look good.",
    "created_at": "2021-12-23T14:45:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494596",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:55'></a>OK,macOS runs on GH look good.



---

archive/issue_comments_494597.json:
```json
{
    "body": "<a id='comment:56'></a>Thanks!",
    "created_at": "2021-12-23T16:25:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494597",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:56'></a>Thanks!



---

archive/issue_events_086589.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-01-01T00:23:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32703#event-86589"
}
```



---

archive/issue_comments_494598.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-01-01T00:23:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32703#issuecomment-494598",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
