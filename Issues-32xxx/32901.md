# Issue 32901: Cache _row_ambient_module of matrices

archive/issues_032664.json:
```json
{
    "assignees": [],
    "body": "... and some other optimizations in `_row_ambient_module` and `_column_ambient_module`:\n\nBefore:\n\n```\nsage: M = random_matrix(ZZ, 10)\nsage: %timeit M._row_ambient_module()\n2.77 \u00b5s \u00b1 11.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._row_ambient_module(QQ)\n2.93 \u00b5s \u00b1 14.8 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._column_ambient_module()\n66.3 ns \u00b1 0.0649 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\nsage: v = random_vector(ZZ, 10)\nsage: %timeit v*M\n5.56 \u00b5s \u00b1 30.6 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n2.61 \u00b5s \u00b1 11.3 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module(QQ)\n2.73 \u00b5s \u00b1 10.8 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n1.5 \u00b5s \u00b1 4.57 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: %timeit M._clear_cache(); v*M\n5.26 \u00b5s \u00b1 20.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\nAfter:\n\n```\nsage: M = random_matrix(ZZ, 10)\nsage: %timeit M._row_ambient_module()\n68.6 ns \u00b1 0.0774 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\nsage: %timeit M._row_ambient_module(QQ)\n1 \u00b5s \u00b1 1.16 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: %timeit M._column_ambient_module()\n64.9 ns \u00b1 0.0636 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\nsage: v = random_vector(ZZ, 10)\nsage: %timeit v*M\n1.81 \u00b5s \u00b1 1.17 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n1.24 \u00b5s \u00b1 1.04 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module(QQ)\n2.57 \u00b5s \u00b1 9.12 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n1.25 \u00b5s \u00b1 4.43 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: %timeit M._clear_cache(); v*M\n3.34 \u00b5s \u00b1 13.7 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\nCC:  @nbruin @orlitzky\n\nBranch/Commit: **[e6188d0](https://github.com/sagemath/sagetrac-mirror/commit/e6188d02dacc78f3a594cad5925cccd8513483b2)**\n\nReviewer: **Michael Orlitzky**\n\nAuthor: **Jonathan Kliem**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/32901_\n\n",
    "closed_at": "2021-12-12T15:09:18Z",
    "created_at": "2021-11-19T08:18:10Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20linear%20algebra",
        "https://github.com/sagemath/sage/labels/p2%20%E2%80%93%20critical",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.5",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Cache _row_ambient_module of matrices",
    "type": "issue",
    "updated_at": "2021-12-12T15:09:18Z",
    "url": "https://github.com/sagemath/sage/issues/32901",
    "user": "https://github.com/kliem"
}
```
... and some other optimizations in `_row_ambient_module` and `_column_ambient_module`:

Before:

```
sage: M = random_matrix(ZZ, 10)
sage: %timeit M._row_ambient_module()
2.77 µs ± 11.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._row_ambient_module(QQ)
2.93 µs ± 14.8 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._column_ambient_module()
66.3 ns ± 0.0649 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
sage: v = random_vector(ZZ, 10)
sage: %timeit v*M
5.56 µs ± 30.6 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module()
2.61 µs ± 11.3 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module(QQ)
2.73 µs ± 10.8 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._column_ambient_module()
1.5 µs ± 4.57 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit M._clear_cache(); v*M
5.26 µs ± 20.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

After:

```
sage: M = random_matrix(ZZ, 10)
sage: %timeit M._row_ambient_module()
68.6 ns ± 0.0774 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
sage: %timeit M._row_ambient_module(QQ)
1 µs ± 1.16 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit M._column_ambient_module()
64.9 ns ± 0.0636 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
sage: v = random_vector(ZZ, 10)
sage: %timeit v*M
1.81 µs ± 1.17 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module()
1.24 µs ± 1.04 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module(QQ)
2.57 µs ± 9.12 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._column_ambient_module()
1.25 µs ± 4.43 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit M._clear_cache(); v*M
3.34 µs ± 13.7 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

CC:  @nbruin @orlitzky

Branch/Commit: **[e6188d0](https://github.com/sagemath/sagetrac-mirror/commit/e6188d02dacc78f3a594cad5925cccd8513483b2)**

Reviewer: **Michael Orlitzky**

Author: **Jonathan Kliem**

_Issue created by migration from https://trac.sagemath.org/ticket/32901_





---

archive/issue_events_434603.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-11-19T08:18:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32901#event-434603"
}
```



---

archive/issue_events_434604.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-11-19T08:18:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20linear%20algebra",
    "label_color": "0000ff",
    "label_name": "component: linear algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32901#event-434604"
}
```



---

archive/issue_events_434605.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-11-19T08:18:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "label": "https://github.com/sagemath/sage/labels/p2%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32901#event-434605"
}
```



---

archive/issue_events_434606.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-11-19T08:18:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32901#event-434606"
}
```



---

archive/issue_comments_534367.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">Comment 1</div>\n\nIt's a tiny change with a huge perfomance impact on `_vector_times_matrix_`, hence I marked it as critical.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/182ee47f0418a11bf9f1f22e6ad58eb4618d003f\">182ee47</a></td><td><code>cache row_ambient_module of matrices</code></td></tr></table>\n",
    "created_at": "2021-11-19T08:20:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534367",
    "user": "https://github.com/kliem"
}
```

<div id="comment:1" align="right">Comment 1</div>

It's a tiny change with a huge perfomance impact on `_vector_times_matrix_`, hence I marked it as critical.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/182ee47f0418a11bf9f1f22e6ad58eb4618d003f">182ee47</a></td><td><code>cache row_ambient_module of matrices</code></td></tr></table>




---

archive/issue_comments_534368.json:
```json
{
    "body": "Branch: **[public/32901](https://github.com/sagemath/sagetrac-mirror/tree/public/32901)**",
    "created_at": "2021-11-19T08:20:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534368",
    "user": "https://github.com/kliem"
}
```

Branch: **[public/32901](https://github.com/sagemath/sagetrac-mirror/tree/public/32901)**



---

archive/issue_comments_534369.json:
```json
{
    "body": "Commit: **[182ee47](https://github.com/sagemath/sagetrac-mirror/commit/182ee47f0418a11bf9f1f22e6ad58eb4618d003f)**",
    "created_at": "2021-11-19T08:20:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534369",
    "user": "https://github.com/kliem"
}
```

Commit: **[182ee47](https://github.com/sagemath/sagetrac-mirror/commit/182ee47f0418a11bf9f1f22e6ad58eb4618d003f)**



---

archive/issue_events_434607.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-11-19T08:20:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32901#event-434607"
}
```



---

archive/issue_comments_534370.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">Comment 2</div>\n\nGiven the following:\n\n```\nsage: M = random_matrix(ZZ, 10)\nsage: p = M._row_ambient_module()\nsage: %timeit p.zero_vector()\n703 ns \u00b1 1.65 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n```\n\nI would say that the ticket is a good start. Using `cached_method` decorator does not give an improvement (but a slight slowdown).",
    "created_at": "2021-11-19T23:01:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534370",
    "user": "https://github.com/kliem"
}
```

<div id="comment:2" align="right">Comment 2</div>

Given the following:

```
sage: M = random_matrix(ZZ, 10)
sage: p = M._row_ambient_module()
sage: %timeit p.zero_vector()
703 ns ± 1.65 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
```

I would say that the ticket is a good start. Using `cached_method` decorator does not give an improvement (but a slight slowdown).



---

archive/issue_comments_534371.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/52efd67e51b06d72586ab508ba2d6da70c0d0218\">52efd67</a></td><td><code>ome further optimization of the fast path in _row_ambient_module</code></td></tr></table>\n",
    "created_at": "2021-11-19T23:58:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534371",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:3" align="right">Comment 3</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/52efd67e51b06d72586ab508ba2d6da70c0d0218">52efd67</a></td><td><code>ome further optimization of the fast path in _row_ambient_module</code></td></tr></table>




---

archive/issue_comments_534372.json:
```json
{
    "body": "Changed commit from **[182ee47](https://github.com/sagemath/sagetrac-mirror/commit/182ee47f0418a11bf9f1f22e6ad58eb4618d003f)** to **[52efd67](https://github.com/sagemath/sagetrac-mirror/commit/52efd67e51b06d72586ab508ba2d6da70c0d0218)**",
    "created_at": "2021-11-19T23:58:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534372",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[182ee47](https://github.com/sagemath/sagetrac-mirror/commit/182ee47f0418a11bf9f1f22e6ad58eb4618d003f)** to **[52efd67](https://github.com/sagemath/sagetrac-mirror/commit/52efd67e51b06d72586ab508ba2d6da70c0d0218)**



---

archive/issue_comments_534373.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">Comment 4</div>\n\nThis change reduces the penalty for having an optional `base_ring` argument a little further: I'm now seeing 109 ns vs. 101 ns for row vs. column. So the price of the optional argument, together with the testing for it, is still measurable, but is now something like 6% rather than 50%.",
    "created_at": "2021-11-20T00:01:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534373",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:4" align="right">Comment 4</div>

This change reduces the penalty for having an optional `base_ring` argument a little further: I'm now seeing 109 ns vs. 101 ns for row vs. column. So the price of the optional argument, together with the testing for it, is still measurable, but is now something like 6% rather than 50%.



---

archive/issue_comments_534374.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,7 +1,7 @@\n Before:\n \n ```\n-sage: M = random_matrix(ZZ, 100)\n+sage: M = random_matrix(ZZ, 10)\n sage: %timeit M._row_ambient_module()\n 2.82 \u00b5s \u00b1 10.3 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n sage: %timeit M._row_ambient_module(QQ)\n``````\n",
    "created_at": "2021-11-20T09:36:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534374",
    "user": "https://github.com/kliem"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,7 +1,7 @@
 Before:
 
 ```
-sage: M = random_matrix(ZZ, 100)
+sage: M = random_matrix(ZZ, 10)
 sage: %timeit M._row_ambient_module()
 2.82 µs ± 10.3 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
 sage: %timeit M._row_ambient_module(QQ)
``````




---

archive/issue_comments_534375.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">Comment 6</div>\n\n`_repr_` doesn't work unfortunatly. There are failing doctests.",
    "created_at": "2021-11-20T10:02:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534375",
    "user": "https://github.com/kliem"
}
```

<div id="comment:6" align="right">Comment 6</div>

`_repr_` doesn't work unfortunatly. There are failing doctests.



---

archive/issue_comments_534376.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -18,12 +18,12 @@\n ```\n sage: M = random_matrix(ZZ, 10)\n sage: %timeit M._row_ambient_module()\n-95.3 ns \u00b1 0.15 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\n+66.8 ns \u00b1 0.0605 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\n sage: %timeit M._row_ambient_module(QQ)\n-287 ns \u00b1 0.885 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n+1.08 \u00b5s \u00b1 3.81 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n sage: %timeit M._column_ambient_module()\n-63 ns \u00b1 0.0671 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\n+65 ns \u00b1 0.0586 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\n sage: v = random_vector(ZZ, 10)\n sage: %timeit v*M\n-1.94 \u00b5s \u00b1 5.58 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n+1.85 \u00b5s \u00b1 1.07 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n ```\n``````\n",
    "created_at": "2021-11-20T10:06:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534376",
    "user": "https://github.com/kliem"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -18,12 +18,12 @@
 ```
 sage: M = random_matrix(ZZ, 10)
 sage: %timeit M._row_ambient_module()
-95.3 ns ± 0.15 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
+66.8 ns ± 0.0605 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
 sage: %timeit M._row_ambient_module(QQ)
-287 ns ± 0.885 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
+1.08 µs ± 3.81 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
 sage: %timeit M._column_ambient_module()
-63 ns ± 0.0671 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
+65 ns ± 0.0586 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
 sage: v = random_vector(ZZ, 10)
 sage: %timeit v*M
-1.94 µs ± 5.58 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
+1.85 µs ± 1.07 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
 ```
``````




---

archive/issue_comments_534377.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">Comment 7</div>\n\nWith the changes that I'll push in a second, I get the following timings:\n\n```\nsage: M = random_matrix(ZZ, 10)\nsage: %timeit M._row_ambient_module(QQ)\n1.08 \u00b5s \u00b1 2.16 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: %timeit M._row_ambient_module().change_ring(QQ)\n2.57 \u00b5s \u00b1 7.9 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\nSo it is still a bit faster. Unfortunatly, `__repr__` is lots slower than `_repr_`.",
    "created_at": "2021-11-20T10:06:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534377",
    "user": "https://github.com/kliem"
}
```

<div id="comment:7" align="right">Comment 7</div>

With the changes that I'll push in a second, I get the following timings:

```
sage: M = random_matrix(ZZ, 10)
sage: %timeit M._row_ambient_module(QQ)
1.08 µs ± 2.16 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit M._row_ambient_module().change_ring(QQ)
2.57 µs ± 7.9 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

So it is still a bit faster. Unfortunatly, `__repr__` is lots slower than `_repr_`.



---

archive/issue_comments_534378.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">Comment 8</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/06236ebdb951bd3fea252a5d237cba04dab61eca\">06236eb</a></td><td><code>cythonize _row_ambient_moudle and _column_ambient_module</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2dd33b9dc5818862b266597d946da7b7831ad50a\">2dd33b9</a></td><td><code>Merge branch 'public/32901' of git://trac.sagemath.org/sage into public/32901</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ba5eecf89e6ba47db31265cfe1ea45194bb1b2e3\">ba5eecf</a></td><td><code>use `__repr__` as `_repr_` isnt always defined</code></td></tr></table>\n",
    "created_at": "2021-11-20T10:06:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534378",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:8" align="right">Comment 8</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/06236ebdb951bd3fea252a5d237cba04dab61eca">06236eb</a></td><td><code>cythonize _row_ambient_moudle and _column_ambient_module</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2dd33b9dc5818862b266597d946da7b7831ad50a">2dd33b9</a></td><td><code>Merge branch 'public/32901' of git://trac.sagemath.org/sage into public/32901</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ba5eecf89e6ba47db31265cfe1ea45194bb1b2e3">ba5eecf</a></td><td><code>use `__repr__` as `_repr_` isnt always defined</code></td></tr></table>




---

archive/issue_comments_534379.json:
```json
{
    "body": "Changed commit from **[52efd67](https://github.com/sagemath/sagetrac-mirror/commit/52efd67e51b06d72586ab508ba2d6da70c0d0218)** to **[ba5eecf](https://github.com/sagemath/sagetrac-mirror/commit/ba5eecf89e6ba47db31265cfe1ea45194bb1b2e3)**",
    "created_at": "2021-11-20T10:06:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534379",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[52efd67](https://github.com/sagemath/sagetrac-mirror/commit/52efd67e51b06d72586ab508ba2d6da70c0d0218)** to **[ba5eecf](https://github.com/sagemath/sagetrac-mirror/commit/ba5eecf89e6ba47db31265cfe1ea45194bb1b2e3)**



---

archive/issue_comments_534380.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">Comment 9</div>\n\nThis is the `__repr__` on `SageObject`:\n\n```\n        try:\n            name = self.__custom_name\n            if name is not None:\n                return name\n        except AttributeError:\n            pass\n        try:\n            reprfunc = self._repr_\n        except AttributeError:\n            return super().__repr__()\n        result = reprfunc()\n        if isinstance(result, str):\n            return result\n        # Allow _repr_ to return unicode on Python 2\n        return result.encode('utf-8')\n```\nI think our python 2 compatibility should be removed now. Furthermore, I think `__repr__` should return a `str`, not a `bytes` (which is what `encode` will return). So the fallback is now erroneous, I think. That means we should just return `result` unconditionally and trust it produces a `str`.\n**EDIT**: these changes don't actually affect the speed very much. I assume `__custom_name` is rare, so the usual code path at the moment incurs an `AttributeError`, which is the expensive part of a `try/except`. Rewriting that with a `hasattr(self,\"__custom_name\")` instead didn't really affect the speed much either.",
    "created_at": "2021-11-20T23:24:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534380",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:9" align="right">Comment 9</div>

This is the `__repr__` on `SageObject`:

```
        try:
            name = self.__custom_name
            if name is not None:
                return name
        except AttributeError:
            pass
        try:
            reprfunc = self._repr_
        except AttributeError:
            return super().__repr__()
        result = reprfunc()
        if isinstance(result, str):
            return result
        # Allow _repr_ to return unicode on Python 2
        return result.encode('utf-8')
```
I think our python 2 compatibility should be removed now. Furthermore, I think `__repr__` should return a `str`, not a `bytes` (which is what `encode` will return). So the fallback is now erroneous, I think. That means we should just return `result` unconditionally and trust it produces a `str`.
**EDIT**: these changes don't actually affect the speed very much. I assume `__custom_name` is rare, so the usual code path at the moment incurs an `AttributeError`, which is the expensive part of a `try/except`. Rewriting that with a `hasattr(self,"__custom_name")` instead didn't really affect the speed much either.



---

archive/issue_comments_534381.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">Comment 10</div>\n\nReplying to [@nbruin](#comment%3A9):\n> This is the `__repr__` on `SageObject`:\n> \n> ```\n>         try:\n>             name = self.__custom_name\n>             if name is not None:\n>                 return name\n>         except AttributeError:\n>             pass\n>         try:\n>             reprfunc = self._repr_\n>         except AttributeError:\n>             return super().__repr__()\n>         result = reprfunc()\n>         if isinstance(result, str):\n>             return result\n>         # Allow _repr_ to return unicode on Python 2\n>         return result.encode('utf-8')\n> ```\n> I think our python 2 compatibility should be removed now. Furthermore, I think `__repr__` should return a `str`, not a `bytes` (which is what `encode` will return). So the fallback is now erroneous, I think. That means we should just return `result` unconditionally and trust it produces a `str`.\n> **EDIT**: these changes don't actually affect the speed very much. I assume `__custom_name` is rare, so the usual code path at the moment incurs an `AttributeError`, which is the expensive part of a `try/except`. Rewriting that with a `hasattr(self,\"__custom_name\")` instead didn't really affect the speed much either.\n\nYes, unfortunatly this choice of `self.__custom_name` is slow.\n\nHowever, I don't think doing those changes should be part of this ticket.",
    "created_at": "2021-11-23T13:55:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534381",
    "user": "https://github.com/kliem"
}
```

<div id="comment:10" align="right">Comment 10</div>

Replying to [@nbruin](#comment%3A9):
> This is the `__repr__` on `SageObject`:
> 
> ```
>         try:
>             name = self.__custom_name
>             if name is not None:
>                 return name
>         except AttributeError:
>             pass
>         try:
>             reprfunc = self._repr_
>         except AttributeError:
>             return super().__repr__()
>         result = reprfunc()
>         if isinstance(result, str):
>             return result
>         # Allow _repr_ to return unicode on Python 2
>         return result.encode('utf-8')
> ```
> I think our python 2 compatibility should be removed now. Furthermore, I think `__repr__` should return a `str`, not a `bytes` (which is what `encode` will return). So the fallback is now erroneous, I think. That means we should just return `result` unconditionally and trust it produces a `str`.
> **EDIT**: these changes don't actually affect the speed very much. I assume `__custom_name` is rare, so the usual code path at the moment incurs an `AttributeError`, which is the expensive part of a `try/except`. Rewriting that with a `hasattr(self,"__custom_name")` instead didn't really affect the speed much either.

Yes, unfortunatly this choice of `self.__custom_name` is slow.

However, I don't think doing those changes should be part of this ticket.



---

archive/issue_comments_534382.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">Comment 11</div>\n\nPlease leave some comments in the code mentioning how performance-critical it is, and that the unusual logic speeds things up. Otherwise someone is going to see the duplication introduced in Nils's commit and try to change it back the way it was.",
    "created_at": "2021-11-23T23:55:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534382",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:11" align="right">Comment 11</div>

Please leave some comments in the code mentioning how performance-critical it is, and that the unusual logic speeds things up. Otherwise someone is going to see the duplication introduced in Nils's commit and try to change it back the way it was.



---

archive/issue_comments_534383.json:
```json
{
    "body": "Changed commit from **[ba5eecf](https://github.com/sagemath/sagetrac-mirror/commit/ba5eecf89e6ba47db31265cfe1ea45194bb1b2e3)** to **[313c645](https://github.com/sagemath/sagetrac-mirror/commit/313c645c723a9a1d9a15c6d2fb571de3108b8f4e)**",
    "created_at": "2021-11-24T06:30:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534383",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[ba5eecf](https://github.com/sagemath/sagetrac-mirror/commit/ba5eecf89e6ba47db31265cfe1ea45194bb1b2e3)** to **[313c645](https://github.com/sagemath/sagetrac-mirror/commit/313c645c723a9a1d9a15c6d2fb571de3108b8f4e)**



---

archive/issue_comments_534384.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">Comment 12</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a356ff1c9ecc2996821ce144ac1ed886e544b8cd\">a356ff1</a></td><td><code>remark about code duplication</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/313c645c723a9a1d9a15c6d2fb571de3108b8f4e\">313c645</a></td><td><code>documentation</code></td></tr></table>\n",
    "created_at": "2021-11-24T06:30:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534384",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:12" align="right">Comment 12</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a356ff1c9ecc2996821ce144ac1ed886e544b8cd">a356ff1</a></td><td><code>remark about code duplication</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/313c645c723a9a1d9a15c6d2fb571de3108b8f4e">313c645</a></td><td><code>documentation</code></td></tr></table>




---

archive/issue_comments_534385.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">Comment 13</div>\n\nSo long as we're shaving off nanoseconds, you can probably replace `self.ncols()` with `self._ncols`,  `self.base_ring()` with `self._base_ring`, and `self.is_sparse()` with `self.is_sparse_c()` to help the compiler out if it hasn't already optimized out the intermediate methods.",
    "created_at": "2021-11-24T12:36:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534385",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:13" align="right">Comment 13</div>

So long as we're shaving off nanoseconds, you can probably replace `self.ncols()` with `self._ncols`,  `self.base_ring()` with `self._base_ring`, and `self.is_sparse()` with `self.is_sparse_c()` to help the compiler out if it hasn't already optimized out the intermediate methods.



---

archive/issue_comments_534386.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">Comment 14</div>\n\nI could do that, but it woudn't make difference for the cached version.",
    "created_at": "2021-11-24T13:08:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534386",
    "user": "https://github.com/kliem"
}
```

<div id="comment:14" align="right">Comment 14</div>

I could do that, but it woudn't make difference for the cached version.



---

archive/issue_comments_534387.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">Comment 15</div>\n\nReplying to [@kliem](#comment%3A14):\n> I could do that, but it woudn't make difference for the cached version.\n\nSure, but it doesn't hurt the cached path, either. Since this is critical for vector-matrix multiplication, I was thinking of all the random tests that I have that generate a random matrix, use it once, and then throw it out. The difference is small but measurable.\n\nBefore:\n\n```\nsage: M = matrix.random(ZZ,10)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n5.16 \u00b5s \u00b1 12.9 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n5.18 \u00b5s \u00b1 10.8 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n5.17 \u00b5s \u00b1 9.82 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n5.17 \u00b5s \u00b1 10.7 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n5.1 \u00b5s \u00b1 22.8 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\nAfter:\n\n```\nsage: M = matrix.random(ZZ,10)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n4.93 \u00b5s \u00b1 18 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n4.85 \u00b5s \u00b1 15 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n4.86 \u00b5s \u00b1 19.4 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n4.93 \u00b5s \u00b1 5.97 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n4.89 \u00b5s \u00b1 13.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```",
    "created_at": "2021-11-24T23:13:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534387",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:15" align="right">Comment 15</div>

Replying to [@kliem](#comment%3A14):
> I could do that, but it woudn't make difference for the cached version.

Sure, but it doesn't hurt the cached path, either. Since this is critical for vector-matrix multiplication, I was thinking of all the random tests that I have that generate a random matrix, use it once, and then throw it out. The difference is small but measurable.

Before:

```
sage: M = matrix.random(ZZ,10)
sage: %timeit M._clear_cache(); M._row_ambient_module()
5.16 µs ± 12.9 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module()
5.18 µs ± 10.8 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module()
5.17 µs ± 9.82 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module()
5.17 µs ± 10.7 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module()
5.1 µs ± 22.8 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

After:

```
sage: M = matrix.random(ZZ,10)
sage: %timeit M._clear_cache(); M._row_ambient_module()
4.93 µs ± 18 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module()
4.85 µs ± 15 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module()
4.86 µs ± 19.4 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module()
4.93 µs ± 5.97 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module()
4.89 µs ± 13.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```



---

archive/issue_comments_534388.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">Comment 16</div>\n\nWhile you're at it, check if the same changes can be made to _column_ambient_module.",
    "created_at": "2021-11-24T23:51:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534388",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:16" align="right">Comment 16</div>

While you're at it, check if the same changes can be made to _column_ambient_module.



---

archive/issue_comments_534389.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">Comment 17</div>\n\nReplying to [@nbruin](#comment%3A16):\n> While you're at it, check if the same changes can be made to _column_ambient_module.\n\nSure. Before:\n\n```\nsage: M = matrix.random(ZZ,10)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n5.02 \u00b5s \u00b1 12.9 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n5.01 \u00b5s \u00b1 17.3 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n5.02 \u00b5s \u00b1 9.4 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n5.01 \u00b5s \u00b1 9.14 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n5.02 \u00b5s \u00b1 12.9 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\nAnd after:\n\n```\nsage: M = matrix.random(ZZ,10)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n4.36 \u00b5s \u00b1 17.8 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n4.41 \u00b5s \u00b1 14.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n4.41 \u00b5s \u00b1 25.1 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n4.41 \u00b5s \u00b1 19.1 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n4.41 \u00b5s \u00b1 32.7 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```",
    "created_at": "2021-11-25T00:35:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534389",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:17" align="right">Comment 17</div>

Replying to [@nbruin](#comment%3A16):
> While you're at it, check if the same changes can be made to _column_ambient_module.

Sure. Before:

```
sage: M = matrix.random(ZZ,10)
sage: %timeit M._clear_cache(); M._column_ambient_module()
5.02 µs ± 12.9 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._column_ambient_module()
5.01 µs ± 17.3 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._column_ambient_module()
5.02 µs ± 9.4 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._column_ambient_module()
5.01 µs ± 9.14 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._column_ambient_module()
5.02 µs ± 12.9 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

And after:

```
sage: M = matrix.random(ZZ,10)
sage: %timeit M._clear_cache(); M._column_ambient_module()
4.36 µs ± 17.8 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._column_ambient_module()
4.41 µs ± 14.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._column_ambient_module()
4.41 µs ± 25.1 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._column_ambient_module()
4.41 µs ± 19.1 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._column_ambient_module()
4.41 µs ± 32.7 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```



---

archive/issue_comments_534390.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">Comment 18</div>\n\nThe current state:\n\n```\nsage: set_random_seed(0)\nsage: M = matrix.random(ZZ, 10)\nsage: v = random_vector(ZZ, 10)\nsage: %timeit M._clear_cache(); v*M\n3.69 \u00b5s \u00b1 12.6 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\nWith optimization:\n\n```\nsage: set_random_seed(0)\nsage: M = matrix.random(ZZ, 10)\nsage: v = random_vector(ZZ, 10)\nsage: %timeit M._clear_cache(); v*M\n3.54 \u00b5s \u00b1 28.6 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\nSo you are right. It is noticable.",
    "created_at": "2021-11-25T08:37:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534390",
    "user": "https://github.com/kliem"
}
```

<div id="comment:18" align="right">Comment 18</div>

The current state:

```
sage: set_random_seed(0)
sage: M = matrix.random(ZZ, 10)
sage: v = random_vector(ZZ, 10)
sage: %timeit M._clear_cache(); v*M
3.69 µs ± 12.6 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

With optimization:

```
sage: set_random_seed(0)
sage: M = matrix.random(ZZ, 10)
sage: v = random_vector(ZZ, 10)
sage: %timeit M._clear_cache(); v*M
3.54 µs ± 28.6 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

So you are right. It is noticable.



---

archive/issue_comments_534391.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">Comment 19</div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e6188d02dacc78f3a594cad5925cccd8513483b2\">e6188d0</a></td><td><code>optimization when obtaining FreeModule</code></td></tr></table>\n",
    "created_at": "2021-11-25T08:37:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534391",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:19" align="right">Comment 19</div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e6188d02dacc78f3a594cad5925cccd8513483b2">e6188d0</a></td><td><code>optimization when obtaining FreeModule</code></td></tr></table>




---

archive/issue_comments_534392.json:
```json
{
    "body": "Changed commit from **[313c645](https://github.com/sagemath/sagetrac-mirror/commit/313c645c723a9a1d9a15c6d2fb571de3108b8f4e)** to **[e6188d0](https://github.com/sagemath/sagetrac-mirror/commit/e6188d02dacc78f3a594cad5925cccd8513483b2)**",
    "created_at": "2021-11-25T08:37:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534392",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[313c645](https://github.com/sagemath/sagetrac-mirror/commit/313c645c723a9a1d9a15c6d2fb571de3108b8f4e)** to **[e6188d0](https://github.com/sagemath/sagetrac-mirror/commit/e6188d02dacc78f3a594cad5925cccd8513483b2)**



---

archive/issue_comments_534393.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,16 +1,26 @@\n+... and some other optimizations in `_row_ambient_module` and `_column_ambient_module`:\n+\n Before:\n \n ```\n sage: M = random_matrix(ZZ, 10)\n sage: %timeit M._row_ambient_module()\n-2.82 \u00b5s \u00b1 10.3 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n+2.77 \u00b5s \u00b1 11.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n sage: %timeit M._row_ambient_module(QQ)\n-2.91 \u00b5s \u00b1 14.3 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n+2.93 \u00b5s \u00b1 14.8 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n sage: %timeit M._column_ambient_module()\n-66.6 ns \u00b1 0.105 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\n+66.3 ns \u00b1 0.0649 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\n sage: v = random_vector(ZZ, 10)\n sage: %timeit v*M\n-5.79 \u00b5s \u00b1 34.9 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n+5.56 \u00b5s \u00b1 30.6 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n+sage: %timeit M._clear_cache(); M._row_ambient_module()\n+2.61 \u00b5s \u00b1 11.3 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n+sage: %timeit M._clear_cache(); M._row_ambient_module(QQ)\n+2.73 \u00b5s \u00b1 10.8 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n+sage: %timeit M._clear_cache(); M._column_ambient_module()\n+1.5 \u00b5s \u00b1 4.57 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n+sage: %timeit M._clear_cache(); v*M\n+5.26 \u00b5s \u00b1 20.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n ```\n \n After:\n@@ -18,12 +28,20 @@\n ```\n sage: M = random_matrix(ZZ, 10)\n sage: %timeit M._row_ambient_module()\n-66.8 ns \u00b1 0.0605 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\n+68.6 ns \u00b1 0.0774 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\n sage: %timeit M._row_ambient_module(QQ)\n-1.08 \u00b5s \u00b1 3.81 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n+1 \u00b5s \u00b1 1.16 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n sage: %timeit M._column_ambient_module()\n-65 ns \u00b1 0.0586 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\n+64.9 ns \u00b1 0.0636 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\n sage: v = random_vector(ZZ, 10)\n sage: %timeit v*M\n-1.85 \u00b5s \u00b1 1.07 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n+1.81 \u00b5s \u00b1 1.17 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n+sage: %timeit M._clear_cache(); M._row_ambient_module()\n+1.24 \u00b5s \u00b1 1.04 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n+sage: %timeit M._clear_cache(); M._row_ambient_module(QQ)\n+2.57 \u00b5s \u00b1 9.12 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n+sage: %timeit M._clear_cache(); M._column_ambient_module()\n+1.25 \u00b5s \u00b1 4.43 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n+sage: %timeit M._clear_cache(); v*M\n+3.34 \u00b5s \u00b1 13.7 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n ```\n``````\n",
    "created_at": "2021-11-25T08:51:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534393",
    "user": "https://github.com/kliem"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,16 +1,26 @@
+... and some other optimizations in `_row_ambient_module` and `_column_ambient_module`:
+
 Before:
 
 ```
 sage: M = random_matrix(ZZ, 10)
 sage: %timeit M._row_ambient_module()
-2.82 µs ± 10.3 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
+2.77 µs ± 11.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
 sage: %timeit M._row_ambient_module(QQ)
-2.91 µs ± 14.3 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
+2.93 µs ± 14.8 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
 sage: %timeit M._column_ambient_module()
-66.6 ns ± 0.105 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
+66.3 ns ± 0.0649 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
 sage: v = random_vector(ZZ, 10)
 sage: %timeit v*M
-5.79 µs ± 34.9 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
+5.56 µs ± 30.6 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
+sage: %timeit M._clear_cache(); M._row_ambient_module()
+2.61 µs ± 11.3 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
+sage: %timeit M._clear_cache(); M._row_ambient_module(QQ)
+2.73 µs ± 10.8 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
+sage: %timeit M._clear_cache(); M._column_ambient_module()
+1.5 µs ± 4.57 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
+sage: %timeit M._clear_cache(); v*M
+5.26 µs ± 20.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
 ```
 
 After:
@@ -18,12 +28,20 @@
 ```
 sage: M = random_matrix(ZZ, 10)
 sage: %timeit M._row_ambient_module()
-66.8 ns ± 0.0605 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
+68.6 ns ± 0.0774 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
 sage: %timeit M._row_ambient_module(QQ)
-1.08 µs ± 3.81 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
+1 µs ± 1.16 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
 sage: %timeit M._column_ambient_module()
-65 ns ± 0.0586 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
+64.9 ns ± 0.0636 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
 sage: v = random_vector(ZZ, 10)
 sage: %timeit v*M
-1.85 µs ± 1.07 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
+1.81 µs ± 1.17 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
+sage: %timeit M._clear_cache(); M._row_ambient_module()
+1.24 µs ± 1.04 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
+sage: %timeit M._clear_cache(); M._row_ambient_module(QQ)
+2.57 µs ± 9.12 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
+sage: %timeit M._clear_cache(); M._column_ambient_module()
+1.25 µs ± 4.43 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
+sage: %timeit M._clear_cache(); v*M
+3.34 µs ± 13.7 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
 ```
``````




---

archive/issue_events_434608.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2021-11-30T00:01:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32901#event-434608"
}
```



---

archive/issue_events_434609.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2021-11-30T00:01:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32901#event-434609"
}
```



---

archive/issue_comments_534394.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">Comment 21</div>\n\nLGTM. Nils, you may want to add yourself as an author?",
    "created_at": "2021-11-30T00:01:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534394",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:21" align="right">Comment 21</div>

LGTM. Nils, you may want to add yourself as an author?



---

archive/issue_comments_534395.json:
```json
{
    "body": "Reviewer: **Michael Orlitzky**",
    "created_at": "2021-11-30T00:01:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534395",
    "user": "https://github.com/orlitzky"
}
```

Reviewer: **Michael Orlitzky**



---

archive/issue_comments_534396.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">Comment 22</div>\n\nIs it really necessary to cache the ambient module when the `base_ring` argument is not the underlying base ring of the matrix? Going through the `repr` does not look like a reasonable option anyway. Discussion to be continued at #32984.",
    "created_at": "2021-12-07T02:43:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534396",
    "user": "https://github.com/videlec"
}
```

<div id="comment:22" align="right">Comment 22</div>

Is it really necessary to cache the ambient module when the `base_ring` argument is not the underlying base ring of the matrix? Going through the `repr` does not look like a reasonable option anyway. Discussion to be continued at #32984.



---

archive/issue_comments_534397.json:
```json
{
    "body": "Changed branch from **[public/32901](https://github.com/sagemath/sagetrac-mirror/tree/public/32901)** to **[e6188d0](https://github.com/sagemath/sagetrac-mirror/commit/e6188d02dacc78f3a594cad5925cccd8513483b2)**",
    "created_at": "2021-12-12T15:09:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32901#issuecomment-534397",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/32901](https://github.com/sagemath/sagetrac-mirror/tree/public/32901)** to **[e6188d0](https://github.com/sagemath/sagetrac-mirror/commit/e6188d02dacc78f3a594cad5925cccd8513483b2)**



---

archive/issue_events_434610.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-12-12T15:09:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32901#event-434610"
}
```



---

archive/issue_events_434611.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "a44d9b3c7cf462659d3de6c4d4664bd4c443d537",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-12-12T15:09:18Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/32901",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32901#event-434611"
}
```
