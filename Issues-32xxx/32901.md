# Issue 32901: Cache _row_ambient_module of matrices

archive/issues_032664.json:
```json
{
    "body": "... and some other optimizations in `_row_ambient_module` and `_column_ambient_module`:\n\nBefore:\n\n```\nsage: M = random_matrix(ZZ, 10)\nsage: %timeit M._row_ambient_module()\n2.77 \u00b5s \u00b1 11.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._row_ambient_module(QQ)\n2.93 \u00b5s \u00b1 14.8 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._column_ambient_module()\n66.3 ns \u00b1 0.0649 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\nsage: v = random_vector(ZZ, 10)\nsage: %timeit v*M\n5.56 \u00b5s \u00b1 30.6 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n2.61 \u00b5s \u00b1 11.3 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module(QQ)\n2.73 \u00b5s \u00b1 10.8 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n1.5 \u00b5s \u00b1 4.57 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: %timeit M._clear_cache(); v*M\n5.26 \u00b5s \u00b1 20.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\nAfter:\n\n```\nsage: M = random_matrix(ZZ, 10)\nsage: %timeit M._row_ambient_module()\n68.6 ns \u00b1 0.0774 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\nsage: %timeit M._row_ambient_module(QQ)\n1 \u00b5s \u00b1 1.16 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: %timeit M._column_ambient_module()\n64.9 ns \u00b1 0.0636 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\nsage: v = random_vector(ZZ, 10)\nsage: %timeit v*M\n1.81 \u00b5s \u00b1 1.17 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n1.24 \u00b5s \u00b1 1.04 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module(QQ)\n2.57 \u00b5s \u00b1 9.12 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n1.25 \u00b5s \u00b1 4.43 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: %timeit M._clear_cache(); v*M\n3.34 \u00b5s \u00b1 13.7 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\nCC:  @nbruin @orlitzky\n\nBranch/Commit: e6188d02dacc78f3a594cad5925cccd8513483b2\n\nReviewer: Michael Orlitzky\n\nAuthor: Jonathan Kliem\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32901\n\n",
    "closed_at": "2021-12-12T15:09:18Z",
    "created_at": "2021-11-19T08:18:10Z",
    "labels": [
        "component: linear algebra",
        "critical"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Cache _row_ambient_module of matrices",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32901",
    "user": "https://github.com/kliem"
}
```
... and some other optimizations in `_row_ambient_module` and `_column_ambient_module`:

Before:

```
sage: M = random_matrix(ZZ, 10)
sage: %timeit M._row_ambient_module()
2.77 µs ± 11.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._row_ambient_module(QQ)
2.93 µs ± 14.8 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._column_ambient_module()
66.3 ns ± 0.0649 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
sage: v = random_vector(ZZ, 10)
sage: %timeit v*M
5.56 µs ± 30.6 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module()
2.61 µs ± 11.3 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module(QQ)
2.73 µs ± 10.8 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._column_ambient_module()
1.5 µs ± 4.57 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit M._clear_cache(); v*M
5.26 µs ± 20.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

After:

```
sage: M = random_matrix(ZZ, 10)
sage: %timeit M._row_ambient_module()
68.6 ns ± 0.0774 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
sage: %timeit M._row_ambient_module(QQ)
1 µs ± 1.16 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit M._column_ambient_module()
64.9 ns ± 0.0636 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
sage: v = random_vector(ZZ, 10)
sage: %timeit v*M
1.81 µs ± 1.17 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module()
1.24 µs ± 1.04 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module(QQ)
2.57 µs ± 9.12 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._column_ambient_module()
1.25 µs ± 4.43 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit M._clear_cache(); v*M
3.34 µs ± 13.7 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

CC:  @nbruin @orlitzky

Branch/Commit: e6188d02dacc78f3a594cad5925cccd8513483b2

Reviewer: Michael Orlitzky

Author: Jonathan Kliem

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/32901





---

archive/issue_comments_497605.json:
```json
{
    "body": "<a id='comment:1'></a>It's a tiny change with a huge perfomance impact on `_vector_times_matrix_`, hence I marked it as critical.\n\n---\nNew commits:",
    "created_at": "2021-11-19T08:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497605",
    "user": "https://github.com/kliem"
}
```

<a id='comment:1'></a>It's a tiny change with a huge perfomance impact on `_vector_times_matrix_`, hence I marked it as critical.

---
New commits:



---

archive/issue_comments_497606.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-11-19T08:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497606",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_497607.json:
```json
{
    "body": "<a id='comment:2'></a>Given the following:\n\n```\nsage: M = random_matrix(ZZ, 10)\nsage: p = M._row_ambient_module()\nsage: %timeit p.zero_vector()\n703 ns \u00b1 1.65 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n```\n\nI would say that the ticket is a good start. Using `cached_method` decorator does not give an improvement (but a slight slowdown).",
    "created_at": "2021-11-19T23:01:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497607",
    "user": "https://github.com/kliem"
}
```

<a id='comment:2'></a>Given the following:

```
sage: M = random_matrix(ZZ, 10)
sage: p = M._row_ambient_module()
sage: %timeit p.zero_vector()
703 ns ± 1.65 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
```

I would say that the ticket is a good start. Using `cached_method` decorator does not give an improvement (but a slight slowdown).



---

archive/issue_comments_497608.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-19T23:58:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497608",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_497609.json:
```json
{
    "body": "<a id='comment:4'></a>This change reduces the penalty for having an optional `base_ring` argument a little further: I'm now seeing 109 ns vs. 101 ns for row vs. column. So the price of the optional argument, together with the testing for it, is still measurable, but is now something like 6% rather than 50%.",
    "created_at": "2021-11-20T00:01:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497609",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:4'></a>This change reduces the penalty for having an optional `base_ring` argument a little further: I'm now seeing 109 ns vs. 101 ns for row vs. column. So the price of the optional argument, together with the testing for it, is still measurable, but is now something like 6% rather than 50%.



---

archive/issue_comments_497610.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,7 +1,7 @@\n Before:\n \n ```\n-sage: M = random_matrix(ZZ, 100)\n+sage: M = random_matrix(ZZ, 10)\n sage: %timeit M._row_ambient_module()\n 2.82 \u00b5s \u00b1 10.3 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n sage: %timeit M._row_ambient_module(QQ)\n``````\n",
    "created_at": "2021-11-20T09:36:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497610",
    "user": "https://github.com/kliem"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,7 +1,7 @@
 Before:
 
 ```
-sage: M = random_matrix(ZZ, 100)
+sage: M = random_matrix(ZZ, 10)
 sage: %timeit M._row_ambient_module()
 2.82 µs ± 10.3 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
 sage: %timeit M._row_ambient_module(QQ)
``````




---

archive/issue_comments_497611.json:
```json
{
    "body": "<a id='comment:6'></a>`_repr_` doesn't work unfortunatly. There are failing doctests.",
    "created_at": "2021-11-20T10:02:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497611",
    "user": "https://github.com/kliem"
}
```

<a id='comment:6'></a>`_repr_` doesn't work unfortunatly. There are failing doctests.



---

archive/issue_comments_497612.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,32 @@\n+Before:\n \n+```\n+sage: M = random_matrix(ZZ, 10)\n+sage: %timeit M._row_ambient_module()\n+2.82 \u00b5s \u00b1 10.3 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n+sage: %timeit M._row_ambient_module(QQ)\n+2.91 \u00b5s \u00b1 14.3 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n+sage: %timeit M._column_ambient_module()\n+66.6 ns \u00b1 0.105 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\n+sage: v = random_vector(ZZ, 10)\n+sage: %timeit v*M\n+5.79 \u00b5s \u00b1 34.9 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n+```\n+\n+After:\n+\n+```\n+sage: M = random_matrix(ZZ, 10)\n+sage: %timeit M._row_ambient_module()\n+66.8 ns \u00b1 0.0605 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\n+sage: %timeit M._row_ambient_module(QQ)\n+1.08 \u00b5s \u00b1 3.81 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n+sage: %timeit M._column_ambient_module()\n+65 ns \u00b1 0.0586 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\n+sage: v = random_vector(ZZ, 10)\n+sage: %timeit v*M\n+1.85 \u00b5s \u00b1 1.07 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n+```\n \n Author: Jonathan Kliem\n \n``````\n",
    "created_at": "2021-11-20T10:06:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497612",
    "user": "https://github.com/kliem"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,32 @@
+Before:
 
+```
+sage: M = random_matrix(ZZ, 10)
+sage: %timeit M._row_ambient_module()
+2.82 µs ± 10.3 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
+sage: %timeit M._row_ambient_module(QQ)
+2.91 µs ± 14.3 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
+sage: %timeit M._column_ambient_module()
+66.6 ns ± 0.105 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
+sage: v = random_vector(ZZ, 10)
+sage: %timeit v*M
+5.79 µs ± 34.9 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
+```
+
+After:
+
+```
+sage: M = random_matrix(ZZ, 10)
+sage: %timeit M._row_ambient_module()
+66.8 ns ± 0.0605 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
+sage: %timeit M._row_ambient_module(QQ)
+1.08 µs ± 3.81 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
+sage: %timeit M._column_ambient_module()
+65 ns ± 0.0586 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
+sage: v = random_vector(ZZ, 10)
+sage: %timeit v*M
+1.85 µs ± 1.07 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
+```
 
 Author: Jonathan Kliem
 
``````




---

archive/issue_comments_497613.json:
```json
{
    "body": "<a id='comment:7'></a>With the changes that I'll push in a second, I get the following timings:\n\n```\nsage: M = random_matrix(ZZ, 10)\nsage: %timeit M._row_ambient_module(QQ)\n1.08 \u00b5s \u00b1 2.16 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: %timeit M._row_ambient_module().change_ring(QQ)\n2.57 \u00b5s \u00b1 7.9 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\nSo it is still a bit faster. Unfortunatly, `__repr__` is lots slower than `_repr_`.",
    "created_at": "2021-11-20T10:06:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497613",
    "user": "https://github.com/kliem"
}
```

<a id='comment:7'></a>With the changes that I'll push in a second, I get the following timings:

```
sage: M = random_matrix(ZZ, 10)
sage: %timeit M._row_ambient_module(QQ)
1.08 µs ± 2.16 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: %timeit M._row_ambient_module().change_ring(QQ)
2.57 µs ± 7.9 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

So it is still a bit faster. Unfortunatly, `__repr__` is lots slower than `_repr_`.



---

archive/issue_comments_497614.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-20T10:06:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497614",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_497615.json:
```json
{
    "body": "<a id='comment:9'></a>This is the `__repr__` on `SageObject`:\n\n```\n        try:\n            name = self.__custom_name\n            if name is not None:\n                return name\n        except AttributeError:\n            pass\n        try:\n            reprfunc = self._repr_\n        except AttributeError:\n            return super().__repr__()\n        result = reprfunc()\n        if isinstance(result, str):\n            return result\n        # Allow _repr_ to return unicode on Python 2\n        return result.encode('utf-8')\n```\nI think our python 2 compatibility should be removed now. Furthermore, I think `__repr__` should return a `str`, not a `bytes` (which is what `encode` will return). So the fallback is now erroneous, I think. That means we should just return `result` unconditionally and trust it produces a `str`.\n**EDIT**: these changes don't actually affect the speed very much. I assume `__custom_name` is rare, so the usual code path at the moment incurs an `AttributeError`, which is the expensive part of a `try/except`. Rewriting that with a `hasattr(self,\"__custom_name\")` instead didn't really affect the speed much either.",
    "created_at": "2021-11-20T23:24:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497615",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:9'></a>This is the `__repr__` on `SageObject`:

```
        try:
            name = self.__custom_name
            if name is not None:
                return name
        except AttributeError:
            pass
        try:
            reprfunc = self._repr_
        except AttributeError:
            return super().__repr__()
        result = reprfunc()
        if isinstance(result, str):
            return result
        # Allow _repr_ to return unicode on Python 2
        return result.encode('utf-8')
```
I think our python 2 compatibility should be removed now. Furthermore, I think `__repr__` should return a `str`, not a `bytes` (which is what `encode` will return). So the fallback is now erroneous, I think. That means we should just return `result` unconditionally and trust it produces a `str`.
**EDIT**: these changes don't actually affect the speed very much. I assume `__custom_name` is rare, so the usual code path at the moment incurs an `AttributeError`, which is the expensive part of a `try/except`. Rewriting that with a `hasattr(self,"__custom_name")` instead didn't really affect the speed much either.



---

archive/issue_comments_497616.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:9 nbruin]:\n> This is the `__repr__` on `SageObject`:\n> \n> ```\n>         try:\n>             name = self.__custom_name\n>             if name is not None:\n>                 return name\n>         except AttributeError:\n>             pass\n>         try:\n>             reprfunc = self._repr_\n>         except AttributeError:\n>             return super().__repr__()\n>         result = reprfunc()\n>         if isinstance(result, str):\n>             return result\n>         # Allow _repr_ to return unicode on Python 2\n>         return result.encode('utf-8')\n> ```\n> I think our python 2 compatibility should be removed now. Furthermore, I think `__repr__` should return a `str`, not a `bytes` (which is what `encode` will return). So the fallback is now erroneous, I think. That means we should just return `result` unconditionally and trust it produces a `str`.\n> **EDIT**: these changes don't actually affect the speed very much. I assume `__custom_name` is rare, so the usual code path at the moment incurs an `AttributeError`, which is the expensive part of a `try/except`. Rewriting that with a `hasattr(self,\"__custom_name\")` instead didn't really affect the speed much either.\n\n\nYes, unfortunatly this choice of `self.__custom_name` is slow.\n\nHowever, I don't think doing those changes should be part of this ticket.",
    "created_at": "2021-11-23T13:55:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497616",
    "user": "https://github.com/kliem"
}
```

<a id='comment:10'></a>Replying to [comment:9 nbruin]:
> This is the `__repr__` on `SageObject`:
> 
> ```
>         try:
>             name = self.__custom_name
>             if name is not None:
>                 return name
>         except AttributeError:
>             pass
>         try:
>             reprfunc = self._repr_
>         except AttributeError:
>             return super().__repr__()
>         result = reprfunc()
>         if isinstance(result, str):
>             return result
>         # Allow _repr_ to return unicode on Python 2
>         return result.encode('utf-8')
> ```
> I think our python 2 compatibility should be removed now. Furthermore, I think `__repr__` should return a `str`, not a `bytes` (which is what `encode` will return). So the fallback is now erroneous, I think. That means we should just return `result` unconditionally and trust it produces a `str`.
> **EDIT**: these changes don't actually affect the speed very much. I assume `__custom_name` is rare, so the usual code path at the moment incurs an `AttributeError`, which is the expensive part of a `try/except`. Rewriting that with a `hasattr(self,"__custom_name")` instead didn't really affect the speed much either.


Yes, unfortunatly this choice of `self.__custom_name` is slow.

However, I don't think doing those changes should be part of this ticket.



---

archive/issue_comments_497617.json:
```json
{
    "body": "<a id='comment:11'></a>Please leave some comments in the code mentioning how performance-critical it is, and that the unusual logic speeds things up. Otherwise someone is going to see the duplication introduced in Nils's commit and try to change it back the way it was.",
    "created_at": "2021-11-23T23:55:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497617",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:11'></a>Please leave some comments in the code mentioning how performance-critical it is, and that the unusual logic speeds things up. Otherwise someone is going to see the duplication introduced in Nils's commit and try to change it back the way it was.



---

archive/issue_comments_497618.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-24T06:30:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497618",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_497619.json:
```json
{
    "body": "<a id='comment:13'></a>So long as we're shaving off nanoseconds, you can probably replace `self.ncols()` with `self._ncols`,  `self.base_ring()` with `self._base_ring`, and `self.is_sparse()` with `self.is_sparse_c()` to help the compiler out if it hasn't already optimized out the intermediate methods.",
    "created_at": "2021-11-24T12:36:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497619",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:13'></a>So long as we're shaving off nanoseconds, you can probably replace `self.ncols()` with `self._ncols`,  `self.base_ring()` with `self._base_ring`, and `self.is_sparse()` with `self.is_sparse_c()` to help the compiler out if it hasn't already optimized out the intermediate methods.



---

archive/issue_comments_497620.json:
```json
{
    "body": "<a id='comment:14'></a>I could do that, but it woudn't make difference for the cached version.",
    "created_at": "2021-11-24T13:08:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497620",
    "user": "https://github.com/kliem"
}
```

<a id='comment:14'></a>I could do that, but it woudn't make difference for the cached version.



---

archive/issue_comments_497621.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 gh-kliem]:\n> I could do that, but it woudn't make difference for the cached version.\n\n\nSure, but it doesn't hurt the cached path, either. Since this is critical for vector-matrix multiplication, I was thinking of all the random tests that I have that generate a random matrix, use it once, and then throw it out. The difference is small but measurable.\n\nBefore:\n\n```\nsage: M = matrix.random(ZZ,10)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n5.16 \u00b5s \u00b1 12.9 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n5.18 \u00b5s \u00b1 10.8 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n5.17 \u00b5s \u00b1 9.82 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n5.17 \u00b5s \u00b1 10.7 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n5.1 \u00b5s \u00b1 22.8 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\nAfter:\n\n```\nsage: M = matrix.random(ZZ,10)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n4.93 \u00b5s \u00b1 18 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n4.85 \u00b5s \u00b1 15 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n4.86 \u00b5s \u00b1 19.4 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n4.93 \u00b5s \u00b1 5.97 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._row_ambient_module()\n4.89 \u00b5s \u00b1 13.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```",
    "created_at": "2021-11-24T23:13:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497621",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:15'></a>Replying to [comment:14 gh-kliem]:
> I could do that, but it woudn't make difference for the cached version.


Sure, but it doesn't hurt the cached path, either. Since this is critical for vector-matrix multiplication, I was thinking of all the random tests that I have that generate a random matrix, use it once, and then throw it out. The difference is small but measurable.

Before:

```
sage: M = matrix.random(ZZ,10)
sage: %timeit M._clear_cache(); M._row_ambient_module()
5.16 µs ± 12.9 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module()
5.18 µs ± 10.8 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module()
5.17 µs ± 9.82 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module()
5.17 µs ± 10.7 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module()
5.1 µs ± 22.8 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

After:

```
sage: M = matrix.random(ZZ,10)
sage: %timeit M._clear_cache(); M._row_ambient_module()
4.93 µs ± 18 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module()
4.85 µs ± 15 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module()
4.86 µs ± 19.4 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module()
4.93 µs ± 5.97 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._row_ambient_module()
4.89 µs ± 13.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```



---

archive/issue_comments_497622.json:
```json
{
    "body": "<a id='comment:16'></a>While you're at it, check if the same changes can be made to _column_ambient_module.",
    "created_at": "2021-11-24T23:51:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497622",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:16'></a>While you're at it, check if the same changes can be made to _column_ambient_module.



---

archive/issue_comments_497623.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:16 nbruin]:\n> While you're at it, check if the same changes can be made to _column_ambient_module.\n\n\nSure. Before:\n\n```\nsage: M = matrix.random(ZZ,10)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n5.02 \u00b5s \u00b1 12.9 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n5.01 \u00b5s \u00b1 17.3 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n5.02 \u00b5s \u00b1 9.4 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n5.01 \u00b5s \u00b1 9.14 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n5.02 \u00b5s \u00b1 12.9 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\nAnd after:\n\n```\nsage: M = matrix.random(ZZ,10)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n4.36 \u00b5s \u00b1 17.8 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n4.41 \u00b5s \u00b1 14.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n4.41 \u00b5s \u00b1 25.1 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n4.41 \u00b5s \u00b1 19.1 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit M._clear_cache(); M._column_ambient_module()\n4.41 \u00b5s \u00b1 32.7 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```",
    "created_at": "2021-11-25T00:35:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497623",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:17'></a>Replying to [comment:16 nbruin]:
> While you're at it, check if the same changes can be made to _column_ambient_module.


Sure. Before:

```
sage: M = matrix.random(ZZ,10)
sage: %timeit M._clear_cache(); M._column_ambient_module()
5.02 µs ± 12.9 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._column_ambient_module()
5.01 µs ± 17.3 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._column_ambient_module()
5.02 µs ± 9.4 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._column_ambient_module()
5.01 µs ± 9.14 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._column_ambient_module()
5.02 µs ± 12.9 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

And after:

```
sage: M = matrix.random(ZZ,10)
sage: %timeit M._clear_cache(); M._column_ambient_module()
4.36 µs ± 17.8 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._column_ambient_module()
4.41 µs ± 14.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._column_ambient_module()
4.41 µs ± 25.1 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._column_ambient_module()
4.41 µs ± 19.1 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit M._clear_cache(); M._column_ambient_module()
4.41 µs ± 32.7 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```



---

archive/issue_comments_497624.json:
```json
{
    "body": "<a id='comment:18'></a>The current state:\n\n```\nsage: set_random_seed(0)\nsage: M = matrix.random(ZZ, 10)\nsage: v = random_vector(ZZ, 10)\nsage: %timeit M._clear_cache(); v*M\n3.69 \u00b5s \u00b1 12.6 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\nWith optimization:\n\n```\nsage: set_random_seed(0)\nsage: M = matrix.random(ZZ, 10)\nsage: v = random_vector(ZZ, 10)\nsage: %timeit M._clear_cache(); v*M\n3.54 \u00b5s \u00b1 28.6 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\nSo you are right. It is noticable.",
    "created_at": "2021-11-25T08:37:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497624",
    "user": "https://github.com/kliem"
}
```

<a id='comment:18'></a>The current state:

```
sage: set_random_seed(0)
sage: M = matrix.random(ZZ, 10)
sage: v = random_vector(ZZ, 10)
sage: %timeit M._clear_cache(); v*M
3.69 µs ± 12.6 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

With optimization:

```
sage: set_random_seed(0)
sage: M = matrix.random(ZZ, 10)
sage: v = random_vector(ZZ, 10)
sage: %timeit M._clear_cache(); v*M
3.54 µs ± 28.6 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

So you are right. It is noticable.



---

archive/issue_comments_497625.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-25T08:37:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497625",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_497626.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,50 @@\n+... and some other optimizations in `_row_ambient_module` and `_column_ambient_module`:\n \n+Before:\n+\n+```\n+sage: M = random_matrix(ZZ, 10)\n+sage: %timeit M._row_ambient_module()\n+2.77 \u00b5s \u00b1 11.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n+sage: %timeit M._row_ambient_module(QQ)\n+2.93 \u00b5s \u00b1 14.8 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n+sage: %timeit M._column_ambient_module()\n+66.3 ns \u00b1 0.0649 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\n+sage: v = random_vector(ZZ, 10)\n+sage: %timeit v*M\n+5.56 \u00b5s \u00b1 30.6 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n+sage: %timeit M._clear_cache(); M._row_ambient_module()\n+2.61 \u00b5s \u00b1 11.3 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n+sage: %timeit M._clear_cache(); M._row_ambient_module(QQ)\n+2.73 \u00b5s \u00b1 10.8 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n+sage: %timeit M._clear_cache(); M._column_ambient_module()\n+1.5 \u00b5s \u00b1 4.57 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n+sage: %timeit M._clear_cache(); v*M\n+5.26 \u00b5s \u00b1 20.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n+```\n+\n+After:\n+\n+```\n+sage: M = random_matrix(ZZ, 10)\n+sage: %timeit M._row_ambient_module()\n+68.6 ns \u00b1 0.0774 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\n+sage: %timeit M._row_ambient_module(QQ)\n+1 \u00b5s \u00b1 1.16 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n+sage: %timeit M._column_ambient_module()\n+64.9 ns \u00b1 0.0636 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000000 loops each)\n+sage: v = random_vector(ZZ, 10)\n+sage: %timeit v*M\n+1.81 \u00b5s \u00b1 1.17 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n+sage: %timeit M._clear_cache(); M._row_ambient_module()\n+1.24 \u00b5s \u00b1 1.04 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n+sage: %timeit M._clear_cache(); M._row_ambient_module(QQ)\n+2.57 \u00b5s \u00b1 9.12 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n+sage: %timeit M._clear_cache(); M._column_ambient_module()\n+1.25 \u00b5s \u00b1 4.43 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n+sage: %timeit M._clear_cache(); v*M\n+3.34 \u00b5s \u00b1 13.7 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n+```\n \n Author: Jonathan Kliem\n \n``````\n",
    "created_at": "2021-11-25T08:51:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497626",
    "user": "https://github.com/kliem"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,50 @@
+... and some other optimizations in `_row_ambient_module` and `_column_ambient_module`:
 
+Before:
+
+```
+sage: M = random_matrix(ZZ, 10)
+sage: %timeit M._row_ambient_module()
+2.77 µs ± 11.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
+sage: %timeit M._row_ambient_module(QQ)
+2.93 µs ± 14.8 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
+sage: %timeit M._column_ambient_module()
+66.3 ns ± 0.0649 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
+sage: v = random_vector(ZZ, 10)
+sage: %timeit v*M
+5.56 µs ± 30.6 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
+sage: %timeit M._clear_cache(); M._row_ambient_module()
+2.61 µs ± 11.3 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
+sage: %timeit M._clear_cache(); M._row_ambient_module(QQ)
+2.73 µs ± 10.8 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
+sage: %timeit M._clear_cache(); M._column_ambient_module()
+1.5 µs ± 4.57 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
+sage: %timeit M._clear_cache(); v*M
+5.26 µs ± 20.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
+```
+
+After:
+
+```
+sage: M = random_matrix(ZZ, 10)
+sage: %timeit M._row_ambient_module()
+68.6 ns ± 0.0774 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
+sage: %timeit M._row_ambient_module(QQ)
+1 µs ± 1.16 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
+sage: %timeit M._column_ambient_module()
+64.9 ns ± 0.0636 ns per loop (mean ± std. dev. of 7 runs, 10000000 loops each)
+sage: v = random_vector(ZZ, 10)
+sage: %timeit v*M
+1.81 µs ± 1.17 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
+sage: %timeit M._clear_cache(); M._row_ambient_module()
+1.24 µs ± 1.04 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
+sage: %timeit M._clear_cache(); M._row_ambient_module(QQ)
+2.57 µs ± 9.12 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
+sage: %timeit M._clear_cache(); M._column_ambient_module()
+1.25 µs ± 4.43 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
+sage: %timeit M._clear_cache(); v*M
+3.34 µs ± 13.7 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
+```
 
 Author: Jonathan Kliem
 
``````




---

archive/issue_comments_497627.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-11-30T00:01:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497627",
    "user": "https://github.com/orlitzky"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_497628.json:
```json
{
    "body": "<a id='comment:21'></a>LGTM. Nils, you may want to add yourself as an author?",
    "created_at": "2021-11-30T00:01:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497628",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:21'></a>LGTM. Nils, you may want to add yourself as an author?



---

archive/issue_comments_497629.json:
```json
{
    "body": "<a id='comment:22'></a>Is it really necessary to cache the ambient module when the `base_ring` argument is not the underlying base ring of the matrix? Going through the `repr` does not look like a reasonable option anyway. Discussion to be continued at #32984.",
    "created_at": "2021-12-07T02:43:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497629",
    "user": "https://github.com/videlec"
}
```

<a id='comment:22'></a>Is it really necessary to cache the ambient module when the `base_ring` argument is not the underlying base ring of the matrix? Going through the `repr` does not look like a reasonable option anyway. Discussion to be continued at #32984.



---

archive/issue_events_086971.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-12-12T15:09:18Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32901#event-86971"
}
```



---

archive/issue_comments_497630.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-12-12T15:09:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32901",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32901#issuecomment-497630",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
