# Issue 32031: Stop setuptools install from nuking the setuptools_scm installation

archive/issues_031794.json:
```json
{
    "assignees": [],
    "body": "Possibly related to `pip` and `setuptools_scm`.\n\nReported in:\n- https://groups.google.com/g/sage-release/c/vCHOb2h80kU/m/-h1eI1BPBgAJ\n- https://patchbot.sagemath.org/ticket/0/\n\nCC:  @dimpase @mkoeppe @rocky @kiwifb @isuruf @kliem\n\nBranch/Commit: **[`f307b11`](https://github.com/sagemath/sagetrac-mirror/commit/f307b11af55cd9ee7302d8983773a4d71703b6ff)**\n\nReviewer: **Dima Pasechnik**\n\nAuthor: **Matthias Koeppe**\n\nComponent: **build**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/32031_\n\n",
    "closed_at": "2021-06-29T17:39:52Z",
    "created_at": "2021-06-22T08:45:14Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20build",
        "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Stop setuptools install from nuking the setuptools_scm installation",
    "type": "issue",
    "updated_at": "2021-06-29T17:39:52Z",
    "url": "https://github.com/sagemath/sage/issues/32031",
    "user": "https://github.com/sagetrac-tmonteil"
}
```
Possibly related to `pip` and `setuptools_scm`.

Reported in:
- https://groups.google.com/g/sage-release/c/vCHOb2h80kU/m/-h1eI1BPBgAJ
- https://patchbot.sagemath.org/ticket/0/

CC:  @dimpase @mkoeppe @rocky @kiwifb @isuruf @kliem

Branch/Commit: **[`f307b11`](https://github.com/sagemath/sagetrac-mirror/commit/f307b11af55cd9ee7302d8983773a4d71703b6ff)**

Reviewer: **Dima Pasechnik**

Author: **Matthias Koeppe**

Component: **build**

_Issue created by migration from https://trac.sagemath.org/ticket/32031_





---

archive/issue_events_438530.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2021-06-22T08:45:14Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32031#event-438530"
}
```



---

archive/issue_events_438531.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2021-06-22T08:45:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32031#event-438531"
}
```



---

archive/issue_events_438532.json:
```json
{
    "actor": "https://github.com/sagetrac-tmonteil",
    "created_at": "2021-06-22T08:45:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32031#event-438532"
}
```



---

archive/issue_comments_515553.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\n\n```\n[mpmath-1.2.1]     ERROR: Could not find a version that satisfies the requirement setuptools_scm>=1.7.0 (from versions: none)\n[mpmath-1.2.1]     ERROR: No matching distribution found for setuptools_scm>=1.7.0\n[mpmath-1.2.1]     Traceback (most recent call last):\n[mpmath-1.2.1]       File \"/home/chapoton/sage/local/lib/python3.9/site-packages/setuptools/installer.py\", line 75, in fetch_build_egg\n[mpmath-1.2.1]         subprocess.check_call(cmd)\n[mpmath-1.2.1]       File \"/usr/lib/python3.9/subprocess.py\", line 373, in check_call\n[mpmath-1.2.1]         raise CalledProcessError(retcode, cmd)\n[mpmath-1.2.1]     subprocess.CalledProcessError: Command '['/home/chapoton/sage/local/bin/python3', '-m', 'pip', '--disable-pip-version-check', 'wheel', '--no-deps', '-w', '/tmp/tmpqau7q1i8', '--quiet', 'setuptools_scm>=1.7.0']' returned non-zero exit status 1.\n```\n\nDespite the dependencies declared in `build/pkgs/mpmath/dependencies`, it seems `setuptools_scm` has not been installed",
    "created_at": "2021-06-22T13:16:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515553",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:1" align="right">comment:1</div>


```
[mpmath-1.2.1]     ERROR: Could not find a version that satisfies the requirement setuptools_scm>=1.7.0 (from versions: none)
[mpmath-1.2.1]     ERROR: No matching distribution found for setuptools_scm>=1.7.0
[mpmath-1.2.1]     Traceback (most recent call last):
[mpmath-1.2.1]       File "/home/chapoton/sage/local/lib/python3.9/site-packages/setuptools/installer.py", line 75, in fetch_build_egg
[mpmath-1.2.1]         subprocess.check_call(cmd)
[mpmath-1.2.1]       File "/usr/lib/python3.9/subprocess.py", line 373, in check_call
[mpmath-1.2.1]         raise CalledProcessError(retcode, cmd)
[mpmath-1.2.1]     subprocess.CalledProcessError: Command '['/home/chapoton/sage/local/bin/python3', '-m', 'pip', '--disable-pip-version-check', 'wheel', '--no-deps', '-w', '/tmp/tmpqau7q1i8', '--quiet', 'setuptools_scm>=1.7.0']' returned non-zero exit status 1.
```

Despite the dependencies declared in `build/pkgs/mpmath/dependencies`, it seems `setuptools_scm` has not been installed



---

archive/issue_events_438533.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-22T13:22:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "0000b0",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32031#event-438533"
}
```



---

archive/issue_events_438534.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-22T13:22:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32031#event-438534"
}
```



---

archive/issue_events_438535.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-22T13:22:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32031#event-438535"
}
```



---

archive/issue_events_438536.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-22T13:22:25Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "title_is": "Dependency of mpmath on setuptools_scm is ineffective",
    "title_was": "patchbots fail to build mpmath",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32031#event-438536"
}
```



---

archive/issue_comments_515554.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,5 @@\n-See https://patchbot.sagemath.org/ticket/0/\n-\n Possibly related to `pip` and `setuptools_scm`.\n \n+Reported in:\n+- https://groups.google.com/g/sage-release/c/vCHOb2h80kU/m/-h1eI1BPBgAJ\n+- https://patchbot.sagemath.org/ticket/0/\n``````\n",
    "created_at": "2021-06-22T13:22:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515554",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,5 @@
-See https://patchbot.sagemath.org/ticket/0/
-
 Possibly related to `pip` and `setuptools_scm`.
 
+Reported in:
+- https://groups.google.com/g/sage-release/c/vCHOb2h80kU/m/-h1eI1BPBgAJ
+- https://patchbot.sagemath.org/ticket/0/
``````




---

archive/issue_comments_515555.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nSomething similar happened before in #31915 - are our order-only dependencies broken?",
    "created_at": "2021-06-22T13:24:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515555",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:3" align="right">comment:3</div>

Something similar happened before in #31915 - are our order-only dependencies broken?



---

archive/issue_comments_515556.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nWhat's the version of `make` on the machines where this fails?",
    "created_at": "2021-06-22T13:42:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515556",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:4" align="right">comment:4</div>

What's the version of `make` on the machines where this fails?



---

archive/issue_comments_515557.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\n\n```\nkliem@cofio:~/localhome/sage$ make --version\nGNU Make 4.2.1\nBuilt for x86_64-pc-linux-gnu\nCopyright (C) 1988-2016 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.\n```",
    "created_at": "2021-06-22T13:44:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515557",
    "user": "https://github.com/kliem"
}
```

<div id="comment:5" align="right">comment:5</div>


```
kliem@cofio:~/localhome/sage$ make --version
GNU Make 4.2.1
Built for x86_64-pc-linux-gnu
Copyright (C) 1988-2016 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
```



---

archive/issue_comments_515558.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nIt would be helpful to use `make --debug=all` to see what's happening with the dependencies.",
    "created_at": "2021-06-22T13:46:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515558",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:6" align="right">comment:6</div>

It would be helpful to use `make --debug=all` to see what's happening with the dependencies.



---

archive/issue_comments_515559.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nOk. So what part do I need to rebuilt then?",
    "created_at": "2021-06-22T13:47:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515559",
    "user": "https://github.com/kliem"
}
```

<div id="comment:7" align="right">comment:7</div>

Ok. So what part do I need to rebuilt then?



---

archive/issue_comments_515560.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nI'd say do `make setuptools_scm-clean mpmath-clean` and then run `make --debug=all mpmath`",
    "created_at": "2021-06-22T13:50:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515560",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:8" align="right">comment:8</div>

I'd say do `make setuptools_scm-clean mpmath-clean` and then run `make --debug=all mpmath`



---

archive/issue_comments_515561.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nMy guess is that #29013 (merged in 9.4.beta0) somehow managed to break order-only dependencies",
    "created_at": "2021-06-22T13:52:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515561",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:9" align="right">comment:9</div>

My guess is that #29013 (merged in 9.4.beta0) somehow managed to break order-only dependencies



---

archive/issue_comments_515562.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nWell it fixed it. Thanks. But now I'm confused and I don't know what happened.",
    "created_at": "2021-06-22T13:55:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515562",
    "user": "https://github.com/kliem"
}
```

<div id="comment:10" align="right">comment:10</div>

Well it fixed it. Thanks. But now I'm confused and I don't know what happened.



---

archive/issue_comments_515563.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nShould I fix the patchbot like this?",
    "created_at": "2021-06-22T14:15:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515563",
    "user": "https://github.com/kliem"
}
```

<div id="comment:11" align="right">comment:11</div>

Should I fix the patchbot like this?



---

archive/issue_comments_515564.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nCan you post the debug output please?",
    "created_at": "2021-06-22T14:16:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515564",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:12" align="right">comment:12</div>

Can you post the debug output please?



---

archive/issue_comments_515565.json:
```json
{
    "body": "Attachment: **[debug.log](https://github.com/sagemath/sage/files/ticket32031/debug.log)**\n\nmpmath with debug",
    "created_at": "2021-06-22T14:22:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515565",
    "user": "https://github.com/kliem"
}
```

Attachment: **[debug.log](https://github.com/sagemath/sage/files/ticket32031/debug.log)**

mpmath with debug



---

archive/issue_comments_515566.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nEverything looks fine in this log...",
    "created_at": "2021-06-22T15:05:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515566",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:13" align="right">comment:13</div>

Everything looks fine in this log...



---

archive/issue_comments_515567.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\n\n```\n[setuptools_scm-6.0.1] Ignoring indexes: https://pypi.org/simple\n```\nCould this make the difference?",
    "created_at": "2021-06-22T15:52:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515567",
    "user": "https://github.com/kliem"
}
```

<div id="comment:14" align="right">comment:14</div>


```
[setuptools_scm-6.0.1] Ignoring indexes: https://pypi.org/simple
```
Could this make the difference?



---

archive/issue_comments_515568.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\n\"Ignoring indexes\" is normal - we do not use PyPI for installing normal packages. (See `build/bin/sage-dist-helpers` (`sdh_pip_install`)",
    "created_at": "2021-06-22T16:03:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515568",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:15" align="right">comment:15</div>

"Ignoring indexes" is normal - we do not use PyPI for installing normal packages. (See `build/bin/sage-dist-helpers` (`sdh_pip_install`)



---

archive/issue_comments_515569.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@mkoeppe](#comment:6):\n> It would be helpful to use `make --debug=all` to see what's happening with the dependencies.\n\nIn my biased opinion, if you feel the need to run `make --debug=all`, `remake -x` is better.",
    "created_at": "2021-06-22T16:27:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515569",
    "user": "https://github.com/rocky"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@mkoeppe](#comment:6):
> It would be helpful to use `make --debug=all` to see what's happening with the dependencies.

In my biased opinion, if you feel the need to run `make --debug=all`, `remake -x` is better.



---

archive/issue_comments_515570.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nI gather that `setuptools_scm` must really depend on `setuptools`, not just order-only.\nBecause if I rebuild `setuptools`, clean `mpmath` and try building `mpmath` again (without cleaning `setuptools_scm`), it gets stuck,\nas follows:\n\n```\n[mpmath-1.2.1]     Running setup.py (path:/private/var/folders/lh/tzyg2vbn4z99vg__rg2_t_f80000gs/T/pip-req-build-wmba2pau/setup.py) egg_info for package from file:///Users/dima/sage/local/var/tmp/sage/build/mpmath-1.2.1/src\n[mpmath-1.2.1]     Created temporary directory: /private/var/folders/lh/tzyg2vbn4z99vg__rg2_t_f80000gs/T/pip-pip-egg-info-3tzuenlm\n[mpmath-1.2.1]     Running command python setup.py egg_info\n[mpmath-1.2.1]     WARNING: Retrying (Retry(total=4, connect=None, read=None, redirect=None, status=None)) after connection broken by 'ConnectTimeoutError(<pip._vendor.urllib3.connection.HTTPSConnection object at 0x10d35a910>, 'Connection to 192.0.2.0 timed out. (connect timeout=15)')': /simple/setuptools-scm/\n```",
    "created_at": "2021-06-22T16:49:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515570",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:17" align="right">comment:17</div>

I gather that `setuptools_scm` must really depend on `setuptools`, not just order-only.
Because if I rebuild `setuptools`, clean `mpmath` and try building `mpmath` again (without cleaning `setuptools_scm`), it gets stuck,
as follows:

```
[mpmath-1.2.1]     Running setup.py (path:/private/var/folders/lh/tzyg2vbn4z99vg__rg2_t_f80000gs/T/pip-req-build-wmba2pau/setup.py) egg_info for package from file:///Users/dima/sage/local/var/tmp/sage/build/mpmath-1.2.1/src
[mpmath-1.2.1]     Created temporary directory: /private/var/folders/lh/tzyg2vbn4z99vg__rg2_t_f80000gs/T/pip-pip-egg-info-3tzuenlm
[mpmath-1.2.1]     Running command python setup.py egg_info
[mpmath-1.2.1]     WARNING: Retrying (Retry(total=4, connect=None, read=None, redirect=None, status=None)) after connection broken by 'ConnectTimeoutError(<pip._vendor.urllib3.connection.HTTPSConnection object at 0x10d35a910>, 'Connection to 192.0.2.0 timed out. (connect timeout=15)')': /simple/setuptools-scm/
```



---

archive/issue_comments_515571.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nThat seems to be exacly the problem. Do you want to provide a branch?",
    "created_at": "2021-06-22T18:08:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515571",
    "user": "https://github.com/kliem"
}
```

<div id="comment:18" align="right">comment:18</div>

That seems to be exacly the problem. Do you want to provide a branch?



---

archive/issue_comments_515572.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@rocky](#comment:16):\n> Replying to [@mkoeppe](#comment:6):\n> > It would be helpful to use `make --debug=all` to see what's happening with the dependencies.\n\n> \n> In my biased opinion, if you feel the need to run `make --debug=all`, `remake -x` is better. \n\nThanks! I'll try it out next time I feel this need",
    "created_at": "2021-06-22T18:30:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515572",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@rocky](#comment:16):
> Replying to [@mkoeppe](#comment:6):
> > It would be helpful to use `make --debug=all` to see what's happening with the dependencies.

> 
> In my biased opinion, if you feel the need to run `make --debug=all`, `remake -x` is better. 

Thanks! I'll try it out next time I feel this need



---

archive/issue_comments_515573.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@dimpase](#comment:17):\n> I gather that `setuptools_scm` must really depend on `setuptools`, not just order-only.\n> Because if I rebuild `setuptools`, clean `mpmath` and try building `mpmath` again (without cleaning `setuptools_scm`), it gets stuck,\n> as follows:\n> \n> ```\n> [mpmath-1.2.1]     Running setup.py (path:/private/var/folders/lh/tzyg2vbn4z99vg__rg2_t_f80000gs/T/pip-req-build-wmba2pau/setup.py) egg_info for package from file:///Users/dima/sage/local/var/tmp/sage/build/mpmath-1.2.1/src\n> [mpmath-1.2.1]     Created temporary directory: /private/var/folders/lh/tzyg2vbn4z99vg__rg2_t_f80000gs/T/pip-pip-egg-info-3tzuenlm\n> [mpmath-1.2.1]     Running command python setup.py egg_info\n> [mpmath-1.2.1]     WARNING: Retrying (Retry(total=4, connect=None, read=None, redirect=None, status=None)) after connection broken by 'ConnectTimeoutError(<pip._vendor.urllib3.connection.HTTPSConnection object at 0x10d35a910>, 'Connection to 192.0.2.0 timed out. (connect timeout=15)')': /simple/setuptools-scm/\n> ```\n\nAfter rebuilding `setuptools`, is `setuptools_scm` still present or did it somehow get lost?",
    "created_at": "2021-06-22T18:34:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515573",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@dimpase](#comment:17):
> I gather that `setuptools_scm` must really depend on `setuptools`, not just order-only.
> Because if I rebuild `setuptools`, clean `mpmath` and try building `mpmath` again (without cleaning `setuptools_scm`), it gets stuck,
> as follows:
> 
> ```
> [mpmath-1.2.1]     Running setup.py (path:/private/var/folders/lh/tzyg2vbn4z99vg__rg2_t_f80000gs/T/pip-req-build-wmba2pau/setup.py) egg_info for package from file:///Users/dima/sage/local/var/tmp/sage/build/mpmath-1.2.1/src
> [mpmath-1.2.1]     Created temporary directory: /private/var/folders/lh/tzyg2vbn4z99vg__rg2_t_f80000gs/T/pip-pip-egg-info-3tzuenlm
> [mpmath-1.2.1]     Running command python setup.py egg_info
> [mpmath-1.2.1]     WARNING: Retrying (Retry(total=4, connect=None, read=None, redirect=None, status=None)) after connection broken by 'ConnectTimeoutError(<pip._vendor.urllib3.connection.HTTPSConnection object at 0x10d35a910>, 'Connection to 192.0.2.0 timed out. (connect timeout=15)')': /simple/setuptools-scm/
> ```

After rebuilding `setuptools`, is `setuptools_scm` still present or did it somehow get lost?



---

archive/issue_comments_515574.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\n\n```\nModuleNotFoundError: No module named 'setuptools_scm'\n```\nSo somehow got lost somehow.\n\nBut `sage --standard` claims it's installed somehow.",
    "created_at": "2021-06-22T18:36:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515574",
    "user": "https://github.com/kliem"
}
```

<div id="comment:21" align="right">comment:21</div>


```
ModuleNotFoundError: No module named 'setuptools_scm'
```
So somehow got lost somehow.

But `sage --standard` claims it's installed somehow.



---

archive/issue_comments_515575.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nIt's bad old code at the top of `build/pkgs/setuptools/spkg-install.in`",
    "created_at": "2021-06-22T18:37:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515575",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:22" align="right">comment:22</div>

It's bad old code at the top of `build/pkgs/setuptools/spkg-install.in`



---

archive/issue_comments_515576.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\n... which just nukes everything in site-packages that starts with \"setuptools\". Ouch.",
    "created_at": "2021-06-22T18:38:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515576",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:23" align="right">comment:23</div>

... which just nukes everything in site-packages that starts with "setuptools". Ouch.



---

archive/issue_comments_515577.json:
```json
{
    "body": "Branch: **[u/mkoeppe/dependency_of_mpmath_on_setuptools_scm_is_ineffective](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/dependency_of_mpmath_on_setuptools_scm_is_ineffective)**",
    "created_at": "2021-06-22T18:43:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515577",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/dependency_of_mpmath_on_setuptools_scm_is_ineffective](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/dependency_of_mpmath_on_setuptools_scm_is_ineffective)**



---

archive/issue_comments_515578.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nTry with this change please\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f307b11af55cd9ee7302d8983773a4d71703b6ff\"><code>f307b11</code></a></td><td><code>build/pkgs/setuptools/spkg-install.in: Do not nuke packages in site-packages before install</code></td></tr></table>\n",
    "created_at": "2021-06-22T18:44:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515578",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:25" align="right">comment:25</div>

Try with this change please

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f307b11af55cd9ee7302d8983773a4d71703b6ff"><code>f307b11</code></a></td><td><code>build/pkgs/setuptools/spkg-install.in: Do not nuke packages in site-packages before install</code></td></tr></table>




---

archive/issue_comments_515579.json:
```json
{
    "body": "Commit: **[`f307b11`](https://github.com/sagemath/sagetrac-mirror/commit/f307b11af55cd9ee7302d8983773a4d71703b6ff)**",
    "created_at": "2021-06-22T18:44:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515579",
    "user": "https://github.com/mkoeppe"
}
```

Commit: **[`f307b11`](https://github.com/sagemath/sagetrac-mirror/commit/f307b11af55cd9ee7302d8983773a4d71703b6ff)**



---

archive/issue_events_438537.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-22T18:44:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32031#event-438537"
}
```



---

archive/issue_comments_515580.json:
```json
{
    "body": "Author: **Matthias Koeppe**",
    "created_at": "2021-06-22T18:44:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515580",
    "user": "https://github.com/mkoeppe"
}
```

Author: **Matthias Koeppe**



---

archive/issue_comments_515581.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nOK, this works, thanks.",
    "created_at": "2021-06-22T19:02:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515581",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:26" align="right">comment:26</div>

OK, this works, thanks.



---

archive/issue_events_438538.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-06-22T19:02:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32031#event-438538"
}
```



---

archive/issue_events_438539.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-06-22T19:02:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32031#event-438539"
}
```



---

archive/issue_comments_515582.json:
```json
{
    "body": "Reviewer: **Dima Pasechnik**",
    "created_at": "2021-06-22T19:02:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515582",
    "user": "https://github.com/dimpase"
}
```

Reviewer: **Dima Pasechnik**



---

archive/issue_comments_515583.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nThanks!",
    "created_at": "2021-06-22T19:42:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515583",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:27" align="right">comment:27</div>

Thanks!



---

archive/issue_events_438540.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-22T20:19:08Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "title_is": "Stop setuptools install from nuking the setuptools_scm installation",
    "title_was": "Dependency of mpmath on setuptools_scm is ineffective",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32031#event-438540"
}
```



---

archive/issue_events_438541.json:
```json
{
    "actor": "https://github.com/strogdon",
    "created_at": "2021-06-22T20:32:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32031#event-438541"
}
```



---

archive/issue_events_438542.json:
```json
{
    "actor": "https://github.com/strogdon",
    "created_at": "2021-06-22T20:32:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32031#event-438542"
}
```



---

archive/issue_comments_515584.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nThis doesn't work here. After applying the patch and\n\n```\n./bootstrap\n./configure\nmake\n```\nSee attached mpmath and py logs.",
    "created_at": "2021-06-22T20:32:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515584",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:29" align="right">comment:29</div>

This doesn't work here. After applying the patch and

```
./bootstrap
./configure
make
```
See attached mpmath and py logs.



---

archive/issue_comments_515585.json:
```json
{
    "body": "Attachment: **[mpmath-1.2.1.log](https://github.com/sagemath/sage/files/ticket32031/mpmath-1.2.1.log)**\n\nAttachment: **[py-1.10.0.log](https://github.com/sagemath/sage/files/ticket32031/py-1.10.0.log)**",
    "created_at": "2021-06-22T20:33:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515585",
    "user": "https://github.com/strogdon"
}
```

Attachment: **[mpmath-1.2.1.log](https://github.com/sagemath/sage/files/ticket32031/mpmath-1.2.1.log)**

Attachment: **[py-1.10.0.log](https://github.com/sagemath/sage/files/ticket32031/py-1.10.0.log)**



---

archive/issue_events_438543.json:
```json
{
    "actor": "https://github.com/strogdon",
    "created_at": "2021-06-22T20:51:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32031#event-438543"
}
```



---

archive/issue_events_438544.json:
```json
{
    "actor": "https://github.com/strogdon",
    "created_at": "2021-06-22T20:51:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32031#event-438544"
}
```



---

archive/issue_comments_515586.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nOK, doing\n\n```\n./sage -f setuptools_scm\n```\nfixed things.",
    "created_at": "2021-06-22T20:51:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515586",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:30" align="right">comment:30</div>

OK, doing

```
./sage -f setuptools_scm
```
fixed things.



---

archive/issue_comments_515587.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/dependency_of_mpmath_on_setuptools_scm_is_ineffective](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/dependency_of_mpmath_on_setuptools_scm_is_ineffective)** to **[`f307b11`](https://github.com/sagemath/sagetrac-mirror/commit/f307b11af55cd9ee7302d8983773a4d71703b6ff)**",
    "created_at": "2021-06-29T17:39:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32031#issuecomment-515587",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/mkoeppe/dependency_of_mpmath_on_setuptools_scm_is_ineffective](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/dependency_of_mpmath_on_setuptools_scm_is_ineffective)** to **[`f307b11`](https://github.com/sagemath/sagetrac-mirror/commit/f307b11af55cd9ee7302d8983773a4d71703b6ff)**



---

archive/issue_events_438545.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-06-29T17:39:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32031#event-438545"
}
```



---

archive/issue_events_438546.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "70c0b075b8be7e6256a3c39df50d59040a5db82a",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-06-29T17:39:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/32031",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32031#event-438546"
}
```
