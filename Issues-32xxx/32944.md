# Issue 32944: pyzmq: Fix build error on cygwin

archive/issues_032707.json:
```json
{
    "body": "Follow up after #32828.\n\n```\nInstalling pyzmq-22.3.0\nProcessing /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/var/tmp/sage/build/pyzmq-22.3.0/src\n  Preparing metadata (pyproject.toml): started\n  Running command /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/bin/python3 /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /tmp/tmpltkh04hs\n  running dist_info\n  creating /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info\n  writing /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/PKG-INFO\n  writing dependency_links to /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/dependency_links.txt\n  writing requirements to /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/requires.txt\n  writing top-level names to /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/top_level.txt\n  writing manifest file '/tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/SOURCES.txt'\n  running configure\n  /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib/python3.8/site-packages/setuptools/_distutils/dist.py:275: UserWarning: Unknown distribution option: 'cffi_modules'\n    warnings.warn(msg)\n  {'libraries': ['zmq'], 'include_dirs': ['/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/include'], 'library_dirs': ['/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib'], 'runtime_library_dirs': ['/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib'], 'extra_link_args': []}\n  gcc -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -g -O2 -I/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/include -c build/temp.cygwin-3.3.2-x86_64-3.8/scratch/check_sys_un.c -o build/temp.cygwin-3.3.2-x86_64-3.8/scratch/check_sys_un.o\n  gcc build/temp.cygwin-3.3.2-x86_64-3.8/scratch/check_sys_un.o -L/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib -Wl,--enable-new-dtags,-R/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib -o build/temp.cygwin-3.3.2-x86_64-3.8/scratch/check_sys_un.exe\n  /usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: unrecognized option '--enable-new-dtags'\n  /usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: use the --help option for usage information\n  collect2: error: ld returned 1 exit status\n  Warning: No sys/un.h, IPC_PATH_MAX_LEN will be undefined: command '/usr/bin/gcc' failed with exit code 1\n  Configure: Autodetecting ZMQ settings...\n      Custom ZMQ dir:       /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36\n  ************************************************\n  gcc -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -g -O2 -I/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/include -Izmq/utils -c build/temp.cygwin-3.3.2-x86_64-3.8/scratch/vers.c -o build/temp.cygwin-3.3.2-x86_64-3.8/scratch/vers.o\n  gcc build/temp.cygwin-3.3.2-x86_64-3.8/scratch/vers.o -L/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib -Wl,--enable-new-dtags,-R/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib -lzmq -o build/temp.cygwin-3.3.2-x86_64-3.8/scratch/vers.exe\n  /usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: unrecognized option '--enable-new-dtags'\n  /usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: use the --help option for usage information\n  collect2: error: ld returned 1 exit status\n\n  error: command '/usr/bin/gcc' failed with exit code 1\n\n  Fatal: Falling back on bundled libzmq, but config has explicitly prohibited building the libzmq extension.\n  Preparing metadata (pyproject.toml): finished with status 'error'\nWARNING: Discarding file:///opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/var/tmp/sage/build/pyzmq-22.3.0/src. Command errored out with exit status 1: /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/bin/python3 /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /tmp/tmpltkh04hs Check the logs for full command output.\n```\n\nThis failure is from using `SETUPTOOLS_USE_DISTUTILS=local`, which bypasses the vendor patches to distutils in Cygwin's python3.\n\nIt is appearing now because #32828 tightened the `pyzmq` spkg-install script to no longer fall back to using its vendored copy of `zeromq`, which was hiding the problem.\n\nWe fix it on this ticket by restricting use of `SETUPTOOLS_USE_DISTUTILS=local` to the `homebrew` platform -- for which this setting was introduced in #31335.\n\n\nCC:  @dimpase @slel\n\nBranch/Commit: fbb8228e04a410aac7990db34e57fb29fa2103d0\n\nReviewer: Dima Pasechnik\n\nAuthor: Matthias Koeppe\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32944\n\n",
    "closed_at": "2021-12-12T15:09:27Z",
    "created_at": "2021-11-28T04:16:57Z",
    "labels": [
        "component: porting: cygwin",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "pyzmq: Fix build error on cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32944",
    "user": "https://github.com/mkoeppe"
}
```
Follow up after #32828.

```
Installing pyzmq-22.3.0
Processing /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/var/tmp/sage/build/pyzmq-22.3.0/src
  Preparing metadata (pyproject.toml): started
  Running command /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/bin/python3 /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /tmp/tmpltkh04hs
  running dist_info
  creating /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info
  writing /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/PKG-INFO
  writing dependency_links to /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/dependency_links.txt
  writing requirements to /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/requires.txt
  writing top-level names to /tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/top_level.txt
  writing manifest file '/tmp/pip-modern-metadata-v73c4p_y/pyzmq.egg-info/SOURCES.txt'
  running configure
  /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib/python3.8/site-packages/setuptools/_distutils/dist.py:275: UserWarning: Unknown distribution option: 'cffi_modules'
    warnings.warn(msg)
  {'libraries': ['zmq'], 'include_dirs': ['/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/include'], 'library_dirs': ['/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib'], 'runtime_library_dirs': ['/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib'], 'extra_link_args': []}
  gcc -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -g -O2 -I/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/include -c build/temp.cygwin-3.3.2-x86_64-3.8/scratch/check_sys_un.c -o build/temp.cygwin-3.3.2-x86_64-3.8/scratch/check_sys_un.o
  gcc build/temp.cygwin-3.3.2-x86_64-3.8/scratch/check_sys_un.o -L/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib -Wl,--enable-new-dtags,-R/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib -o build/temp.cygwin-3.3.2-x86_64-3.8/scratch/check_sys_un.exe
  /usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: unrecognized option '--enable-new-dtags'
  /usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: use the --help option for usage information
  collect2: error: ld returned 1 exit status
  Warning: No sys/un.h, IPC_PATH_MAX_LEN will be undefined: command '/usr/bin/gcc' failed with exit code 1
  Configure: Autodetecting ZMQ settings...
      Custom ZMQ dir:       /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36
  ************************************************
  gcc -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -ggdb -O2 -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -fstack-protector-strong --param=ssp-buffer-size=4 -DOPENSSL_NO_SSL3=1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/build=/usr/src/debug/python38-3.8.12-1 -fdebug-prefix-map=/pub/devel/python/python38/python38-3.8.12-1.x86_64/src/Python-3.8.12=/usr/src/debug/python38-3.8.12-1 -g -O2 -I/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/include -Izmq/utils -c build/temp.cygwin-3.3.2-x86_64-3.8/scratch/vers.c -o build/temp.cygwin-3.3.2-x86_64-3.8/scratch/vers.o
  gcc build/temp.cygwin-3.3.2-x86_64-3.8/scratch/vers.o -L/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib -Wl,--enable-new-dtags,-R/opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib -lzmq -o build/temp.cygwin-3.3.2-x86_64-3.8/scratch/vers.exe
  /usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: unrecognized option '--enable-new-dtags'
  /usr/lib/gcc/x86_64-pc-cygwin/11/../../../../x86_64-pc-cygwin/bin/ld: use the --help option for usage information
  collect2: error: ld returned 1 exit status

  error: command '/usr/bin/gcc' failed with exit code 1

  Fatal: Falling back on bundled libzmq, but config has explicitly prohibited building the libzmq extension.
  Preparing metadata (pyproject.toml): finished with status 'error'
WARNING: Discarding file:///opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/var/tmp/sage/build/pyzmq-22.3.0/src. Command errored out with exit status 1: /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/bin/python3 /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /tmp/tmpltkh04hs Check the logs for full command output.
```

This failure is from using `SETUPTOOLS_USE_DISTUTILS=local`, which bypasses the vendor patches to distutils in Cygwin's python3.

It is appearing now because #32828 tightened the `pyzmq` spkg-install script to no longer fall back to using its vendored copy of `zeromq`, which was hiding the problem.

We fix it on this ticket by restricting use of `SETUPTOOLS_USE_DISTUTILS=local` to the `homebrew` platform -- for which this setting was introduced in #31335.


CC:  @dimpase @slel

Branch/Commit: fbb8228e04a410aac7990db34e57fb29fa2103d0

Reviewer: Dima Pasechnik

Author: Matthias Koeppe

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/32944





---

archive/issue_comments_656933.json:
```json
{
    "body": "<a id='comment:1'></a>\nLooks like this is more fallout from using `SETUPTOOLS_USE_DISTUTILS=local`, see https://github.com/pypa/distutils/pull/60#issuecomment-980846735",
    "created_at": "2021-11-28T06:23:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32944#issuecomment-656933",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>
Looks like this is more fallout from using `SETUPTOOLS_USE_DISTUTILS=local`, see https://github.com/pypa/distutils/pull/60#issuecomment-980846735



---

archive/issue_comments_656934.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-11-28T06:24:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32944#issuecomment-656934",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_656935.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/pyzmq__fix_build_error_on_cygwin\"",
    "created_at": "2021-11-28T07:06:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32944#issuecomment-656935",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/pyzmq__fix_build_error_on_cygwin"



---

archive/issue_comments_656936.json:
```json
{
    "body": "Changing reviewer from \"\" to \"https://github.com/mkoeppe/sage/actions/runs/1512139060\"",
    "created_at": "2021-11-28T07:13:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32944#issuecomment-656936",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "https://github.com/mkoeppe/sage/actions/runs/1512139060"



---

archive/issue_comments_656937.json:
```json
{
    "body": "Changing commit from \"\" to \"fbb8228e04a410aac7990db34e57fb29fa2103d0\"",
    "created_at": "2021-11-28T07:13:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32944#issuecomment-656937",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "" to "fbb8228e04a410aac7990db34e57fb29fa2103d0"



---

archive/issue_comments_656938.json:
```json
{
    "body": "<a id='comment:5'></a>\nLast 10 new commits:\n|                                                                                                                                          |                                                                              |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------|\n|[89e1dea](https://git.sagemath.org/sage.git/commit?id=89e1dea356a04ee0f68def9823f9bee117a09057)|`build/pkgs/setuptools: Instead of bumping the patch level, upgrade to 58.5.3`|\n|[129d0fb](https://git.sagemath.org/sage.git/commit?id=129d0fbd15736ebf8d547620f4a27e93ca431eb7)|`build/pkgs/pyzmq/spkg-install.in: Fix up`|\n|[2240cc1](https://git.sagemath.org/sage.git/commit?id=2240cc157d1b17a087d42ea9010a920a80288de2)|`build/pkgs/pyzmq: Update to 22.3.0`|\n|[fc11612](https://git.sagemath.org/sage.git/commit?id=fc116124dfa4790bdd829f2b8518cf076adb4e49)|`build/pkgs/zeromq: Update to 4.3.4, add upstream_url`|\n|[a8fe9da](https://git.sagemath.org/sage.git/commit?id=a8fe9da95f28efc4b3bf975a997ce6da05c928bf)|`build/pkgs/zeromq/patches/getrandom.patch: Remove`|\n|[078e37b](https://git.sagemath.org/sage.git/commit?id=078e37bbcc8825841a80c9118a1d0598c01d78c8)|`build/pkgs/setuptools: Update to 59.1.0, remove patch`|\n|[ee4f6b4](https://git.sagemath.org/sage.git/commit?id=ee4f6b4a5af0122465882f5f42b5b561852756e2)|`Merge tag '9.5.beta7' into t/32828/pyzmq__build_errors`|\n|[b430bcf](https://git.sagemath.org/sage.git/commit?id=b430bcf4c46c4822a0b248db307565dd2c814119)|`build/pkgs/setuptools: Update to 59.2.0`|\n|[090295b](https://git.sagemath.org/sage.git/commit?id=090295bf53333151b9b93711b9932ed7acbf786e)|`Merge #32828`|\n|[fbb8228](https://git.sagemath.org/sage.git/commit?id=fbb8228e04a410aac7990db34e57fb29fa2103d0)|`build/bin/sage-build-env: Do not use SETUPTOOLS_USE_DISTUTILS=local on platforms other than homebrew`|",
    "created_at": "2021-11-28T07:13:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32944#issuecomment-656938",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>
Last 10 new commits:
|                                                                                                                                          |                                                                              |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------|
|[89e1dea](https://git.sagemath.org/sage.git/commit?id=89e1dea356a04ee0f68def9823f9bee117a09057)|`build/pkgs/setuptools: Instead of bumping the patch level, upgrade to 58.5.3`|
|[129d0fb](https://git.sagemath.org/sage.git/commit?id=129d0fbd15736ebf8d547620f4a27e93ca431eb7)|`build/pkgs/pyzmq/spkg-install.in: Fix up`|
|[2240cc1](https://git.sagemath.org/sage.git/commit?id=2240cc157d1b17a087d42ea9010a920a80288de2)|`build/pkgs/pyzmq: Update to 22.3.0`|
|[fc11612](https://git.sagemath.org/sage.git/commit?id=fc116124dfa4790bdd829f2b8518cf076adb4e49)|`build/pkgs/zeromq: Update to 4.3.4, add upstream_url`|
|[a8fe9da](https://git.sagemath.org/sage.git/commit?id=a8fe9da95f28efc4b3bf975a997ce6da05c928bf)|`build/pkgs/zeromq/patches/getrandom.patch: Remove`|
|[078e37b](https://git.sagemath.org/sage.git/commit?id=078e37bbcc8825841a80c9118a1d0598c01d78c8)|`build/pkgs/setuptools: Update to 59.1.0, remove patch`|
|[ee4f6b4](https://git.sagemath.org/sage.git/commit?id=ee4f6b4a5af0122465882f5f42b5b561852756e2)|`Merge tag '9.5.beta7' into t/32828/pyzmq__build_errors`|
|[b430bcf](https://git.sagemath.org/sage.git/commit?id=b430bcf4c46c4822a0b248db307565dd2c814119)|`build/pkgs/setuptools: Update to 59.2.0`|
|[090295b](https://git.sagemath.org/sage.git/commit?id=090295bf53333151b9b93711b9932ed7acbf786e)|`Merge #32828`|
|[fbb8228](https://git.sagemath.org/sage.git/commit?id=fbb8228e04a410aac7990db34e57fb29fa2103d0)|`build/bin/sage-build-env: Do not use SETUPTOOLS_USE_DISTUTILS=local on platforms other than homebrew`|



---

archive/issue_comments_656939.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -38,3 +38,9 @@\n WARNING: Discarding file:///opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/var/tmp/sage/build/pyzmq-22.3.0/src. Command errored out with exit status 1: /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/bin/python3 /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /tmp/tmpltkh04hs Check the logs for full command output.\n ```\n \n+This failure is from using `SETUPTOOLS_USE_DISTUTILS=local`, which bypasses the vendor patches to distutils in Cygwin's python3.\n+\n+It is appearing now because #32828 tightened the `pyzmq` spkg-install script to no longer fall back to using its vendored copy of `zeromq`, which was hiding the problem.\n+\n+We fix it on this ticket by restricting use of `SETUPTOOLS_USE_DISTUTILS=local` to the `homebrew` platform -- for which this setting was introduced in #31335.\n+\n``````\n",
    "created_at": "2021-11-28T20:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32944#issuecomment-656939",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -38,3 +38,9 @@
 WARNING: Discarding file:///opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/var/tmp/sage/build/pyzmq-22.3.0/src. Command errored out with exit status 1: /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/bin/python3 /opt/sage-cd2efe781b1af81b2b3b1ebe7b4cced0d9243f36/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /tmp/tmpltkh04hs Check the logs for full command output.
 ```
 
+This failure is from using `SETUPTOOLS_USE_DISTUTILS=local`, which bypasses the vendor patches to distutils in Cygwin's python3.
+
+It is appearing now because #32828 tightened the `pyzmq` spkg-install script to no longer fall back to using its vendored copy of `zeromq`, which was hiding the problem.
+
+We fix it on this ticket by restricting use of `SETUPTOOLS_USE_DISTUTILS=local` to the `homebrew` platform -- for which this setting was introduced in #31335.
+
``````




---

archive/issue_comments_656940.json:
```json
{
    "body": "Changing reviewer from \"https://github.com/mkoeppe/sage/actions/runs/1512139060\" to \"https://github.com/mkoeppe/sage/actions/runs/1512139060, https://github.com/mkoeppe/sage/runs/4344360215\"",
    "created_at": "2021-11-28T20:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32944#issuecomment-656940",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "https://github.com/mkoeppe/sage/actions/runs/1512139060" to "https://github.com/mkoeppe/sage/actions/runs/1512139060, https://github.com/mkoeppe/sage/runs/4344360215"



---

archive/issue_comments_656941.json:
```json
{
    "body": "<a id='comment:6'></a>\nWith this ticket, \nhttps://github.com/mkoeppe/sage/actions/runs/1512139060 shows in `cygwin-stage-ii-d`:\n\n```\n[pyzmq-22.3.0] installing. Log file: /cygdrive/d/a/sage/sage/logs/pkgs/pyzmq-22.3.0.log\n  [pyzmq-22.3.0] successfully installed.\n```\n(the build stage fails later because of the unrelated issue #32945).",
    "created_at": "2021-11-28T20:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32944#issuecomment-656941",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>
With this ticket, 
https://github.com/mkoeppe/sage/actions/runs/1512139060 shows in `cygwin-stage-ii-d`:

```
[pyzmq-22.3.0] installing. Log file: /cygdrive/d/a/sage/sage/logs/pkgs/pyzmq-22.3.0.log
  [pyzmq-22.3.0] successfully installed.
```
(the build stage fails later because of the unrelated issue #32945).



---

archive/issue_comments_656942.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-11-28T20:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32944#issuecomment-656942",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_656943.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2021-11-28T20:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32944#issuecomment-656943",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_comments_656944.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2021-11-28T20:26:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32944#issuecomment-656944",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_656945.json:
```json
{
    "body": "<a id='comment:8'></a>\nAnyone willing to give this a positive review based on the GH Actions run?",
    "created_at": "2021-12-01T20:03:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32944#issuecomment-656945",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>
Anyone willing to give this a positive review based on the GH Actions run?



---

archive/issue_comments_656946.json:
```json
{
    "body": "<a id='comment:9'></a>\nlgtm",
    "created_at": "2021-12-01T21:05:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32944#issuecomment-656946",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>
lgtm



---

archive/issue_comments_656947.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-01T21:05:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32944#issuecomment-656947",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_656948.json:
```json
{
    "body": "Changing reviewer from \"https://github.com/mkoeppe/sage/actions/runs/1512139060, https://github.com/mkoeppe/sage/runs/4344360215\" to \"Dima Pasechnik\"",
    "created_at": "2021-12-01T21:05:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32944#issuecomment-656948",
    "user": "https://github.com/dimpase"
}
```

Changing reviewer from "https://github.com/mkoeppe/sage/actions/runs/1512139060, https://github.com/mkoeppe/sage/runs/4344360215" to "Dima Pasechnik"



---

archive/issue_comments_656949.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-12-12T15:09:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32944#issuecomment-656949",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_087058.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-12-12T15:09:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32944",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32944#event-87058"
}
```



---

archive/issue_comments_656950.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/pyzmq__fix_build_error_on_cygwin\" to \"fbb8228e04a410aac7990db34e57fb29fa2103d0\"",
    "created_at": "2021-12-12T15:09:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32944",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32944#issuecomment-656950",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mkoeppe/pyzmq__fix_build_error_on_cygwin" to "fbb8228e04a410aac7990db34e57fb29fa2103d0"
