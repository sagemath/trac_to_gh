# Issue 32953: Sphere: improve handling of default charts

archive/issues_032716.json:
```json
{
    "body": "If one uses the method `stereographic_coordinates` to initialize steographic coordinates (instead of as via the constructor argument), then there are some inconsistencies.\n\nFor example, \n\n```\nsage: M = manifolds.Sphere(2)\nsage: XN = M.stereographic_coordinates(pole='north')\nsage: g = M.metric()\nsage: U = XN.domain(); U\nOpen subset S^2-{NP} of the 2-sphere S^2 of radius 1 smoothly embedded in the \n Euclidean space E^3\nsage: g.restrict(U).display()\ng = (cos(theta)^2 - 2*cos(theta) + 1) dy1\u2297dy1\n  + (cos(theta)^2 - 2*cos(theta) + 1) dy2\u2297dy2\n```\nOne would certainly expect the components of g to be expressed in terms of (y1,y2), i.e. the chart XN, which is the only chart that covers entirely U = S^2-{NP}. \n\nCC:  @tscrim @nthiery @mjungmath @egourgoulhon\n\nKeywords: sphere\n\nBranch/Commit: 20b9cb0cf890c1a717605b9e043ba398203a05e0\n\nReviewer: Travis Scrimshaw\n\nAuthor: Eric Gourgoulhon\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32953\n\n",
    "closed_at": "2022-02-27T22:00:34Z",
    "created_at": "2021-12-01T16:30:36Z",
    "labels": [
        "component: manifolds",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Sphere: improve handling of default charts",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32953",
    "user": "https://github.com/tobiasdiez"
}
```
If one uses the method `stereographic_coordinates` to initialize steographic coordinates (instead of as via the constructor argument), then there are some inconsistencies.

For example, 

```
sage: M = manifolds.Sphere(2)
sage: XN = M.stereographic_coordinates(pole='north')
sage: g = M.metric()
sage: U = XN.domain(); U
Open subset S^2-{NP} of the 2-sphere S^2 of radius 1 smoothly embedded in the 
 Euclidean space E^3
sage: g.restrict(U).display()
g = (cos(theta)^2 - 2*cos(theta) + 1) dy1⊗dy1
  + (cos(theta)^2 - 2*cos(theta) + 1) dy2⊗dy2
```
One would certainly expect the components of g to be expressed in terms of (y1,y2), i.e. the chart XN, which is the only chart that covers entirely U = S^2-{NP}. 

CC:  @tscrim @nthiery @mjungmath @egourgoulhon

Keywords: sphere

Branch/Commit: 20b9cb0cf890c1a717605b9e043ba398203a05e0

Reviewer: Travis Scrimshaw

Author: Eric Gourgoulhon

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/32953





---

archive/issue_comments_466081.json:
```json
{
    "body": "Replying to [ticket:32953 gh-tobiasdiez]:\n> As one can see, the volume form has components with respect to a coordinate frame on S2-{SP} but with respect to a vector frame on S2-{NP}.\n\n\nThis is because the volume form is defined with respect to the orientation provided by the frame of stereographic coordinates on  S2-{SP}. The frame of stereographic coordinates on S2-{NP} having the opposite orientation, a vector frame `(f1, f2)` is introduced there to keep the orientation. As you can read on line 954 of `src/sage/manifolds/differentiable/examples/sphere.py`, the relation to the coordinate frame is very simple: `f1 = -d/dy1`, `f2 = d/dy2`. \nSee also the comment on the orientation in the [reference manual for Sphere](https://doc.sagemath.org/html/en/reference/manifolds/sage/manifolds/differentiable/examples/sphere.html).\n\nA side remark:\n\n```\nfrom sage.manifolds.differentiable.examples.sphere import Sphere\nM = Sphere(2)\n```\ncan be shorten to \n\n```\nM = manifolds.Sphere(2)\n```\n`manifolds` providing a direct access to the manifold catalog. \n\nNote that the class `Sphere` is not extensively tested and might have some bugs.",
    "created_at": "2021-12-01T18:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466081",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [ticket:32953 gh-tobiasdiez]:
> As one can see, the volume form has components with respect to a coordinate frame on S2-{SP} but with respect to a vector frame on S2-{NP}.


This is because the volume form is defined with respect to the orientation provided by the frame of stereographic coordinates on  S2-{SP}. The frame of stereographic coordinates on S2-{NP} having the opposite orientation, a vector frame `(f1, f2)` is introduced there to keep the orientation. As you can read on line 954 of `src/sage/manifolds/differentiable/examples/sphere.py`, the relation to the coordinate frame is very simple: `f1 = -d/dy1`, `f2 = d/dy2`. 
See also the comment on the orientation in the [reference manual for Sphere](https://doc.sagemath.org/html/en/reference/manifolds/sage/manifolds/differentiable/examples/sphere.html).

A side remark:

```
from sage.manifolds.differentiable.examples.sphere import Sphere
M = Sphere(2)
```
can be shorten to 

```
M = manifolds.Sphere(2)
```
`manifolds` providing a direct access to the manifold catalog. 

Note that the class `Sphere` is not extensively tested and might have some bugs.



---

archive/issue_comments_466082.json:
```json
{
    "body": "<a id='comment:2'></a>Replying to [comment:1 egourgoulhon]:\n> Note that the class `Sphere` is not extensively tested and might have some bugs. \n\nAn example of bug is\n\n```\nsage: M = manifolds.Sphere(2)\nsage: XN = M.stereographic_coordinates(pole='north')\nsage: g = M.metric()\nsage: U = XN.domain(); U\nOpen subset S^2-{NP} of the 2-sphere S^2 of radius 1 smoothly embedded in the \n Euclidean space E^3\nsage: g.restrict(U).display()\ng = (cos(theta)^2 - 2*cos(theta) + 1) dy1\u2297dy1\n  + (cos(theta)^2 - 2*cos(theta) + 1) dy2\u2297dy2\n```\nOne would certainly expect the components of `g` to be expressed in terms of `(y1,y2)`, i.e. the chart `XN`, which is the only chart that covers entirely `U` = `S^2-{NP}`.",
    "created_at": "2021-12-01T18:22:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466082",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:2'></a>Replying to [comment:1 egourgoulhon]:
> Note that the class `Sphere` is not extensively tested and might have some bugs. 

An example of bug is

```
sage: M = manifolds.Sphere(2)
sage: XN = M.stereographic_coordinates(pole='north')
sage: g = M.metric()
sage: U = XN.domain(); U
Open subset S^2-{NP} of the 2-sphere S^2 of radius 1 smoothly embedded in the 
 Euclidean space E^3
sage: g.restrict(U).display()
g = (cos(theta)^2 - 2*cos(theta) + 1) dy1⊗dy1
  + (cos(theta)^2 - 2*cos(theta) + 1) dy2⊗dy2
```
One would certainly expect the components of `g` to be expressed in terms of `(y1,y2)`, i.e. the chart `XN`, which is the only chart that covers entirely `U` = `S^2-{NP}`.



---

archive/issue_comments_466083.json:
```json
{
    "body": "<a id='comment:3'></a>Thanks for having a look at this.\n\nSo the vector frame `f` is only needed to specify the orienation? I guess then its easy to also calculate the components of the volumen form in the coordinate frame, since it's only a overall factor of minus 1.\n\nI had a look at the implementation and would propose to circumvent this problem completely by slightly generalizing the way an orientation is represented in sage.\nCurrently, it is as a list of frames for which the chart transitions are orientation-preserving.\nMore generally one can assign to each chart (or frame) a sign, where two such signs have to be equal if the chart transition is orientation-preserving and otherwise they have to differ (thatt is, a 0-cochain trivializating the Z_2-valued orientation 1-cocycle).\nUsing this extension, one could simply say that the chart on SP-NP gets a minus sign instead of needing to introduce a new frame.\n\nWhat do you think?",
    "created_at": "2021-12-02T12:26:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466083",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:3'></a>Thanks for having a look at this.

So the vector frame `f` is only needed to specify the orienation? I guess then its easy to also calculate the components of the volumen form in the coordinate frame, since it's only a overall factor of minus 1.

I had a look at the implementation and would propose to circumvent this problem completely by slightly generalizing the way an orientation is represented in sage.
Currently, it is as a list of frames for which the chart transitions are orientation-preserving.
More generally one can assign to each chart (or frame) a sign, where two such signs have to be equal if the chart transition is orientation-preserving and otherwise they have to differ (thatt is, a 0-cochain trivializating the Z_2-valued orientation 1-cocycle).
Using this extension, one could simply say that the chart on SP-NP gets a minus sign instead of needing to introduce a new frame.

What do you think?



---

archive/issue_comments_466084.json:
```json
{
    "body": "<a id='comment:4'></a>In general, this is a good idea. Then the question is, how do we assign these values when we introduce new charts? Currently, this is not necessary because we have reference frames/charts in the aforementioned list. Instead of giving every frame/chart a sign, I'd suggest to keep such a list of references but assign to each frame/chart only in that list a sign as you propose. (Is this user-friendly?)\n\nI presume, however, a much better way would incorporate Chech cohomology, which goes in the direction of what you suggested in terms of cohomology. As soon as we have implemented Chech cohomology, the notion of \"orientation\" can easily be generalized. I think this is the proper way of doing it.",
    "created_at": "2021-12-02T13:48:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466084",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:4'></a>In general, this is a good idea. Then the question is, how do we assign these values when we introduce new charts? Currently, this is not necessary because we have reference frames/charts in the aforementioned list. Instead of giving every frame/chart a sign, I'd suggest to keep such a list of references but assign to each frame/chart only in that list a sign as you propose. (Is this user-friendly?)

I presume, however, a much better way would incorporate Chech cohomology, which goes in the direction of what you suggested in terms of cohomology. As soon as we have implemented Chech cohomology, the notion of "orientation" can easily be generalized. I think this is the proper way of doing it.



---

archive/issue_comments_466085.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:3 gh-tobiasdiez]:\n> So the vector frame `f` is only needed to specify the orienation? I guess then its easy to also calculate the components of the volumen form in the coordinate frame, since it's only a overall factor of minus 1.\n\n\nIndeed, and Sage will do it automatically if required, because it knows all the automorphisms connecting the various frames. In particular, it knows the automorphism linking `f` to the coordinate frame on `S^2-{NP}`. \n> \n> I had a look at the implementation and would propose to circumvent this problem completely by slightly generalizing the way an orientation is represented in sage.\n\n\nI am not sure to understand what your problem is. At the initialization of the volume form, only the minimal amount of information is stored in the attribute `_components`. The user shall not access this private attribute directly, but should instead ask for components via the method `comp()` or `display()`. The required components are then automatically computed if they need to be and cached in `_components`. For instance:\n\n```\nsage: M = manifolds.Sphere(2, coordinates='stereographic')\nsage: eps = M.metric().volume_form()\nsage: for restr in eps._restrictions.values():\n....:     print(restr)\n....:     for comp in restr._components:\n....:         print(comp)\n....:\n2-form eps_g on the Open subset S^2-{SP} of the 2-sphere S^2 of radius 1 smoothly embedded in the Euclidean space E^3\nCoordinate frame (S^2-{SP}, (\u2202/\u2202yp1,\u2202/\u2202yp2))\n2-form eps_g on the Open subset S^2-{NP} of the 2-sphere S^2 of radius 1 smoothly embedded in the Euclidean space E^3\nVector frame (S^2-{NP}, (f_1,f_2))\n```\nAs you noticed, `eps` is initialized only w.r.t. `f` on `S^2-{NP}`. But you can access to the components in the coordinate frame by `comp()`:\n\n```\nsage: Nf = M.stereographic_coordinates().frame(); Nf\nCoordinate frame (S^2-{NP}, (\u2202/\u2202y1,\u2202/\u2202y2))\nsage: eps.comp(Nf)\nFully antisymmetric 2-indices components w.r.t. Coordinate frame (S^2-{NP}, (\u2202/\u2202y1,\u2202/\u2202y2))\n```\nNote that the attribute `_components` has been updated:\n\n```\nsage: for restr in eps._restrictions.values():\n....:     print(restr)\n....:     for comp in restr._components:\n....:         print(comp)\n....:         \n2-form eps_g on the Open subset S^2-{SP} of the 2-sphere S^2 of radius 1 smoothly embedded in the Euclidean space E^3\nCoordinate frame (S^2-{SP}, (\u2202/\u2202yp1,\u2202/\u2202yp2))\n2-form eps_g on the Open subset S^2-{NP} of the 2-sphere S^2 of radius 1 smoothly embedded in the Euclidean space E^3\nVector frame (S^2-{NP}, (f_1,f_2))\nCoordinate frame (S^2-{NP}, (\u2202/\u2202y1,\u2202/\u2202y2))\n```\nInvoking `display()` instead of `comp()` would have produced the same result:\n\n```\nsage: eps.display(Nf)\neps_g = -4/(y1^4 + y2^4 + 2*(y1^2 + 1)*y2^2 + 2*y1^2 + 1) dy1\u2227dy2\n```",
    "created_at": "2021-12-02T13:58:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466085",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:5'></a>Replying to [comment:3 gh-tobiasdiez]:
> So the vector frame `f` is only needed to specify the orienation? I guess then its easy to also calculate the components of the volumen form in the coordinate frame, since it's only a overall factor of minus 1.


Indeed, and Sage will do it automatically if required, because it knows all the automorphisms connecting the various frames. In particular, it knows the automorphism linking `f` to the coordinate frame on `S^2-{NP}`. 
> 
> I had a look at the implementation and would propose to circumvent this problem completely by slightly generalizing the way an orientation is represented in sage.


I am not sure to understand what your problem is. At the initialization of the volume form, only the minimal amount of information is stored in the attribute `_components`. The user shall not access this private attribute directly, but should instead ask for components via the method `comp()` or `display()`. The required components are then automatically computed if they need to be and cached in `_components`. For instance:

```
sage: M = manifolds.Sphere(2, coordinates='stereographic')
sage: eps = M.metric().volume_form()
sage: for restr in eps._restrictions.values():
....:     print(restr)
....:     for comp in restr._components:
....:         print(comp)
....:
2-form eps_g on the Open subset S^2-{SP} of the 2-sphere S^2 of radius 1 smoothly embedded in the Euclidean space E^3
Coordinate frame (S^2-{SP}, (∂/∂yp1,∂/∂yp2))
2-form eps_g on the Open subset S^2-{NP} of the 2-sphere S^2 of radius 1 smoothly embedded in the Euclidean space E^3
Vector frame (S^2-{NP}, (f_1,f_2))
```
As you noticed, `eps` is initialized only w.r.t. `f` on `S^2-{NP}`. But you can access to the components in the coordinate frame by `comp()`:

```
sage: Nf = M.stereographic_coordinates().frame(); Nf
Coordinate frame (S^2-{NP}, (∂/∂y1,∂/∂y2))
sage: eps.comp(Nf)
Fully antisymmetric 2-indices components w.r.t. Coordinate frame (S^2-{NP}, (∂/∂y1,∂/∂y2))
```
Note that the attribute `_components` has been updated:

```
sage: for restr in eps._restrictions.values():
....:     print(restr)
....:     for comp in restr._components:
....:         print(comp)
....:         
2-form eps_g on the Open subset S^2-{SP} of the 2-sphere S^2 of radius 1 smoothly embedded in the Euclidean space E^3
Coordinate frame (S^2-{SP}, (∂/∂yp1,∂/∂yp2))
2-form eps_g on the Open subset S^2-{NP} of the 2-sphere S^2 of radius 1 smoothly embedded in the Euclidean space E^3
Vector frame (S^2-{NP}, (f_1,f_2))
Coordinate frame (S^2-{NP}, (∂/∂y1,∂/∂y2))
```
Invoking `display()` instead of `comp()` would have produced the same result:

```
sage: eps.display(Nf)
eps_g = -4/(y1^4 + y2^4 + 2*(y1^2 + 1)*y2^2 + 2*y1^2 + 1) dy1∧dy2
```



---

archive/issue_comments_466086.json:
```json
{
    "body": "<a id='comment:6'></a>I agree with Eric, there is no major problem here. Though I also agree with Tobias in the sense that introducing a dummy frame in order to get the orientation is not \"nice\" either.",
    "created_at": "2021-12-02T14:19:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466086",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:6'></a>I agree with Eric, there is no major problem here. Though I also agree with Tobias in the sense that introducing a dummy frame in order to get the orientation is not "nice" either.



---

archive/issue_comments_466087.json:
```json
{
    "body": "<a id='comment:7'></a>My (originial) problem was that the following code\n\n```\nimport sage.all\nfrom sage.manifolds.differentiable.examples.sphere import Sphere\nfrom sage.symbolic.function_factory import function\n\nM = Sphere(2)\nstereoN = M.stereographic_coordinates(pole='north')\nstereoS = M.stereographic_coordinates(pole='south')\n\nprint(\"Metric\")\nfor restr in M.metric()._restrictions.values():\n    print(restr)\n    for comp in restr._components:\n        print(comp)\n\nprint(\"Volume form\")\nfor restr in M.metric().volume_form()._restrictions.values():\n    print(restr)\n    for comp in restr._components:\n        print(comp)\n\nchart_functions = {chart: function('H')(*chart[:]) for chart in M.atlas()}\nH = M.scalar_field(chart_functions, name='H')\nprint(H.display())\nX = M.metric().inverse().contract(H.differential())\nprint(X.display())\n\nprint(\"X\")\nfor restr in X._restrictions.values():\n    print(restr)\n    for comp in restr._components:\n        print(comp)\n\nM.metric().volume_form().contract(X)\n```\nfails with the error \"ValueError: no common chart for the multiplication\" (in the last line). I thought that this might be a result of the difference in vector vs coordinate frame.\nBut I guess based on your comments, the issue is more that `FreeModuleTensor#contract` is directly using `_components` instead of trying to compute the components in the other frame using `comp`, right?\n\n\nI've opened #32974 for the idea to improve the orientation of manifolds (using a general framework).",
    "created_at": "2021-12-04T17:13:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466087",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:7'></a>My (originial) problem was that the following code

```
import sage.all
from sage.manifolds.differentiable.examples.sphere import Sphere
from sage.symbolic.function_factory import function

M = Sphere(2)
stereoN = M.stereographic_coordinates(pole='north')
stereoS = M.stereographic_coordinates(pole='south')

print("Metric")
for restr in M.metric()._restrictions.values():
    print(restr)
    for comp in restr._components:
        print(comp)

print("Volume form")
for restr in M.metric().volume_form()._restrictions.values():
    print(restr)
    for comp in restr._components:
        print(comp)

chart_functions = {chart: function('H')(*chart[:]) for chart in M.atlas()}
H = M.scalar_field(chart_functions, name='H')
print(H.display())
X = M.metric().inverse().contract(H.differential())
print(X.display())

print("X")
for restr in X._restrictions.values():
    print(restr)
    for comp in restr._components:
        print(comp)

M.metric().volume_form().contract(X)
```
fails with the error "ValueError: no common chart for the multiplication" (in the last line). I thought that this might be a result of the difference in vector vs coordinate frame.
But I guess based on your comments, the issue is more that `FreeModuleTensor#contract` is directly using `_components` instead of trying to compute the components in the other frame using `comp`, right?


I've opened #32974 for the idea to improve the orientation of manifolds (using a general framework).



---

archive/issue_comments_466088.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 gh-tobiasdiez]:\n> \n> \n> My (originial) problem was that the following code\n> ...\n> fails with the error \"ValueError: no common chart for the multiplication\" (in the last line). I thought that this might be a result of the difference in vector vs coordinate frame.\n> But I guess based on your comments, the issue is more that `FreeModuleTensor#contract` is directly using `_components` instead of trying to compute the components in the other frame using `comp`, right?\n\n\nNo, `FreeModuleTensor.contract` is doing things correctly by invoking \n\n```\nbasis = self.common_basis(other)\n```\n(cf. line 2826 of `src/sage/tensor/modules/free_module_tensor.py`), which computes the components in a common frame by calling `comp` if necessary.\nThe issue you are facing is rather due to some flaw in the current implementation of `Sphere`, as already mentioned in comment:2. To circumvent it, you should use \n\n```\nM = manifolds.Sphere(2, coordinates='stereographic')\n```\nif you plan to work with stereographic coordinates. Then `M.metric().volume_form().contract(X)` returns no error.",
    "created_at": "2021-12-06T10:41:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466088",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:8'></a>Replying to [comment:7 gh-tobiasdiez]:
> 
> 
> My (originial) problem was that the following code
> ...
> fails with the error "ValueError: no common chart for the multiplication" (in the last line). I thought that this might be a result of the difference in vector vs coordinate frame.
> But I guess based on your comments, the issue is more that `FreeModuleTensor#contract` is directly using `_components` instead of trying to compute the components in the other frame using `comp`, right?


No, `FreeModuleTensor.contract` is doing things correctly by invoking 

```
basis = self.common_basis(other)
```
(cf. line 2826 of `src/sage/tensor/modules/free_module_tensor.py`), which computes the components in a common frame by calling `comp` if necessary.
The issue you are facing is rather due to some flaw in the current implementation of `Sphere`, as already mentioned in comment:2. To circumvent it, you should use 

```
M = manifolds.Sphere(2, coordinates='stereographic')
```
if you plan to work with stereographic coordinates. Then `M.metric().volume_form().contract(X)` returns no error.



---

archive/issue_comments_466089.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:7 gh-tobiasdiez]:\n> \n> \n> My (originial) problem was that the following code\n> \n> ```\n> ...\n> chart_functions = {chart: function('H')(*chart[:]) for chart in M.atlas()}\n> H = M.scalar_field(chart_functions, name='H')\n> ```\n\nThis declaration of the scalar field `H` is not mathematically correct: it enforces the same coordinate expression `H(x,y)` for all the coordinates `(x,y)` in the manifold's atlas, which cannot be, except for a constant scalar field. Furthermore, it introduces a confusion between `function('H')` and the scalar field `H`. For the sake of clarity, different symbols shall be used. Keep in mind that `function('H')` injects `H` in the global namespace. By running subsequently `H = M.scalar_field(...)`, you overwrite the Python name `H`. This can be unfortunate when you want to further manipulate `function('H')`, like in `substitute_function` for instance.",
    "created_at": "2021-12-06T10:47:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466089",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:9'></a>Replying to [comment:7 gh-tobiasdiez]:
> 
> 
> My (originial) problem was that the following code
> 
> ```
> ...
> chart_functions = {chart: function('H')(*chart[:]) for chart in M.atlas()}
> H = M.scalar_field(chart_functions, name='H')
> ```

This declaration of the scalar field `H` is not mathematically correct: it enforces the same coordinate expression `H(x,y)` for all the coordinates `(x,y)` in the manifold's atlas, which cannot be, except for a constant scalar field. Furthermore, it introduces a confusion between `function('H')` and the scalar field `H`. For the sake of clarity, different symbols shall be used. Keep in mind that `function('H')` injects `H` in the global namespace. By running subsequently `H = M.scalar_field(...)`, you overwrite the Python name `H`. This can be unfortunate when you want to further manipulate `function('H')`, like in `substitute_function` for instance.



---

archive/issue_comments_466090.json:
```json
{
    "body": "<a id='comment:10'></a>Oh, then I misunderstood your comment above.\n\n> To  circumvent it, you should use  `  M = manifolds.Sphere(2, coordinates='stereographic')  `  \n\n\nThis works perfectly, thanks!\n\nI've updated the ticket description accordingly.",
    "created_at": "2021-12-06T17:35:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466090",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:10'></a>Oh, then I misunderstood your comment above.

> To  circumvent it, you should use  `  M = manifolds.Sphere(2, coordinates='stereographic')  `  


This works perfectly, thanks!

I've updated the ticket description accordingly.



---

archive/issue_comments_466091.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:9 egourgoulhon]:\n> Replying to [comment:7 gh-tobiasdiez]:\n> > \n> > \n> > My (originial) problem was that the following code\n> > \n> > ```\n> > ...\n> > chart_functions = {chart: function('H')(*chart[:]) for chart in M.atlas()}\n> > H = M.scalar_field(chart_functions, name='H')\n> > ```\n\n> This declaration of the scalar field `H` is not mathematically correct: it enforces the same coordinate expression `H(x,y)` for all the coordinates `(x,y)` in the manifold's atlas, which cannot be, except for a constant scalar field. Furthermore, it introduces a confusion between `function('H')` and the scalar field `H`. For the sake of clarity, different symbols shall be used. Keep in mind that `function('H')` injects `H` in the global namespace. By running subsequently `H = M.scalar_field(...)`, you overwrite the Python name `H`. This can be unfortunate when you want to further manipulate `function('H')`, like in `substitute_function` for instance. \n\nWhat I intended to do was to create a new function in each chart, i.e. just represent a general function on a manifold. What would be the correct way to do this? Simply use a different name for each chart function, or can one disable the injection of the local function in the global namespace?\n\nSide remark: I agree that using the same name might be confusing, but at least in the area I work in it seems standard to denote the chart representation of a function by the same symbol and make the distinction only by the arguments, i.e. if `H: M \\to \\R` is function on a manifold and `\\kappa: M \\to \\R^n` a local chart, then `H(x_1, ..., x_n) := H \\circ \\kappa^{-1}(x_1, ..., x_n)`.",
    "created_at": "2021-12-06T17:38:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466091",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:11'></a>Replying to [comment:9 egourgoulhon]:
> Replying to [comment:7 gh-tobiasdiez]:
> > 
> > 
> > My (originial) problem was that the following code
> > 
> > ```
> > ...
> > chart_functions = {chart: function('H')(*chart[:]) for chart in M.atlas()}
> > H = M.scalar_field(chart_functions, name='H')
> > ```

> This declaration of the scalar field `H` is not mathematically correct: it enforces the same coordinate expression `H(x,y)` for all the coordinates `(x,y)` in the manifold's atlas, which cannot be, except for a constant scalar field. Furthermore, it introduces a confusion between `function('H')` and the scalar field `H`. For the sake of clarity, different symbols shall be used. Keep in mind that `function('H')` injects `H` in the global namespace. By running subsequently `H = M.scalar_field(...)`, you overwrite the Python name `H`. This can be unfortunate when you want to further manipulate `function('H')`, like in `substitute_function` for instance. 

What I intended to do was to create a new function in each chart, i.e. just represent a general function on a manifold. What would be the correct way to do this? Simply use a different name for each chart function, or can one disable the injection of the local function in the global namespace?

Side remark: I agree that using the same name might be confusing, but at least in the area I work in it seems standard to denote the chart representation of a function by the same symbol and make the distinction only by the arguments, i.e. if `H: M \to \R` is function on a manifold and `\kappa: M \to \R^n` a local chart, then `H(x_1, ..., x_n) := H \circ \kappa^{-1}(x_1, ..., x_n)`.



---

archive/issue_comments_466092.json:
```json
{
    "body": "<a id='comment:12'></a>By the way, I really appreciate that you guys take the time to clarify and explain to me the inner workings of the manifold code!",
    "created_at": "2021-12-06T17:39:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466092",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:12'></a>By the way, I really appreciate that you guys take the time to clarify and explain to me the inner workings of the manifold code!



---

archive/issue_comments_466093.json:
```json
{
    "body": "<a id='comment:13'></a>Spheres are automatically initialized with spherical coordinates if not stated otherwise. That means, at the point of initialization, the default chart is set to the one given by spherical coordinates. I bet this to be the culprit of that \"inconsistency\".\n\nIf you want to initialize the sphere with stereographic coordinates right from the start, you can use `manifolds.Sphere(2, coordinates='stereographic')`.\n\nOne would probably have to transcribe the `display` method in such a way that the chart used for displaying is tried to be obtained from (the restriction) of the chart which the frame is induced from before the default chart is used. This is just my guess from not looking into the code.\n\n*Incidental remark 1: Ticket #31894 attempts to solve the covering issue of spherical coordinates.*\n\n*Incidental remark 2: remark 1 is also related to the orientation #31324 issue.*",
    "created_at": "2021-12-06T22:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466093",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:13'></a>Spheres are automatically initialized with spherical coordinates if not stated otherwise. That means, at the point of initialization, the default chart is set to the one given by spherical coordinates. I bet this to be the culprit of that "inconsistency".

If you want to initialize the sphere with stereographic coordinates right from the start, you can use `manifolds.Sphere(2, coordinates='stereographic')`.

One would probably have to transcribe the `display` method in such a way that the chart used for displaying is tried to be obtained from (the restriction) of the chart which the frame is induced from before the default chart is used. This is just my guess from not looking into the code.

*Incidental remark 1: Ticket #31894 attempts to solve the covering issue of spherical coordinates.*

*Incidental remark 2: remark 1 is also related to the orientation #31324 issue.*



---

archive/issue_comments_466094.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:13 gh-mjungmath]:\n> \n> One would probably has to transcribe the `display` method in such a way that the chart used for displaying is tried to be obtained from (the restriction) of the chart which the frame is induced from before the default chart is used. This is just my guess from not looking into the code.\n> \n\nThis sounds a good idea!",
    "created_at": "2021-12-06T23:03:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466094",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:14'></a>Replying to [comment:13 gh-mjungmath]:
> 
> One would probably has to transcribe the `display` method in such a way that the chart used for displaying is tried to be obtained from (the restriction) of the chart which the frame is induced from before the default chart is used. This is just my guess from not looking into the code.
> 

This sounds a good idea!



---

archive/issue_comments_466095.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:11 gh-tobiasdiez]:\n> What I intended to do was to create a new function in each chart, i.e. just represent a general function on a manifold. What would be the correct way to do this? \n\nI would say like this:\n\n```\nsage: M = manifolds.Sphere(2, coordinates='stereographic')\nsage: XN.<y1, y2> = M.stereographic_coordinates(pole='north')\nsage: XS = M.stereographic_coordinates(pole='south')\nsage: H = M.scalar_field({XN: function('h')(y1, y2)}, name='H')\nsage: H.add_expr_by_continuation(XS, XN.domain().intersection(XS.domain()))\nsage: H.display()\nH: S^2 \u2192 \u211d\non S^2-{NP}: (y1, y2) \u21a6 h(y1, y2)\non S^2-{SP}: (yp1, yp2) \u21a6 h(yp1/(yp1^2 + yp2^2), yp2/(yp1^2 + yp2^2))\n```\nThanks to [add_expr_by_continuation](https://doc.sagemath.org/html/en/reference/manifolds/sage/manifolds/scalarfield.html#sage.manifolds.scalarfield.ScalarField.add_expr_by_continuation), the scalar field is defined in a consistent way on all the manifold. \n> \n> Side remark: I agree that using the same name might be confusing, but at least in the area I work in it seems standard to denote the chart representation of a function by the same symbol and make the distinction only by the arguments, i.e. if `H: M \\to \\R` is function on a manifold and `\\kappa: M \\to \\R^n` a local chart, then `H(x_1, ..., x_n) := H \\circ \\kappa^{-1}(x_1, ..., x_n)`. \n\n\nI see your point, but I am afraid that using this in a computer algebra system may lead to some false results.",
    "created_at": "2021-12-07T09:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466095",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:15'></a>Replying to [comment:11 gh-tobiasdiez]:
> What I intended to do was to create a new function in each chart, i.e. just represent a general function on a manifold. What would be the correct way to do this? 

I would say like this:

```
sage: M = manifolds.Sphere(2, coordinates='stereographic')
sage: XN.<y1, y2> = M.stereographic_coordinates(pole='north')
sage: XS = M.stereographic_coordinates(pole='south')
sage: H = M.scalar_field({XN: function('h')(y1, y2)}, name='H')
sage: H.add_expr_by_continuation(XS, XN.domain().intersection(XS.domain()))
sage: H.display()
H: S^2 → ℝ
on S^2-{NP}: (y1, y2) ↦ h(y1, y2)
on S^2-{SP}: (yp1, yp2) ↦ h(yp1/(yp1^2 + yp2^2), yp2/(yp1^2 + yp2^2))
```
Thanks to [add_expr_by_continuation](https://doc.sagemath.org/html/en/reference/manifolds/sage/manifolds/scalarfield.html#sage.manifolds.scalarfield.ScalarField.add_expr_by_continuation), the scalar field is defined in a consistent way on all the manifold. 
> 
> Side remark: I agree that using the same name might be confusing, but at least in the area I work in it seems standard to denote the chart representation of a function by the same symbol and make the distinction only by the arguments, i.e. if `H: M \to \R` is function on a manifold and `\kappa: M \to \R^n` a local chart, then `H(x_1, ..., x_n) := H \circ \kappa^{-1}(x_1, ..., x_n)`. 


I see your point, but I am afraid that using this in a computer algebra system may lead to some false results.



---

archive/issue_comments_466096.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:13 gh-mjungmath]:\n> Spheres are automatically initialized with spherical coordinates if not stated otherwise. That means, at the point of initialization, the default chart is set to the one given by spherical coordinates. I bet this to be the culprit of that \"inconsistency\".\n> \n\nThe issue is rather that the spherical chart appears as well as the default one on the domain of stereographic coordinates:\n\n```\nsage: M = manifolds.Sphere(2)\nsage: XN = M.stereographic_coordinates(pole='north')\nsage: M.default_chart()  # output is OK, given the initialization of M\nChart (A, (theta, phi))\nsage: XN.domain().default_chart()  # output is unexpected\nChart (A, (theta, phi))\n```\nOne would rather expect `XN.domain().default_chart()` to be `XN`.",
    "created_at": "2021-12-07T09:49:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466096",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:16'></a>Replying to [comment:13 gh-mjungmath]:
> Spheres are automatically initialized with spherical coordinates if not stated otherwise. That means, at the point of initialization, the default chart is set to the one given by spherical coordinates. I bet this to be the culprit of that "inconsistency".
> 

The issue is rather that the spherical chart appears as well as the default one on the domain of stereographic coordinates:

```
sage: M = manifolds.Sphere(2)
sage: XN = M.stereographic_coordinates(pole='north')
sage: M.default_chart()  # output is OK, given the initialization of M
Chart (A, (theta, phi))
sage: XN.domain().default_chart()  # output is unexpected
Chart (A, (theta, phi))
```
One would rather expect `XN.domain().default_chart()` to be `XN`.



---

archive/issue_comments_466097.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:16 egourgoulhon]:\n> Replying to [comment:13 gh-mjungmath]:\n> > Spheres are automatically initialized with spherical coordinates if not stated otherwise. That means, at the point of initialization, the default chart is set to the one given by spherical coordinates. I bet this to be the culprit of that \"inconsistency\".\n> > \n\n> The issue is rather that the spherical chart appears as well as the default one on the domain of stereographic coordinates:\n> {{{\n> sage: M = manifolds.Sphere(2)\n> sage: XN = M.stereographic_coordinates(pole='north')\n> sage: M.default_chart()  # output is OK, given the initialization of M\n> Chart (A, (theta, phi))\n> sage: XN.domain().default_chart()  # output is unexpected\n> Chart (A, (theta, phi))\n> }}}\n> One would rather expect `XN.domain().default_chart()` to be `XN`. \n\n\nWhy is this output unexpected? Wouldn't you expect open subsets `U` to have the same default chart as their ambient space `M`?",
    "created_at": "2021-12-07T10:18:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466097",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:17'></a>Replying to [comment:16 egourgoulhon]:
> Replying to [comment:13 gh-mjungmath]:
> > Spheres are automatically initialized with spherical coordinates if not stated otherwise. That means, at the point of initialization, the default chart is set to the one given by spherical coordinates. I bet this to be the culprit of that "inconsistency".
> > 

> The issue is rather that the spherical chart appears as well as the default one on the domain of stereographic coordinates:
> {{{
> sage: M = manifolds.Sphere(2)
> sage: XN = M.stereographic_coordinates(pole='north')
> sage: M.default_chart()  # output is OK, given the initialization of M
> Chart (A, (theta, phi))
> sage: XN.domain().default_chart()  # output is unexpected
> Chart (A, (theta, phi))
> }}}
> One would rather expect `XN.domain().default_chart()` to be `XN`. 


Why is this output unexpected? Wouldn't you expect open subsets `U` to have the same default chart as their ambient space `M`?



---

archive/issue_comments_466098.json:
```json
{
    "body": "<a id='comment:18'></a>I find this default chart concept in case of non-parallelizable manifolds a bit cumbersome, anyways.\n\nWhat if we replace `default_chart` by `default_charts`, and use dictionaries instead? That is, the keys are subsets and values are default charts on that domain.\n\nIn addition, I'd opt for what I said earlier in comment:13.",
    "created_at": "2021-12-07T10:39:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466098",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:18'></a>I find this default chart concept in case of non-parallelizable manifolds a bit cumbersome, anyways.

What if we replace `default_chart` by `default_charts`, and use dictionaries instead? That is, the keys are subsets and values are default charts on that domain.

In addition, I'd opt for what I said earlier in comment:13.



---

archive/issue_comments_466099.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:17 gh-mjungmath]:\n> > One would rather expect `XN.domain().default_chart()` to be `XN`. \n\n> \n> Why is this output unexpected? Wouldn't you expect open subsets `U` to have the same default chart as their ambient space `M`?\n\n\nNo, not in general. Especially in the present case, where the spherical chart, `Xspher` says, does not cover `U = XN.domain()`, but only `A`, which is a strict subset of `U`. If `U` can be covered by a single chart, one would certainly expect that its default chart is such a covering chart. Moreover, in the current context, `U` is precisely defined as the domain of stereographic coordinates from the North pole (`XN`), so one certainly expects that its default chart is `XN`. That it is instead the chart of spherical coordinates happens only as an artifact of the order of creation of the open subsets and the spherical coordinate chart, in this part of `Sphere.__init__`:\n\n```\nself._init_chart_domains()   <- creates U, but not XN\nself._init_embedding()\nself._init_coordinates[coordinates](names)  <- creates Xspher and set it as the \n                                               default on all the preexisting \n                                               supersets of A, including U\n```\nIf one creates a new open subset of `M`, it does not inherit of `Xspher` as a default chart:\n\n```\nsage: V = M.open_subset('V')\nsage: V.default_chart() is None\nTrue\n```\nwhich is fortunate, since `V` might not contain `A`. \n\nIMHO, the solution would be that `Sphere._init_stereographic` sets `XN` as the default chart on `U`, just after having created it. Similarly, `Sphere._init_spherical` should set `Xspher` as the default chart on `A`.",
    "created_at": "2021-12-07T14:23:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466099",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:19'></a>Replying to [comment:17 gh-mjungmath]:
> > One would rather expect `XN.domain().default_chart()` to be `XN`. 

> 
> Why is this output unexpected? Wouldn't you expect open subsets `U` to have the same default chart as their ambient space `M`?


No, not in general. Especially in the present case, where the spherical chart, `Xspher` says, does not cover `U = XN.domain()`, but only `A`, which is a strict subset of `U`. If `U` can be covered by a single chart, one would certainly expect that its default chart is such a covering chart. Moreover, in the current context, `U` is precisely defined as the domain of stereographic coordinates from the North pole (`XN`), so one certainly expects that its default chart is `XN`. That it is instead the chart of spherical coordinates happens only as an artifact of the order of creation of the open subsets and the spherical coordinate chart, in this part of `Sphere.__init__`:

```
self._init_chart_domains()   <- creates U, but not XN
self._init_embedding()
self._init_coordinates[coordinates](names)  <- creates Xspher and set it as the 
                                               default on all the preexisting 
                                               supersets of A, including U
```
If one creates a new open subset of `M`, it does not inherit of `Xspher` as a default chart:

```
sage: V = M.open_subset('V')
sage: V.default_chart() is None
True
```
which is fortunate, since `V` might not contain `A`. 

IMHO, the solution would be that `Sphere._init_stereographic` sets `XN` as the default chart on `U`, just after having created it. Similarly, `Sphere._init_spherical` should set `Xspher` as the default chart on `A`.



---

archive/issue_comments_466100.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:15 egourgoulhon]:\n> Thanks to [add_expr_by_continuation](https://doc.sagemath.org/html/en/reference/manifolds/sage/manifolds/scalarfield.html#sage.manifolds.scalarfield.ScalarField.add_expr_by_continuation), the scalar field is defined in a consistent way on all the manifold. \n> > \n> > Side remark: I agree that using the same name might be confusing, but at least in the area I work in it seems standard to denote the chart representation of a function by the same symbol and make the distinction only by the arguments, i.e. if `H: M \\to \\R` is function on a manifold and `\\kappa: M \\to \\R^n` a local chart, then `H(x_1, ..., x_n) := H \\circ \\kappa^{-1}(x_1, ..., x_n)`. \n\n> \n> I see your point, but I am afraid that using this in a computer algebra system may lead to some false results.\n\n\nHere is an example of such false result. Suppose you define a scalar field the way you would like:\n\n```\nsage: M = manifolds.Sphere(2, coordinates='stereographic')\nsage: XN.<y1, y2> = M.stereographic_coordinates(pole='north')\nsage: XS.<yp1, yp2> = M.stereographic_coordinates(pole='south')\nsage: H = M.scalar_field({XN: function('h')(y1, y2), \n....:                     XS: function('h')(yp1, yp2)}, name='H')\n```\nThen it will always take identical values at the North and South poles:\n\n```\nsage: NP = M((0,0), chart=XS)\nsage: SP = M((0,0), chart=XN)\nsage: bool(H(NP) == H(SP))\nTrue\n```\nwhich is certainly not what you want for a generic scalar field on the sphere.",
    "created_at": "2021-12-07T15:13:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466100",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:21'></a>Replying to [comment:15 egourgoulhon]:
> Thanks to [add_expr_by_continuation](https://doc.sagemath.org/html/en/reference/manifolds/sage/manifolds/scalarfield.html#sage.manifolds.scalarfield.ScalarField.add_expr_by_continuation), the scalar field is defined in a consistent way on all the manifold. 
> > 
> > Side remark: I agree that using the same name might be confusing, but at least in the area I work in it seems standard to denote the chart representation of a function by the same symbol and make the distinction only by the arguments, i.e. if `H: M \to \R` is function on a manifold and `\kappa: M \to \R^n` a local chart, then `H(x_1, ..., x_n) := H \circ \kappa^{-1}(x_1, ..., x_n)`. 

> 
> I see your point, but I am afraid that using this in a computer algebra system may lead to some false results.


Here is an example of such false result. Suppose you define a scalar field the way you would like:

```
sage: M = manifolds.Sphere(2, coordinates='stereographic')
sage: XN.<y1, y2> = M.stereographic_coordinates(pole='north')
sage: XS.<yp1, yp2> = M.stereographic_coordinates(pole='south')
sage: H = M.scalar_field({XN: function('h')(y1, y2), 
....:                     XS: function('h')(yp1, yp2)}, name='H')
```
Then it will always take identical values at the North and South poles:

```
sage: NP = M((0,0), chart=XS)
sage: SP = M((0,0), chart=XN)
sage: bool(H(NP) == H(SP))
True
```
which is certainly not what you want for a generic scalar field on the sphere.



---

archive/issue_comments_466101.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:19 egourgoulhon]:\n> No, not in general. Especially in the present case, where the spherical chart, `Xspher` says, does not cover `U = XN.domain()`, but only `A`, which is a strict subset of `U`. If `U` can be covered by a single chart, one would certainly expect that its default chart is such a covering chart. Moreover, in the current context, `U` is precisely defined as the domain of stereographic coordinates from the North pole (`XN`), so one certainly expects that its default chart is `XN`. That it is instead the chart of spherical coordinates happens only as an artifact of the order of creation of the open subsets and the spherical coordinate chart, in this part of `Sphere.__init__`:\n> \n> ```\n> self._init_chart_domains()   <- creates U, but not XN\n> self._init_embedding()\n> self._init_coordinates[coordinates](names)  <- creates Xspher and set it as the \n>                                                default on all the preexisting \n>                                                supersets of A, including U\n> ```\n> If one creates a new open subset of `M`, it does not inherit of `Xspher` as a default chart:\n> \n> ```\n> sage: V = M.open_subset('V')\n> sage: V.default_chart() is None\n> True\n> ```\n> which is fortunate, since `V` might not contain `A`. \n> \n> IMHO, the solution would be that `Sphere._init_stereographic` sets `XN` as the default chart on `U`, just after having created it. Similarly, `Sphere._init_spherical` should set `Xspher` as the default chart on `A`. \n\n\nDon't you think this should be attacked on the level of the general manifolds implementation? Those (non-obvious) things can still happen if you define manifolds on the fly.",
    "created_at": "2021-12-07T15:31:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466101",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:22'></a>Replying to [comment:19 egourgoulhon]:
> No, not in general. Especially in the present case, where the spherical chart, `Xspher` says, does not cover `U = XN.domain()`, but only `A`, which is a strict subset of `U`. If `U` can be covered by a single chart, one would certainly expect that its default chart is such a covering chart. Moreover, in the current context, `U` is precisely defined as the domain of stereographic coordinates from the North pole (`XN`), so one certainly expects that its default chart is `XN`. That it is instead the chart of spherical coordinates happens only as an artifact of the order of creation of the open subsets and the spherical coordinate chart, in this part of `Sphere.__init__`:
> 
> ```
> self._init_chart_domains()   <- creates U, but not XN
> self._init_embedding()
> self._init_coordinates[coordinates](names)  <- creates Xspher and set it as the 
>                                                default on all the preexisting 
>                                                supersets of A, including U
> ```
> If one creates a new open subset of `M`, it does not inherit of `Xspher` as a default chart:
> 
> ```
> sage: V = M.open_subset('V')
> sage: V.default_chart() is None
> True
> ```
> which is fortunate, since `V` might not contain `A`. 
> 
> IMHO, the solution would be that `Sphere._init_stereographic` sets `XN` as the default chart on `U`, just after having created it. Similarly, `Sphere._init_spherical` should set `Xspher` as the default chart on `A`. 


Don't you think this should be attacked on the level of the general manifolds implementation? Those (non-obvious) things can still happen if you define manifolds on the fly.



---

archive/issue_comments_466102.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:22 gh-mjungmath]:\n> > \n> > IMHO, the solution would be that `Sphere._init_stereographic` sets `XN` as the default chart on `U`, just after having created it. Similarly, `Sphere._init_spherical` should set `Xspher` as the default chart on `A`. \n\n> \n> Don't you think this should be attacked on the level of the general manifolds implementation? Those (non-obvious) things can still happen if you define manifolds on the fly.\n\n\nI don't see any general strategy here. Probably we should leave this to the user defining the manifold on the fly. But in the specific case of the sphere, we should implement the standard charts (spherical, stereographic) in such a way that they are the default ones on their domains.",
    "created_at": "2021-12-07T15:52:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466102",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:23'></a>Replying to [comment:22 gh-mjungmath]:
> > 
> > IMHO, the solution would be that `Sphere._init_stereographic` sets `XN` as the default chart on `U`, just after having created it. Similarly, `Sphere._init_spherical` should set `Xspher` as the default chart on `A`. 

> 
> Don't you think this should be attacked on the level of the general manifolds implementation? Those (non-obvious) things can still happen if you define manifolds on the fly.


I don't see any general strategy here. Probably we should leave this to the user defining the manifold on the fly. But in the specific case of the sphere, we should implement the standard charts (spherical, stereographic) in such a way that they are the default ones on their domains.



---

archive/issue_comments_466103.json:
```json
{
    "body": "<a id='comment:24'></a>I agree, it wouldn't hurt to add this for spheres.\n\nWhat about my idea before, using dictionaries instead?\n\nPerhaps Travis has an idea?",
    "created_at": "2021-12-07T16:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466103",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:24'></a>I agree, it wouldn't hurt to add this for spheres.

What about my idea before, using dictionaries instead?

Perhaps Travis has an idea?



---

archive/issue_comments_466104.json:
```json
{
    "body": "<a id='comment:25'></a>I don't really like the idea of using dictionaries because you further increase the burden on keeping all of the information consistent when the information you want can just be directly attached to the subsets in question. So you have `nC2 ~ n^2` pieces of information stored instead of `n` for a chain of `n` subsets.",
    "created_at": "2021-12-09T00:40:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466104",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:25'></a>I don't really like the idea of using dictionaries because you further increase the burden on keeping all of the information consistent when the information you want can just be directly attached to the subsets in question. So you have `nC2 ~ n^2` pieces of information stored instead of `n` for a chain of `n` subsets.



---

archive/issue_events_087067.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:11:26Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32953#event-87067"
}
```



---

archive/issue_comments_466105.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:24 gh-mjungmath]:\n> I agree, it wouldn't hurt to add this for spheres.\n> \n\nHere we go...\n\n---\nNew commits:",
    "created_at": "2022-02-22T14:02:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466105",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:27'></a>Replying to [comment:24 gh-mjungmath]:
> I agree, it wouldn't hurt to add this for spheres.
> 

Here we go...

---
New commits:



---

archive/issue_comments_466106.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-02-22T14:02:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466106",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_466107.json:
```json
{
    "body": "Changing keywords from \"\" to \"sphere\".",
    "created_at": "2022-02-22T14:02:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466107",
    "user": "https://github.com/egourgoulhon"
}
```

Changing keywords from "" to "sphere".



---

archive/issue_comments_466108.json:
```json
{
    "body": "<a id='comment:28'></a>Green bot (morally). I am setting this to a positive review. Feel free to revert if there are any objections.",
    "created_at": "2022-02-23T03:51:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466108",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:28'></a>Green bot (morally). I am setting this to a positive review. Feel free to revert if there are any objections.



---

archive/issue_comments_466109.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-23T03:51:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466109",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_466110.json:
```json
{
    "body": "<a id='comment:29'></a>Thank you for the review!",
    "created_at": "2022-02-23T13:17:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466110",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:29'></a>Thank you for the review!



---

archive/issue_events_087068.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-02-27T22:00:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32953#event-87068"
}
```



---

archive/issue_comments_466111.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-02-27T22:00:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32953",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32953#issuecomment-466111",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
