# Issue 32424: Upgrade to OpenBLAS 0.3.18 and make Sage fat binaries portable

archive/issues_032187.json:
```json
{
    "assignees": [],
    "body": "as reported in:\n- https://groups.google.com/g/sage-support/c/KZFZBoI6xJk/m/HCXHDOnOAAAJ\n- #32447\n\nRelated:\n- #32363 Rename configure option --enable-fat-binary to --enable-portable-binary\n- #32434 Do not require AVX when building with `SAGE_FAT_BINARY`\n\n\nCC:  @williamstein @kliem @dimpase @NathanDunfield @culler @slel @orlitzky @vbraun @maxale @sagetrac-tmonteil @jhpalmieri\n\nKeywords: **upgrade, openblas**\n\nBranch/Commit: **[`2f5f195`](https://github.com/sagemath/sagetrac-mirror/commit/2f5f1957034aee0d9b130dae3f4e52f0e855986e)**\n\nReviewer: **Matthias Koeppe, Dima Pasechnik**\n\nAuthor: **Isuru Fernando, Matthias Koeppe, Volker Braun**\n\nComponent: **porting**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/32424_\n\n",
    "closed_at": "2021-11-12T21:27:59Z",
    "created_at": "2021-08-26T04:16:33Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20porting",
        "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.5",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Upgrade to OpenBLAS 0.3.18 and make Sage fat binaries portable",
    "type": "issue",
    "updated_at": "2021-11-12T21:27:59Z",
    "url": "https://github.com/sagemath/sage/issues/32424",
    "user": "https://github.com/mkoeppe"
}
```
as reported in:
- https://groups.google.com/g/sage-support/c/KZFZBoI6xJk/m/HCXHDOnOAAAJ
- #32447

Related:
- #32363 Rename configure option --enable-fat-binary to --enable-portable-binary
- #32434 Do not require AVX when building with `SAGE_FAT_BINARY`


CC:  @williamstein @kliem @dimpase @NathanDunfield @culler @slel @orlitzky @vbraun @maxale @sagetrac-tmonteil @jhpalmieri

Keywords: **upgrade, openblas**

Branch/Commit: **[`2f5f195`](https://github.com/sagemath/sagetrac-mirror/commit/2f5f1957034aee0d9b130dae3f4e52f0e855986e)**

Reviewer: **Matthias Koeppe, Dima Pasechnik**

Author: **Isuru Fernando, Matthias Koeppe, Volker Braun**

Component: **porting**

_Issue created by migration from https://trac.sagemath.org/ticket/32424_





---

archive/issue_events_447184.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-26T04:16:33Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447184"
}
```



---

archive/issue_events_447185.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-26T04:16:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20porting",
    "label_color": "000080",
    "label_name": "c: porting",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447185"
}
```



---

archive/issue_events_447186.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-26T04:16:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447186"
}
```



---

archive/issue_events_447187.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-26T04:16:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447187"
}
```



---

archive/issue_comments_522845.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nThe signal error is caused by `nullspaceMP`, which is in the iml library.\n\nIml itself doesn't use architecture specific instructions, but the dependencies are.\nBut then again, OPENBLAS and gmp are already built with `make DYNAMIC_ARCH=1` resp. `--enable-fat`. Both of them got updated between sage 9.0 and sage 9.3.",
    "created_at": "2021-08-26T09:47:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522845",
    "user": "https://github.com/kliem"
}
```

<div id="comment:1" align="right">comment:1</div>

The signal error is caused by `nullspaceMP`, which is in the iml library.

Iml itself doesn't use architecture specific instructions, but the dependencies are.
But then again, OPENBLAS and gmp are already built with `make DYNAMIC_ARCH=1` resp. `--enable-fat`. Both of them got updated between sage 9.0 and sage 9.3.



---

archive/issue_comments_522846.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,5 @@\n as reported in https://groups.google.com/g/sage-support/c/KZFZBoI6xJk/m/HCXHDOnOAAAJ\n \n \n+Related:\n+- #32363 Rename configure option --enable-fat-binary to --enable-portable-binary\n``````\n",
    "created_at": "2021-08-26T18:16:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522846",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,5 @@
 as reported in https://groups.google.com/g/sage-support/c/KZFZBoI6xJk/m/HCXHDOnOAAAJ
 
 
+Related:
+- #32363 Rename configure option --enable-fat-binary to --enable-portable-binary
``````




---

archive/issue_comments_522847.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nI suspect the cause is OpenBLAS.  While this library is built with DYNAMIC_ARCH=1, there is still the non-performance critical code in it which will use whatever instructions are available on the machine at compile time unless you **also** set TARGET.  See\n\nhttps://github.com/xianyi/OpenBLAS/issues/3056\n\nFor the macOS app, Marc Culler had to set TARGET=CORE2 in addition to DYNAMIC_ARCH=1 so that it would run on a 2013 cylindrical Mac Pro.",
    "created_at": "2021-08-26T18:40:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522847",
    "user": "https://github.com/NathanDunfield"
}
```

<div id="comment:3" align="right">comment:3</div>

I suspect the cause is OpenBLAS.  While this library is built with DYNAMIC_ARCH=1, there is still the non-performance critical code in it which will use whatever instructions are available on the machine at compile time unless you **also** set TARGET.  See

https://github.com/xianyi/OpenBLAS/issues/3056

For the macOS app, Marc Culler had to set TARGET=CORE2 in addition to DYNAMIC_ARCH=1 so that it would run on a 2013 cylindrical Mac Pro.



---

archive/issue_comments_522848.json:
```json
{
    "body": "Commit: **[`343d6a1`](https://github.com/sagemath/sagetrac-mirror/commit/343d6a15cfc21f69024d19bba66e73833ef58966)**",
    "created_at": "2021-08-26T19:21:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522848",
    "user": "https://github.com/isuruf"
}
```

Commit: **[`343d6a1`](https://github.com/sagemath/sagetrac-mirror/commit/343d6a15cfc21f69024d19bba66e73833ef58966)**



---

archive/issue_events_447188.json:
```json
{
    "actor": "https://github.com/isuruf",
    "created_at": "2021-08-26T19:21:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447188"
}
```



---

archive/issue_comments_522849.json:
```json
{
    "body": "Author: **Isuru Fernando**",
    "created_at": "2021-08-26T19:21:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522849",
    "user": "https://github.com/isuruf"
}
```

Author: **Isuru Fernando**



---

archive/issue_comments_522850.json:
```json
{
    "body": "<div id=\"comment:5\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cff0e2bb73af1223f03e6a9b3aa434063e2439ee\">cff0e2b</a></td><td><code>set target for dynamic_arch</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/343d6a15cfc21f69024d19bba66e73833ef58966\">343d6a1</a></td><td><code>AVX512 support is now much better</code></td></tr></table>\n",
    "created_at": "2021-08-26T19:21:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522850",
    "user": "https://github.com/isuruf"
}
```

<div id="comment:5"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cff0e2bb73af1223f03e6a9b3aa434063e2439ee">cff0e2b</a></td><td><code>set target for dynamic_arch</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/343d6a15cfc21f69024d19bba66e73833ef58966">343d6a1</a></td><td><code>AVX512 support is now much better</code></td></tr></table>




---

archive/issue_comments_522851.json:
```json
{
    "body": "Branch: **[u/isuruf/openblas-target](https://github.com/sagemath/sagetrac-mirror/tree/u/isuruf/openblas-target)**",
    "created_at": "2021-08-26T19:21:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522851",
    "user": "https://github.com/isuruf"
}
```

Branch: **[u/isuruf/openblas-target](https://github.com/sagemath/sagetrac-mirror/tree/u/isuruf/openblas-target)**



---

archive/issue_comments_522852.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nshould we also throw in an openblas upgrade? https://repology.org/projects/o/?inrepo=sagemath_stable",
    "created_at": "2021-08-26T19:53:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522852",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:6" align="right">comment:6</div>

should we also throw in an openblas upgrade? https://repology.org/projects/o/?inrepo=sagemath_stable



---

archive/issue_comments_522853.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nYes, that would be good to have. I didn't realize openblas was way behind.\nFeel free to push to this branch",
    "created_at": "2021-08-26T19:55:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522853",
    "user": "https://github.com/isuruf"
}
```

<div id="comment:7" align="right">comment:7</div>

Yes, that would be good to have. I didn't realize openblas was way behind.
Feel free to push to this branch



---

archive/issue_comments_522854.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\non macOS:\n\n```\n[openblas-0.3.17] ./spkg-install: line 55: conditional binary operator expected\n[openblas-0.3.17] ./spkg-install: line 55: syntax error near `~='\n[openblas-0.3.17] ./spkg-install: line 55: `    if [[ $os-$machine ~= darwin-x86_64 ]]; then'\n```",
    "created_at": "2021-08-26T20:03:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522854",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:8" align="right">comment:8</div>

on macOS:

```
[openblas-0.3.17] ./spkg-install: line 55: conditional binary operator expected
[openblas-0.3.17] ./spkg-install: line 55: syntax error near `~='
[openblas-0.3.17] ./spkg-install: line 55: `    if [[ $os-$machine ~= darwin-x86_64 ]]; then'
```



---

archive/issue_comments_522855.json:
```json
{
    "body": "Changed branch from **[u/isuruf/openblas-target](https://github.com/sagemath/sagetrac-mirror/tree/u/isuruf/openblas-target)** to **[u/mkoeppe/openblas-target](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/openblas-target)**",
    "created_at": "2021-08-26T20:03:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522855",
    "user": "https://github.com/mkoeppe"
}
```

Changed branch from **[u/isuruf/openblas-target](https://github.com/sagemath/sagetrac-mirror/tree/u/isuruf/openblas-target)** to **[u/mkoeppe/openblas-target](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/openblas-target)**



---

archive/issue_comments_522856.json:
```json
{
    "body": "Changed commit from **[`343d6a1`](https://github.com/sagemath/sagetrac-mirror/commit/343d6a15cfc21f69024d19bba66e73833ef58966)** to **[`c8cbf1f`](https://github.com/sagemath/sagetrac-mirror/commit/c8cbf1fac644982d29c617669bb4d0958b18fa5c)**",
    "created_at": "2021-08-26T23:17:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522856",
    "user": "https://github.com/slel"
}
```

Changed commit from **[`343d6a1`](https://github.com/sagemath/sagetrac-mirror/commit/343d6a15cfc21f69024d19bba66e73833ef58966)** to **[`c8cbf1f`](https://github.com/sagemath/sagetrac-mirror/commit/c8cbf1fac644982d29c617669bb4d0958b18fa5c)**



---

archive/issue_events_447189.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2021-08-26T23:17:11Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "title_is": "Upgrade to OpenBLAS 0.3.17 and make Sage fat binaries portable",
    "title_was": "Sage 9.4 still creates non-portable binaries with SAGE_FAT_BINARY=\"yes\"",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447189"
}
```



---

archive/issue_comments_522857.json:
```json
{
    "body": "<div id=\"comment:10\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c8cbf1fac644982d29c617669bb4d0958b18fa5c\">c8cbf1f</a></td><td><code>build/pkgs/openblas: Update to 0.3.17</code></td></tr></table>\n",
    "created_at": "2021-08-26T23:17:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522857",
    "user": "https://github.com/slel"
}
```

<div id="comment:10"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c8cbf1fac644982d29c617669bb4d0958b18fa5c">c8cbf1f</a></td><td><code>build/pkgs/openblas: Update to 0.3.17</code></td></tr></table>




---

archive/issue_comments_522858.json:
```json
{
    "body": "Changed keywords from none to **upgrade, openblas**",
    "created_at": "2021-08-26T23:17:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522858",
    "user": "https://github.com/slel"
}
```

Changed keywords from none to **upgrade, openblas**



---

archive/issue_events_447190.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-27T00:41:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447190"
}
```



---

archive/issue_events_447191.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-27T00:41:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447191"
}
```



---

archive/issue_comments_522859.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/openblas-target](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/openblas-target)** to **[u/isuruf/openblas-target](https://github.com/sagemath/sagetrac-mirror/tree/u/isuruf/openblas-target)**",
    "created_at": "2021-08-27T00:49:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522859",
    "user": "https://github.com/isuruf"
}
```

Changed branch from **[u/mkoeppe/openblas-target](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/openblas-target)** to **[u/isuruf/openblas-target](https://github.com/sagemath/sagetrac-mirror/tree/u/isuruf/openblas-target)**



---

archive/issue_comments_522860.json:
```json
{
    "body": "Changed commit from **[`c8cbf1f`](https://github.com/sagemath/sagetrac-mirror/commit/c8cbf1fac644982d29c617669bb4d0958b18fa5c)** to **[`1b03f2b`](https://github.com/sagemath/sagetrac-mirror/commit/1b03f2bde68d5548d483c43157cc4795c4579e23)**",
    "created_at": "2021-08-27T00:49:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522860",
    "user": "https://github.com/isuruf"
}
```

Changed commit from **[`c8cbf1f`](https://github.com/sagemath/sagetrac-mirror/commit/c8cbf1fac644982d29c617669bb4d0958b18fa5c)** to **[`1b03f2b`](https://github.com/sagemath/sagetrac-mirror/commit/1b03f2bde68d5548d483c43157cc4795c4579e23)**



---

archive/issue_comments_522861.json:
```json
{
    "body": "<div id=\"comment:12\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bed527e3c4704f61dcc33c44758b57d39020ca49\">bed527e</a></td><td><code>set target for dynamic_arch</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/825f704babd1535d169b795b459ed7be54350fb7\">825f704</a></td><td><code>AVX512 support is now much better</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1b03f2bde68d5548d483c43157cc4795c4579e23\">1b03f2b</a></td><td><code>build/pkgs/openblas: Update to 0.3.17</code></td></tr></table>\n",
    "created_at": "2021-08-27T00:49:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522861",
    "user": "https://github.com/isuruf"
}
```

<div id="comment:12"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bed527e3c4704f61dcc33c44758b57d39020ca49">bed527e</a></td><td><code>set target for dynamic_arch</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/825f704babd1535d169b795b459ed7be54350fb7">825f704</a></td><td><code>AVX512 support is now much better</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1b03f2bde68d5548d483c43157cc4795c4579e23">1b03f2b</a></td><td><code>build/pkgs/openblas: Update to 0.3.17</code></td></tr></table>




---

archive/issue_events_447192.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-27T19:09:22Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447192"
}
```



---

archive/issue_events_447193.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-27T19:09:22Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447193"
}
```



---

archive/issue_comments_522862.json:
```json
{
    "body": "Changed author from **Isuru Fernando** to **Isuru Fernando, Matthias Koeppe**",
    "created_at": "2021-08-27T21:40:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522862",
    "user": "https://github.com/mkoeppe"
}
```

Changed author from **Isuru Fernando** to **Isuru Fernando, Matthias Koeppe**



---

archive/issue_comments_522863.json:
```json
{
    "body": "Reviewer: **https://github.com/mkoeppe/sage/actions/runs/1175727870, https://github.com/mkoeppe/sage/actions/runs/1175727869**",
    "created_at": "2021-08-27T21:40:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522863",
    "user": "https://github.com/mkoeppe"
}
```

Reviewer: **https://github.com/mkoeppe/sage/actions/runs/1175727870, https://github.com/mkoeppe/sage/actions/runs/1175727869**



---

archive/issue_comments_522864.json:
```json
{
    "body": "Changed reviewer from **https://github.com/mkoeppe/sage/actions/runs/1175727870, https://github.com/mkoeppe/sage/actions/runs/1175727869** to **https://github.com/mkoeppe/sage/actions/runs/1176095684, https://github.com/mkoeppe/sage/actions/runs/1175727875, ...**",
    "created_at": "2021-08-28T00:51:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522864",
    "user": "https://github.com/mkoeppe"
}
```

Changed reviewer from **https://github.com/mkoeppe/sage/actions/runs/1175727870, https://github.com/mkoeppe/sage/actions/runs/1175727869** to **https://github.com/mkoeppe/sage/actions/runs/1176095684, https://github.com/mkoeppe/sage/actions/runs/1175727875, ...**



---

archive/issue_comments_522865.json:
```json
{
    "body": "Changed reviewer from **https://github.com/mkoeppe/sage/actions/runs/1176095684, https://github.com/mkoeppe/sage/actions/runs/1175727875, ...** to **Matthias Koeppe, https://github.com/mkoeppe/sage/actions/runs/1176095684, https://github.com/mkoeppe/sage/actions/runs/1175727875, ...**",
    "created_at": "2021-08-28T17:17:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522865",
    "user": "https://github.com/mkoeppe"
}
```

Changed reviewer from **https://github.com/mkoeppe/sage/actions/runs/1176095684, https://github.com/mkoeppe/sage/actions/runs/1175727875, ...** to **Matthias Koeppe, https://github.com/mkoeppe/sage/actions/runs/1176095684, https://github.com/mkoeppe/sage/actions/runs/1175727875, ...**



---

archive/issue_comments_522866.json:
```json
{
    "body": "Changed reviewer from **Matthias Koeppe, https://github.com/mkoeppe/sage/actions/runs/1176095684, https://github.com/mkoeppe/sage/actions/runs/1175727875, ...** to **Matthias Koeppe, https://github.com/mkoeppe/sage/actions/runs/1176095684, https://github.com/mkoeppe/sage/actions/runs/1177591365, ...**",
    "created_at": "2021-08-28T17:26:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522866",
    "user": "https://github.com/mkoeppe"
}
```

Changed reviewer from **Matthias Koeppe, https://github.com/mkoeppe/sage/actions/runs/1176095684, https://github.com/mkoeppe/sage/actions/runs/1175727875, ...** to **Matthias Koeppe, https://github.com/mkoeppe/sage/actions/runs/1176095684, https://github.com/mkoeppe/sage/actions/runs/1177591365, ...**



---

archive/issue_comments_522867.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nFor `SAGE_FAT_BINARY`, I think we have to set the `TARGET` to the \"oldest\" value that we expect the binaries to run on. If that's right, then using the `uname` will make it so that the binaries are portable only to other machines with the same (or \"newer\") `uname`.\n\n`CORE2` sounds like a good choice to me. Old enough to work for most people, but not crippled performance-wise.",
    "created_at": "2021-09-01T12:10:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522867",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:19" align="right">comment:19</div>

For `SAGE_FAT_BINARY`, I think we have to set the `TARGET` to the "oldest" value that we expect the binaries to run on. If that's right, then using the `uname` will make it so that the binaries are portable only to other machines with the same (or "newer") `uname`.

`CORE2` sounds like a good choice to me. Old enough to work for most people, but not crippled performance-wise.



---

archive/issue_comments_522868.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\n> If that's right, then using the uname will make it so that the binaries are portable only to other machines with the same (or \"newer\") uname. \n\nThat's correct. What's wrong with that? Do you expect binaries built on ppc64le to run on x86_64?\n\n> CORE2 sounds like a good choice to me. Old enough to work for most people, but not crippled performance-wise. \n\nCORE2 is only for x86_64. Besides TARGET is needed only for non-performance critical code paths.",
    "created_at": "2021-09-01T12:35:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522868",
    "user": "https://github.com/isuruf"
}
```

<div id="comment:20" align="right">comment:20</div>

> If that's right, then using the uname will make it so that the binaries are portable only to other machines with the same (or "newer") uname. 

That's correct. What's wrong with that? Do you expect binaries built on ppc64le to run on x86_64?

> CORE2 sounds like a good choice to me. Old enough to work for most people, but not crippled performance-wise. 

CORE2 is only for x86_64. Besides TARGET is needed only for non-performance critical code paths.



---

archive/issue_comments_522869.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@isuruf](#comment:20):\n> > If that's right, then using the uname will make it so that the binaries are portable only to other machines with the same (or \"newer\") uname. \n\n> \n> That's correct. What's wrong with that?\n\nNothing, I didn't look closely enough at the cases. The only two that overlap in any way are x86_64 and x86, and setting `TARGET` to an x86 value on an x86_64 machine won't magically make it produce 32-bit binaries, so... LGTM now.",
    "created_at": "2021-09-01T12:52:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522869",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@isuruf](#comment:20):
> > If that's right, then using the uname will make it so that the binaries are portable only to other machines with the same (or "newer") uname. 

> 
> That's correct. What's wrong with that?

Nothing, I didn't look closely enough at the cases. The only two that overlap in any way are x86_64 and x86, and setting `TARGET` to an x86 value on an x86_64 machine won't magically make it produce 32-bit binaries, so... LGTM now.



---

archive/issue_comments_522870.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nI think instead of `uname`, we should use `$CC -dumpmachine` like we do in `build/pkgs/gfortran/spkg-build.in` from #29241",
    "created_at": "2021-09-01T18:23:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522870",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:22" align="right">comment:22</div>

I think instead of `uname`, we should use `$CC -dumpmachine` like we do in `build/pkgs/gfortran/spkg-build.in` from #29241



---

archive/issue_comments_522871.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@isuruf](#comment:20):\n> > If that's right, then using the uname will make it so that the binaries are portable only to other machines with the same (or \"newer\") uname. \n\n> \n> That's correct. What's wrong with that? Do you expect binaries built on ppc64le to run on x86_64?\n\nThey often do, via qemu and `binfmt_misc`..., see https://hub.docker.com/r/multiarch/ubuntu-core",
    "created_at": "2021-09-01T18:41:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522871",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@isuruf](#comment:20):
> > If that's right, then using the uname will make it so that the binaries are portable only to other machines with the same (or "newer") uname. 

> 
> That's correct. What's wrong with that? Do you expect binaries built on ppc64le to run on x86_64?

They often do, via qemu and `binfmt_misc`..., see https://hub.docker.com/r/multiarch/ubuntu-core



---

archive/issue_comments_522872.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,5 +1,6 @@\n-as reported in https://groups.google.com/g/sage-support/c/KZFZBoI6xJk/m/HCXHDOnOAAAJ\n-\n+as reported in:\n+- https://groups.google.com/g/sage-support/c/KZFZBoI6xJk/m/HCXHDOnOAAAJ\n+- \n \n Related:\n - #32363 Rename configure option --enable-fat-binary to --enable-portable-binary\n``````\n",
    "created_at": "2021-09-01T20:12:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522872",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,5 +1,6 @@
-as reported in https://groups.google.com/g/sage-support/c/KZFZBoI6xJk/m/HCXHDOnOAAAJ
-
+as reported in:
+- https://groups.google.com/g/sage-support/c/KZFZBoI6xJk/m/HCXHDOnOAAAJ
+- 
 
 Related:
 - #32363 Rename configure option --enable-fat-binary to --enable-portable-binary
``````




---

archive/issue_comments_522873.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n as reported in:\n - https://groups.google.com/g/sage-support/c/KZFZBoI6xJk/m/HCXHDOnOAAAJ\n-- \n+- #32447\n \n Related:\n - #32363 Rename configure option --enable-fat-binary to --enable-portable-binary\n``````\n",
    "created_at": "2021-09-01T20:12:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522873",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 as reported in:
 - https://groups.google.com/g/sage-support/c/KZFZBoI6xJk/m/HCXHDOnOAAAJ
-- 
+- #32447
 
 Related:
 - #32363 Rename configure option --enable-fat-binary to --enable-portable-binary
``````




---

archive/issue_comments_522874.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\n> They often do, via qemu and binfmt_misc\n\nThat's not relevant either. qemu would emulate the instruction set\nincluding cpuid instruction.",
    "created_at": "2021-09-01T20:29:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522874",
    "user": "https://github.com/isuruf"
}
```

<div id="comment:27" align="right">comment:27</div>

> They often do, via qemu and binfmt_misc

That's not relevant either. qemu would emulate the instruction set
including cpuid instruction.



---

archive/issue_comments_522875.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nBut because of the `binfmt_misc` emulation route, you cannot rely on `uname` to reason about the target architecture, i.e., [comment:22](#comment:22) applies not just for x86_64/i686.",
    "created_at": "2021-09-01T20:33:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522875",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:28" align="right">comment:28</div>

But because of the `binfmt_misc` emulation route, you cannot rely on `uname` to reason about the target architecture, i.e., [comment:22](#comment:22) applies not just for x86_64/i686.



---

archive/issue_comments_522876.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\n> But because of the binfmt_misc emulation route, you cannot rely on uname to reason about the target architecture, i.e., [comment:22](#comment:22) applies not just for x86_64/i686.\n\nOpenblas `spkg-install.in` doesn't support building for non-native architecture\neven on `develop` branch.",
    "created_at": "2021-09-01T20:37:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522876",
    "user": "https://github.com/isuruf"
}
```

<div id="comment:29" align="right">comment:29</div>

> But because of the binfmt_misc emulation route, you cannot rely on uname to reason about the target architecture, i.e., [comment:22](#comment:22) applies not just for x86_64/i686.

Openblas `spkg-install.in` doesn't support building for non-native architecture
even on `develop` branch.



---

archive/issue_comments_522877.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nWe do test this at least for i686 on x86_64 - see for example https://github.com/sagemath/sage/runs/3392765581?check_suite_focus=true\n(which needed #29241)",
    "created_at": "2021-09-01T20:48:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522877",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:30" align="right">comment:30</div>

We do test this at least for i686 on x86_64 - see for example https://github.com/sagemath/sage/runs/3392765581?check_suite_focus=true
(which needed #29241)



---

archive/issue_comments_522878.json:
```json
{
    "body": "Changed commit from **[`1b03f2b`](https://github.com/sagemath/sagetrac-mirror/commit/1b03f2bde68d5548d483c43157cc4795c4579e23)** to **[`76dc19c`](https://github.com/sagemath/sagetrac-mirror/commit/76dc19c9161051c52cf428dc666533a1cfbde013)**",
    "created_at": "2021-09-01T20:55:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522878",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`1b03f2b`](https://github.com/sagemath/sagetrac-mirror/commit/1b03f2bde68d5548d483c43157cc4795c4579e23)** to **[`76dc19c`](https://github.com/sagemath/sagetrac-mirror/commit/76dc19c9161051c52cf428dc666533a1cfbde013)**



---

archive/issue_comments_522879.json:
```json
{
    "body": "<div id=\"comment:31\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/76dc19c9161051c52cf428dc666533a1cfbde013\">76dc19c</a></td><td><code>use compiler triplet</code></td></tr></table>\n",
    "created_at": "2021-09-01T20:55:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522879",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:31"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/76dc19c9161051c52cf428dc666533a1cfbde013">76dc19c</a></td><td><code>use compiler triplet</code></td></tr></table>




---

archive/issue_comments_522880.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\ntesting on top of 9.5.beta0",
    "created_at": "2021-09-02T03:43:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522880",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:32" align="right">comment:32</div>

testing on top of 9.5.beta0



---

archive/issue_comments_522881.json:
```json
{
    "body": "Changed reviewer from **Matthias Koeppe, https://github.com/mkoeppe/sage/actions/runs/1176095684, https://github.com/mkoeppe/sage/actions/runs/1177591365, ...** to **Matthias Koeppe, https://github.com/mkoeppe/sage/actions/runs/1192736161, https://github.com/mkoeppe/sage/actions/runs/1192736162**",
    "created_at": "2021-09-02T03:43:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522881",
    "user": "https://github.com/mkoeppe"
}
```

Changed reviewer from **Matthias Koeppe, https://github.com/mkoeppe/sage/actions/runs/1176095684, https://github.com/mkoeppe/sage/actions/runs/1177591365, ...** to **Matthias Koeppe, https://github.com/mkoeppe/sage/actions/runs/1192736161, https://github.com/mkoeppe/sage/actions/runs/1192736162**



---

archive/issue_comments_522882.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nThe tests on Linux and macOS (https://github.com/mkoeppe/sage/actions/runs/1192736161 ) look normal. Note that they do not test `--enable-fat-binary` at all.\nUnchanged:  `centos-7-i386` gives SIGFPE while building dochtml. Reported in https://groups.google.com/g/sage-release/c/ocdEAV4pFMo/m/4BEdJZQ8BAAJ for 9.4.rc1 (and probably earlier).\n\nThe test on Cygwin (https://github.com/mkoeppe/sage/actions/runs/1192736162) uses `--enable-fat-binary`. Unchanged: It gives the same segfaults whenever plotting is used (https://github.com/mkoeppe/sage/runs/3506881828) that showed up in the previous betas.\n\nSo this seems safe to merge, but it remains unknown whether it helps at all. Some help from the people who build and test binaries is needed here.",
    "created_at": "2021-09-03T18:53:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522882",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:33" align="right">comment:33</div>

The tests on Linux and macOS (https://github.com/mkoeppe/sage/actions/runs/1192736161 ) look normal. Note that they do not test `--enable-fat-binary` at all.
Unchanged:  `centos-7-i386` gives SIGFPE while building dochtml. Reported in https://groups.google.com/g/sage-release/c/ocdEAV4pFMo/m/4BEdJZQ8BAAJ for 9.4.rc1 (and probably earlier).

The test on Cygwin (https://github.com/mkoeppe/sage/actions/runs/1192736162) uses `--enable-fat-binary`. Unchanged: It gives the same segfaults whenever plotting is used (https://github.com/mkoeppe/sage/runs/3506881828) that showed up in the previous betas.

So this seems safe to merge, but it remains unknown whether it helps at all. Some help from the people who build and test binaries is needed here.



---

archive/issue_comments_522883.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,3 +4,5 @@\n \n Related:\n - #32363 Rename configure option --enable-fat-binary to --enable-portable-binary\n+- #32434 Do not require AVX when building with `SAGE_FAT_BINARY`\n+\n``````\n",
    "created_at": "2021-09-25T19:28:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522883",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,3 +4,5 @@
 
 Related:
 - #32363 Rename configure option --enable-fat-binary to --enable-portable-binary
+- #32434 Do not require AVX when building with `SAGE_FAT_BINARY`
+
``````




---

archive/issue_comments_522884.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nlet's merge this then",
    "created_at": "2021-09-25T20:33:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522884",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:35" align="right">comment:35</div>

let's merge this then



---

archive/issue_events_447194.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-09-25T20:33:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447194"
}
```



---

archive/issue_events_447195.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-09-25T20:33:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447195"
}
```



---

archive/issue_comments_522885.json:
```json
{
    "body": "Changed reviewer from **Matthias Koeppe, https://github.com/mkoeppe/sage/actions/runs/1192736161, https://github.com/mkoeppe/sage/actions/runs/1192736162** to **Matthias Koeppe, Dima Pasechnik**",
    "created_at": "2021-09-25T20:33:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522885",
    "user": "https://github.com/dimpase"
}
```

Changed reviewer from **Matthias Koeppe, https://github.com/mkoeppe/sage/actions/runs/1192736161, https://github.com/mkoeppe/sage/actions/runs/1192736162** to **Matthias Koeppe, Dima Pasechnik**



---

archive/issue_comments_522886.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nSegfaults on OSX\n\n```\nsage: for i in range(0,n2):\n   A[i,i]=4*h2+1.\n   if i+1<n2: A[i,int(i+1)]=-h2\n   if i>0:    A[i,int(i-1)]=-h2\n   if i+n<n2: A[i,int(i+n)]=-h2\n   if i-n>=0: A[i,int(i-n)]=-h2 ## line 366 ##\nsage: Acsc = A.tocsc() ## line 372 ##\nsage: b = array([1 for i in range(0,n2)]) ## line 373 ##\nsage: solve = factorized(Acsc) # LU factorization ## line 374 ##\n------------------------------------------------------------------------\n0   signals.cpython-39-darwin.so        0x0000000103db93e2 print_backtrace + 66\n1   signals.cpython-39-darwin.so        0x0000000103dbd097 sigdie + 39\n2   signals.cpython-39-darwin.so        0x0000000103dbcf84 cysigs_signal_handler + 404\n3   libsystem_platform.dylib            0x00007fff7132b5fd _sigtramp + 29\n4   ???                                 0x0000000000000013 0x0 + 19\n------------------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred.\nThis probably occurred because a *compiled* module has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nPython will now terminate.\n------------------------------------------------------------------------\n**********************************************************************\n----------------------------------------------------------------------\nsage -t --long --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py  # Killed due to segmentation fault\n----------------------------------------------------------------------\n```",
    "created_at": "2021-10-07T22:30:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522886",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:36" align="right">comment:36</div>

Segfaults on OSX

```
sage: for i in range(0,n2):
   A[i,i]=4*h2+1.
   if i+1<n2: A[i,int(i+1)]=-h2
   if i>0:    A[i,int(i-1)]=-h2
   if i+n<n2: A[i,int(i+n)]=-h2
   if i-n>=0: A[i,int(i-n)]=-h2 ## line 366 ##
sage: Acsc = A.tocsc() ## line 372 ##
sage: b = array([1 for i in range(0,n2)]) ## line 373 ##
sage: solve = factorized(Acsc) # LU factorization ## line 374 ##
------------------------------------------------------------------------
0   signals.cpython-39-darwin.so        0x0000000103db93e2 print_backtrace + 66
1   signals.cpython-39-darwin.so        0x0000000103dbd097 sigdie + 39
2   signals.cpython-39-darwin.so        0x0000000103dbcf84 cysigs_signal_handler + 404
3   libsystem_platform.dylib            0x00007fff7132b5fd _sigtramp + 29
4   ???                                 0x0000000000000013 0x0 + 19
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
**********************************************************************
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py  # Killed due to segmentation fault
----------------------------------------------------------------------
```



---

archive/issue_events_447196.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-10-07T22:30:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447196"
}
```



---

archive/issue_events_447197.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-10-07T22:30:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447197"
}
```



---

archive/issue_comments_522887.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nObviously we need more detail about the platform",
    "created_at": "2021-10-07T22:59:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522887",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:37" align="right">comment:37</div>

Obviously we need more detail about the platform



---

archive/issue_comments_522888.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nIn the meantime 0.3.18 has come out",
    "created_at": "2021-10-07T23:00:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522888",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:38" align="right">comment:38</div>

In the meantime 0.3.18 has come out



---

archive/issue_comments_522889.json:
```json
{
    "body": "Changed commit from **[`76dc19c`](https://github.com/sagemath/sagetrac-mirror/commit/76dc19c9161051c52cf428dc666533a1cfbde013)** to **[`5d6f68b`](https://github.com/sagemath/sagetrac-mirror/commit/5d6f68b7edd2ed151dce45f4df0b7413b61efb00)**",
    "created_at": "2021-10-08T13:24:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522889",
    "user": "https://github.com/dimpase"
}
```

Changed commit from **[`76dc19c`](https://github.com/sagemath/sagetrac-mirror/commit/76dc19c9161051c52cf428dc666533a1cfbde013)** to **[`5d6f68b`](https://github.com/sagemath/sagetrac-mirror/commit/5d6f68b7edd2ed151dce45f4df0b7413b61efb00)**



---

archive/issue_comments_522890.json:
```json
{
    "body": "Changed branch from **[u/isuruf/openblas-target](https://github.com/sagemath/sagetrac-mirror/tree/u/isuruf/openblas-target)** to **[u/dimpase/packages/openblas/0.3.18](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/packages/openblas/0.3.18)**",
    "created_at": "2021-10-08T13:24:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522890",
    "user": "https://github.com/dimpase"
}
```

Changed branch from **[u/isuruf/openblas-target](https://github.com/sagemath/sagetrac-mirror/tree/u/isuruf/openblas-target)** to **[u/dimpase/packages/openblas/0.3.18](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/packages/openblas/0.3.18)**



---

archive/issue_events_447198.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-10-08T13:24:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447198"
}
```



---

archive/issue_events_447199.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-10-08T13:24:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447199"
}
```



---

archive/issue_comments_522891.json:
```json
{
    "body": "<div id=\"comment:39\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0ea5dc006fbc1256825546aa2cf4baa989967395\">0ea5dc0</a></td><td><code>set target for dynamic_arch</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/121dda1a3e38b8390db392fcf46039afee29d70f\">121dda1</a></td><td><code>AVX512 support is now much better</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d48c8ab7ad10bee813bfc168ce30044517dad0ac\">d48c8ab</a></td><td><code>build/pkgs/openblas: Update to 0.3.17</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d49adc02338fcb25e240ae9d310614ce5a929326\">d49adc0</a></td><td><code>use compiler triplet</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5d6f68b7edd2ed151dce45f4df0b7413b61efb00\">5d6f68b</a></td><td><code>version bump</code></td></tr></table>\n",
    "created_at": "2021-10-08T13:24:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522891",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:39"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0ea5dc006fbc1256825546aa2cf4baa989967395">0ea5dc0</a></td><td><code>set target for dynamic_arch</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/121dda1a3e38b8390db392fcf46039afee29d70f">121dda1</a></td><td><code>AVX512 support is now much better</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d48c8ab7ad10bee813bfc168ce30044517dad0ac">d48c8ab</a></td><td><code>build/pkgs/openblas: Update to 0.3.17</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d49adc02338fcb25e240ae9d310614ce5a929326">d49adc0</a></td><td><code>use compiler triplet</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5d6f68b7edd2ed151dce45f4df0b7413b61efb00">5d6f68b</a></td><td><code>version bump</code></td></tr></table>




---

archive/issue_comments_522892.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nupdate to 0.3.18",
    "created_at": "2021-10-08T13:25:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522892",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:40" align="right">comment:40</div>

update to 0.3.18



---

archive/issue_events_447200.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-10-08T16:02:18Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "title_is": "Upgrade to OpenBLAS 0.3.18 and make Sage fat binaries portable",
    "title_was": "Upgrade to OpenBLAS 0.3.17 and make Sage fat binaries portable",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447200"
}
```



---

archive/issue_events_447201.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-10-14T11:55:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447201"
}
```



---

archive/issue_events_447202.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-10-14T11:55:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447202"
}
```



---

archive/issue_comments_522893.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nlet's get this in, see if it helps with that not easy to reproduce bug.",
    "created_at": "2021-10-14T11:55:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522893",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:42" align="right">comment:42</div>

let's get this in, see if it helps with that not easy to reproduce bug.



---

archive/issue_comments_522894.json:
```json
{
    "body": "Changed branch from **[u/dimpase/packages/openblas/0.3.18](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/packages/openblas/0.3.18)** to **[`5d6f68b`](https://github.com/sagemath/sagetrac-mirror/commit/5d6f68b7edd2ed151dce45f4df0b7413b61efb00)**",
    "created_at": "2021-10-20T23:01:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522894",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/dimpase/packages/openblas/0.3.18](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/packages/openblas/0.3.18)** to **[`5d6f68b`](https://github.com/sagemath/sagetrac-mirror/commit/5d6f68b7edd2ed151dce45f4df0b7413b61efb00)**



---

archive/issue_events_447203.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-10-20T23:01:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447203"
}
```



---

archive/issue_events_447204.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-10-20T23:01:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447204"
}
```



---

archive/issue_comments_522895.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nstill segfaults on mac in the same spot",
    "created_at": "2021-10-23T09:19:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522895",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:44" align="right">comment:44</div>

still segfaults on mac in the same spot



---

archive/issue_comments_522896.json:
```json
{
    "body": "Changed branch from **[`5d6f68b`](https://github.com/sagemath/sagetrac-mirror/commit/5d6f68b7edd2ed151dce45f4df0b7413b61efb00)** to **[u/dimpase/packages/openblas/0.3.18](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/packages/openblas/0.3.18)**",
    "created_at": "2021-10-23T09:19:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522896",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[`5d6f68b`](https://github.com/sagemath/sagetrac-mirror/commit/5d6f68b7edd2ed151dce45f4df0b7413b61efb00)** to **[u/dimpase/packages/openblas/0.3.18](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/packages/openblas/0.3.18)**



---

archive/issue_comments_522897.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nare you unmerging this ticket? it is a valid update, no regressions, right?",
    "created_at": "2021-10-23T09:31:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522897",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:45" align="right">comment:45</div>

are you unmerging this ticket? it is a valid update, no regressions, right?



---

archive/issue_comments_522898.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nThere is a regression, this used to work and is now segfaulting on osx:\n\n```\n>>> solve = factorized(Acsc) # LU factorization\nProcess 56588 stopped\n* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x0)\n    frame #0: 0x0000000107d55588 libopenblas_penrynp-r0.3.18.dylib`.L01\nlibopenblas_penrynp-r0.3.18.dylib`.L01:\n->  0x107d55588 <+0>:  movaps %xmm4, (%rbp)\n    0x107d5558c <+4>:  movaps %xmm4, 0x10(%rbp)\n    0x107d55590 <+8>:  movaps %xmm4, 0x20(%rbp)\n    0x107d55594 <+12>: movaps %xmm4, 0x30(%rbp)\nTarget 0: (python3) stopped.\n```",
    "created_at": "2021-10-23T14:06:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522898",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:46" align="right">comment:46</div>

There is a regression, this used to work and is now segfaulting on osx:

```
>>> solve = factorized(Acsc) # LU factorization
Process 56588 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x0)
    frame #0: 0x0000000107d55588 libopenblas_penrynp-r0.3.18.dylib`.L01
libopenblas_penrynp-r0.3.18.dylib`.L01:
->  0x107d55588 <+0>:  movaps %xmm4, (%rbp)
    0x107d5558c <+4>:  movaps %xmm4, 0x10(%rbp)
    0x107d55590 <+8>:  movaps %xmm4, 0x20(%rbp)
    0x107d55594 <+12>: movaps %xmm4, 0x30(%rbp)
Target 0: (python3) stopped.
```



---

archive/issue_comments_522899.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\nBuilding Sage with\n\n```\nOPENBLAS_CONFIGURE=\"TARGET=PENRYN DEBUG=1 USE_OPENMP=0\" make\n```\nworks, so its apparently a threading-related issue. Kinda guessed that from the messed up stack trace, seems to be in a thread thats not doing so well.",
    "created_at": "2021-10-24T09:27:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522899",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:47" align="right">comment:47</div>

Building Sage with

```
OPENBLAS_CONFIGURE="TARGET=PENRYN DEBUG=1 USE_OPENMP=0" make
```
works, so its apparently a threading-related issue. Kinda guessed that from the messed up stack trace, seems to be in a thread thats not doing so well.



---

archive/issue_comments_522900.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\nPossibly related: https://github.com/xianyi/OpenBLAS/issues/2787",
    "created_at": "2021-10-24T10:36:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522900",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:48" align="right">comment:48</div>

Possibly related: https://github.com/xianyi/OpenBLAS/issues/2787



---

archive/issue_comments_522901.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\nReplying to [@vbraun](#comment:46):\n> There is a regression, this used to work and is now segfaulting on osx:\n\nVolker, more details please: \n\n* was OpenBLAS built from source? \n* On what version of macOS? \n* On what CPU?",
    "created_at": "2021-10-26T07:48:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522901",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:49" align="right">comment:49</div>

Replying to [@vbraun](#comment:46):
> There is a regression, this used to work and is now segfaulting on osx:

Volker, more details please: 

* was OpenBLAS built from source? 
* On what version of macOS? 
* On what CPU?



---

archive/issue_events_447205.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-10-26T07:52:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447205"
}
```



---

archive/issue_comments_522902.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nI'm running full builds; Does the following work for you? For me, it segfaults:\n\n```\nmake distclean\nOPENBLAS_CONFIGURE=\"TARGET=PENRYN\" make -j10\nsage -t --long --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py\n```\nBoth Catalina and BigSur. CPU is qemu64 (lowest-common denominator, which is why openblas picks Penryn).",
    "created_at": "2021-10-26T19:36:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522902",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:51" align="right">comment:51</div>

I'm running full builds; Does the following work for you? For me, it segfaults:

```
make distclean
OPENBLAS_CONFIGURE="TARGET=PENRYN" make -j10
sage -t --long --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py
```
Both Catalina and BigSur. CPU is qemu64 (lowest-common denominator, which is why openblas picks Penryn).



---

archive/issue_comments_522903.json:
```json
{
    "body": "<div id=\"comment:52\" align=\"right\">comment:52</div>\n\nhmm, so it's a qemu64 running macOS on a Mac? \n\nOr a hackintosh, i.e. qemu running macOS on Linux?\n\nHow is this a meaningful test, and not testing the resolve of Apple to prevent \"illegal\" macOS emulators?",
    "created_at": "2021-10-26T20:44:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522903",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:52" align="right">comment:52</div>

hmm, so it's a qemu64 running macOS on a Mac? 

Or a hackintosh, i.e. qemu running macOS on Linux?

How is this a meaningful test, and not testing the resolve of Apple to prevent "illegal" macOS emulators?



---

archive/issue_comments_522904.json:
```json
{
    "body": "<div id=\"comment:53\" align=\"right\">comment:53</div>\n\nReplying to [@vbraun](#comment:51):\n> I'm running full builds; Does the following work for you? For me, it segfaults:\n> \n> ```\n> make distclean\n> OPENBLAS_CONFIGURE=\"TARGET=PENRYN\" make -j10\n> sage -t --long --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py\n> ```\n\nVolker, this recipe is wildly underspecified. When you post failures like this, could you please attach at least the `config.log` and the build log of the package?",
    "created_at": "2021-10-26T21:04:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522904",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:53" align="right">comment:53</div>

Replying to [@vbraun](#comment:51):
> I'm running full builds; Does the following work for you? For me, it segfaults:
> 
> ```
> make distclean
> OPENBLAS_CONFIGURE="TARGET=PENRYN" make -j10
> sage -t --long --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py
> ```

Volker, this recipe is wildly underspecified. When you post failures like this, could you please attach at least the `config.log` and the build log of the package?



---

archive/issue_comments_522905.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">comment:54</div>\n\nIt currently works and an openblas update breaks it, for once thats not going to be Apple's fault.\n\nBTW you have an account on `catalina-osx`, too ;)",
    "created_at": "2021-10-26T21:04:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522905",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:54" align="right">comment:54</div>

It currently works and an openblas update breaks it, for once thats not going to be Apple's fault.

BTW you have an account on `catalina-osx`, too ;)



---

archive/issue_comments_522906.json:
```json
{
    "body": "<div id=\"comment:55\" align=\"right\">comment:55</div>\n\nCan we split the two things in this ticket?\n\nFixing fat binaries and upgrading openblas?",
    "created_at": "2021-10-26T21:06:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522906",
    "user": "https://github.com/isuruf"
}
```

<div id="comment:55" align="right">comment:55</div>

Can we split the two things in this ticket?

Fixing fat binaries and upgrading openblas?



---

archive/issue_comments_522907.json:
```json
{
    "body": "<div id=\"comment:56\" align=\"right\">comment:56</div>\n\nReplying to [@vbraun](#comment:54):\n> It currently works and an openblas update breaks it, for once thats not going to be Apple's fault.\n> \n\nyou might be just hitting a deficiency in your Hackingtosh, not a real bug.\n\n \n\n> BTW you have an account on `catalina-osx`, too ;)",
    "created_at": "2021-10-27T22:40:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522907",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:56" align="right">comment:56</div>

Replying to [@vbraun](#comment:54):
> It currently works and an openblas update breaks it, for once thats not going to be Apple's fault.
> 

you might be just hitting a deficiency in your Hackingtosh, not a real bug.

 

> BTW you have an account on `catalina-osx`, too ;)



---

archive/issue_comments_522908.json:
```json
{
    "body": "<div id=\"comment:57\" align=\"right\">comment:57</div>\n\nLogs are here: http://sagepad.org/pub/sage/32424/",
    "created_at": "2021-10-28T22:37:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522908",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:57" align="right">comment:57</div>

Logs are here: http://sagepad.org/pub/sage/32424/



---

archive/issue_comments_522909.json:
```json
{
    "body": "<div id=\"comment:58\" align=\"right\">comment:58</div>\n\nfrom config.log one can see you have another OpenBLAS installed on the box \n(pkg-config finds it)\n\nCan you, just as a sanitary check,  uninstall it and check that you can reproduce the crash?",
    "created_at": "2021-10-29T12:46:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522909",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:58" align="right">comment:58</div>

from config.log one can see you have another OpenBLAS installed on the box 
(pkg-config finds it)

Can you, just as a sanitary check,  uninstall it and check that you can reproduce the crash?



---

archive/issue_comments_522910.json:
```json
{
    "body": "<div id=\"comment:59\" align=\"right\">comment:59</div>\n\nI don't have another openblas; it seems the configure prints `configure:12750: result: openblas` by default even if you don't have any blas:\n\n```\n  12734 # Check whether --with-blas was given.\n  12735 if test \"${with_blas+set}\" = set; then :\n  12736   withval=$with_blas;\n  12737 else\n  12738   with_blas=openblas  # default\n  12739 \n  12740 fi\n  12741 \n  12742   case \"$with_blas\" in #(\n  12743   openblas) :\n  12744      ;; #(\n  12745   atlas) :\n  12746     sage_spkg_install_openblas=no ;; #(\n  12747   *) :\n  12748     as_fn_error $? \"allowed values for --with-blas are 'atlas' and 'openblas'\" \"$LINENO\" 5 ;;\n  12749 esac\n  12750   { $as_echo \"$as_me:${as_lineno-$LINENO}: result: $with_blas\" >&5\n```",
    "created_at": "2021-10-29T23:08:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522910",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:59" align="right">comment:59</div>

I don't have another openblas; it seems the configure prints `configure:12750: result: openblas` by default even if you don't have any blas:

```
  12734 # Check whether --with-blas was given.
  12735 if test "${with_blas+set}" = set; then :
  12736   withval=$with_blas;
  12737 else
  12738   with_blas=openblas  # default
  12739 
  12740 fi
  12741 
  12742   case "$with_blas" in #(
  12743   openblas) :
  12744      ;; #(
  12745   atlas) :
  12746     sage_spkg_install_openblas=no ;; #(
  12747   *) :
  12748     as_fn_error $? "allowed values for --with-blas are 'atlas' and 'openblas'" "$LINENO" 5 ;;
  12749 esac
  12750   { $as_echo "$as_me:${as_lineno-$LINENO}: result: $with_blas" >&5
```



---

archive/issue_comments_522911.json:
```json
{
    "body": "<div id=\"comment:60\" align=\"right\">comment:60</div>\n\nmaybe it needs gfortran 11?",
    "created_at": "2021-10-30T11:11:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522911",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:60" align="right">comment:60</div>

maybe it needs gfortran 11?



---

archive/issue_comments_522912.json:
```json
{
    "body": "<div id=\"comment:61\" align=\"right\">comment:61</div>\n\nalso, one might need more details on the hist CPU and how qemu is started/configured.",
    "created_at": "2021-10-30T11:13:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522912",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:61" align="right">comment:61</div>

also, one might need more details on the hist CPU and how qemu is started/configured.



---

archive/issue_comments_522913.json:
```json
{
    "body": "Changed branch from **[u/dimpase/packages/openblas/0.3.18](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/packages/openblas/0.3.18)** to **[u/mkoeppe/packages/openblas/0.3.18](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/packages/openblas/0.3.18)**",
    "created_at": "2021-10-30T19:33:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522913",
    "user": "https://github.com/mkoeppe"
}
```

Changed branch from **[u/dimpase/packages/openblas/0.3.18](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/packages/openblas/0.3.18)** to **[u/mkoeppe/packages/openblas/0.3.18](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/packages/openblas/0.3.18)**



---

archive/issue_comments_522914.json:
```json
{
    "body": "Changed commit from **[`5d6f68b`](https://github.com/sagemath/sagetrac-mirror/commit/5d6f68b7edd2ed151dce45f4df0b7413b61efb00)** to **[`18044f3`](https://github.com/sagemath/sagetrac-mirror/commit/18044f326508a898561fb787a902279b1a527ee6)**",
    "created_at": "2021-10-30T19:35:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522914",
    "user": "https://github.com/mkoeppe"
}
```

Changed commit from **[`5d6f68b`](https://github.com/sagemath/sagetrac-mirror/commit/5d6f68b7edd2ed151dce45f4df0b7413b61efb00)** to **[`18044f3`](https://github.com/sagemath/sagetrac-mirror/commit/18044f326508a898561fb787a902279b1a527ee6)**



---

archive/issue_comments_522915.json:
```json
{
    "body": "<div id=\"comment:63\" align=\"right\">comment:63</div>\n\nReplying to [@mkoeppe](#comment:53):\n> Replying to [@vbraun](#comment:51):\n> > I'm running full builds; Does the following work for you? For me, it segfaults:\n> > \n> > ```\n> > make distclean\n> > OPENBLAS_CONFIGURE=\"TARGET=PENRYN\" make -j10\n> > sage -t --long --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py\n> > ```\n\nBased on the provided logs, I have built a similar configuration using `OPENBLAS_CONFIGURE=TARGET=PENRYN tox -e local-macos-nohomebrew -- bash` on a real Mac (Intelr Core i9, Big Sur). The tests pass.\n\nI'll try again now after merging 9.5.beta5.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/143e90728caf2c225d09da801f13d9d9cbc20f1a\">143e907</a></td><td><code>tox.ini (local): passenv OPENBLAS_CONFIGURE</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/18044f326508a898561fb787a902279b1a527ee6\">18044f3</a></td><td><code>Merge tag '9.5.beta5' into t/32424/openblas-target</code></td></tr></table>\n",
    "created_at": "2021-10-30T19:35:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522915",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:63" align="right">comment:63</div>

Replying to [@mkoeppe](#comment:53):
> Replying to [@vbraun](#comment:51):
> > I'm running full builds; Does the following work for you? For me, it segfaults:
> > 
> > ```
> > make distclean
> > OPENBLAS_CONFIGURE="TARGET=PENRYN" make -j10
> > sage -t --long --random-seed=0 src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py
> > ```

Based on the provided logs, I have built a similar configuration using `OPENBLAS_CONFIGURE=TARGET=PENRYN tox -e local-macos-nohomebrew -- bash` on a real Mac (Intelr Core i9, Big Sur). The tests pass.

I'll try again now after merging 9.5.beta5.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/143e90728caf2c225d09da801f13d9d9cbc20f1a">143e907</a></td><td><code>tox.ini (local): passenv OPENBLAS_CONFIGURE</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/18044f326508a898561fb787a902279b1a527ee6">18044f3</a></td><td><code>Merge tag '9.5.beta5' into t/32424/openblas-target</code></td></tr></table>




---

archive/issue_comments_522916.json:
```json
{
    "body": "<div id=\"comment:64\" align=\"right\">comment:64</div>\n\nVolker, I'd suggest that you take the problem on your configuration upstream by trying to reproduce it outside of Sage.",
    "created_at": "2021-10-30T19:38:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522916",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:64" align="right">comment:64</div>

Volker, I'd suggest that you take the problem on your configuration upstream by trying to reproduce it outside of Sage.



---

archive/issue_comments_522917.json:
```json
{
    "body": "<div id=\"comment:65\" align=\"right\">comment:65</div>\n\nReplying to [@mkoeppe](#comment:63):\n> I'll try again now after merging 9.5.beta5.\n\nSame result, all good.",
    "created_at": "2021-10-30T21:29:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522917",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:65" align="right">comment:65</div>

Replying to [@mkoeppe](#comment:63):
> I'll try again now after merging 9.5.beta5.

Same result, all good.



---

archive/issue_events_447206.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-10-31T20:37:24Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447206"
}
```



---

archive/issue_events_447207.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-10-31T20:37:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447207"
}
```



---

archive/issue_events_447208.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-10-31T21:55:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447208"
}
```



---

archive/issue_events_447209.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-10-31T21:55:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447209"
}
```



---

archive/issue_comments_522918.json:
```json
{
    "body": "<div id=\"comment:68\" align=\"right\">comment:68</div>\n\nSomething is definitely not right. Its not just TARGET=PENRYN, with that it also works for me.",
    "created_at": "2021-10-31T21:56:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522918",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:68" align="right">comment:68</div>

Something is definitely not right. Its not just TARGET=PENRYN, with that it also works for me.



---

archive/issue_comments_522919.json:
```json
{
    "body": "<div id=\"comment:69\" align=\"right\">comment:69</div>\n\nSo what is the configuration that fails for you?",
    "created_at": "2021-10-31T21:57:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522919",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:69" align="right">comment:69</div>

So what is the configuration that fails for you?



---

archive/issue_comments_522920.json:
```json
{
    "body": "<div id=\"comment:70\" align=\"right\">comment:70</div>\n\nThis is the Makefile.conf that segfaults:\n\n```\nOSNAME=Darwin\nARCH=x86_64\nC_COMPILER=CLANG\nBINARY32=\nBINARY64=1\nFU=_\nCEXTRALIB=-L/Users/vbraun/Sage/local/lib -L/usr/local/lib  -lto_library -lSystem  /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/12.0.0/lib/darwin/libclang_rt.osx.a \nF_COMPILER=GFORTRAN\nFC=gfortran\nBU=_\nFEXTRALIB=-L/Users/vbraun/Sage/local/lib -L/Users/vbraun/Sage/local/lib/gcc/x86_64-apple-darwin19.6.0/10.3.0 -L/Users/vbraun/Sage/local/lib/gcc/x86_64-apple-darwin19.6.0/10.3.0/../../.. -L/Users/vbraun/Sage/local/lib -L/Users/vbraun/Sage/local/lib/gcc/x86_64-apple-darwin19.6.0/10.3.0 -L/Users/vbraun/Sage/local/lib/gcc/x86_64-apple-darwin19.6.0/10.3.0/../../..  -lgfortran -lSystem -lquadmath -lm -lSystem -lgfortran -lSystem -lquadmath -lm -lSystem  \nCORE=PENRYN\nLIBCORE=penryn\nNUM_CORES=8\nHAVE_MMX=1\nHAVE_SSE=1\nHAVE_SSE2=1\nHAVE_SSE3=1\nHAVE_SSSE3=1\nHAVE_SSE4_1=1\nHAVE_SSE4_2=1\nHAVE_AVX=1\nMAKE += -j 8\nSBGEMM_UNROLL_M=8\nSBGEMM_UNROLL_N=4\nSGEMM_UNROLL_M=8\nSGEMM_UNROLL_N=4\nDGEMM_UNROLL_M=4\nDGEMM_UNROLL_N=4\nQGEMM_UNROLL_M=2\nQGEMM_UNROLL_N=2\nCGEMM_UNROLL_M=4\nCGEMM_UNROLL_N=2\nZGEMM_UNROLL_M=2\nZGEMM_UNROLL_N=2\nXGEMM_UNROLL_M=1\nXGEMM_UNROLL_N=1\nCGEMM3M_UNROLL_M=8\nCGEMM3M_UNROLL_N=4\nZGEMM3M_UNROLL_M=4\nZGEMM3M_UNROLL_N=4\nXGEMM3M_UNROLL_M=2\nXGEMM3M_UNROLL_N=2\n```",
    "created_at": "2021-10-31T21:59:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522920",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:70" align="right">comment:70</div>

This is the Makefile.conf that segfaults:

```
OSNAME=Darwin
ARCH=x86_64
C_COMPILER=CLANG
BINARY32=
BINARY64=1
FU=_
CEXTRALIB=-L/Users/vbraun/Sage/local/lib -L/usr/local/lib  -lto_library -lSystem  /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/12.0.0/lib/darwin/libclang_rt.osx.a 
F_COMPILER=GFORTRAN
FC=gfortran
BU=_
FEXTRALIB=-L/Users/vbraun/Sage/local/lib -L/Users/vbraun/Sage/local/lib/gcc/x86_64-apple-darwin19.6.0/10.3.0 -L/Users/vbraun/Sage/local/lib/gcc/x86_64-apple-darwin19.6.0/10.3.0/../../.. -L/Users/vbraun/Sage/local/lib -L/Users/vbraun/Sage/local/lib/gcc/x86_64-apple-darwin19.6.0/10.3.0 -L/Users/vbraun/Sage/local/lib/gcc/x86_64-apple-darwin19.6.0/10.3.0/../../..  -lgfortran -lSystem -lquadmath -lm -lSystem -lgfortran -lSystem -lquadmath -lm -lSystem  
CORE=PENRYN
LIBCORE=penryn
NUM_CORES=8
HAVE_MMX=1
HAVE_SSE=1
HAVE_SSE2=1
HAVE_SSE3=1
HAVE_SSSE3=1
HAVE_SSE4_1=1
HAVE_SSE4_2=1
HAVE_AVX=1
MAKE += -j 8
SBGEMM_UNROLL_M=8
SBGEMM_UNROLL_N=4
SGEMM_UNROLL_M=8
SGEMM_UNROLL_N=4
DGEMM_UNROLL_M=4
DGEMM_UNROLL_N=4
QGEMM_UNROLL_M=2
QGEMM_UNROLL_N=2
CGEMM_UNROLL_M=4
CGEMM_UNROLL_N=2
ZGEMM_UNROLL_M=2
ZGEMM_UNROLL_N=2
XGEMM_UNROLL_M=1
XGEMM_UNROLL_N=1
CGEMM3M_UNROLL_M=8
CGEMM3M_UNROLL_N=4
ZGEMM3M_UNROLL_M=4
ZGEMM3M_UNROLL_N=4
XGEMM3M_UNROLL_M=2
XGEMM3M_UNROLL_N=2
```



---

archive/issue_comments_522921.json:
```json
{
    "body": "<div id=\"comment:71\" align=\"right\">comment:71</div>\n\nThe build log is identical to one with `OPENBLAS_CONFIGURE=\"TARGET=PENRYN HAVE_AVX=1\"` except that the latter doesn't segfault, so it must be in the config.h value",
    "created_at": "2021-10-31T22:05:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522921",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:71" align="right">comment:71</div>

The build log is identical to one with `OPENBLAS_CONFIGURE="TARGET=PENRYN HAVE_AVX=1"` except that the latter doesn't segfault, so it must be in the config.h value



---

archive/issue_comments_522922.json:
```json
{
    "body": "<div id=\"comment:72\" align=\"right\">comment:72</div>\n\nconfig.h:\n\n```\n#define OS_DARWIN\t1\n#define ARCH_X86_64\t1\n#define C_CLANG\t1\n#define __64BIT__\t1\n#define FUNDERSCORE\t_\n#define HAVE_C11\t1\n#define PTHREAD_CREATE_FUNC\tpthread_create\n#define BUNDERSCORE\t_\n#define NEEDBUNDERSCORE\t1\n#define PENRYN\n#define L1_CODE_SIZE 32768\n#define L1_CODE_ASSOCIATIVE 8\n#define L1_CODE_LINESIZE 64\n#define L1_DATA_SIZE 32768\n#define L1_DATA_ASSOCIATIVE 8\n#define L1_DATA_LINESIZE 64\n#define L2_SIZE 2097152\n#define L2_ASSOCIATIVE 8\n#define L2_LINESIZE 64\n#define L3_SIZE 16777216\n#define L3_ASSOCIATIVE 16\n#define L3_LINESIZE 64\n#define DTB_DEFAULT_ENTRIES 32\n#define HAVE_CMOV\n#define HAVE_MMX\n#define HAVE_SSE\n#define HAVE_SSE2\n#define HAVE_SSE3\n#define HAVE_SSSE3\n#define HAVE_SSE4_1\n#define HAVE_SSE4_2\n#define HAVE_AVX\n#define HAVE_CFLUSH\n#define NUM_SHAREDCACHE 1\n#define NUM_CORES 1\n#define CORE_PENRYN\n#define CHAR_CORENAME \"PENRYN\"\n#define SLOCAL_BUFFER_SIZE\t32768\n#define DLOCAL_BUFFER_SIZE\t16384\n#define CLOCAL_BUFFER_SIZE\t32768\n#define ZLOCAL_BUFFER_SIZE\t16384\n#define GEMM_MULTITHREAD_THRESHOLD\t4\n```",
    "created_at": "2021-10-31T22:07:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522922",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:72" align="right">comment:72</div>

config.h:

```
#define OS_DARWIN	1
#define ARCH_X86_64	1
#define C_CLANG	1
#define __64BIT__	1
#define FUNDERSCORE	_
#define HAVE_C11	1
#define PTHREAD_CREATE_FUNC	pthread_create
#define BUNDERSCORE	_
#define NEEDBUNDERSCORE	1
#define PENRYN
#define L1_CODE_SIZE 32768
#define L1_CODE_ASSOCIATIVE 8
#define L1_CODE_LINESIZE 64
#define L1_DATA_SIZE 32768
#define L1_DATA_ASSOCIATIVE 8
#define L1_DATA_LINESIZE 64
#define L2_SIZE 2097152
#define L2_ASSOCIATIVE 8
#define L2_LINESIZE 64
#define L3_SIZE 16777216
#define L3_ASSOCIATIVE 16
#define L3_LINESIZE 64
#define DTB_DEFAULT_ENTRIES 32
#define HAVE_CMOV
#define HAVE_MMX
#define HAVE_SSE
#define HAVE_SSE2
#define HAVE_SSE3
#define HAVE_SSSE3
#define HAVE_SSE4_1
#define HAVE_SSE4_2
#define HAVE_AVX
#define HAVE_CFLUSH
#define NUM_SHAREDCACHE 1
#define NUM_CORES 1
#define CORE_PENRYN
#define CHAR_CORENAME "PENRYN"
#define SLOCAL_BUFFER_SIZE	32768
#define DLOCAL_BUFFER_SIZE	16384
#define CLOCAL_BUFFER_SIZE	32768
#define ZLOCAL_BUFFER_SIZE	16384
#define GEMM_MULTITHREAD_THRESHOLD	4
```



---

archive/issue_comments_522923.json:
```json
{
    "body": "<div id=\"comment:73\" align=\"right\">comment:73</div>\n\nMy configuration (works): \n\nMakefile.conf:\n\n```\nOSNAME=Darwin\nARCH=x86_64\nC_COMPILER=CLANG\nBINARY32=\nBINARY64=1\nFU=_\nCEXTRALIB=-L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib  -lto_library -lSystem  /Library/Developer/CommandLineTools/usr/lib/clang/13.0.0/lib/darwin/libclang_rt.osx.a \nF_COMPILER=GFORTRAN\nFC=gfortran\nBU=_\nFEXTRALIB=-L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib/gcc/x86_64-apple-darwin20.6.0/10.3.0 -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib/gcc/x86_64-apple-darwin20.6.0/10.3.0/../../.. -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib/gcc/x86_64-apple-darwin20.6.0/10.3.0 -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib/gcc/x86_64-apple-darwin20.6.0/10.3.0/../../..  -lgfortran -lSystem -lquadmath -lm -lSystem -lgfortran -lSystem -lquadmath -lm -lSystem  \nCORE=PENRYN\nLIBCORE=penryn\nNUM_CORES=12\nPENRYN=1\nL1_DATA_SIZE=32768\nL1_DATA_LINESIZE=64\nL2_SIZE=1048576\nL2_LINESIZE=64\nDTB_DEFAULT_ENTRIES=256\nDTB_SIZE=4096\nHAVE_CMOV=1\nHAVE_MMX=1\nHAVE_SSE=1\nHAVE_SSE2=1\nHAVE_SSE3=1\nHAVE_SSSE3=1\nHAVE_SSE4_1=1\nMAKE += -j 12\nSBGEMM_UNROLL_M=8\nSBGEMM_UNROLL_N=4\nSGEMM_UNROLL_M=8\nSGEMM_UNROLL_N=4\nDGEMM_UNROLL_M=4\nDGEMM_UNROLL_N=4\nQGEMM_UNROLL_M=2\nQGEMM_UNROLL_N=2\nCGEMM_UNROLL_M=4\nCGEMM_UNROLL_N=2\nZGEMM_UNROLL_M=2\nZGEMM_UNROLL_N=2\nXGEMM_UNROLL_M=1\nXGEMM_UNROLL_N=1\nCGEMM3M_UNROLL_M=8\nCGEMM3M_UNROLL_N=4\nZGEMM3M_UNROLL_M=4\nZGEMM3M_UNROLL_N=4\nXGEMM3M_UNROLL_M=2\nXGEMM3M_UNROLL_N=2\n```\n\n\nconfig.h:\n\n```\n#define OS_DARWIN\t1\n#define ARCH_X86_64\t1\n#define C_CLANG\t1\n#define __64BIT__\t1\n#define FUNDERSCORE\t_\n#define HAVE_C11\t1\n#define PTHREAD_CREATE_FUNC\tpthread_create\n#define BUNDERSCORE\t_\n#define NEEDBUNDERSCORE\t1\n#define PENRYN\n#define L1_DATA_SIZE 32768\n#define L1_DATA_LINESIZE 64\n#define L2_SIZE 1048576\n#define L2_LINESIZE 64\n#define DTB_DEFAULT_ENTRIES 256\n#define DTB_SIZE 4096\n#define HAVE_CMOV\n#define HAVE_MMX\n#define HAVE_SSE\n#define HAVE_SSE2\n#define HAVE_SSE3\n#define HAVE_SSSE3\n#define HAVE_SSE4_1\n#define CORE_PENRYN\n#define CHAR_CORENAME \"PENRYN\"\n#define SLOCAL_BUFFER_SIZE\t32768\n#define DLOCAL_BUFFER_SIZE\t16384\n#define CLOCAL_BUFFER_SIZE\t32768\n#define ZLOCAL_BUFFER_SIZE\t16384\n#define GEMM_MULTITHREAD_THRESHOLD\t4\n```",
    "created_at": "2021-10-31T22:15:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522923",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:73" align="right">comment:73</div>

My configuration (works): 

Makefile.conf:

```
OSNAME=Darwin
ARCH=x86_64
C_COMPILER=CLANG
BINARY32=
BINARY64=1
FU=_
CEXTRALIB=-L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib  -lto_library -lSystem  /Library/Developer/CommandLineTools/usr/lib/clang/13.0.0/lib/darwin/libclang_rt.osx.a 
F_COMPILER=GFORTRAN
FC=gfortran
BU=_
FEXTRALIB=-L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib/gcc/x86_64-apple-darwin20.6.0/10.3.0 -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib/gcc/x86_64-apple-darwin20.6.0/10.3.0/../../.. -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib/gcc/x86_64-apple-darwin20.6.0/10.3.0 -L/Users/mkoeppe/s/sage/sage-rebasing/.tox/local-macos-nohomebrew/local/lib/gcc/x86_64-apple-darwin20.6.0/10.3.0/../../..  -lgfortran -lSystem -lquadmath -lm -lSystem -lgfortran -lSystem -lquadmath -lm -lSystem  
CORE=PENRYN
LIBCORE=penryn
NUM_CORES=12
PENRYN=1
L1_DATA_SIZE=32768
L1_DATA_LINESIZE=64
L2_SIZE=1048576
L2_LINESIZE=64
DTB_DEFAULT_ENTRIES=256
DTB_SIZE=4096
HAVE_CMOV=1
HAVE_MMX=1
HAVE_SSE=1
HAVE_SSE2=1
HAVE_SSE3=1
HAVE_SSSE3=1
HAVE_SSE4_1=1
MAKE += -j 12
SBGEMM_UNROLL_M=8
SBGEMM_UNROLL_N=4
SGEMM_UNROLL_M=8
SGEMM_UNROLL_N=4
DGEMM_UNROLL_M=4
DGEMM_UNROLL_N=4
QGEMM_UNROLL_M=2
QGEMM_UNROLL_N=2
CGEMM_UNROLL_M=4
CGEMM_UNROLL_N=2
ZGEMM_UNROLL_M=2
ZGEMM_UNROLL_N=2
XGEMM_UNROLL_M=1
XGEMM_UNROLL_N=1
CGEMM3M_UNROLL_M=8
CGEMM3M_UNROLL_N=4
ZGEMM3M_UNROLL_M=4
ZGEMM3M_UNROLL_N=4
XGEMM3M_UNROLL_M=2
XGEMM3M_UNROLL_N=2
```


config.h:

```
#define OS_DARWIN	1
#define ARCH_X86_64	1
#define C_CLANG	1
#define __64BIT__	1
#define FUNDERSCORE	_
#define HAVE_C11	1
#define PTHREAD_CREATE_FUNC	pthread_create
#define BUNDERSCORE	_
#define NEEDBUNDERSCORE	1
#define PENRYN
#define L1_DATA_SIZE 32768
#define L1_DATA_LINESIZE 64
#define L2_SIZE 1048576
#define L2_LINESIZE 64
#define DTB_DEFAULT_ENTRIES 256
#define DTB_SIZE 4096
#define HAVE_CMOV
#define HAVE_MMX
#define HAVE_SSE
#define HAVE_SSE2
#define HAVE_SSE3
#define HAVE_SSSE3
#define HAVE_SSE4_1
#define CORE_PENRYN
#define CHAR_CORENAME "PENRYN"
#define SLOCAL_BUFFER_SIZE	32768
#define DLOCAL_BUFFER_SIZE	16384
#define CLOCAL_BUFFER_SIZE	32768
#define ZLOCAL_BUFFER_SIZE	16384
#define GEMM_MULTITHREAD_THRESHOLD	4
```



---

archive/issue_comments_522924.json:
```json
{
    "body": "<div id=\"comment:74\" align=\"right\">comment:74</div>\n\nReplying to [@vbraun](#comment:71):\n> The build log is identical to one with `OPENBLAS_CONFIGURE=\"TARGET=PENRYN HAVE_AVX=1\"` except that the latter doesn't segfault, so it must be in the config.h value\n\nThe files that you showed in [comment:70](#comment:70), [comment:72](#comment:72) have HAVE_AVX, so what's going on?",
    "created_at": "2021-10-31T22:20:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522924",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:74" align="right">comment:74</div>

Replying to [@vbraun](#comment:71):
> The build log is identical to one with `OPENBLAS_CONFIGURE="TARGET=PENRYN HAVE_AVX=1"` except that the latter doesn't segfault, so it must be in the config.h value

The files that you showed in [comment:70](#comment:70), [comment:72](#comment:72) have HAVE_AVX, so what's going on?



---

archive/issue_comments_522925.json:
```json
{
    "body": "<div id=\"comment:75\" align=\"right\">comment:75</div>\n\nPENRYN=1 is apparently not the same as CORE=PENRYN\n\nI do have AVX (and building with TARGET=PENRYN HAVE_AVX=1 works fine):\n\n```\n  <qemu:commandline>\n    <qemu:arg value=\"-device\"/>\n    <qemu:arg value=\"isa-applesmc,osk=ourhardworkbythesewordsguardedpleasedontsteal(c)AppleComputerInc\"/>\n    <qemu:arg value=\"-smbios\"/>\n    <qemu:arg value=\"type=2\"/>\n    <qemu:arg value=\"-device\"/>\n    <qemu:arg value=\"vmware-svga\"/>\n    <qemu:arg value=\"-cpu\"/>\n    <qemu:arg value=\"Penryn,kvm=on,vendor=GenuineIntel,+invtsc,vmware-cpuid-freq=on,+pcid,+ssse3,+sse4.2,+popcnt,+avx,+aes,+xsave,+xsaveopt,check\"/>\n  </qemu:commandline>\n```",
    "created_at": "2021-10-31T23:00:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522925",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:75" align="right">comment:75</div>

PENRYN=1 is apparently not the same as CORE=PENRYN

I do have AVX (and building with TARGET=PENRYN HAVE_AVX=1 works fine):

```
  <qemu:commandline>
    <qemu:arg value="-device"/>
    <qemu:arg value="isa-applesmc,osk=ourhardworkbythesewordsguardedpleasedontsteal(c)AppleComputerInc"/>
    <qemu:arg value="-smbios"/>
    <qemu:arg value="type=2"/>
    <qemu:arg value="-device"/>
    <qemu:arg value="vmware-svga"/>
    <qemu:arg value="-cpu"/>
    <qemu:arg value="Penryn,kvm=on,vendor=GenuineIntel,+invtsc,vmware-cpuid-freq=on,+pcid,+ssse3,+sse4.2,+popcnt,+avx,+aes,+xsave,+xsaveopt,check"/>
  </qemu:commandline>
```



---

archive/issue_comments_522926.json:
```json
{
    "body": "<div id=\"comment:76\" align=\"right\">comment:76</div>\n\nReplying to [@mkoeppe](#comment:74):\n> Replying to [@vbraun](#comment:71):\n> > The build log is identical to one with `OPENBLAS_CONFIGURE=\"TARGET=PENRYN HAVE_AVX=1\"` except that the latter doesn't segfault, so it must be in the config.h value\n\n> \n> The files that you showed in [comment:70](#comment:70), [comment:72](#comment:72) have HAVE_AVX, so what's going on?\n\nSo when you pass `TARGET=PENRYN HAVE_AVX=1`, how do `config.h` and `Makefile.conf` change compared to what you posted in [comment:70](#comment:70), [comment:72](#comment:72)?",
    "created_at": "2021-11-01T01:43:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522926",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:76" align="right">comment:76</div>

Replying to [@mkoeppe](#comment:74):
> Replying to [@vbraun](#comment:71):
> > The build log is identical to one with `OPENBLAS_CONFIGURE="TARGET=PENRYN HAVE_AVX=1"` except that the latter doesn't segfault, so it must be in the config.h value

> 
> The files that you showed in [comment:70](#comment:70), [comment:72](#comment:72) have HAVE_AVX, so what's going on?

So when you pass `TARGET=PENRYN HAVE_AVX=1`, how do `config.h` and `Makefile.conf` change compared to what you posted in [comment:70](#comment:70), [comment:72](#comment:72)?



---

archive/issue_comments_522927.json:
```json
{
    "body": "<div id=\"comment:77\" align=\"right\">comment:77</div>\n\n* `src-segfault` is from running `make`\n* `src-working` is from running `make TARGET=PENRYN HAVE_AVX=1`\n\nconfig.h\n\n```\nvbraun@catalina-osx openblas-test % diff -u src-segfault/config.h src-working/config.h\n--- src-segfault/config.h\t2021-11-01 15:01:57.000000000 -0700\n+++ src-working/config.h\t2021-11-01 15:02:16.000000000 -0700\n@@ -8,19 +8,12 @@\n #define BUNDERSCORE\t_\n #define NEEDBUNDERSCORE\t1\n #define PENRYN\n-#define L1_CODE_SIZE 32768\n-#define L1_CODE_ASSOCIATIVE 8\n-#define L1_CODE_LINESIZE 64\n #define L1_DATA_SIZE 32768\n-#define L1_DATA_ASSOCIATIVE 8\n #define L1_DATA_LINESIZE 64\n-#define L2_SIZE 2097152\n-#define L2_ASSOCIATIVE 8\n+#define L2_SIZE 1048576\n #define L2_LINESIZE 64\n-#define L3_SIZE 16777216\n-#define L3_ASSOCIATIVE 16\n-#define L3_LINESIZE 64\n-#define DTB_DEFAULT_ENTRIES 32\n+#define DTB_DEFAULT_ENTRIES 256\n+#define DTB_SIZE 4096\n #define HAVE_CMOV\n #define HAVE_MMX\n #define HAVE_SSE\n@@ -28,11 +21,6 @@\n #define HAVE_SSE3\n #define HAVE_SSSE3\n #define HAVE_SSE4_1\n-#define HAVE_SSE4_2\n-#define HAVE_AVX\n-#define HAVE_CFLUSH\n-#define NUM_SHAREDCACHE 1\n-#define NUM_CORES 1\n #define CORE_PENRYN\n #define CHAR_CORENAME \"PENRYN\"\n #define SLOCAL_BUFFER_SIZE\t32768\n```\nMakefile.conf\n\n```\nvbraun@catalina-osx openblas-test % diff -u src-segfault/Makefile.conf src-working/Makefile.conf \n--- src-segfault/Makefile.conf\t2021-11-01 15:01:57.000000000 -0700\n+++ src-working/Makefile.conf\t2021-11-01 15:02:16.000000000 -0700\n@@ -12,14 +12,20 @@\n CORE=PENRYN\n LIBCORE=penryn\n NUM_CORES=8\n+PENRYN=1\n+L1_DATA_SIZE=32768\n+L1_DATA_LINESIZE=64\n+L2_SIZE=1048576\n+L2_LINESIZE=64\n+DTB_DEFAULT_ENTRIES=256\n+DTB_SIZE=4096\n+HAVE_CMOV=1\n HAVE_MMX=1\n HAVE_SSE=1\n HAVE_SSE2=1\n HAVE_SSE3=1\n HAVE_SSSE3=1\n HAVE_SSE4_1=1\n-HAVE_SSE4_2=1\n-HAVE_AVX=1\n MAKE += -j 8\n SBGEMM_UNROLL_M=8\n SBGEMM_UNROLL_N=4\n```",
    "created_at": "2021-11-01T22:07:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522927",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:77" align="right">comment:77</div>

* `src-segfault` is from running `make`
* `src-working` is from running `make TARGET=PENRYN HAVE_AVX=1`

config.h

```
vbraun@catalina-osx openblas-test % diff -u src-segfault/config.h src-working/config.h
--- src-segfault/config.h	2021-11-01 15:01:57.000000000 -0700
+++ src-working/config.h	2021-11-01 15:02:16.000000000 -0700
@@ -8,19 +8,12 @@
 #define BUNDERSCORE	_
 #define NEEDBUNDERSCORE	1
 #define PENRYN
-#define L1_CODE_SIZE 32768
-#define L1_CODE_ASSOCIATIVE 8
-#define L1_CODE_LINESIZE 64
 #define L1_DATA_SIZE 32768
-#define L1_DATA_ASSOCIATIVE 8
 #define L1_DATA_LINESIZE 64
-#define L2_SIZE 2097152
-#define L2_ASSOCIATIVE 8
+#define L2_SIZE 1048576
 #define L2_LINESIZE 64
-#define L3_SIZE 16777216
-#define L3_ASSOCIATIVE 16
-#define L3_LINESIZE 64
-#define DTB_DEFAULT_ENTRIES 32
+#define DTB_DEFAULT_ENTRIES 256
+#define DTB_SIZE 4096
 #define HAVE_CMOV
 #define HAVE_MMX
 #define HAVE_SSE
@@ -28,11 +21,6 @@
 #define HAVE_SSE3
 #define HAVE_SSSE3
 #define HAVE_SSE4_1
-#define HAVE_SSE4_2
-#define HAVE_AVX
-#define HAVE_CFLUSH
-#define NUM_SHAREDCACHE 1
-#define NUM_CORES 1
 #define CORE_PENRYN
 #define CHAR_CORENAME "PENRYN"
 #define SLOCAL_BUFFER_SIZE	32768
```
Makefile.conf

```
vbraun@catalina-osx openblas-test % diff -u src-segfault/Makefile.conf src-working/Makefile.conf 
--- src-segfault/Makefile.conf	2021-11-01 15:01:57.000000000 -0700
+++ src-working/Makefile.conf	2021-11-01 15:02:16.000000000 -0700
@@ -12,14 +12,20 @@
 CORE=PENRYN
 LIBCORE=penryn
 NUM_CORES=8
+PENRYN=1
+L1_DATA_SIZE=32768
+L1_DATA_LINESIZE=64
+L2_SIZE=1048576
+L2_LINESIZE=64
+DTB_DEFAULT_ENTRIES=256
+DTB_SIZE=4096
+HAVE_CMOV=1
 HAVE_MMX=1
 HAVE_SSE=1
 HAVE_SSE2=1
 HAVE_SSE3=1
 HAVE_SSSE3=1
 HAVE_SSE4_1=1
-HAVE_SSE4_2=1
-HAVE_AVX=1
 MAKE += -j 8
 SBGEMM_UNROLL_M=8
 SBGEMM_UNROLL_N=4
```



---

archive/issue_comments_522928.json:
```json
{
    "body": "<div id=\"comment:78\" align=\"right\">comment:78</div>\n\nIts weird that `HAVE_AVX` isn't set in the working case, but I'm pretty sure AVX isn't the reason. In particular, building with `OPENBLAS_CONFIGURE=\"NO_AVX=1\"` segfaults as well, and building with `OPENBLAS_CONFIGURE=\"TARGET=PENRYN HAVE_AVX=1\"` works.",
    "created_at": "2021-11-01T23:37:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522928",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:78" align="right">comment:78</div>

Its weird that `HAVE_AVX` isn't set in the working case, but I'm pretty sure AVX isn't the reason. In particular, building with `OPENBLAS_CONFIGURE="NO_AVX=1"` segfaults as well, and building with `OPENBLAS_CONFIGURE="TARGET=PENRYN HAVE_AVX=1"` works.



---

archive/issue_comments_522929.json:
```json
{
    "body": "<div id=\"comment:79\" align=\"right\">comment:79</div>\n\nThe culprit seems to be\n\n```\n#define DTB_DEFAULT_ENTRIES 32\n```\nincreasing it to 64, say, fixes the segfault",
    "created_at": "2021-11-04T21:21:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522929",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:79" align="right">comment:79</div>

The culprit seems to be

```
#define DTB_DEFAULT_ENTRIES 32
```
increasing it to 64, say, fixes the segfault



---

archive/issue_comments_522930.json:
```json
{
    "body": "<div id=\"comment:80\" align=\"right\">comment:80</div>\n\nReport upstream?",
    "created_at": "2021-11-04T21:38:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522930",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:80" align="right">comment:80</div>

Report upstream?



---

archive/issue_comments_522931.json:
```json
{
    "body": "<div id=\"comment:81\" align=\"right\">comment:81</div>\n\nI've made a branch at `u/vbraun/packages/openblas/0.3.18-test` that patches  DTB_DEFAULT_ENTRIES=32 when forcing TARGET=PENRYN, with that I can reproduce the same segfault on linux when running\n\n```\nOPENBLAS_CONFIGURE=\"TARGET=PENRYN\" ./sage -p openblas\n./sage -t --long  src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py\n```",
    "created_at": "2021-11-06T10:35:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522931",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:81" align="right">comment:81</div>

I've made a branch at `u/vbraun/packages/openblas/0.3.18-test` that patches  DTB_DEFAULT_ENTRIES=32 when forcing TARGET=PENRYN, with that I can reproduce the same segfault on linux when running

```
OPENBLAS_CONFIGURE="TARGET=PENRYN" ./sage -p openblas
./sage -t --long  src/sage/tests/books/computational-mathematics-with-sagemath/linsolve_doctest.py
```



---

archive/issue_comments_522932.json:
```json
{
    "body": "<div id=\"comment:82\" align=\"right\">comment:82</div>\n\n\n```\n$ valgrind ./local/bin/python\n[...]\n>>> solve = factorized(Acsc) # LU factorization\n==727003== Invalid write of size 8\n==727003==    at 0x143AC900: dgemv_n (dgemv_n.S:233)\n==727003==    by 0xFFFFFFFFFFFFFFFE: ???\n==727003==    by 0x1F: ???\n==727003==    by 0x1E: ???\n==727003==    by 0xA75C8947: ???\n==727003==    by 0x9F0E438F: ???\n==727003==    by 0x4CF: ???\n==727003==    by 0xBFEFFFFFFFFFFFFF: ???\n==727003==    by 0xFFFFFFFFFFE00009: ???\n==727003==    by 0x1F: ???\n==727003==    by 0x9F0DAA87: ???\n==727003==    by 0x98: ???\n==727003==  Address 0x0 is not stack'd, malloc'd or (recently) free'd\n```\nThough dgemv_n.S hasn't been touched in 8 years ;)",
    "created_at": "2021-11-06T11:46:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522932",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:82" align="right">comment:82</div>


```
$ valgrind ./local/bin/python
[...]
>>> solve = factorized(Acsc) # LU factorization
==727003== Invalid write of size 8
==727003==    at 0x143AC900: dgemv_n (dgemv_n.S:233)
==727003==    by 0xFFFFFFFFFFFFFFFE: ???
==727003==    by 0x1F: ???
==727003==    by 0x1E: ???
==727003==    by 0xA75C8947: ???
==727003==    by 0x9F0E438F: ???
==727003==    by 0x4CF: ???
==727003==    by 0xBFEFFFFFFFFFFFFF: ???
==727003==    by 0xFFFFFFFFFFE00009: ???
==727003==    by 0x1F: ???
==727003==    by 0x9F0DAA87: ???
==727003==    by 0x98: ???
==727003==  Address 0x0 is not stack'd, malloc'd or (recently) free'd
```
Though dgemv_n.S hasn't been touched in 8 years ;)



---

archive/issue_comments_522933.json:
```json
{
    "body": "<div id=\"comment:83\" align=\"right\">comment:83</div>\n\nThis is https://github.com/xianyi/OpenBLAS/issues/3421, patch is in the linked PR",
    "created_at": "2021-11-06T12:05:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522933",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:83" align="right">comment:83</div>

This is https://github.com/xianyi/OpenBLAS/issues/3421, patch is in the linked PR



---

archive/issue_comments_522934.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/packages/openblas/0.3.18](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/packages/openblas/0.3.18)** to **[u/vbraun/packages/openblas/0.3.18](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/packages/openblas/0.3.18)**",
    "created_at": "2021-11-06T12:08:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522934",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/mkoeppe/packages/openblas/0.3.18](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/packages/openblas/0.3.18)** to **[u/vbraun/packages/openblas/0.3.18](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/packages/openblas/0.3.18)**



---

archive/issue_comments_522935.json:
```json
{
    "body": "Changed reviewer from **Matthias Koeppe, Dima Pasechnik** to **Matthias Koeppe, Dima Pasechnik, https://github.com/mkoeppe/sage/actions/runs/1429845185, https://github.com/mkoeppe/sage/actions/runs/1429845182**",
    "created_at": "2021-11-06T20:06:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522935",
    "user": "https://github.com/mkoeppe"
}
```

Changed reviewer from **Matthias Koeppe, Dima Pasechnik** to **Matthias Koeppe, Dima Pasechnik, https://github.com/mkoeppe/sage/actions/runs/1429845185, https://github.com/mkoeppe/sage/actions/runs/1429845182**



---

archive/issue_comments_522936.json:
```json
{
    "body": "<div id=\"comment:85\" align=\"right\">comment:85</div>\n\nTesting with a bunch of other upgrade tickets \n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2f5f1957034aee0d9b130dae3f4e52f0e855986e\">2f5f195</a></td><td><code>Add upstream fix for segfault in factorize</code></td></tr></table>\n",
    "created_at": "2021-11-06T20:06:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522936",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:85" align="right">comment:85</div>

Testing with a bunch of other upgrade tickets 

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2f5f1957034aee0d9b130dae3f4e52f0e855986e">2f5f195</a></td><td><code>Add upstream fix for segfault in factorize</code></td></tr></table>




---

archive/issue_events_447210.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-11-06T20:06:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447210"
}
```



---

archive/issue_events_447211.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-11-06T20:06:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447211"
}
```



---

archive/issue_comments_522937.json:
```json
{
    "body": "Changed commit from **[`18044f3`](https://github.com/sagemath/sagetrac-mirror/commit/18044f326508a898561fb787a902279b1a527ee6)** to **[`2f5f195`](https://github.com/sagemath/sagetrac-mirror/commit/2f5f1957034aee0d9b130dae3f4e52f0e855986e)**",
    "created_at": "2021-11-06T20:06:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522937",
    "user": "https://github.com/mkoeppe"
}
```

Changed commit from **[`18044f3`](https://github.com/sagemath/sagetrac-mirror/commit/18044f326508a898561fb787a902279b1a527ee6)** to **[`2f5f195`](https://github.com/sagemath/sagetrac-mirror/commit/2f5f1957034aee0d9b130dae3f4e52f0e855986e)**



---

archive/issue_comments_522938.json:
```json
{
    "body": "Changed reviewer from **Matthias Koeppe, Dima Pasechnik, https://github.com/mkoeppe/sage/actions/runs/1429845185, https://github.com/mkoeppe/sage/actions/runs/1429845182** to **Matthias Koeppe, Dima Pasechnik, https://github.com/mkoeppe/sage/actions/runs/1430376304, https://github.com/mkoeppe/sage/actions/runs/1430376300**",
    "created_at": "2021-11-07T01:18:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522938",
    "user": "https://github.com/mkoeppe"
}
```

Changed reviewer from **Matthias Koeppe, Dima Pasechnik, https://github.com/mkoeppe/sage/actions/runs/1429845185, https://github.com/mkoeppe/sage/actions/runs/1429845182** to **Matthias Koeppe, Dima Pasechnik, https://github.com/mkoeppe/sage/actions/runs/1430376304, https://github.com/mkoeppe/sage/actions/runs/1430376300**



---

archive/issue_comments_522939.json:
```json
{
    "body": "<div id=\"comment:87\" align=\"right\">comment:87</div>\n\nTests look good",
    "created_at": "2021-11-08T00:49:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522939",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:87" align="right">comment:87</div>

Tests look good



---

archive/issue_events_447212.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-11-08T00:49:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447212"
}
```



---

archive/issue_events_447213.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-11-08T00:49:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447213"
}
```



---

archive/issue_comments_522940.json:
```json
{
    "body": "Changed reviewer from **Matthias Koeppe, Dima Pasechnik, https://github.com/mkoeppe/sage/actions/runs/1430376304, https://github.com/mkoeppe/sage/actions/runs/1430376300** to **Matthias Koeppe, Dima Pasechnik**",
    "created_at": "2021-11-08T00:49:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522940",
    "user": "https://github.com/mkoeppe"
}
```

Changed reviewer from **Matthias Koeppe, Dima Pasechnik, https://github.com/mkoeppe/sage/actions/runs/1430376304, https://github.com/mkoeppe/sage/actions/runs/1430376300** to **Matthias Koeppe, Dima Pasechnik**



---

archive/issue_comments_522941.json:
```json
{
    "body": "Changed author from **Isuru Fernando, Matthias Koeppe** to **Isuru Fernando, Matthias Koeppe, Volker Braun**",
    "created_at": "2021-11-08T00:53:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522941",
    "user": "https://github.com/mkoeppe"
}
```

Changed author from **Isuru Fernando, Matthias Koeppe** to **Isuru Fernando, Matthias Koeppe, Volker Braun**



---

archive/issue_events_447214.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2021-11-12T11:24:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447214"
}
```



---

archive/issue_events_447215.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2021-11-12T11:24:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447215"
}
```



---

archive/issue_comments_522942.json:
```json
{
    "body": "Changed branch from **[u/vbraun/packages/openblas/0.3.18](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/packages/openblas/0.3.18)** to **[`2f5f195`](https://github.com/sagemath/sagetrac-mirror/commit/2f5f1957034aee0d9b130dae3f4e52f0e855986e)**",
    "created_at": "2021-11-12T21:27:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32424#issuecomment-522942",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/vbraun/packages/openblas/0.3.18](https://github.com/sagemath/sagetrac-mirror/tree/u/vbraun/packages/openblas/0.3.18)** to **[`2f5f195`](https://github.com/sagemath/sagetrac-mirror/commit/2f5f1957034aee0d9b130dae3f4e52f0e855986e)**



---

archive/issue_events_447216.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-11-12T21:27:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447216"
}
```



---

archive/issue_events_447217.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "a44476579fa52e72b98c7da22257293748a6d328",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-11-12T21:27:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/32424",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32424#event-447217"
}
```
