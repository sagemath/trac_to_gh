# Issue 32870: sage.rings: Modularization changes

archive/issues_032633.json:
```json
{
    "body": "split out from #32432.\n\n\n\nCC:  @kliem\n\nReviewer: Jonathan Kliem, Matthias Koeppe\n\nAuthor: Matthias Koeppe, Jonathan Kliem\n\nBranch: 92d88c059f0608e19e951e30f1c0afe2d2bb38f6\n\nCommit: 92d88c059f0608e19e951e30f1c0afe2d2bb38f6\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32870\n\n",
    "closed_at": "2021-12-19T11:47:25Z",
    "created_at": "2021-11-14T08:23:09Z",
    "labels": [
        "component: refactoring"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "sage.rings: Modularization changes",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32870",
    "user": "https://github.com/mkoeppe"
}
```
split out from #32432.



CC:  @kliem

Reviewer: Jonathan Kliem, Matthias Koeppe

Author: Matthias Koeppe, Jonathan Kliem

Branch: 92d88c059f0608e19e951e30f1c0afe2d2bb38f6

Commit: 92d88c059f0608e19e951e30f1c0afe2d2bb38f6

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/32870





---

archive/issue_comments_464888.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2021-11-14T08:23:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464888",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_464889.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-11-14T08:23:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464889",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_464890.json:
```json
{
    "body": "<a id='comment:3'></a>```\n    from .functional import (additive_order,\n  File \"/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/misc/functional.py\", line 26, in <module>\n    from sage.rings.complex_double import CDF\n  File \"sage/rings/complex_double.pyx\", line 110, in init sage.rings.complex_double (build/cythonized/sage/rings/complex_double.c:24921)\n  File \"sage/rings/complex_mpfr.pyx\", line 1, in init sage.rings.complex_mpfr (build/cythonized/sage/rings/complex_mpfr.c:35629)\n  File \"sage/rings/real_mpfr.pyx\", line 1, in init sage.rings.real_mpfr (build/cythonized/sage/rings/real_mpfr.c:47129)\n  File \"sage/libs/mpmath/utils.pyx\", line 17, in init sage.libs.mpmath.utils (build/cythonized/sage/libs/mpmath/utils.c:9319)\nImportError: cannot import name ComplexField\n```",
    "created_at": "2021-11-16T20:24:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464890",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>```
    from .functional import (additive_order,
  File "/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/misc/functional.py", line 26, in <module>
    from sage.rings.complex_double import CDF
  File "sage/rings/complex_double.pyx", line 110, in init sage.rings.complex_double (build/cythonized/sage/rings/complex_double.c:24921)
  File "sage/rings/complex_mpfr.pyx", line 1, in init sage.rings.complex_mpfr (build/cythonized/sage/rings/complex_mpfr.c:35629)
  File "sage/rings/real_mpfr.pyx", line 1, in init sage.rings.real_mpfr (build/cythonized/sage/rings/real_mpfr.c:47129)
  File "sage/libs/mpmath/utils.pyx", line 17, in init sage.libs.mpmath.utils (build/cythonized/sage/libs/mpmath/utils.c:9319)
ImportError: cannot import name ComplexField
```



---

archive/issue_comments_464891.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-11-16T20:24:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464891",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_464892.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-11-16T23:54:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464892",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_464893.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-11-16T23:55:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464893",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_464894.json:
```json
{
    "body": "<a id='comment:5'></a>Backed out the last change to `src/sage/rings/rational.pyx`",
    "created_at": "2021-11-16T23:55:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464894",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>Backed out the last change to `src/sage/rings/rational.pyx`



---

archive/issue_comments_464895.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-18T18:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464895",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_464896.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-11-29T22:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464896",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_464897.json:
```json
{
    "body": "<a id='comment:7'></a>```\nsage -t --long --random-seed=194261639548588837697181034125749346937 src/sage/rings/commutative_algebra.py\n**********************************************************************\nFile \"src/sage/rings/commutative_algebra.py\", line 28, in sage.rings.commutative_algebra.is_CommutativeAlgebra\nFailed example:\n    sage.rings.commutative_algebra.is_CommutativeAlgebra(sage.rings.ring.CommutativeAlgebra(ZZ))\nException raised:\n    Traceback (most recent call last):\n      File \"/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.rings.commutative_algebra.is_CommutativeAlgebra[0]>\", line 1, in <module>\n        sage.rings.commutative_algebra.is_CommutativeAlgebra(sage.rings.ring.CommutativeAlgebra(ZZ))\n    AttributeError: module 'sage.rings' has no attribute 'commutative_algebra'\n```",
    "created_at": "2021-11-29T22:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464897",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>```
sage -t --long --random-seed=194261639548588837697181034125749346937 src/sage/rings/commutative_algebra.py
**********************************************************************
File "src/sage/rings/commutative_algebra.py", line 28, in sage.rings.commutative_algebra.is_CommutativeAlgebra
Failed example:
    sage.rings.commutative_algebra.is_CommutativeAlgebra(sage.rings.ring.CommutativeAlgebra(ZZ))
Exception raised:
    Traceback (most recent call last):
      File "/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/srv/public/patchbot-sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.commutative_algebra.is_CommutativeAlgebra[0]>", line 1, in <module>
        sage.rings.commutative_algebra.is_CommutativeAlgebra(sage.rings.ring.CommutativeAlgebra(ZZ))
    AttributeError: module 'sage.rings' has no attribute 'commutative_algebra'
```



---

archive/issue_comments_464898.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-29T22:13:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464898",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_464899.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-11-29T22:13:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464899",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_464900.json:
```json
{
    "body": "<a id='comment:10'></a>Before:\n\n```\nsage: P.<x,y>  = PolynomialRing(GF(2),2)\nsage: I = sage.rings.ideal.FieldIdeal(P)\nsage: Q = P.quo(I)\nsage: %timeit Q._singular_()\n833 ns \u00b1 1.01 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n```\n\nAfter:\n\n```\nsage: P.<x,y>  = PolynomialRing(GF(2),2)\nsage: I = sage.rings.ideal.FieldIdeal(P)\nsage: Q = P.quo(I)\nsage: %timeit Q._singular_()\n1.37 \u00b5s \u00b1 0.777 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\n```\n\nI will see, if I can improve this.",
    "created_at": "2021-11-30T08:40:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464900",
    "user": "https://github.com/kliem"
}
```

<a id='comment:10'></a>Before:

```
sage: P.<x,y>  = PolynomialRing(GF(2),2)
sage: I = sage.rings.ideal.FieldIdeal(P)
sage: Q = P.quo(I)
sage: %timeit Q._singular_()
833 ns ± 1.01 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
```

After:

```
sage: P.<x,y>  = PolynomialRing(GF(2),2)
sage: I = sage.rings.ideal.FieldIdeal(P)
sage: Q = P.quo(I)
sage: %timeit Q._singular_()
1.37 µs ± 0.777 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
```

I will see, if I can improve this.



---

archive/issue_comments_464901.json:
```json
{
    "body": "<a id='comment:11'></a>Before:\n\n```\nsage: R.<x,y> = PolynomialRing(QQ)\nsage: S = R.quotient_ring(x^2+y^2)\nsage: %timeit S.ideal(x+y+1)\n8.2 \u00b5s \u00b1 38.6 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit S.ideal()\n2.24 \u00b5s \u00b1 8.11 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit S(x)\n2.04 \u00b5s \u00b1 7.01 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\nAfter:\n\n```\nsage: R.<x,y> = PolynomialRing(QQ)\nsage: S = R.quotient_ring(x^2+y^2)\nsage: %timeit S.ideal(x+y+1)\n9.71 \u00b5s \u00b1 36.4 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit S.ideal()\n3.2 \u00b5s \u00b1 26.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit S(x)\n2.75 \u00b5s \u00b1 6.89 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```",
    "created_at": "2021-11-30T08:47:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464901",
    "user": "https://github.com/kliem"
}
```

<a id='comment:11'></a>Before:

```
sage: R.<x,y> = PolynomialRing(QQ)
sage: S = R.quotient_ring(x^2+y^2)
sage: %timeit S.ideal(x+y+1)
8.2 µs ± 38.6 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit S.ideal()
2.24 µs ± 8.11 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit S(x)
2.04 µs ± 7.01 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

After:

```
sage: R.<x,y> = PolynomialRing(QQ)
sage: S = R.quotient_ring(x^2+y^2)
sage: %timeit S.ideal(x+y+1)
9.71 µs ± 36.4 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit S.ideal()
3.2 µs ± 26.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit S(x)
2.75 µs ± 6.89 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```



---

archive/issue_comments_464902.json:
```json
{
    "body": "<a id='comment:12'></a>I'm pretty much back to the old timings:\n\n```\nsage: P.<x,y>  = PolynomialRing(GF(2),2)\nsage: I = sage.rings.ideal.FieldIdeal(P)\nsage: Q = P.quo(I)\nsage: %timeit Q._singular_()\n853 ns \u00b1 1.18 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000000 loops each)\nsage: R.<x,y> = PolynomialRing(QQ)\nsage: S = R.quotient_ring(x^2+y^2)\nsage: %timeit S.ideal(x+y+1)\n8.1 \u00b5s \u00b1 71.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit S.ideal()\n2.11 \u00b5s \u00b1 2.83 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit S(x)\n2.02 \u00b5s \u00b1 13.9 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\n---\nNew commits:",
    "created_at": "2021-11-30T09:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464902",
    "user": "https://github.com/kliem"
}
```

<a id='comment:12'></a>I'm pretty much back to the old timings:

```
sage: P.<x,y>  = PolynomialRing(GF(2),2)
sage: I = sage.rings.ideal.FieldIdeal(P)
sage: Q = P.quo(I)
sage: %timeit Q._singular_()
853 ns ± 1.18 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)
sage: R.<x,y> = PolynomialRing(QQ)
sage: S = R.quotient_ring(x^2+y^2)
sage: %timeit S.ideal(x+y+1)
8.1 µs ± 71.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit S.ideal()
2.11 µs ± 2.83 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit S(x)
2.02 µs ± 13.9 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

---
New commits:



---

archive/issue_comments_464903.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-11-30T21:11:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464903",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_464904.json:
```json
{
    "body": "<a id='comment:13'></a>Thanks a lot, this is looking great.",
    "created_at": "2021-11-30T21:11:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464904",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>Thanks a lot, this is looking great.



---

archive/issue_comments_464905.json:
```json
{
    "body": "<a id='comment:14'></a>Actually, in this change there's a typo:\n\n```\n--- a/src/sage/rings/quotient_ring_element.py\n+++ b/src/sage/rings/quotient_ring_element.py\n@@ -18,7 +18,12 @@ AUTHORS:\n \n from sage.structure.element import RingElement\n from sage.structure.richcmp import richcmp, rich_to_bool\n-from sage.interfaces.singular import singular as singular_default\n+\n+\n+try:\n+    from sage.interfaces.singular import singular as singular_default\n+except ImportError:\n+    is_singularElement = lambda x : False\n```\n\n... `singular_default` should be set here",
    "created_at": "2021-11-30T23:45:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464905",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>Actually, in this change there's a typo:

```
--- a/src/sage/rings/quotient_ring_element.py
+++ b/src/sage/rings/quotient_ring_element.py
@@ -18,7 +18,12 @@ AUTHORS:
 
 from sage.structure.element import RingElement
 from sage.structure.richcmp import richcmp, rich_to_bool
-from sage.interfaces.singular import singular as singular_default
+
+
+try:
+    from sage.interfaces.singular import singular as singular_default
+except ImportError:
+    is_singularElement = lambda x : False
```

... `singular_default` should be set here



---

archive/issue_comments_464906.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-11-30T23:45:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464906",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_464907.json:
```json
{
    "body": "<a id='comment:16'></a>New commits:",
    "created_at": "2021-11-30T23:49:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464907",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>New commits:



---

archive/issue_comments_464908.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-11-30T23:49:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464908",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_464909.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-01T06:08:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464909",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_464910.json:
```json
{
    "body": "<a id='comment:17'></a>Thanks for fixing this.",
    "created_at": "2021-12-01T06:08:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464910",
    "user": "https://github.com/kliem"
}
```

<a id='comment:17'></a>Thanks for fixing this.



---

archive/issue_events_086906.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-12-19T11:47:25Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32870#event-86906"
}
```



---

archive/issue_comments_464911.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-12-19T11:47:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32870",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32870#issuecomment-464911",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
