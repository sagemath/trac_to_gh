# Issue 32375: speed up logarithms modulo composite integers

archive/issues_032138.json:
```json
{
    "body": "CC:  @JohnCremona @kwankyu @defeo @edgarcosta @kedlaya\n\nKeywords: discrete logarithms, finite rings, composite characteristic\n\nThe current logic for `IntegerModRing_abstract.log()` is as follows:\n\n1. If `logarithm_exists=True` was passed: Call Pari's `znlog` with just the elements.\n2. Else, if the modulus is prime: Compute the orders of `a,b` and (if the logarithm exists) call Pari's `znlog` with the elements and the order of `b`.\n3. Else, use generic `discrete_log` (i.e., Pohlig\u2013Hellman).\n\nThe main reason things are done like this appears to be that `znlog` is not guaranteed to terminate if the logarithm doesn't exist, and checking if it exists is not straightforward when the ambient group is non-cyclic. Since we're already at it, here's what Pari does in `znlog`:\n\n1. If the order of the base element is given, factor it and use Pohlig\u2013Hellman.\n2. Else, factor the modulus and solve each prime-power part separately using either index calculus (if p is a suitable prime) or Pohlig\u2013Hellman with either BSGS or Pollard \u03c1 for the base cases (depending on size).\n\nWe really shouldn't resort to generic `discrete_log()` right away if the modulus isn't prime: While indeed `(\u2124/n)*` is usually non-cyclic, we can typically reduce to the cyclic case using CRT, which we can then pass on to Pari after checking that the logarithm exists (by comparing orders). This patch takes care of this.\n\nSummary of the new algorithm:\n1. Factor the modulus.\n2. Solve the problem modulo each prime power separately:\n   1. Modulo powers of two, use Sage's `discrete_log`.\n   2. Modulo odd prime powers, check that the logarithm exists and call Pari's `znlog`.\n3. Use CRT to combine the local solutions.\n\nThe reason to treat powers of two differently is that this is the only case where the unit group is not always cyclic, hence we might run into Pari's infinite loop when no solution exists (side note: I'm not sure if this can actually happen, but of course we should rely only on documented behaviour). Since 2-groups are a very easy case for generic `discrete_log()`, we simply deal with that in Sage instead of risking the infinite loop. In all other cases, unit groups modulo prime powers are cyclic, hence we can safely call Pari after checking the orders.\n\nI know factoring the modulus looks scary, but let me point out that we're already doing that in all cases:\n* If `logarithm_exists=True` is given, the order is factored in Pari first thing.\n* Else, we are computing the orders of elements in Sage, which requires first factoring the group order.\n\nThe new doctests introduced in the patch are cases where the old algorithm would take a very long time (if it managed to finish at all without getting killed for lack of memory), whereas the new algorithm takes much less than a second. I also tested the old and new code with thousands of random DLPs modulo (1) random integers, and (2) primes, of sizes up to `2^64`, and there didn't appear to be any noticeable performance degradation even in the previous best case of prime moduli. For composite integers, the new code is unsurprisingly a lot faster on average.\n\nI found out about the current, suboptimal implementation here: [https://web.archive.org/web/20210813155145/https://cryptohack.gitbook.io/cryptobook/abstract-algebra/groups/untitled](https://web.archive.org/web/20210813155145/https://cryptohack.gitbook.io/cryptobook/abstract-algebra/groups/untitled)\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32375\n\n",
    "closed_at": "2021-09-13T22:22:21Z",
    "created_at": "2021-08-14T04:14:01Z",
    "labels": [
        "component: number theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "speed up logarithms modulo composite integers",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32375",
    "user": "https://github.com/yyyyx4"
}
```
CC:  @JohnCremona @kwankyu @defeo @edgarcosta @kedlaya

Keywords: discrete logarithms, finite rings, composite characteristic

The current logic for `IntegerModRing_abstract.log()` is as follows:

1. If `logarithm_exists=True` was passed: Call Pari's `znlog` with just the elements.
2. Else, if the modulus is prime: Compute the orders of `a,b` and (if the logarithm exists) call Pari's `znlog` with the elements and the order of `b`.
3. Else, use generic `discrete_log` (i.e., Pohlig–Hellman).

The main reason things are done like this appears to be that `znlog` is not guaranteed to terminate if the logarithm doesn't exist, and checking if it exists is not straightforward when the ambient group is non-cyclic. Since we're already at it, here's what Pari does in `znlog`:

1. If the order of the base element is given, factor it and use Pohlig–Hellman.
2. Else, factor the modulus and solve each prime-power part separately using either index calculus (if p is a suitable prime) or Pohlig–Hellman with either BSGS or Pollard ρ for the base cases (depending on size).

We really shouldn't resort to generic `discrete_log()` right away if the modulus isn't prime: While indeed `(ℤ/n)*` is usually non-cyclic, we can typically reduce to the cyclic case using CRT, which we can then pass on to Pari after checking that the logarithm exists (by comparing orders). This patch takes care of this.

Summary of the new algorithm:
1. Factor the modulus.
2. Solve the problem modulo each prime power separately:
   1. Modulo powers of two, use Sage's `discrete_log`.
   2. Modulo odd prime powers, check that the logarithm exists and call Pari's `znlog`.
3. Use CRT to combine the local solutions.

The reason to treat powers of two differently is that this is the only case where the unit group is not always cyclic, hence we might run into Pari's infinite loop when no solution exists (side note: I'm not sure if this can actually happen, but of course we should rely only on documented behaviour). Since 2-groups are a very easy case for generic `discrete_log()`, we simply deal with that in Sage instead of risking the infinite loop. In all other cases, unit groups modulo prime powers are cyclic, hence we can safely call Pari after checking the orders.

I know factoring the modulus looks scary, but let me point out that we're already doing that in all cases:
* If `logarithm_exists=True` is given, the order is factored in Pari first thing.
* Else, we are computing the orders of elements in Sage, which requires first factoring the group order.

The new doctests introduced in the patch are cases where the old algorithm would take a very long time (if it managed to finish at all without getting killed for lack of memory), whereas the new algorithm takes much less than a second. I also tested the old and new code with thousands of random DLPs modulo (1) random integers, and (2) primes, of sizes up to `2^64`, and there didn't appear to be any noticeable performance degradation even in the previous best case of prime moduli. For composite integers, the new code is unsurprisingly a lot faster on average.

I found out about the current, suboptimal implementation here: [https://web.archive.org/web/20210813155145/https://cryptohack.gitbook.io/cryptobook/abstract-algebra/groups/untitled](https://web.archive.org/web/20210813155145/https://cryptohack.gitbook.io/cryptobook/abstract-algebra/groups/untitled)


Issue created by migration from https://trac.sagemath.org/ticket/32375





---

archive/issue_comments_458429.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-08-14T04:31:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458429",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_458430.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-08-15T00:49:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458430",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_458431.json:
```json
{
    "body": "I am cc-ing some people who might have an opinion on this. (Sorry if you don't care.)\n\nSome quick comments:\n\nI don't think we need the `assert b**n == self` check to be run. I would comment it out.\n\nI would just copy the error message where appropriate rather than put it in a `lambda` function. It obfuscates the code a bit for something effectively trivial (having an easy way to change an error message). Plus you can then have more nuanced error messages explaining where the computation failed.\n\nSplit these lines:\n\n```diff\n-n, m = 0, 1\n+n = 0\n+m = 0\n```\n\n```diff\n-na, nb = a_red.multiplicative_order(), b_red.multiplicative_order()\n+na = a_red.multiplicative_order()\nnb = b_red.multiplicative_order()\n```\nIt makes a difference in Cython code. (Related question: do we know anything about the types of some of these variables? This could make the code even faster.)\n\nMove the import statement `from sage.arith.all import crt, lcm` outside of the `for` loop. It only needs to be done once in the function.\n\nIt is only the `crt` that could fail here, right? So\n\n```diff\n             try:\n                 n = crt(n, v, m, nb)\n-                m = lcm(m, nb)\n             except ValueError:  # contradictory partial solutions\n                 raise exc(self.modulus())\n             m = lcm(m, nb)\n```",
    "created_at": "2021-08-15T00:49:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458431",
    "user": "https://github.com/tscrim"
}
```

I am cc-ing some people who might have an opinion on this. (Sorry if you don't care.)

Some quick comments:

I don't think we need the `assert b**n == self` check to be run. I would comment it out.

I would just copy the error message where appropriate rather than put it in a `lambda` function. It obfuscates the code a bit for something effectively trivial (having an easy way to change an error message). Plus you can then have more nuanced error messages explaining where the computation failed.

Split these lines:

```diff
-n, m = 0, 1
+n = 0
+m = 0
```

```diff
-na, nb = a_red.multiplicative_order(), b_red.multiplicative_order()
+na = a_red.multiplicative_order()
nb = b_red.multiplicative_order()
```
It makes a difference in Cython code. (Related question: do we know anything about the types of some of these variables? This could make the code even faster.)

Move the import statement `from sage.arith.all import crt, lcm` outside of the `for` loop. It only needs to be done once in the function.

It is only the `crt` that could fail here, right? So

```diff
             try:
                 n = crt(n, v, m, nb)
-                m = lcm(m, nb)
             except ValueError:  # contradictory partial solutions
                 raise exc(self.modulus())
             m = lcm(m, nb)
```



---

archive/issue_comments_458432.json:
```json
{
    "body": "Changing component from algebra to number theory.",
    "created_at": "2021-08-15T00:49:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458432",
    "user": "https://github.com/tscrim"
}
```

Changing component from algebra to number theory.



---

archive/issue_comments_458433.json:
```json
{
    "body": "Overall it looks like a solid improvement, and I agree with Travis's comments.\n\nAnother minor comment, I would consider storing a list with `nb`s and `v`s and at the end calling CRT_list which is literally doing the same as you\n\n```\n                n = crt(n, v, m, nb)\n                m = lcm(m, nb)\n```\nbut now the code would be more readable and modular.",
    "created_at": "2021-08-15T22:39:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458433",
    "user": "https://github.com/edgarcosta"
}
```

Overall it looks like a solid improvement, and I agree with Travis's comments.

Another minor comment, I would consider storing a list with `nb`s and `v`s and at the end calling CRT_list which is literally doing the same as you

```
                n = crt(n, v, m, nb)
                m = lcm(m, nb)
```
but now the code would be more readable and modular.



---

archive/issue_comments_458434.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-17T08:28:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458434",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_458435.json:
```json
{
    "body": "Thanks for the comments! All done (I think), except for this:\n\nReplying to [comment:3 edgarcosta]:\n> I would consider storing a list with `nb`s and `v`s and at the end calling CRT_list which is literally doing the same\n\n\n\u2014 that's what I had at first, but the current version aborts earlier in some cases. (We don't want to continue running an expensive DLP computation when it's already clear that there will be no solution.)",
    "created_at": "2021-08-17T08:33:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458435",
    "user": "https://github.com/yyyyx4"
}
```

Thanks for the comments! All done (I think), except for this:

Replying to [comment:3 edgarcosta]:
> I would consider storing a list with `nb`s and `v`s and at the end calling CRT_list which is literally doing the same


— that's what I had at first, but the current version aborts earlier in some cases. (We don't want to continue running an expensive DLP computation when it's already clear that there will be no solution.)



---

archive/issue_comments_458436.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-08-17T08:33:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458436",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_458437.json:
```json
{
    "body": "Makes sense! I will wait for the tests to pass to take a more careful look into it.",
    "created_at": "2021-08-17T12:35:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458437",
    "user": "https://github.com/edgarcosta"
}
```

Makes sense! I will wait for the tests to pass to take a more careful look into it.



---

archive/issue_comments_458438.json:
```json
{
    "body": "Green patchbot. Now to some technical comments:\n\n```diff\n-for kw in kwargs.keys():\n+for kw in kwargs:\n```\nHowever, while I somewhat understand why you are using `kwargs` input, you could just set `logarithm_exists=None` and check if `None`. I doubt anyone is passing `None` here and meant to.\n\nTrivial formatting point: We try to follow Python's convention and have error messages starting with a lower case letter.",
    "created_at": "2021-08-17T22:22:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458438",
    "user": "https://github.com/tscrim"
}
```

Green patchbot. Now to some technical comments:

```diff
-for kw in kwargs.keys():
+for kw in kwargs:
```
However, while I somewhat understand why you are using `kwargs` input, you could just set `logarithm_exists=None` and check if `None`. I doubt anyone is passing `None` here and meant to.

Trivial formatting point: We try to follow Python's convention and have error messages starting with a lower case letter.



---

archive/issue_comments_458439.json:
```json
{
    "body": "In terms of math, the code looks good! Once Travis is happy, I will give a positive review.\n\nI agree that `logarithm_exists=None` sounds ideal to me, and less opaque why we still have it, no one needs to wonder what goes in `**kwargs`, and we can just mark it as deprecated in the documentation.\n\nOptional formatting:\n- delete the empty lines at the beginning of `if`, `for`, `try`... blocks\n- `for p,e in ...` -> `for p, e in ...`\n- extra minor, I'm a strong fan of https://docs.python.org/3/tutorial/inputoutput.html#fancier-output-formatting",
    "created_at": "2021-08-17T22:54:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458439",
    "user": "https://github.com/edgarcosta"
}
```

In terms of math, the code looks good! Once Travis is happy, I will give a positive review.

I agree that `logarithm_exists=None` sounds ideal to me, and less opaque why we still have it, no one needs to wonder what goes in `**kwargs`, and we can just mark it as deprecated in the documentation.

Optional formatting:
- delete the empty lines at the beginning of `if`, `for`, `try`... blocks
- `for p,e in ...` -> `for p, e in ...`
- extra minor, I'm a strong fan of https://docs.python.org/3/tutorial/inputoutput.html#fancier-output-formatting



---

archive/issue_comments_458440.json:
```json
{
    "body": "Replying to [comment:8 edgarcosta]:\n> I agree that `logarithm_exists=None` sounds ideal to me, and less opaque why we still have it, no one needs to wonder what goes in `**kwargs`, and we can just mark it as deprecated in the documentation.\n\n\nI would just leave it out altogether from the documentation since it is deprecated and the warning/code makes it clear that it is. No need to tell a more casual user about something that is disappearing.",
    "created_at": "2021-08-17T23:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458440",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:8 edgarcosta]:
> I agree that `logarithm_exists=None` sounds ideal to me, and less opaque why we still have it, no one needs to wonder what goes in `**kwargs`, and we can just mark it as deprecated in the documentation.


I would just leave it out altogether from the documentation since it is deprecated and the warning/code makes it clear that it is. No need to tell a more casual user about something that is disappearing.



---

archive/issue_comments_458441.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-18T03:26:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458441",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_458442.json:
```json
{
    "body": "Thanks both of you! Done.",
    "created_at": "2021-08-18T03:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458442",
    "user": "https://github.com/yyyyx4"
}
```

Thanks both of you! Done.



---

archive/issue_comments_458443.json:
```json
{
    "body": "Thank you. I am setting this to a positive review from comment:8.\n\nEdgar, if there is something else you feel needs to be addressed, feel free to revert the positive review.",
    "created_at": "2021-08-18T04:21:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458443",
    "user": "https://github.com/tscrim"
}
```

Thank you. I am setting this to a positive review from comment:8.

Edgar, if there is something else you feel needs to be addressed, feel free to revert the positive review.



---

archive/issue_comments_458444.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-08-18T04:21:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458444",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_458445.json:
```json
{
    "body": "Thank you, Travis!",
    "created_at": "2021-08-18T10:27:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458445",
    "user": "https://github.com/edgarcosta"
}
```

Thank you, Travis!



---

archive/issue_comments_458446.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-09-06T19:33:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458446",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_458447.json:
```json
{
    "body": "```\nsage -t --long --warn-long 42.3 --random-seed=0 src/sage/functions/log.py\n**********************************************************************\nFile \"src/sage/functions/log.py\", line 385, in sage.functions.log.log\nFailed example:\n    log(a,3)\nExpected:\n    Traceback (most recent call last):\n    ...\n    ValueError: No discrete log of 8 found to base 3 modulo 13\nGot:\n    <BLANKLINE>\n    Traceback (most recent call last):\n      File \"/home/release/Sage/local/lib64/python3.9/site-packages/sage/functions/log.py\", line 451, in log\n        return args[0].log(args[1])\n      File \"sage/rings/finite_rings/integer_mod.pyx\", line 777, in sage.rings.finite_rings.integer_mod.IntegerMod_abstract.log (build/cythonized/sage/rings/finite_rings/integer_mod.c:9308)\n        raise ValueError(f\"no logarithm of {self} found to base {b} modulo {self.modulus()}\" \\\n    ValueError: no logarithm of 8 found to base 3 modulo 13\n    <BLANKLINE>\n    During handling of the above exception, another exception occurred:\n    <BLANKLINE>\n    Traceback (most recent call last):\n      File \"sage/symbolic/function.pyx\", line 573, in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.cpp:6731)\n        args = [SR.coerce(a) for a in args]\n      File \"sage/structure/parent.pyx\", line 1177, in sage.structure.parent.Parent.coerce (build/cythonized/sage/structure/parent.c:11028)\n        cpdef coerce(self, x):\n      File \"sage/structure/parent.pyx\", line 1209, in sage.structure.parent.Parent.coerce (build/cythonized/sage/structure/parent.c:10974)\n        return (<map.Map>mor)._call_(x)\n      File \"sage/structure/coerce_maps.pyx\", line 161, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4638)\n        raise\n      File \"sage/structure/coerce_maps.pyx\", line 156, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4530)\n        return C._element_constructor(x)\n      File \"sage/symbolic/ring.pyx\", line 402, in sage.symbolic.ring.SymbolicRing._element_constructor_ (build/cythonized/sage/symbolic/ring.cpp:6851)\n        raise TypeError('positive characteristic not allowed in symbolic computations')\n    TypeError: positive characteristic not allowed in symbolic computations\n    <BLANKLINE>\n    During handling of the above exception, another exception occurred:\n    <BLANKLINE>\n    Traceback (most recent call last):\n      File \"/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py\", line 704, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py\", line 1098, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.functions.log.log[32]>\", line 1, in <module>\n        log(a,Integer(3))\n      File \"/home/release/Sage/local/lib64/python3.9/site-packages/sage/functions/log.py\", line 455, in log\n        return logb(args[0], args[1])\n      File \"sage/symbolic/function.pyx\", line 1179, in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:12857)\n        res = super(BuiltinFunction, self).__call__(\n      File \"sage/symbolic/function.pyx\", line 586, in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.cpp:6893)\n        raise TypeError(\"cannot coerce arguments: %s\" % (err))\n    TypeError: cannot coerce arguments: positive characteristic not allowed in symbolic computations\n**********************************************************************\n1 item had failures:\n   1 of  50 in sage.functions.log.log\n    [330 tests, 1 failure, 1.97 s]\n----------------------------------------------------------------------\nsage -t --long --warn-long 42.3 --random-seed=0 src/sage/functions/log.py  # 1 doctest failed\n----------------------------------------------------------------------\n```",
    "created_at": "2021-09-06T19:33:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458447",
    "user": "https://github.com/vbraun"
}
```

```
sage -t --long --warn-long 42.3 --random-seed=0 src/sage/functions/log.py
**********************************************************************
File "src/sage/functions/log.py", line 385, in sage.functions.log.log
Failed example:
    log(a,3)
Expected:
    Traceback (most recent call last):
    ...
    ValueError: No discrete log of 8 found to base 3 modulo 13
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/functions/log.py", line 451, in log
        return args[0].log(args[1])
      File "sage/rings/finite_rings/integer_mod.pyx", line 777, in sage.rings.finite_rings.integer_mod.IntegerMod_abstract.log (build/cythonized/sage/rings/finite_rings/integer_mod.c:9308)
        raise ValueError(f"no logarithm of {self} found to base {b} modulo {self.modulus()}" \
    ValueError: no logarithm of 8 found to base 3 modulo 13
    <BLANKLINE>
    During handling of the above exception, another exception occurred:
    <BLANKLINE>
    Traceback (most recent call last):
      File "sage/symbolic/function.pyx", line 573, in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.cpp:6731)
        args = [SR.coerce(a) for a in args]
      File "sage/structure/parent.pyx", line 1177, in sage.structure.parent.Parent.coerce (build/cythonized/sage/structure/parent.c:11028)
        cpdef coerce(self, x):
      File "sage/structure/parent.pyx", line 1209, in sage.structure.parent.Parent.coerce (build/cythonized/sage/structure/parent.c:10974)
        return (<map.Map>mor)._call_(x)
      File "sage/structure/coerce_maps.pyx", line 161, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4638)
        raise
      File "sage/structure/coerce_maps.pyx", line 156, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4530)
        return C._element_constructor(x)
      File "sage/symbolic/ring.pyx", line 402, in sage.symbolic.ring.SymbolicRing._element_constructor_ (build/cythonized/sage/symbolic/ring.cpp:6851)
        raise TypeError('positive characteristic not allowed in symbolic computations')
    TypeError: positive characteristic not allowed in symbolic computations
    <BLANKLINE>
    During handling of the above exception, another exception occurred:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py", line 704, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/doctest/forker.py", line 1098, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.functions.log.log[32]>", line 1, in <module>
        log(a,Integer(3))
      File "/home/release/Sage/local/lib64/python3.9/site-packages/sage/functions/log.py", line 455, in log
        return logb(args[0], args[1])
      File "sage/symbolic/function.pyx", line 1179, in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:12857)
        res = super(BuiltinFunction, self).__call__(
      File "sage/symbolic/function.pyx", line 586, in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.cpp:6893)
        raise TypeError("cannot coerce arguments: %s" % (err))
    TypeError: cannot coerce arguments: positive characteristic not allowed in symbolic computations
**********************************************************************
1 item had failures:
   1 of  50 in sage.functions.log.log
    [330 tests, 1 failure, 1.97 s]
----------------------------------------------------------------------
sage -t --long --warn-long 42.3 --random-seed=0 src/sage/functions/log.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

archive/issue_comments_458448.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-07T02:15:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458448",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_458449.json:
```json
{
    "body": "This error is a result of this absolutely hilarious piece of code in `src/sage/functions/log.py`:\n\n```python\n    except ValueError as ex:\n        if repr(ex)[12:27] == \"No discrete log\":\n            raise\n```\n\nThe \"fix\" is easy, but the underlying issue isn't: Has there been any effort to systematize exception types in Sage so that this could be replaced by something along the lines of `except NoSolutionFound:`?",
    "created_at": "2021-09-07T02:17:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458449",
    "user": "https://github.com/yyyyx4"
}
```

This error is a result of this absolutely hilarious piece of code in `src/sage/functions/log.py`:

```python
    except ValueError as ex:
        if repr(ex)[12:27] == "No discrete log":
            raise
```

The "fix" is easy, but the underlying issue isn't: Has there been any effort to systematize exception types in Sage so that this could be replaced by something along the lines of `except NoSolutionFound:`?



---

archive/issue_comments_458450.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-09-07T02:17:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458450",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_458451.json:
```json
{
    "body": "That is quite impressive of a failure. The fix LGTM.\n\nI don't think there has been, although it could be good to have a `NoSolutionError`, perhaps as a subclass of `ArithmeticError`. This likely would need a discussion on sage-devel.",
    "created_at": "2021-09-07T06:42:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458451",
    "user": "https://github.com/tscrim"
}
```

That is quite impressive of a failure. The fix LGTM.

I don't think there has been, although it could be good to have a `NoSolutionError`, perhaps as a subclass of `ArithmeticError`. This likely would need a discussion on sage-devel.



---

archive/issue_comments_458452.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-07T06:42:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458452",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_458453.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-09-13T22:22:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32375#issuecomment-458453",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_085915.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-09-13T22:22:21Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32375",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32375#event-85915"
}
```
