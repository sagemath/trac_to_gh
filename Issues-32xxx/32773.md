# Issue 32773: Another test failure with KlyachkoBundle_class.random_deformation

archive/issues_032536.json:
```json
{
    "body": "Part of #32544:\n\nBug or incorrect test?\n\n```\nsage -t --long --random-seed=23747002002644886606785003174022326205 src/sage/schemes/toric/sheaf/klyachko.py\n**********************************************************************\nFile \"src/sage/schemes/toric/sheaf/klyachko.py\", line 951, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation\nFailed example:\n    Vtilde.cohomology(dim=True, weight=(0,))\nExpected:\n    (1, 0)\nGot:\n    (0, 0)\n```\n\nCC:  @vbraun @orlitzky @collares\n\nAuthor: Markus Wageringel\n\nBranch: u/gh-mwageringel/32773\n\nStatus: needs_review\n\nCommit: 27c8891779b28bf0bf0da619889f8a57458827d4\n\nIssue created by migration from https://trac.sagemath.org/ticket/32773\n\n",
    "created_at": "2021-10-26T09:43:16Z",
    "labels": [
        "component: algebraic geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Another test failure with KlyachkoBundle_class.random_deformation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32773",
    "user": "https://github.com/kliem"
}
```
Part of #32544:

Bug or incorrect test?

```
sage -t --long --random-seed=23747002002644886606785003174022326205 src/sage/schemes/toric/sheaf/klyachko.py
**********************************************************************
File "src/sage/schemes/toric/sheaf/klyachko.py", line 951, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation
Failed example:
    Vtilde.cohomology(dim=True, weight=(0,))
Expected:
    (1, 0)
Got:
    (0, 0)
```

CC:  @vbraun @orlitzky @collares

Author: Markus Wageringel

Branch: u/gh-mwageringel/32773

Status: needs_review

Commit: 27c8891779b28bf0bf0da619889f8a57458827d4

Issue created by migration from https://trac.sagemath.org/ticket/32773





---

archive/issue_comments_653215.json:
```json
{
    "body": "<a id='comment:1'></a>Another one:\n\n```\nsage -t --long --warn-long 289.1 --random-seed=213487260798313884417459570000434714591 src/sage/schemes/toric/sheaf/klyachko.py\n**********************************************************************\nFile \"src/sage/schemes/toric/sheaf/klyachko.py\", line 29, in sage.schemes.toric.sheaf.klyachko\nFailed example:\n    V.cohomology(dim=True, weight=(0,0,0,0))    # long time\nExpected:\n    (0, 0, 3, 0, 0)\nGot:\n    (0, 0, 0, 0, 0)\n```",
    "created_at": "2021-12-04T11:27:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-653215",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:1'></a>Another one:

```
sage -t --long --warn-long 289.1 --random-seed=213487260798313884417459570000434714591 src/sage/schemes/toric/sheaf/klyachko.py
**********************************************************************
File "src/sage/schemes/toric/sheaf/klyachko.py", line 29, in sage.schemes.toric.sheaf.klyachko
Failed example:
    V.cohomology(dim=True, weight=(0,0,0,0))    # long time
Expected:
    (0, 0, 3, 0, 0)
Got:
    (0, 0, 0, 0, 0)
```



---

archive/issue_events_086716.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T20:12:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32773#event-86716"
}
```



---

archive/issue_comments_653216.json:
```json
{
    "body": "<a id='comment:4'></a>The source of the problem seems to be the implementation of `FilteredVectorSpace_class.random_deformation` [(source)](https://github.com/sagemath/sage/blob/97d550d15c2bce750f404034d71b517ab34b5d77/src/sage/modules/filtered_vector_space.py#L1271-L1275). This is the relevant code:\n\n```python\n        filtration = dict()\n        for deg, filt in self._filt[1:]:\n            generators = [v + epsilon * random_vector(R, self.rank())\n                          for v in filt.echelonized_basis()]\n            filtration[deg] = generators\n```\n\nOccasionally, this random deformation results in `generators` that are linearly dependent, so that the new filtered component is of lower dimension than the original. It seems to me that this is not intended, as this will only happen in rare cases. Should we add a check here to avoid this?",
    "created_at": "2022-01-29T21:54:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-653216",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:4'></a>The source of the problem seems to be the implementation of `FilteredVectorSpace_class.random_deformation` [(source)](https://github.com/sagemath/sage/blob/97d550d15c2bce750f404034d71b517ab34b5d77/src/sage/modules/filtered_vector_space.py#L1271-L1275). This is the relevant code:

```python
        filtration = dict()
        for deg, filt in self._filt[1:]:
            generators = [v + epsilon * random_vector(R, self.rank())
                          for v in filt.echelonized_basis()]
            filtration[deg] = generators
```

Occasionally, this random deformation results in `generators` that are linearly dependent, so that the new filtered component is of lower dimension than the original. It seems to me that this is not intended, as this will only happen in rare cases. Should we add a check here to avoid this?



---

archive/issue_comments_653217.json:
```json
{
    "body": "<a id='comment:5'></a>Here is an attempt at a partial fix which I think respects the original intent, while preserving the subspace inclusions and dimensions of the filtered vector spaces.\n\nThis fixes the issue in the description, but the test from comment:1 still sometimes fails:\n\n```\nsage -t --long --warn-long 69.2 --random-seed=298280877953805287150486292027026647714 src/sage/schemes/toric/sheaf/klyachko.py\n**********************************************************************\nFile \"src/sage/schemes/toric/sheaf/klyachko.py\", line 29, in sage.schemes.toric.sheaf.klyachko\nFailed example:\n    V.cohomology(dim=True, weight=(0,0,0,0))    # long time\nExpected:\n    (0, 0, 3, 0, 0)\nGot:\n    (0, 0, 5, 0, 0)\n```\n\n---\nNew commits:",
    "created_at": "2022-01-30T13:35:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-653217",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:5'></a>Here is an attempt at a partial fix which I think respects the original intent, while preserving the subspace inclusions and dimensions of the filtered vector spaces.

This fixes the issue in the description, but the test from comment:1 still sometimes fails:

```
sage -t --long --warn-long 69.2 --random-seed=298280877953805287150486292027026647714 src/sage/schemes/toric/sheaf/klyachko.py
**********************************************************************
File "src/sage/schemes/toric/sheaf/klyachko.py", line 29, in sage.schemes.toric.sheaf.klyachko
Failed example:
    V.cohomology(dim=True, weight=(0,0,0,0))    # long time
Expected:
    (0, 0, 3, 0, 0)
Got:
    (0, 0, 5, 0, 0)
```

---
New commits:



---

archive/issue_comments_653218.json:
```json
{
    "body": "Changing branch from \"\" to \"u/gh-mwageringel/32773\"",
    "created_at": "2022-01-30T13:35:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-653218",
    "user": "https://github.com/mwageringel"
}
```

Changing branch from "" to "u/gh-mwageringel/32773"



---

archive/issue_comments_653219.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-01-30T13:35:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-653219",
    "user": "https://github.com/mwageringel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_653220.json:
```json
{
    "body": "Changing commit from \"\" to \"27c8891779b28bf0bf0da619889f8a57458827d4\"",
    "created_at": "2022-01-30T13:35:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-653220",
    "user": "https://github.com/mwageringel"
}
```

Changing commit from "" to "27c8891779b28bf0bf0da619889f8a57458827d4"



---

archive/issue_comments_653221.json:
```json
{
    "body": "Changing author from \"\" to \"Markus Wageringel\"",
    "created_at": "2022-02-07T00:50:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-653221",
    "user": "https://github.com/slel"
}
```

Changing author from "" to "Markus Wageringel"



---

archive/issue_comments_653222.json:
```json
{
    "body": "<a id='comment:7'></a>If the current fix seems acceptable, I would suggest to open a new ticket for the remaining failure. We can mark it as known bug here to make the tests pass again.",
    "created_at": "2022-02-14T21:18:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-653222",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:7'></a>If the current fix seems acceptable, I would suggest to open a new ticket for the remaining failure. We can mark it as known bug here to make the tests pass again.



---

archive/issue_comments_653223.json:
```json
{
    "body": "<a id='comment:8'></a>It looks like all of this machinery was added specifically for Klyachko bundles, so it really comes down to the intent. And I think the `FilteredVectorSpace` constructor guarantees the subspace inclusions? If so, it's only the dimensions of the components that can cause  an issue; I don't see a problem with that a priori for general filtered vector spaces, but the docs for the Klyachko bundle method say,\n\n> Return a generic torus-equivariant deformation of the bundle... A new Klyachko bundle with randomly perturbed moduli. In particular, the same Chern classes.\n\n\nand I have to admit that I don't know what very many of those words mean. If it's only the Klyachko class that needs the dimensions of the components to remain invariant, it might be better to change\n\n```\nwhile not filt.is_exhaustive():\n    filt = self._filt.random_deformation(epsilon)\n```\n\nto preserve those dimensions as well.",
    "created_at": "2022-02-16T13:03:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-653223",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:8'></a>It looks like all of this machinery was added specifically for Klyachko bundles, so it really comes down to the intent. And I think the `FilteredVectorSpace` constructor guarantees the subspace inclusions? If so, it's only the dimensions of the components that can cause  an issue; I don't see a problem with that a priori for general filtered vector spaces, but the docs for the Klyachko bundle method say,

> Return a generic torus-equivariant deformation of the bundle... A new Klyachko bundle with randomly perturbed moduli. In particular, the same Chern classes.


and I have to admit that I don't know what very many of those words mean. If it's only the Klyachko class that needs the dimensions of the components to remain invariant, it might be better to change

```
while not filt.is_exhaustive():
    filt = self._filt.random_deformation(epsilon)
```

to preserve those dimensions as well.



---

archive/issue_comments_653224.json:
```json
{
    "body": "<a id='comment:9'></a>Yes, I think your assessments are correct. I am not completely sure about the original intent either.\n\n`@`vbraun: Could you help us on this, please? You seem to be the original author. In particular, what is needed for the random deformations of Klyachko bundles to have those properties? And should random deformations of filtered vector spaces preserve the dimensions of their components?",
    "created_at": "2022-02-17T08:59:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-653224",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:9'></a>Yes, I think your assessments are correct. I am not completely sure about the original intent either.

`@`vbraun: Could you help us on this, please? You seem to be the original author. In particular, what is needed for the random deformations of Klyachko bundles to have those properties? And should random deformations of filtered vector spaces preserve the dimensions of their components?



---

archive/issue_comments_653225.json:
```json
{
    "body": "<a id='comment:10'></a>it seems to me that \"random\" here silently   means \"generic\", as well.",
    "created_at": "2022-04-04T11:06:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-653225",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>it seems to me that "random" here silently   means "generic", as well.



---

archive/issue_events_086717.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32773#event-86717"
}
```



---

archive/issue_events_086718.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32773#event-86718"
}
```



---

archive/issue_comments_653226.json:
```json
{
    "body": "<a id='comment:13'></a>This also happens with a different `random-seed`.\n\n```\nsage -t --long --warn-long 91.4 --random-seed=194967010328380092288236333293077030743 /usr/lib/python3.10/site-packages/sage/schemes/toric/sheaf/klyachko.py\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/schemes/toric/sheaf/klyachko.py\", line 951, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation\nFailed example:\n    Vtilde.cohomology(dim=True, weight=(0,))\nExpected:\n    (1, 0)\nGot:\n    (0, 0)\n**********************************************************************\n1 item had failures:\n   1 of   7 in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation\n    [151 tests, 1 failure, 7.14 s]\n----------------------------------------------------------------------\nsage -t --long --warn-long 91.4 --random-seed=19496701032838009228823633\n```",
    "created_at": "2022-08-12T05:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-653226",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:13'></a>This also happens with a different `random-seed`.

```
sage -t --long --warn-long 91.4 --random-seed=194967010328380092288236333293077030743 /usr/lib/python3.10/site-packages/sage/schemes/toric/sheaf/klyachko.py
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/schemes/toric/sheaf/klyachko.py", line 951, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation
Failed example:
    Vtilde.cohomology(dim=True, weight=(0,))
Expected:
    (1, 0)
Got:
    (0, 0)
**********************************************************************
1 item had failures:
   1 of   7 in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation
    [151 tests, 1 failure, 7.14 s]
----------------------------------------------------------------------
sage -t --long --warn-long 91.4 --random-seed=19496701032838009228823633
```



---

archive/issue_comments_653227.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:13 strogdon]:\n> This also happens with a different `random-seed`.\n> \n> ```\n> sage -t --long --warn-long 91.4 --random-seed=194967010328380092288236333293077030743 /usr/lib/python3.10/site-packages/sage/schemes/toric/sheaf/klyachko.py\n> **********************************************************************\n> File \"/usr/lib/python3.10/site-packages/sage/schemes/toric/sheaf/klyachko.py\", line 951, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation\n> Failed example:\n>     Vtilde.cohomology(dim=True, weight=(0,))\n> Expected:\n>     (1, 0)\n> Got:\n>     (0, 0)\n> **********************************************************************\n> 1 item had failures:\n>    1 of   7 in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation\n>     [151 tests, 1 failure, 7.14 s]\n> ----------------------------------------------------------------------\n> sage -t --long --warn-long 91.4 --random-seed=19496701032838009228823633\n> ```\n\nThis was on Sage-on-Gentoo. With vanilla sage the failure is\n\n```\nsage -t --long --warn-long 91.4 --random-seed=194967010328380092288236333293077030743 src/sage/schemes/toric/sheaf/klyachko.py\n**********************************************************************\nFile \"src/sage/schemes/toric/sheaf/klyachko.py\", line 951, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation\nFailed example:\n    Vtilde.cohomology(dim=True, weight=(0,))\nExpected:\n    (1, 0)\nGot:\n    (0, 0)\n**********************************************************************\n1 item had failures:\n   1 of   7 in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation\n    [151 tests, 1 failure, 7.30 s]\n----------------------------------------------------------------------\nsage -t --long --warn-long 91.4 --random-seed=194967010328380092288236333293077030743 src/sage/schemes/toric/sheaf/klyachko.py  # 1 doctest failed\n```",
    "created_at": "2022-08-12T06:00:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-653227",
    "user": "https://github.com/strogdon"
}
```

<a id='comment:14'></a>Replying to [comment:13 strogdon]:
> This also happens with a different `random-seed`.
> 
> ```
> sage -t --long --warn-long 91.4 --random-seed=194967010328380092288236333293077030743 /usr/lib/python3.10/site-packages/sage/schemes/toric/sheaf/klyachko.py
> **********************************************************************
> File "/usr/lib/python3.10/site-packages/sage/schemes/toric/sheaf/klyachko.py", line 951, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation
> Failed example:
>     Vtilde.cohomology(dim=True, weight=(0,))
> Expected:
>     (1, 0)
> Got:
>     (0, 0)
> **********************************************************************
> 1 item had failures:
>    1 of   7 in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation
>     [151 tests, 1 failure, 7.14 s]
> ----------------------------------------------------------------------
> sage -t --long --warn-long 91.4 --random-seed=19496701032838009228823633
> ```

This was on Sage-on-Gentoo. With vanilla sage the failure is

```
sage -t --long --warn-long 91.4 --random-seed=194967010328380092288236333293077030743 src/sage/schemes/toric/sheaf/klyachko.py
**********************************************************************
File "src/sage/schemes/toric/sheaf/klyachko.py", line 951, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation
Failed example:
    Vtilde.cohomology(dim=True, weight=(0,))
Expected:
    (1, 0)
Got:
    (0, 0)
**********************************************************************
1 item had failures:
   1 of   7 in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation
    [151 tests, 1 failure, 7.30 s]
----------------------------------------------------------------------
sage -t --long --warn-long 91.4 --random-seed=194967010328380092288236333293077030743 src/sage/schemes/toric/sheaf/klyachko.py  # 1 doctest failed
```



---

archive/issue_events_086719.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32773#event-86719"
}
```



---

archive/issue_events_086720.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32773#event-86720"
}
```
