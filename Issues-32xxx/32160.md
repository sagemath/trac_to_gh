# Issue 32160: Fix integral involving (x - floor(x))

archive/issues_031923.json:
```json
{
    "body": "Assignee: @daju1\n\nCC:  @EmmanuelCharpentier @slel @frederichan-IMJPRG @mwageringel parisse\n\nKeywords: integral, giac, libgiac\n\nThe following function involves (x - floor(x))\n\n```\nsage: f = (2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3/(x^2 + 1)^6 - 3*x/(x^2 + 1)^5)\n```\n\nIntegrating it gives a wrong answer:\n\n```\nsage: ans_sage = integrate(f, x, 1, +Infinity)\nsage: ans_sage\n3/128*pi - 5/128\nsage: ans_sage.n()\n0.0345685778185108\n```\n\nCompare with the answer given by SciPy:\n\n```\nsage: from scipy import integrate\nsage: ans_scipy = integrate.quad(f, 1, +Infinity)\nsage: ans_scipy[0]\n0.0009945480575073787\n```\n\nThat answer seems correct.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32160\n\n",
    "created_at": "2021-07-08T03:12:45Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Fix integral involving (x - floor(x))",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32160",
    "user": "https://github.com/daju1"
}
```
Assignee: @daju1

CC:  @EmmanuelCharpentier @slel @frederichan-IMJPRG @mwageringel parisse

Keywords: integral, giac, libgiac

The following function involves (x - floor(x))

```
sage: f = (2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3/(x^2 + 1)^6 - 3*x/(x^2 + 1)^5)
```

Integrating it gives a wrong answer:

```
sage: ans_sage = integrate(f, x, 1, +Infinity)
sage: ans_sage
3/128*pi - 5/128
sage: ans_sage.n()
0.0345685778185108
```

Compare with the answer given by SciPy:

```
sage: from scipy import integrate
sage: ans_scipy = integrate.quad(f, 1, +Infinity)
sage: ans_scipy[0]
0.0009945480575073787
```

That answer seems correct.


Issue created by migration from https://trac.sagemath.org/ticket/32160





---

archive/issue_comments_455519.json:
```json
{
    "body": "Attachment [bug integrate of function with floor.ipynb](tarball://root/attachments/some-uuid/ticket32160/bug integrate of function with floor.ipynb) by @daju1 created at 2021-07-08 03:13:43",
    "created_at": "2021-07-08T03:13:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455519",
    "user": "https://github.com/daju1"
}
```

Attachment [bug integrate of function with floor.ipynb](tarball://root/attachments/some-uuid/ticket32160/bug integrate of function with floor.ipynb) by @daju1 created at 2021-07-08 03:13:43



---

archive/issue_comments_455520.json:
```json
{
    "body": "Attachment [bug integrate of function with floor.2.ipynb](tarball://root/attachments/some-uuid/ticket32160/bug integrate of function with floor.2.ipynb) by @daju1 created at 2021-07-11 21:16:23\n\n[https://git.sagemath.org/sage.git/commit/?h=u/gh-daju1/integrate_of_function_which_contains__x___floor_x__](https://git.sagemath.org/sage.git/commit/?h=u/gh-daju1/integrate_of_function_which_contains__x___floor_x__)\n\n---\nNew commits:",
    "created_at": "2021-07-11T21:16:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455520",
    "user": "https://github.com/daju1"
}
```

Attachment [bug integrate of function with floor.2.ipynb](tarball://root/attachments/some-uuid/ticket32160/bug integrate of function with floor.2.ipynb) by @daju1 created at 2021-07-11 21:16:23

[https://git.sagemath.org/sage.git/commit/?h=u/gh-daju1/integrate_of_function_which_contains__x___floor_x__](https://git.sagemath.org/sage.git/commit/?h=u/gh-daju1/integrate_of_function_which_contains__x___floor_x__)

---
New commits:



---

archive/issue_comments_455521.json:
```json
{
    "body": "Set assignee to @daju1.",
    "created_at": "2021-07-11T21:18:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455521",
    "user": "https://github.com/daju1"
}
```

Set assignee to @daju1.



---

archive/issue_comments_455522.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-07-11T21:18:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455522",
    "user": "https://github.com/daju1"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_455523.json:
```json
{
    "body": "Using my commit I have \n\n\n```\nsage: f = (2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3/(x^2 + 1)^6 - 3*x/(x^2 + 1)^5)\n```\n\n\n\n```\nsage: ans_sage = integrate(f, x, 1, +Infinity)\nsage: ans_sage\n```\n\n\n\n```\nintegrate((7*x^2 - 3)*(2*x - 2*floor(x) - 1)*(x - floor(x))*(x - floor(x) - 1)*x/(x^2 + 1)^6, x, 1, +Infinity)\n```\n\n\n\n```\nsage: ans_sage.n()\n```\n\n\n\n```\n0.0009945490551909021\n```\n\nwhich is close to ans_scipy\n\n```\n0.0009945480575073787\n```",
    "created_at": "2021-07-12T06:32:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455523",
    "user": "https://github.com/daju1"
}
```

Using my commit I have 


```
sage: f = (2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3/(x^2 + 1)^6 - 3*x/(x^2 + 1)^5)
```



```
sage: ans_sage = integrate(f, x, 1, +Infinity)
sage: ans_sage
```



```
integrate((7*x^2 - 3)*(2*x - 2*floor(x) - 1)*(x - floor(x))*(x - floor(x) - 1)*x/(x^2 + 1)^6, x, 1, +Infinity)
```



```
sage: ans_sage.n()
```



```
0.0009945490551909021
```

which is close to ans_scipy

```
0.0009945480575073787
```



---

archive/issue_comments_455524.json:
```json
{
    "body": "Needs doctests - \u200bhttps://www.sagemath.org/git-developer-guide/coding_basics.html#writing-testable-examples",
    "created_at": "2021-07-12T18:36:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455524",
    "user": "https://github.com/mkoeppe"
}
```

Needs doctests - â€‹https://www.sagemath.org/git-developer-guide/coding_basics.html#writing-testable-examples



---

archive/issue_comments_455525.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-07-12T18:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455525",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_455526.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-15T21:03:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455526",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_455527.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-07-15T21:04:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455527",
    "user": "https://github.com/daju1"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_455528.json:
```json
{
    "body": "Needs rebase on Sage 9.4.beta5.\n\nThis change would make the example clearer:\n\n```diff\n     Check that :trac:`32160` is fixed::\n \n-        sage: f = (2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3/(x^2 + 1)^6 - 3*x/(x^2 + 1)^5)\n+        sage: g = x - floor(x)\n+        sage: h = x^2 + 1\n+        sage: f = (2*g^3 - 3*g^2 + g)*(10*x^3/h^6 - 3*x/h^5)\n         sage: ans_sage = integrate(f, x, 1, +Infinity)\n         sage: ans_sage\n```",
    "created_at": "2021-07-24T16:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455528",
    "user": "https://github.com/slel"
}
```

Needs rebase on Sage 9.4.beta5.

This change would make the example clearer:

```diff
     Check that :trac:`32160` is fixed::
 
-        sage: f = (2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3/(x^2 + 1)^6 - 3*x/(x^2 + 1)^5)
+        sage: g = x - floor(x)
+        sage: h = x^2 + 1
+        sage: f = (2*g^3 - 3*g^2 + g)*(10*x^3/h^6 - 3*x/h^5)
         sage: ans_sage = integrate(f, x, 1, +Infinity)
         sage: ans_sage
```



---

archive/issue_comments_455529.json:
```json
{
    "body": "Changing keywords from \"\" to \"integral\".",
    "created_at": "2021-07-24T16:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455529",
    "user": "https://github.com/slel"
}
```

Changing keywords from "" to "integral".



---

archive/issue_comments_455530.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-07-24T17:15:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455530",
    "user": "https://github.com/slel"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_455531.json:
```json
{
    "body": "Testing `src/sage/symbolic/integration/integral.py`\nwith the proposed changes (rebased on Sage 9.4.beta5)\nfails for me:\n\n```\n$ sage -t --long src/sage/symbolic/integration/integral.py\ntoo many failed tests, not using stored timings\nRunning doctests with ID 2021-07-24-18-43-49-44924a2f.\nGit branch: 32160\nUsing --optional=build,dochtml,gap_packages,homebrew,libsemigroups,pip,sage,sage_spkg\nDoctesting 1 file.\nsage -t --long --random-seed=0 src/sage/symbolic/integration/integral.py\n**********************************************************************\nFile \"src/sage/symbolic/integration/integral.py\", line 1017, in sage.symbolic.integration.integral.integrate\nFailed example:\n    ans_scipy = integrate.quad(f, 1, +Infinity)\nExpected nothing\nGot:\n    doctest:warning\n      File \"/opt/s/sage9a/src/bin/sage-runtests\", line 144, in <module>\n        err = DC.run()\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/control.py\", line 1207, in run\n        self.run_doctests()\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/control.py\", line 909, in run_doctests\n        self.dispatcher.dispatch()\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 2044, in dispatch\n        self.parallel_dispatch()\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1939, in parallel_dispatch\n        w.start()  # This might take some time\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 2211, in start\n        super(DocTestWorker, self).start()\n      File \"/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/process.py\", line 121, in start\n        self._popen = self._Popen(self)\n      File \"/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/context.py\", line 224, in _Popen\n        return _default_context.get_context().Process._Popen(process_obj)\n      File \"/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/context.py\", line 277, in _Popen\n        return Popen(process_obj)\n      File \"/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/popen_fork.py\", line 19, in __init__\n        self._launch(process_obj)\n      File \"/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/popen_fork.py\", line 71, in _launch\n        code = process_obj._bootstrap(parent_sentinel=child_r)\n      File \"/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/process.py\", line 315, in _bootstrap\n        self.run()\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 2183, in run\n        task(self.options, self.outtmpfile, msgpipe, self.result_queue)\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 2512, in __call__\n        doctests, extras = self._run(runner, options, results)\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 2559, in _run\n        result = runner.run(test)\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 910, in run\n        return self._run(test, compileflags, out)\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 718, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1137, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.symbolic.integration.integral.integrate[166]>\", line 1, in <module>\n        ans_scipy = integrate.quad(f, Integer(1), +Infinity)\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/scipy/integrate/quadpack.py\", line 351, in quad\n        retval = _quad(func, a, b, args, full_output, epsabs, epsrel, limit,\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/scipy/integrate/quadpack.py\", line 465, in _quad\n        return _quadpack._qagie(func,bound,infbounds,args,full_output,epsabs,epsrel,limit)\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/misc/superseded.py\", line 99, in deprecation\n        warning(trac_number, message, DeprecationWarning, stacklevel)\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/misc/superseded.py\", line 145, in warning\n        warn(message, warning_class, stacklevel)\n      File \"/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/warnings.py\", line 109, in _showwarnmsg\n        sw(msg.message, msg.category, msg.filename, msg.lineno,\n    :\n    DeprecationWarning: Substitution using function-call syntax and unnamed arguments is deprecated and will be removed from a future release of Sage; you can use named arguments instead, like EXPR(x=..., y=...)\n    See http://trac.sagemath.org/5930 for details.\n**********************************************************************\nFile \"src/sage/symbolic/integration/integral.py\", line 1018, in sage.symbolic.integration.integral.integrate\nFailed example:\n    ans_scipy[0]\nExpected:\n    0.0009945480575073787\nGot:\n    0.0009945480575073791\n**********************************************************************\n1 item had failures:\n   2 of 169 in sage.symbolic.integration.integral.integrate\n    [229 tests, 2 failures, 826.72 s]\n----------------------------------------------------------------------\nsage -t --long --random-seed=0 src/sage/symbolic/integration/integral.py  # 2 doctests failed\n----------------------------------------------------------------------\nTotal time for all tests: 826.9 seconds\n    cpu time: 804.2 seconds\n    cumulative wall time: 826.7 seconds\nPytest is not installed, skip checking tests that rely on it.\n```\n\nNot sure how to deal with the deprecation warning.\n\nFor the other failure, either use an ellipsis for\nthe last few digits:\n\n```diff\n     sage: ans_scipy[0]\n-    0.0009945480575073787\n+    0.00099454805750737...\n```\nor add a tolerance indication, either absolute:\n\n```diff\n-    sage: ans_scipy[0]\n+    sage: ans_scipy[0]  # abs tol 1e-15\n     0.0009945480575073787\n```\nor relative:\n\n```diff\n-    sage: ans_scipy[0]\n+    sage: ans_scipy[0]  # rel tol 1e-11\n     0.0009945480575073787\n```",
    "created_at": "2021-07-24T17:15:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455531",
    "user": "https://github.com/slel"
}
```

Testing `src/sage/symbolic/integration/integral.py`
with the proposed changes (rebased on Sage 9.4.beta5)
fails for me:

```
$ sage -t --long src/sage/symbolic/integration/integral.py
too many failed tests, not using stored timings
Running doctests with ID 2021-07-24-18-43-49-44924a2f.
Git branch: 32160
Using --optional=build,dochtml,gap_packages,homebrew,libsemigroups,pip,sage,sage_spkg
Doctesting 1 file.
sage -t --long --random-seed=0 src/sage/symbolic/integration/integral.py
**********************************************************************
File "src/sage/symbolic/integration/integral.py", line 1017, in sage.symbolic.integration.integral.integrate
Failed example:
    ans_scipy = integrate.quad(f, 1, +Infinity)
Expected nothing
Got:
    doctest:warning
      File "/opt/s/sage9a/src/bin/sage-runtests", line 144, in <module>
        err = DC.run()
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/control.py", line 1207, in run
        self.run_doctests()
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/control.py", line 909, in run_doctests
        self.dispatcher.dispatch()
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2044, in dispatch
        self.parallel_dispatch()
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1939, in parallel_dispatch
        w.start()  # This might take some time
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2211, in start
        super(DocTestWorker, self).start()
      File "/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/process.py", line 121, in start
        self._popen = self._Popen(self)
      File "/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/context.py", line 224, in _Popen
        return _default_context.get_context().Process._Popen(process_obj)
      File "/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/context.py", line 277, in _Popen
        return Popen(process_obj)
      File "/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/popen_fork.py", line 19, in __init__
        self._launch(process_obj)
      File "/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/popen_fork.py", line 71, in _launch
        code = process_obj._bootstrap(parent_sentinel=child_r)
      File "/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/process.py", line 315, in _bootstrap
        self.run()
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2183, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2512, in __call__
        doctests, extras = self._run(runner, options, results)
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2559, in _run
        result = runner.run(test)
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 910, in run
        return self._run(test, compileflags, out)
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 718, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1137, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.symbolic.integration.integral.integrate[166]>", line 1, in <module>
        ans_scipy = integrate.quad(f, Integer(1), +Infinity)
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/scipy/integrate/quadpack.py", line 351, in quad
        retval = _quad(func, a, b, args, full_output, epsabs, epsrel, limit,
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/scipy/integrate/quadpack.py", line 465, in _quad
        return _quadpack._qagie(func,bound,infbounds,args,full_output,epsabs,epsrel,limit)
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/misc/superseded.py", line 99, in deprecation
        warning(trac_number, message, DeprecationWarning, stacklevel)
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/misc/superseded.py", line 145, in warning
        warn(message, warning_class, stacklevel)
      File "/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/warnings.py", line 109, in _showwarnmsg
        sw(msg.message, msg.category, msg.filename, msg.lineno,
    :
    DeprecationWarning: Substitution using function-call syntax and unnamed arguments is deprecated and will be removed from a future release of Sage; you can use named arguments instead, like EXPR(x=..., y=...)
    See http://trac.sagemath.org/5930 for details.
**********************************************************************
File "src/sage/symbolic/integration/integral.py", line 1018, in sage.symbolic.integration.integral.integrate
Failed example:
    ans_scipy[0]
Expected:
    0.0009945480575073787
Got:
    0.0009945480575073791
**********************************************************************
1 item had failures:
   2 of 169 in sage.symbolic.integration.integral.integrate
    [229 tests, 2 failures, 826.72 s]
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/symbolic/integration/integral.py  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 826.9 seconds
    cpu time: 804.2 seconds
    cumulative wall time: 826.7 seconds
Pytest is not installed, skip checking tests that rely on it.
```

Not sure how to deal with the deprecation warning.

For the other failure, either use an ellipsis for
the last few digits:

```diff
     sage: ans_scipy[0]
-    0.0009945480575073787
+    0.00099454805750737...
```
or add a tolerance indication, either absolute:

```diff
-    sage: ans_scipy[0]
+    sage: ans_scipy[0]  # abs tol 1e-15
     0.0009945480575073787
```
or relative:

```diff
-    sage: ans_scipy[0]
+    sage: ans_scipy[0]  # rel tol 1e-11
     0.0009945480575073787
```



---

archive/issue_comments_455532.json:
```json
{
    "body": "Hi, slelievre\n\nIf you want to make the example more clearer, I can provide the part of my work related with two dimensional Euler-Maclarin formula\n\n```\n\nsage: x,y = var(\"x,y\")                                                                                                                                                           \nsage: f = (x^2 + y^2)^(-2)                                                                                                                                                       \nsage: p = 3                                                                                                                                                                      \nsage: f_diff_x_p = f.diff(x, p)                                                                                                                                                  \nsage: f_diff_x_p                                                                                                                                                                 \n-192*x^3/(x^2 + y^2)^5 + 72*x/(x^2 + y^2)^4\nsage: P = lambda x, p : bernoulli_polynomial(x - floor(x), p)                                                                                                                    \nsage: poly = P(x=x,p=p)/factorial(p)                                                                                                                                             \nsage: poly                                                                                                                                                                       \n1/6*(x - floor(x))^3 - 1/4*(x - floor(x))^2 + 1/12*x - 1/12*floor(x)\nsage: assume(y>0)                                                                                                                                                                \nsage: Rpx = (-1)^(p+1)*integrate(f_diff_x_p*poly, x, 1, Infinity)                                                                                                                \nsage: Rpx                                                                                                                                                                        \n-2*integrate((2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(8*x^3/(x^2 + y^2)^5 - 3*x/(x^2 + y^2)^4), x, 1, +Infinity)\nsage: k = 2                                                                                                                                                                      \nsage: g = bernoulli(k)/factorial(k) * Rpx.diff(y, k-1)                                                                                                                           \nsage: g                                                                                                                                                                          \n4/3*integrate((2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3*y/(x^2 + y^2)^6 - 3*x*y/(x^2 + y^2)^5), x, 1, +Infinity)\nsage: g.subs(y == 1)                                                                                                                                                             \n1/32*pi - 5/96\nsage: g.subs(y == 1).n()                                                                                                                                                         \n0.0460914370913477\n```\n\nthe obtained value is wrong, because\n\n\n```\nsage: from scipy import integrate as scipy_integrate                                                                                                                             \nsage: ans_scipy = (-1)^(p+1) * bernoulli(k)/factorial(k) * scipy_integrate.quad((f_diff_x_p*poly).diff(y,k-1).subs(y == 1), 1, Infinity)[0]                                      \nsage: ans_scipy                                                                                                                                                                  \n0.001326061994802289\n```",
    "created_at": "2021-07-26T09:59:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455532",
    "user": "https://github.com/daju1"
}
```

Hi, slelievre

If you want to make the example more clearer, I can provide the part of my work related with two dimensional Euler-Maclarin formula

```

sage: x,y = var("x,y")                                                                                                                                                           
sage: f = (x^2 + y^2)^(-2)                                                                                                                                                       
sage: p = 3                                                                                                                                                                      
sage: f_diff_x_p = f.diff(x, p)                                                                                                                                                  
sage: f_diff_x_p                                                                                                                                                                 
-192*x^3/(x^2 + y^2)^5 + 72*x/(x^2 + y^2)^4
sage: P = lambda x, p : bernoulli_polynomial(x - floor(x), p)                                                                                                                    
sage: poly = P(x=x,p=p)/factorial(p)                                                                                                                                             
sage: poly                                                                                                                                                                       
1/6*(x - floor(x))^3 - 1/4*(x - floor(x))^2 + 1/12*x - 1/12*floor(x)
sage: assume(y>0)                                                                                                                                                                
sage: Rpx = (-1)^(p+1)*integrate(f_diff_x_p*poly, x, 1, Infinity)                                                                                                                
sage: Rpx                                                                                                                                                                        
-2*integrate((2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(8*x^3/(x^2 + y^2)^5 - 3*x/(x^2 + y^2)^4), x, 1, +Infinity)
sage: k = 2                                                                                                                                                                      
sage: g = bernoulli(k)/factorial(k) * Rpx.diff(y, k-1)                                                                                                                           
sage: g                                                                                                                                                                          
4/3*integrate((2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3*y/(x^2 + y^2)^6 - 3*x*y/(x^2 + y^2)^5), x, 1, +Infinity)
sage: g.subs(y == 1)                                                                                                                                                             
1/32*pi - 5/96
sage: g.subs(y == 1).n()                                                                                                                                                         
0.0460914370913477
```

the obtained value is wrong, because


```
sage: from scipy import integrate as scipy_integrate                                                                                                                             
sage: ans_scipy = (-1)^(p+1) * bernoulli(k)/factorial(k) * scipy_integrate.quad((f_diff_x_p*poly).diff(y,k-1).subs(y == 1), 1, Infinity)[0]                                      
sage: ans_scipy                                                                                                                                                                  
0.001326061994802289
```



---

archive/issue_comments_455533.json:
```json
{
    "body": "Note that `frac(x)` is a nicer way to write `x - floor(x)`.",
    "created_at": "2021-07-26T10:06:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455533",
    "user": "https://github.com/slel"
}
```

Note that `frac(x)` is a nicer way to write `x - floor(x)`.



---

archive/issue_comments_455534.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-28T14:32:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455534",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_455535.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-07-28T14:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455535",
    "user": "https://github.com/daju1"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_455536.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-17T10:58:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455536",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_455537.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-17T21:05:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455537",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_455538.json:
```json
{
    "body": "Could we break the long output line into multiple lines (say at `+`)?",
    "created_at": "2021-08-18T06:19:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455538",
    "user": "https://github.com/tscrim"
}
```

Could we break the long output line into multiple lines (say at `+`)?



---

archive/issue_events_085155.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32160#event-85155"
}
```



---

archive/issue_comments_455539.json:
```json
{
    "body": "I have truncated the doctest.\n\n---\nNew commits:",
    "created_at": "2021-11-02T17:17:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455539",
    "user": "https://github.com/fchapoton"
}
```

I have truncated the doctest.

---
New commits:



---

archive/issue_comments_455540.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-11-12T10:35:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455540",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_455541.json:
```json
{
    "body": "now integration is using libgiac rather than giac, so the proposed fix no longer works",
    "created_at": "2021-11-12T10:35:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455541",
    "user": "https://github.com/fchapoton"
}
```

now integration is using libgiac rather than giac, so the proposed fix no longer works



---

archive/issue_events_085156.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-10T00:37:38Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32160#event-85156"
}
```



---

archive/issue_events_085157.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-10T00:37:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32160#event-85157"
}
```



---

archive/issue_events_085158.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:19:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32160#event-85158"
}
```



---

archive/issue_events_085159.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:19:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32160#event-85159"
}
```



---

archive/issue_comments_455542.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-23T20:46:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455542",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_455543.json:
```json
{
    "body": "This seems to be an error in Giac itself as the antiderivative is not correct. It would be best to report it to Giac upstream, so that it can be fixed there.\n\nIn particular, this is not caused by one of the integration bounds being infinity, and not caused by the switch of integration algorithms from giac to libgiac.\n\nFor a smaller example, consider just the left factor of the original example.\n\n```sage\nsage: g = 2*(frac(x))^3 - 3*(frac(x))^2 + frac(x)     # g is continuous\nsage: G = g.integral(x, algorithm='libgiac'); G       # Tested with Giac 1.9.0\n// Giac share root-directory:/usr/share/giac/\n// Giac share root-directory:/usr/share/giac/\nAdded 0 synonyms\nWarning, integration of abs or sign assumes constant sign by intervals (correct if the argument is real):\nCheck [sign(sageVARx)]\nWarning, integration of abs or sign assumes constant sign by intervals (correct if the argument is real):\nCheck [sign(sageVARx)]\nWarning, integration of abs or sign assumes constant sign by intervals (correct if the argument is real):\nCheck [sign(sageVARx)]\n1/2*x^4 - x^3 - x*floor(x*sgn(x))*sgn(x) + 1/2*x^2\n```\nThis antiderivative is only correct for `0 < x < 1`. For the whole real line, the antiderivative should instead be (I think):\n\n```\nfrac(x)^4/2 - frac(x)^3 + frac(x)^2/2\n```\nGiac did issue some warnings which are a hint that the result might be wrong, but our argument *is* real, so I am not sure what to make of it.",
    "created_at": "2022-07-24T11:21:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455543",
    "user": "https://github.com/mwageringel"
}
```

This seems to be an error in Giac itself as the antiderivative is not correct. It would be best to report it to Giac upstream, so that it can be fixed there.

In particular, this is not caused by one of the integration bounds being infinity, and not caused by the switch of integration algorithms from giac to libgiac.

For a smaller example, consider just the left factor of the original example.

```sage
sage: g = 2*(frac(x))^3 - 3*(frac(x))^2 + frac(x)     # g is continuous
sage: G = g.integral(x, algorithm='libgiac'); G       # Tested with Giac 1.9.0
// Giac share root-directory:/usr/share/giac/
// Giac share root-directory:/usr/share/giac/
Added 0 synonyms
Warning, integration of abs or sign assumes constant sign by intervals (correct if the argument is real):
Check [sign(sageVARx)]
Warning, integration of abs or sign assumes constant sign by intervals (correct if the argument is real):
Check [sign(sageVARx)]
Warning, integration of abs or sign assumes constant sign by intervals (correct if the argument is real):
Check [sign(sageVARx)]
1/2*x^4 - x^3 - x*floor(x*sgn(x))*sgn(x) + 1/2*x^2
```
This antiderivative is only correct for `0 < x < 1`. For the whole real line, the antiderivative should instead be (I think):

```
frac(x)^4/2 - frac(x)^3 + frac(x)^2/2
```
Giac did issue some warnings which are a hint that the result might be wrong, but our argument *is* real, so I am not sure what to make of it.



---

archive/issue_comments_455544.json:
```json
{
    "body": "Changing keywords from \"integral\" to \"integral, giac, libgiac\".",
    "created_at": "2022-07-24T11:21:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455544",
    "user": "https://github.com/mwageringel"
}
```

Changing keywords from "integral" to "integral, giac, libgiac".



---

archive/issue_comments_455545.json:
```json
{
    "body": "First of all I see that in giac online\n\n[https://www.xcasenligne.fr/giac_online/demoGiacPhp.php](https://www.xcasenligne.fr/giac_online/demoGiacPhp.php)\n\n```\nfrac(x)\n```\n\nmeans\n\n```\nx-sign(x)floor(xsign(x))\n```",
    "created_at": "2022-07-31T06:48:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455545",
    "user": "https://github.com/daju1"
}
```

First of all I see that in giac online

[https://www.xcasenligne.fr/giac_online/demoGiacPhp.php](https://www.xcasenligne.fr/giac_online/demoGiacPhp.php)

```
frac(x)
```

means

```
x-sign(x)floor(xsign(x))
```



---

archive/issue_comments_455546.json:
```json
{
    "body": "Oh dear, both Giac and Sage return `-0.25` for `frac(-1.25)`.",
    "created_at": "2022-08-01T09:30:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455546",
    "user": "https://github.com/slel"
}
```

Oh dear, both Giac and Sage return `-0.25` for `frac(-1.25)`.



---

archive/issue_comments_455547.json:
```json
{
    "body": "The definition is a little different. In Sage for `RR` elements, it uses mpfr and satisfies `x == x.trunc() + x.frac()`:\n\n```\nsage: x = -1.25\nsage: x.trunc()\n-1\nsage: x.frac()\n-0.250000000000000\n```\nThis is at odds with the `frac()` function definition.",
    "created_at": "2022-08-03T08:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455547",
    "user": "https://github.com/tscrim"
}
```

The definition is a little different. In Sage for `RR` elements, it uses mpfr and satisfies `x == x.trunc() + x.frac()`:

```
sage: x = -1.25
sage: x.trunc()
-1
sage: x.frac()
-0.250000000000000
```
This is at odds with the `frac()` function definition.



---

archive/issue_comments_455548.json:
```json
{
    "body": "So currently (Sage 9.6) the following mismatches are puzzling:\n\n```\nsage: frac(-1.25)\n-0.250000000000000\nsage: frac(x).subs({x: -1.25})\n0.750000000000000\n```\n\n```\nsage: frac(-1.25r)\n-0.25\nsage: frac(x).subs({x: -1.25r})\n0.75\n```\n\n```\nsage: frac(RDF(-1.25))\n-0.25\nsage: frac(x).subs({x: RDF(-1.25)})\n0.75\n```\n\n```\nsage: plot(frac, (-5, 5), aspect_ratio=1)\nLaunched png viewer for Graphics object consisting of 1 graphics primitive\n```\nRationals behave well:\n\n```\n{{{\nsage: frac(-5/4)\n3/4\nsage: frac(x).subs({x: -5/4})\n3/4\n}}}",
    "created_at": "2022-08-30T14:41:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-455548",
    "user": "https://github.com/slel"
}
```

So currently (Sage 9.6) the following mismatches are puzzling:

```
sage: frac(-1.25)
-0.250000000000000
sage: frac(x).subs({x: -1.25})
0.750000000000000
```

```
sage: frac(-1.25r)
-0.25
sage: frac(x).subs({x: -1.25r})
0.75
```

```
sage: frac(RDF(-1.25))
-0.25
sage: frac(x).subs({x: RDF(-1.25)})
0.75
```

```
sage: plot(frac, (-5, 5), aspect_ratio=1)
Launched png viewer for Graphics object consisting of 1 graphics primitive
```
Rationals behave well:

```
{{{
sage: frac(-5/4)
3/4
sage: frac(x).subs({x: -5/4})
3/4
}}}



---

archive/issue_events_085160.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32160#event-85160"
}
```



---

archive/issue_events_085161.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32160#event-85161"
}
```
