# Issue 32160: Fix integral involving (x - floor(x))

archive/issues_031923.json:
```json
{
    "body": "The following function involves (x - floor(x))\n\n```\nsage: f = (2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3/(x^2 + 1)^6 - 3*x/(x^2 + 1)^5)\n```\n\nIntegrating it gives a wrong answer:\n\n```\nsage: ans_sage = integrate(f, x, 1, +Infinity)\nsage: ans_sage\n3/128*pi - 5/128\nsage: ans_sage.n()\n0.0345685778185108\n```\n\nCompare with the answer given by SciPy:\n\n```\nsage: from scipy import integrate\nsage: ans_scipy = integrate.quad(f, 1, +Infinity)\nsage: ans_scipy[0]\n0.0009945480575073787\n```\n\nThat answer seems correct.\n\n\n**Assignee:** @daju1\n\n**CC:**  @EmmanuelCharpentier @slel @frederichan-IMJPRG @mwageringel parisse\n\n**Keywords:** integral, giac, libgiac\n\n**Branch:** [public/ticket/32160](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/32160)\n\n**Commit:** [382d37aa83c64e2f9cb944797e6aaacf176dc3fb](https://github.com/sagemath/sagetrac-mirror/commit/382d37aa83c64e2f9cb944797e6aaacf176dc3fb)\n\n**Reviewer:** Samuel Leli\u00e8vre\n\n**Author:** Alexey Drozdov\n\n**Status:** needs_work\n\nIssue created by migration from https://trac.sagemath.org/ticket/32160\n\n",
    "created_at": "2021-07-08T03:12:45Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Fix integral involving (x - floor(x))",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32160",
    "user": "https://github.com/daju1"
}
```
The following function involves (x - floor(x))

```
sage: f = (2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3/(x^2 + 1)^6 - 3*x/(x^2 + 1)^5)
```

Integrating it gives a wrong answer:

```
sage: ans_sage = integrate(f, x, 1, +Infinity)
sage: ans_sage
3/128*pi - 5/128
sage: ans_sage.n()
0.0345685778185108
```

Compare with the answer given by SciPy:

```
sage: from scipy import integrate
sage: ans_scipy = integrate.quad(f, 1, +Infinity)
sage: ans_scipy[0]
0.0009945480575073787
```

That answer seems correct.


**Assignee:** @daju1

**CC:**  @EmmanuelCharpentier @slel @frederichan-IMJPRG @mwageringel parisse

**Keywords:** integral, giac, libgiac

**Branch:** [public/ticket/32160](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/32160)

**Commit:** [382d37aa83c64e2f9cb944797e6aaacf176dc3fb](https://github.com/sagemath/sagetrac-mirror/commit/382d37aa83c64e2f9cb944797e6aaacf176dc3fb)

**Reviewer:** Samuel Leli√®vre

**Author:** Alexey Drozdov

**Status:** needs_work

Issue created by migration from https://trac.sagemath.org/ticket/32160





---

archive/attachments_021534.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "bug integrate of function with floor.ipynb",
    "asset_url": "tarball://root/attachments/some-uuid/ticket32160/bug integrate of function with floor.ipynb",
    "created_at": "2021-07-08T03:13:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.ipynb",
    "user": "https://github.com/daju1"
}
```



---

archive/issue_comments_640289.json:
```json
{
    "body": "",
    "created_at": "2021-07-08T03:13:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640289",
    "user": "https://github.com/daju1"
}
```





---

archive/issue_comments_640290.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,41 +2,53 @@\n \n \n ```\n-f = (2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3/(x^2 + 1)^6 - 3*x/(x^2 + 1)^5)\n+sage: f = (2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3/(x^2 + 1)^6 - 3*x/(x^2 + 1)^5)\n ```\n \n \n \n ```\n-ans_sage = integrate(f, x, 1, +Infinity)\n-ans_sage\n+sage: ans_sage = integrate(f, x, 1, +Infinity)\n+sage: ans_sage\n ```\n \n \n+\n+```\n 3/128*pi - 5/128\n+```\n+\n \n \n ```\n-ans_sage.n()\n+sage: ans_sage.n()\n ```\n \n \n+\n+```\n 0.0345685778185108\n+```\n+\n \n seems like ans_sage is wrong\n \n \n ```\n-from scipy import integrate\n-ans_scipy = integrate.quad(f, 1, +Infinity)\n+sage: from scipy import integrate\n+sage: ans_scipy = integrate.quad(f, 1, +Infinity)\n ```\n \n \n ```\n-ans_scipy[0]\n+sage: ans_scipy[0]\n ```\n \n+\n+```\n 0.0009945480575073787\n+```\n+\n \n seems like ans_scipy is true\n \n``````\n",
    "created_at": "2021-07-08T03:44:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640290",
    "user": "https://github.com/daju1"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,41 +2,53 @@
 
 
 ```
-f = (2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3/(x^2 + 1)^6 - 3*x/(x^2 + 1)^5)
+sage: f = (2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3/(x^2 + 1)^6 - 3*x/(x^2 + 1)^5)
 ```
 
 
 
 ```
-ans_sage = integrate(f, x, 1, +Infinity)
-ans_sage
+sage: ans_sage = integrate(f, x, 1, +Infinity)
+sage: ans_sage
 ```
 
 
+
+```
 3/128*pi - 5/128
+```
+
 
 
 ```
-ans_sage.n()
+sage: ans_sage.n()
 ```
 
 
+
+```
 0.0345685778185108
+```
+
 
 seems like ans_sage is wrong
 
 
 ```
-from scipy import integrate
-ans_scipy = integrate.quad(f, 1, +Infinity)
+sage: from scipy import integrate
+sage: ans_scipy = integrate.quad(f, 1, +Infinity)
 ```
 
 
 ```
-ans_scipy[0]
+sage: ans_scipy[0]
 ```
 
+
+```
 0.0009945480575073787
+```
+
 
 seems like ans_scipy is true
 
``````




---

archive/issue_comments_640291.json:
```json
{
    "body": "**Branch:** [u/gh-daju1/integrate_of_function_which_contains__x___floor_x__](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-daju1/integrate_of_function_which_contains__x___floor_x__)",
    "created_at": "2021-07-11T21:02:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640291",
    "user": "https://github.com/daju1"
}
```

**Branch:** [u/gh-daju1/integrate_of_function_which_contains__x___floor_x__](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-daju1/integrate_of_function_which_contains__x___floor_x__)



---

archive/attachments_021535.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "bug integrate of function with floor.2.ipynb",
    "asset_url": "tarball://root/attachments/some-uuid/ticket32160/bug integrate of function with floor.2.ipynb",
    "created_at": "2021-07-11T21:16:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.ipynb",
    "user": "https://github.com/daju1"
}
```



---

archive/issue_comments_640292.json:
```json
{
    "body": "<a id='comment:3'></a>\n[https://git.sagemath.org/sage.git/commit/?h=u/gh-daju1/integrate_of_function_which_contains__x___floor_x__](https://git.sagemath.org/sage.git/commit/?h=u/gh-daju1/integrate_of_function_which_contains__x___floor_x__)\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c76967d57f120cc25952274a62c81ed0d556d3ee\">c76967d</a></td><td><code>Giac interpreter: 'unable to handle infinite boundaries' added</code></td></tr></table>\n",
    "created_at": "2021-07-11T21:16:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640292",
    "user": "https://github.com/daju1"
}
```

<a id='comment:3'></a>
[https://git.sagemath.org/sage.git/commit/?h=u/gh-daju1/integrate_of_function_which_contains__x___floor_x__](https://git.sagemath.org/sage.git/commit/?h=u/gh-daju1/integrate_of_function_which_contains__x___floor_x__)

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c76967d57f120cc25952274a62c81ed0d556d3ee">c76967d</a></td><td><code>Giac interpreter: 'unable to handle infinite boundaries' added</code></td></tr></table>




---

archive/issue_comments_640293.json:
```json
{
    "body": "**Commit:** [c76967d57f120cc25952274a62c81ed0d556d3ee](https://github.com/sagemath/sagetrac-mirror/commit/c76967d57f120cc25952274a62c81ed0d556d3ee)",
    "created_at": "2021-07-11T21:16:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640293",
    "user": "https://github.com/daju1"
}
```

**Commit:** [c76967d57f120cc25952274a62c81ed0d556d3ee](https://github.com/sagemath/sagetrac-mirror/commit/c76967d57f120cc25952274a62c81ed0d556d3ee)



---

archive/issue_comments_640294.json:
```json
{
    "body": "**Assignee:** @daju1",
    "created_at": "2021-07-11T21:18:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640294",
    "user": "https://github.com/daju1"
}
```

**Assignee:** @daju1



---

archive/issue_comments_640295.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2021-07-11T21:18:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640295",
    "user": "https://github.com/daju1"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_640296.json:
```json
{
    "body": "<a id='comment:6'></a>\nUsing my commit I have \n\n\n```\nsage: f = (2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3/(x^2 + 1)^6 - 3*x/(x^2 + 1)^5)\n```\n\n\n\n```\nsage: ans_sage = integrate(f, x, 1, +Infinity)\nsage: ans_sage\n```\n\n\n\n```\nintegrate((7*x^2 - 3)*(2*x - 2*floor(x) - 1)*(x - floor(x))*(x - floor(x) - 1)*x/(x^2 + 1)^6, x, 1, +Infinity)\n```\n\n\n\n```\nsage: ans_sage.n()\n```\n\n\n\n```\n0.0009945490551909021\n```\n\nwhich is close to ans_scipy\n\n```\n0.0009945480575073787\n```",
    "created_at": "2021-07-12T06:32:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640296",
    "user": "https://github.com/daju1"
}
```

<a id='comment:6'></a>
Using my commit I have 


```
sage: f = (2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3/(x^2 + 1)^6 - 3*x/(x^2 + 1)^5)
```



```
sage: ans_sage = integrate(f, x, 1, +Infinity)
sage: ans_sage
```



```
integrate((7*x^2 - 3)*(2*x - 2*floor(x) - 1)*(x - floor(x))*(x - floor(x) - 1)*x/(x^2 + 1)^6, x, 1, +Infinity)
```



```
sage: ans_sage.n()
```



```
0.0009945490551909021
```

which is close to ans_scipy

```
0.0009945480575073787
```



---

archive/issue_comments_640297.json:
```json
{
    "body": "<a id='comment:7'></a>\nNeeds doctests - \u200bhttps://www.sagemath.org/git-developer-guide/coding_basics.html#writing-testable-examples",
    "created_at": "2021-07-12T18:36:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640297",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>
Needs doctests - ‚Äãhttps://www.sagemath.org/git-developer-guide/coding_basics.html#writing-testable-examples



---

archive/issue_comments_640298.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2021-07-12T18:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640298",
    "user": "https://github.com/mkoeppe"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_640299.json:
```json
{
    "body": "**Author:** Alexey Drozdov",
    "created_at": "2021-07-12T18:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640299",
    "user": "https://github.com/mkoeppe"
}
```

**Author:** Alexey Drozdov



---

archive/issue_comments_640300.json:
```json
{
    "body": "<a id='comment:9'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ef7506157f7bdac4a784b3a69e663cfd144bd927\">ef75061</a></td><td><code>Trac: #32160 testable example added</code></td></tr></table>\n",
    "created_at": "2021-07-15T21:03:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640300",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ef7506157f7bdac4a784b3a69e663cfd144bd927">ef75061</a></td><td><code>Trac: #32160 testable example added</code></td></tr></table>




---

archive/issue_comments_640301.json:
```json
{
    "body": "**Changing commit** from \"[c76967d57f120cc25952274a62c81ed0d556d3ee](https://github.com/sagemath/sagetrac-mirror/commit/c76967d57f120cc25952274a62c81ed0d556d3ee)\" to \"[ef7506157f7bdac4a784b3a69e663cfd144bd927](https://github.com/sagemath/sagetrac-mirror/commit/ef7506157f7bdac4a784b3a69e663cfd144bd927)\".",
    "created_at": "2021-07-15T21:03:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640301",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[c76967d57f120cc25952274a62c81ed0d556d3ee](https://github.com/sagemath/sagetrac-mirror/commit/c76967d57f120cc25952274a62c81ed0d556d3ee)" to "[ef7506157f7bdac4a784b3a69e663cfd144bd927](https://github.com/sagemath/sagetrac-mirror/commit/ef7506157f7bdac4a784b3a69e663cfd144bd927)".



---

archive/issue_comments_640302.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2021-07-15T21:04:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640302",
    "user": "https://github.com/daju1"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_640303.json:
```json
{
    "body": "**Reviewer:** Samuel Leli\u00e8vre",
    "created_at": "2021-07-24T16:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640303",
    "user": "https://github.com/slel"
}
```

**Reviewer:** Samuel Leli√®vre



---

archive/issue_events_095794.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "rename": {
        "from": "Integrate of function which contains (x - floor(x))",
        "to": "Fix integral involving (x - floor(x))"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32160#event-95794"
}
```



---

archive/issue_comments_640304.json:
```json
{
    "body": "<a id='comment:11'></a>\nNeeds rebase on Sage 9.4.beta5.\n\nThis change would make the example clearer:\n\n```diff\n     Check that :trac:`32160` is fixed::\n \n-        sage: f = (2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3/(x^2 + 1)^6 - 3*x/(x^2 + 1)^5)\n+        sage: g = x - floor(x)\n+        sage: h = x^2 + 1\n+        sage: f = (2*g^3 - 3*g^2 + g)*(10*x^3/h^6 - 3*x/h^5)\n         sage: ans_sage = integrate(f, x, 1, +Infinity)\n         sage: ans_sage\n```",
    "created_at": "2021-07-24T16:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640304",
    "user": "https://github.com/slel"
}
```

<a id='comment:11'></a>
Needs rebase on Sage 9.4.beta5.

This change would make the example clearer:

```diff
     Check that :trac:`32160` is fixed::
 
-        sage: f = (2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3/(x^2 + 1)^6 - 3*x/(x^2 + 1)^5)
+        sage: g = x - floor(x)
+        sage: h = x^2 + 1
+        sage: f = (2*g^3 - 3*g^2 + g)*(10*x^3/h^6 - 3*x/h^5)
         sage: ans_sage = integrate(f, x, 1, +Infinity)
         sage: ans_sage
```



---

archive/issue_comments_640305.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,55 +1,27 @@\n-Lets try to integrate the following function which contains (x - floor(x))\n-\n+The following function involves (x - floor(x))\n \n ```\n sage: f = (2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3/(x^2 + 1)^6 - 3*x/(x^2 + 1)^5)\n ```\n \n-\n+Integrating it gives a wrong answer:\n \n ```\n sage: ans_sage = integrate(f, x, 1, +Infinity)\n sage: ans_sage\n-```\n-\n-\n-\n-```\n 3/128*pi - 5/128\n-```\n-\n-\n-\n-```\n sage: ans_sage.n()\n-```\n-\n-\n-\n-```\n 0.0345685778185108\n ```\n \n-\n-seems like ans_sage is wrong\n-\n+Compare with the answer given by SciPy:\n \n ```\n sage: from scipy import integrate\n sage: ans_scipy = integrate.quad(f, 1, +Infinity)\n-```\n-\n-\n-```\n sage: ans_scipy[0]\n-```\n-\n-\n-```\n 0.0009945480575073787\n ```\n \n+That answer seems correct.\n \n-seems like ans_scipy is true\n-\n-\n``````\n",
    "created_at": "2021-07-24T16:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640305",
    "user": "https://github.com/slel"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,55 +1,27 @@
-Lets try to integrate the following function which contains (x - floor(x))
-
+The following function involves (x - floor(x))
 
 ```
 sage: f = (2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3/(x^2 + 1)^6 - 3*x/(x^2 + 1)^5)
 ```
 
-
+Integrating it gives a wrong answer:
 
 ```
 sage: ans_sage = integrate(f, x, 1, +Infinity)
 sage: ans_sage
-```
-
-
-
-```
 3/128*pi - 5/128
-```
-
-
-
-```
 sage: ans_sage.n()
-```
-
-
-
-```
 0.0345685778185108
 ```
 
-
-seems like ans_sage is wrong
-
+Compare with the answer given by SciPy:
 
 ```
 sage: from scipy import integrate
 sage: ans_scipy = integrate.quad(f, 1, +Infinity)
-```
-
-
-```
 sage: ans_scipy[0]
-```
-
-
-```
 0.0009945480575073787
 ```
 
+That answer seems correct.
 
-seems like ans_scipy is true
-
-
``````




---

archive/issue_comments_640306.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"integral\".",
    "created_at": "2021-07-24T16:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640306",
    "user": "https://github.com/slel"
}
```

**Changing keywords** from "" to "integral".



---

archive/issue_comments_640307.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2021-07-24T17:15:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640307",
    "user": "https://github.com/slel"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_640308.json:
```json
{
    "body": "<a id='comment:12'></a>\nTesting `src/sage/symbolic/integration/integral.py`\nwith the proposed changes (rebased on Sage 9.4.beta5)\nfails for me:\n\n```\n$ sage -t --long src/sage/symbolic/integration/integral.py\ntoo many failed tests, not using stored timings\nRunning doctests with ID 2021-07-24-18-43-49-44924a2f.\nGit branch: 32160\nUsing --optional=build,dochtml,gap_packages,homebrew,libsemigroups,pip,sage,sage_spkg\nDoctesting 1 file.\nsage -t --long --random-seed=0 src/sage/symbolic/integration/integral.py\n**********************************************************************\nFile \"src/sage/symbolic/integration/integral.py\", line 1017, in sage.symbolic.integration.integral.integrate\nFailed example:\n    ans_scipy = integrate.quad(f, 1, +Infinity)\nExpected nothing\nGot:\n    doctest:warning\n      File \"/opt/s/sage9a/src/bin/sage-runtests\", line 144, in <module>\n        err = DC.run()\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/control.py\", line 1207, in run\n        self.run_doctests()\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/control.py\", line 909, in run_doctests\n        self.dispatcher.dispatch()\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 2044, in dispatch\n        self.parallel_dispatch()\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1939, in parallel_dispatch\n        w.start()  # This might take some time\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 2211, in start\n        super(DocTestWorker, self).start()\n      File \"/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/process.py\", line 121, in start\n        self._popen = self._Popen(self)\n      File \"/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/context.py\", line 224, in _Popen\n        return `_default_`context.get_context().Process._Popen(process_obj)\n      File \"/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/context.py\", line 277, in _Popen\n        return Popen(process_obj)\n      File \"/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/popen_fork.py\", line 19, in `__init__`\n        self._launch(process_obj)\n      File \"/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/popen_fork.py\", line 71, in _launch\n        code = process_obj._bootstrap(parent_sentinel=child_r)\n      File \"/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/process.py\", line 315, in _bootstrap\n        self.run()\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 2183, in run\n        task(self.options, self.outtmpfile, msgpipe, self.result_queue)\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 2512, in `__call__`\n        doctests, extras = self._run(runner, options, results)\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 2559, in _run\n        result = runner.run(test)\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 910, in run\n        return self._run(test, compileflags, out)\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 718, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1137, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.symbolic.integration.integral.integrate[166]>\", line 1, in <module>\n        ans_scipy = integrate.quad(f, Integer(1), +Infinity)\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/scipy/integrate/quadpack.py\", line 351, in quad\n        retval = _quad(func, a, b, args, full_output, epsabs, epsrel, limit,\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/scipy/integrate/quadpack.py\", line 465, in _quad\n        return _quadpack._qagie(func,bound,infbounds,args,full_output,epsabs,epsrel,limit)\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/misc/superseded.py\", line 99, in deprecation\n        warning(trac_number, message, DeprecationWarning, stacklevel)\n      File \"/opt/s/sage9a/local/lib/python3.9/site-packages/sage/misc/superseded.py\", line 145, in warning\n        warn(message, warning_class, stacklevel)\n      File \"/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/warnings.py\", line 109, in _showwarnmsg\n        sw(msg.message, msg.category, msg.filename, msg.lineno,\n    :\n    DeprecationWarning: Substitution using function-call syntax and unnamed arguments is deprecated and will be removed from a future release of Sage; you can use named arguments instead, like EXPR(x=..., y=...)\n    See http://trac.sagemath.org/5930 for details.\n**********************************************************************\nFile \"src/sage/symbolic/integration/integral.py\", line 1018, in sage.symbolic.integration.integral.integrate\nFailed example:\n    ans_scipy[0]\nExpected:\n    0.0009945480575073787\nGot:\n    0.0009945480575073791\n**********************************************************************\n1 item had failures:\n   2 of 169 in sage.symbolic.integration.integral.integrate\n    [229 tests, 2 failures, 826.72 s]\n----------------------------------------------------------------------\nsage -t --long --random-seed=0 src/sage/symbolic/integration/integral.py  # 2 doctests failed\n----------------------------------------------------------------------\nTotal time for all tests: 826.9 seconds\n    cpu time: 804.2 seconds\n    cumulative wall time: 826.7 seconds\nPytest is not installed, skip checking tests that rely on it.\n```\n\nNot sure how to deal with the deprecation warning.\n\nFor the other failure, either use an ellipsis for\nthe last few digits:\n\n```diff\n     sage: ans_scipy[0]\n-    0.0009945480575073787\n+    0.00099454805750737...\n```\nor add a tolerance indication, either absolute:\n\n```diff\n-    sage: ans_scipy[0]\n+    sage: ans_scipy[0]  # abs tol 1e-15\n     0.0009945480575073787\n```\nor relative:\n\n```diff\n-    sage: ans_scipy[0]\n+    sage: ans_scipy[0]  # rel tol 1e-11\n     0.0009945480575073787\n```",
    "created_at": "2021-07-24T17:15:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640308",
    "user": "https://github.com/slel"
}
```

<a id='comment:12'></a>
Testing `src/sage/symbolic/integration/integral.py`
with the proposed changes (rebased on Sage 9.4.beta5)
fails for me:

```
$ sage -t --long src/sage/symbolic/integration/integral.py
too many failed tests, not using stored timings
Running doctests with ID 2021-07-24-18-43-49-44924a2f.
Git branch: 32160
Using --optional=build,dochtml,gap_packages,homebrew,libsemigroups,pip,sage,sage_spkg
Doctesting 1 file.
sage -t --long --random-seed=0 src/sage/symbolic/integration/integral.py
**********************************************************************
File "src/sage/symbolic/integration/integral.py", line 1017, in sage.symbolic.integration.integral.integrate
Failed example:
    ans_scipy = integrate.quad(f, 1, +Infinity)
Expected nothing
Got:
    doctest:warning
      File "/opt/s/sage9a/src/bin/sage-runtests", line 144, in <module>
        err = DC.run()
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/control.py", line 1207, in run
        self.run_doctests()
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/control.py", line 909, in run_doctests
        self.dispatcher.dispatch()
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2044, in dispatch
        self.parallel_dispatch()
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1939, in parallel_dispatch
        w.start()  # This might take some time
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2211, in start
        super(DocTestWorker, self).start()
      File "/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/process.py", line 121, in start
        self._popen = self._Popen(self)
      File "/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/context.py", line 224, in _Popen
        return `_default_`context.get_context().Process._Popen(process_obj)
      File "/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/context.py", line 277, in _Popen
        return Popen(process_obj)
      File "/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/popen_fork.py", line 19, in `__init__`
        self._launch(process_obj)
      File "/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/popen_fork.py", line 71, in _launch
        code = process_obj._bootstrap(parent_sentinel=child_r)
      File "/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/multiprocessing/process.py", line 315, in _bootstrap
        self.run()
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2183, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2512, in `__call__`
        doctests, extras = self._run(runner, options, results)
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2559, in _run
        result = runner.run(test)
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 910, in run
        return self._run(test, compileflags, out)
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 718, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1137, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.symbolic.integration.integral.integrate[166]>", line 1, in <module>
        ans_scipy = integrate.quad(f, Integer(1), +Infinity)
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/scipy/integrate/quadpack.py", line 351, in quad
        retval = _quad(func, a, b, args, full_output, epsabs, epsrel, limit,
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/scipy/integrate/quadpack.py", line 465, in _quad
        return _quadpack._qagie(func,bound,infbounds,args,full_output,epsabs,epsrel,limit)
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/misc/superseded.py", line 99, in deprecation
        warning(trac_number, message, DeprecationWarning, stacklevel)
      File "/opt/s/sage9a/local/lib/python3.9/site-packages/sage/misc/superseded.py", line 145, in warning
        warn(message, warning_class, stacklevel)
      File "/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/warnings.py", line 109, in _showwarnmsg
        sw(msg.message, msg.category, msg.filename, msg.lineno,
    :
    DeprecationWarning: Substitution using function-call syntax and unnamed arguments is deprecated and will be removed from a future release of Sage; you can use named arguments instead, like EXPR(x=..., y=...)
    See http://trac.sagemath.org/5930 for details.
**********************************************************************
File "src/sage/symbolic/integration/integral.py", line 1018, in sage.symbolic.integration.integral.integrate
Failed example:
    ans_scipy[0]
Expected:
    0.0009945480575073787
Got:
    0.0009945480575073791
**********************************************************************
1 item had failures:
   2 of 169 in sage.symbolic.integration.integral.integrate
    [229 tests, 2 failures, 826.72 s]
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/symbolic/integration/integral.py  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 826.9 seconds
    cpu time: 804.2 seconds
    cumulative wall time: 826.7 seconds
Pytest is not installed, skip checking tests that rely on it.
```

Not sure how to deal with the deprecation warning.

For the other failure, either use an ellipsis for
the last few digits:

```diff
     sage: ans_scipy[0]
-    0.0009945480575073787
+    0.00099454805750737...
```
or add a tolerance indication, either absolute:

```diff
-    sage: ans_scipy[0]
+    sage: ans_scipy[0]  # abs tol 1e-15
     0.0009945480575073787
```
or relative:

```diff
-    sage: ans_scipy[0]
+    sage: ans_scipy[0]  # rel tol 1e-11
     0.0009945480575073787
```



---

archive/issue_comments_640309.json:
```json
{
    "body": "<a id='comment:13'></a>\nHi, slelievre\n\nIf you want to make the example more clearer, I can provide the part of my work related with two dimensional Euler-Maclarin formula\n\n```\n\nsage: x,y = var(\"x,y\")                                                                                                                                                           \nsage: f = (x^2 + y^2)^(-2)                                                                                                                                                       \nsage: p = 3                                                                                                                                                                      \nsage: f_diff_x_p = f.diff(x, p)                                                                                                                                                  \nsage: f_diff_x_p                                                                                                                                                                 \n-192*x^3/(x^2 + y^2)^5 + 72*x/(x^2 + y^2)^4\nsage: P = lambda x, p : bernoulli_polynomial(x - floor(x), p)                                                                                                                    \nsage: poly = P(x=x,p=p)/factorial(p)                                                                                                                                             \nsage: poly                                                                                                                                                                       \n1/6*(x - floor(x))^3 - 1/4*(x - floor(x))^2 + 1/12*x - 1/12*floor(x)\nsage: assume(y>0)                                                                                                                                                                \nsage: Rpx = (-1)^(p+1)*integrate(f_diff_x_p*poly, x, 1, Infinity)                                                                                                                \nsage: Rpx                                                                                                                                                                        \n-2*integrate((2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(8*x^3/(x^2 + y^2)^5 - 3*x/(x^2 + y^2)^4), x, 1, +Infinity)\nsage: k = 2                                                                                                                                                                      \nsage: g = bernoulli(k)/factorial(k) * Rpx.diff(y, k-1)                                                                                                                           \nsage: g                                                                                                                                                                          \n4/3*integrate((2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3*y/(x^2 + y^2)^6 - 3*x*y/(x^2 + y^2)^5), x, 1, +Infinity)\nsage: g.subs(y == 1)                                                                                                                                                             \n1/32*pi - 5/96\nsage: g.subs(y == 1).n()                                                                                                                                                         \n0.0460914370913477\n```\n\nthe obtained value is wrong, because\n\n\n```\nsage: from scipy import integrate as scipy_integrate                                                                                                                             \nsage: ans_scipy = (-1)^(p+1) * bernoulli(k)/factorial(k) * scipy_integrate.quad((f_diff_x_p*poly).diff(y,k-1).subs(y == 1), 1, Infinity)[0]                                      \nsage: ans_scipy                                                                                                                                                                  \n0.001326061994802289\n```",
    "created_at": "2021-07-26T09:59:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640309",
    "user": "https://github.com/daju1"
}
```

<a id='comment:13'></a>
Hi, slelievre

If you want to make the example more clearer, I can provide the part of my work related with two dimensional Euler-Maclarin formula

```

sage: x,y = var("x,y")                                                                                                                                                           
sage: f = (x^2 + y^2)^(-2)                                                                                                                                                       
sage: p = 3                                                                                                                                                                      
sage: f_diff_x_p = f.diff(x, p)                                                                                                                                                  
sage: f_diff_x_p                                                                                                                                                                 
-192*x^3/(x^2 + y^2)^5 + 72*x/(x^2 + y^2)^4
sage: P = lambda x, p : bernoulli_polynomial(x - floor(x), p)                                                                                                                    
sage: poly = P(x=x,p=p)/factorial(p)                                                                                                                                             
sage: poly                                                                                                                                                                       
1/6*(x - floor(x))^3 - 1/4*(x - floor(x))^2 + 1/12*x - 1/12*floor(x)
sage: assume(y>0)                                                                                                                                                                
sage: Rpx = (-1)^(p+1)*integrate(f_diff_x_p*poly, x, 1, Infinity)                                                                                                                
sage: Rpx                                                                                                                                                                        
-2*integrate((2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(8*x^3/(x^2 + y^2)^5 - 3*x/(x^2 + y^2)^4), x, 1, +Infinity)
sage: k = 2                                                                                                                                                                      
sage: g = bernoulli(k)/factorial(k) * Rpx.diff(y, k-1)                                                                                                                           
sage: g                                                                                                                                                                          
4/3*integrate((2*(x - floor(x))^3 - 3*(x - floor(x))^2 + x - floor(x))*(10*x^3*y/(x^2 + y^2)^6 - 3*x*y/(x^2 + y^2)^5), x, 1, +Infinity)
sage: g.subs(y == 1)                                                                                                                                                             
1/32*pi - 5/96
sage: g.subs(y == 1).n()                                                                                                                                                         
0.0460914370913477
```

the obtained value is wrong, because


```
sage: from scipy import integrate as scipy_integrate                                                                                                                             
sage: ans_scipy = (-1)^(p+1) * bernoulli(k)/factorial(k) * scipy_integrate.quad((f_diff_x_p*poly).diff(y,k-1).subs(y == 1), 1, Infinity)[0]                                      
sage: ans_scipy                                                                                                                                                                  
0.001326061994802289
```



---

archive/issue_comments_640310.json:
```json
{
    "body": "<a id='comment:14'></a>\nNote that `frac(x)` is a nicer way to write `x - floor(x)`.",
    "created_at": "2021-07-26T10:06:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640310",
    "user": "https://github.com/slel"
}
```

<a id='comment:14'></a>
Note that `frac(x)` is a nicer way to write `x - floor(x)`.



---

archive/issue_comments_640311.json:
```json
{
    "body": "<a id='comment:15'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7d7c888f1cbf1c09bae9cde44ff98e6628cc1c2d\">7d7c888</a></td><td><code>Trac: #32160 testable example fixed</code></td></tr></table>\n",
    "created_at": "2021-07-28T14:32:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640311",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7d7c888f1cbf1c09bae9cde44ff98e6628cc1c2d">7d7c888</a></td><td><code>Trac: #32160 testable example fixed</code></td></tr></table>




---

archive/issue_comments_640312.json:
```json
{
    "body": "**Changing commit** from \"[ef7506157f7bdac4a784b3a69e663cfd144bd927](https://github.com/sagemath/sagetrac-mirror/commit/ef7506157f7bdac4a784b3a69e663cfd144bd927)\" to \"[7d7c888f1cbf1c09bae9cde44ff98e6628cc1c2d](https://github.com/sagemath/sagetrac-mirror/commit/7d7c888f1cbf1c09bae9cde44ff98e6628cc1c2d)\".",
    "created_at": "2021-07-28T14:32:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640312",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[ef7506157f7bdac4a784b3a69e663cfd144bd927](https://github.com/sagemath/sagetrac-mirror/commit/ef7506157f7bdac4a784b3a69e663cfd144bd927)" to "[7d7c888f1cbf1c09bae9cde44ff98e6628cc1c2d](https://github.com/sagemath/sagetrac-mirror/commit/7d7c888f1cbf1c09bae9cde44ff98e6628cc1c2d)".



---

archive/issue_comments_640313.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2021-07-28T14:33:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640313",
    "user": "https://github.com/daju1"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_640314.json:
```json
{
    "body": "**Changing commit** from \"[7d7c888f1cbf1c09bae9cde44ff98e6628cc1c2d](https://github.com/sagemath/sagetrac-mirror/commit/7d7c888f1cbf1c09bae9cde44ff98e6628cc1c2d)\" to \"[26539f09d9f151c026e249757bbe59e5fe230e3a](https://github.com/sagemath/sagetrac-mirror/commit/26539f09d9f151c026e249757bbe59e5fe230e3a)\".",
    "created_at": "2021-08-17T10:58:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640314",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[7d7c888f1cbf1c09bae9cde44ff98e6628cc1c2d](https://github.com/sagemath/sagetrac-mirror/commit/7d7c888f1cbf1c09bae9cde44ff98e6628cc1c2d)" to "[26539f09d9f151c026e249757bbe59e5fe230e3a](https://github.com/sagemath/sagetrac-mirror/commit/26539f09d9f151c026e249757bbe59e5fe230e3a)".



---

archive/issue_comments_640315.json:
```json
{
    "body": "<a id='comment:17'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/26539f09d9f151c026e249757bbe59e5fe230e3a\">26539f0</a></td><td><code>Merge tag '9.4.rc2' into t/32160/integrate_of_function_which_contains__x___floor_x__</code></td></tr></table>\n",
    "created_at": "2021-08-17T10:58:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640315",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/26539f09d9f151c026e249757bbe59e5fe230e3a">26539f0</a></td><td><code>Merge tag '9.4.rc2' into t/32160/integrate_of_function_which_contains__x___floor_x__</code></td></tr></table>




---

archive/issue_comments_640316.json:
```json
{
    "body": "<a id='comment:18'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c1e475a22f4553a39d9eddd56ab18080ca725eee\">c1e475a</a></td><td><code>Trac: #32160 testable example fixed according with enhanced switching between integrators</code></td></tr></table>\n",
    "created_at": "2021-08-17T21:05:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640316",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c1e475a22f4553a39d9eddd56ab18080ca725eee">c1e475a</a></td><td><code>Trac: #32160 testable example fixed according with enhanced switching between integrators</code></td></tr></table>




---

archive/issue_comments_640317.json:
```json
{
    "body": "**Changing commit** from \"[26539f09d9f151c026e249757bbe59e5fe230e3a](https://github.com/sagemath/sagetrac-mirror/commit/26539f09d9f151c026e249757bbe59e5fe230e3a)\" to \"[c1e475a22f4553a39d9eddd56ab18080ca725eee](https://github.com/sagemath/sagetrac-mirror/commit/c1e475a22f4553a39d9eddd56ab18080ca725eee)\".",
    "created_at": "2021-08-17T21:05:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640317",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[26539f09d9f151c026e249757bbe59e5fe230e3a](https://github.com/sagemath/sagetrac-mirror/commit/26539f09d9f151c026e249757bbe59e5fe230e3a)" to "[c1e475a22f4553a39d9eddd56ab18080ca725eee](https://github.com/sagemath/sagetrac-mirror/commit/c1e475a22f4553a39d9eddd56ab18080ca725eee)".



---

archive/issue_comments_640318.json:
```json
{
    "body": "<a id='comment:19'></a>\nCould we break the long output line into multiple lines (say at `+`)?",
    "created_at": "2021-08-18T06:19:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640318",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:19'></a>
Could we break the long output line into multiple lines (say at `+`)?



---

archive/issue_events_095795.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32160#event-95795"
}
```



---

archive/issue_comments_640319.json:
```json
{
    "body": "**Changing branch** from \"[u/gh-daju1/integrate_of_function_which_contains__x___floor_x__](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-daju1/integrate_of_function_which_contains__x___floor_x__)\" to \"[public/ticket/32160](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/32160)\".",
    "created_at": "2021-11-02T17:17:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640319",
    "user": "https://github.com/fchapoton"
}
```

**Changing branch** from "[u/gh-daju1/integrate_of_function_which_contains__x___floor_x__](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-daju1/integrate_of_function_which_contains__x___floor_x__)" to "[public/ticket/32160](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/32160)".



---

archive/issue_comments_640320.json:
```json
{
    "body": "<a id='comment:21'></a>\nI have truncated the doctest.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e3951cea695a7f05bbb5f546b4ff07abcd3a123b\">e3951ce</a></td><td><code>Merge branch 'u/gh-daju1/integrate_of_function_which_contains__x___floor_x__' in 9.5.b5</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/339ef17fa76b75d5717e1a81cfd2ae6f0ac65902\">339ef17</a></td><td><code>shorten doctest</code></td></tr></table>\n",
    "created_at": "2021-11-02T17:17:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640320",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:21'></a>
I have truncated the doctest.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e3951cea695a7f05bbb5f546b4ff07abcd3a123b">e3951ce</a></td><td><code>Merge branch 'u/gh-daju1/integrate_of_function_which_contains__x___floor_x__' in 9.5.b5</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/339ef17fa76b75d5717e1a81cfd2ae6f0ac65902">339ef17</a></td><td><code>shorten doctest</code></td></tr></table>




---

archive/issue_comments_640321.json:
```json
{
    "body": "**Changing commit** from \"[c1e475a22f4553a39d9eddd56ab18080ca725eee](https://github.com/sagemath/sagetrac-mirror/commit/c1e475a22f4553a39d9eddd56ab18080ca725eee)\" to \"[339ef17fa76b75d5717e1a81cfd2ae6f0ac65902](https://github.com/sagemath/sagetrac-mirror/commit/339ef17fa76b75d5717e1a81cfd2ae6f0ac65902)\".",
    "created_at": "2021-11-02T17:17:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640321",
    "user": "https://github.com/fchapoton"
}
```

**Changing commit** from "[c1e475a22f4553a39d9eddd56ab18080ca725eee](https://github.com/sagemath/sagetrac-mirror/commit/c1e475a22f4553a39d9eddd56ab18080ca725eee)" to "[339ef17fa76b75d5717e1a81cfd2ae6f0ac65902](https://github.com/sagemath/sagetrac-mirror/commit/339ef17fa76b75d5717e1a81cfd2ae6f0ac65902)".



---

archive/issue_comments_640322.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2021-11-12T10:35:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640322",
    "user": "https://github.com/fchapoton"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_640323.json:
```json
{
    "body": "<a id='comment:22'></a>\nnow integration is using libgiac rather than giac, so the proposed fix no longer works",
    "created_at": "2021-11-12T10:35:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640323",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:22'></a>
now integration is using libgiac rather than giac, so the proposed fix no longer works



---

archive/issue_events_095796.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-10T00:37:38Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32160#event-95796"
}
```



---

archive/issue_events_095797.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-10T00:37:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32160#event-95797"
}
```



---

archive/issue_events_095798.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:19:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32160#event-95798"
}
```



---

archive/issue_events_095799.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:19:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32160#event-95799"
}
```



---

archive/issue_comments_640324.json:
```json
{
    "body": "<a id='comment:25'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/382d37aa83c64e2f9cb944797e6aaacf176dc3fb\">382d37a</a></td><td><code>Merge tag '9.6.beta7' into t/32160/public/ticket/32160</code></td></tr></table>\n",
    "created_at": "2022-07-23T20:46:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640324",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/382d37aa83c64e2f9cb944797e6aaacf176dc3fb">382d37a</a></td><td><code>Merge tag '9.6.beta7' into t/32160/public/ticket/32160</code></td></tr></table>




---

archive/issue_comments_640325.json:
```json
{
    "body": "**Changing commit** from \"[339ef17fa76b75d5717e1a81cfd2ae6f0ac65902](https://github.com/sagemath/sagetrac-mirror/commit/339ef17fa76b75d5717e1a81cfd2ae6f0ac65902)\" to \"[382d37aa83c64e2f9cb944797e6aaacf176dc3fb](https://github.com/sagemath/sagetrac-mirror/commit/382d37aa83c64e2f9cb944797e6aaacf176dc3fb)\".",
    "created_at": "2022-07-23T20:46:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640325",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[339ef17fa76b75d5717e1a81cfd2ae6f0ac65902](https://github.com/sagemath/sagetrac-mirror/commit/339ef17fa76b75d5717e1a81cfd2ae6f0ac65902)" to "[382d37aa83c64e2f9cb944797e6aaacf176dc3fb](https://github.com/sagemath/sagetrac-mirror/commit/382d37aa83c64e2f9cb944797e6aaacf176dc3fb)".



---

archive/issue_comments_640326.json:
```json
{
    "body": "<a id='comment:27'></a>\nThis seems to be an error in Giac itself as the antiderivative is not correct. It would be best to report it to Giac upstream, so that it can be fixed there.\n\nIn particular, this is not caused by one of the integration bounds being infinity, and not caused by the switch of integration algorithms from giac to libgiac.\n\nFor a smaller example, consider just the left factor of the original example.\n\n```sage\nsage: g = 2*(frac(x))^3 - 3*(frac(x))^2 + frac(x)     # g is continuous\nsage: G = g.integral(x, algorithm='libgiac'); G       # Tested with Giac 1.9.0\n// Giac share root-directory:/usr/share/giac/\n// Giac share root-directory:/usr/share/giac/\nAdded 0 synonyms\nWarning, integration of abs or sign assumes constant sign by intervals (correct if the argument is real):\nCheck [sign(sageVARx)]\nWarning, integration of abs or sign assumes constant sign by intervals (correct if the argument is real):\nCheck [sign(sageVARx)]\nWarning, integration of abs or sign assumes constant sign by intervals (correct if the argument is real):\nCheck [sign(sageVARx)]\n1/2*x^4 - x^3 - x*floor(x*sgn(x))*sgn(x) + 1/2*x^2\n```\nThis antiderivative is only correct for `0 < x < 1`. For the whole real line, the antiderivative should instead be (I think):\n\n```\nfrac(x)^4/2 - frac(x)^3 + frac(x)^2/2\n```\nGiac did issue some warnings which are a hint that the result might be wrong, but our argument *is* real, so I am not sure what to make of it.",
    "created_at": "2022-07-24T11:21:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640326",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:27'></a>
This seems to be an error in Giac itself as the antiderivative is not correct. It would be best to report it to Giac upstream, so that it can be fixed there.

In particular, this is not caused by one of the integration bounds being infinity, and not caused by the switch of integration algorithms from giac to libgiac.

For a smaller example, consider just the left factor of the original example.

```sage
sage: g = 2*(frac(x))^3 - 3*(frac(x))^2 + frac(x)     # g is continuous
sage: G = g.integral(x, algorithm='libgiac'); G       # Tested with Giac 1.9.0
// Giac share root-directory:/usr/share/giac/
// Giac share root-directory:/usr/share/giac/
Added 0 synonyms
Warning, integration of abs or sign assumes constant sign by intervals (correct if the argument is real):
Check [sign(sageVARx)]
Warning, integration of abs or sign assumes constant sign by intervals (correct if the argument is real):
Check [sign(sageVARx)]
Warning, integration of abs or sign assumes constant sign by intervals (correct if the argument is real):
Check [sign(sageVARx)]
1/2*x^4 - x^3 - x*floor(x*sgn(x))*sgn(x) + 1/2*x^2
```
This antiderivative is only correct for `0 < x < 1`. For the whole real line, the antiderivative should instead be (I think):

```
frac(x)^4/2 - frac(x)^3 + frac(x)^2/2
```
Giac did issue some warnings which are a hint that the result might be wrong, but our argument *is* real, so I am not sure what to make of it.



---

archive/issue_comments_640327.json:
```json
{
    "body": "**Changing keywords** from \"integral\" to \"integral, giac, libgiac\".",
    "created_at": "2022-07-24T11:21:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640327",
    "user": "https://github.com/mwageringel"
}
```

**Changing keywords** from "integral" to "integral, giac, libgiac".



---

archive/issue_comments_640328.json:
```json
{
    "body": "<a id='comment:28'></a>\nFirst of all I see that in giac online\n\n[https://www.xcasenligne.fr/giac_online/demoGiacPhp.php](https://www.xcasenligne.fr/giac_online/demoGiacPhp.php)\n\n```\nfrac(x)\n```\n\nmeans\n\n```\nx-sign(x)floor(xsign(x))\n```",
    "created_at": "2022-07-31T06:48:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640328",
    "user": "https://github.com/daju1"
}
```

<a id='comment:28'></a>
First of all I see that in giac online

[https://www.xcasenligne.fr/giac_online/demoGiacPhp.php](https://www.xcasenligne.fr/giac_online/demoGiacPhp.php)

```
frac(x)
```

means

```
x-sign(x)floor(xsign(x))
```



---

archive/issue_comments_640329.json:
```json
{
    "body": "<a id='comment:29'></a>\nOh dear, both Giac and Sage return `-0.25` for `frac(-1.25)`.",
    "created_at": "2022-08-01T09:30:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640329",
    "user": "https://github.com/slel"
}
```

<a id='comment:29'></a>
Oh dear, both Giac and Sage return `-0.25` for `frac(-1.25)`.



---

archive/issue_comments_640330.json:
```json
{
    "body": "<a id='comment:30'></a>\nThe definition is a little different. In Sage for `RR` elements, it uses mpfr and satisfies `x == x.trunc() + x.frac()`:\n\n```\nsage: x = -1.25\nsage: x.trunc()\n-1\nsage: x.frac()\n-0.250000000000000\n```\nThis is at odds with the `frac()` function definition.",
    "created_at": "2022-08-03T08:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640330",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:30'></a>
The definition is a little different. In Sage for `RR` elements, it uses mpfr and satisfies `x == x.trunc() + x.frac()`:

```
sage: x = -1.25
sage: x.trunc()
-1
sage: x.frac()
-0.250000000000000
```
This is at odds with the `frac()` function definition.



---

archive/issue_comments_640331.json:
```json
{
    "body": "<a id='comment:31'></a>\nSo currently (Sage 9.6) the following mismatches are puzzling:\n\n```\nsage: frac(-1.25)\n-0.250000000000000\nsage: frac(x).subs({x: -1.25})\n0.750000000000000\n```\n\n```\nsage: frac(-1.25r)\n-0.25\nsage: frac(x).subs({x: -1.25r})\n0.75\n```\n\n```\nsage: frac(RDF(-1.25))\n-0.25\nsage: frac(x).subs({x: RDF(-1.25)})\n0.75\n```\n\n```\nsage: plot(frac, (-5, 5), aspect_ratio=1)\nLaunched png viewer for Graphics object consisting of 1 graphics primitive\n```\nRationals behave well:\n\n```\n{{{\nsage: frac(-5/4)\n3/4\nsage: frac(x).subs({x: -5/4})\n3/4\n}}}",
    "created_at": "2022-08-30T14:41:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32160#issuecomment-640331",
    "user": "https://github.com/slel"
}
```

<a id='comment:31'></a>
So currently (Sage 9.6) the following mismatches are puzzling:

```
sage: frac(-1.25)
-0.250000000000000
sage: frac(x).subs({x: -1.25})
0.750000000000000
```

```
sage: frac(-1.25r)
-0.25
sage: frac(x).subs({x: -1.25r})
0.75
```

```
sage: frac(RDF(-1.25))
-0.25
sage: frac(x).subs({x: RDF(-1.25)})
0.75
```

```
sage: plot(frac, (-5, 5), aspect_ratio=1)
Launched png viewer for Graphics object consisting of 1 graphics primitive
```
Rationals behave well:

```
{{{
sage: frac(-5/4)
3/4
sage: frac(x).subs({x: -5/4})
3/4
}}}



---

archive/issue_events_095800.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32160#event-95800"
}
```



---

archive/issue_events_095801.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32160",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32160#event-95801"
}
```
