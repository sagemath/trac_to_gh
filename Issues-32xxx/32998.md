# Issue 32998: Dockerfile builds everything twice

archive/issues_032761.json:
```json
{
    "assignees": [],
    "body": "The docker/Dockerfile uses a multi-stage approach to build several related images. However, something is broken since every SPKG is built (at least) twice during a run of .ci/build-docker.sh.\n\nAs a result, building docker images takes a very long time and, with this bug, likely exceeds the limits of most CI providers.\n\nCC:  @koffie @dimpase @videlec\n\nKeywords: **docker**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/32998_\n\n",
    "created_at": "2021-12-08T23:55:53Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20docker",
        "https://github.com/sagemath/sage/labels/p4%20%E2%80%93%20minor",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Dockerfile builds everything twice",
    "type": "issue",
    "updated_at": "2022-09-19T18:58:47Z",
    "url": "https://github.com/sagemath/sage/issues/32998",
    "user": "https://github.com/saraedum"
}
```
The docker/Dockerfile uses a multi-stage approach to build several related images. However, something is broken since every SPKG is built (at least) twice during a run of .ci/build-docker.sh.

As a result, building docker images takes a very long time and, with this bug, likely exceeds the limits of most CI providers.

CC:  @koffie @dimpase @videlec

Keywords: **docker**

_Issue created by migration from https://trac.sagemath.org/ticket/32998_





---

archive/issue_events_435807.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2021-12-08T23:55:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/32998",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32998#event-435807"
}
```



---

archive/issue_events_435808.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2021-12-08T23:55:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32998",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20docker",
    "label_color": "000080",
    "label_name": "component: docker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32998#event-435808"
}
```



---

archive/issue_events_435809.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2021-12-08T23:55:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32998",
    "label": "https://github.com/sagemath/sage/labels/p4%20%E2%80%93%20minor",
    "label_color": "ffe799",
    "label_name": "p4 \u2013 minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32998#event-435809"
}
```



---

archive/issue_events_435810.json:
```json
{
    "actor": "https://github.com/saraedum",
    "created_at": "2021-12-08T23:55:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/32998",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32998#event-435810"
}
```



---

archive/issue_comments_535888.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">Comment 1</div>\n\n(I am building 9.3 and 9.4 images locally. Assuming that it succeeds, I can push them to docker hub but it might take all day for that build to finish.)",
    "created_at": "2021-12-08T23:56:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32998#issuecomment-535888",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:1" align="right">Comment 1</div>

(I am building 9.3 and 9.4 images locally. Assuming that it succeeds, I can push them to docker hub but it might take all day for that build to finish.)



---

archive/issue_comments_535889.json:
```json
{
    "body": "Changed keywords from none to **docker**",
    "created_at": "2021-12-09T00:06:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32998#issuecomment-535889",
    "user": "https://github.com/saraedum"
}
```

Changed keywords from none to **docker**



---

archive/issue_comments_535890.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nOne thing to watch out for is the time stamps in `SAGE_LOCAL/var/lib/sage/installed` and `SAGE_VENV/var/lib/sage/installed`.",
    "created_at": "2021-12-09T06:12:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32998#issuecomment-535890",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:3" align="right">Comment 3</div>

One thing to watch out for is the time stamps in `SAGE_LOCAL/var/lib/sage/installed` and `SAGE_VENV/var/lib/sage/installed`.



---

archive/issue_comments_535891.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">Comment 4</div>\n\nDocker build can use more system packages...",
    "created_at": "2021-12-09T08:40:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32998#issuecomment-535891",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:4" align="right">Comment 4</div>

Docker build can use more system packages...



---

archive/issue_comments_535892.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">Comment 5</div>\n\nReplying to [@dimpase](#comment%3A4):\n> Docker build can use more system packages...\n\nSure, but that just helps with the symptom here I think. Also, the idea of these docker images were that they are the actual [SageMath](../wiki/SageMath) distribution. In particular, the idea was that these images can be used to test SPKG changes by supporting incremental builds. For this we must not use system packages. That might not be what we want here anymore.",
    "created_at": "2021-12-09T18:36:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32998#issuecomment-535892",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:5" align="right">Comment 5</div>

Replying to [@dimpase](#comment%3A4):
> Docker build can use more system packages...

Sure, but that just helps with the symptom here I think. Also, the idea of these docker images were that they are the actual [SageMath](../wiki/SageMath) distribution. In particular, the idea was that these images can be used to test SPKG changes by supporting incremental builds. For this we must not use system packages. That might not be what we want here anymore.



---

archive/issue_comments_535893.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">Comment 6</div>\n\nThe wish for to the sagemath-dev image being the actual distribution makes sense.\n\nFor the regular sagemath image this wish is I guess less relevant, but having two different build setups for the sagemath-dev and sagemath image doesn't really makes sense to me, since it will mean more maintenance. \n\nThe time limit for ci jobs on github is 6 hours per job for what it is worth.",
    "created_at": "2021-12-09T19:04:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32998#issuecomment-535893",
    "user": "https://github.com/koffie"
}
```

<div id="comment:6" align="right">Comment 6</div>

The wish for to the sagemath-dev image being the actual distribution makes sense.

For the regular sagemath image this wish is I guess less relevant, but having two different build setups for the sagemath-dev and sagemath image doesn't really makes sense to me, since it will mean more maintenance. 

The time limit for ci jobs on github is 6 hours per job for what it is worth.



---

archive/issue_comments_535894.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">Comment 7</div>\n\nReplying to [@saraedum](#comment%3A5):\n> Replying to [@dimpase](#comment%3A4):\n> > Docker build can use more system packages...\n\n> \n> Sure, but that just helps with the symptom here I think. Also, the idea of these docker images were that they are the actual [SageMath](../wiki/SageMath) distribution. In particular, the idea was that these images can be used to test SPKG changes by supporting incremental builds.\n> For this we must not use system packages. That might not be what we want here anymore.\n\nThere are many packages that change quite infrequently, yet take lot of time to build.\n\nIf there is an image only allowing changes in sagelib, it would already be quite useful.\n\nAs well, I don't even understand why using system packages is any different - do you mean to say that docker images don't allow monkey-patching?",
    "created_at": "2021-12-09T20:13:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32998#issuecomment-535894",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:7" align="right">Comment 7</div>

Replying to [@saraedum](#comment%3A5):
> Replying to [@dimpase](#comment%3A4):
> > Docker build can use more system packages...

> 
> Sure, but that just helps with the symptom here I think. Also, the idea of these docker images were that they are the actual [SageMath](../wiki/SageMath) distribution. In particular, the idea was that these images can be used to test SPKG changes by supporting incremental builds.
> For this we must not use system packages. That might not be what we want here anymore.

There are many packages that change quite infrequently, yet take lot of time to build.

If there is an image only allowing changes in sagelib, it would already be quite useful.

As well, I don't even understand why using system packages is any different - do you mean to say that docker images don't allow monkey-patching?



---

archive/issue_comments_535895.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">Comment 8</div>\n\n>  As well, I don't even understand why using system packages is any different - do you mean to say that docker images don't allow monkey-patching? \n\nNo. The [GitLab](../wiki/GitLab) CI setup supports (modulo this very issue here) incremental builds. So, the idea was that you can perform an SPKG change in a ticket here (something which the patchbot does afaik not support.) The CI then incrementally builds a docker image starting from sagemath-dev with that SPKG upgraded. That docker image can then be tested with tools such as https://gitlab.com/sagemath/gitlab-sage which is deployed here at the moment: https://gitlab-hooks-flau3jeaza-ew.a.run.app/\n\nAn actual demo of this would be the (outdated) build for #28466 at https://gitlab-hooks-flau3jeaza-ew.a.run.app/status/trac/branch/u%2Fgalois%2Fmrs%2F32%2Fgeneral-extensions but it works equally for any other branch. (i.e., it doesn't because the [GitLab](../wiki/GitLab) builds are not functional at the moment.)\n\nOf course this also works for non-SPKG changes. The idea was to be able to better review changes proposed on a ticket without having to run the rebuild of [SageMath](../wiki/SageMath) locally. However, in the end there was not that much interest in this feature.",
    "created_at": "2021-12-10T21:19:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32998#issuecomment-535895",
    "user": "https://github.com/saraedum"
}
```

<div id="comment:8" align="right">Comment 8</div>

>  As well, I don't even understand why using system packages is any different - do you mean to say that docker images don't allow monkey-patching? 

No. The [GitLab](../wiki/GitLab) CI setup supports (modulo this very issue here) incremental builds. So, the idea was that you can perform an SPKG change in a ticket here (something which the patchbot does afaik not support.) The CI then incrementally builds a docker image starting from sagemath-dev with that SPKG upgraded. That docker image can then be tested with tools such as https://gitlab.com/sagemath/gitlab-sage which is deployed here at the moment: https://gitlab-hooks-flau3jeaza-ew.a.run.app/

An actual demo of this would be the (outdated) build for #28466 at https://gitlab-hooks-flau3jeaza-ew.a.run.app/status/trac/branch/u%2Fgalois%2Fmrs%2F32%2Fgeneral-extensions but it works equally for any other branch. (i.e., it doesn't because the [GitLab](../wiki/GitLab) builds are not functional at the moment.)

Of course this also works for non-SPKG changes. The idea was to be able to better review changes proposed on a ticket without having to run the rebuild of [SageMath](../wiki/SageMath) locally. However, in the end there was not that much interest in this feature.



---

archive/issue_comments_535896.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">Comment 9</div>\n\nReplying to [@saraedum](#comment%3A8):\n> >  As well, I don't even understand why using system packages is any different - do you mean to say that docker images don't allow monkey-patching? \n\n> \n> No. The [GitLab](../wiki/GitLab) CI setup supports (modulo this very issue here) incremental builds. So, the idea was that you can perform an SPKG change in a ticket here (something which the patchbot does afaik not support.) \n\nYou can perform an SPKG change from a system-wide package `foo` to a Sage-provided one, by doing `make foo && make build`. You can also go back to a system package (assuming it's accepted by `./configure`, naturally), by `make foo-clean && ./configure && make build`",
    "created_at": "2021-12-10T22:40:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/32998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/32998#issuecomment-535896",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:9" align="right">Comment 9</div>

Replying to [@saraedum](#comment%3A8):
> >  As well, I don't even understand why using system packages is any different - do you mean to say that docker images don't allow monkey-patching? 

> 
> No. The [GitLab](../wiki/GitLab) CI setup supports (modulo this very issue here) incremental builds. So, the idea was that you can perform an SPKG change in a ticket here (something which the patchbot does afaik not support.) 

You can perform an SPKG change from a system-wide package `foo` to a Sage-provided one, by doing `make foo && make build`. You can also go back to a system package (assuming it's accepted by `./configure`, naturally), by `make foo-clean && ./configure && make build`



---

archive/issue_events_435811.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-10T23:22:31Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/32998",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32998#event-435811"
}
```



---

archive/issue_events_435812.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-10T23:22:31Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/32998",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32998#event-435812"
}
```



---

archive/issue_events_435813.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/32998",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32998#event-435813"
}
```



---

archive/issue_events_435814.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/32998",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32998#event-435814"
}
```



---

archive/issue_events_435815.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/32998",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32998#event-435815"
}
```



---

archive/issue_events_435816.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/32998",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/32998#event-435816"
}
```
