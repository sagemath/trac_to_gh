# Issue 32361: Actually remove DESTDIR staging for Python packages to eliminate race conditions during Python package installations

archive/issues_032124.json:
```json
{
    "body": "Follow-up from #29585, which forgot to include a crucial commit.\n\nRace conditions are still present in parallel builds:\nhttps://github.com/sagemath/sage/runs/3274951485?check_suite_focus=true\n\n```\n  [cython-0.29.21]   user\t1m11.995s\n  [cython-0.29.21]   sys\t0m2.867s\n  [cython-0.29.21]   Copying package files from temporary location /sage/local/var/tmp/sage/build/cython-0.29.21/inst to /sage/local\n  [cython-0.29.21]   cp: cannot create directory '/sage/local/./lib/python3.9/site-packages/Cython/__pycache__': File exists\n  [cython-0.29.21]   ************************************************************************\n  [cython-0.29.21]   Error copying files for cython-0.29.21.\n  [cython-0.29.21]   ************************************************************************\n```\n\n\nCC:  @vbraun @jhpalmieri @dimpase\n\nBranch/Commit: 378a034ab454ce5a93007b8698519e1979e4eff2\n\nReviewer: John Palmieri\n\nAuthor: Matthias Koeppe\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32361\n\n",
    "closed_at": "2021-09-13T22:22:35Z",
    "created_at": "2021-08-10T18:46:44Z",
    "labels": [
        "component: build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Actually remove DESTDIR staging for Python packages to eliminate race conditions during Python package installations",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32361",
    "user": "https://github.com/mkoeppe"
}
```
Follow-up from #29585, which forgot to include a crucial commit.

Race conditions are still present in parallel builds:
https://github.com/sagemath/sage/runs/3274951485?check_suite_focus=true

```
  [cython-0.29.21]   user	1m11.995s
  [cython-0.29.21]   sys	0m2.867s
  [cython-0.29.21]   Copying package files from temporary location /sage/local/var/tmp/sage/build/cython-0.29.21/inst to /sage/local
  [cython-0.29.21]   cp: cannot create directory '/sage/local/./lib/python3.9/site-packages/Cython/__pycache__': File exists
  [cython-0.29.21]   ************************************************************************
  [cython-0.29.21]   Error copying files for cython-0.29.21.
  [cython-0.29.21]   ************************************************************************
```


CC:  @vbraun @jhpalmieri @dimpase

Branch/Commit: 378a034ab454ce5a93007b8698519e1979e4eff2

Reviewer: John Palmieri

Author: Matthias Koeppe

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/32361





---

archive/issue_comments_644268.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/actually_remove_destdir_staging_for_python_packages_to_eliminate_race_conditions_during_python_package_installations\"",
    "created_at": "2021-08-10T19:05:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644268",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/actually_remove_destdir_staging_for_python_packages_to_eliminate_race_conditions_during_python_package_installations"



---

archive/issue_comments_644269.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2021-08-10T19:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644269",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_comments_644270.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-08-10T19:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644270",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_644271.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/actually_remove_destdir_staging_for_python_packages_to_eliminate_race_conditions_during_python_package_installations\" to \"\"",
    "created_at": "2021-08-10T19:05:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644271",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "u/mkoeppe/actually_remove_destdir_staging_for_python_packages_to_eliminate_race_conditions_during_python_package_installations" to ""



---

archive/issue_comments_644272.json:
```json
{
    "body": "<a id='comment:3'></a>the branch field was removed?\n\nI am away from kbds till Sat, so I can review only visually",
    "created_at": "2021-08-10T19:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644272",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>the branch field was removed?

I am away from kbds till Sat, so I can review only visually



---

archive/issue_comments_644273.json:
```json
{
    "body": "<a id='comment:4'></a>... editing mistake\n  \n---\nNew commits:",
    "created_at": "2021-08-10T19:54:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644273",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>... editing mistake
  
---
New commits:



---

archive/issue_comments_644274.json:
```json
{
    "body": "Changing commit from \"\" to \"8fccf3e023864bde327fdf6ccf383535aff47e2b\"",
    "created_at": "2021-08-10T19:54:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644274",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "" to "8fccf3e023864bde327fdf6ccf383535aff47e2b"



---

archive/issue_comments_644275.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/actually_remove_destdir_staging_for_python_packages_to_eliminate_race_conditions_during_python_package_installations\"",
    "created_at": "2021-08-10T19:54:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644275",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/actually_remove_destdir_staging_for_python_packages_to_eliminate_race_conditions_during_python_package_installations"



---

archive/issue_comments_644276.json:
```json
{
    "body": "<a id='comment:5'></a>I'd never set `SAGE_SUDO=\"sudo -E\"` before, but now I'm trying it and `pip` is failing to build. In brief experiments, it seems to succeed without this branch.",
    "created_at": "2021-08-18T18:38:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644276",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:5'></a>I'd never set `SAGE_SUDO="sudo -E"` before, but now I'm trying it and `pip` is failing to build. In brief experiments, it seems to succeed without this branch.



---

archive/issue_comments_644277.json:
```json
{
    "body": "Attachment [pip-21.1.2.log](tarball://root/attachments/some-uuid/ticket32361/pip-21.1.2.log) by @jhpalmieri created at 2021-08-18 18:38:21",
    "created_at": "2021-08-18T18:38:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644277",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [pip-21.1.2.log](tarball://root/attachments/some-uuid/ticket32361/pip-21.1.2.log) by @jhpalmieri created at 2021-08-18 18:38:21



---

archive/issue_comments_644278.json:
```json
{
    "body": "<a id='comment:6'></a>Just to confirm: if I do `sudo make distclean; ./configure; make toolchain; make pip`, it fails with this branch, succeeds with 9.4.rc2 (assuming that `SAGE_SUDO` is set).",
    "created_at": "2021-08-18T18:45:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644278",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:6'></a>Just to confirm: if I do `sudo make distclean; ./configure; make toolchain; make pip`, it fails with this branch, succeeds with 9.4.rc2 (assuming that `SAGE_SUDO` is set).



---

archive/issue_comments_644279.json:
```json
{
    "body": "<a id='comment:7'></a>`sudo make distclean` is a scary operation, perhaps you just wanted `sudo rm -rf local/`?\n\nAs `make distclean` can run `./config.status --recheck`, this may create root-owned files in the source directory.",
    "created_at": "2021-08-22T01:00:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644279",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>`sudo make distclean` is a scary operation, perhaps you just wanted `sudo rm -rf local/`?

As `make distclean` can run `./config.status --recheck`, this may create root-owned files in the source directory.



---

archive/issue_events_085868.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32361#event-85868"
}
```



---

archive/issue_comments_644280.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [mkoeppe](#comment%3A7):\n> `sudo make distclean` is a scary operation, perhaps you just wanted `sudo rm -rf local/`?\n> \n> As `make distclean` can run `./config.status --recheck`, this may create root-owned files in the source directory.\n\n\nIt is still the case that after doing `export SAGE_SUDO=\"sudo -E\"`, then `pip` fails to build.",
    "created_at": "2021-09-06T01:05:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644280",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:9'></a>Replying to [mkoeppe](#comment%3A7):
> `sudo make distclean` is a scary operation, perhaps you just wanted `sudo rm -rf local/`?
> 
> As `make distclean` can run `./config.status --recheck`, this may create root-owned files in the source directory.


It is still the case that after doing `export SAGE_SUDO="sudo -E"`, then `pip` fails to build.



---

archive/issue_comments_644281.json:
```json
{
    "body": "Changing commit from \"8fccf3e023864bde327fdf6ccf383535aff47e2b\" to \"c7a117119111a7645a459b04ba39f93b389af01d\"",
    "created_at": "2021-09-06T02:53:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644281",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "8fccf3e023864bde327fdf6ccf383535aff47e2b" to "c7a117119111a7645a459b04ba39f93b389af01d"



---

archive/issue_comments_644282.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-06T02:53:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644282",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_644283.json:
```json
{
    "body": "<a id='comment:11'></a>Found the mistake, fixed",
    "created_at": "2021-09-06T02:53:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644283",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>Found the mistake, fixed



---

archive/issue_comments_644284.json:
```json
{
    "body": "<a id='comment:12'></a>That helps, thanks. In the log for `sage_docbuild`, I see messages like this, and they seem to be new with this branch:\n\n```\nValue for scheme.platlib does not match. Please report this to <https://github.com/pypa/pip/issues/9617>\n```\n(This is again with `SAGE_SUDO` set.)",
    "created_at": "2021-09-06T16:29:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644284",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:12'></a>That helps, thanks. In the log for `sage_docbuild`, I see messages like this, and they seem to be new with this branch:

```
Value for scheme.platlib does not match. Please report this to <https://github.com/pypa/pip/issues/9617>
```
(This is again with `SAGE_SUDO` set.)



---

archive/issue_comments_644285.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [jhpalmieri](#comment%3A12):\n> In the log for `sage_docbuild`, I see messages like this, and they seem to be new with this branch:\n> \n> ```\n> Value for scheme.platlib does not match. Please report this to <https://github.com/pypa/pip/issues/9617>\n> ```\n\n\nThanks, I see them too. I'll investigate",
    "created_at": "2021-09-06T18:25:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644285",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>Replying to [jhpalmieri](#comment%3A12):
> In the log for `sage_docbuild`, I see messages like this, and they seem to be new with this branch:
> 
> ```
> Value for scheme.platlib does not match. Please report this to <https://github.com/pypa/pip/issues/9617>
> ```


Thanks, I see them too. I'll investigate



---

archive/issue_comments_644286.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-06T18:33:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644286",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_644287.json:
```json
{
    "body": "Changing commit from \"c7a117119111a7645a459b04ba39f93b389af01d\" to \"a05d57e8032354c091d6a3ed6cdd2a4aff13484a\"",
    "created_at": "2021-09-06T18:33:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644287",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c7a117119111a7645a459b04ba39f93b389af01d" to "a05d57e8032354c091d6a3ed6cdd2a4aff13484a"



---

archive/issue_comments_644288.json:
```json
{
    "body": "<a id='comment:15'></a>Unchanged with 9.5.beta0 merged (which has #32046)\n\nAlso upgrading pip to latest (21.2.4) does not make a difference",
    "created_at": "2021-09-06T18:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644288",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>Unchanged with 9.5.beta0 merged (which has #32046)

Also upgrading pip to latest (21.2.4) does not make a difference



---

archive/issue_comments_644289.json:
```json
{
    "body": "<a id='comment:16'></a>Newer pip issue: https://github.com/pypa/pip/issues/10151",
    "created_at": "2021-09-06T18:38:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644289",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>Newer pip issue: https://github.com/pypa/pip/issues/10151



---

archive/issue_comments_644290.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-06T18:59:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644290",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_644291.json:
```json
{
    "body": "Changing commit from \"a05d57e8032354c091d6a3ed6cdd2a4aff13484a\" to \"378a034ab454ce5a93007b8698519e1979e4eff2\"",
    "created_at": "2021-09-06T18:59:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644291",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "a05d57e8032354c091d6a3ed6cdd2a4aff13484a" to "378a034ab454ce5a93007b8698519e1979e4eff2"



---

archive/issue_comments_644292.json:
```json
{
    "body": "<a id='comment:18'></a>OK, found a solution. Not a pip bug.",
    "created_at": "2021-09-06T19:00:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644292",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'></a>OK, found a solution. Not a pip bug.



---

archive/issue_comments_644293.json:
```json
{
    "body": "Changing reviewer from \"\" to \"John Palmieri\"",
    "created_at": "2021-09-07T02:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644293",
    "user": "https://github.com/jhpalmieri"
}
```

Changing reviewer from "" to "John Palmieri"



---

archive/issue_comments_644294.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-07T02:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644294",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_644295.json:
```json
{
    "body": "<a id='comment:19'></a>Okay, I think it's ready to go. I don't know what else to do to stress-test it.",
    "created_at": "2021-09-07T02:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644295",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:19'></a>Okay, I think it's ready to go. I don't know what else to do to stress-test it.



---

archive/issue_comments_644296.json:
```json
{
    "body": "<a id='comment:20'></a>Thank you!",
    "created_at": "2021-09-07T02:02:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644296",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>Thank you!



---

archive/issue_comments_644297.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/actually_remove_destdir_staging_for_python_packages_to_eliminate_race_conditions_during_python_package_installations\" to \"378a034ab454ce5a93007b8698519e1979e4eff2\"",
    "created_at": "2021-09-13T22:22:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644297",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mkoeppe/actually_remove_destdir_staging_for_python_packages_to_eliminate_race_conditions_during_python_package_installations" to "378a034ab454ce5a93007b8698519e1979e4eff2"



---

archive/issue_events_085869.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-09-13T22:22:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32361#event-85869"
}
```



---

archive/issue_comments_644298.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-09-13T22:22:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32361",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32361#issuecomment-644298",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
