# Issue 32582: Add colored Jones polynomial

archive/issues_032345.json:
```json
{
    "body": "This a proposal to add a new method in braid.py to allow the calculation of the colored Jones polynomial. Following https://arxiv.org/abs/1804.07910\n\nCC:  @miguelmarco @NathanDunfield\n\nKeywords: knots, braids\n\nReviewer: Travis Scrimshaw\n\nAuthor: Moritz Firsching\n\nBranch: d2722d0b1128b578fc6e88d144f8a8af21cc9805\n\nDependencies: #32629\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32582\n\n",
    "closed_at": "2021-10-24T18:38:58Z",
    "created_at": "2021-09-28T19:38:04Z",
    "labels": [
        "component: group theory",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Add colored Jones polynomial",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32582",
    "user": "https://github.com/mo271"
}
```
This a proposal to add a new method in braid.py to allow the calculation of the colored Jones polynomial. Following https://arxiv.org/abs/1804.07910

CC:  @miguelmarco @NathanDunfield

Keywords: knots, braids

Reviewer: Travis Scrimshaw

Author: Moritz Firsching

Branch: d2722d0b1128b578fc6e88d144f8a8af21cc9805

Dependencies: #32629

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/32582





---

archive/issue_comments_492834.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-09-28T19:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492834",
    "user": "https://github.com/mo271"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_492835.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-29T06:36:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492835",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_492836.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-29T13:51:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492836",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_492837.json:
```json
{
    "body": "<a id='comment:4'></a>please check indentation in the doc. doctests inside EXAMPLES:: must be indented",
    "created_at": "2021-09-29T15:13:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492837",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:4'></a>please check indentation in the doc. doctests inside EXAMPLES:: must be indented



---

archive/issue_comments_492838.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-29T19:48:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492838",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_492839.json:
```json
{
    "body": "<a id='comment:6'></a>Thanks for pointing that out and taking a look, chapoton! I tried to fix it in all places..",
    "created_at": "2021-09-29T19:52:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492839",
    "user": "https://github.com/mo271"
}
```

<a id='comment:6'></a>Thanks for pointing that out and taking a look, chapoton! I tried to fix it in all places..



---

archive/issue_comments_492840.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-29T19:54:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492840",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_492841.json:
```json
{
    "body": "<a id='comment:10'></a>Thank you for this implementation. I have a few comments/questions.\n\nWhy should `_RightQuantumWord` be internal? It seems like it would be okay as a separate class (in the `braid.py` file).\n\nWhy is `_deformed_burau_matrix` hidden? It seems like it would be useful for other people using the braid group class.\n\nI think `_quantum_determinant` should not be in `braid.py`, much less as a method of the braid group elements. The question then becomes where is a good home for this function. I am thinking it is best as a method on matrices. You should also add in the definition to the docstring and make it unhidden.\n\nWhile it is unlikely, I don't think we should have the caching of `colored_jones_polynomial` depend on the variable and `try_inverse`. The cached version would have a fixed choice of variable, such as `q`. Probably the better thing to do here is to manually handle the cache with an attribute, e.g., `self._colored_jones_poly`. The other option is to have the cached part be a separate hidden method (and ``@`cached_method` can take a key function, where we can ignore the `try_inverse` input).\n\nI am not a big fan of the `for` loop in `_colored_jones_sum`. While there might be some code duplication, having it as a `while` loop makes it easier to understand the logic IMO (which can be seen as you won't need the comment).\n\nYou have numerous formatting errors with your documentation. Please see the [Sage dev guide: docstrings](https://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings) and the other code in `braid.py`. Let me know if you have any questions.",
    "created_at": "2021-10-03T08:29:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492841",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:10'></a>Thank you for this implementation. I have a few comments/questions.

Why should `_RightQuantumWord` be internal? It seems like it would be okay as a separate class (in the `braid.py` file).

Why is `_deformed_burau_matrix` hidden? It seems like it would be useful for other people using the braid group class.

I think `_quantum_determinant` should not be in `braid.py`, much less as a method of the braid group elements. The question then becomes where is a good home for this function. I am thinking it is best as a method on matrices. You should also add in the definition to the docstring and make it unhidden.

While it is unlikely, I don't think we should have the caching of `colored_jones_polynomial` depend on the variable and `try_inverse`. The cached version would have a fixed choice of variable, such as `q`. Probably the better thing to do here is to manually handle the cache with an attribute, e.g., `self._colored_jones_poly`. The other option is to have the cached part be a separate hidden method (and ``@`cached_method` can take a key function, where we can ignore the `try_inverse` input).

I am not a big fan of the `for` loop in `_colored_jones_sum`. While there might be some code duplication, having it as a `while` loop makes it easier to understand the logic IMO (which can be seen as you won't need the comment).

You have numerous formatting errors with your documentation. Please see the [Sage dev guide: docstrings](https://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings) and the other code in `braid.py`. Let me know if you have any questions.



---

archive/issue_comments_492842.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-10-03T08:29:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492842",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_492843.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:10 tscrim]:\n> Thank you for this implementation. I have a few comments/questions.\n> \n\nThanks for taking a look and the comments!\n> Why should `_RightQuantumWord` be internal? It seems like it would be okay as a separate class (in the `braid.py` file).\n> \n> Why is `_deformed_burau_matrix` hidden? It seems like it would be useful for other people using the braid group class.\n\nBoth for `_RightQuantumWord` and the `_deformed_burau_matrix`, I couldn't image that they would be used in any other context than in calculating the colored Jones, but why not, let's expose those, there might be some other uses. \n> \n> I think `_quantum_determinant` should not be in `braid.py`, much less as a method of the braid group elements. The question then becomes where is a good home for this function. I am thinking it is best as a method on matrices. You should also add in the definition to the docstring and make it unhidden.\n\nLooking around where to put this, I found a `quantum_determinant` method of `QuantumMatrixCoordinate`.\n\n```\nsage: O = algebras.QuantumMatrixCoordinate(3)                                                                                                                                                                                                                                                                                                                                                                                           \nsage: O.quantum_determinant()                                                                                                                                                                                                                                                                                                                                                                                                           \nx[1,1]*x[2,2]*x[3,3] - q*x[1,1]*x[2,3]*x[3,2] - q*x[1,2]*x[2,1]*x[3,3] + q^2*x[1,2]*x[2,3]*x[3,1] + q^2*x[1,3]*x[2,1]*x[3,2] - q^3*x[1,3]*x[2,2]*x[3,1]\n```\n However this is in its current form not useful for our purposes, since it cannot be accessed without creating the an instance of `QuantumMatrixCoordinate` and this is slow. It is also broken if one changes `3` to `11`, #32623. Perhaps it would be best to have a `quantum_determinant` method somewhere where both our code in braid.py as well as `QuantumMatrixCoordinate` can access it. If you agree I would prepare a separate ticket to add `quantum_determinant`.\n\n> \n> While it is unlikely, I don't think we should have the caching of `colored_jones_polynomial` depend on the variable and `try_inverse`. The cached version would have a fixed choice of variable, such as `q`. Probably the better thing to do here is to manually handle the cache with an attribute, e.g., `self._colored_jones_poly`. The other option is to have the cached part be a separate hidden method (and ``@`cached_method` can take a key function, where we can ignore the `try_inverse` input).\n\nMake sense, I will cache it in an attribute. \n> \n> I am not a big fan of the `for` loop in `_colored_jones_sum`. While there might be some code duplication, having it as a `while` loop makes it easier to understand the logic IMO (which can be seen as you won't need the comment).\n\nSure, will change to a while loop. \n> \n> You have numerous formatting errors with your documentation. Please see the [Sage dev guide: docstrings](https://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings) and the other code in `braid.py`. Let me know if you have any questions.\n\nI will take another look at those...",
    "created_at": "2021-10-04T15:13:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492843",
    "user": "https://github.com/mo271"
}
```

<a id='comment:11'></a>Replying to [comment:10 tscrim]:
> Thank you for this implementation. I have a few comments/questions.
> 

Thanks for taking a look and the comments!
> Why should `_RightQuantumWord` be internal? It seems like it would be okay as a separate class (in the `braid.py` file).
> 
> Why is `_deformed_burau_matrix` hidden? It seems like it would be useful for other people using the braid group class.

Both for `_RightQuantumWord` and the `_deformed_burau_matrix`, I couldn't image that they would be used in any other context than in calculating the colored Jones, but why not, let's expose those, there might be some other uses. 
> 
> I think `_quantum_determinant` should not be in `braid.py`, much less as a method of the braid group elements. The question then becomes where is a good home for this function. I am thinking it is best as a method on matrices. You should also add in the definition to the docstring and make it unhidden.

Looking around where to put this, I found a `quantum_determinant` method of `QuantumMatrixCoordinate`.

```
sage: O = algebras.QuantumMatrixCoordinate(3)                                                                                                                                                                                                                                                                                                                                                                                           
sage: O.quantum_determinant()                                                                                                                                                                                                                                                                                                                                                                                                           
x[1,1]*x[2,2]*x[3,3] - q*x[1,1]*x[2,3]*x[3,2] - q*x[1,2]*x[2,1]*x[3,3] + q^2*x[1,2]*x[2,3]*x[3,1] + q^2*x[1,3]*x[2,1]*x[3,2] - q^3*x[1,3]*x[2,2]*x[3,1]
```
 However this is in its current form not useful for our purposes, since it cannot be accessed without creating the an instance of `QuantumMatrixCoordinate` and this is slow. It is also broken if one changes `3` to `11`, #32623. Perhaps it would be best to have a `quantum_determinant` method somewhere where both our code in braid.py as well as `QuantumMatrixCoordinate` can access it. If you agree I would prepare a separate ticket to add `quantum_determinant`.

> 
> While it is unlikely, I don't think we should have the caching of `colored_jones_polynomial` depend on the variable and `try_inverse`. The cached version would have a fixed choice of variable, such as `q`. Probably the better thing to do here is to manually handle the cache with an attribute, e.g., `self._colored_jones_poly`. The other option is to have the cached part be a separate hidden method (and ``@`cached_method` can take a key function, where we can ignore the `try_inverse` input).

Make sense, I will cache it in an attribute. 
> 
> I am not a big fan of the `for` loop in `_colored_jones_sum`. While there might be some code duplication, having it as a `while` loop makes it easier to understand the logic IMO (which can be seen as you won't need the comment).

Sure, will change to a while loop. 
> 
> You have numerous formatting errors with your documentation. Please see the [Sage dev guide: docstrings](https://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings) and the other code in `braid.py`. Let me know if you have any questions.

I will take another look at those...



---

archive/issue_comments_492844.json:
```json
{
    "body": "<a id='comment:12'></a>I have fixed #32623, along with a speedup for the qdet. From a little bit of testing, it seems like they are approximately the same speed as they are the same algorithm. I agree that this should not use the quantum matrix coordinate ring as that is meant for that class specifically. I wouldn't try to refactor that out into a single function. Instead, I would just move the implementation to `src/sage/matrix/matrix2.pyx` as it is most natural to be a function acting on a matrix.\n\nI would also add a default `q`:\n\n```python\ndef quantum_determinant(self, q=None):\n    if q is None:\n        from sage.rings.polynomial.polynomial_ring_constructor import PolynomialRing\n        q = PolynomialRing(self.base_ring(), 'q').gen()\n    [rest of code]\n```\nThis will make it easier to use for a general user.",
    "created_at": "2021-10-05T06:45:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492844",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>I have fixed #32623, along with a speedup for the qdet. From a little bit of testing, it seems like they are approximately the same speed as they are the same algorithm. I agree that this should not use the quantum matrix coordinate ring as that is meant for that class specifically. I wouldn't try to refactor that out into a single function. Instead, I would just move the implementation to `src/sage/matrix/matrix2.pyx` as it is most natural to be a function acting on a matrix.

I would also add a default `q`:

```python
def quantum_determinant(self, q=None):
    if q is None:
        from sage.rings.polynomial.polynomial_ring_constructor import PolynomialRing
        q = PolynomialRing(self.base_ring(), 'q').gen()
    [rest of code]
```
This will make it easier to use for a general user.



---

archive/issue_comments_492845.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-10-05T11:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492845",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_492846.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-10-05T11:42:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492846",
    "user": "https://github.com/mo271"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_492847.json:
```json
{
    "body": "<a id='comment:15'></a>I aimed to address all review comments as outlined in the reply above. \nAfter looking into it, I'm now not using an attribute, but cache the function \n`_colored_jones_sum`, using always `q` as a variable first and then substituting if necessary. This seems to work as intended:\n\n```\nsage: b = BraidGroup(5)([1,2,4,2,-4,-2,3,-2,-1,2,3,1,2,4])\nsage: %time b.colored_jones_polynomial(2, try_inverse=False)\nCPU times: user 2.14 s, sys: 9.22 ms, total: 2.15 s\nWall time: 2.15 s\nq - q^2 + 2*q^3 - q^4 + q^5 - q^6\nsage: %time b.colored_jones_polynomial(2, try_inverse=False)\nCPU times: user 24.6 ms, sys: 33 \u00b5s, total: 24.6 ms\nWall time: 24.3 ms\nq - q^2 + 2*q^3 - q^4 + q^5 - q^6\nsage: %time b.colored_jones_polynomial(2, 'z', try_inverse=False)\nCPU times: user 27.2 ms, sys: 263 \u00b5s, total: 27.4 ms\nWall time: 26.9 ms\nz - z^2 + 2*z^3 - z^4 + z^5 - z^6\nsage: %time b.colored_jones_polynomial(2, 'z', try_inverse=True)\nCPU times: user 167 ms, sys: 101 ms, total: 268 ms\nWall time: 267 ms\nz - z^2 + 2*z^3 - z^4 + z^5 - z^6\n```\n\nWe now use the new `quantum_determinant`. \nNot sure why lint on github is still failing, I at least made sure that now pep8 errors appear in the code I added. Also, I hope I now got the formatting for the doc strings correct.",
    "created_at": "2021-10-05T11:42:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492847",
    "user": "https://github.com/mo271"
}
```

<a id='comment:15'></a>I aimed to address all review comments as outlined in the reply above. 
After looking into it, I'm now not using an attribute, but cache the function 
`_colored_jones_sum`, using always `q` as a variable first and then substituting if necessary. This seems to work as intended:

```
sage: b = BraidGroup(5)([1,2,4,2,-4,-2,3,-2,-1,2,3,1,2,4])
sage: %time b.colored_jones_polynomial(2, try_inverse=False)
CPU times: user 2.14 s, sys: 9.22 ms, total: 2.15 s
Wall time: 2.15 s
q - q^2 + 2*q^3 - q^4 + q^5 - q^6
sage: %time b.colored_jones_polynomial(2, try_inverse=False)
CPU times: user 24.6 ms, sys: 33 µs, total: 24.6 ms
Wall time: 24.3 ms
q - q^2 + 2*q^3 - q^4 + q^5 - q^6
sage: %time b.colored_jones_polynomial(2, 'z', try_inverse=False)
CPU times: user 27.2 ms, sys: 263 µs, total: 27.4 ms
Wall time: 26.9 ms
z - z^2 + 2*z^3 - z^4 + z^5 - z^6
sage: %time b.colored_jones_polynomial(2, 'z', try_inverse=True)
CPU times: user 167 ms, sys: 101 ms, total: 268 ms
Wall time: 267 ms
z - z^2 + 2*z^3 - z^4 + z^5 - z^6
```

We now use the new `quantum_determinant`. 
Not sure why lint on github is still failing, I at least made sure that now pep8 errors appear in the code I added. Also, I hope I now got the formatting for the doc strings correct.



---

archive/issue_comments_492848.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-06T06:27:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492848",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_492849.json:
```json
{
    "body": "<a id='comment:17'></a>Thank you. It is looking very good. I made some additional changes; most are minor tweaks for PEP8 (and breaking the 80 char/line rule when I felt it made things more readable) and documentation. The two biggest changes is I made are (1) the caching is now associated to `colored_jones_polynomial` so the quantum determinant did not have to be computed multiple times; (2) made `RightQuantumWord.to_tuples()` into a lazy attribute.\n\nIf my changes are good, then you can set a positive review.\n\n---\nNew commits:",
    "created_at": "2021-10-08T01:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492849",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:17'></a>Thank you. It is looking very good. I made some additional changes; most are minor tweaks for PEP8 (and breaking the 80 char/line rule when I felt it made things more readable) and documentation. The two biggest changes is I made are (1) the caching is now associated to `colored_jones_polynomial` so the quantum determinant did not have to be computed multiple times; (2) made `RightQuantumWord.to_tuples()` into a lazy attribute.

If my changes are good, then you can set a positive review.

---
New commits:



---

archive/issue_comments_492850.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-08T01:54:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492850",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_492851.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-08T02:34:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492851",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_492852.json:
```json
{
    "body": "<a id='comment:20'></a>I also was able to get an ~8x speedup by being more careful about where objects live and knowing a bit about the internal workings of `FreeAlgebra`:\n\n```\nsage: B = BraidGroup(4)\nsage: b = B([1,1,1,2,-1,2,-3,2,-3])\nsage: %time b.colored_jones_polynomial(2)\nCPU times: user 1.4 s, sys: 4 ms, total: 1.4 s\nWall time: 1.4 s\nq^-1 - 2 + 4*q - 5*q^2 + 6*q^3 - 5*q^4 + 4*q^5 - 3*q^6 + q^7\n```\nBefore this took about 12s. I don't see any other obvious way to speed this up further. With this new version, I can now do the `N=3` case for the above in a reasonable amount of time:\n\n```\nsage: %time b.colored_jones_polynomial(3)\nCPU times: user 34.6 s, sys: 104 ms, total: 34.7 s\nWall time: 34.7 s\nq^-4 - 2*q^-3 + 6*q^-1 - 8 - 2*q + 18*q^2 - 17*q^3 - 8*q^4 + 32*q^5 - 22*q^6\n - 15*q^7 + 39*q^8 - 21*q^9 - 18*q^10 + 34*q^11 - 14*q^12 - 16*q^13 + 22*q^14\n - 5*q^15 - 10*q^16 + 9*q^17 - 3*q^19 + q^20\n```",
    "created_at": "2021-10-08T02:37:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492852",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:20'></a>I also was able to get an ~8x speedup by being more careful about where objects live and knowing a bit about the internal workings of `FreeAlgebra`:

```
sage: B = BraidGroup(4)
sage: b = B([1,1,1,2,-1,2,-3,2,-3])
sage: %time b.colored_jones_polynomial(2)
CPU times: user 1.4 s, sys: 4 ms, total: 1.4 s
Wall time: 1.4 s
q^-1 - 2 + 4*q - 5*q^2 + 6*q^3 - 5*q^4 + 4*q^5 - 3*q^6 + q^7
```
Before this took about 12s. I don't see any other obvious way to speed this up further. With this new version, I can now do the `N=3` case for the above in a reasonable amount of time:

```
sage: %time b.colored_jones_polynomial(3)
CPU times: user 34.6 s, sys: 104 ms, total: 34.7 s
Wall time: 34.7 s
q^-4 - 2*q^-3 + 6*q^-1 - 8 - 2*q + 18*q^2 - 17*q^3 - 8*q^4 + 32*q^5 - 22*q^6
 - 15*q^7 + 39*q^8 - 21*q^9 - 18*q^10 + 34*q^11 - 14*q^12 - 16*q^13 + 22*q^14
 - 5*q^15 - 10*q^16 + 9*q^17 - 3*q^19 + q^20
```



---

archive/issue_comments_492853.json:
```json
{
    "body": "<a id='comment:21'></a>Now I am done (I also made this accessible directly from a knot). Please review my changes.",
    "created_at": "2021-10-08T02:38:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492853",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:21'></a>Now I am done (I also made this accessible directly from a knot). Please review my changes.



---

archive/issue_comments_492854.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-10-08T06:42:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492854",
    "user": "https://github.com/mo271"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_492855.json:
```json
{
    "body": "<a id='comment:22'></a>Wow, nice speedup! All the changes look good to me.",
    "created_at": "2021-10-08T06:42:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492855",
    "user": "https://github.com/mo271"
}
```

<a id='comment:22'></a>Wow, nice speedup! All the changes look good to me.



---

archive/issue_comments_492856.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-10-20T23:03:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492856",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_492857.json:
```json
{
    "body": "<a id='comment:23'></a>Merge conflict",
    "created_at": "2021-10-20T23:03:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492857",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:23'></a>Merge conflict



---

archive/issue_comments_492858.json:
```json
{
    "body": "<a id='comment:24'></a>Last 10 new commits:",
    "created_at": "2021-10-21T14:30:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492858",
    "user": "https://github.com/mo271"
}
```

<a id='comment:24'></a>Last 10 new commits:



---

archive/issue_comments_492859.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-10-21T14:30:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492859",
    "user": "https://github.com/mo271"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_492860.json:
```json
{
    "body": "<a id='comment:25'></a>rebased and fixed all conficts (hopefully)",
    "created_at": "2021-10-21T14:30:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492860",
    "user": "https://github.com/mo271"
}
```

<a id='comment:25'></a>rebased and fixed all conficts (hopefully)



---

archive/issue_comments_492861.json:
```json
{
    "body": "<a id='comment:26'></a>botched rebase, working on fixing it...",
    "created_at": "2021-10-21T14:58:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492861",
    "user": "https://github.com/mo271"
}
```

<a id='comment:26'></a>botched rebase, working on fixing it...



---

archive/issue_comments_492862.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-10-21T14:58:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492862",
    "user": "https://github.com/mo271"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_492863.json:
```json
{
    "body": "<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-21T15:13:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492863",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_492864.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-10-21T15:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492864",
    "user": "https://github.com/mo271"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_492865.json:
```json
{
    "body": "<a id='comment:29'></a>It still conflicts. Sometimes the beta release it conflicts with is not released yet when Volker says there is a merge conflict.",
    "created_at": "2021-10-21T23:11:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492865",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:29'></a>It still conflicts. Sometimes the beta release it conflicts with is not released yet when Volker says there is a merge conflict.



---

archive/issue_comments_492866.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-10-21T23:11:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492866",
    "user": "https://github.com/tscrim"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_492867.json:
```json
{
    "body": "<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2021-10-22T06:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492867",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_492868.json:
```json
{
    "body": "<a id='comment:31'></a>ok, rebased on `9.5.beta4`, see if that helps...",
    "created_at": "2021-10-22T06:45:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492868",
    "user": "https://github.com/mo271"
}
```

<a id='comment:31'></a>ok, rebased on `9.5.beta4`, see if that helps...



---

archive/issue_comments_492869.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-10-22T07:17:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492869",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_492870.json:
```json
{
    "body": "<a id='comment:32'></a>That should be good. Thank you.",
    "created_at": "2021-10-22T07:17:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492870",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:32'></a>That should be good. Thank you.



---

archive/issue_events_086357.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-10-24T18:38:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32582#event-86357"
}
```



---

archive/issue_comments_492871.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-10-24T18:38:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492871",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_492872.json:
```json
{
    "body": "<a id='comment:34'></a>In the method `eps` of the class `RightQuantumWord`,\nthe auxiliary function `eps_monom`'s docstring should\ncome first:\n\n```diff\n         def eps_monom(q_tuple):\n-            q = self.q\n             r\"\"\"Evaluate the map $\\mathcal{E}_N$ for a single mononial.\"\"\"\n+            q = self.q\n```\n\nFor a follow-up ticket if you care enough.",
    "created_at": "2021-10-25T15:24:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492872",
    "user": "https://github.com/slel"
}
```

<a id='comment:34'></a>In the method `eps` of the class `RightQuantumWord`,
the auxiliary function `eps_monom`'s docstring should
come first:

```diff
         def eps_monom(q_tuple):
-            q = self.q
             r"""Evaluate the map $\mathcal{E}_N$ for a single mononial."""
+            q = self.q
```

For a follow-up ticket if you care enough.



---

archive/issue_comments_492873.json:
```json
{
    "body": "<a id='comment:35'></a>I thought I had fixed that, but I missed it. Indeed, that should be fixed (it is likely causing a few lost CPU cycles with Python creating that string on each function call).",
    "created_at": "2021-10-26T05:51:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492873",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:35'></a>I thought I had fixed that, but I missed it. Indeed, that should be fixed (it is likely causing a few lost CPU cycles with Python creating that string on each function call).



---

archive/issue_comments_492874.json:
```json
{
    "body": "<a id='comment:36'></a>Replying to [comment:35 tscrim]:\n> I thought I had fixed that, but I missed it. Indeed, that should be fixed (it is likely causing a few lost CPU cycles with Python creating that string on each function call).\n\n\nFixed in #32829.",
    "created_at": "2021-11-06T02:10:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32582",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32582#issuecomment-492874",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:36'></a>Replying to [comment:35 tscrim]:
> I thought I had fixed that, but I missed it. Indeed, that should be fixed (it is likely causing a few lost CPU cycles with Python creating that string on each function call).


Fixed in #32829.
