# Issue 32025: PolyhedronFace: Fix pickling test

archive/issues_031788.json:
```json
{
    "body": "needed for #32013\n\nWe fix rich comparison of faces and pickled faces, so that as expected we have:\n\n```\nsage: P = polytopes.cube()\nsage: f = P.faces(1)[2]\nsage: f == loads(f.dumps())\nTrue\n```\n\nAlong the way we remove `_test_pickling` skips that are no longer necessary (because ppl polyhedra can be pickled).\n\nCC:  @kliem @tscrim\n\nBranch/Commit: [2b9316b61b375deff2e02b49c4341596353b9ebc](https://github.com/sagemath/sagetrac-mirror/commit/2b9316b61b375deff2e02b49c4341596353b9ebc)\n\nReviewer: Matthias Koeppe\n\nAuthor: Jonathan Kliem\n\nDependencies: #31959\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/32025\n\n",
    "closed_at": "2021-07-25T13:25:32Z",
    "created_at": "2021-06-21T19:09:52Z",
    "labels": [
        "component: geometry",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "PolyhedronFace: Fix pickling test",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32025",
    "user": "https://github.com/mkoeppe"
}
```
needed for #32013

We fix rich comparison of faces and pickled faces, so that as expected we have:

```
sage: P = polytopes.cube()
sage: f = P.faces(1)[2]
sage: f == loads(f.dumps())
True
```

Along the way we remove `_test_pickling` skips that are no longer necessary (because ppl polyhedra can be pickled).

CC:  @kliem @tscrim

Branch/Commit: [2b9316b61b375deff2e02b49c4341596353b9ebc](https://github.com/sagemath/sagetrac-mirror/commit/2b9316b61b375deff2e02b49c4341596353b9ebc)

Reviewer: Matthias Koeppe

Author: Jonathan Kliem

Dependencies: #31959

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/32025





---

archive/issue_comments_637497.json:
```json
{
    "body": "<a id='comment:1'></a>\nCan you please provide an example on where it fails? If you are going to fix it yourself then I guess you'll provide an example along with the fix.",
    "created_at": "2021-06-21T19:13:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-637497",
    "user": "https://github.com/kliem"
}
```

<a id='comment:1'></a>
Can you please provide an example on where it fails? If you are going to fix it yourself then I guess you'll provide an example along with the fix.



---

archive/issue_comments_637498.json:
```json
{
    "body": "<a id='comment:2'></a>\nThe `TestSuite` fails -- currently all calls to `TestSuite` use `skip='_test_pickling'`.\n\nI'm working on something else right now - so help with this ticket would be welcome!",
    "created_at": "2021-06-21T19:58:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-637498",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>
The `TestSuite` fails -- currently all calls to `TestSuite` use `skip='_test_pickling'`.

I'm working on something else right now - so help with this ticket would be welcome!



---

archive/issue_comments_637499.json:
```json
{
    "body": "<a id='comment:3'></a>\nWell, the only problem is that we currently require `face._polyhedron` to be identical for two faces to be tested equal. Otherwise, everything is working, isn't it?",
    "created_at": "2021-06-21T20:14:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-637499",
    "user": "https://github.com/kliem"
}
```

<a id='comment:3'></a>
Well, the only problem is that we currently require `face._polyhedron` to be identical for two faces to be tested equal. Otherwise, everything is working, isn't it?



---

archive/issue_comments_637500.json:
```json
{
    "body": "<a id='comment:4'></a>\nOK, perhaps it's too tricky to implement __richcmp__ for faces of polyhedra that are merely equal, not identical. \n\nAlthough I suppose if the polyhedra are not the same, one could just delegate the comparison to `as_polyhedron(...)`. \n\nBut I guess I can just skip the pickling test in #32013 to work around it.",
    "created_at": "2021-06-21T20:52:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-637500",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>
OK, perhaps it's too tricky to implement __richcmp__ for faces of polyhedra that are merely equal, not identical. 

Although I suppose if the polyhedra are not the same, one could just delegate the comparison to `as_polyhedron(...)`. 

But I guess I can just skip the pickling test in #32013 to work around it.



---

archive/issue_events_095318.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-06-21T20:54:05Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "milestone": "sage-wishlist",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32025#event-95318"
}
```



---

archive/issue_comments_637501.json:
```json
{
    "body": "<a id='comment:6'></a>\nI didn't mean to imply that this does not need to be fixed. I just wanted to comment that the fixing needs to be done in richcmp and not pickling. Pickling works fine.\n\nI guess instead of requiring the two polyhedra two be identical, we can just require the `Vrepresentation` and `Hrepresentation` to be the same:\n\n```diff\n    if self._polyhedron is not other._polyhedron:\n-       raise NotImplementedError\n+       if (self._polyhedron.Vrepresentation() != other._polyhedron.Vrepresentation() \n+               or self._polyhedron.Hrepresentation() != other._polyhedron.Hrepresentation()):\n+           raise NotImplementedError\n```\n\nActually we can be less strict and allow the Hrepresentation to differ. We could even allow the Vrepresentation to be a permutation of the other Vrepresentation, but this is definitely not needed to fix the pickling test for faces.",
    "created_at": "2021-06-22T10:37:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-637501",
    "user": "https://github.com/kliem"
}
```

<a id='comment:6'></a>
I didn't mean to imply that this does not need to be fixed. I just wanted to comment that the fixing needs to be done in richcmp and not pickling. Pickling works fine.

I guess instead of requiring the two polyhedra two be identical, we can just require the `Vrepresentation` and `Hrepresentation` to be the same:

```diff
    if self._polyhedron is not other._polyhedron:
-       raise NotImplementedError
+       if (self._polyhedron.Vrepresentation() != other._polyhedron.Vrepresentation() 
+               or self._polyhedron.Hrepresentation() != other._polyhedron.Hrepresentation()):
+           raise NotImplementedError
```

Actually we can be less strict and allow the Hrepresentation to differ. We could even allow the Vrepresentation to be a permutation of the other Vrepresentation, but this is definitely not needed to fix the pickling test for faces.



---

archive/issue_comments_637502.json:
```json
{
    "body": "<a id='comment:7'></a>\nNew commits:\n|                                                                                                                                          |                                        |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------|\n|[981bb21](https://github.com/sagemath/sagetrac-mirror/commit/981bb21fbd18ef9fe9931698d752a3238110f351)|`allow rich comparison of pickled faces`|\n|[52a6f40](https://github.com/sagemath/sagetrac-mirror/commit/52a6f40d204d88fff4c0ac3bf56c9bec9ed232d1)|`do not skip `test_pickling`, if it works`|",
    "created_at": "2021-06-22T10:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-637502",
    "user": "https://github.com/kliem"
}
```

<a id='comment:7'></a>
New commits:
|                                                                                                                                          |                                        |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------|
|[981bb21](https://github.com/sagemath/sagetrac-mirror/commit/981bb21fbd18ef9fe9931698d752a3238110f351)|`allow rich comparison of pickled faces`|
|[52a6f40](https://github.com/sagemath/sagetrac-mirror/commit/52a6f40d204d88fff4c0ac3bf56c9bec9ed232d1)|`do not skip `test_pickling`, if it works`|



---

archive/issue_comments_637503.json:
```json
{
    "body": "Author: Jonathan Kliem",
    "created_at": "2021-06-22T10:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-637503",
    "user": "https://github.com/kliem"
}
```

Author: Jonathan Kliem



---

archive/issue_events_095319.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "rename": {
        "from": "PolyhedronFace: Fix pickling",
        "to": "PolyhedronFace: Fix pickling test"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32025#event-95319"
}
```



---

archive/issue_comments_637504.json:
```json
{
    "body": "Branch: [public/32025](https://github.com/sagemath/sagetrac-mirror/tree/public/32025)",
    "created_at": "2021-06-22T10:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-637504",
    "user": "https://github.com/kliem"
}
```

Branch: [public/32025](https://github.com/sagemath/sagetrac-mirror/tree/public/32025)



---

archive/issue_comments_637505.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,12 @@\n needed for #32013\n+\n+We fix rich comparison of faces and pickled faces, so that as expected we have:\n+\n+```\n+sage: P = polytopes.cube()\n+sage: f = P.faces(1)[2]\n+sage: f == loads(f.dumps())\n+True\n+```\n+\n+Along the way we remove `_test_pickling` skips that are no longer necessary (because ppl polyhedra can be pickled).\n``````\n",
    "created_at": "2021-06-22T10:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-637505",
    "user": "https://github.com/kliem"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,12 @@
 needed for #32013
+
+We fix rich comparison of faces and pickled faces, so that as expected we have:
+
+```
+sage: P = polytopes.cube()
+sage: f = P.faces(1)[2]
+sage: f == loads(f.dumps())
+True
+```
+
+Along the way we remove `_test_pickling` skips that are no longer necessary (because ppl polyhedra can be pickled).
``````




---

archive/issue_comments_637506.json:
```json
{
    "body": "Commit: [52a6f40d204d88fff4c0ac3bf56c9bec9ed232d1](https://github.com/sagemath/sagetrac-mirror/commit/52a6f40d204d88fff4c0ac3bf56c9bec9ed232d1)",
    "created_at": "2021-06-22T10:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-637506",
    "user": "https://github.com/kliem"
}
```

Commit: [52a6f40d204d88fff4c0ac3bf56c9bec9ed232d1](https://github.com/sagemath/sagetrac-mirror/commit/52a6f40d204d88fff4c0ac3bf56c9bec9ed232d1)



---

archive/issue_comments_637507.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-22T10:58:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-637507",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_events_095320.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-06-22T10:58:11Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "milestone": "sage-wishlist",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32025#event-95320"
}
```



---

archive/issue_events_095321.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2021-06-22T10:58:11Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32025#event-95321"
}
```



---

archive/issue_comments_637508.json:
```json
{
    "body": "<a id='comment:8'></a>\nBranch pushed to git repo; I updated commit sha1. Last 10 new commits:\n|                                                                                                                                           |                                                                    |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------|\n|[686d0af](https://github.com/sagemath/sagetrac-mirror/commit/686d0afbeba9f5d33131ecbe20a907c20635faa5)|`Polyhedron_base.product: Add doctest for alias 'cartesian_product'`|\n|[2b1d108](https://github.com/sagemath/sagetrac-mirror/commit/2b1d108f1c5c788af1699943d8c79a60bffbf570)|`Merge #31919`|\n|[7323b10](https://github.com/sagemath/sagetrac-mirror/commit/7323b10d6c628c32adfeb62025879f909f707c61)|`ConvexSet_base._test_contains: Only test extension to AA for exact base rings`|\n|[94e6858](https://github.com/sagemath/sagetrac-mirror/commit/94e68582fde0f5bb8b2c57e5f7aa56dbaa5e825a)|`RelativeInterior.ambient, ambient_vector_space, is_universe: New`|\n|[0c9bc94](https://github.com/sagemath/sagetrac-mirror/commit/0c9bc945a59ffbf38c59d3679036bf4c90a516fd)|`ConvexSet_base: Add default implementations of ambient, ambient_dim; add doctests`|\n|[ce91e44](https://github.com/sagemath/sagetrac-mirror/commit/ce91e44231c897ad00c4d838d2e4f081afcc6ff9)|`src/sage/geometry/relative_interior.py: Fix doctest output`|\n|[f0e7c58](https://github.com/sagemath/sagetrac-mirror/commit/f0e7c5864eeea17190b0657accf9534fcafa0c89)|`ambient_vector_space docstring: Fix bad blocks`|\n|[200d967](https://github.com/sagemath/sagetrac-mirror/commit/200d967982e2d4c600658354ef80a15f1ed0ccd8)|`ConvexSet_base.ambient doctest: Actually test the method`|\n|[f02ca28](https://github.com/sagemath/sagetrac-mirror/commit/f02ca284d4c7b886f5b185db5e6b6d6a8bc4a039)|`src/sage/geometry/polyhedron/face.py: Remove unused import`|\n|[2b9316b](https://github.com/sagemath/sagetrac-mirror/commit/2b9316b61b375deff2e02b49c4341596353b9ebc)|`Merge #31959`|",
    "created_at": "2021-06-22T14:24:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-637508",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>
Branch pushed to git repo; I updated commit sha1. Last 10 new commits:
|                                                                                                                                           |                                                                    |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------|
|[686d0af](https://github.com/sagemath/sagetrac-mirror/commit/686d0afbeba9f5d33131ecbe20a907c20635faa5)|`Polyhedron_base.product: Add doctest for alias 'cartesian_product'`|
|[2b1d108](https://github.com/sagemath/sagetrac-mirror/commit/2b1d108f1c5c788af1699943d8c79a60bffbf570)|`Merge #31919`|
|[7323b10](https://github.com/sagemath/sagetrac-mirror/commit/7323b10d6c628c32adfeb62025879f909f707c61)|`ConvexSet_base._test_contains: Only test extension to AA for exact base rings`|
|[94e6858](https://github.com/sagemath/sagetrac-mirror/commit/94e68582fde0f5bb8b2c57e5f7aa56dbaa5e825a)|`RelativeInterior.ambient, ambient_vector_space, is_universe: New`|
|[0c9bc94](https://github.com/sagemath/sagetrac-mirror/commit/0c9bc945a59ffbf38c59d3679036bf4c90a516fd)|`ConvexSet_base: Add default implementations of ambient, ambient_dim; add doctests`|
|[ce91e44](https://github.com/sagemath/sagetrac-mirror/commit/ce91e44231c897ad00c4d838d2e4f081afcc6ff9)|`src/sage/geometry/relative_interior.py: Fix doctest output`|
|[f0e7c58](https://github.com/sagemath/sagetrac-mirror/commit/f0e7c5864eeea17190b0657accf9534fcafa0c89)|`ambient_vector_space docstring: Fix bad blocks`|
|[200d967](https://github.com/sagemath/sagetrac-mirror/commit/200d967982e2d4c600658354ef80a15f1ed0ccd8)|`ConvexSet_base.ambient doctest: Actually test the method`|
|[f02ca28](https://github.com/sagemath/sagetrac-mirror/commit/f02ca284d4c7b886f5b185db5e6b6d6a8bc4a039)|`src/sage/geometry/polyhedron/face.py: Remove unused import`|
|[2b9316b](https://github.com/sagemath/sagetrac-mirror/commit/2b9316b61b375deff2e02b49c4341596353b9ebc)|`Merge #31959`|



---

archive/issue_comments_637509.json:
```json
{
    "body": "Changing commit from \"[52a6f40d204d88fff4c0ac3bf56c9bec9ed232d1](https://github.com/sagemath/sagetrac-mirror/commit/52a6f40d204d88fff4c0ac3bf56c9bec9ed232d1)\" to \"[2b9316b61b375deff2e02b49c4341596353b9ebc](https://github.com/sagemath/sagetrac-mirror/commit/2b9316b61b375deff2e02b49c4341596353b9ebc)\"",
    "created_at": "2021-06-22T14:24:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-637509",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "[52a6f40d204d88fff4c0ac3bf56c9bec9ed232d1](https://github.com/sagemath/sagetrac-mirror/commit/52a6f40d204d88fff4c0ac3bf56c9bec9ed232d1)" to "[2b9316b61b375deff2e02b49c4341596353b9ebc](https://github.com/sagemath/sagetrac-mirror/commit/2b9316b61b375deff2e02b49c4341596353b9ebc)"



---

archive/issue_comments_637510.json:
```json
{
    "body": "<a id='comment:9'></a>\nMerged to resolve merge conflict",
    "created_at": "2021-06-22T14:24:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-637510",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>
Merged to resolve merge conflict



---

archive/issue_comments_637511.json:
```json
{
    "body": "Dependencies: #31959",
    "created_at": "2021-06-22T14:24:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-637511",
    "user": "https://github.com/mkoeppe"
}
```

Dependencies: #31959



---

archive/issue_comments_637512.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-06-23T01:12:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-637512",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_637513.json:
```json
{
    "body": "Reviewer: Matthias Koeppe",
    "created_at": "2021-06-23T01:12:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-637513",
    "user": "https://github.com/mkoeppe"
}
```

Reviewer: Matthias Koeppe



---

archive/issue_comments_637514.json:
```json
{
    "body": "<a id='comment:10'></a>\nThanks for working on this! LGTM",
    "created_at": "2021-06-23T01:12:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-637514",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>
Thanks for working on this! LGTM



---

archive/issue_comments_637515.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-25T13:25:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-637515",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_637516.json:
```json
{
    "body": "Changing branch from \"[public/32025](https://github.com/sagemath/sagetrac-mirror/tree/public/32025)\" to \"[2b9316b61b375deff2e02b49c4341596353b9ebc](https://github.com/sagemath/sagetrac-mirror/commit/2b9316b61b375deff2e02b49c4341596353b9ebc)\"",
    "created_at": "2021-07-25T13:25:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32025#issuecomment-637516",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "[public/32025](https://github.com/sagemath/sagetrac-mirror/tree/public/32025)" to "[2b9316b61b375deff2e02b49c4341596353b9ebc](https://github.com/sagemath/sagetrac-mirror/commit/2b9316b61b375deff2e02b49c4341596353b9ebc)"



---

archive/issue_events_095322.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-07-25T13:25:32Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32025",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32025#event-95322"
}
```
