# Issue 24685: Use restore_atexit in doctest framework

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2018-03-07 09:49:16

CC:  embray chapoton




---

Comment by jdemeyer created at 2018-03-07 10:21:00

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-03-07 10:21:00

Can somebody review my changes (top 2 commits)?
----
New commits:


---

Comment by embray created at 2018-03-07 10:44:50

I don't see why anyone would want this:


```
+        If ``run=True` and ``clear=False``, then exit functions might
+        be run twice: once when exiting this context and again when
+        exiting Python.
```


so I would just note that `run=True` implies `clear=True`.


---

Comment by jdemeyer created at 2018-03-07 10:48:06

Replying to [comment:4 embray]:
> I don't see why anyone would want this

Me neither, but is that a sufficient reason to not support it?

What would you suggest precisely? Just to remove that piece of doc or to change the code?


---

Comment by embray created at 2018-03-07 11:57:09

A little of both.  Setting `run=True` would force `clear=True`.  I'm fine with not changing it either, it just seems strange to have docs along the lines of "this particular combination of inputs makes no sense, but it works anyways..."


---

Comment by jdemeyer created at 2018-03-07 14:09:30

Replying to [comment:6 embray]:
> it just seems strange to have docs along the lines of "this particular combination of inputs makes no sense, but it works anyways..."

I see it more as "I cannot think of a reason why you would want to do that, but if you want, you can do ".


---

Comment by git created at 2018-03-08 08:32:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-03-08 09:16:35

I reworded the comment slightly (without changing the code).


---

Comment by embray created at 2018-03-08 13:20:31

Okay, up to you.


---

Comment by embray created at 2018-03-08 13:20:31

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-03-11 12:58:01

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-03-11 12:58:01


```
sage -t src/sage/structure/coerce_dict.pyx
**********************************************************************
File "src/sage/structure/coerce_dict.pyx", line 399, in sage.structure.coerce_dict.MonoDict
Failed example:
    del a
Expected:
    Exception RuntimeError: 'maximum recursion depth exceeded while calling a Python object' in <function remove at ...> ignored
Got:
    Exception RuntimeError: 'maximum recursion depth exceeded' in <function remove at 0x7f8a9daf4f50> ignored
**********************************************************************
1 item had failures:
   1 of  62 in sage.structure.coerce_dict.MonoDict
    [311 tests, 1 failure, 21.72 s]
----------------------------------------------------------------------
sage -t src/sage/structure/coerce_dict.pyx  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by embray created at 2018-03-12 14:22:53

It's mysterious to me how this change would cause this specific minor difference in this exception message, but it does appear to be the case...


---

Comment by embray created at 2018-03-12 14:38:24

I think I see. In this slight bit of refactoring we added another level of call stack depth in the test run, and the exact exception message that occurs for a recursion error can depend on exactly where the Python interpreter is at that moment--in this case whether it's just constructing a new frame, or if it's executing a `PyObject_Call`.  This subtle change in the test runner caused this exception message to be slightly different.  We should just add ellipses to it to make it more flexible.


---

Comment by embray created at 2018-03-12 14:40:06

New commits:


---

Comment by embray created at 2018-03-12 14:40:06

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-03-12 14:55:27

Positive review if tests pass.


---

Comment by jdemeyer created at 2018-03-12 14:55:27

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-03-12 15:00:46

This was the only test I could find that would be affected by this.


---

Comment by vbraun created at 2018-03-22 19:23:40

Resolution: fixed
