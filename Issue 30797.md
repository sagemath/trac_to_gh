# Issue 30797: GH Actions workflow to sync upstream packages to the Sage server

Issue created by migration from https://trac.sagemath.org/ticket/31034

Original creator: mkoeppe

Original creation time: 2020-12-10 00:41:22

CC:  vbraun @kliem @tobiasdiez dimpase jipilab slelievre slabbe

We should be able to automate this using

```
./sage -package download --allow-upstream :all:
```

followed by 

```
./sage -package upload :all:
```

... if someone is able to set up the necessary credentials for the workflow.


---

Comment by dimpase created at 2020-12-10 13:55:31

it might be more reasonable to do this with a special GH action.
Then it can be run on e.g. Volker's repo by him, e.g. while making a beta.


---

Comment by vbraun created at 2020-12-20 11:01:26

I tried to put it into my release management script but it doesn't actually try to download from the `upstream_url`:

```
$ cat build/pkgs/pynormaliz/checksums.ini 
tarball=PyNormaliz-VERSION.tar.gz
sha1=c01c7a734deeb09e1dd236fb53575b152b99657b
md5=6ff9ccc61592190fdb88fe08a50e062c
cksum=3111232777
upstream_url=https://pypi.io/packages/source/p/pynormaliz/PyNormaliz-VERSION.tar.gz

$ ./sage -package download --allow-upstream pynormaliz
[...]
http://sagepad.org/spkg/upstream/pynormaliz/PyNormaliz-2.13.tar.gz
[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]
ERROR [transfer|run:135]: [Errno 404] Not Found: '//sagepad.org/spkg/upstream/pynormaliz/PyNormaliz-2.13.tar.gz'
Traceback (most recent call last):
  File "/home/release/Sage/build/bin/sage-package", line 42, in <module>
    run()
  File "/home/release/Sage/build/bin/../sage_bootstrap/cmdline.py", line 339, in run
    app.download_cls(args.package_name, args.allow_upstream)
  File "/home/release/Sage/build/bin/../sage_bootstrap/app.py", line 177, in download_cls
    pc.apply(self.download)
  File "/home/release/Sage/build/bin/../sage_bootstrap/expand_class.py", line 71, in apply
    function(package_name, *args, **kwds)
  File "/home/release/Sage/build/bin/../sage_bootstrap/app.py", line 167, in download
    package.tarball.download(allow_upstream=allow_upstream)
  File "/home/release/Sage/build/bin/../sage_bootstrap/tarball.py", line 177, in download
    raise FileNotMirroredError('tarball does not exist on mirror network')
sage_bootstrap.tarball.FileNotMirroredError: tarball does not exist on mirror network
```

Is there anything that I'm doing wrong?


---

Comment by dimpase created at 2020-12-20 12:24:19

./configure must be run with
`--enable-download-from-upstream-url`


---

Comment by vbraun created at 2020-12-20 14:17:28

Is the `--allow-upstream` actually doing anything or is only the configure switch relevant?


---

Comment by mkoeppe created at 2020-12-20 19:38:05

`./sage -package` does NOT respect the configure switch, it only handles `--allow-upstream`... which, however, was indeed broken


---

Comment by mkoeppe created at 2020-12-20 19:40:41

New commits:


---

Comment by mkoeppe created at 2020-12-20 19:47:54

Changing status from new to needs_review.


---

Comment by @kliem created at 2020-12-22 16:22:26

Why did you update pynormaliz to 7.77?


---

Comment by mkoeppe created at 2020-12-22 16:23:20

Sorry...


---

Comment by git created at 2020-12-22 16:24:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @kliem created at 2020-12-22 16:29:31

This ticket looks like a left over from somewhere else.

I mean, why was `download_with_args` defined but never used?


---

Comment by mkoeppe created at 2020-12-22 16:31:49

Probably I messed it up in a merge.


---

Comment by @kliem created at 2020-12-22 16:40:02

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2020-12-22 16:40:02

LGTM.


---

Comment by @kliem created at 2020-12-22 16:41:57

Btw, pynormaliz still isn't on the mirrors, this is how I tested it. It was convenient for this purpose, but isn't otherwise.


---

Comment by mkoeppe created at 2020-12-22 16:45:14

Thank you!


---

Comment by slelievre created at 2020-12-23 13:54:31

Replying to [comment:17 gh-kliem]:
> Btw, pynormaliz still isn't on the mirrors, this is how I tested it.
> It was convenient for this purpose, but isn't otherwise.

Fixed now. Thanks Volker!


---

Comment by vbraun created at 2020-12-23 15:13:04

To run this unattended we also need to ignore tarballs that we are not allowed to distribute for licensing reasons:

```
$ echo sage -package download --allow-upstream :all:
[...]
http://sagepad.org/spkg/upstream/scipoptsuite/scipoptsuite-5.0.1.tgz
[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]
ERROR [transfer|run:135]: [Errno 404] Not Found: '//sagepad.org/spkg/upstream/scipoptsuite/scipoptsuite-5.0.1.tgz'
Traceback (most recent call last):
  File "/home/release/Sage/build/bin/sage-package", line 42, in <module>
    run()
  File "/home/release/Sage/build/bin/../sage_bootstrap/cmdline.py", line 339, in run
    app.download_cls(args.package_name, args.allow_upstream)
  File "/home/release/Sage/build/bin/../sage_bootstrap/app.py", line 177, in download_cls
    pc.apply(download_with_args)
  File "/home/release/Sage/build/bin/../sage_bootstrap/expand_class.py", line 71, in apply
    function(package_name, *args, **kwds)
  File "/home/release/Sage/build/bin/../sage_bootstrap/app.py", line 176, in download_with_args
    return self.download(package, allow_upstream=allow_upstream)
  File "/home/release/Sage/build/bin/../sage_bootstrap/app.py", line 167, in download
    package.tarball.download(allow_upstream=allow_upstream)
  File "/home/release/Sage/build/bin/../sage_bootstrap/tarball.py", line 177, in download
    raise FileNotMirroredError('tarball does not exist on mirror network')
sage_bootstrap.tarball.FileNotMirroredError: tarball does not exist on mirror network
```



---

Comment by vbraun created at 2020-12-23 15:13:44

Changing status from positive_review to needs_work.


---

Comment by @kliem created at 2020-12-23 15:17:07

I think this ticket is fine. It fixes

```
./sage -package download --allow-upstream :all:
```

as claimed.


```
./sage -package upload :all:
```

needs work yet, which is a seperate issue, I would say.

Of course, both things can be taken care of in this ticket. But one might as well open a seperate ticket.


---

Comment by mkoeppe created at 2020-12-23 17:52:30

`needs_work` is just shorthand for "Could you please prepare the mechanism to exclude non-distributable tarballs as you suggested on the ticket description". I'm working on it.


---

Comment by git created at 2020-12-23 18:16:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-23 18:19:42

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-12-23 18:19:42

Here's a version with this new feature


---

Comment by @kliem created at 2020-12-23 18:43:46

There is at least an info section missing here https://doc.sagemath.org/html/en/developer/packaging.html, so that people are warned when adding new packages.

However, I would prefer it the other way around, even though it is annoying: Have a small sentence in SPKG.rst that we may redistribute. This would be more fool-proof.


---

Comment by mkoeppe created at 2020-12-23 19:08:25

Replying to [comment:27 gh-kliem]:
> There is at least an info section missing here https://doc.sagemath.org/html/en/developer/packaging.html, so that people are warned when adding new packages.

Good idea.

> However, I would prefer it the other way around, even though it is annoying: Have a small sentence in SPKG.rst that we may redistribute. This would be more fool-proof.

I disagree. We make free software here; the non-distributable case is an exception for rare cases.

It does not have to be foolproof. We have the review process that so far seems to have successfully stopped people from adding proprietary packages.

If you are interested in adding structured license info to `build/pkgs/`... see #21571.


---

Comment by @kliem created at 2020-12-23 19:11:57

Fine.


---

Comment by git created at 2020-12-23 19:15:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-12-23 20:15:19

Ok, seems fine.

Have you tested that this actually works and skips scipoptsuite?


---

Comment by @kliem created at 2020-12-23 20:32:18

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2020-12-23 20:32:18

Never mind, I tested it with a dummy file and it works fine.


---

Comment by mkoeppe created at 2020-12-23 20:45:53

Thanks!


---

Comment by vbraun created at 2020-12-25 15:49:34

Downloading still fails tho:

```
$ sage -package download --allow-upstream :all:
[...]
http://sagepad.org/spkg/upstream/scipoptsuite/scipoptsuite-5.0.1-do-not-distribute.tgz
[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]
ERROR [transfer|run:135]: [Errno 404] Not Found: '//sagepad.org/spkg/upstream/scipoptsuite/scipoptsuite-5.0.1-do-not-distribute.tgz'
Traceback (most recent call last):
  File "/home/release/Sage/build/bin/sage-package", line 42, in <module>
    run()
  File "/home/release/Sage/build/bin/../sage_bootstrap/cmdline.py", line 339, in run
    app.download_cls(args.package_name, args.allow_upstream)
  File "/home/release/Sage/build/bin/../sage_bootstrap/app.py", line 177, in download_cls
    pc.apply(download_with_args)
  File "/home/release/Sage/build/bin/../sage_bootstrap/expand_class.py", line 71, in apply
    function(package_name, *args, **kwds)
  File "/home/release/Sage/build/bin/../sage_bootstrap/app.py", line 176, in download_with_args
    return self.download(package, allow_upstream=allow_upstream)
  File "/home/release/Sage/build/bin/../sage_bootstrap/app.py", line 167, in download
    package.tarball.download(allow_upstream=allow_upstream)
  File "/home/release/Sage/build/bin/../sage_bootstrap/tarball.py", line 180, in download
    raise FileNotMirroredError('tarball does not exist on mirror network')
sage_bootstrap.tarball.FileNotMirroredError: tarball does not exist on mirror network
```



---

Comment by vbraun created at 2020-12-25 15:49:34

Changing status from positive_review to needs_work.


---

Comment by git created at 2020-12-25 19:01:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-25 19:02:20

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-12-25 19:02:54

Here you go


---

Comment by vbraun created at 2020-12-27 00:26:55

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-12-27 03:24:54

Thanks.


---

Comment by vbraun created at 2020-12-27 23:25:48

Resolution: fixed
