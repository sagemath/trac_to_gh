# Issue 11405: save(x,filename) fails for some types of objects for x if filename contains a dot

Issue created by migration from https://trac.sagemath.org/ticket/11577

Original creator: logix

Original creation time: 2011-07-05 14:53:21

Assignee: ncalexan

If the filename passed to save() contains a dot, save() assumes that the user doesnt just want to dump the (pickled) object, but instead wants to call the object's save() method. I guess this makes sense in situations like save(g, 'mygraph.png'), but the code should fall back to dumping the pickled version (e.g. via try: ... except AttributeError: ... - suggested via IRC by leif) if the object has no save() method.

leif also suggested checking if the file name extension is known - however I guess that we then should verify this with the object itself (e.g. it wouldn't make sense to save a graphics object to a .wav file) and not statically compare with a list of known extensions.


```
sage: save((1,1), 'foo2')
sage: save(Matrix(3,3), 'foo.bar3')
sage: save((1,1), 'foo.bar4')
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)

/tmp/sagedebug/<ipython console> in <module>()

/usr/local/sage/local/lib/python2.6/site-packages/sage/structure/sage_object.so in sage.structure.sage_object.save (sage/structure/sage_object.c:8156)()

AttributeError: 'tuple' object has no attribute 'save'
```



---

Comment by leif created at 2011-07-05 15:13:39

Changing component from sage-mode to pickling.


---

Comment by leif created at 2011-07-05 15:13:39

Changing assignee from ncalexan to was.


---

Comment by leif created at 2011-07-05 15:19:46

What about simply adding `.sobj` above if there's no extension *or* the object has no `save()` method?


---

Comment by leif created at 2011-07-05 16:45:19

Attached patch does exactly what I suggested last.


---

Comment by leif created at 2011-07-05 16:45:19

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2011-07-23 19:34:27

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2011-07-23 19:34:27

You shouldn't write to a file like "foo.bar" in a doctest.  Instead, make sure you write to a temporary directory, for example using SAGE_TMP.


---

Comment by leif created at 2011-07-23 19:52:00

Replying to [comment:6 jhpalmieri]:
> You shouldn't write to a file like "foo.bar" in a doctest.  Instead, make sure you write to a temporary directory, for example using SAGE_TMP.

Ooops, I thought doctests would be executed there, i.e. `sage{-doctest,doctest.py}` would `cd` to that before running Python.


---

Attachment

Sage library patch. Adds ".sobj" to filename if the object has no save() method. (Corrected and improved version.) Based on Sage 4.7.1.rc0.


---

Comment by leif created at 2011-07-23 23:36:06

Changing status from needs_work to needs_review.


---

Comment by leif created at 2011-07-23 23:36:06

Finally...

The updated patch now adds another doctest and clarifies the description in the docstring. (I intentionally haven't changed it to enumerate all parameters as we normally do, as I think it is more readable as it is now, and `compress=True` should be self-explanatory. For some reason I don't get the correct default parameters shown when typing `save?` at the Sage prompt though.)

I originally wanted to add 

```python
    import os.path
    from sage.misc.misc import SAGE_TMP
    filename = os.path.join(SAGE_TMP, "foo.bar")
    ...
```

but then saw the other examples, so I guess _a lot of_ doctests rely on
 * having `SAGE_TMP` already imported (by `sage.all`), and also
 * `SAGE_TMP` having a trailing slash (or `os.path.sep`),
the latter being perhaps a bit more dangerous than the former.

So I also just used `SAGE_TMP + "..."`.


---

Comment by jhpalmieri created at 2011-07-24 03:23:27

At the sage: prompt, I get

```
Definition:       save(obj, filename, compress=None, **kwds=True)
```

Odd, the values are shifted right by one (filename should be None, compress should be True).  I wonder what's causing that.  Other functions in the same file seem to be okay.  I have some old copies of Sage around, and this behavior dates back to at least version 4.3.

As far as `SAGE_TMP` is concerned, you're right, it's sloppy.  Probably the right solution is to have a function `sage_tmpfile` or something like that, which takes one argument, FILE, and returns a valid path using `os.path.join(SAGE_TMP, FILE)`.  In fact, if you look at how `SAGE_TMP` is defined in the first place (in sage.misc.misc), it's defined using explicit slashes rather than with `os.path.join`.  This all belongs on another ticket; if I have time, I'll work on that eventually.

I'm happy with the patch, basically as is.  I'm attaching a new version fixing one or two words in the docstring.  I'm marking it as "positive review"; if you don't like my changes, switch it back.


---

Comment by jhpalmieri created at 2011-07-24 03:23:27

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2011-07-24 03:23:56

for reference only: difference between old patch and new one


---

Attachment

apply only this patch


---

Attachment

Replying to [comment:9 jhpalmieri]:
> At the sage: prompt, I get

```
Definition:       save(obj, filename, compress=None, **kwds=True)
```


Oh, I did not notice the true keywords.

The most disturbing thing with `SAGE_TMP` is IMHO that it ignores settings of `TMP`, `TMPDIR` and `TEMP`, and -- worse -- does not even use `/tmp/` which is more likely to be on a local (usually auto-cleaned) file system than `$HOME/.sage/`, and I don't expect people to change `DOT_SAGE`  to live on a temporary filesystem. (Ok, one can still create a symbolic link from `~/.sage/temp` to whatever is desired, but who knows? Especially since there's also `~/.sage/tmp/` and of course `$SAGE_ROOT/tmp/`.) We furthermore had `SAGE_TMPDIR` and `SAGE_TESTDIR`, the former meanwhile changed to the latter. I'll perhaps open a `sage-devel` thread on that (to make William happy).

> I'm attaching a new version fixing one or two words in the docstring.

Ok. Regarding extensions, I'd consider `foo.png` having _one_, while `foo.baz` and `foo.bar` (non-exclusively) having _some_. :-)


---

Comment by jdemeyer created at 2011-08-18 06:18:00

I have a doctest failure which might have been caused by this:

```
sage -t  -force_lib devel/sage/sage/misc/cachefunc.py
**********************************************************************
File "/mnt/usb1/scratch/jdemeyer/merger/sage-4.7.2.alpha2/devel/sage-main/sage/misc/cachefunc.py", line 1106:
    sage: for f in sorted(FC.file_list()): print f[len(dir):]
Expected:
    /t-.key.sobj
    /t-.sobj
    /t-1_2.key.sobj
    /t-1_2.sobj
    /t-a-1.1.key.sobj
    /t-a-1.1.sobj
Got:
    /t-.key.sobj.sobj
    /t-.sobj.sobj
    /t-1_2.key.sobj.sobj
    /t-1_2.sobj.sobj
    /t-a-1.1.key.sobj.sobj
    /t-a-1.1.sobj.sobj
```



---

Comment by jdemeyer created at 2011-08-18 06:18:00

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2011-08-18 09:33:00

Confirmed that this does indeed cause the above doctest failures on sage-4.7.1.


---

Comment by jhpalmieri created at 2011-08-18 22:59:36

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2011-08-18 22:59:36

Here's a new patch, along with a "delta" patch.


---

Attachment

for reference only: difference between old jhp patch and v2


---

Comment by jhpalmieri created at 2011-08-18 23:00:18

apply only this patch


---

Comment by leif created at 2011-08-19 01:21:28

Changing status from needs_review to positive_review.


---

Attachment

New patch looks reasonable, and passes all [long] tests in `sage/{misc,structure}/`, so *positive review*. (Tested with Sage 4.7.1.rc2.)


---

Comment by leif created at 2011-08-19 01:21:28

Changing keywords from "" to ".sobj".


---

Comment by jdemeyer created at 2011-08-22 17:34:16

Resolution: fixed
