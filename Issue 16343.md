# Issue 16343: FiniteStateMachine: cleanup code

Issue created by migration from https://trac.sagemath.org/ticket/16580

Original creator: cheuberg

Original creation time: 2014-06-28 05:59:42

CC:  dkrenn skropf

Keywords: finite_state_machine

#16067 introduced some changes into the finite state machine code by rewritting several instances of filter into list comprehensions. When re-reading the resulting code, I had the impression that the code can be simplified somewhat by combining it with the next lines (two occurrences). So I simplified these two occurrences.

Another occurrence touched very inefficient code in `_latex_` which was scheduled to be rewritten at some state anyway. So this is now done. Unfortunately, this changes the order of the transitions in the latex output, so the output in a few corresponding doctests had to be reordered, too.

Furthermore, when #15990 rewrote the raise statement for Python 3 compatibility, one occurrence of the old syntax was re-introduced in a separate branch. Fixed this.

Finally, added two doctests where I wanted to make sure that two methods work as promised.


---

Comment by cheuberg created at 2014-06-28 05:59:59

Changing status from new to needs_review.


---

Comment by dkrenn created at 2014-07-19 17:49:20

Changing status from needs_review to positive_review.


---

Comment by dkrenn created at 2014-07-19 17:49:20

Reviewed the patch...looks fine.


---

Comment by vbraun created at 2014-07-20 03:22:03

Fails on OSX:

```
sage -t --long src/sage/combinat/finite_state_machine.py
**********************************************************************
File "src/sage/combinat/finite_state_machine.py", line 3318, in sage.combinat.finite_state_machine.FiniteStateMachine.?
Failed example:
    latex(T)
Expected:
    \begin{tikzpicture}[auto, initial text=, >=latex]
    \node[state, initial, initial where=above] (v0) at (0.000000, 0.000000) {$\mathcal{I}$};
    \node[state, accepting, accepting where=left] (v1) at (-6.000000, 3.000000) {$\mathbf{0}$};
    \node[state, accepting, accepting where=45] (v2) at (6.000000, 3.000000) {$\mathbf{3}$};
    \path[->] (v2.45.00) edge node[rotate=45.00, anchor=south] {$\$ \mid {\scriptstyle w_{0} w_{0}}$} ++(45.00:10ex);
    \node[state] (v3) at (-2.000000, 3.000000) {$\mathbf{1}$};
    \node[state] (v4) at (2.000000, 3.000000) {$\mathbf{2}$};
    \path[->] (v0.31.57) edge node[rotate=26.57, anchor=south] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{3}}$} (v2.201.57);
    \path[->] (v1) edge[loop left] node[rotate=90, anchor=south] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0}}$} ();
    \path[->] (v2) edge[loop below] node {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0}}$} ();
    \path[->] (v0.128.69) edge node[rotate=303.69, anchor=north] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{1}}$} (v3.298.69);
    \path[->] (v4.-118.69) edge node[rotate=56.31, anchor=north] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{-2}}$} (v0.51.31);
    \path[->] (v0.158.43) edge node[rotate=333.43, anchor=north] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{0}}$} (v1.328.43);
    \path[->] (v2.-148.43) edge node[rotate=26.57, anchor=north] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{-3}}$} (v0.21.57);
    \path[->] (v3.-51.31) edge node[rotate=-56.31, anchor=south] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{-1}}$} (v0.118.69);
    \path[->] (v0) edge[loop below] node {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0}}$} ();
    \path[->] (v4) edge[loop right] node[rotate=90, anchor=north] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0}}$} ();
    \path[->] (v1.-21.57) edge node[rotate=-26.57, anchor=south] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{0}}$} (v0.148.43);
    \path[->] (v3) edge[loop above] node {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0}}$} ();
    \path[->] (v0.61.31) edge node[rotate=56.31, anchor=south] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{2}}$} (v4.231.31);
    \end{tikzpicture}
Got:
    \begin{tikzpicture}[auto, initial text=, >=latex]
    \node[state, initial, initial where=above] (v0) at (0.000000, 0.000000) {$\mathcal{I}$};
    \node[state, accepting, accepting where=left] (v1) at (-6.000000, 3.000000) {$\mathbf{0}$};
    \node[state, accepting, accepting where=45] (v2) at (6.000000, 3.000000) {$\mathbf{3}$};
    \path[->] (v2.45.00) edge node[rotate=45.00, anchor=south] {$\$ \mid {\scriptstyle w_{0} w_{0}}$} ++(45.00:10ex);
    \node[state] (v3) at (-2.000000, 3.000000) {$\mathbf{1}$};
    \node[state] (v4) at (2.000000, 3.000000) {$\mathbf{2}$};
    \path[->] (v0.31.57) edge node[rotate=26.57, anchor=south] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{3}}$} (v2.201.57);
    \path[->] (v1) edge[loop left] node[rotate=90, anchor=south] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0}}$} ();
    \path[->] (v0.61.31) edge node[rotate=56.31, anchor=south] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{2}}$} (v4.231.31);
    \path[->] (v0.128.69) edge node[rotate=303.69, anchor=north] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{1}}$} (v3.298.69);
    \path[->] (v4.-118.69) edge node[rotate=56.31, anchor=north] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{-2}}$} (v0.51.31);
    \path[->] (v0.158.43) edge node[rotate=333.43, anchor=north] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{0}}$} (v1.328.43);
    \path[->] (v2.-148.43) edge node[rotate=26.57, anchor=north] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{-3}}$} (v0.21.57);
    \path[->] (v3.-51.31) edge node[rotate=-56.31, anchor=south] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{-1}}$} (v0.118.69);
    \path[->] (v0) edge[loop below] node {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0}}$} ();
    \path[->] (v4) edge[loop right] node[rotate=90, anchor=north] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0}}$} ();
    \path[->] (v1.-21.57) edge node[rotate=-26.57, anchor=south] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{0}}$} (v0.148.43);
    \path[->] (v3) edge[loop above] node {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0}}$} ();
    \path[->] (v2) edge[loop below] node {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0}}$} ();
    \end{tikzpicture}
**********************************************************************
File "src/sage/combinat/finite_state_machine.py", line 3352, in sage.combinat.finite_state_machine.FiniteStateMachine.?
Failed example:
    latex(T)
Expected:
    \begin{tikzpicture}[auto, initial text=, >=latex, accepting text=, accepting/.style=accepting by arrow, accepting distance=10ex]
    \node[state, initial, initial where=above] (v0) at (0.000000, 0.000000) {$\mathcal{I}$};
    \node[state] (v1) at (-6.000000, 3.000000) {$\mathbf{0}$};
    \path[->] (v1.180.00) edge node[rotate=360.00, anchor=south] {$\$ \mid \varepsilon$} ++(180.00:10ex);
    \node[state] (v2) at (6.000000, 3.000000) {$\mathbf{3}$};
    \path[->] (v2.45.00) edge node[rotate=45.00, anchor=south] {$\$ \mid w_{0} w_{0}$} ++(45.00:10ex);
    \node[state] (v3) at (-2.000000, 3.000000) {$\mathbf{1}$};
    \node[state] (v4) at (2.000000, 3.000000) {$\mathbf{2}$};
    \path[->] (v0.31.57) edge node[rotate=26.57, anchor=south] {$w_{0}\mid w_{0} w_{3}$} (v2.201.57);
    \path[->] (v1) edge[loop left] node[rotate=90, anchor=south] {$w_{0}\mid w_{0}$} ();
    \path[->] (v2) edge[loop below] node {$w_{0}\mid w_{0}$} ();
    \path[->] (v0.128.69) edge node[rotate=303.69, anchor=north] {$w_{0}\mid w_{0} w_{1}$} (v3.298.69);
    \path[->] (v4.-118.69) edge node[rotate=56.31, anchor=north] {$w_{0}\mid w_{0} w_{-2}$} (v0.51.31);
    \path[->] (v0.158.43) edge node[rotate=333.43, anchor=north] {$w_{0}\mid w_{0} w_{0}$} (v1.328.43);
    \path[->] (v2.-148.43) edge node[rotate=26.57, anchor=north] {$w_{0}\mid w_{0} w_{-3}$} (v0.21.57);
    \path[->] (v3.-51.31) edge node[rotate=-56.31, anchor=south] {$w_{0}\mid w_{0} w_{-1}$} (v0.118.69);
    \path[->] (v0) edge[loop below] node {$w_{0}\mid w_{0}$} ();
    \path[->] (v4) edge[loop right] node[rotate=90, anchor=north] {$w_{0}\mid w_{0}$} ();
    \path[->] (v1.-21.57) edge node[rotate=-26.57, anchor=south] {$w_{0}\mid w_{0} w_{0}$} (v0.148.43);
    \path[->] (v3) edge[loop above] node {$w_{0}\mid w_{0}$} ();
    \path[->] (v0.61.31) edge node[rotate=56.31, anchor=south] {$w_{0}\mid w_{0} w_{2}$} (v4.231.31);
    \end{tikzpicture}
Got:
    \begin{tikzpicture}[auto, initial text=, >=latex, accepting text=, accepting/.style=accepting by arrow, accepting distance=10ex]
    \node[state, initial, initial where=above] (v0) at (0.000000, 0.000000) {$\mathcal{I}$};
    \node[state] (v1) at (-6.000000, 3.000000) {$\mathbf{0}$};
    \path[->] (v1.180.00) edge node[rotate=360.00, anchor=south] {$\$ \mid \varepsilon$} ++(180.00:10ex);
    \node[state] (v2) at (6.000000, 3.000000) {$\mathbf{3}$};
    \path[->] (v2.45.00) edge node[rotate=45.00, anchor=south] {$\$ \mid w_{0} w_{0}$} ++(45.00:10ex);
    \node[state] (v3) at (-2.000000, 3.000000) {$\mathbf{1}$};
    \node[state] (v4) at (2.000000, 3.000000) {$\mathbf{2}$};
    \path[->] (v0.31.57) edge node[rotate=26.57, anchor=south] {$w_{0}\mid w_{0} w_{3}$} (v2.201.57);
    \path[->] (v1) edge[loop left] node[rotate=90, anchor=south] {$w_{0}\mid w_{0}$} ();
    \path[->] (v0.61.31) edge node[rotate=56.31, anchor=south] {$w_{0}\mid w_{0} w_{2}$} (v4.231.31);
    \path[->] (v0.128.69) edge node[rotate=303.69, anchor=north] {$w_{0}\mid w_{0} w_{1}$} (v3.298.69);
    \path[->] (v4.-118.69) edge node[rotate=56.31, anchor=north] {$w_{0}\mid w_{0} w_{-2}$} (v0.51.31);
    \path[->] (v0.158.43) edge node[rotate=333.43, anchor=north] {$w_{0}\mid w_{0} w_{0}$} (v1.328.43);
    \path[->] (v2.-148.43) edge node[rotate=26.57, anchor=north] {$w_{0}\mid w_{0} w_{-3}$} (v0.21.57);
    \path[->] (v3.-51.31) edge node[rotate=-56.31, anchor=south] {$w_{0}\mid w_{0} w_{-1}$} (v0.118.69);
    \path[->] (v0) edge[loop below] node {$w_{0}\mid w_{0}$} ();
    \path[->] (v4) edge[loop right] node[rotate=90, anchor=north] {$w_{0}\mid w_{0}$} ();
    \path[->] (v1.-21.57) edge node[rotate=-26.57, anchor=south] {$w_{0}\mid w_{0} w_{0}$} (v0.148.43);
    \path[->] (v3) edge[loop above] node {$w_{0}\mid w_{0}$} ();
    \path[->] (v2) edge[loop below] node {$w_{0}\mid w_{0}$} ();
    \end{tikzpicture}
**********************************************************************
1 item had failures:
   2 of 132 in sage.combinat.finite_state_machine.FiniteStateMachine.?
    [1234 tests, 2 failures, 3.75 s]
```



---

Comment by vbraun created at 2014-07-20 03:22:12

Changing status from positive_review to needs_work.


---

Comment by dkrenn created at 2014-07-20 07:22:52

Replying to [comment:3 vbraun]:
> Fails on OSX: [...]

Checked again; works on my Debian. It seem that the output is correct, but the lines are permutated.


---

Comment by git created at 2014-07-21 08:53:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2014-07-21 08:59:22

Changing status from needs_work to needs_review.


---

Comment by cheuberg created at 2014-07-21 08:59:22

I now replaced a `dict` by an `OrderedDict` in order to avoid the problem that the order of the output seems to be architecture-dependent. The performance overhead should be bearable as we sort anyway to collect transitions between the same pairs of states.


---

Comment by dkrenn created at 2014-07-21 09:35:47

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-07-22 14:15:20

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2014-07-22 14:15:20

Still fails on osx

```
sage -t --long src/sage/combinat/finite_state_machine.py
**********************************************************************
File "src/sage/combinat/finite_state_machine.py", line 3699, in sage.combinat.finite_state_machine.FiniteStateMachine.?
Failed example:
    latex(T)
Expected:
    \begin{tikzpicture}[auto, initial text=, >=latex]
    \node[state, initial, initial where=above] (v0) at (0.000000, 0.000000) {$\mathcal{I}$};
    \node[state, accepting, accepting where=left] (v1) at (-6.000000, 3.000000) {$\mathbf{0}$};
    \node[state, accepting, accepting where=45] (v2) at (6.000000, 3.000000) {$\mathbf{3}$};
    \path[->] (v2.45.00) edge node[rotate=45.00, anchor=south] {$\$ \mid {\scriptstyle w_{0} w_{0}}$} ++(45.00:10ex);
    \node[state] (v3) at (-2.000000, 3.000000) {$\mathbf{1}$};
    \node[state] (v4) at (2.000000, 3.000000) {$\mathbf{2}$};
    \path[->] (v1) edge[loop left] node[rotate=90, anchor=south] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0}}$} ();
    \path[->] (v1.-21.57) edge node[rotate=-26.57, anchor=south] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{0}}$} (v0.148.43);
    \path[->] (v3) edge[loop above] node {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0}}$} ();
    \path[->] (v3.-51.31) edge node[rotate=-56.31, anchor=south] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{-1}}$} (v0.118.69);
    \path[->] (v4) edge[loop right] node[rotate=90, anchor=north] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0}}$} ();
    \path[->] (v4.-118.69) edge node[rotate=56.31, anchor=north] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{-2}}$} (v0.51.31);
    \path[->] (v2) edge[loop below] node {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0}}$} ();
    \path[->] (v2.-148.43) edge node[rotate=26.57, anchor=north] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{-3}}$} (v0.21.57);
    \path[->] (v0.158.43) edge node[rotate=333.43, anchor=north] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{0}}$} (v1.328.43);
    \path[->] (v0.128.69) edge node[rotate=303.69, anchor=north] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{1}}$} (v3.298.69);
    \path[->] (v0.61.31) edge node[rotate=56.31, anchor=south] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{2}}$} (v4.231.31);
    \path[->] (v0.31.57) edge node[rotate=26.57, anchor=south] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{3}}$} (v2.201.57);
    \path[->] (v0) edge[loop below] node {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0}}$} ();
    \end{tikzpicture}
Got:
    \begin{tikzpicture}[auto, initial text=, >=latex]
    \node[state, initial, initial where=above] (v0) at (0.000000, 0.000000) {$\mathcal{I}$};
    \node[state, accepting, accepting where=left] (v1) at (-6.000000, 3.000000) {$\mathbf{0}$};
    \node[state, accepting, accepting where=45] (v2) at (6.000000, 3.000000) {$\mathbf{3}$};
    \path[->] (v2.45.00) edge node[rotate=45.00, anchor=south] {$\$ \mid {\scriptstyle w_{0} w_{0}}$} ++(45.00:10ex);
    \node[state] (v3) at (-2.000000, 3.000000) {$\mathbf{1}$};
    \node[state] (v4) at (2.000000, 3.000000) {$\mathbf{2}$};
    \path[->] (v0) edge[loop below] node {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0}}$} ();
    \path[->] (v0.158.43) edge node[rotate=333.43, anchor=north] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{0}}$} (v1.328.43);
    \path[->] (v0.128.69) edge node[rotate=303.69, anchor=north] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{1}}$} (v3.298.69);
    \path[->] (v0.61.31) edge node[rotate=56.31, anchor=south] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{2}}$} (v4.231.31);
    \path[->] (v0.31.57) edge node[rotate=26.57, anchor=south] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{3}}$} (v2.201.57);
    \path[->] (v1.-21.57) edge node[rotate=-26.57, anchor=south] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{0}}$} (v0.148.43);
    \path[->] (v1) edge[loop left] node[rotate=90, anchor=south] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0}}$} ();
    \path[->] (v3.-51.31) edge node[rotate=-56.31, anchor=south] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{-1}}$} (v0.118.69);
    \path[->] (v3) edge[loop above] node {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0}}$} ();
    \path[->] (v4.-118.69) edge node[rotate=56.31, anchor=north] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{-2}}$} (v0.51.31);
    \path[->] (v4) edge[loop right] node[rotate=90, anchor=north] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0}}$} ();
    \path[->] (v2.-148.43) edge node[rotate=26.57, anchor=north] {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0} w_{-3}}$} (v0.21.57);
    \path[->] (v2) edge[loop below] node {${\scriptstyle w_{0}}\mid {\scriptstyle w_{0}}$} ();
    \end{tikzpicture}
**********************************************************************
File "src/sage/combinat/finite_state_machine.py", line 3733, in sage.combinat.finite_state_machine.FiniteStateMachine.?
Failed example:
    latex(T)
Expected:
    \begin{tikzpicture}[auto, initial text=, >=latex, accepting text=, accepting/.style=accepting by arrow, accepting distance=10ex]
    \node[state, initial, initial where=above] (v0) at (0.000000, 0.000000) {$\mathcal{I}$};
    \node[state] (v1) at (-6.000000, 3.000000) {$\mathbf{0}$};
    \path[->] (v1.180.00) edge node[rotate=360.00, anchor=south] {$\$ \mid \varepsilon$} ++(180.00:10ex);
    \node[state] (v2) at (6.000000, 3.000000) {$\mathbf{3}$};
    \path[->] (v2.45.00) edge node[rotate=45.00, anchor=south] {$\$ \mid w_{0} w_{0}$} ++(45.00:10ex);
    \node[state] (v3) at (-2.000000, 3.000000) {$\mathbf{1}$};
    \node[state] (v4) at (2.000000, 3.000000) {$\mathbf{2}$};
    \path[->] (v1) edge[loop left] node[rotate=90, anchor=south] {$w_{0}\mid w_{0}$} ();
    \path[->] (v1.-21.57) edge node[rotate=-26.57, anchor=south] {$w_{0}\mid w_{0} w_{0}$} (v0.148.43);
    \path[->] (v3) edge[loop above] node {$w_{0}\mid w_{0}$} ();
    \path[->] (v3.-51.31) edge node[rotate=-56.31, anchor=south] {$w_{0}\mid w_{0} w_{-1}$} (v0.118.69);
    \path[->] (v4) edge[loop right] node[rotate=90, anchor=north] {$w_{0}\mid w_{0}$} ();
    \path[->] (v4.-118.69) edge node[rotate=56.31, anchor=north] {$w_{0}\mid w_{0} w_{-2}$} (v0.51.31);
    \path[->] (v2) edge[loop below] node {$w_{0}\mid w_{0}$} ();
    \path[->] (v2.-148.43) edge node[rotate=26.57, anchor=north] {$w_{0}\mid w_{0} w_{-3}$} (v0.21.57);
    \path[->] (v0.158.43) edge node[rotate=333.43, anchor=north] {$w_{0}\mid w_{0} w_{0}$} (v1.328.43);
    \path[->] (v0.128.69) edge node[rotate=303.69, anchor=north] {$w_{0}\mid w_{0} w_{1}$} (v3.298.69);
    \path[->] (v0.61.31) edge node[rotate=56.31, anchor=south] {$w_{0}\mid w_{0} w_{2}$} (v4.231.31);
    \path[->] (v0.31.57) edge node[rotate=26.57, anchor=south] {$w_{0}\mid w_{0} w_{3}$} (v2.201.57);
    \path[->] (v0) edge[loop below] node {$w_{0}\mid w_{0}$} ();
    \end{tikzpicture}
Got:
    \begin{tikzpicture}[auto, initial text=, >=latex, accepting text=, accepting/.style=accepting by arrow, accepting distance=10ex]
    \node[state, initial, initial where=above] (v0) at (0.000000, 0.000000) {$\mathcal{I}$};
    \node[state] (v1) at (-6.000000, 3.000000) {$\mathbf{0}$};
    \path[->] (v1.180.00) edge node[rotate=360.00, anchor=south] {$\$ \mid \varepsilon$} ++(180.00:10ex);
    \node[state] (v2) at (6.000000, 3.000000) {$\mathbf{3}$};
    \path[->] (v2.45.00) edge node[rotate=45.00, anchor=south] {$\$ \mid w_{0} w_{0}$} ++(45.00:10ex);
    \node[state] (v3) at (-2.000000, 3.000000) {$\mathbf{1}$};
    \node[state] (v4) at (2.000000, 3.000000) {$\mathbf{2}$};
    \path[->] (v0) edge[loop below] node {$w_{0}\mid w_{0}$} ();
    \path[->] (v0.158.43) edge node[rotate=333.43, anchor=north] {$w_{0}\mid w_{0} w_{0}$} (v1.328.43);
    \path[->] (v0.128.69) edge node[rotate=303.69, anchor=north] {$w_{0}\mid w_{0} w_{1}$} (v3.298.69);
    \path[->] (v0.61.31) edge node[rotate=56.31, anchor=south] {$w_{0}\mid w_{0} w_{2}$} (v4.231.31);
    \path[->] (v0.31.57) edge node[rotate=26.57, anchor=south] {$w_{0}\mid w_{0} w_{3}$} (v2.201.57);
    \path[->] (v1.-21.57) edge node[rotate=-26.57, anchor=south] {$w_{0}\mid w_{0} w_{0}$} (v0.148.43);
    \path[->] (v1) edge[loop left] node[rotate=90, anchor=south] {$w_{0}\mid w_{0}$} ();
    \path[->] (v3.-51.31) edge node[rotate=-56.31, anchor=south] {$w_{0}\mid w_{0} w_{-1}$} (v0.118.69);
    \path[->] (v3) edge[loop above] node {$w_{0}\mid w_{0}$} ();
    \path[->] (v4.-118.69) edge node[rotate=56.31, anchor=north] {$w_{0}\mid w_{0} w_{-2}$} (v0.51.31);
    \path[->] (v4) edge[loop right] node[rotate=90, anchor=north] {$w_{0}\mid w_{0}$} ();
    \path[->] (v2.-148.43) edge node[rotate=26.57, anchor=north] {$w_{0}\mid w_{0} w_{-3}$} (v0.21.57);
    \path[->] (v2) edge[loop below] node {$w_{0}\mid w_{0}$} ();
    \end{tikzpicture}
**********************************************************************
1 item had failures:
   2 of 132 in sage.combinat.finite_state_machine.FiniteStateMachine.?
    [1249 tests, 2 failures, 3.23 s]
```



---

Comment by cheuberg created at 2014-07-22 17:00:31

There seems to be a problem that 0<'I' does not always give the same answer; see
https://groups.google.com/d/topic/sage-devel/zzVpd5yZ_Rw/discussion .


---

Comment by nbruin created at 2014-07-22 19:51:05

Wouldn't a doctest template like this:

```
    \begin{tikzpicture}[auto, initial text=, >=latex, accepting text=, accepting/.style=accepting by arrow, accepting distance=10ex]
...
    \node[state] (v1) at (-6.000000, 3.000000) {$\mathbf{0}$};
    \path[->] (v1.180.00) edge node[rotate=360.00, anchor=south] {$\$ \mid \varepsilon$} ++(180.00:10ex);
...
    \end{tikzpicture}
```

be good enough? Then the whole order thing gets avoided and we're still testing that the output has some of the desired characteristics.


---

Comment by vbraun created at 2014-07-22 22:01:16

Or compare sets

```
sage: expected = """
....:    \begin{tikzpicture}[auto, initial text=, >=latex, accepting text=, 
....:    ...
....:    \end{tikzpicture}
....: """
sage: set(latex(T).splitlines()) == set(expected.splitlines())
```

Or write a convenience funtion to do the comparison and import it into the doctest.


---

Comment by git created at 2014-07-23 06:01:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-07-23 06:19:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2014-07-23 06:27:35

Thank you for your comments, here and on sage-devel.

So I understand that the result of `0 < 'I'` is intentionally random.

For the particular two sometimes failing doctests (I now could reproduce the failure by calling `sage -t` via a Makefile), the solution seems to be actually quite simple: In the sample transducer, I renamed the state `'I'` to `4`, now we are sorting integers and that should be well-defined.

This required merging of #16557 in order to avoid a merge conflict.

Trac's automerge is still unhappy, but I cannot see the reason.


---

Comment by cheuberg created at 2014-07-23 06:27:35

Changing status from needs_work to needs_review.


---

Comment by dkrenn created at 2014-07-23 07:35:27

Reviewed the changes. It's a positive_review for me.

Can someone test it on osx and if tests pass give it a positive review?


---

Comment by dkrenn created at 2014-07-30 10:54:39

It was now tested on osx as well (thanks to R.B.).


---

Comment by dkrenn created at 2014-07-30 10:54:39

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-07-31 00:44:26

Resolution: fixed
