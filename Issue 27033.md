# Issue 27033: spkg-configure.m4 for arb

Issue created by migration from https://trac.sagemath.org/ticket/27270

Original creator: dimpase

Original creation time: 2019-02-13 09:26:16

CC:  embray jdemeyer thansen fbissey

Keywords: spkg-configure




---

Comment by dimpase created at 2019-03-21 15:54:31

this does not implement `--with-arb=...`, as I hope it's not needed.
And no other packages have `--with-arb=`, too.
----
Last 10 new commits:


---

Comment by dimpase created at 2019-03-21 15:54:31

Changing status from new to needs_review.


---

Comment by dimpase created at 2019-03-21 22:25:56

Tests pass, apart from this amusing doctest failure:

```
File "src/sage/misc/package.py", line 282, in sage.misc.package.installed_packages
Failed example:
    installed_packages()
Expected:
    {...'arb': ...'pynac': ...}
Got:
    {'.dummy': '',
     'alabaster': '0.7.12',
     'appnope': '0.1.0.p0',
...
```


Less amusing is that with arb manually installed to /usr/local on Gentoo Linux, I get a import error upon Sage startup, from deep inside sagelib.

I have to start Sage as `LD_LIBRARY_PATH=/usr/local/lib64 ./sage`, otherwise
I get 

```
ImportError: libarb.so.2: cannot open shared object file: No such file or directory
```

I do have `/usr/local/lib64` in `/etc/ld.so.conf`, by the way.
Does this mean we need do jump through some linking hoops here?

I certainly can add a proper runtime test in `spkg-configure.m4`, but why?


---

Comment by dimpase created at 2019-03-22 09:02:38

Replying to [comment:4 dimpase]:

> 
> Less amusing is that with arb manually installed to /usr/local on Gentoo Linux, I get a import error upon Sage startup, from deep inside sagelib.

oops, my fault. Forgot to run ldconfig after the installation.
(maybe arb should do it for you, cf. https://github.com/fredrik-johansson/arb/issues/273).


---

Comment by git created at 2019-03-22 09:30:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-03-22 09:32:03

upstream report not directly relevant to this ticket, bit OK.


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by git created at 2019-04-01 13:28:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-04-30 22:01:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by dimpase created at 2019-04-30 22:04:06

OK, so this branch has mpfr (#27258)
mpc (#27259)
ntl (#27265)
flint (#27264) and, naturally, 
arb. Would be great to have it all reviewed in one go...


---

Comment by git created at 2019-04-30 22:12:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Attachment

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-05-21 16:37:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by dimpase created at 2019-05-21 16:38:42

rebased over #27264, added dependency check


---

Comment by git created at 2019-06-04 11:38:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Attachment

this is now bundled with flint ticket. New configure tarball attached. I also squashed some commits, and rebased over 8.8.beta7


---

Comment by git created at 2019-06-04 11:45:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-06-09 18:37:19

How come that 8.8.rc0 needs configure-323, which is here, not yet merged ??

**EDIT:**

And how can this depend on a duplicate/invalid/wontfix ticket ??


---

Comment by dimpase created at 2019-06-09 20:27:51

version numbers of these tarballs are autogenerated. they are otherwise pretty much meaningless.

it is merely a bug in our release process that is needed to be workedaround, as builbots don’t have autotools and cannot generate the stuff on the fly...


---

Comment by vbraun created at 2019-06-09 20:45:11

Needs a new confball. I'd suggest to merge this in 8.9.beta0 so hold the horses until 8.8 is out. 

You should remove the dependency on tickets that cannot be merged, the release script will wait until the dependencies are merged which, right now, is never.


---

Comment by vbraun created at 2019-06-09 20:45:24

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2019-06-10 08:53:28

the branch here bundles the work done on #27264.


---

Comment by git created at 2019-06-11 11:18:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2019-06-11 11:19:55

rebased over 8.8.rc0 (without configure bump, for the time being)


---

Comment by embray created at 2019-06-14 14:50:27

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).


---

Comment by dimpase created at 2019-06-16 11:56:26

Replying to [comment:21 vbraun]:
> Needs a new confball. I'd suggest to merge this in 8.9.beta0 so hold the horses until 8.8 is out. 

Would you like to get #27978 first?


---

Comment by git created at 2019-06-29 08:05:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2019-06-29 08:09:38

Changing status from needs_work to needs_review.


---

Comment by git created at 2019-07-03 15:23:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2019-07-03 15:26:03

now rebased over 8.9.beta1, using sha1-based configure tarball

Please test!


---

Comment by git created at 2019-07-11 06:14:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2019-07-11 06:17:45

rebased, config bump, added another name for the arb library (in Debian), mention it and flint in docs


---

Comment by dimpase created at 2019-07-11 06:55:14

with the latest branch on Debian buster, building `sage/libs/arb/arith.so` against system's arb (so it needs `-lflint-arb` and not `-larb` breaks with a linking error (as there is no `libarb`)


```
[sagelib-8.9.beta2] gcc -pthread -shared -L/home/dimpase/sage/local/lib -Wl,-rpath,/home/dimpase/sage/local/lib -L/home/dimpase/sage/local/lib -Wl,-rpath,/home/dimpase/sage/local/lib build/temp.linux-x86_64-2.7/build/cythonized/sage/libs/arb/arith.o -L/home/dimpase/sage/local/lib -L/home/dimpase/sage/local/lib -lflint -larb -lgmp -lpython2.7 -o build/lib.linux-x86_64-2.7/sage/libs/arb/arith.so
[sagelib-8.9.beta2] /usr/bin/ld: cannot find -larb
```


It apparently derives `-larb` somewhere in Cython, but where, and is there a way to override it?

Note that `-lflint-arb` is known to the global makefile:

```
build/make/Makefile-auto:LIBS = -lrw -lreadline -lmpc -lgf2x -lcurl -lbz2 -lflint-arb -lflint -lmpfr -lgmp -lm  -lntl
```



---

Comment by dimpase created at 2019-07-11 06:55:14

Changing status from needs_review to needs_info.


---

Comment by dimpase created at 2019-07-11 09:02:23

I can apply


```diff
--- a/src/module_list.py
+++ b/src/module_list.py
@@ -79,7 +79,7 @@ library_order_list = aliases["SINGULAR_LIBRARIES"] + [
     "ec", "ecm",
 ] + aliases["LINBOX_LIBRARIES"] + aliases["FFLASFFPACK_LIBRARIES"] + aliases["GSL_LIBRARIES"] + [
     "pari", "flint", "ratpoints", "ecl", "glpk", "ppl",
-    "arb", "mpfi", "mpfr", "mpc", "gmp", "gmpxx",
+    "flint-arb", "mpfi", "mpfr", "mpc", "gmp", "gmpxx",
     "brial",
     "brial_groebner",
     "m4rie",
@@ -765,7 +765,7 @@ ext_modules = [
 
     Extension("sage.matrix.matrix_complex_ball_dense",
               ["sage/matrix/matrix_complex_ball_dense.pyx"],
-              libraries=['arb']),
+              libraries=['flint-arb']),
 
     Extension('sage.matrix.matrix_complex_double_dense',
               sources = ['sage/matrix/matrix_complex_double_dense.pyx']),
```

and then it builds, but is this the correct way?


---

Comment by dimpase created at 2019-07-11 09:48:43

oops, scratch this, this change does not help, it appears there is some divining of `-larb` by Cython(?)


---

Comment by dimpase created at 2019-07-12 11:31:14

OK, so also some `#distutils` entries need to be modified. Debian applies
https://salsa.debian.org/science-team/sagemath/blob/master/debian/patches/d0-arb.patch


---

Comment by git created at 2019-07-15 18:16:55

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-07-15 20:55:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-07-15 20:57:51

Changing status from needs_info to needs_review.


---

Comment by dimpase created at 2019-07-15 20:57:51

please review - should also work on Debian now...


---

Comment by fbissey created at 2019-07-15 21:59:06

Quick impressions on the `arb` part. I would test for `flint-arb` first, otherwise you could get the other `arb` on a debian system. I would use `AC_SEARCH_LIBS` see https://autotools.io/autoconf/finding.html. When you use `AC_CHECK_LIBS` or `AC_SEARCH_LIBS`  the library found will be added  to `LIBS` and that may be used for all linkings independently of other settings - of course that's what would happen in a fully autotooled package. The question is whether all those `SAGE_${PKG}_LIBRARY` variables are needed at all.


---

Comment by fbissey created at 2019-07-15 22:07:19

I have now read the stuff about `src/sage/env.py.in` and this is a no for me. I don't run configure to build the sage python library and don't intend to if I can help it. I certainly can prepare the sources if you force me too but I'd rather not have to do that.


---

Comment by dimpase created at 2019-07-15 22:08:24

Replying to [comment:42 fbissey]:
> Quick impressions on the `arb` part. I would test for `flint-arb` first, otherwise you could get the other `arb` on a debian system. 

not really - it tests for a specific function from the "right" arb, I cannot imagine the other arb having it.

> I would use `AC_SEARCH_LIBS` see https://autotools.io/autoconf/finding.html.

I tried that, but then you have to analyse the result of its run, and this leads to arcane code (one needs to strip `-l`, etc...)
 

> When you use `AC_CHECK_LIBS` or `AC_SEARCH_LIBS`  the library found will be added  to `LIBS` and that may be used for all linkings independently of other settings - of course that's what would happen in a fully autotooled package. The question is whether all those `SAGE_${PKG}_LIBRARY` variables are needed at all.

The problem is that sagelib isn't autotooled, and so one needes to get arb/flint-arb strings into `# distutils libraries=` directives in Cython header files.


---

Comment by dimpase created at 2019-07-15 22:15:40

Replying to [comment:43 fbissey]:
> I have now read the stuff about `src/sage/env.py.in` and this is a no for me. I don't run configure to build the sage python library and don't intend to if I can help it. I certainly can prepare the sources if you force me too but I'd rather not have to do that.

well, I don't see a point of not running `./configure`. Perhaps it was fashionable in Python world 10-15 years ago :-)


---

Comment by fbissey created at 2019-07-15 22:28:25

OK you are right about the library order. Because of the check you make it doesn't matter.

It is an interesting comment about configure. Unfortunately, as far as I know running configure for a python project is still not a done thing. It doesn't mesh with the other elements of the python toolchain. There is certainly room for some configurability option in sage in regards to the optional libraries. But autotool's configure is definitely not the python way. Apart from cypari I cannot think of another python package using configure.

Let's be honest, a small configure script for sage's optional stuff and the possibly unusual stuff would be fine to run. The full configure script for the whole of the distribution is inappropriate. It all goes back, once again, to "sagelib" being treated special instead of as a normal package. So many things would have to click in place once you do that. Other superbuild systems like the one for paraview don't treat the main target in a special way like sage's does.


---

Comment by dimpase created at 2019-07-15 22:57:46

Replying to [comment:46 fbissey]:

> It is an interesting comment about configure. Unfortunately, as far as I know running configure for a python project is still not a done thing. It doesn't mesh with the other elements of the python toolchain. There is certainly room for some configurability option in sage in regards to the optional libraries. But autotool's configure is definitely not the python way. Apart from cypari I cannot think of another python package using configure.

Have you ever heard of cpython? :-)

> 
> Let's be honest, a small configure script for sage's optional stuff and the possibly unusual stuff would be fine to run. The full configure script for the whole of the distribution is inappropriate. It all goes back, once again, to "sagelib" being treated special instead of as a normal package. So many things would have to click in place once you do that. 

well, writing thousands of lines of Python to do configuration and building is what is (mal)practiced by many Python packages for reasons I don't really get. 


> Other superbuild systems like the one for paraview don't treat the main target in a special way like sage's does.

I suggest you might look at the build system of Tensorflow (it uses Bazel ;-))


---

Comment by fbissey created at 2019-07-15 23:09:24

`cpython` is the language. While it would be interesting to see if python could bootstrap itself, I am considering that you are stretching your credibility there.

`bazel` and the way it is used in tensorflow [heck the whole way tensorflow is build] is a whole private hell of its own. Let's not go there. Invoking a worst project does not make yours any better. That reminds of my daughter pretending her room isn't messy because she saw a bigger mess at one of her friend's house.


---

Comment by dimpase created at 2019-07-15 23:54:53

Replying to [comment:48 fbissey]:
> `cpython` is the language. While it would be interesting to see if python could bootstrap itself, I am considering that you are stretching your credibility there.

I don't claim any credibility, but merely observe that Python 3 is moving quite a bit of its build system from setup.py to autotools. 

I don't get it why pre-build manipulation of `Python/Cython` code must be done in Python or shell, and not with more suitable tools. Sounds like religion rather than common sense to me.


---

Comment by fbissey created at 2019-07-16 00:02:31

Replying to [comment:49 dimpase]:
> Replying to [comment:48 fbissey]:
> > `cpython` is the language. While it would be interesting to see if python could bootstrap itself, I am considering that you are stretching your credibility there.
> 
> I don't claim any credibility, but merely observe that Python 3 is moving quite a bit of its build system from setup.py to autotools. 
> 
> I don't get it why pre-build manipulation of `Python/Cython` code must be done in Python or shell, and not with more suitable tools. Sounds like religion rather than common sense to me.

I haven't seen that. But that is welcome in some way.

But the big issue we have in distro if I can pinpoint it better is not necessarily that you want to run configure. It is that you run configure for sage the distro and use it for sage the package. "sagelib" should be its own self contained package, and if it had its own configure why not. But leveraging your monster build system in the way you do, is not fine. __We don't want it.__


---

Comment by dimpase created at 2019-07-16 00:14:11

Unvendoring everything that was sheepishly vendored into Sage over the years is an essential step towards having a self contained package for sagelib alone.

This ticket is a part of the unvendoring process. One way or another, the problem here is that arb library does not have pkg-config support, and yes, we want to support !Debian/Ubuntu arb package with non-standard naming.


---

Comment by fbissey created at 2019-07-16 00:29:12

I understand perfectly. Since the controversial changes are for the sake of debian, I think a debian developer should give their opinion.

`@`thansen if you would like to oblige or pass it to someone else in debian for review.

As I said I won't review this any further but won't oppose it further either. I have my own contingency plans.


---

Comment by dimpase created at 2019-07-16 09:47:57

alternatively I can store an environment variable in `src/bin/sage-env-config`
(which, as you know, is also created by `./configure` :-))
and then access it from `src/sage/env.py` to populate `ARB_LIBRARY`.

This would avoid creating `src/sage/env.py.in`.

If this is more acceptable (after all, distributions already deal with rewriting
`src/bin/sage-env-config.in`) let me know, I can do this change.


---

Comment by arojas created at 2019-07-16 10:04:19

Replying to [comment:53 dimpase]:
> alternatively I can store an environment variable in `src/bin/sage-env-config`
> (which, as you know, is also created by `./configure` :-))
> and then access it from `src/sage/env.py` to populate `ARB_LIBRARY`.
> 
> This would avoid creating `src/sage/env.py.in`.
> 
> If this is more acceptable (after all, distributions already deal with rewriting
> `src/bin/sage-env-config.in`) let me know, I can do this change.

+1 to this alternative. Setting env variables at build time is much better than having to tamper with source files.


---

Comment by fbissey created at 2019-07-16 10:14:11

While it feels better to deal with an environment variable I wonder if it is better to elect to touch the source code here. 

People can compile cython code from sage against sage libraries. If we don't touch the code minimally and someone wants to compile some cython code from sage involving arb, they will have to define the variable unless we put it permanently in the environment in some way (which is also doable of course but I stopped doing that around sage-5.0 I think).


---

Comment by dimpase created at 2019-07-16 10:26:24

Well, you tell me what you prefer. I think that to compile cython code from sage against sage libraries requires pkg-config knowing about `SAGE_LOCAL/lib/pkgconfig` directory to pick up settings for quite a number of Sage libraries, otherwise it's doomed to fail.
In effect, this means either using Sage's pkg-config or providing a properly set `PKG_CONFIG_PATH`. That is you cannot get away from setting some environment variables.

In fact I plan to work on `spkg-configure.m4` for `pkgconf` Sage package (cf. #27827, a part of #27330) and to install `PKG_CONFIG_PATH` into `src/bin/sage-env-config` in case
a system has pkg-config installed.


---

Comment by fbissey created at 2019-07-16 10:29:43

If it currently wouldn't work for cython code, then environment is best - it doesn't break something currently working. Thank you for pulling through my painful exhortations with something palatable.


---

Comment by git created at 2019-07-16 16:29:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2019-07-16 16:59:30

OK, it's changed as discussed. Please review.


---

Comment by arojas created at 2019-07-16 17:21:01

FWIW sagelib builds fine against system packages now by just setting SAGE_ARB_LIBRARY (and not running configure)


---

Comment by @timokau created at 2019-07-16 18:52:50

For what its worth, I'm fine with setting an environment variable. There are already lots of env vars to set, one more or less won't make a difference. And I'm also glad we can get around configure. Thanks François for taking the distro standpoint here :)

Replying to [comment:51 dimpase]:
> Unvendoring everything that was sheepishly vendored into Sage over the years is an essential step towards having a self contained package for sagelib alone.

I feel like you're arguing slightly different things here. Treating the sagelib package as just another package could in principle be done without removing any vendoring. You keep the current build system, add a `sagelib` package under build, add basically everything as a dependency for it. `sagelib` can then have its own `./configure`, which configure just sagelib and not everything else. Distros would have not problem running that.


---

Comment by dimpase created at 2019-07-16 19:10:01

Replying to [comment:62 gh-timokau]:
> Replying to [comment:51 dimpase]:
> > Unvendoring everything that was sheepishly vendored into Sage over the years is an essential step towards having a self contained package for sagelib alone.
> 
> I feel like you're arguing slightly different things here. Treating the sagelib package as just another package could in principle be done without removing any vendoring. 

the main configure configures "just" sagelib. What one has in `build/pkgs/` are vendored dependencies, which ought to disappear.
These little (or not so little) `spkg-configure.m4` scripts are part of the sagelib configure, they check that the deps are satisfied.
They have nothing to do with building the relevant deps (they deal with NOT building them).

> You keep the current build system, add a `sagelib` package under build, add basically everything as a dependency for it. `sagelib` can then have its own `./configure`, which configure just sagelib and not everything else. Distros would have not problem running that.


---

Comment by fbissey created at 2019-07-16 21:10:00

I'll be waiting to see if the patchbot turns green, but in principle I am OK with this and will give it a positive review if no problems turn up.


---

Comment by dimpase created at 2019-07-17 10:17:25

not sure whether patchbots are able to deal well with packages changing configure; basically, for a proper test one needs to have appropriate versions of arb etc installed (so e.g. Debian 10 and Gentoo should be OK - and these are what I tested them on, as well as on other platforms, such as OSX with Homebrew).


---

Comment by fbissey created at 2019-07-17 10:57:19

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2019-07-17 10:57:19

I was hoping the changes in the tarball handling would have helped with that. But obviously not. It is good enough, in my opinion, to send to the bots to figure if corner cases have been missed.


---

Comment by git created at 2019-07-19 11:57:06

Changing status from positive_review to needs_review.


---

Comment by git created at 2019-07-19 11:57:06

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by dimpase created at 2019-07-19 11:59:13

fixing a "minor" m4 error in the latest change.


---

Comment by arojas created at 2019-07-19 12:20:34

Could you add a fallback for SAGE_ARB_LIBRARY in env.py? This wouldn't make any difference for users of the Sage build system (since it is set in sage-env-config) or distros that rename the arb library (which need to set it anyway), and would save distros that use the standard arb library name from having to worry about it


```
--- src/sage/env.py.orig        2019-07-19 14:05:32.947459540 +0200
+++ src/sage/env.py     2019-07-19 14:15:14.193540393 +0200
@@ -406,6 +406,8 @@
     # This is not a problem in practice since LinBox depends on
     # fflas-ffpack and fflas-ffpack does add such a C++11 flag.
     aliases["LINBOX_CFLAGS"].append("-std=gnu++11")
-    aliases["ARB_LIBRARY"] = os.environ['SAGE_ARB_LIBRARY']
-
+    if os.environ.get('SAGE_ARB_LIBRARY'):
+        aliases["ARB_LIBRARY"] = os.environ['SAGE_ARB_LIBRARY']
+    else:
+        aliases["ARB_LIBRARY"] = 'arb'
     return aliases
```



---

Comment by git created at 2019-07-19 12:31:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2019-07-19 12:34:18

Done the fallback.


---

Comment by isuruf created at 2019-07-21 04:12:35

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2019-07-21 08:42:53

Last 10 new commits:


---

Comment by dimpase created at 2019-07-21 08:44:36

merged u/isuruf/arbconfig (which erroneously contained just 1 commit), rebased over 8.9.beta3, bumpled up configure


---

Comment by vbraun created at 2019-07-26 20:27:32

Resolution: fixed


---

Comment by mkoeppe created at 2020-02-06 23:02:03

Recognizing `flint-arb` here broke the optional package `e-antic` (used by `normaliz`). Follow-up = #27952.
