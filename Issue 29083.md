# Issue 29083: downgrade various sagenb deps to optional

Issue created by migration from https://trac.sagemath.org/ticket/29320

Original creator: dimpase

Original creation time: 2020-03-12 18:22:28

CC:  slelievre fbissey

this inculdes `twisted` and `flask*` packages


---

Comment by chapoton created at 2020-03-12 21:41:30

Changing status from new to needs_review.


---

Comment by chapoton created at 2020-03-12 21:41:30

here is a branch (not tested)
----
New commits:


---

Comment by dimpase created at 2020-03-12 21:49:55

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-03-12 21:49:55

You beat me by 5 minutes :-) 
But I've tested that this works.


---

Comment by slelievre created at 2020-03-13 18:12:00

Changing keywords from "" to "sagenb, dependencies, optional".


---

Comment by jhpalmieri created at 2020-03-13 20:14:09

`@`fbissey told me that terminado uses twisted, so maybe twisted should be kept as standard. (Also, it should be listed in terminado's dependencies file, if this is accurate.) Can anyone confirm?


---

Comment by jhpalmieri created at 2020-03-13 20:14:09

Changing status from positive_review to needs_info.


---

Comment by fbissey created at 2020-03-13 20:20:08

I should have said tornado, I misread the output of my dependency query in gentoo.  That being said terminado depends on tornado.


---

Comment by dimpase created at 2020-03-13 20:31:47

the tests pass, and I manually checked dependencies to make sure that this change  leads to no standard packages missing deps. If there are undeclared deps of untested standard packages, it is a bug.


---

Comment by arojas created at 2020-03-13 20:32:06

Other candidates for downgrade: python_openid, speaklater


---

Comment by dimpase created at 2020-03-13 20:50:25

I think we can downgrade tornado and terminado etc. I don't know who is using them.


---

Comment by jhpalmieri created at 2020-03-13 21:00:43

The Jupyter notebook may use these if they are available, but I don't know any details.


---

Comment by arojas created at 2020-03-13 21:03:23

Replying to [comment:10 jhpalmieri]:
> The Jupyter notebook may use these if they are available, but I don't know any details.

They are actually mandatory https://github.com/jupyter/notebook/blob/master/setup.py#L99


---

Comment by jhpalmieri created at 2020-03-13 21:06:04

Twisted, on the other hand, looks optional: see "Prerequisites" in https://www.tornadoweb.org/. Twisted is only used in `tornado.platform.twisted`: "This module lets you run applications and libraries written for Twisted in a Tornado application."


---

Comment by jhpalmieri created at 2020-03-13 21:08:13

So it looks to me like `python_openid`, `speaklater`, and `twisted` could all be removed. Re `twisted` especially, we should not only build and run tests, but also make sure the Jupyter notebook works.


---

Comment by jhpalmieri created at 2020-03-13 23:29:51

Replying to [comment:7 dimpase]:
> the tests pass

Not for me:

```
$ ./sage -t src/sage/combinat/root_system/cartan_type.py
Running doctests with ID 2020-03-13-16-27-46-31297653.
Git branch: t/29320/29320
Using --optional=build,dochtml,sage
Doctesting 1 file.
sage -t --warn-long 69.1 src/sage/combinat/root_system/cartan_type.py
**********************************************************************
File "src/sage/combinat/root_system/cartan_type.py", line 3069, in sage.combinat.root_system.cartan_type.CartanType_simple_finite.__setstate__
Failed example:
    pg_unpickleModule = unpickle_global('twisted.persisted.styles', 'unpickleModule')
Exception raised:
    Traceback (most recent call last):
      File "sage/misc/persist.pyx", line 548, in sage.misc.persist.unpickle_global (build/cythonized/sage/misc/persist.c:5033)
        __import__(module)
    ModuleNotFoundError: No module named 'twisted'

...
```



---

Comment by jhpalmieri created at 2020-03-13 23:32:08

In brief testing, though, the Jupyter notebook looks okay.


---

Comment by jhpalmieri created at 2020-03-13 23:33:35

I propose these changes:

```diff
diff --git a/build/pkgs/python_openid/type b/build/pkgs/python_openid/type
index a6a7b9cd72..134d9bc32d 100644
--- a/build/pkgs/python_openid/type
+++ b/build/pkgs/python_openid/type
@@ -1 +1 @@
-standard
+optional
diff --git a/build/pkgs/speaklater/type b/build/pkgs/speaklater/type
index a6a7b9cd72..134d9bc32d 100644
--- a/build/pkgs/speaklater/type
+++ b/build/pkgs/speaklater/type
@@ -1 +1 @@
-standard
+optional
diff --git a/build/pkgs/twisted/type b/build/pkgs/twisted/type
index 134d9bc32d..a6a7b9cd72 100644
--- a/build/pkgs/twisted/type
+++ b/build/pkgs/twisted/type
@@ -1 +1 @@
-optional
+standard
```



---

Comment by jhpalmieri created at 2020-03-13 23:36:38

Replying to [comment:14 jhpalmieri]:
> Replying to [comment:7 dimpase]:
> > the tests pass
> 
> Not for me:
> {{{
> $ ./sage -t src/sage/combinat/root_system/cartan_type.py
> ...
> }}}

Admittedly, this is a doctest for a sort of stupid function: "Implements the unpickling of Cartan types pickled by Sage <= 4.0."


---

Comment by dimpase created at 2020-03-13 23:41:10

Replying to [comment:17 jhpalmieri]:
> Replying to [comment:14 jhpalmieri]:
> > Replying to [comment:7 dimpase]:
> > > the tests pass
> > 
> > Not for me:
> > {{{
> > $ ./sage -t src/sage/combinat/root_system/cartan_type.py
> > ...
> > }}}
> 
> Admittedly, this is a doctest for a sort of stupid function: "Implements the unpickling of Cartan types pickled by Sage <= 4.0."

Oops, I overlooked this, I thought that this must be irrelevant.

Let's just tag it `# optional - twisted`. I don't see a need to keep `twisted` standard just cause of this.


---

Comment by jhpalmieri created at 2020-03-14 01:03:00

Okay, ready for review. Please check the functionality of the Jupyter notebook; do we lose anything when we build without twisted?
----
New commits:


---

Comment by jhpalmieri created at 2020-03-14 01:03:16

Changing status from needs_info to needs_review.


---

Comment by slabbe created at 2020-03-15 08:23:13

Looking at:


```
$ cat build/pkgs/sagenb/dependencies 
$(STARTED) | pip babel flask flask_autoindex flask_babel flask_oldsessions flask_openid mathjax twisted sphinx

----------
All lines of this file are ignored except the first.
It is copied by SAGE_ROOT/build/make/install into SAGE_ROOT/build/make/Makefile.
```


Are there other dependencies to be removed from being standard? like babel ?


---

Comment by fbissey created at 2020-03-15 08:57:41

`babel` should actually be in the list removed from standard I believe. Thanks for bringing it up. `twisted` seems a bit ambiguous but `mathjax` and `sphinx` should definitely stay standard.


---

Comment by jhpalmieri created at 2020-03-15 18:06:42

`babel` is listed as a dependency of Sphinx, so it should be kept.


---

Comment by fbissey created at 2020-03-15 18:57:24

Replying to [comment:24 jhpalmieri]:
> `babel` is listed as a dependency of Sphinx, so it should be kept.

Ah! Sorry, my mistake.


---

Comment by dimpase created at 2020-03-16 16:08:53

Looks good, but we need to take care of the dependency of that pickle on twisted (on a followup ticket).


---

Comment by dimpase created at 2020-03-16 16:08:53

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2020-03-16 21:11:23

I don't understand pickling, but I am tempted to make this change:

```diff
diff --git a/src/sage/combinat/root_system/cartan_type.py b/src/sage/combinat/root_system/cartan_type.py
index 202e1abe11..3cac952462 100644
--- a/src/sage/combinat/root_system/cartan_type.py
+++ b/src/sage/combinat/root_system/cartan_type.py
@@ -3066,10 +3066,10 @@ class CartanType_simple_finite(object):
 
             sage: pg_CartanType_simple_finite = unpickle_global('sage.combinat.root_system.cartan_type', 'CartanType_simple_finite')
             sage: si1 = unpickle_newobj(pg_CartanType_simple_finite, ())
-            sage: pg_unpickleModule = unpickle_global('twisted.persisted.styles', 'unpickleModule')
+            sage: from sage.misc.fpickle import unpickleModule
             sage: pg_make_integer = unpickle_global('sage.rings.integer', 'make_integer')
             sage: si2 = pg_make_integer('4')
-            sage: unpickle_build(si1, {'tools':pg_unpickleModule('sage.combinat.root_system.type_A'), 't':['A', si2], 'letter':'A', 'n':si2})
+            sage: unpickle_build(si1, {'tools':unpickleModule('sage.combinat.root_system.type_A'), 't':['A', si2], 'letter':'A', 'n':si2})
 
             sage: si1
             ['A', 4]
```

I'm building and running tests now.


---

Comment by jhpalmieri created at 2020-03-16 22:19:02

See #29348 for the pickling issue.


---

Comment by vbraun created at 2020-03-18 22:40:42

Resolution: fixed


---

Comment by jhpalmieri created at 2020-05-28 17:20:48

Followup at #29752: werkzeug can be optional, too.
