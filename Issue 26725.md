# Issue 26725: Logarithm of rational numbers is broken

archive/issues_026725.json:
```json
{
    "body": "\n```\nsage: log(25/2, base=5/2)\n2\nsage: (25/2).log(5/2)\n2\nsage: (5/2).log(5/4)\n1/2\n```\n\n\nThese are obviously not the correct results.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26962\n\n",
    "created_at": "2018-12-26T20:43:42Z",
    "labels": [
        "component: basic arithmetic",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "Logarithm of rational numbers is broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26725",
    "user": "https://github.com/ManfP"
}
```

```
sage: log(25/2, base=5/2)
2
sage: (25/2).log(5/2)
2
sage: (5/2).log(5/4)
1/2
```


These are obviously not the correct results.

Issue created by migration from https://trac.sagemath.org/ticket/26962





---

archive/issue_comments_375452.json:
```json
{
    "body": "Are you using sage with python3 ? Beware that this is still in an experimental state..\n\nIf so, then this is a duplicate of #25979",
    "created_at": "2018-12-28T19:34:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26725#issuecomment-375452",
    "user": "https://github.com/fchapoton"
}
```

Are you using sage with python3 ? Beware that this is still in an experimental state..

If so, then this is a duplicate of #25979



---

archive/issue_comments_375453.json:
```json
{
    "body": "No, this happens in normal 8.5. The logic in sage.rings.rational.Rational.log is flawed.",
    "created_at": "2018-12-28T20:23:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26725#issuecomment-375453",
    "user": "https://github.com/nbruin"
}
```

No, this happens in normal 8.5. The logic in sage.rings.rational.Rational.log is flawed.



---

archive/issue_comments_375454.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-12-28T21:16:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26725#issuecomment-375454",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_375455.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-12-28T21:17:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26725#issuecomment-375455",
    "user": "https://github.com/nbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_375456.json:
```json
{
    "body": "Could you add spaces around your equalities?\n\n```diff\n- a_exp=adp[1]\n+ a_exp = adp[1]\n```\n",
    "created_at": "2018-12-31T13:32:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26725#issuecomment-375456",
    "user": "https://github.com/videlec"
}
```

Could you add spaces around your equalities?

```diff
- a_exp=adp[1]
+ a_exp = adp[1]
```




---

archive/issue_comments_375457.json:
```json
{
    "body": "Why not\n\n```diff\n- if a_base*b_base == 1:\n+ if (a_base * b_base).is_one():\n```\n",
    "created_at": "2018-12-31T13:39:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26725#issuecomment-375457",
    "user": "https://github.com/videlec"
}
```

Why not

```diff
- if a_base*b_base == 1:
+ if (a_base * b_base).is_one():
```




---

archive/issue_comments_375458.json:
```json
{
    "body": "It would be nice to fix and check these type inconsistencies\n\n```\nsage: a = 2\nsage: parent((a**2).log(a))\nInteger Ring\nsage: parent((a**3).log(a**2))\nSymbolic Ring\n```\n\nversus\n\n```\nsage: a = 2/5\nsage: parent((a**2).log(a))\nRational Field\nsage: parent((a**3).log(a**2))\nRational Field\n```\n",
    "created_at": "2018-12-31T13:46:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26725#issuecomment-375458",
    "user": "https://github.com/videlec"
}
```

It would be nice to fix and check these type inconsistencies

```
sage: a = 2
sage: parent((a**2).log(a))
Integer Ring
sage: parent((a**3).log(a**2))
Symbolic Ring
```

versus

```
sage: a = 2/5
sage: parent((a**2).log(a))
Rational Field
sage: parent((a**3).log(a**2))
Rational Field
```




---

archive/issue_comments_375459.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-12-31T13:52:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26725#issuecomment-375459",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_375460.json:
```json
{
    "body": "The case of denominator = 1 is treated twice, lines 3163-3164\n\n```\n        if self.denom() == ZZ.one():\n            return ZZ(self.numer()).log(m, prec)\n```\n\nand 3194-3196\n\n```\n       elif aden.is_one():\n            a_exp=anp[1]\n            a_base=anp[0]\n```\n\nAs a consequence of the type inconsistencies of [This is the Trac macro *comment:8* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:8-macro) we have\n\n```\nsage: parent(QQ(2).log(4))\nSymbolic Ring\n```\n",
    "created_at": "2018-12-31T13:52:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26725#issuecomment-375460",
    "user": "https://github.com/videlec"
}
```

The case of denominator = 1 is treated twice, lines 3163-3164

```
        if self.denom() == ZZ.one():
            return ZZ(self.numer()).log(m, prec)
```

and 3194-3196

```
       elif aden.is_one():
            a_exp=anp[1]
            a_base=anp[0]
```

As a consequence of the type inconsistencies of [This is the Trac macro *comment:8* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:8-macro) we have

```
sage: parent(QQ(2).log(4))
Symbolic Ring
```




---

archive/issue_comments_375461.json:
```json
{
    "body": "The base is not forwarded with negative argument (needs also a doctest)\n\n```\nsage: (-2/3).log(2).n()\n-0.405465108108164 + 3.14159265358979*I\nsage: (log(-2/3) / log(2)).n()\n-0.584962500721156 + 4.53236014182719*I\n```\n",
    "created_at": "2018-12-31T13:54:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26725#issuecomment-375461",
    "user": "https://github.com/videlec"
}
```

The base is not forwarded with negative argument (needs also a doctest)

```
sage: (-2/3).log(2).n()
-0.405465108108164 + 3.14159265358979*I
sage: (log(-2/3) / log(2)).n()
-0.584962500721156 + 4.53236014182719*I
```




---

archive/issue_comments_375462.json:
```json
{
    "body": "Lastly, the integer log is (to some extent) smarter\n\n```\nsage: (5^3).log()\n3*log(5)\nsage: ((2/5)^3).log()\nlog(8/125)\n```\n\nSince we check for perfect power anyway, it is worth changing it.",
    "created_at": "2018-12-31T14:09:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26725#issuecomment-375462",
    "user": "https://github.com/videlec"
}
```

Lastly, the integer log is (to some extent) smarter

```
sage: (5^3).log()
3*log(5)
sage: ((2/5)^3).log()
log(8/125)
```

Since we check for perfect power anyway, it is worth changing it.



---

archive/issue_comments_375463.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-12-31T14:46:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26725#issuecomment-375463",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_375464.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-12-31T14:47:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26725#issuecomment-375464",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_375465.json:
```json
{
    "body": "Oops, looks like we overlapped in work. Please merge as you see fit.\n\nSome remarks:\n- log(8) simplifying is actually an SR feature. So I don't think we should replicate this behaviour here (or on QQ) again. Also: it's broken. `log(2**100)` doesn't get recognized.\n- I have no opinion on the type inconsistencies. In terms of type signature, this routine is a mess anyway.\n- the routines previously didn't handle negative arguments with given prec appropriately. Hopefully the code changes I introduced (via ComplexField) take care of that.\n\nI'll leave the ticket to you now.\n----\nNew commits:",
    "created_at": "2018-12-31T15:53:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26725#issuecomment-375465",
    "user": "https://github.com/nbruin"
}
```

Oops, looks like we overlapped in work. Please merge as you see fit.

Some remarks:
- log(8) simplifying is actually an SR feature. So I don't think we should replicate this behaviour here (or on QQ) again. Also: it's broken. `log(2**100)` doesn't get recognized.
- I have no opinion on the type inconsistencies. In terms of type signature, this routine is a mess anyway.
- the routines previously didn't handle negative arguments with given prec appropriately. Hopefully the code changes I introduced (via ComplexField) take care of that.

I'll leave the ticket to you now.
----
New commits:



---

archive/issue_comments_375466.json:
```json
{
    "body": "Replying to [comment:15 nbruin]:\n> Some remarks:\n>  - log(8) simplifying is actually an SR feature. So I don't think we should replicate this behaviour here (or on QQ) again. Also: it's broken. `log(2**100)` doesn't get recognized.\n\nI realized that it is an SR feature. However, in QQ, since the code computes a power factorization the simplifcation is already done\n\n```\nreturn (a_exp * log(a_base)) / (b_exp * log(b_base))\n```\n\nIt would be strange to not provide it. In ZZ, the story is different since the code does not go through `perfect_power`. But then, it would be strange to have different behavior in ZZ and QQ.",
    "created_at": "2019-01-01T10:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26725#issuecomment-375466",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:15 nbruin]:
> Some remarks:
>  - log(8) simplifying is actually an SR feature. So I don't think we should replicate this behaviour here (or on QQ) again. Also: it's broken. `log(2**100)` doesn't get recognized.

I realized that it is an SR feature. However, in QQ, since the code computes a power factorization the simplifcation is already done

```
return (a_exp * log(a_base)) / (b_exp * log(b_base))
```

It would be strange to not provide it. In ZZ, the story is different since the code does not go through `perfect_power`. But then, it would be strange to have different behavior in ZZ and QQ.



---

archive/issue_comments_375467.json:
```json
{
    "body": "Replying to [comment:16 vdelecroix]:\n> It would be strange to not provide it. In ZZ, the story is different since the code does not go through `perfect_power`. But then, it would be strange to have different behavior in ZZ and QQ.\n\nGo ahead. I don't have a particular preference for the return format. It shouldn't return wrong results, but otherwise I don't think it matters much. Since this plays out in SR, a better place to improve simplification of logarithms is in a simplification routine there (since logarithms of rational numbers can meet there, and they would preferably interact consistently).\n\nA \"normal form\" would be to write these logarithms as Q-linear combination of logarithms of prime numbers. That involves factoring, so we shouldn't do that by default. The next step would be to write them as Q-linear combinations of coprime integers. You can do that via GCDs etc, so that's fairly efficient. The right place to do that would be in SR, however, where it would take as input a Q-linear combination of logs of integers and then returns a normal form of that (with logs of pairwise coprime integers). That would be a much more general tool than the specific case encountered here.",
    "created_at": "2019-01-01T18:51:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26725#issuecomment-375467",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:16 vdelecroix]:
> It would be strange to not provide it. In ZZ, the story is different since the code does not go through `perfect_power`. But then, it would be strange to have different behavior in ZZ and QQ.

Go ahead. I don't have a particular preference for the return format. It shouldn't return wrong results, but otherwise I don't think it matters much. Since this plays out in SR, a better place to improve simplification of logarithms is in a simplification routine there (since logarithms of rational numbers can meet there, and they would preferably interact consistently).

A "normal form" would be to write these logarithms as Q-linear combination of logarithms of prime numbers. That involves factoring, so we shouldn't do that by default. The next step would be to write them as Q-linear combinations of coprime integers. You can do that via GCDs etc, so that's fairly efficient. The right place to do that would be in SR, however, where it would take as input a Q-linear combination of logs of integers and then returns a normal form of that (with logs of pairwise coprime integers). That would be a much more general tool than the specific case encountered here.



---

archive/issue_comments_375468.json:
```json
{
    "body": "It is better enough than what it used to be...",
    "created_at": "2019-01-03T10:18:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26725#issuecomment-375468",
    "user": "https://github.com/videlec"
}
```

It is better enough than what it used to be...



---

archive/issue_comments_375469.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-03T10:18:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26725#issuecomment-375469",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_375470.json:
```json
{
    "body": "Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.",
    "created_at": "2019-01-15T18:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26725#issuecomment-375470",
    "user": "https://github.com/embray"
}
```

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.



---

archive/issue_events_024817.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-01-23T15:39:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26725",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26725#event-24817"
}
```



---

archive/issue_comments_375471.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-01-23T15:39:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26725#issuecomment-375471",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
