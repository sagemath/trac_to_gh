# Issue 26725: Logarithm of rational numbers is broken

Issue created by migration from https://trac.sagemath.org/ticket/26962

Original creator: @ManfP

Original creation time: 2018-12-26 20:43:42


```
sage: log(25/2, base=5/2)
2
sage: (25/2).log(5/2)
2
sage: (5/2).log(5/4)
1/2
```


These are obviously not the correct results.


---

Comment by chapoton created at 2018-12-28 19:34:34

Are you using sage with python3 ? Beware that this is still in an experimental state..

If so, then this is a duplicate of #25979


---

Comment by nbruin created at 2018-12-28 20:23:40

No, this happens in normal 8.5. The logic in sage.rings.rational.Rational.log is flawed.


---

Comment by git created at 2018-12-28 21:16:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nbruin created at 2018-12-28 21:17:43

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2018-12-31 13:32:53

Could you add spaces around your equalities?

```diff
- a_exp=adp[1]
+ a_exp = adp[1]
```



---

Comment by vdelecroix created at 2018-12-31 13:39:04

Why not

```diff
- if a_base*b_base == 1:
+ if (a_base * b_base).is_one():
```



---

Comment by vdelecroix created at 2018-12-31 13:46:46

It would be nice to fix and check these type inconsistencies

```
sage: a = 2
sage: parent((a**2).log(a))
Integer Ring
sage: parent((a**3).log(a**2))
Symbolic Ring
```

versus

```
sage: a = 2/5
sage: parent((a**2).log(a))
Rational Field
sage: parent((a**3).log(a**2))
Rational Field
```



---

Comment by vdelecroix created at 2018-12-31 13:52:46

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2018-12-31 13:52:46

The case of denominator = 1 is treated twice, lines 3163-3164

```
        if self.denom() == ZZ.one():
            return ZZ(self.numer()).log(m, prec)
```

and 3194-3196

```
       elif aden.is_one():
            a_exp=anp[1]
            a_base=anp[0]
```

As a consequence of the type inconsistencies of [This is the Trac macro *comment:8* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#comment:8-macro) we have

```
sage: parent(QQ(2).log(4))
Symbolic Ring
```



---

Comment by vdelecroix created at 2018-12-31 13:54:43

The base is not forwarded with negative argument (needs also a doctest)

```
sage: (-2/3).log(2).n()
-0.405465108108164 + 3.14159265358979*I
sage: (log(-2/3) / log(2)).n()
-0.584962500721156 + 4.53236014182719*I
```



---

Comment by vdelecroix created at 2018-12-31 14:09:29

Lastly, the integer log is (to some extent) smarter

```
sage: (5^3).log()
3*log(5)
sage: ((2/5)^3).log()
log(8/125)
```

Since we check for perfect power anyway, it is worth changing it.


---

Comment by vdelecroix created at 2018-12-31 14:46:55

Changing status from needs_work to needs_review.


---

Comment by git created at 2018-12-31 14:47:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nbruin created at 2018-12-31 15:53:40

Oops, looks like we overlapped in work. Please merge as you see fit.

Some remarks:
 - log(8) simplifying is actually an SR feature. So I don't think we should replicate this behaviour here (or on QQ) again. Also: it's broken. `log(2**100)` doesn't get recognized.
 - I have no opinion on the type inconsistencies. In terms of type signature, this routine is a mess anyway.
 - the routines previously didn't handle negative arguments with given prec appropriately. Hopefully the code changes I introduced (via ComplexField) take care of that.

I'll leave the ticket to you now.
----
New commits:


---

Comment by vdelecroix created at 2019-01-01 10:04:31

Replying to [comment:15 nbruin]:
> Some remarks:
>  - log(8) simplifying is actually an SR feature. So I don't think we should replicate this behaviour here (or on QQ) again. Also: it's broken. `log(2**100)` doesn't get recognized.

I realized that it is an SR feature. However, in QQ, since the code computes a power factorization the simplifcation is already done

```
return (a_exp * log(a_base)) / (b_exp * log(b_base))
```

It would be strange to not provide it. In ZZ, the story is different since the code does not go through `perfect_power`. But then, it would be strange to have different behavior in ZZ and QQ.


---

Comment by nbruin created at 2019-01-01 18:51:54

Replying to [comment:16 vdelecroix]:
> It would be strange to not provide it. In ZZ, the story is different since the code does not go through `perfect_power`. But then, it would be strange to have different behavior in ZZ and QQ.

Go ahead. I don't have a particular preference for the return format. It shouldn't return wrong results, but otherwise I don't think it matters much. Since this plays out in SR, a better place to improve simplification of logarithms is in a simplification routine there (since logarithms of rational numbers can meet there, and they would preferably interact consistently).

A "normal form" would be to write these logarithms as Q-linear combination of logarithms of prime numbers. That involves factoring, so we shouldn't do that by default. The next step would be to write them as Q-linear combinations of coprime integers. You can do that via GCDs etc, so that's fairly efficient. The right place to do that would be in SR, however, where it would take as input a Q-linear combination of logs of integers and then returns a normal form of that (with logs of pairwise coprime integers). That would be a much more general tool than the specific case encountered here.


---

Comment by vdelecroix created at 2019-01-03 10:18:24

It is better enough than what it used to be...


---

Comment by vdelecroix created at 2019-01-03 10:18:24

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-01-15 18:16:10

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.


---

Comment by vbraun created at 2019-01-23 15:39:28

Resolution: fixed
