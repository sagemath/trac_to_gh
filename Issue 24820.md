# Issue 24820: Building ecl-16.1.2 with SAGE_DEBUG=yes fails on Cygwin

archive/issues_024820.json:
```json
{
    "body": "IIRC I've had this problem for a while but never made a report of it.\n\n\n```\n[ecl-16.1.2.p5] gcc -DECLDIR=\"\\\"/home/embray/src/sagemath/sage/local/lib/ecl-16.1.2\\\"\" -I. -I/home/embray/src/sagemath/sage/local/var/tmp/sage/build/ecl-16.1.2.p5/src/build -I/home/embray/src/sagemath/sage/local/var/tmp/sage/build/ecl-16.1.2.p5/src/src/c -I../ecl/gc -DECL_API -DECL_NO_LEGACY   -I/home/embray/src/sagemath/sage/local/include  -g -O0   -Dcygwin -c -o ffi/backtrace.o ffi/backtrace.o.c\n[ecl-16.1.2.p5] /home/embray/src/sagemath/sage/local/var/tmp/sage/build/ecl-16.1.2.p5/src/src/c/ffi/backtrace.d: In function 'backtrace_symbols':\n[ecl-16.1.2.p5] /home/embray/src/sagemath/sage/local/var/tmp/sage/build/ecl-16.1.2.p5/src/src/c/ffi/backtrace.d:84:9: error: unknown type name 'Dl_info'\n[ecl-16.1.2.p5]          Dl_info data[1];\n[ecl-16.1.2.p5]          ^~~~~~~\n[ecl-16.1.2.p5] /home/embray/src/sagemath/sage/local/var/tmp/sage/build/ecl-16.1.2.p5/src/src/c/ffi/backtrace.d:88:21: warning: implicit declaration of function 'dladdr' [-Wimplicit-function-declaration]\n[ecl-16.1.2.p5]                  if (dladdr(buffer[i], data)) {\n[ecl-16.1.2.p5]                      ^~~~~~\n[ecl-16.1.2.p5] /home/embray/src/sagemath/sage/local/var/tmp/sage/build/ecl-16.1.2.p5/src/src/c/ffi/backtrace.d:89:42: error: request for member 'dli_sname' in something not a structure or union\n[ecl-16.1.2.p5]                          strings[i] = data->dli_sname;\n[ecl-16.1.2.p5]                                           ^~\n[ecl-16.1.2.p5] make[5]: *** [Makefile:86: ffi/backtrace.o] Error 1\n```\n\n\nIt works if I run `SAGE_DEBUG=no make ecl`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25057\n\n",
    "created_at": "2018-03-29T08:43:39Z",
    "labels": [
        "porting: Cygwin",
        "major",
        "bug"
    ],
    "title": "Building ecl-16.1.2 with SAGE_DEBUG=yes fails on Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24820",
    "user": "embray"
}
```
IIRC I've had this problem for a while but never made a report of it.


```
[ecl-16.1.2.p5] gcc -DECLDIR="\"/home/embray/src/sagemath/sage/local/lib/ecl-16.1.2\"" -I. -I/home/embray/src/sagemath/sage/local/var/tmp/sage/build/ecl-16.1.2.p5/src/build -I/home/embray/src/sagemath/sage/local/var/tmp/sage/build/ecl-16.1.2.p5/src/src/c -I../ecl/gc -DECL_API -DECL_NO_LEGACY   -I/home/embray/src/sagemath/sage/local/include  -g -O0   -Dcygwin -c -o ffi/backtrace.o ffi/backtrace.o.c
[ecl-16.1.2.p5] /home/embray/src/sagemath/sage/local/var/tmp/sage/build/ecl-16.1.2.p5/src/src/c/ffi/backtrace.d: In function 'backtrace_symbols':
[ecl-16.1.2.p5] /home/embray/src/sagemath/sage/local/var/tmp/sage/build/ecl-16.1.2.p5/src/src/c/ffi/backtrace.d:84:9: error: unknown type name 'Dl_info'
[ecl-16.1.2.p5]          Dl_info data[1];
[ecl-16.1.2.p5]          ^~~~~~~
[ecl-16.1.2.p5] /home/embray/src/sagemath/sage/local/var/tmp/sage/build/ecl-16.1.2.p5/src/src/c/ffi/backtrace.d:88:21: warning: implicit declaration of function 'dladdr' [-Wimplicit-function-declaration]
[ecl-16.1.2.p5]                  if (dladdr(buffer[i], data)) {
[ecl-16.1.2.p5]                      ^~~~~~
[ecl-16.1.2.p5] /home/embray/src/sagemath/sage/local/var/tmp/sage/build/ecl-16.1.2.p5/src/src/c/ffi/backtrace.d:89:42: error: request for member 'dli_sname' in something not a structure or union
[ecl-16.1.2.p5]                          strings[i] = data->dli_sname;
[ecl-16.1.2.p5]                                           ^~
[ecl-16.1.2.p5] make[5]: *** [Makefile:86: ffi/backtrace.o] Error 1
```


It works if I run `SAGE_DEBUG=no make ecl`.

Issue created by migration from https://trac.sagemath.org/ticket/25057





---

archive/issue_comments_348631.json:
```json
{
    "body": "Set assignee to embray.",
    "created_at": "2018-03-29T08:43:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24820#issuecomment-348631",
    "user": "embray"
}
```

Set assignee to embray.



---

archive/issue_comments_348632.json:
```json
{
    "body": "I feel like I've run into a problem with `Dl_info` on Cygwin before, but I can't recall where...",
    "created_at": "2018-03-29T15:57:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24820#issuecomment-348632",
    "user": "embray"
}
```

I feel like I've run into a problem with `Dl_info` on Cygwin before, but I can't recall where...



---

archive/issue_comments_348633.json:
```json
{
    "body": "I see, `Dl_info` is not defined unless the `_GNU_SOURCE` macro is defined--this the default on Linux, but on Cygwin it is not defined by default.  This should be fixed upstream, but we can also easily add it in.",
    "created_at": "2018-03-29T16:27:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24820#issuecomment-348633",
    "user": "embray"
}
```

I see, `Dl_info` is not defined unless the `_GNU_SOURCE` macro is defined--this the default on Linux, but on Cygwin it is not defined by default.  This should be fixed upstream, but we can also easily add it in.



---

archive/issue_comments_348634.json:
```json
{
    "body": "Just got this on the buildbot machine I'm trying to set up, mysteriously, even without SAGE_DEBUG defined.  In fact, I'm not sure why this was affected by SAGE_DEBUG in the first place...",
    "created_at": "2018-09-24T15:20:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24820#issuecomment-348634",
    "user": "embray"
}
```

Just got this on the buildbot machine I'm trying to set up, mysteriously, even without SAGE_DEBUG defined.  In fact, I'm not sure why this was affected by SAGE_DEBUG in the first place...



---

archive/issue_comments_348635.json:
```json
{
    "body": "My only guess for why I don't get this on my local machine is that it must have something to do with ccache.  I haven't even seen this on the patchbot in a while, which also has a well-primed ccache.  I just have to wonder what's being missed from the ccache hash.  It's also possible this only stopped working on more recent cygwin versions but it's not obvious to me when that would have occurred...",
    "created_at": "2018-09-24T15:55:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24820#issuecomment-348635",
    "user": "embray"
}
```

My only guess for why I don't get this on my local machine is that it must have something to do with ccache.  I haven't even seen this on the patchbot in a while, which also has a well-primed ccache.  I just have to wonder what's being missed from the ccache hash.  It's also possible this only stopped working on more recent cygwin versions but it's not obvious to me when that would have occurred...



---

archive/issue_comments_348636.json:
```json
{
    "body": "Well, I tried re-building ecl with `CCACHE_DISABLE=1` and it still built, so it probably has something to do with the newlib version or gcc or something.  Very strange...",
    "created_at": "2018-09-25T09:12:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24820#issuecomment-348636",
    "user": "embray"
}
```

Well, I tried re-building ecl with `CCACHE_DISABLE=1` and it still built, so it probably has something to do with the newlib version or gcc or something.  Very strange...



---

archive/issue_comments_348637.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2018-09-25T09:17:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24820#issuecomment-348637",
    "user": "embray"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_348638.json:
```json
{
    "body": "Setting this as a blocker since it's preventing building in general, at least, I'm guessing on newer Cygwins.  Fortunately it has an easy workaround.",
    "created_at": "2018-09-25T09:17:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24820#issuecomment-348638",
    "user": "embray"
}
```

Setting this as a blocker since it's preventing building in general, at least, I'm guessing on newer Cygwins.  Fortunately it has an easy workaround.



---

archive/issue_comments_348639.json:
```json
{
    "body": "Fairly trivial fix.  In this case I deliberately did not bump the package version for a few reasons:\n\n1) The main purpose of doing so would be for testing on buildbots, however there is still not yet an automated Cygwin buildbot (ironically, this issue was hit in the process of trying to test and configure one).\n\n2) It only affects Sage on Cygwin--there is no need to waste buildbot time on other platforms that won't be affected by this change.\n\n3) Even on existing builds on Cygwin it is not necessary to re-build ECL due to this change; this will only fix an issue on systems where ECL could not be built in the first place.\n\nI'm happy to bump it anyways if anyone suggests otherwise, but I believe these are good arguments not to in this case.\n----\nNew commits:",
    "created_at": "2018-09-25T09:28:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24820#issuecomment-348639",
    "user": "embray"
}
```

Fairly trivial fix.  In this case I deliberately did not bump the package version for a few reasons:

1) The main purpose of doing so would be for testing on buildbots, however there is still not yet an automated Cygwin buildbot (ironically, this issue was hit in the process of trying to test and configure one).

2) It only affects Sage on Cygwin--there is no need to waste buildbot time on other platforms that won't be affected by this change.

3) Even on existing builds on Cygwin it is not necessary to re-build ECL due to this change; this will only fix an issue on systems where ECL could not be built in the first place.

I'm happy to bump it anyways if anyone suggests otherwise, but I believe these are good arguments not to in this case.
----
New commits:



---

archive/issue_comments_348640.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-09-25T09:28:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24820#issuecomment-348640",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_348641.json:
```json
{
    "body": "Would it help to have a Windows (10? something else) Google CE host running  Cygwin patch/buildbots?\n(I have a grant from Google that lets me do this for the coming 5 months or so).",
    "created_at": "2018-09-25T11:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24820#issuecomment-348641",
    "user": "dimpase"
}
```

Would it help to have a Windows (10? something else) Google CE host running  Cygwin patch/buildbots?
(I have a grant from Google that lets me do this for the coming 5 months or so).



---

archive/issue_comments_348642.json:
```json
{
    "body": "Replying to [comment:11 dimpase]:\n> Would it help to have a Windows (10? something else) Google CE host running  Cygwin patch/buildbots?\n> (I have a grant from Google that lets me do this for the coming 5 months or so).\n\nIt may or may not.  I've had a number of private conversations about possibilities for hosting such things.  The problem has consistently been that Cygwin under a virtualized host can be rather slow.  This slowness can be mitigated significantly with appropriate control over the VM host, but with cloud services we frequently don't even have that.  I tried setting up a VM on Azure, for example, and it was still rather slow.\n\nAnyways, we now (or will soon) have a buildbot running on a VM once all these blocker issues are fixed.  In the meantime the best thing is having a dedicated host.  We have had discussions about purchasing a machine with OpenDreamKit funds, but I don't know where that's at right now.",
    "created_at": "2018-09-25T12:58:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24820#issuecomment-348642",
    "user": "embray"
}
```

Replying to [comment:11 dimpase]:
> Would it help to have a Windows (10? something else) Google CE host running  Cygwin patch/buildbots?
> (I have a grant from Google that lets me do this for the coming 5 months or so).

It may or may not.  I've had a number of private conversations about possibilities for hosting such things.  The problem has consistently been that Cygwin under a virtualized host can be rather slow.  This slowness can be mitigated significantly with appropriate control over the VM host, but with cloud services we frequently don't even have that.  I tried setting up a VM on Azure, for example, and it was still rather slow.

Anyways, we now (or will soon) have a buildbot running on a VM once all these blocker issues are fixed.  In the meantime the best thing is having a dedicated host.  We have had discussions about purchasing a machine with OpenDreamKit funds, but I don't know where that's at right now.



---

archive/issue_comments_348643.json:
```json
{
    "body": "I was not hit with this, but Sage builds on my cygwin just fine with this and it doesn't affect other systems. So I am setting this to a positive review.",
    "created_at": "2018-09-26T03:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24820#issuecomment-348643",
    "user": "tscrim"
}
```

I was not hit with this, but Sage builds on my cygwin just fine with this and it doesn't affect other systems. So I am setting this to a positive review.



---

archive/issue_comments_348644.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-09-26T03:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24820#issuecomment-348644",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_348645.json:
```json
{
    "body": "Thanks for checking.  Indeed I'm still a little mystified as to why this was affecting this new machine I set up but not others.  But the basic underlying issue is clear.",
    "created_at": "2018-09-26T09:17:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24820#issuecomment-348645",
    "user": "embray"
}
```

Thanks for checking.  Indeed I'm still a little mystified as to why this was affecting this new machine I set up but not others.  But the basic underlying issue is clear.



---

archive/issue_comments_348646.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-09-27T17:41:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24820",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24820#issuecomment-348646",
    "user": "vbraun"
}
```

Resolution: fixed
