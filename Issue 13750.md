# Issue 13750: New Gap spkg (>=4.5) does not build with shared only GMP/MPIR

archive/issues_013750.json:
```json
{
    "body": "Assignee: tbd\n\nCC:  kcrisman dimpase\n\nKeywords: spkg gap cygwin\n\nAnd we only build a shared one on Cygwin because we cannot build both static and shared (although this limitation is not clearly still needed).\n\nIssue created by migration from https://trac.sagemath.org/ticket/13954\n\n",
    "created_at": "2013-01-14T19:43:40Z",
    "labels": [
        "packages: standard",
        "major",
        "bug"
    ],
    "title": "New Gap spkg (>=4.5) does not build with shared only GMP/MPIR",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13750",
    "user": "jpflori"
}
```
Assignee: tbd

CC:  kcrisman dimpase

Keywords: spkg gap cygwin

And we only build a shared one on Cygwin because we cannot build both static and shared (although this limitation is not clearly still needed).

Issue created by migration from https://trac.sagemath.org/ticket/13954





---

archive/issue_comments_170658.json:
```json
{
    "body": "The configure script tests for libgmp.a if --with-gmp=... is passed.",
    "created_at": "2013-01-14T19:44:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170658",
    "user": "jpflori"
}
```

The configure script tests for libgmp.a if --with-gmp=... is passed.



---

archive/issue_comments_170659.json:
```json
{
    "body": "Would this explain my current problem that GAP doesn't build on XP?  Configure fails with\n\n```\nconfigure: error: Could not locate GMP in the specified location\n```\n",
    "created_at": "2013-01-14T19:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170659",
    "user": "kcrisman"
}
```

Would this explain my current problem that GAP doesn't build on XP?  Configure fails with

```
configure: error: Could not locate GMP in the specified location
```




---

archive/issue_comments_170660.json:
```json
{
    "body": "Yes that's it.",
    "created_at": "2013-01-14T20:02:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170660",
    "user": "jpflori"
}
```

Yes that's it.



---

archive/issue_comments_170661.json:
```json
{
    "body": "Ok, I got GAP to build but the script gap_cygwin is completely broken as well.",
    "created_at": "2013-01-15T13:04:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170661",
    "user": "jpflori"
}
```

Ok, I got GAP to build but the script gap_cygwin is completely broken as well.



---

archive/issue_comments_170662.json:
```json
{
    "body": "Ok we basically have to remove all Cygwin specific things from spkg-install.",
    "created_at": "2013-01-15T13:11:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170662",
    "user": "jpflori"
}
```

Ok we basically have to remove all Cygwin specific things from spkg-install.



---

archive/issue_comments_170663.json:
```json
{
    "body": "Great, provide something and I can still try it today!\n\nNice that the folks at #13211 managed to do this\n\n```\nif [ \"x$GAP_DIR\" = \"x\" ];  then\n    GAP_DIR=\"$SAGE_ROOT/local/lib/gap-4.5.5\" \nfi\n```\n\nbut then somehow not update it to 4.5.7!?",
    "created_at": "2013-01-15T14:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170663",
    "user": "kcrisman"
}
```

Great, provide something and I can still try it today!

Nice that the folks at #13211 managed to do this

```
if [ "x$GAP_DIR" = "x" ];  then
    GAP_DIR="$SAGE_ROOT/local/lib/gap-4.5.5" 
fi
```

but then somehow not update it to 4.5.7!?



---

archive/issue_comments_170664.json:
```json
{
    "body": "By the way, WHY do we need to start GAP to start Sage?  I know that sage-location or some similar script does this upon the first start... but it does seem a bit much.",
    "created_at": "2013-01-15T14:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170664",
    "user": "kcrisman"
}
```

By the way, WHY do we need to start GAP to start Sage?  I know that sage-location or some similar script does this upon the first start... but it does seem a bit much.



---

archive/issue_comments_170665.json:
```json
{
    "body": "Anyway even the SAGE_ROOT part is wrong.\n\nTry a dirty spkg at http://boxen.math.washington.edu/home/jpflori/gap-4.5.7.p2.spkg",
    "created_at": "2013-01-15T14:12:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170665",
    "user": "jpflori"
}
```

Anyway even the SAGE_ROOT part is wrong.

Try a dirty spkg at http://boxen.math.washington.edu/home/jpflori/gap-4.5.7.p2.spkg



---

archive/issue_comments_170666.json:
```json
{
    "body": "Looks good to me. \n\nNot sure what you mean by needing to start GAP for Sage. Sage startup doesn't start a GAP session. The GAP workspace cache needs to be rebuilt once, though.",
    "created_at": "2013-01-15T14:42:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170666",
    "user": "vbraun"
}
```

Looks good to me. 

Not sure what you mean by needing to start GAP for Sage. Sage startup doesn't start a GAP session. The GAP workspace cache needs to be rebuilt once, though.



---

archive/issue_comments_170667.json:
```json
{
    "body": "\n```diff\ndiff --git a/spkg-install b/spkg-install\n--- a/spkg-install\n+++ b/spkg-install\n@@ -86,34 +86,6 @@\n     exit 1\n fi\n \n-# On Cygwin installations the GAP build creates a file 'gap.exe',\n-# and then tries to strip the file 'gap'.\n-# This broke the build on old Cygwin installations.\n-# On newer Cygwins, 'gap' is automatically \"translated\" to 'gap.exe'.\n-if [[ \"$UNAME\" = CYGWIN ]]; then\n-    echo \"Creating a dummy 'gap.exe' in 'bin/i686-pc-cygwin-gcc'...\"\n-    cd \"$SPKG_ROOT/src\"\n-    mkdir -p bin/i686-pc-cygwin-gcc &&\n-    cd bin/i686-pc-cygwin-gcc &&\n-    touch gap.exe\n-    if [[ $? -ne 0 ]]; then\n-        # Something really went wrong.\n-        echo >&2 \"Error creating a dummy gap.exe file.\"\n-        exit 1\n-    fi\n-    # Check if 'gap' is automatically \"translated\" to 'gap.exe'.\n-    # If not, create a symbolic link from 'gap' to 'gap.exe'.\n-    if [[ ! -f gap ]]; then\n-        echo \"Creating a symbolic link from 'gap' to 'gap.exe'...\"\n-        ln -s gap.exe gap\n-        if [[ $? -ne 0 ]]; then\n-            # Something really went wrong.\n-            echo >&2 \"Error creating the symbolic link.\"\n-            exit 1\n-        fi\n-    fi\n-fi\n-\n echo \"Building GAP...\"\n cd \"$SPKG_ROOT/src\"\n $MAKE -j1\n@@ -144,11 +116,7 @@\n echo \"Copying GAP startup script...\"\n rm -f \"$SAGE_LOCAL/bin/gap\"\n cd \"$SPKG_ROOT\"\n-if [[ \"$UNAME\" = CYGWIN ]]; then\n-    cp patches/gap_cygwin \"$SAGE_LOCAL/bin/gap\"\n-else\n-    cp src/bin/gap.sh \"$SAGE_LOCAL/bin/gap\"\n-fi\n+cp src/bin/gap.sh \"$SAGE_LOCAL/bin/gap\"\n if [[ $? -ne 0 ]]; then\n     echo >&2 \"Error copying customized GAP startup script.\"\n     exit 1\n```\n\nYeah, if it works, then we are set.  It just finished building for me... `sage -b` now... that worked... Trying to start, `sage-location` is being run... it works!!!\n\nCommit and make the spkg, this is ready to go.\n\n> Not sure what you mean by needing to start GAP for Sage. Sage startup doesn't start a GAP session. The GAP workspace cache needs to be rebuilt once, though.\n\nWell, there is a GAP command that is run (and fails here, `gap -r -b -p -T -o 251m .../gap/sage.g`), so that sounds like GAP to me.  Also, upon a first start (or relocation), Sage always says something about stopping a GAP session.  But if it's not technically a session, that's fine; my point was that it does *something*, which e.g. Singular and Maxima don't.",
    "created_at": "2013-01-15T14:50:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170667",
    "user": "kcrisman"
}
```


```diff
diff --git a/spkg-install b/spkg-install
--- a/spkg-install
+++ b/spkg-install
@@ -86,34 +86,6 @@
     exit 1
 fi
 
-# On Cygwin installations the GAP build creates a file 'gap.exe',
-# and then tries to strip the file 'gap'.
-# This broke the build on old Cygwin installations.
-# On newer Cygwins, 'gap' is automatically "translated" to 'gap.exe'.
-if [[ "$UNAME" = CYGWIN ]]; then
-    echo "Creating a dummy 'gap.exe' in 'bin/i686-pc-cygwin-gcc'..."
-    cd "$SPKG_ROOT/src"
-    mkdir -p bin/i686-pc-cygwin-gcc &&
-    cd bin/i686-pc-cygwin-gcc &&
-    touch gap.exe
-    if [[ $? -ne 0 ]]; then
-        # Something really went wrong.
-        echo >&2 "Error creating a dummy gap.exe file."
-        exit 1
-    fi
-    # Check if 'gap' is automatically "translated" to 'gap.exe'.
-    # If not, create a symbolic link from 'gap' to 'gap.exe'.
-    if [[ ! -f gap ]]; then
-        echo "Creating a symbolic link from 'gap' to 'gap.exe'..."
-        ln -s gap.exe gap
-        if [[ $? -ne 0 ]]; then
-            # Something really went wrong.
-            echo >&2 "Error creating the symbolic link."
-            exit 1
-        fi
-    fi
-fi
-
 echo "Building GAP..."
 cd "$SPKG_ROOT/src"
 $MAKE -j1
@@ -144,11 +116,7 @@
 echo "Copying GAP startup script..."
 rm -f "$SAGE_LOCAL/bin/gap"
 cd "$SPKG_ROOT"
-if [[ "$UNAME" = CYGWIN ]]; then
-    cp patches/gap_cygwin "$SAGE_LOCAL/bin/gap"
-else
-    cp src/bin/gap.sh "$SAGE_LOCAL/bin/gap"
-fi
+cp src/bin/gap.sh "$SAGE_LOCAL/bin/gap"
 if [[ $? -ne 0 ]]; then
     echo >&2 "Error copying customized GAP startup script."
     exit 1
```

Yeah, if it works, then we are set.  It just finished building for me... `sage -b` now... that worked... Trying to start, `sage-location` is being run... it works!!!

Commit and make the spkg, this is ready to go.

> Not sure what you mean by needing to start GAP for Sage. Sage startup doesn't start a GAP session. The GAP workspace cache needs to be rebuilt once, though.

Well, there is a GAP command that is run (and fails here, `gap -r -b -p -T -o 251m .../gap/sage.g`), so that sounds like GAP to me.  Also, upon a first start (or relocation), Sage always says something about stopping a GAP session.  But if it's not technically a session, that's fine; my point was that it does *something*, which e.g. Singular and Maxima don't.



---

archive/issue_comments_170668.json:
```json
{
    "body": "Ok, here you go, the spkg is updated and diff posted here.\nI directly patch configure and leave configure.in as is.\nThis is dirty but what GAP does is so it's fair.",
    "created_at": "2013-01-15T15:19:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170668",
    "user": "jpflori"
}
```

Ok, here you go, the spkg is updated and diff posted here.
I directly patch configure and leave configure.in as is.
This is dirty but what GAP does is so it's fair.



---

archive/issue_comments_170669.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-01-15T15:20:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170669",
    "user": "jpflori"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_170670.json:
```json
{
    "body": "Thanks.  Do we need to provide a dylib check for Mac, or is that not relevant (apparently not, since we never encountered trouble looking for the .a file)?  I really need to read configure files more - the solution was just sitting there waiting to be found.  Too bad you can't take a class on configure files...\n\nAnyway, although the change in the config shouldn't make a difference on other platforms, it would be nice to test this on Mac and Linux.  JP, I assume you developed on Linux.",
    "created_at": "2013-01-15T15:37:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170670",
    "user": "kcrisman"
}
```

Thanks.  Do we need to provide a dylib check for Mac, or is that not relevant (apparently not, since we never encountered trouble looking for the .a file)?  I really need to read configure files more - the solution was just sitting there waiting to be found.  Too bad you can't take a class on configure files...

Anyway, although the change in the config shouldn't make a difference on other platforms, it would be nice to test this on Mac and Linux.  JP, I assume you developed on Linux.



---

archive/issue_comments_170671.json:
```json
{
    "body": "Also, another data point is #13588, which just (finally!) got positive review.  I have no idea if that will make things tougher for us here, but I think that, given all the many months of work that went into that ticket, we should probably rebase this to that ticket.",
    "created_at": "2013-01-16T04:03:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170671",
    "user": "kcrisman"
}
```

Also, another data point is #13588, which just (finally!) got positive review.  I have no idea if that will make things tougher for us here, but I think that, given all the many months of work that went into that ticket, we should probably rebase this to that ticket.



---

archive/issue_comments_170672.json:
```json
{
    "body": "Of course, it somehow got out of my head.\n\nI'll take this chance to provide a slightly cleaner patch, maybe using -lgmp to let the linker chose, not sure though, because if we really check for the existence of a shared *gmp*.* we can as well pass its full path to the linker.",
    "created_at": "2013-01-16T08:13:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170672",
    "user": "jpflori"
}
```

Of course, it somehow got out of my head.

I'll take this chance to provide a slightly cleaner patch, maybe using -lgmp to let the linker chose, not sure though, because if we really check for the existence of a shared *gmp*.* we can as well pass its full path to the linker.



---

archive/issue_comments_170673.json:
```json
{
    "body": "doesn't work for me. I get \n\n```\n$ ./sage -f gap-4.5.7.p2.spkg\ngap-4.5.7.p2\n====================================================\nExtracting package /usr/local/src/sage/sage-5.7.beta0/gap-4.5.7.p2.spkg\n-rw-r--r-- 1 dima Domain Users 8274155 Jan 15 23:18 /usr/local/src/sage/sage-5.7.beta0/gap-4.5.7.p2.spkg\nFinished extraction\n****************************************************\nHost system:\nCYGWIN_NT-6.1-WOW64 SPMS-DIMA-W7-64 1.7.17(0.262/5/3) 2012-10-19 14:39 i686 Cygwin\n****************************************************\nC compiler: gcc\nC compiler version:\nUsing built-in specs.\nCOLLECT_GCC=gcc\nCOLLECT_LTO_WRAPPER=/usr/lib/gcc/i686-pc-cygwin/4.5.3/lto-wrapper.exe\nTarget: i686-pc-cygwin\n[...]\ngcc version 4.5.3 (GCC)\n****************************************************\nspkg-install is using\nVERSION = 4.5.7\nGAP_DIR = gap-4.5.7\nINSTALL_DIR = /usr/local/src/sage/sage-5.7.beta0/local/gap/gap-4.5.7\nApplying patches...\npatching file cnf/aclocal.m4\npatching file cnf/configure.out\nHunk #1 succeeded at 4428 (offset 26 lines).\npatching file configure\nReversed (or previously applied) patch detected!  Assume -R? [n]\nApply anyway? [n]\nSkipping patch.\n1 out of 1 hunk ignored -- saving rejects to file configure.rej\nError applying '../patches/configure.patch'\n\nreal    0m1.047s\nuser    0m0.120s\nsys     0m0.521s\n************************************************************************\nError installing package gap-4.5.7.p2\n```\n",
    "created_at": "2013-01-26T04:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170673",
    "user": "dimpase"
}
```

doesn't work for me. I get 

```
$ ./sage -f gap-4.5.7.p2.spkg
gap-4.5.7.p2
====================================================
Extracting package /usr/local/src/sage/sage-5.7.beta0/gap-4.5.7.p2.spkg
-rw-r--r-- 1 dima Domain Users 8274155 Jan 15 23:18 /usr/local/src/sage/sage-5.7.beta0/gap-4.5.7.p2.spkg
Finished extraction
****************************************************
Host system:
CYGWIN_NT-6.1-WOW64 SPMS-DIMA-W7-64 1.7.17(0.262/5/3) 2012-10-19 14:39 i686 Cygwin
****************************************************
C compiler: gcc
C compiler version:
Using built-in specs.
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/usr/lib/gcc/i686-pc-cygwin/4.5.3/lto-wrapper.exe
Target: i686-pc-cygwin
[...]
gcc version 4.5.3 (GCC)
****************************************************
spkg-install is using
VERSION = 4.5.7
GAP_DIR = gap-4.5.7
INSTALL_DIR = /usr/local/src/sage/sage-5.7.beta0/local/gap/gap-4.5.7
Applying patches...
patching file cnf/aclocal.m4
patching file cnf/configure.out
Hunk #1 succeeded at 4428 (offset 26 lines).
patching file configure
Reversed (or previously applied) patch detected!  Assume -R? [n]
Apply anyway? [n]
Skipping patch.
1 out of 1 hunk ignored -- saving rejects to file configure.rej
Error applying '../patches/configure.patch'

real    0m1.047s
user    0m0.120s
sys     0m0.521s
************************************************************************
Error installing package gap-4.5.7.p2
```




---

archive/issue_comments_170674.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-01-26T04:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170674",
    "user": "dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_170675.json:
```json
{
    "body": "Replying to [comment:16 dimpase]:\n> doesn't work for me. \n\nhowever, I took the diff above and applied it in the gap spkg directory as follows:\n\n```\npatch -p1 <gap-4.5.7.p2.diff\n```\n\nthe resulting spkg installed just fine on cygwin.",
    "created_at": "2013-01-26T06:59:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170675",
    "user": "dimpase"
}
```

Replying to [comment:16 dimpase]:
> doesn't work for me. 

however, I took the diff above and applied it in the gap spkg directory as follows:

```
patch -p1 <gap-4.5.7.p2.diff
```

the resulting spkg installed just fine on cygwin.



---

archive/issue_comments_170676.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-01-26T18:04:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170676",
    "user": "jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_170677.json:
```json
{
    "body": "Ive uploaded a new spkg based on #13963.\n\nAfter a quick look it does not seem that libgap which uses better checks for GMP will need any action from here, but I've not actually tried to build it yet.\nAs I've finally found where my Cygwin memleak came from, I might test 5.7.beta1 quickly though.",
    "created_at": "2013-01-26T18:04:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170677",
    "user": "jpflori"
}
```

Ive uploaded a new spkg based on #13963.

After a quick look it does not seem that libgap which uses better checks for GMP will need any action from here, but I've not actually tried to build it yet.
As I've finally found where my Cygwin memleak came from, I might test 5.7.beta1 quickly though.



---

archive/issue_comments_170678.json:
```json
{
    "body": "Attachment\n\nSpkg diff, for review only.",
    "created_at": "2013-01-26T18:06:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170678",
    "user": "jpflori"
}
```

Attachment

Spkg diff, for review only.



---

archive/issue_comments_170679.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-01-27T03:38:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170679",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_170680.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-01-30T07:35:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13750",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13750#issuecomment-170680",
    "user": "jdemeyer"
}
```

Resolution: fixed
