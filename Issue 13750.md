# Issue 13750: New Gap spkg (>=4.5) does not build with shared only GMP/MPIR

Issue created by migration from https://trac.sagemath.org/ticket/13954

Original creator: jpflori

Original creation time: 2013-01-14 19:43:40

Assignee: tbd

CC:  kcrisman dimpase

Keywords: spkg gap cygwin

And we only build a shared one on Cygwin because we cannot build both static and shared (although this limitation is not clearly still needed).


---

Comment by jpflori created at 2013-01-14 19:44:22

The configure script tests for libgmp.a if --with-gmp=... is passed.


---

Comment by kcrisman created at 2013-01-14 19:57:39

Would this explain my current problem that GAP doesn't build on XP?  Configure fails with

```
configure: error: Could not locate GMP in the specified location
```



---

Comment by jpflori created at 2013-01-14 20:02:30

Yes that's it.


---

Comment by jpflori created at 2013-01-15 13:04:21

Ok, I got GAP to build but the script gap_cygwin is completely broken as well.


---

Comment by jpflori created at 2013-01-15 13:11:21

Ok we basically have to remove all Cygwin specific things from spkg-install.


---

Comment by kcrisman created at 2013-01-15 14:05:28

Great, provide something and I can still try it today!

Nice that the folks at #13211 managed to do this

```
if [ "x$GAP_DIR" = "x" ];  then
    GAP_DIR="$SAGE_ROOT/local/lib/gap-4.5.5" 
fi
```

but then somehow not update it to 4.5.7!?


---

Comment by kcrisman created at 2013-01-15 14:07:47

By the way, WHY do we need to start GAP to start Sage?  I know that sage-location or some similar script does this upon the first start... but it does seem a bit much.


---

Comment by jpflori created at 2013-01-15 14:12:13

Anyway even the SAGE_ROOT part is wrong.

Try a dirty spkg at http://boxen.math.washington.edu/home/jpflori/gap-4.5.7.p2.spkg


---

Comment by vbraun created at 2013-01-15 14:42:37

Looks good to me. 

Not sure what you mean by needing to start GAP for Sage. Sage startup doesn't start a GAP session. The GAP workspace cache needs to be rebuilt once, though.


---

Comment by kcrisman created at 2013-01-15 14:50:18


```diff
diff --git a/spkg-install b/spkg-install
--- a/spkg-install
+++ b/spkg-install
@@ -86,34 +86,6 @@
     exit 1
 fi
 
-# On Cygwin installations the GAP build creates a file 'gap.exe',
-# and then tries to strip the file 'gap'.
-# This broke the build on old Cygwin installations.
-# On newer Cygwins, 'gap' is automatically "translated" to 'gap.exe'.
-if [[ "$UNAME" = CYGWIN ]]; then
-    echo "Creating a dummy 'gap.exe' in 'bin/i686-pc-cygwin-gcc'..."
-    cd "$SPKG_ROOT/src"
-    mkdir -p bin/i686-pc-cygwin-gcc &&
-    cd bin/i686-pc-cygwin-gcc &&
-    touch gap.exe
-    if [[ $? -ne 0 ]]; then
-        # Something really went wrong.
-        echo >&2 "Error creating a dummy gap.exe file."
-        exit 1
-    fi
-    # Check if 'gap' is automatically "translated" to 'gap.exe'.
-    # If not, create a symbolic link from 'gap' to 'gap.exe'.
-    if [[ ! -f gap ]]; then
-        echo "Creating a symbolic link from 'gap' to 'gap.exe'..."
-        ln -s gap.exe gap
-        if [[ $? -ne 0 ]]; then
-            # Something really went wrong.
-            echo >&2 "Error creating the symbolic link."
-            exit 1
-        fi
-    fi
-fi
-
 echo "Building GAP..."
 cd "$SPKG_ROOT/src"
 $MAKE -j1
@@ -144,11 +116,7 @@
 echo "Copying GAP startup script..."
 rm -f "$SAGE_LOCAL/bin/gap"
 cd "$SPKG_ROOT"
-if [[ "$UNAME" = CYGWIN ]]; then
-    cp patches/gap_cygwin "$SAGE_LOCAL/bin/gap"
-else
-    cp src/bin/gap.sh "$SAGE_LOCAL/bin/gap"
-fi
+cp src/bin/gap.sh "$SAGE_LOCAL/bin/gap"
 if [[ $? -ne 0 ]]; then
     echo >&2 "Error copying customized GAP startup script."
     exit 1
```

Yeah, if it works, then we are set.  It just finished building for me... `sage -b` now... that worked... Trying to start, `sage-location` is being run... it works!!!

Commit and make the spkg, this is ready to go.

> Not sure what you mean by needing to start GAP for Sage. Sage startup doesn't start a GAP session. The GAP workspace cache needs to be rebuilt once, though.

Well, there is a GAP command that is run (and fails here, `gap -r -b -p -T -o 251m .../gap/sage.g`), so that sounds like GAP to me.  Also, upon a first start (or relocation), Sage always says something about stopping a GAP session.  But if it's not technically a session, that's fine; my point was that it does _something_, which e.g. Singular and Maxima don't.


---

Comment by jpflori created at 2013-01-15 15:19:38

Ok, here you go, the spkg is updated and diff posted here.
I directly patch configure and leave configure.in as is.
This is dirty but what GAP does is so it's fair.


---

Comment by jpflori created at 2013-01-15 15:20:09

Changing status from new to needs_review.


---

Comment by kcrisman created at 2013-01-15 15:37:32

Thanks.  Do we need to provide a dylib check for Mac, or is that not relevant (apparently not, since we never encountered trouble looking for the .a file)?  I really need to read configure files more - the solution was just sitting there waiting to be found.  Too bad you can't take a class on configure files...

Anyway, although the change in the config shouldn't make a difference on other platforms, it would be nice to test this on Mac and Linux.  JP, I assume you developed on Linux.


---

Comment by kcrisman created at 2013-01-16 04:03:15

Also, another data point is #13588, which just (finally!) got positive review.  I have no idea if that will make things tougher for us here, but I think that, given all the many months of work that went into that ticket, we should probably rebase this to that ticket.


---

Comment by jpflori created at 2013-01-16 08:13:49

Of course, it somehow got out of my head.

I'll take this chance to provide a slightly cleaner patch, maybe using -lgmp to let the linker chose, not sure though, because if we really check for the existence of a shared *gmp*.* we can as well pass its full path to the linker.


---

Comment by dimpase created at 2013-01-26 04:24:06

doesn't work for me. I get 

```
$ ./sage -f gap-4.5.7.p2.spkg
gap-4.5.7.p2
====================================================
Extracting package /usr/local/src/sage/sage-5.7.beta0/gap-4.5.7.p2.spkg
-rw-r--r-- 1 dima Domain Users 8274155 Jan 15 23:18 /usr/local/src/sage/sage-5.7.beta0/gap-4.5.7.p2.spkg
Finished extraction
****************************************************
Host system:
CYGWIN_NT-6.1-WOW64 SPMS-DIMA-W7-64 1.7.17(0.262/5/3) 2012-10-19 14:39 i686 Cygwin
****************************************************
C compiler: gcc
C compiler version:
Using built-in specs.
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/usr/lib/gcc/i686-pc-cygwin/4.5.3/lto-wrapper.exe
Target: i686-pc-cygwin
[...]
gcc version 4.5.3 (GCC)
****************************************************
spkg-install is using
VERSION = 4.5.7
GAP_DIR = gap-4.5.7
INSTALL_DIR = /usr/local/src/sage/sage-5.7.beta0/local/gap/gap-4.5.7
Applying patches...
patching file cnf/aclocal.m4
patching file cnf/configure.out
Hunk #1 succeeded at 4428 (offset 26 lines).
patching file configure
Reversed (or previously applied) patch detected!  Assume -R? [n]
Apply anyway? [n]
Skipping patch.
1 out of 1 hunk ignored -- saving rejects to file configure.rej
Error applying '../patches/configure.patch'

real    0m1.047s
user    0m0.120s
sys     0m0.521s
************************************************************************
Error installing package gap-4.5.7.p2
```



---

Comment by dimpase created at 2013-01-26 04:24:06

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2013-01-26 06:59:04

Replying to [comment:16 dimpase]:
> doesn't work for me. 

however, I took the diff above and applied it in the gap spkg directory as follows:

```
patch -p1 <gap-4.5.7.p2.diff
```

the resulting spkg installed just fine on cygwin.


---

Comment by jpflori created at 2013-01-26 18:04:58

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2013-01-26 18:04:58

Ive uploaded a new spkg based on #13963.

After a quick look it does not seem that libgap which uses better checks for GMP will need any action from here, but I've not actually tried to build it yet.
As I've finally found where my Cygwin memleak came from, I might test 5.7.beta1 quickly though.


---

Attachment

Spkg diff, for review only.


---

Comment by dimpase created at 2013-01-27 03:38:44

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-01-30 07:35:44

Resolution: fixed
