# Issue 31391: fix/improve conversions to QQbar and AA

Issue created by migration from https://trac.sagemath.org/ticket/31628

Original creator: mmezzarobba

Original creation time: 2021-04-09 08:18:00

* fix conversion from â„š[i] to `QQbar` (honor complex embeddings)
* add implicit coercions from python ints and from number fields with compatible embeddings


---

Comment by mmezzarobba created at 2021-04-09 08:19:34

Changing status from new to needs_review.


---

Comment by mmezzarobba created at 2021-04-09 08:19:34

New commits:


---

Comment by slelievre created at 2021-04-09 08:48:58

Not sure about that kind of humour:

```
            sage: NF.<sqrt3> = QuadraticField(2)
            sage: AA(sqrt3)
            1.414213562373095?
```



---

Comment by git created at 2021-04-09 08:53:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2021-04-09 08:53:32

fixed, thanks


---

Comment by vdelecroix created at 2021-04-09 10:36:39

Conversions always existed I think. Could you doctest more directly what changed, namely

```
sage: QQbar.has_coerce_map_from(QuadraticField(-1))
```

and

```
sage: K = NumberField(x^3 - 2, 'a', embedding=2.**(1/3))
sage: AA.has_coerce_map_from(K)
```

I will adapt #30518.


---

Comment by git created at 2021-04-09 10:44:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmezzarobba created at 2021-04-09 10:45:43

The first case is already tested by

```
            sage: i + QQbar(2)
            I + 2
            sage: K.<ii> = QuadraticField(-1, embedding=ComplexField(13)(0,-1))
            sage: ii + QQbar(2)
            -I + 2
```

(better IMO, since it checks that the embedding is respected).

I added the second one so that we have an example or degree >2.
----
New commits:


---

Comment by vdelecroix created at 2021-04-09 10:49:35

Parfait. Merci.


---

Comment by vdelecroix created at 2021-04-09 10:49:35

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-04-18 16:13:17

Changing priority from major to blocker.


---

Comment by vbraun created at 2021-04-25 12:14:09

Resolution: fixed


---

Comment by vbraun created at 2021-04-25 20:23:43

Resolution changed from fixed to 


---

Comment by vbraun created at 2021-04-25 20:23:43

Changing status from closed to new.


---

Comment by vbraun created at 2021-04-25 20:23:43


```
sage -t --long --warn-long 45.5 --random-seed=0 src/sage/symbolic/expression.pyx  # 1 doctest failed
sage -t --long --warn-long 45.5 --random-seed=0 src/sage/modular/dirichlet.py  # 1 doctest failed
```



---

Comment by vdelecroix created at 2021-04-25 20:54:32

Indeed

```
File "symbolic/expression.pyx", line 3155, in sage.symbolic.expression.Expression.__nonzero__
Failed example:
    bool(SR(QQbar(I)) == I)
Expected:
    Traceback (most recent call last):
    ...
    TypeError: unsupported operand parent(s)...
Got:
    True
```

and

```
sage -t --long --warn-long 45.5 --random-seed=0 modular/dirichlet.py
**********************************************************************
File "modular/dirichlet.py", line 1593, in sage.modular.dirichlet.DirichletCharacter.kloosterman_sum
Failed example:
    e.kloosterman_sum(5,11)
Expected:
    Traceback (most recent call last):
    ...
    NotImplementedError: Kloosterman sums not implemented over this ring
Got:
    0
```



---

Comment by vdelecroix created at 2021-04-25 20:59:31

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2021-04-25 20:59:31

New commits:


---

Comment by mmezzarobba created at 2021-04-26 09:18:41

Changing status from needs_review to positive_review.


---

Comment by mmezzarobba created at 2021-04-26 09:18:41

Thank you Volker and Vincent!


---

Comment by vbraun created at 2021-04-29 21:06:03

Resolution: fixed
