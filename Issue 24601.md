# Issue 24601: Upgrade to pynac-0.7.17

Issue created by migration from https://trac.sagemath.org/ticket/24838

Original creator: rws

Original creation time: 2018-02-26 14:06:03

CC:  fbissey @timokau

In the new version:
 * fix memleak in in-place PyObject numerics (#24745)
 * Python interface / Py3 fixes and improvements (thx Erik Bray, #24561, #24752)
 * fix internal `asin`/`acos` of complex balls
 * draw factors out of `add^rational` (#24768)
 * `exp(f(x))`, `exp(c*f(x))`, f inv. hyperbolic simplifications
 * always extend trig/hyperbolic functions to complex domain (#24428)
 * extensive code readability improvements

https://github.com/pynac/pynac/releases/download/pynac-0.7.17/pynac-0.7.17.tar.bz2


---

Comment by rws created at 2018-02-26 14:14:53

New commits:


---

Comment by rws created at 2018-02-26 14:14:53

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-03-02 13:57:34

Just a question: is this supposed to fix #24522 too?


---

Comment by rws created at 2018-03-02 14:06:38

Yes, that PR is merged. I'll probably add a hotfix for #24883 here as patch, too.


---

Comment by jdemeyer created at 2018-03-02 14:15:56

Replying to [comment:6 rws]:
> I'll probably add a hotfix for #24883 here as patch, too. 

Then I'm setting this to needs_work. If you change your mind, feel free to set this back to needs_review.


---

Comment by rws created at 2018-03-02 14:20:27

The issue is no longer there. Please review.


---

Comment by jdemeyer created at 2018-03-02 16:16:37

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-03-02 16:16:37

This used to return a purely imaginary number, now there is a small real part:

```
sage: arccosh(x).subs(x=0.9)
-9.66146955461936e-22 + 0.451026811796262*I
```



---

Comment by rws created at 2018-03-03 09:12:07

This is an artifact of conversion to CC:

```
sage: CC(ComplexBallField(68)(0.9).arccosh())
-9.66146955461936e-22 + 0.451026811796262*I
```

We use arb with precision+15 and convert back to parent, all to make up for missing or limited (in the calculus sense, not the algebraic, note recent discussion) member functions of parent (RR in this case). Before this pynac version we had specific logic to zero the real part but this was error-prone. IMHO CC conversion of complex balls should be fixed.


---

Comment by rws created at 2018-03-03 09:27:52

See also https://github.com/fredrik-johansson/arb/issues/198


---

Comment by rws created at 2018-03-03 14:31:12

You may also want to know why I'm using arb and not mpfr:

```
sage: r=srange(-2.5,2.5,.01)
sage: rr = [CC(i) for i in r]
sage: %timeit for x in rr: _=x.arccosh()
100 loops, best of 3: 11.9 ms per loop
sage: rr = [CBF(i) for i in r]
sage: %timeit for x in rr: _=x.arccosh()
1000 loops, best of 3: 649 Âµs per loop
```



---

Comment by rws created at 2018-03-04 07:23:24

What do you prefer, patching arb or the arb interface?


---

Comment by rws created at 2018-03-04 08:20:09

See https://github.com/fredrik-johansson/arb/pull/210


---

Comment by jdemeyer created at 2018-03-04 08:39:37

Replying to [comment:12 rws]:
> You may also want to know why I'm using arb and not mpfr:

Despite what you think, you are not using mpfr, but PARI:

```python
    def arccosh(self):
        """
        Return the hyperbolic arccosine of ``self``.

        EXAMPLES::

            sage: (1+CC(I)).arccosh()
            1.06127506190504 + 0.904556894302381*I
        """
        return self._parent(self.__pari__().acosh())
```


If you want to compare with something, it should be mpc (in Sage: `CC = MPComplexField(53)`)


---

Comment by rws created at 2018-03-04 09:46:42

Interestingly,

```
sage: arccosh(x).subs(x=MPComplexField(53)(0.9))
...
TypeError: no canonical coercion from Complex Field with 53 bits of precision to Symbolic Ring
```



---

Comment by rws created at 2018-03-05 15:17:12

Replying to [comment:14 rws]:
> See https://github.com/fredrik-johansson/arb/pull/210

This is now merged. Do we want that patch in this ticket? If not, anything else?


---

Comment by rws created at 2018-03-10 08:33:55

Changing status from needs_work to needs_review.


---

Comment by git created at 2018-03-22 07:33:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2018-03-22 07:35:19

Changing status from needs_review to needs_work.


---

Comment by rws created at 2018-03-22 07:35:19

New release incoming.


---

Comment by git created at 2018-03-23 07:25:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2018-03-23 07:26:09

Changing status from needs_work to needs_review.


---

Comment by rws created at 2018-04-07 16:07:34

0.7.17 introduced a bug in `exp(ex*log(x))` simplification, and we need a new release, anyway.


---

Comment by rws created at 2018-04-07 16:07:34

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-04-08 12:50:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2018-04-08 12:51:09

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-04-23 13:53:21

This looks fishy:

```diff
-            sage: SR(CDF(1/2)).arccosh()  # rel tol 1e-15
+            sage: SR(CDF(1/2)).arccosh() # abs tol 1e-15
```



---

Comment by jdemeyer created at 2018-04-23 14:52:40

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-04-23 14:52:40

The analogous thing as [comment:9] should be fixed for pure imaginary results:

```
sage: CDF(1/2).arccosh()
1.0471975511965979*I
sage: SR(CDF(1/2)).arccosh()
-6.372599439108525e-21 + 1.0471975511965979*I
```

Then you also revert [comment:29]


---

Comment by rws created at 2018-04-30 13:08:05

Replying to [comment:30 jdemeyer]:
> The analogous thing as [comment:9] should be fixed for pure imaginary results:
> {{{
> sage: CDF(1/2).arccosh()
> 1.0471975511965979*I
> sage: SR(CDF(1/2)).arccosh()
> -6.372599439108525e-21 + 1.0471975511965979*I
> }}}

As explained in [comment:10] missing FP functionality is gained using arb. But there was that bug in arb which is now fixed. Consequentially we need that fix or a recent arb to get the right result, see [comment:14].

> Then you also revert [comment:29]

Will re-revert.


---

Comment by rws created at 2018-04-30 13:20:59

I confirm that this works with https://github.com/fredrik-johansson/arb/commit/7afd3bfaf1697739751d96d3665ef83e78c76820 applied, which is in arb-2.13.0 (#24927).


---

Comment by git created at 2018-04-30 14:27:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2018-05-29 05:46:12

Some recent Sage commit makes doctests (involving powers of `I`) fail together with pynac-0.7.17 so we'll need a fix in 0.7.20.


---

Comment by rws created at 2018-05-29 06:03:12

Actually it's not our fault: #25458.


---

Comment by git created at 2018-05-29 07:36:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2018-06-24 07:46:52

The dependency is now in. Here a fresh branch with the newest Pynac.
----
New commits:


---

Comment by rws created at 2018-06-24 07:46:52

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-06-24 12:54:16

I got "invalid checksum"


---

Comment by rws created at 2018-06-24 14:18:19

Please check again, I just now did not get any error with the file linked in the ticket. Did you reload the branch?


---

Comment by chapoton created at 2018-06-24 14:48:17

Indeed. Works now. I must have made some mistake in my previous attempt.


---

Comment by chapoton created at 2018-06-24 16:29:28

got

```
sage -t --long src/sage/rings/asymptotic/asymptotics_multivariate_generating_functions.py  # 2 doctests failed
sage -t --long src/sage/symbolic/expression.pyx  # 1 doctest failed
```



---

Comment by chapoton created at 2018-06-24 16:31:30


```
Doctesting 2 files.
sage -t --long src/sage/rings/asymptotic/asymptotics_multivariate_generating_functions.py
**********************************************************************
File "src/sage/rings/asymptotic/asymptotics_multivariate_generating_functions.py", line 153, in sage.rings.asymptotic.asymptotics_multivariate_generating_functions
Failed example:
    F1.asymptotics(p, alpha, 2)
Expected:
    (-3*((2*a^2 - 5*a*b + 2*b^2)*r^2 + (a + b)*r + 3)*((1/3)^(-a)*(1/3)^(-b))^r,
     (1/3)^(-a)*(1/3)^(-b), -3*(2*a^2 - 5*a*b + 2*b^2)*r^2 - 3*(a + b)*r - 9)
Got:
    (-3*((2*a^2 - 5*a*b + 2*b^2)*r^2 + (a + b)*r + 3)*(1/((1/3)^a*(1/3)^b))^r,
     1/((1/3)^a*(1/3)^b),
     -3*(2*a^2 - 5*a*b + 2*b^2)*r^2 - 3*(a + b)*r - 9)
**********************************************************************
File "src/sage/rings/asymptotic/asymptotics_multivariate_generating_functions.py", line 2161, in sage.rings.asymptotic.asymptotics_multivariate_generating_functions.FractionWithFactoredDenominator.?
Failed example:
    F.asymptotics_multiple(p, alpha, 2, var('r')) # long time
Expected:
    (3*((1/3)^(-a)*(1/3)^(-b))^r*e^(2/3), (1/3)^(-a)*(1/3)^(-b), 3*e^(2/3))
Got:
    (3*(1/((1/3)^a*(1/3)^b))^r*e^(2/3), 1/((1/3)^a*(1/3)^b), 3*e^(2/3))
**********************************************************************
2 items had failures:
   1 of  77 in sage.rings.asymptotic.asymptotics_multivariate_generating_functions
```

and

```
Failed example:
    SR(CDF(1/2)).arccosh() #  rel tol 1e-15
Expected:
    1.0471975511965976*I
Got:
    -6.372599439108525e-21 + 1.0471975511965979*I
```



---

Comment by rws created at 2018-06-25 05:14:02

Replying to [comment:49 chapoton]:
> {{{
> Failed example:
>     SR(CDF(1/2)).arccosh() #  rel tol 1e-15
> Expected:
>     1.0471975511965976*I
> Got:
>     -6.372599439108525e-21 + 1.0471975511965979*I
> }}}

Not confirmed. You apparently don't have the dependency installed, the newest arb.


---

Comment by git created at 2018-06-25 05:38:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-06-25 08:17:45

The second doctest is still failing for me.

```
sage: version()
'SageMath version 8.3.beta7, Release Date: 2018-06-23'
sage: package_versions('standard')['arb']
('2.13.0', '2.13.0')
```



---

Comment by rws created at 2018-06-25 12:46:48

Replying to [comment:52 chapoton]:
> The second doctest is still failing for me.

Can you please give the output of:

```
sage: CDF(1/2).arccosh()
1.0471975511965979*I
sage: CBF(1/2).arccosh()
[1.047197551196598 +/- 7.94e-16]*I
```



---

Comment by chapoton created at 2018-06-25 12:48:41


```
sage: CDF(1/2).arccosh()
1.0471975511965979*I
sage: CBF(1/2).arccosh()
[+/- 4.90e-16] + [1.047197551196598 +/- 7.94e-16]*I
```



---

Comment by rws created at 2018-06-25 13:11:06

This is peculiar. I was under the impression that this fix: https://github.com/fredrik-johansson/arb/commit/7afd3bfaf1697739751d96d3665ef83e78c76820 would be in arb-2.13.0. I just found out that it was committed Mar 5, while the release was Feb 23. I should have actively propagated that patch into our arb upgrade ticket.

Should I open a separate ticket for the arb patch or just put it into this branch?

I would have noticed earlier but for some reason I don't get the error with 2.13.0.


---

Comment by rws created at 2018-06-25 13:39:13

Ah, I had the patch still in the patches directory. New files are not deleted when changing branches.


---

Comment by git created at 2018-06-25 14:15:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2018-06-25 14:17:52

This is reviewed by Fredrik in https://github.com/fredrik-johansson/arb/pull/210


---

Comment by chapoton created at 2018-06-25 15:14:32

This should bump the arb version by `.p0`


---

Comment by git created at 2018-06-25 15:41:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-06-25 15:45:19

Thanks. This should be ready to go.

Launching now "make ptestlong" once again, just to be sure.


---

Comment by chapoton created at 2018-06-25 16:55:07

ok, all tests pass


---

Comment by chapoton created at 2018-06-25 16:55:07

Changing status from needs_review to positive_review.


---

Comment by rws created at 2018-06-26 05:10:23

Thanks for the review!


---

Comment by vbraun created at 2018-06-27 06:02:43

On 32-bit:

```
File "src/sage/functions/hypergeometric.py", line 148, in sage.functions.hypergeometric
Failed example:
    hypergeometric_U(2, 2, x).series(x == 3, 100).subs(x=1).n()
Expected:
    0.403652637676806
Got:
    0.403651580752398
```



---

Comment by vbraun created at 2018-06-27 06:02:43

Changing status from positive_review to needs_work.


---

Comment by rws created at 2018-06-27 15:23:41

Replying to [comment:64 vbraun]:
> On 32-bit:
> {{{
> File "src/sage/functions/hypergeometric.py", line 148, in sage.functions.hypergeometric
> Failed example:
>     hypergeometric_U(2, 2, x).series(x == 3, 100).subs(x=1).n()
> Expected:
>     0.403652637676806
> Got:
>     0.403651580752398
> }}}

Pynac is not involved in the numerics (`hypergeometric_U` is not a `GinacFunction`), so the hypothesis is that the expression before `.n()` is different with 32bit pynac-0.7.22.


---

Comment by rws created at 2018-06-28 14:15:33

Replying to [comment:65 rws]:
> Replying to [comment:64 vbraun]:
> > On 32-bit:
> 
> Pynac is not involved in the numerics (`hypergeometric_U` is not a `GinacFunction`), so the hypothesis is that the expression before `.n()` is different with 32bit pynac-0.7.22.

We will never know. I failed to install 32bit versions of CentOS and ArchLinux in a VM, and I will not try again. There will be a ticket for this doctest failure, and the test marked "known bug (see ...".


---

Comment by git created at 2018-06-28 14:39:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2018-06-28 14:41:22

Changing status from needs_work to positive_review.


---

Comment by @timokau created at 2018-06-28 20:40:33

This isn't really about this specific ticket (thanks for putting in the work for the upgrade), but is there a reason everybody seems to make seperate "pkg version / chksum" and "doctest fixes" patches?

Shouldn't each commit be one unit of changes for which the doctests still pass?


---

Comment by rws created at 2018-06-29 05:36:16

Replying to [comment:70 gh-timokau]:
> Shouldn't each commit be one unit of changes for which the doctests still pass?

The only reason I see for this is to make statistics based on number of commits meaningful. By splitting commits into parts (if there is such a natural split, maybe here it's less needed) I make the job of reviewing easier.


---

Comment by @timokau created at 2018-06-29 13:53:36

Replying to [comment:71 rws]:
> Replying to [comment:70 gh-timokau]:
> > Shouldn't each commit be one unit of changes for which the doctests still pass?
> 
> The only reason I see for this is to make statistics based on number of commits meaningful. By splitting commits into parts (if there is such a natural split, maybe here it's less needed) I make the job of reviewing easier.

A much more practical reason is the use of `git-bisect` or just generally being able to check out some interesting commit and build from it.


---

Comment by vbraun created at 2018-06-29 22:33:33

Resolution: fixed


---

Comment by @timokau created at 2018-06-30 11:39:23

Replying to [comment:57 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[6645f79](https://git.sagemath.org/sage.git/commit/?id=6645f7923ee5bdd97219b0a475e3ae98e03de4e8)||`24838: add arb commit 7afd3afbf`||

For the future it would greatly simplify packaging if you would add some documentation when adding a patch. A link to the github issue/pr and maybe a sentence about what it does would be sufficient. (The commit is actually 7afd3bfaf)


---

Comment by jdemeyer created at 2018-06-30 11:41:47

Replying to [comment:74 gh-timokau]:
> For the future it would greatly simplify packaging if you would add some documentation when adding a patch. A link to the github issue/pr and maybe a sentence about what it does would be sufficient. (The commit is actually 7afd3bfaf)

+1

Patches without any documentation or links should be rejected.
