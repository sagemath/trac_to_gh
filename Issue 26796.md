# Issue 26796: Make relabel() of DynkinDiagram more compatible with GenericGraph

archive/issues_026796.json:
```json
{
    "body": "CC:  tscrim nthiery\n\n`DynkinDiagram_class` is a derived class of `GenericGraph`. It specializes the `relabel()` method of `GenericGraph`, but it changes the interface in the following ways:\n\n1. A permutation is required to be given. This is in contrast to `GenericGraph.relabel()` which allows no permutation (in that case, vertices will be relabelled to `range(G.order())`)\n\n2. `return_map` is not supported.\n\n3. The default value for `inplace` is `False` instead of `True`.\n\nWe fix the first two issues and add a deprecation for the third.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27033\n\n",
    "created_at": "2019-01-08T10:57:43Z",
    "labels": [
        "combinatorics",
        "major",
        "enhancement"
    ],
    "title": "Make relabel() of DynkinDiagram more compatible with GenericGraph",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26796",
    "user": "jdemeyer"
}
```
CC:  tscrim nthiery

`DynkinDiagram_class` is a derived class of `GenericGraph`. It specializes the `relabel()` method of `GenericGraph`, but it changes the interface in the following ways:

1. A permutation is required to be given. This is in contrast to `GenericGraph.relabel()` which allows no permutation (in that case, vertices will be relabelled to `range(G.order())`)

2. `return_map` is not supported.

3. The default value for `inplace` is `False` instead of `True`.

We fix the first two issues and add a deprecation for the third.

Issue created by migration from https://trac.sagemath.org/ticket/27033





---

archive/issue_comments_376883.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-01-08T11:16:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376883",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_376884.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-01-08T11:16:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376884",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_376885.json:
```json
{
    "body": "Green patchbot!",
    "created_at": "2019-01-08T15:39:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376885",
    "user": "jdemeyer"
}
```

Green patchbot!



---

archive/issue_comments_376886.json:
```json
{
    "body": "I believe Nicolas has a better sense of what we want from `DynkinDiagram`, but here is my understanding. The reason it is a subclass, as opposed to a wrapper, is many of the methods would be simple punts to the corresponding `DiGraph` object, and it is a digraph, albeit with special properties. I do agree with trying to keep the API as much as possible. Yet, we want it to behave more like a immutable object, so I think we should keep the default for `inplace=False`. So 1 and 2 are good with me, but I think 3 needs to be reconsidered.",
    "created_at": "2019-01-08T17:52:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376886",
    "user": "tscrim"
}
```

I believe Nicolas has a better sense of what we want from `DynkinDiagram`, but here is my understanding. The reason it is a subclass, as opposed to a wrapper, is many of the methods would be simple punts to the corresponding `DiGraph` object, and it is a digraph, albeit with special properties. I do agree with trying to keep the API as much as possible. Yet, we want it to behave more like a immutable object, so I think we should keep the default for `inplace=False`. So 1 and 2 are good with me, but I think 3 needs to be reconsidered.



---

archive/issue_comments_376887.json:
```json
{
    "body": "Regardless of the reason of `DynkinDiagram_class` being a subclass of `GenericGraph`, the effect is that generic code relies on the behaviour of `relabel()`. For example, the reason for breakage in #27029 is that the generic isomorphism check for graphs at some point calls `G.relabel()`. The code expects this to be an in-place relabeling.\n\nSo if you don't like my solution to make `inplace=True` the default, I still feel that the problem needs to be solved. One alternative is to have no default and always require `inplace` to be given.",
    "created_at": "2019-01-08T20:52:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376887",
    "user": "jdemeyer"
}
```

Regardless of the reason of `DynkinDiagram_class` being a subclass of `GenericGraph`, the effect is that generic code relies on the behaviour of `relabel()`. For example, the reason for breakage in #27029 is that the generic isomorphism check for graphs at some point calls `G.relabel()`. The code expects this to be an in-place relabeling.

So if you don't like my solution to make `inplace=True` the default, I still feel that the problem needs to be solved. One alternative is to have no default and always require `inplace` to be given.



---

archive/issue_comments_376888.json:
```json
{
    "body": "I see your point. I definitely do not want to always specify an `inplace`. What about always specifying `inplace` when the `relabel` is called in functions indicated by doctests that fail otherwise? As I write that, I don't feel like it is a good solution.\n\nI'm not quite sure what the path forward is. Nicolas, do you have any thoughts on this?",
    "created_at": "2019-01-09T01:33:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376888",
    "user": "tscrim"
}
```

I see your point. I definitely do not want to always specify an `inplace`. What about always specifying `inplace` when the `relabel` is called in functions indicated by doctests that fail otherwise? As I write that, I don't feel like it is a good solution.

I'm not quite sure what the path forward is. Nicolas, do you have any thoughts on this?



---

archive/issue_comments_376889.json:
```json
{
    "body": "Hmm, that's indeed a bit delicate. \n\nOne thing that sounds clear to me is that DynkinDiagrams should be immutable objects (once constructed). Which means that inplace relabeling should be invalid. Then it feels silly to be forced to pass an \"inplace=False\".\n\nHow does relabel and isomorphism tests handle immutable graphs?\n\nMaybe the root of the evil is that DynkinDiagrams are not really graphs, and should instead contain a graph in the data structure. That would be a big change though, and also not super convenient to run graph questions on a Dynkin Diagram. Another root of the evil might be that for our various Cartan datum (DynkinDiagrams & the like) which are immutable, we should have used ``ct.relabeled()`` (noun) rather than ``ct.relabel()`` (verb). Again a non trivial thing to change.",
    "created_at": "2019-01-09T17:40:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376889",
    "user": "nthiery"
}
```

Hmm, that's indeed a bit delicate. 

One thing that sounds clear to me is that DynkinDiagrams should be immutable objects (once constructed). Which means that inplace relabeling should be invalid. Then it feels silly to be forced to pass an "inplace=False".

How does relabel and isomorphism tests handle immutable graphs?

Maybe the root of the evil is that DynkinDiagrams are not really graphs, and should instead contain a graph in the data structure. That would be a big change though, and also not super convenient to run graph questions on a Dynkin Diagram. Another root of the evil might be that for our various Cartan datum (DynkinDiagrams & the like) which are immutable, we should have used ``ct.relabeled()`` (noun) rather than ``ct.relabel()`` (verb). Again a non trivial thing to change.



---

archive/issue_comments_376890.json:
```json
{
    "body": "> There is some precedence for `DynkinDiagram` acting like a mutable object, e.g., with its `add_edge` method.\n\nIndeed; but as far as I remember this is always at \"construction time\" when the to be constructed diagram can be built from an existing one by doing some small edits: make a copy, do a couple edits, and then freeze the result forever. We could revisit our Dynkin diagrams to always set them as immutable once constructed.",
    "created_at": "2019-01-09T18:20:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376890",
    "user": "tscrim"
}
```

> There is some precedence for `DynkinDiagram` acting like a mutable object, e.g., with its `add_edge` method.

Indeed; but as far as I remember this is always at "construction time" when the to be constructed diagram can be built from an existing one by doing some small edits: make a copy, do a couple edits, and then freeze the result forever. We could revisit our Dynkin diagrams to always set them as immutable once constructed.



---

archive/issue_comments_376891.json:
```json
{
    "body": "Replying to [comment:7 nthiery]:\n> Hmm, that's indeed a bit delicate. \n> \n> One thing that sounds clear to me is that DynkinDiagrams should be immutable objects (once constructed).\n\nJust curious: why it is clear that dynkin diagrams should be immutable but graphs not? Because that's really what this ticket is about: that graphs and dynkin diagrams behave differently even though the first is a superclass of the second.\n\n> How does relabel and isomorphism tests handle immutable graphs?\n\nIt makes a copy and then relabels that copy in-place.",
    "created_at": "2019-01-10T08:56:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376891",
    "user": "jdemeyer"
}
```

Replying to [comment:7 nthiery]:
> Hmm, that's indeed a bit delicate. 
> 
> One thing that sounds clear to me is that DynkinDiagrams should be immutable objects (once constructed).

Just curious: why it is clear that dynkin diagrams should be immutable but graphs not? Because that's really what this ticket is about: that graphs and dynkin diagrams behave differently even though the first is a superclass of the second.

> How does relabel and isomorphism tests handle immutable graphs?

It makes a copy and then relabels that copy in-place.



---

archive/issue_comments_376892.json:
```json
{
    "body": "> Just curious: why it is clear that dynkin diagrams should be immutable but graphs not? Because that's really what this ticket is about: that graphs and dynkin diagrams behave differently even though the first is a superclass of the second.\n\nMy answer is going to be more art than science :-)\n\nIn most use cases, Dynkin diagram are used to model mathematical objects from which computations will be done. On the other hand, graphs are often used more as a data structure on which algorithm will be run. Also, Dynkin diagrams tend to be small, and the overhead of having to create copies is not an issue. Whereas graphs can be big and you would not want to be forced to do such copies at every step of the execution of an algorithm.\n\nThat's roughly the same situation as for our polynomials which are always immutable, whereas our matrices can be mutable or not depending on the use case.",
    "created_at": "2019-01-10T13:03:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376892",
    "user": "nthiery"
}
```

> Just curious: why it is clear that dynkin diagrams should be immutable but graphs not? Because that's really what this ticket is about: that graphs and dynkin diagrams behave differently even though the first is a superclass of the second.

My answer is going to be more art than science :-)

In most use cases, Dynkin diagram are used to model mathematical objects from which computations will be done. On the other hand, graphs are often used more as a data structure on which algorithm will be run. Also, Dynkin diagrams tend to be small, and the overhead of having to create copies is not an issue. Whereas graphs can be big and you would not want to be forced to do such copies at every step of the execution of an algorithm.

That's roughly the same situation as for our polynomials which are always immutable, whereas our matrices can be mutable or not depending on the use case.



---

archive/issue_comments_376893.json:
```json
{
    "body": "> > How does relabel and isomorphism tests handle immutable graphs?\n> \n> It makes a copy and then relabels that copy in-place.\n\nOk. If our Dynkin diagrams would be flagged as immutable, would this resolve the original issue?\n(up to maybe having to reset the immutable flag)?",
    "created_at": "2019-01-10T13:05:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376893",
    "user": "nthiery"
}
```

> > How does relabel and isomorphism tests handle immutable graphs?
> 
> It makes a copy and then relabels that copy in-place.

Ok. If our Dynkin diagrams would be flagged as immutable, would this resolve the original issue?
(up to maybe having to reset the immutable flag)?



---

archive/issue_comments_376894.json:
```json
{
    "body": "For the record: the main reason that I am reluctant to change the interface for \"relabel\" is that Dynkin diagrams are special case of cartan types: they are in the `CartanType_abstract` class where relabel is defined to not take argument and return a new object. So that change would break that compatibility, and presumably this would break generic code about cartan types.",
    "created_at": "2019-01-10T13:14:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376894",
    "user": "nthiery"
}
```

For the record: the main reason that I am reluctant to change the interface for "relabel" is that Dynkin diagrams are special case of cartan types: they are in the `CartanType_abstract` class where relabel is defined to not take argument and return a new object. So that change would break that compatibility, and presumably this would break generic code about cartan types.



---

archive/issue_comments_376895.json:
```json
{
    "body": "Replying to [comment:11 nthiery]:\n> Ok. If our Dynkin diagrams would be flagged as immutable, would this resolve the original issue?\n\nNo, because the original issue is that generic graph code expects `G.relabel()` to relabel in-place. If they would be immutable, then an exception would be raised by this disallowed in-place relabelling.",
    "created_at": "2019-01-10T13:36:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376895",
    "user": "jdemeyer"
}
```

Replying to [comment:11 nthiery]:
> Ok. If our Dynkin diagrams would be flagged as immutable, would this resolve the original issue?

No, because the original issue is that generic graph code expects `G.relabel()` to relabel in-place. If they would be immutable, then an exception would be raised by this disallowed in-place relabelling.



---

archive/issue_comments_376896.json:
```json
{
    "body": "Replying to [comment:12 nthiery]:\n> For the record: the main reason that I am reluctant to change the interface for \"relabel\" is that Dynkin diagrams are special case of cartan types: they are in the `CartanType_abstract` class where relabel is defined to not take argument and return a new object.\n\nI see what you mean: we have\n\n```\nclass DynkinDiagram_class(DiGraph, CartanType_abstract)\n```\n\nwhere both subclasses (`DiGraph` and `CartanType_abstract`) have a `relabel()` method which happens to be incompatible.",
    "created_at": "2019-01-10T14:20:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376896",
    "user": "jdemeyer"
}
```

Replying to [comment:12 nthiery]:
> For the record: the main reason that I am reluctant to change the interface for "relabel" is that Dynkin diagrams are special case of cartan types: they are in the `CartanType_abstract` class where relabel is defined to not take argument and return a new object.

I see what you mean: we have

```
class DynkinDiagram_class(DiGraph, CartanType_abstract)
```

where both subclasses (`DiGraph` and `CartanType_abstract`) have a `relabel()` method which happens to be incompatible.



---

archive/issue_comments_376897.json:
```json
{
    "body": "I did a search of `relabel()` methods on various combinatorial objects. There are various behaviours:\n\n**A. in-place by default, allowing not in-place**\n\n1. cluster algebra quivers\n\n2. incidence structures\n\n3. graphs (various classes)\n\n**B1. not in-place by default, allowing in-place**\n\n1. Dynkin diagrams\n\n**B2. always not in-place**\n\n1. constellations\n\n2. posets\n\n3. anything else involving root systems (various classes)\n\n4. matroids\n\nI don't know what to conclude from this...",
    "created_at": "2019-01-10T14:45:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376897",
    "user": "jdemeyer"
}
```

I did a search of `relabel()` methods on various combinatorial objects. There are various behaviours:

**A. in-place by default, allowing not in-place**

1. cluster algebra quivers

2. incidence structures

3. graphs (various classes)

**B1. not in-place by default, allowing in-place**

1. Dynkin diagrams

**B2. always not in-place**

1. constellations

2. posets

3. anything else involving root systems (various classes)

4. matroids

I don't know what to conclude from this...



---

archive/issue_comments_376898.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-11T08:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376898",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_376899.json:
```json
{
    "body": "Replying to [comment:4 tscrim]:\n> So 1 and 2 are good with me, but I think 3 needs to be reconsidered.\n\nOK, I reverted changes to 3. If certain `relabel()` calls fail, we'll just need to fix them.",
    "created_at": "2019-01-11T08:36:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376899",
    "user": "jdemeyer"
}
```

Replying to [comment:4 tscrim]:
> So 1 and 2 are good with me, but I think 3 needs to be reconsidered.

OK, I reverted changes to 3. If certain `relabel()` calls fail, we'll just need to fix them.



---

archive/issue_comments_376900.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-11T10:28:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376900",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_376901.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-13T17:53:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376901",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_376902.json:
```json
{
    "body": "Thank you. Sorry for being problematic with this.",
    "created_at": "2019-01-13T17:53:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376902",
    "user": "tscrim"
}
```

Thank you. Sorry for being problematic with this.



---

archive/issue_comments_376903.json:
```json
{
    "body": "Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.",
    "created_at": "2019-01-15T18:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376903",
    "user": "embray"
}
```

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.



---

archive/issue_comments_376904.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-01-24T18:17:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26796#issuecomment-376904",
    "user": "vbraun"
}
```

Resolution: fixed
