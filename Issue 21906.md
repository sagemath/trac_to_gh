# Issue 21906: failing doctests with optional package database_jones_numfield (2)

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2017-01-06 10:25:16

CC:  chapoton vbraun

On 32-bit:

```
sage -t --long src/sage/databases/jones.py
**********************************************************************
File "src/sage/databases/jones.py", line 168, in sage.databases.jones.JonesDatabase.unramified_outside
Failed example:
    J.unramified_outside([101,109]) # optional - database_jones_numfield
Expected:
    [Number Field in a with defining polynomial x - 1,
     Number Field in a with defining polynomial x^2 - 101,
     Number Field in a with defining polynomial x^2 - 109,
     Number Field in a with defining polynomial x^3 - x^2 - 36*x + 4,
     Number Field in a with defining polynomial x^4 - x^3 + 13*x^2 - 19*x + 361,
     Number Field in a with defining polynomial x^4 - x^3 + 14*x^2 + 34*x + 393,
     Number Field in a with defining polynomial x^5 + x^4 - 6*x^3 - x^2 + 18*x + 4,
     Number Field in a with defining polynomial x^5 + 2*x^4 + 7*x^3 + 4*x^2 + 11*x - 6,
     Number Field in a with defining polynomial x^5 - x^4 - 40*x^3 - 93*x^2 - 21*x + 17]
Got:
    [Number Field in a with defining polynomial x - 1,
     Number Field in a with defining polynomial x^2 - 101,
     Number Field in a with defining polynomial x^2 - 109,
     Number Field in a with defining polynomial x^3 - x^2 - 36*x + 4,
     Number Field in a with defining polynomial x^4 - x^3 + 13*x^2 - 19*x + 361,
     Number Field in a with defining polynomial x^4 - x^3 + 14*x^2 + 34*x + 393,
     Number Field in a with defining polynomial x^5 + 2*x^4 + 7*x^3 + 4*x^2 + 11*x - 6,
     Number Field in a with defining polynomial x^5 + x^4 - 6*x^3 - x^2 + 18*x + 4,
     Number Field in a with defining polynomial x^5 - x^4 - 40*x^3 - 93*x^2 - 21*x + 17]
**********************************************************************
```



---

Comment by chapoton created at 2017-01-06 10:28:12

yes, indeed. I thought this was solved. But apparently sorting number fields is still not deterministic


---

Comment by jdemeyer created at 2017-01-06 10:43:33

One can easily see that the sort is not deterministic if both the degree and the discriminant of two fields are equal. And that is what happens in this case. We can make the sort completely deterministic by also sorting by the polynomial (which are ordered first by degree and then lexicographically).


---

Comment by jdemeyer created at 2017-01-06 10:53:36

New commits:


---

Comment by jdemeyer created at 2017-01-06 10:53:36

Changing status from new to needs_review.


---

Comment by chapoton created at 2017-01-06 14:35:01

Would you please let arando run on that ticket, by calling it from an ipython session ?


---

Comment by jdemeyer created at 2017-01-06 14:42:55

Replying to [comment:7 chapoton]:
> Would you please let arando run on that ticket, by calling it from an ipython session ?

I don't think there is much point. It should be clear from the code that the sorting is now completely deterministic.


---

Comment by chapoton created at 2017-01-06 14:44:09

That would be to check that the doctests of jones will pass..


---

Comment by jdemeyer created at 2017-01-06 18:22:40

I ran tests on arando (without involving the patchbot):

```
Running doctests with ID 2017-01-06-18-17-18-8e454854.
Git branch: HEAD
Using --optional=atlas,cbc,database_jones_numfield,database_pari,gdb,mpir,python2,sage
Doctesting 2 files using 4 threads.
sage -t --long --warn-long 68.7 src/sage/databases/jones.py
    [22 tests, 6.48 s]
sage -t --long --warn-long 68.7 src/doc/en/constructions/number_fields.rst
    [37 tests, 9.11 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 9.3 seconds
    cpu time: 3.9 seconds
    cumulative wall time: 15.6 seconds
```



---

Comment by chapoton created at 2017-01-06 19:40:42

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2017-01-06 19:40:42

ok, thanks. Good to go.


---

Comment by jdemeyer created at 2017-01-07 15:22:52

Volker: given that you need to merge #22037 in 7.5 anyway, would you consider merging this one too? It would be nice to have no optional doctest failures in a released version.


---

Comment by jdemeyer created at 2017-01-07 15:22:52

Changing priority from critical to blocker.


---

Comment by jdemeyer created at 2017-01-07 15:23:22

Volker: given that you need to merge #22037 in 7.5 anyway, would you consider merging this one too? It would be nice to have no optional doctest failures in a released version.


---

Comment by vbraun created at 2017-01-08 00:54:37

Resolution: fixed
