# Issue 15979: Improve PEP8 compliance: replace "== None" by "is None"

Issue created by migration from https://trac.sagemath.org/ticket/16216

Original creator: wluebbe

Original creation time: 2014-04-23 12:28:28

CC:  tscrim

Keywords: pep8

To cite from [PEP8](http://legacy.python.org/dev/peps/pep-0008/):


Comparisons to singletons like None should always be done with is or is not, never the equality operators.

This ticket is also related to a promise in ticket:15984.


---

Comment by wluebbe created at 2014-04-24 05:24:44

Hi Travis, these are the changes you suggested in ticket:15984.


Would you like to review this ticket?
----
New commits:


---

Comment by wluebbe created at 2014-04-24 05:24:44

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2014-04-24 07:58:07

Why not provide a script here? It should be possible to apply it just before the stable release.

With a simple grep I found many more instances in

- sage/coding/code_bounds.py
- sage/schemes/toric/variety.py
- sage/schemes/toric/chow_group.py
- sage/schemes/projective/projective_morphism.py
- sage/schemes/generic/divisor_group.py
- sage/schemes/elliptic_curves/weierstrass_morphism.py
- sage/schemes/elliptic_curves/ell_finite_field.py
- sage/schemes/elliptic_curves/ell_generic.py
- sage/geometry/toric_lattice.py
- sage/geometry/triangulation/point_configuration.py
- sage/geometry/polyhedron/misc.py
- sage/geometry/polyhedron/cdd_file_format.py
- sage/geometry/polyhedron/face.py
- sage/numerical/optimize.py
- sage/calculus/desolvers.py
- sage/sandpiles/sandpile.py
- sage/graphs/generic_graph.py
- sage/graphs/graph_coloring.py
- sage/graphs/graph.py
- sage/modular/modform/ambient_eps.py
- sage/categories/coxeter_groups.py
- sage/matrix/constructor.py
- sage/quadratic_forms/quadratic_form__ternary_Tornaria.py
- sage/interfaces/singular.py
- sage/combinat/root_system/root_lattice_realizations.py
- sage/combinat/sf/ns_macdonald.py
- sage/combinat/tableau_tuple.py
- sage/combinat/composition_tableau.py
- sage/combinat/k_tableau.py
- sage/combinat/affine_permutation.py
- sage/ext/gen_interpreters.py


---

Comment by vdelecroix created at 2014-04-24 08:19:49

I guess something like the following would do the job (trickier than what I thought... I edited twice my answer)

```/usr/bin/env bash

for f in $(find . -name "*py");
do
    echo "processing $f"
    sed -i -e's/==\ *None$/is None/g' $f
    sed -i -e's/==\ *None\([ :)]\)/is None\1/g' $f
    sed -i -e's/!=\ *None$/is not None/g' $f
    sed -i -e's/!=\ *None\([ :)]\)/is not None\1/g' $f
done
```



---

Comment by wluebbe created at 2014-04-24 09:12:36

I did it with a small Python script, but instead of "\w*" I had "\w+"  :-(


Wait a minute ... ;-)


---

Comment by vdelecroix created at 2014-04-24 09:16:30

In [that thread](https://groups.google.com/forum/#!topic/sage-devel/SN93zx3YnAA) on sage-devel I asked the question of whether we can provide a script rather than a branch... it would make more sense here.

Vincent


---

Comment by vdelecroix created at 2014-04-24 09:28:56

See also [this thread](https://groups.google.com/forum/#!msg/sage-devel/r-85whQZGhY/KkUkGMzg7tgJ)


---

Comment by leif created at 2014-04-24 10:11:55

Such scripts should ideally be applied by the release manager right before doing a new stable release.  Not sure whether Volker is aware of this ticket.

For new code / changes, it's up to the reviewers to check no new instances get introduced. ;-)


---

Comment by vdelecroix created at 2014-04-24 10:42:39

Thanks Leif. I will ask Volker directly if he does not answer on sage-devel.

The script was not the good one (because of things like "my_variable!=None"), new try

```/usr/bin/env bash

for f in $(find . -name "*py");
do
    echo "processing $f"
    sed -i -e's/\ *==\ *None$/ is None/g' $f
    sed -i -e's/\ *==\ *None\([ :)]\)/ is None\1/g' $f
    sed -i -e's/\ *!=\ *None$/ is not None/g' $f
    sed -i -e's/\ *!=\ *None\([ :)]\)/ is not None\1/g' $f
done
```

I applied it to Sage source code, and obtain 505 occurrences... and Sage even starts after that!!


---

Comment by wluebbe created at 2014-04-24 10:47:57

There are several competing / overlapping tools that could support such a "project". 
Here are some links:
* [Pylint](http://www.pylint.org/) and [in PIP](https://pypi.python.org/pypi/pylint/1.2.0)
* [pep8](http://pep8.readthedocs.org/en/latest/) and [in PIP](https://pypi.python.org/pypi/pep8)
* [flake8](https://bitbucket.org/tarek/flake8/wiki/Home) and [in PIP](https://pypi.python.org/pypi/flake8)
* [pyflakes](https://github.com/pyflakes/pyflakes/) and [in PIP](https://pypi.python.org/pypi/pyflakes/0.8.1)
* [frosted](https://github.com/timothycrosley/frosted) and [in PIP](https://pypi.python.org/pypi/frosted)

The cross tool mailing list is [code-quality](https://mail.python.org/mailman/listinfo/code-quality).

These are the Python guidelines:
* [PEP8 Style Guide for Python Code](http://legacy.python.org/dev/peps/pep-0008/)
* [PEP257 Docstring Conventions](http://legacy.python.org/dev/peps/pep-0257/)
* [PEP7 Style Guide for C Code](http://legacy.python.org/dev/peps/pep-0007/)

I had a quick look at them - there is no obvious BEST one.
But it would certainly be worthwhile to select / combine / customize them for use with Sage.


---

Comment by git created at 2014-04-24 10:51:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2014-04-24 10:57:17

1) The script can be done with only one call to sed and is much faster that way (took less than 10 secs on my computer)

```/usr/bin/env bash

for f in $(find . -name "*py");
do
    echo "processing $f"
    sed -i -e's/\ *==\ *None$/ is None/g' \
           -e's/\ *==\ *None\([ :)]\)/ is None\1/g' \
           -e's/\ *!=\ *None$/ is not None/g' \
           -e's/\ *!=\ *None\([ :)]\)/ is not None\1/g' $f
done
```


2) There are few things to fix by hand. For example, some occurrences appear in the docstrings and the script did bad to them (src/sage/ext/gen_interpreters.py, src/sage/geometry/polyhedron/misc.py, ...)

For Wilfried:

3) It is not a good idea to provide a git branch (it will certainly create plenty of conflicts). The best would be to apply the script just before the stable release.

4) If you used a script different from mine, it would be nice that you provide it!


---

Comment by wluebbe created at 2014-04-24 10:59:24

The update also includes some pyx modules. And a few py modules not in your list.

The regexp now looks like

```
  c_pat_1 = re.compile(r"""\s? == \s* None \b""", re.VERBOSE)
  contents_1, n1 = re.subn(c_pat_1, " is None", contents_0)
  c_pat_2 = re.compile(r"""\s? != \s* None \b""", re.VERBOSE)
  new_contents, n2 = re.subn(c_pat_2, " is not None", contents_1)
```



---

Comment by wluebbe created at 2014-04-24 11:21:43

Replying to [comment:11 vdelecroix]:
> 3) It is not a good idea to provide a git branch (it will certainly create plenty of conflicts). The best would be to apply the script just before the stable release.
I would agree but at least once you have to clean up the existing stuff. - And the conflicts should be manageable.




> 4) If you used a script different from mine, it would be nice that you provide it!
I am more familiar with Python than with the classic Un*x tools like grep and sed :-/


I attached my quick and dirty Python script.


---

Comment by leif created at 2014-04-24 11:38:35

There's also at least one occurrence in `.rst` source (as opposed to generated) files:


```
src/doc/en/thematic_tutorials/lie/crystals.rst:421:    sage: v.f(1).f(1) == None
```



---

Comment by git created at 2014-04-24 13:25:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by wluebbe created at 2014-04-24 13:26:59

This was also the only `.rst` I could find.


---

Comment by wluebbe created at 2014-04-24 13:42:55

Update for .rst and to exclude selected modules


---

Attachment

Hi,

Thanks Wilfried for providing your script. Your regexps look much nicer than mine!

The syntax for regexp in sed is (almost) the same as in Python! You can write what you did in sed as

```
sed -e's/\s\?==\s*None\b/ is None/g' \
    -e's/\s\?!=\s*None\b/ is not None/g' my_file.py
```


Instead of the for loop, it is faster and cleaner to use xargs. The following one-line command takes care of py and pyx files.

```
find -regex ".*pyx?" | xargs sed -i        \
        -e's/\s\?==\s*None\b/ is None/g'   \
        -e's/\s\?!=\s*None\b/ is not None/g'
```

With the command above I got 637 instances on 6.2.rc0.

At the very last, there are two possibilities to avoid occurrence of "bla == None" in the future (see Volker's answer in [that thread](https://groups.google.com/forum/#!topic/sage-devel/SN93zx3YnAA)):
 - provide a pre-commit hook for git
 - modify the "sage -b" command

Vincent

PS: sed is not Unix but [GNU](http://www.gnu.org/)!


---

Comment by wluebbe created at 2014-04-24 14:03:24

Thanks Vincent, I guess I have to learn these tools :-))

But I am also still learning git, vim, Linux ... and often even Python. Not to mention Sage!!


---

Comment by tscrim created at 2014-04-24 14:08:22

Also there is no difference in conflicts with a branch that gets merged into develop versus a script that fixes these things right before release. However it would be nice to have such a script in order to make reviews easier (mostly for reviewers who are unaware of what we're trying to do) and so we don't (re)introduce non-conformance.

Let me know if you need me to review anything (it seems both of you [Vincent and Wilfried] are taking care of it).


---

Comment by leif created at 2014-04-24 17:51:11

Replying to [comment:17 vdelecroix]:
> Instead of the for loop, it is faster and cleaner to use xargs. The following one-line command takes care of py and pyx files.
> {{{
> find -regex ".*pyx?" | xargs sed -i        \
>         -e's/\s\?==\s*None\b/ is None/g'   \
>         -e's/\s\?!=\s*None\b/ is not None/g'
> }}}

`-regex` is not portable; one should use `-name \*.py -o -name \*.pyx` [`-o -name \*.rst`] instead.  (And you can also use `sed ... $(find ...)`, or -- preferably -- `find ... -exec sed ...`, because the latter reduces the required size of the environment, i.e. `argv`.)

`sed -i ...` is (unfortunately) also not portable, nor  is `\s`, and IIRC neither `\b` nor `\?`.




> PS: sed is not Unix but [GNU](http://www.gnu.org/)!

`sed` is UNIX from the very beginning, while *G*NU's *N*ot *U*nix! ;-)


---

Comment by leif created at 2014-04-24 17:58:21

Replying to [comment:19 tscrim]:
> Also there is no difference in conflicts with a branch that gets merged into develop versus a script that fixes these things right before release.

Well, in application, there is.

Also, I'd apply it last before preparing a _stable_ release, since developers will have to rebase their pending patches afterwards anyway.  (Of course the _number_ of potential conflicts with work in progress they'll face doesn't really change though.)


---

Comment by wluebbe created at 2014-04-24 18:21:46

This ticket now has 
* 177 files changed, 515 insertions, 515 deletions
but ticket:15990 had
* 503 files changed, 3138 insertions, 3170 deletions
On the way there were some merge conflict, but nothing serious.


Therefore I'm not afraid about conflicts (for this ticket).


---

Comment by vdelecroix created at 2014-04-25 08:41:20

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2014-04-25 08:41:20

Hi,

1) As I already told you, the substitutions made bad things to the documentation. Hopefully, in very few places. For examples
- `/src/sage/ext/gen_interpreters.py`: we had "so len==None is different than len==1" and now it is "so len is None is different than len==1".  The new sentence is much harder to read.
- `/src/sage/coding/code_bounds.py`: in a comment we had "algorithm==None or algorithm="gap"" would be better to have "algorithm=None or algorithm="gap" (instead of the is None here).
- etc

2) You start removing unnecessary parenthesis. First of all it is not the job of that ticket. Secondly, one can arguably says that code is more readable with more parenthesis. So revert all those changes. If you want to remove parenthesis (which I think is a bad idea in general) then open a discussion on sage-devel and then a ticket if a consensus is reached.

Vincent


---

Comment by leif created at 2014-04-25 12:45:00

Replying to [comment:23 vdelecroix]:
> 1) As I already told you, the substitutions made bad things to the documentation. Hopefully, in very few places.

Yep, at least where "is None" isn't typeset as code.

And I also wouldn't touch most of the _comments_.




> 2) You start removing unnecessary parenthesis. First of all it is not the job of that ticket. Secondly, one can arguably says that code is more readable with more parenthesis. So revert all those changes. If you want to remove parenthesis (which I think is a bad idea in general) then open a discussion on sage-devel and then a ticket if a consensus is reached.

I'm in general ok with changing the "C style" `if (cond):` and `while (cond):` to usual Python syntax (without _outer_ parentheses), but I agree that this should be done on another ticket, especially since currently only _some_ instances (namely those in or near the context of other changes) get "normalized".

There are also a couple of conditions where I'd personally change _the order_ of evaluation, of the form `if <expensive_test> <and|or> <cheap_test>:`,  but that's also out of the scope of this ticket.


---

Comment by wluebbe created at 2014-05-07 09:39:40

Changing status from needs_work to needs_review.


---

Comment by wluebbe created at 2014-05-07 09:39:40

I pushed a fresh start based on Sage 6.2.

From commit message of the manual changes:

```
    * changed "not xxx is None" to "xxx is not None" (where appropriate)
    * reverted changes in docstring text
      - usually did not revert changes to doctest *code*
      - but reverted changes to expected results (if required)
    * (usually) did not revert changes to *code* in comments
    
    Always tried to apply good judgement - but refrained from changes
    unrelated to the subject "is None".
```

----
New commits:


---

Comment by git created at 2014-05-16 10:41:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2014-05-20 06:44:11

I've eyeballed it all and patchbot is happy, too. So, if you remove that unrelated change in combinat/backtrack you can set positive.


---

Comment by wluebbe created at 2014-05-20 09:12:28

That //unrelated change in combinat/backtrack// resulted from resolving the merge conflict (comment 27). So it is not mine ;-) and I am reluctant removing it.

Positive review anyway?


---

Comment by rws created at 2014-05-20 09:39:57

But develop doesn't have this code so you introduced (or re-introduced) it.


---

Comment by rws created at 2014-05-20 09:53:04

If you don't know the best way to check it: `git diff develop` when in your up-to-date branch should show only your own changes.


---

Comment by git created at 2014-05-20 13:07:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by wluebbe created at 2014-05-20 13:11:43

Changing status from needs_review to positive_review.


---

Comment by wluebbe created at 2014-05-20 13:11:43

Thanks Ralf, for the help! The merge error is fixed.

I set to positive as you suggested in comment 28.


---

Comment by vbraun created at 2014-05-21 15:33:39

Resolution: fixed
