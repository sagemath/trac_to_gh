# Issue 23474: sage-env: do not depend on matplotlib version number

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2017-08-25 10:04:57

CC:  embray

So we really to know the matplotlib version number in `sage-env`?

```sh
# Use a matplotlib config directory specific to Sage and specific to
# the version number of matplotlib, by setting the environment
# variable MPLCONFIGDIR. Note that we can't find the version number by
# importing matplotlib, because that could create matplotlib's standard
# config directory. So we use pkg_resources.
"$SAGE_LOCAL/bin/python" -c 'import pkg_resources; pkg_resources.get_distribution("matplotlib").version' 2>/dev/null
if [ $? -eq 0 ]; then
    MPLVERSION=`"$SAGE_LOCAL/bin/python" -c 'import pkg_resources; print (pkg_resources.get_distribution("matplotlib").version)'`
    MPLCONFIGDIR="$DOT_SAGE/matplotlib-$MPLVERSION"
    export MPLCONFIGDIR
    # The directory is created when Sage starts (see sage.misc.misc).
fi
```


Instead, we could just hardcode a version number, analogous to what we do for Jupyter:

```sh
if [ -z "$IPYTHONDIR" ]; then
    # We hardcode a version number in the directory name. The idea is
    # that we keep using the same version number as long as that is
    # possible. Only when some future IPython version really requires
    # a new structure for the $IPYTHONDIR should this version number be
    # changed to the new IPython version.
    export IPYTHONDIR="$DOT_SAGE/ipython-5.0.0"
fi

if [ -z "$JUPYTER_CONFIG_DIR" ]; then
    # We hardcode a version number in the directory name. The idea is
    # that we keep using the same version number as long as that is
    # possible. Only when some future Jupyter version really requires
    # a new structure for the $JUPYTER_CONFIG_DIR should this version
    # number be changed to the new jupyter_core version.
    export JUPYTER_CONFIG_DIR="$DOT_SAGE/jupyter-4.1"
fi
```



---

Comment by jdemeyer created at 2017-08-25 10:10:34

New commits:


---

Comment by jdemeyer created at 2017-08-25 10:10:34

Changing status from new to needs_review.


---

Comment by dimpase created at 2017-08-25 10:14:14

Shouldn't this kind of hardcoding be delegated to `./configure` ?


---

Comment by embray created at 2017-08-25 10:18:22

That was fast.  I'm sort of inclined to agree that the config dir really doesn't need to be updated unless an explicit need to do so is found.

An alternative approach I had in mind was to set the paths to these config files in a separate file that can be updated when upgrading the relevant packages.  This would be a good use case for #22652, which I still think would be a good idea, though it hasn't been a priority to pursue.  With #22652, individual spkgs could provide small shell snippets that are sourced at startup time.  That keeps configuration for individual software packages closer to that package, rather than scattered about arbitrarily.
----
New commits:


---

Comment by embray created at 2017-08-25 10:18:45

Not sure why that happened.


---

Comment by jdemeyer created at 2017-08-25 10:25:53

Replying to [comment:4 dimpase]:
> Shouldn't this kind of hardcoding be delegated to `./configure` ?

No, how would `./configure` know which version number to hardcode?


---

Comment by fbissey created at 2017-08-25 10:30:27

But #22652 is probably the right way to go on the long term. Not that I should really care.


---

Comment by embray created at 2017-08-25 10:30:56

Changing status from needs_review to positive_review.


---

Comment by embray created at 2017-08-25 10:30:56

I think this makes sense to me, especially since we're already doing the same for Jupyter.

I'd still like a more general approach like I suggested above, but that can happen separately since this will give speedup times to sage startup now.


---

Comment by jdemeyer created at 2017-08-25 10:35:17

I'm not convinced to use #22652 to change the directory every time. Usually, it is considered a feature that a configuration directory remains in the same place.

That was the reason for hardcoding the Jupyter directories: I have some custom configuration and it's not fun if you need to copy it every time that Jupyter is upgraded in Sage.


---

Comment by dimpase created at 2017-08-25 10:37:03

Replying to [comment:7 jdemeyer]:
> Replying to [comment:4 dimpase]:
> > Shouldn't this kind of hardcoding be delegated to `./configure` ?
> 
> No, how would `./configure` know which version number to hardcode?

trivially: by looking at `build/pkgs/*/package-version.txt`


---

Comment by fbissey created at 2017-08-25 10:39:58

If I remember well, the version hardcoding is meant to change when incompatible changes are made. #22652 just give the package the responsibility to increment the number, it can mimic the current behavior and only change the number at breaking point.


---

Comment by dimpase created at 2017-08-25 10:43:25

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2017-08-25 10:43:25

by right, these kinds of changes must be documented somewhere (in the developer manual, or/and in `SPKG.txt`), otherwise you're building a code spaghetti monster only you know the way around...


---

Comment by jdemeyer created at 2017-08-25 11:51:25

Replying to [comment:11 dimpase]:
> trivially: by looking at `build/pkgs/*/package-version.txt` 

That's exactly what we _do not_ want to do. It's a misfeature to have configuration directories depend on a version number.


---

Comment by embray created at 2017-08-25 11:54:39

Replying to [comment:10 jdemeyer]:
> I'm not convinced to use #22652 to change the directory every time. Usually, it is considered a feature that a configuration directory remains in the same place.

I'm not necessarily saying it should be changed every time.  It _could_ be done that way, and more easily if the config is written, say, by the package's `spkg-install`.  My point here is that it just keeps this configuration closer to the package it's relevant to, making it easier to remember to update its configuration when desired/necessary.


---

Comment by embray created at 2017-08-25 11:55:15

Replying to [comment:12 fbissey]:
> If I remember well, the version hardcoding is meant to change when incompatible changes are made. #22652 just give the package the responsibility to increment the number, it can mimic the current behavior and only change the number at breaking point.

Exactly^


---

Comment by dimpase created at 2017-08-25 12:18:59

Replying to [comment:14 jdemeyer]:
> Replying to [comment:11 dimpase]:
> > trivially: by looking at `build/pkgs/*/package-version.txt` 
> 
> That's exactly what we _do not_ want to do. It's a misfeature to have configuration directories depend on a version number.

Tell me more about advantages of having the same number hardcoded in two different files, come on...

You are perpetuating some old crappy misdesign, not the other way around.


---

Comment by embray created at 2017-08-25 13:05:51

Replying to [comment:17 dimpase]:
> Replying to [comment:14 jdemeyer]:
> > Replying to [comment:11 dimpase]:
> > > trivially: by looking at `build/pkgs/*/package-version.txt` 
> > 
> > That's exactly what we _do not_ want to do. It's a misfeature to have configuration directories depend on a version number.
> 
> Tell me more about advantages of having the same number hardcoded in two different files, come on...
> 
> You are perpetuating some old crappy misdesign, not the other way around.

Jeroen's point is that it's _not_ the same number.  The number in the config directory name is the _last_ version at which the format of the configuration for that package changed in a significantly-enough backwards-incompatible way that a new configuration is needed.

For example "jupyter-1.5.0" means "configuration for jupyter-1.5.0 and above".  If jupyter 3.0 comes along and changes the layout of its config directory then we add "jupyter-3.0" for config of jupyter 3.0 and above.

This is as opposed to updating the config dir every time a package is updated (especially onerous when we're talking micro version updates that only contain bug fixes).  The config dirs do not track one-to-one with the version of the package.


---

Comment by dimpase created at 2017-08-25 13:43:13

Replying to [comment:18 embray]:
> Replying to [comment:17 dimpase]:
> > Replying to [comment:14 jdemeyer]:
> > > Replying to [comment:11 dimpase]:
> > > > trivially: by looking at `build/pkgs/*/package-version.txt` 
> > > 
> > > That's exactly what we _do not_ want to do. It's a misfeature to have configuration directories depend on a version number.
> > 
> > Tell me more about advantages of having the same number hardcoded in two different files, come on...
> > 
> > You are perpetuating some old crappy misdesign, not the other way around.
> 
> Jeroen's point is that it's _not_ the same number.  The number in the config directory name is the _last_ version at which the format of the configuration for that package changed in a significantly-enough backwards-incompatible way that a new configuration is needed.
> 
> For example "jupyter-1.5.0" means "configuration for jupyter-1.5.0 and above".  If jupyter 3.0 comes along and changes the layout of its config directory then we add "jupyter-3.0" for config of jupyter 3.0 and above.
> 
> This is as opposed to updating the config dir every time a package is updated (especially onerous when we're talking micro version updates that only contain bug fixes).  The config dirs do not track one-to-one with the version of the package.

This is called madness in my book. I would understand these directory names being independent of the minor version, but having in `~/.sage/blah-1.1.1` configuration for `blah-2.3.4` is crazy.


---

Comment by jdemeyer created at 2017-08-25 13:53:00

Replying to [comment:19 dimpase]:
> having in `~/.sage/blah-1.1.1` configuration for `blah-2.3.4` is crazy.

You should consider the `1.1.1` to be essentially an arbitrary string. One could go with `~/.sage/blah-A` if you want. The reason that I picked `1.5.1` is because that is what is currently used, so the directory wouldn't be changed.


---

Comment by embray created at 2017-08-25 14:13:57

Let's put it this way: At the very least this ticket is just treating matplotlib's config the way we were already treating jupyter/ipython config, so if nothing else it's consistent.  I think it makes sense to name the config dir after the lowest applicable version supported by Sage, but you could just as well name them ".0", ".1", ".2", etc.  This would be a debate for a separate ticket.


---

Comment by git created at 2017-08-25 14:28:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-08-25 14:53:26

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2017-08-25 14:58:22

OK, thanks, this starts making sense to me. Now it remains to check that the docs build...


---

Comment by chapoton created at 2017-08-26 19:29:42

typo "where the configuation"


---

Comment by git created at 2017-08-28 10:53:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-09-01 12:33:59

*ping*


---

Comment by embray created at 2017-09-01 12:41:15

I was waiting to see if Dima had anything more to say about this--it has positive review from me otherwise.


---

Comment by dimpase created at 2017-09-01 12:44:31

just a second, I'll see if it works on top of #23023


---

Comment by dimpase created at 2017-09-01 13:08:33

OK, but how about a link to https://matplotlib.org/faq/environment_variables_faq.html#envvar-MPLCONFIGDIR
in the place where you mention `MPLCONFIGDIR` in the docs?


---

Comment by git created at 2017-09-03 08:20:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2017-09-03 14:26:11

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2017-09-03 14:26:11

OK, thanks.


---

Comment by vbraun created at 2017-09-10 11:57:25

Resolution: fixed
