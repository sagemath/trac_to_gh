# Issue 29866: configure finds zlib but pillow does not

Issue created by migration from https://trac.sagemath.org/ticket/30103

Original creator: mkoeppe

Original creation time: 2020-07-10 16:47:52

CC:  dimpase mjo jhpalmieri

https://groups.google.com/d/msg/sage-support/vS2CZd_kEHA/f1VaXUQhAQAJ

In complete analogy to 
#29448 (configure finds libpng but matplotlib does not)


See also:
 - #28906 generate libpng.pc, zlib.pc if needed


---

Comment by dimpase created at 2020-07-11 10:57:08

I don't see how this is in analogy to #29448

With zlib we don't use pkg-config - so something really goes bad in pillow.


---

Comment by mjo created at 2020-07-11 11:38:49

Pillow's build system is a half-baked reimplementation of autotools in python. It tries and fails to guess the system library location, whereas `AC_CHECK_LIB` actually compiles and links something, so it doesn't need to guess.

The first thing we should do is upgrade to the latest version of pillow so that we aren't completely wasting our time. Then the best solution would be for them to ~~adopt a real build system~~ reimplement `AC_CHECK_LIB` in their python script. Trying to fix the list of guessed locations isn't a good long term solution because it's guaranteed to find the wrong libraries if you check e.g. `/usr/lib` before `/usr/lib64` on a multilib system. All you really want to know is if you can compile something with `-lz`, so autotools has the right idea.


---

Comment by mkoeppe created at 2020-07-11 18:04:02

+1 on upgrading pillow first.


---

Comment by mkoeppe created at 2020-07-11 18:05:23

Replying to [comment:2 dimpase]:
> I don't see how this is in analogy to #29448
> 
> With zlib we don't use pkg-config - so something really goes bad in pillow.

Well, pillow uses pkg-config to find zlib, as you can see in the bug report:

```
[pillow-5.3.0.p0] Looking for `zlib` using pkg-config.
[pillow-5.3.0.p0] Looking for zlib
```



---

Comment by mkoeppe created at 2020-07-11 22:26:22

New commits:


---

Comment by mkoeppe created at 2020-07-11 22:33:34

7.2.0 still uses the same approach for finding its libraries.

Since it checks each library using pkgconfig first, Dima's approach of generating fake pkgconfig files (from the abandoned ticket #28906) could be a solution that would not require patching pillow.


---

Comment by mjo created at 2020-07-12 11:55:23

I wonder why pillow's pkg-config isn't finding zlib in this case. I think the reporter is using Gentoo, and we install zlib.pc. In fact everyone should be installing zlib.pc since 2012 or so.


---

Comment by dimpase created at 2020-07-12 12:00:10

probably his PKG_path - whatever it is called, ismiconfigured.


---

Comment by mkoeppe created at 2020-07-21 05:40:58

Moved the pillow upgrade to #30185


---

Comment by mkoeppe created at 2020-07-21 05:41:27

Changing priority from major to minor.


---

Comment by mkoeppe created at 2021-05-10 17:42:09

Moving to 9.4, as 9.3 has been released.
