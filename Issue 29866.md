# Issue 29866: configure finds zlib but pillow does not

archive/issues_029866.json:
```json
{
    "body": "CC:  @dimpase @orlitzky @jhpalmieri\n\nhttps://groups.google.com/d/msg/sage-support/vS2CZd_kEHA/f1VaXUQhAQAJ\n\nIn complete analogy to \n#29448 (configure finds libpng but matplotlib does not)\n\n\nSee also:\n- #28906 generate libpng.pc, zlib.pc if needed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30103\n\n",
    "created_at": "2020-07-10T16:47:52Z",
    "labels": [
        "component: build: configure",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "configure finds zlib but pillow does not",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29866",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @dimpase @orlitzky @jhpalmieri

https://groups.google.com/d/msg/sage-support/vS2CZd_kEHA/f1VaXUQhAQAJ

In complete analogy to 
#29448 (configure finds libpng but matplotlib does not)


See also:
- #28906 generate libpng.pc, zlib.pc if needed

Issue created by migration from https://trac.sagemath.org/ticket/30103





---

archive/issue_comments_423749.json:
```json
{
    "body": "I don't see how this is in analogy to #29448\n\nWith zlib we don't use pkg-config - so something really goes bad in pillow.",
    "created_at": "2020-07-11T10:57:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-423749",
    "user": "https://github.com/dimpase"
}
```

I don't see how this is in analogy to #29448

With zlib we don't use pkg-config - so something really goes bad in pillow.



---

archive/issue_comments_423750.json:
```json
{
    "body": "Pillow's build system is a half-baked reimplementation of autotools in python. It tries and fails to guess the system library location, whereas `AC_CHECK_LIB` actually compiles and links something, so it doesn't need to guess.\n\nThe first thing we should do is upgrade to the latest version of pillow so that we aren't completely wasting our time. Then the best solution would be for them to ~~adopt a real build system~~ reimplement `AC_CHECK_LIB` in their python script. Trying to fix the list of guessed locations isn't a good long term solution because it's guaranteed to find the wrong libraries if you check e.g. `/usr/lib` before `/usr/lib64` on a multilib system. All you really want to know is if you can compile something with `-lz`, so autotools has the right idea.",
    "created_at": "2020-07-11T11:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-423750",
    "user": "https://github.com/orlitzky"
}
```

Pillow's build system is a half-baked reimplementation of autotools in python. It tries and fails to guess the system library location, whereas `AC_CHECK_LIB` actually compiles and links something, so it doesn't need to guess.

The first thing we should do is upgrade to the latest version of pillow so that we aren't completely wasting our time. Then the best solution would be for them to ~~adopt a real build system~~ reimplement `AC_CHECK_LIB` in their python script. Trying to fix the list of guessed locations isn't a good long term solution because it's guaranteed to find the wrong libraries if you check e.g. `/usr/lib` before `/usr/lib64` on a multilib system. All you really want to know is if you can compile something with `-lz`, so autotools has the right idea.



---

archive/issue_comments_423751.json:
```json
{
    "body": "+1 on upgrading pillow first.",
    "created_at": "2020-07-11T18:04:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-423751",
    "user": "https://github.com/mkoeppe"
}
```

+1 on upgrading pillow first.



---

archive/issue_comments_423752.json:
```json
{
    "body": "Replying to [comment:2 dimpase]:\n> I don't see how this is in analogy to #29448\n> \n> With zlib we don't use pkg-config - so something really goes bad in pillow.\n\n\nWell, pillow uses pkg-config to find zlib, as you can see in the bug report:\n\n```\n[pillow-5.3.0.p0] Looking for `zlib` using pkg-config.\n[pillow-5.3.0.p0] Looking for zlib\n```",
    "created_at": "2020-07-11T18:05:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-423752",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:2 dimpase]:
> I don't see how this is in analogy to #29448
> 
> With zlib we don't use pkg-config - so something really goes bad in pillow.


Well, pillow uses pkg-config to find zlib, as you can see in the bug report:

```
[pillow-5.3.0.p0] Looking for `zlib` using pkg-config.
[pillow-5.3.0.p0] Looking for zlib
```



---

archive/issue_comments_423753.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-07-11T22:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-423753",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_423754.json:
```json
{
    "body": "7.2.0 still uses the same approach for finding its libraries.\n\nSince it checks each library using pkgconfig first, Dima's approach of generating fake pkgconfig files (from the abandoned ticket #28906) could be a solution that would not require patching pillow.",
    "created_at": "2020-07-11T22:33:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-423754",
    "user": "https://github.com/mkoeppe"
}
```

7.2.0 still uses the same approach for finding its libraries.

Since it checks each library using pkgconfig first, Dima's approach of generating fake pkgconfig files (from the abandoned ticket #28906) could be a solution that would not require patching pillow.



---

archive/issue_comments_423755.json:
```json
{
    "body": "I wonder why pillow's pkg-config isn't finding zlib in this case. I think the reporter is using Gentoo, and we install zlib.pc. In fact everyone should be installing zlib.pc since 2012 or so.",
    "created_at": "2020-07-12T11:55:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-423755",
    "user": "https://github.com/orlitzky"
}
```

I wonder why pillow's pkg-config isn't finding zlib in this case. I think the reporter is using Gentoo, and we install zlib.pc. In fact everyone should be installing zlib.pc since 2012 or so.



---

archive/issue_comments_423756.json:
```json
{
    "body": "probably his PKG_path - whatever it is called, ismiconfigured.",
    "created_at": "2020-07-12T12:00:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-423756",
    "user": "https://github.com/dimpase"
}
```

probably his PKG_path - whatever it is called, ismiconfigured.



---

archive/issue_comments_423757.json:
```json
{
    "body": "Moved the pillow upgrade to #30185",
    "created_at": "2020-07-21T05:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-423757",
    "user": "https://github.com/mkoeppe"
}
```

Moved the pillow upgrade to #30185



---

archive/issue_comments_423758.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2020-07-21T05:41:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-423758",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to minor.



---

archive/issue_events_077536.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29866#event-77536"
}
```



---

archive/issue_comments_423759.json:
```json
{
    "body": "Moving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29866#issuecomment-423759",
    "user": "https://github.com/mkoeppe"
}
```

Moving to 9.4, as 9.3 has been released.



---

archive/issue_events_077537.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-05-10T17:42:09Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29866#event-77537"
}
```



---

archive/issue_events_077538.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-05-10T17:42:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29866#event-77538"
}
```



---

archive/issue_events_077539.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29866#event-77539"
}
```



---

archive/issue_events_077540.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29866#event-77540"
}
```



---

archive/issue_events_077541.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T20:12:32Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29866#event-77541"
}
```



---

archive/issue_events_077542.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T20:12:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29866#event-77542"
}
```



---

archive/issue_events_077543.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29866#event-77543"
}
```



---

archive/issue_events_077544.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29866#event-77544"
}
```



---

archive/issue_events_077545.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29866#event-77545"
}
```



---

archive/issue_events_077546.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/29866",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29866#event-77546"
}
```
