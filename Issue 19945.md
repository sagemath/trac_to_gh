# Issue 19945: Automatic doctest for nonpackages

Issue created by migration from https://trac.sagemath.org/ticket/20182

Original creator: klee

Original creation time: 2016-03-09 15:45:46

Many doctests depend on nonpackages (softwares external to Sage) installed and available on the system, such as latex, magma, mathematica, maple, etc. This patch allows to run the optional doctests if the nonpackages are available, when you include "nonpackages" value to the "--optional" tag, as in the following example.

sage -t --optional=nonpackages ./src/sage/repl/rich_output/pretty_print.py

This is a rewrite of #18904.


---

Comment by git created at 2016-03-09 15:49:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2016-03-09 15:53:06

The patch is a draft or a proof of concept.


---

Comment by kcrisman created at 2016-03-09 16:04:29

Don't forget internet - or should that be its own ticket, since it's a different kind of non-package?  One could presumably do some connectivity test and if it failed, _not_ run the internet tests - they should really nearly always be run.


---

Comment by jdemeyer created at 2016-03-09 16:08:10

I don't like the fact that you _explicitly_ need to specify `--optional=nonpackages`. That's almost as much "effort" as writing `--optional=latex,magma,internet`. Also the name "nonpackages" is a bit strange: why is "octave" a nonpackage?

Also, I don't believe that `have_latex()` is a sufficient test to check that `latex` works. You should really run `latex` to be sure. All the other tests actually run the optional program.


---

Comment by klee created at 2016-03-09 16:10:35

The intention is to test the doctests of the form "#optional - xxx" where xxx is not a Sage package. So I think internet is also a "nonpackage" :-)


---

Comment by jdemeyer created at 2016-03-09 16:11:37

Replying to [comment:5 jdemeyer]:
> I don't like the fact that you _explicitly_ need to specify `--optional=nonpackages`.

To be clear, I meant that `nonpackages` should be passed by default if no `--optional` argument is given.


---

Comment by jdemeyer created at 2016-03-09 16:14:31

It would be cool if this would automatically go over all test functions instead of this ugly error-prone code:

```
    if test_latex(): pkgs.append('latex')
    if test_magma(): pkgs.append('magma')
    if test_matlab(): pkgs.append('matlab')     
    if test_mathematica(): pkgs.append('mathematica')  
    if test_macaulay2(): pkgs.append('macaulay2')  
    if test_octave(): pkgs.append('octave')  
    if test_scilab(): pkgs.append('scilab')  
    if test_maple(): pkgs.append('maple')
    if test_cplex(): pkgs.append('cplex')  
    if test_gurobi(): pkgs.append('gurobi')
```



---

Comment by jdemeyer created at 2016-03-09 16:16:38

You should also consider performance issues. I don't want to run all these tests every time I doctest something. You should look at #13540, which uses a lazy mechanism for testing optional tags.


---

Comment by klee created at 2016-03-09 16:23:25

Replying to [comment:8 jdemeyer]:
> Replying to [comment:5 jdemeyer]:
> > I don't like the fact that you _explicitly_ need to specify `--optional=nonpackages`.
> 
> To be clear, I meant that `nonpackages` should be passed by default if no `--optional` argument is given.

Currently doctests for Sage optional packages, if installed on the system, are automatically run only if "--optional" is given. Doctests for nonpackages are run only if "--optional=nonpackages" is given. Perhaps we should keep this ability because of the performance issues that you mention...


---

Comment by klee created at 2016-03-09 16:27:16

Replying to [comment:9 jdemeyer]:
> It would be cool if this would automatically go over all test functions instead of this ugly error-prone code:
> {{{
>     if test_latex(): pkgs.append('latex')
>     if test_magma(): pkgs.append('magma')
>     if test_matlab(): pkgs.append('matlab')     
>     if test_mathematica(): pkgs.append('mathematica')  
>     if test_macaulay2(): pkgs.append('macaulay2')  
>     if test_octave(): pkgs.append('octave')  
>     if test_scilab(): pkgs.append('scilab')  
>     if test_maple(): pkgs.append('maple')
>     if test_cplex(): pkgs.append('cplex')  
>     if test_gurobi(): pkgs.append('gurobi')
> }}}

I totally agree! But I needed to write the code before I go to sleep, as I am living on the other side of the globe :-) You can help!


---

Comment by jdemeyer created at 2016-03-09 16:34:10

I think this is only really useful if "nonpackages" are tested by default.


---

Comment by jhpalmieri created at 2016-03-09 18:33:34

Replying to [comment:4 kcrisman]:
> Don't forget internet - or should that be its own ticket, since it's a different kind of non-package?  One could presumably do some connectivity test and if it failed, _not_ run the internet tests - they should really nearly always be run.

There were [some concerns](http://trac.sagemath.org/ticket/16252#comment:32) about running internet tests whenever possible. I'm not sure I agree with those, but maybe there are other reasons not to do these all the time. (What if I lose my internet connection after testing testing connectivity but in the middle of doctesting? Do we have to test connectivity before every internet test?) But I think some of the patchbots could use the `internet` flag when doctesting.


---

Comment by jhpalmieri created at 2016-03-09 18:44:36

Replying to [comment:11 klee]:
> Currently doctests for Sage optional packages, if installed on the system, are automatically run only if "--optional" is given.

I don't think this is correct. When I run doctests without any extra flags, I see (after installing a few optional packages for testing purposes)

```
$ sage -tp src/sage/homology/
...
Using --optional=ccache,database_gap,gcc,mpir,ore_algebra,python2,sage
...
```



---

Comment by vbraun created at 2016-03-09 23:08:38

I would prefer "external" instead of "nonpackage", otherwise the `--optional=nonpackages` has a confusing double negation vibe.


---

Comment by klee created at 2016-03-10 05:27:22

The behavior "--optional" tag has changed after the merged ticket: http://trac.sagemath.org/ticket/18558, but the developer's manual seems not updated completely to reflect the changes. The following is from experiments and the documentation. So would you verify my understanding?

(1) "-t" : tests all ordinary doctests and also doctests about installed optional packages, in effect equivalent to "-t --optional=optional".
(2) "-t --optional": no-op
(3) "-t --optional=PKGS":   only run doctests including one of the "# optional - xxx" tags where xxx is listed in PKGS; 
                                     if "sage" is listed will also test the standard doctests; 
                                     if "optional" is listed will also test all available(installed) optional packages; 
                                     if set to "all", then all tests will be run; 
If this is correct, then

(A)  Via this ticket I want to add one more line to (3):

                                    if "external" is listed, then also include all doctests  with "# optional - xxx" where xxx is an available external softwares and resources like "magma", "matlab", "internet", "latex", etc (basically everything that is not a Sage standard or optional package).

(B) Also we can change (1) to equate "-t" to "-t --optional=optional,external".

Do you agree?


---

Comment by kcrisman created at 2016-03-10 14:53:45

This seems reasonable to me as a concept (implementation of (B) shouldn't slow things down ridiculously, though, so the devil may be in the details).  Should "-t --optional" be equivalent to "-t" or is the desired behavior still thus?

```
sage-runtests: error: --optional option requires an argument
```



---

Comment by klee created at 2016-03-11 01:33:19

Replying to [comment:18 kcrisman]:
> This seems reasonable to me as a concept (implementation of (B) shouldn't slow things down ridiculously, though, so the devil may be in the details). 

Agree. We definitely need to implement a lazy mechanism like that in #13540. I am reading the related codes in Sage.

> Should "-t --optional" be equivalent to "-t" or is the desired behavior still thus?
> {{{
> sage-runtests: error: --optional option requires an argument
> }}}

Once we implement "external", "all" will mean "sage"+"optional"+"external". Then we may set "-t --optional" to mean "-t --optional=all".


---

Comment by git created at 2016-03-11 07:33:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2016-03-11 07:42:38

Changing priority from minor to major.


---

Comment by git created at 2016-03-11 11:58:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-11 15:40:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-11 15:43:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-11 16:47:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-11 16:52:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-11 16:59:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-03-11 17:32:12

Why does `LazySet` inherit from `set`? Are you actually using any `set` functionality?


---

Comment by jhpalmieri created at 2016-03-11 18:17:23

If I do `sage -tp --optional=sage,optional,external ...`, then instead of printing

```
Using --optional=...,external,...
```

it would be nice if it printed

```
Using --optional=...,internet,latex,maple,...
```



---

Comment by git created at 2016-03-11 22:42:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2016-03-11 22:44:59

Replying to [comment:29 jdemeyer]:
> Why does `LazySet` inherit from `set`? Are you actually using any `set` functionality?

No. I was not. See the last commit.


---

Comment by klee created at 2016-03-11 22:55:48

Replying to [comment:30 jhpalmieri]:
> If I do `sage -tp --optional=sage,optional,external ...`, then instead of printing
> {{{
> Using --optional=...,external,...
> }}}
> it would be nice if it printed
> {{{
> Using --optional=...,internet,latex,maple,...
> }}}

Hmmm. It seems possible... But what do you think it means that "maple" appears in the list? Does it mean that maple is available and tests depending on it will be tested. This behavior defeats the lazy mechanism. Does it simply mean that any doctests depending on maple will run if maple turns out to be available lazily and not otherwise? Then this is very different from an optional package, say gcc or mpir, appearing in the list.


---

Comment by jhpalmieri created at 2016-03-11 23:10:45

Replying to [comment:33 klee]:
> Replying to [comment:30 jhpalmieri]:
> > If I do `sage -tp --optional=sage,optional,external ...`, then instead of printing
> > {{{
> > Using --optional=...,external,...
> > }}}
> > it would be nice if it printed
> > {{{
> > Using --optional=...,internet,latex,maple,...
> > }}}
> 
> Hmmm. It seems possible... But what do you think it means that "maple" appears in the list? Does it mean that maple is available and tests depending on it will be tested. This behavior defeats the lazy mechanism. Does it simply mean that any doctests depending on maple will run if maple turns out to be available lazily and not otherwise? 

I say no to the last question. I don't know how to balance the laziness with what I'm looking for. Maybe a summary at the _end_ of doctesting of which external packages were detected, or (even better) the intersection of those external packages which were detected and those for which a test was run. I think it is important to provide feedback about this in order to debug failed tests (or slow tests, etc.).


---

Comment by klee created at 2016-03-12 05:21:59

> I don't know how to balance the laziness with what I'm looking for. Maybe a summary at the _end_ of doctesting of which external packages were detected, or (even better) the intersection of those external packages which were detected and those for which a test was run. 

Because of the lazyset mechanism, at least one test was run for an external software detected in most cases. There may be exceptional cases to this, but is this important? By the way, I prefer "external software" than "external package". Internet is rather a software than a package :-)


> I think it is important to provide feedback about this in order to debug failed tests (or slow tests, etc.).
 
I agree. Perhaps we can list the detected softwares at the end of doctesting as you suggested.


---

Comment by git created at 2016-03-15 04:38:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-15 04:42:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2016-03-15 04:48:44

The latest patch copes with the multiprocessing of Sage doctesting.


---

Comment by jdemeyer created at 2016-03-15 07:21:27

This is silly:

```
raise Exception # should not happen!
```


Replace it by something like

```
raise AssertionError("invalid value for self.seen")
```



---

Comment by jdemeyer created at 2016-03-15 07:26:39

Can you add a timeout (using `alarm()`) for this:

```
urllib.request.urlopen("http://www.sagemath.org")
```



---

Comment by git created at 2016-03-15 08:14:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-15 09:33:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2016-03-15 22:13:37

On my computer, doctesting the file `external.py` causes two windows to open up, showing the results from `view('2+3')`. Try to find another way to test whether latex is present and functional, maybe something like this:

```diff
diff --git a/src/sage/doctest/external.py b/src/sage/doctest/external.py
index f05bc8d..463413a 100644
--- a/src/sage/doctest/external.py
+++ b/src/sage/doctest/external.py
@@ -59,9 +59,14 @@ def has_latex():
         sage: has_latex() # random
         True
     """
-    from sage.misc.latex import view
+    from sage.misc.latex import _run_latex_, _latex_file_
+    from sage.misc.temporary_file import tmp_filename
     try:
-        view('2+3')
+        f = tmp_filename(ext='.tex')
+        O = open(f, 'w')
+        O.write(_latex_file_('3'))
+        O.close()
+        _run_latex_(f)
         return True
     except Exception:
         return False
```


Also, you might consider adding `ImageMagick` (and in particular the `convert` command) to the set of external programs to be tested.


---

Comment by jhpalmieri created at 2016-03-15 23:45:29

Also, I'm getting a lot of failed `internet` doctests, and some for `latex`, too. If we enable testing those by default, Sage won't pass doctests anymore. They need to be fixed: on separate tickets?


---

Comment by kcrisman created at 2016-03-16 02:13:32

> Also, I'm getting a lot of failed `internet` doctests, and some for `latex`, too. If we enable testing those by default, Sage won't pass doctests anymore. They need to be fixed: on separate tickets?

Yes.  Like #16302.  Are the ones (OEIS) in #16252 at least still fixed?


---

Comment by jhpalmieri created at 2016-03-16 02:37:16

I had to make this change in `oeis.py` to fix one failure:

```diff
diff --git a/src/sage/databases/oeis.py b/src/sage/databases/oeis.py
index ff88286..b8de905 100644
--- a/src/sage/databases/oeis.py
+++ b/src/sage/databases/oeis.py
@@ -841,7 +841,7 @@ class OEISSequence(SageObject):
             A000045: Fibonacci numbers: F(n) = F(n-1) + F(n-2) with F(0) = 0 and F(1) = 1.
 
             sage: f.keywords()                          # optional -- internet
-            ('core', 'nonn', 'nice', 'easy', 'hear')
+            ('core', 'nonn', 'nice', 'easy', 'hear', 'changed')
 
         TESTS::
 
```



---

Comment by jhpalmieri created at 2016-03-16 02:39:47

I think that the `internet` doctests have to be robust enough that if an external website changes something, our tests will still pass. I tried to argue for this at #16252, but there was disagreement. I think it's either that or we don't enable `internet` testing by default.


---

Comment by git created at 2016-03-16 05:24:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2016-03-16 05:35:56

Replying to [comment:43 jhpalmieri]:

> Also, you might consider adding `ImageMagick` (and in particular the `convert` command) to the set of external programs to be tested.

For this ticket, I will stop at providing the framework for tests requiring external softwares.  Thus

(1) Any expert is cordially invited to contribute commits for better and new `has_xxx` tester for the software `xxx`.

(2) Turning on `external` by default should be dealt with in another ticket.

(3) Fixing all doctest failures that result from changing the default should be dealt with separate tickets.


---

Comment by git created at 2016-03-16 07:05:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-03-16 08:35:06

Or perhaps you should indeed define `make (p)testall(long)` to use `--optional=sage,optional,external`


---

Comment by git created at 2016-03-16 09:37:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2016-03-16 09:38:25

Replying to [comment:51 jdemeyer]:
> Or perhaps you should indeed define `make (p)testall(long)` to use `--optional=sage,optional,external`

Done. What about `make (p)testoptional(long)`? Perhaps `--optional=sage,optional`?


---

Comment by kcrisman created at 2016-03-16 12:42:14

> I think that the `internet` doctests have to be robust enough that if an external website changes something, our tests will still pass. I tried to argue for this at #16252, but there was disagreement. I think it's either that or we don't enable `internet` testing by default.

Agreed.  (In your example, presumably `'core' in f.keywords()` would be better?)  But I also think we _must_ enable the internet testing within some framework people will test relatively often - if `make testall` is that place, that's fine.  Otherwise untested is broken - between OEIS and some of the timeseries stuff there is probably a lot eventually broken.


---

Comment by git created at 2016-03-17 00:48:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2016-03-17 00:51:19

Changing status from new to needs_review.


---

Comment by klee created at 2016-03-25 02:33:55

Why the patchbot is not working on this ticket? Since I made changes on `Makefile`?


---

Comment by saraedum created at 2016-04-11 02:18:51

I am working on a more generic way of checking for features of the system (including nice error messages) at #20382. klee: What do you think about it? You could potentially rebase your code to use the features there or I could do that once #20182 got merged.


---

Comment by klee created at 2016-04-11 07:39:57

As this ticket is related to #20382, but independent from it. I think this ticket could be reviewed and merged independently, though still no one bothers reviewing it. Then I would be happy that you open a new ticket to use your features once #20382 got merged.

If #20382 is merged first, then I would also be very happy that you rebase this ticket to #20382.


---

Comment by jhpalmieri created at 2016-04-12 16:09:30

This doctest should be marked "random":

```
        sage: available_softwares.seen()
        ['internet', 'latex', 'magma']
```

Also, throughout, "softwares" should be "software" -- "which software do you have installed" is correct, for example, not "which softwares do you have installed".


---

Comment by jhpalmieri created at 2016-04-12 18:33:06

What should happen with failing doctests? klee's opinion is that they should be fixed on another ticket. I guess that's okay as long as they are not run by default. Anyone else have opinions? 

For example:

```
sage -t src/sage/plot/graphics.py
**********************************************************************
File "src/sage/plot/graphics.py", line 1624, in sage.plot.graphics.Graphics.show
Failed example:
    plot(x, typeset='latex') # optional - latex
Expected nothing
Got:
    Graphics object consisting of 1 graphics primitive
**********************************************************************
File "src/sage/plot/graphics.py", line 1630, in sage.plot.graphics.Graphics.show
Failed example:
    plot(x, typeset='type1') # optional - latex
Expected nothing
Got:
    Graphics object consisting of 1 graphics primitive
**********************************************************************
1 item had failures:
   2 of  87 in sage.plot.graphics.Graphics.show
```

I get this at the end of `make ptestall`:

```
----------------------------------------------------------------------
sage -t src/sage/plot/graphics.py  # 2 doctests failed
sage -t src/sage/plot/plot.py  # 1 doctest failed
sage -t src/sage/arith/misc.py  # 1 doctest failed
sage -t src/sage/tests/cmdline.py  # 1 doctest failed
sage -t src/sage/dev/sagedev.py  # 2 doctests failed
sage -t src/sage/structure/sage_object.pyx  # 2 doctests failed
sage -t src/sage/combinat/designs/bibd.py  # 1 doctest failed
sage -t src/sage/misc/package.py  # 6 doctests failed
sage -t src/sage/doctest/external.py  # 1 doctest failed
sage -t src/sage/repl/rich_output/pretty_print.py  # 1 doctest failed
sage -t src/sage/dev/trac_interface.py  # 5 doctests failed
sage -t src/sage/repl/load.py  # 2 doctests failed
sage -t src/doc/en/developer/coding_basics.rst  # 1 doctest failed
sage -t src/sage/dev/patch.py  # 3 doctests failed
sage -t src/sage/databases/oeis.py  # 2 doctests failed
sage -t src/sage/combinat/integer_lists/invlex.pyx  # 1 doctest failed
sage -t src/sage/dev/digest_transport.py  # 1 doctest failed
sage -t src/sage/finance/stock.py  # 2 doctests failed
sage -t src/sage/misc/remote_file.py  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 1929.7 seconds
    cpu time: 3833.1 seconds
    cumulative wall time: 7184.9 seconds
External softwares detected for doctesting: internet,latex
```



---

Comment by vdelecroix created at 2016-04-12 23:42:00

minor remark: there is a timeout optional argument for `urlopen` (that will gives you a `URLError` in case of failure). And in this particular test, why are you catching `Exception`?


---

Comment by klee created at 2016-04-13 06:55:34

Replying to [comment:62 jhpalmieri]:
> What should happen with failing doctests? klee's opinion is that they should be fixed on another ticket. I guess that's okay as long as they are not run by default. 

This patch can be safely merged as long as the patchbot and the people checking a new Sage release use `make ptestlong`,  which I think is the current practice. Then we need to open a ticket for the failing doctests for each external software, before we at some point switch to use `make ptestall` for a new release.


---

Comment by git created at 2016-04-13 08:11:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2016-04-13 15:09:53

Every function and method needs documentation and doctests.

```
$ sage --coverage src/sage/doctest/external.py 
------------------------------------------------------------------------
SCORE src/sage/doctest/external.py: 64.7% (11 of 17)

Missing documentation:
     * line 272: def __init__(self)
     * line 277: def __contains__(self, item)

Missing doctests:
     * line 224: def external_software()
     * line 236: def _lookup(software)
     * line 294: def issuperset(self, other)
     * line 303: def seen(self)
------------------------------------------------------------------------
```



---

Comment by git created at 2016-04-14 01:44:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-18 20:40:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2016-04-18 20:42:35

Here are a few minor rewordings. The only possibly significant change is removing "# random" from one doctest, but the same thing is doctested later in the same file (in `AvailableSoftware`) without that marking.

I am happy with this now. Does anyone else have any comments?


---

Comment by git created at 2016-04-19 00:28:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2016-04-19 00:32:59

The list "external_software" should not be random. For convenience of later modification, I changed one of the duplicate doctests. Thank you for elaborate review!


---

Comment by jhpalmieri created at 2016-04-25 17:51:48

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-04-26 12:58:41

Resolution: fixed
