# Issue 10107: Calling mwrank(-10) hangs Sage, but uses very little CPU time

Issue created by migration from https://trac.sagemath.org/ticket/10108

Original creator: drkirkby

Original creation time: 2010-10-09 19:53:29

Assignee: tbd

CC:  cremona

Following some very quick hacks at using "fuzz testing" techniques, I found that


```
sage: mwrank(-10)
```


just hangs, but does not appear to be using any CPU time. Although I don't know what this is supposed to do, from discussions on sage-devel, I understand my suspicions this behavior is an error were correct. 

Can someone please select the component appropriately, as I don't have a clue myself. 



---

Comment by cremona created at 2010-10-09 19:55:25

Changing keywords from "" to "mwrank".


---

Comment by cremona created at 2010-10-09 19:55:25

Changing component from PLEASE CHANGE to elliptic curves.


---

Comment by cremona created at 2010-10-09 19:55:25

Changing assignee from tbd to cremona.


---

Comment by cremona created at 2010-10-09 19:55:25

I have a patch for this which I will post soon.


---

Comment by cremona created at 2010-10-09 22:21:00

Replying to [comment:1 cremona]:
> I have a patch for this which I will post soon.

Delays caused by break in internet access -- hope to post patch Sunday.


---

Comment by cremona created at 2010-10-10 20:18:19

applies to 4.6.alpha3


---

Attachment

This was harder than expected.  Without either (1) rewriting mwrank's in put parser or (2) writing a full parser within Sage and only sending to mwrank when certainly correct, which I do not want to do.  If you feed mwrank correct but incomplete input (such as <5 integers separated by whitespace) it quietly waits for the rest of the input (with no prompts).

To get around this I pad the strings sent to mwrank with ' 0 0 0 0 0 ' which means that this never happens, and then to get repeated calls to mwrank to work properly need a bit of fiddling.  I tested the patch on two machines (4.6.alpha3).


---

Comment by cremona created at 2010-10-10 20:23:20

Changing status from new to needs_review.


---

Comment by drkirkby created at 2010-10-11 01:56:49

Replying to [comment:3 cremona]:
> This was harder than expected.  Without either (1) rewriting mwrank's in put parser or (2) writing a full parser within Sage and only sending to mwrank when certainly correct, which I do not want to do.  If you feed mwrank correct but incomplete input (such as <5 integers separated by whitespace) it quietly waits for the rest of the input (with no prompts).


If this hard, then perhaps it's more effort to fix properly than it is worth. You are a better judge of that than me. 

I can't help feeling if this is supposed to take 5 integers then it should take 5, and not accept fewer or more, as it does. For example:


```
sage: mwrank('1 2 3')
"Curve [0,0,0,1,2] :     \n1 points of order 2:\n[-1:0:1]\n\nUsing 2-isogenous curve [0,6,0,-7,0] (minimal model [0,0,0,-19,30])\n-------------------------------------------------------\nFirst step, determining 1st descent Selmer groups\n-------------------------------------------------------\nAfter first local descent, rank bound = 0\nrk(S^{phi}(E'))=        1\nrk(S^{phi'}(E))=        1\n\n-------------------------------------------------------\nSecond step, determining 2nd descent Selmer groups\n-------------------------------------------------------\n...skipping since we already know rank=0\nAfter second local descent, rank bound = 0\nrk(phi'(S^{2}(E)))=     1\nrk(phi(S^{2}(E')))=     1\nrk(S^{2}(E))=   1\nrk(S^{2}(E'))=  2\n\nThird step, determining E(Q)/phi(E'(Q)) and E'(Q)/phi'(E(Q))\n-------------------------------------------------------\n1. E(Q)/phi(E'(Q))\n-------------------------------------------------------\n(c,d)  =(-3,4)\n(c',d')=(6,-7)\nThis component of the rank is 0\n-------------------------------------------------------\n2. E'(Q)/phi'(E(Q))\n-------------------------------------------------------\nThis component of the rank is 0\n\n-------------------------------------------------------\nSummary of results:\n-------------------------------------------------------\n        rank(E) = 0\n        #E(Q)/2E(Q) = 2\n\nInformation on III(E/Q):\n        #III(E/Q)[phi']    = 1\n        #III(E/Q)[2]       = 1\n\nInformation on III(E'/Q):\n        #phi'(III(E/Q)[2]) = 1\n        #III(E'/Q)[phi]    = 1\n        #III(E'/Q)[2]      = 1\n\n\nUsed descent via 2-isogeny with isogenous curve E' = [0,0,0,-19,30]\nRank = 0\nRank of S^2(E)  = 1\nRank of S^2(E') = 2\nRank of S^phi(E') = 1\nRank of S^phi'(E) = 1\n\nSearching for points (bound = 8)...done:\n  found points of rank 0\n  and regulator 1\nProcessing points found during 2-descent...done:\n  now regulator = 1\nSaturating (bound = 100)...done:\n  points were already saturated.\n\n\nRegulator = 1\n\nThe rank and full Mordell-Weil basis have been determined unconditionally.\n (0.055625 seconds)"
```


(It would also be nice if those `\n`'s actually created a new line, as I expect they are supposed to do, but that's another issue entirely.)

Again, I don't feel able to review the Python.


---

Attachment

Looks good to me.  I added a patch which fixes the indentation of the options blocks.


---

Comment by mhansen created at 2010-10-11 03:19:15

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2010-10-23 12:28:08

Please fix the ticket number (10108, NOT 10105) in the patch


---

Comment by jdemeyer created at 2010-10-23 12:28:08

Changing status from positive_review to needs_work.


---

Attachment

renamed version of previous -- applies to 4.6.rc0


---

Comment by cremona created at 2010-10-23 12:58:16

Changing status from needs_work to needs_review.


---

Attachment

Apply only trac_10108-mwrank.3.patch (and sorry for the mess -- previous ones can be deleted).


---

Comment by jdemeyer created at 2010-10-23 16:03:47

Ticket number fixed, apply only this patch


---

Attachment

John, I seem to have confused you :-)
Never mind, I made the fix myself.


---

Comment by jdemeyer created at 2010-10-23 16:05:06

Changing status from needs_review to positive_review.


---

Comment by cremona created at 2010-10-23 16:58:26

Replying to [comment:8 jdemeyer]:
> John, I seem to have confused you :-)
> Never mind, I made the fix myself.

Very sorry - -first I thought it was the patch's name, then the comment in the doctest...  but at least the bugfix works!


---

Comment by jdemeyer created at 2010-10-23 20:59:09

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2010-10-23 20:59:09

This patch gives trouble for me when merging it as part of a potential sage-4.6.1.alpha0.  For some reason I cannot explain, I get the following error when running `sage -t devel/sage/sage/interfaces/mwrank.py`:

```
sage -t  "devel/sage/sage/interfaces/mwrank.py"
**********************************************************************
File "/mnt/usb1/scratch/jdemeyer/sage-4.6.1.alpha0-x86_64-Linux/devel/sage/sage/interfaces/mwrank.py", line 111:
    sage: mwrank([0,-1,1,0,0])
Exception raised:
    Traceback (most recent call last):
      File "/mnt/usb1/scratch/jdemeyer/sage-4.6.1.alpha0-x86_64-Linux/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/mnt/usb1/scratch/jdemeyer/sage-4.6.1.alpha0-x86_64-Linux/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/mnt/usb1/scratch/jdemeyer/sage-4.6.1.alpha0-x86_64-Linux/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_4[3]>", line 1, in <module>
        mwrank([Integer(0),-Integer(1),Integer(1),Integer(0),Integer(0)])###line 111:
    sage: mwrank([0,-1,1,0,0])
      File "/mnt/usb1/scratch/jdemeyer/sage-4.6.1.alpha0-x86_64-Linux/local/lib/python/site-packages/sage/interfaces/mwrank.py", line 139, in __call__
        raise ValueError, 'Invalid input (%s) to mwrank'%cmd
    ValueError: Invalid input ([0, -1, 1, 0, 0]) to mwrank
**********************************************************************
```


What is strange is that simply doing

```
sage: mwrank([0,-1,1,0,0])
```

in a "real" Sage session works.  So it works in Sage, but not in a doctest.  I will need to investigate further.


---

Comment by cremona created at 2010-10-23 21:50:37

I think I can explain this.  The problem to be solved for this ticket was that if mwrank is given incomplete but otherwise correct input, it just waits for the rest of the input, making Sage appear to hang.  To fix this I made sure that the input provided by Sage always has some other stuff appended to it, so mwrank never has insufficient input.  But then,  the *next* time input is sent to mwrank, there is likely to be still some of that extra stuff in its input buffer.  To get around that (I thought) I made sure that mwrank was restarted at every call.

Clearly what I did was insufficient, but this does explain who the order of executing commands does matter.


---

Comment by cremona created at 2014-01-13 12:29:03

The git commit does a better jpb than the old patch:  I implemented a new function `validate_mwrank_input` which accepts (and to a small degree standardises) valid mwrank inputs using some regular expression analysis.  This means that mwrank will only get sent a valid string.

This is now ready for review.
----
Last 10 new commits:


---

Comment by cremona created at 2014-01-13 12:29:03

Changing status from needs_work to needs_review.


---

Comment by wuthrich created at 2014-01-25 22:37:53

I have two tests that do not pass. (I have rebased the branch to 6.1.rc0; so maybe mwrank changed in the meantime.) I looks like


```
**********************************************************************
File "mwrank.py", line 233, in sage.interfaces.mwrank.Mwrank_class.__call__
Failed example:
    mwrank('0 -1 1 0 0')
Expected:
    'Curve [0,-1,1,0,0] :\tBasic pair: I=16, J=-304\ndisc=-76032\n2-adic index bound = 2\nBy Lemma 5.1(a), 2-adic index = 1\n2-adic index = 1\nOne (I,J) pair\nLooking for quartics with I = 16, J = -304\nLooking for Type 3 quartics:\nTrying positive a from 1 up to 1 (square a first...)\n(1,0,-4,4,0)\t--trivial\n(1,0,2,4,1)\t--trivial\nTrying positive a from 1 up to 1 (...then non-square a)\nFinished looking for Type 3 quartics.\nMordell rank contribution from B=im(eps) = 0\nSelmer  rank contribution from B=im(eps) = 0\nSha     rank contribution from B=im(eps) = 0\nMordell rank contribution from A=ker(eps) = 0\nSelmer  rank contribution from A=ker(eps) = 0\nSha     rank contribution from A=ker(eps) = 0\n\nUsed full 2-descent via multiplication-by-2 map\nRank = 0\nRank of S^2(E)  = 0\n\nProcessing points found during 2-descent...done:\n  now regulator = 1\n\n\nRegulator = 1\n\nThe rank has been determined unconditionally.\n\n...'
Got:
    'Curve [0,-1,1,0,0] :\tBasic pair: I=16, J=-304\ndisc=-76032\n2-adic index bound = 2\nBy Lemma 5.1(a), 2-adic index = 1\n2-adic index = 1\nOne (I,J) pair\nLooking for quartics with I = 16, J = -304\nLooking for Type 3 quartics:\nTrying positive a from 1 up to 1 (square a first...)\n(1,0,-4,4,0)\t--trivial\n(1,0,2,4,1)\t--trivial\nTrying positive a from 1 up to 1 (...then non-square a)\nFinished looking for Type 3 quartics.\nMordell rank contribution from B=im(eps) = 0\nSelmer  rank contribution from B=im(eps) = 0\nSha     rank contribution from B=im(eps) = 0\nMordell rank contribution from A=ker(eps) = 0\nSelmer  rank contribution from A=ker(eps) = 0\nSha     rank contribution from A=ker(eps) = 0\n\nUsed full 2-descent via multiplication-by-2 map\nRank = 0\nRank of S^2(E)  = 0\n\nProcessing points found during 2-descent...done:\n  now regulator = 1\n\n\nRegulator = 1\n\nThe rank and full Mordell-Weil basis have been determined unconditionally.\n (0.006 seconds)'
**********************************************************************
File "mwrank.py", line 239, in sage.interfaces.mwrank.Mwrank_class.__call__
Failed example:
    "Rank = 0" in s and "The rank has been determined unconditionally" in s
Expected:
    True
Got:
    False
**********************************************************************
```



---

Comment by wuthrich created at 2014-01-25 22:37:53

Changing status from needs_review to needs_work.


---

Comment by cremona created at 2014-01-26 09:21:48

Thanks.  Since you did a rebase I can't see what you changed additionally, but I seem to have slipped up in testing (in one example) that the long-winded mwrank output is good where because of the time output one cannot just do a literal comparison.
Testing...


---

Comment by cremona created at 2014-01-26 09:33:35

Changing status from needs_work to needs_review.


---

Comment by cremona created at 2014-01-26 09:33:35

OK, works for me (though I think my earlier branch did too!).  I have set this back to "needs review" and Chris you can set it to positive review.


---

Comment by wuthrich created at 2014-01-26 11:49:38

Ah interesting.

I did not change anything. I litterally took your mwrank.py and copied it into a branch based at develop, checking that this file was not touch on since then.

So I get the above errors and you do not get them. So it seems that mwrank does not give back the same string for you than for me. The issue (in both failures) is the final sentence. I get

"The rank and full Mordell-Weil basis have been determined unconditionally."

while we test for

"The rank has been determined unconditionally."

Is there a change in mwrank that I have missed?

(I revert back to needs_work).


---

Comment by wuthrich created at 2014-01-26 11:49:38

Changing status from needs_review to needs_work.


---

Comment by cremona created at 2014-01-26 12:57:29

That is weird;  I misunderstood.  No changes at all in mwrank.  But when I switch branches there is more recompilation than I would have expected (mpir rebuilds) for this.  Very odd!  I'll look into it further.


---

Comment by wuthrich created at 2014-01-26 13:41:42

From my develop to this branch u/wuthrich/..., it only compiles mwrank.py (as I would expect).


---

Comment by cremona created at 2014-01-26 14:39:30

I think there was some conflict between the state of the original branch of mine called ticket/10108 and the branch I had after checking out yours.  So I switched back to develop, deleted the branch ticket/10108 altogether and re-pulled it.  Now my git log has the right look to it:

```
commit e4f365ae32a8804072b839205566fede75066431
Author: Chris Wuthrich <christian.wuthrich@gmail.com>
Date:   Sat Jan 25 20:33:23 2014 +0000

    Trac #10108: more robust interface to mwrank

commit 1bd331978c99681b70e4877fa3149b0c9adf47ce
Author: Volker Braun <vbraun.name@gmail.com>
Date:   Sat Jan 25 01:41:12 2014 +0000

    Updated Sage version to 6.1.rc0
```

so I rebuild (i.e. "make").  And sage/interfaces/mwrank.py passes its tests.  And specifically when in Sage I run

```
sage: mwrank('0 -1 1 0 0')
```

the output string is

```
'Curve [0,-1,1,0,0] :\tBasic pair: I=16, J=-304\ndisc=-76032\n2-adic index bound = 2\nBy Lemma 5.1(a), 2-adic index = 1\n2-adic index = 1\nOne (I,J) pair\nLooking for quartics with I = 16, J = -304\nLooking for Type 3 quartics:\nTrying positive a from 1 up to 1 (square a first...)\n(1,0,-4,4,0)\t--trivial\n(1,0,2,4,1)\t--trivial\nTrying positive a from 1 up to 1 (...then non-square a)\nFinished looking for Type 3 quartics.\nMordell rank contribution from B=im(eps) = 0\nSelmer  rank contribution from B=im(eps) = 0\nSha     rank contribution from B=im(eps) = 0\nMordell rank contribution from A=ker(eps) = 0\nSelmer  rank contribution from A=ker(eps) = 0\nSha     rank contribution from A=ker(eps) = 0\n\nUsed full 2-descent via multiplication-by-2 map\nRank = 0\nRank of S^2(E)  = 0\n\nProcessing points found during 2-descent...done:\n  now regulator = 1\n\n\nRegulator = 1\n\nThe rank has been determined unconditionally.\n\n (0.004001 seconds)'
```



Now I see what is happening!    The curve has rank 0;  so mwrank does not do the usual saturation step of making sure that we have the full MW group and not a subgroup of finite index;  there is a flag (in my C++ code) called sat_ok which is set to 1 if saturation suceeds, 0 if it fails -- and is uninitialized otherwise!  So it will be random for a rank 0 curve where one sees the additional string "The rank and full Mordell-Weil basis have been determined" or "The rank and full Mordell-Weil basis have been determined".

Obviously I will correct this in eclib, which is timely since I was planning tp update Sage's version sson anyway.  Meanwhile we'll have to sidestep this by changing that doctest sneakily.  I suggest first deleting the variable sentence, effectively moving the "..." forward; and in the next line just test for "Rank = 0" in s.

Shall I do that or will you?


---

Comment by wuthrich created at 2014-01-26 15:06:04

I can do it. 

Do you want to keep the lengthy output to be tested ? Or would not 
'Curve [0,-1,1,0,0] :\tBasic pair: I=16, J=-304 ... determined unconditionally ...'
be enough ?


---

Comment by cremona created at 2014-01-26 15:09:32

Replying to [comment:23 wuthrich]:
> I can do it. 
> 

Thanks.

> Do you want to keep the lengthy output to be tested ? Or would not 
> 'Curve [0,-1,1,0,0] :\tBasic pair: I=16, J=-304 ... determined unconditionally ...'
> be enough ?

That would be enough, certainly as we also check that "Rank = 0" is in there.


---

Comment by git created at 2014-01-26 16:50:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by wuthrich created at 2014-01-26 16:51:48

I run the tests now.


---

Comment by cremona created at 2014-01-26 20:29:08

Replying to [comment:22 cremona]:

> Obviously I will correct this in eclib, which is timely since I was planning to update Sage's version soon anyway. 

The eclib patch is visible here:

https://github.com/JohnCremona/eclib/commit/d1ab6a59103fb86730f1e668e70ecf010ee37b2d

and the new version (with a lot more than just this change) is in a new spkg at #15738.  But this ticket does not need that.


---

Comment by wuthrich created at 2014-01-26 23:22:46

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2014-02-01 15:16:59

Resolution: fixed


---

Comment by vbraun created at 2014-02-08 13:01:58

See #15798 for a followup ticket
