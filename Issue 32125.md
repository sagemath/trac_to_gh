# Issue 32125: HyperbolicGeodesicPD.plot can be wrong for CDF coordinates

Issue created by migration from https://trac.sagemath.org/ticket/32362

Original creator: @Vectornaut

Original creation time: 2021-08-10 20:38:32

CC:  slelievre jhonrubia6 mjo

**Input**


```python
D = HyperbolicPlane().PD()
a = 0
b = 1e-15 + 0.7*I
geodesics = [
  D.get_geodesic(a, b),
  D.get_geodesic(CC(a), CC(b)),
  D.get_geodesic(CDF(a), CDF(b))
]
show(graphics_array([geod.plot() for geod in geodesics]))
print(geodesics[2].plot()[0])
```


**Result**

The first two pictures show the expected output: a straight line from `0` to `0.7*I`. The last picture shows the buggy output: a short arc between two points near `0.7*I`. The printed output describes the arc in the buggy picture:


```
Arc with center (-0.4210526315789469,1.0000000000000007) radii (0.42105263157894823,0.42105263157894823) angle 0.0 inside the sector (-1.172273881128477,-0.6190660545826288)
```



---

Comment by @Vectornaut created at 2021-08-10 20:40:43

Output image from example code


---

Attachment

The current implementation of hyperbolic geodesics
relies on a conversion to the half-plane model.

Any geodesic `g` has its corresponding
half-plane model geodesic stored as
`g._cached_geodesic`.

The example geodesic has endpoints
I and 2.222222222222222e-14 + 5.666666666666666*I.

The corresponding complete geodesic is a
euclidean semicircle. Due to rounding errors
on its centre and radius, its endpoints are
computed in CDF as (-2.375, 1400000000000002.0),
whereas computations in CC give them much more
correctly as (0.0, 1.4e15).

Converting back to the disc model, the effect
is a disaster.


---

Comment by @Vectornaut created at 2021-08-17 22:27:33

Aha! I suspect it's possible to find the ideal endpoints of a disk model geodesic in a more numerically stable way. I can work on a test implementation.

If the test implementation works well, do you know what we'd have to do to incorporate it into `hyperbolic_geodesic.py`? Is it just a matter of overriding `ideal_endpoints` in `HyperbolicGeodesicPD`?


---

Comment by slelievre created at 2021-08-18 16:21:04

Changing keywords from "" to "hyperbolic, geodesic, plot, precision".


---

Comment by slelievre created at 2021-08-18 16:21:04

Replying to [comment:2 gh-Vectornaut]:
> Aha! I suspect it's possible to find the ideal endpoints
> of a disk model geodesic in a more numerically stable way.
> I can work on a test implementation.

Good!
 
> If the test implementation works well, do you know
> what we'd have to do to incorporate it into
> `hyperbolic_geodesic.py`? Is it just a matter of
> overriding `ideal_endpoints` in `HyperbolicGeodesicPD`?

Yes.


---

Comment by @Vectornaut created at 2021-08-20 04:55:08

Finding ideal endpoints of geodesics on the Poincaré disk: example implementation


---

Attachment

Finding ideal endpoints of geodesics on the Poincaré disk: method explanation


---

Attachment

I just attached an example implementation. I've done some basic tests, but no systematic challenges or comparison with the current implementation (via the upper half-plane).


---

Comment by jhonrubia6 created at 2021-11-20 10:31:15

Maybe unrelated or not (If you think it's unrelated I can open a new ticket on this) I've just discovered working on ticket [ticket:23427] that ideal endpoints on PD geodesics can be mapped to imag()<0 points which is an error, and when plotted often draw a geodesic int the lower half plane.
For example

```
Sage:    P = PD.get_point(-0.920704875684763 - 0.390259569889459*I)
Sage:    P
Boundary point in PD -0.920704875684763 - 0.390259569889459*I
Sage:    UHP(P)
Boundary point in UHP -0.662253938491478 - 1.66533453693773e-16*I
```


```
sage: g=HyperbolicPlane().PD().random_geodesic()
Sage:  g
Geodesic in PD from -0.920704875684763 - 0.390259569889459*I to 0.0632992206159446 + 0.997994593507106*I
sage: g.to_model('UHP')  
Geodesic in UHP from -0.662253938491478 - 5.55111512312578e-17*I to 31.5642842686728 - 8.34887714518118e-14*I
```

