# Issue 32125: HyperbolicGeodesicPD.plot can be wrong for CDF coordinates

archive/issues_032125.json:
```json
{
    "body": "CC:  @slel jhonrubia6 @orlitzky\n\n**Input**\n\n```python\nD = HyperbolicPlane().PD()\na = 0\nb = 1e-15 + 0.7*I\ngeodesics = [\n  D.get_geodesic(a, b),\n  D.get_geodesic(CC(a), CC(b)),\n  D.get_geodesic(CDF(a), CDF(b))\n]\nshow(graphics_array([geod.plot() for geod in geodesics]))\nprint(geodesics[2].plot()[0])\n```\n\n**Result**\n\nThe first two pictures show the expected output: a straight line from `0` to `0.7*I`. The last picture shows the buggy output: a short arc between two points near `0.7*I`. The printed output describes the arc in the buggy picture:\n\n```\nArc with center (-0.4210526315789469,1.0000000000000007) radii (0.42105263157894823,0.42105263157894823) angle 0.0 inside the sector (-1.172273881128477,-0.6190660545826288)\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/32362\n\n",
    "created_at": "2021-08-10T20:38:32Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "HyperbolicGeodesicPD.plot can be wrong for CDF coordinates",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32125",
    "user": "https://github.com/Vectornaut"
}
```
CC:  @slel jhonrubia6 @orlitzky

**Input**

```python
D = HyperbolicPlane().PD()
a = 0
b = 1e-15 + 0.7*I
geodesics = [
  D.get_geodesic(a, b),
  D.get_geodesic(CC(a), CC(b)),
  D.get_geodesic(CDF(a), CDF(b))
]
show(graphics_array([geod.plot() for geod in geodesics]))
print(geodesics[2].plot()[0])
```

**Result**

The first two pictures show the expected output: a straight line from `0` to `0.7*I`. The last picture shows the buggy output: a short arc between two points near `0.7*I`. The printed output describes the arc in the buggy picture:

```
Arc with center (-0.4210526315789469,1.0000000000000007) radii (0.42105263157894823,0.42105263157894823) angle 0.0 inside the sector (-1.172273881128477,-0.6190660545826288)
```

Issue created by migration from https://trac.sagemath.org/ticket/32362





---

archive/issue_comments_458175.json:
```json
{
    "body": "Output image from example code",
    "created_at": "2021-08-10T20:40:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32125#issuecomment-458175",
    "user": "https://github.com/Vectornaut"
}
```

Output image from example code



---

archive/issue_comments_458176.json:
```json
{
    "body": "Attachment [geodesic_bug.png](tarball://root/attachments/some-uuid/ticket32362/geodesic_bug.png) by @slel created at 2021-08-14 21:01:18\n\nThe current implementation of hyperbolic geodesics\nrelies on a conversion to the half-plane model.\n\nAny geodesic `g` has its corresponding\nhalf-plane model geodesic stored as\n`g._cached_geodesic`.\n\nThe example geodesic has endpoints\nI and 2.222222222222222e-14 + 5.666666666666666*I.\n\nThe corresponding complete geodesic is a\neuclidean semicircle. Due to rounding errors\non its centre and radius, its endpoints are\ncomputed in CDF as (-2.375, 1400000000000002.0),\nwhereas computations in CC give them much more\ncorrectly as (0.0, 1.4e15).\n\nConverting back to the disc model, the effect\nis a disaster.",
    "created_at": "2021-08-14T21:01:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32125#issuecomment-458176",
    "user": "https://github.com/slel"
}
```

Attachment [geodesic_bug.png](tarball://root/attachments/some-uuid/ticket32362/geodesic_bug.png) by @slel created at 2021-08-14 21:01:18

The current implementation of hyperbolic geodesics
relies on a conversion to the half-plane model.

Any geodesic `g` has its corresponding
half-plane model geodesic stored as
`g._cached_geodesic`.

The example geodesic has endpoints
I and 2.222222222222222e-14 + 5.666666666666666*I.

The corresponding complete geodesic is a
euclidean semicircle. Due to rounding errors
on its centre and radius, its endpoints are
computed in CDF as (-2.375, 1400000000000002.0),
whereas computations in CC give them much more
correctly as (0.0, 1.4e15).

Converting back to the disc model, the effect
is a disaster.



---

archive/issue_comments_458177.json:
```json
{
    "body": "Aha! I suspect it's possible to find the ideal endpoints of a disk model geodesic in a more numerically stable way. I can work on a test implementation.\n\nIf the test implementation works well, do you know what we'd have to do to incorporate it into `hyperbolic_geodesic.py`? Is it just a matter of overriding `ideal_endpoints` in `HyperbolicGeodesicPD`?",
    "created_at": "2021-08-17T22:27:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32125#issuecomment-458177",
    "user": "https://github.com/Vectornaut"
}
```

Aha! I suspect it's possible to find the ideal endpoints of a disk model geodesic in a more numerically stable way. I can work on a test implementation.

If the test implementation works well, do you know what we'd have to do to incorporate it into `hyperbolic_geodesic.py`? Is it just a matter of overriding `ideal_endpoints` in `HyperbolicGeodesicPD`?



---

archive/issue_comments_458178.json:
```json
{
    "body": "Changing keywords from \"\" to \"hyperbolic, geodesic, plot, precision\".",
    "created_at": "2021-08-18T16:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32125#issuecomment-458178",
    "user": "https://github.com/slel"
}
```

Changing keywords from "" to "hyperbolic, geodesic, plot, precision".



---

archive/issue_comments_458179.json:
```json
{
    "body": "Replying to [comment:2 gh-Vectornaut]:\n> Aha! I suspect it's possible to find the ideal endpoints\n> of a disk model geodesic in a more numerically stable way.\n> I can work on a test implementation.\n\n\nGood!\n \n> If the test implementation works well, do you know\n> what we'd have to do to incorporate it into\n> `hyperbolic_geodesic.py`? Is it just a matter of\n> overriding `ideal_endpoints` in `HyperbolicGeodesicPD`?\n\n\nYes.",
    "created_at": "2021-08-18T16:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32125#issuecomment-458179",
    "user": "https://github.com/slel"
}
```

Replying to [comment:2 gh-Vectornaut]:
> Aha! I suspect it's possible to find the ideal endpoints
> of a disk model geodesic in a more numerically stable way.
> I can work on a test implementation.


Good!
 
> If the test implementation works well, do you know
> what we'd have to do to incorporate it into
> `hyperbolic_geodesic.py`? Is it just a matter of
> overriding `ideal_endpoints` in `HyperbolicGeodesicPD`?


Yes.



---

archive/issue_comments_458180.json:
```json
{
    "body": "Finding ideal endpoints of geodesics on the Poincar\u00e9 disk: example implementation",
    "created_at": "2021-08-20T04:55:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32125#issuecomment-458180",
    "user": "https://github.com/Vectornaut"
}
```

Finding ideal endpoints of geodesics on the Poincaré disk: example implementation



---

archive/issue_comments_458181.json:
```json
{
    "body": "Attachment [hyperbolic_geodesic_PD.sage](tarball://root/attachments/some-uuid/ticket32362/hyperbolic_geodesic_PD.sage) by @Vectornaut created at 2021-08-20 04:56:02\n\nFinding ideal endpoints of geodesics on the Poincar\u00e9 disk: method explanation",
    "created_at": "2021-08-20T04:56:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32125#issuecomment-458181",
    "user": "https://github.com/Vectornaut"
}
```

Attachment [hyperbolic_geodesic_PD.sage](tarball://root/attachments/some-uuid/ticket32362/hyperbolic_geodesic_PD.sage) by @Vectornaut created at 2021-08-20 04:56:02

Finding ideal endpoints of geodesics on the Poincaré disk: method explanation



---

archive/issue_comments_458182.json:
```json
{
    "body": "Attachment [drawing-geodesics.pdf](tarball://root/attachments/some-uuid/ticket32362/drawing-geodesics.pdf) by @Vectornaut created at 2021-08-20 04:59:34\n\nI just attached an example implementation. I've done some basic tests, but no systematic challenges or comparison with the current implementation (via the upper half-plane).",
    "created_at": "2021-08-20T04:59:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32125#issuecomment-458182",
    "user": "https://github.com/Vectornaut"
}
```

Attachment [drawing-geodesics.pdf](tarball://root/attachments/some-uuid/ticket32362/drawing-geodesics.pdf) by @Vectornaut created at 2021-08-20 04:59:34

I just attached an example implementation. I've done some basic tests, but no systematic challenges or comparison with the current implementation (via the upper half-plane).



---

archive/issue_comments_458183.json:
```json
{
    "body": "Maybe unrelated or not (If you think it's unrelated I can open a new ticket on this) I've just discovered working on ticket [ticket:23427] that ideal endpoints on PD geodesics can be mapped to imag()<0 points which is an error, and when plotted often draw a geodesic int the lower half plane.\nFor example\n\n```\nSage:    P = PD.get_point(-0.920704875684763 - 0.390259569889459*I)\nSage:    P\nBoundary point in PD -0.920704875684763 - 0.390259569889459*I\nSage:    UHP(P)\nBoundary point in UHP -0.662253938491478 - 1.66533453693773e-16*I\n```\n\n```\nsage: g=HyperbolicPlane().PD().random_geodesic()\nSage:  g\nGeodesic in PD from -0.920704875684763 - 0.390259569889459*I to 0.0632992206159446 + 0.997994593507106*I\nsage: g.to_model('UHP')  \nGeodesic in UHP from -0.662253938491478 - 5.55111512312578e-17*I to 31.5642842686728 - 8.34887714518118e-14*I\n```",
    "created_at": "2021-11-20T10:31:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32125",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32125#issuecomment-458183",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

Maybe unrelated or not (If you think it's unrelated I can open a new ticket on this) I've just discovered working on ticket [ticket:23427] that ideal endpoints on PD geodesics can be mapped to imag()<0 points which is an error, and when plotted often draw a geodesic int the lower half plane.
For example

```
Sage:    P = PD.get_point(-0.920704875684763 - 0.390259569889459*I)
Sage:    P
Boundary point in PD -0.920704875684763 - 0.390259569889459*I
Sage:    UHP(P)
Boundary point in UHP -0.662253938491478 - 1.66533453693773e-16*I
```

```
sage: g=HyperbolicPlane().PD().random_geodesic()
Sage:  g
Geodesic in PD from -0.920704875684763 - 0.390259569889459*I to 0.0632992206159446 + 0.997994593507106*I
sage: g.to_model('UHP')  
Geodesic in UHP from -0.662253938491478 - 5.55111512312578e-17*I to 31.5642842686728 - 8.34887714518118e-14*I
```



---

archive/issue_events_085870.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T20:12:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32125",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32125#event-85870"
}
```



---

archive/issue_events_085871.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32125",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32125#event-85871"
}
```



---

archive/issue_events_085872.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32125",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32125#event-85872"
}
```



---

archive/issue_events_085873.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32125",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32125#event-85873"
}
```



---

archive/issue_events_085874.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32125",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32125#event-85874"
}
```
