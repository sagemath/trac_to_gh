# Issue 27462: Detect Anaconda

Issue created by migration from https://trac.sagemath.org/ticket/27699

Original creator: slelievre

Original creation time: 2019-04-18 13:48:22

CC:  dimpase saraedum isuruf jhpalmieri embray tscrim fbissey

Keywords: Anaconda

This ticket is to detect the presence of Anaconda when building or
starting Sage, and output a helpful warning or error message in
cases where it is likely to cause, or when it causes, trouble.

Many support requests come from the failure of Sage to build or
to run in the presence of Anaconda.


---

Comment by embray created at 2019-05-10 11:14:17

I think it would be best to just make it possible to build sage in an anaconda env (at least given the right dependencies).


---

Comment by mkoeppe created at 2019-06-04 01:31:14

Replying to [comment:1 embray]:
> I think it would be best to just make it possible to build sage in an anaconda env (at least given the right dependencies).
+1


---

Comment by mkoeppe created at 2019-06-06 20:49:35

First ticket: #27941


---

Comment by embray created at 2019-06-14 14:55:02

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).


---

Comment by mkoeppe created at 2019-06-21 03:08:13

As discussed in #27941, if Anaconda is detected, it may suffice to add an `-rpath` directive to our `LDFLAGS` to enable linking against the libraries provided by Anaconda.


---

Comment by mkoeppe created at 2019-11-17 19:14:06

It suffices to install the following conda packages:
    - c-compiler
    - cxx-compiler
    - fortran-compiler
They take care of adding the necessary flags. See https://docs.conda.io/projects/conda-build/en/latest/resources/compiler-tools.html (end) and also #28745.


---

Comment by mkoeppe created at 2020-01-11 00:34:05

Changing type from task to enhancement.


---

Comment by mkoeppe created at 2020-01-11 01:50:17

New commits:


---

Comment by mkoeppe created at 2020-01-11 01:50:26

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-01-13 11:02:52

Nice, but does it always do the job? E.g. I noticed that I must comment out everything in the following block inserted by conda into my `.bashrc`:

```
# >>> conda initialize >>>
# !! Contents within this block are managed by 'conda init' !!
__conda_setup="$('/home/scratch2/dimpase/miniconda3/bin/conda' 'shell.bash' 'hook' 2> /dev/null)"
 if [ $? -eq 0 ]; then
    eval "$__conda_setup"
 else
    if [ -f "/home/scratch2/dimpase/miniconda3/etc/profile.d/conda.sh" ]; then
        . "/home/scratch2/dimpase/miniconda3/etc/profile.d/conda.sh"
    else
        export PATH="/home/scratch2/dimpase/miniconda3/bin:$PATH"
    fi
fi
```

- deactivating conda is not enough to let a conda-less build of Sage complete on Fedora.


---

Comment by mkoeppe created at 2020-01-13 14:00:02

Replying to [comment:12 dimpase]:
> Nice, but does it always do the job? E.g. I noticed that I must comment out everything in the following block inserted by conda into my `.bashrc`:
> {{{
> # >>> conda initialize >>>
> # !! Contents within this block are managed by 'conda init' !! ...
> }}}
> - deactivating conda is not enough to let a conda-less build of Sage complete on Fedora.

That would be a conda bug.
What is the environment on that system after `conda deactivate`?


---

Comment by dimpase created at 2020-01-13 14:10:07

If I leave these things uncommented, and ssh into the box, I land in conda's `(base)`.
Then

```
(base) clpc171[~]$ conda deactivate  
clpc171[~]$ 
clpc171[~]$ logout
Connection to clpc171.cs.ox.ac.uk closed.
coml0531@raven:~$ ssh cs
Last login: Mon Jan 13 14:07:02 2020 from raven.linux.ox.ac.uk
(base) clpc171[~]$ 
```

and I land back into conda, as you see...


---

Comment by mkoeppe created at 2020-01-13 14:15:45

That's normal.
`conda deactivate` and `conda activate` manipulate the environment of the current shell.


---

Comment by dimpase created at 2020-01-13 14:27:20

but then every `sh` call in a build that happens to source `~/.bashrc` activates conda, resulting in broken builds.


---

Comment by dimpase created at 2020-01-13 14:37:16

E.g.:

```
clpc171[~]$ bash
(base) clpc171[~]$ 
```


Given that `bash` is called in a lot of places in `build/` we obviously have a problem.


---

Comment by mkoeppe created at 2020-01-13 15:05:57

The conda initialization code belongs into `~/.bash_profile`, not `~/.bashrc`. This is where `conda init` puts it. It is supposed to be invoked for login shells only.


---

Comment by dimpase created at 2020-01-13 15:16:36

I have not done anything special to install conda on that box. Perhaps it just has no .bash_profile

I will check as soon as I am back to keyboard. Feels like a conda bug to me.


---

Comment by mkoeppe created at 2020-01-13 15:31:45

It may be behavior of older versions of conda. In any case, also `~/.bashrc` is only run by **interactive** bash invocations. If one of our build scripts calls it, that's a bug on our side.


---

Comment by mkoeppe created at 2020-01-13 15:58:30

Replying to [comment:18 mkoeppe]:
> The conda initialization code belongs into `~/.bash_profile`, not `~/.bashrc`. This is where `conda init` puts it. It is supposed to be invoked for login shells only.
I think it may be a difference in `conda init` behavior between mac and linux.


---

Comment by dimpase created at 2020-01-13 16:22:38

I do have `~/.bash_profile` - but it was not used by `conda init` (which I did last month, so it's a pretty recent install).

I'll move that chunk to `~/.bash_profile` and verify whether it allows to build.

Isuru, is this not a conda bug, installing that stuff into `~/.bashrc` ?


---

Comment by isuruf created at 2020-01-13 16:43:12

> Isuru, is this not a conda bug, installing that stuff into `~/.bashrc` ?

You could do,


```
conda config --set auto_activate_base false
```


to make it not initialize by default.


---

Comment by isuruf created at 2020-01-13 16:52:18

See also, https://stackoverflow.com/a/57974390/4768820


---

Comment by dimpase created at 2020-01-13 17:24:08

ok, so this stuff has to be in Sage's docs.

one way or another, why would anyone want automatic activation of conda in non-login shell?


---

Comment by jhpalmieri created at 2020-01-13 18:02:51

For what it's worth, I very recently installed anaconda on a Mac, and the installation wrote to `.bash_profile`, not `.bashrc`.


---

Comment by mkoeppe created at 2020-01-13 18:08:49

FWIW, I successfully built sage from scratch after `conda deactivate`. But this is with a miniconda installation with a clean `base` environment.

I'll test again on Linux with a dirty `base` environment that has lots of `bin/*-config` executables - this was the problem in #27941.


---

Comment by mkoeppe created at 2020-01-13 18:10:08

Replying to [comment:25 dimpase]:
> one way or another, why would anyone want automatic activation of conda in non-login shell?

I don't know but it does not matter as long as it's not also done in noninteractive shells (which it isn't).


---

Comment by mkoeppe created at 2020-01-13 18:14:20

Changing keywords from "Anaconda" to "Anaconda, conda".


---

Comment by mkoeppe created at 2020-01-13 18:16:41

Changing keywords from "Anaconda, conda" to "conda".


---

Comment by mkoeppe created at 2020-01-13 18:19:02

Replying to [comment:25 dimpase]:
> ok, so this stuff has to be in Sage's docs.

I'll update the doc in this ticket.


---

Comment by git created at 2020-01-13 18:44:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Attachment


---

Comment by mkoeppe created at 2020-01-14 03:54:35

Replying to [comment:27 mkoeppe]:
> I'll test again on Linux with a dirty `base` environment that has lots of `bin/*-config` executables - this was the problem in #27941.

See the attached Dockerfile for this setup.


---

Comment by dimpase created at 2020-01-14 11:36:42

Replying to [comment:28 mkoeppe]:
> Replying to [comment:25 dimpase]:
> > one way or another, why would anyone want automatic activation of conda in non-login shell?
> 
> I don't know but it does not matter as long as it's not also done in noninteractive shells (which it isn't).

Well, I can imagine a Sage test invoking an interactive shell, and then, well, all the bets are off. Can we test that Conda has `auto_activate_base=false` - if we are outside conda?

As well, the docs ought to mention comment:23 (atm they only tell how to use conda, but they also ought to tell how not to)


---

Comment by mkoeppe created at 2020-01-14 14:06:09

Replying to [comment:34 dimpase]:
> Replying to [comment:28 mkoeppe]:
> > Replying to [comment:25 dimpase]:
> > > one way or another, why would anyone want automatic activation of conda in non-login shell?
> > 
> > I don't know but it does not matter as long as it's not also done in noninteractive shells (which it isn't).
> 
> Well, I can imagine a Sage test invoking an interactive shell, and then, well, all the bets are off.

If there is such a bug in the testsuite, we'll fix it. 

This really isn't specific to conda. Users' interactive shell configuration in  ~/.bashrc could also define all kinds of incompatible `alias`es or print arbitrary output etc. that could confuse a doctest.

> Can we test that Conda has `auto_activate_base=false` - if we are outside conda?

I don't know what you mean by that.

> As well, the docs ought to mention comment:23 (atm they only tell how to use conda, but they also ought to tell how not to)

The added docs already mention `conda deactivate`. And that is sufficient. 

Telling the user that they have to disable conda by editing their init scripts, or uninstall conda, or change their conda configuration --- all of this is going in the wrong direction for Sage.


---

Comment by mkoeppe created at 2020-01-18 02:03:34

Replying to [comment:33 mkoeppe]:
> Replying to [comment:27 mkoeppe]:
> > I'll test again on Linux with a dirty `base` environment that has lots of `bin/*-config` executables - this was the problem in #27941.
> 
> See the attached Dockerfile for this setup.

With #29026 (which fixes a compile error in the conda environment reported in #29005), this works fine.


---

Comment by mkoeppe created at 2020-01-18 02:06:43

I will not add #29026 as a dependency because the main purpose of the present ticket is to prevent broken builds in the situation described in the ticket.

Needs review.


---

Comment by isuruf created at 2020-01-27 20:16:48

Changing status from needs_review to needs_work.


---

Comment by isuruf created at 2020-01-27 20:16:48

This would break building the conda package.


---

Comment by mkoeppe created at 2020-01-27 22:04:46

When building the conda package, are the c-compiler, cxx-compiler, and fortran-compiler packages not installed?


---

Comment by isuruf created at 2020-01-27 22:16:42

Nope. Individual packages like `gcc_linux-64` (or `clang_osx-64`) are installed.


---

Comment by mkoeppe created at 2020-01-27 22:18:24

Would you have a suggestion how we should test this more generally?


---

Comment by mkoeppe created at 2020-04-23 03:57:05

Replying to [comment:43 isuruf]:
> Individual packages like `gcc_linux-64` (or `clang_osx-64`) are installed.
In that case, are the environment variables CC and CXX guaranteed to be set?


---

Comment by git created at 2020-04-23 04:03:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-04-23 04:12:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-04-23 04:13:02

Changing status from needs_work to needs_review.


---

Comment by isuruf created at 2020-04-23 04:19:25

Replying to [comment:45 mkoeppe]:
> Replying to [comment:43 isuruf]:
> > Individual packages like `gcc_linux-64` (or `clang_osx-64`) are installed.
> In that case, are the environment variables CC and CXX guaranteed to be set?

Yes.


---

Comment by mkoeppe created at 2020-04-23 06:54:43

Then is the updated branch OK for building the conda package?


---

Comment by mkoeppe created at 2020-04-23 17:57:29

Changing priority from major to critical.


---

Comment by mkoeppe created at 2020-04-25 05:41:24

`@`isuruf Any objections?


---

Comment by isuruf created at 2020-04-25 06:16:36

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-04-25 06:17:19

Thank you!


---

Comment by vbraun created at 2020-04-25 22:16:37

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-04-25 22:16:37

Merge conflict


---

Comment by git created at 2020-04-25 22:43:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-04-25 22:44:13

rebased on 9.1.rc2


---

Comment by mkoeppe created at 2020-04-25 22:44:13

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2020-05-02 21:58:39

Resolution: fixed
