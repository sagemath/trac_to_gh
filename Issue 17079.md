# Issue 17079: RegularMatroid.is_isomorphic returns false positives

Issue created by migration from https://trac.sagemath.org/ticket/17316

Original creator: Stefan

Original creation time: 2014-11-11 21:46:41

CC:  yomcat rudi

Keywords: matroid, isomorphism

Example:


```
from sage.matroids.advanced import *
Mnew = RegularMatroid(groundset=range(12), matrix=Matrix(ZZ,
[[ 1, 0, 0, 0, 1, 0, 0,-1,-1, 0, 1, 0],
 [ 0, 1, 0, 0,-1, 1, 0, 0, 0, 0, 0, 0],
 [ 0, 0, 1, 0, 0,-1, 1, 0, 1, 0,-1, 0],
 [ 0, 0, 0, 1, 0, 0,-1, 1, 0, 0, 0, 0],
 [ 0, 0, 0, 0, 0, 1,-1, 0, 0, 1, 1, 0],
 [ 0, 0, 0, 0, 1, 0, 0,-1,-1, 0, 0, 1]]))

Nnew = RegularMatroid(groundset=range(12), matrix=Matrix(ZZ,
[[1,0,0,0,0,0,1,1,0,0,1,0],
 [0,1,0,0,0,0,1,0,1,0,1,0],
 [0,0,1,0,0,0,1,0,0,1,1,0],
 [0,0,0,1,0,0,1,1,0,0,0,1],
 [0,0,0,0,1,0,1,0,1,0,0,1],
 [0,0,0,0,0,1,1,0,0,1,0,1]]))

print Mnew.is_isomorphic(Nnew)
print len(Mnew.circuits()) == len(Nnew.circuits())
```



```
True
False
```



---

Comment by Rudi created at 2014-11-13 15:23:46

The bug is in _hypertest, or rather in the assumption that any isomorphism of the labelled graphs produced by _hypergraph() will also be an isomorphism of the projection matrices up to row/column scaling by -1. I know how to resolve this, but even with the release candidate I cannot develop on Yosemite (I cannot checkout this ticket). So here is my proposed fix, if anyone wants to get it over with right now. Otherwise, you have to wait until the regular development on Yosemite works again.

1) _hypertest, rather than returning True/False, should return an isomorphism or None. I think I would prefer it if the isomorphism is already translated to a map from the groundset of self to the groundset of other.

2) in _fast_isom_test, the final `return self._hypertest(other)' should be replaced with:

m=self._hypertest(other)
if m is None: return False
if self.is_field_isomorphism(other, m): return True

In the remaining case, _fast_isom_test should return None, so that really is the bottom line.

This will solve the issue. Is there a good reason why in _hypergraph, the vertex labels of the graph are not identical to the labels of the matroid ground set? If the `isomorphism' method is an implementation of McKay's algorithm, it may be possible to hand RegularMatroid._is_field_isomorphism down to that routine, and it will look a matroid isomorphism among the graph isomorphisms. That would be an even cleaner alternative solution.




 In addition, I would make the following optimizations:

3) in _invariant: compute the number of negative triangles of the projection matrix and stick that number in the hashed invariant:
P = self._projection()
        A = {}
        B = {}
        N = 0
        for i in xrange(P.nrows()):
            w = P.get_unsafe(i, i)
            if w != 0:
                if w in A:
                    A[w] += 1
                else:
                    A[w] = 1
            for j in xrange(i):
                w = abs(P.get_unsafe(i, j))
                if w != 0:
                    if w in B:
                        B[w] += 1
                    else:
                        B[w] = 1
                    for k in range(j):
                        if P.get_unsafe(i,j)*P.get_unsafe(j,k)*P.get_unsafe(k,i)<0: 
                            N=N+1
        self._r_invariant = hash(tuple([tuple([(w, A[w]) for w in sorted(A)]), tuple([(w, B[w]) for w in sorted(B)]), N]))
        return self._r_invariant

4) In _hypergraph,  these negative triangles themselves could also be added, as in the snippet of `old code'. 

5) _projection: also looks a bit wasteful to me now. det(X)*X.inverse() is just X.adjoint(). So:
if self._r_projection is None:
            R = self._basic_representation()._matrix_()
            self._r_projection = R.transpose() * (R * R.transpose()).adjoint() * R
return self._r_projection


---

Attachment

linear_matroid.pyx with fixed RegularMatroid isomorphism test


---

Comment by Rudi created at 2014-11-13 22:24:11

I could not resist implementing this, so I just did all of the above, except 4). But as I said, I cannot create a patch from my machine. So I just attached my new LinearMatroid.pyx file. Anyone who can create a patch for this ticket now only needs to upload my file.
 
Not sure if it matters, but I created this .pyx file by modifying the latest release candidate.

I'm still a bit bothered about the way groundset elements are changed into strings in _hypergraph. If this is not absolutely necessary, I'd like to remove that translation. It creates a bit of extra work later on in _hypertest that potentially gets repeated a lot.


---

Comment by Stefan created at 2014-11-14 00:34:47

Patches are the Old Way, you should make git branches and push those to the server. Check out the developer guide.


---

Comment by git created at 2014-11-14 14:44:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by Rudi created at 2014-11-14 14:54:51

Replying to [comment:3 Stefan]:
> Patches are the Old Way, you should make git branches and push those to the server. Check out the developer guide.

Stefan, I've been using the New Way for some time. 

My problem was and is that I have version of sage (6.3) in which I can communicate with the trac server but cannot compile, and another (6.4rc) in which I can compile but cannot communicate with trac. But I worked around it with a bit of copy-pasting. 

So here is my fix for review. If it fails to compile on 6.3 (I was not able to test that), then I will solve that when 6.4 is out, since this is a terrible way to work. But this code seemed to work fine in the release candidate.


---

Comment by Rudi created at 2014-11-14 14:54:51

Changing status from new to needs_review.


---

Comment by Stefan created at 2014-11-19 18:30:41

I would give the code a positive review, but I had to add an example showing that the bug was fixed. If you approve of my review patch, Rudi, you can set this ticket to Positive Review.
----
New commits:


---

Comment by Rudi created at 2014-11-19 18:52:09

Changing status from needs_review to positive_review.


---

Comment by Rudi created at 2014-11-19 18:52:09

Replying to [comment:8 Stefan]:
> I would give the code a positive review, but I had to add an example showing that the bug was fixed. If you approve of my review patch, Rudi, you can set this ticket to Positive Review.
> ----

Thanks, forgot that. 

If you are happy, then so am I. Positive review.


---

Comment by vbraun created at 2014-11-20 16:35:07

Resolution: fixed
