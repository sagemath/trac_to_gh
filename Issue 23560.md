# Issue 23560: Cygwin: openblas does not install correctly

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2017-09-07 10:25:39

For most of the time I've worked on Cygwin, I've been building with Cygwin's system BLAS (which I don't think is actually ATLAS, but using `--with-blas=atlas` and the appropriate `SAGE_ATLAS_LIB` picks it up and runs with it).

Recently I had to restart the Cygwin patchbot and forgot to configure it with these settings, so it built openblas (which seems to build successfully) but then grinds to a halt.  I think I was already aware there were problems like this with openblas and just didn't deal with it since there was a good workaround.  Still, it should be fixed.

The problem in scipy is that it simply fails to detect a BLAS library during its `setup.py egg_info`.

Similarly, gsl fails at configure time with:


```
[gsl-2.3] checking whether the C compiler works... no
[gsl-2.3] configure: error: in `/home/Admin/src/sagemath/sage/local/var/tmp/sage/build/gsl-2.3/src':
[gsl-2.3] configure: error: C compiler cannot create executables
[gsl-2.3] See `config.log' for more details
[gsl-2.3] Error configuring GSL.
```


where `config.log` shows:


```
configure:3480: checking whether the C compiler works
configure:3502: gcc -g -O2   -L/home/Admin/src/sagemath/sage/local/lib -Wl,-rpath,/home/Admin/src/sagemath/sage/local/lib  conftest.c -lopenblas -lm >&5
/usr/lib/gcc/x86_64-pc-cygwin/5.4.0/../../../../x86_64-pc-cygwin/bin/ld: cannot find -lopenblas
collect2: error: ld returned 1 exit status
configure:3506: $? = 1
configure:3544: result: no
configure: failed program was:
configure:3549: error: in `/home/Admin/src/sagemath/sage/local/var/tmp/sage/build/gsl-2.3/src':
configure:3551: error: C compiler cannot create executables
```

| /* confdefs.h */
| #define PACKAGE_NAME "gsl"
| #define PACKAGE_TARNAME "gsl"
| #define PACKAGE_VERSION "2.3"
| #define PACKAGE_STRING "gsl 2.3"
| #define PACKAGE_BUGREPORT ""
| #define PACKAGE_URL ""
| #define PACKAGE "gsl"
| #define VERSION "2.3"
| #define RELEASED /**/
| /* end confdefs.h.  */
|
| int
| main ()
| {
|
|   ;
|   return 0;
| }
So it both cases it looks like it's trying to explicitly link `-lopenblas`.

It seems that under `$SAGE_LOCAL/bin` there is a `libopenblas.dll`, and there is no `libopenblas.dll.a` import lib under `$SAGE_LOCAL/lib`.  There are a couple problems with this:

1) While current versions of gcc for Cygwin do not technically need a separate import lib (`.dll.a`), and can generate one directly from a `.dll`, the defaults (as explained [here https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/4/html/Using_ld_the_GNU_Linker/win32.html]) are such that on Cygwin there is a convention of prefixing library names with `cyg` instead of `lib`, and so for `ld` to find the right file for `-lopenblas` its name must be `cygopenblas.dll`.

2) Even if we had `cygopenblas.dll`, `-L $SAGE_LOCAL/bin` needs to be explicitly added to the linker flags to search in bin.

Instead I've been trying to keep the Cygwin build consistent about explicitly using import libs since that requires less fiddling.  So I'll investigate what needs to be fixed for openblas to install properly on Cygwin.


---

Comment by embray created at 2017-09-07 12:09:17

Changing keywords from "" to "openblas".


---

Comment by embray created at 2017-09-07 12:09:17

Adds a patch for this issue, which I will also submit upstream.
----
New commits:


---

Comment by embray created at 2017-09-07 12:09:17

Changing status from new to needs_review.


---

Comment by embray created at 2017-09-07 12:09:17

Changing priority from major to critical.


---

Comment by jdemeyer created at 2017-09-19 09:35:59

If this works for you...


---

Comment by jdemeyer created at 2017-09-19 09:35:59

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-09-20 22:26:18

Resolution: fixed
