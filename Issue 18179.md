# Issue 18179: UniqueRepresentation issue with PowerSeriesRing

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2015-05-14 06:28:53

CC:  niles simonking tscrim slelievre

The power series ring (`sage.rings.power_series_ring.PowerSeriesRing`) inherits from `UniqueRepresentation`. In the argument of the constructor there is the precision (`prec`) but it can be modified! Which leads to wrong behavior

```
sage: R1 = PowerSeriesRing(QQ, 'x', 3)
sage: R2 = PowerSeriesRing(QQ, 'x', 3)
sage: R1 is R2
True
sage: R2 = PowerSeriesRing(QQ, 'x', 4)
sage: R1 is R2
False
sage: R2.set_default_prec(3)
sage: R1 == R2
False
```

Moreover, a function can modify a power series in use

```
sage: def haha()
....:     PowerSeriesRing(QQ, 'x').set_default_prec(1)
sage: R = PowerSeriesRing(QQ, 'x')
sage: R.default_prec()
20
sage: haha()
sage: R.default_prec()
1
```



---

Comment by alexjbest created at 2019-03-09 08:03:44

Does anyone know the status of this?

The corresponding behavior for LaurentSeries was deprecated in #16201 (which also mentions power series) and finally removed in #26915 .


So now we are in the situation where PowerSeries and LaurentSeries work quite differently here, I can't see any real reason for this.


---

Comment by tscrim created at 2019-03-09 21:35:51

+1 on deprecating the `set_default_prec` for `PowerSeriesRing` for the same reasons as for `LaurentSeriesRing`.


---

Comment by tscrim created at 2019-03-09 21:36:47

Even worse in terms of hidden side effects:

```
sage: R.<x> = LaurentSeriesRing(QQ,50)
sage: R.default_prec()
50
sage: S = PowerSeriesRing(QQ,50,names='x')
sage: S.set_default_prec(10)
sage: R.default_prec()
10
```



---

Comment by niles created at 2019-03-11 15:13:00

yes, this should definitely be changed


---

Comment by embray created at 2019-03-25 10:41:19

Moving all blocker/critical issues from 8.7 to 8.8.


---

Comment by embray created at 2019-07-03 11:39:12

Moving open critical and blocker issues to the next release milestone (optimistically).


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by @mjungmath created at 2021-01-20 13:21:05

I propose to go back to the idea from #16201. In particular, we should handle the whole precision business using a global variable. If desired, one could introduce several global variables (e.g. one for univariate power series and another for multivariate).

I'll upload a branch soon.


---

Comment by @mjungmath created at 2021-01-20 15:06:27

Okay, this is tricky: mostly all doctests heavily rely on the `default_prec` syntax, which is actually bad. Either we add after each example where the precision has been changed a


```
sage: set_series_precision(20)  # reset to default
```


or we have to establish each example with the default precision.

At least, this behavior would be expected with the proposed changes, whereas now it is entirely random to the user.

Alternatively, we come up with an entirely different solution. I am open for suggestions.


---

Comment by @mjungmath created at 2021-01-20 21:56:26

So, this my first approach. Since the global variable `series_prec` keeps track of the multivariate case too (otherwise one runs into problems with the background power series ring), I set the default to 15, as a compromise for now.

If this meets your approval, we have to think what we should do with the failed doctests.

I know, this is a big change. But the current behavior should not be further promoted either.
----
New commits:


---

Comment by @mjungmath created at 2021-01-20 21:56:26

Changing keywords from "" to "power_series".


---

Comment by git created at 2021-01-20 21:58:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-01-21 00:23:09

Replying to [comment:12 gh-mjungmath]:
> I propose to go back to the idea from #16201. In particular, we should handle the whole precision business using a global variable. If desired, one could introduce several global variables (e.g. one for univariate power series and another for multivariate).

I am a very strong -1 on having a global variable for default precision. This would have far too many unintended side effects where code could seemingly-randomly change because you changed the default precision. This is something that should be strongly associated to the ring. I think the idea on #16201 of removing the ability to set the default precision is the correct one. If you want to change the precision, you need a new ring. This would be in line with real numbers.


---

Comment by vdelecroix created at 2021-01-21 07:55:39

Replying to [comment:18 tscrim]:
> Replying to [comment:12 gh-mjungmath]:
> > I propose to go back to the idea from #16201. In particular, we should handle the whole precision business using a global variable. If desired, one could introduce several global variables (e.g. one for univariate power series and another for multivariate).
> 
> I am a very strong -1 on having a global variable for default precision. This would have far too many unintended side effects where code could seemingly-randomly change because you changed the default precision. This is something that should be strongly associated to the ring. I think the idea on #16201 of removing the ability to set the default precision is the correct one. If you want to change the precision, you need a new ring. This would be in line with real numbers.

I totally agree: no precision should be handled by global variables. We have parents exactly for that purpose.


---

Comment by @mjungmath created at 2021-01-21 08:29:25

Watching how unpredictable the doctest behaves after this change, I totally agree. To be honest, I wasn't so convinced of this idea either.

So, remove all doctest related to `set_default_prec` and deprecate that function?


---

Comment by @mjungmath created at 2021-01-21 08:30:29

What about the current global variable? I think that should be deprecated as well if we don't pursue that behavior.


---

Comment by @mjungmath created at 2021-01-21 13:36:17

For some reason, both the Laurent series ring and power series ring refer to the global series precision in the documentation even though they just use the locally defined default precision

However, effectively, the global series precision is only used in `expression.pyx`.

How do we treat elements of a power series ring with different precision than its parent? I tend to say that the element's precision should be fixed and linked to the parent. But this would change the entire behavior of power series.


---

Comment by tscrim created at 2021-01-21 22:59:49

Yes, we should deprecate `set_default_prec`.

There is some use for that global variable, that is to ensure consistency across implementations in Sage as it is not exposed to the user. It can also be used by an expert who knows what they are doing.

There should be a coercion from a parent with more (default) precision to one with less precision (over the same variables and base ring). (Of course, conversions should clearly be allowed.) This is in agreement with real numbers and if you create one with less precision, you are expecting to have less precision in the future. On the other hand, there is an argument that would say that because of how the precision is used, we should go the other way because we hold onto the cutoff and we should be as accurate as possible.

I doubt for most people there will be any practical change.


---

Comment by @mjungmath created at 2021-01-22 11:23:27

Replying to [comment:23 tscrim]:
> Yes, we should deprecate `set_default_prec`.
> 
> There is some use for that global variable, that is to ensure consistency across implementations in Sage as it is not exposed to the user. It can also be used by an expert who knows what they are doing.
> 
> There should be a coercion from a parent with more (default) precision to one with less precision (over the same variables and base ring). (Of course, conversions should clearly be allowed.) This is in agreement with real numbers and if you create one with less precision, you are expecting to have less precision in the future. On the other hand, there is an argument that would say that because of how the precision is used, we should go the other way because we hold onto the cutoff and we should be as accurate as possible.
> 
> I doubt for most people there will be any practical change.

Then, this needs a change of the current behavior, which is that the element's precision and precision of its parent are independent:


```
sage: R.<x> = PowerSeriesRing(QQ, default_prec=10)
sage: p = R(x, prec=20); p
x + O(x^20)
sage: p.sin()
x - 1/6*x^3 + 1/120*x^5 - 1/5040*x^7 + 1/362880*x^9 - 1/39916800*x^11 + 1/6227020800*x^13 - 1/1307674368000*x^15 + 1/355687428096000*x^17 - 1/121645100408832000*x^19 + O(x^20)
sage: p.sin() in R
True
```



---

Comment by nbruin created at 2021-01-23 05:27:21

Replying to [comment:24 gh-mjungmath]:
> Then, this needs a change of the current behavior, which is that the element's precision and precision of its parent are independent

There's no particular problem with that: it's a default precision. If you explicitly want, you can ask for more precision. The issue arises because some operations (like coercing 1/(1+x) into a power series ring) need to choose a finite precision. In those cases, the default precision comes in.

There are other models; see the p-adics: for computational efficiency you may want to ensure you're never carrying around *more* than a certain number of terms. That would lead to a "capped precision" ring. But then you probably still want to allow for elements with less precision, because cancellation may mean that you simply can't determine more than a certain number of terms.


---

Comment by @mjungmath created at 2021-01-23 10:22:14

I agree in so far as currently there's no particular problem with that behavior. In fact, the term `default_prec` and especially the method `set_defeault_prec` even promote it.

However, if we want to _fix_ the (default) precision of a power series ring instance, as Travis suggested in line with the real numbers, wouldn't it be confusing if its elements can still adopt higher (or lower) precision? This could also lead to unexpected and unwanted behavior when you try to coerce elements into elements of rings with higher/lower precision. This is in line with the real numbers, where you choose a precision and cannot increase the precision afterwards, and this makes perfect sense for power series, too. Increasing the precision (however that shall be possible after we've fixed the default precision and cannot be changed anymore), should then lead to another parent with corresponding higher precision.

One exception could be an element with infinite precision (i.e. a polynomial).


---

Comment by tscrim created at 2021-01-23 22:08:14

I think you are again confusing the precision of the element and the default precision of the ring. The former doesn't change no matter the default precision of the ring you are in. The latter only comes into play when you are doing a computation that requires a cutoff, such as division. The reality is I doubt anyone will be making a bunch of different power series rings with different precisions and mixing them together. The analog I made with the real numbers is not an exact comparison, but merely to point out the precedence for having a precision value set in the parent construction.


---

Comment by nbruin created at 2021-01-24 02:32:24

Replying to [comment:26 gh-mjungmath]:
> This is in line with the real numbers, where you choose a precision and cannot increase the precision afterwards, and this makes perfect sense for power series, too.

The analogue of floating point numbers would be a laurent polynomial ring where you just chop after a fixed number of terms. Power series rings and p-adics actually more resemble the `RealIntervalField` and `RealBallField`, where elements carry precision information with it, so that you can actually PROVE that two elements are distinct (you can only do that with floating point if you analyze the computation that you have used to arrive at those numbers).


---

Comment by @mjungmath created at 2021-01-24 10:57:14

Okay, I obviously misunderstood Travis' comparison with the real numbers. Thank you both for your thorough explaination.

So, the idea is then simply to deprecate `set_default_prec`, remove its use in the documentation and provide a coercion (and keep the precision for elements)? Then add some examples like


```
sage: R.<x> = PowerSeriesRing(QQ, default_prec=10)
sage: f = sin(x); f
x - 1/6*x^3 + 1/120*x^5 - 1/5040*x^7 + 1/362880*x^9 + O(x^10)
sage: P.<x> = PowerSeriesRing(QQ, default_prec=5)
sage. P(f)
x - 1/6*x^3 + O(x^5)
```



---

Comment by tscrim created at 2021-02-01 03:55:13

Yes, that is correct other than the example, where the result of `P(f)` will be the same `f`. However, a good illustration of the difference is doing the exact same computation but in `P` (which will yield the output you have).


---

Comment by git created at 2021-02-01 17:32:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @mjungmath created at 2021-02-01 17:33:34

Changing status from new to needs_review.


---

Comment by @mjungmath created at 2021-02-01 18:28:42

Something like this?


---

Comment by git created at 2021-02-01 19:11:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-02-02 06:31:39

Overall yes, but I think it would be better to deprecate the `set_default_prec` in `Nonexact` and continue to use that mix-in class. It is a nice indicator class that might be useful. Plus it would fix both types of power series rings in one place and make future maintenance easier.


---

Comment by @mjungmath created at 2021-02-02 07:59:03

Are you sure this is a good idea? I mean, this method only causes trouble when you mix-in the class together with `UniqueRepresentation`. What if one still wants to use `Nonexact` and the feature `set_default_prec`?


---

Comment by git created at 2021-02-02 08:51:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-02-02 08:53:06

Okay, this class is used nowhere else. Instead, I have deprecated the method in `Nonexact` and improved its documentation to clarify the proper usage.


---

Comment by git created at 2021-02-02 08:57:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-02-04 05:23:02

The only things I would change before giving a positive review (with a green patchbot) are the deprecation message to

```
The method set_default_prec() is deprecated and will be removed in a future version of Sage. The default precision is set during construction.
```

and this

```diff
-The default precision of a power series ring instance stays fixed and
-cannot be changed. To work with different default precisions, we must
-establish new instances instead::
+The default precision of a power series ring stays fixed and
+cannot be changed. To work with different default precision, create
+a new power series ring::
```



---

Comment by git created at 2021-02-05 09:34:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @mjungmath created at 2021-02-05 09:36:01

There we go. :)


---

Comment by chapoton created at 2021-02-05 19:29:01

changing src/bin/sage is not a thing to do


---

Comment by @mjungmath created at 2021-02-05 19:46:29

I merged #31263 to use the `sage -b` command...

Rebase?


---

Comment by chapoton created at 2021-02-05 20:47:20

* you could have used "make build" instead of "sage -b", until this is repaired

* do not rebase, but add #31263 in the dependency field here above (I did that for you)

* changing the src/bin/sage file make your ticket "unsafe", so patchbots do not test it


---

Comment by @mjungmath created at 2021-02-05 22:12:04

That is good to know. Thank you for pointing this out.

Travis, are you satisfied?


---

Comment by tscrim created at 2021-02-08 23:42:19

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2021-02-08 23:42:19

Yep. LGTM. Thank you.


---

Comment by vbraun created at 2021-02-28 12:16:39

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-02-28 12:16:39


```
[dochtml] Traceback (most recent call last):
[dochtml]   File "/usr/lib64/python3.9/runpy.py", line 197, in _run_module_as_main
[dochtml]     return _run_code(code, main_globals, None,
[dochtml]   File "/usr/lib64/python3.9/runpy.py", line 87, in _run_code
[dochtml]     exec(code, run_globals)
[dochtml]   File "/home/release/Sage/local/lib64/python3.9/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
[dochtml]     main()
[dochtml]   File "/home/release/Sage/local/lib64/python3.9/site-packages/sage_setup/docbuild/__init__.py", line 1738, in main
[dochtml]     builder()
[dochtml]   File "/home/release/Sage/local/lib64/python3.9/site-packages/sage_setup/docbuild/__init__.py", line 345, in _wrapper
[dochtml]     getattr(get_builder(document), 'inventory')(*args, **kwds)
[dochtml]   File "/home/release/Sage/local/lib64/python3.9/site-packages/sage_setup/docbuild/__init__.py", line 577, in _wrapper
[dochtml]     self._build_everything_except_bibliography(lang, format, *args, **kwds)
[dochtml]   File "/home/release/Sage/local/lib64/python3.9/site-packages/sage_setup/docbuild/__init__.py", line 563, in _build_everything_except_bibliography
[dochtml]     build_many(build_ref_doc, non_references)
[dochtml]   File "/home/release/Sage/local/lib64/python3.9/site-packages/sage_setup/docbuild/__init__.py", line 297, in build_many
[dochtml]     _build_many(target, args, processes=processes)
[dochtml]   File "/home/release/Sage/local/lib64/python3.9/site-packages/sage_setup/docbuild/utils.py", line 289, in build_many
[dochtml]     raise worker_exc.original_exception
[dochtml] OSError: /home/release/Sage/local/lib64/python3.9/site-packages/sage/structure/nonexact.py:docstring of sage.structure.nonexact.Nonexact:6: WARNING: Bullet list ends without a blank line; unexpected unindent.
[dochtml] 
[dochtml]     Note: incremental documentation builds sometimes cause spurious
[dochtml]     error messages. To be certain that these are real errors, run
[dochtml]     "make doc-clean" first and try again.
make[3]: *** [Makefile:1916: doc-html] Error 1
```



---

Comment by git created at 2021-02-28 14:25:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-02-28 14:25:52

Just one character missing...here we go.


---

Comment by @mjungmath created at 2021-02-28 14:25:52

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2021-02-28 22:02:40

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-03-07 17:06:34

Resolution: fixed
