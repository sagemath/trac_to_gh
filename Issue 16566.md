# Issue 16566: Reimplement matrix_integer_dense using FLINT

archive/issues_016566.json:
```json
{
    "body": "CC:  @pjbruin\n\nKeywords: flint, matrix\n\nIn this ticket we reimplement all of matrix_integer_dense using FLINT fmpz_mat_t.\n\nThe speed-up is substantial. With the new code:\n\n```\nsage: A = Matrix(ZZ,1000,1000,range(10^6))\nsage: %time B = A*A\nCPU times: user 883 ms, sys: 3.33 ms, total: 887 ms\nWall time: 888 ms\n```\n\nThis takes more than 1 minute in the same computer using Sage 6.3.\n\nIssue created by migration from https://trac.sagemath.org/ticket/16803\n\n",
    "created_at": "2014-08-12T16:39:14Z",
    "labels": [
        "component: linear algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Reimplement matrix_integer_dense using FLINT",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16566",
    "user": "https://github.com/mmasdeu"
}
```
CC:  @pjbruin

Keywords: flint, matrix

In this ticket we reimplement all of matrix_integer_dense using FLINT fmpz_mat_t.

The speed-up is substantial. With the new code:

```
sage: A = Matrix(ZZ,1000,1000,range(10^6))
sage: %time B = A*A
CPU times: user 883 ms, sys: 3.33 ms, total: 887 ms
Wall time: 888 ms
```

This takes more than 1 minute in the same computer using Sage 6.3.

Issue created by migration from https://trac.sagemath.org/ticket/16803





---

archive/issue_comments_217673.json:
```json
{
    "body": "By the way, after rebasing it does not compile. I will fix it tomorrow hopefully.",
    "created_at": "2014-08-12T18:21:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217673",
    "user": "https://github.com/mmasdeu"
}
```

By the way, after rebasing it does not compile. I will fix it tomorrow hopefully.



---

archive/issue_comments_217674.json:
```json
{
    "body": "A word of caution about algorithm defaults: FLINT should generally be faster for small input but IML/Linbox etc. probably have much better code for things like nullspace, charpoly... as soon as the matrices start to get large.\n\nReplacing _rational_kernel_iml with _rational_kernel_flint, for example, is strange. Surely both algorithms should be available.",
    "created_at": "2014-08-12T22:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217674",
    "user": "https://github.com/fredrik-johansson"
}
```

A word of caution about algorithm defaults: FLINT should generally be faster for small input but IML/Linbox etc. probably have much better code for things like nullspace, charpoly... as soon as the matrices start to get large.

Replacing _rational_kernel_iml with _rational_kernel_flint, for example, is strange. Surely both algorithms should be available.



---

archive/issue_comments_217675.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-15T18:11:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217675",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_217676.json:
```json
{
    "body": "I rewrote the code to have all the previous functionality available. The code compiles and passes all the doctests in the matrix/ folder. I will have it run all the doctests during the weekend.",
    "created_at": "2014-08-15T18:23:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217676",
    "user": "https://github.com/mmasdeu"
}
```

I rewrote the code to have all the previous functionality available. The code compiles and passes all the doctests in the matrix/ folder. I will have it run all the doctests during the weekend.



---

archive/issue_comments_217677.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-19T17:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217677",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_217678.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-21T14:07:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217678",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_217679.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-08-22T12:54:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217679",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_217680.json:
```json
{
    "body": "Hi,\n\nA first remark playing around with timings is that in sage-6.3 somebody or something has definitely *completely massively screwed* up Linbox, or how Linbox is built, or how we use linbox, which was the default representation and library for arithmetic. Consider this:\n\n```\nsage: n=200; set_random_seed(0); a = random_matrix(ZZ,n); b = random_matrix(ZZ,n)\nsage: %time c=a._multiply_linbox(b)\nCPU times: user 326 ms, sys: 3.63 ms, total: 330 ms\nWall time: 347 ms\nsage: %time c=a._multiply_multi_modular(b)\nCPU times: user 51.5 ms, sys: 1.6 ms, total: 53.1 ms\nWall time: 56.1 ms\nsage: n=400; set_random_seed(0); a = random_matrix(ZZ,n); b = random_matrix(ZZ,n)\nsage: %time c=a._multiply_linbox(b)\nCPU times: user 5.28 s, sys: 22.8 ms, total: 5.3 s\nWall time: 5.37 s\nsage: %time c=a._multiply_multi_modular(b)\nCPU times: user 230 ms, sys: 6.08 ms, total: 236 ms\nWall time: 248 ms\n```\n\nLinbox should easily beat the multiply_multi_modular approach -- that's just basically a naive version of the same thing linbox would be doing if it were properly built and linked.  Instead, Linbox is massively slower.   In fact, almost exactly as much slower as I would expect if the wrong BLAS were being linked.    Note that I tested against the new flint backend and now a._multiply_multi_modular(b) is asymptotically similar to flint, though asymptotically (for n=2000 already), they are pretty close to the same in speed (8.55s versus 11.4s).      In any case, somebody should really look into why linbox is so screwed up -- we switched to it initially since it was much better than doing a._multiply_multi_modular(b) and also our own strassen implementation.",
    "created_at": "2014-08-29T07:41:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217680",
    "user": "https://github.com/williamstein"
}
```

Hi,

A first remark playing around with timings is that in sage-6.3 somebody or something has definitely *completely massively screwed* up Linbox, or how Linbox is built, or how we use linbox, which was the default representation and library for arithmetic. Consider this:

```
sage: n=200; set_random_seed(0); a = random_matrix(ZZ,n); b = random_matrix(ZZ,n)
sage: %time c=a._multiply_linbox(b)
CPU times: user 326 ms, sys: 3.63 ms, total: 330 ms
Wall time: 347 ms
sage: %time c=a._multiply_multi_modular(b)
CPU times: user 51.5 ms, sys: 1.6 ms, total: 53.1 ms
Wall time: 56.1 ms
sage: n=400; set_random_seed(0); a = random_matrix(ZZ,n); b = random_matrix(ZZ,n)
sage: %time c=a._multiply_linbox(b)
CPU times: user 5.28 s, sys: 22.8 ms, total: 5.3 s
Wall time: 5.37 s
sage: %time c=a._multiply_multi_modular(b)
CPU times: user 230 ms, sys: 6.08 ms, total: 236 ms
Wall time: 248 ms
```

Linbox should easily beat the multiply_multi_modular approach -- that's just basically a naive version of the same thing linbox would be doing if it were properly built and linked.  Instead, Linbox is massively slower.   In fact, almost exactly as much slower as I would expect if the wrong BLAS were being linked.    Note that I tested against the new flint backend and now a._multiply_multi_modular(b) is asymptotically similar to flint, though asymptotically (for n=2000 already), they are pretty close to the same in speed (8.55s versus 11.4s).      In any case, somebody should really look into why linbox is so screwed up -- we switched to it initially since it was much better than doing a._multiply_multi_modular(b) and also our own strassen implementation.



---

archive/issue_comments_217681.json:
```json
{
    "body": "OK, I've been skeptically looking at and testing this patch much of today.  I made a few  tiny changes, but frankly I think this is overall AWESOME.   FLINT's linear algebra seems quite good. \n\nThe following three methods are now still gone.  Add them back so I can run some randomized consistency tests more easily...\n\n```\n     a._multiply_classical      a._multiply_linbox         a._multiply_multi_modular\n```\n\nWhen these are added back, and I run tests of correctness by comparing with them, then I'll give this an enthusiastic positive review.",
    "created_at": "2014-08-29T16:15:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217681",
    "user": "https://github.com/williamstein"
}
```

OK, I've been skeptically looking at and testing this patch much of today.  I made a few  tiny changes, but frankly I think this is overall AWESOME.   FLINT's linear algebra seems quite good. 

The following three methods are now still gone.  Add them back so I can run some randomized consistency tests more easily...

```
     a._multiply_classical      a._multiply_linbox         a._multiply_multi_modular
```

When these are added back, and I run tests of correctness by comparing with them, then I'll give this an enthusiastic positive review.



---

archive/issue_comments_217682.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-08-29T16:15:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217682",
    "user": "https://github.com/williamstein"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_217683.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-08-29T16:15:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217683",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_217684.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-01T08:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217684",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_217685.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-01T10:55:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217685",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_217686.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-09-01T10:59:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217686",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_217687.json:
```json
{
    "body": "I have added the three functions back, and run the long tests in sage/matrix/.",
    "created_at": "2014-09-01T10:59:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217687",
    "user": "https://github.com/mmasdeu"
}
```

I have added the three functions back, and run the long tests in sage/matrix/.



---

archive/issue_comments_217688.json:
```json
{
    "body": "MAJOR PROBLEM!  Now that multiply_multi_modular is back, I wrote code to do some random testing of correctness.  I did not find situations where things are wrong... however, I quickly ran into major trouble because this ticket introduces a huge memory leak.    I just defined two matrices and multiplied them a few hundred times, and had major ram problems.  In particular, in sage-6.3 (without this branch):\n\n```\nsage: get_memory_usage()\n1047.1875\nsage: for i in range(50):\n....:         a=random_matrix(ZZ,300); del a\n....: \nsage: get_memory_usage()\n1047.1875\n```\n\nWith this ticket:\n\n```\nsage: get_memory_usage()\n2132.09765625\nsage: for i in range(50):\n    a=random_matrix(ZZ,300); del a\n....: \nsage: get_memory_usage()\n2231.3203125\n```\n\n**Conclusion: making nontrivial use of the code on this ticket will very quickly use up all RAM on your computer.**\n\nSo... needs work until that is fixed.",
    "created_at": "2014-09-01T11:13:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217688",
    "user": "https://github.com/williamstein"
}
```

MAJOR PROBLEM!  Now that multiply_multi_modular is back, I wrote code to do some random testing of correctness.  I did not find situations where things are wrong... however, I quickly ran into major trouble because this ticket introduces a huge memory leak.    I just defined two matrices and multiplied them a few hundred times, and had major ram problems.  In particular, in sage-6.3 (without this branch):

```
sage: get_memory_usage()
1047.1875
sage: for i in range(50):
....:         a=random_matrix(ZZ,300); del a
....: 
sage: get_memory_usage()
1047.1875
```

With this ticket:

```
sage: get_memory_usage()
2132.09765625
sage: for i in range(50):
    a=random_matrix(ZZ,300); del a
....: 
sage: get_memory_usage()
2231.3203125
```

**Conclusion: making nontrivial use of the code on this ticket will very quickly use up all RAM on your computer.**

So... needs work until that is fixed.



---

archive/issue_comments_217689.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-01T13:21:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217689",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_217690.json:
```json
{
    "body": "I don't think the changeset with name \"Fixed memory leak\" fixes the memory leak, at least not for matrix multiplication.  I'm not sure if you're done yet.  With your fix, if you run the functions `test1`, `test2` or `test3` in the script `2014-08-29-180550-stupid-test.sage` below, then the memory usage (print out second) grows quite rapidly and doesn't go down.  Doing the same thing in sage-6.3 results in almost no leakage of the heap.    In particular, with your patch after running those 3 tests I ended up with over 2GB extra memory used (oer startup), even after doing `import gc; gc.collect()`.  Doing the identical thing with sage-6.3 uses only a few MB's. \n\n```\ndef t0(n):\n    a = random_matrix(ZZ,n)\n    b = random_matrix(ZZ,n)\n    assert a*b == a*b\n\ndef t(n):\n    a = random_matrix(ZZ,n)\n    b = random_matrix(ZZ,n)\n    assert a*b == a._multiply_multi_modular(b)\n\ndef test1():\n    for n in range(1,50):\n        print n, get_memory_usage()\n        set_random_seed(0)\n        for i in range(100):\n            t(n)\n\ndef test2():\n    for n in range(51,150):\n        print n, get_memory_usage()\n        set_random_seed(0)\n        for i in range(10):\n            t(n)\n\n\ndef t2(n):\n    a = random_matrix(ZZ,n,2*n)\n    b = random_matrix(ZZ,2*n,n)\n    at = a.transpose()\n    bt = b.transpose()\n    assert a*b == a._multiply_multi_modular(b)\n    assert bt*at == bt._multiply_multi_modular(at)\n\ndef test3():\n    for n in range(1,50):\n        print n, get_memory_usage()\n        set_random_seed(0)\n        for i in range(50):\n            t2(n)\n```",
    "created_at": "2014-09-01T15:11:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217690",
    "user": "https://github.com/williamstein"
}
```

I don't think the changeset with name "Fixed memory leak" fixes the memory leak, at least not for matrix multiplication.  I'm not sure if you're done yet.  With your fix, if you run the functions `test1`, `test2` or `test3` in the script `2014-08-29-180550-stupid-test.sage` below, then the memory usage (print out second) grows quite rapidly and doesn't go down.  Doing the same thing in sage-6.3 results in almost no leakage of the heap.    In particular, with your patch after running those 3 tests I ended up with over 2GB extra memory used (oer startup), even after doing `import gc; gc.collect()`.  Doing the identical thing with sage-6.3 uses only a few MB's. 

```
def t0(n):
    a = random_matrix(ZZ,n)
    b = random_matrix(ZZ,n)
    assert a*b == a*b

def t(n):
    a = random_matrix(ZZ,n)
    b = random_matrix(ZZ,n)
    assert a*b == a._multiply_multi_modular(b)

def test1():
    for n in range(1,50):
        print n, get_memory_usage()
        set_random_seed(0)
        for i in range(100):
            t(n)

def test2():
    for n in range(51,150):
        print n, get_memory_usage()
        set_random_seed(0)
        for i in range(10):
            t(n)


def t2(n):
    a = random_matrix(ZZ,n,2*n)
    b = random_matrix(ZZ,2*n,n)
    at = a.transpose()
    bt = b.transpose()
    assert a*b == a._multiply_multi_modular(b)
    assert bt*at == bt._multiply_multi_modular(at)

def test3():
    for n in range(1,50):
        print n, get_memory_usage()
        set_random_seed(0)
        for i in range(50):
            t2(n)
```



---

archive/issue_comments_217691.json:
```json
{
    "body": "Just from a quick glance at the code, it looks like _lift_crt doesn't mpz_clear out tmp.",
    "created_at": "2014-09-02T13:45:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217691",
    "user": "https://github.com/fredrik-johansson"
}
```

Just from a quick glance at the code, it looks like _lift_crt doesn't mpz_clear out tmp.



---

archive/issue_comments_217692.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-02T16:33:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217692",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_217693.json:
```json
{
    "body": "Thanks Fredrik, I fixed that (although it was not the only problem, by far).\n\nThe previous commit was not finished yet (sorry for the confusing commit message). I believe that now the memory leaks are gone (at least those that were detected by William's tests). The main problem was that the get_unsafe_mpz function was initializing the value that it modifies in place, and all functions calling it were also mpz_init'ing it as well. All should be good now.",
    "created_at": "2014-09-02T16:37:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217693",
    "user": "https://github.com/mmasdeu"
}
```

Thanks Fredrik, I fixed that (although it was not the only problem, by far).

The previous commit was not finished yet (sorry for the confusing commit message). I believe that now the memory leaks are gone (at least those that were detected by William's tests). The main problem was that the get_unsafe_mpz function was initializing the value that it modifies in place, and all functions calling it were also mpz_init'ing it as well. All should be good now.



---

archive/issue_comments_217694.json:
```json
{
    "body": "Replying to [comment:9 was]:\n> A first remark playing around with timings is that in sage-6.3 somebody or something has definitely *completely massively screwed* up Linbox, or how Linbox is built, or how we use linbox, which was the default representation and library for arithmetic.\n\nAre you sure this isn't an imaginary slow-down?  Just for fun, I installed some old versions of Sage on boxen and executed the command\n\n```\n$ time ./sage -c '_ = Matrix(ZZ,1000,1000,range(10^6))^5'\n```\n\nI tested Sage versions 2.9(*), 2.11(*), 3.0.6, 3.2.3, 4.1, 4.5, 4.7, 5.0, 5.12, 6.1.1, 6.3 and the above command always took about 12 minutes. Note that boxen is not an idle machine, so it's difficult to get accurate timings, but there is certainly no massive slow-down.\n\n(*) For these versions, ATLAS didn't compile so I used the ATLAS package from Sage 3.0.6.",
    "created_at": "2014-09-03T12:39:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217694",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:9 was]:
> A first remark playing around with timings is that in sage-6.3 somebody or something has definitely *completely massively screwed* up Linbox, or how Linbox is built, or how we use linbox, which was the default representation and library for arithmetic.

Are you sure this isn't an imaginary slow-down?  Just for fun, I installed some old versions of Sage on boxen and executed the command

```
$ time ./sage -c '_ = Matrix(ZZ,1000,1000,range(10^6))^5'
```

I tested Sage versions 2.9(*), 2.11(*), 3.0.6, 3.2.3, 4.1, 4.5, 4.7, 5.0, 5.12, 6.1.1, 6.3 and the above command always took about 12 minutes. Note that boxen is not an idle machine, so it's difficult to get accurate timings, but there is certainly no massive slow-down.

(*) For these versions, ATLAS didn't compile so I used the ATLAS package from Sage 3.0.6.



---

archive/issue_comments_217695.json:
```json
{
    "body": "Replying to [comment:22 jdemeyer]:\n> Replying to [comment:9 was]:\n> > A first remark playing around with timings is that in sage-6.3 somebody or something has definitely *completely massively screwed* up Linbox, or how Linbox is built, or how we use linbox, which was the default representation and library for arithmetic.\n\n> Are you sure this isn't an imaginary slow-down?  Just for fun, I installed some old versions of Sage on boxen and executed the command\n> {{{\n> $ time ./sage -c '_ = Matrix(ZZ,1000,1000,range(10<sup>6))</sup>5'\n> }}}\n> \n> I tested Sage versions 2.9(*), 2.11(*), 3.0.6, 3.2.3, 4.1, 4.5, 4.7, 5.0, 5.12, 6.1.1, 6.3 and the above command always took about 12 minutes. Note that boxen is not an idle machine, so it's difficult to get accurate timings, but there is certainly no massive slow-down.\n> \n> (*) For these versions, ATLAS didn't compile so I used the ATLAS package from Sage 3.0.6.\n\n\nThanks for testing.   I wouldn't be at all surprised if the problem was introduced quite a long time ago -- I haven't benchmarked sage linear algebra at all since around the time when Clement was my postdoc (about 2007-2008), and at that time definitely a properly built linbox provided the fastest matrix multiply (and many other things).   It might still today -- I don't know.",
    "created_at": "2014-09-03T14:04:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217695",
    "user": "https://github.com/williamstein"
}
```

Replying to [comment:22 jdemeyer]:
> Replying to [comment:9 was]:
> > A first remark playing around with timings is that in sage-6.3 somebody or something has definitely *completely massively screwed* up Linbox, or how Linbox is built, or how we use linbox, which was the default representation and library for arithmetic.

> Are you sure this isn't an imaginary slow-down?  Just for fun, I installed some old versions of Sage on boxen and executed the command
> {{{
> $ time ./sage -c '_ = Matrix(ZZ,1000,1000,range(10<sup>6))</sup>5'
> }}}
> 
> I tested Sage versions 2.9(*), 2.11(*), 3.0.6, 3.2.3, 4.1, 4.5, 4.7, 5.0, 5.12, 6.1.1, 6.3 and the above command always took about 12 minutes. Note that boxen is not an idle machine, so it's difficult to get accurate timings, but there is certainly no massive slow-down.
> 
> (*) For these versions, ATLAS didn't compile so I used the ATLAS package from Sage 3.0.6.


Thanks for testing.   I wouldn't be at all surprised if the problem was introduced quite a long time ago -- I haven't benchmarked sage linear algebra at all since around the time when Clement was my postdoc (about 2007-2008), and at that time definitely a properly built linbox provided the fastest matrix multiply (and many other things).   It might still today -- I don't know.



---

archive/issue_comments_217696.json:
```json
{
    "body": "Replying to [comment:21 mmasdeu]:\n> Thanks Fredrik, I fixed that (although it was not the only problem, by far).\n> \n> The previous commit was not finished yet (sorry for the confusing commit message). I believe that now the memory leaks are gone (at least those that were detected by William's tests). The main problem was that the get_unsafe_mpz function was initializing the value that it modifies in place, and all functions calling it were also mpz_init'ing it as well. All should be good now.\n\n\nMarc -- can you update the code in our SD61 project in sagetest-marc so I can test this out.  I tried what was there, and it leaked like a sieve.",
    "created_at": "2014-09-03T14:04:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217696",
    "user": "https://github.com/williamstein"
}
```

Replying to [comment:21 mmasdeu]:
> Thanks Fredrik, I fixed that (although it was not the only problem, by far).
> 
> The previous commit was not finished yet (sorry for the confusing commit message). I believe that now the memory leaks are gone (at least those that were detected by William's tests). The main problem was that the get_unsafe_mpz function was initializing the value that it modifies in place, and all functions calling it were also mpz_init'ing it as well. All should be good now.


Marc -- can you update the code in our SD61 project in sagetest-marc so I can test this out.  I tried what was there, and it leaked like a sieve.



---

archive/issue_comments_217697.json:
```json
{
    "body": "It just finished compiling now. I got tired of bug-fixing in the cloud (some things are better done in private), and worked from my local copy in the last bit.",
    "created_at": "2014-09-03T15:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217697",
    "user": "https://github.com/mmasdeu"
}
```

It just finished compiling now. I got tired of bug-fixing in the cloud (some things are better done in private), and worked from my local copy in the last bit.



---

archive/issue_comments_217698.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-09-03T22:33:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217698",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_217699.json:
```json
{
    "body": "OK, I'm now officially thrilled/very happy by this code :-)",
    "created_at": "2014-09-03T22:33:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217699",
    "user": "https://github.com/williamstein"
}
```

OK, I'm now officially thrilled/very happy by this code :-)



---

archive/issue_comments_217700.json:
```json
{
    "body": "Merge conflict, probably from #16583",
    "created_at": "2014-09-05T11:02:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217700",
    "user": "https://github.com/vbraun"
}
```

Merge conflict, probably from #16583



---

archive/issue_comments_217701.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2014-09-05T11:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217701",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_217702.json:
```json
{
    "body": "Merged with\n\n```\ngit merge ticket/16583 -X theirs\n```\n\nCompiles fine, not tested again.\n\n---\nNew commits:",
    "created_at": "2014-09-05T11:41:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217702",
    "user": "https://github.com/jdemeyer"
}
```

Merged with

```
git merge ticket/16583 -X theirs
```

Compiles fine, not tested again.

---
New commits:



---

archive/issue_comments_217703.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2014-09-05T11:41:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217703",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_217704.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2014-09-05T15:11:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217704",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_217705.json:
```json
{
    "body": "I have just realized that (in a bad design choice) I was initializing allocating _rows and _entries for every single matrix created, which is not very efficient. Now it is only done when needed (i.e. when calling _init_linbox()). Changes are minimal, and I ran the tests (long version) in /matrix/ for safety, but I will resubmit for review.\n\n---\nNew commits:",
    "created_at": "2014-09-05T15:11:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217705",
    "user": "https://github.com/mmasdeu"
}
```

I have just realized that (in a bad design choice) I was initializing allocating _rows and _entries for every single matrix created, which is not very efficient. Now it is only done when needed (i.e. when calling _init_linbox()). Changes are minimal, and I ran the tests (long version) in /matrix/ for safety, but I will resubmit for review.

---
New commits:



---

archive/issue_comments_217706.json:
```json
{
    "body": "Be more careful about freeing.  Right now, in all cases, you do\n\n```\nsage_free(self._rows)\nsage_free(self._entries)\n```\n\nYou're depending on self._rows being automatically initialized to NULL (?), and sage_free doing the right thing when passed NULL.   Maybe that works, but I would be more comfortable if it was explicit, e.g., put self._rows=NULL and only free self._rows if not NULL (or check the source code and see whether it already works that way).",
    "created_at": "2014-09-05T16:24:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217706",
    "user": "https://github.com/williamstein"
}
```

Be more careful about freeing.  Right now, in all cases, you do

```
sage_free(self._rows)
sage_free(self._entries)
```

You're depending on self._rows being automatically initialized to NULL (?), and sage_free doing the right thing when passed NULL.   Maybe that works, but I would be more comfortable if it was explicit, e.g., put self._rows=NULL and only free self._rows if not NULL (or check the source code and see whether it already works that way).



---

archive/issue_comments_217707.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-05T16:49:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217707",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_217708.json:
```json
{
    "body": "Done.\n\n---\nNew commits:",
    "created_at": "2014-09-05T16:49:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217708",
    "user": "https://github.com/mmasdeu"
}
```

Done.

---
New commits:



---

archive/issue_comments_217709.json:
```json
{
    "body": "Its safe to call `sage_free` with `NULL`, but an unintialized pointer can have a non-null value. You should explicitly set all pointers to NULL in `__cinit__`.",
    "created_at": "2014-09-05T16:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217709",
    "user": "https://github.com/vbraun"
}
```

Its safe to call `sage_free` with `NULL`, but an unintialized pointer can have a non-null value. You should explicitly set all pointers to NULL in `__cinit__`.



---

archive/issue_comments_217710.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-09-05T16:54:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217710",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_217711.json:
```json
{
    "body": "Replying to [comment:36 vbraun]:\n> Its safe to call `sage_free` with `NULL`, but an unintialized pointer can have a non-null value. You should explicitly set all pointers to NULL in `__cinit__`.\n\n\nThanks for clarifying this.  The change he made does explicitly set pointers to NULL now, but it also checks for NULL before calling sage_free.  He should probably change that part back.\n\nAnyway, positive review.",
    "created_at": "2014-09-05T16:54:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217711",
    "user": "https://github.com/williamstein"
}
```

Replying to [comment:36 vbraun]:
> Its safe to call `sage_free` with `NULL`, but an unintialized pointer can have a non-null value. You should explicitly set all pointers to NULL in `__cinit__`.


Thanks for clarifying this.  The change he made does explicitly set pointers to NULL now, but it also checks for NULL before calling sage_free.  He should probably change that part back.

Anyway, positive review.



---

archive/issue_comments_217712.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2014-09-05T17:26:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217712",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_217713.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2014-09-05T17:26:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217713",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_217714.json:
```json
{
    "body": "I cleaned that up.",
    "created_at": "2014-09-05T17:27:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217714",
    "user": "https://github.com/mmasdeu"
}
```

I cleaned that up.



---

archive/issue_comments_217715.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-09-05T17:27:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217715",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_217716.json:
```json
{
    "body": "The commit is ok but the commit message is wrong ;-)   You initialize it to NULL, thats the whole point.",
    "created_at": "2014-09-05T17:28:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217716",
    "user": "https://github.com/vbraun"
}
```

The commit is ok but the commit message is wrong ;-)   You initialize it to NULL, thats the whole point.



---

archive/issue_comments_217717.json:
```json
{
    "body": "Argh! By uninitialized I meant unallocated. Sorry...",
    "created_at": "2014-09-05T18:01:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217717",
    "user": "https://github.com/mmasdeu"
}
```

Argh! By uninitialized I meant unallocated. Sorry...



---

archive/issue_comments_217718.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2014-09-06T11:04:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217718",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_217719.json:
```json
{
    "body": "Conflicts with #15946, please fix.",
    "created_at": "2014-09-06T11:04:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217719",
    "user": "https://github.com/vbraun"
}
```

Conflicts with #15946, please fix.



---

archive/issue_comments_217720.json:
```json
{
    "body": "I merged with #15946, but that revealed some genuine bugs with this ticket, hang on...\n\n---\nNew commits:",
    "created_at": "2014-09-07T18:10:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217720",
    "user": "https://github.com/jdemeyer"
}
```

I merged with #15946, but that revealed some genuine bugs with this ticket, hang on...

---
New commits:



---

archive/issue_comments_217721.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-07T18:44:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217721",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_217722.json:
```json
{
    "body": "Still needs work because of\n\n```\nsage -t src/sage/combinat/q_analogues.py\n**********************************************************************\nFile \"src/sage/combinat/q_analogues.py\", line 200, in sage.combinat.q_analogues.q_binomial\nFailed example:\n    q_binomial(4,2,matrix([[2,1],[-1,3]]))\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 480, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 843, in compile_and_execute\n        exec compiled in globs\n      File \"<doctest sage.combinat.q_analogues.q_binomial[14]>\", line 1, in <module>\n        q_binomial(Integer(4),Integer(2),matrix([[Integer(2),Integer(1)],[-Integer(1),Integer(3)]]))\n      File \"/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/combinat/q_analogues.py\", line 308, in q_binomial\n        return numerat/denomin\n      File \"element.pyx\", line 2743, in sage.structure.element.Matrix.__div__ (build/cythonized/sage/structure/element.c:20137)\n      File \"matrix_integer_dense.pyx\", line 923, in sage.matrix.matrix_integer_dense.Matrix_integer_dense._matrix_times_matrix_ (build/cythonized/sage/matrix/matrix_integer_dense.c:11570)\n      File \"c_lib.pyx\", line 97, in sage.ext.c_lib.sig_raise_exception (build/cythonized/sage/ext/c_lib.c:1208)\n    SignalError: Segmentation fault\n**********************************************************************\n```\n\nGiven that this test also fails (not with a segfault though) in the patchbot, I guess the merging isn't to blame.\n\nPlease fix this...",
    "created_at": "2014-09-07T19:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217722",
    "user": "https://github.com/jdemeyer"
}
```

Still needs work because of

```
sage -t src/sage/combinat/q_analogues.py
**********************************************************************
File "src/sage/combinat/q_analogues.py", line 200, in sage.combinat.q_analogues.q_binomial
Failed example:
    q_binomial(4,2,matrix([[2,1],[-1,3]]))
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 843, in compile_and_execute
        exec compiled in globs
      File "<doctest sage.combinat.q_analogues.q_binomial[14]>", line 1, in <module>
        q_binomial(Integer(4),Integer(2),matrix([[Integer(2),Integer(1)],[-Integer(1),Integer(3)]]))
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/combinat/q_analogues.py", line 308, in q_binomial
        return numerat/denomin
      File "element.pyx", line 2743, in sage.structure.element.Matrix.__div__ (build/cythonized/sage/structure/element.c:20137)
      File "matrix_integer_dense.pyx", line 923, in sage.matrix.matrix_integer_dense.Matrix_integer_dense._matrix_times_matrix_ (build/cythonized/sage/matrix/matrix_integer_dense.c:11570)
      File "c_lib.pyx", line 97, in sage.ext.c_lib.sig_raise_exception (build/cythonized/sage/ext/c_lib.c:1208)
    SignalError: Segmentation fault
**********************************************************************
```

Given that this test also fails (not with a segfault though) in the patchbot, I guess the merging isn't to blame.

Please fix this...



---

archive/issue_comments_217723.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-09-08T12:05:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217723",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_217724.json:
```json
{
    "body": "I have fixed this by changing the code of sage.structure.element.Matrix.__div__, which was assuming that the _matrix_times_matrix method of matrix.matrix_integer_dense would know how to deal with matrices over the rationals. This is a low-level private function which doesn't do type checking, which I think is the right thing to do.\n\nWhat the current patch does is, when writing something like A/B for matrices A and B, to take the denominator out of ~B, multiply and then put it back. I have run make ptest and all passed **except** for some that have nothing to do with matrices, for example this one:\n\n```\nsage -t src/sage/rings/integer.pyx\n**********************************************************************\nFile \"src/sage/rings/integer.pyx\", line 1954, in sage.rings.integer.Integer.__pow__\nFailed example:\n    2^(2^63-2)\nExpected:\n    Traceback (most recent call last):\n    ...\n    MemoryError: failed to allocate 1152921504606847008 bytes\nGot:\n    Fatal Python error: Insufficient memory\n    Traceback (most recent call last):\n      File \"/usr/local/sage/sage-6.3.beta6/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 480, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/usr/local/sage/sage-6.3.beta6/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 839, in execute\n        exec compiled in globs\n      File \"<doctest sage.rings.integer.Integer.__pow__[27]>\", line 1, in <module>\n        Integer(2)**(Integer(2)**Integer(63)-Integer(2))\n      File \"integer.pyx\", line 1999, in sage.rings.integer.Integer.__pow__ (build/cythonized/sage/rings/integer.c:14710)\n      File \"c_lib.pyx\", line 85, in sage.ext.c_lib.sig_raise_exception (build/cythonized/sage/ext/c_lib.c:1040)\n    RuntimeError: Aborted\n**********************************************************************\n```",
    "created_at": "2014-09-08T12:05:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217724",
    "user": "https://github.com/mmasdeu"
}
```

I have fixed this by changing the code of sage.structure.element.Matrix.__div__, which was assuming that the _matrix_times_matrix method of matrix.matrix_integer_dense would know how to deal with matrices over the rationals. This is a low-level private function which doesn't do type checking, which I think is the right thing to do.

What the current patch does is, when writing something like A/B for matrices A and B, to take the denominator out of ~B, multiply and then put it back. I have run make ptest and all passed **except** for some that have nothing to do with matrices, for example this one:

```
sage -t src/sage/rings/integer.pyx
**********************************************************************
File "src/sage/rings/integer.pyx", line 1954, in sage.rings.integer.Integer.__pow__
Failed example:
    2^(2^63-2)
Expected:
    Traceback (most recent call last):
    ...
    MemoryError: failed to allocate 1152921504606847008 bytes
Got:
    Fatal Python error: Insufficient memory
    Traceback (most recent call last):
      File "/usr/local/sage/sage-6.3.beta6/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/usr/local/sage/sage-6.3.beta6/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.rings.integer.Integer.__pow__[27]>", line 1, in <module>
        Integer(2)**(Integer(2)**Integer(63)-Integer(2))
      File "integer.pyx", line 1999, in sage.rings.integer.Integer.__pow__ (build/cythonized/sage/rings/integer.c:14710)
      File "c_lib.pyx", line 85, in sage.ext.c_lib.sig_raise_exception (build/cythonized/sage/ext/c_lib.c:1040)
    RuntimeError: Aborted
**********************************************************************
```



---

archive/issue_comments_217725.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-09-09T07:51:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217725",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_217726.json:
```json
{
    "body": "The patchbot reports a segmentation fault in `matrix_integer_dense.pyx`, which is likely due to this ticket.",
    "created_at": "2014-09-09T07:51:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217726",
    "user": "https://github.com/jdemeyer"
}
```

The patchbot reports a segmentation fault in `matrix_integer_dense.pyx`, which is likely due to this ticket.



---

archive/issue_comments_217727.json:
```json
{
    "body": "I cannot reproduce it. And I don't know where the error comes from, other than the coercion model not checking for types before calling the low-level functions...\n\n```\n~/sagetest-marc$ ./sage -t --long src/sage/modular/modform/ambient_R.py\nRunning doctests with ID 2014-09-09-08-48-58-b66cd1ea.\nDoctesting 1 file.\nsage -t --long --warn-long 26.1 src/sage/modular/modform/ambient_R.py\n    [26 tests, 29.09 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 29.2 seconds\n    cpu time: 27.7 seconds\n    cumulative wall time: 29.1 seconds\n```",
    "created_at": "2014-09-09T08:51:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217727",
    "user": "https://github.com/mmasdeu"
}
```

I cannot reproduce it. And I don't know where the error comes from, other than the coercion model not checking for types before calling the low-level functions...

```
~/sagetest-marc$ ./sage -t --long src/sage/modular/modform/ambient_R.py
Running doctests with ID 2014-09-09-08-48-58-b66cd1ea.
Doctesting 1 file.
sage -t --long --warn-long 26.1 src/sage/modular/modform/ambient_R.py
    [26 tests, 29.09 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 29.2 seconds
    cpu time: 27.7 seconds
    cumulative wall time: 29.1 seconds
```



---

archive/issue_comments_217728.json:
```json
{
    "body": "Your last fix is almost certainly going to break over other rings. In any case, this change requires extra doctests over other rings.\n\nI would advise the following: the matrix division coercion model bug is independent of this ticket. I recommend you to create a new ticket for that and make this ticket depend on that.",
    "created_at": "2014-09-09T14:04:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217728",
    "user": "https://github.com/jdemeyer"
}
```

Your last fix is almost certainly going to break over other rings. In any case, this change requires extra doctests over other rings.

I would advise the following: the matrix division coercion model bug is independent of this ticket. I recommend you to create a new ticket for that and make this ticket depend on that.



---

archive/issue_comments_217729.json:
```json
{
    "body": "I propose the following, which I think is a good solution (especially since the plan is to move matrices over rationals also to FLINT).\n\n```\ndef __div__(left,right):\n    return left * (~right)\n```\n\nI have tried this and it passes the tests. I will push the code in a minute.",
    "created_at": "2014-09-09T17:36:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217729",
    "user": "https://github.com/mmasdeu"
}
```

I propose the following, which I think is a good solution (especially since the plan is to move matrices over rationals also to FLINT).

```
def __div__(left,right):
    return left * (~right)
```

I have tried this and it passes the tests. I will push the code in a minute.



---

archive/issue_comments_217730.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-09-09T17:36:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217730",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_217731.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2014-09-09T17:45:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217731",
    "user": "https://github.com/mmasdeu"
}
```

Last 10 new commits:



---

archive/issue_comments_217732.json:
```json
{
    "body": "Replying to [comment:51 mmasdeu]:\n> I propose the following, which I think is a good solution (especially since the plan is to move matrices over rationals also to FLINT).\n> \n> \n> ```\n> def __div__(left,right):\n>     return left * (~right)\n> ```\n> \n> I have tried this and it passes the tests.\n\nYou need to add more doctests to this `__div__` function.",
    "created_at": "2014-09-09T19:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217732",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:51 mmasdeu]:
> I propose the following, which I think is a good solution (especially since the plan is to move matrices over rationals also to FLINT).
> 
> 
> ```
> def __div__(left,right):
>     return left * (~right)
> ```
> 
> I have tried this and it passes the tests.

You need to add more doctests to this `__div__` function.



---

archive/issue_comments_217733.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-09-09T19:18:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217733",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_217734.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-10T08:35:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217734",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_217735.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-09-10T08:36:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217735",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_217736.json:
```json
{
    "body": "Done.",
    "created_at": "2014-09-10T08:36:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217736",
    "user": "https://github.com/mmasdeu"
}
```

Done.



---

archive/issue_comments_217737.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-09-10T08:46:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217737",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_217738.json:
```json
{
    "body": "I really think more doctests are needed, also over rings which are not `ZZ` or `QQ` (see also comment [comment:50]). Perhaps `GF(3)` and `RDF` and `ZZ['t']` to have some wider coverage?\n\nAnd you should use the `:trac:`16803`` syntax to refer to Trac tickets (but given that this ticket has nothing to do with division of matrices, perhaps it makes more sense to just remove that comment).",
    "created_at": "2014-09-10T08:46:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217738",
    "user": "https://github.com/jdemeyer"
}
```

I really think more doctests are needed, also over rings which are not `ZZ` or `QQ` (see also comment [comment:50]). Perhaps `GF(3)` and `RDF` and `ZZ['t']` to have some wider coverage?

And you should use the `:trac:`16803`` syntax to refer to Trac tickets (but given that this ticket has nothing to do with division of matrices, perhaps it makes more sense to just remove that comment).



---

archive/issue_comments_217739.json:
```json
{
    "body": "Also, doctest division of a matrix by a scalar...",
    "created_at": "2014-09-10T08:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217739",
    "user": "https://github.com/jdemeyer"
}
```

Also, doctest division of a matrix by a scalar...



---

archive/issue_comments_217740.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-10T08:53:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217740",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_217741.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-10T08:55:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217741",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_217742.json:
```json
{
    "body": "Done!",
    "created_at": "2014-09-10T08:55:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217742",
    "user": "https://github.com/mmasdeu"
}
```

Done!



---

archive/issue_comments_217743.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-09-10T08:55:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217743",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_217744.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-09-10T09:16:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217744",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_217745.json:
```json
{
    "body": "In the last patches, you messed up the indentation from 4 to 3 spaces.",
    "created_at": "2014-09-10T09:16:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217745",
    "user": "https://github.com/jdemeyer"
}
```

In the last patches, you messed up the indentation from 4 to 3 spaces.



---

archive/issue_comments_217746.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-10T10:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217746",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_217747.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-09-10T10:07:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217747",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_217748.json:
```json
{
    "body": "Sorry. Fixed that.",
    "created_at": "2014-09-10T10:07:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217748",
    "user": "https://github.com/mmasdeu"
}
```

Sorry. Fixed that.



---

archive/issue_comments_217749.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-09-10T10:10:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217749",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_217750.json:
```json
{
    "body": "I think this still leaks memory.\n\nThe following command works without this patch, but fails with this patch:\n\n```\n( ulimit -v 2000000; ./sage -t --long src/sage/combinat/root_system/branching_rules.py )\n```",
    "created_at": "2014-09-10T10:10:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217750",
    "user": "https://github.com/jdemeyer"
}
```

I think this still leaks memory.

The following command works without this patch, but fails with this patch:

```
( ulimit -v 2000000; ./sage -t --long src/sage/combinat/root_system/branching_rules.py )
```



---

archive/issue_comments_217751.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-10T13:37:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217751",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_217752.json:
```json
{
    "body": "The bug reported in comment:65 may be related to an issue with infinite recursion. I traced it down to the modification of the __div__ function. With the current patch the command in comment:65 works, and all the tests in sage/structure and sage/matrix pass. I am now running make ptest and will report if something arises.",
    "created_at": "2014-09-10T13:44:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217752",
    "user": "https://github.com/mmasdeu"
}
```

The bug reported in comment:65 may be related to an issue with infinite recursion. I traced it down to the modification of the __div__ function. With the current patch the command in comment:65 works, and all the tests in sage/structure and sage/matrix pass. I am now running make ptest and will report if something arises.



---

archive/issue_comments_217753.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-09-10T13:44:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217753",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_217754.json:
```json
{
    "body": "I have rebased it again. It looks like some other code is a moving target and it is hard to keep pace...\n\n---\nLast 10 new commits:",
    "created_at": "2014-09-18T13:43:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217754",
    "user": "https://github.com/mmasdeu"
}
```

I have rebased it again. It looks like some other code is a moving target and it is hard to keep pace...

---
Last 10 new commits:



---

archive/issue_comments_217755.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-09-18T13:47:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217755",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_217756.json:
```json
{
    "body": "Since test pass, and the issues Jereon found were addressed, I'm switching this back to positive review.",
    "created_at": "2014-09-18T13:47:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217756",
    "user": "https://github.com/williamstein"
}
```

Since test pass, and the issues Jereon found were addressed, I'm switching this back to positive review.



---

archive/issue_comments_217757.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2014-09-18T15:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217757",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_217758.json:
```json
{
    "body": "This still fails, I'm pretty sure just or your branch as well:\n\n```\nsage -t --long --warn-long 70.7 src/sage/structure/element.pyx\n**********************************************************************\nFile \"src/sage/structure/element.pyx\", line 2770, in sage.structure.element.Matrix.__div__\nFailed example:\n    a / b\nExpected:\n    [-0.159090909091 -0.295454545455]\n    [  2.86363636364 -0.681818181818]\nGot:\n    [-0.15909090909090906 -0.29545454545454547]\n    [   2.863636363636364  -0.6818181818181817]\n**********************************************************************\n1 item had failures:\n   1 of  22 in sage.structure.element.Matrix.__div__\n    [455 tests, 1 failure, 38.78 s]\n```",
    "created_at": "2014-09-18T15:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217758",
    "user": "https://github.com/vbraun"
}
```

This still fails, I'm pretty sure just or your branch as well:

```
sage -t --long --warn-long 70.7 src/sage/structure/element.pyx
**********************************************************************
File "src/sage/structure/element.pyx", line 2770, in sage.structure.element.Matrix.__div__
Failed example:
    a / b
Expected:
    [-0.159090909091 -0.295454545455]
    [  2.86363636364 -0.681818181818]
Got:
    [-0.15909090909090906 -0.29545454545454547]
    [   2.863636363636364  -0.6818181818181817]
**********************************************************************
1 item had failures:
   1 of  22 in sage.structure.element.Matrix.__div__
    [455 tests, 1 failure, 38.78 s]
```



---

archive/issue_comments_217759.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-18T16:38:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217759",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_217760.json:
```json
{
    "body": "If I am not mistaken, it is the current output which is correct (I checked with Magma also). I had myself added this doctest last week, sorry!",
    "created_at": "2014-09-18T16:40:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217760",
    "user": "https://github.com/mmasdeu"
}
```

If I am not mistaken, it is the current output which is correct (I checked with Magma also). I had myself added this doctest last week, sorry!



---

archive/issue_comments_217761.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2014-09-18T16:42:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217761",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_217762.json:
```json
{
    "body": "Numerical noise on 32-bit, should be marked with a suitable `# rel tol`\n\n```\nsage -t --long src/sage/structure/element.pyx\n**********************************************************************\nFile \"src/sage/structure/element.pyx\", line 2770, in sage.structure.element.Matrix.__div__\nFailed example:\n    a / b\nExpected:\n    [-0.15909090909090906 -0.29545454545454547]\n    [   2.863636363636364  -0.6818181818181817]\nGot:\n    [ -0.1590909090909091 -0.29545454545454547]\n    [   2.863636363636364  -0.6818181818181815]\n**********************************************************************\n1 item had failures:\n```",
    "created_at": "2014-09-18T20:00:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217762",
    "user": "https://github.com/vbraun"
}
```

Numerical noise on 32-bit, should be marked with a suitable `# rel tol`

```
sage -t --long src/sage/structure/element.pyx
**********************************************************************
File "src/sage/structure/element.pyx", line 2770, in sage.structure.element.Matrix.__div__
Failed example:
    a / b
Expected:
    [-0.15909090909090906 -0.29545454545454547]
    [   2.863636363636364  -0.6818181818181817]
Got:
    [ -0.1590909090909091 -0.29545454545454547]
    [   2.863636363636364  -0.6818181818181815]
**********************************************************************
1 item had failures:
```



---

archive/issue_comments_217763.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2014-09-18T20:00:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217763",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_217764.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-19T08:49:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217764",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_217765.json:
```json
{
    "body": "Done.",
    "created_at": "2014-09-19T08:50:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217765",
    "user": "https://github.com/mmasdeu"
}
```

Done.



---

archive/issue_comments_217766.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-09-19T08:51:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217766",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_217767.json:
```json
{
    "body": "Linear algebra should really give the right answer to a few ulp, and not just 1e-10. But the test is about testing that the division operator works, so ok.",
    "created_at": "2014-09-19T10:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217767",
    "user": "https://github.com/vbraun"
}
```

Linear algebra should really give the right answer to a few ulp, and not just 1e-10. But the test is about testing that the division operator works, so ok.



---

archive/issue_comments_217768.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-09-19T10:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217768",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_049179.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-09-19T15:08:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16566#event-49179"
}
```



---

archive/issue_comments_217769.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-09-19T15:08:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217769",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_217770.json:
```json
{
    "body": "Follow-ups: #17080 and #17090.",
    "created_at": "2014-10-02T14:00:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217770",
    "user": "https://github.com/jdemeyer"
}
```

Follow-ups: #17080 and #17090.



---

archive/issue_comments_217771.json:
```json
{
    "body": "Did any of the reviewers (Volker?) actually read the code on this ticket? I've started doing this and there are many things to be improved... perhaps this ticket was merged too fast.",
    "created_at": "2014-10-02T18:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217771",
    "user": "https://github.com/jdemeyer"
}
```

Did any of the reviewers (Volker?) actually read the code on this ticket? I've started doing this and there are many things to be improved... perhaps this ticket was merged too fast.



---

archive/issue_comments_217772.json:
```json
{
    "body": "Is it perfect? No. But better than before? IMHO yes. Faster? For sure.",
    "created_at": "2014-10-02T18:17:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217772",
    "user": "https://github.com/vbraun"
}
```

Is it perfect? No. But better than before? IMHO yes. Faster? For sure.



---

archive/issue_comments_217773.json:
```json
{
    "body": "Replying to [comment:82 jdemeyer]:\n> Did any of the reviewers (Volker?) actually read the code on this ticket? I've started doing this and there are many things to be improved... \n\n\nI certainly read the version of the code 5 weeks ago, and had many, many, many suggestions for improvement, found numerous major bugs, etc.     \n\n> perhaps this ticket was merged too fast.\n\n\nOne has to balance that with the fact that for whatever reason, without this ticket a vast range of linear algebra in Sage is so utterly orders of magnitude too slow, as to make it painful and useless for research work.    This new code is **dramatically** faster than before.",
    "created_at": "2014-10-02T18:18:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217773",
    "user": "https://github.com/williamstein"
}
```

Replying to [comment:82 jdemeyer]:
> Did any of the reviewers (Volker?) actually read the code on this ticket? I've started doing this and there are many things to be improved... 


I certainly read the version of the code 5 weeks ago, and had many, many, many suggestions for improvement, found numerous major bugs, etc.     

> perhaps this ticket was merged too fast.


One has to balance that with the fact that for whatever reason, without this ticket a vast range of linear algebra in Sage is so utterly orders of magnitude too slow, as to make it painful and useless for research work.    This new code is **dramatically** faster than before.



---

archive/issue_comments_217774.json:
```json
{
    "body": "Replying to [comment:84 was]:\n> This new code is **dramatically** faster than before.\n\nI only hope we're not trading correctness for speed.",
    "created_at": "2014-10-02T18:20:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217774",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:84 was]:
> This new code is **dramatically** faster than before.

I only hope we're not trading correctness for speed.



---

archive/issue_comments_217775.json:
```json
{
    "body": "Replying to [comment:85 jdemeyer]:\n> Replying to [comment:84 was]:\n> > This new code is **dramatically** faster than before.\n\n> I only hope we're not trading correctness for speed.\n\nWell when I looked over the code 5 weeks ago there are numerous  memory leaks and other causes for concern (e.g., unitialized memory assumed to be 0). But those were I think all addressed.   Did you find anything that is actually incorrect?  Or does the overall code just make you unhappy and nervous?  Or are you not happy building on FLINT?",
    "created_at": "2014-10-02T18:25:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217775",
    "user": "https://github.com/williamstein"
}
```

Replying to [comment:85 jdemeyer]:
> Replying to [comment:84 was]:
> > This new code is **dramatically** faster than before.

> I only hope we're not trading correctness for speed.

Well when I looked over the code 5 weeks ago there are numerous  memory leaks and other causes for concern (e.g., unitialized memory assumed to be 0). But those were I think all addressed.   Did you find anything that is actually incorrect?  Or does the overall code just make you unhappy and nervous?  Or are you not happy building on FLINT?



---

archive/issue_comments_217776.json:
```json
{
    "body": "I just have to add jdemeyer that I'm really glad you're looking at this too, since you have an amazing eye for quality (similar to your recent remarks about the pexpect interfaces).",
    "created_at": "2014-10-02T18:36:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217776",
    "user": "https://github.com/williamstein"
}
```

I just have to add jdemeyer that I'm really glad you're looking at this too, since you have an amazing eye for quality (similar to your recent remarks about the pexpect interfaces).



---

archive/issue_comments_217777.json:
```json
{
    "body": "Replying to [comment:86 was]:\n> Did you find anything that is actually incorrect?\n\nThe segmentation fault in `_lmul_`, which is the reason for creating #17090.\n\n> Or does the overall code just make you unhappy and nervous?\n\nWhen looking at this code, there are some sloppy things (like why is the `_det_pari()` function duplicated?). Overall, I have less faith in sloppy code than clear code.\n\n> Or are you not happy building on FLINT?\n\nThat's not the problem. In general, I think it's good to rely on external packages if they do a good job (which seems to be the case here).",
    "created_at": "2014-10-02T20:29:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217777",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:86 was]:
> Did you find anything that is actually incorrect?

The segmentation fault in `_lmul_`, which is the reason for creating #17090.

> Or does the overall code just make you unhappy and nervous?

When looking at this code, there are some sloppy things (like why is the `_det_pari()` function duplicated?). Overall, I have less faith in sloppy code than clear code.

> Or are you not happy building on FLINT?

That's not the problem. In general, I think it's good to rely on external packages if they do a good job (which seems to be the case here).



---

archive/issue_comments_217778.json:
```json
{
    "body": "What's with the changes in padics in this ticket? Surely, yet another mistake...",
    "created_at": "2014-10-02T21:30:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217778",
    "user": "https://github.com/jdemeyer"
}
```

What's with the changes in padics in this ticket? Surely, yet another mistake...



---

archive/issue_comments_217779.json:
```json
{
    "body": "Yet another follow-up: #17094",
    "created_at": "2014-10-03T09:03:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217779",
    "user": "https://github.com/jdemeyer"
}
```

Yet another follow-up: #17094



---

archive/issue_comments_217780.json:
```json
{
    "body": "I must say that IMO some of the comments (82 and 90) made above are not very constructive. jdemeyer questions the thoroughness of the reviewing process, while clearly he himself didn't read the comments at the beginning of the ticket (at least those that refer to the convenience of leaving in the legacy functions).\n\nAfter the experience with this ticket I feel less inclined to take on the analogous job for matrix_rational_dense. Sorry!",
    "created_at": "2014-10-03T09:46:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217780",
    "user": "https://github.com/mmasdeu"
}
```

I must say that IMO some of the comments (82 and 90) made above are not very constructive. jdemeyer questions the thoroughness of the reviewing process, while clearly he himself didn't read the comments at the beginning of the ticket (at least those that refer to the convenience of leaving in the legacy functions).

After the experience with this ticket I feel less inclined to take on the analogous job for matrix_rational_dense. Sorry!



---

archive/issue_comments_217781.json:
```json
{
    "body": "Replying to [comment:92 mmasdeu]:\n> I must say that IMO some of the comments (82 and 90) made above are not very constructive.\n\n[comment:82] was made out of frustration by seeing so many things here which are dubious. So okay, that's not constructive.\n\nHowever in [comment:90], I noticed a mistake, mentioned it in the comment and fixed it in #17090. How is that not constructive?\n\n> while clearly he himself didn't read the comments at the beginning of the ticket (at least those that refer to the convenience of leaving in the legacy functions).\n\nThat's true, but after William Stein's comment, I have fixed that back in #17090.\n\n> I feel less inclined to take on the analogous job for matrix_rational_dense.\n\nPlease don't. I think it's absolutely good to improve matrices like you did here. The fact that I am making so many comments and creating follow-up tickets means that I care. I make mistakes, you make mistakes, that's normal and that's why have this review process.\n\nMy only complaint (and I still stand behind this) is that this ticket was given positive_review too soon. Ideally, those 3 follow-up tickets should have been reviewer patches on this ticket.",
    "created_at": "2014-10-03T10:36:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217781",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:92 mmasdeu]:
> I must say that IMO some of the comments (82 and 90) made above are not very constructive.

[comment:82] was made out of frustration by seeing so many things here which are dubious. So okay, that's not constructive.

However in [comment:90], I noticed a mistake, mentioned it in the comment and fixed it in #17090. How is that not constructive?

> while clearly he himself didn't read the comments at the beginning of the ticket (at least those that refer to the convenience of leaving in the legacy functions).

That's true, but after William Stein's comment, I have fixed that back in #17090.

> I feel less inclined to take on the analogous job for matrix_rational_dense.

Please don't. I think it's absolutely good to improve matrices like you did here. The fact that I am making so many comments and creating follow-up tickets means that I care. I make mistakes, you make mistakes, that's normal and that's why have this review process.

My only complaint (and I still stand behind this) is that this ticket was given positive_review too soon. Ideally, those 3 follow-up tickets should have been reviewer patches on this ticket.



---

archive/issue_comments_217782.json:
```json
{
    "body": "Replying to [comment:93 jdemeyer]:\n\n> [comment:82] was made out of frustration by seeing so many things here which are dubious. So okay, that's not constructive.\n\n\nI can understand your frustration. But the bar is high enough (python + cython + sage oddities + legacy code + git + trac, and I am probably missing something here) that makes it very hard for people to contribute, and these comments do not help. But I take your last comment in good faith :-).\n\nAlso, if there are other things that are dubious please share them because I (and possibly others!) would like to learn from it.\n\n> However in [comment:90], I noticed a mistake, mentioned it in the comment and fixed it in #17090. How is that not constructive?\n\n\nSurely I did not go and touch p-adics for no reason. These changes weren't there in the first version of the my patch, and I had to add them because during the time it took to from the first version until this ticket got closed other changes were being merged, and these made the patch to stop compiling. Changing those lines in p-adics is how I managed to fix it, but the hackish idea was not mine, I saw it used elsewhere. I appreciate you having fixed it back.",
    "created_at": "2014-10-03T11:10:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217782",
    "user": "https://github.com/mmasdeu"
}
```

Replying to [comment:93 jdemeyer]:

> [comment:82] was made out of frustration by seeing so many things here which are dubious. So okay, that's not constructive.


I can understand your frustration. But the bar is high enough (python + cython + sage oddities + legacy code + git + trac, and I am probably missing something here) that makes it very hard for people to contribute, and these comments do not help. But I take your last comment in good faith :-).

Also, if there are other things that are dubious please share them because I (and possibly others!) would like to learn from it.

> However in [comment:90], I noticed a mistake, mentioned it in the comment and fixed it in #17090. How is that not constructive?


Surely I did not go and touch p-adics for no reason. These changes weren't there in the first version of the my patch, and I had to add them because during the time it took to from the first version until this ticket got closed other changes were being merged, and these made the patch to stop compiling. Changing those lines in p-adics is how I managed to fix it, but the hackish idea was not mine, I saw it used elsewhere. I appreciate you having fixed it back.



---

archive/issue_comments_217783.json:
```json
{
    "body": "Replying to [comment:94 mmasdeu]:\n> Surely I did not go and touch p-adics for no reason. These changes weren't there in the first version of the my patch, and I had to add them because during the time it took to from the first version until this ticket got closed other changes were being merged, and these made the patch to stop compiling.\n\nI think you simply did something compiling Sage, because those changes to p-adics are totally unrelated to matrices. I cannot imagine how the change to matrices could break building p-adics or vice versa. And indeed, I simply undid the changes in #17090 without any bad consequences.",
    "created_at": "2014-10-03T11:29:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217783",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:94 mmasdeu]:
> Surely I did not go and touch p-adics for no reason. These changes weren't there in the first version of the my patch, and I had to add them because during the time it took to from the first version until this ticket got closed other changes were being merged, and these made the patch to stop compiling.

I think you simply did something compiling Sage, because those changes to p-adics are totally unrelated to matrices. I cannot imagine how the change to matrices could break building p-adics or vice versa. And indeed, I simply undid the changes in #17090 without any bad consequences.



---

archive/issue_comments_217784.json:
```json
{
    "body": "Replying to [comment:94 mmasdeu]:\n> Replying to [comment:93 jdemeyer]:\n> \n> > [comment:82] was made out of frustration by seeing so many things here which are dubious. So okay, that's not constructive.\n\n> \n> I can understand your frustration. But the bar is high enough (python + cython + sage oddities + legacy code + git + trac, and I am probably missing something here) that makes it very hard for people to contribute, and these comments do not help. But I take your last comment in good faith :-).\n> \n\n\nMarc -- don't you want to be a bad ass computer programmer, in addition to mathematician?   Just redo matrix_rational_dense, and you'll be way closer :-)",
    "created_at": "2014-10-03T15:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217784",
    "user": "https://github.com/williamstein"
}
```

Replying to [comment:94 mmasdeu]:
> Replying to [comment:93 jdemeyer]:
> 
> > [comment:82] was made out of frustration by seeing so many things here which are dubious. So okay, that's not constructive.

> 
> I can understand your frustration. But the bar is high enough (python + cython + sage oddities + legacy code + git + trac, and I am probably missing something here) that makes it very hard for people to contribute, and these comments do not help. But I take your last comment in good faith :-).
> 


Marc -- don't you want to be a bad ass computer programmer, in addition to mathematician?   Just redo matrix_rational_dense, and you'll be way closer :-)



---

archive/issue_comments_217785.json:
```json
{
    "body": "Replying to [comment:94 mmasdeu]:\n> Also, if there are other things that are dubious please share them because I (and possibly others!) would like to learn from it.\n\nWell, you can look at the follow-up tickets #17090 and #17094 and see what I changed (and preferably review those tickets).\n\nSome general things which haven't been mentioned yet:\n1. clean-up your code when you change things: when you remove code, try to remove everything related to the old code. When you change code, the old structure might not be applicable anymore, so refactor if needed (e.g. the sepatate branch for `n <= 4` in `determinant()` no longer serves any purpose)\n2. also fix documentation: when you change something, also change the corresponding documentation. When you copy/paste something, be sure to update documentation and doctests (see the various `set_unsafe` methods).\n3. don't add unneeded import statements or includes, those add needless extra dependencies. Like, why did you add `include \"sage/libs/ntl/decl.pxi\"` in several places when you don't use any NTL code?\n4. try to use correct formatting: spacing, indentation, docstring formatting (this was mostly good, but a bit messed up in `src/module_list.py`). If anything, this makes your code look more professional and less sloppy.\n5. don't use `assert` for checking user input: use `assert` for when you *know* that something is true (but want to check just in case), not when you need to check that something is true.",
    "created_at": "2014-10-03T19:23:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217785",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:94 mmasdeu]:
> Also, if there are other things that are dubious please share them because I (and possibly others!) would like to learn from it.

Well, you can look at the follow-up tickets #17090 and #17094 and see what I changed (and preferably review those tickets).

Some general things which haven't been mentioned yet:
1. clean-up your code when you change things: when you remove code, try to remove everything related to the old code. When you change code, the old structure might not be applicable anymore, so refactor if needed (e.g. the sepatate branch for `n <= 4` in `determinant()` no longer serves any purpose)
2. also fix documentation: when you change something, also change the corresponding documentation. When you copy/paste something, be sure to update documentation and doctests (see the various `set_unsafe` methods).
3. don't add unneeded import statements or includes, those add needless extra dependencies. Like, why did you add `include "sage/libs/ntl/decl.pxi"` in several places when you don't use any NTL code?
4. try to use correct formatting: spacing, indentation, docstring formatting (this was mostly good, but a bit messed up in `src/module_list.py`). If anything, this makes your code look more professional and less sloppy.
5. don't use `assert` for checking user input: use `assert` for when you *know* that something is true (but want to check just in case), not when you need to check that something is true.



---

archive/issue_comments_217786.json:
```json
{
    "body": "Replying to [comment:97 jdemeyer]:\n\nThanks! These comments are helpful indeed.\n\nWilliam -- I rather try to be a better mathematician...it has the advantage that although you get constantly evaluated, the evaluations are mostly anonymous :-). But that was in my to-do list. And it still is, despite my previous comments in this ticket!",
    "created_at": "2014-10-03T20:00:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16566",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16566#issuecomment-217786",
    "user": "https://github.com/mmasdeu"
}
```

Replying to [comment:97 jdemeyer]:

Thanks! These comments are helpful indeed.

William -- I rather try to be a better mathematician...it has the advantage that although you get constantly evaluated, the evaluations are mostly anonymous :-). But that was in my to-do list. And it still is, despite my previous comments in this ticket!
