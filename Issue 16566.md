# Issue 16566: Reimplement matrix_integer_dense using FLINT

Issue created by migration from https://trac.sagemath.org/ticket/16803

Original creator: mmasdeu

Original creation time: 2014-08-12 16:39:14

CC:  pbruin

Keywords: flint, matrix

In this ticket we reimplement all of matrix_integer_dense using FLINT fmpz_mat_t.

The speed-up is substantial. With the new code:


```
sage: A = Matrix(ZZ,1000,1000,range(10^6))
sage: %time B = A*A
CPU times: user 883 ms, sys: 3.33 ms, total: 887 ms
Wall time: 888 ms
```


This takes more than 1 minute in the same computer using Sage 6.3.


---

Comment by mmasdeu created at 2014-08-12 18:21:58

By the way, after rebasing it does not compile. I will fix it tomorrow hopefully.


---

Comment by fredrik.johansson created at 2014-08-12 22:06:35

A word of caution about algorithm defaults: FLINT should generally be faster for small input but IML/Linbox etc. probably have much better code for things like nullspace, charpoly... as soon as the matrices start to get large.

Replacing _rational_kernel_iml with _rational_kernel_flint, for example, is strange. Surely both algorithms should be available.


---

Comment by git created at 2014-08-15 18:11:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmasdeu created at 2014-08-15 18:23:45

I rewrote the code to have all the previous functionality available. The code compiles and passes all the doctests in the matrix/ folder. I will have it run all the doctests during the weekend.


---

Comment by git created at 2014-08-19 17:11:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-08-21 14:07:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-08-22 12:54:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by was created at 2014-08-29 07:41:03

Hi,

A first remark playing around with timings is that in sage-6.3 somebody or something has definitely *completely massively screwed* up Linbox, or how Linbox is built, or how we use linbox, which was the default representation and library for arithmetic. Consider this:

```
sage: n=200; set_random_seed(0); a = random_matrix(ZZ,n); b = random_matrix(ZZ,n)
sage: %time c=a._multiply_linbox(b)
CPU times: user 326 ms, sys: 3.63 ms, total: 330 ms
Wall time: 347 ms
sage: %time c=a._multiply_multi_modular(b)
CPU times: user 51.5 ms, sys: 1.6 ms, total: 53.1 ms
Wall time: 56.1 ms
sage: n=400; set_random_seed(0); a = random_matrix(ZZ,n); b = random_matrix(ZZ,n)
sage: %time c=a._multiply_linbox(b)
CPU times: user 5.28 s, sys: 22.8 ms, total: 5.3 s
Wall time: 5.37 s
sage: %time c=a._multiply_multi_modular(b)
CPU times: user 230 ms, sys: 6.08 ms, total: 236 ms
Wall time: 248 ms
```


Linbox should easily beat the multiply_multi_modular approach -- that's just basically a naive version of the same thing linbox would be doing if it were properly built and linked.  Instead, Linbox is massively slower.   In fact, almost exactly as much slower as I would expect if the wrong BLAS were being linked.    Note that I tested against the new flint backend and now a._multiply_multi_modular(b) is asymptotically similar to flint, though asymptotically (for n=2000 already), they are pretty close to the same in speed (8.55s versus 11.4s).      In any case, somebody should really look into why linbox is so screwed up -- we switched to it initially since it was much better than doing a._multiply_multi_modular(b) and also our own strassen implementation.


---

Comment by was created at 2014-08-29 16:15:20

OK, I've been skeptically looking at and testing this patch much of today.  I made a few  tiny changes, but frankly I think this is overall AWESOME.   FLINT's linear algebra seems quite good. 

The following three methods are now still gone.  Add them back so I can run some randomized consistency tests more easily...

```
     a._multiply_classical      a._multiply_linbox         a._multiply_multi_modular
```


When these are added back, and I run tests of correctness by comparing with them, then I'll give this an enthusiastic positive review.


---

Comment by was created at 2014-08-29 16:15:33

Changing status from new to needs_review.


---

Comment by was created at 2014-08-29 16:15:39

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-09-01 08:34:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-09-01 10:55:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmasdeu created at 2014-09-01 10:59:37

Changing status from needs_work to needs_review.


---

Comment by mmasdeu created at 2014-09-01 10:59:37

I have added the three functions back, and run the long tests in sage/matrix/.


---

Comment by was created at 2014-09-01 11:13:39

MAJOR PROBLEM!  Now that multiply_multi_modular is back, I wrote code to do some random testing of correctness.  I did not find situations where things are wrong... however, I quickly ran into major trouble because this ticket introduces a huge memory leak.    I just defined two matrices and multiplied them a few hundred times, and had major ram problems.  In particular, in sage-6.3 (without this branch):

```
sage: get_memory_usage()
1047.1875
sage: for i in range(50):
....:         a=random_matrix(ZZ,300); del a
....: 
sage: get_memory_usage()
1047.1875
```


With this ticket:

```
sage: get_memory_usage()
2132.09765625
sage: for i in range(50):
    a=random_matrix(ZZ,300); del a
....: 
sage: get_memory_usage()
2231.3203125
```


**Conclusion: making nontrivial use of the code on this ticket will very quickly use up all RAM on your computer.**

So... needs work until that is fixed.


---

Comment by git created at 2014-09-01 13:21:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by was created at 2014-09-01 15:11:31

I don't think the changeset with name "Fixed memory leak" fixes the memory leak, at least not for matrix multiplication.  I'm not sure if you're done yet.  With your fix, if you run the functions `test1`, `test2` or `test3` in the script `2014-08-29-180550-stupid-test.sage` below, then the memory usage (print out second) grows quite rapidly and doesn't go down.  Doing the same thing in sage-6.3 results in almost no leakage of the heap.    In particular, with your patch after running those 3 tests I ended up with over 2GB extra memory used (oer startup), even after doing `import gc; gc.collect()`.  Doing the identical thing with sage-6.3 uses only a few MB's. 


```
def t0(n):
    a = random_matrix(ZZ,n)
    b = random_matrix(ZZ,n)
    assert a*b == a*b

def t(n):
    a = random_matrix(ZZ,n)
    b = random_matrix(ZZ,n)
    assert a*b == a._multiply_multi_modular(b)

def test1():
    for n in range(1,50):
        print n, get_memory_usage()
        set_random_seed(0)
        for i in range(100):
            t(n)

def test2():
    for n in range(51,150):
        print n, get_memory_usage()
        set_random_seed(0)
        for i in range(10):
            t(n)


def t2(n):
    a = random_matrix(ZZ,n,2*n)
    b = random_matrix(ZZ,2*n,n)
    at = a.transpose()
    bt = b.transpose()
    assert a*b == a._multiply_multi_modular(b)
    assert bt*at == bt._multiply_multi_modular(at)

def test3():
    for n in range(1,50):
        print n, get_memory_usage()
        set_random_seed(0)
        for i in range(50):
            t2(n)
```



---

Comment by fredrik.johansson created at 2014-09-02 13:45:40

Just from a quick glance at the code, it looks like _lift_crt doesn't mpz_clear out tmp.


---

Comment by git created at 2014-09-02 16:33:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmasdeu created at 2014-09-02 16:37:05

Thanks Fredrik, I fixed that (although it was not the only problem, by far).

The previous commit was not finished yet (sorry for the confusing commit message). I believe that now the memory leaks are gone (at least those that were detected by William's tests). The main problem was that the get_unsafe_mpz function was initializing the value that it modifies in place, and all functions calling it were also mpz_init'ing it as well. All should be good now.


---

Comment by jdemeyer created at 2014-09-03 12:39:46

Replying to [comment:9 was]:
> A first remark playing around with timings is that in sage-6.3 somebody or something has definitely *completely massively screwed* up Linbox, or how Linbox is built, or how we use linbox, which was the default representation and library for arithmetic.
Are you sure this isn't an imaginary slow-down?  Just for fun, I installed some old versions of Sage on boxen and executed the command

```
$ time ./sage -c '_ = Matrix(ZZ,1000,1000,range(10^6))^5'
```


I tested Sage versions 2.9(*), 2.11(*), 3.0.6, 3.2.3, 4.1, 4.5, 4.7, 5.0, 5.12, 6.1.1, 6.3 and the above command always took about 12 minutes. Note that boxen is not an idle machine, so it's difficult to get accurate timings, but there is certainly no massive slow-down.

(*) For these versions, ATLAS didn't compile so I used the ATLAS package from Sage 3.0.6.


---

Comment by was created at 2014-09-03 14:04:09

Replying to [comment:22 jdemeyer]:
> Replying to [comment:9 was]:
> > A first remark playing around with timings is that in sage-6.3 somebody or something has definitely *completely massively screwed* up Linbox, or how Linbox is built, or how we use linbox, which was the default representation and library for arithmetic.
> Are you sure this isn't an imaginary slow-down?  Just for fun, I installed some old versions of Sage on boxen and executed the command
> {{{
> $ time ./sage -c '_ = Matrix(ZZ,1000,1000,range(10<sup>6))</sup>5'
> }}}
> 
> I tested Sage versions 2.9(*), 2.11(*), 3.0.6, 3.2.3, 4.1, 4.5, 4.7, 5.0, 5.12, 6.1.1, 6.3 and the above command always took about 12 minutes. Note that boxen is not an idle machine, so it's difficult to get accurate timings, but there is certainly no massive slow-down.
> 
> (*) For these versions, ATLAS didn't compile so I used the ATLAS package from Sage 3.0.6.

Thanks for testing.   I wouldn't be at all surprised if the problem was introduced quite a long time ago -- I haven't benchmarked sage linear algebra at all since around the time when Clement was my postdoc (about 2007-2008), and at that time definitely a properly built linbox provided the fastest matrix multiply (and many other things).   It might still today -- I don't know.


---

Comment by was created at 2014-09-03 14:04:56

Replying to [comment:21 mmasdeu]:
> Thanks Fredrik, I fixed that (although it was not the only problem, by far).
> 
> The previous commit was not finished yet (sorry for the confusing commit message). I believe that now the memory leaks are gone (at least those that were detected by William's tests). The main problem was that the get_unsafe_mpz function was initializing the value that it modifies in place, and all functions calling it were also mpz_init'ing it as well. All should be good now.

Marc -- can you update the code in our SD61 project in sagetest-marc so I can test this out.  I tried what was there, and it leaked like a sieve.


---

Comment by mmasdeu created at 2014-09-03 15:18:06

It just finished compiling now. I got tired of bug-fixing in the cloud (some things are better done in private), and worked from my local copy in the last bit.


---

Comment by was created at 2014-09-03 22:33:04

Changing status from needs_review to positive_review.


---

Comment by was created at 2014-09-03 22:33:04

OK, I'm now officially thrilled/very happy by this code :-)


---

Comment by vbraun created at 2014-09-05 11:02:55

Merge conflict, probably from #16583


---

Comment by vbraun created at 2014-09-05 11:03:05

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2014-09-05 11:41:15

Merged with

```
git merge ticket/16583 -X theirs
```


Compiles fine, not tested again.
----
New commits:


---

Comment by jdemeyer created at 2014-09-05 11:41:31

Changing status from needs_work to positive_review.


---

Comment by mmasdeu created at 2014-09-05 15:11:28

Changing status from positive_review to needs_review.


---

Comment by mmasdeu created at 2014-09-05 15:11:28

I have just realized that (in a bad design choice) I was initializing allocating _rows and _entries for every single matrix created, which is not very efficient. Now it is only done when needed (i.e. when calling _init_linbox()). Changes are minimal, and I ran the tests (long version) in /matrix/ for safety, but I will resubmit for review.
----
New commits:


---

Comment by was created at 2014-09-05 16:24:39

Be more careful about freeing.  Right now, in all cases, you do

```
sage_free(self._rows)
sage_free(self._entries)
```


You're depending on self._rows being automatically initialized to NULL (?), and sage_free doing the right thing when passed NULL.   Maybe that works, but I would be more comfortable if it was explicit, e.g., put self._rows=NULL and only free self._rows if not NULL (or check the source code and see whether it already works that way).


---

Comment by git created at 2014-09-05 16:49:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmasdeu created at 2014-09-05 16:49:57

Done.
----
New commits:


---

Comment by vbraun created at 2014-09-05 16:52:25

Its safe to call `sage_free` with `NULL`, but an unintialized pointer can have a non-null value. You should explicitly set all pointers to NULL in `__cinit__`.


---

Comment by was created at 2014-09-05 16:54:34

Changing status from needs_review to positive_review.


---

Comment by was created at 2014-09-05 16:54:34

Replying to [comment:36 vbraun]:
> Its safe to call `sage_free` with `NULL`, but an unintialized pointer can have a non-null value. You should explicitly set all pointers to NULL in `__cinit__`.

Thanks for clarifying this.  The change he made does explicitly set pointers to NULL now, but it also checks for NULL before calling sage_free.  He should probably change that part back.

Anyway, positive review.


---

Comment by git created at 2014-09-05 17:26:53

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2014-09-05 17:26:53

Changing status from positive_review to needs_review.


---

Comment by mmasdeu created at 2014-09-05 17:27:44

I cleaned that up.


---

Comment by mmasdeu created at 2014-09-05 17:27:44

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-09-05 17:28:29

The commit is ok but the commit message is wrong ;-)   You initialize it to NULL, thats the whole point.


---

Comment by mmasdeu created at 2014-09-05 18:01:41

Argh! By uninitialized I meant unallocated. Sorry...


---

Comment by vbraun created at 2014-09-06 11:04:18

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2014-09-06 11:04:18

Conflicts with #15946, please fix.


---

Comment by jdemeyer created at 2014-09-07 18:10:07

I merged with #15946, but that revealed some genuine bugs with this ticket, hang on...
----
New commits:


---

Comment by git created at 2014-09-07 18:44:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-09-07 19:09:36

Still needs work because of

```
sage -t src/sage/combinat/q_analogues.py
**********************************************************************
File "src/sage/combinat/q_analogues.py", line 200, in sage.combinat.q_analogues.q_binomial
Failed example:
    q_binomial(4,2,matrix([[2,1],[-1,3]]))
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 843, in compile_and_execute
        exec compiled in globs
      File "<doctest sage.combinat.q_analogues.q_binomial[14]>", line 1, in <module>
        q_binomial(Integer(4),Integer(2),matrix([[Integer(2),Integer(1)],[-Integer(1),Integer(3)]]))
      File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/combinat/q_analogues.py", line 308, in q_binomial
        return numerat/denomin
      File "element.pyx", line 2743, in sage.structure.element.Matrix.__div__ (build/cythonized/sage/structure/element.c:20137)
      File "matrix_integer_dense.pyx", line 923, in sage.matrix.matrix_integer_dense.Matrix_integer_dense._matrix_times_matrix_ (build/cythonized/sage/matrix/matrix_integer_dense.c:11570)
      File "c_lib.pyx", line 97, in sage.ext.c_lib.sig_raise_exception (build/cythonized/sage/ext/c_lib.c:1208)
    SignalError: Segmentation fault
**********************************************************************
```


Given that this test also fails (not with a segfault though) in the patchbot, I guess the merging isn't to blame.

Please fix this...


---

Comment by mmasdeu created at 2014-09-08 12:05:55

Changing status from needs_work to needs_review.


---

Comment by mmasdeu created at 2014-09-08 12:05:55

I have fixed this by changing the code of sage.structure.element.Matrix.__div__, which was assuming that the _matrix_times_matrix method of matrix.matrix_integer_dense would know how to deal with matrices over the rationals. This is a low-level private function which doesn't do type checking, which I think is the right thing to do.

What the current patch does is, when writing something like A/B for matrices A and B, to take the denominator out of ~B, multiply and then put it back. I have run make ptest and all passed *except* for some that have nothing to do with matrices, for example this one:


```
sage -t src/sage/rings/integer.pyx
**********************************************************************
File "src/sage/rings/integer.pyx", line 1954, in sage.rings.integer.Integer.__pow__
Failed example:
    2^(2^63-2)
Expected:
    Traceback (most recent call last):
    ...
    MemoryError: failed to allocate 1152921504606847008 bytes
Got:
    Fatal Python error: Insufficient memory
    Traceback (most recent call last):
      File "/usr/local/sage/sage-6.3.beta6/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/usr/local/sage/sage-6.3.beta6/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.rings.integer.Integer.__pow__[27]>", line 1, in <module>
        Integer(2)**(Integer(2)**Integer(63)-Integer(2))
      File "integer.pyx", line 1999, in sage.rings.integer.Integer.__pow__ (build/cythonized/sage/rings/integer.c:14710)
      File "c_lib.pyx", line 85, in sage.ext.c_lib.sig_raise_exception (build/cythonized/sage/ext/c_lib.c:1040)
    RuntimeError: Aborted
**********************************************************************
```



---

Comment by jdemeyer created at 2014-09-09 07:51:28

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-09-09 07:51:28

The patchbot reports a segmentation fault in `matrix_integer_dense.pyx`, which is likely due to this ticket.


---

Comment by mmasdeu created at 2014-09-09 08:51:11

I cannot reproduce it. And I don't know where the error comes from, other than the coercion model not checking for types before calling the low-level functions...


```
~/sagetest-marc$ ./sage -t --long src/sage/modular/modform/ambient_R.py
Running doctests with ID 2014-09-09-08-48-58-b66cd1ea.
Doctesting 1 file.
sage -t --long --warn-long 26.1 src/sage/modular/modform/ambient_R.py
    [26 tests, 29.09 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 29.2 seconds
    cpu time: 27.7 seconds
    cumulative wall time: 29.1 seconds
```



---

Comment by jdemeyer created at 2014-09-09 14:04:40

Your last fix is almost certainly going to break over other rings. In any case, this change requires extra doctests over other rings.

I would advise the following: the matrix division coercion model bug is independent of this ticket. I recommend you to create a new ticket for that and make this ticket depend on that.


---

Comment by mmasdeu created at 2014-09-09 17:36:31

I propose the following, which I think is a good solution (especially since the plan is to move matrices over rationals also to FLINT).


```
def __div__(left,right):
    return left * (~right)
```


I have tried this and it passes the tests. I will push the code in a minute.


---

Comment by mmasdeu created at 2014-09-09 17:36:31

Changing status from needs_work to needs_review.


---

Comment by mmasdeu created at 2014-09-09 17:45:26

Last 10 new commits:


---

Comment by jdemeyer created at 2014-09-09 19:18:06

Replying to [comment:51 mmasdeu]:
> I propose the following, which I think is a good solution (especially since the plan is to move matrices over rationals also to FLINT).
> 
> {{{
> def __div__(left,right):
>     return left * (~right)
> }}}
> 
> I have tried this and it passes the tests.
You need to add more doctests to this `__div__` function.


---

Comment by jdemeyer created at 2014-09-09 19:18:06

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-09-10 08:35:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmasdeu created at 2014-09-10 08:36:31

Changing status from needs_work to needs_review.


---

Comment by mmasdeu created at 2014-09-10 08:36:31

Done.


---

Comment by jdemeyer created at 2014-09-10 08:46:06

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-09-10 08:46:06

I really think more doctests are needed, also over rings which are not `ZZ` or `QQ` (see also comment [comment:50]). Perhaps `GF(3)` and `RDF` and `ZZ['t']` to have some wider coverage?

And you should use the `:trac:`16803`` syntax to refer to Trac tickets (but given that this ticket has nothing to do with division of matrices, perhaps it makes more sense to just remove that comment).


---

Comment by jdemeyer created at 2014-09-10 08:52:25

Also, doctest division of a matrix by a scalar...


---

Comment by git created at 2014-09-10 08:53:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-09-10 08:55:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmasdeu created at 2014-09-10 08:55:49

Done!


---

Comment by mmasdeu created at 2014-09-10 08:55:58

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2014-09-10 09:16:48

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-09-10 09:16:48

In the last patches, you messed up the indentation from 4 to 3 spaces.


---

Comment by git created at 2014-09-10 10:05:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmasdeu created at 2014-09-10 10:07:54

Changing status from needs_work to needs_review.


---

Comment by mmasdeu created at 2014-09-10 10:07:54

Sorry. Fixed that.


---

Comment by jdemeyer created at 2014-09-10 10:10:13

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-09-10 10:10:13

I think this still leaks memory.

The following command works without this patch, but fails with this patch:

```
( ulimit -v 2000000; ./sage -t --long src/sage/combinat/root_system/branching_rules.py )
```



---

Comment by git created at 2014-09-10 13:37:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmasdeu created at 2014-09-10 13:44:07

The bug reported in comment:65 may be related to an issue with infinite recursion. I traced it down to the modification of the __div__ function. With the current patch the command in comment:65 works, and all the tests in sage/structure and sage/matrix pass. I am now running make ptest and will report if something arises.


---

Comment by mmasdeu created at 2014-09-10 13:44:07

Changing status from needs_work to needs_review.


---

Comment by mmasdeu created at 2014-09-18 13:43:20

I have rebased it again. It looks like some other code is a moving target and it is hard to keep pace...
----
Last 10 new commits:


---

Comment by was created at 2014-09-18 13:47:02

Changing status from needs_review to positive_review.


---

Comment by was created at 2014-09-18 13:47:02

Since test pass, and the issues Jereon found were addressed, I'm switching this back to positive review.


---

Comment by vbraun created at 2014-09-18 15:21:04

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2014-09-18 15:21:04

This still fails, I'm pretty sure just or your branch as well:

```
sage -t --long --warn-long 70.7 src/sage/structure/element.pyx
**********************************************************************
File "src/sage/structure/element.pyx", line 2770, in sage.structure.element.Matrix.__div__
Failed example:
    a / b
Expected:
    [-0.159090909091 -0.295454545455]
    [  2.86363636364 -0.681818181818]
Got:
    [-0.15909090909090906 -0.29545454545454547]
    [   2.863636363636364  -0.6818181818181817]
**********************************************************************
1 item had failures:
   1 of  22 in sage.structure.element.Matrix.__div__
    [455 tests, 1 failure, 38.78 s]
```



---

Comment by git created at 2014-09-18 16:38:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmasdeu created at 2014-09-18 16:40:05

If I am not mistaken, it is the current output which is correct (I checked with Magma also). I had myself added this doctest last week, sorry!


---

Comment by vbraun created at 2014-09-18 16:42:49

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2014-09-18 20:00:13

Numerical noise on 32-bit, should be marked with a suitable `# rel tol`

```
sage -t --long src/sage/structure/element.pyx
**********************************************************************
File "src/sage/structure/element.pyx", line 2770, in sage.structure.element.Matrix.__div__
Failed example:
    a / b
Expected:
    [-0.15909090909090906 -0.29545454545454547]
    [   2.863636363636364  -0.6818181818181817]
Got:
    [ -0.1590909090909091 -0.29545454545454547]
    [   2.863636363636364  -0.6818181818181815]
**********************************************************************
1 item had failures:
```



---

Comment by vbraun created at 2014-09-18 20:00:26

Changing status from positive_review to needs_work.


---

Comment by git created at 2014-09-19 08:49:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmasdeu created at 2014-09-19 08:50:30

Done.


---

Comment by mmasdeu created at 2014-09-19 08:51:08

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2014-09-19 10:41:54

Linear algebra should really give the right answer to a few ulp, and not just 1e-10. But the test is about testing that the division operator works, so ok.


---

Comment by vbraun created at 2014-09-19 10:41:54

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-09-19 15:08:52

Resolution: fixed


---

Comment by jdemeyer created at 2014-10-02 14:00:51

Follow-ups: #17080 and #17090.


---

Comment by jdemeyer created at 2014-10-02 18:09:36

Did any of the reviewers (Volker?) actually read the code on this ticket? I've started doing this and there are many things to be improved... perhaps this ticket was merged too fast.


---

Comment by vbraun created at 2014-10-02 18:17:31

Is it perfect? No. But better than before? IMHO yes. Faster? For sure.


---

Comment by was created at 2014-10-02 18:18:27

Replying to [comment:82 jdemeyer]:
> Did any of the reviewers (Volker?) actually read the code on this ticket? I've started doing this and there are many things to be improved... 

I certainly read the version of the code 5 weeks ago, and had many, many, many suggestions for improvement, found numerous major bugs, etc.     

> perhaps this ticket was merged too fast.

One has to balance that with the fact that for whatever reason, without this ticket a vast range of linear algebra in Sage is so utterly orders of magnitude too slow, as to make it painful and useless for research work.    This new code is **dramatically** faster than before.


---

Comment by jdemeyer created at 2014-10-02 18:20:36

Replying to [comment:84 was]:
> This new code is **dramatically** faster than before.
I only hope we're not trading correctness for speed.


---

Comment by was created at 2014-10-02 18:25:37

Replying to [comment:85 jdemeyer]:
> Replying to [comment:84 was]:
> > This new code is **dramatically** faster than before.
> I only hope we're not trading correctness for speed.

Well when I looked over the code 5 weeks ago there are numerous  memory leaks and other causes for concern (e.g., unitialized memory assumed to be 0). But those were I think all addressed.   Did you find anything that is actually incorrect?  Or does the overall code just make you unhappy and nervous?  Or are you not happy building on FLINT?


---

Comment by was created at 2014-10-02 18:36:29

I just have to add jdemeyer that I'm really glad you're looking at this too, since you have an amazing eye for quality (similar to your recent remarks about the pexpect interfaces).


---

Comment by jdemeyer created at 2014-10-02 20:29:51

Replying to [comment:86 was]:
> Did you find anything that is actually incorrect?
The segmentation fault in `_lmul_`, which is the reason for creating #17090.

> Or does the overall code just make you unhappy and nervous?
When looking at this code, there are some sloppy things (like why is the `_det_pari()` function duplicated?). Overall, I have less faith in sloppy code than clear code.

> Or are you not happy building on FLINT?
That's not the problem. In general, I think it's good to rely on external packages if they do a good job (which seems to be the case here).


---

Comment by jdemeyer created at 2014-10-02 21:30:51

What's with the changes in padics in this ticket? Surely, yet another mistake...


---

Comment by jdemeyer created at 2014-10-03 09:03:59

Yet another follow-up: #17094


---

Comment by mmasdeu created at 2014-10-03 09:46:38

I must say that IMO some of the comments (82 and 90) made above are not very constructive. jdemeyer questions the thoroughness of the reviewing process, while clearly he himself didn't read the comments at the beginning of the ticket (at least those that refer to the convenience of leaving in the legacy functions).

After the experience with this ticket I feel less inclined to take on the analogous job for matrix_rational_dense. Sorry!


---

Comment by jdemeyer created at 2014-10-03 10:36:09

Replying to [comment:92 mmasdeu]:
> I must say that IMO some of the comments (82 and 90) made above are not very constructive.
[comment:82] was made out of frustration by seeing so many things here which are dubious. So okay, that's not constructive.

However in [comment:90], I noticed a mistake, mentioned it in the comment and fixed it in #17090. How is that not constructive?

> while clearly he himself didn't read the comments at the beginning of the ticket (at least those that refer to the convenience of leaving in the legacy functions).
That's true, but after William Stein's comment, I have fixed that back in #17090.

> I feel less inclined to take on the analogous job for matrix_rational_dense.
Please don't. I think it's absolutely good to improve matrices like you did here. The fact that I am making so many comments and creating follow-up tickets means that I care. I make mistakes, you make mistakes, that's normal and that's why have this review process.

My only complaint (and I still stand behind this) is that this ticket was given positive_review too soon. Ideally, those 3 follow-up tickets should have been reviewer patches on this ticket.


---

Comment by mmasdeu created at 2014-10-03 11:10:42

Replying to [comment:93 jdemeyer]:

> [comment:82] was made out of frustration by seeing so many things here which are dubious. So okay, that's not constructive.

I can understand your frustration. But the bar is high enough (python + cython + sage oddities + legacy code + git + trac, and I am probably missing something here) that makes it very hard for people to contribute, and these comments do not help. But I take your last comment in good faith :-).

Also, if there are other things that are dubious please share them because I (and possibly others!) would like to learn from it.

> However in [comment:90], I noticed a mistake, mentioned it in the comment and fixed it in #17090. How is that not constructive?

Surely I did not go and touch p-adics for no reason. These changes weren't there in the first version of the my patch, and I had to add them because during the time it took to from the first version until this ticket got closed other changes were being merged, and these made the patch to stop compiling. Changing those lines in p-adics is how I managed to fix it, but the hackish idea was not mine, I saw it used elsewhere. I appreciate you having fixed it back.


---

Comment by jdemeyer created at 2014-10-03 11:29:58

Replying to [comment:94 mmasdeu]:
> Surely I did not go and touch p-adics for no reason. These changes weren't there in the first version of the my patch, and I had to add them because during the time it took to from the first version until this ticket got closed other changes were being merged, and these made the patch to stop compiling.
I think you simply did something compiling Sage, because those changes to p-adics are totally unrelated to matrices. I cannot imagine how the change to matrices could break building p-adics or vice versa. And indeed, I simply undid the changes in #17090 without any bad consequences.


---

Comment by was created at 2014-10-03 15:26:00

Replying to [comment:94 mmasdeu]:
> Replying to [comment:93 jdemeyer]:
> 
> > [comment:82] was made out of frustration by seeing so many things here which are dubious. So okay, that's not constructive.
> 
> I can understand your frustration. But the bar is high enough (python + cython + sage oddities + legacy code + git + trac, and I am probably missing something here) that makes it very hard for people to contribute, and these comments do not help. But I take your last comment in good faith :-).
> 

Marc -- don't you want to be a bad ass computer programmer, in addition to mathematician?   Just redo matrix_rational_dense, and you'll be way closer :-)


---

Comment by jdemeyer created at 2014-10-03 19:23:34

Replying to [comment:94 mmasdeu]:
> Also, if there are other things that are dubious please share them because I (and possibly others!) would like to learn from it.
Well, you can look at the follow-up tickets #17090 and #17094 and see what I changed (and preferably review those tickets).

Some general things which haven't been mentioned yet:
1. clean-up your code when you change things: when you remove code, try to remove everything related to the old code. When you change code, the old structure might not be applicable anymore, so refactor if needed (e.g. the sepatate branch for `n <= 4` in `determinant()` no longer serves any purpose)
2. also fix documentation: when you change something, also change the corresponding documentation. When you copy/paste something, be sure to update documentation and doctests (see the various `set_unsafe` methods).
3. don't add unneeded import statements or includes, those add needless extra dependencies. Like, why did you add `include "sage/libs/ntl/decl.pxi"` in several places when you don't use any NTL code?
4. try to use correct formatting: spacing, indentation, docstring formatting (this was mostly good, but a bit messed up in `src/module_list.py`). If anything, this makes your code look more professional and less sloppy.
5. don't use `assert` for checking user input: use `assert` for when you _know_ that something is true (but want to check just in case), not when you need to check that something is true.


---

Comment by mmasdeu created at 2014-10-03 20:00:29

Replying to [comment:97 jdemeyer]:

Thanks! These comments are helpful indeed.

William -- I rather try to be a better mathematician...it has the advantage that although you get constantly evaluated, the evaluations are mostly anonymous :-). But that was in my to-do list. And it still is, despite my previous comments in this ticket!
