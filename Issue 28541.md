# Issue 28541: Implement pushout for generic number fields with compatible embeddings

Issue created by migration from https://trac.sagemath.org/ticket/28778

Original creator: @kliem

Original creation time: 2019-11-20 14:02:50

Keywords: number fields, coercion, pushout, composite field

For generic number fields, there is a method `composite_fields` that
preserves there embeddings, if they exists:


```
sage: z = QQ['z'].0
sage: K2 = NumberField(z^2 - 2,'s', embedding=AA(2).sqrt())
sage: K3 = NumberField(z^2 - 3,'t', embedding=AA(3).sqrt())
sage: K2.composite_fields(K3)
[Number Field in st with defining polynomial z^4 - 10*z^2 + 1 with st = 0.3178372451957823?]
```


This ticket implements the method `_pushout_` to return this composite field, if:
- it exists,
- is unique,
- and both fields have compatible embeddings (e.g. the pushout of the fields embedded to exists).


---

Comment by @kliem created at 2019-11-20 14:03:48

New commits:


---

Comment by @kliem created at 2019-11-20 14:03:48

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2019-11-20 14:37:42

Changing status from needs_review to needs_info.


---

Comment by vdelecroix created at 2019-11-20 14:37:42

A pushout is already available

```
sage: K.<a> = NumberField(x^2 - 2, embedding=AA(2).sqrt())
sage: L.<b> = NumberField(x^2 - 3, embedding=AA(3).sqrt())
sage: a+b
3.146264369941973?
sage: K._pushout_(L)
Algebraic Real Field
```

(was implemented in #20746)

Going via composite field is very fragile (order dependent, non canonical, expensive, etc).


---

Comment by @kliem created at 2019-11-20 15:52:49

Thanks for pointing this out. I was aware of this method, but not that you had the discussion before.

Nevertheless, one could just devote this ticket here to implementing the case, where the fields are embedded into `QQbar`.

I figured this would be useful for rings in general.


---

Comment by @mwageringel created at 2019-11-20 21:51:08

Replying to [comment:3 gh-kliem]:
> Nevertheless, one could just devote this ticket here to implementing the case, where the fields are embedded into `QQbar`.
> 
> I figured this would be useful for rings in general.

Assuming this also makes coercion between `AA` and number fields embedded in `QQbar` possible, this would then help solve #28489 as far as I can see (possibly after #28774).


---

Comment by vdelecroix created at 2019-11-20 23:33:31

Changing status from needs_info to needs_work.


---

Comment by vdelecroix created at 2019-11-20 23:33:31

description updated then


---

Comment by git created at 2019-11-21 11:17:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @kliem created at 2019-11-21 11:30:58

I also fixed a bug of the previous construction. It did try to coerce number fields embedded into `RLF` into `AA`, which did not work (the attribute `_embedded_real` is set to `True` in that case).

There is a failing doctest now in `sage/rings/qqbar.py` line 167, for which I need some help.

The test wants to make sure, that `QQ[I]` and `QQbar` cannot be implicitly coerced, as `QQ[I]` does not come with an embedding.

This makes sense, however this is not the way it is implemented:

```
sage: QQ[I]
Number Field in I with defining polynomial x^2 + 1 with I = 1*I
```

So `QQ[I]` does come with an embedding to `QQbar` and therefore I think my construction is correct in using this embedding.
Unlike this example

```
sage: K.<a> = NumberField(x^2 + 1); K
Number Field in a with defining polynomial x^2 + 1
```

where my construction does not give a pushout.


---

Comment by @kliem created at 2019-11-21 11:30:58

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2019-11-21 14:38:58

To be more precise, as it is `QQ[I]` comes with an embedding to complex lazy field:

```
sage: coercion_model.explain(QQ[I], CLF)
Coercion on left operand via
    Generic morphism:
      From: Number Field in I with defining polynomial x^2 + 1 with I = 1*I
      To:   Complex Lazy Field
      Defn: I -> 1*I
Arithmetic performed after coercions.
Result lives in Complex Lazy Field
Complex Lazy Field
```

and there is a coercion from `QQbar` to `CLF`

```
sage: coercion_model.explain(QQbar, CLF)
Coercion on left operand via
    Generic morphism:
      From: Algebraic Field
      To:   Complex Lazy Field
Arithmetic performed after coercions.
Result lives in Complex Lazy Field
Complex Lazy Field
```

I find it very confusing, that there is a doctest fixing that there shall be no coercion of `QQ[I]` and `CLF`. If this is the way we want it to be, there should not be coercion of `QQ[I]` and `CLF` in the first place.

The same holds for `QQ[sqrt(2)]` btw. There is no embedding of `QQ[sqrt(2), sqrt(3)]` to `RLF`, but probably not by design but only because relative number fields do not support embeddings.


---

Comment by @kliem created at 2019-11-21 14:39:35

Please tell me, if I should post a query on sage-devel instead.


---

Comment by @kliem created at 2019-11-21 14:39:35

Changing status from needs_review to needs_info.


---

Comment by @kliem created at 2019-11-22 17:30:42

Changing status from needs_info to needs_review.


---

Comment by @kliem created at 2019-11-22 17:30:42

Ok, I just went back to just doing `QQbar` and added the case that both are embedded into the same field.
----
New commits:


---

Comment by vdelecroix created at 2019-11-22 23:16:19

Your example

```
sage: K.<sqrt2_plus_sqrt3> = NumberField(x^4 - 10*x^2 + 1)
sage: K2.<sqrt2> = NumberField(x^2-2, embedding=(sqrt2_plus_sqrt3^3 - 9*sqrt2_plus_sqrt3)/2)
sage: K3.<sqrt3> = NumberField(x^2-3, embedding=-(sqrt2_plus_sqrt3^3 - 11*sqrt2_plus_sqrt3)/2)
sage: sqrt2 + sqrt3
sqrt2_plus_sqrt3
```

is working without any modification to the `_pushout_` method. You should simply remove what you wrote for number fields unless there is a real application for it.


---

Comment by vdelecroix created at 2019-11-22 23:16:39

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-11-23 07:07:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2019-11-23 07:20:07

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2019-11-23 07:20:07

Ok. I see.

This example is handled by the `_pushout_` method now, but I don't think it hurts. I wasn't aware that a canonical coercion is already discovered. Nice.

I could also just handle `AA` and `QQbar`, if this seems more reasonable.


---

Comment by git created at 2019-11-23 16:40:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2019-11-25 15:19:50

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2019-11-25 15:19:50

Replying to [comment:14 gh-kliem]:
> Ok. I see.
> 
> This example is handled by the `_pushout_` method now, but I don't think it hurts. I wasn't aware that a canonical coercion is already discovered. Nice.
> 
> I could also just handle `AA` and `QQbar`, if this seems more reasonable.

Yes, it would be better.


---

Comment by git created at 2019-11-25 16:10:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2019-11-25 16:11:50

Changing status from needs_work to needs_review.


---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-04-14 19:41:51

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.


---

Comment by vdelecroix created at 2020-04-23 16:53:03

Maybe we could be more greedy with something like

```
if codomain_self is not self or codomain_other is not other:
    try:
        return coercion_model.common_parent(codomain_self, codomain_other)
    except TypeError:
        pass
```



---

Comment by mkoeppe created at 2020-07-18 19:23:38

Looks like a good improvement as is.

Feel free to open the suggestion from comment 21 as another ticket.


---

Comment by mkoeppe created at 2020-07-18 19:23:38

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2020-07-18 19:41:41

Thank you.


---

Comment by vbraun created at 2020-07-25 22:51:26

Resolution: fixed
