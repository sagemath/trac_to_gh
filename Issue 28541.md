# Issue 28541: Implement pushout for generic number fields with compatible embeddings

archive/issues_028541.json:
```json
{
    "body": "Keywords: number fields, coercion, pushout, composite field\n\nFor generic number fields, there is a method `composite_fields` that\npreserves there embeddings, if they exists:\n\n\n```\nsage: z = QQ['z'].0\nsage: K2 = NumberField(z^2 - 2,'s', embedding=AA(2).sqrt())\nsage: K3 = NumberField(z^2 - 3,'t', embedding=AA(3).sqrt())\nsage: K2.composite_fields(K3)\n[Number Field in st with defining polynomial z^4 - 10*z^2 + 1 with st = 0.3178372451957823?]\n```\n\n\nThis ticket implements the method `_pushout_` to return this composite field, if:\n- it exists,\n- is unique,\n- and both fields have compatible embeddings (e.g. the pushout of the fields embedded to exists).\n\nIssue created by migration from https://trac.sagemath.org/ticket/28778\n\n",
    "created_at": "2019-11-20T14:02:50Z",
    "labels": [
        "number fields",
        "major",
        "enhancement"
    ],
    "title": "Implement pushout for generic number fields with compatible embeddings",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28541",
    "user": "@kliem"
}
```
Keywords: number fields, coercion, pushout, composite field

For generic number fields, there is a method `composite_fields` that
preserves there embeddings, if they exists:


```
sage: z = QQ['z'].0
sage: K2 = NumberField(z^2 - 2,'s', embedding=AA(2).sqrt())
sage: K3 = NumberField(z^2 - 3,'t', embedding=AA(3).sqrt())
sage: K2.composite_fields(K3)
[Number Field in st with defining polynomial z^4 - 10*z^2 + 1 with st = 0.3178372451957823?]
```


This ticket implements the method `_pushout_` to return this composite field, if:
- it exists,
- is unique,
- and both fields have compatible embeddings (e.g. the pushout of the fields embedded to exists).

Issue created by migration from https://trac.sagemath.org/ticket/28778





---

archive/issue_comments_402958.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-11-20T14:03:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402958",
    "user": "@kliem"
}
```

New commits:



---

archive/issue_comments_402959.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-11-20T14:03:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402959",
    "user": "@kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_402960.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2019-11-20T14:37:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402960",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_402961.json:
```json
{
    "body": "A pushout is already available\n\n```\nsage: K.<a> = NumberField(x^2 - 2, embedding=AA(2).sqrt())\nsage: L.<b> = NumberField(x^2 - 3, embedding=AA(3).sqrt())\nsage: a+b\n3.146264369941973?\nsage: K._pushout_(L)\nAlgebraic Real Field\n```\n\n(was implemented in #20746)\n\nGoing via composite field is very fragile (order dependent, non canonical, expensive, etc).",
    "created_at": "2019-11-20T14:37:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402961",
    "user": "vdelecroix"
}
```

A pushout is already available

```
sage: K.<a> = NumberField(x^2 - 2, embedding=AA(2).sqrt())
sage: L.<b> = NumberField(x^2 - 3, embedding=AA(3).sqrt())
sage: a+b
3.146264369941973?
sage: K._pushout_(L)
Algebraic Real Field
```

(was implemented in #20746)

Going via composite field is very fragile (order dependent, non canonical, expensive, etc).



---

archive/issue_comments_402962.json:
```json
{
    "body": "Thanks for pointing this out. I was aware of this method, but not that you had the discussion before.\n\nNevertheless, one could just devote this ticket here to implementing the case, where the fields are embedded into `QQbar`.\n\nI figured this would be useful for rings in general.",
    "created_at": "2019-11-20T15:52:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402962",
    "user": "@kliem"
}
```

Thanks for pointing this out. I was aware of this method, but not that you had the discussion before.

Nevertheless, one could just devote this ticket here to implementing the case, where the fields are embedded into `QQbar`.

I figured this would be useful for rings in general.



---

archive/issue_comments_402963.json:
```json
{
    "body": "Replying to [comment:3 gh-kliem]:\n> Nevertheless, one could just devote this ticket here to implementing the case, where the fields are embedded into `QQbar`.\n> \n> I figured this would be useful for rings in general.\n\nAssuming this also makes coercion between `AA` and number fields embedded in `QQbar` possible, this would then help solve #28489 as far as I can see (possibly after #28774).",
    "created_at": "2019-11-20T21:51:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402963",
    "user": "@mwageringel"
}
```

Replying to [comment:3 gh-kliem]:
> Nevertheless, one could just devote this ticket here to implementing the case, where the fields are embedded into `QQbar`.
> 
> I figured this would be useful for rings in general.

Assuming this also makes coercion between `AA` and number fields embedded in `QQbar` possible, this would then help solve #28489 as far as I can see (possibly after #28774).



---

archive/issue_comments_402964.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2019-11-20T23:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402964",
    "user": "vdelecroix"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_402965.json:
```json
{
    "body": "description updated then",
    "created_at": "2019-11-20T23:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402965",
    "user": "vdelecroix"
}
```

description updated then



---

archive/issue_comments_402966.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-11-21T11:17:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402966",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_402967.json:
```json
{
    "body": "I also fixed a bug of the previous construction. It did try to coerce number fields embedded into `RLF` into `AA`, which did not work (the attribute `_embedded_real` is set to `True` in that case).\n\nThere is a failing doctest now in `sage/rings/qqbar.py` line 167, for which I need some help.\n\nThe test wants to make sure, that `QQ[I]` and `QQbar` cannot be implicitly coerced, as `QQ[I]` does not come with an embedding.\n\nThis makes sense, however this is not the way it is implemented:\n\n```\nsage: QQ[I]\nNumber Field in I with defining polynomial x^2 + 1 with I = 1*I\n```\n\nSo `QQ[I]` does come with an embedding to `QQbar` and therefore I think my construction is correct in using this embedding.\nUnlike this example\n\n```\nsage: K.<a> = NumberField(x^2 + 1); K\nNumber Field in a with defining polynomial x^2 + 1\n```\n\nwhere my construction does not give a pushout.",
    "created_at": "2019-11-21T11:30:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402967",
    "user": "@kliem"
}
```

I also fixed a bug of the previous construction. It did try to coerce number fields embedded into `RLF` into `AA`, which did not work (the attribute `_embedded_real` is set to `True` in that case).

There is a failing doctest now in `sage/rings/qqbar.py` line 167, for which I need some help.

The test wants to make sure, that `QQ[I]` and `QQbar` cannot be implicitly coerced, as `QQ[I]` does not come with an embedding.

This makes sense, however this is not the way it is implemented:

```
sage: QQ[I]
Number Field in I with defining polynomial x^2 + 1 with I = 1*I
```

So `QQ[I]` does come with an embedding to `QQbar` and therefore I think my construction is correct in using this embedding.
Unlike this example

```
sage: K.<a> = NumberField(x^2 + 1); K
Number Field in a with defining polynomial x^2 + 1
```

where my construction does not give a pushout.



---

archive/issue_comments_402968.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-11-21T11:30:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402968",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_402969.json:
```json
{
    "body": "To be more precise, as it is `QQ[I]` comes with an embedding to complex lazy field:\n\n```\nsage: coercion_model.explain(QQ[I], CLF)\nCoercion on left operand via\n    Generic morphism:\n      From: Number Field in I with defining polynomial x^2 + 1 with I = 1*I\n      To:   Complex Lazy Field\n      Defn: I -> 1*I\nArithmetic performed after coercions.\nResult lives in Complex Lazy Field\nComplex Lazy Field\n```\n\nand there is a coercion from `QQbar` to `CLF`\n\n```\nsage: coercion_model.explain(QQbar, CLF)\nCoercion on left operand via\n    Generic morphism:\n      From: Algebraic Field\n      To:   Complex Lazy Field\nArithmetic performed after coercions.\nResult lives in Complex Lazy Field\nComplex Lazy Field\n```\n\nI find it very confusing, that there is a doctest fixing that there shall be no coercion of `QQ[I]` and `CLF`. If this is the way we want it to be, there should not be coercion of `QQ[I]` and `CLF` in the first place.\n\nThe same holds for `QQ[sqrt(2)]` btw. There is no embedding of `QQ[sqrt(2), sqrt(3)]` to `RLF`, but probably not by design but only because relative number fields do not support embeddings.",
    "created_at": "2019-11-21T14:38:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402969",
    "user": "@kliem"
}
```

To be more precise, as it is `QQ[I]` comes with an embedding to complex lazy field:

```
sage: coercion_model.explain(QQ[I], CLF)
Coercion on left operand via
    Generic morphism:
      From: Number Field in I with defining polynomial x^2 + 1 with I = 1*I
      To:   Complex Lazy Field
      Defn: I -> 1*I
Arithmetic performed after coercions.
Result lives in Complex Lazy Field
Complex Lazy Field
```

and there is a coercion from `QQbar` to `CLF`

```
sage: coercion_model.explain(QQbar, CLF)
Coercion on left operand via
    Generic morphism:
      From: Algebraic Field
      To:   Complex Lazy Field
Arithmetic performed after coercions.
Result lives in Complex Lazy Field
Complex Lazy Field
```

I find it very confusing, that there is a doctest fixing that there shall be no coercion of `QQ[I]` and `CLF`. If this is the way we want it to be, there should not be coercion of `QQ[I]` and `CLF` in the first place.

The same holds for `QQ[sqrt(2)]` btw. There is no embedding of `QQ[sqrt(2), sqrt(3)]` to `RLF`, but probably not by design but only because relative number fields do not support embeddings.



---

archive/issue_comments_402970.json:
```json
{
    "body": "Please tell me, if I should post a query on sage-devel instead.",
    "created_at": "2019-11-21T14:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402970",
    "user": "@kliem"
}
```

Please tell me, if I should post a query on sage-devel instead.



---

archive/issue_comments_402971.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2019-11-21T14:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402971",
    "user": "@kliem"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_402972.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2019-11-22T17:30:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402972",
    "user": "@kliem"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_402973.json:
```json
{
    "body": "Ok, I just went back to just doing `QQbar` and added the case that both are embedded into the same field.\n----\nNew commits:",
    "created_at": "2019-11-22T17:30:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402973",
    "user": "@kliem"
}
```

Ok, I just went back to just doing `QQbar` and added the case that both are embedded into the same field.
----
New commits:



---

archive/issue_comments_402974.json:
```json
{
    "body": "Your example\n\n```\nsage: K.<sqrt2_plus_sqrt3> = NumberField(x^4 - 10*x^2 + 1)\nsage: K2.<sqrt2> = NumberField(x^2-2, embedding=(sqrt2_plus_sqrt3^3 - 9*sqrt2_plus_sqrt3)/2)\nsage: K3.<sqrt3> = NumberField(x^2-3, embedding=-(sqrt2_plus_sqrt3^3 - 11*sqrt2_plus_sqrt3)/2)\nsage: sqrt2 + sqrt3\nsqrt2_plus_sqrt3\n```\n\nis working without any modification to the `_pushout_` method. You should simply remove what you wrote for number fields unless there is a real application for it.",
    "created_at": "2019-11-22T23:16:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402974",
    "user": "vdelecroix"
}
```

Your example

```
sage: K.<sqrt2_plus_sqrt3> = NumberField(x^4 - 10*x^2 + 1)
sage: K2.<sqrt2> = NumberField(x^2-2, embedding=(sqrt2_plus_sqrt3^3 - 9*sqrt2_plus_sqrt3)/2)
sage: K3.<sqrt3> = NumberField(x^2-3, embedding=-(sqrt2_plus_sqrt3^3 - 11*sqrt2_plus_sqrt3)/2)
sage: sqrt2 + sqrt3
sqrt2_plus_sqrt3
```

is working without any modification to the `_pushout_` method. You should simply remove what you wrote for number fields unless there is a real application for it.



---

archive/issue_comments_402975.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-11-22T23:16:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402975",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_402976.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-11-23T07:07:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402976",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_402977.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-11-23T07:20:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402977",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_402978.json:
```json
{
    "body": "Ok. I see.\n\nThis example is handled by the `_pushout_` method now, but I don't think it hurts. I wasn't aware that a canonical coercion is already discovered. Nice.\n\nI could also just handle `AA` and `QQbar`, if this seems more reasonable.",
    "created_at": "2019-11-23T07:20:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402978",
    "user": "@kliem"
}
```

Ok. I see.

This example is handled by the `_pushout_` method now, but I don't think it hurts. I wasn't aware that a canonical coercion is already discovered. Nice.

I could also just handle `AA` and `QQbar`, if this seems more reasonable.



---

archive/issue_comments_402979.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-11-23T16:40:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402979",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_402980.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-11-25T15:19:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402980",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_402981.json:
```json
{
    "body": "Replying to [comment:14 gh-kliem]:\n> Ok. I see.\n> \n> This example is handled by the `_pushout_` method now, but I don't think it hurts. I wasn't aware that a canonical coercion is already discovered. Nice.\n> \n> I could also just handle `AA` and `QQbar`, if this seems more reasonable.\n\nYes, it would be better.",
    "created_at": "2019-11-25T15:19:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402981",
    "user": "vdelecroix"
}
```

Replying to [comment:14 gh-kliem]:
> Ok. I see.
> 
> This example is handled by the `_pushout_` method now, but I don't think it hurts. I wasn't aware that a canonical coercion is already discovered. Nice.
> 
> I could also just handle `AA` and `QQbar`, if this seems more reasonable.

Yes, it would be better.



---

archive/issue_comments_402982.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-11-25T16:10:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402982",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_402983.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-11-25T16:11:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402983",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_402984.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402984",
    "user": "embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_402985.json:
```json
{
    "body": "Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402985",
    "user": "mkoeppe"
}
```

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_comments_402986.json:
```json
{
    "body": "Maybe we could be more greedy with something like\n\n```\nif codomain_self is not self or codomain_other is not other:\n    try:\n        return coercion_model.common_parent(codomain_self, codomain_other)\n    except TypeError:\n        pass\n```\n",
    "created_at": "2020-04-23T16:53:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402986",
    "user": "vdelecroix"
}
```

Maybe we could be more greedy with something like

```
if codomain_self is not self or codomain_other is not other:
    try:
        return coercion_model.common_parent(codomain_self, codomain_other)
    except TypeError:
        pass
```




---

archive/issue_comments_402987.json:
```json
{
    "body": "Looks like a good improvement as is.\n\nFeel free to open the suggestion from comment 21 as another ticket.",
    "created_at": "2020-07-18T19:23:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402987",
    "user": "mkoeppe"
}
```

Looks like a good improvement as is.

Feel free to open the suggestion from comment 21 as another ticket.



---

archive/issue_comments_402988.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-18T19:23:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402988",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_402989.json:
```json
{
    "body": "Thank you.",
    "created_at": "2020-07-18T19:41:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402989",
    "user": "@kliem"
}
```

Thank you.



---

archive/issue_comments_402990.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-25T22:51:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28541",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28541#issuecomment-402990",
    "user": "vbraun"
}
```

Resolution: fixed
