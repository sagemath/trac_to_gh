# Issue 34214: sage.tensor: Canonicalize sym, antisym

Issue created by migration from https://trac.sagemath.org/ticket/34451

Original creator: mkoeppe

Original creation time: 2022-08-29 17:21:32

CC:  egourgoulhon

for #30229


---

Comment by mkoeppe created at 2022-08-29 19:03:58

New commits:


---

Comment by mkoeppe created at 2022-08-29 19:03:58

Changing status from new to needs_review.


---

Comment by egourgoulhon created at 2022-09-01 08:20:40

Thanks for introducing this and removing the code duplication!

It would useful to add `INPUT` and `OUTPUT` fields in the docstring of `_canonicalize_sym_antisym`. 
Besides, I don't understand this change:

```diff
-                if len(isym) < 2:
-                    raise IndexError("at least two index positions must be " +
-                                     "provided to define a symmetry")
+                if len(isym) < 2:
+                    # Drop trivial symmetry
+                    continue
```

Shouldn't an error be raised if the input pretends to define a symmetry/antisymmetry with less than  2 index positions?


---

Comment by mkoeppe created at 2022-09-01 14:56:01

In this version of this code:

```
diff --git a/src/sage/tensor/modules/free_module_tensor.py b/src/sage/tensor/modules/free_module_tensor.py
index bbcc1ec..4d6d05c 100644
--- a/src/sage/tensor/modules/free_module_tensor.py
+++ b/src/sage/tensor/modules/free_module_tensor.py
@@ -309,41 +309,8 @@ class FreeModuleTensor(ModuleElementWithMutability):
                               # bases, with the bases as keys (initially empty)
 
         # Treatment of symmetry declarations:
-        self._sym = []
-        if sym is not None and sym != []:
-            if isinstance(sym[0], (int, Integer)):
-                # a single symmetry is provided as a tuple -> 1-item list:
-                sym = [tuple(sym)]
-            for isym in sym:
-                if len(isym) > 1:
-                    for i in isym:
```

... the trivial symmetries were dropped silently.

I suppose I can add a parameter `trivial_symmetries='error'` for the cases where you'd like to see the errors.


---

Comment by git created at 2022-09-01 16:27:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-01 16:35:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-01 16:39:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2022-09-01 16:47:59

Replying to [comment:5 mkoeppe]:
> In this version of this code:
>
> ... the trivial symmetries were dropped silently.

True...

> I suppose I can add a parameter `trivial_symmetries='error'` for the cases where you'd like to see the errors.

I am wondering about what should be meant by _trivial symmetry_, especially for an antisymmetry: if only a single index position is provided, is there any meaning in stating that the components are antisymmetric with respect to this position? 

----
New commits:


---

Comment by git created at 2022-09-01 16:49:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-01 16:59:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-09-01 17:00:41

Replying to [comment:9 egourgoulhon]:
> I am wondering about what should be meant by _trivial symmetry_, especially for an antisymmetry: if only a single index position is provided, is there any meaning in stating that the components are antisymmetric with respect to this position? 

One index (whether symmetry or antisymmetry) just means that there's a symmetry group of 1 element acting. This element is the identity


---

Comment by mkoeppe created at 2022-09-01 17:03:08

I ran into this, by the way, using `dual_ext_power` of order 1: It is passing `antisym=range(1)`.


---

Comment by mkoeppe created at 2022-09-01 17:04:02

I've worked a bit more on the branch and have removed some more code duplication. Ready for another look


---

Comment by egourgoulhon created at 2022-09-01 18:59:18

Replying to [comment:12 mkoeppe]:
> Replying to [comment:9 egourgoulhon]:
> > I am wondering about what should be meant by _trivial symmetry_, especially for an antisymmetry: if only a single index position is provided, is there any meaning in stating that the components are antisymmetric with respect to this position? 
> 
> One index (whether symmetry or antisymmetry) just means that there's a symmetry group of 1 element acting. This element is the identity

Thanks for the explanation. I see now: since the signature of the identity is +1, this makes sense. 
Then, I would vote for reverting to the original version, i.e. that without the extra argument `trivial_symmetries`: this adds an extra test and we might want a rather fast method here; moreover, I don't see any use case of `trivial_symmetries='error'`. Sorry for the noise... Anyway, I leave it to you...


---

Comment by egourgoulhon created at 2022-09-01 19:00:37

Replying to [comment:13 mkoeppe]:
> I ran into this, by the way, using `dual_ext_power` of order 1: It is passing `antisym=range(1)`. 
Indeed!


---

Comment by mkoeppe created at 2022-09-01 19:08:53

OK, I'll revert it


---

Comment by git created at 2022-09-01 19:28:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-09-01 19:28:54

Done


---

Comment by egourgoulhon created at 2022-09-02 08:40:44

Replying to [comment:19 mkoeppe]:
> Done
Thanks!


---

Comment by egourgoulhon created at 2022-09-02 08:40:44

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2022-09-02 09:01:28

There is actually an error (sequel of an old piece of code) in `_canonicalize_sym_antisym`, which is revealed by the pyflakes plugin of the patchbot running on #30229 (unfortunately, the patchbot did not visit this ticket after the last commit): the name `i` in 

```
                if isym[0] < 0 or isym[-1] > nb_indices - 1:
                    raise IndexError("invalid index position: " + str(i) +
                                     " not in [0," + str(nb_indices-1) + "]")
```

is undefined. Same issue a few lines lower.


---

Comment by egourgoulhon created at 2022-09-02 09:01:28

Changing status from positive_review to needs_work.


---

Comment by git created at 2022-09-02 16:14:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-09-02 16:20:10

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-09-02 16:24:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2022-09-02 21:25:42

Nice refactoring!


---

Comment by egourgoulhon created at 2022-09-02 21:25:42

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-09-02 21:27:39

Thanks!


---

Comment by vbraun created at 2022-09-22 22:35:26

Resolution: fixed
