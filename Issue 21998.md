# Issue 21998: pip-lock broken for global sage installs

archive/issues_021998.json:
```json
{
    "body": "Hello, over here in SMC-world, we have a global [SageMath](SageMath) install. One thing users like to do is to run {{{ sage -pip install --user ... }}. Problem is, with version 7.5 there is this {{ pip-lock }} script in place, which prevents them from doing that. The problem is:\n\n\n```\nTraceback (most recent call last): \nFile \"/projects/sage/sage-7.5/src/bin/pip-lock\", line 33, in <module> \nlock = open(lockfile, \"w+\") \nIOError: [Errno 13] Permission denied: \n'/projects/sage/sage-7.5/local/var/lock/pip.lock'\n```\n\n\nDigging up what's going on, it's because the path to the lock is based on  {{ sys.prefix }}. Therefore, this is kind of broken for everyone who is running [SageMath](SageMath) 7.5 via a common global installation.\n\nI have patched this up via\n\n\n```\ndiff --git a/src/bin/pip-lock b/src/bin/pip-lock\nindex 8975b52..38754bc 100755\n--- a/src/bin/pip-lock\n+++ b/src/bin/pip-lock\n@@ -22,7 +22,10 @@ sys.argv[0] = \"pip\"\n \n \n # Open lockfile and lock it\n-lockdir = os.path.join(sys.prefix, \"var\", \"lock\")\n+import site\n+user_local = site.getuserbase()\n+lockdir = os.path.join(user_local, \"var\", \"lock\")\n+\n try:\n     os.makedirs(lockdir)\n except OSError:\n```\n\n\nwhich basically changes ` sys.prefix ` by ` ~/.local `. In the context of SMC this makes sense (keep everything in ` ~/.local `) but maybe it could also be a temporary directory.\n\nIssue created by migration from https://trac.sagemath.org/ticket/22235\n\n",
    "created_at": "2017-01-22T15:59:07Z",
    "labels": [
        "component: misc",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.6",
    "title": "pip-lock broken for global sage installs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21998",
    "user": "https://github.com/haraldschilly"
}
```
Hello, over here in SMC-world, we have a global [SageMath](SageMath) install. One thing users like to do is to run {{{ sage -pip install --user ... }}. Problem is, with version 7.5 there is this {{ pip-lock }} script in place, which prevents them from doing that. The problem is:


```
Traceback (most recent call last): 
File "/projects/sage/sage-7.5/src/bin/pip-lock", line 33, in <module> 
lock = open(lockfile, "w+") 
IOError: [Errno 13] Permission denied: 
'/projects/sage/sage-7.5/local/var/lock/pip.lock'
```


Digging up what's going on, it's because the path to the lock is based on  {{ sys.prefix }}. Therefore, this is kind of broken for everyone who is running [SageMath](SageMath) 7.5 via a common global installation.

I have patched this up via


```
diff --git a/src/bin/pip-lock b/src/bin/pip-lock
index 8975b52..38754bc 100755
--- a/src/bin/pip-lock
+++ b/src/bin/pip-lock
@@ -22,7 +22,10 @@ sys.argv[0] = "pip"
 
 
 # Open lockfile and lock it
-lockdir = os.path.join(sys.prefix, "var", "lock")
+import site
+user_local = site.getuserbase()
+lockdir = os.path.join(user_local, "var", "lock")
+
 try:
     os.makedirs(lockdir)
 except OSError:
```


which basically changes ` sys.prefix ` by ` ~/.local `. In the context of SMC this makes sense (keep everything in ` ~/.local `) but maybe it could also be a temporary directory.

Issue created by migration from https://trac.sagemath.org/ticket/22235





---

archive/issue_comments_305394.json:
```json
{
    "body": "Replying to [ticket:22235 schilly]:\n> maybe it could also be a temporary directory.\n\nIt certainly can't be a temporary directory. It must be a deterministic directory for the locking mechanism to work.\n\nOne trivial solution would be to use the locking only for installing packages as part of building Sage itself and not use when running `sage --pip`",
    "created_at": "2017-01-23T08:33:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21998#issuecomment-305394",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [ticket:22235 schilly]:
> maybe it could also be a temporary directory.

It certainly can't be a temporary directory. It must be a deterministic directory for the locking mechanism to work.

One trivial solution would be to use the locking only for installing packages as part of building Sage itself and not use when running `sage --pip`



---

archive/issue_comments_305395.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-01-23T08:52:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21998#issuecomment-305395",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_305396.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-01-23T08:52:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21998#issuecomment-305396",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_305397.json:
```json
{
    "body": "This looks like a reasonable fix.",
    "created_at": "2017-02-02T21:07:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21998#issuecomment-305397",
    "user": "https://github.com/mkoeppe"
}
```

This looks like a reasonable fix.



---

archive/issue_comments_305398.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-02-02T21:07:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21998#issuecomment-305398",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_305399.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-02-03T23:51:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21998",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21998#issuecomment-305399",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
