# Issue 21998: pip-lock broken for global sage installs

Issue created by migration from https://trac.sagemath.org/ticket/22235

Original creator: schilly

Original creation time: 2017-01-22 15:59:07

Hello, over here in SMC-world, we have a global [SageMath](SageMath) install. One thing users like to do is to run {{{ sage -pip install --user ... }}. Problem is, with version 7.5 there is this {{ pip-lock }} script in place, which prevents them from doing that. The problem is:


```
Traceback (most recent call last): 
File "/projects/sage/sage-7.5/src/bin/pip-lock", line 33, in <module> 
lock = open(lockfile, "w+") 
IOError: [Errno 13] Permission denied: 
'/projects/sage/sage-7.5/local/var/lock/pip.lock'
```


Digging up what's going on, it's because the path to the lock is based on  {{ sys.prefix }}. Therefore, this is kind of broken for everyone who is running [SageMath](SageMath) 7.5 via a common global installation.

I have patched this up via


```
diff --git a/src/bin/pip-lock b/src/bin/pip-lock
index 8975b52..38754bc 100755
--- a/src/bin/pip-lock
+++ b/src/bin/pip-lock
@@ -22,7 +22,10 @@ sys.argv[0] = "pip"
 
 
 # Open lockfile and lock it
-lockdir = os.path.join(sys.prefix, "var", "lock")
+import site
+user_local = site.getuserbase()
+lockdir = os.path.join(user_local, "var", "lock")
+
 try:
     os.makedirs(lockdir)
 except OSError:
```


which basically changes ` sys.prefix ` by ` ~/.local `. In the context of SMC this makes sense (keep everything in ` ~/.local `) but maybe it could also be a temporary directory.


---

Comment by jdemeyer created at 2017-01-23 08:33:14

Replying to [ticket:22235 schilly]:
> maybe it could also be a temporary directory.

It certainly can't be a temporary directory. It must be a deterministic directory for the locking mechanism to work.

One trivial solution would be to use the locking only for installing packages as part of building Sage itself and not use when running `sage --pip`


---

Comment by jdemeyer created at 2017-01-23 08:52:24

New commits:


---

Comment by jdemeyer created at 2017-01-23 08:52:24

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2017-02-02 21:07:12

This looks like a reasonable fix.


---

Comment by mkoeppe created at 2017-02-02 21:07:12

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-02-03 23:51:19

Resolution: fixed
