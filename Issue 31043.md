# Issue 31043: Jupyter upgrade

Issue created by migration from https://trac.sagemath.org/ticket/31280

Original creator: mkoeppe

Original creation time: 2021-01-22 04:26:21

CC:  @jcamp0x2a slelievre kcrisman egourgoulhon fbissey vdelecroix @kliem arojas isuruf




---

Comment by mkoeppe created at 2021-01-22 04:45:53

New commits:


---

Comment by git created at 2021-01-22 18:26:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-01-22 18:49:45

`importlib_metadata` needs `toml`


---

Comment by mkoeppe created at 2021-01-22 18:51:06

`backcall` and `ptyprocess` need `flit_core` (#29846)


---

Comment by git created at 2021-01-22 19:38:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-01-22 19:44:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-01-22 19:51:48

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-01-22 19:57:32

With this update I seem to be running into:

```
  [pplpy-0.8.6]   Extension error:
  [pplpy-0.8.6]   Could not import extension sphinx.builders.linkcheck (exception: No module named 'urllib3')
  [pplpy-0.8.6]   make[5]: *** [html] Error 2
  [pplpy-0.8.6]   cp: build/html/*: No such file or directory
```



---

Comment by vdelecroix created at 2021-01-23 08:44:14

I don't see why this would have anything to do with Jupyter. The problem seems to happen during the build of the pplpy documentation with sphinx. Probably to make cross linking, sphinx requires `urllib3`... though this problem never occured to me.


---

Comment by mkoeppe created at 2021-01-23 17:42:47

This ticket is updating 40 packages, including `requests`


---

Comment by mkoeppe created at 2021-02-02 20:17:14

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-03-10 02:15:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2021-03-10 02:16:35

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-03-10 04:46:41

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-05-12 01:57:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2021-05-12 02:12:45

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-05-12 02:58:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-12 03:35:50

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-05-19 02:44:40

Upgraded `requests` has new dependencies:

```
requires = [
    'chardet>=3.0.2,<5',
    'idna>=2.5,<3',
    'urllib3>=1.21.1,<1.27',
    'certifi>=2017.4.17'
]
```



---

Comment by mkoeppe created at 2021-05-19 02:44:40

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-05-19 03:52:04

(requests unvendored these libraries in 2.16 - https://docs.python-requests.org/en/master/community/updates/#id25)


---

Comment by git created at 2021-05-19 03:55:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-19 03:56:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-05-19 04:04:58

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-05-25 00:21:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-31 21:22:30

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by dimpase created at 2021-06-02 11:18:49

lgtm


---

Comment by dimpase created at 2021-06-02 11:18:49

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-06-02 16:29:22

Thanks!


---

Comment by mkoeppe created at 2021-06-02 16:34:13

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-06-02 16:38:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-02 16:38:23

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-06-02 22:41:41

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-06-02 22:41:41

OK


---

Comment by mkoeppe created at 2021-06-03 00:10:38

Thanks


---

Comment by vbraun created at 2021-06-29 22:38:56

On OSX:

```
sage -t --long --random-seed=0 src/sage/interfaces/expect.py  # 38 doctests failed
sage -t --long --random-seed=0 src/sage/interfaces/gap.py  # 61 doctests failed
sage -t --long --random-seed=0 src/sage/interfaces/mwrank.py  # 6 doctests failed
sage -t --long --random-seed=0 src/sage/interfaces/quit.py  # 6 doctests failed
```



---

Comment by vbraun created at 2021-06-29 22:38:56

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2021-06-29 22:46:15

More detail please


---

Comment by mkoeppe created at 2021-07-06 18:52:38

Indeed, the upgrade of ptyprocess breaks `sage.interfaces.expect` on macOS.

Does someone already have a fix for this?


---

Comment by mkoeppe created at 2021-07-06 19:05:43

Even just upgrading `ptyprocess` from 0.5.1 to 0.5.2 causes the breakage. All later versions (0.6.0, 0.7.0) are broken.


---

Comment by mkoeppe created at 2021-07-06 19:09:54

If we are lucky, this is just https://github.com/pexpect/ptyprocess/commit/f673a54f1fef9c390bc1a683cbcdfa8128385bd0


---

Comment by git created at 2021-07-06 19:15:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-06 19:18:17

I have opened #32147 (Make `sage.interfaces.expect` compatible with ptyprocess >= 0.5.2).
I don't think we need it for this ticket.


---

Comment by mkoeppe created at 2021-07-06 19:19:40

Cherry-picked the single fix-up commit for `rst2ipynb` from #31967.


---

Comment by mkoeppe created at 2021-07-06 19:21:16

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-07-07 18:08:52

starting `./sage -n` and attempting to create a Sage notebook from browser leads to `500 Internal Server Error` and on console I see 

```
ModuleNotFoundError: No module named 'jupyterlab_pygments'
```

the full log (I killed the session with Ctrl-C in the end)

```
Please wait while the Sage Jupyter Notebook server starts...
[I 19:04:20.346 NotebookApp] Serving notebooks from local directory: /mnt/opt/Sage/sage-dev
[I 19:04:20.346 NotebookApp] Jupyter Notebook 6.3.0 is running at:
[I 19:04:20.347 NotebookApp] http://localhost:8888/?token=0d3f0cbd61c7d818de2b8399e051f51dc2fdf23481edb381
[I 19:04:20.347 NotebookApp]  or http://127.0.0.1:8888/?token=0d3f0cbd61c7d818de2b8399e051f51dc2fdf23481edb381
[I 19:04:20.347 NotebookApp] Use Control-C to stop this server and shut down all kernels (twice to skip confirmation).
[C 19:04:20.394 NotebookApp] 
    
    To access the notebook, open this file in a browser:
        file:///home/dima/.local/share/jupyter/runtime/nbserver-11985-open.html
    Or copy and paste one of these URLs:
        http://localhost:8888/?token=0d3f0cbd61c7d818de2b8399e051f51dc2fdf23481edb381
     or http://127.0.0.1:8888/?token=0d3f0cbd61c7d818de2b8399e051f51dc2fdf23481edb381
[I 19:04:31.562 NotebookApp] Creating new notebook in 
[E 19:04:31.729 NotebookApp] Uncaught exception GET /notebooks/Untitled1.ipynb?kernel_name=sagemath (127.0.0.1)
    HTTPServerRequest(protocol='http', host='localhost:8888', method='GET', uri='/notebooks/Untitled1.ipynb?kernel_name=sagemath', version='HTTP/1.1', remote_ip='127.0.0.1')
    Traceback (most recent call last):
      File "/mnt/opt/Sage/sage-dev/local/lib/python3.8/site-packages/tornado/web.py", line 1704, in _execute
        result = await result
      File "/mnt/opt/Sage/sage-dev/local/lib/python3.8/site-packages/tornado/gen.py", line 775, in run
        yielded = self.gen.send(value)
      File "/mnt/opt/Sage/sage-dev/local/lib/python3.8/site-packages/notebook/notebook/handlers.py", line 95, in get
        self.write(self.render_template('notebook.html',
      File "/mnt/opt/Sage/sage-dev/local/lib/python3.8/site-packages/notebook/base/handlers.py", line 516, in render_template
        return template.render(**ns)
      File "/mnt/opt/Sage/sage-dev/local/lib/python3.8/site-packages/jinja2/environment.py", line 1090, in render
        self.environment.handle_exception()
      File "/mnt/opt/Sage/sage-dev/local/lib/python3.8/site-packages/jinja2/environment.py", line 832, in handle_exception
        reraise(*rewrite_traceback_stack(source=source))
      File "/mnt/opt/Sage/sage-dev/local/lib/python3.8/site-packages/jinja2/_compat.py", line 28, in reraise
        raise value.with_traceback(tb)
      File "/mnt/opt/Sage/sage-dev/local/lib/python3.8/site-packages/notebook/templates/notebook.html", line 1, in top-level template code
        {% extends "page.html" %}
      File "/mnt/opt/Sage/sage-dev/local/lib/python3.8/site-packages/notebook/templates/page.html", line 154, in top-level template code
        {% block header %}
      File "/mnt/opt/Sage/sage-dev/local/lib/python3.8/site-packages/notebook/templates/notebook.html", line 115, in block "header"
        {% for exporter in get_frontend_exporters() %}
      File "/mnt/opt/Sage/sage-dev/local/lib/python3.8/site-packages/notebook/notebook/handlers.py", line 23, in get_frontend_exporters
        from nbconvert.exporters.base import get_export_names, get_exporter
      File "/mnt/opt/Sage/sage-dev/local/lib/python3.8/site-packages/nbconvert/__init__.py", line 4, in <module>
        from .exporters import *
      File "/mnt/opt/Sage/sage-dev/local/lib/python3.8/site-packages/nbconvert/exporters/__init__.py", line 4, in <module>
        from .slides import SlidesExporter
      File "/mnt/opt/Sage/sage-dev/local/lib/python3.8/site-packages/nbconvert/exporters/slides.py", line 12, in <module>
        from ..preprocessors.base import Preprocessor
      File "/mnt/opt/Sage/sage-dev/local/lib/python3.8/site-packages/nbconvert/preprocessors/__init__.py", line 7, in <module>
        from .csshtmlheader import CSSHTMLHeaderPreprocessor
      File "/mnt/opt/Sage/sage-dev/local/lib/python3.8/site-packages/nbconvert/preprocessors/csshtmlheader.py", line 14, in <module>
        from jupyterlab_pygments import JupyterStyle
    ModuleNotFoundError: No module named 'jupyterlab_pygments'
[E 19:04:31.737 NotebookApp] {
      "Host": "localhost:8888",
      "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:87.0) Gecko/20100101 Firefox/87.0",
      "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
      "Accept-Language": "en-US,en;q=0.5",
      "Accept-Encoding": "gzip, deflate",
      "Dnt": "1",
      "Connection": "keep-alive",
      "Referer": "http://localhost:8888/tree",
      "Cookie": "username-localhost-8888=\"2|1:0|10:1625681061|23:username-localhost-8888|44:Yzk3OTE4MGZmZDk0NGIwZWE3OGJhN2U2ZWRlZjM2MjQ=|1dece02d459d6cbd9afa3010954d3af0225ea32fc03d6fb8a2c97d06acb77c3b\"; _xsrf=2|32f2db10|41bba910a8914a43d015ffbce18afe72|1625680821",
      "Upgrade-Insecure-Requests": "1"
    }
[E 19:04:31.737 NotebookApp] 500 GET /notebooks/Untitled1.ipynb?kernel_name=sagemath (127.0.0.1) 94.570000ms referer=http://localhost:8888/tree
^C[I 19:04:51.095 NotebookApp] interrupted
Serving notebooks from local directory: /mnt/opt/Sage/sage-dev
0 active kernels
Jupyter Notebook 6.3.0 is running at:
http://localhost:8888/?token=0d3f0cbd61c7d818de2b8399e051f51dc2fdf23481edb381
 or http://127.0.0.1:8888/?token=0d3f0cbd61c7d818de2b8399e051f51dc2fdf23481edb381
Shutdown this notebook server (y/[n])? y
```



---

Comment by dimpase created at 2021-07-07 18:17:47

To make it work, I tried

```
$ ./sage --pip3 install jupyterlab_pygments
```

and got

```
Collecting jupyterlab_pygments
  Using cached jupyterlab_pygments-0.1.2-py2.py3-none-any.whl (4.6 kB)
Requirement already satisfied: pygments<3,>=2.4.1 in ./local/lib/python3.8/site-packages (from jupyterlab_pygments) (2.9.0)
Installing collected packages: jupyterlab-pygments
ERROR: pip's dependency resolver does not currently take into account all the packages that are installed. This behaviour is the source of the following dependency conflicts.
nbconvert 6.0.7 requires nbclient<0.6.0,>=0.5.0, which is not installed.
Successfully installed jupyterlab-pygments-0.1.2
```

Then I did

```
./sage --pip3 uninstall jupyterlab_pygments
./sage --pip3 install nbclient
./sage --pip3 install jupyterlab_pygments
```

and this fixed this issue.


---

Comment by mkoeppe created at 2021-07-07 19:48:11

Thanks for testing!


---

Comment by mkoeppe created at 2021-07-07 19:48:11

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-07-19 03:15:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-19 03:33:49

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-07-19 03:33:49

I can't reproduce this error...
Another try on top of the current beta?


---

Comment by dimpase created at 2021-07-21 13:44:26

still the same error as in comment:51


---

Comment by mkoeppe created at 2021-07-21 16:12:28

What does `./sage -pip list` say on this installation?


---

Attachment

pip list output


---

Comment by dimpase created at 2021-07-22 08:40:46

Replying to [comment:57 mkoeppe]:
> What does `./sage -pip list` say on this installation?
attached.


---

Comment by git created at 2021-08-12 02:50:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-12 03:02:56

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-08-12 04:32:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-12 04:37:09

OK... `jupyterlab_pygments` is a new dependency of `nbconvert`. Some more dependencies also came in.


---

Comment by chapoton created at 2021-08-12 11:56:52

Note: update of **requests** should help for #30768


---

Comment by git created at 2021-08-12 18:36:19

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2021-08-12 18:37:27

Rebased onto 9.4.rc1 + #32371, #32372. Dropped parso update, which went outside the version range of another package


---

Comment by git created at 2021-08-12 18:48:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-13 04:32:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-13 07:41:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-13 20:42:55

The upgraded `ipykernel` declares two new `install_requires`: https://pypi.org/project/debugpy/, https://pypi.org/project/matplotlib-inline/


---

Comment by git created at 2021-08-13 20:46:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-13 22:01:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-26 20:48:09

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-08-28 00:46:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-28 17:09:46

Some dependencies need to be declared:

```
   File "/opt/sage-5e2cde910e349f3b257feb1bbcf1c5a3f83d122b/lib/python3.8/site-packages/jupyter_client/provisioning/factory.py", line 9, in <module>
      from entrypoints import EntryPoint  # type: ignore
  ModuleNotFoundError: No module named 'entrypoints'
  Building wheel for ipykernel (PEP 517): finished with status 'error'
  ERROR: Failed building wheel for ipykernel
Failed to build ipykernel
ERROR: Failed to build one or more wheels
```

https://github.com/mkoeppe/sage/runs/3449969195


---

Comment by git created at 2021-08-28 17:21:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-06 22:36:12

https://github.com/mkoeppe/sage/actions/runs/1177591365 still indicates dependency trouble

```
  [ipykernel-6.2.0] error installing, exit status 1. End of log file:
  [ipykernel-6.2.0]       File "/opt/sage-7bc14322e3a24f69b4bf3741c25d26d20a26f47c/lib/python3.8/site-packages/jupyter_client/provisioning/factory.py", line 9, in <module>
  [ipykernel-6.2.0]         from entrypoints import EntryPoint  # type: ignore
  [ipykernel-6.2.0]     ModuleNotFoundError: No module named 'entrypoints'
  [ipykernel-6.2.0]     Building wheel for ipykernel (PEP 517): finished with status 'error'
  [ipykernel-6.2.0]     ERROR: Failed building wheel for ipykernel
```



---

Comment by git created at 2021-09-06 22:47:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-06 23:07:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-09-06 23:10:29

Replying to [comment:68 mkoeppe]:
> Dropped parso update, which went outside the version range of another package

Now `jedi` insisted on `parso<0.9.0,>=0.8.0`, so I upgraded to latest


---

Comment by git created at 2021-09-06 23:41:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-09-07 12:52:33

OK, this  looks good. I see you're testing cygiwn on GH Actions. Feel free to flip to positive review if these make sense to you.


---

Comment by mkoeppe created at 2021-09-07 18:15:27

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-09-07 18:15:27

Thank you! Yes, the Cygwin test looks fine (in previous runs, the multi-stage CI for Cygwin had revealed some of the missing dependencies).


---

Comment by dimpase created at 2021-09-08 13:30:04

`debugpy` is introduced here, but not listed as a dependency anywhere. Seems to be a bug.
(I got an error importing debugpy while working on new matplotlib with this ticket merged).

Should be a dependency of ipykernel as far as I can tell.


---

Comment by dimpase created at 2021-09-08 13:30:54

Changing status from positive_review to needs_info.


---

Comment by mkoeppe created at 2021-09-08 17:36:50

It is only needed at runtime. Being a standard package, `debugpy` is installed whenever `make build` is used.

Since this is already on Volker's branch, let's keep it on "positive review" and add the dependency in a follow-up ticket


---

Comment by mkoeppe created at 2021-09-08 17:36:50

Changing status from needs_info to positive_review.


---

Comment by dimpase created at 2021-09-08 19:35:41

I think I got the error after I typed `make`, and it was building docs. So I am not 100% sure that it would be built without declared a dependency of sagelib.


---

Comment by mkoeppe created at 2021-09-08 19:42:52

Let's do this in #32493


---

Comment by vbraun created at 2021-09-13 22:22:30

Resolution: fixed


---

Comment by slelievre created at 2021-11-13 15:24:31

Changing keywords from "" to "upgrade, jupyter".
