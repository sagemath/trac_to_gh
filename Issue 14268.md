# Issue 14268: some elliptic curve functions over number fields fail over relative fields

archive/issues_014268.json:
```json
{
    "body": "Assignee: cremona\n\nCC:  alejandroargaez@hotmail.com\n\nKeywords: elliptic curve relative number field\n\nThis was reported by Alejandro Argaez:\n\n```\nsage: K1.<w>=NumberField(x^2+x+1)             \nsage: m=polygen(K1)\nsage: K2.<v>=K1.extension(m^2-w+1)\nsage: E=EllipticCurve([0*v,-432])\nsage: E.global_minimal_model()\n<boom>\n```\n\nThe error is that the degree() function is called on the ring of integers of a relative number field.\n\nIn fixing this bug (which should be easy) it would be a good idea to add relative examples to as many functions as possible in `ell_numberfield.py`\n\nIssue created by migration from https://trac.sagemath.org/ticket/14472\n\n",
    "created_at": "2013-04-21T16:14:02Z",
    "labels": [
        "elliptic curves",
        "major",
        "bug"
    ],
    "title": "some elliptic curve functions over number fields fail over relative fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14268",
    "user": "cremona"
}
```
Assignee: cremona

CC:  alejandroargaez@hotmail.com

Keywords: elliptic curve relative number field

This was reported by Alejandro Argaez:

```
sage: K1.<w>=NumberField(x^2+x+1)             
sage: m=polygen(K1)
sage: K2.<v>=K1.extension(m^2-w+1)
sage: E=EllipticCurve([0*v,-432])
sage: E.global_minimal_model()
<boom>
```

The error is that the degree() function is called on the ring of integers of a relative number field.

In fixing this bug (which should be easy) it would be a good idea to add relative examples to as many functions as possible in `ell_numberfield.py`

Issue created by migration from https://trac.sagemath.org/ticket/14472





---

archive/issue_comments_179598.json:
```json
{
    "body": "Note: after changing ZK.degree() to ZK.absolute_degree() on line 651 of `ell_numberfield.py` it still fails, since the code in lines 656--658 (which I wrote, I think) does not work for relative number fields.  The purpose of these lines is to set r,s,t to \"least residues\" modulo 2,3,2 of three successive quantities.",
    "created_at": "2013-04-21T16:38:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14268#issuecomment-179598",
    "user": "cremona"
}
```

Note: after changing ZK.degree() to ZK.absolute_degree() on line 651 of `ell_numberfield.py` it still fails, since the code in lines 656--658 (which I wrote, I think) does not work for relative number fields.  The purpose of these lines is to set r,s,t to "least residues" modulo 2,3,2 of three successive quantities.



---

archive/issue_comments_179599.json:
```json
{
    "body": "Replying to [comment:1 cremona]:\n> Note: after changing ZK.degree() to ZK.absolute_degree() on line 651 of `ell_numberfield.py` it still fails, since the code in lines 656--658 (which I wrote, I think) does not work for relative number fields.  The purpose of these lines is to set r,s,t to \"least residues\" modulo 2,3,2 of three successive quantities.\n\nFollow-up:  the old code for _reduce_model() was flawed, as follows:   to reduce a1,a2,a3 modulo 2,3,2 respectively, it attempted to reduce their coordinates as given by list(a1), etc.  Firstly this fails for relative extensions, but it is also misguided since there is no reason why the list() coordinates should be integral.  I have changed this to work with the coordinates with respect to an integral basis, which is good for relative extensions.  Only one small problem:  the doctest on line 860 which used to return (as a minimal model over Q(a) where a=sqrt(5))\n\n```\n(0, 1, 0, a - 33, -2*a + 64)\n```\n\nbut now  gives\n\n```\n(0, -3/2*a - 1/2, 0, 3/2*a - 59/2, 27/2*a + 155/2)\n```\n\nwhich does not look so nice.  Note that the integral basis here is [1/2*a + 1/2, a] and that with respect to this basis 1 has coordinates (2,-1) while -3/2*a - 1/2 has coordinates (-1,-1) so (counterintuitively) 1 is not reduced mod 2 but -(3a+1)/2 is!\n\nNote that the integral basis computed does depend on the polynomial used to generate the field:\n\n```\nsage: QuadraticField(5,'a').ring_of_integers().gens()                                                   \n[1/2*a + 1/2, a]\nsage: NumberField(x^2-x-1,'a').ring_of_integers().gens()                                                \n[1, a]\n```\n",
    "created_at": "2013-04-22T09:14:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14268#issuecomment-179599",
    "user": "cremona"
}
```

Replying to [comment:1 cremona]:
> Note: after changing ZK.degree() to ZK.absolute_degree() on line 651 of `ell_numberfield.py` it still fails, since the code in lines 656--658 (which I wrote, I think) does not work for relative number fields.  The purpose of these lines is to set r,s,t to "least residues" modulo 2,3,2 of three successive quantities.

Follow-up:  the old code for _reduce_model() was flawed, as follows:   to reduce a1,a2,a3 modulo 2,3,2 respectively, it attempted to reduce their coordinates as given by list(a1), etc.  Firstly this fails for relative extensions, but it is also misguided since there is no reason why the list() coordinates should be integral.  I have changed this to work with the coordinates with respect to an integral basis, which is good for relative extensions.  Only one small problem:  the doctest on line 860 which used to return (as a minimal model over Q(a) where a=sqrt(5))

```
(0, 1, 0, a - 33, -2*a + 64)
```

but now  gives

```
(0, -3/2*a - 1/2, 0, 3/2*a - 59/2, 27/2*a + 155/2)
```

which does not look so nice.  Note that the integral basis here is [1/2*a + 1/2, a] and that with respect to this basis 1 has coordinates (2,-1) while -3/2*a - 1/2 has coordinates (-1,-1) so (counterintuitively) 1 is not reduced mod 2 but -(3a+1)/2 is!

Note that the integral basis computed does depend on the polynomial used to generate the field:

```
sage: QuadraticField(5,'a').ring_of_integers().gens()                                                   
[1/2*a + 1/2, a]
sage: NumberField(x^2-x-1,'a').ring_of_integers().gens()                                                
[1, a]
```




---

archive/issue_comments_179600.json:
```json
{
    "body": "Applies to 5.9.beta5",
    "created_at": "2013-04-22T10:19:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14268#issuecomment-179600",
    "user": "cremona"
}
```

Applies to 5.9.beta5



---

archive/issue_comments_179601.json:
```json
{
    "body": "Attachment [trac_14472-elliptic_curves.patch](tarball://root/attachments/some-uuid/ticket14472/trac_14472-elliptic_curves.patch) by cremona created at 2013-04-22 10:20:11",
    "created_at": "2013-04-22T10:20:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14268#issuecomment-179601",
    "user": "cremona"
}
```

Attachment [trac_14472-elliptic_curves.patch](tarball://root/attachments/some-uuid/ticket14472/trac_14472-elliptic_curves.patch) by cremona created at 2013-04-22 10:20:11



---

archive/issue_comments_179602.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-04-22T10:20:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14268#issuecomment-179602",
    "user": "cremona"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_179603.json:
```json
{
    "body": "All the examples seem to be *quadratic* number fields, is this intentional?\n\nI don't know why Sage returns the basis of `ZK` like that, because it's not what PARI gives:\n\n```\nsage: K.<a> = NumberField(x^2-5)\nsage: K.integral_basis()\n[1/2*a + 1/2, a]\nsage: K._pari_integral_basis()\n[1, 1/2*y - 1/2]\n```\n\n\nAs for reducing an element modulo an ideal (which is what you do here), you could use PARI's `nfeltreduce()`.",
    "created_at": "2013-04-23T07:20:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14268#issuecomment-179603",
    "user": "jdemeyer"
}
```

All the examples seem to be *quadratic* number fields, is this intentional?

I don't know why Sage returns the basis of `ZK` like that, because it's not what PARI gives:

```
sage: K.<a> = NumberField(x^2-5)
sage: K.integral_basis()
[1/2*a + 1/2, a]
sage: K._pari_integral_basis()
[1, 1/2*y - 1/2]
```


As for reducing an element modulo an ideal (which is what you do here), you could use PARI's `nfeltreduce()`.



---

archive/issue_comments_179604.json:
```json
{
    "body": "Replying to [comment:4 jdemeyer]:\n> All the examples seem to be *quadratic* number fields, is this intentional?\n\nNo, probably just laziness.\n\n> \n> I don't know why Sage returns the basis of `ZK` like that, because it's not what PARI gives:\n> {{{\n> sage: K.<a> = NumberField(x^2-5)\n> sage: K.integral_basis()\n> [1/2*a + 1/2, a]\n> sage: K._pari_integral_basis()\n> [1, 1/2*y - 1/2]\n> }}}\n> \n\nWell spotted.  The integral_basis method calls maximal_order which does call _pari_integral_basis, but then applies some Order constructor to the generators (order.absolute_order_from_module_generators) which is where this non-canonical ( to my mind) basis comes from.  If that is to be chaned for quadratic fields then that would be a separate ticket, and would surely have a lot of doctest output consequences.\n\n> As for reducing an element modulo an ideal (which is what you do here), you could use PARI's `nfeltreduce()`.\n\nSure, but here we are only reducing modulo (2) or (3) so it seemed easier to do it manually.",
    "created_at": "2013-04-23T08:28:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14268#issuecomment-179604",
    "user": "cremona"
}
```

Replying to [comment:4 jdemeyer]:
> All the examples seem to be *quadratic* number fields, is this intentional?

No, probably just laziness.

> 
> I don't know why Sage returns the basis of `ZK` like that, because it's not what PARI gives:
> {{{
> sage: K.<a> = NumberField(x^2-5)
> sage: K.integral_basis()
> [1/2*a + 1/2, a]
> sage: K._pari_integral_basis()
> [1, 1/2*y - 1/2]
> }}}
> 

Well spotted.  The integral_basis method calls maximal_order which does call _pari_integral_basis, but then applies some Order constructor to the generators (order.absolute_order_from_module_generators) which is where this non-canonical ( to my mind) basis comes from.  If that is to be chaned for quadratic fields then that would be a separate ticket, and would surely have a lot of doctest output consequences.

> As for reducing an element modulo an ideal (which is what you do here), you could use PARI's `nfeltreduce()`.

Sure, but here we are only reducing modulo (2) or (3) so it seemed easier to do it manually.



---

archive/issue_comments_179605.json:
```json
{
    "body": "I made a new patch using PARI's `nfeltdiveuc`. This gives simpler code and has the advantage that 1 is reduced, so there is no need to change the field.",
    "created_at": "2013-04-23T09:32:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14268#issuecomment-179605",
    "user": "jdemeyer"
}
```

I made a new patch using PARI's `nfeltdiveuc`. This gives simpler code and has the advantage that 1 is reduced, so there is no need to change the field.



---

archive/issue_comments_179606.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-04-23T09:34:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14268#issuecomment-179606",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_179607.json:
```json
{
    "body": "Replying to [comment:7 jdemeyer]:\nI like the use of nfeltdiveuc, but (as you have maybe already noticed) the values of r,s,t are not the reduced values....so I'll wait for the next version of your patch!",
    "created_at": "2013-04-23T09:39:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14268#issuecomment-179607",
    "user": "cremona"
}
```

Replying to [comment:7 jdemeyer]:
I like the use of nfeltdiveuc, but (as you have maybe already noticed) the values of r,s,t are not the reduced values....so I'll wait for the next version of your patch!



---

archive/issue_comments_179608.json:
```json
{
    "body": "Replying to [comment:8 cremona]:\n> Replying to [comment:7 jdemeyer]:\n> I like the use of nfeltdiveuc, but (as you have maybe already noticed) the values of r,s,t are not the reduced values...\nSorry, I don't understand what you mean. Can you say more precisely what is wrong?",
    "created_at": "2013-04-23T10:43:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14268#issuecomment-179608",
    "user": "jdemeyer"
}
```

Replying to [comment:8 cremona]:
> Replying to [comment:7 jdemeyer]:
> I like the use of nfeltdiveuc, but (as you have maybe already noticed) the values of r,s,t are not the reduced values...
Sorry, I don't understand what you mean. Can you say more precisely what is wrong?



---

archive/issue_comments_179609.json:
```json
{
    "body": "Sorry, I think I misunderstood the output of nfeltdiveuc.  I see now that it gives the quotient, not the remainder, and that is correct.  So it is good.  I am testing -- so why does it need work?\n\nAlso, I am getting an warning that line 9821 in sage.libs.pari.gen.pyx is unreachable code.  Does tat need looking into?",
    "created_at": "2013-04-23T10:57:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14268#issuecomment-179609",
    "user": "cremona"
}
```

Sorry, I think I misunderstood the output of nfeltdiveuc.  I see now that it gives the quotient, not the remainder, and that is correct.  So it is good.  I am testing -- so why does it need work?

Also, I am getting an warning that line 9821 in sage.libs.pari.gen.pyx is unreachable code.  Does tat need looking into?



---

archive/issue_comments_179610.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-04-23T11:46:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14268#issuecomment-179610",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_179611.json:
```json
{
    "body": "Attachment [trac_14472-elliptic_curves_jd.patch](tarball://root/attachments/some-uuid/ticket14472/trac_14472-elliptic_curves_jd.patch) by jdemeyer created at 2013-04-23 11:50:04\n\nReplying to [comment:10 cremona]:\n> Also, I am getting an warning that line 9821 in sage.libs.pari.gen.pyx is unreachable code.  Does tat need looking into?\nThat has nothing to do with this ticket, but I fixed it anyway.",
    "created_at": "2013-04-23T11:50:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14268#issuecomment-179611",
    "user": "jdemeyer"
}
```

Attachment [trac_14472-elliptic_curves_jd.patch](tarball://root/attachments/some-uuid/ticket14472/trac_14472-elliptic_curves_jd.patch) by jdemeyer created at 2013-04-23 11:50:04

Replying to [comment:10 cremona]:
> Also, I am getting an warning that line 9821 in sage.libs.pari.gen.pyx is unreachable code.  Does tat need looking into?
That has nothing to do with this ticket, but I fixed it anyway.



---

archive/issue_comments_179612.json:
```json
{
    "body": "John, do you want to formally review my patch? I give positive review to the parts which were copied from your initial patch.",
    "created_at": "2013-04-25T11:54:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14268#issuecomment-179612",
    "user": "jdemeyer"
}
```

John, do you want to formally review my patch? I give positive review to the parts which were copied from your initial patch.



---

archive/issue_comments_179613.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-04-25T12:26:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14268#issuecomment-179613",
    "user": "cremona"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_179614.json:
```json
{
    "body": "I give positive review to the parts which Jeroen added, hance we have an overall positive review.",
    "created_at": "2013-04-25T12:26:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14268#issuecomment-179614",
    "user": "cremona"
}
```

I give positive review to the parts which Jeroen added, hance we have an overall positive review.



---

archive/issue_comments_179615.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-04-30T09:40:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14268#issuecomment-179615",
    "user": "jdemeyer"
}
```

Resolution: fixed
