# Issue 26993: Improve detection of library files in sage.env

Issue created by migration from https://trac.sagemath.org/ticket/27230

Original creator: embray

Original creation time: 2019-02-06 15:59:11

CC:  dimpase fbissey

This is basically repackaging the existing code from `sage.env` that is used to set the `SINGULAR_SO` variable, but making it a bit more generic and flexible.

This will be useful as well for #26930 to get the correct libgap path.  It also tries to be a bit more flexible than the old code, so as to reduce the need for patching in some distros, though this does not guarantee to eliminate that need altogether.


---

Comment by embray created at 2019-02-06 16:02:41

I have a branch for this, but the cloud hosting provider for the VM I was working in seems to be monkeying around with something and now my VM lacks working DNS...


---

Comment by embray created at 2019-02-06 16:03:20

Oh, it's working again....
----
New commits:


---

Comment by embray created at 2019-02-06 16:03:20

Changing status from new to needs_review.


---

Comment by embray created at 2019-02-06 16:04:54

This is built on top of #27040, with which it would otherwise conflict.

For #26930 the idea then would be to add


```
LIBGAP_SO = _get_shared_lib_filename('gap')
```



---

Comment by dimpase created at 2019-02-06 16:06:30

merge conflict, red branch...


---

Comment by git created at 2019-02-06 16:06:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-02-06 16:07:36

Rebased on latest develop again.  It seems 8.7.beta2 was released since I was previously working on this yesterday, and already includes #27040.


---

Comment by embray created at 2019-02-06 16:11:34

Changing status from needs_review to needs_work.


---

Comment by embray created at 2019-02-06 16:11:34

I just realized with my second commit the test could fail now on Debian.


---

Comment by git created at 2019-02-06 16:14:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2019-02-06 16:14:28

Changing status from needs_work to needs_review.


---

Comment by embray created at 2019-02-06 16:14:28

New commits:


---

Comment by dimpase created at 2019-02-06 18:34:15

Does this stuff really belong to `src/sage/env.py`? 
IMHO a better fit would be src/sage/libs/ - as this is really something to do with libs...


---

Comment by fbissey created at 2019-02-06 18:51:54

`env.py` is a central repository of variables so it fits there. But I am open to discussion about splitting some of it in the future if there is a good rationale. But that will be in the future. 

Now this will remove a bit of patch in sage-on-gentoo in a nice generic way. The amount of patching of sage in sage-on-gentoo has gone down considerably.


---

Comment by fbissey created at 2019-02-06 19:57:52

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2019-02-06 19:57:52

Patchbot has two failures unrelated to this ticket and it looks good to me. So I am giving this a positive review.


---

Comment by dimpase created at 2019-02-06 19:58:30

OK, so please apply to your branch

```
--- a/src/sage/env.py
+++ b/src/sage/env.py
@@ -267,6 +267,10 @@ def _get_shared_lib_filename(libname, *additional_libnames):
 SINGULAR_SO = _get_shared_lib_filename('Singular', 'singular-Singular')
 var('SINGULAR_SO', SINGULAR_SO)
 
+# locate libgap shared object
+GAP_SO= _get_shared_lib_filename('gap','')
+var('GAP_SO', GAP_SO)
+
 # post process
 if ' ' in DOT_SAGE:
     if UNAME[:6] == 'CYGWIN':
```

and then I'll use it on #26930


---

Comment by dimpase created at 2019-02-06 19:58:30

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2019-02-07 01:43:11

I just added the stuff I asked for in comment 13 to the branch of #26930, so no worried about it, positive review.


---

Comment by dimpase created at 2019-02-07 01:43:11

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2019-02-07 08:09:30

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2019-02-07 08:09:30

`pyflakes` reports:

```
src/sage/env.py:37: redefinition of unused 'sys' from line 32
src/sage/env.py:235: undefined name 'libdir'
src/sage/env.py:235: undefined name 'libdir'
```

The latter is a genuine bug as far as I can see.


---

Comment by jdemeyer created at 2019-02-07 08:11:41

Just a minor thing, but I find this remark more confusing than helping and suggest to remove it:

```
(technically this is superfluous but clearer when made explicit)
```



---

Comment by fbissey created at 2019-02-07 08:15:06

Replying to [comment:15 jdemeyer]:
> `pyflakes` reports:
> {{{
> src/sage/env.py:37: redefinition of unused 'sys' from line 32
> src/sage/env.py:235: undefined name 'libdir'
> src/sage/env.py:235: undefined name 'libdir'
> }}}
> The latter is a genuine bug as far as I can see.

I am guessing Erik meant `libname` from the context.


---

Comment by jdemeyer created at 2019-02-07 08:48:28

Another detail: why this signature

```
def _get_shared_lib_filename(libname, *additional_libnames)
```

when all the arguments play the same role?

Wouldn't it be clearer to write it as

```
def _get_shared_lib_filename(*libnames)
```



---

Comment by embray created at 2019-02-07 18:00:43

Replying to [comment:18 jdemeyer]:
> Another detail: why this signature
> {{{
> def _get_shared_lib_filename(libname, *additional_libnames)
> }}}
> when all the arguments play the same role?
> 
> Wouldn't it be clearer to write it as
> {{{
> def _get_shared_lib_filename(*libnames)
> }}}

I pinged back and forth on that, but ultimately did it that way so that it would require at least one argument.  I suppose it could allow zero arguments and then just return None but why bother?


---

Comment by git created at 2019-02-07 18:06:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-02-07 18:07:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-02-07 18:10:13

Changing status from needs_work to needs_review.


---

Comment by embray created at 2019-02-07 18:10:13

Addressed comment:16 and obvious bugs from comment:15 (in the latter case, it previously worked on Cygwin but I did not test on Cygwin after the refactoring I did; I'm confident now that it's right-enough).

Happy to shuffle things around to different locations as well, though keep in mind everything in `sage.env` should work easily with minimal, if any, imports from other sub-packages in Sage (at least anything that does anything less trivial that define a few pure-Python classes and functions).
----
New commits:


---

Comment by dimpase created at 2019-02-08 12:08:05

an import is missing, it seems:


```
[sagelib-8.7.beta2] && sage-python23 -u setup.py --no-user-cfg build install
[sagelib-8.7.beta2] ************************************************************************
[sagelib-8.7.beta2] Traceback (most recent call last):
[sagelib-8.7.beta2]   File "setup.py", line 61, in <module>
[sagelib-8.7.beta2]     import sage.env
[sagelib-8.7.beta2]   File "/mnt/opt/Sage/sage-dev/src/sage/env.py", line 264, in <module>
[sagelib-8.7.beta2]     SINGULAR_SO = _get_shared_lib_filename('Singular', 'singular-Singular')
[sagelib-8.7.beta2]   File "/mnt/opt/Sage/sage-dev/src/sage/env.py", line 247, in _get_shared_lib_filename
[sagelib-8.7.beta2]     libdirs = [sysconfig.get_config_var('LIBDIR')]
[sagelib-8.7.beta2] NameError: global name 'sysconfig' is not defined
[sagelib-8.7.beta2] ************************************************************************
[sagelib-8.7.beta2] Error building the Sage library
```



---

Comment by dimpase created at 2019-02-08 12:08:05

Changing status from needs_review to needs_work.


---

Comment by embray created at 2019-02-08 12:22:47

That's weird--I thought an `import sysconfig` was already added in #27040, but apparently not?


---

Comment by git created at 2019-02-08 12:56:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-02-08 12:56:31

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2019-02-08 13:05:10

There is something weird going on with the commits... Why am I seeing `Updated [SageMath](SageMath) version to 8.7.beta2` in the list of commits on this ticket (when clicking on "commits" in the box at the top of this page)? Either it's something wrong with Trac or with this branch, but it would be good to clear that up.


---

Comment by jdemeyer created at 2019-02-08 13:05:10

Changing status from needs_review to needs_info.


---

Comment by embray created at 2019-02-08 13:11:58

I clearly must have screwed something up while rebasing, because it also says I'm the committer on that commit.  I suspect what I did was at some point I did a `git rebase -i` and selected too many commits.  Still surprising that it would modify some commits and set me as the committer even if I didn't change them at all.


---

Comment by git created at 2019-02-08 13:14:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-02-08 13:15:02

That's better.


---

Comment by embray created at 2019-02-08 13:15:02

Changing status from needs_info to needs_review.


---

Comment by dimpase created at 2019-02-08 20:53:27

ok, tests out well.


---

Comment by dimpase created at 2019-02-08 20:53:27

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-02-10 12:55:42

Resolution: fixed


---

Comment by embray created at 2019-02-21 10:46:17

Ugh, this is still completely broken on Cygwin.


---

Comment by @timokau created at 2019-04-06 14:23:11

This fails to find any libraries on nix, since they won't be in the same libdir as python. For that reason I'm already setting the `SINGULAR_SO` and `GAP_SO` env vars, but now this test fails anyways.

Thoughts on how best to resolve this? I'm not sure the function should even be tested (instead maybe test that `SINGULAR_SO` and `GAP_SO` have proper values after being assigned. If we really do want to test that function, maybe ad the `SINGULAR_SO` and `GAP_SO` locations to the `libdirs` list?


---

Comment by dimpase created at 2019-04-06 16:26:18

this seems to be duplucating in an ad hoc way what the system linker/loader knows. Is there a way to query the cache of ldconfig from Python? This would be a much more robust thing, for system libraries, IMHO.


---

Comment by @timokau created at 2019-04-07 13:17:18

Come to think of it, why do we need this at all? Isn't the functionality covered (better) by `find_library` in `src/sage/misc/compat.py`?


---

Comment by embray created at 2019-04-08 16:01:09

New ticket please.
