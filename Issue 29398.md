# Issue 29398: Singular: degneglex order differs from definition in Sage

Issue created by migration from https://trac.sagemath.org/ticket/29635

Original creator: @mwageringel

Original creation time: 2020-05-02 17:34:12

CC:  dimpase klee

Keywords: singular

Using a `degneglex` term order with the Singular backend gives different results than specified. For example, compare the monomials of degree 4 in increasing order in Sage (left) vs Singular (right):


```
sage: R = PolynomialRing(QQ, 'x,y,z', order='degneglex', implementation='generic')
sage: S = PolynomialRing(QQ, 'x,y,z', order='degneglex')
sage: L_R, L_S = [sorted([ring.monomial(*e) for e in IntegerVectors(4, 3)]) for ring in [R, S]]
sage: L_R == L_S  # should be True
False
sage: [[f.exponents()[0] for f in fs] for fs in zip(L_R, L_S)]  # Sage vs Singular (increasing order)
[[(4, 0, 0), (4, 0, 0)],
 [(3, 1, 0), (3, 1, 0)],
 [(3, 0, 1), (2, 2, 0)],
 [(2, 2, 0), (1, 3, 0)],
 [(2, 1, 1), (0, 4, 0)],
 [(2, 0, 2), (3, 0, 1)],
 [(1, 3, 0), (2, 1, 1)],
 [(1, 2, 1), (1, 2, 1)],
 [(1, 1, 2), (0, 3, 1)],
 [(1, 0, 3), (2, 0, 2)],
 [(0, 4, 0), (1, 1, 2)],
 [(0, 3, 1), (0, 2, 2)],
 [(0, 2, 2), (1, 0, 3)],
 [(0, 1, 3), (0, 1, 3)],
 [(0, 0, 4), (0, 0, 4)]]
```


Sage defines `degneglex` to compare by total degree first, and then by exponents from left to right, so the Singular ordering is wrong.


---

Comment by @mwageringel created at 2020-05-02 17:35:21

The corresponding order in Singular is defined as `(a(1:3), ls(3))`, which means it uses the [weight vector](https://www.singular.uni-kl.de/Manual/4-1-2/sing_956.htm#SEC1008) `1,1,1` to compare by degree and then it should use the [local ordering](https://www.singular.uni-kl.de/Manual/4-1-2/sing_952.htm#SEC1004) `ls`, which also compares left-to-right. This construction looks correct to me.

When using the `neglex`/`ls` ordering, the ordering of the degree 4 monomials is correct, so this looks like an upstream problem.


---

Comment by @mwageringel created at 2020-05-02 18:59:07

Actually, using the Singular pexpect interface, instead of libsingular, gives correct results:

```
sage: T = PolynomialRing(QQ, 'x,y,z', order=TermOrder('(a(1:3), ls(3))', force=True))
sage: L_T = sorted([singular(T.monomial(*e)) for e in IntegerVectors(4, 3)])
sage: [f.leadexp().sage() for f in L_T]
[(4, 0, 0),
 (3, 1, 0),
 (3, 0, 1),
 (2, 2, 0),
 (2, 1, 1),
 (2, 0, 2),
 (1, 3, 0),
 (1, 2, 1),
 (1, 1, 2),
 (1, 0, 3),
 (0, 4, 0),
 (0, 3, 1),
 (0, 2, 2),
 (0, 1, 3),
 (0, 0, 4)]
```

So the error must be somewhere between Sage and libsingular.

The libsingular implementation might be using this one:

```
sage: U = PolynomialRing(QQ, 'x,y,z', order=TermOrder('(a(1:3), rp(3))', force=True))
sage: L_U = sorted([singular(U.monomial(*e)) for e in IntegerVectors(4, 3)])
sage: [f.leadexp().sage() for f in L_U]
[(4, 0, 0),
 (3, 1, 0),
 (2, 2, 0),
 (1, 3, 0),
 (0, 4, 0),
 (3, 0, 1),
 (2, 1, 1),
 (1, 2, 1),
 (0, 3, 1),
 (2, 0, 2),
 (1, 1, 2),
 (0, 2, 2),
 (1, 0, 3),
 (0, 1, 3),
 (0, 0, 4)]
```



---

Comment by @mwageringel created at 2020-05-02 19:33:34

Ok, indeed that was the problem. I will push a branch soon.

With Sage's specification, `degneglex` and `degrevlex` are equivalent under reversal of variables.

The very very strange thing is I have an example where `degneglex` finishes a computation instantly (before and after this patch), but on the equivalent problem with variables reversed, `degrevlex` is extremely slow. This is why I got interested in this `degneglex` order in the first place.


---

Comment by nbruin created at 2020-05-02 20:17:29

You are probably aware of this: a "local" monomial ordering is not actually a monomial ordering in the sense of groebner bases on polynomial rings. You can use them to compute in local rings, but then you're computing in a local rings; not a polynomial ring.


---

Comment by @mwageringel created at 2020-05-02 20:25:30

Indeed, I found this a bit odd, too, but it is not just a local ordering, but a local ordering together with the weight vector `(1,1,1)`; see [extra weight vectors](https://www.singular.uni-kl.de/Manual/4-1-2/sing_956.htm#SEC1008). Thus, the comparison is done first by weighted degree, which turns this ordering into a well-ordering, as far as I understand.


---

Comment by @mwageringel created at 2020-05-02 21:24:28

Changing status from new to needs_review.


---

Comment by @mwageringel created at 2020-05-02 21:24:28

New commits:


---

Comment by git created at 2020-05-02 23:22:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mwageringel created at 2020-05-02 23:25:01

I have also fixed the conversion of `degneglex` orders in the Singular pexpect interface, which would otherwise have caused issues.


---

Comment by git created at 2020-05-03 11:38:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-05-27 00:18:31

I have a naive question on the maths behind this - what's being computed? That's not a Grobner basis, right?

I think Singular's docs are also quite unclear on this point, they don't provide any obvious references to what one gets if this order is selected.


---

Comment by @mwageringel created at 2020-05-27 14:04:14

Yes, it does compute Gröbner bases. The ordering `degneglex` as defined by Sage is equivalent to `degrevlex` up to permutation of the variables, namely by mapping `(x_1,…,x_n)` to `(x_n,…,x_1)`. This is what is checked in the doctest I added.

The weight vector `a(1,..,1)` in the ordering has the effect that monomials are first compared by weighted degree, in this case standard degree. Then, for monomials of the same degree, the ordering `ls` is used for the comparison.


---

Comment by dimpase created at 2020-05-27 22:16:47

I ask, as the link in comment:1 to Singular manual mentions K[x]_(x), but without saying why.


---

Comment by @mwageringel created at 2020-05-28 18:32:41

Replying to [comment:13 dimpase]:
> I ask, as the link in comment:1 to Singular manual mentions K[x]_(x), but without saying why.

Yes, when using a local term ordering, Singular computes in the localization. I am not very familiar with the local orderings in Singular myself. However, for the `degneglex` ordering, you can test that Singular indeed understands that it is a global ordering by checking the `OrdSgn`.

```
sage: %%cython
....: from sage.all import *
....: from sage.rings.polynomial.multi_polynomial_libsingular cimport MPolynomialRing_libsingular
....: from sage.libs.singular.decl cimport ring
....: R = PolynomialRing(QQ, 'x', 3, order='degneglex')
....: cdef ring* S = (<MPolynomialRing_libsingular> R)._ring
....: print(S.OrdSgn)
....:
1        # would be -1 for local orderings
```



---

Comment by dimpase created at 2020-06-03 22:44:52

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-06-03 22:44:52

OK, good.


---

Comment by chapoton created at 2020-06-09 07:48:54

This may be related to the question on ask

https://ask.sagemath.org/question/51851/toric-ideal-of-point-configuration-yielding-whole-ring/


---

Comment by @mwageringel created at 2020-06-09 08:30:43

Replying to [comment:16 chapoton]:
> This may be related to the question on ask
> 
> https://ask.sagemath.org/question/51851/toric-ideal-of-point-configuration-yielding-whole-ring/
> 

Hm, I think this is not related. `ToricIdeal` does not use a `degneglex` term ordering by default, and this ticket does not seem to fix that problem.


---

Comment by dimpase created at 2020-06-10 17:02:33

but do see #29832 - where I conjecture what goes wrong.


---

Comment by vbraun created at 2020-06-21 22:37:03

Resolution: fixed
