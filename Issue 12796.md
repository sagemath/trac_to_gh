# Issue 12796: round of symbolic expression (precision issue due to RR)

archive/issues_012796.json:
```json
{
    "body": "Assignee: burcin\n\nCC:  kcrisman mjo\n\nKeywords: round symbolic precision RR beginner\n\nWe have\n\n```\nsage: u = sqrt(43203735824841025516773866131535024) #add one digit\nsage: floor(u)\n207855083711803944\nsage: round(u) # ?? smaller than floor(u)! No warning message...\n207855083711803936\nsage: r = round(u)\nsage: ceil(u)\n207855083711803945\n```\n\nNumbers with one digit less work\n\n```\nsage: t=sqrt(4320373582484102551677386613153502)\nsage: floor(t)\n65729548777426599\nsage: round(t) #everything as expected, floor \u2264 round \u2264 ceil\n65729548777426600\nsage: ceil(t)\n65729548777426600\n```\n\nThe docstring/source code of the symbolic round mentions that behavior\n\n```\nDefinition:     u.round(self)\nSource:\n    def round(self):\n        \"\"\"\n        Round this expression to the nearest integer.\n\n        This method evaluates an expression in ``RR`` first and rounds\n        the result. This may lead to misleading results.\n\n        EXAMPLES::\n\n            sage: t = sqrt(Integer('1'*1000)).round(); t\n            3333333333333333056287287783757109595393...\n\n         This is off by a huge margin::\n\n            sage: (Integer('1'*1000) - t^2).ndigits()\n            984\n        \"\"\"\n        #FIXME: can we do better?\n```\n\n\nThis was reported on [sage-support](https://groups.google.com/d/topic/sage-support/s-A22yzFnbY/discussion) by Lorenzo. I created a ticket here, since I didn't find one for that behavior (but maybe I missed it...).\n\nIssue created by migration from https://trac.sagemath.org/ticket/12968\n\n",
    "created_at": "2012-05-18T08:30:06Z",
    "labels": [
        "symbolics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.1",
    "title": "round of symbolic expression (precision issue due to RR)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12796",
    "user": "dkrenn"
}
```
Assignee: burcin

CC:  kcrisman mjo

Keywords: round symbolic precision RR beginner

We have

```
sage: u = sqrt(43203735824841025516773866131535024) #add one digit
sage: floor(u)
207855083711803944
sage: round(u) # ?? smaller than floor(u)! No warning message...
207855083711803936
sage: r = round(u)
sage: ceil(u)
207855083711803945
```

Numbers with one digit less work

```
sage: t=sqrt(4320373582484102551677386613153502)
sage: floor(t)
65729548777426599
sage: round(t) #everything as expected, floor ≤ round ≤ ceil
65729548777426600
sage: ceil(t)
65729548777426600
```

The docstring/source code of the symbolic round mentions that behavior

```
Definition:     u.round(self)
Source:
    def round(self):
        """
        Round this expression to the nearest integer.

        This method evaluates an expression in ``RR`` first and rounds
        the result. This may lead to misleading results.

        EXAMPLES::

            sage: t = sqrt(Integer('1'*1000)).round(); t
            3333333333333333056287287783757109595393...

         This is off by a huge margin::

            sage: (Integer('1'*1000) - t^2).ndigits()
            984
        """
        #FIXME: can we do better?
```


This was reported on [sage-support](https://groups.google.com/d/topic/sage-support/s-A22yzFnbY/discussion) by Lorenzo. I created a ticket here, since I didn't find one for that behavior (but maybe I missed it...).

Issue created by migration from https://trac.sagemath.org/ticket/12968





---

archive/issue_comments_153624.json:
```json
{
    "body": "This is the same problem as in #9627 and #9953. We should change those tickets to mention `round()` and close this one. Perhaps `floor()` and `ceil()` can be mentioned there as well. The implementation of `floor.__call__()` in `sage/functions/other.py` might help here.",
    "created_at": "2012-05-18T09:22:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12796#issuecomment-153624",
    "user": "burcin"
}
```

This is the same problem as in #9627 and #9953. We should change those tickets to mention `round()` and close this one. Perhaps `floor()` and `ceil()` can be mentioned there as well. The implementation of `floor.__call__()` in `sage/functions/other.py` might help here.



---

archive/issue_comments_153625.json:
```json
{
    "body": "It might be best to do something along the lines of:\n\n\n```\ndef round(self):\n    return floor(self+1/2)\n```\n\n\nbut there's the possibility that that addition causes problems with inexact arithmetic.",
    "created_at": "2012-05-18T19:04:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12796#issuecomment-153625",
    "user": "mhansen"
}
```

It might be best to do something along the lines of:


```
def round(self):
    return floor(self+1/2)
```


but there's the possibility that that addition causes problems with inexact arithmetic.



---

archive/issue_comments_153626.json:
```json
{
    "body": "I've put a patch up which should fix these issues.",
    "created_at": "2012-05-18T20:18:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12796#issuecomment-153626",
    "user": "mhansen"
}
```

I've put a patch up which should fix these issues.



---

archive/issue_comments_153627.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-05-18T20:18:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12796#issuecomment-153627",
    "user": "mhansen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_153628.json:
```json
{
    "body": "Thanks Mike! This looks great.\n\nJust by reading the code, I have one minor problem: Isn't the test `self > 0` too costly if the expression still contains variables? Maybe we should convert to `RR` first and do the comparison there, similar to the way Gonzalo handled this in #9627. This would also raise an error earlier instead of going through maxima for the comparison and waiting for floor or ceil to complain.",
    "created_at": "2012-05-19T07:17:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12796#issuecomment-153628",
    "user": "burcin"
}
```

Thanks Mike! This looks great.

Just by reading the code, I have one minor problem: Isn't the test `self > 0` too costly if the expression still contains variables? Maybe we should convert to `RR` first and do the comparison there, similar to the way Gonzalo handled this in #9627. This would also raise an error earlier instead of going through maxima for the comparison and waiting for floor or ceil to complain.



---

archive/issue_comments_153629.json:
```json
{
    "body": "Replying to [comment:6 burcin]:\n> Just by reading the code, I have one minor problem: Isn't the test `self > 0` too costly if the expression still contains variables? Maybe we should convert to `RR` first and do the comparison there\n\nMaybe you could try converting to RIF first instead and then do the full test if that interval contains zero.  Checking to see if there are variables should also be really quick.  I'll put up a patch that does this.",
    "created_at": "2012-05-19T16:52:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12796#issuecomment-153629",
    "user": "mhansen"
}
```

Replying to [comment:6 burcin]:
> Just by reading the code, I have one minor problem: Isn't the test `self > 0` too costly if the expression still contains variables? Maybe we should convert to `RR` first and do the comparison there

Maybe you could try converting to RIF first instead and then do the full test if that interval contains zero.  Checking to see if there are variables should also be really quick.  I'll put up a patch that does this.



---

archive/issue_comments_153630.json:
```json
{
    "body": "I've posted a new patch which should be better.",
    "created_at": "2012-05-19T17:10:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12796#issuecomment-153630",
    "user": "mhansen"
}
```

I've posted a new patch which should be better.



---

archive/issue_comments_153631.json:
```json
{
    "body": "Looks good to me.\n\nPatchbot, apply attachment:trac_12968.patch.",
    "created_at": "2012-05-22T22:38:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12796#issuecomment-153631",
    "user": "burcin"
}
```

Looks good to me.

Patchbot, apply attachment:trac_12968.patch.



---

archive/issue_comments_153632.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-05-22T22:38:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12796#issuecomment-153632",
    "user": "burcin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_153633.json:
```json
{
    "body": "This causes a doctest failure (see also the Patchbot):\n\n```\nsage -t  -force_lib devel/sage/sage/rings/polynomial/polynomial_rational_flint.pyx\n**********************************************************************\nFile \"/padic/scratch/jdemeyer/merger/sage-5.1.beta2/devel/sage-main/sage/rings/polynomial/polynomial_rational_flint.pyx\", line 596:\n    sage: f.reverse(I)\nExpected:\n    Traceback (most recent call last):\n    ...\n    TypeError: can't convert complex to int; use int(abs(z))\nGot:\n    Traceback (most recent call last):\n      File \"/padic/scratch/jdemeyer/merger/sage-5.1.beta2/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/padic/scratch/jdemeyer/merger/sage-5.1.beta2/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/padic/scratch/jdemeyer/merger/sage-5.1.beta2/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_17[19]>\", line 1, in <module>\n        f.reverse(I)###line 596:\n    sage: f.reverse(I)\n      File \"polynomial_rational_flint.pyx\", line 608, in sage.rings.polynomial.polynomial_rational_flint.Polynomial_rational_flint.reverse\n (sage/rings/polynomial/polynomial_rational_flint.cpp:7922)\n        len = <unsigned long> n\n      File \"expression.pyx\", line 751, in sage.symbolic.expression.Expression.__int__ (sage/symbolic/expression.cpp:4932)\n    ValueError: cannot convert I to int\n**********************************************************************\n```\n",
    "created_at": "2012-05-27T16:26:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12796#issuecomment-153633",
    "user": "jdemeyer"
}
```

This causes a doctest failure (see also the Patchbot):

```
sage -t  -force_lib devel/sage/sage/rings/polynomial/polynomial_rational_flint.pyx
**********************************************************************
File "/padic/scratch/jdemeyer/merger/sage-5.1.beta2/devel/sage-main/sage/rings/polynomial/polynomial_rational_flint.pyx", line 596:
    sage: f.reverse(I)
Expected:
    Traceback (most recent call last):
    ...
    TypeError: can't convert complex to int; use int(abs(z))
Got:
    Traceback (most recent call last):
      File "/padic/scratch/jdemeyer/merger/sage-5.1.beta2/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/padic/scratch/jdemeyer/merger/sage-5.1.beta2/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/padic/scratch/jdemeyer/merger/sage-5.1.beta2/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_17[19]>", line 1, in <module>
        f.reverse(I)###line 596:
    sage: f.reverse(I)
      File "polynomial_rational_flint.pyx", line 608, in sage.rings.polynomial.polynomial_rational_flint.Polynomial_rational_flint.reverse
 (sage/rings/polynomial/polynomial_rational_flint.cpp:7922)
        len = <unsigned long> n
      File "expression.pyx", line 751, in sage.symbolic.expression.Expression.__int__ (sage/symbolic/expression.cpp:4932)
    ValueError: cannot convert I to int
**********************************************************************
```




---

archive/issue_comments_153634.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-05-27T16:26:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12796#issuecomment-153634",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_153635.json:
```json
{
    "body": "Attachment [trac_12968.patch](tarball://root/attachments/some-uuid/ticket12968/trac_12968.patch) by mhansen created at 2012-05-28 04:44:19",
    "created_at": "2012-05-28T04:44:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12796#issuecomment-153635",
    "user": "mhansen"
}
```

Attachment [trac_12968.patch](tarball://root/attachments/some-uuid/ticket12968/trac_12968.patch) by mhansen created at 2012-05-28 04:44:19



---

archive/issue_comments_153636.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-05-28T04:45:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12796#issuecomment-153636",
    "user": "mhansen"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_153637.json:
```json
{
    "body": "Changing keywords from \"round symbolic precision RR beginner\" to \"round symbolic precision RR beginner, sd40.5\".",
    "created_at": "2012-05-28T04:45:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12796#issuecomment-153637",
    "user": "mhansen"
}
```

Changing keywords from "round symbolic precision RR beginner" to "round symbolic precision RR beginner, sd40.5".



---

archive/issue_comments_153638.json:
```json
{
    "body": "I've posted a new patch which fixes this issue.  If someone could look over it, it's just a matter of changing the doctest.",
    "created_at": "2012-05-28T04:45:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12796#issuecomment-153638",
    "user": "mhansen"
}
```

I've posted a new patch which fixes this issue.  If someone could look over it, it's just a matter of changing the doctest.



---

archive/issue_comments_153639.json:
```json
{
    "body": "Yes, this is clearly the same behavior for the error.  This test passes now, as do many other relevant ones.",
    "created_at": "2012-05-28T05:06:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12796#issuecomment-153639",
    "user": "kcrisman"
}
```

Yes, this is clearly the same behavior for the error.  This test passes now, as do many other relevant ones.



---

archive/issue_comments_153640.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-05-28T05:06:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12796#issuecomment-153640",
    "user": "kcrisman"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_153641.json:
```json
{
    "body": "Just before we put this to bed, I noticed a quirk involving negative numbers.  We typically truncate toward zero, like Python:\n\n\n```\n\nPython 2.7.2 (v2.7.2:8527427914a2, Jun 11 2011, 15:22:34) \n[GCC 4.2.1 (Apple Inc. build 5666) (dot 3)] on darwin\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> from fractions import Fraction\n>>> int(-1)\n-1\n>>> int(-0.99)\n0\n>>> int(Fraction(-99, 100))\n0\n```\n\n\nBut our int-ing is a little more sensitive:\n\n\n```\n\nsage: int(-1)\n-1\nsage: int(-0.99)\n0\nsage: int(SR(-99/100))\n0\nsage: -0.99 == -99/100\nTrue\nsage: int(-99/100) # ??\n-1\n\n```\n",
    "created_at": "2012-05-28T15:06:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12796#issuecomment-153641",
    "user": "dsm"
}
```

Just before we put this to bed, I noticed a quirk involving negative numbers.  We typically truncate toward zero, like Python:


```

Python 2.7.2 (v2.7.2:8527427914a2, Jun 11 2011, 15:22:34) 
[GCC 4.2.1 (Apple Inc. build 5666) (dot 3)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> from fractions import Fraction
>>> int(-1)
-1
>>> int(-0.99)
0
>>> int(Fraction(-99, 100))
0
```


But our int-ing is a little more sensitive:


```

sage: int(-1)
-1
sage: int(-0.99)
0
sage: int(SR(-99/100))
0
sage: -0.99 == -99/100
True
sage: int(-99/100) # ??
-1

```




---

archive/issue_comments_153642.json:
```json
{
    "body": "This is due to the default rounding mode for rationals, which is independent of this code.  We could make a ticket for changing that,",
    "created_at": "2012-05-28T17:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12796#issuecomment-153642",
    "user": "mhansen"
}
```

This is due to the default rounding mode for rationals, which is independent of this code.  We could make a ticket for changing that,



---

archive/issue_comments_153643.json:
```json
{
    "body": "Yeah, since the behaviour precedes this patch and this patch makes things better, I left it as positive review.  If it were a one-line change (i.e. this behaviour wasn't possibly deliberate)  we could have done it here, but instead I'll open a new ticket.",
    "created_at": "2012-05-28T17:57:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12796#issuecomment-153643",
    "user": "dsm"
}
```

Yeah, since the behaviour precedes this patch and this patch makes things better, I left it as positive review.  If it were a one-line change (i.e. this behaviour wasn't possibly deliberate)  we could have done it here, but instead I'll open a new ticket.



---

archive/issue_comments_153644.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-06-18T10:25:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12796",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12796#issuecomment-153644",
    "user": "jdemeyer"
}
```

Resolution: fixed
