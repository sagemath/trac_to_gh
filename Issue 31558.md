# Issue 31558: faster conversion between power series and polynomials

archive/issues_031558.json:
```json
{
    "body": "CC:  vdelecroix\n\nThis ticket adds a method `homogeneous_components` for multivariate polynomials, which is then used to improve the performance of conversions from multivariate power series to polynomials and vice versa.\n\nThese conversions are called frequently in some operations with power series, so this can be a bottleneck. The implementation avoids calls to `subs()` which are slow.\n\nResults:\n\n```\nset_random_seed(0)\nR.<x,y,z> = QQ[[]]\nf = R.random_element(20, 40)\n%timeit f.polynomial()  # calls _send_to_fg()\np = f.polynomial()\n%timeit R(p)  # calls _send_to_bg()\n```\n\n\nWith the above tests, I get about a `2\u00d7` speedup in the first and more than a 10\u00d7 speedup in the second case:\n\n```\n# before\n41.9 \u00b5s \u00b1 837 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n1.64 ms \u00b1 10.9 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n\n# after\n17.6 \u00b5s \u00b1 116 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n130 \u00b5s \u00b1 484 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n```\n\n\nIf I replace `f` by a smaller element `f = R.random_element(3, 5)`, I get a 7\u00d7 speedup for the first and more than a 2\u00d7 speedup for the second test:\n\n```\n# before\n20.5 \u00b5s \u00b1 115 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n82.8 \u00b5s \u00b1 429 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n\n# after\n2.77 \u00b5s \u00b1 41 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n31.3 \u00b5s \u00b1 102 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n```\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/31795\n\n",
    "created_at": "2021-05-08T13:45:15Z",
    "labels": [
        "performance",
        "major",
        "enhancement"
    ],
    "title": "faster conversion between power series and polynomials",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31558",
    "user": "@mwageringel"
}
```
CC:  vdelecroix

This ticket adds a method `homogeneous_components` for multivariate polynomials, which is then used to improve the performance of conversions from multivariate power series to polynomials and vice versa.

These conversions are called frequently in some operations with power series, so this can be a bottleneck. The implementation avoids calls to `subs()` which are slow.

Results:

```
set_random_seed(0)
R.<x,y,z> = QQ[[]]
f = R.random_element(20, 40)
%timeit f.polynomial()  # calls _send_to_fg()
p = f.polynomial()
%timeit R(p)  # calls _send_to_bg()
```


With the above tests, I get about a `2×` speedup in the first and more than a 10× speedup in the second case:

```
# before
41.9 µs ± 837 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
1.64 ms ± 10.9 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)

# after
17.6 µs ± 116 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
130 µs ± 484 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
```


If I replace `f` by a smaller element `f = R.random_element(3, 5)`, I get a 7× speedup for the first and more than a 2× speedup for the second test:

```
# before
20.5 µs ± 115 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
82.8 µs ± 429 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)

# after
2.77 µs ± 41 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
31.3 µs ± 102 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
```



Issue created by migration from https://trac.sagemath.org/ticket/31795





---

archive/issue_comments_450987.json:
```json
{
    "body": "There is more performance to be gained with power series (multiplication, in particular), but this ticket is a first easy step.\n----\nNew commits:",
    "created_at": "2021-05-08T13:57:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31558",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31558#issuecomment-450987",
    "user": "@mwageringel"
}
```

There is more performance to be gained with power series (multiplication, in particular), but this ticket is a first easy step.
----
New commits:



---

archive/issue_comments_450988.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-05-08T13:57:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31558",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31558#issuecomment-450988",
    "user": "@mwageringel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_450989.json:
```json
{
    "body": "Your construction for computing homogeneous components looks complicated. What do you think about the branch [u/tmonteil/31795](https://git.sagemath.org/sage.git/log/?h=u/tmonteil/31795) ?",
    "created_at": "2021-05-18T15:03:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31558",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31558#issuecomment-450989",
    "user": "tmonteil"
}
```

Your construction for computing homogeneous components looks complicated. What do you think about the branch [u/tmonteil/31795](https://git.sagemath.org/sage.git/log/?h=u/tmonteil/31795) ?



---

archive/issue_comments_450990.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2021-05-18T15:03:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31558",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31558#issuecomment-450990",
    "user": "tmonteil"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_450991.json:
```json
{
    "body": "Replying to [comment:2 tmonteil]:\n> Your construction for computing homogeneous components looks complicated. What do you think about the branch [u/tmonteil/31795](https://git.sagemath.org/sage.git/log/?h=u/tmonteil/31795) ?\n\nIt adds two nice commits:\n\n- [dff03f3f: simplify the code of homogeneous_components](https://git.sagemath.org/sage.git/commit/?h=u/tmonteil/31795&id=dff03f3f3bf75481f5ad174b0a6e3a645defbcf8)\n- [aafd615c: multivariate polynomial rings should be callable with no argument](https://git.sagemath.org/sage.git/commit/?h=u/tmonteil/31795&id=aafd615c13d45305339b99fefa18572f50986e0c)",
    "created_at": "2021-05-18T17:19:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31558",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31558#issuecomment-450991",
    "user": "slelievre"
}
```

Replying to [comment:2 tmonteil]:
> Your construction for computing homogeneous components looks complicated. What do you think about the branch [u/tmonteil/31795](https://git.sagemath.org/sage.git/log/?h=u/tmonteil/31795) ?

It adds two nice commits:

- [dff03f3f: simplify the code of homogeneous_components](https://git.sagemath.org/sage.git/commit/?h=u/tmonteil/31795&id=dff03f3f3bf75481f5ad174b0a6e3a645defbcf8)
- [aafd615c: multivariate polynomial rings should be callable with no argument](https://git.sagemath.org/sage.git/commit/?h=u/tmonteil/31795&id=aafd615c13d45305339b99fefa18572f50986e0c)



---

archive/issue_comments_450992.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-18T19:05:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31558",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31558#issuecomment-450992",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_450993.json:
```json
{
    "body": "Replying to [comment:2 tmonteil]:\n> Your construction for computing homogeneous components looks complicated. What do you think about the branch [u/tmonteil/31795](https://git.sagemath.org/sage.git/log/?h=u/tmonteil/31795) ?\n\nThis is much simpler indeed and about as fast, at least for libsingular polynomials. Thank you.\n\nI have slightly changed the default factory to use the `.zero()` method, which is about 10% faster in my testing. Otherwise, I am happy with your changes.",
    "created_at": "2021-05-18T19:06:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31558",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31558#issuecomment-450993",
    "user": "@mwageringel"
}
```

Replying to [comment:2 tmonteil]:
> Your construction for computing homogeneous components looks complicated. What do you think about the branch [u/tmonteil/31795](https://git.sagemath.org/sage.git/log/?h=u/tmonteil/31795) ?

This is much simpler indeed and about as fast, at least for libsingular polynomials. Thank you.

I have slightly changed the default factory to use the `.zero()` method, which is about 10% faster in my testing. Otherwise, I am happy with your changes.



---

archive/issue_comments_450994.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2021-05-18T19:06:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31558",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31558#issuecomment-450994",
    "user": "@mwageringel"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_450995.json:
```json
{
    "body": "If you want to squeeze some more speed out, I would do\n\n```python\ncdef ETuple m\nd = defaultdict(dict)\nfrom collections import defaultdict\nfor m, c in self.iterator_exp_coeff():\n   d[m.unweighted_degree()][m] = c\nreturn {k: self._parent(d[k]) for k in d}\n```\n\nThis way you avoid creating more transient objects as `+=` is not truly in-place. The corresponding parent constructor will be faster at handling the group. As a proof-of-concept:\n\n```\nsage: R.<a,b,c> = PolynomialRing(QQ, 3, order='lex')\nsage: def test1(p):\n....:     return R.sum(m*c for m,c in p)\nsage: def test2(p): \n....:     d = {m: c for m, c in p.iterator_exp_coeff()} \n....:     return R(d)\n\nsage: %timeit test1(p)\n7.78 \u00b5s \u00b1 20 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit test2(p)\n7.09 \u00b5s \u00b1 38.4 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n",
    "created_at": "2021-05-19T05:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31558",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31558#issuecomment-450995",
    "user": "tscrim"
}
```

If you want to squeeze some more speed out, I would do

```python
cdef ETuple m
d = defaultdict(dict)
from collections import defaultdict
for m, c in self.iterator_exp_coeff():
   d[m.unweighted_degree()][m] = c
return {k: self._parent(d[k]) for k in d}
```

This way you avoid creating more transient objects as `+=` is not truly in-place. The corresponding parent constructor will be faster at handling the group. As a proof-of-concept:

```
sage: R.<a,b,c> = PolynomialRing(QQ, 3, order='lex')
sage: def test1(p):
....:     return R.sum(m*c for m,c in p)
sage: def test2(p): 
....:     d = {m: c for m, c in p.iterator_exp_coeff()} 
....:     return R(d)

sage: %timeit test1(p)
7.78 µs ± 20 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit test2(p)
7.09 µs ± 38.4 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```




---

archive/issue_comments_450996.json:
```json
{
    "body": "What I wrote in comment:6 won't work in the graded case. Here is a modified version:\n\n```python\nd = defaultdict(dict)\nfrom collections import defaultdict\nfor c, m in self:\n   d[m.degree()][m.exponents()[0]] = c\nreturn {k: self._parent(d[k]) for k in d}\n```\n\n\nTimings:\n\n```\nsage: def test2(p):\n....:     d = {m.exponents()[0]: c for c,m in p}\n....:     return R(d)\n\nsage: %timeit test1(p)\n7.91 \u00b5s \u00b1 168 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\nsage: %timeit test2(p)\n9.75 \u00b5s \u00b1 73.7 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\nHowever, if we change rings:\n\n```\nsage: S.<a,b,c> = PolynomialRing(ZZ, order=TermOrder('wdegrevlex', (1,2,3)))\nsage: p = a + b + c\nsage: %timeit test1(p)\n27.7 \u00b5s \u00b1 710 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\nsage: %timeit test2(p)\n9.92 \u00b5s \u00b1 153 ns per loop (mean \u00b1 std. dev. of 7 runs, 100000 loops each)\n```\n\n\nBased off this, what I would propose would be this:\n\n```python\ncdef ETuple m\nd = defaultdict(dict)\nfrom collections import defaultdict\nif self._parent.__term_order._weights:\n    for c, mon in self:\n        d[mon.degree()][mon.exponents()[0]] = c\n    return {k: self._parent(d[k]) for k in d}\n# Otherwise it is unweighted\nfor m, c in self.iterator_exp_coeff():\n   d[m.unweighted_degree()][m] = c\nreturn {k: self._parent(d[k]) for k in d}\n```\n",
    "created_at": "2021-05-19T06:12:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31558",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31558#issuecomment-450996",
    "user": "tscrim"
}
```

What I wrote in comment:6 won't work in the graded case. Here is a modified version:

```python
d = defaultdict(dict)
from collections import defaultdict
for c, m in self:
   d[m.degree()][m.exponents()[0]] = c
return {k: self._parent(d[k]) for k in d}
```


Timings:

```
sage: def test2(p):
....:     d = {m.exponents()[0]: c for c,m in p}
....:     return R(d)

sage: %timeit test1(p)
7.91 µs ± 168 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit test2(p)
9.75 µs ± 73.7 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```

However, if we change rings:

```
sage: S.<a,b,c> = PolynomialRing(ZZ, order=TermOrder('wdegrevlex', (1,2,3)))
sage: p = a + b + c
sage: %timeit test1(p)
27.7 µs ± 710 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit test2(p)
9.92 µs ± 153 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```


Based off this, what I would propose would be this:

```python
cdef ETuple m
d = defaultdict(dict)
from collections import defaultdict
if self._parent.__term_order._weights:
    for c, mon in self:
        d[mon.degree()][mon.exponents()[0]] = c
    return {k: self._parent(d[k]) for k in d}
# Otherwise it is unweighted
for m, c in self.iterator_exp_coeff():
   d[m.unweighted_degree()][m] = c
return {k: self._parent(d[k]) for k in d}
```




---

archive/issue_comments_450997.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-20T18:06:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31558",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31558#issuecomment-450997",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_450998.json:
```json
{
    "body": "Replying to [comment:7 tscrim]:\n> Based off this, what I would propose would be this:\n> <...>\n\nThanks. I have been able to replicate your timings and have updated the branch accordingly.",
    "created_at": "2021-05-20T18:10:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31558",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31558#issuecomment-450998",
    "user": "@mwageringel"
}
```

Replying to [comment:7 tscrim]:
> Based off this, what I would propose would be this:
> <...>

Thanks. I have been able to replicate your timings and have updated the branch accordingly.



---

archive/issue_comments_450999.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-05-23T05:27:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31558",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31558#issuecomment-450999",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_451000.json:
```json
{
    "body": "There might be some extra speed that can be worked out by providing a specialized version of `homogeneous_components` for libsingular polynomials. Although something about blood and stones comes to mind. So this is good enough as a first implementation. Thank you.",
    "created_at": "2021-05-23T05:27:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31558",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31558#issuecomment-451000",
    "user": "tscrim"
}
```

There might be some extra speed that can be worked out by providing a specialized version of `homogeneous_components` for libsingular polynomials. Although something about blood and stones comes to mind. So this is good enough as a first implementation. Thank you.



---

archive/issue_comments_451001.json:
```json
{
    "body": "Replying to [comment:10 tscrim]:\n> There might be some extra speed that can be worked out by providing a specialized version of `homogeneous_components` for libsingular polynomials.\n\nYes, for sure. For now, I think it is more worthwhile to look into the performance of multiplication of power series next (there are two problems: the product does not take advantage of truncation, and it is computed using Karatsuba (I think) which is not a good choice considering that power series are represented as univariate polynomials over a multivariate base ring).\n\nThanks for the review.",
    "created_at": "2021-05-23T13:19:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31558",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31558#issuecomment-451001",
    "user": "@mwageringel"
}
```

Replying to [comment:10 tscrim]:
> There might be some extra speed that can be worked out by providing a specialized version of `homogeneous_components` for libsingular polynomials.

Yes, for sure. For now, I think it is more worthwhile to look into the performance of multiplication of power series next (there are two problems: the product does not take advantage of truncation, and it is computed using Karatsuba (I think) which is not a good choice considering that power series are represented as univariate polynomials over a multivariate base ring).

Thanks for the review.



---

archive/issue_comments_451002.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-06-19T20:57:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31558",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31558#issuecomment-451002",
    "user": "vbraun"
}
```

Resolution: fixed
