# Issue 24007: Fast check for C long

archive/issues_024007.json:
```json
{
    "body": "Implement a fast variant of `pyobject_to_long`, which could be used to replace checks of the form `isinstance(x, int)`. This will help porting to Python 3 without losing too much performance.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24244\n\n",
    "created_at": "2017-11-19T19:03:19Z",
    "labels": [
        "component: cython"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Fast check for C long",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24007",
    "user": "https://github.com/jdemeyer"
}
```
Implement a fast variant of `pyobject_to_long`, which could be used to replace checks of the form `isinstance(x, int)`. This will help porting to Python 3 without losing too much performance.

Issue created by migration from https://trac.sagemath.org/ticket/24244





---

archive/issue_comments_336086.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-20T09:40:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336086",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_336087.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-20T10:35:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336087",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_336088.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-11-20T10:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336088",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_336089.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-11-20T16:24:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336089",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_336090.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-20T18:32:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336090",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_336091.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-11-20T18:56:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336091",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_336092.json:
```json
{
    "body": "I think it would be better if `integer_check_long` and `integer_check_long_py` returned the error and `0` if it was completely successful. Then `pyobject_to_long` would then interpret the error using the `enum` and do the correct Python error raising. I feel like you are basically doing this, but in a roundabout way by passing `err`.",
    "created_at": "2017-11-20T23:46:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336092",
    "user": "https://github.com/tscrim"
}
```

I think it would be better if `integer_check_long` and `integer_check_long_py` returned the error and `0` if it was completely successful. Then `pyobject_to_long` would then interpret the error using the `enum` and do the correct Python error raising. I feel like you are basically doing this, but in a roundabout way by passing `err`.



---

archive/issue_comments_336093.json:
```json
{
    "body": "Also, in #24248, you do not even use the return `bint` of `integer_check_long_py`.",
    "created_at": "2017-11-20T23:47:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336093",
    "user": "https://github.com/tscrim"
}
```

Also, in #24248, you do not even use the return `bint` of `integer_check_long_py`.



---

archive/issue_comments_336094.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-11-21T09:21:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336094",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_336095.json:
```json
{
    "body": "Use case 2 could just become:\n\n```\nif integer_check_long(x, &value) == 0:\n    # Conversion successful, use value\n```\n\nwhich feels much more natural to me.\n\nHowever, I agree that use case 1 is a bit more of a hassle because you could not subsequently assign the error message (this wouldn't be a problem in, e.g., C because of the looser syntax rules). Although you can get around this by expanding out the `elif` as an `else-if` (but it looks fugly). Do you have a specific case where this does come up?",
    "created_at": "2017-11-22T05:05:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336095",
    "user": "https://github.com/tscrim"
}
```

Use case 2 could just become:

```
if integer_check_long(x, &value) == 0:
    # Conversion successful, use value
```

which feels much more natural to me.

However, I agree that use case 1 is a bit more of a hassle because you could not subsequently assign the error message (this wouldn't be a problem in, e.g., C because of the looser syntax rules). Although you can get around this by expanding out the `elif` as an `else-if` (but it looks fugly). Do you have a specific case where this does come up?



---

archive/issue_comments_336096.json:
```json
{
    "body": "Replying to [comment:13 tscrim]:\n> Use case 2 could just become:\n> {{{\n> if integer_check_long(x, &value) == 0:\n>     # Conversion successful, use value\n> }}}\n> which feels much more natural to me.\n\nSure, I can simplify use case 1 and use case 2 individually. But I see no way to simplify things in such a way that both use cases still work. Alternatively, I could simply add another layer for use case 2 and make a new function\n> {{{\n> if integer_check_long_no_overflow(x, &value):\n>     # Conversion successful, use value\n> }}}\n\nFinally, let me stress that this complexity shouldn't affect performance since we are dealing with `inline` functions and compilers are good at optimization.",
    "created_at": "2017-11-22T07:56:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336096",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:13 tscrim]:
> Use case 2 could just become:
> {{{
> if integer_check_long(x, &value) == 0:
>     # Conversion successful, use value
> }}}
> which feels much more natural to me.

Sure, I can simplify use case 1 and use case 2 individually. But I see no way to simplify things in such a way that both use cases still work. Alternatively, I could simply add another layer for use case 2 and make a new function
> {{{
> if integer_check_long_no_overflow(x, &value):
>     # Conversion successful, use value
> }}}

Finally, let me stress that this complexity shouldn't affect performance since we are dealing with `inline` functions and compilers are good at optimization.



---

archive/issue_comments_336097.json:
```json
{
    "body": "Replying to [comment:13 tscrim]:\n> Do you have a specific case where this does come up?\n\nI don't know exactly what you mean, but you can look at my work in progress at #24247. There are various calls to `integer_check_long(_py)` there.",
    "created_at": "2017-11-22T08:09:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336097",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:13 tscrim]:
> Do you have a specific case where this does come up?

I don't know exactly what you mean, but you can look at my work in progress at #24247. There are various calls to `integer_check_long(_py)` there.



---

archive/issue_comments_336098.json:
```json
{
    "body": "Let me know what you would suggest to do with this ticket.",
    "created_at": "2017-11-22T08:25:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336098",
    "user": "https://github.com/jdemeyer"
}
```

Let me know what you would suggest to do with this ticket.



---

archive/issue_comments_336099.json:
```json
{
    "body": "Replying to [comment:15 jdemeyer]:\n> Replying to [comment:13 tscrim]:\n> > Do you have a specific case where this does come up?\n> \n> I don't know exactly what you mean, but you can look at my work in progress at #24247. There are various calls to `integer_check_long(_py)` there.\n\nDo you have a place on a future ticket where use case 1 applies? I see use case 2 on #24247 and this one:\n\n```python\n            if integer_check_long_py(right, &value, &err):\n                if not err:\n                    return (<Element>left)._pow_long(value)\n                else:\n                    return (<Element>left)._pow_int(right)\n```\n\nwhich could be simplified to\n\n```python\n            err = integer_check_long_py(right, &value):\n            if not err:\n                return (<Element>left)._pow_long(value)\n            elif err == ERR_OVERFLOW:\n                return (<Element>left)._pow_int(right)\n```\n\n\nHowever, if you see a clear benefit to take on the more complicated function description and return values, then you can set this to a positive review. I just am thinking a little bit about the potential future maintenance of this function (I also don't think there will be any [noticeable] performance difference) and the places where it is used.",
    "created_at": "2017-11-22T22:15:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336099",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:15 jdemeyer]:
> Replying to [comment:13 tscrim]:
> > Do you have a specific case where this does come up?
> 
> I don't know exactly what you mean, but you can look at my work in progress at #24247. There are various calls to `integer_check_long(_py)` there.

Do you have a place on a future ticket where use case 1 applies? I see use case 2 on #24247 and this one:

```python
            if integer_check_long_py(right, &value, &err):
                if not err:
                    return (<Element>left)._pow_long(value)
                else:
                    return (<Element>left)._pow_int(right)
```

which could be simplified to

```python
            err = integer_check_long_py(right, &value):
            if not err:
                return (<Element>left)._pow_long(value)
            elif err == ERR_OVERFLOW:
                return (<Element>left)._pow_int(right)
```


However, if you see a clear benefit to take on the more complicated function description and return values, then you can set this to a positive review. I just am thinking a little bit about the potential future maintenance of this function (I also don't think there will be any [noticeable] performance difference) and the places where it is used.



---

archive/issue_comments_336100.json:
```json
{
    "body": "Here is a concrete proposal: we keep the complicated signature for now (if anything, simply to prevent conflicts with current tickets depending on this one). Once we have a clearer idea on how these functions are used, we can revisit and change things if needed.",
    "created_at": "2017-11-23T09:03:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336100",
    "user": "https://github.com/jdemeyer"
}
```

Here is a concrete proposal: we keep the complicated signature for now (if anything, simply to prevent conflicts with current tickets depending on this one). Once we have a clearer idea on how these functions are used, we can revisit and change things if needed.



---

archive/issue_comments_336101.json:
```json
{
    "body": "Replying to [comment:17 tscrim]:\n> I also don't think there will be any [noticeable] performance difference\n\nFun observation: compiler warnings can be used to get data on how the compiler is able to optimize the code. For example, in #24247 I'm writing essentially\n\n```\n        cdef long value\n        cdef int err\n        if integer_check_long(y, &value, &err):\n            if not err:\n                return (<Element>x)._pow_long(value)\n```\n\nIn this case, the compiler *does not give a warning* that `err` and `value` might be uninitialized. This means that the compiler is able to inline and optimize all code paths of `integer_check_long` to prove that `err` and `value` are set to a known value whenever they are accessed in the code snippet above.",
    "created_at": "2017-11-23T09:12:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336101",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:17 tscrim]:
> I also don't think there will be any [noticeable] performance difference

Fun observation: compiler warnings can be used to get data on how the compiler is able to optimize the code. For example, in #24247 I'm writing essentially

```
        cdef long value
        cdef int err
        if integer_check_long(y, &value, &err):
            if not err:
                return (<Element>x)._pow_long(value)
```

In this case, the compiler *does not give a warning* that `err` and `value` might be uninitialized. This means that the compiler is able to inline and optimize all code paths of `integer_check_long` to prove that `err` and `value` are set to a known value whenever they are accessed in the code snippet above.



---

archive/issue_comments_336102.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-11-23T09:32:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336102",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_336103.json:
```json
{
    "body": "Oh, I just saw this from #24293 (I don't look at every ticket opened...)\n\nAs for \"integer_fake\" is there maybe a name for it that better reflects its purpose\"?  I was thinking something like \"integer_proto\" (for prototype) since providing early access to the Integer prototype seems to be its primary purpose for existing.  \"integer_fake\" to me sounds like something for testing, or some other odd purpose.",
    "created_at": "2017-11-28T15:32:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336103",
    "user": "https://github.com/embray"
}
```

Oh, I just saw this from #24293 (I don't look at every ticket opened...)

As for "integer_fake" is there maybe a name for it that better reflects its purpose"?  I was thinking something like "integer_proto" (for prototype) since providing early access to the Integer prototype seems to be its primary purpose for existing.  "integer_fake" to me sounds like something for testing, or some other odd purpose.



---

archive/issue_comments_336104.json:
```json
{
    "body": "Replying to [comment:21 embray]:\n> As for \"integer_fake\" is there maybe a name for it that better reflects its purpose\"?  I was thinking something like \"integer_proto\" (for prototype) since providing early access to the Integer prototype seems to be its primary purpose for existing.\n\nI think that `integer_fake` or `integer_proto` are equally meaningless. What would \"prototype\" mean in this context? I don't mind changing the name, but I'm not convinced with `integer_proto` either.\n\n> \"integer_fake\" to me sounds like something for testing, or some other odd purpose.\n\n\"odd purpose\" totally applies here :-)",
    "created_at": "2017-11-28T15:40:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336104",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:21 embray]:
> As for "integer_fake" is there maybe a name for it that better reflects its purpose"?  I was thinking something like "integer_proto" (for prototype) since providing early access to the Integer prototype seems to be its primary purpose for existing.

I think that `integer_fake` or `integer_proto` are equally meaningless. What would "prototype" mean in this context? I don't mind changing the name, but I'm not convinced with `integer_proto` either.

> "integer_fake" to me sounds like something for testing, or some other odd purpose.

"odd purpose" totally applies here :-)



---

archive/issue_comments_336105.json:
```json
{
    "body": "Thinking more about it, I actually like how the name sounds like it should not be used. `integer_proto` sounds too official somehow.",
    "created_at": "2017-11-28T16:16:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336105",
    "user": "https://github.com/jdemeyer"
}
```

Thinking more about it, I actually like how the name sounds like it should not be used. `integer_proto` sounds too official somehow.



---

archive/issue_comments_336106.json:
```json
{
    "body": "When I read `proto`(`type`), my first thought was the prototype design pattern, but that's right, in C it is called prototyping. However, since this is only mimicking that, I think `fake` is a little more accurate as to the class's purpose.",
    "created_at": "2017-11-29T00:02:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336106",
    "user": "https://github.com/tscrim"
}
```

When I read `proto`(`type`), my first thought was the prototype design pattern, but that's right, in C it is called prototyping. However, since this is only mimicking that, I think `fake` is a little more accurate as to the class's purpose.



---

archive/issue_comments_336107.json:
```json
{
    "body": "I mean, it *should* be used, just for a specific narrow case.  Alright I won't push on it; just something called \"fake\" is a little jarring to me to see outside of, say, test code.",
    "created_at": "2017-11-29T09:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336107",
    "user": "https://github.com/embray"
}
```

I mean, it *should* be used, just for a specific narrow case.  Alright I won't push on it; just something called "fake" is a little jarring to me to see outside of, say, test code.



---

archive/issue_comments_336108.json:
```json
{
    "body": "BTW, I should add, this is really cool.  Definitely something we should have done in the first place, in retrospect.",
    "created_at": "2017-11-29T09:54:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336108",
    "user": "https://github.com/embray"
}
```

BTW, I should add, this is really cool.  Definitely something we should have done in the first place, in retrospect.



---

archive/issue_comments_336109.json:
```json
{
    "body": "Replying to [comment:26 embray]:\n> BTW, I should add, this is really cool.  Definitely something we should have done in the first place, in retrospect.\n\nThanks!",
    "created_at": "2017-11-29T09:56:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336109",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:26 embray]:
> BTW, I should add, this is really cool.  Definitely something we should have done in the first place, in retrospect.

Thanks!



---

archive/issue_comments_336110.json:
```json
{
    "body": "Okay okay, what about \"integer_decl\", since it's basically a forward declaration IIUC.",
    "created_at": "2017-11-29T09:56:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336110",
    "user": "https://github.com/embray"
}
```

Okay okay, what about "integer_decl", since it's basically a forward declaration IIUC.



---

archive/issue_comments_336111.json:
```json
{
    "body": "Replying to [comment:28 embray]:\n> Okay okay, what about \"integer_decl\", since it's basically a forward declaration IIUC.\n\nIt's a fake forward declaration which shouldn't be used.",
    "created_at": "2017-12-05T10:26:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336111",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:28 embray]:
> Okay okay, what about "integer_decl", since it's basically a forward declaration IIUC.

It's a fake forward declaration which shouldn't be used.



---

archive/issue_events_022456.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2017-12-13T17:38:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24007#event-22456"
}
```



---

archive/issue_comments_336112.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-13T17:38:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336112",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_336113.json:
```json
{
    "body": "Arghs, my typo.",
    "created_at": "2018-04-24T17:13:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24007#issuecomment-336113",
    "user": "https://github.com/jm58660"
}
```

Arghs, my typo.
