# Issue 25620: Uninstall should probably be recursive

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2018-07-13 11:54:27

On Cygwin I tried doing `./sage -f mpir` and everything broke.

This is because my C compiler uses mpc and mpfr, and on Cygwin (see #25816) at least, it ends up using Sage's mpc and mpfr DLLs.  This may be less of a problem on other platforms but I haven't given much thought to it yet.

The mpc and mpfr DLLs in Sage break when Sage's mpir gets uninstalled, so it's necessary _at a minimum_ to also uninstall mpc and mpfr.  But at that point it might also make sense to recursively uninstall _anything_ that depends on mpir.  This seems reasonable given that they'll have to be re-built anyways.


---

Comment by jdemeyer created at 2018-07-13 13:07:16

Changing priority from major to blocker.


---

Comment by jdemeyer created at 2018-07-13 13:07:16

Replying to [ticket:25857 embray]:
> On Cygwin I tried doing `./sage -f mpir` and everything broke.

Can you give more details :-)

I disagree with your solution: it just needs to reorder the operations from

1. Uninstall
2. Build
3. Install

to

1. Build
2. Uninstall
3. Install

That shouldn't break anything.

If this is not easy to fix, maybe we should just disable the uninstall feature for now?


---

Comment by embray created at 2018-07-13 13:41:19

Replying to [comment:1 jdemeyer]:
> Replying to [ticket:25857 embray]:
> > On Cygwin I tried doing `./sage -f mpir` and everything broke.
> 
> Can you give more details :-)

I think I did in the description.  By "everything" I mean that as soon as mpir's configure tries to detect a C compiler, gcc breaks because it's loading DLLs from `$SAGE_LOCAL` (ugh), and those DLLs are in turn compiled against the mpir from Sage, and are incompatible with my system's GMP.

The problem here is my system's gcc using libraries from Sage, when it really shouldn't.  But this is a little difficult to avoid, unless I can patch things somewhere so that executables from the system such as gcc or git are explicitly _not_ run with Sage's environment modifications (e.g. to `$PATH`).  I believe this is less of a problem on Linux.

> I disagree with your solution: it just needs to reorder the operations from

Why?  I think it's a rather sensible solution.

> 1. Uninstall
> 2. Build
> 3. Install
> 
> to
> 
> 1. Build
> 2. Uninstall
> 3. Install

It sort of depends on what you mean by "order of operations".  Currently, `sage-spkg` does the second process, which is certainly my preference.  (This process has its own problems, e.g. when building Python--this is partly Python's fault, and partly our fault for not providing better isolation between build and runtime environments.)

However, when you run `./sage -f` like I did, it manually calls `make <pkg>-clean` before calling `make <pkg>`.  Perhaps it shouldn't.  

I don't consider this a blocker though, unless the problem can be reproduced other than on Cygwin, since I'm pretty much the only person who does development on Cygwin, and this isn't a normal use case.


---

Comment by embray created at 2018-07-13 13:42:50

FWIW I did lots of testing of the uninstaller on Linux, including doing odd things like `./sage -f mpir` (and I did specifically focus on mpir due to its involvement in tricky dependency cycles). Never saw any problem like this.


---

Comment by embray created at 2018-07-13 13:45:26

Anyways, a lot more packages have problems if you _don't_ remove their previous versions before building new versions of those packages, than the other way around.  In this case, it's because mpir has dependents that are in turn dependencies of the compiler.  In that case I would just uninstall all of mpir's dependents as well, hence my suggestion of recursive uninstall.

I don't like uninstalling things before their replacements are built, but it seems that's pretty necessary a lot of the time.  For that reason I think I'll place a higher priority on #25202.


---

Comment by embray created at 2018-07-13 13:58:36

This reminds me--did you ever get anywhere with creating a separate build-time package for mpir?  Something like that might also help.  Same for the other "toolchain-deps" (zlib, mpfr, mpc).  They all share the problem that breaking them can break the C compiler which, in turn, needs them to build.


---

Comment by jdemeyer created at 2018-07-13 14:13:11

Replying to [comment:4 embray]:
> In that case I would just uninstall all of mpir's dependents as well, hence my suggestion of recursive uninstall.

How would you deal with a Sage-built GCC? That will obviously depend on Sage's MPIR too.


---

Comment by jdemeyer created at 2018-07-13 14:14:41

Replying to [comment:5 embray]:
> This reminds me--did you ever get anywhere with creating a separate build-time package for mpir?

Creating a separate package might simplify the build system, but it wouldn't fix the uninstall problem.


---

Comment by jdemeyer created at 2018-07-13 14:15:48

Replying to [comment:3 embray]:
> FWIW I did lots of testing of the uninstaller on Linux, including doing odd things like `./sage -f mpir` (and I did specifically focus on mpir due to its involvement in tricky dependency cycles). Never saw any problem like this.

Did you do that with a Sage-built GCC? That's where things get tricky.


---

Comment by embray created at 2018-07-13 14:22:41

A few additional thoughts:

a) As for sage-gcc, recursively uninstalling all dependents doubly makes sense.  If you rebuild mpir you have to rebuild gcc anyways.

b) I'm thinking at the very least recursive uninstall should happen for all the "toolchain-deps"

c) Something I think would make all of this work better (either instead of, or parallel to separate packages), would be to have a separate install prefix, either under `$SAGE_LOCAL` or parallel to `$SAGE_LOCAL` or all toolchain dependencies.  This prefix would be superseded by the usual SAGE_LOCAL paths, so the bootstrap toolchain never entirely goes away, but packages that are otherwise dependents of the toolchain can still be upgraded without breaking the existing toolchain.


---

Comment by embray created at 2018-07-13 14:23:13

Replying to [comment:8 jdemeyer]:
> Replying to [comment:3 embray]:
> > FWIW I did lots of testing of the uninstaller on Linux, including doing odd things like `./sage -f mpir` (and I did specifically focus on mpir due to its involvement in tricky dependency cycles). Never saw any problem like this.
> 
> Did you do that with a Sage-built GCC? That's where things get tricky.

I did, and I don't remember having any problems (again, on Linux), but that was a long time ago now so my memory is hazy.


---

Comment by jdemeyer created at 2018-07-13 14:28:29

Replying to [comment:10 embray]:
> I did, and I don't remember having any problems (again, on Linux)

Maybe your system GMP libraries were compatible with the Sage MPIR libraries, so the GCC-in-Sage used your system GMP library while MPIR was being rebuilt? Just guessing...


---

Comment by embray created at 2018-07-13 14:36:00

I'd think it would almost have to.  I don't see how else it could work.

All the more reason to have separate copies as "toolchain dependencies", and even then only needed when doing silly things like building gcc.  Then, a developer wanting to do things (such as I was doing) like experiment with patching and reconfiguring mpir can do so on top of that without breaking the toolchain.


---

Comment by jdemeyer created at 2018-07-13 14:53:06

The question is what can we do _right now_ to fix this serious bug?


---

Comment by embray created at 2018-07-13 15:19:37

Unless someone can reproduce this outside of Cygwin, I don't think it's that serious.  I just installed sage-gcc on a Linux build and am trying all manner of `./sage -f mpir/gcc/etc` without any problems.

I'm going to keep thinking about it though.  If I can find a simple solution that works for Cygwin I believe it would work on Linux as well.  Perhaps one very localized solution would be that if one of the `toolchain-deps` gets uninstalled they should all be uninstalled and rebuilt.


---

Comment by jdemeyer created at 2018-07-16 10:49:19

Replying to [comment:14 embray]:
> Unless someone can reproduce this outside of Cygwin, I don't think it's that serious.

Given the analysis, I don't see any reason why this would be limited to Cygwin.


---

Comment by jdemeyer created at 2018-07-16 11:16:24

Just reproduced it on Ubuntu 16.04.1 LTS (CPU architecture ppc64le) with system compiler

```
gcc (Ubuntu/IBM 5.4.0-6ubuntu1~16.04.10) 5.4.0 20160609
Copyright (C) 2015 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
```


When running `./sage -f mpir` on Sage 8.3.rc1, the problem is as I predicted:

```
$ ldd local/libexec/gcc/powerpc64le-unknown-linux-gnu/7.2.0/cc1
        linux-vdso64.so.1 =>  (0x00003fffa2290000)
        libmpc.so.3 => /home/jdemeyer/sage-test/local/lib/libmpc.so.3 (0x00003fffa2260000)
        libmpfr.so.6 => /home/jdemeyer/sage-test/local/lib/libmpfr.so.6 (0x00003fffa21c0000)
        libgmp.so.23 => not found
        libdl.so.2 => /lib/powerpc64le-linux-gnu/libdl.so.2 (0x00003fffa2180000)
        libz.so.1 => /home/jdemeyer/sage-test/local/lib/libz.so.1 (0x00003fffa2140000)
        libm.so.6 => /lib/powerpc64le-linux-gnu/libm.so.6 (0x00003fffa2050000)
        libc.so.6 => /lib/powerpc64le-linux-gnu/libc.so.6 (0x00003fffa1e80000)
        /lib64/ld64.so.2 (0x00003fffa22b0000)
        libgmp.so.23 => not found
        libgmp.so.23 => not found
```

causing obvious build failures.


---

Comment by embray created at 2018-07-16 16:42:21

I'll try to reproduce that on x86_64, as I don't have access to that architecture.  But I see what you're saying in general.

There are two cases here:

* without sage-gcc
* with sage-gcc

The reason I focused here on Cygwin is that this a problem for Cygwin even _without_ sage-gcc due to problems with the DLL search path on Windows.  It non-sage-gcc should not have any problem on Linux.

But it is a problem certainly for sage-gcc if it's built against a sage-mpir that is not compatible somehow or other with the system's libgmp.


This all goes back to (one of) Sage's original sins, which is that you're building software packages in a build environment that is also the installation target.  For most packages this is not a big problem, but for your build toolchain itself it certainly is.  This is why I think that for bootstrapping purposes the build toochain and its dependencies should have some level of isolation from the rest of the install target.

As for a solution, I'd certainly be willing to disable the new-style uninstallation as the default behavior for now. Honestly, I would have preferred to wait until more/all of DESTDIR-related updates were in, as well as #25140, though be design it's supposed to be able to work without that (and does in most cases).  But I'm hesitant because for the majority of packages it does work well now, and I'm not entirely sure what the impact would be of fully disabling it now (but maybe it would be small).

So I think for now it still might be best to find a middle-ground.  What if, for now, for toolchain dependencies only, we ensure that their files are not removed before reinstalling them?  This could work in part with cooperation from `sage-spkg` by adding a flag similar to pip's `--ignore-installed` which causes it to ignore dependencies that are already satisfied and just install on top of them, rather than uninstalling conflicting/existing dependencies first.


---

Comment by jdemeyer created at 2018-07-17 06:37:06

Personally, I would prefer to revert uninstall completely because that's the safest operation. But if you have a different solution which is reasonably simple, that might be OK for me too.


---

Comment by embray created at 2018-07-17 10:47:30

I mean, this issue needs to be resolved somehow anyways--the new package uninstallation is not going away long-term.


---

Comment by embray created at 2018-07-17 14:54:14

I'm currently testing a fix that I think is pretty uninvasive.  I would still consider it a work-around but it's reasonable.


---

Comment by embray created at 2018-07-17 16:07:23

Changing status from new to needs_review.


---

Comment by embray created at 2018-07-17 16:07:23

New commits:


---

Comment by embray created at 2018-07-17 16:53:03

[f1411c5](https://git.sagemath.org/sage.git/commit?id=f1411c5ee7e3aad4a11e2eeab767e980a0d65abb) works for toolchain packages, but can actually break other packages that rely on the new-style uninstaller to remove files should should be removed in order to reinstall that package.  This came up for me in the case of elliptic_curves.  Simply deleting the stamp file can be a problem, because it means erasing the file manifest for that package (perhaps an argument that they should not be one in the same, but that's another issue).

This can be fixed by further narrowing things so that `<spkg>-clean` works the old way only for packages in TOOLCHAIN_DEPS.


---

Comment by embray created at 2018-07-17 16:53:03

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-07-17 17:23:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-07-17 17:24:00

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2018-07-17 22:27:32

IMHO this would be a mistake to merge at the last minute; This does not fix any bug that generates wrong answers, has no testsuite coverage, etc. Its much safer to merge it at the beginnig of the next beta phase...


---

Comment by jdemeyer created at 2018-07-18 06:55:18

I don't like the change `$(inst_zlib)` -> `zlib`. It will prevent using a system `zlib` if we ever want that.


---

Comment by vbraun created at 2018-07-18 06:57:04

Changing priority from blocker to major.


---

Comment by jdemeyer created at 2018-07-18 07:00:24

Changing priority from major to blocker.


---

Comment by jdemeyer created at 2018-07-18 07:00:24

This fixes a very serious bug when building from source. You may not like the solution, but the bug is real.


---

Comment by vbraun created at 2018-07-18 07:05:18

It doesn't break configure && make as far as I can tell. Basically there is an obscure makefile target that requires a full rebuild to recover. How is that a release blocker, just don't do it until its fixed.

In a similar vein, `make doc` frequently breaks incremental builds and nobody thinks thats a release blocker.


---

Comment by embray created at 2018-07-18 07:42:22

Replying to [comment:26 jdemeyer]:
> I don't like the change `$(inst_zlib)` -> `zlib`. It will prevent using a system `zlib` if we ever want that.

I'm not sure that's true.  My system for enabling use of more system packages wouldn't be impacted by that, I don't think.  But if that's your only review comment I'll fix it; it's not a big deal (I think it's still useful to have a variable listing the bare package names, but I can add a separate one).


---

Comment by embray created at 2018-07-18 07:45:03

Replying to [comment:29 vbraun]:
> It doesn't break configure && make as far as I can tell. Basically there is an obscure makefile target that requires a full rebuild to recover. How is that a release blocker, just don't do it until its fixed.
> 
> In a similar vein, `make doc` frequently breaks incremental builds and nobody thinks thats a release blocker.

I actually kind of agree with Volker on this one :)  But I'm also sympathetic to it since:

a) I broke it.

b) I was bitten by this issue myself, and on Cygwin it can rather badly break patchbots since it affects Cygwin even without installing sage-gcc.

c) The fix is simple (IMO) and if it helps Jeroen sleep at night I don't see the problem.


---

Comment by embray created at 2018-07-18 07:47:20

Replying to [comment:25 vbraun]:
> IMHO this would be a mistake to merge at the last minute; This does not fix any bug that generates wrong answers, has no testsuite coverage, etc. Its much safer to merge it at the beginnig of the next beta phase...

Also it wouldn't be "last minute" it if we had a release schedule that created fewer artificial "panic windows".


---

Comment by jdemeyer created at 2018-07-19 07:04:10

I'm not very comfortable with code like

```
	+$(AM_V_at)sage-logger -p '$$(SAGE_SPKG) \
		$(if $(filter $(1),$(TOOLCHAIN_DEPS)),--keep-existing) \
		$(1)-$(2)' '$$(SAGE_LOGS)/$(1)-$(2).log'
```

I never liked your idea about defining these kind of rules in `Makefile` syntax. How am I supposed to understand what is going on here?


---

Comment by jdemeyer created at 2018-07-19 07:06:03

This comment

```
# Note: This list is determined from the dependencies of the TOOLCHAIN
# packages which include gcc, and optionally ccache; in principle this
# list is redundant.
```

is not completely accurate since it should also include the dependencies of the system toolchain, which may use Sage libraries (or did we fix that?)


---

Comment by jdemeyer created at 2018-07-19 07:07:55

Also, `TOOLCHAIN_DEPS` should only contain the runtime dependencies of the toolchain (I mean the runtime of the toolchain, when building packages), so not `xz`.


---

Comment by jdemeyer created at 2018-07-19 07:20:32

Setting this to needs_work for me because of [comment:26] and [comment:34] and [comment:35] but I haven't finished testing.


---

Comment by jdemeyer created at 2018-07-19 07:20:37

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-07-19 07:37:29

Replying to [comment:33 jdemeyer]:
> I'm not very comfortable with code like
> {{{
> 	+$(AM_V_at)sage-logger -p '$$(SAGE_SPKG) \
> 		$(if $(filter $(1),$(TOOLCHAIN_DEPS)),--keep-existing) \
> 		$(1)-$(2)' '$$(SAGE_LOGS)/$(1)-$(2).log'
> }}}
> I never liked your idea about defining these kind of rules in `Makefile` syntax. How am I supposed to understand what is going on here?

I'm sorry but you'll have to live with that.  Read the docs?  With GNU make functions, if you ignore the `$` (or at least, understand that the function call is treated the same as any other variable expansion), and the commas, then it reads more or less like LISP:

`(if (filter <the-dependency> TOOLCHAIN_DEPS) --keep-existing)`

where `filter` expands to `<the-dependency>` if it is found in `TOOLCHAIN_DEPS`, and `if` expands to its second argument if its first argument is non-empty (or to its optional third argument if the first argument is empty).


---

Comment by embray created at 2018-07-19 07:39:19

Replying to [comment:34 jdemeyer]:
> This comment
> {{{
> # Note: This list is determined from the dependencies of the TOOLCHAIN
> # packages which include gcc, and optionally ccache; in principle this
> # list is redundant.
> }}}
> is not completely accurate since it should also include the dependencies of the system toolchain, which may use Sage libraries (or did we fix that?)

Why would the system toolchain ever use Sage libraries unless the user were doing something like setting `LD_LIBRARY_PATH`?


---

Comment by embray created at 2018-07-19 07:40:55

Replying to [comment:35 jdemeyer]:
> Also, `TOOLCHAIN_DEPS` should only contain the runtime dependencies of the toolchain (I mean the runtime of the toolchain, when building packages), so not `xz`.

I'm not really clear on where xz fits into this.  Why is it listed as a dependency of gcc in the first place?


---

Comment by jdemeyer created at 2018-07-19 07:45:43

Replying to [comment:40 embray]:
> Why is it listed as a dependency of gcc in the first place?

Only because the GCC tarball is xz-compressed.


---

Comment by jdemeyer created at 2018-07-19 07:46:48

Replying to [comment:39 embray]:
> Why would the system toolchain ever use Sage libraries unless the user were doing something like setting `LD_LIBRARY_PATH`?

We certainly did that in the past but maybe not anymore.


---

Comment by embray created at 2018-07-19 07:54:12

Replying to [comment:42 jdemeyer]:
> Replying to [comment:39 embray]:
> > Why would the system toolchain ever use Sage libraries unless the user were doing something like setting `LD_LIBRARY_PATH`?
> 
> We certainly did that in the past but maybe not anymore.

Only on Cygwin, where it's required for `dlopen` to work, but it has no other effect on Cygwin.  There's no reason otherwise to set `LD_LIBRARY_PATH` in the Sage environment in general since we mostly rely on RPATH.  There are just a few individual special cases where it's set (but not for running the compiler).


---

Comment by embray created at 2018-07-19 07:55:03

Replying to [comment:41 jdemeyer]:
> Replying to [comment:40 embray]:
> > Why is it listed as a dependency of gcc in the first place?
> 
> Only because the GCC tarball is xz-compressed.

Wow, ok...

I'll just, drop the commit that added it then.


---

Comment by jdemeyer created at 2018-07-19 09:13:51

Replying to [comment:29 vbraun]:
> It doesn't break configure && make as far as I can tell.

It doesn't break a build from scratch but I don't understand why. It should break since mpir is built twice (once before GCC and once after GCC).


---

Comment by jdemeyer created at 2018-07-19 09:17:14

When building mpir the second time (after GCC) I get

```
No record that 'mpir' was ever installed; skipping uninstall
```


Can anybody explain this?


---

Comment by embray created at 2018-07-19 09:24:26

Replying to [comment:45 jdemeyer]:
> Replying to [comment:29 vbraun]:
> > It doesn't break configure && make as far as I can tell.
> 
> It doesn't break a build from scratch but I don't understand why. It should break since mpir is built twice (once before GCC and once after GCC).

How exactly are you reproducing the issue?  I can reproduce it by running `./sage -f mpir`.  The reason for this is very specific to `./sage -f`, because it _explicitly_ calls `make clean-mpir` before trying to rebuild mpir.  During a normal build from scratch that does not happen.


---

Comment by embray created at 2018-07-19 09:26:00

Replying to [comment:46 jdemeyer]:
> When building mpir the second time (after GCC) I get
> {{{
> No record that 'mpir' was ever installed; skipping uninstall
> }}}
> 
> Can anybody explain this?

Are you getting that _with_ this patch, or on bare 8.3.rc1.

Either way that's normal.  That's just what `sage-spkg-uninstall` says if it can't find `local/var/lib/sage/installed/mpir-<whatever>`.  As far is it knows there's nothing to uninstall.


---

Comment by git created at 2018-07-19 11:49:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-07-19 11:52:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-07-19 11:54:42

Replying to [comment:36 jdemeyer]:
> Setting this to needs_work for me because of [comment:26] and [comment:34] and [comment:35] but I haven't finished testing.

I think I've addressed all of these:

[x] removed `xz` from `TOOLCHAIN_DEPS`

[x] used `$(MAKE) $(inst_pkg)` for each package in `TOOLCHAIN_DEPS` (serially)

[x] updated the comment; though I don't know if what it says now is really any better (I think it is though)


Sorry for my flippancy about make syntax constructs but I really think it makes things simpler; there's nothing out of the ordinary about it.


---

Comment by embray created at 2018-07-19 11:54:42

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-07-24 20:52:42

I changed my mind about the urgency if it only happens on force rebuilds (`sage -f ...`)


---

Comment by jdemeyer created at 2018-07-24 20:52:42

Changing priority from blocker to critical.


---

Comment by embray created at 2018-07-25 13:39:27

FWIW it can also screw up patchbots since they're regularly jumping back and forth between branches (which might end up requiring a rebuild of mpir and/or dependencies).

But if that's still fixed by the next beta release I don't see it as that big a deal.


---

Comment by jdemeyer created at 2018-07-30 14:56:49

Replying to [comment:38 embray]:
> I'm sorry but you'll have to live with that.  Read the docs?

Understanding this syntactically is not the same as actually understanding it semantically. Whenever I try to review this ticket, I also end up realizing that there is no way to be sure that this `Makefile` syntax does what it is supposed to do.

And your suggestion to run `make -f build/make/Makefile -n DEBUG_RULES=1` would be useful if it would actually do what it said: the `toolchain-deps` rules that you change on this ticket do not appear there.

I'm not making this comment just to be annoying or pedantic. I really do think that it's a serious problem with #21524.


---

Comment by jdemeyer created at 2018-07-30 15:01:58

Some other comments:

1. the flags `SAGE_INSTALL_FETCH_ONLY`, `SAGE_CHECK` and `SAGE_KEEP_BUILT_SPKGS` are meant to be usable as environment variables. So I would do the same for `KEEP_EXISTING` (rename it to `SAGE_KEEP_EXISTING` and remove `KEEP_EXISTING=0`).

2. keep the whitespace line in the `-clean` rule.


---

Comment by embray created at 2018-07-30 15:56:24

Replying to [comment:55 jdemeyer]:
> Some other comments:
> 
> 1. the flags `SAGE_INSTALL_FETCH_ONLY`, `SAGE_CHECK` and `SAGE_KEEP_BUILT_SPKGS` are meant to be usable as environment variables. So I would do the same for `KEEP_EXISTING` (rename it to `SAGE_KEEP_EXISTING` and remove `KEEP_EXISTING=0`).

Ok.

> 2. keep the whitespace line in the `-clean` rule.

Yes, weirdly I thought I already fixed that.  I don't know why the fix went away again.


---

Comment by embray created at 2018-07-30 16:03:52

Replying to [comment:54 jdemeyer]:
> Replying to [comment:38 embray]:
> > I'm sorry but you'll have to live with that.  Read the docs?
> 
> Understanding this syntactically is not the same as actually understanding it semantically. Whenever I try to review this ticket, I also end up realizing that there is no way to be sure that this `Makefile` syntax does what it is supposed to do.
> 
> And your suggestion to run `make -f build/make/Makefile -n DEBUG_RULES=1` would be useful if it would actually do what it said: the `toolchain-deps` rules that you change on this ticket do not appear there.

That's just for printing the automatically generated rules, not for printing every rule in the makefile, not statically-defined targets, like `toolchain-deps`.

I'm not sure what's unclear about that target.

> I'm not making this comment just to be annoying or pedantic. I really do think that it's a serious problem with #21524.

I believe your intentions are sincere, but I still find this objection very confusing.  I feel like you're just stubbornly refusing to learn for some reason, because I find it easy to understand, and to check; maybe just not as easy as, say, a Python script.  I don't know if that's what's going on; that's just what it feels like to me.  Maybe a tutorial on make would help; I don't know.

Anyways, I think that discussion is outside the scope of this ticket.


---

Comment by embray created at 2018-07-30 16:04:10

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-07-30 16:07:25

Replying to [comment:56 embray]:
> Replying to [comment:55 jdemeyer]:
> > Some other comments:
> > 
> > 1. the flags `SAGE_INSTALL_FETCH_ONLY`, `SAGE_CHECK` and `SAGE_KEEP_BUILT_SPKGS` are meant to be usable as environment variables. So I would do the same for `KEEP_EXISTING` (rename it to `SAGE_KEEP_EXISTING` and remove `KEEP_EXISTING=0`).
> 
> Ok.

Actually, the more I think about it, I think we should avoid adding yet another environment variable for now.  Is this something we actually need?  If there's not an obvious use case for setting this flag for all packages I think it should be avoided.  The name `SAGE_KEEP_EXISTING` is also very unclear as to what it does.  Keep existing what?  In the context of the `sage-spkg` script it makes sense, but it's very unobvious otherwise.


---

Comment by git created at 2018-07-30 16:11:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-07-30 16:11:43

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-07-30 16:14:19

Replying to [comment:57 embray]:
> Replying to [comment:54 jdemeyer]:
> > Replying to [comment:38 embray]:
> > > I'm sorry but you'll have to live with that.  Read the docs?
> > 
> > Understanding this syntactically is not the same as actually understanding it semantically. Whenever I try to review this ticket, I also end up realizing that there is no way to be sure that this `Makefile` syntax does what it is supposed to do.

Which syntax specifically?  What are you trying to check?


---

Comment by jdemeyer created at 2018-08-07 12:08:44

Replying to [comment:59 embray]:
> If there's not an obvious use case for setting this flag for all packages I think it should be avoided.

Why? I would argue the opposite: it doesn't harm to support it as an environment variable, so why should we not do that?

> The name `SAGE_KEEP_EXISTING` is also very unclear as to what it does.

Then call it `SAGE_SKIP_UNINSTALL` or whatever.


---

Comment by jdemeyer created at 2018-08-07 12:16:46

Replying to [comment:62 embray]:
> Which syntax specifically?  What are you trying to check?

I'm just trying to check that this branch does what it seems to be doing. It _looks_ like it does the right thing (skipping uninstall for toolchain packages) but how I can be sure?

By now, I've looked at this ticket a few times and I guess it's OK. I'll wait for your reply on the environment variable issue before doing a final review.


---

Comment by embray created at 2018-08-08 13:27:34

Replying to [comment:64 jdemeyer]:
> Replying to [comment:62 embray]:
> > Which syntax specifically?  What are you trying to check?
> 
> I'm just trying to check that this branch does what it seems to be doing. It _looks_ like it does the right thing (skipping uninstall for toolchain packages) but how I can be sure?

I'm still not sure what you're asking here.  Are you just asking how to test code in a makefile?  How can you be sure any code does what you think it looks like it does?  I'm not trying to be facetious--I'm just trying to get to the bottom of what your concern is.


---

Comment by embray created at 2018-08-08 13:31:06

Replying to [comment:63 jdemeyer]:
> Replying to [comment:59 embray]:
> > If there's not an obvious use case for setting this flag for all packages I think it should be avoided.
> 
> Why? I would argue the opposite: it doesn't harm to support it as an environment variable, so why should we not do that?

I don't agree.  Adding any new "feature" means you have to support it. The main purpose of this change (although it _does_ add new features in the form of new command-line flags to some scripts) was not really to add new features so much as to workaround a specific problem.  So better to keep the feature surface area of the change minimal.  I also believe the YAGNI principle applies here.

But if you _really_ want it for some reason a compromise might be to change the name but not document it anywhere.  I'm also a little unsure about this in that it's really a behavior of the uninstallation that this is changing, not the installation.  ~~If anything it should be an environment variable read by the uninstaller, but there again it adds needless complication...~~ (That last sentence didn't make sense; I misremembered what my own patch does :)


---

Comment by git created at 2018-08-10 11:08:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-08-10 11:10:04

How about this?  I called it `SAGE_SPKG_SKIP_UNINSTALL` and noted it in the documentation at the top of `sage-spkg`, but not elsewhere, at least for now.

I'd like to get this done already; I think this fix is too important to be held up any longer by bikeshedding.


---

Comment by dimpase created at 2018-09-07 08:50:59

Perhaps this should get #25188 as a dependence, so that the latter and this are merged together, with just one new configure tarball instead of two...


---

Comment by embray created at 2018-09-07 09:14:37

Looks like the latest patchbot build failed due to #18438.

Dima, that's not a bad idea, but I'd like to see a positive review on both first.


---

Comment by dimpase created at 2018-10-15 09:55:10

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-10-20 11:59:15

Resolution: fixed


---

Comment by embray created at 2018-10-28 14:52:23

This should be re-targeted for 8.5.
