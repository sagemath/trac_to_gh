# Issue 31183: Review/remove monkey patching in src/sage/__init__.py

archive/issues_031183.json:
```json
{
    "body": "CC:  @kiwifb @jhpalmieri @embray\n\nTo make `sage` a namespace package, we need to get rid of `src/sage/__init__.py`.\n\nIt currently contains:\n- definition of __all__\n- definition of __version__\n- preloading of zlib\n- `load_ipython_extension`\n- monkey patching of `inspect.isfunction` to support Cython functions\n- monkey patching of sqlite on Cygwin\n\nWe should review all of them, remove anything that is not needed any more, and move the rest to other module inits if possible.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31420\n\n",
    "created_at": "2021-02-20T22:14:32Z",
    "labels": [
        "component: refactoring"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Review/remove monkey patching in src/sage/__init__.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31183",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @kiwifb @jhpalmieri @embray

To make `sage` a namespace package, we need to get rid of `src/sage/__init__.py`.

It currently contains:
- definition of __all__
- definition of __version__
- preloading of zlib
- `load_ipython_extension`
- monkey patching of `inspect.isfunction` to support Cython functions
- monkey patching of sqlite on Cygwin

We should review all of them, remove anything that is not needed any more, and move the rest to other module inits if possible.

Issue created by migration from https://trac.sagemath.org/ticket/31420





---

archive/issue_comments_445283.json:
```json
{
    "body": "Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-24T02:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31183#issuecomment-445283",
    "user": "https://github.com/mkoeppe"
}
```

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_445284.json:
```json
{
    "body": "It seems that removing `__version__` and `__all__` is harmless. I don't know about the `zlib` issue: I tried moving the import to `all.py` and everything worked, but that's hardly an exhaustive test.",
    "created_at": "2021-09-08T20:48:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31183#issuecomment-445284",
    "user": "https://github.com/jhpalmieri"
}
```

It seems that removing `__version__` and `__all__` is harmless. I don't know about the `zlib` issue: I tried moving the import to `all.py` and everything worked, but that's hardly an exhaustive test.



---

archive/issue_comments_445285.json:
```json
{
    "body": "We can probably move it (and also the `sqlite` monkey-patching on cygwin) to a module that is loaded very early such as `sage.cpython.__init__`.",
    "created_at": "2021-09-08T21:17:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31183#issuecomment-445285",
    "user": "https://github.com/mkoeppe"
}
```

We can probably move it (and also the `sqlite` monkey-patching on cygwin) to a module that is loaded very early such as `sage.cpython.__init__`.



---

archive/issue_comments_445286.json:
```json
{
    "body": "Do you also want `del _sys`?\n----\nNew commits:",
    "created_at": "2021-09-08T22:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31183#issuecomment-445286",
    "user": "https://github.com/jhpalmieri"
}
```

Do you also want `del _sys`?
----
New commits:



---

archive/issue_comments_445287.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-08T23:03:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31183#issuecomment-445287",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_445288.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-09-08T23:23:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31183#issuecomment-445288",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_445289.json:
```json
{
    "body": "Where does the `del _zlib` come from in `sage/cpython/__init__.py`? It wasn't present in `sage/__init__.py` and the ticket above that group only talks about `import zlib`. Is mentioning that ticket obsolete? Is the whole block obsolete when we favor system zlib whenever possible?",
    "created_at": "2021-09-08T23:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31183#issuecomment-445289",
    "user": "https://github.com/kiwifb"
}
```

Where does the `del _zlib` come from in `sage/cpython/__init__.py`? It wasn't present in `sage/__init__.py` and the ticket above that group only talks about `import zlib`. Is mentioning that ticket obsolete? Is the whole block obsolete when we favor system zlib whenever possible?



---

archive/issue_comments_445290.json:
```json
{
    "body": "The `del` introduced in `af6642f` just removes the binding of the name `_zlib` created by the `import` statement from the `sage.cpython` module. Likewise the other `del`s in this commit.",
    "created_at": "2021-09-09T00:25:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31183#issuecomment-445290",
    "user": "https://github.com/mkoeppe"
}
```

The `del` introduced in `af6642f` just removes the binding of the name `_zlib` created by the `import` statement from the `sage.cpython` module. Likewise the other `del`s in this commit.



---

archive/issue_comments_445291.json:
```json
{
    "body": "Call me obtuse, why do you import and then delete straight away? Is it a cleaner way to make sure that the right library is loaded while you may not want it around in this particular unit?",
    "created_at": "2021-09-09T00:32:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31183#issuecomment-445291",
    "user": "https://github.com/kiwifb"
}
```

Call me obtuse, why do you import and then delete straight away? Is it a cleaner way to make sure that the right library is loaded while you may not want it around in this particular unit?



---

archive/issue_comments_445292.json:
```json
{
    "body": "The importing there is just to trigger loading some shared library.\nOne could use a function from `importlib` instead of using `import` but that's a tiny bit more obscure",
    "created_at": "2021-09-09T00:38:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31183#issuecomment-445292",
    "user": "https://github.com/mkoeppe"
}
```

The importing there is just to trigger loading some shared library.
One could use a function from `importlib` instead of using `import` but that's a tiny bit more obscure



---

archive/issue_comments_445293.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-09T00:41:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31183#issuecomment-445293",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_445294.json:
```json
{
    "body": "Thank you for taking the time to answer my questions. It looks good to go.",
    "created_at": "2021-09-09T00:41:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31183#issuecomment-445294",
    "user": "https://github.com/kiwifb"
}
```

Thank you for taking the time to answer my questions. It looks good to go.



---

archive/issue_comments_445295.json:
```json
{
    "body": "Thanks for reviewing!",
    "created_at": "2021-09-09T00:56:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31183#issuecomment-445295",
    "user": "https://github.com/mkoeppe"
}
```

Thanks for reviewing!



---

archive/issue_comments_445296.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-09-15T22:06:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31183",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31183#issuecomment-445296",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
