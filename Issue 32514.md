# Issue 32514: Incremental build fails with packaging-related packages

Issue created by migration from https://trac.sagemath.org/ticket/32751

Original creator: vbraun

Original creation time: 2021-10-24 09:12:58

CC:  vbraun dimpase jhpalmieri mkoeppe

Incremental builds fail if a dependency of `setuptools_scm` needs to be rebuilt. Steps to reproduce:

```
make distclean
make
sage -p packaging
```

Expected behavior is to rebuild, actually get

```
****************************************************
Uninstalling existing 'packaging'
Running pip-uninstall script for 'packaging'
Found existing installation: packaging 21.0
Uninstalling packaging-21.0:
  Successfully uninstalled packaging-21.0
Removing stamp file '/home/vbraun/Sage/git/local/var/lib/sage/installed/packaging-21.0'
Installing packaging-21.0
Processing /home/vbraun/Sage/git/local/var/tmp/sage/build/packaging-21.0/src
    Preparing wheel metadata: started
    Running command /home/vbraun/Sage/git/local/bin/python3 /home/vbraun/Sage/git/local/lib64/python3.9/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /tmp/tmpdfyrpf_j
    Traceback (most recent call last):
      File "/home/vbraun/Sage/git/local/lib64/python3.9/site-packages/pip/_vendor/pep517/in_process/_in_process.py", line 349, in <module>
        main()
      File "/home/vbraun/Sage/git/local/lib64/python3.9/site-packages/pip/_vendor/pep517/in_process/_in_process.py", line 331, in main
        json_out['return_val'] = hook(**hook_input['kwargs'])
      File "/home/vbraun/Sage/git/local/lib64/python3.9/site-packages/pip/_vendor/pep517/in_process/_in_process.py", line 151, in prepare_metadata_for_build_wheel
        return hook(metadata_directory, config_settings)
      File "/home/vbraun/Sage/git/local/lib64/python3.9/site-packages/setuptools/build_meta.py", line 166, in prepare_metadata_for_build_wheel
        self.run_setup()
      File "/home/vbraun/Sage/git/local/lib64/python3.9/site-packages/setuptools/build_meta.py", line 150, in run_setup
        exec(compile(code, __file__, 'exec'), locals())
      File "setup.py", line 40, in <module>
        setup(
      File "/home/vbraun/Sage/git/local/lib64/python3.9/site-packages/setuptools/__init__.py", line 153, in setup
        return distutils.core.setup(**attrs)
      File "/home/vbraun/Sage/git/local/lib64/python3.9/site-packages/setuptools/_distutils/core.py", line 108, in setup
        _setup_distribution = dist = klass(attrs)
      File "/home/vbraun/Sage/git/local/lib64/python3.9/site-packages/setuptools/dist.py", line 450, in __init__
        _Distribution.__init__(
      File "/home/vbraun/Sage/git/local/lib64/python3.9/site-packages/setuptools/_distutils/dist.py", line 293, in __init__
        self.finalize_options()
      File "/home/vbraun/Sage/git/local/lib64/python3.9/site-packages/setuptools/dist.py", line 827, in finalize_options
        for ep in sorted(loaded, key=by_order):
      File "/home/vbraun/Sage/git/local/lib64/python3.9/site-packages/setuptools/dist.py", line 826, in <lambda>
        loaded = map(lambda e: e.load(), filtered)
      File "/home/vbraun/Sage/git/local/lib64/python3.9/site-packages/pkg_resources/__init__.py", line 2449, in load
        self.require(*args, **kwargs)
      File "/home/vbraun/Sage/git/local/lib64/python3.9/site-packages/pkg_resources/__init__.py", line 2472, in require
        items = working_set.resolve(reqs, env, installer, extras=self.extras)
      File "/home/vbraun/Sage/git/local/lib64/python3.9/site-packages/pkg_resources/__init__.py", line 772, in resolve
        raise DistributionNotFound(req, requirers)
    pkg_resources.DistributionNotFound: The 'packaging>=20.0' distribution was not found and is required by the application
    Preparing wheel metadata: finished with status 'error'
WARNING: Discarding file:///home/vbraun/Sage/git/local/var/tmp/sage/build/packaging-21.0/src. Command errored out with exit status 1: /home/vbraun/Sage/git/local/bin/python3 /home/vbraun/Sage/git/local/lib64/python3.9/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /tmp/tmpdfyrpf_j Check the logs for full command output.
ERROR: Command errored out with exit status 1: /home/vbraun/Sage/git/local/bin/python3 /home/vbraun/Sage/git/local/lib64/python3.9/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /tmp/tmpdfyrpf_j Check the logs for full command output.
************************************************************************************************************************************************************
Error building a wheel for packaging-21.0
************************************************************************************************************************************************************
```

Inserting some debug printing in require line 2474 reveals

```
self = EntryPoint.parse('setuptools_scm = setuptools_scm.integration:infer_version'), 
reqs = [Requirement.parse('setuptools'), Requirement.parse('tomli>=1.0.0'), Requirement.parse('packaging>=20.0')], None, None, ()]
```


This is because 

```
cat venv/lib/python3.9/site-packages/setuptools_scm-6.3.2.dist-info/METADATA
[...]
Requires-Dist: packaging (>=20.0)
Requires-Dist: setuptools
Requires-Dist: tomli (>=1.0.0)
Provides-Extra: toml
Requires-Dist: setuptools (>=42) ; extra == 'toml'
Requires-Dist: tomli (>=1.0.0) ; extra == 'toml'
[...]
```



---

Comment by mkoeppe created at 2021-10-24 18:01:21

Changing priority from major to critical.


---

Comment by mkoeppe created at 2021-10-24 18:01:21

Thanks for investigating. I was able to reproduce this error using a shorter recipe (updated the description).


---

Comment by mkoeppe created at 2021-10-24 18:28:35

What's happening here is simply that `sage -p` is broken. Don't use it.


---

Comment by mkoeppe created at 2021-10-24 18:28:35

Changing priority from critical to major.


---

Comment by vbraun created at 2021-10-24 18:36:59

I usually don't use `sage -p`, that was just an attempt to get a reproducer. Still get frequent incremental build failures of that sort.


---

Comment by mkoeppe created at 2021-10-24 18:38:03

Yes, that's true, there are 2 issues at play here. Let's take `sage -p` to #30649.


---

Comment by mkoeppe created at 2021-10-24 18:41:29

I've updated the recipe.


---

Comment by mkoeppe created at 2021-10-24 18:45:18

Changing priority from major to critical.


---

Comment by mkoeppe created at 2021-10-24 19:10:31

Here's a solution that takes us a step closer to sanity.
----
New commits:


---

Comment by mkoeppe created at 2021-10-24 19:11:41

Probably need the same for more dependencies of `setuptools_scm`.


---

Comment by mkoeppe created at 2021-10-24 19:17:06

Looks like this is good enough, please try


---

Comment by mkoeppe created at 2021-10-24 19:17:06

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2021-10-27 21:17:35

It looks okay to me. Volker?


---

Comment by vbraun created at 2021-10-27 22:40:12

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-10-28 00:37:03

Thanks.


---

Comment by vbraun created at 2021-10-28 22:34:04

I tried a clean build (`make distclean`) and pillow fails to build...


---

Comment by vbraun created at 2021-10-28 22:34:04

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-10-28 22:36:42

(deleted, wrong ticket)


---

Comment by git created at 2021-10-28 23:36:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-28 23:37:10

Guessing what may have gone wrong, fixed.


---

Comment by mkoeppe created at 2021-10-28 23:37:10

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2021-10-29 02:10:37

It builds for me now.


---

Comment by jhpalmieri created at 2021-10-30 04:54:20

Builds for me on OS X and with several tox docker builds. Let's try again.


---

Comment by jhpalmieri created at 2021-10-30 04:54:20

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-10-30 05:17:10

Thanks!


---

Comment by vbraun created at 2021-11-02 22:36:38

Resolution: fixed
