# Issue 28097: py3: polynomial_rational_flint.pyx problem

Issue created by migration from https://trac.sagemath.org/ticket/28334

Original creator: jhpalmieri

Original creation time: 2019-08-08 17:01:15

CC:  slelievre spancratz wbhart chapoton

On some systems, Debian for example, we see this failure with Python 3:

```
Failed example:
    G = f.galois_group(); G
Expected:
    Transitive group number 5 of degree 4
Got:
    Exception (FLINT memory_manager). Unable to allocate memory.
    Transitive group number 5 of degree 4
**********************************************************************
1 item had failures:
   1 of  16 in sage.rings.polynomial.polynomial_rational_flint.Polynomial_rational_flint.galois_group
    [397 tests, 1 failure, 2.56 s]
```




---

Comment by jhpalmieri created at 2019-08-08 17:11:50

I installed a Debian virtual machine, and now I can see this error.

This problem does not seem related to the particular doctest: if I remove lots of other doctests from that file but keep this one, the error goes away. If I instead keep the file intact and add some print statements, the error is printed as this line is executed:

```
return PermutationGroup(H)
```

`PermutationGroup` has nothing to do with flint, I think.

Any ideas how to debug this?


---

Comment by jhpalmieri created at 2019-08-08 17:22:13

It could be related to the problem discussed at #28106.


---

Comment by jhpalmieri created at 2019-08-08 18:05:50

Replying to [comment:2 jhpalmieri]:
> It could be related to the problem discussed at #28106.

On the other hand, I've tried increasing the default `memlimit` in `bin/sage-runtests`, with no effect.


---

Comment by jhpalmieri created at 2019-08-08 18:09:48

Also, I get the same error in a Sage session with

```
sage: from sage.doctest.control import DocTestController, DocTestDefaults
sage: DC = DocTestController(DocTestDefaults(), ['/home/john/Sage/sage-8.9.beta5/src/sage/rings/polynomial/polynomial_rational_flint.pyx'])
sage: DC.run()
```

I don't think this uses `sage-runtests` and the memory limits there. So maybe it's not the same as #28106.


---

Comment by jhpalmieri created at 2019-08-08 20:55:33

I added a few print statements to flint's `memory_manager.c`. This error is being printed by `flint_calloc`.


---

Comment by klee created at 2019-08-10 23:12:11

I don't have a debian machine and know nothing about flint. But John's experiment seems to indicate that the memory error is genuine. I guess somehow the polynomial_rational_flint module of sage on debian machine leaks memory.


---

Comment by jhpalmieri created at 2019-08-11 06:12:46

I'm seeing this on an Ubuntu virtual machine (running on the same OS X box). I wonder if it's the processor as much as which type of linux is running. This machine has a Core i7 processor.


---

Comment by egourgoulhon created at 2019-08-26 12:48:13

Replying to [comment:8 jhpalmieri]:
> I'm seeing this on an Ubuntu virtual machine (running on the same OS X box). I wonder if it's the processor as much as which type of linux is running. This machine has a Core i7 processor.

As reported in https://groups.google.com/d/msg/sage-release/VuAt1Sc46IQ/n9ejPwoiAwAJ, I also get the error on a Xeon E5-2623 processor (with Ubuntu 18.04).


---

Comment by egourgoulhon created at 2019-09-04 14:36:19

According to the entry (G) in the summary table of #28298, the doctest discussed here is passed on the reference patchbot, which is a Ubuntu machine though...


---

Comment by egourgoulhon created at 2019-09-04 14:42:17

Replying to [comment:10 egourgoulhon]:
> According to the entry (G) in the summary table of #28298, the doctest discussed here is passed on the reference patchbot, which is a Ubuntu machine though...
Well, actually it is reported as failed in
https://patchbot.sagemath.org/log/0/Ubuntu/18.04/x86_64/4.15.0-54-generic/petitbonum/2019-09-03%2009:06:17?short

Is this the "reference patchbot" for Python 3 Sage? If yes, then the table of #28298 must be updated.


---

Comment by jhpalmieri created at 2019-09-09 17:28:10

Okay, I think I know what's going on. This is the same problem as in #28454: strings are being sent to stdout by a C or C++ library but the output is not flushed, or whether it's flushed is system/OS-dependent, so messages like "Exception (FLINT memory_manager). Unable to allocate memory." do not get printed when we expect them, but rather some time later. In this particular case, the message should be printed when this doctest is run:

```
        FLINT memory errors do not crash Sage (:trac:`17629`)::

            sage: t^(sys.maxsize//2)
            Traceback (most recent call last):
            ...
            RuntimeError: FLINT exception
```

in which case it's captured by the "...". But on some platforms, with Python 3 only, the message is not printed at the right time. (I don't know why, but this really does seem to be what's going on.)

One solution would be to modify FLINT to flush the output. Is there a pure Python 3 solution, which we can incorporate in the Sage library without patching or modifying FLINT?


---

Comment by jhpalmieri created at 2019-09-09 17:33:12

Replying to [comment:12 jhpalmieri]:
> One solution would be to modify FLINT to flush the output. Is there a pure Python 3 solution, which we can incorporate in the Sage library without patching or modifying FLINT?

I should also note that patching FLINT won't help if a user is using the system's version of FLINT. So can we do this just with Sage's FLINT interface?


---

Comment by jhpalmieri created at 2019-09-09 18:44:18

Having said that, here is a patch for FLINT. This fixes the problem for me. I won't mark as "needs review" yet, since I would like to know if there is a fix for this on the !Sage/Python side first. If that looks possible but complicated, we can use this patch as a stopgap.
----
New commits:


---

Comment by git created at 2019-09-09 18:45:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-09-09 19:00:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2019-09-09 19:12:37

A stupid workaround, by the way, would be to label the doctest in comment:12 as `py2`. I would rather not do that.


---

Comment by strogdon created at 2019-09-09 19:23:31

I see this failure, as well as that at #28454, on a sage-on-gentoo build using py3. Of course both `flint` and `eclib` are system installed.


---

Comment by jhpalmieri created at 2019-09-09 19:38:55

John Cremona is working on a new `eclib` release, so that problem should be fixed pretty soon, without any patching needed (but after updating the system `eclib`). I don't know what to do about FLINT, if patching is not the right choice.


---

Comment by jhpalmieri created at 2019-09-13 18:59:41

I think these are the options:

- label one doctest as `py2`, thereby sweeping the problem under the rug
- add a patch to flint, which won't help with system-installed copies of flint
- convince the Python/flint interface to flush the output

The last one should be the best, but I don't know how to do it. Do we do either of the others as a stopgap, or wait?


---

Comment by slelievre created at 2019-09-15 14:01:04

Changing keywords from "" to "flint, flush, py3".


---

Comment by slelievre created at 2019-09-15 14:01:04

cc-ing Bill Hart who might have some insight on this.


---

Comment by jhpalmieri created at 2019-10-03 18:20:29

Changing priority from major to blocker.


---

Comment by jhpalmieri created at 2019-10-10 14:47:53

There has been no progress on this. I'm going to mark this as "needs review", since the other options (new flint, or get Sage to flush flint's output) can coexist with this. As I've said before, I would welcome other solutions.


---

Comment by jhpalmieri created at 2019-10-10 14:47:53

Changing status from new to needs_review.


---

Comment by strogdon created at 2019-10-10 21:40:18

Would it help to file an issue or a pull request at https://github.com/wbhart/flint2. There are numerous locations in the `trunk` branch where code had been added of the type

```
flint_print("...");
fflush(stdout);
```

Then again adding a `fflush` to `memory_manager.c` may be too trivial a change prior to a major release.


---

Comment by jhpalmieri created at 2019-10-10 22:13:03

I created a [pull request](https://github.com/wbhart/flint2/pull/585), but since the last release was four years ago, I don't have high hopes.


---

Comment by slelievre created at 2019-10-10 22:51:55

Replying to [comment:26 jhpalmieri]:
> I created a [pull request](https://github.com/wbhart/flint2/pull/585),
> but since the last release was four years ago, I don't have high hopes.

The FLINT repo is active, and has
[a roadmap for FLINT 2.6.0](https://github.com/wbhart/flint2/issues/517),
itself part of
[the Oscar roadmap](https://github.com/oscar-system/Oscar.jl/issues/1),
so there are reasons to hope.


---

Comment by jhpalmieri created at 2019-10-11 00:18:09

The pull request has been merged.


---

Comment by jhpalmieri created at 2019-10-23 02:46:28

This is the main remaining Py3 doctest failure. Shall we merge this, and then later hope to find a systematic way to flush output, or upgrade flint when it's ready?


---

Comment by strogdon created at 2019-10-23 02:54:59

I think we should merge it, but I'll wait for comment.


---

Comment by nbruin created at 2019-10-23 20:50:27

+1 to merging this. If you end up inserting "flush" in the interface wrappers, you'll end up flushing a lot when there's nothing to flush. Since flush is a system call, such wasteful use of resources might end up quite noticeable. Better flush at the source, where you know when it's necessary.


---

Comment by strogdon created at 2019-10-24 03:21:57

Changing status from needs_review to positive_review.


---

Comment by strogdon created at 2019-10-24 03:21:57

I'll push the button. It can always be undone.


---

Comment by jhpalmieri created at 2019-10-24 18:29:00

See #28649 for a followup. I still think we should merge this, especially since the patch has been accepted upstream. #28649 uses nbruin's suggestion for flushing the output when we have a non-patched FLINT.


---

Comment by vbraun created at 2019-10-27 10:28:32

Resolution: fixed
