# Issue 32670: Update singular to 4.2.1p2

Issue created by migration from https://trac.sagemath.org/ticket/32907

Original creator: mkoeppe

Original creation time: 2021-11-19 18:21:34

CC:  dimpase mjo fbissey arojas slelievre




---

Comment by mkoeppe created at 2021-11-19 18:40:58

New commits:


---

Comment by git created at 2021-11-19 18:44:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-19 18:54:46

Build ends with `Error: source file/directory doc/singular.idx does not exist`


---

Comment by git created at 2021-11-19 19:57:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2021-11-19 20:40:56

Passing `-j1` to "make" should no longer be necessary.


---

Comment by git created at 2021-11-19 20:45:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-19 20:51:47

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-11-20 00:09:12

This gives errors in the sagelib build:

```
  [sagelib-9.5.beta7]   build/cythonized/sage/rings/polynomial/multi_polynomial_libsingular.cpp:33693:18: note: in expansion of macro ‘p_SetCoeff0’
  [sagelib-9.5.beta7]              (void)(p_SetCoeff0(__pyx_v_temp, n_Copy(p_GetCoeff(__pyx_v_p, __pyx_v_r), __pyx_v_r), __pyx_v_r));
  [sagelib-9.5.beta7]                     ^
  [sagelib-9.5.beta7]   build/cythonized/sage/rings/polynomial/multi_polynomial_libsingular.cpp: In function ‘PyObject* __pyx_pf_4sage_5rings_10polynomial_28multi_polynomial_libsingular_23MPolynomial_libsingular_104factor(__pyx_obj_4sage_5rings_10polynomial_28multi_polynomial_libsingular_MPolynomial_libsingular*, PyObject*)’:
  [sagelib-9.5.beta7]   build/cythonized/sage/rings/polynomial/multi_polynomial_libsingular.cpp:34874:40: error: cannot convert ‘ip_sring*’ to ‘coeffs {aka n_Procs_s*}’ for argument ‘1’ to ‘int n_GetChar(coeffs)’
  [sagelib-9.5.beta7]      __pyx_t_7 = ((n_GetChar(__pyx_v__ring) > 0x20000000) != 0);
  [sagelib-9.5.beta7]                                           ^
```



---

Comment by mkoeppe created at 2021-11-20 00:09:19

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-11-20 11:41:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2021-11-20 11:47:06

Changing status from needs_work to needs_review.


---

Comment by arojas created at 2021-11-20 11:47:06

Builds now, also with older singular (at least as far back as 4.2.0p1). I've also tried to keep tests compatible with older singular, except for the example in `rings/polynomial/hilbert.pyx`, which failed before and works now. Should we care about it?


---

Comment by mkoeppe created at 2021-11-20 17:53:13

New commits:


---

Comment by mkoeppe created at 2021-11-21 01:09:27

`ubuntu-trusty-minimal` (https://github.com/mkoeppe/sage/runs/4274462334?check_suite_focus=true) and `ubuntu-trusty-standard`:

```
  [sagemath_doc_html-none]       from sage.symbolic.all   import *
  [sagemath_doc_html-none]     File "/sage/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/symbolic/all.py", line 8, in <module>
  [sagemath_doc_html-none]       import sage.symbolic.expression  # initialize pynac before .ring
  [sagemath_doc_html-none]   ImportError: /sage/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/symbolic/expression.cpython-39-x86_64-linux-gnu.so: undefined symbol: fmpq_poly_inv_series_newton
  [sagemath_doc_html-none]   Error: './sage --docbuild --all-documents' failed
```



---

Comment by mkoeppe created at 2021-11-21 01:11:54

Changing status from needs_review to needs_work.


---

Comment by arojas created at 2021-11-21 08:19:02

Replying to [comment:21 mkoeppe]:
> `ubuntu-trusty-minimal` (https://github.com/mkoeppe/sage/runs/4274462334?check_suite_focus=true) and `ubuntu-trusty-standard`:

how can one see the singular spkg logs?


---

Comment by mkoeppe created at 2021-11-21 08:45:01

The log artifacts are now available at https://github.com/mkoeppe/sage/actions/runs/1485019210 (I had to cancel the workflow for that)


---

Comment by arojas created at 2021-11-21 11:37:45

Still can't figure out where spkg logs are. Anyways, I insalled the docker image locally and this is the actual issue:

```
configure:24015: gcc -std=gnu11 -o conftest -I/home/sage/local/include/ -I/home/sage/local/include -I/home/sage/local/include -g -O2  -pipe -fno-common -g0 -O3 -Wno-unused-function -Wno-trigraphs -Wno-unused-parameter -Wunknown-pragmas -Wno-unused-variable -fomit-frame-pointer -fwrapv -fvisibility=default -finline-functions -fno-exceptions -funroll-loops  -Wl,-rpath-link,/home/sage/local/lib -L/home/sage/local/lib -Wl,-rpath,/home/sage/local/lib -Wl,-rpath-link,/home/sage/local/lib -L/home/sage/local/lib -Wl,-rpath,/home/sage/local/lib  -pipe -fno-common -g0 -O3 -Wno-unused-function -Wno-trigraphs -Wno-unused-parameter -Wunknown-pragmas -Wno-unused-variable -fomit-frame-pointer -fwrapv -fvisibility=default -finline-functions -fno-exceptions -funroll-loops conftest.c -L/home/sage/local/lib -Wl,-rpath,/home/sage/local/lib -lflint -lmpfr -lgmp -L/home/sage/local/lib -Wl,-rpath,/home/sage/local/lib -lgmp -lpthread  -L/home/sage/local/lib -Wl,-rpath,/home/sage/local/lib -lgmp -lm  >&5
In file included from /home/sage/local/include/flint/nmod_vec.h:29:0,
                 from /home/sage/local/include/flint/fmpz.h:31,
                 from conftest.c:34:
/home/sage/local/include/flint/ulong_extras.h:119:1: error: unknown type name '_Thread_local'
 extern FLINT_TLS_PREFIX ulong * _flint_primes[FLINT_BITS];
 ^
```

Perhaps a too old gcc?


---

Comment by arojas created at 2021-11-21 11:53:32

Besides singular not using flint on trusty, this error shows that there's also an issue in sagelib: `symbolic.expression` uses flint functions (probably via GiNaC) and yet it only links to flint via `SINGULAR_LIBRARIES` (and therefore it underlinks if singular is built without flint). It should be linking to flint directly.


---

Comment by arojas created at 2021-11-21 12:16:45

Replying to [comment:26 arojas]:
> Besides singular not using flint on trusty, this error shows that there's also an issue in sagelib: `symbolic.expression` uses flint functions (probably via GiNaC) and yet it only links to flint via `SINGULAR_LIBRARIES` (and therefore it underlinks if singular is built without flint). It should be linking to flint directly.

Opened #32919 for this


---

Comment by mkoeppe created at 2021-11-21 18:32:05

Replying to [comment:25 arojas]:
> {{{
> configure:24015: gcc -std=gnu11 -o conftest -I/home/sage/local/include/ -I/home/sage/local/include -I/home/sage/local/include -g -O2  -pipe -fno-common -g0 -O3 -Wno-unused-function -Wno-trigraphs -Wno-unused-parameter -Wunknown-pragmas -Wno-unused-variable -fomit-frame-pointer -fwrapv -fvisibility=default -finline-functions -fno-exceptions -funroll-loops  -Wl,-rpath-link,/home/sage/local/lib -L/home/sage/local/lib -Wl,-rpath,/home/sage/local/lib -Wl,-rpath-link,/home/sage/local/lib -L/home/sage/local/lib -Wl,-rpath,/home/sage/local/lib  -pipe -fno-common -g0 -O3 -Wno-unused-function -Wno-trigraphs -Wno-unused-parameter -Wunknown-pragmas -Wno-unused-variable -fomit-frame-pointer -fwrapv -fvisibility=default -finline-functions -fno-exceptions -funroll-loops conftest.c -L/home/sage/local/lib -Wl,-rpath,/home/sage/local/lib -lflint -lmpfr -lgmp -L/home/sage/local/lib -Wl,-rpath,/home/sage/local/lib -lgmp -lpthread  -L/home/sage/local/lib -Wl,-rpath,/home/sage/local/lib -lgmp -lm  >&5
> In file included from /home/sage/local/include/flint/nmod_vec.h:29:0,
>                  from /home/sage/local/include/flint/fmpz.h:31,
>                  from conftest.c:34:
> /home/sage/local/include/flint/ulong_extras.h:119:1: error: unknown type name '_Thread_local'
>  extern FLINT_TLS_PREFIX ulong * _flint_primes[FLINT_BITS];
>  ^
> }}}
> Perhaps a too old gcc?

Yes, it looks like we are running into an old problem, 
https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=203066, "don't use `-std=gnu11` with gcc < 4.9


---

Comment by mkoeppe created at 2021-11-21 18:36:41

It looks like this is showing up now simply because the new singular tarball has been generated with a newer version of autoconf.

Before:

```
Configuring singular-4.2.1.p0
checking for gcc... gcc
checking whether the C compiler works... yes
checking for C compiler default output file name... a.out
checking for suffix of executables... 
checking whether we are cross compiling... no
checking for suffix of object files... o
checking whether we are using the GNU C compiler... yes
checking whether gcc accepts -g... yes
checking for gcc option to accept ISO C89... none needed
```



After:

```
Configuring singular-4.2.1p2
checking for gcc... gcc
checking whether the C compiler works... yes
checking for C compiler default output file name... a.out
checking for suffix of executables... 
checking whether we are cross compiling... no
checking for suffix of object files... o
checking whether the compiler supports GNU C... yes
checking whether gcc accepts -g... yes
checking for gcc option to enable C11 features... -std=gnu11
```



---

Comment by git created at 2021-11-21 20:03:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-21 20:28:39

With this patch for flint, Singular finds it, as tested with `tox -e docker-ubuntu-trusty-standard -- singular`.


---

Comment by mkoeppe created at 2021-11-21 20:28:56

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-11-22 17:56:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slelievre created at 2021-11-26 22:58:04

If it helps I could try this ticket out
on a few machines (Cygwin, Linux, macOS).

For now I can only offer trivial comments
(feel free to disregard them).

I would wrap this long output line:

```diff
         sage: J.hilbert_numerator(algorithm='singular')
-        120*t^33 - 3465*t^32 + 48180*t^31 - 429374*t^30 + 2753520*t^29 - 13522410*t^28 + 52832780*t^27 - 168384150*t^26 + 445188744*t^25 - 987193350*t^24 + 1847488500*t^23 + 1372406746*t^22 - 403422496*t^21 - 8403314*t^20 - 471656596*t^19 + 1806623746*t^18 + 752776200*t^17 + 752776200*t^16 - 1580830020*t^15 + 1673936550*t^14 - 1294246800*t^13 + 786893250*t^12 - 382391100*t^11 + 146679390*t^10 - 42299400*t^9 + 7837830*t^8 - 172260*t^7 - 468930*t^6 + 183744*t^5 - 39270*t^4 + 5060*t^3 - 330*t^2 + 1
+        120*t^33 - 3465*t^32 + 48180*t^31 - 429374*t^30 + 2753520*t^29
+        - 13522410*t^28 + 52832780*t^27 - 168384150*t^26 + 445188744*t^25
+        - 987193350*t^24 + 1847488500*t^23 + 1372406746*t^22 - 403422496*t^21
+        - 8403314*t^20 - 471656596*t^19 + 1806623746*t^18 + 752776200*t^17
+        + 752776200*t^16 - 1580830020*t^15 + 1673936550*t^14 - 1294246800*t^13
+        + 786893250*t^12 - 382391100*t^11 + 146679390*t^10 - 42299400*t^9
+        + 7837830*t^8 - 172260*t^7 - 468930*t^6 + 183744*t^5 - 39270*t^4
+        + 5060*t^3 - 330*t^2 + 1
```

or maybe even rewrite that doctest as:

```diff
-        sage: J.hilbert_numerator(algorithm='singular')
+        sage: p = J.hilbert_numerator(algorithm='singular')
+        sage: p.list()
+        [1, 0, -330, 5060, -39270, 183744, -468930, -172260, 7837830,
+         -42299400, 146679390, -382391100, 786893250, -1294246800,
+         1673936550, -1580830020, 752776200, 752776200, 1806623746,
+         -471656596, -8403314, -403422496, 1372406746, 1847488500,
+         -987193350, 445188744, -168384150, 52832780, -13522410,
+         2753520, -429374, 48180, -3465, 120]
```

whose output I personally find easier to parse visually.

Another wrapping suggestion:

```diff
-        [x + y + 57119*z + 4, y^2 + 3*y + 17220, y*z + ..., 2*y + 158864, z^2 + 17223, 2*z + 41856, 164878]
+        [x + y + 57119*z + 4, y^2 + 3*y + 17220, y*z + ...,
+         2*y + 158864, z^2 + 17223, 2*z + 41856, 164878]
```


Some pep8 whitespace suggestions (the last two occur several times):

```diff
-            n_Delete(&n,r.cf)
+            n_Delete(&n, r.cf)
```



```diff
-                p_SetCoeff(newptemp,n_Copy(p_GetCoeff(p,r),r.cf),r)
+                p_SetCoeff(newptemp, n_Copy(p_GetCoeff(p, r), r.cf), r)
```



```diff
-            p_SetCoeff(p, n_Init(1,_ring.cf), _ring)
+            p_SetCoeff(p, n_Init(1, _ring.cf), _ring)
```



---

Comment by slelievre created at 2021-11-26 22:58:04

Changing keywords from "" to "upgrade, Singular".


---

Comment by mkoeppe created at 2021-11-26 23:04:19

Cygwin testing would be valuable


---

Comment by mkoeppe created at 2021-11-27 19:49:21

Also please feel free to push these edits to the ticket


---

Comment by mkoeppe created at 2021-12-09 21:15:37

Setting to blocker because system singular is already being picked up by our spkg-configure


---

Comment by mkoeppe created at 2021-12-09 21:15:37

Changing priority from major to blocker.


---

Comment by mkoeppe created at 2021-12-17 23:29:58

Let's get this in please


---

Comment by arojas created at 2021-12-17 23:39:00

4.2.1p3 is out including the commit needed for #32959


---

Comment by dimpase created at 2021-12-18 00:08:02

yes, seems like a nice update to get: https://github.com/Singular/Singular/releases/tag/Release-4-2-1p3


---

Comment by git created at 2021-12-18 04:20:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-18 18:49:18

Tests on GH Actions look fine.


---

Comment by dimpase created at 2021-12-22 23:59:52

lgtm


---

Comment by dimpase created at 2021-12-22 23:59:52

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-12-23 00:17:56

Thanks!


---

Comment by vbraun created at 2021-12-28 21:15:55

Resolution: fixed


---

Comment by dimpase created at 2022-01-13 13:34:50

update to 4.3.0 is dealt with on #33160
