# Issue 33351: 15 GLPK doctests failing because "Long-step dual simplex will be used" gets printed

Issue created by migration from https://trac.sagemath.org/ticket/33588

Original creator: slabbe

Original creation time: 2022-03-29 12:54:42

CC:  fbissey

The command

```
sage -tp --long src/sage/geometry/polyhedron/base.py src/sage/numerical/backends/glpk_backend.pyx src/sage/numerical/mip.pyx src/sage/tests/books/computational-mathematics-with-sagemath/lp_doctest.py
```


gives


```
Doctesting 4 files.
sage -t --long --random-seed=35631835319362689698338084947465382717 src/sage/geometry/polyhedron/base.py
**********************************************************************
File "src/sage/geometry/polyhedron/base.py", line 389, in sage.geometry.polyhedron.base.Polyhedron_base.to_linear_program
Failed example:
    lp.solve()                                               # tol 1e-8   # optional - sage.rings.number_field
Expected:
    1.3090169943749475
Got:
    Long-step dual simplex will be used
    1.3090169943749472
**********************************************************************
1 item had failures:
   1 of  32 in sage.geometry.polyhedron.base.Polyhedron_base.to_linear_program
    [324 tests, 1 failure, 11.62 s]
sage -t --long --random-seed=35631835319362689698338084947465382717 src/sage/numerical/backends/glpk_backend.pyx
**********************************************************************
File "src/sage/numerical/backends/glpk_backend.pyx", line 1104, in sage.numerical.backends.glpk_backend.GLPKBackend.solve
Failed example:
    p.solve() # rel tol 100
Expected:
    1
Got:
    Long-step dual simplex will be used
    2.0
**********************************************************************
File "src/sage/numerical/backends/glpk_backend.pyx", line 1111, in sage.numerical.backends.glpk_backend.GLPKBackend.solve
Failed example:
    p.solve() # rel tol 100
Expected:
    1
Got:
    Long-step dual simplex will be used
    24.0
**********************************************************************

[...]

**********************************************************************
File "src/sage/tests/books/computational-mathematics-with-sagemath/lp_doctest.py", line 127, in sage.tests.books.computational-mathematics-with-sagemath.lp_doctest
Failed example:
    p.solve() # abs tol 1e-10
Expected:
    1.4199999999999999
Got:
    Long-step dual simplex will be used
    1.42
**********************************************************************
1 item had failures:
   2 of  69 in sage.tests.books.computational-mathematics-with-sagemath.lp_doctest
    [68 tests, 2 failures, 0.05 s]
----------------------------------------------------------------------
sage -t --long src/sage/geometry/polyhedron/base.py  # 1 doctest failed
sage -t --long src/sage/numerical/backends/glpk_backend.pyx  # 4 doctests failed
sage -t --long src/sage/numerical/mip.pyx  # 8 doctests failed
sage -t --long src/sage/tests/books/computational-mathematics-with-sagemath/lp_doctest.py  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 17.1 seconds
    cpu time: 15.8 seconds
    cumulative wall time: 16.7 seconds
Features detected for doctesting: sage.combinat,sage.graphs,sage.rings.number_field
```



---

Comment by @sheerluck created at 2022-03-29 17:14:47


```
Doctesting 4 files.
sage -t --long --random-seed=19 geometry/polyhedron/base.py
    28 latte_int tests not run
    0 tests not run because we ran out of time
    [320 tests, 31.72 s]
sage -t --long --random-seed=19 numerical/backends/glpk_backend.pyx
    0 tests not run because we ran out of time
    [592 tests, 4.18 s]
sage -t --long --random-seed=19 numerical/mip.pyx
    8 cplex tests not run
    3 gurobi tests not run
    7 not tested tests not run
    0 tests not run because we ran out of time
    [713 tests, 1.60 s]
sage -t --long --random-seed=19 tests/books/computational-mathematics-with-sagemath/lp_doctest.py
    0 tests not run because we ran out of time
    [68 tests, 0.04 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 39.3 seconds
    cpu time: 20.1 seconds
    cumulative wall time: 37.5 seconds
```

but that is `9.6.beta6` + #31962


---

Comment by jhpalmieri created at 2022-03-29 22:39:26

See also #29317, where we solved this problem once before. Is this with a system version of GLPK? I'm not sure why the fix at #29317 is not catching this, in fact.


---

Comment by slabbe created at 2022-03-31 09:38:14

Replying to [comment:3 jhpalmieri]:
> See also #29317, where we solved this problem once before. Is this with a system version of GLPK? I'm not sure why the fix at #29317 is not catching this, in fact.

Yes, it is the glpk from the system:


```
$ grep glpk config.log
## Checking whether SageMath should install SPKG glpk... ##
configure:12313: checking glpk.h usability
configure:12313: checking glpk.h presence
configure:12313: checking for glpk.h
configure:12352: g++ -std=gnu++11 -o conftest    conftest.cpp -lglpk  -lgmp -lm  >&5
configure:12369: result: -lglpk
configure:12374: result: yes. Use system's glpk
configure:12395: will use system package and not install SPKG glpk
configure:12434: result: using glpk from the system
```


This one:


```
$ glpsol -v
GLPSOL: GLPK LP/MIP Solver, v4.65
```



---

Comment by jhpalmieri created at 2022-03-31 16:11:24

As I said, I wonder why the fix from #29317 is not catching this. From `sage.doctest.parsing`:

```
# Version 4.65 of glpk prints the warning "Long-step dual simplex will
# be used" frequently. When Sage uses a system installation of glpk
# which has not been patched, we need to ignore that message.
# See :trac:`29317`.
glpk_simplex_warning_regex = re.compile(r'(Long-step dual simplex will be used)')
```

and then later on, that regular expression should be filtered out.


---

Comment by slabbe created at 2022-04-01 15:28:09

Replying to [comment:6 jhpalmieri]:
> As I said, I wonder why the fix from #29317 is not catching this.

I got it. It is because the `# tol 1e-8` is dealt in the `check_output` method before the glpk regex get replaced.

The following behavior is fine:


```
sage: import doctest
sage: optflag = doctest.NORMALIZE_WHITESPACE|doctest.ELLIPSIS
sage: from sage.doctest.parsing import SageOutputChecker
sage: OC = SageOutputChecker()
sage: OC.check_output('1.3090169943749475','1.3090169943749475',optflag)
True
sage: OC.check_output('1.3090169943749475','ANYTHING1.3090169943749475',optflag)
False
sage: OC.check_output('1.3090169943749475','Long-step dual simplex will be used\n1.3090169943749475',optflag)
True
```


The following is ok as well:


```
sage: from sage.doctest.parsing import SageOutputChecker, SageDocTestParser
sage: import doctest
sage: optflag = doctest.NORMALIZE_WHITESPACE|doctest.ELLIPSIS
sage: DTP = SageDocTestParser(('sage','magma','guava'))
sage: OC = SageOutputChecker()
sage: example = "sage: 1.3090169943749475\n1.3090169943749475"
sage: ex = DTP.parse(example)[1]
sage: ex.want
'1.3090169943749475\n'
sage: OC.check_output(ex.want, '1.3090169943749475', optflag)
True
sage: OC.check_output(ex.want, 'ANYTHING1.3090169943749475', optflag)
False
sage: OC.check_output(ex.want, 'Long-step dual simplex will be used\n1.3090169943749475', optflag)
True
```


The following illustrates the bug (the last line should be True):

```
sage: example = "sage: 1.3090169943749475 # tol 1e-8\n1.3090169943749475"
sage: ex = DTP.parse(example)[1]
sage: ex.sage_source
'1.3090169943749475 # tol 1e-8\n'
sage: ex.want
'1.3090169943749475\n'
sage: OC.check_output(ex.want, '1.3090169943749475', optflag)
True
sage: OC.check_output(ex.want, 'ANYTHING1.3090169943749475', optflag)
False
sage: OC.check_output(ex.want, 'Long-step dual simplex will be used\n1.3090169943749475', optflag)
False
```


Observe that turning `ex.want` back to a string fixes it because I think the return is made in the `if isinstance(want, MarkedOutput):` block within the `check_output` method:


```
sage: type(ex.want)
<class 'sage.doctest.parsing.MarkedOutput'>
sage: sage: OC.check_output(str(ex.want), 'Long-step dual simplex will be used\n1.3090169943749475', optflag)
True
```



---

Comment by mkoeppe created at 2022-04-03 18:57:54

Changing priority from major to critical.


---

Comment by slabbe created at 2022-04-07 15:15:04

Changing status from new to needs_review.


---

Comment by slabbe created at 2022-04-07 15:15:04

I found a way to fix the issue.
----
New commits:


---

Comment by slabbe created at 2022-04-07 15:27:24

The code as it is now works and fixes the issue in the description of this ticket. Doing so, I added a new method `try_fixup` which helps understand what is happening. The way it is written follows how the code was written before. But here are few things that I dislike and that could be improved if reviewers agree:

 - parameter `want` is not changed by `try_fixup`, only `got`, so why should `fixup` take `want` as input?
 - the list `_repr_fixups` is defined in the header of the module but it is used only in the `try_fixup` method. I think it would make sense to remove it from the header and move it down inside the `try_fixup` method. It would make the `try_fixup` method more usable. More precisely, when somethings goes wrong for instance while debugging #33588, it is practical to add few `print` statements to see what is happening but it is quite painful to add a print statement inside of the lambda functions defined in the `_repr_fixups` at the top of the module.
 - Since `_repr_fixups` is defined completely out of context in the top module it comes with 8 lines of documentation painfully explaining what it is. These lines would just disappear by defining them in context inside of the `try_fixup` method.


```python
# Collection of fixups applied in the SageOutputChecker.  Each element in this
# this list a pair of functions applied to the actual test output ('g' for
# "got") and the expected test output ('w' for "wanted").  The first function
# should be a simple fast test on the expected and/or actual output to                 
# determine if a fixup should be applied.  The second function is the actual
# fixup, which is applied if the test function passes.  In most fixups only one
# of the expected or received outputs are normalized, depending on the
# application.                            
_repr_fixups = [                                                          
    (lambda g, w: "Long-step" in g,         
     lambda g, w: (glpk_simplex_warning_regex.sub('', g), w)),
                                  
    (lambda g, w: "dylib" in g,                             
     lambda g, w: (ld_warning_regex.sub('', g), w)),             
                                                                    
    (lambda g, w: "pie being ignored" in g,                              
     lambda g, w: (ld_pie_warning_regex.sub('', g), w))                                          
]    
```


If reviewers agree with me, I will do one more commit improving that.


---

Comment by slabbe created at 2022-04-07 15:27:32

Changing status from needs_review to needs_info.


---

Comment by git created at 2022-04-07 15:34:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2022-04-07 15:35:52

I just added a commit which is unrelated to the question asked in comment:10.


---

Comment by git created at 2022-04-07 16:04:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2022-04-07 16:05:28

Changing status from needs_info to needs_review.


---

Comment by slabbe created at 2022-04-07 16:05:28

While having my head on this part of the code, I decide to answer my comment:10 by YES and I did the latest commit.

Needs review!


---

Comment by git created at 2022-04-07 16:10:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-04-07 16:12:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2022-04-07 16:12:38

Did 2 small changes on the last commit. Now done. Needs review.


---

Comment by jhpalmieri created at 2022-04-07 17:32:27

I don't have time to review this right now, but I agree with your decisions regarding comment:10.


---

Comment by git created at 2022-04-08 08:23:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2022-04-08 08:24:28

I renamed `try_fixup` to `do_fixup` because the following line looks better like this, the same verb is used:

```
did_fixup, want, got = self.do_fixup(want, got)
```



---

Comment by git created at 2022-04-11 07:52:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2022-04-11 07:53:43

I added a commit to fix one patchbot warning:

```
========== blocks ==========
git checkout patchbot/ticket_merged
inside file:  b/src/sage/doctest/parsing.py
@@ -923,41 +919,111 @@ class SageOutputChecker(doctest.OutputChecker):
+        OUTPUT
wrong syntax for blocks (INPUT, OUTPUT, EXAMPLES, NOTE, etc) inserted on 1 non-empty lines
blocks -- 0 seconds
========== end blocks ==========
```



---

Comment by chapoton created at 2022-04-11 09:13:41

Please do not remove `_repr_fixups` and the comments before.

EDIT: Just make that an empty list

Somebody else may need that again at some point.


---

Comment by chapoton created at 2022-04-11 09:15:25

ah, I see, this is more complicated than what I thought. No time to look at that now.


---

Comment by slabbe created at 2022-04-11 10:20:39

It is not so complicated in the end, but it is true that it may look complicated.

Let me update the description of the ticket to better explain the problem and the solution.


---

Comment by git created at 2022-04-11 12:37:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2022-04-11 12:39:14

I removed the commit deleting the `_repr_fixups` as it can be done in a later ticket which will simplify the review of the current ticket.


---

Comment by slabbe created at 2022-04-11 13:03:45

Updated description.


---

Comment by slabbe created at 2022-04-11 13:09:57

Further description improvements.


---

Comment by slabbe created at 2022-04-11 13:13:23

Needs review.


---

Comment by slabbe created at 2022-04-11 13:33:41

Touching the `_repr_fixups` list is now in a follow-up ticket #33680.


---

Comment by slabbe created at 2022-04-18 10:04:13

Changing status from needs_review to needs_work.


---

Comment by slabbe created at 2022-04-18 10:04:13

one patchbot currently says:

```
[sagemath_doc_html-none] Error building the documentation.
[sagemath_doc_html-none] Traceback (most recent call last):
...
[sagemath_doc_html-none] OSError: /home/debian/sage/local/var/lib/sage/
venv-python3.9/lib/python3.9/site-packages/sage/doctest/parsing.py:
docstring of sage.doctest.parsing.SageOutputChecker.check_output:118: 
WARNING: Block quote ends without a blank line; unexpected unindent.
[sagemath_doc_html-none]
```



---

Comment by git created at 2022-04-18 11:01:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2022-04-18 11:06:30

The documentation failure was due to a docstring defined with `"""..."""` as opposed to `r"""..."""`. I added a commit to fix that.

Now rebased on 9.6.rc0.

Also squashed the commit changing name `try_fixup` to `do_fixup` to simplify the review.


---

Comment by slabbe created at 2022-04-18 11:14:34

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2022-04-20 17:54:00

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2022-04-20 17:54:00

This looks good to me.


---

Comment by slabbe created at 2022-04-20 18:23:43

Thank you John!


---

Comment by mkoeppe created at 2022-04-21 07:06:09

Changing priority from critical to blocker.


---

Comment by vbraun created at 2022-04-24 06:31:07

Resolution: fixed
