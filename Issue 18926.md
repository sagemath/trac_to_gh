# Issue 18926: LatticePoset creation: Empty argument, better error reporting

Issue created by migration from Trac.

Original creator: jmantysalo

Original creation time: 2015-09-08 11:38:57

CC:  dkrenn

Because `Poset()` creates the empty poset, I think that `LatticePoset()` should create the empty lattice.

Error reporting is irritating. `LatticePoset({'a':['b','c']})` should say "no top element" of "no join for 'b' and 'c'" or something similar.


---

Comment by git created at 2015-11-13 07:44:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2015-11-13 07:46:32

This is ready for comments, even if it is not ready for review.


---

Comment by git created at 2015-11-13 08:22:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2015-11-24 11:09:54

Jeroen, can you check this until I do more? I.e. is `LatticeMeetException` done as it should?

This is kind of first time when I add something more than new functions to existing classes.


---

Comment by jmantysalo created at 2015-12-11 08:13:27

Replying to [comment:5 jmantysalo]:
> Jeroen, can you check this until I do more? I.e. is `LatticeMeetException` done as it should?

Ping...


---

Comment by git created at 2016-02-10 11:09:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jmantysalo created at 2016-02-10 11:15:16

Changing status from new to needs_review.


---

Comment by jmantysalo created at 2016-02-10 11:15:16

As I got no comments for custom error class, I did this with string manipulation.


---

Comment by jmantysalo created at 2016-02-12 08:27:57

Daniel? This is more trivial than you could think from number of lines.


---

Comment by tscrim created at 2016-02-18 19:06:06

I think this approach of parsing the error message just makes things needlessly more complicated (and takes extra time if you, say, want to check if a set of posets are meet-semilattices). Instead, I would just allow the error from calling `self._hasse_diagram.meet_matrix()` to propagate up.


---

Comment by jmantysalo created at 2016-02-18 20:59:44

Replying to [comment:10 tscrim]:
> I think this approach of parsing the error message just makes things needlessly more complicated (and takes extra time if you, say, want to check if a set of posets are meet-semilattices).

?? Error message is only parsed when there is a message. And to just check use `is_meet_semilattice()`. I can't see how this would slow down anything.

> Instead, I would just allow the error from calling `self._hasse_diagram.meet_matrix()` to propagate up.

It is very irritating if the elements of the lattice are integers. Then we may got error saying that 5 and 8 have no meet, when actually it is 6 and 10 that have no meet.


---

Comment by tscrim created at 2016-02-18 23:24:45

Replying to [comment:11 jmantysalo]:
> Replying to [comment:10 tscrim]:
> > I think this approach of parsing the error message just makes things needlessly more complicated (and takes extra time if you, say, want to check if a set of posets are meet-semilattices).
> 
> ?? Error message is only parsed when there is a message. And to just check use `is_meet_semilattice()`. I can't see how this would slow down anything.

Suppose you iterate over a collection of posets and you want to determine which of them are (semi)lattices. Then for those that are lattices, you do some extra processing on them. Being Pythonic (and to avoid double checking things), you just cast the poset to a lattice and do nothing if an error is thrown. That is where the slowdown comes in.

> > Instead, I would just allow the error from calling `self._hasse_diagram.meet_matrix()` to propagate up.
> 
> It is very irritating if the elements of the lattice are integers. Then we may got error saying that 5 and 8 have no meet, when actually it is 6 and 10 that have no meet.

That is a good point. However, I would much rather have a less informative error message than the (IMO fugly) string parsing code you currently have. It seems like Volker's suggestion of doing a custom error class will be what you want (if you think it is important to see (only) one instance where the lattice property fails).


---

Comment by jmantysalo created at 2016-02-19 08:16:17

Replying to [comment:12 tscrim]:
 
> Suppose you iterate over a collection of posets and you want to determine which of them are (semi)lattices. Then for those that are lattices, you do some extra processing on them. Being Pythonic (and to avoid double checking things), you just cast the poset to a lattice and do nothing if an error is thrown. That is where the slowdown comes in.

You mean something like


```
n = 0
for P in PP:
    try:
        if LatticePoset(P).cardinality() != 0:
            n += 1
    except:
        pass
```


where `PP` is precomputed list of posets. This error reporting is `O(1)` and checking if a poset is lattice is `O(n^2.5)`. So this would be a question only if most posets are non-lattices that are easily recognized (like a poset that is not bounded). I will run some timing on this.

> > > Instead, I would just allow the error from calling `self._hasse_diagram.meet_matrix()` to propagate up.
> > 
> > It is very irritating if the elements of the lattice are integers. Then we may got error saying that 5 and 8 have no meet, when actually it is 6 and 10 that have no meet.
> 
> That is a good point. However, I would much rather have a less informative error message than the (IMO fugly) string parsing code you currently have. It seems like Volker's suggestion of doing a custom error class will be what you want (if you think it is important to see (only) one instance where the lattice property fails).

I guess this conflicts with performance you cared in a paragraph just before this one `:=)`. I suppose creating an object is slower than manipulating a string.

Actually I did a code using specific error class and tried to get comments on it, to be sure that I did nothing stupid. But as I got no comments, I decided to do this in a way that I know to work. (And added tests, so that if somebody changes the error string at `hasse_diagram.py` it will be noticed.)


---

Comment by jmantysalo created at 2016-02-19 09:03:26

I tested with a list of all non-isomorphic posets of 8 elements. There are 16999 of those.

Before the patch it took 0,69 seconds to run my test code for the first time. Second run took 0,39 seconds. After the patch timings were 0,70 and 0,41 second. So this will take something like 15 ms for 15000 posets, i.e. a microsecond per poset. (At i5-3470 CPU `@` 3.20GHz).

I think that this in not too much penalty for better usability.


---

Comment by tscrim created at 2016-02-19 14:58:44

Thanks for doing those timings. I didn't expect too much of a penalty, but if we can have cleaner and less fragile code with extra speed, then why shouldn't we?

I would say the lack of response for your question (if it was "Am I doing something stupid?") is a strong indication that you are not. Personally, I don't think we need to include this in the error message as pdb can be used, but I'm neutral if we add it responsibly.

In more detail, the fragility comes from the fact that we have to rewrite this error message if the underlying error message changes wording. By having a custom class, it means we can easily change the message without having to rewrite this (essentially unrelated) code.

Also, the `int(error.message.split()[3][2:])` creates many, many new transient objects: the `split`, in and of itself, creates a new list, plus the `int`, plus each of the strings in the split. However I was thinking of doing a catch-and-release with the error message by simply updating the two elements of said message. So the error class would look something like this:

```python
class LatticeException(ValueError):
    def __init__(self, fail, x, y):
        ValueError.__init__(self, None)
        self.fail = fail
        self.x = x
        self.y = y
    def __str__(self):
        return "no {} for {} and {}".format(self.fail, self.x, self.y)
```

The result would look like this:

```
sage: raise LatticeException('meet', 5, 2)
---------------------------------------------------------------------------
LatticeException                          Traceback (most recent call last)
<ipython-input-20-626aad3b7a17> in <module>()
----> 1 raise LatticeException('meet', Integer(5), Integer(2))

LatticeException: no meet for 5 and 2
```



---

Comment by jmantysalo created at 2016-02-19 16:22:25

Replying to [comment:15 tscrim]:

> I would say the lack of response for your question (if it was "Am I doing something stupid?") is a strong indication that you are not.

No. I do not trust silence being acception.

But see my commit on comment number 3. I guess it was something like what you suggested.

> In more detail, the fragility comes from the fact that we have to rewrite this error message if the underlying error message changes wording.

That's why I added tests. We could also add a comment to the code raising exception in `_meet()` and `_join()`.

> Also, the `int(error.message.split()[3][2:])` creates many, many new transient objects: the `split`, in and of itself, creates a new list, plus the `int`, plus each of the strings in the split.

Maybe I can optimize if, it one microsecond is too much...


---

Comment by tscrim created at 2016-02-19 16:45:30

Replying to [comment:16 jmantysalo]:
> Replying to [comment:15 tscrim]:
> > I would say the lack of response for your question (if it was "Am I doing something stupid?") is a strong indication that you are not.
> 
> No. I do not trust silence being acception.
> 
> But see my commit on comment number 3. I guess it was something like what you suggested.

Then consider this as acceptance of doing a custom error message (along with Volker's comment on the sage-devel thread).


---

Comment by tscrim created at 2016-02-19 16:48:34

Replying to [comment:16 jmantysalo]:
> Replying to [comment:15 tscrim]:
> > In more detail, the fragility comes from the fact that we have to rewrite this error message if the underlying error message changes wording.
> 
> That's why I added tests. We could also add a comment to the code raising exception in `_meet()` and `_join()`.

It's not about the tests; it is about the fact you have to change code in the frontend class anytime you change this error message in the backend. An analogy would be like you changed the background color attribute in a css file, but now you have to change html code of the webpage because of that.

> > Also, the `int(error.message.split()[3][2:])` creates many, many new transient objects: the `split`, in and of itself, creates a new list, plus the `int`, plus each of the strings in the split.
> 
> Maybe I can optimize if, it one microsecond is too much...

That was mainly as a counterpoint to your statement creating objects is more costly than string parsing. I strongly believe string parsing is an evil practice. The fact that it is (micro) slower is just a small part of that belief. The much bigger issue is the readability, extendability, and fragility of the code.


---

Comment by git created at 2016-02-24 11:14:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2016-02-24 11:15:04

Doctests on `hasse_diagram.py` must be corrected, but otherwise this is ready for comments.


---

Comment by jmantysalo created at 2016-02-24 11:15:04

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-02-24 14:22:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2016-02-24 14:33:51

Changing status from needs_work to needs_review.


---

Comment by jmantysalo created at 2016-02-24 14:33:51

Doctests corrected.


---

Comment by tscrim created at 2016-02-24 15:31:58

Thank you for making the changes; it definitely improves the code. A few comments:

- Move the comment before `LatticeException` as the docstring for that class so it is visible in the doc.
- Could be bikeshedding, but I'm thinking we should call it `LatticeError` since it is inheriting from `ValueError`. 
- Make the default value for `x` and `y` in `LatticeException` to be `None`.
- All methods need doctests, this includes those for the exceptions
- I would consider making the no top/bottom errors just raise `ValueError`. Granted, this won't look as slick when the error gets reported, but it will be cleaner code. (This would mean we don't need default values for `LatticeException`.) IMO this is also okay since `LatticeException` inherits from `ValueError`.
- The errors are not sentences, so they should start with a lowercase letter.
- I would do:
  {{{#!python
  try:
      P._hasse_diagram.meet_matrix()
  except LatticeException as error:
      error.x = P._vertex_to_element(error.x)
      error.y = P._vertex_to_element(error.y)
      raise
  }}}
- Unrelated but I noticed it because there were changes made. I would do this:
  {{{#!diff
-if isinstance(data,FiniteLatticePoset) and len(args) == 0 and len(options) == 0:
+if (isinstance(data, FiniteLatticePoset) and not args and not options):
  }}}
  as it is the fastest way to check for emptiness.


---

Comment by jmantysalo created at 2016-02-24 17:45:28

Replying to [comment:23 tscrim]:

> - I would consider making the no top/bottom errors just raise `ValueError`. Granted, this won't look as slick when the error gets reported, but it will be cleaner code. (This would mean we don't need default values for `LatticeException`.) IMO this is also okay since `LatticeException` inherits from `ValueError`.

But then I guess that `LatticePoset(P)` could say "not a _semi_lattice", assuming that I don't check the error string. Is that bad? Not that much, but...?


---

Comment by git created at 2016-02-25 07:19:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2016-02-25 07:21:42

I did some changes. But I got strange error from `make`:


```
[polynomia] build succeeded.
Error building the documentation.
Traceback (most recent call last):
  File "/home/jm58660/sage/local/lib/python/runpy.py", line 162, in _run_module_as_main
    "__main__", fname, loader, pkg_name)
  File "/home/jm58660/sage/local/lib/python/runpy.py", line 72, in _run_code
    exec code in run_globals
  File "/home/jm58660/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
    main()
  File "/home/jm58660/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 1620, in main
    builder()
  File "/home/jm58660/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 280, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/home/jm58660/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 491, in _wrapper
    x.get(99999)
  File "/home/jm58660/sage/local/lib/python/multiprocessing/pool.py", line 567, in get
    raise self._value
AttributeError: 'module' object has no attribute 'has'
make[2]: *** [doc-html] Error 1
```


Any ideas?


---

Comment by jmantysalo created at 2016-03-03 07:27:08

Replying to [comment:24 jmantysalo]:

Just pinging for this question:

> But then I guess that `LatticePoset(P)` could say "not a _semi_lattice", assuming that I don't check the error string. Is that bad? Not that much, but...?


---

Comment by jmantysalo created at 2016-04-12 08:12:25

Ping.


---

Comment by tscrim created at 2016-04-13 13:47:32

Replying to [comment:27 jmantysalo]:
> Replying to [comment:24 jmantysalo]:
> 
> Just pinging for this question:
> 
> > But then I guess that `LatticePoset(P)` could say "not a _semi_lattice", assuming that I don't check the error string. Is that bad? Not that much, but...?

Well, perhaps just have `x` and `y` be default to `None` in the exception `__init__`, but it contradicts your docstring for `LatticeError`. Moreover, I still think you should let that propagate up rather than creating a completely new error message.


---

Comment by jmantysalo created at 2016-04-27 08:14:27

Needs thinking. I put this to _needs_work_ to see what tickets are really just waiting for a review.


---

Comment by jmantysalo created at 2016-04-27 08:14:27

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-07-18 08:42:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jmantysalo created at 2016-07-18 08:49:07

Changing priority from minor to major.


---

Comment by jmantysalo created at 2016-07-18 08:49:07

Changing status from needs_work to needs_review.


---

Comment by jmantysalo created at 2016-07-18 08:49:07

OK, this was actually quite simple after thinking. Also I found an error in the process.


---

Comment by tscrim created at 2016-07-18 14:42:48

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2016-07-18 14:42:48

Replying to [comment:29 tscrim]:
> Moreover, I still think you should let that propagate up rather than creating a completely new error message.

This is still an issue, both for readability and performance. I can write a modified version if you want.


---

Comment by jmantysalo created at 2016-07-18 16:06:10

Replying to [comment:33 tscrim]:
> Replying to [comment:29 tscrim]:
> > Moreover, I still think you should let that propagate up rather than creating a completely new error message.
> 
> This is still an issue, both for readability and performance. I can write a modified version if you want.

Please do so, as I think that I don't understand what you mean.


---

Comment by jmantysalo created at 2016-08-13 04:42:09

Replying to [comment:34 jmantysalo]:
> Replying to [comment:33 tscrim]:
> > Replying to [comment:29 tscrim]:
> > > Moreover, I still think you should let that propagate up rather than creating a completely new error message.
> > 
> > This is still an issue, both for readability and performance. I can write a modified version if you want.
> 
> Please do so, as I think that I don't understand what you mean.

Just pingin this.


---

Comment by jmantysalo created at 2016-09-14 08:15:23

Another ping. I don't get what you suggest until I see a code or at least a pseudocode.


---

Comment by tscrim created at 2016-09-14 14:06:04

Sorry it took so long, kept having other things come up. Here is what I am suggesting, where we don't recreate the error, just trap it long enough to change the element labels.
----
New commits:


---

Comment by tscrim created at 2016-09-14 14:06:04

Changing status from needs_work to needs_review.


---

Comment by jmantysalo created at 2016-09-14 16:53:38

Now I understand: Green solution, recycling of error message!

Also test passed, and I manually checked meet- and join-semilattices. Hence positive review.

Replying to [comment:37 tscrim]:

> Sorry it took so long

No horry. I have said to some developer (you?) earlier: it took about 2000 years to proof that squaring a circle is impossible. So there is no horry, this is mathematics.


---

Comment by jmantysalo created at 2016-09-14 16:53:38

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-09-17 15:25:51

Resolution: fixed
