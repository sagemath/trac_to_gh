# Issue 14160: The jmol spkg contains testjava.sh

Issue created by migration from https://trac.sagemath.org/ticket/14364

Original creator: Snark

Original creation time: 2013-03-27 08:30:24

Assignee: tbd

CC:  gutow

This script would be better in the sage-scripts spkg, as it's sage-specific, probably as sage-testjava.sh or some such. The change will break one doctest in devel/sage/sage/interfaces/jmoldata.py, where it is looking for it using the full path.


---

Comment by gutow created at 2013-03-27 16:38:13

I would argue the move is only appropriate if any other package in Sage depends on java.  To my knowledge, nothing in the base install other than Jmol does.


---

Comment by Snark created at 2013-03-27 16:40:37

You can argue like that if you want, but jmol doesn't use testjava.sh -- devel/sage/sage/interfaces/jmoldata.py does. So I argue that only sage depends on it, and I stand by my report! :-P


---

Comment by gutow created at 2013-03-27 16:48:59

Replying to [comment:3 Snark]:
> You can argue like that if you want, but jmol doesn't use testjava.sh -- devel/sage/sage/interfaces/jmoldata.py does. So I argue that only sage depends on it, and I stand by my report! :-P
You have a good point.  Since Sage depends on Jmol, this will always be available if Jmol needs it...I'll put this on my list as I try to incorporate the pure javascript version of Jmol for the notebook.


---

Comment by Snark created at 2013-05-25 12:49:36

What's the status of this?


---

Comment by gutow created at 2013-05-26 00:36:09

Replying to [comment:5 Snark]:
> What's the status of this?
I'm swamped...I am hoping to spend more time on this starting next month, but I have equipment (spectrometers, vacuum lines, computers, etc..to get fixed for next Fall's classes), and some web site programming for use at my University to finish before I can get to this.  Sorry, for the delay.  I definitely have not forgot about this.
JG


---

Comment by strogdon created at 2013-10-09 22:13:08

Is there any interest in moving the functionality of `testjava.sh` into `jmoldata.py`? I'm not sure what is easiest to maintain, but I believe the following will work.


```diff
--- a/sage/interfaces/jmoldata.py
+++ b/sage/interfaces/jmoldata.py
@@ -86,13 +86,23 @@
             sage_makedirs(jmolscratch)
         scratchout = os.path.join(jmolscratch,"jmolout.txt")
         jout=open(scratchout,'w')
-        testjavapath = os.path.join(SAGE_LOCAL, "share", "jmol", "testjava.sh")
-        result = subprocess.call([testjavapath],stdout=jout)
-        jout.close()
-        if (result == 0):
-            return (True)
-        else:
-            return (False)
+        try:
+            version = subprocess.check_output(['java', '-version'], stderr=subprocess.STDOUT)
+            import re, types
+            java_version = re.search("version.*[1]\.[567]", version)
+            if type(java_version) is types.NoneType:
+                jout.write('Your version of Java is either deprecated or not supported\nWe support versions 1.5 to 1.7\n')
+                jout.close()
+                result = bool(java_version)
+            else:
+                jout.write('You have a supported version of Java, Exiting\n')
+                jout.close()
+                result = bool(java_version)
+        except (subprocess.CalledProcessError, OSError):
+            jout.write('You do not have Java installed\nWe support versions 1.5 to 1.7\n')
+            jout.close()
+            result = False
+        return result

     def export_image(self,
         targetfile,
@@ -183,7 +193,7 @@
             if not os.path.exists(jmolscratch):
                 sage_makedirs(jmolscratch)
             scratchout = os.path.join(jmolscratch,"jmolout.txt")
-            jout=open(scratchout,'w')
+            jout=open(scratchout,'a')
             #now call the java application and write the file.
             result = subprocess.call(["java","-Xmx512m","-Djava.awt.headless=true","-jar",jmolpath,"-iox","-g",sizeStr,"-J",launchscript,"-j",imagescript],stdout=jout)
             jout.close()

```



---

Comment by jhpalmieri created at 2013-10-09 22:27:57

This idea was also discussed [earlier](http://trac.sagemath.org/ticket/12299#comment:159).


---

Comment by strogdon created at 2013-10-09 22:36:46

Replying to [comment:9 jhpalmieri]:

> This idea was also discussed [earlier](http://trac.sagemath.org/ticket/12299#comment:159) .
And the ideas are really yours.


---

Comment by jhpalmieri created at 2013-10-09 22:39:06

I think a lot of people had ideas about this, in fact.


---

Comment by gutow created at 2013-10-10 13:08:35

I wrote the original code and think this is a good idea.  I did try to make it work that way originally, but ran into some problems, I believe with escaping of quotations.  I will try to test this soon and encourage others to as well.  If we can give it a positive review it is one less file to keep up-to-date.


---

Comment by jdemeyer created at 2013-12-11 15:00:23

strongdon: I'm making an actual patch based on your suggestion. I don't see the need to write to `jmolout.txt` though...


---

Attachment


---

Comment by strogdon created at 2013-12-30 04:48:07

Attempting to push the ```14364_testjava.patchâ€‹``` to the Git Server. Let's hope this works!
----
New commits:


---

Comment by jdemeyer created at 2013-12-30 10:35:18

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2013-12-30 10:58:17

New commits:


---

Comment by leif created at 2014-06-12 08:29:06

[ping]

Is there anything to test beyond (re)installing the spkg and testing `src/sage/interfaces/jmoldata.py`?

If not, works for me...


---

Comment by Snark created at 2014-06-13 16:51:28

Ok, I was finally able to test, and it works.

I think reinstalling the spkg won't do the trick for a review, because you'll still have testjava.sh from the previous installation (sage-as-a-distribution doesn't have uninstallation if I don't err). And you'll also need to recompile the sagelib since one of the files has been modified.


---

Comment by Snark created at 2014-06-13 16:51:28

Changing status from needs_review to positive_review.


---

Comment by gutow created at 2014-06-13 19:13:13

Hmm...maybe I need to include this in the updated jmol.spkg I'm building? I expect to have some time to devote to that over the next few days.  I'll try plugging this into the new code.

Replying to [comment:23 Snark]:
> Ok, I was finally able to test, and it works.
> 
> I think reinstalling the spkg won't do the trick for a review, because you'll still have testjava.sh from the previous installation (sage-as-a-distribution doesn't have uninstallation if I don't err). And you'll also need to recompile the sagelib since one of the files has been modified.


---

Comment by Snark created at 2014-06-13 20:13:26

The fix for this ticket is two patches:
 * one to detect java directly in sagelib ;
 * the other to remove testjava.sh from the build/pkgs/jmol/ data.

If they go in, doesn't it update things (in particular the spkg) correctly and automatically?


---

Comment by gutow created at 2014-06-13 21:50:26

I believe so, but if I do not fix the updated .spkg it may reinstall testjava.sh, although it would not get used.  I will make sure my update is compatible.  I too think this ticket is fine.  I just have to make my end work well with it.

Replying to [comment:25 Snark]:

> If they go in, doesn't it update things (in particular the spkg) correctly and automatically?


---

Comment by vbraun created at 2014-06-15 15:24:21

Resolution: fixed
