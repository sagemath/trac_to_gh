# Issue 22838: copy(CombinatorialFreeModule.Element) broken by #22632

Issue created by migration from https://trac.sagemath.org/ticket/23075

Original creator: cnassau

Original creation time: 2017-05-25 10:43:22

CC:  nthiery jdemeyer chapoton tscrim @mjungmath

The following problem showed up with 8.0.beta8: the copy of an IndexedFreeModuleElement seems to be not functional:

```sage
sage: F=CombinatorialFreeModule(ZZ,ZZ)
sage: a=F.an_element() ; a
3*B[-1] + B[0] + 3*B[1]
sage: copy(a)
<repr(<sage.combinat.free_module.CombinatorialFreeModule_with_category.element_class at 0x7f5d735e7808>) failed: AttributeError: 'NoneType' object has no attribute 'items'>
sage: type(copy(a)._monomial_coefficients)
<type 'NoneType'>
```



---

Comment by nthiery created at 2017-05-25 10:48:29

Thanks for the report.

Hmm, that's due to the fact that _monomial_coefficients is a Cython attribute now, so not automatically copied. So we need a custom `copy` method. We have to decide whether we want `copy(x)` to just return `x` (since it's supposed to be immutable) or really make a copy.

What's the use case where this showed up?


---

Comment by cnassau created at 2017-05-25 11:18:30

Replying to [comment:1 nthiery]:
> What's the use case where this showed up?

I was reparenting an element from one module to a slightly altered clone of its parent (so I was probably violating the immutability assumption regarding elements, of which I was unaware). My code was similar to this:

```sage
def corresponding_element_in_clone(parent,elem):
   N = parent.create_modified_clone(parent)
   x = copy(elem)
   x._set_parent(N)
   return x
```

Using "deepcopy" seems to still work.


---

Comment by tscrim created at 2017-05-25 21:22:40

Changing component from PLEASE CHANGE to combinatorics.


---

Comment by tscrim created at 2017-05-25 21:22:40

Well, I would say yes and no. By copying the object, you're going around the immutability by making a temporarily mutable object. This isn't quite your question, but if you wanted to (safely) manipulate the underlying `dict`, you could get get a copy by calling `d = x.monomial_coefficients()`, mutating that, and then `F._from_dict(d)` (with appropriate options, probably `coerce=False` and `remove_zeros=False`). Yet, you're not changing the "defining" information of the object, just what parent it is associated to. So you could do `x.monomial_coefficients(copy=False)` to get the underlying `dict` and then do the `F._from_dict(d)`. In the abstract, this should be just as fast, and is the (IMO) correct way to do it.

However, the fact that `copy` fails is not good. I would say `copy(x) is x` should be `True` in this case because it is only an immutable object.


---

Comment by nthiery created at 2017-05-28 22:54:52

Thanks for the feedback. I agree with Travis. Let's go for an idempotent copy operator. Do you see a natural place to advertise that the elements are immutable?


---

Comment by tscrim created at 2017-05-29 20:55:10

For the most part, elements in Sage are considered immutable so we can do hashing, but I guess this conflicts with the rest of the linear algebra in Sage. So I would put a small note/example in the `IndexedFreeModuleElement` class doc.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2022-08-28 04:45:03

Still broken in 9.7.beta8


---

Comment by @sheerluck created at 2022-08-28 06:57:42


```diff
--- a/src/sage/combinat/free_module.py
+++ b/src/sage/combinat/free_module.py
@@ -358,10 +358,12 @@
             sage: A.__class__.element_class.__module__
             'sage.combinat.free_module'
         """
-        return self.__make_element_class__(self.Element,
+        cls = self.__make_element_class__(self.Element,
                                            name="%s.element_class" % self.__class__.__name__,
                                            module=self.__class__.__module__,
                                            inherit=True)
+        setattr(cls, '__copy__', lambda x: x)
+        return cls

     def __init__(self, R, basis_keys=None, element_class=None, category=None,
                  prefix=None, names=None, **kwds):
```



---

Comment by tscrim created at 2022-08-29 01:00:18

Very strong -1 on the comment:12 proposal. It is a hack and only applies to `CFM` elements.

I think it should be sufficient to do

```
def __copy__(self):
    return self
def __deepcopy__(self):
    return self
```

in `IndexedFreeModuleElement`. Although perhaps the `__deepcopy__` can actually copy the dictionary (to be more in line with copy vs deepcopy).


---

Comment by mkoeppe created at 2022-08-29 01:01:54

Are CFM elements immutable?


---

Comment by tscrim created at 2022-08-29 01:03:35

Yes, like most (all?) other elements in Sage (other than matrices, vectors, and (di)graphs).


---

Comment by mkoeppe created at 2022-08-29 01:04:51

Then `__deepcopy__` should not copy anything either


---

Comment by tscrim created at 2022-08-29 01:21:41

Here are the methods. I am now leaning towards not really saying anything because it doesn't implement any of the other mutability operations than `vector` has. This would also be consistent with the linear morphisms code too.
----
New commits:


---

Comment by tscrim created at 2022-08-29 01:21:41

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-08-29 01:23:56

Looking good, with the nitpick that "copy" is not only idempotent here but actually the identity.


---

Comment by git created at 2022-08-29 01:33:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-08-29 01:33:26

Replying to [comment:19 mkoeppe]:
> Looking good, with the nitpick that "copy" is not only idempotent here but actually the identity.

Fair enough. I have changed it.


---

Comment by mkoeppe created at 2022-08-29 01:34:36

just waiting for a green bot


---

Comment by mkoeppe created at 2022-08-29 05:58:48

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2022-08-29 06:06:09

Thank you.


---

Comment by vbraun created at 2022-08-30 06:51:58

Resolution: fixed
