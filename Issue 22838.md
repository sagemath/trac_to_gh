# Issue 22838: copy(CombinatorialFreeModule.Element) broken by #22632

archive/issues_022838.json:
```json
{
    "body": "CC:  @nthiery @jdemeyer @fchapoton @tscrim @mjungmath\n\nThe following problem showed up with 8.0.beta8: the copy of an IndexedFreeModuleElement seems to be not functional:\n\n```sage\nsage: F=CombinatorialFreeModule(ZZ,ZZ)\nsage: a=F.an_element() ; a\n3*B[-1] + B[0] + 3*B[1]\nsage: copy(a)\n<repr(<sage.combinat.free_module.CombinatorialFreeModule_with_category.element_class at 0x7f5d735e7808>) failed: AttributeError: 'NoneType' object has no attribute 'items'>\nsage: type(copy(a)._monomial_coefficients)\n<type 'NoneType'>\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/23075\n\n",
    "created_at": "2017-05-25T10:43:22Z",
    "labels": [
        "component: please change",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.7",
    "title": "copy(CombinatorialFreeModule.Element) broken by #22632",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22838",
    "user": "https://github.com/cnassau"
}
```
CC:  @nthiery @jdemeyer @fchapoton @tscrim @mjungmath

The following problem showed up with 8.0.beta8: the copy of an IndexedFreeModuleElement seems to be not functional:

```sage
sage: F=CombinatorialFreeModule(ZZ,ZZ)
sage: a=F.an_element() ; a
3*B[-1] + B[0] + 3*B[1]
sage: copy(a)
<repr(<sage.combinat.free_module.CombinatorialFreeModule_with_category.element_class at 0x7f5d735e7808>) failed: AttributeError: 'NoneType' object has no attribute 'items'>
sage: type(copy(a)._monomial_coefficients)
<type 'NoneType'>
```


Issue created by migration from https://trac.sagemath.org/ticket/23075





---

archive/issue_comments_319004.json:
```json
{
    "body": "Thanks for the report.\n\nHmm, that's due to the fact that _monomial_coefficients is a Cython attribute now, so not automatically copied. So we need a custom `copy` method. We have to decide whether we want `copy(x)` to just return `x` (since it's supposed to be immutable) or really make a copy.\n\nWhat's the use case where this showed up?",
    "created_at": "2017-05-25T10:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319004",
    "user": "https://github.com/nthiery"
}
```

Thanks for the report.

Hmm, that's due to the fact that _monomial_coefficients is a Cython attribute now, so not automatically copied. So we need a custom `copy` method. We have to decide whether we want `copy(x)` to just return `x` (since it's supposed to be immutable) or really make a copy.

What's the use case where this showed up?



---

archive/issue_comments_319005.json:
```json
{
    "body": "Replying to [comment:1 nthiery]:\n> What's the use case where this showed up?\n\nI was reparenting an element from one module to a slightly altered clone of its parent (so I was probably violating the immutability assumption regarding elements, of which I was unaware). My code was similar to this:\n\n```sage\ndef corresponding_element_in_clone(parent,elem):\n   N = parent.create_modified_clone(parent)\n   x = copy(elem)\n   x._set_parent(N)\n   return x\n```\n\nUsing \"deepcopy\" seems to still work.",
    "created_at": "2017-05-25T11:18:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319005",
    "user": "https://github.com/cnassau"
}
```

Replying to [comment:1 nthiery]:
> What's the use case where this showed up?

I was reparenting an element from one module to a slightly altered clone of its parent (so I was probably violating the immutability assumption regarding elements, of which I was unaware). My code was similar to this:

```sage
def corresponding_element_in_clone(parent,elem):
   N = parent.create_modified_clone(parent)
   x = copy(elem)
   x._set_parent(N)
   return x
```

Using "deepcopy" seems to still work.



---

archive/issue_comments_319006.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to combinatorics.",
    "created_at": "2017-05-25T21:22:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319006",
    "user": "https://github.com/tscrim"
}
```

Changing component from PLEASE CHANGE to combinatorics.



---

archive/issue_comments_319007.json:
```json
{
    "body": "Well, I would say yes and no. By copying the object, you're going around the immutability by making a temporarily mutable object. This isn't quite your question, but if you wanted to (safely) manipulate the underlying `dict`, you could get get a copy by calling `d = x.monomial_coefficients()`, mutating that, and then `F._from_dict(d)` (with appropriate options, probably `coerce=False` and `remove_zeros=False`). Yet, you're not changing the \"defining\" information of the object, just what parent it is associated to. So you could do `x.monomial_coefficients(copy=False)` to get the underlying `dict` and then do the `F._from_dict(d)`. In the abstract, this should be just as fast, and is the (IMO) correct way to do it.\n\nHowever, the fact that `copy` fails is not good. I would say `copy(x) is x` should be `True` in this case because it is only an immutable object.",
    "created_at": "2017-05-25T21:22:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319007",
    "user": "https://github.com/tscrim"
}
```

Well, I would say yes and no. By copying the object, you're going around the immutability by making a temporarily mutable object. This isn't quite your question, but if you wanted to (safely) manipulate the underlying `dict`, you could get get a copy by calling `d = x.monomial_coefficients()`, mutating that, and then `F._from_dict(d)` (with appropriate options, probably `coerce=False` and `remove_zeros=False`). Yet, you're not changing the "defining" information of the object, just what parent it is associated to. So you could do `x.monomial_coefficients(copy=False)` to get the underlying `dict` and then do the `F._from_dict(d)`. In the abstract, this should be just as fast, and is the (IMO) correct way to do it.

However, the fact that `copy` fails is not good. I would say `copy(x) is x` should be `True` in this case because it is only an immutable object.



---

archive/issue_comments_319008.json:
```json
{
    "body": "Thanks for the feedback. I agree with Travis. Let's go for an idempotent copy operator. Do you see a natural place to advertise that the elements are immutable?",
    "created_at": "2017-05-28T22:54:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319008",
    "user": "https://github.com/nthiery"
}
```

Thanks for the feedback. I agree with Travis. Let's go for an idempotent copy operator. Do you see a natural place to advertise that the elements are immutable?



---

archive/issue_comments_319009.json:
```json
{
    "body": "For the most part, elements in Sage are considered immutable so we can do hashing, but I guess this conflicts with the rest of the linear algebra in Sage. So I would put a small note/example in the `IndexedFreeModuleElement` class doc.",
    "created_at": "2017-05-29T20:55:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319009",
    "user": "https://github.com/tscrim"
}
```

For the most part, elements in Sage are considered immutable so we can do hashing, but I guess this conflicts with the rest of the linear algebra in Sage. So I would put a small note/example in the `IndexedFreeModuleElement` class doc.



---

archive/issue_comments_319010.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319010",
    "user": "https://github.com/mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_319011.json:
```json
{
    "body": "Still broken in 9.7.beta8",
    "created_at": "2022-08-28T04:45:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319011",
    "user": "https://github.com/mkoeppe"
}
```

Still broken in 9.7.beta8



---

archive/issue_comments_319012.json:
```json
{
    "body": "\n```diff\n--- a/src/sage/combinat/free_module.py\n+++ b/src/sage/combinat/free_module.py\n@@ -358,10 +358,12 @@\n             sage: A.__class__.element_class.__module__\n             'sage.combinat.free_module'\n         \"\"\"\n-        return self.__make_element_class__(self.Element,\n+        cls = self.__make_element_class__(self.Element,\n                                            name=\"%s.element_class\" % self.__class__.__name__,\n                                            module=self.__class__.__module__,\n                                            inherit=True)\n+        setattr(cls, '__copy__', lambda x: x)\n+        return cls\n\n     def __init__(self, R, basis_keys=None, element_class=None, category=None,\n                  prefix=None, names=None, **kwds):\n```\n",
    "created_at": "2022-08-28T06:57:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319012",
    "user": "https://github.com/sheerluck"
}
```


```diff
--- a/src/sage/combinat/free_module.py
+++ b/src/sage/combinat/free_module.py
@@ -358,10 +358,12 @@
             sage: A.__class__.element_class.__module__
             'sage.combinat.free_module'
         """
-        return self.__make_element_class__(self.Element,
+        cls = self.__make_element_class__(self.Element,
                                            name="%s.element_class" % self.__class__.__name__,
                                            module=self.__class__.__module__,
                                            inherit=True)
+        setattr(cls, '__copy__', lambda x: x)
+        return cls

     def __init__(self, R, basis_keys=None, element_class=None, category=None,
                  prefix=None, names=None, **kwds):
```




---

archive/issue_comments_319013.json:
```json
{
    "body": "Very strong -1 on the comment:12 proposal. It is a hack and only applies to `CFM` elements.\n\nI think it should be sufficient to do\n\n```\ndef __copy__(self):\n    return self\ndef __deepcopy__(self):\n    return self\n```\n\nin `IndexedFreeModuleElement`. Although perhaps the `__deepcopy__` can actually copy the dictionary (to be more in line with copy vs deepcopy).",
    "created_at": "2022-08-29T01:00:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319013",
    "user": "https://github.com/tscrim"
}
```

Very strong -1 on the comment:12 proposal. It is a hack and only applies to `CFM` elements.

I think it should be sufficient to do

```
def __copy__(self):
    return self
def __deepcopy__(self):
    return self
```

in `IndexedFreeModuleElement`. Although perhaps the `__deepcopy__` can actually copy the dictionary (to be more in line with copy vs deepcopy).



---

archive/issue_comments_319014.json:
```json
{
    "body": "Are CFM elements immutable?",
    "created_at": "2022-08-29T01:01:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319014",
    "user": "https://github.com/mkoeppe"
}
```

Are CFM elements immutable?



---

archive/issue_comments_319015.json:
```json
{
    "body": "Yes, like most (all?) other elements in Sage (other than matrices, vectors, and (di)graphs).",
    "created_at": "2022-08-29T01:03:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319015",
    "user": "https://github.com/tscrim"
}
```

Yes, like most (all?) other elements in Sage (other than matrices, vectors, and (di)graphs).



---

archive/issue_comments_319016.json:
```json
{
    "body": "Then `__deepcopy__` should not copy anything either",
    "created_at": "2022-08-29T01:04:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319016",
    "user": "https://github.com/mkoeppe"
}
```

Then `__deepcopy__` should not copy anything either



---

archive/issue_comments_319017.json:
```json
{
    "body": "Here are the methods. I am now leaning towards not really saying anything because it doesn't implement any of the other mutability operations than `vector` has. This would also be consistent with the linear morphisms code too.\n----\nNew commits:",
    "created_at": "2022-08-29T01:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319017",
    "user": "https://github.com/tscrim"
}
```

Here are the methods. I am now leaning towards not really saying anything because it doesn't implement any of the other mutability operations than `vector` has. This would also be consistent with the linear morphisms code too.
----
New commits:



---

archive/issue_comments_319018.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-08-29T01:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319018",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_319019.json:
```json
{
    "body": "Looking good, with the nitpick that \"copy\" is not only idempotent here but actually the identity.",
    "created_at": "2022-08-29T01:23:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319019",
    "user": "https://github.com/mkoeppe"
}
```

Looking good, with the nitpick that "copy" is not only idempotent here but actually the identity.



---

archive/issue_comments_319020.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-29T01:33:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319020",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_319021.json:
```json
{
    "body": "Replying to [comment:19 mkoeppe]:\n> Looking good, with the nitpick that \"copy\" is not only idempotent here but actually the identity.\n\nFair enough. I have changed it.",
    "created_at": "2022-08-29T01:33:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319021",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:19 mkoeppe]:
> Looking good, with the nitpick that "copy" is not only idempotent here but actually the identity.

Fair enough. I have changed it.



---

archive/issue_comments_319022.json:
```json
{
    "body": "just waiting for a green bot",
    "created_at": "2022-08-29T01:34:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319022",
    "user": "https://github.com/mkoeppe"
}
```

just waiting for a green bot



---

archive/issue_comments_319023.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-08-29T05:58:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319023",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_319024.json:
```json
{
    "body": "Thank you.",
    "created_at": "2022-08-29T06:06:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319024",
    "user": "https://github.com/tscrim"
}
```

Thank you.



---

archive/issue_comments_319025.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-08-30T06:51:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22838#issuecomment-319025",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_021463.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2022-08-30T06:51:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/22838",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/22838#event-21463"
}
```
