# Issue 22854: preparsing breaks from __future__ import directives

archive/issues_022854.json:
```json
{
    "body": "\n```\n~/tmp$ cat > foo.sage\nfrom __future__ import print_function\n~/tmp$ sage foo.sage\n  File \"foo.sage.py\", line 5\n    from __future__ import print_function\nSyntaxError: from __future__ imports must occur at the beginning of the file\n(exit 1) \n~/tmp$ cat foo.sage.py \n\n# This file was *autogenerated* from the file foo.sage\nfrom sage.all_cmdline import *   # import sage library\n\nfrom __future__ import print_function\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/23091\n\n",
    "created_at": "2017-05-27T10:37:30Z",
    "labels": [
        "user interface",
        "major",
        "bug"
    ],
    "title": "preparsing breaks from __future__ import directives",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22854",
    "user": "mmezzarobba"
}
```

```
~/tmp$ cat > foo.sage
from __future__ import print_function
~/tmp$ sage foo.sage
  File "foo.sage.py", line 5
    from __future__ import print_function
SyntaxError: from __future__ imports must occur at the beginning of the file
(exit 1) 
~/tmp$ cat foo.sage.py 

# This file was *autogenerated* from the file foo.sage
from sage.all_cmdline import *   # import sage library

from __future__ import print_function
```


Issue created by migration from https://trac.sagemath.org/ticket/23091





---

archive/issue_comments_319569.json:
```json
{
    "body": "That would not be that simple to handle. Just checking for the regexp `^from __future__` would not be enough since this could appear in a string such as\n\n```\n\"\"\"\nMy module\n\nfrom __future__\n\"\"\"\n\ndef f(x):\n    return x\n```\n\n(I agree that this is very artificial)",
    "created_at": "2019-03-03T10:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22854",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22854#issuecomment-319569",
    "user": "vdelecroix"
}
```

That would not be that simple to handle. Just checking for the regexp `^from __future__` would not be enough since this could appear in a string such as

```
"""
My module

from __future__
"""

def f(x):
    return x
```

(I agree that this is very artificial)



---

archive/issue_comments_319570.json:
```json
{
    "body": "If one first strips off all the comments then it's perhaps doable.",
    "created_at": "2019-03-03T11:46:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22854",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22854#issuecomment-319570",
    "user": "dimpase"
}
```

If one first strips off all the comments then it's perhaps doable.



---

archive/issue_comments_319571.json:
```json
{
    "body": "Compared to the other fragile hacks in the preparser this would be minor issue imho",
    "created_at": "2019-03-03T11:57:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22854",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22854#issuecomment-319571",
    "user": "vbraun"
}
```

Compared to the other fragile hacks in the preparser this would be minor issue imho



---

archive/issue_comments_319572.json:
```json
{
    "body": "I've written a small tool that injects code *after* all `from __future__` imports:\nhttps://github.com/timokau/python-inject\n\nI've written that for a similar purpose (https://github.com/NixOS/nixpkgs/pull/53816), but haven't done significant testing yet. Maybe its relevant for this usecase.",
    "created_at": "2019-03-03T12:17:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22854",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22854#issuecomment-319572",
    "user": "@timokau"
}
```

I've written a small tool that injects code *after* all `from __future__` imports:
https://github.com/timokau/python-inject

I've written that for a similar purpose (https://github.com/NixOS/nixpkgs/pull/53816), but haven't done significant testing yet. Maybe its relevant for this usecase.



---

archive/issue_comments_319573.json:
```json
{
    "body": "My trick is to have\n\n```\nfrom __future__ import division, absolute_import, print_function\n```\n\nas the first line of my init dot sage file:\n\n- https://github.com/slel/sagemath-tips/blob/master/init-dot-sage/init.sage\n\nMaybe SageMath 9.0 could start by such imports, whether Python2-based\nor Python3-based, to encourage and guide everybody's transition to Python3,\nand later on SageMath 10.0 could be Python3-only.",
    "created_at": "2019-03-03T14:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22854",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22854#issuecomment-319573",
    "user": "slelievre"
}
```

My trick is to have

```
from __future__ import division, absolute_import, print_function
```

as the first line of my init dot sage file:

- https://github.com/slel/sagemath-tips/blob/master/init-dot-sage/init.sage

Maybe SageMath 9.0 could start by such imports, whether Python2-based
or Python3-based, to encourage and guide everybody's transition to Python3,
and later on SageMath 10.0 could be Python3-only.



---

archive/issue_comments_319574.json:
```json
{
    "body": "Replying to [comment:1 vdelecroix]:\n> That would not be that simple to handle. Just checking for the regexp `^from __future__` would not be enough since this could appear in a string such as\n> {{{\n> \"\"\"\n> My module\n> \n> from __future__\n> \"\"\"\n> \n> def f(x):\n>     return x\n> }}}\n> (I agree that this is very artificial)\n\nShould be using the `ast` module to parse out import statements.",
    "created_at": "2019-03-04T15:47:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22854",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22854#issuecomment-319574",
    "user": "embray"
}
```

Replying to [comment:1 vdelecroix]:
> That would not be that simple to handle. Just checking for the regexp `^from __future__` would not be enough since this could appear in a string such as
> {{{
> """
> My module
> 
> from __future__
> """
> 
> def f(x):
>     return x
> }}}
> (I agree that this is very artificial)

Should be using the `ast` module to parse out import statements.



---

archive/issue_comments_319575.json:
```json
{
    "body": "Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22854",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22854#issuecomment-319575",
    "user": "embray"
}
```

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_comments_319576.json:
```json
{
    "body": "fixed by #27719",
    "created_at": "2019-06-05T13:31:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22854",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22854#issuecomment-319576",
    "user": "mmezzarobba"
}
```

fixed by #27719



---

archive/issue_comments_319577.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-06-05T13:31:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22854",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22854#issuecomment-319577",
    "user": "mmezzarobba"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_319578.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-06-05T13:31:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22854",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22854#issuecomment-319578",
    "user": "mmezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_319579.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2019-06-05T18:26:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22854",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22854#issuecomment-319579",
    "user": "chapoton"
}
```

Resolution: duplicate



---

archive/issue_comments_319580.json:
```json
{
    "body": "Sorry, I missed this ticket when I created #27719.",
    "created_at": "2019-06-05T18:53:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22854",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22854#issuecomment-319580",
    "user": "jhpalmieri"
}
```

Sorry, I missed this ticket when I created #27719.
