# Issue 22854: preparsing breaks from __future__ import directives

Issue created by migration from Trac.

Original creator: mmezzarobba

Original creation time: 2017-05-27 10:37:30


```
~/tmp$ cat > foo.sage
from __future__ import print_function
~/tmp$ sage foo.sage
  File "foo.sage.py", line 5
    from __future__ import print_function
SyntaxError: from __future__ imports must occur at the beginning of the file
(exit 1) 
~/tmp$ cat foo.sage.py 

# This file was *autogenerated* from the file foo.sage
from sage.all_cmdline import *   # import sage library

from __future__ import print_function
```



---

Comment by vdelecroix created at 2019-03-03 10:39:48

That would not be that simple to handle. Just checking for the regexp `^from __future__` would not be enough since this could appear in a string such as

```
"""
My module

from __future__
"""

def f(x):
    return x
```

(I agree that this is very artificial)


---

Comment by dimpase created at 2019-03-03 11:46:46

If one first strips off all the comments then it's perhaps doable.


---

Comment by vbraun created at 2019-03-03 11:57:54

Compared to the other fragile hacks in the preparser this would be minor issue imho


---

Comment by @timokau created at 2019-03-03 12:17:53

I've written a small tool that injects code *after* all `from __future__` imports:
https://github.com/timokau/python-inject

I've written that for a similar purpose (https://github.com/NixOS/nixpkgs/pull/53816), but haven't done significant testing yet. Maybe its relevant for this usecase.


---

Comment by slelievre created at 2019-03-03 14:44:40

My trick is to have

```
from __future__ import division, absolute_import, print_function
```

as the first line of my init dot sage file:

- https://github.com/slel/sagemath-tips/blob/master/init-dot-sage/init.sage

Maybe SageMath 9.0 could start by such imports, whether Python2-based
or Python3-based, to encourage and guide everybody's transition to Python3,
and later on SageMath 10.0 could be Python3-only.


---

Comment by embray created at 2019-03-04 15:47:04

Replying to [comment:1 vdelecroix]:
> That would not be that simple to handle. Just checking for the regexp `^from __future__` would not be enough since this could appear in a string such as
> {{{
> """
> My module
> 
> from __future__
> """
> 
> def f(x):
>     return x
> }}}
> (I agree that this is very artificial)

Should be using the `ast` module to parse out import statements.


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by mmezzarobba created at 2019-06-05 13:31:29

fixed by #27719


---

Comment by mmezzarobba created at 2019-06-05 13:31:29

Changing status from new to needs_review.


---

Comment by mmezzarobba created at 2019-06-05 13:31:42

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2019-06-05 18:26:14

Resolution: duplicate


---

Comment by jhpalmieri created at 2019-06-05 18:53:48

Sorry, I missed this ticket when I created #27719.
