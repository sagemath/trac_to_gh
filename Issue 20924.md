# Issue 20924: repr of NumberFields (the parents) should indicate its embedding if there is one

Issue created by migration from Trac.

Original creator: mkoeppe

Original creation time: 2016-08-03 23:12:14

CC:  vdelecroix jipilab cremona tscrim mmezzarobba jdemeyer

Number fields with coercion embeddings, in particular with real embeddings, behave quite differently from those without - but there's no indication of embeddings in the print representation:

```
sage: K.<a> = NumberField(x^2 - 2)
sage: a.parent()
Number Field in a with defining polynomial x^2 - 2
sage: K.<sqrt2> = NumberField(x^2 - 2, embedding=1.4)
sage: sqrt2.parent()
Number Field in sqrt2 with defining polynomial x^2 - 2
```


I propose to change the print representation when there is an embedding, for example like this:

```
sage: K.<sqrt2> = NumberField(x^2 - 2, embedding=1.4)
sage: sqrt2.parent()
Real Number Field in sqrt2 as the root of the defining polynomial x^2 - 2 near 1.41421356237309?
```



---

Comment by vdelecroix created at 2016-08-03 23:18:13

Shorter sentence would be better.

```
Real Number Field in sqrt2 as the root of x^2 - 2 in [1.41, 1.42]
```

Ideally (as above), the `X` in `near X` should have the form of an interval `[1.41,1.42]` that specifies uniquely the root.


---

Comment by vdelecroix created at 2016-08-03 23:19:16

Or possibly

```
Real Number Field in sqrt2=1.41421356237309? with defining polynomial x^2 - 2
```



---

Comment by mkoeppe created at 2016-08-03 23:31:08

`AlgebraicGenerator` (from `qqbar`) uses 

```
   Number Field in a with defining polynomial y^2 - y - 1 with a in 1.618033988749895?
```



---

Comment by vdelecroix created at 2016-08-03 23:39:06

Replying to [comment:4 mkoeppe]:
> `AlgebraicGenerator` (from `qqbar`) uses 
> {{{
>    Number Field in a with defining polynomial y^2 - y - 1 with a in 1.618033988749895?
> }}}

Which is not that bad except the `a in 1.618033988749895?`. Would make more sense with `a in [1.61, 1.62]` or `a = 1.618033988749895?`.


---

Comment by nbruin created at 2019-02-09 21:13:57

This should work for number fields with a real embedding as well as a complex one. The interval notation is painful for the latter, so "with a=..." would probably work better. Also good if we end up with number fields with a p-adic embedding specified:

```
K.<a>=NumberField(x^2+1,embedding=pAdicField(5)(-1).sqrt())
```



---

Comment by git created at 2019-04-22 14:27:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-04-22 14:29:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2019-04-22 22:04:43

In this patch I am using a format with `with a = ...` now (as suggested by nbruin), which works well also for the complex case:

```
Number Field in a with defining polynomial x^13 - 2/3*x + 3 with a = -1.106745229567614?
```

and for more complicated situations such as this one:

```
            sage: K.<a> = NumberField(x^4 - 3); K
            Number Field in a with defining polynomial x^4 - 3
            sage: H.<b>, from_H = K.subfield(a^2)
            sage: H
            Number Field in b with defining polynomial x^2 - 3 with b = a^2
```


The output for the following looks a bit strange because printing goes through `sage.rings.real_lazy.LazyBinop`:

```
sage: QuadraticField(-1, 'a')
Number Field in a with defining polynomial x^2 + 1 with a = 1*I
```

Should we special case this?


---

Comment by git created at 2019-04-22 22:06:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-04-22 22:07:27

Changing status from new to needs_review.


---

Comment by jipilab created at 2019-04-23 09:16:41

Changing keywords from "" to "number field".


---

Comment by jipilab created at 2019-04-23 09:16:41

The patchbot gave 2 pyflakes warnings, I repaired one of them, the other one I can not make sure that it does not have side effects.

Otherwise, the patchbot is happy and the resolution looks reasonable. I set it as positive review, if you agree `@`mkoeppe.
----
New commits:


---

Comment by jipilab created at 2019-04-23 09:16:41

Changing status from needs_review to positive_review.


---

Comment by jipilab created at 2019-04-23 09:18:04

Changing status from positive_review to needs_work.


---

Comment by jipilab created at 2019-04-23 09:18:04

Whoooops!


---

Comment by git created at 2019-04-23 12:09:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2019-04-23 12:10:50

Changing status from needs_work to needs_review.


---

Comment by jipilab created at 2019-04-23 12:10:50

Let's see if the bot finds more. I hope I did not forget any...


---

Comment by jipilab created at 2019-04-24 05:58:26

Failing doctests


---

Comment by jipilab created at 2019-04-24 05:58:26

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-04-25 08:06:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-04-25 08:11:08

Changing status from needs_work to needs_review.


---

Comment by git created at 2019-04-25 10:07:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2019-04-25 13:58:52


```
sage -t --long src/sage/modular/local_comp/smoothchar.py
**********************************************************************
File "src/sage/modular/local_comp/smoothchar.py", line 461, in sage.modular.local_comp.smoothchar.SmoothCharacterGroupGeneric._coerce_map_from_
Failed example:
    G.coerce(GK.character(0, [4]))
Exception raised:
    Traceback (most recent call last):
      File "/home/sage-patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/sage-patchbot/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.modular.local_comp.smoothchar.SmoothCharacterGroupGeneric._coerce_map_from_[7]>", line 1, in <module>
        G.coerce(GK.character(Integer(0), [Integer(4)]))
      File "sage/structure/parent.pyx", line 1114, in sage.structure.parent.Parent.coerce (build/cythonized/sage/structure/parent.c:10541)
        cpdef coerce(self, x):
      File "sage/structure/parent.pyx", line 1144, in sage.structure.parent.Parent.coerce (build/cythonized/sage/structure/parent.c:10470)
        raise TypeError(_LazyString(_lazy_format, ("no canonical coercion from %s to %s", parent(x), self), {}))
    TypeError: no canonical coercion from Group of smooth characters of Q_3* with values in Number Field in i with defining polynomial x^2 + 1 with i = 1*I to Group of smooth characters of Q_3* with values in Rational Field
**********************************************************************
1 item had failures:
   1 of  14 in sage.modular.local_comp.smoothchar.SmoothCharacterGroupGeneric._coerce_map_from_
    [303 tests, 1 failure, 2.58 s]
sage -t --long src/sage/tests/books/computational-mathematics-with-sagemath/polynomes_doctest.py
**********************************************************************
File "src/sage/tests/books/computational-mathematics-with-sagemath/polynomes_doctest.py", line 177, in sage.tests.books.computational-mathematics-with-sagemath.polynomes_doctest
Failed example:
    for A in [QQ, ComplexField(16), GF(5), QQ[sqrt(2)]]:
        print(str(A) + ":")
        print(A['x'](p).factor())
Expected:
    Rational Field:
    (54) * (x + 1/3)^2 * (x^2 - 2)
    Complex Field with 16 bits of precision:
    (54.00) * (x - 1.414) * (x + 0.3333)^2 * (x + 1.414)
    Finite Field of size 5:
    (4) * (x + 2)^2 * (x^2 + 3)
    Number Field in sqrt2 with defining polynomial x^2 - 2:
    (54) * (x - sqrt2) * (x + sqrt2) * (x + 1/3)^2
Got:
    Rational Field:
    (54) * (x + 1/3)^2 * (x^2 - 2)
    Complex Field with 16 bits of precision:
    (54.00) * (x - 1.414) * (x + 0.3333)^2 * (x + 1.414)
    Finite Field of size 5:
    (4) * (x + 2)^2 * (x^2 + 3)
    Number Field in sqrt2 with defining polynomial x^2 - 2 with sqrt2 = 1.414213562373095?:
    (54) * (x - sqrt2) * (x + sqrt2) * (x + 1/3)^2
**********************************************************************
1 item had failures:
   1 of 111 in sage.tests.books.computational-mathematics-with-sagemath.polynomes_doctest
    [110 tests, 1 failure, 0.96 s]
----------------------------------------------------------------------
sage -t --long src/sage/modular/local_comp/smoothchar.py  # 1 doctest failed
sage -t --long src/sage/tests/books/computational-mathematics-with-sagemath/polynomes_doctest.py  # 1 doctest failed
----------------------------------------------------------------------
```


The first one seems to be taken care of but not the second one.


---

Comment by git created at 2019-04-26 15:01:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-04-26 15:07:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-04-26 15:08:44

Fixed these two.


---

Comment by jipilab created at 2019-05-16 17:18:05

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-05-18 14:59:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-05-18 15:00:56

Changing status from needs_work to needs_review.


---

Comment by jipilab created at 2019-05-22 16:11:56

There are only 6 failing doctests. That's not bad!


```
----------------------------------------------------------------------
sage -t --long src/sage/rings/qqbar.py  # 5 doctests failed
sage -t --long src/sage/rings/number_field/order.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by jipilab created at 2019-05-22 16:11:56

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-05-23 02:08:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2019-05-23 02:08:42

Changing status from needs_work to needs_review.


---

Comment by jipilab created at 2019-05-25 10:59:32

Looks good to me. The tests seem to pass on the latest beta and the pyflakes errors are not regressions. I set this to positive review.


---

Comment by jipilab created at 2019-05-25 10:59:32

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-05-28 21:07:55

Resolution: fixed


---

Comment by chapoton created at 2019-06-20 15:06:17

This ticket is probably causing (randomly) **infinite loops** on several patchbots.

For example, see

https://patchbot.sagemath.org/log/27408/Ubuntu/18.04/x86_64/4.15.0-52-generic/petitbonum/2019-06-20%2014:50:38?short

EDIT:
the problematic doctest is

```
File "src/sage/structure/parent.pyx", line 1734, in sage.structure.parent.Parent.hom.register_embedding
Failed example:
    K.coerce_embedding()(a)
Exception raised:
...
RuntimeError: maximum recursion depth exceeded while calling a Python object
```



---

Comment by jipilab created at 2019-06-21 09:25:47

Replying to [comment:37 chapoton]:
> This ticket is probably causing (randomly) **infinite loops** on several patchbots.
> 
> For example, see
> 
> https://patchbot.sagemath.org/log/27408/Ubuntu/18.04/x86_64/4.15.0-52-generic/petitbonum/2019-06-20%2014:50:38?short
> 
> EDIT:
> the problematic doctest is
> {{{
> File "src/sage/structure/parent.pyx", line 1734, in sage.structure.parent.Parent.hom.register_embedding
> Failed example:
>     K.coerce_embedding()(a)
> Exception raised:
> ...
> RuntimeError: maximum recursion depth exceeded while calling a Python object
> }}}

The source code that changed is


```diff
--- a/src/sage/rings/number_field/number_field.py
+++ b/src/sage/rings/number_field/number_field.py
`@``@` -3087,9 +3089,16 `@``@` class NumberField_generic(WithEqualityById, number_field_base.NumberField):
         """
-        return "Number Field in %s with defining polynomial %s"%(
-                   self.variable_name(), self.polynomial())
+        result = "Number Field in {} with defining polynomial {}".format(self.variable_name(), self.polynomial())
+        gen = self.gen_embedding()
+        if gen is not None:
+            result += " with {} = {}".format(self.variable_name(), gen)
+        return result
```


The rest of the diff consist of adapting the doctests. Where could the infinite loop come from? Hmm.


---

Comment by chapoton created at 2019-06-21 09:56:58

It appears that using the embedding in the repr is a very bad idea...

Even when this problematic doctest works, calling

```
K.coerce_embedding()
```

after this doctest makes sage crash..
And the culprit are really those 2 "innocent" added lines..


---

Comment by chapoton created at 2019-06-21 11:00:28

I have made #28036 to revert the changes made here.


---

Comment by chapoton created at 2019-06-21 12:08:49

Maybe changing this line would be a way out:

```
return copy(self._embedding) # It might be overkill to make a copy here
```

