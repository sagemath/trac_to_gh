# Issue 29476: Broken conversion from FractionField over PolynomialRing over Field back to Field

Issue created by migration from https://trac.sagemath.org/ticket/29713

Original creator: @petRUShka

Original creation time: 2020-05-19 16:14:38

CC:  mmezzarobba caruso slelievre saraedum vdelecroix

Keywords: fraction field

Let consider following code:


```
F = FunctionField(QQ, 'a')
a = F.gen()

polynomial_ring = PolynomialRing(F, 'x')
FF = FractionField(polynomial_ring)

element = F(-1/2/(a^2 + a))

assert F(FF(element))
```


The last line yields following error:


```
>           raise TypeError("fraction must have unit denominator")
E           TypeError: fraction must have unit denominator

/usr/lib/python3.8/site-packages/sage/rings/fraction_field.py:1190: TypeError
```


But actually it should be just conversion from FractionField element back to Field.

P.S. There is also one more thing:


```
assert FF(element) in F
```


yields following:


```
E       assert -1/2/(a^2 + a) in Rational function field in a over Rational Field
E        +  where -1/2/(a^2 + a) = Fraction Field of Univariate Polynomial Ring in x over Rational function field in a over Rational Field(-1/2/(a^2 + a))
```


P.P.S. [SageMath](SageMath) version 9.0, Release Date: 2020-01-01 


---

Comment by heluani created at 2020-05-20 03:39:47

I feel like the right solution is to have FractionFieldEmbeddingSection._call_ raise a `ValueError` instead of a `TypeError`. From the code in fraction_field.py:


```
     # This should probably be a ValueError.
     # However, too much existing code is expecting this to throw a
     # TypeError, so we decided to keep it for the time being.
     raise TypeError("fraction must have unit denominator")
```

I did not have the courage to change this, so I implemented a hack in `RationalFunctionField._element_constructor`_that fixes this issue at least. 
----
New commits:


---

Comment by heluani created at 2020-05-20 03:39:47

Changing status from new to needs_review.


---

Comment by git created at 2020-05-20 03:41:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-05-20 03:43:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-05-20 03:47:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2020-05-20 04:34:27

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2020-05-20 04:34:27

I think this is a pretty bad hack and it doesn't solve the underlying problem:

```
sage: F = FractionField(QQ['a'])
sage: a = F.gen()
sage: R = PolynomialRing(F, 'x')
sage: FF = FractionField(R)
sage: elt = F(-1/2/(a^2+a))
sage: FF(elt)
-1/2/(a^2 + a)
sage: F(_)  # Same error
```

I think the correct fix would be to change something in the fraction field `_element_constructor_` to handle this case.


---

Comment by tscrim created at 2020-05-20 05:26:07

Here is my proposal that should make sure such things work. It might not be the fastest, but there is some attempt at making the most natural code paths fast.
----
New commits:


---

Comment by tscrim created at 2020-05-20 05:26:07

Changing status from needs_work to needs_review.


---

Comment by caruso created at 2020-05-25 16:49:28

I mostly agree with your proposal but I would have implemented things slightly differently.


---

Comment by git created at 2020-05-25 16:49:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2020-05-25 17:08:35

Moreover, I'm not sure that having a special case when `y` is not none and `parent(x)` is `self` is really relevant. I agree that it can short-circuit something but, on the contrary, I think that conveting `y` to `self` may have some impact on the efficiency.


---

Comment by tscrim created at 2020-05-26 02:19:14

Replying to [comment:9 caruso]:
> Moreover, I'm not sure that having a special case when `y` is not none and `parent(x)` is `self` is really relevant. I agree that it can short-circuit something but, on the contrary, I think that conveting `y` to `self` may have some impact on the efficiency.

I somewhat agree. It was my first attempt at a solution, but I felt could cover some extra similar such cases. Why I convert `y` to `self` is this: If we try and short-circuit it this way, there can be some extra conversions that are there, but are not coercions. The first thing I tried was:

```
y *= x.denominator()
```

The other option would be to use

```
y *= parent(y)(x.denominator())
```

but I feel that could involve even more conversions. I also concluded that if we didn't short-circuit, there would be just as many conversions that would be done using the default pathway (plus extra exceptions raised).


---

Comment by caruso created at 2020-05-27 17:02:45

OK.

So, if you agree with my changes, you can give a positive review to this ticket on my behalf.


---

Comment by tscrim created at 2020-05-28 01:20:42

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2020-05-28 01:20:42

Yes, I agree. Thank you for the review.

Addendum - I forgot to say, I like your fix by checking the parent.


---

Comment by vbraun created at 2020-05-29 21:16:07

Resolution: fixed
