# Issue 13759: Failure running Sage when local/share/sage/ext doesn't exist

Issue created by migration from https://trac.sagemath.org/ticket/13963

Original creator: jdemeyer

Original creation time: 2013-01-17 11:37:26

Assignee: GeorgSWeber

It seems that nothing really guarantees the existence of the directory

```
$SAGE_ROOT/local/share/sage/ext
```

apart from the installers of some packages.

When Sage is started when that directory doesn't exist:

```
[...lots of stuff...]
/release/merger/sage-5.7.beta0/local/lib/python2.7/site-packages/sage/interfaces/all.py in <module>()
      7
      8 from expect import is_ExpectElement
----> 9 from gap import gap, gap_reset_workspace, gap_console, gap_version, set_gap_memory_pool_size, is_GapElement, Gap
     10 from gap3 import gap3, gap3_console, gap3_version, Gap3
     11 from genus2reduction import genus2reduction, Genus2reduction

/release/merger/sage-5.7.beta0/local/lib/python2.7/site-packages/sage/interfaces/gap.py in <module>()
   1457 # if the modification time of the gap link has changed (which signals
   1458 # that gap has been somehow upgraded).
-> 1459 if not os.path.exists(WORKSPACE) or os.path.getmtime(WORKSPACE) < os.path.getmtime(GAP_STAMP):
   1460     #print "Automatically updating the cached Gap workspace:"
   1461     #print WORKSPACE

/release/merger/sage-5.7.beta0/local/lib/python/genericpath.py in getmtime(filename)
     52 def getmtime(filename):
     53     """Return the last modification time of a file, reported by os.stat()."""
---> 54     return os.stat(filename).st_mtime
     55
     56
```



---

Attachment


---

Comment by jdemeyer created at 2013-01-17 13:32:19

Changing status from new to needs_review.


---

Comment by vbraun created at 2013-01-17 14:02:19

+1

In the long run it would also be nice to have just a single cache dir with a single hashing scheme for SAGE_ROOT. Right now we have at least

```
~/.sage/gap/workspace-1816283156629376178
~/.sage/cache/_home_vbraun_opt_sage-5.6.rc0_devel_sage-main-lazy_import_cache.pickle
```



---

Comment by vbraun created at 2013-01-17 14:02:19

Changing status from needs_review to positive_review.


---

Comment by leif created at 2013-01-17 14:34:31

Minor comments:

 * `GAP_BINARY` is misleading, as `$SAGE_LOCAL/bin/gap` is a shell script.

 * A failure upon creation of `README.txt` is silently ignored in the first place.  (This has been in before.)

 * The created README could contain a note on the automatic deletion of old GAP workspaces.




Avoiding to think of the race conditions we may run into here... ;-)


---

Comment by jdemeyer created at 2013-01-17 14:44:59

Replying to [comment:7 leif]:
> Minor comments:
> 
>  * `GAP_BINARY` is misleading, as `$SAGE_LOCAL/bin/gap` is a shell script.
I think that the name `GAP_SCRIPT` would be even more misleading.  Besides, for this code it doesn't really matter whether it's a binary or a script, it's only needed to check the time when GAP was installed.

> Avoiding to think of the race conditions we may run into here... ;-)
It mainly depends on how GAP's `SaveWorkspace()` is implemented because that would be the most obvious place to check for race conditions.


---

Comment by leif created at 2013-01-17 14:45:50

P.S.:

`GAP_DIR` (here meaning the directory _for GAP workspaces_) should also get renamed, as that name is already used for the directory _where GAP lives_, in other contexts of course.


---

Comment by leif created at 2013-01-17 14:55:14

Replying to [comment:8 jdemeyer]:
> Replying to [comment:7 leif]:
> > Minor comments:
> > 
> >  * `GAP_BINARY` is misleading, as `$SAGE_LOCAL/bin/gap` is a shell script.
> I think that the name `GAP_SCRIPT` would be even more misleading.  Besides, for this code it doesn't really matter whether it's a binary or a script, it's only needed to check the time when GAP was installed.

Well, a _binary_ is more likely to change upon reinstallation than some (more or less generic) script.

(Haven't checked whether it actually gets [re-]created by the GAP spkg.)


---

Comment by leif created at 2013-01-17 15:06:07

I'd say this needs work, as in GAP's most recent `spkg-install` we have:


```sh

# Indicate that GAP has somehow been updated, which invalidates all workspaces:
touch "$SAGE_LOCAL/bin/gap_stamp"
```



---

Comment by vbraun created at 2013-01-17 15:14:16

The `gap_stamp` gets touched by the `gap` and `gap_packages` spkgs. Putting it in `/bin` was of course a bad call.


---

Comment by leif created at 2013-01-17 15:25:42

Replying to [comment:12 vbraun]:
> The `gap_stamp` gets touched by the `gap` and `gap_packages` spkgs. Putting it in `/bin` was of course a bad call. 

No matter _what_ we use as the stamp, it wouldn't be bad to use _the same_ in GAP-related spkgs as well as the Sage library... ;-)


---

Comment by jdemeyer created at 2013-01-17 15:38:39

Replying to [comment:12 vbraun]:
> The `gap_stamp` gets touched by the `gap` and `gap_packages` spkgs.
Does installing a new GAP package require a rebuild of the workspace?


---

Comment by vbraun created at 2013-01-17 15:55:42

Yes... just the other day I spent a fun few hours figuring out why some GAP command mysteriously crashes. Wrong gap workspace %-)


---

Comment by jdemeyer created at 2013-01-17 16:01:31

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-01-17 16:02:05

Replying to [comment:15 vbraun]:
> Yes... just the other day I spent a fun few hours figuring out why some GAP command mysteriously crashes. Wrong gap workspace %-)
Any suggestions for a way of properly checking whether a new package was installed?


---

Attachment


---

Comment by jdemeyer created at 2013-01-17 16:20:44

This seems the best solution, although it is not very elegant.


---

Comment by vbraun created at 2013-01-17 16:21:45

How about we check the date of `gap_stamp` for rebuilding the workspace, thats what its meant for.


---

Comment by leif created at 2013-01-17 16:35:52

I'd still let `-O0` override a user's O-level (in `$CFLAGS`) if `SAGE_DEBUG=yes`, like most -- if not all -- other spkgs do.

And while you're at it, change the `==` to `=` there, and/or use `[This is the Trac macro *... * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#... -macro)`.

There are also a few error checks missing, and `SPKG_ROOT` isn't always quoted.  (One should also probably do some sanity check on `$VERSION` at least.)

The `-f` in `ln -sf ... latest` is redundant, as we always first delete the symbolic link (if present).


---

Comment by jdemeyer created at 2013-01-17 18:13:01

Replying to [comment:21 leif]:
> I'd still let `-O0` override a user's O-level (in `$CFLAGS`) if `SAGE_DEBUG=yes`, like most -- if not all -- other spkgs do.
I don't think Sage should ever override user-chosen flags, so we should always do

```
CFLAGS="-sage -specific -flags $CFLAGS"
```



---

Attachment


---

Comment by jdemeyer created at 2013-01-17 18:28:20

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2013-01-19 09:32:20

Can this be reviewed again please?


---

Comment by vbraun created at 2013-01-19 13:21:37

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-01-19 13:21:37

Its still fugly to touch bin/gap but at least it works. Cute trick with `autoconf --trace`...


---

Comment by leif created at 2013-01-19 14:28:40

Replying to [comment:22 jdemeyer]:
> Replying to [comment:21 leif]:
> > I'd still let `-O0` override a user's O-level (in `$CFLAGS`) if `SAGE_DEBUG=yes`, like most -- if not all -- other spkgs do.
> I don't think Sage should ever override user-chosen flags, so we should always do
> {{{
> CFLAGS="-sage -specific -flags $CFLAGS"
> }}}

Well, IMHO depends.  If `-foo` is mandatory to not break the build, it should be _ap_pended; same for options to `configure`.  (`-L` is even more troublesome, and `-I-` for example isn't portable.)

Unfortunately there's not always an option to toggle or invalidate a previously (i.e., "user-specified") option, and flags may even conflict.  (The same is true for the opposite case, when a user wants to override some option added by Sage or an spkg's build system.  This especially holds for `-g`, which we almost always add by default -- thereby probably already overriding a user's choice; stripping afterwards may be inappropriate in some cases.)

If a user sets `SAGE_DEBUG=yes`, he will or should be aware of the consequences, which are documented (I think), and usually subject of a corresponding warning message.  If someone really wants to do debugging without e.g. `-O0`, he'll certainly be able to modify `spkg-install` for that purpose, which is trivial.  Temporarily modifying `C*FLAGS` is more tedious, and less experienced users may have (more or less intentionally) some of them set, while still expecting `SAGE_DEBUG` to work as advertised, without having to mess with other environment variables.

Ideally, we'd have some `SAGE_DEBUG_LEVEL`, or we'd at least separate "standard" compiler options _probably_ useful for debugging (such as `-O0`) from usually package-specific ones, like `-DDEBUG_FOO`;  `configure` may also take special debug options specific to the package (which IMHO is the main reason we do have `SAGE_DEBUG`).

Until we have `SAGE_DEBUG_CFLAGS`, say, which could easily be set/modified by the user, I'd still (try to) override e.g. `-O2` by default (if `SAGE_DEBUG=yes` of course).


---

Comment by jdemeyer created at 2013-01-19 17:19:19

Replying to [comment:26 leif]:
> If `-foo` is mandatory to not break the build, it should be _ap_pended
I don't think there are many situations where it's known that a flag is absolutely required to not break the build.  I like the principle of "the user knows best" and not "the Sage developers know best".

> This especially holds for `-g`
The `-g` option can be cancelled by `-g0`.

> If a user sets `SAGE_DEBUG=yes`, he will or should be aware of the consequences
Sure, but exactly the same holds for `CFLAGS`.

> If someone really wants to do debugging without e.g. `-O0`, he'll certainly be able to modify `spkg-install` for that purpose, which is trivial.
So now we require users to *modify a spkg* to get the options they want?  Why make things hard which should be easy?

> Temporarily modifying `C*FLAGS` is more tedious
Why that?  Changing `CFLAGS` is equally easy as changing `SAGE_DEBUG`.

> and less experienced users may have (more or less intentionally) some of them set
Why do you think that?  Are there any distributions which have `CFLAGS` set in the environment by default?


---

Comment by jdemeyer created at 2013-01-21 21:09:37

Resolution: fixed
