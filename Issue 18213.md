# Issue 18213: Define library dependencies in .pxd files

Issue created by migration from https://trac.sagemath.org/ticket/18450

Original creator: jdemeyer

Original creation time: 2015-05-19 12:56:01

CC:  jpflori gouezel

Rather than defining libraries in `module_list.py` or in `.pyx` files, we should add them to the `.pxd` files where the declarations are.

One annoying part is that the order of libraries is not defined, so we need to manually re-order them.

*Needed upstream bug fix*: [http://trac.cython.org/ticket/845](http://trac.cython.org/ticket/845) (patch included in this branch)


---

Comment by jdemeyer created at 2015-05-20 05:49:42

New commits:


---

Comment by git created at 2015-05-20 09:28:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-05-20 09:29:41

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-05-23 11:58:26

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-05-23 20:47:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-05-23 20:48:38

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-06-01 10:13:05

To potential reviewers: if the upstream status of the second Cython patch is what prevents you from reviewing this ticket, I can add a quick work-around for that. Just let me know.


---

Comment by jpflori created at 2015-06-01 10:20:15

Please do!

I had a look at the upstream ticket and did not get any strong feeling yet.


---

Comment by jdemeyer created at 2015-06-01 11:19:07

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-06-01 12:05:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-06-01 12:07:36

Changing status from needs_work to needs_review.


---

Comment by gouezel created at 2015-06-02 07:29:32

With the patch, `mpfr` is not picked when compiling `partitions_c` (on cygwin)
Part of the log:

```
build/temp.cygwin-1.7.35-x86_64-2.7/sage/combinat/partitions_c.o: dans la fonction « compute_current_precision »:
/home/Sebastien/sage13/sage/src/sage/combinat/partitions_c.cc:448: référence indéfinie vers « __imp_mpfr_init2 »
/home/Sebastien/sage13/sage/src/sage/combinat/partitions_c.cc:448:(.text+0x16): relocalisation tronquée pour concorder avec la taille: R_X86_64_PC32 vers le symbole indéfini __imp_mpfr_init2
/home/Sebastien/sage13/sage/src/sage/combinat/partitions_c.cc:452: référence indéfinie vers « __imp_mpfr_set_d »
```

Full log on request.


---

Comment by gouezel created at 2015-06-02 07:29:32

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-06-02 07:43:16

Right, it's `partitions_c.cc` which needs those libraries, not the Cython code...


---

Comment by git created at 2015-06-02 07:49:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-06-02 07:49:56

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-06-02 09:31:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2015-06-02 09:43:37

Coule you please open a follow up ticket for the Pari linking issue?


---

Comment by jdemeyer created at 2015-06-02 10:01:55

You mean the fact that `pari` gets added as library when it's not needed? That's now #18583.


---

Comment by gouezel created at 2015-06-02 15:07:49

Changing status from needs_review to needs_work.


---

Comment by gouezel created at 2015-06-02 15:07:49

With the patch, linking problem of 'libecm' with 'gmp'
Part of log:

```
gcc -shared -Wl,--enable-auto-image-base -L/home/Sebastien/sage13/sage/local/lib build/temp.cygwin-1.7.35-x86_64-2.7/build/cythonized/sage/libs/libecm.o -L/home/Sebastien/sage13/sage/local/lib -L/home/Sebastien/sage13/sage/local/lib/python2.7/config -L/home/Sebastien/sage13/sage/local/lib -lcsage -lgmp -lecm -lpython2.7 -o build/lib.cygwin-1.7.35-x86_64-2.7/sage/libs/libecm.dll
/home/Sebastien/sage13/sage/local/lib/libecm.a(libecm_la-factor.o): dans la fonction « ecm_init »:
/home/Sebastien/sage13/sage/local/var/tmp/sage/build/ecm-6.4.4/src/factor.c:32: référence indéfinie vers « __imp___gmpz_init_set_ui »
```



---

Comment by jpflori created at 2015-06-02 15:29:23

There is a lgmp but before lecm and the linker is picky.


---

Comment by git created at 2015-06-02 15:55:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-06-02 15:56:30

Right, I forgot to add `ecm`.


---

Comment by jdemeyer created at 2015-06-02 15:56:30

Changing status from needs_work to needs_review.


---

Comment by gouezel created at 2015-06-02 20:51:27

Good to go.


---

Comment by gouezel created at 2015-06-02 20:51:27

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2015-06-03 05:42:25

Thanks for the review!


---

Comment by vbraun created at 2015-06-03 23:22:41

Resolution: fixed


---

Comment by leif created at 2016-06-29 20:00:46

Just out of curiosity:  Are there follow-ups moving further things into `*.pxd`?

(More precisely, into `# distutils: ...` declarations.)
