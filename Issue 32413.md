# Issue 32413: sage.misc.latex: Replace have_... functions by Features

Issue created by migration from https://trac.sagemath.org/ticket/32650

Original creator: mkoeppe

Original creation time: 2021-10-07 19:10:34

CC:  klee




---

Comment by slabbe created at 2021-11-02 16:12:09

Here is some work towards that goal removing all uses of `have_program` in `misc/latex.py`.

----
New commits:


---

Comment by slabbe created at 2021-11-02 16:13:01

Remainings usage of `have_program` are:


```
$ git grep have_program
interfaces/chomp.py:        from sage.misc.sage_ostools import have_program
interfaces/chomp.py:        _have_chomp[program] = have_program(program)
interfaces/phc.py:            from sage.misc.sage_ostools import have_program
interfaces/phc.py:            if not have_program('phc'):
misc/dist.py:    from sage.misc.sage_ostools import have_program
misc/dist.py:        cmd_inside_sage = have_program(cmd, path=SAGE_BIN)
misc/dist.py:        cmd_outside_sage = have_program(cmd, path=PATH)
misc/sage_ostools.pyx:def have_program(program, path=None):
misc/sage_ostools.pyx:        sage: from sage.misc.sage_ostools import have_program
misc/sage_ostools.pyx:        sage: have_program('ls')
misc/sage_ostools.pyx:        sage: have_program('there_is_not_a_program_with_this_name')
misc/sage_ostools.pyx:        sage: have_program('sage', os.path.join(SAGE_VENV, 'bin'))
misc/sage_ostools.pyx:        sage: have_program('sage', '/there_is_not_a_path_with_this_name')
misc/sage_ostools.pyx:        sage: have_program('there_is_not_a_program_with_this_name', os.path.join(SAGE_VENV, 'bin'))
misc/viewer.py:    from sage.misc.sage_ostools import have_program
misc/viewer.py:    elif have_program('xdg-open'):
misc/viewer.py:                if have_program(cmd):
misc/viewer.py:                if have_program(cmd):
misc/viewer.py:                if have_program(cmd):
plot/animate.py:        from sage.misc.sage_ostools import have_program
plot/animate.py:        have_convert = have_program('convert')
plot/animate.py:        from sage.misc.sage_ostools import have_program
plot/animate.py:        return have_program('ffmpeg')
plot/graphics.py:                from sage.misc.sage_ostools import have_program
plot/graphics.py:                                         if have_program(i)]
plot/multigraphics.py:                from sage.misc.sage_ostools import have_program
plot/multigraphics.py:                                         if have_program(i)]
```



---

Comment by git created at 2021-11-02 16:31:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-02 16:39:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2021-11-02 16:43:54

I suggest this ticket should handle only the removal of `have_program` in `misc.latex.py` and `sage.plot`.

TODO: Answer this question: do we want `.require(needed_for_msg)` to provide an additional message explaining why the feature is needed for?


---

Comment by git created at 2021-11-02 20:40:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-11-02 20:44:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2021-11-02 20:46:00

Replying to [comment:6 slabbe]:
> TODO: Answer this question: do we want `.require(needed_for_msg)` to provide an additional message explaining why the feature is needed for?

I decided to get rid of the `.require(needed_for_msg)`. I did a forced push to clean the commit about `plot/animate.py` file.


---

Comment by slabbe created at 2021-11-02 20:52:08

On my side, the command

```
$ sage -tp --optional=sage,optional,external --long src/sage/features src/sage/plot src/sage/doctest
```

currently gives:

```
Git branch: 32650
Using --optional=4ti2,bliss,cbc,ccache,cryptominisat,database_symbolic_data,debian,dot2tex,e_antic,external,fricas,glucose,latte_int,libnauty,lidia,normaliz,notedown,pandoc_attributes,pip,pycosat,pynormaliz,rst2ipynb,rubiks,sage,sage.geometry.polyhedron,sage.rings.real_double,sage_numerical_backends_coin,sage_spkg,sage_sws2rst
External software to be detected: 4ti2,cplex,dvipng,ffmpeg,graphviz,gurobi,imagemagick,internet,latex,lualatex,macaulay2,magma,maple,mathematica,matlab,octave,pandoc,pdf2svg,pdflatex,rubiks,scilab,xelatex
Sorting sources by runtime so that slower doctests are run first....
Doctesting 95 files using 8 threads.
[...]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 455.6 seconds
    cpu time: 680.6 seconds
    cumulative wall time: 2815.7 seconds
External software detected for doctesting: dvipng,ffmpeg,graphviz,imagemagick,internet,latex,lualatex,octave,pandoc,pdf2svg,pdflatex,xelatex
```



---

Comment by slabbe created at 2021-11-02 20:52:08

Changing status from new to needs_review.


---

Comment by git created at 2021-11-02 21:18:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2021-11-02 21:28:08

Needs review!


---

Comment by git created at 2021-11-04 10:29:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2021-11-04 10:29:50

I added a commit to fix a pyflakes warning.


---

Comment by slabbe created at 2021-11-04 10:34:47

`@`mkoeppe: I have a question for you with respect to a choice I made I am not sure of. Within the class `class latex(Executable)`, I addded the method `is_functional` where I reused the code which was in the previous `have_latex` in `sage.misc.latex.py`. This allows to have a behavior which matches the previous behavior when `have_latex` was called. But doing so, there are now imports `from sage.misc.latex import _run_latex_, _latex_file_` within the file `sage/features/latex.py`. Is this a file dependency we want to avoid with respect to modularization?


---

Comment by mkoeppe created at 2021-11-04 15:32:50

Great question. In this code:

```
+    def is_functional(self):
...
+        from sage.misc.latex import _run_latex_, _latex_file_
```

it would probably be good to use `try...except` around the import and return a `False` test result if `sage.misc.latex` is not available.


---

Comment by slabbe created at 2021-11-04 16:10:47

Replying to [comment:16 mkoeppe]:
> and return a `False` test result if `sage.misc.latex` is not available. 

`False`? But maybe `latex` is available and functional even if `sage.misc.latex` module is not available, so we could return `True`.


---

Comment by mkoeppe created at 2021-11-04 16:17:39

Do we have code that calls `latex` without going through `sage.misc.latex`?


---

Comment by slabbe created at 2021-11-04 16:20:47

In fact, I hate the function `_run_latex_` as it is a bunch of spaghetti code involving everything:

https://gitlab.com/sagemath/sage/-/blob/develop/src/sage/misc/latex.py#L643

So I think it is preferable to not call it within `features/latex.py` at all.


---

Comment by slabbe created at 2021-11-04 16:22:08

Replying to [comment:18 mkoeppe]:
> Do we have code that calls `latex` without going through `sage.misc.latex`?

Yes, it can be done without, by using a simple `subprocess.run`. I do that in #20343, for instance in the method `def pdf(self)`.


---

Comment by slabbe created at 2021-11-04 16:30:55

(note to myself: I just noticed that `have_latex` should be updated in `src/sage/doctest/external.py` to use features as well.)


---

Comment by mkoeppe created at 2021-11-04 20:37:40

Are you still planning to add the distro info for pdf2svg here as you wrote in #20343?


---

Comment by slabbe created at 2021-11-04 20:59:09

Yes.


---

Comment by git created at 2021-11-04 21:03:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-04 21:24:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-04 21:41:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2021-11-04 21:49:51

So I created the `build/pkgs/pdf2svg` by immitating what was done for `build/pkgs/pandoc` and `build/pkgs/graphviz`. I hope it makes sense.


---

Comment by slabbe created at 2021-11-04 21:50:53

While testing `sage -i pdf2svg`, I noticed this strange part in the output:


```
Error: pdf2svg is a dummy script package that the Sage distribution uses
to provide information about equivalent system packages.
It cannot be installed using the Sage distribution.
Please install it manually, for example using the system packages
recommended at the end of a run of './configure'
See below for package-specific information.
```


maybe this message should be fixed in another ticket.


---

Comment by mkoeppe created at 2021-11-04 21:51:42

What did you expect to happen?


---

Comment by git created at 2021-11-04 21:56:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2021-11-04 22:02:04

Replying to [comment:29 mkoeppe]:
> What did you expect to happen?

Well, the part that surprised me is `Error: pdf2svg is a dummy script package`, which I attributed to `_prereq`, `_recommmended` and `_bootstrap`. But, now, rereading it again, I understand what it means. It is just that it does not contain the source. Maybe `dummy` could be replaced by another word which better describe what it is? Or just leave it as it is...


---

Comment by slabbe created at 2021-11-04 22:03:58

Ok, so this ticket now needs review. I did not have anything else in mind to be done with respect to `have_...` within `sage.misc.latex.py` and `sage.plot`.


---

Comment by mkoeppe created at 2021-11-04 22:17:36

While at it, also dummy script packages for `ffmpeg` and `imagemagick` could be added (see #30930)


---

Comment by slabbe created at 2021-11-04 22:22:51

ok, I can do this, but next week. Going to bed now!


---

Comment by mkoeppe created at 2021-11-07 04:35:26

LGTM. One green patchbot, one patchbot that is not feeling well.


---

Comment by mkoeppe created at 2021-11-07 04:35:26

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-11-12 21:27:39

Resolution: fixed


---

Comment by slelievre created at 2021-11-18 15:48:20

There does not seem to be a Cygwin package for pdf2svg.

At least I could not find one by searching Cygwin packages via

- https://cygwin.com/packages/

and the command `apt-cyg install pdf2svg` fails.


---

Comment by slabbe created at 2021-11-18 16:28:48

Do you mean that the file `build/pkgs/pdf2svg/distros/cygwin.txt` should be removed?


---

Comment by slelievre created at 2021-11-18 16:50:43

Yes, otherwise configure ends with a recommendation
to run `apt-cyg install pdf2svg`.


---

Comment by slelievre created at 2021-11-18 16:52:04

Or package pdf2svg for Cygwin...  : )


---

Comment by slabbe created at 2021-11-25 10:14:24

I created #32931 to deal with this issue.


---

Comment by slelievre created at 2021-11-29 16:30:18

A request on the Cygwin mailing list to package pdf2svg
was answered as follows:

- https://cygwin.com/pipermail/cygwin/2021-November/250061.html

> The pdf2svg home page recommends instead pdftocairo
> from the poppler package, which does the same and
> is maintained as part of the package, rather than
> being a standalone utility which integrates the two,
> and is not as well maintained:
>
> {{{
> $ pdftocairo --help
> [...]
> }}}

That suggests `pdftocairo --svg file.pdf`
will transform `file.pdf` to `file.svg`.

It seems poppler is widely packaged:

- https://repology.org/project/poppler/versions


---

Comment by slabbe created at 2021-12-01 20:52:18

Then, should we replace `pdf2svg` feature by `pdftocairo`?


---

Comment by slabbe created at 2021-12-01 21:08:53

Replying to [comment:33 mkoeppe]:
> While at it, also dummy script packages for `ffmpeg` and `imagemagick` could be added (see #30930)

I just created #32956 for that. I will work on it tomorrow.


---

Comment by slabbe created at 2021-12-01 21:12:44

Replying to [comment:3 slabbe]:
> Remainings usage of `have_program` are:

I created #32957 to deal with remaining usage of `have_program`


---

Comment by slabbe created at 2021-12-09 17:15:41

Replying to [comment:43 slelievre]:
> That suggests `pdftocairo --svg file.pdf`
> will transform `file.pdf` to `file.svg`.
> 
> It seems poppler is widely packaged:
> 
> - https://repology.org/project/poppler/versions

I created #33005 to add the feature pdftocairo.
