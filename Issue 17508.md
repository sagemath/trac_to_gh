# Issue 17508: typo causes latex error in indexed generators

Issue created by migration from https://trac.sagemath.org/ticket/17745

Original creator: kcrisman

Original creation time: 2015-02-08 02:43:43

CC:  tscrim nthiery

See http://ask.sagemath.org/question/25763/incorrect-parsing-of-docstring-of-sagestructureindexed_generatorsindexedgenerators/
> where a \left is displayed as <=ft. It seems that \le in \left gets replaced by <=.
This is from #15289.


---

Comment by tscrim created at 2015-02-08 07:33:11

I believe this is a general issue with the parsing of latex docstrings to a more ascii version just being too greedy (because I saw it somewhere else IIRC). Do you happen to know where the code that does this substitution is?


---

Comment by aapitzsch created at 2015-02-08 10:27:16

Problem seems to be in `src/sage/misc/sagedoc.py`


```
math_substitutes = [
    ...
    ('\\le', '<='),
    ...
]
```



---

Comment by aapitzsch created at 2015-02-08 10:49:03

One solution might be to replace `'\\left'` and `'\\right'` by `''` before replacing `\\le`.


---

Comment by tscrim created at 2015-02-08 12:50:36

I agree, along with perhaps:

- `'\\lvert'` and `'\\rvert'` by `'|'`,
- `'\\ast'` by `*`,
- `'\\bigr'`, `'\\bigl'`, etc. by `''`.


---

Comment by jhpalmieri created at 2015-02-08 20:27:34

Here's an attempt at a fix, along the lines suggested.
----
New commits:


---

Comment by jhpalmieri created at 2015-02-08 20:27:42

Changing status from new to needs_review.


---

Comment by tscrim created at 2015-02-09 00:39:59

LGTM, but could you add one more test with a `\\left`, a `\\le`, and a `\\leq` to make sure all 3 get converted correctly? Thanks.


---

Comment by git created at 2015-02-09 16:12:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2015-02-09 16:13:54

Sure, here you go. Eventually, we might run into the same problem with `\\to` or `\\ge`; at some point we might want to change the whole system so it uses regular expressions instead of just a plain text `replace`.
----
New commits:


---

Comment by tscrim created at 2015-02-09 18:05:49

Thanks. Probably, but we'll cross that bridge if we come to it.


---

Comment by tscrim created at 2015-02-09 18:05:49

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2015-02-09 18:24:44

I realized that this won't work: it will turn `\\leftarrow` and `\\rightarrow` into `arrow`. I think regular expressions are the way to go.


---

Comment by jhpalmieri created at 2015-02-09 18:24:44

Changing status from positive_review to needs_work.


---

Comment by tscrim created at 2015-02-09 18:28:51

How about then just putting `\\leftarrow` and `\\rightarrow` before `\left` and `\right` (sending them to `<--` and `-->` respectively?


---

Comment by jhpalmieri created at 2015-02-09 18:43:35

Because I don't think we should actually be trying to run a serious LaTeX-to-text conversion here, and that's what this is in danger of becoming. What about `\leftrightarrow`, `\leftleftarrows`, etc.?


---

Comment by tscrim created at 2015-02-09 19:04:09

I'm not so familiar with using regular expressions, so if you can make it more elegant that way, then +1 from me.


---

Comment by git created at 2015-02-09 20:53:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2015-02-09 20:56:27

Here's a regular expression version.


---

Comment by jhpalmieri created at 2015-02-09 20:56:32

Changing status from needs_work to needs_review.


---

Comment by aapitzsch created at 2015-02-09 21:33:58

The current implementation replaces LaTeX commands in the examples section, too.
See for example

```
sage: from sage.structure.indexed_generators import IndexedGenerators
sage: IndexedGenerators?
```

That's bad. Users might complain, that they don't get the results show in the examples.

P.S. The ticket description should be updated.


---

Comment by jhpalmieri created at 2015-02-10 04:45:13

Replying to [comment:19 aapitzsch]:
> The current implementation replaces LaTeX commands in the examples section, too.

I think that's complicated to fix. We would need to detect when we're in an EXAMPLES or TESTS block and ignore the output, but otherwise process the output. I guess we can do that, but it's a little annoying to do perfectly. This really should be done for each of `detex`, `process_dollars`, `process_extlinks`, `process_mathtt`. So maybe it should actually be done in `format`:

```
if not in examples block:
    detex(next line)
    process_dollars(next_lines)
    ...
```

So everything would need to be rewritten with this logic in mind. Alternatively, each of those functions will duplicate some code which keeps track of whether it's processing a line in an examples block.

I think that really, functions which have LaTeX output in their EXAMPLES (or elsewhere in their docstrings), and if that LaTeX should not be processed, then they should have their docstrings decorated with `nodetex`. That's why `nodetex` is available. Maybe we should add it to the IndexedGenerators docstring.

> P.S. The ticket description should be updated.

Please go ahead. What did you have in mind?


---

Comment by git created at 2015-02-10 04:47:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kcrisman created at 2015-02-15 02:28:11

Probably this will also fix the followup comment at the ask.sagemath question:

```
sage: timeit("a = 2nb=131nfactor(a^b-1)", number=25)
  25 loops, best of 3: ... per loop
```



---

Comment by git created at 2015-02-15 17:05:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kcrisman created at 2015-02-21 21:53:02

And even more examples from the same place:

```
Another such issues appear for dirac_delta, heaviside, unit_step. A \left gets replaced by <=ft
```



---

Comment by tscrim created at 2015-02-22 01:17:57

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2015-02-22 01:17:57

I think this is a good step in the right direction; most importantly, it fixes the issue at hand. So I'm going to give this a positive review.


---

Comment by vbraun created at 2015-02-24 00:39:11

Resolution: fixed
