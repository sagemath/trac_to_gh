# Issue 27478: Jupyter notebook can crash during startup if default port cannot be used

archive/issues_027478.json:
```json
{
    "body": "Per reports like [this one](https://ask.sagemath.org/question/46075/sage-notebook-crashes-immediately), it seems there is some condition (I am not sure yet what) such that on Windows trying to bind to port 8888 results in a permission error, on which the notebook crashes:\n\n\n\n```\n[I 17:51:21.659 NotebookApp] Using MathJax: nbextensions/mathjax/MathJax.js Traceback (most recent call last):\n\nFile \"/opt/sagemath-8.6/src/bin/sage-notebook\", line 268, in <module> launcher(unknown)\n\nFile \"/opt/sagemath-8.6/src/bin/sage-notebook\", line 100, in __init__ main(argv)\n\nFile \"/opt/sagemath-8.6/local/lib/python2.7/site-packages/jupyter_core/application.py\", line 266, in launch_instance return super(JupyterApp, cls).launch_instance(argv=argv, **kwargs)\n\nFile \"/opt/sagemath-8.6/local/lib/python2.7/site-packages/traitlets/config/application.py\", line 657, in launch_instance app.initialize(argv)\n\nFile \"<decorator-gen-7>\", line 2, in initialize\nFile \"/opt/sagemath-8.6/local/lib/python2.7/site-packages/traitlets/config/application.py\", line 87, in catch_config_error return method(app, args, *kwargs)\n\nFile \"/opt/sagemath-8.6/local/lib/python2.7/site-packages/notebook/notebookapp.py\", line 1629, in initialize self.init_webapp()\n\nFile \"/opt/sagemath-8.6/local/lib/python2.7/site-packages/notebook/notebookapp.py\", line 1408, in init_webapp self.http_server.listen(port, self.ip)\n\nFile \"/opt/sagemath-8.6/local/lib/python2.7/site-packages/tornado/tcpserver.py\", line 142, in listen sockets = bind_sockets(port, address=address)\n\nFile \"/opt/sagemath-8.6/local/lib/python2.7/site-packages/tornado/netutil.py\", line 197, in bind_sockets sock.bind(sockaddr)\nFile \"/opt/sagemath-8.6/local/lib/python2.7/socket.py\", line 230, in meth return getattr(self._sock,name)(*args)\n\nsocket.error: [Errno 1] Operation not permitted\n```\n\n\nThe notebook already has some code to try other ports if the requested port fails:\n\n\n```python\n        for port in random_ports(self.port, self.port_retries+1):\n            try:\n                self.http_server.listen(port, self.ip)\n            except socket.error as e:\n                if e.errno == errno.EADDRINUSE:\n                    self.log.info(_('The port %i is already in use, trying another port.') % port)\n                    continue\n                elif e.errno in (errno.EACCES, getattr(errno, 'WSAEACCES', errno.EACCES)):\n                    self.log.warning(_(\"Permission to listen on port %i denied\") % port)\n                    continue\n                else:\n                    raise\n```\n\n\nHowever, in this case some reason users are getting `EPERM` instead of `EACCES` and that case is not handled in the above code.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27715\n\n",
    "created_at": "2019-04-23T11:37:54Z",
    "labels": [
        "notebook",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Jupyter notebook can crash during startup if default port cannot be used",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27478",
    "user": "embray"
}
```
Per reports like [this one](https://ask.sagemath.org/question/46075/sage-notebook-crashes-immediately), it seems there is some condition (I am not sure yet what) such that on Windows trying to bind to port 8888 results in a permission error, on which the notebook crashes:



```
[I 17:51:21.659 NotebookApp] Using MathJax: nbextensions/mathjax/MathJax.js Traceback (most recent call last):

File "/opt/sagemath-8.6/src/bin/sage-notebook", line 268, in <module> launcher(unknown)

File "/opt/sagemath-8.6/src/bin/sage-notebook", line 100, in __init__ main(argv)

File "/opt/sagemath-8.6/local/lib/python2.7/site-packages/jupyter_core/application.py", line 266, in launch_instance return super(JupyterApp, cls).launch_instance(argv=argv, **kwargs)

File "/opt/sagemath-8.6/local/lib/python2.7/site-packages/traitlets/config/application.py", line 657, in launch_instance app.initialize(argv)

File "<decorator-gen-7>", line 2, in initialize
File "/opt/sagemath-8.6/local/lib/python2.7/site-packages/traitlets/config/application.py", line 87, in catch_config_error return method(app, args, *kwargs)

File "/opt/sagemath-8.6/local/lib/python2.7/site-packages/notebook/notebookapp.py", line 1629, in initialize self.init_webapp()

File "/opt/sagemath-8.6/local/lib/python2.7/site-packages/notebook/notebookapp.py", line 1408, in init_webapp self.http_server.listen(port, self.ip)

File "/opt/sagemath-8.6/local/lib/python2.7/site-packages/tornado/tcpserver.py", line 142, in listen sockets = bind_sockets(port, address=address)

File "/opt/sagemath-8.6/local/lib/python2.7/site-packages/tornado/netutil.py", line 197, in bind_sockets sock.bind(sockaddr)
File "/opt/sagemath-8.6/local/lib/python2.7/socket.py", line 230, in meth return getattr(self._sock,name)(*args)

socket.error: [Errno 1] Operation not permitted
```


The notebook already has some code to try other ports if the requested port fails:


```python
        for port in random_ports(self.port, self.port_retries+1):
            try:
                self.http_server.listen(port, self.ip)
            except socket.error as e:
                if e.errno == errno.EADDRINUSE:
                    self.log.info(_('The port %i is already in use, trying another port.') % port)
                    continue
                elif e.errno in (errno.EACCES, getattr(errno, 'WSAEACCES', errno.EACCES)):
                    self.log.warning(_("Permission to listen on port %i denied") % port)
                    continue
                else:
                    raise
```


However, in this case some reason users are getting `EPERM` instead of `EACCES` and that case is not handled in the above code.

Issue created by migration from https://trac.sagemath.org/ticket/27715





---

archive/issue_comments_387455.json:
```json
{
    "body": "As it happens, the [POSIX specification for bind()](https://pubs.opengroup.org/onlinepubs/009695399/functions/bind.html) does not mention `EPERM` as an expected error, just `EACCES`.  Perhaps this is a Cygwin-specific bug.  Will have to dig a bit to see where it might be coming from.",
    "created_at": "2019-04-23T11:44:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27478",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27478#issuecomment-387455",
    "user": "embray"
}
```

As it happens, the [POSIX specification for bind()](https://pubs.opengroup.org/onlinepubs/009695399/functions/bind.html) does not mention `EPERM` as an expected error, just `EACCES`.  Perhaps this is a Cygwin-specific bug.  Will have to dig a bit to see where it might be coming from.



---

archive/issue_comments_387456.json:
```json
{
    "body": "I confirmed that this is [likely a bug in Cygwin](https://cygwin.com/ml/cygwin/2019-04/msg00161.html).  For now though it is easiest to workaround in the Notebook code.",
    "created_at": "2019-04-23T12:51:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27478",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27478#issuecomment-387456",
    "user": "embray"
}
```

I confirmed that this is [likely a bug in Cygwin](https://cygwin.com/ml/cygwin/2019-04/msg00161.html).  For now though it is easiest to workaround in the Notebook code.



---

archive/issue_comments_387457.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-04-23T13:56:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27478",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27478#issuecomment-387457",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_387458.json:
```json
{
    "body": "I'm okay, in this case, with just patching the package in Sage, since the patch is only needed (in some cases) on Cygwin, so it won't be needed by most other downstream packagers, etc.\n\nI will just note for the record that the issue *could* be worked around by monkey-patching, but this is probably easier in this case.\n----\nNew commits:",
    "created_at": "2019-04-23T13:56:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27478",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27478#issuecomment-387458",
    "user": "embray"
}
```

I'm okay, in this case, with just patching the package in Sage, since the patch is only needed (in some cases) on Cygwin, so it won't be needed by most other downstream packagers, etc.

I will just note for the record that the issue *could* be worked around by monkey-patching, but this is probably easier in this case.
----
New commits:



---

archive/issue_comments_387459.json:
```json
{
    "body": "I will also probably backport this to Sage 8.7 for Windows now that I have a mechanism for that.",
    "created_at": "2019-04-23T13:57:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27478",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27478#issuecomment-387459",
    "user": "embray"
}
```

I will also probably backport this to Sage 8.7 for Windows now that I have a mechanism for that.



---

archive/issue_comments_387460.json:
```json
{
    "body": "Note possible slight conflict with #26919.",
    "created_at": "2019-04-24T14:34:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27478",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27478#issuecomment-387460",
    "user": "embray"
}
```

Note possible slight conflict with #26919.



---

archive/issue_comments_387461.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-04-25T02:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27478",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27478#issuecomment-387461",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_387462.json:
```json
{
    "body": "LGTM.",
    "created_at": "2019-04-25T02:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27478",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27478#issuecomment-387462",
    "user": "tscrim"
}
```

LGTM.



---

archive/issue_comments_387463.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-04-29T12:35:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27478",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27478#issuecomment-387463",
    "user": "vbraun"
}
```

Resolution: fixed
