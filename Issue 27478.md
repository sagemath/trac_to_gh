# Issue 27478: Jupyter notebook can crash during startup if default port cannot be used

Issue created by migration from https://trac.sagemath.org/ticket/27715

Original creator: embray

Original creation time: 2019-04-23 11:37:54

Per reports like [this one](https://ask.sagemath.org/question/46075/sage-notebook-crashes-immediately), it seems there is some condition (I am not sure yet what) such that on Windows trying to bind to port 8888 results in a permission error, on which the notebook crashes:



```
[I 17:51:21.659 NotebookApp] Using MathJax: nbextensions/mathjax/MathJax.js Traceback (most recent call last):

File "/opt/sagemath-8.6/src/bin/sage-notebook", line 268, in <module> launcher(unknown)

File "/opt/sagemath-8.6/src/bin/sage-notebook", line 100, in __init__ main(argv)

File "/opt/sagemath-8.6/local/lib/python2.7/site-packages/jupyter_core/application.py", line 266, in launch_instance return super(JupyterApp, cls).launch_instance(argv=argv, **kwargs)

File "/opt/sagemath-8.6/local/lib/python2.7/site-packages/traitlets/config/application.py", line 657, in launch_instance app.initialize(argv)

File "<decorator-gen-7>", line 2, in initialize
File "/opt/sagemath-8.6/local/lib/python2.7/site-packages/traitlets/config/application.py", line 87, in catch_config_error return method(app, args, *kwargs)

File "/opt/sagemath-8.6/local/lib/python2.7/site-packages/notebook/notebookapp.py", line 1629, in initialize self.init_webapp()

File "/opt/sagemath-8.6/local/lib/python2.7/site-packages/notebook/notebookapp.py", line 1408, in init_webapp self.http_server.listen(port, self.ip)

File "/opt/sagemath-8.6/local/lib/python2.7/site-packages/tornado/tcpserver.py", line 142, in listen sockets = bind_sockets(port, address=address)

File "/opt/sagemath-8.6/local/lib/python2.7/site-packages/tornado/netutil.py", line 197, in bind_sockets sock.bind(sockaddr)
File "/opt/sagemath-8.6/local/lib/python2.7/socket.py", line 230, in meth return getattr(self._sock,name)(*args)

socket.error: [Errno 1] Operation not permitted
```


The notebook already has some code to try other ports if the requested port fails:


```python
        for port in random_ports(self.port, self.port_retries+1):
            try:
                self.http_server.listen(port, self.ip)
            except socket.error as e:
                if e.errno == errno.EADDRINUSE:
                    self.log.info(_('The port %i is already in use, trying another port.') % port)
                    continue
                elif e.errno in (errno.EACCES, getattr(errno, 'WSAEACCES', errno.EACCES)):
                    self.log.warning(_("Permission to listen on port %i denied") % port)
                    continue
                else:
                    raise
```


However, in this case some reason users are getting `EPERM` instead of `EACCES` and that case is not handled in the above code.


---

Comment by embray created at 2019-04-23 11:44:58

As it happens, the [POSIX specification for bind()](https://pubs.opengroup.org/onlinepubs/009695399/functions/bind.html) does not mention `EPERM` as an expected error, just `EACCES`.  Perhaps this is a Cygwin-specific bug.  Will have to dig a bit to see where it might be coming from.


---

Comment by embray created at 2019-04-23 12:51:15

I confirmed that this is [likely a bug in Cygwin](https://cygwin.com/ml/cygwin/2019-04/msg00161.html).  For now though it is easiest to workaround in the Notebook code.


---

Comment by embray created at 2019-04-23 13:56:34

Changing status from new to needs_review.


---

Comment by embray created at 2019-04-23 13:56:34

I'm okay, in this case, with just patching the package in Sage, since the patch is only needed (in some cases) on Cygwin, so it won't be needed by most other downstream packagers, etc.

I will just note for the record that the issue _could_ be worked around by monkey-patching, but this is probably easier in this case.
----
New commits:


---

Comment by embray created at 2019-04-23 13:57:30

I will also probably backport this to Sage 8.7 for Windows now that I have a mechanism for that.


---

Comment by embray created at 2019-04-24 14:34:03

Note possible slight conflict with #26919.


---

Comment by tscrim created at 2019-04-25 02:16:10

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2019-04-25 02:16:10

LGTM.


---

Comment by vbraun created at 2019-04-29 12:35:49

Resolution: fixed
