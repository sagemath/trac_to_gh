# Issue 21394: avoid repackaging of Singular4

Issue created by migration from Trac.

Original creator: jakobkroeker

Original creation time: 2016-10-03 18:55:45

CC:  john_perry klee vbraun jdemeyer

Keywords: Singular upgrade

to use xalloc in debug mode (SAGE_DEBUG=yes),
Singular4 has to be repackaged since at least the 
folder 'xalloc' is not autoconfigured. This is unfortunate.


=> fix the issue in such a way that it will be accepted upstream


---

Comment by jakobkroeker created at 2016-10-04 19:59:32

now xalloc should be autoconfigured upstream, see
https://github.com/Singular/Sources/pull/795


---

Comment by jpflori created at 2016-10-19 12:15:27

New upstream tarball:
* http://www.mathematik.uni-kl.de/ftp/pub/Math/Singular/SOURCES/4-0-3/singular-4.0.3p4.tar.gz

4.0.4 should be out soon including a fix needed for NTL 10+.


---

Comment by jpflori created at 2016-10-24 13:11:00

Changing priority from minor to major.


---

Comment by jpflori created at 2016-10-24 13:11:00

There is also the segfault mentioned by FranÃ§ois at #21676#comment:11 when calling singular kernel function.

At the time of cleaning up, it seems we end up with a ring set to NULL and call p_Delete with that at 
* https://github.com/Singular/Sources/blob/spielwiese/libpolys/polys/simpleideals.cc#L133


---

Comment by jpflori created at 2016-10-24 13:33:49

With the previous version merge with trac/develop, no issue.


---

Comment by fbissey created at 2016-10-24 20:10:20

Replying to [comment:4 jpflori]:
> With the previous version merge with trac/develop, no issue.

What do you mean by this?


---

Comment by jpflori created at 2016-10-24 20:20:18

Sorry, I typed too fast.
This makes no sense.
The singular update to 4.0.3p3 + fixes is currently in trac/develop.


---

Comment by fbissey created at 2016-10-24 20:23:47

In sage-on-gentoo I actually shipped 7.4 with singular 4.0.3p3 which indeed works fine. So the behavior with 4.0.3p4 was a big shock.


---

Comment by jpflori created at 2016-10-24 20:29:17

Yes the issue arises when deallocating from singular the args passed to the mres function (I would say a list of vectors with ring set to NULL).
Didn't find out yet what changed.
Hopefully I'll be successfull tomorrow.


---

Comment by jpflori created at 2016-10-25 09:59:30

Here is what changed:
* in 4.0.3p3 `sleftv::CleanUp` was called from `iiExpr2Arith` with ring set and then once again in Sage's `handle_call` method without a ring set but on a empty `sleftv` which just did nothing
* in 4.0.3p4 it is only called the second time on a non-empty `leftv` without a ring set and boom.


---

Comment by jpflori created at 2016-10-25 10:04:34

Here you go:
* https://github.com/Singular/Sources/commit/86ce458e1269a1d57e682c12b9154dd1f1459354


---

Comment by jpflori created at 2016-10-25 10:12:11

Ask for advice here:
* https://groups.google.com/forum/#!topic/libsingular-devel/BKGa51UV-hw


---

Comment by jpflori created at 2016-10-25 10:24:49

New commits:


---

Comment by git created at 2016-10-25 14:22:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2016-10-25 14:28:46

Still issues with matrix ordering...
Maybe my comment here:
* #17254#comment:157
Was not so wrong.
But there is also
* #17254#comment:196
and
* #17254#comment:199

See also:
* https://groups.google.com/forum/#!topic/libsingular-devel/jregxl-k8Mw


---

Comment by jpflori created at 2016-10-25 14:53:30

Looks like both issues about "local/mixed" and total degree are related to this commit:
* https://github.com/Singular/Sources/commit/45f4b2d83e0b667a78f6a5d22c428bf88f28fca7
and commits following it.
Now the `p_WTotalDegree` function gives negative results so the Sage hackish code returns `-1`.


---

Comment by jpflori created at 2016-10-25 15:01:44

In fact we now end up in a "very bad" block because of the matrix entries set to `0`:
* https://github.com/Singular/Sources/commit/0d91221c4a45f7a2621d280d09e628b3e963a60d#diff-d09c8493af07f5c7209a8ad3ce8842feR3826

```
+          else
+          {
+            // very bad:
+            nonpos++;
+            nonneg++;
+            found=1;
+          }
```

which leads to `OrdSgn = -1` (and `MixedOrd = 1`) whereas before we had `OrdSgn = -1`.

Not sure what should happen when matrix ordering has zeros inside.
CC'ing knowledgeable people...


---

Comment by jpflori created at 2016-10-25 15:12:38

Opened
* https://groups.google.com/forum/#!topic/libsingular-devel/OjJUi3zw04E
for discussion.


---

Comment by jpflori created at 2016-10-25 15:18:32

There is also:
* https://groups.google.com/forum/#!topic/libsingular-devel/dulzKFTF3g8
suggesting to use `p_FDeg` or p_LDeg`.


---

Comment by john_perry created at 2016-10-25 15:26:44

Replying to [comment:16 jpflori]:
> Not sure what should happen when matrix ordering has zeros inside.

If the first nonzero element in each column is positive, the ordering is global. From the comments, it says they look at "other blocks." I don't remember offhand how wvhdl works in this case (not sure I ever knew) but it's not clear to me they're looking further down the column than the first row. If not, that would be a bug.


---

Comment by jpflori created at 2016-10-25 15:45:35

What is sure is that in the case

```
            sage: tord = TermOrder(matrix([3,0,1,1,1,0,1,0,0]))
```

singular gets a `OrdSgn = -1` now.

And I get

```
sage: tord=TermOrder(matrix([3,0,1,1,1,0,1,0,0]))
sage: R.<x,y,z> = PolynomialRing(QQ,3,order=tord)
sage: x.parent()._singular_()

polynomial ring, over a field, mixed ordering
//   characteristic : 0
//   number of vars : 3
//        block   1 : ordering M
//                  : names    x y z
//                  : weights  3 0 1
//                  : weights  1 1 0
//                  : weights  1 0 0
//        block   2 : ordering C
sage: 
```



---

Comment by jpflori created at 2016-10-25 15:46:43

It also depends on what you mean by positive...


---

Comment by jpflori created at 2016-10-25 15:49:21

Form the "very bad" snippet, any zero entry (in at least the first row) makes it a mixed ordering.


---

Comment by git created at 2016-10-25 16:33:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2016-10-25 18:16:51

Changing status from new to needs_review.


---

Comment by jpflori created at 2016-10-25 18:16:51

It seems most failing doctests are gone.
* `Fatal: Memory exhausted` in `sage -t --long src/sage/modular/local_comp/type_space.py` which might be unrelated.


---

Comment by jpflori created at 2016-10-26 14:54:38

I can confirm the above issue also happends without the update to 4.0.3p4 so it should not prevent this ticket from being merged.


---

Comment by jdemeyer created at 2016-10-26 17:42:07

1. I think it's better to keep the touching in `spkg-src` instead of moving it to `spkg-install`.

2. Why this change? You don't seem to use the newly-cimported stuff

```diff
diff --git a/src/sage/libs/singular/polynomial.pyx b/src/sage/libs/singular/polynomial.pyx
index e243fae..83b5104 100644
--- a/src/sage/libs/singular/polynomial.pyx
+++ b/src/sage/libs/singular/polynomial.pyx
`@``@` -22,7 +22,7 `@``@` plusminus_pattern = re.compile("([^\(^])([\+\-])")
 from sage.libs.singular.decl cimport number, ideal
 from sage.libs.singular.decl cimport currRing, rChangeCurrRing
 from sage.libs.singular.decl cimport p_Copy, p_Add_q, p_Neg, pp_Mult_nn, p_GetCoeff, p_IsConstant, p_Cmp, pNext
-from sage.libs.singular.decl cimport p_GetMaxExp, pp_Mult_qq, pPower, p_String, p_GetExp, p_Deg, p_Totaldegree, p_WTotaldegree, p_WDegree
+from sage.libs.singular.decl cimport p_GetMaxExp, pp_Mult_qq, pPower, p_String, p_GetExp, p_Deg, p_Totaldegree, p_WTotaldegree, p_WDegree, p_LDeg, p_FDeg
 from sage.libs.singular.decl cimport n_Delete, idInit, fast_map_common_subexp, id_Delete
 from sage.libs.singular.decl cimport omAlloc0, omStrDup, omFree
 from sage.libs.singular.decl cimport p_GetComp, p_SetComp
```


3. Remove this: `#return p_Deg(p, r)`


---

Comment by jdemeyer created at 2016-10-26 17:42:07

Changing status from needs_review to needs_work.


---

Comment by fbissey created at 2016-10-27 09:55:46

The current patch works for me to solve the segfault problems. Pending the revisions asked by Jeroen, I am ok with this.


---

Comment by git created at 2016-10-27 10:23:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2016-10-27 10:30:18

Points 2 and 3 addressed.

I can go with point 1 but that means repackaging the tarball.
Will the patchbots and Volker be happy?


---

Comment by jpflori created at 2016-10-27 10:35:25

I've reported the issue here:
* https://groups.google.com/forum/#!topic/libsingular-devel/OdaD7HctT9Q


---

Comment by git created at 2016-10-27 11:48:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2016-10-27 11:50:05

Dealt with point 1.
The tarball changed.


---

Comment by jpflori created at 2016-10-27 11:50:05

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2016-10-31 04:08:19

Replying to [comment:29 jpflori]:
> Points 2 and 3 addressed.
> 
> I can go with point 1 but that means repackaging the tarball.
> Will the patchbots and Volker be happy?
Depends whether or not he already uploaded it on the mirrors or not. This hasn't got through his develop branch on github so probably not.

Putting it to positive review.


---

Comment by fbissey created at 2016-10-31 04:08:19

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2016-10-31 04:39:39

Changing status from positive_review to needs_info.


---

Comment by fbissey created at 2016-10-31 04:39:39

Stop! I thought this release was supposed to have the fix for ntl 10+. But it isn't there, in the tarball or the patches directory. Do we want to proceed with that?


---

Comment by jpflori created at 2016-10-31 09:43:54

Changing status from needs_info to positive_review.


---

Comment by jpflori created at 2016-10-31 09:43:54

I'd say we merge now and add a patch in the ntl10 ticket #21676.
More work will also be needed for a better debug mode #21624 but I need Hans' feedback on that one as there might be some bugs in singular itself.


---

Comment by vbraun created at 2016-11-02 19:18:16

There are now a lot more warnings in debug mode but I'll leave that to you in #21624


---

Comment by vbraun created at 2016-11-02 19:20:16

Resolution: fixed


---

Comment by jhpalmieri created at 2016-11-12 01:10:38

See #21865 for a followup.


---

Comment by jdemeyer created at 2016-11-12 08:08:56

Did somebody verify that all patches which are removed in this ticket are actually upstreamed in this Singular version? If not, we might have an easy fix for #21865.
