# Issue 21376: Don't use make for autogenerated modules in sagelib

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2016-09-29 15:45:29

CC:  mkoeppe jdemeyer

Currently there is a `src/Makefile` at the root of the sagelib sources that is required to be invoked in order to make sure the packages in `sage_setup.autogen` and that autogenerated sources are placed in the sage sources before running its `setup.py install`.

#21480 inverts things somewhat by removing the old Makefile (really making it into a no-op for now), but pulling out the `sage_setup.autogen` stuff into a separate makefile that is still invoked by calling `make` from the `setup.py` (in the current version of that ticket it is even called unconditionally).  This is pretty non-standard.

The appropriate time to do this would be either just before the `build_py` command is run, or the `build_ext` command is run (in the case of autogenerated sources for extension modules).

In the current cases we have its very trivial to check whether or not any of the sources actually need to be regenerated, and this is a pretty normal thing to do in some other complex Python packages.  For example, the package responsible for generating the source files (e.g. currently the `sage_setup.autogen` sub-packages) simply needs to be responsible for knowing what its own source code files are, and knowing the paths for its generated sources--then just compare modtimes.

One can do even better by having one of the generated files be a hash of the source files, and compare the hashes instead (this avoids rebuilds when switching between git branches but where the files didn't otherwise change).


---

Comment by mkoeppe created at 2016-09-29 18:05:06

From the description:
> The appropriate time to do this would be either just before the build_py command is run, or the build_ext command is run (in the case of autogenerated sources for extension modules).

Could you make a ticket on top of #21480 (and probably #21604) that moves the invocation of `make  -f generate_py_source.mk` to the right place?


---

Comment by jdemeyer created at 2016-09-30 08:40:15

Replying to [comment:2 mkoeppe]:
> Could you make a ticket on top of #21480 (and probably #21604) that moves the invocation of `make  -f generate_py_source.mk` to the right place?

That's not so easy, for the same reason that #21600 is not so easy. We need to pass the list of Python packages, Cython extensions and data_files to `setup()`. It is harder to get this right if not everything has been generated at that point. We should probably compute the list of packages dynamically in `setup()`.


---

Comment by jdemeyer created at 2016-09-30 08:42:31

Again, the title of this ticket does not match the long description. Do you want to get rid of `make` or just move the invocation of `make -f generate_py_source.mk` inside `setup()`?


---

Comment by embray created at 2016-09-30 10:12:43

I think it does match but I'm not sure what's unclear.


---

Comment by embray created at 2016-09-30 10:13:21

I feel like this is not hard, having done it many times before.  There's nothing particularly special about sage either in any of these regards.


---

Comment by embray created at 2016-10-06 10:20:36

Set assignee to embray.


---

Comment by embray created at 2016-10-07 12:08:52

Changing status from new to needs_review.


---

Comment by embray created at 2016-10-07 12:08:52

Determine directly in the Python code whether or not autogenerated sources need to be built, without requiring a makefile or anything.  I think this is simple and clear to anyone who looks at the code.

If in the future we want more full make-like capabilities I've got something in the works for that, but it seems unlikely that anything more complicated than this is needed any time soon.
----
Last 10 new commits:


---

Comment by mkoeppe created at 2016-10-09 21:10:44

This looks nice and easy to understand. 
But let's get #21600 done before we full review this one.


---

Comment by mkoeppe created at 2016-10-14 06:18:21

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2016-10-14 06:18:21

On this ticket, [0394333](https://git.sagemath.org/sage.git/commit?id=0394333a54e51c53b9404f248220a412cf13e00e) needs to be reverted, `generate_py_source` removed again from `MANIFEST.in`

(Of course, the manifest is out-of-date in many respects (#21516).)


---

Comment by embray created at 2016-10-14 08:23:16

Indeed. I just noticed that MANIFEST.in contains MANIFEST.in, which it really doesn't need to do :)


---

Comment by git created at 2016-10-14 08:24:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2016-10-14 08:25:08

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2016-10-17 03:42:17

This needs rebasing on top of current develop and possibly some work there.
Building from scratch (with 7.4.rc2 merged) fails for me with:

```
No such file or directory: '/doesnotexist/sage/libs/pari/paridecl.pxd'
```

(this is from #21480).


---

Comment by mkoeppe created at 2016-10-17 03:42:17

Changing status from needs_review to needs_work.


---

Comment by embray created at 2016-10-17 09:36:11

Ok, but I'm a little confused--this branch is based on the branch in #21600.  Was that rebased, or in need of rebasing too?


---

Comment by mkoeppe created at 2016-10-17 14:00:46

Probably easiest to just merge current develop, not rebase.


---

Comment by embray created at 2016-10-17 14:18:13

Oh I see, this is because `sage_setup.autogen` uses `SAGE_SRC`.  I guess it would be fine to just remove that, under the assumption that sage's `setup.py` is always run from the root of the sagelib source directory.


---

Comment by embray created at 2016-10-17 14:21:33

Alternatively, would you be opposed to changing the Makefile so that `SAGE_SRC` is just set to `.`?  There are places in the code where it makes sense to have `SAGE_SRC` set outside the context of building (e.g. testing), but where when building it should just be `.`.


---

Comment by mkoeppe created at 2016-10-17 14:24:54

Replying to [comment:20 embray]:
> Alternatively, would you be opposed to changing the Makefile so that `SAGE_SRC` is just set to `.`?  There are places in the code where it makes sense to have `SAGE_SRC` set outside the context of building (e.g. testing), but where when building it should just be `.`.

Please don't do that.
setup.py needs to be able to run without SAGE_SRC set.
That's the whole point of #21480.


---

Comment by embray created at 2016-10-17 14:35:49

That's sort of what I thought.  The problem is that there is code in this package that needs to be able to run in both a "build" environment and a "runtime" environment.  I agree that in the "build" environment it should not depend on `SAGE_SRC`.

However, prior to this ticket the `setup.py` was depending on `SAGE_SRC` anyways, implicitly, through running Python from the makefile.

I could modify that code to only use `SAGE_SRC` if it is set, but that's not going to work because it _is_ set to "/doesnotexist".  I could check explicitly for that path but that's rather ugly too.


---

Comment by embray created at 2016-10-17 14:37:56

How about this:  As a special case, when `sys.argv[0] == 'setup.py'` we could set `SAGE_SRC` in `sage.env` to `'.'`?


---

Comment by mkoeppe created at 2016-10-17 14:41:14

Why not just set the environment variable in setup.py?
That's what was done (well, for a subprocess) before this ticket.


---

Comment by embray created at 2016-10-17 14:42:50

Ah, so _that's_ ok so long as it's not coming from the outer environment in which `setup.py` is run.  That makes sense--thanks for the suggestion.


---

Comment by embray created at 2016-10-17 14:44:40

Ok, I'm confused again because `setup.py` _is_ setting `SAGE_SRC` to `os.getcwd()`, quite early on too.  So I'm not sure why that's being dropped.  The autogen code isn't being run in a subprocess, at least I don't think.


---

Comment by mkoeppe created at 2016-10-17 14:47:23

This is exactly what you need to debug; it worked before.


---

Comment by git created at 2016-10-17 14:53:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2016-10-17 14:53:39

Fixed--there were some dangling uses of `os.environ` is `sage_setup.autogen.pari`.


---

Comment by git created at 2016-10-17 14:55:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-10-17 15:08:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2016-10-18 04:49:07

Changing status from needs_work to positive_review.


---

Comment by mkoeppe created at 2016-10-18 04:49:07

Looks good.


---

Comment by vbraun created at 2016-10-20 21:24:34

Merge conflict


---

Comment by vbraun created at 2016-10-20 21:24:34

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2016-10-20 23:55:17

This is not actionable unless you tell us with which ticket it conflicts.


---

Comment by vbraun created at 2016-10-21 06:54:49

Just wait for the next beta


---

Comment by mkoeppe created at 2016-10-22 18:28:02

Erik: The branch on this ticket also has some of Jeroen's changes in it that are not yet in 7.5.beta0. From which ticket are they? It should be added to dependencies.


---

Comment by jdemeyer created at 2016-11-05 17:01:52

I'm adding #21820 as dependency because this ticket would conflict with that.


---

Comment by embray created at 2016-11-07 13:51:16

Or, since this ticket already had a positive review pending resolution of merge conflicts, you could make #21820 depend on this.


---

Comment by jdemeyer created at 2016-11-07 13:56:37

Replying to [comment:38 embray]:
> Or, since this ticket already had a positive review

"ha*d*" is the important word here. Adding a dependency on a needs_work ticket with no activity for 2 weeks did not seem like a wise move to me.

But I don't want to upset you. So feel free to undo [comment:37] if you fix this ticket.


---

Comment by git created at 2016-11-07 14:01:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2016-11-07 14:03:30

Changing status from needs_work to needs_review.


---

Comment by embray created at 2016-11-07 14:03:30

Rebased--this was just based on a slightly older version of #21600 that was ultimately merged.


---

Comment by jdemeyer created at 2016-11-07 14:13:06

In order to at least _minimize_ the conflict with #21820 and #21821, can you revert the unneeded changes to `src/sage_setup/autogen/pari/parser.py`?


---

Comment by jdemeyer created at 2016-11-07 14:16:05

Changing status from needs_review to needs_work.


---

Comment by embray created at 2016-11-07 16:01:25

I would be happy to, but as it stands that change is needed, per [comment:15].  Now that I'm back from vacation and we can sync up better we can keep the dependencies if you want.  I just figured it would be easier for you to understand this change and build on top of it, rather than for me to do the same with #21820 and #21821.


---

Comment by jdemeyer created at 2016-11-07 16:13:59

Replying to [comment:44 embray]:
> I would be happy to, but as it stands that change is needed, per [comment:15].

I am missing something. Why doesn't the same code fail right now (without applying this branch)?


---

Comment by jdemeyer created at 2016-11-07 16:19:57

Besides the fact that the code using `sage.env` conflicts with #21821, I think it is also bad style for `setup.py` to import `sage.env` while building `sage`.


---

Comment by embray created at 2016-11-07 16:23:13

Replying to [comment:45 jdemeyer]:
> Replying to [comment:44 embray]:
> > I would be happy to, but as it stands that change is needed, per [comment:15].
> 
> I am missing something. Why doesn't the same code fail right now (without applying this branch)?

Previously, when `make` was invoked, it was passed `SAGE_SRC=...`.


---

Comment by jdemeyer created at 2016-11-07 16:40:24

Replying to [comment:47 embray]:
> Previously, when `make` was invoked, it was passed `SAGE_SRC=...`.

Right, I see. That's an ugly hack though.

I changed #21821 such that it doesn't need `SAGE_SRC`.


---

Comment by mkoeppe created at 2016-11-18 01:21:27

needs rebasing...


---

Comment by git created at 2016-11-18 16:16:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-11-18 16:19:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-11-19 08:05:22

Somewhere you should add a Python equivalent of

```
rm -f sage/libs/pari/auto_*.pxi
```



---

Comment by embray created at 2016-11-21 10:47:39

I don't really think that belongs here in the first place but okay.


---

Comment by git created at 2016-11-21 10:53:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2016-11-21 10:54:42

Changing status from needs_work to needs_review.


---

Comment by embray created at 2016-11-21 10:54:42

New commits:


---

Comment by jdemeyer created at 2016-11-22 10:53:58

In #21820, some paths changed. In particular, the generated files are now in `src/sage/libs/cypari2`.


---

Comment by jdemeyer created at 2016-11-22 10:53:58

Changing status from needs_review to needs_work.


---

Comment by embray created at 2016-11-22 13:18:09

Yes, I see that now. Incidentally _building_ still worked, it just built the files in the wrong place.


---

Comment by git created at 2016-11-22 13:23:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-11-22 13:27:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2016-11-22 13:27:21

Changing status from needs_work to needs_review.


---

Comment by embray created at 2016-11-22 13:27:21

New commits:


---

Comment by mkoeppe created at 2016-12-06 19:23:47

Looks good to me; though the description of this ticket could use updating.


---

Comment by mkoeppe created at 2016-12-06 19:23:47

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-12-07 23:30:01

Resolution: fixed


---

Comment by chapoton created at 2016-12-10 11:18:38

Some changes made here are not py3 compatible, and need to be corrected to be so.

try:

```
export SAGE_PYTHON3=yes 
make build
```



---

Comment by chapoton created at 2016-12-11 09:53:38

proposal fix in #22044


---

Comment by jdemeyer created at 2016-12-26 09:27:45

Breakage: #22094.
