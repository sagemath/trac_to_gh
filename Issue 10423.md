# Issue 10423: Problems interrupting Singular

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2010-12-14 19:45:24

Assignee: was

CC:  malb burcin rbeezer

Keywords: interrupt singular expect

Type the following:

```
sage: singular._expect_expr("1")
```

Now type `CTRL-C`.  It takes a very long time before something happens.  This was the cause of #9163 (which was fixed to avoid this issue).


---

Comment by jdemeyer created at 2010-12-14 19:54:01

I suspect this is behind it, start Singular and press `CTRL-C`:

```
$ sage -singular
                     SINGULAR                             /  Development
 A Computer Algebra System for Polynomial Computations   /   version 3-1-1
                                                       0<
     by: G.-M. Greuel, G. Pfister, H. Schoenemann        \   Feb 2010
FB Mathematik der Universitaet, D-67653 Kaiserslautern    \
> ^C// ** Interrupt at cmd:`$INVALID$` in line:''
abort command(a), continue(c) or quit Singular(q) ?
```

So we get a stupid prompt instead.


---

Comment by vbraun created at 2011-01-03 11:58:47

I find that it takes about 5 seconds, not "very long". On a closer look, it actually takes 6 seconds = 20*0.3:


```python
Definition:	singular.interrupt(self, tries=20, timeout=0.29999999999999999, quit_on_fail=True)
Source:
    def interrupt(self, tries=20, timeout=0.3, quit_on_fail=True):
        E = self._expect
        if E is None:
            return True
        success = False
        try:
            for i in range(tries):
                E.sendline(self._quit_string())
                E.sendline(chr(3))
                try:
                    E.expect(self._prompt, timeout=timeout)
                    success= True
                    break
                except (pexpect.TIMEOUT, pexpect.EOF), msg:
                    #print msg
                    pass
        except Exception, msg:
            pass
        if success:
            pass
        elif quit_on_fail:
            self.quit()
        return success
```


  * The inherited method `interrupt()` actually tries to quit Singular (`self._quit_string()=="quit"`)
  * If quitting did not work the first time, is it going to work the next 19 times?
  * From personal experience, I find that actually interrupting (using ctrl-c and "continue") Singular often does not work. Restarting is very fast, though. 

I propose that the Singular pexpect interface override `interrupt()` to be a synonym for `quit()`.


---

Comment by jdemeyer created at 2012-05-28 02:01:48

Changing priority from major to blocker.


---

Comment by jdemeyer created at 2012-05-28 02:02:05

Changing keywords from "interrupt singular expect" to "interrupt singular expect sd40.5".


---

Comment by jdemeyer created at 2012-05-29 05:06:54

I'm having a hard time fixing this with pexpect, it's too unreliable.  Next strategy is patching Singular not to show the stupid interrupt prompt...


---

Attachment

Diff for the singular spkg. For reference / review only.


---

Comment by jdemeyer created at 2012-06-18 21:07:13

Changing status from new to needs_review.


---

Attachment


---

Comment by vbraun created at 2012-06-20 13:56:26

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2012-06-20 13:56:26

Running the doctest in a loop, I get occasional (maybe 1 in 20) failures

```
sage -t -force_lib "devel/sage/sage/interfaces/singular.py" 
**********************************************************************
File "/home/vbraun/opt/sage-5.1.beta5/devel/sage/sage/interfaces/singular.py", line 480:
    sage: 2*a
Exception raised:
    Traceback (most recent call last):
      File "/home/vbraun/opt/sage-5.1.beta5/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/home/vbraun/opt/sage-5.1.beta5/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/home/vbraun/opt/sage-5.1.beta5/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_9[6]>", line 1, in <module>
        Integer(2)*a###line 480:
    sage: 2*a
      File "element.pyx", line 1687, in sage.structure.element.RingElement.__mul__ (sage/structure/element.c:12755)
      File "coerce.pyx", line 749, in sage.structure.coerce.CoercionModel_cache_maps.bin_op (sage/structure/coerce.c:6778)
      File "coerce.pyx", line 745, in sage.structure.coerce.CoercionModel_cache_maps.bin_op (sage/structure/coerce.c:6718)
      File "element.pyx", line 1682, in sage.structure.element.RingElement.__mul__ (sage/structure/element.c:12681)
      File "element.pyx", line 1689, in sage.structure.element.RingElement._mul_ (sage/structure/element.c:12807)
      File "/home/vbraun/opt/sage-5.1.beta5/local/lib/python/site-packages/sage/interfaces/interface.py", line 1118, in _mul_
        return self._operation('*', right)
      File "/home/vbraun/opt/sage-5.1.beta5/local/lib/python/site-packages/sage/interfaces/interface.py", line 1075, in _operation
        raise TypeError, msg
    TypeError: Singular error:
       ? `sage449` is not defined
       ? error occurred in or before STDIN line 11: `def sage458=sage450 * sage449;`
**********************************************************************
1 items had failures:
   1 of   8 in __main__.example_9
```



---

Comment by jdemeyer created at 2012-06-24 22:31:26

Well, improving the function from working less than 5% of the time to about 95% of the time isn't bad :-)

But you're right that this needs work.  Since I will have to make some more serious changes, let's not do it anymore in sage-5.1.


---

Comment by jdemeyer created at 2012-07-12 13:59:38

Changing assignee from was to jdemeyer.


---

Comment by jdemeyer created at 2012-07-21 16:16:05

Changing priority from blocker to critical.


---

Comment by rws created at 2014-05-20 16:04:52

Replying to [comment:9 vbraun]:
> Running the doctest in a loop, I get occasional (maybe 1 in 20) failures

This is a good estimate of the rate when the issue leads to patchbot false test failures.
But #13237 was fixed 21 months ago, so obviously they too didn't fix it completely.


---

Comment by rws created at 2014-05-20 16:04:52

Changing keywords from "interrupt singular expect sd40.5" to "interrupt singular expect sd40.5 patchbot".


---

Comment by rws created at 2014-05-20 16:04:52

Changing status from needs_work to needs_info.


---

Comment by rws created at 2014-05-29 09:35:24

After 6.3beta2 the rate of failure under Ubuntu+patchbot (both `SageMath`/`Google` cloud) has gone up significantly to the order of 50%.

```
File "src/sage/interfaces/expect.py", line 790, in sage.interfaces.expect.Expect._eval_line
Failed example:
    singular.interrupt(timeout=3)  # sometimes very slow (up to 60s on sage.math, 2012)
Expected:
    False
Got:
    True
```



---

Comment by vbraun created at 2014-05-29 11:06:16

#15178 might improve things a bit (will be in beta3)


---

Comment by jdemeyer created at 2014-06-02 09:20:54

Replying to [comment:20 vbraun]:
> #15178 might improve things a bit (will be in beta3)
I don't see how that could be related.


---

Comment by vbraun created at 2014-07-16 19:53:16

Since the `cntrlc=a` patch is now in upstream we should at least make use of the command line option...


---

Comment by jakobkroeker created at 2015-02-03 00:06:46

> Since the cntrlc=a patch is now in upstream we should at least make use of the command line option

That should be easy now, since the patch is in 3.1.7 and 3.1.7 is in sage!
I just do not know where this change has to be done.

Following choices for --cntrlc= are possible: a,r,b,c,q :

```
abort after this command(a), abort immediately(r), print backtrace(b), continue(c) or quit Singular(q) ?
```



---

Comment by jdemeyer created at 2015-02-03 08:17:29

I'm in `pexpect` mood anyway (#17686, #17704), so I might as well have a look at this.


---

Comment by jdemeyer created at 2015-02-03 12:01:33

Changing status from needs_info to needs_work.


---

Comment by chapoton created at 2015-05-17 18:36:40

New commits:


---

Comment by git created at 2015-05-18 13:07:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-05-21 07:54:25

There is one failing doctest in the singular interface.


---

Comment by jdemeyer created at 2015-05-21 08:07:10

I would rather have #17686 in Sage first before continuing on this ticket.


---

Comment by vbraun created at 2015-06-19 20:53:05

This seems to be much more frequent now with #17686 

```
sage -t --long src/sage/interfaces/expect.py
**********************************************************************
File "src/sage/interfaces/expect.py", line 823, in sage.interfaces.expect.Expect._eval_line
Failed example:
    singular.interrupt(timeout=3)  # sometimes very slow (up to 60s on sage.math, 2012)
Expected:
    False
Got:
    True
**********************************************************************
1 item had failures:
   1 of  15 in sage.interfaces.expect.Expect._eval_line
    [89 tests, 1 failure, 4.74 s]
```



---

Comment by jdemeyer created at 2015-06-19 21:06:24

Good, so we're making progress!

The _correct_ result of that doctest is `True`.


---

Comment by git created at 2015-06-21 09:10:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-06-21 18:54:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-06-23 09:30:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-06-23 10:30:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-06-23 10:31:02

Changing status from needs_work to needs_review.


---

Comment by kdilks created at 2015-06-23 21:50:16

Minor doc error:

OSError: [interface] docstring of sage.interfaces.sagespawn.SageSpawn.expect_peek:12: WARNING: Block quote ends without a blank line; unexpected unindent.


---

Comment by git created at 2015-06-24 06:50:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kdilks created at 2015-06-24 23:48:05

The documentation builds now.

Not a thorough review of the code, but when repeatedly doctesting the file `./src/sage/interfaces/expect.py` on 6.8beta5, I can get `singular.interrupt(timeout=3)` to give an error every hundred or so times. With this patch applied, I've all had all tests pass a few thousand times.


---

Comment by wluebbe created at 2015-07-03 11:39:02

I tried `./sage -t src/sage/interfaces/expect.py` on sage-6.8.beta7 and Ubuntu 15.04 a dozen times: it failed in about 50% of the runs (seemingly at random).


---

Comment by kdilks created at 2015-07-06 21:16:51

Upstream bug ticket has been updated.


---

Comment by vbraun created at 2015-07-16 09:50:49

Well they don't really deny its a bug, just difficult to fix in the current architecture...


---

Comment by vbraun created at 2015-07-16 09:50:49

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2015-07-16 09:56:45

Replying to [comment:53 vbraun]:
> Well they don't really deny its a bug, just difficult to fix in the current architecture...

I sort of agree, but they did say it's considered a "proposed feature".


---

Comment by vbraun created at 2015-07-16 22:51:13

Resolution: fixed
