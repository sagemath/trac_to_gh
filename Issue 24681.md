# Issue 24681: Failing doctest in test_jupyter.rst when running patchbot

Issue created by migration from Trac.

Original creator: rws

Original creation time: 2018-03-06 15:02:37

With 8.2.beta7 all patchbots fail with:

```
File "src/sage/interacts/test_jupyter.rst", line 288, in sage.interacts.test_jupyter
Failed example:
    test(interacts.statistics.coin)
Expected:
    Interactive function <function coin at ...> with 2 widgets
      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2, step=100)
      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', max=1)
    doctest:...: UserWarning: Attempting to set identical bottom==top results
    in singular transformations; automatically expanding.
    bottom=0.0, top=0.0
Got:
    doctest:warning
      File "/home/vdelecro/sage_patchbot/src/bin/sage-runtests", line 127, in <module>
        err = DC.run()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/control.py", line 1163, in run
        self.run_doctests()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/control.py", line 891, in run_doctests
        self.dispatcher.dispatch()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1835, in dispatch
        self.parallel_dispatch()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1732, in parallel_dispatch
        w.start()  # This might take some time
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 2001, in start
        super(DocTestWorker, self).start()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/multiprocessing/process.py", line 130, in start
        self._popen = Popen(self)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/multiprocessing/forking.py", line 126, in __init__
        code = process_obj._bootstrap()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/multiprocessing/process.py", line 267, in _bootstrap
        self.run()
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1974, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 2291, in __call__
        result = runner.run(test)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 721, in run
        return self._run(test, compileflags, out)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 537, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 947, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interacts.test_jupyter[27]>", line 1, in <module>
        test(interacts.statistics.coin)
      File "<doctest sage.interacts.test_jupyter[3]>", line 6, in test
        return f(**kwargs)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/interacts/library.py", line 736, in coin
        show(point(c[1:], gridlines=[None, [0.5]], pointsize=1), ymin=interval[0], ymax=interval[1])
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/pretty_print.py", line 258, in show
        pretty_print(*args, **kwds)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/pretty_print.py", line 229, in pretty_print
        dm.display_immediately(*args, **kwds)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 833, in display_immediately
        plain_text, rich_output = self._rich_output_formatter(obj, rich_repr_kwds)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 623, in _rich_output_formatter
        rich_output = self._call_rich_repr(obj, rich_repr_kwds)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 581, in _call_rich_repr
        return obj._rich_repr_(self, **rich_repr_kwds)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/plot/graphics.py", line 884, in _rich_repr_
        self.save, kwds, file_ext, output_container)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 711, in graphics_from_save
        save_function(filename, **kwds)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/misc/decorators.py", line 483, in wrapper
        return func(*args, **kwds)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/plot/graphics.py", line 3153, in save
        figure = self.matplotlib(**options)
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/plot/graphics.py", line 2680, in matplotlib
        subplot.set_ylim([ymin, ymax])
      File "/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/matplotlib/axes/_base.py", line 3239, in set_ylim
        'bottom=%s, top=%s') % (bottom, top))
    :
    UserWarning: Attempting to set identical bottom==top results
    in singular transformations; automatically expanding.
    bottom=0.0, top=0.0
    Interactive function <function coin at 0x7fc26c78baa0> with 2 widgets
      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2, step=100)
      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', max=1)
```




---

Comment by rws created at 2018-03-06 15:07:40

The parts with "Interactive function" and "doctest" are reversed, and in "doctest" a backtrace is inserted. Race condition?


---

Comment by rws created at 2018-03-06 15:11:56

Can the output of warnings (presumably from matplotlib?) be silenced in these tests? They don't seem to add anything.


---

Comment by rws created at 2018-03-06 15:18:24

Changing status from new to needs_review.


---

Comment by rws created at 2018-03-06 15:18:24

Let's see if the patchbots like that more.
----
New commits:


---

Comment by jdemeyer created at 2018-03-06 16:07:38

Replying to [comment:1 rws]:
> in "doctest" a backtrace is inserted.

That's normal for doctests.

The reordering is mysterious though. It's especially mysterious that it happens only on the patchbots.

The cause is likely #24771.


---

Comment by embray created at 2018-03-06 16:13:50

I agree--the warning is from matplotlib and not really at all interesting for the purposes of these docs.


---

Comment by embray created at 2018-03-06 16:20:45

Having warnings go to `sys.stderr` makes sense, but it is a problem when it comes to unpredictable interleaving of stdout and stderr.  I could suggest that when running the doctests all warnings just go to stdout, but really this is a general problem for any test that looked at interleaved output on stdout and stderr.  I'm not really sure why it just came up in this case.


---

Comment by jdemeyer created at 2018-03-06 16:23:29

Replying to [comment:7 embray]:
> Having warnings go to `sys.stderr` makes sense, but it is a problem when it comes to unpredictable interleaving of stdout and stderr.

I agree, but that does not explain why it fails _only_ on the patchbot.


---

Comment by rws created at 2018-03-06 16:36:58

Replying to [comment:7 embray]:
> Having warnings go to `sys.stderr` makes sense, but it is a problem when it comes to unpredictable interleaving of stdout and stderr.

In principle this is also the case with #24920. If one could just switch off stderr for those tests the linking of a system readline would not be necessary to make those tests pass.


---

Comment by embray created at 2018-03-06 16:54:37

The patchbot runner simply runs `./sage -t` using `os.system`, so on its own that shouldn't make a difference.

However, I was able to make this fail consistently by running `sp.Popen(['./sage', '-t', 'src/sage/interacts/test_jupyter.rst'], stdout=sp.PIPE)` (where `sp` is the `subprocess` module).

So it might just be some difference, when the patchbot itself is run, in type of file stdout and/or stderr, whether or not those files are buffered, and the size of the buffer.


---

Comment by embray created at 2018-03-06 17:01:59

Even more simply, I can reproduce just by running `./sage -t src/sage/interacts/test_jupyter.rst > test.txt`, for example.


---

Comment by rws created at 2018-03-07 07:52:22

The test:

```
    sage: test(interacts.statistics.coin)
    ...
    Interactive function <function coin at ...> with 2 widgets
      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2, step=100)
      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', max=1)
    ...
```

The test run:

```
Failed example:
    test(interacts.statistics.coin)
Expected:
    Interactive function <function coin at ...> with 2 widgets
      n: IntSlider(value=1000, description=u'Number of Tosses', max=10000, min=2
, step=100)
      interval: IntRangeSlider(value=(0, 0), description=u'Plotting range (y)', 
max=1)
    ...
```

It appears that ellipsis at the start of the output part of the doctest is ignored, is this a feature? If not immediately fixable I propose to "known bug" this doctest for now.


---

Comment by embray created at 2018-03-07 09:24:42

It does make more sense that the warning should come first in the output. But whether or not it actually does come first depends on I/O buffering peculiarities it seems.


---

Comment by jdemeyer created at 2018-03-07 09:28:11

One simple workaround would be to flush stdout before printing the warning. That's literally a 1-line fix.


---

Comment by rws created at 2018-03-07 09:34:59

Replying to [comment:14 jdemeyer]:
> One simple workaround would be to flush stdout before printing the warning. That's literally a 1-line fix.

In `matplotlib/axes/_base.py`, so that's a matplotlib patch I guess.


---

Comment by jdemeyer created at 2018-03-07 09:36:32

No, I meant in the doctest framework whenever a warning is printed.


---

Comment by jdemeyer created at 2018-03-07 09:37:36

I mean this change:

```diff
diff --git a/src/sage/doctest/forker.py b/src/sage/doctest/forker.py
index 301383b..38c5cdf 100644
--- a/src/sage/doctest/forker.py
+++ b/src/sage/doctest/forker.py
`@``@` -170,6 +170,9 `@``@` def showwarning_with_traceback(message, category, filename, lineno, file=None, l
         :
         UserWarning: bad stuff
     """
+    # Flush stdout to get predictable ordering of output and warnings
+    sys.stdout.flush()
+
     # Get traceback to display in warning
     tb = traceback.extract_stack()
     tb = tb[:-1]  # Drop this stack frame for showwarning_with_traceback()
```



---

Comment by git created at 2018-03-07 09:43:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-03-07 09:43:59

Yes, that makes total sense.  I was just experimenting with a different approach that reopens `sys.stdout` and `sys.stderr` with unbuffered files, but this should be simpler.
----
New commits:


---

Comment by rws created at 2018-03-07 09:44:49

OK, thanks.


---

Comment by embray created at 2018-03-07 10:13:54

Looks like this works, though in this case you can also just remove the original fix, since now the stdout does appear before the stderr as before (I'm actually not sure why that's the case--I would think the warning would be displayed first--but apparently not).


---

Comment by jdemeyer created at 2018-03-07 10:16:47

Changing status from needs_review to needs_work.


---

Comment by rws created at 2018-03-07 13:51:43

New commits:


---

Comment by rws created at 2018-03-07 13:51:43

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-03-08 13:31:24

Changing status from needs_review to positive_review.


---

Comment by rws created at 2018-03-08 13:50:40

Thanks.


---

Comment by vbraun created at 2018-03-19 21:59:33

Resolution: fixed
