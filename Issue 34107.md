# Issue 34107: Update setuptools to 64.0.0

Issue created by migration from https://trac.sagemath.org/ticket/34344

Original creator: mkoeppe

Original creation time: 2022-08-11 19:11:24

CC:  fbissey arojas saraedum jhpalmieri

This brings PEP 660 editable installs.

Here on this ticket, we disable them. The follow-up ticket #34209 will switch editable builds to this new technology.


---

Comment by mkoeppe created at 2022-08-11 19:30:41

New commits:


---

Comment by mkoeppe created at 2022-08-11 19:49:30

This version of setuptools breaks the build of our numpy-1.22.4 package

```
    File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/Cython/Distutils/old_build_ext.py", line 157, in __getattr__
      return _build_ext.build_ext.__getattr__(self, name)
    File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/setuptools/_distutils/cmd.py", line 105, in __getattr__
      raise AttributeError(attr)
  AttributeError: fcompiler
  error: subprocess-exited-with-error
  
  × python setup.py egg_info did not run successfully.
  │ exit code: 1

```



---

Comment by mkoeppe created at 2022-08-26 15:23:58

Actually it needs to be `SETUPTOOLS_ENABLE_FEATURES` (plural) https://github.com/pypa/setuptools/pull/3538


---

Comment by git created at 2022-08-26 15:27:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-08-26 15:31:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-08-26 18:00:55

The updated `setuptools` still causes the same build failure with our numpy 1.22.4.


---

Comment by mkoeppe created at 2022-09-23 23:56:33

The upgrade to numpy 1.23.3 (#34110) does not help.

In fact, upstream numpy is moving away from `numpy.distutils` and does not intend to keep it working with newer setuptools - https://github.com/numpy/numpy/pull/22154

Breaking the numpy build system has been raised as  https://github.com/pypa/setuptools/issues/3549 - no solution as of 2022-09-23


---

Comment by git created at 2022-09-24 01:03:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-09-24 01:17:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-09-24 01:20:00

Changing status from new to needs_review.


---

Comment by git created at 2022-09-24 02:46:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-24 23:25:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2022-09-25 03:23:32

This almost looks like a straightforward upgrade. My only questions are about `setuptools` vs. `setuptools_wheel`: how does `numpy` (and maybe that's the only relevant package) know not to use `setuptools_wheel`? And could there be there an issue with having mismatched versions of `setuptools` and `setuptools_wheel`?


---

Comment by mkoeppe created at 2022-09-25 03:28:56

Since #33789, we use build isolation for all Python packages that use `sdh_pip_install` - except for those that we invoke with `--no-use-pep517` or `--no-build-isolation`.
When build isolation is in use, it does not matter what is installed in `site-packages`, as it creates a fresh build environment using the wheels in `venv/var/lib/sage/wheels/`; this includes the setuptools wheel, which is provided by our `setuptools_wheel` SPKG.
The versions don't need to be synchronized - a setuptools-based package uses exactly one of the two.


---

Comment by git created at 2022-09-25 04:40:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2022-09-26 19:54:31

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2022-09-26 19:54:31

Okay, let's merge it.


---

Comment by mkoeppe created at 2022-09-26 20:16:09

Thanks!


---

Comment by vbraun created at 2022-09-28 23:04:20

Resolution: fixed
