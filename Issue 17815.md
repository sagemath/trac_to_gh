# Issue 17815: Wrap Python functions in a PARI entree

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2015-03-25 10:51:25

CC:  pbruin

To improve support for PARI functions taking closures, it would be very nice if we could wrap an arbitrary Python function in an `entree`.


---

Comment by jdemeyer created at 2015-04-10 13:34:22

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-04-10 13:34:22

New commits:


---

Comment by git created at 2015-04-10 13:35:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-04-11 13:13:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-05-05 20:57:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2015-06-06 10:39:15

I tried to implement a variadic version of this, and ran into #18623.


---

Comment by pbruin created at 2015-06-06 10:42:44

Two comments on the current implementation:
- I think it is better to use `ulong` instead of `unsigned long`, because `unsigned long` may be smaller than the size of a pointer (on 64-bit Windows maybe?).
- The case where the Python function returns `None` is not handled correctly; I propose

```diff
--- a/src/sage/libs/pari/closure.pyx
+++ b/src/sage/libs/pari/closure.pyx
`@``@``@` -65,7 +65,10 `@``@` cdef inline GEN call_python_func_impl "call_python_func"(GEN* args, object py_fu
     # Call the Python function
     r = PyObject_Call(py_func, t, <dict>NULL)

-    # Convert the result to a gen and copy it to the PARI stack
+    # Convert the result to a GEN and copy it to the PARI stack,
+    # treating None specially
+    if r is None:
+        return gnil
     return gcopy(objtogen(r).g)

 # We rename this function to be able to call it with a different
```



---

Comment by git created at 2015-06-08 12:01:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2015-06-08 13:22:34

Changing status from needs_review to positive_review.


---

Comment by pbruin created at 2015-06-08 13:22:34

This looks good to me now.  We can always implement a variadic version later, but I think is not a priority at the moment.  Also, the most naÃ¯ve version of this makes the "cube" doctest fail, because even PARI doesn't support variadic functions in `apply`:

```
gp> g(v[..]) = v[1]^3
%1 = (v[..])->v[1]^3
gp> g(2)
%2 = 8
gp> apply(g, [1,2,3])
  ***   at top-level: apply(g,[1,2,3])
  ***                 ^----------------
  *** apply: incorrect type in apply (t_CLOSURE).
```

(The error only arises because the closure is variadic; non-variadic closures do work.)


---

Comment by vbraun created at 2015-06-09 07:20:38

Resolution: fixed
