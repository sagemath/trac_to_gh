# Issue 31847: `_nth_root_naive` fails for integer mod

archive/issues_031847.json:
```json
{
    "body": "Keywords: ring, mod, root\n\n\n```\nsage -t --long --random-seed=3 src/sage/rings/finite_rings/integer_mod.pyx\n**********************************************************************\nFile \"src/sage/rings/finite_rings/integer_mod.pyx\", line 1525, in sage.rings.finite_rings.integer_mod.IntegerMod_abstract._nth_root_naive\nFailed example:\n    for n in range(2,100): # long time\n        K = Integers(n)\n        elist = list(range(1,min(2*n+2,100)))\n        for e in random_sublist(elist, 5/len(elist)):\n            for a in random_sublist(range(1,n), min((n+2)//2,10)/(n-1)):\n                b = K(a)\n                try:\n                    L = b.nth_root(e, all=True)\n                    if L:\n                        c = b.nth_root(e)\n                except Exception:\n                    L = [-1]\n                M = b._nth_root_naive(e)\n                if sorted(L) != M:\n                    print(\"mod(%s, %s).nth_root(%s,all=True), mod(%s, %s)._nth_root_naive(%s)\" % (a,n,e,a,n,e))\n                if L and (c not in L):\n                    print(\"mod(%s, %s).nth_root(%s), mod(%s, %s).nth_root(%s,all=True)\" % (a,n,e,a,n,e))\nExpected nothing\nGot:\n    mod(43, 75).nth_root(75), mod(43, 75).nth_root(75,all=True)\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32084\n\n",
    "created_at": "2021-06-29T16:29:33Z",
    "labels": [
        "component: algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "`_nth_root_naive` fails for integer mod",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31847",
    "user": "https://github.com/kliem"
}
```
Keywords: ring, mod, root


```
sage -t --long --random-seed=3 src/sage/rings/finite_rings/integer_mod.pyx
**********************************************************************
File "src/sage/rings/finite_rings/integer_mod.pyx", line 1525, in sage.rings.finite_rings.integer_mod.IntegerMod_abstract._nth_root_naive
Failed example:
    for n in range(2,100): # long time
        K = Integers(n)
        elist = list(range(1,min(2*n+2,100)))
        for e in random_sublist(elist, 5/len(elist)):
            for a in random_sublist(range(1,n), min((n+2)//2,10)/(n-1)):
                b = K(a)
                try:
                    L = b.nth_root(e, all=True)
                    if L:
                        c = b.nth_root(e)
                except Exception:
                    L = [-1]
                M = b._nth_root_naive(e)
                if sorted(L) != M:
                    print("mod(%s, %s).nth_root(%s,all=True), mod(%s, %s)._nth_root_naive(%s)" % (a,n,e,a,n,e))
                if L and (c not in L):
                    print("mod(%s, %s).nth_root(%s), mod(%s, %s).nth_root(%s,all=True)" % (a,n,e,a,n,e))
Expected nothing
Got:
    mod(43, 75).nth_root(75), mod(43, 75).nth_root(75,all=True)
```


Issue created by migration from https://trac.sagemath.org/ticket/32084





---

archive/issue_comments_454557.json:
```json
{
    "body": "The problem seems to be that `mod(a, n).nth_root(k)` sometimes returns a value that is not actually a `k`th root of `mod(a, n)`:\n\n```\nsage: for n in range(100):\n....:     for k in range(2*n):\n....:         kth_powers = set(x^k % n for x in range(n))\n....:         bad = set( (a, mod(a, n).nth_root(k), mod(a, n).nth_root(k)^k) for a in kth_powers\n....:             if mod(a, n).nth_root(k)^k % n != a)\n....:         if bad:\n....:             print(n, k, bad)\n50 50 {(49, 49, 1), (24, 24, 26)}\n50 75 {(7, 7, 43), (43, 43, 7), (32, 32, 18), (18, 18, 32)}\n75 50 {(49, 74, 1), (24, 24, 51)}\n75 75 {(7, 7, 43), (18, 18, 57), (68, 68, 32), (57, 57, 18), (32, 32, 68), (43, 43, 7)}\n98 98 {(79, 79, 67), (30, 30, 18), (67, 67, 79), (18, 18, 30)}\n```\n\nIn the above examples, the erroneous `kth` root of `a` is always `a` itself, but there are larger examples where this is not the case. For example:\n\n```\nsage: n = 147\nsage: a = 67\nsage: k = 98\nsage: mod(a, n).nth_root(k)\n116\nsage: (116^k) % n\n79\n```\n",
    "created_at": "2021-06-30T17:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31847#issuecomment-454557",
    "user": "https://github.com/DaveWitteMorris"
}
```

The problem seems to be that `mod(a, n).nth_root(k)` sometimes returns a value that is not actually a `k`th root of `mod(a, n)`:

```
sage: for n in range(100):
....:     for k in range(2*n):
....:         kth_powers = set(x^k % n for x in range(n))
....:         bad = set( (a, mod(a, n).nth_root(k), mod(a, n).nth_root(k)^k) for a in kth_powers
....:             if mod(a, n).nth_root(k)^k % n != a)
....:         if bad:
....:             print(n, k, bad)
50 50 {(49, 49, 1), (24, 24, 26)}
50 75 {(7, 7, 43), (43, 43, 7), (32, 32, 18), (18, 18, 32)}
75 50 {(49, 74, 1), (24, 24, 51)}
75 75 {(7, 7, 43), (18, 18, 57), (68, 68, 32), (57, 57, 18), (32, 32, 68), (43, 43, 7)}
98 98 {(79, 79, 67), (30, 30, 18), (67, 67, 79), (18, 18, 30)}
```

In the above examples, the erroneous `kth` root of `a` is always `a` itself, but there are larger examples where this is not the case. For example:

```
sage: n = 147
sage: a = 67
sage: k = 98
sage: mod(a, n).nth_root(k)
116
sage: (116^k) % n
79
```




---

archive/issue_comments_454558.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-30T21:34:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31847#issuecomment-454558",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_454559.json:
```json
{
    "body": "When `n` is a prime power, `mod(a,n).nth_root(k)` returned `self` in certain cases where `self` happened to be a `(p - 1)`th root of unity, but it needs to return a `k`th root of `self`. This PR should fix the problem.\n----\nNew commits:",
    "created_at": "2021-06-30T21:34:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31847#issuecomment-454559",
    "user": "https://github.com/DaveWitteMorris"
}
```

When `n` is a prime power, `mod(a,n).nth_root(k)` returned `self` in certain cases where `self` happened to be a `(p - 1)`th root of unity, but it needs to return a `k`th root of `self`. This PR should fix the problem.
----
New commits:



---

archive/issue_comments_454560.json:
```json
{
    "body": "Rebased on #29979, and removed \"known bug\" tag. Only the last 2 commits are from this ticket ('trac 32084 fix nth root' and 'remove \"known bug\" tag').\n----\nNew commits:",
    "created_at": "2021-07-01T01:37:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31847#issuecomment-454560",
    "user": "https://github.com/DaveWitteMorris"
}
```

Rebased on #29979, and removed "known bug" tag. Only the last 2 commits are from this ticket ('trac 32084 fix nth root' and 'remove "known bug" tag').
----
New commits:



---

archive/issue_comments_454561.json:
```json
{
    "body": "The first value in the line above is quasi `K(modp.lift()`, but here we pick `K(modp)`. Why?",
    "created_at": "2021-07-01T10:58:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31847#issuecomment-454561",
    "user": "https://github.com/kliem"
}
```

The first value in the line above is quasi `K(modp.lift()`, but here we pick `K(modp)`. Why?



---

archive/issue_comments_454562.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-01T20:47:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31847#issuecomment-454562",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_454563.json:
```json
{
    "body": "Thanks for the comment. Using `lift()` may be a bit safer, because we know exactly what `K(modp.lift())` will do (lift `modp` to an integer, and then pass to `Z/(p^k Z)` in the obvious way), but it may not be so obvious what the constructor `K(modp)`  will do. So I made the change. We are in the situation where every lift of `modp` to an element of `Z/(p^k Z)` is an `n`th root, so it does not matter how we get the lift.",
    "created_at": "2021-07-01T20:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31847#issuecomment-454563",
    "user": "https://github.com/DaveWitteMorris"
}
```

Thanks for the comment. Using `lift()` may be a bit safer, because we know exactly what `K(modp.lift())` will do (lift `modp` to an integer, and then pass to `Z/(p^k Z)` in the obvious way), but it may not be so obvious what the constructor `K(modp)`  will do. So I made the change. We are in the situation where every lift of `modp` to an element of `Z/(p^k Z)` is an `n`th root, so it does not matter how we get the lift.



---

archive/issue_comments_454564.json:
```json
{
    "body": "Can we reverse the dependency with #29979? I think this has a much higher chance of getting reviewed first.",
    "created_at": "2021-07-02T05:52:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31847#issuecomment-454564",
    "user": "https://github.com/tscrim"
}
```

Can we reverse the dependency with #29979? I think this has a much higher chance of getting reviewed first.



---

archive/issue_comments_454565.json:
```json
{
    "body": "The work issue was really meant as a note that one of the tickets needs to be rebased. I think the order should be whichever ticket is ready to be merged first.\n\nBtw, it would be great to add one of the failing examples as a doctest.",
    "created_at": "2021-07-02T05:56:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31847#issuecomment-454565",
    "user": "https://github.com/kliem"
}
```

The work issue was really meant as a note that one of the tickets needs to be rebased. I think the order should be whichever ticket is ready to be merged first.

Btw, it would be great to add one of the failing examples as a doctest.



---

archive/issue_comments_454566.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-07-03T00:56:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31847#issuecomment-454566",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_454567.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-07-03T00:56:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31847#issuecomment-454567",
    "user": "https://github.com/DaveWitteMorris"
}
```

New commits:



---

archive/issue_comments_454568.json:
```json
{
    "body": "Sorry for the confusion.  I think I put this back the way it was (including the work issue), except that I rebased on 9.4b4 and added a doctest.\n----\nNew commits:",
    "created_at": "2021-07-03T01:13:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31847#issuecomment-454568",
    "user": "https://github.com/DaveWitteMorris"
}
```

Sorry for the confusion.  I think I put this back the way it was (including the work issue), except that I rebased on 9.4b4 and added a doctest.
----
New commits:



---

archive/issue_comments_454569.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-07-03T01:17:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31847#issuecomment-454569",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_454570.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-03T01:37:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31847#issuecomment-454570",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_454571.json:
```json
{
    "body": "Thank you. LGTM.",
    "created_at": "2021-07-03T01:37:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31847#issuecomment-454571",
    "user": "https://github.com/tscrim"
}
```

Thank you. LGTM.



---

archive/issue_comments_454572.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-07-03T02:17:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31847#issuecomment-454572",
    "user": "https://github.com/DaveWitteMorris"
}
```

Thanks!



---

archive/issue_comments_454573.json:
```json
{
    "body": "I moved the work issue now to #29979. (I hoped that this is what a reviewer would do when setting it on positive review, I caught on to this so things are fine.)",
    "created_at": "2021-07-03T05:57:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31847#issuecomment-454573",
    "user": "https://github.com/kliem"
}
```

I moved the work issue now to #29979. (I hoped that this is what a reviewer would do when setting it on positive review, I caught on to this so things are fine.)



---

archive/issue_comments_454574.json:
```json
{
    "body": "Replying to [comment:18 gh-kliem]:\n> I moved the work issue now to #29979. (I hoped that this is what a reviewer would do when setting it on positive review, I caught on to this so things are fine.)\n\nSorry, I should have done that.",
    "created_at": "2021-07-04T01:23:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31847#issuecomment-454574",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:18 gh-kliem]:
> I moved the work issue now to #29979. (I hoped that this is what a reviewer would do when setting it on positive review, I caught on to this so things are fine.)

Sorry, I should have done that.



---

archive/issue_events_028984.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-07-23T20:11:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31847",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31847#event-28984"
}
```



---

archive/issue_comments_454575.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-23T20:11:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31847",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31847#issuecomment-454575",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
