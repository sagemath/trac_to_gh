# Issue 31660: A dense implementation for the Lazy Laurent Series

Issue created by migration from https://trac.sagemath.org/ticket/31897

Original creator: @tejasvicsr1

Original creation time: 2021-06-03 17:35:14

CC:  mantepse tscrim

Keywords: LazyPowerSeries, FormalSeries, GSoC

A dense implementation of the Lazy Laurent Series using Lazy Lists.

This ticket is part of the meta ticket #31651


---

Comment by mantepse created at 2021-06-04 07:33:38

Changing keywords from "LazyPowerSeries, FormalSeries, GSoC" to "LazyPowerSeries, FormalSeries, GSoC21".


---

Comment by git created at 2021-06-05 19:17:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-06 19:41:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-07 17:18:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-07 17:47:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-08 18:44:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-09 13:42:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-09 18:30:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-16 15:36:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-17 14:12:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-17 16:17:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-17 17:54:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-18 13:07:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-18 14:13:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-18 14:23:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-25 17:36:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-27 13:58:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-29 14:33:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-29 21:10:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-06 22:10:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-06 22:22:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-08 13:35:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-08 14:00:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-09 18:39:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-09 21:10:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-10 18:14:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-13 20:12:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-14 07:02:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-14 10:22:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-14 20:46:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-14 21:09:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-14 21:38:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-07-15 05:45:17

New commits:


---

Comment by git created at 2021-07-15 07:57:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-07-16 01:02:39

I have fixed the pickling issue, some bugs I found in `_element_constructor_` in addition to what Martin pointed out, implemented slices (for `LLS` only to keep the `LLS_aux` classes fast with `__getitem__`), and ported over the doctests for `define`. We just need composition implemented in order to check the last test there.
----
New commits:


---

Comment by tscrim created at 2021-07-16 06:32:21

Accidental double post...


---

Comment by git created at 2021-07-16 21:41:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-20 21:01:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-07-22 07:37:21

New commits:


---

Comment by git created at 2021-07-25 19:55:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-07-26 02:41:03

New commits:


---

Comment by git created at 2021-07-26 22:36:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-07-27 23:32:31

New commits:


---

Comment by git created at 2021-07-31 13:53:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-01 14:09:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-03 20:51:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-03 21:04:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-03 21:16:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-08-04 04:09:58

New commits:


---

Comment by git created at 2021-08-04 04:13:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-08-04 07:12:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-04 11:16:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-07 19:55:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-08-08 03:57:03

Changing status from new to needs_review.


---

Comment by tscrim created at 2021-08-08 03:57:03

New commits:


---

Comment by git created at 2021-08-08 04:33:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-08 04:45:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-08 15:00:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-08 15:46:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-08 15:49:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-08 16:07:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-08-09 02:49:14

New commits:


---

Comment by git created at 2021-08-09 13:45:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-09 18:51:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-09 19:22:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-10 19:30:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-08-10 22:34:08

New commits:


---

Comment by git created at 2021-08-10 23:31:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-11 09:03:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-08-11 12:45:52

That's a good idea, and it made me catch a potential corner case in `CS_map_coefficients`.
----
New commits:


---

Comment by git created at 2021-08-11 20:58:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-12 00:26:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-12 00:35:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-08-12 00:49:01

Changing keywords from "LazyPowerSeries, FormalSeries, GSoC21" to "LazyPowerSeries, FormalSeries, gsoc2021".


---

Comment by tscrim created at 2021-08-12 08:55:38

New commits:


---

Comment by tscrim created at 2021-08-13 09:18:21

New commits:


---

Comment by git created at 2021-08-13 11:55:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-13 12:53:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-13 13:02:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-14 09:43:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2021-08-14 11:17:28

From my point of view this is ready to go, under the assumption that #32324 is going to get in next.

Travis, please set it to positive review if you agree.


---

Comment by tscrim created at 2021-08-14 12:25:42

Yes, let's work on finishing #32324 next. Thank you both very much for your hard work on this.

I pushed one trivial fix to take care of an unneeded import from pyflakes. I am allowing myself to set this to a positive review since the clean patchbot, and I double-checked with my last commit locally.
----
New commits:


---

Comment by tscrim created at 2021-08-14 12:25:42

Changing status from needs_review to positive_review.


---

Comment by slelievre created at 2021-08-15 21:22:10

Changing status from positive_review to needs_work.


---

Comment by slelievre created at 2021-08-15 21:22:10

Sorry to jump in with some naive questions and comments,
feel free to ignore. Or to set back to positive review
and to open a follow-up ticket instead.

These class names mix camel case and underscores:

```
CoefficientStream_add
CoefficientStream_cauchy_product
CoefficientStream_sub
CoefficientStream_composition
CoefficientStream_lmul
CoefficientStream_rmul
CoefficientStream_neg
CoefficientStream_cauchy_inverse
CoefficientStream_map_coefficients
CoefficientStream_zero
CoefficientStream_exact
CoefficientStream_uninitialized
CoefficientStream_shift
```

Is that usual? Naively I would have expected:

```
CoefficientStreamAdd
CoefficientStreamCauchyProduct
CoefficientStreamSub
CoefficientStreamComposition
CoefficientStreamLmul
CoefficientStreamRmul
CoefficientStreamNeg
CoefficientStreamCauchyInverse
CoefficientStreamMapCoefficients
CoefficientStreamZero
CoefficientStreamExact
CoefficientStreamUninitialized
CoefficientStreamShift
```


I'm sure it's just my ignorance and you'll point me
to other examples.

Could names be shortened by using Stream
instead of CoefficientStream?

Change which L is capitalised:

```diff
-The coefficient stream can be used to build up a Lazy laurent series::
+The coefficient stream can be used to build up a lazy Laurent series::
```


Unclear syntax:


```
Two coefficient streams can be composed (depending on whether it exists)::
```


Typo:


```diff
         The default is to always return ``False`` as it
-        cannot be decided or they are equal.
+        cannot be decided whether they are equal.
```


In comments, use sentences with initial capital
and final period, and regular indentation
(with additional minor rephrasing suggestions).


```diff
             # We cannot pickle a generator object, so we remove it and
-            #   the cache from the pickle information.
+            # the cache from the pickle information.
```



```diff
         # We do not insist that the last entry of initial_coefficients
-        #   is different from constant in case comparisons can be
-        #   expensive such as in the symbolic ring
+        # is different from constant in case comparisons can be
+        # expensive such as in the symbolic ring.
```



```diff
-            # the constant part makes no contribution to the negative
-            # we need this for the case so self._neg_powers[0][n] => 0
+            # The constant part makes no contribution to the negative.
+            # We need this for the case so self._neg_powers[0][n] => 0.
```



```diff
-        v = self._approximate_order  # shorthand name
+        v = self._approximate_order  # shorthand name for this "order" or "valuation"
-        n = 0  # Counts the number of places from the order
+        n = 0  # shift from the "order" position
         yield self._ainv
+        # Note that first entry of the cache will correspond to z^v
+        # The first entry of the cache is the coefficient of z^v
```



```diff
-        # We don't hash the function in case that happens to not be hashable
+        # We don't hash the function as it might not be hashable.
```


In examples blocks, end introductory sentences with `::` or `. ::`
but not `.::` (as I think that would render as ".:" -- please check).


```diff
-generating functions for sequences arising in combinatorics.::
+generating functions for sequences arising in combinatorics.::
```



```diff
-that are needed are computed.::
+that are needed are computed. ::
```



```diff
-coefficient are computed.::
+coefficient are computed. ::
```


Typos.


```diff
-    Two sequences can be subracted::
+    Two sequences can be subtracted::
```



```diff
-explcitly
+explicitly
```


Incorrect capitalisation (several occurrences):


```diff
-        Dense Implementation::
+        Dense implementation::
```



```diff
-        Sparse Implementation::
+        Sparse implementation::
```


Capitalise Laurent and end with period:


```diff
-                # One of the lazy laurent series is not known to eventually be constant
+                # One of the lazy Laurent series is not known to eventually be constant.
```


Rephrase:


```diff
-        # the product is exact if and only if both of the factors are
-        # exact, and one has eventually 0 coefficients:
+        # The product is exact if and only if both factors are exact
+        # and one of the factors has eventually 0 coefficients:
         #   (p + a x^d/(1-x))(q + b x^e/(1-x))
         #   = p q + (a x^d q + b x^e p)/(1-x) + a b x^(d+e)/(1-x)^2
```


Rephrase and fix typo in "coeffcients"


```
-            # (a x^d q)/(1-x) has constant a q(1), and the initial
-            # values are the cumulative sums of the coeffcients of q
+            # The series `(a * x^d * q) / (1 - x)` has constant term
+            # `a * q(1)`, and initial values the cumulative sums
+            # of the coefficients of `q`.
```


In several docstrings, "if" should be "whether", e.g.


```diff
+        Return if ``self`` is sparse or not.
+        Return whether ``self`` is sparse.
```


Note you can check which files were touched by this ticket with


```
$ git diff --name-only 9.4.rc0 HEAD
src/doc/en/reference/data_structures/index.rst
src/doc/en/reference/power_series/index.rst
src/sage/categories/unital_algebras.py
src/sage/data_structures/coefficient_stream.py
src/sage/rings/lazy_laurent_series.py
src/sage/rings/lazy_laurent_series_operator.py
src/sage/rings/lazy_laurent_series_ring.py
src/sage/rings/polynomial/polynomial_element.pyx
src/sage/rings/polynomial/polynomial_element_generic.py
src/sage/rings/polynomial/polynomial_integer_dense_flint.pyx
src/sage/rings/polynomial/polynomial_integer_dense_ntl.pyx
```


and then run tox on these files
(except `src/sage/rings/lazy_laurent_series_operator.py`
which was removed):


```
./sage -tox -- \
src/doc/en/reference/data_structures/index.rst \
src/doc/en/reference/power_series/index.rst \
src/sage/categories/unital_algebras.py \
src/sage/data_structures/coefficient_stream.py \
src/sage/rings/lazy_laurent_series.py \
src/sage/rings/lazy_laurent_series_ring.py \
src/sage/rings/polynomial/polynomial_element.pyx \
src/sage/rings/polynomial/polynomial_element_generic.py \
src/sage/rings/polynomial/polynomial_integer_dense_flint.pyx \
src/sage/rings/polynomial/polynomial_integer_dense_ntl.pyx
```


which runs tests and some sanity checks
including pycodestyle which detects
invalid escape sequences, and codespell 
which detects some typos.

In particular codespell makes these suggestions,
some silly, some useful:


```
sage/categories/unital_algebras.py:132: mor ==> more
sage/categories/unital_algebras.py:133: mor ==> more
sage/categories/unital_algebras.py:134: mor ==> more
sage/categories/unital_algebras.py:136: mor ==> more
sage/categories/unital_algebras.py:242: mor ==> more
sage/categories/unital_algebras.py:244: mor ==> more
sage/categories/unital_algebras.py:257: mor ==> more
sage/categories/unital_algebras.py:260: mor ==> more
sage/rings/lazy_laurent_series.py:133: subracted ==> subtracted
sage/rings/lazy_laurent_series.py:1045: coeffcients ==> coefficients
sage/rings/lazy_laurent_series_ring.py:382: convertable ==> convertible
sage/rings/polynomial/polynomial_element.pyx:2533: overriden ==> overridden
sage/rings/polynomial/polynomial_element.pyx:4375: Hart ==> Heart, harm
```



---

Comment by mantepse created at 2021-08-16 06:12:29

Thank you for looking at this and for your suggestions!  Indeed, stream is better than corfficientstream. I am currently without Computer, but I will fix these in about four hours from now.


---

Comment by mantepse created at 2021-08-17 07:43:42

Travis, please feel free to set to positive review!
----
New commits:


---

Comment by mantepse created at 2021-08-17 07:43:59

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-08-17 10:34:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-08-18 04:46:39

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2021-08-18 04:46:39

This will be fine. I am setting this to a positive review. Any further improvements can be done on subsequent tickets.

There is a strong precedent for having classes names `MainClassName_other_info`. See matrices and polynomials. I agree it is a break from the usual Python conventions, but in some ways I see it as a way around not having an analog of C++ namespaces. We also get oddities like `StreamRmul`. However, this isn't something I care that strongly about.

I am also a -1 on enforcement of comments being proper sentences. Simple clauses can be more useful as it expresses the most pertinent information. The indentation does serve a purpose; it tells you that it is part of the same comment. (I have had to put 3 different unrelated comment blocks together, but it takes a little bit of thought to understand they are actually unrelated. This gives a visual cue they are unrelated.)


---

Comment by tscrim created at 2021-08-18 08:25:32

Changing status from positive_review to needs_work.


---

Comment by tscrim created at 2021-08-18 08:25:32

Martin and I discussed this a bit more, and we decided to go back to the `Stream_info` format.


---

Comment by slelievre created at 2021-08-18 09:42:59

In the meantime I (re)discovered `IntegerMod_abstract`
and I'm sure there are many more.

Also, one can always `import CoefficientStream as Stream`
if you prefer specific names.

Thanks for making some of the suggested changes
and for explaining your position on others.


---

Comment by git created at 2021-08-19 08:00:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2021-08-19 08:01:33

Setting this boldly to positive review, since all reviewers agreed to the (trivial) change.


---

Comment by mantepse created at 2021-08-19 08:01:33

Changing status from needs_work to positive_review.


---

Comment by mantepse created at 2021-08-19 13:10:44

The single failing doctest reported by the patchbot has almost certainly nothing to do with this ticket.


---

Comment by git created at 2021-08-27 12:17:58

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2021-08-27 12:17:58

Changing status from positive_review to needs_review.


---

Comment by mantepse created at 2021-08-27 12:21:12

Boldly setting this back to positive review, because the changes are trivial.


---

Comment by mantepse created at 2021-08-27 12:21:12

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2021-08-27 12:26:03

Changing status from positive_review to needs_review.


---

Comment by tscrim created at 2021-08-27 12:26:03

This is a nontrivial change that definitely needs to be reviewed. That should have been done on a followup ticket; hopefully this branch has not already been merged and the commit won't be lost.


---

Comment by mantepse created at 2021-08-27 12:32:10

OK, can I somehow remove the push and push it into a followup?

(It looked trivial to me, please forgive)


---

Comment by tscrim created at 2021-08-27 12:47:35

This is changing the behavior, so I consider it to be nontrivial.

What we can do is just reset the branch back to the commit that we positively reviewed. We could just plow ahead too since it is unlikely the next beta will be cut soon and have this ticket included. (Commits have been lost this way before.) Plus since we are doing followup tickets that we have included the later commits, they definitely won't get lost. Your choice now.

----

Comments on your changes:

In the test `L(0).map_coefficients(lambda c: c + 1)`, we should actually check the resulting stream is `Stream_zero`.

We should also better handle `truncate` and `__pow__` (with the special `0^0` returning `1`).


```diff
-return - other
+return -other
```



---

Comment by mantepse created at 2021-08-27 12:57:04

OK, then I'd rather leave my mistake as it is, especially since you are evidently already reviewing.

Concerning `L(0).map_coefficients(lambda c: c + 1)`, I decided against it, because the test would look really ugly, and, more importantly, `Stream_exact` would actually raise an error (at least it should).  So, in fact an output `0` (without the `O(z^7)`) is a promise that the stream is zero.

`__pow__` actually does the right thing: if `self` is 0, then it calls `generic_power`, which calls `_mul_`, which returns `0`.  I will add a test, however.


---

Comment by git created at 2021-08-27 13:01:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-08-27 13:02:31

Replying to [comment:123 mantepse]:
> Concerning `L(0).map_coefficients(lambda c: c + 1)`, I decided against it, because the test would look really ugly,

It is a test, and it would make it clear what behavior we expect.

> and, more importantly, `Stream_exact` would actually raise an error (at least it should).  So, in fact an output `0` (without the `O(z^7)`) is a promise that the stream is zero.

It is possible we optimize out some of the checks for `Stream_exact` that ends up allowing this to sneak through. So it makes the test more robust.

> `__pow__` actually does the right thing: if `self` is 0, then it calls `generic_power`, which calls `_mul_`, which returns `0`.  I will add a test, however.

I agree that it does the right thing, but we can certainly optimize it.


---

Comment by mantepse created at 2021-08-27 13:21:23

Hm, I have a question about 0 actually: can we make something like the following work:


```
sage: L.<z> = LazyLaurentSeriesRing(QQ)
sage: L(0) is L.zero()
```



---

Comment by mantepse created at 2021-08-27 13:31:15

One further thought:

I'm not quite sure we should really insist in the doctests on a difference between `Stream_exact` and `Stream_zero`.  It looks like an implementation detail to me.  I think that from the user's perspective, there should be absolutely no difference in behaviour between the two - in contrast to any `Stream_inexact`.

In case you do not agree, did you have a test as follows in mind:

```
            sage: from sage.data_structures.stream import Stream_zero
            sage: L.<z> = LazyLaurentSeriesRing(ZZ)
            sage: s = L(0).map_coefficients(lambda c: c + 1); s
            0
            sage: isinstance(s._coeff_stream, Stream_zero)
            True
```



---

Comment by tscrim created at 2021-08-27 17:14:36

Replying to [comment:127 mantepse]:
> One further thought:
> 
> I'm not quite sure we should really insist in the doctests on a difference between `Stream_exact` and `Stream_zero`.  It looks like an implementation detail to me.  I think that from the user's perspective, there should be absolutely no difference in behaviour between the two - in contrast to any `Stream_inexact`.

Running that argument further, `Stream_exact` and `Stream_inexact` could be seen as an implementation detail. All the user sees is the element of the lazy Laurent series. It is the developers that see more (as they need to).

Here we are actually wanting to test something about the implementation. Plus `Stream_zero` is a very special object because it is the only thing that will have a non-integer (approximate) order.

I don't think we should test `foo(L(0)) is L.zero()` as we cannot (nor should) presume there is a unique `zero` instance. Although this would be highly desirable.

> In case you do not agree, did you have a test as follows in mind:
> {{{
>             sage: from sage.data_structures.stream import Stream_zero
>             sage: L.<z> = LazyLaurentSeriesRing(ZZ)
>             sage: s = L(0).map_coefficients(lambda c: c + 1); s
>             0
>             sage: isinstance(s._coeff_stream, Stream_zero)
>             True
> }}}

Yes, that would be the test I would want to run here.


---

Comment by git created at 2021-08-28 13:20:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2021-08-28 13:21:24

Replying to [comment:128 tscrim]:
> Replying to [comment:127 mantepse]:
> > One further thought:
> > 
> > I'm not quite sure we should really insist in the doctests on a difference between `Stream_exact` and `Stream_zero`.  It looks like an implementation detail to me.  I think that from the user's perspective, there should be absolutely no difference in behaviour between the two - in contrast to any `Stream_inexact`.
> 
> Running that argument further, `Stream_exact` and `Stream_inexact` could be seen as an implementation detail. All the user sees is the element of the lazy Laurent series. It is the developers that see more (as they need to).
> 
> Here we are actually wanting to test something about the implementation. Plus `Stream_zero` is a very special object because it is the only thing that will have a non-integer (approximate) order.

I have done the requested change.  The remainder of this comment is only for our personal enjoyment:

I think that there is quite a fundamental - and in fact user-visible - difference between `Stream_exact` and `Stream_inexact`.  It is user visible, since the big-O term is missing from the output.  It is fundamental, because we can decide equality.

I agree with your argument that `Stream_zero` is a very special object because of its infinite order.


---

Comment by git created at 2021-08-28 13:46:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2021-08-28 14:07:26

I'm not sure whether you will hate me for this :-)

I think we should change the order of the optional arguments.  Currently, we have:

```
    def _element_constructor_(self, x=None, valuation=None, constant=None, degree=None):
```

I think

```
    def _element_constructor_(self, x=None, valuation=None, degree=None, constant=None):
```

would be more logical.  As I mentioned on #32309, we should also give the user the possibility to be explicit whether the argument is supposed to be interpreted as a polynomial or a function that yields the coefficients.  It appears to me, that the least disruptive way is

```
    def _element_constructor_(self, x=None, valuation=None, degree=None, constant=None, coefficients=None):
```


Note that the original code does only allows a single value as argument to the element constructor, which then returns a constant series.


---

Comment by mantepse created at 2021-08-31 05:29:21

Ping?


---

Comment by git created at 2021-08-31 06:15:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-31 06:26:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2021-08-31 06:29:10

Should we insist that valuation is an integer?

We currently test that it is not `None`, but I think it would be better to test `in ZZ`.  Of course, that won't help with silliness of `True`, but `isinstance(valuation, Integer)` seems a bit strict to me.


---

Comment by tscrim created at 2021-08-31 06:43:12

Sorry, busy with teaching at the start of the week.

comment:132:

I don't think we should have a separate `coefficients` input; it is too problematic for a user to input things. We probably want to change the logic order to handle the case when the input is a callable before we check if we can convert to the Laurent polynomial ring.

Putting `degree` before `constant` is a good idea. We just have to tweak the logic for parsing the old input format.

comment:136:

I don't think we really need to make sure all input is valid. So we could trust the user with good input (and the result will fail at some point). However, I am not opposed to adding this `in ZZ` test, but it should be within the `is not None` check as it should raise an error if that extra check fails.


---

Comment by mantepse created at 2021-08-31 06:59:29

Sorry to put extra burden on you.

Concerning coefficients: there is no way to distinguish between coefficients and polynomials, since polynomials are callable.


---

Comment by git created at 2021-08-31 07:05:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2021-08-31 09:34:20

I'm afraid we should also do something about `series`.  The old signature was:

```
 series(coefficient, valuation, constant=None)

    Return a lazy Laurent series.

    INPUT:

        coefficient – Python function that computes coefficients

        valuation – integer; approximate valuation of the series

        constant – either None or pair of an element of the base ring and an integer
```

Currently, the signature is

```
    def series(self, coefficient, valuation, constant=None, degree=None):
```

which is confusing.

Should we make it 

```
    def series(self, coefficient, valuation, degree=None, constant=None):
```

and allow `degree` to be a pair `(constant, degree)` or

```
    def series(self, coefficient, valuation, constant=None):
```

?

(perhaps it would be better to deprecate this method anyway)


---

Comment by tscrim created at 2021-09-01 00:17:32

Don't worry about it; I just might not be able to always push changes so quickly this week.

We still don't have a good replacement for what the `series` method does. However, I agree with changing the signature and allowing the pair input. I also did the same if someone does `constant=(a,b)`.

I thought a bit more about the `coefficients` attributes for the `_element_constructor_`. I think you're right that there is not really a better solution. I implemented something that is more minimal of a change to avoid duplication and to minimize the impact. Although on this ticket, it is likely not necessary as we cannot (easily) demonstrate a case where we must use the option.

I also added the checks for `valuation in ZZ`.
----
New commits:


---

Comment by mantepse created at 2021-09-01 07:25:53

Thank you! Looks OK, if you agree, please set it back to 'positive review'!


---

Comment by tscrim created at 2021-09-01 07:27:40

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2021-09-01 07:27:40

Thank you. Now back to work on Dirichlet series.


---

Comment by vbraun created at 2021-09-05 21:38:58

Resolution: fixed
