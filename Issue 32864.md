# Issue 32864: lrslib: fix doctest in game_theory/parser.py

Issue created by migration from https://trac.sagemath.org/ticket/33101

Original creator: @mwageringel

Original creation time: 2021-12-31 16:23:15

CC:  klee slabbe

Keywords: lrslib

Apparently, the number of list elements has changed in these tests, but the parsing functionality seems to be unaffected:


```
sage -t --long --warn-long 86.7 --random-seed=66133510998005725882865822426008192085 src/sage/game_theory/parser.py
**********************************************************************
File "src/sage/game_theory/parser.py", line 75, in sage.game_theory.parser.Parser.format_lrs
Failed example:
    lrs_output[:-2]                                                    # optional - lrslib
Expected:
    [...,
     '2  0  1  2 \n',
     '1  1/2  1/2 -2 \n',
     '\n',
     '2  0  1  2 \n',
     '1  0  1 -2 \n',
     '\n',
     '*Number of equilibria found: 2\n',
     '*Player 1: vertices=3 bases=3 pivots=5\n',
     '*Player 2: vertices=2 bases=1 pivots=6\n',
     '\n']
Got:
    ['*lrsnash:lrslib v.7.0 2018.7.1(64bit,lrsgmp.h,hybrid arithmetic) gmp v.6.1\n',
     '2  0  1  2 \n',
     '1  1/2  1/2 -2 \n',
     '\n',
     '2  0  1  2 \n',
     '1  0  1 -2 \n',
     '\n',
     '*Number of equilibria found: 2\n',
     '*Player 1: vertices=3 bases=3 pivots=5\n',
     '*Player 2: vertices=2 bases=1 pivots=6\n',
     '\n',
     '*lrsnash:lrslib v.7.0 2018.7.1(64bit,lrsgmp.h,hybrid arithmetic)\n']
```




---

Comment by @mwageringel created at 2021-12-31 16:42:08

New commits:


---

Comment by @mwageringel created at 2021-12-31 16:42:08

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-12-31 18:47:41

Your lrslib is older than what is in our distribution


---

Comment by @mwageringel created at 2022-01-01 09:52:00

This was after a distclean. I had not explicitly installed lrslib, it was on the system. If I understand the config.log correctly, the system lrslib was not accepted by Sage. Yet, ptestlong runs the optional lrslib tests.

```
## ------------------------------------------------------- ##
## Checking whether SageMath should install SPKG lrslib... ##
## ------------------------------------------------------- ##
configure:30190: checking whether any of gmp flint is installed as or will be installed as SPKG
configure:30194: result: yes; install lrslib as well
configure:30296: no suitable system package found for SPKG lrslib
```



---

Comment by mkoeppe created at 2022-01-01 17:05:09

Changing status from needs_review to needs_work.


---

Attachment

`lrslib` is optional, so it will not be installed unless you use `configure --enable-lrslib` (or install the package explicitly using `sage -i lrslib`).

That the doctest is tested anyway is an interesting new behavior introduced by #32174. It finds system `lrslib` at runtime via `sage.features.lrs`


---

Comment by slabbe created at 2022-01-04 11:22:29

Replying to [comment:4 mkoeppe]:
> That the doctest is tested anyway is an interesting new behavior introduced by #32174. It finds system `lrslib` at runtime via `sage.features.lrs`

Is it a good thing or a bad thing?

Also, I notice that lrslib appears both as an optional package and as a feature to be detected:


```
Using --optional=4ti2,bliss,build,cbc,ccache,cryptominisat,database_symbolic_data,debian,debugpy,dochtml,dot2tex,e_antic,fricas,glucose,latte_int,lidia,lrslib,normaliz,notedown,pandoc_attributes,pip,pycosat,pynormaliz,rst2ipynb,rubiks,sage,sage_numerical_backends_coin,sage_spkg
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,ffmpeg,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,pandoc,pdf2svg,plantri,pynormaliz,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.plot,sage.rings.number_field,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,tdlib
```


But at the end, lrslib does not appear:


```
Features detected for doctesting: 
```

Therefore, in my case, lrslib tests are run because it is an optional package that I haved installed:


```
$ sage -optional | grep lrs
lrslib..................................071b+autotools-2021-07-13 (071b+autotools-2021-07-13)
```


In my case, tests passed with and without the branch. Why needs work?


---

Comment by @mwageringel created at 2022-01-04 11:46:11

Replying to [comment:5 slabbe]:
> Replying to [comment:4 mkoeppe]:
> > That the doctest is tested anyway is an interesting new behavior introduced by #32174. It finds system `lrslib` at runtime via `sage.features.lrs`
> 
> Is it a good thing or a bad thing?

It should not happen. Sage knows that my system lrslib is not compatible with my Sage installation, so the optional tests should not be run with an incompatible lrslib version (note that I have not installed the optional package). I do not know how to solve this, though.

> In my case, tests passed with and without the branch. Why needs work?

The branch makes the tests pass, but actually does not solve the underlying problem.


---

Comment by slabbe created at 2022-01-04 11:58:29

What is the output of this on your machine?

```
sage: from sage.features.lrs import Lrs
sage: Lrs().is_present()
sage: Lrs().is_functional()
```



---

Comment by @mwageringel created at 2022-01-04 13:30:47


```
sage: from sage.features.lrs import Lrs
sage: Lrs().is_present()
FeatureTestResult('lrslib', True)
sage: Lrs().is_functional()
FeatureTestResult('lrslib', True)
```



---

Comment by slabbe created at 2022-01-04 14:18:32

If the `lrslib` that is available on your machine is not functional, you should be able to find an example where it does not behave correctly and you can add this example to the list of examples checked in the method `is_functional` so that `is_functional()` returns `False`. This will imply that the doctests marked with tag `lrslib` will not be run on your machine.


---

Comment by slabbe created at 2022-01-04 14:24:18

Such an example illustrating the new input format is provided in `build/pkgs/lrslib/spkg-configure.m4`. I don't know if there is a way for features to use the stuff from the m4 files without copy-pasting the example?


---

Comment by @mwageringel created at 2022-01-04 16:36:12

Independently of the doctesting behavior – if I use lrslib functionality at runtime, why does Sage not raise an error telling me to install the optional package first? Is it safe to just use it without checking? I know nothing about lrslib, to be honest. For some interfaces such as Macaulay2, it is usually not necessary to check the concrete version that is installed, but I am not sure about optional packages. Especially due to the gmp/flint dependency, as seen in comment:3.


---

Comment by slabbe created at 2022-01-04 20:38:10

Replying to [comment:11 gh-mwageringel]:
> Independently of the doctesting behavior – if I use lrslib functionality at runtime, why does Sage not raise an error telling me to install the optional package first? 

I think it is because it checks whether `lrs` command exists in the `sage -sh` environment which is a union of command from sage and from your system. Since the feature `lrs` is found there, it does not tell you to install it.

> Is it safe to just use it without checking? 

A check *is* done in the `is_functional` method. (Maybe the goal of this ticket is to update this method.)

> I know nothing about lrslib, to be honest. 

Me neither.

> For some interfaces such as Macaulay2, it is usually not necessary to check the concrete version that is installed, but I am not sure about optional packages. Especially due to the gmp/flint dependency, as seen in comment:3.

One option is to change the feature `lrs` which is currently written as an executable `class Lrs(Executable)` and modify it into just feature that checks the presence of the optional package. I let someone else more knowledgeable on lrs than me decides here.


---

Comment by mkoeppe created at 2022-01-04 21:04:03

Replying to [comment:12 slabbe]:
> One option is to change the feature `lrs` which is currently written as an executable `class Lrs(Executable)` and modify it into just feature that checks the presence of the optional package.

No, this is not a step in a good direction. Note that our build system does not record at all whether an optional system package is available. The point of going through `Feature`s is that it also works on both system packages and SPKGs.

I would suggest to:
- check whether lrslib 070 works correctly (perhaps in one of our previous tickets this is already commented on, I don't recall) and if so, relax the tests in `build/pkgs/lrslib/spkg-configure.m4` so that they accept this version
- run equivalents of the tests made by `spkg-configure.m4` in the `lrs` Feature (comment:9, comment:10).


---

Comment by dimpase created at 2022-01-14 11:17:31

I think the branch here is a reasonable compromise. Rejecting a library just because it outputs something in a slightly different way seems to be an overkill.


---

Comment by dimpase created at 2022-01-14 11:17:31

Changing status from needs_work to positive_review.


---

Comment by slabbe created at 2022-01-14 11:41:23

Changing status from positive_review to needs_info.


---

Comment by slabbe created at 2022-01-14 11:42:08

Please, wait a second, I was actually working on a branch adressing the comment 13.


---

Comment by slabbe created at 2022-01-14 11:45:02

New commits:


---

Comment by slabbe created at 2022-01-14 11:45:02

Changing status from needs_info to needs_review.


---

Comment by slabbe created at 2022-01-14 11:47:23

_This comment was moved to #33167#comment:5 _


---

Comment by dimpase created at 2022-01-14 12:20:03

Replying to [comment:17 slabbe]:
> Please, wait a second, I was actually working on a branch adressing the comment 13.

I don't agree that comment:13 is totally right. It's a slightly different output (cause this doctest does parse output!), just as is the case for e.g. numerical noise.


---

Comment by slabbe created at 2022-01-14 14:06:17

Changing status from needs_review to positive_review.


---

Comment by slabbe created at 2022-01-14 14:06:17

Ok, I agree, my branch is more to address comment 3 of this ticket than to address the problem described in the description of this ticket.

Let me put back the previous branch. And I will post my branch on another ticket.
----
New commits:


---

Comment by slabbe created at 2022-01-14 14:12:34

And I created #33167 to address comment:3


---

Comment by slelievre created at 2022-01-22 12:54:05

Changing priority from major to critical.


---

Comment by slelievre created at 2022-01-25 07:34:21

Changing priority from critical to blocker.


---

Comment by slelievre created at 2022-01-25 07:34:21

Needed to resume patchbot operation.


---

Comment by @mwageringel created at 2022-01-25 08:16:19

Changing priority from blocker to critical.


---

Comment by @mwageringel created at 2022-01-25 08:16:19

This is not a blocker, in my opinion, as it does not change any functionality at all, but only touches a flaky doctest. Patchbot owners could enable the optional package, as a workaround.


---

Comment by slelievre created at 2022-01-30 15:39:13

Setting milestone to 9.6 now that 9.5 is out.


---

Comment by vbraun created at 2022-01-31 23:32:02

Resolution: fixed
