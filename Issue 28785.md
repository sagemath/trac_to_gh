# Issue 28785: src/setup.py: Create module sage.env_config, which defines variables for use in sage.env

Issue created by migration from https://trac.sagemath.org/ticket/29022

Original creator: mkoeppe

Original creation time: 2020-01-15 22:39:45

CC:  fbissey arojas isuruf embray infinity0 @timokau jdemeyer dimpase jhpalmieri




---

Comment by mkoeppe created at 2020-01-15 23:30:09

New commits:


---

Comment by mkoeppe created at 2020-01-15 23:30:09

Changing status from new to needs_review.


---

Comment by fbissey created at 2020-01-16 01:10:27

Interesting concept. But your branch won't achieve much since `SAGE_LOCAL` is not `None`. In fact the problem of the value of `SAGE_LOCAL` is solved in most case by the current setting of `os.path.abspath(sys.prefix)`. Did you mean to set `SAGE_ROOT`?


---

Comment by mkoeppe created at 2020-01-16 01:17:46

Replying to [comment:5 fbissey]:
> Interesting concept. But your branch won't achieve much since `SAGE_LOCAL` is not `None`. In fact the problem of the value of `SAGE_LOCAL` is solved in most case by the current setting of `os.path.abspath(sys.prefix)`. 

1) With #29013, `os.path.abspath(sys.prefix)` is the location of the venv, and not equal to `SAGE_LOCAL`.

2) If one starts Sage's Python directly, without going through `sage-env`, then the environment variable `SAGE_LOCAL` is not set; and in this case it is retrieved from `env_config.py`.


---

Comment by mkoeppe created at 2020-01-16 01:21:26

But yes, let's add `SAGE_ROOT` to it.


---

Comment by fbissey created at 2020-01-16 01:46:08

I misunderstood the way the code works in `var`. I thought your value from `env_config.py` wouldn't be used.
For your points
 1) OK - I get it, that's a problem

 2) I am perfectly happy with it being set as `os.path.abspath(sys.prefix)` if `sage-env` is not loaded as it is now. But your alternative is acceptable and of course solves your issue at (1).

I removed `sage-env` completely from sage-on-gentoo a number of releases ago and it does work nicely with very little patching (I upstreamed most of it). There is only one place now where I have to replace a call to `SAGE_ROOT` at runtime (in `sage.misc.copying`). I'd say sage works at 99.99% out of the box without needing `sage-env`, in particular you should be able to call it directly from python. 

However 
 1) your venv work may introduce a few disparities

 2) being able to override some default from a standardised configuration file instead of patching for your distro values is very appealing.

I don't particularly need `SAGE_ROOT` to be set (in fact `None` suits me just fine since it doesn't make much sense on a distro), it was just my misconception on what you were doing.


---

Comment by mkoeppe created at 2020-01-16 01:58:42

Replying to [comment:8 fbissey]:
> I don't particularly need `SAGE_ROOT` to be set (in fact `None` suits me just fine since it doesn't make much sense on a distro), it was just my misconception on what you were doing.

Yes, I agree that SAGE_ROOT is not very important, but it's still used for developer convenience functions like those in `sage.misc.edit_module`.


---

Comment by fbissey created at 2020-01-16 02:08:10

Replying to [comment:9 mkoeppe]:
> Replying to [comment:8 fbissey]:
> > I don't particularly need `SAGE_ROOT` to be set (in fact `None` suits me just fine since it doesn't make much sense on a distro), it was just my misconception on what you were doing.
> 
> Yes, I agree that SAGE_ROOT is not very important, but it's still used for developer convenience functions like those in `sage.misc.edit_module`.

`SAGE_ROOT` is mentioned in the documentation string for `edit_devel` but is otherwise absent. The bit in documentation should have been amended at the same time as https://github.com/sagemath/sage/commit/c352b1d5920ce9ffaebada2fe172784b2ba3e3fb#diff-141c6e649507c15775d157f417db1e26 I guess.

Almost all of the `SAGE_ROOT` stuff left pertains to packaging I think.


---

Comment by mkoeppe created at 2020-01-16 02:09:30

Note `SAGE_SRC` is defined through `SAGE_ROOT`.


---

Comment by fbissey created at 2020-01-16 02:16:07

Replying to [comment:11 mkoeppe]:
> Note `SAGE_SRC` is defined through `SAGE_ROOT`.


```
var('SAGE_SRC',            join(SAGE_ROOT, 'src'), SAGE_LIB)
```

I made sure of that :) - so if `SAGE_ROOT` is `None`, `SAGE_SRC` is set to `SAGE_LIB`. I guess you may prefer the `SAGE_ROOT` based value. But on a distro it will give me a read only view of the code (which is the best you should hope for if you install stuff with your distro package manager).


---

Comment by embray created at 2020-01-16 11:52:43

I don't see why it needs to explicitly be a Python module.  I think my proposal in #22652 is simpler, because the same file could be used both for configuring the shell environment, and can be read by the Python code.

To me this just seems like extra cruft.


---

Comment by embray created at 2020-01-16 12:01:30

Replying to [comment:6 mkoeppe]:
> Replying to [comment:5 fbissey]:
> > Interesting concept. But your branch won't achieve much since `SAGE_LOCAL` is not `None`. In fact the problem of the value of `SAGE_LOCAL` is solved in most case by the current setting of `os.path.abspath(sys.prefix)`. 
> 
> 1) With #29013, `os.path.abspath(sys.prefix)` is the location of the venv, and not equal to `SAGE_LOCAL`.

`sys.prefix` may not be, but even in a venv `sysconfig.get_config_var('prefix')` will always give you the original install prefix for Python, which when using Sage's Python _will_ be `SAGE_LOCAL`.


---

Comment by embray created at 2020-01-16 12:09:11

Replying to [comment:13 embray]:
> I don't see why it needs to explicitly be a Python module.  I think my proposal in #22652 is simpler, because the same file could be used both for configuring the shell environment, and can be read by the Python code.
> 
> To me this just seems like extra cruft.

For example, a file like this could be generated at build time by running something like:


```
$ (source src/bin/sage-env-config && env | grep '^SAGE_' | sort)
SAGE_ARB_LIBRARY=arb
SAGE_CONFIGURE_FLINT=--with-flint=/home/embray/src/sagemath/sage/local
SAGE_CONFIGURE_GMP=--with-gmp=/home/embray/src/sagemath/sage/local
SAGE_CONFIGURE_MPC=--with-mpc=/home/embray/src/sagemath/sage/local
SAGE_CONFIGURE_MPFR=--with-mpfr=/home/embray/src/sagemath/sage/local
SAGE_CONFIGURE_NTL=--with-ntl=/home/embray/src/sagemath/sage/local
SAGE_CONFIGURE_PARI=--with-pari=/home/embray/src/sagemath/sage/local
SAGE_CRTI_DIR=
SAGE_FLINT_PREFIX=/home/embray/src/sagemath/sage/local
SAGE_FREETYPE_PREFIX=
SAGE_GLPK_PREFIX=/home/embray/src/sagemath/sage/local
SAGE_GMP_INCLUDE=/home/embray/src/sagemath/sage/local/include
SAGE_GMP_PREFIX=/home/embray/src/sagemath/sage/local
SAGE_LOCAL=/home/embray/src/sagemath/sage/local
SAGE_MPC_PREFIX=/home/embray/src/sagemath/sage/local
SAGE_MPFR_PREFIX=/home/embray/src/sagemath/sage/local
SAGE_NTL_PREFIX=/home/embray/src/sagemath/sage/local
SAGE_PARI_CFG=/home/embray/src/sagemath/sage/local/lib/pari/pari.cfg
SAGE_PARI_PREFIX=/home/embray/src/sagemath/sage/local
SAGE_PKG_CONFIG_PATH=
SAGE_PYTHON_VERSION=2
```


It could be output to a .py module that's (optionally) imported by `sage.env`, or just a ".env" file (a common extension being used in recent years for a file like this that specifies some environment variables for a project).  Distros, if they wish, could write their own version of this file without patching.


---

Comment by mkoeppe created at 2020-01-16 12:44:14

Replying to [comment:14 embray]:
> Replying to [comment:6 mkoeppe]:
> > Replying to [comment:5 fbissey]:
> > > Interesting concept. But your branch won't achieve much since `SAGE_LOCAL` is not `None`. In fact the problem of the value of `SAGE_LOCAL` is solved in most case by the current setting of `os.path.abspath(sys.prefix)`. 
> > 
> > 1) With #29013, `os.path.abspath(sys.prefix)` is the location of the venv, and not equal to `SAGE_LOCAL`.
> 
> `sys.prefix` may not be, but even in a venv `sysconfig.get_config_var('prefix')` will always give you the original install prefix for Python, which when using Sage's Python _will_ be `SAGE_LOCAL`.

Thanks for this useful info. The purpose of this ticket, however, is to get rid of assumptions like that, to enable use of system python, see #27824.


---

Comment by embray created at 2020-01-16 14:04:03

Yeah, I see what you're saying.  Long term I think it would be great if we could get rid of "SAGE_LOCAL" altogether, though I'm not exactly sure what the alternative looks like either...


---

Comment by mkoeppe created at 2020-01-17 14:29:49

Needs review.


---

Comment by embray created at 2020-01-17 15:12:53

Changing status from needs_review to needs_info.


---

Comment by embray created at 2020-01-17 15:12:53

Sorry, I'm just not convinced this is useful.  At least not yet.  It's not needed for setting SAGE_LOCAL.  I do agree something like this might be useful for setting other paths related to Sage's dependencies, but I don't think that's necessarily something that should be output by a configure script either, but rather should be loaded from a config file that downstream packagers can modify without patching if need be.

To expand on that a bit, the sage-the-distribution configure script is not generally run by packagers.  Instead, this should be handled at the level of the sagelib package itself.


---

Comment by mkoeppe created at 2020-01-17 15:14:52

Replying to [comment:20 embray]:
> I don't think that's necessarily something that should be output by a configure script either, but rather should be loaded from a config file that downstream packagers can modify without patching if need be.
Sage-the-distribution generates the file using configure script. Downstream packagers would generate the file by any means that they prefer.


---

Comment by embray created at 2020-01-17 15:24:24

Replying to [comment:21 mkoeppe]:
> Replying to [comment:20 embray]:
> > I don't think that's necessarily something that should be output by a configure script either, but rather should be loaded from a config file that downstream packagers can modify without patching if need be.
> Sage-the-distribution generates the file using configure script. Downstream packagers would generate the file by any means that they prefer.

If that's the case, I don't think `env_config.py.in` should even be directly in the sage package.  But I also think this file should not go directly into the sage package at all.  It would be better if it were external to the sage package's source tree; but it could still be generated and installed along with the package, but that would be a step handled by setup.py.  I also still fail to see the point of making it an actual Python module.


---

Comment by embray created at 2020-01-17 15:25:30

I think what I also need to see here is a concrete use case...


---

Comment by mkoeppe created at 2020-01-17 15:40:15

Replying to [comment:22 embray]:
> Replying to [comment:21 mkoeppe]:
> > Sage-the-distribution generates the file using configure script. Downstream packagers would generate the file by any means that they prefer.
> 
> If that's the case, I don't think `env_config.py.in` should even be directly in the sage package. 

It's the autoconf standard to have templates right next to the file they are templating.

> But I also think this file should not go directly into the sage package at all.  It would be better if it were external to the sage package's source tree; but it could still be generated and installed along with the package, but that would be a step handled by setup.py. 

I actually agree with that, as you can see in the ticket description: **In a follow-up ticket, src/sage/env_config.py would actually be generated by src/setup.py, not configure.**

>  I also still fail to see the point of making it an actual Python module.

It's the easiest way to import values into Python, without having to fight about the "correct" file format to use. toml, anyone?


---

Comment by embray created at 2020-01-17 16:15:43

Replying to [comment:24 mkoeppe]:
> Replying to [comment:22 embray]:
> > Replying to [comment:21 mkoeppe]:
> > > Sage-the-distribution generates the file using configure script. Downstream packagers would generate the file by any means that they prefer.
> > 
> > If that's the case, I don't think `env_config.py.in` should even be directly in the sage package. 
> 
> It's the autoconf standard to have templates right next to the file they are templating.
> 
> > But I also think this file should not go directly into the sage package at all.  It would be better if it were external to the sage package's source tree; but it could still be generated and installed along with the package, but that would be a step handled by setup.py. 
> 
> I actually agree with that, as you can see in the ticket description: **In a follow-up ticket, src/sage/env_config.py would actually be generated by src/setup.py, not configure.**

I think if we started with that, and put the .in file just directly under src/ instead of src/sage I'd be less concerned about this (I still don't see the need, but I wouldn't fight it as much).

> >  I also still fail to see the point of making it an actual Python module.
> 
> It's the easiest way to import values into Python, without having to fight about the "correct" file format to use. toml, anyone?

I already suggested a ".env" format which is just one "KEY=VALUE" per line, and can also be sourced by shell scripts.


---

Comment by mkoeppe created at 2020-01-17 16:24:38

Replying to [comment:25 embray]:
> > > But I also think this file should not go directly into the sage package at all.  It would be better if it were external to the sage package's source tree; but it could still be generated and installed along with the package, but that would be a step handled by setup.py. 
> > 
> > I actually agree with that, as you can see in the ticket description: **In a follow-up ticket, src/sage/env_config.py would actually be generated by src/setup.py, not configure.**
> 
> I think if we started with that, and put the .in file just directly under src/ instead of src/sage I'd be less concerned about this 

By making it a Python module in src/sage, it is installed by the standard facilities (`setup.py`) that already work now, not in some unspecified future.


---

Comment by mkoeppe created at 2020-01-17 16:34:37

I note here that everything about our installation of non-Python components that reside in `src/` is ad-hoc and we seem to have been unable to make progress on this in years. Relevant tickets:
- #21785 - Installation of SAGE_SRC/ext/ in SAGE_LOCAL/share/sage/ext/ should be done by setup.py, not build/make/Makefile
- #22655 - Support package_data-like of non-Python resource files in Python packages
- #21569 - Install src/bin/* scripts via setup.py (scripts, console_scripts)
That's why I prefer an actionable solution that uses a solid part - the installation of Python modules.


---

Comment by mkoeppe created at 2020-01-17 17:22:02

I've expanded on the explanation of the goals of this ticket.


---

Comment by mkoeppe created at 2020-01-17 17:55:04

Replying to [comment:23 embray]:
> I think what I also need to see here is a concrete use case...
Take a look a the new ticket description please.


---

Comment by mkoeppe created at 2020-01-17 17:55:13

Changing status from needs_info to needs_review.


---

Comment by git created at 2020-01-17 19:45:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-18 17:42:50

Replying to [comment:22 embray]:
> > Sage-the-distribution generates the file using configure script. Downstream packagers would generate the file by any means that they prefer.
> 
> If that's the case, I don't think `env_config.py.in` should even be directly in the sage package.  But I also think this file should not go directly into the sage package at all.  It would be better if it were external to the sage package's source tree; but it could still be generated and installed along with the package

In #29038 I now do exactly that. Thanks for the input.


---

Comment by mkoeppe created at 2020-01-19 19:39:01

This ticket is superseded by #29038 - Python package `sage_conf`: Provides optional configuration information for sagelib.


---

Comment by dimpase created at 2020-01-19 20:41:52

Changing status from needs_review to positive_review.


---

Comment by embray created at 2020-01-22 12:06:05

Changing status from positive_review to needs_info.


---

Comment by embray created at 2020-01-22 12:06:05

Replying to [comment:39 mkoeppe]:
> Replying to [comment:22 embray]:
> > > Sage-the-distribution generates the file using configure script. Downstream packagers would generate the file by any means that they prefer.
> > 
> > If that's the case, I don't think `env_config.py.in` should even be directly in the sage package.  But I also think this file should not go directly into the sage package at all.  It would be better if it were external to the sage package's source tree; but it could still be generated and installed along with the package
> 
> In #29038 I now do exactly that. Thanks for the input.

I'm sorry, what you did in that ticket is not what I meant at all, and that's my fault for not being clearer and more explicit.  What I had in mind here was this:

* I was unclear when I wrote "external to the sage package's source tree".  What I meant was (relative to the git repository), still in `src/`, but not in `src/sage`.

* These settings (whether written by sage-the-distribution's configure script, or by hand by a packager) would be written by `src/setup.py` into a file that *is* installed in the `sage` package.

An analogy I would use is `numpy.__config__`.  If you look at it, and Numpy's setup.py, you can see that it's generated and installed inside the numpy package.  This is close to what you are trying to do, but just a different approach to how the file is installed.

I'm still -1 on it being a .py module, but if you feel strongly about that I'd take it as long as we can do the rest more like Numpy does.


---

Comment by dimpase created at 2020-01-22 12:19:45

numpy's configuration/setup is IMHO a good example of how NOT to do such things.


---

Comment by mkoeppe created at 2020-01-22 14:08:24

Replying to [comment:42 embray]:
> I'd take it as long as we can do the rest more like Numpy does.
Numpy's solution, expecting a configuration file in its to-be-installed sources, is outdated (and, by the way, untested by upstream) because it is incompatible with pip-installing from a source other than a local directory.

Let's continue the discussion in #29038.


---

Comment by mkoeppe created at 2020-01-25 18:31:24

Changing status from needs_info to needs_review.


---

Comment by mkoeppe created at 2020-01-25 18:31:24

This ticket can now be closed because superseded by #29038.


---

Comment by dimpase created at 2020-01-25 18:34:24

Changing status from needs_review to positive_review.


---

Comment by embray created at 2020-01-31 11:27:27

Resolution: wontfix


---

Comment by embray created at 2020-01-31 11:29:04

Replying to [comment:44 mkoeppe]:
> Replying to [comment:42 embray]:
> > I'd take it as long as we can do the rest more like Numpy does.
> Numpy's solution, expecting a configuration file in its to-be-installed sources, is outdated (and, by the way, untested by upstream) because it is incompatible with pip-installing from a source other than a local directory.
> 
> Let's continue the discussion in #29038.

I dont think so; you could also pass the configuration by other means but it's just an example.  I don't see how #29038 makes this any better.  Now you have to have a whole external Python module to do the same thing.


---

Comment by dimpase created at 2020-01-31 12:59:51

wrapping up configuration into a Python package is more Pythonic than "other means". "A whole external Python" module is way cleaner than a bunch of text files (maybe sourceable from shell, maybe not) for a Python library.


---

Comment by fbissey created at 2020-01-31 19:31:28

I need to do a write up about this. I guess I exchanged a bigger patch for a smaller one and an extra file. The issue with your python module is that it is not a proper package. I don't have a tarball for the source apart from sage's own source and it is not versioned. So as a distro packager I am looking at this as extra work if I want to package it as a separate python module because I have to do the packaging and versioning myself.

So right now I have a patch to look for sage.sage_conf in env.py, and I am putting sage_conf.py next to env.py. There may be something wrong with putting sage_cong.py.in in the source themselves. But replacing it by an half assed package is hardly ideal.


---

Comment by dimpase created at 2020-01-31 19:47:15

Replying to [comment:50 fbissey]:
> I need to do a write up about this. I guess I exchanged a bigger patch for a smaller one and an extra file. The issue with your python module is that it is not a proper package. I don't have a tarball for the source apart from sage's own source and it is not versioned. So as a distro packager I am looking at this as extra work if I want to package it as a separate python module because I have to do the packaging and versioning myself.

We can make ./bootstrap to generate a tarball of it in upstream/ just as it's done 
for configure package.

Will it help?


---

Comment by fbissey created at 2020-01-31 19:58:28

It'd possibly be an improvement if it is properly versioned. But it would still need to be pre-processed before it being usable. You are running away from the complexity by heaping a bit more :)

I can adapt with most of the stuff that you throw at me. I have been doing that for about 12 years now. But I am fairly much in agreement with Erik that a different design should have been chosen altogether. In fact it's been years that I have been expecting sage to get a setup.cfg - at the very least for optional packages (the new design for coinor/gurobi/cplex rocks by the way).


---

Comment by mkoeppe created at 2020-01-31 20:01:16

Replying to [comment:50 fbissey]:
> I need to do a write up about this. I guess I exchanged a bigger patch for a smaller one and an extra file. The issue with your python module is that it is not a proper package. I don't have a tarball for the source apart from sage's own source and it is not versioned. So as a distro packager I am looking at this as extra work if I want to package it as a separate python module because I have to do the packaging and versioning myself.
> 
> So right now I have a patch to look for sage.sage_conf in env.py, and I am putting sage_conf.py next to env.py. There may be something wrong with putting sage_cong.py.in in the source themselves. But replacing it by an half assed package is hardly ideal.

Are you commenting on the right ticket? #29038 was merged, not this one.


---

Comment by fbissey created at 2020-01-31 20:05:51

You are right I should have commented on the other ticket. I just took the conversation on this ticket when I found it first in my inbox this morning. That being said I have been thinking of doing a comment for a week so I just took the opportunity before postponing it and never writing it. Of course the order I read things in my inbox in the morning is also a big influence in this case. But if I had waited to read all my inbox before thinking "I should put my comment there" I may not have written it at all :(


---

Comment by mkoeppe created at 2020-01-31 20:08:24

I recommend to read #21707. It gives the high-level overview.
