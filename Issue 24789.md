# Issue 24789: Update jmol to version 14.29.10

Issue created by migration from https://trac.sagemath.org/ticket/25026

Original creator: embray

Original creation time: 2018-03-22 15:04:12

CC:  fbissey paulmasson dimpase egourgoulhon jipilab thansen

The current version of Jmol in Sage is broken on newer JRE versions.  In particular it relies on a `sun.audio` package that [apparently](https://stackoverflow.com/questions/49051745/how-to-use-sun-audio-with-java-9), has been removed from newer versions of Java.  This causes Jmol to crash at startup.

The newest version fixes that issue, and presumably others.


---

Comment by embray created at 2018-03-22 15:05:08

New commits:


---

Comment by embray created at 2018-03-22 15:08:14

Any suggestions for where I could dump the upstream tarball?  I don't feel like hosting it on my personal dropbox, for example.


---

Comment by embray created at 2018-03-26 09:55:41

Also if anyone really familiar with Jmol wants to test this, that would be good.


---

Comment by fbissey created at 2018-03-26 20:24:30

To be honest if the doc builds properly and the pictures for 3D plots are OK and it passes doctests, I don't think it needs more testing apart may be trying `sphere()` on the command line to see that everything is fine.

The doc build process and the doctesting stress jmol quite a bit already.


---

Comment by tscrim created at 2018-03-27 00:02:06

If you still need a place to host the tarball, send it to me in an e-mail and I will use my Google Drive.


---

Comment by embray created at 2018-03-27 12:29:29

I'm tempted to re-up the attachment limit on Trac again to allow it, since really it's not a big deal...


---

Comment by embray created at 2018-03-30 13:44:33

Changing status from new to needs_review.


---

Attachment


---

Comment by embray created at 2018-03-30 13:55:10

We also need to fix the `is_jvm_available()` method to accept newer versions of Java...


---

Comment by embray created at 2018-03-30 14:26:11

A new error I'm getting even with the new jmol on Java 10:


```
sage: G=sphere((0,0,0),1)
sage: show(G,figsize=(5,5),title="Sample Figure",aspect_ratio=1);
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-2-32a6d0745925> in <module>()
----> 1 show(G,figsize=(Integer(5),Integer(5)),title="Sample Figure",aspect_ratio=Integer(1));

/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/repl/rich_output/pretty_print.pyc in show(*args, **kwds)
    256         args[0].show()
    257         return
--> 258     pretty_print(*args, **kwds)

/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/repl/rich_output/pretty_print.pyc in pretty_print(*args, **kwds)
    227             pass
    228         elif len(args) == 1:
--> 229             dm.display_immediately(*args, **kwds)
    230         else:
    231             SequencePrettyPrinter(*args, **kwds).pretty_print()

/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.pyc in display_immediately(self, obj, **rich_repr_kwds)
    831             1/2
    832         """
--> 833         plain_text, rich_output = self._rich_output_formatter(obj, rich_repr_kwds)
    834         self._backend.display_immediately(plain_text, rich_output)
    835

/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.pyc in _rich_output_formatter(self, obj, rich_repr_kwds)
    621         has_rich_repr = isinstance(obj, SageObject) and hasattr(obj, '_rich_repr_')
    622         if has_rich_repr:
--> 623             rich_output = self._call_rich_repr(obj, rich_repr_kwds)
    624         if isinstance(rich_output, OutputPlainText):
    625             plain_text = rich_output

/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.pyc in _call_rich_repr(self, obj, rich_repr_kwds)
    579         if rich_repr_kwds:
    580             # do not ignore errors from invalid options
--> 581             return obj._rich_repr_(self, **rich_repr_kwds)
    582         try:
    583             return obj._rich_repr_(self)

/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d._rich_repr_ (build/cythonized/sage/plot/plot3d/base.c:5362)()
    146         ### Second, return the corresponding graphics file
    147         if viewer == 'jmol':
--> 148             return self._rich_repr_jmol(**opts)
    149         elif viewer == 'tachyon':
    150             preferred = (

/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d._rich_repr_jmol (build/cythonized/sage/plot/plot3d/base.c:7806)()
    271                                             stderr=STDOUT).rstrip()
    272             script = '''set defaultdirectory "{0}"\nscript SCRIPT\n'''.format(scene_native)
--> 273             jdata.export_image(targetfile=preview_png, datafile=script,
    274                                image_type="PNG",
    275                                figsize=opts['figsize'][0])

/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/interfaces/jmoldata.pyc in export_image(self, targetfile, datafile, datafile_cmd, image_type, figsize, **kwds)
    181                 stdout=jout, stderr=jout, env=env)
    182         if not os.path.isfile(targetfile):
--> 183             raise RuntimeError("Jmol failed to create file %s, see %s for details"%(repr(targetfile), repr(scratchout)))
    184         os.unlink(scratchout)

RuntimeError: Jmol failed to create file '/home/embray/.sage/temp/NAVI-Brick/22388/dir_Zegm4i/preview.png', see '/home/embray/.sage/temp/NAVI-Brick/22388/tmp_UtrFaz.txt' for details
sage: cat '/home/embray/.sage/temp/NAVI-Brick/22388/tmp_UtrFaz.txt'
vwr handling error condition: java.lang.NoClassDefFoundError: org/apache/tools/bzip2/CBZip2InputStream
java.lang.NoClassDefFoundError: org/apache/tools/bzip2/CBZip2InputStream
        at java.base/java.lang.Class.forName0(Native Method)
        at java.base/java.lang.Class.forName(Unknown Source)
        at org.jmol.api.Interface.getInterface(Interface.java:49)
        at org.jmol.viewer.Viewer.getJzt(Viewer.java:9600)
        at org.jmol.viewer.FileManager.getUnzippedReaderOrStreamFromName(FileManager.java:693)
        at org.jmol.viewer.FileManager.getBufferedReaderOrErrorMessageFromName(FileManager.java:610)
        at org.jmol.viewer.FileManager.getFileDataAsString(FileManager.java:812)
        at org.jmol.script.ScriptEval.compileScriptFileInternal(ScriptEval.java:965)
        at org.jmol.script.ScriptEval.cmdScript(ScriptEval.java:6533)
        at org.jmol.script.ScriptEval.processCommand(ScriptEval.java:2456)
        at org.jmol.script.ScriptEval.commandLoop(ScriptEval.java:2264)
        at org.jmol.script.ScriptEval.dispatchCommands(ScriptEval.java:2127)
        at org.jmol.script.ScriptEval.executeCommands(ScriptEval.java:417)
        at org.jmol.script.ScriptEval.evaluateCompiledScript(ScriptEval.java:403)
        at org.jmol.script.ScriptManager.evalStringWaitStatusQueued(ScriptManager.java:362)
        at org.jmol.viewer.Viewer.evalStringWaitStatusQueued(Viewer.java:3921)
        at org.jmol.viewer.Viewer.evalWait(Viewer.java:3900)
        at org.jmol.viewer.Viewer.scriptWaitStatus(Viewer.java:3891)
        at org.openscience.jmol.app.JmolApp.runScript(JmolApp.java:578)
        at org.openscience.jmol.app.JmolApp.startViewer(JmolApp.java:528)
        at org.openscience.jmol.app.JmolData.<init>(JmolData.java:85)
        at org.openscience.jmol.app.JmolData.main(JmolData.java:77)
Caused by: java.lang.ClassNotFoundException: org.apache.tools.bzip2.CBZip2InputStream
        at java.base/jdk.internal.loader.BuiltinClassLoader.loadClass(Unknown Source)
        at java.base/jdk.internal.loader.ClassLoaders$AppClassLoader.loadClass(Unknown Source)
        at java.base/java.lang.ClassLoader.loadClass(Unknown Source)
        ... 22 more
script ERROR: java.lang.NoClassDefFoundError: org/apache/tools/bzip2/CBZip2InputStream
ImageEncoder width height 500 500
```


I'm starting to think perhaps jmol is just not well tested yet against the latest JRE and it's best to downgrade.  Let me see if I can't find a workaround though...


---

Comment by embray created at 2018-03-30 15:12:37

Okay, part of the problem just has to do with handing spaces in filenames, and is not related to the Java version or the Jmol version.  But the `NoClassDefFoundError` went away when I downgraded my Java _and_ downgraded Jmol to the previous version :(


---

Comment by saraedum created at 2018-04-01 09:07:11

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2018-04-01 09:07:11

I might have misunderstood the discussion on this ticket, but it seems that this needs work still?


---

Comment by charpent created at 2018-04-01 16:44:50

Definitely `needs_work` I tried it as suggested [here](https://groups.google.com/d/msg/sage-release/333nWF3BtIU/ZnyAcdgXBwAJ), and got a [broken jsmol](https://groups.google.com/d/msg/sage-release/333nWF3BtIU/6UD9YA4sBQAJ).


---

Comment by charpent created at 2018-04-01 17:23:05

Replying to [comment:14 charpent]:
> Definitely `neds_work` I tried it as suggested [here](https://groups.google.com/d/msg/sage-release/333nWF3BtIU/ZnyAcdgXBwAJ), and got a [broken jsmol](https://groups.google.com/d/msg/sage-release/333nWF3BtIU/6UD9YA4sBQAJ).

It's more complicated that that. I happen to follow Debian testing quite closely, and I have presently the following JVM/JDK combos available :

```
root@asus16-ec:~# update-java-alternatives --list
java-1.8.0-openjdk-amd64       1081       /usr/lib/jvm/java-1.8.0-openjdk-amd64
java-1.9.0-openjdk-amd64       1091       /usr/lib/jvm/java-1.9.0-openjdk-amd64
java-gcj-4.8                              /usr/lib/jvm/java-gcj-4.8
java-gcj-4.9                              /usr/lib/jvm/java-gcj-4.9
```


When I do `update-java-alternatives --set java-1.9.0-openjdk-amd64`, I get the reported problem (i. e. no suitable java...). When I switch to `update-java-alternatives --set java-1.9.0-openjdk-amd64` //during the very same Sage session//, java (and jmol) work(s).

Tentative conclusion : Java 9 is broken at least when packaged by Debian...


---

Comment by charpent created at 2018-04-01 18:18:53

Replying to [comment:15 charpent]:

> Tentative conclusion : Java 9 is broken at least when packaged by Debian...

One more data point in the same direction : the new jmol viewer (installed by the present ticket) works when one uses Java 8 (in my case, `java-1.8.0-openjdk-amd64`).

So I'll rephrase my tentative conclusion as "Java 9 is broken WRT our new jmol engine, at least when packaged by Debian".

I have reported this as Debian Bug [894570](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=894570).

It could be interesting to know if some user of the Debian Sage package has hit this bug when following testing.


---

Comment by embray created at 2018-04-03 10:05:58

I have a fix to the "no suitable Java" issue I just haven't pushed yet.  It doesn't work with JRE > 1.8 currently.  It's just a stupid version string check.

However, even with that fixed I'm having problems with Jmol working, like, at all (even with this newest version, or on older Javas).  That's just on Windows though, I haven't tested on other platforms yet...


---

Comment by egourgoulhon created at 2018-05-15 08:29:51

People using Ubuntu 18.04 seem to hit this bug: https://groups.google.com/forum/?fromgroups#!topic/sage-support/pwxKNlwg7CM


---

Comment by embray created at 2018-07-18 11:47:03

I believe this issue can reasonably be addressed for Sage 8.4.


---

Comment by embray created at 2018-12-28 14:10:15

Retargeting some of my tickets (somewhat optimistically for now).


---

Comment by slelievre created at 2019-01-14 10:28:06

Jmol 14.29.29 was released on 2018-11-30.

- https://sourceforge.net/projects/jmol/files/Jmol/


---

Comment by embray created at 2019-03-25 10:43:18

Moving all my in-progress tickets to 8.8 milestone.


---

Comment by embray created at 2019-06-14 14:50:27

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).


---

Comment by tmonteil created at 2019-09-18 14:07:25

Changing status from needs_work to needs_review.


---

Comment by tmonteil created at 2019-09-18 14:07:25

Let me set this to blocker because currently jmol is broken from Debian buster on, hence probably on recent Ubuntus as well.
----
New commits:


---

Comment by tmonteil created at 2019-09-18 14:07:25

Changing priority from major to blocker.


---

Comment by tmonteil created at 2019-09-18 14:12:52

Changing keywords from "" to "sdl".


---

Comment by charpent created at 2019-09-18 16:16:49

Ahem...

Downloaded the tarball in upstream, `make` worked like a charm, but :

```
sage: plot3d(lambda x,y:x^2+y^2, (-2,2), (-2, 2), opacity=0.5).show()
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-4-3105a34b9ca4> in <module>()
----> 1 plot3d(lambda x,y:x**Integer(2)+y**Integer(2), (-Integer(2),Integer(2)), (-Integer(2), Integer(2)), opacity=RealNumber('0.5')).show()

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/plot/plot3d/base.pyx in sage.plot.plot3d.base.Graphics3d.show (build/cythonized/sage/plot/plot3d/base.c:20365)()
   1494         from sage.repl.rich_output import get_display_manager
   1495         dm = get_display_manager()
-> 1496         dm.display_immediately(self, **kwds)
   1497 
   1498     def _save_image_png(self, filename, **kwds):

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py in display_immediately(self, obj, **rich_repr_kwds)
    836         """
    837         plain_text, rich_output = self._rich_output_formatter(obj, rich_repr_kwds)
--> 838         self._backend.display_immediately(plain_text, rich_output)
    839 
    840 

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/repl/rich_output/backend_ipython.py in display_immediately(self, plain_text, rich_output)
    302             Example plain text output
    303         """
--> 304         formatdata, metadata = self.displayhook(plain_text, rich_output)
    305         print(formatdata[u'text/plain'])
    306 

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/repl/rich_output/backend_ipython.py in displayhook(self, plain_text, rich_output)
    265             return ({u'text/plain': msg}, {})
    266         elif isinstance(rich_output, OutputSceneJmol):
--> 267             msg = self.launch_jmol(rich_output, plain_text.text.get_unicode())
    268             return ({u'text/plain': msg}, {})
    269         elif isinstance(rich_output, OutputSceneWavefront):

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/repl/rich_output/backend_ipython.py in launch_jmol(self, output_jmol, plain_text)
    368         jdata = JmolData()
    369         if not jdata.is_jvm_available() and not DOCTEST_MODE:
--> 370             raise RuntimeError('jmol cannot run, no suitable java version found')
    371         launch_script = output_jmol.launch_script_filename()
    372         jmol_cmd = 'jmol'

RuntimeError: jmol cannot run, no suitable java version found
sage: 
```


BTW, I may have hosed my Java installation. On Debian testing,; I have :

```
root@zen-book-flip:~# update-java-alternatives --list
java-1.10.0-openjdk-amd64      1101       /usr/lib/jvm/java-1.10.0-openjdk-amd64
java-1.11.0-openjdk-amd64      1111       /usr/lib/jvm/java-1.11.0-openjdk-amd64
root@zen-book-flip:~# 
root@zen-book-flip:~# update-java-alternatives --set java-1.11.0-openjdk-amd64
update-alternatives: erreur: pas d'alternatives pour mozilla-javaplugin.so
```



---

Comment by charpent created at 2019-09-18 19:02:02

(Attempt to) install the new jmol version.


---

Attachment

Replying to [comment:29 charpent]:

[ Snip... ]

> BTW, I may have hosed my Java installation. On Debian testing,; I have :
> {{{
> root`@`zen-book-flip:~# update-java-alternatives --list
> java-1.10.0-openjdk-amd64      1101       /usr/lib/jvm/java-1.10.0-openjdk-amd64
> java-1.11.0-openjdk-amd64      1111       /usr/lib/jvm/java-1.11.0-openjdk-amd64
> root`@`zen-book-flip:~# 
> root`@`zen-book-flip:~# update-java-alternatives --set java-1.11.0-openjdk-amd64
> update-alternatives: erreur: pas d'alternatives pour mozilla-javaplugin.so
> }}}

No other part of my system seems perturbed : LibreOffice , notoriously Java-greedy, works as advertized.

However, starting from my $SAGE_ROOT:


```

charpent@zen-book-flip:/usr/local/sage-P3-2$ sage -sh

Starting subshell with Sage environment variables set.  Don't forget
to exit when you are done.  Beware:
 * Do not do anything with other copies of Sage on your system.
 * Do not use this for installing Sage packages using "sage -i" or for
   running "make" at Sage's root directory.  These should be done
   outside the Sage shell.

Bypassing shell configuration files...

Note: SAGE_ROOT=/usr/local/sage-P3-2
(sage-sh) charpent@zen-book-flip:sage-P3-2$ /usr/local/sage-P3-2/local/bin/jmol/jmol
Jmol.jar not found in /usr/local/sage-P3-2/local/share/jmol
Error: Unable to access jarfile /usr/local/sage-P3-2/local/share/jmol/Jmol.jar
(sage-sh) charpent@zen-book-flip:sage-P3-2$ ls /usr/local/sage-P3-2/local/share/jmol/
appletweb  src
(sage-sh) charpent@zen-book-flip:sage-P3-2$ exit
exit
Exited Sage subshell.
charpent@zen-book-flip:/usr/local/sage-P3-2$ 
```


The installation procedure //may// miss something, it seems... I have uploaded the installation log (resulting from `sage -f jmol`).

==> `needs_work`.


---

Comment by charpent created at 2019-09-18 19:03:01

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-09-18 22:15:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2019-09-18 22:21:31

OK, i was too fast, here is a corrected `spkg-install` script.

Since you used the wrong `spkg-install`, you may have to do the following cleanup before retrying:


```
rm -rf /usr/local/sage-P3-2/local/bin/jmol
```


Replying to [comment:29 charpent]:
> RuntimeError: jmol cannot run, no suitable java version found

You should install the `default-jre` package.


---

Comment by tmonteil created at 2019-09-18 22:21:42

Changing status from needs_work to needs_review.


---

Comment by charpent created at 2019-09-18 22:51:19

Replying to [comment:32 tmonteil]:
> OK, i was too fast, here is a corrected `spkg-install` script.
> 
> Since you used the wrong `spkg-install`, you may have to do the following cleanup before retrying:
> 
> {{{
> rm -rf /usr/local/sage-P3-2/local/bin/jmol
> }}}

Been there, done that, didn't even hot the tee-shirt:

```
sage: implicit_plot3d(lambda x,y,z:x^2+y^2+z^2-1, (-1,1), (-1,1), (-1,1))
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-1-37831fbba399> in <module>()
----> 1 implicit_plot3d(lambda x,y,z:x**Integer(2)+y**Integer(2)+z**Integer(2)-Integer(1), (-Integer(1),Integer(1)), (-Integer(1),Integer(1)), (-Integer(1),Integer(1)))

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/IPython/core/displayhook.py in __call__(self, result)
    244             self.start_displayhook()
    245             self.write_output_prompt()
--> 246             format_dict, md_dict = self.compute_format_data(result)
    247             self.update_user_ns(result)
    248             self.fill_exec_result(result)

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/IPython/core/displayhook.py in compute_format_data(self, result)
    148 
    149         """
--> 150         return self.shell.display_formatter.format(result)
    151 
    152     # This can be set to True by the write_output_prompt method in a subclass

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/repl/display/formatter.py in format(self, obj, include, exclude)
    198         """
    199         # First, use Sage rich output if there is any
--> 200         sage_format, sage_metadata = self.dm.displayhook(obj)
    201         assert PLAIN_TEXT in sage_format, 'plain text is always present'
    202         if not set(sage_format.keys()).issubset(self.default_mime()):

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/repl/rich_output/display_manager.py in displayhook(self, obj)
    810         self._backend.set_underscore_variable(obj)
    811         plain_text, rich_output = self._rich_output_formatter(obj, dict())
--> 812         return self._backend.displayhook(plain_text, rich_output)
    813 
    814     def display_immediately(self, obj, **rich_repr_kwds):

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/repl/rich_output/backend_ipython.py in displayhook(self, plain_text, rich_output)
    265             return ({u'text/plain': msg}, {})
    266         elif isinstance(rich_output, OutputSceneJmol):
--> 267             msg = self.launch_jmol(rich_output, plain_text.text.get_unicode())
    268             return ({u'text/plain': msg}, {})
    269         elif isinstance(rich_output, OutputSceneWavefront):

/usr/local/sage-P3-2/local/lib/python3.7/site-packages/sage/repl/rich_output/backend_ipython.py in launch_jmol(self, output_jmol, plain_text)
    368         jdata = JmolData()
    369         if not jdata.is_jvm_available() and not DOCTEST_MODE:
--> 370             raise RuntimeError('jmol cannot run, no suitable java version found')
    371         launch_script = output_jmol.launch_script_filename()
    372         jmol_cmd = 'jmol'

RuntimeError: jmol cannot run, no suitable java version found
```


**However**, `jmol` can be successfully invoked from the sage shell (but not from the system prompt, which is normal, as far as I understand this):


```
charpent@zen-book-flip:/usr/local/sage-P3-2$ local/bin/jmol 
Jmol.jar not found in /jmol
Error: Unable to access jarfile /jmol/Jmol.jar
charpent@zen-book-flip:/usr/local/sage-P3-2$ sage -sh

Starting subshell with Sage environment variables set.  Don't forget
to exit when you are done.  Beware:
 * Do not do anything with other copies of Sage on your system.
 * Do not use this for installing Sage packages using "sage -i" or for
   running "make" at Sage's root directory.  These should be done
   outside the Sage shell.

Bypassing shell configuration files...

Note: SAGE_ROOT=/usr/local/sage-P3-2
(sage-sh) charpent@zen-book-flip:sage-P3-2$ local/bin/jmol 
426 translations loaded
548 translations loaded
splash_image=jar:file:/usr/local/sage-P3-2/local/share/jmol/Jmol.jar!/org/openscience/jmol/app/images/Jmol_splash.jpg
history file is /home/charpent/.jmol/history
user properties file is /home/charpent/.jmol/properties
(C) 2015 Jmol Development
Jmol Version: 14.29.52  2019-08-18 15:32
java.vendor: Java: Debian
java.version: Java 11.0.5-ea
os.name: Linux
Access: ALL
memory: 17.3/262.1
processors available: 8
useCommandThread: false
User macros dir: /home/charpent/.jmol/macros
       exists: false
  isDirectory: false

## NOTE : a jmol window opened (solid black content, but menus, icons, etc... present).

(sage-sh) charpent@zen-book-flip:sage-P3-2$ exit
exit
Exited Sage subshell.
charpent@zen-book-flip:/usr/local/sage-P3-2$ local/bin/jmol 
Jmol.jar not found in /jmol
Error: Unable to access jarfile /jmol/Jmol.jar
charpent@zen-book-flip:/usr/local/sage-P3-2$ 
```


Back to the old drawing board, I guess...

==> `needs_work`


> Replying to [comment:29 charpent]:
> > RuntimeError: jmol cannot run, no suitable java version found
> 
> You should install the `default-jre` package.

Was present from the start (as well as `default-jdk`, BTW). Again,LibreOffice finds both java 10 and java 11 in their normal Debian-designated directories...


---

Comment by tmonteil created at 2019-09-18 23:09:26

OK, maybe there is a Python 3 thing going on, i am using Python 2, let me recompile everything for Python 3 so that i can reproduce your error.

Regarding `local/bin/jmol` not working from a standard shell, it is normal since the script relies on variables such as `SAGE_SHARE` that are not defined.

Are you saying that, when `local/bin/jmol` is run from the Sage shell (`sage -sh`), you do not see  the menu ?


---

Comment by charpent created at 2019-09-19 05:19:24

Replying to [comment:35 tmonteil]:
> OK, maybe there is a Python 3 thing going on, i am using Python 2, let me recompile everything for Python 3 so that i can reproduce your error.
> 
> Regarding `local/bin/jmol` not working from a standard shell, it is normal since the script relies on variables such as `SAGE_SHARE` that are not defined.
>

We agreee

> Are you saying that, when `local/bin/jmol` is run from the Sage shell (`sage -sh`), you do not see  the menu ?

I DO se the menu and icons.The only unexpected thing is the black image...


---

Comment by tmonteil created at 2019-09-19 09:03:05

Replying to [comment:35 tmonteil]:
> OK, maybe there is a Python 3 thing going on, i am using Python 2, let me recompile everything for Python 3 so that i can reproduce your error.

Works well on Python 3 as well, so i can not reproduce your issue.

Could you try to bypass the `is_jvm_available()` test and see if you get something ?

Could you tell more about your configuration so that i try to simulate it in a VM ?

Could someone else test the branch as well ?


---

Comment by charpent created at 2019-09-19 09:27:47

Replying to [comment:37 tmonteil]:
> Replying to [comment:35 tmonteil]:
> > OK, maybe there is a Python 3 thing going on, i am using Python 2, let me recompile everything for Python 3 so that i can reproduce your error.
> 
> Works well on Python 3 as well, so i can not reproduce your issue.
> 
> Could you try to bypass the `is_jvm_available()` test and see if you get something ?

I do get a `jmol` display behaving as expected.

> Could you tell more about your configuration so that i try to simulate it in a VM ?

What do you want to know ? (I'm notoriously bad at tea leaves reading, and I'm still running //H. sapiens sapiens L.// v1.0, without mind-reading interface nor divinatory coprocessor...).

> Could someone else test the branch as well ?

That is a necessity ! Given past history, I'd recommend a test on as many Macintoshes as possible... and on `embray`'s port to Cygwin.


---

Comment by tmonteil created at 2019-09-19 09:39:14

Replying to [comment:39 charpent]:
> Replying to [comment:37 tmonteil]:
> > Replying to [comment:35 tmonteil]:
> > > OK, maybe there is a Python 3 thing going on, i am using Python 2, let me recompile everything for Python 3 so that i can reproduce your error.
> > 
> > Works well on Python 3 as well, so i can not reproduce your issue.
> > 
> > Could you try to bypass the `is_jvm_available()` test and see if you get something ?
> 
> I do get a `jmol` display behaving as expected.

OK, great, so the issue is very narrowed now.

What is the output of 


```
java -version
```


in a terminal ?

> > Could you tell more about your configuration so that i try to simulate it in a VM ?
> 
> What do you want to know ? (I'm notoriously bad at tea leaves reading, and I'm still running //H. sapiens sapiens L.// v1.0, without mind-reading interface nor divinatory coprocessor...).

I was thinking on which distro/release/arch, java packages, and options passed to compile Sage, but given the previous answer, i think we do not need that anymore.

> > Could someone else test the branch as well ?
> 
> That is a necessity ! Given past history, I'd recommend a test on as many Macintoshes as possible... and on `embray`'s port to Cygwin.


---

Comment by charpent created at 2019-09-19 09:58:34

Replying to [comment:40 tmonteil]:

[ Snip... ]

> What is the output of 
> 
> {{{
> java -version
> }}}


```
charpent@zen-book-flip:/usr/local/sage-P3-2$ java -version
openjdk version "11.0.5-ea" 2019-10-15
OpenJDK Runtime Environment (build 11.0.5-ea+6-post-Debian-2)
OpenJDK 64-Bit Server VM (build 11.0.5-ea+6-post-Debian-2, mixed mode, sharing)
```



> in a terminal ?
> 
> > > Could you tell more about your configuration so that i try to simulate it in a VM ?
> > 
> > What do you want to know ? (I'm notoriously bad at tea leaves reading, and I'm still running //H. sapiens sapiens L.// v1.0, without mind-reading interface nor divinatory coprocessor...).
> 
> I was thinking on which distro/release/arch, java packages, and options passed to compile Sage, but given the previous answer, i think we do not need that anymore.

Debian testing (religiously updated) ; java packages:


```
charpent@zen-book-flip:/usr/local/sage-P3-2$ dpkg -l "*openjdk*" | grep ii
ii  openjdk-10-jdk:amd64          10.0.2+13-2  amd64        OpenJDK Development Kit (JDK)
ii  openjdk-10-jdk-headless:amd64 10.0.2+13-2  amd64        OpenJDK Development Kit (JDK) (headless)
ii  openjdk-10-jre:amd64          10.0.2+13-2  amd64        OpenJDK Java runtime, using Hotspot JIT
ii  openjdk-10-jre-headless:amd64 10.0.2+13-2  amd64        OpenJDK Java runtime, using Hotspot JIT (headless)
ii  openjdk-11-jdk:amd64          11.0.5+6-2   amd64        OpenJDK Development Kit (JDK)
ii  openjdk-11-jdk-headless:amd64 11.0.5+6-2   amd64        OpenJDK Development Kit (JDK) (headless)
ii  openjdk-11-jre:amd64          11.0.5+6-2   amd64        OpenJDK Java runtime, using Hotspot JIT
ii  openjdk-11-jre-headless:amd64 11.0.5+6-2   amd64        OpenJDK Java runtime, using Hotspot JIT (headless)
```


Sage's compilation by `make`, after `configur`ing for Python 3 (once). A couple releases ago, I started to report the results I get from `ptestalllong` in [sage-release](https://groups.google.com/forum/#!forum/sage-release).

[ Snip again... ]


---

Comment by dimpase created at 2019-09-19 10:04:30

jmol (or perhaps java in general?) is pathetically ill-designed to deal with it being launched in a slightly non-standard windowing enviroment (here it's xmonad on Gentoo). It just won't go away and die after doing `Help/About Jmol` in its menu.

Also, the mouse pointer is off by a position while using jmol's menu, it does not point to the item one wants to click, but much lower, around the next item (I guess it depends on screen resolution etc)  

```
$ java -version
openjdk version "1.8.0_222"
OpenJDK Runtime Environment (IcedTea 3.13.0) (Gentoo icedtea-3.13.0)
OpenJDK 64-Bit Server VM (build 25.222-b10, mixed mode)
```



---

Comment by dimpase created at 2019-09-19 12:02:34

this appears to work on my Gentoo box. I'll test more on OSX and some other Linux...


---

Comment by tmonteil created at 2019-09-19 13:54:14

Replying to [comment:41 charpent]:
> Replying to [comment:40 tmonteil]:
> 
> [ Snip... ]
> 
> > What is the output of 
> > 
> > {{{
> > java -version
> > }}}
> 
> {{{
> charpent`@`zen-book-flip:/usr/local/sage-P3-2$ java -version
> openjdk version "11.0.5-ea" 2019-10-15
> OpenJDK Runtime Environment (build 11.0.5-ea+6-post-Debian-2)
> OpenJDK 64-Bit Server VM (build 11.0.5-ea+6-post-Debian-2, mixed mode, sharing)
> }}}

Very weird, it should be accepted by the test. Within a Sage command-line, what is the output of:


```
sage: from sage.cpython.string import bytes_to_str
sage: import subprocess, re
sage: version = bytes_to_str(subprocess.check_output(['java', '-version'], stderr=subprocess.STDOUT))
sage: version
```


Followed by:


```
sage: java_version = re.search(r'version.*([1][.][789]|"[\d.]+")', version)
sage: bool(java_version)
```


Replying to [comment:43 dimpase]:
> this appears to work on my Gentoo box. I'll test more on OSX and some other Linux...

Great.


---

Comment by tmonteil created at 2019-09-19 13:55:45

Replying to [comment:42 dimpase]:
> jmol (or perhaps java in general?) is pathetically ill-designed to deal with it being launched in a slightly non-standard windowing enviroment (here it's xmonad on Gentoo). It just won't go away and die after doing `Help/About Jmol` in its menu.
> 
> Also, the mouse pointer is off by a position while using jmol's menu, it does not point to the item one wants to click, but much lower, around the next item (I guess it depends on screen resolution etc)  

OK, is the situation worse than before ?


---

Comment by dimpase created at 2019-09-19 14:32:39

Replying to [comment:45 tmonteil]:
> Replying to [comment:42 dimpase]:
> > jmol (or perhaps java in general?) is pathetically ill-designed to deal with it being launched in a slightly non-standard windowing enviroment (here it's xmonad on Gentoo). It just won't go away and die after doing `Help/About Jmol` in its menu.
> > 
> > Also, the mouse pointer is off by a position while using jmol's menu, it does not point to the item one wants to click, but much lower, around the next item (I guess it depends on screen resolution etc)  
> 
> OK, is the situation worse than before ?

not really, sorry for noise. So far no reason not go forward withg this.


---

Comment by charpent created at 2019-09-19 16:58:15

Sorry for the delay : I ha to run my `useful_work_emulator` in a couple of meetings...

Replying to [comment:44 tmonteil]:
> Replying to [comment:41 charpent]:
> > Replying to [comment:40 tmonteil]:
> > 
> > [ Snip... ]
> > 
> > > What is the output of 
> > > 
> > > {{{
> > > java -version
> > > }}}
> > 
> > {{{
> > charpent`@`zen-book-flip:/usr/local/sage-P3-2$ java -version
> > openjdk version "11.0.5-ea" 2019-10-15
> > OpenJDK Runtime Environment (build 11.0.5-ea+6-post-Debian-2)
> > OpenJDK 64-Bit Server VM (build 11.0.5-ea+6-post-Debian-2, mixed mode, sharing)
> > }}}
> 
> Very weird, it should be accepted by the test. Within a Sage command-line, what is the output of:
> 
> {{{
> sage: from sage.cpython.string import bytes_to_str
> sage: import subprocess, re
> sage: version = bytes_to_str(subprocess.check_output(['java', '-version'], stderr=subprocess.STDOUT))
> sage: version
> }}}
> 
> Followed by:
> 
> {{{
> sage: java_version = re.search(r'version.*([1][.][789]|"[\d.]+")', version)
> sage: bool(java_version)
> }}}


```
sage: sage: from sage.cpython.string import bytes_to_str
....: sage: import subprocess, re
....: sage: version = bytes_to_str(subprocess.check_output(['java', '-version'],
....:  stderr=subprocess.STDOUT))
....: sage: version
....: 
'openjdk version "11.0.5-ea" 2019-10-15\nOpenJDK Runtime Environment (build 11.0.5-ea+6-post-Debian-2)\nOpenJDK 64-Bit Server VM (build 11.0.5-ea+6-post-Debian-2, mixed mode, sharing)\n'
sage: sage: java_version = re.search(r'version.*([1][.][789]|"[\d.]+")', version
....: )
....: sage: bool(java_version)
....: 
False
```


> Replying to [comment:43 dimpase]:
> > this appears to work on my Gentoo box. I'll test more on OSX and some other Linux...
> 
> Great.


---

Comment by tmonteil created at 2019-09-19 22:31:11

OK, the `-ea` is parasiting the check for a version number. Actually, the current code just checks that the version number looks like numbers and dots, but it does not really check for any given interval of versions. Let us fix that.


---

Comment by git created at 2019-09-19 22:43:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2019-09-19 22:44:16

Needs review.


---

Comment by charpent created at 2019-09-20 06:27:21

Replying to [comment:50 tmonteil]:
> Needs review.

Seems to work:
* reverted the test short-circuit
* fetched your last branch
* quick test (displaying a sphere and a cone) ==> works.

`ptestlong` underway...


---

Comment by jipilab created at 2019-09-20 07:36:34

Replying to [comment:50 tmonteil]:
> Needs review.

 - Fetched the current branch
 - Downloaded tarball
 - `sage -f jmol`
 - Drew successfully a polyhedron with jmol (my original problem)

Works on debian buster with openjdk version "11.0.4" and Sage8.9rc0 with python3.

Any things else I should test?


---

Comment by charpent created at 2019-09-20 07:58:10

Changing status from needs_review to positive_review.


---

Comment by charpent created at 2019-09-20 07:58:10

Okay. `ptestlong` doesn't show anything not already reported.

==> `positive_review`. But this should be confirmed on other platforms.


---

Comment by egourgoulhon created at 2019-09-20 09:03:32

Works on Ubuntu 18.04 (openjdk 11.0.4) with Python 3 Sage. So +1 for the positive review. 
Thank you Thierry!


---

Comment by dimpase created at 2019-09-20 15:53:58

on my museum MacBookAir from 2010 running OSX 10.13.6, with

```
$ java -version
java version "1.8.0_191"
Java(TM) SE Runtime Environment (build 1.8.0_191-b12)
Java HotSpot(TM) 64-Bit Server VM (build 25.191-b12, mixed mode)
```

I am getting

```
sage: sphere(viewer="jmol")
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-1-bd168a4fee36> in <module>()
----> 1 sphere(viewer="jmol")

/Volumes/MacHD/home/sagetrac-mirror/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in __call__(self, result)
    244             self.start_displayhook()
    245             self.write_output_prompt()
--> 246             format_dict, md_dict = self.compute_format_data(result)
    247             self.update_user_ns(result)
    248             self.fill_exec_result(result)

/Volumes/MacHD/home/sagetrac-mirror/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in compute_format_data(self, result)
    148 
    149         """
--> 150         return self.shell.display_formatter.format(result)
    151 
    152     # This can be set to True by the write_output_prompt method in a subclass

/Volumes/MacHD/home/sagetrac-mirror/local/lib/python2.7/site-packages/sage/repl/display/formatter.pyc in format(self, obj, include, exclude)
    198         """
    199         # First, use Sage rich output if there is any
--> 200         sage_format, sage_metadata = self.dm.displayhook(obj)
    201         assert PLAIN_TEXT in sage_format, 'plain text is always present'
    202         if not set(sage_format.keys()).issubset(self.default_mime()):

/Volumes/MacHD/home/sagetrac-mirror/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.pyc in displayhook(self, obj)
    810         self._backend.set_underscore_variable(obj)
    811         plain_text, rich_output = self._rich_output_formatter(obj, dict())
--> 812         return self._backend.displayhook(plain_text, rich_output)
    813 
    814     def display_immediately(self, obj, **rich_repr_kwds):

/Volumes/MacHD/home/sagetrac-mirror/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_ipython.pyc in displayhook(self, plain_text, rich_output)
    265             return ({u'text/plain': msg}, {})
    266         elif isinstance(rich_output, OutputSceneJmol):
--> 267             msg = self.launch_jmol(rich_output, plain_text.text.get_unicode())
    268             return ({u'text/plain': msg}, {})
    269         elif isinstance(rich_output, OutputSceneWavefront):

/Volumes/MacHD/home/sagetrac-mirror/local/lib/python2.7/site-packages/sage/repl/rich_output/backend_ipython.pyc in launch_jmol(self, output_jmol, plain_text)
    368         jdata = JmolData()
    369         if not jdata.is_jvm_available() and not DOCTEST_MODE:
--> 370             raise RuntimeError('jmol cannot run, no suitable java version found')
    371         launch_script = output_jmol.launch_script_filename()
    372         jmol_cmd = 'jmol'

RuntimeError: jmol cannot run, no suitable java version found
```



---

Comment by dimpase created at 2019-09-20 15:54:25

Changing status from positive_review to needs_work.


---

Comment by jhpalmieri created at 2019-09-20 16:04:54

I get the same thing on OS X 10.14.6. From bash:

```
$ java -version
java version "1.8.0_31"
Java(TM) SE Runtime Environment (build 1.8.0_31-b13)
Java HotSpot(TM) 64-Bit Server VM (build 25.31-b07, mixed mode)
```

The reference manual looks fine, though.


---

Comment by git created at 2019-09-20 18:31:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2019-09-20 18:33:16

Changing status from needs_work to needs_review.


---

Comment by tmonteil created at 2019-09-20 18:33:16

OK, the major version `X` we want to extract either appears as `X.blah` or as `1.X.blah`.

I wonder whether cygwin's java ships yet another version format.


---

Comment by jhpalmieri created at 2019-09-20 18:57:29

That works for me.


---

Comment by dimpase created at 2019-09-20 19:27:41

I think it's a bit hopless to merely chase numbers. E.g. IBM's java implementation OpenJ9 has versions of the form 0.X.Y, see https://github.com/eclipse/openj9/releases

Can one instead test a feature?


---

Comment by tmonteil created at 2019-09-20 21:21:40

Replying to [comment:61 dimpase]:
> I think it's a bit hopless to merely chase numbers. E.g. IBM's java implementation OpenJ9 has versions of the form 0.X.Y, see https://github.com/eclipse/openj9/releases

While we are at it, it is not a hard task to add the 0.X.Y form.

> Can one instead test a feature?

If you know which one, why not.

The benefit of having a (working) version-based test, is that we can also fix some upper bound (the previous version of jmol was not working for java > 8).


---

Comment by jhpalmieri created at 2019-09-20 21:37:18

The existing `src/sage/interfaces/jmoldata.py` checks for version numbers, so testing for a feature could go on another ticket: I don't think it should hold up this one.


---

Comment by git created at 2019-09-20 22:47:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2019-09-20 22:53:15

Replying to [comment:63 jhpalmieri]:
> The existing `src/sage/interfaces/jmoldata.py` checks for version numbers, so testing for a feature could go on another ticket: I don't think it should hold up this one.

Agreed, especially since jmol is currently broken on many distros.


---

Comment by dimpase created at 2019-09-21 09:26:20

Replying to [comment:63 jhpalmieri]:
> The existing `src/sage/interfaces/jmoldata.py` checks for version numbers, so testing for a feature could go on another ticket: I don't think it should hold up this one.

Right. In fact I - clueless about java - misunderstood the meaning of the `version` part of the output of
`java -version` - it's not really implementation-dependent, it's apparently indicating 
`java.version` (a "system property" of the JVM). There are two possible formats for `java.version`:

Java 8 or lower: 1.X.A_B, 1.X.Y  (X<9)

Java 9 or higher: X.Y.Z (X>8)

I could not find anywhere any stipulaton of what `java -version` should print, but
it appears very plausable that every implementation puts `java.version` there.

One certainly can write a bit of Java code to test `java.version`, this would be a fool-proof way. So a future ticket can just do this.


---

Comment by dimpase created at 2019-09-21 11:06:28

OK, this works now on OSX 10.13, as well.


---

Comment by dimpase created at 2019-09-21 11:06:28

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-09-24 22:15:48

Resolution: fixed
