# Issue 10698: Numerical approximation of an algebraic number raises a ValueError

Issue created by migration from https://trac.sagemath.org/ticket/10761

Original creator: slabbe

Original creation time: 2011-02-09 17:11:05

Assignee: tbd

Numerical approximation works for complex numbers:


```
sage: n(1 + I)
1.00000000000000 + 1.00000000000000*I
sage: (1 + I).n()
1.00000000000000 + 1.00000000000000*I
```


but not for algebraic numbers:


```
sage: m = matrix(3, [3,1,6,5,2,9,7,3,13])
sage: E = m.eigenvalues()
sage: E
[18.16815365088822?, -0.08407682544410650? - 0.2190261484802906?*I, -0.08407682544410650? + 0.2190261484802906?*I]
sage: map(type, E)
[<class 'sage.rings.qqbar.AlgebraicNumber'>, <class 'sage.rings.qqbar.AlgebraicNumber'>, <class 'sage.rings.qqbar.AlgebraicNumber'>]
sage: map(n, E)
Traceback (most recent call last):
...
ValueError: Cannot coerce algebraic number with non-zero imaginary part to algebraic real
```




---

Comment by spice created at 2011-03-23 21:31:01

The patch provides a short and sweet fix to the above problem. The issue arises in sage/misc/functional.py's numerical_approx() function:

```
if not (is_ComplexNumber(x) or is_ComplexDoubleElement(x)):
            try:
                return sage.rings.real_mpfr.RealField(prec)(x)                                                                              
            except TypeError:
                pass
        return sage.rings.complex_field.ComplexField(prec)(x)
```

Attempting to call RealField() on a complex AlgebraicNumber raises a ValueError and not a TypeError, so the exception is not caught. Changing the except clause to catch all errors fixes this:

```
if not (is_ComplexNumber(x) or is_ComplexDoubleElement(x)):
            try:
                return sage.rings.real_mpfr.RealField(prec)(x)
            # Trac 10761: now catches all errors (instead of just                                                 
            # a TypeError), since calling RealField on AlgebraicNumbers                                           
            # can raise a ValueError                                                                              
            except:
                pass
        return sage.rings.complex_field.ComplexField(prec)(x)
```



---

Comment by spice created at 2011-03-23 21:31:01

Changing component from PLEASE CHANGE to numerical.


---

Comment by spice created at 2011-03-23 21:31:01

Changing status from new to needs_review.


---

Comment by spice created at 2011-03-23 21:31:01

Changing keywords from "" to "numerical_approx, AlgebraicNumber".


---

Comment by rbeezer created at 2011-03-24 17:44:45

Hi Simon,

This will be _very_ useful, thanks for digging it up.  Three comments:

1.  `type(E[1])` would be more accurate (and readable) as `E[1].parent()`, more Sage-like.

2. I write lots of "naked" except clauses, which I think is a bad practice.  Is this a place where could just add `", Value Error"` after the `TypeError`?

3.  Style Points:  I think three lines of source comments for this fix is more than you would normally see.  With the Trac number in the docstring, and a patch on Trac, you don't need to say so much.  With one line here, it'd warn anybody away from messing with it.

Passes all long tests right now.

Rob


---

Comment by spice created at 2011-03-24 19:20:41

Hi Rob

On the issues you've raised:

1) `type(E[1])` changed to `E[1].parent()` in the example as per your suggestion.

2) Regarding the naked except clause, I tried to add a catch of `ValueError`, but the function was still breaking. I wasn't able to figure out why, which is why I defaulted to catching everything. I figured this was okay, though, since this was just one part of a multistep coercion attempt - and thus errors are to be expected. Thoughts?

3) Inline comment streamlined to a single line.

Simon


---

Comment by rbeezer created at 2011-03-24 20:17:59

Simon,

Looks real good.  If the precise error list does not do the trick, then I think leaving it empty is fine.

Applies and builds, passes tests, docs build and look good.  Positive review.

Rob


---

Comment by rbeezer created at 2011-03-24 20:17:59

Changing status from needs_review to positive_review.


---

Comment by kini created at 2011-03-24 23:27:49

This works for me...


```diff
diff -r 361a4ad7d52c -r 87dedc409966 sage/misc/functional.py
--- a/sage/misc/functional.py	Fri Feb 25 18:56:01 2011 +0000
+++ b/sage/misc/functional.py	Wed Mar 23 14:18:58 2011 -0700
@@ -1260,7 +1270,7 @@
         if not (is_ComplexNumber(x) or is_ComplexDoubleElement(x)):
             try:
                 return sage.rings.real_mpfr.RealField(prec)(x)
-            except TypeError:
+            except (TypeError, ValueError):
                 pass
         return sage.rings.complex_field.ComplexField(prec)(x)
```


I think it would be cleaner than just catching all exceptions. Simon, what exactly was wrong with catching ValueErrors?


---

Comment by slabbe created at 2011-03-24 23:35:51

> Simon, what exactly was wrong with catching ValueErrors?? 

I was going to ask the same, but kini beated me.

I also was going to suggest this if the tuple didn't work :


```
except TypeError:
    pass
except ValueError:
    pass
```


but I think what kini proposes is best. No?


---

Comment by kini created at 2011-03-24 23:48:07

Did you do something like this?

```python
except TypeError, ValueError:
```

This will attempt to catch TypeError exceptions and assign them to the variable name ValueError. It's [a deprecated behavior](http://trac.sagemath.org/sage_trac/ticket/10761#SECTION0010300000000000000000) from old versions of Python.


---

Comment by spice created at 2011-03-24 23:54:46

Replaces existing patch.


---

Attachment

Ah. n00b error - I forgot to add parentheses. It works now.

Simon


---

Comment by spice created at 2011-03-24 23:56:51

Changing status from positive_review to needs_work.


---

Comment by spice created at 2011-03-24 23:57:02

Changing status from needs_work to needs_review.


---

Comment by kini created at 2011-03-25 00:14:43

Er, sorry, I of course meant to link to [this page](http://docs.python.org/release/2.5.4/tut/node10.html#SECTION0010300000000000000000). Patch looks good.


---

Comment by kini created at 2011-03-25 00:14:43

Changing status from needs_review to positive_review.


---

Comment by slabbe created at 2011-03-25 09:32:09

Thank you Simon for the fix !

SÃ©bastien


---

Comment by jdemeyer created at 2011-04-13 07:43:16

Resolution: fixed
