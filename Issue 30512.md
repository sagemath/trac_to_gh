# Issue 30512: Characteristic polynomial of central Hyperplane arrangement results wrong result?

Issue created by migration from https://trac.sagemath.org/ticket/30749

Original creator: jipilab

Original creation time: 2020-10-09 09:43:06

CC:  @kliem @laisrast nailuj

Keywords: hyperplane arrangements, regions

A central hyperplane arrangement must have an even number of regions by central symmetry... yet the one below gets 31 regions(!).


```
sage: R.<y> = QQ[]
....: v1 = AA.polynomial_root(AA.common_polynomial(y^2 - 3), RIF(RR(1.7320508075
....: 688772), RR(1.7320508075688774)))
....: v2 = QQbar.polynomial_root(AA.common_polynomial(y^4 - y^2 + 1), CIF(RIF(RR
....: (0.8660254037844386), RR(0.86602540378443871)), RIF(-RR(0.5000000000000001
....: 1), -RR(0.49999999999999994))))
....: my_vectors = (vector(AA, [-v1, -1, 1]), vector(AA, [0, 2, 1]), vector(AA, 
....: [v1, -1, 1]), vector(AA, [1, 0, 0]), vector(AA, [1/2, AA(-1/2*v2^3 + v2), 
....: 0]), vector(AA, [-1/2, AA(-1/2*v2^3 + v2), 0]))
....: 
sage: H = HyperplaneArrangements(AA,names='xyz')
sage: x,y,z = H.gens()
sage: A = H(backend="normaliz")
sage: for v in my_vectors:
....:     a,b,c = v
....:     A = A.add_hyperplane(a*x + b*y + c*z)
....:     
sage: A
Arrangement of 6 hyperplanes of dimension 3 and rank 3
sage: A.n_regions()
31
sage: A.is_central()
True
```



---

Comment by chapoton created at 2020-10-09 11:01:43

The char poly gives the same answer

```
sage: p = A.characteristic_polynomial() : p
x^3 - 6*x^2 + 13*x - 11
sage: p(-1)                                                                     
-31
```



---

Comment by jipilab created at 2020-10-09 14:14:16

Replying to [comment:2 chapoton]:
> The char poly gives the same answer
> {{{
> sage: p = A.characteristic_polynomial() : p
> x^3 - 6*x^2 + 13*x - 11
> sage: p(-1)                                                                     
> -31
> }}}

Yes, this is how the number of regions is computed up to sign. The hyperplane arrangement seems to be sane: computing `.regions()` computes the expected (number of) regions.

I asked the number of regions to double-check something and then got this scary answer...


---

Comment by nailuj created at 2020-10-09 14:26:06

I encountered this problem in some example a long while ago, before I was contributing to Sage myself. A simple workaround is to have `n_regions` output `len(self.regions())`, which was good enough for me. Of course, this is much slower if one doesn’t want to compute the regions anyway. I don’t understand the characteristic polynomial well enough to figure out the error in there.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by nailuj created at 2022-03-16 17:26:22

Replying to [comment:5 nailuj]:
> I don’t understand the characteristic polynomial well enough to figure out the error in there.

The characteristic polynomial is obtained through recursive deletions and contractions of hyperplane arrangements. During this process, it may occur that some hyperplane `h` is included in an arrangement multiple times with different scalings of the defining linear expression which are not properly detected as duplicates. This is due to a defect in the method `hyperplane.primitive()` addressed in #30078.


---

Comment by mkoeppe created at 2022-04-03 18:48:46

Is this defect solved by #30078?


---

Comment by tscrim created at 2022-04-04 01:08:37

It seems like it is. Using the first example, I get

```
sage: A.n_regions()
24
sage: len(A.regions())
24
sage: A.characteristic_polynomial()(-1)
-24
```

So it is now consistent. We probably just want to add a doctest for this ticket.


---

Comment by @kliem created at 2022-04-05 12:40:36

Changing status from new to needs_review.


---

Comment by @kliem created at 2022-04-05 12:40:36

#30078 already adds one doctest. So we can either close it as duplicate or add another doctest. Either way is fine with me.
----
New commits:


---

Comment by @sheerluck created at 2022-04-05 14:59:47


```diff
--- a/sage/geometry/hyperplane_arrangement/arrangement.py
+++ b/sage/geometry/hyperplane_arrangement/arrangement.py
@@ -1179,10 +1179,10 @@
             sage: H = HyperplaneArrangements(AA, names='xyz')
             sage: x,y,z = H.gens()
             sage: A = H(backend="normaliz")  # optional - pynormaliz
-            sage: for v in my_vector:        # optional - pyrormaliz
+            sage: for v in my_vectors:       # optional - pynormaliz
             ....:     a, b, c = v
             ....:     A = A.add_hyperplane(a*x + b*y + c*z)
-            sage: A.n_regions()              # optional - pyrormaliz
+            sage: A.n_regions()              # optional - pynormaliz
             32
         """
         if self.base_ring().characteristic() != 0:
```



---

Comment by git created at 2022-04-05 15:33:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-04-06 00:51:57

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2022-04-06 00:51:57

Thank you. LGTM.

`@`gh-sheerluck, please add your (real) name to the reviewers (if you want).


---

Comment by vbraun created at 2022-04-10 13:12:46

Resolution: fixed
