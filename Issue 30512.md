# Issue 30512: Characteristic polynomial of central Hyperplane arrangement results wrong result?

archive/issues_030512.json:
```json
{
    "body": "CC:  @kliem @laisrast nailuj\n\nKeywords: hyperplane arrangements, regions\n\nA central hyperplane arrangement must have an even number of regions by central symmetry... yet the one below gets 31 regions(!).\n\n\n```\nsage: R.<y> = QQ[]\n....: v1 = AA.polynomial_root(AA.common_polynomial(y^2 - 3), RIF(RR(1.7320508075\n....: 688772), RR(1.7320508075688774)))\n....: v2 = QQbar.polynomial_root(AA.common_polynomial(y^4 - y^2 + 1), CIF(RIF(RR\n....: (0.8660254037844386), RR(0.86602540378443871)), RIF(-RR(0.5000000000000001\n....: 1), -RR(0.49999999999999994))))\n....: my_vectors = (vector(AA, [-v1, -1, 1]), vector(AA, [0, 2, 1]), vector(AA, \n....: [v1, -1, 1]), vector(AA, [1, 0, 0]), vector(AA, [1/2, AA(-1/2*v2^3 + v2), \n....: 0]), vector(AA, [-1/2, AA(-1/2*v2^3 + v2), 0]))\n....: \nsage: H = HyperplaneArrangements(AA,names='xyz')\nsage: x,y,z = H.gens()\nsage: A = H(backend=\"normaliz\")\nsage: for v in my_vectors:\n....:     a,b,c = v\n....:     A = A.add_hyperplane(a*x + b*y + c*z)\n....:     \nsage: A\nArrangement of 6 hyperplanes of dimension 3 and rank 3\nsage: A.n_regions()\n31\nsage: A.is_central()\nTrue\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/30749\n\n",
    "created_at": "2020-10-09T09:43:06Z",
    "labels": [
        "geometry",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Characteristic polynomial of central Hyperplane arrangement results wrong result?",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30512",
    "user": "@jplab"
}
```
CC:  @kliem @laisrast nailuj

Keywords: hyperplane arrangements, regions

A central hyperplane arrangement must have an even number of regions by central symmetry... yet the one below gets 31 regions(!).


```
sage: R.<y> = QQ[]
....: v1 = AA.polynomial_root(AA.common_polynomial(y^2 - 3), RIF(RR(1.7320508075
....: 688772), RR(1.7320508075688774)))
....: v2 = QQbar.polynomial_root(AA.common_polynomial(y^4 - y^2 + 1), CIF(RIF(RR
....: (0.8660254037844386), RR(0.86602540378443871)), RIF(-RR(0.5000000000000001
....: 1), -RR(0.49999999999999994))))
....: my_vectors = (vector(AA, [-v1, -1, 1]), vector(AA, [0, 2, 1]), vector(AA, 
....: [v1, -1, 1]), vector(AA, [1, 0, 0]), vector(AA, [1/2, AA(-1/2*v2^3 + v2), 
....: 0]), vector(AA, [-1/2, AA(-1/2*v2^3 + v2), 0]))
....: 
sage: H = HyperplaneArrangements(AA,names='xyz')
sage: x,y,z = H.gens()
sage: A = H(backend="normaliz")
sage: for v in my_vectors:
....:     a,b,c = v
....:     A = A.add_hyperplane(a*x + b*y + c*z)
....:     
sage: A
Arrangement of 6 hyperplanes of dimension 3 and rank 3
sage: A.n_regions()
31
sage: A.is_central()
True
```


Issue created by migration from https://trac.sagemath.org/ticket/30749





---

archive/issue_comments_435683.json:
```json
{
    "body": "The char poly gives the same answer\n\n```\nsage: p = A.characteristic_polynomial() : p\nx^3 - 6*x^2 + 13*x - 11\nsage: p(-1)                                                                     \n-31\n```\n",
    "created_at": "2020-10-09T11:01:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30512#issuecomment-435683",
    "user": "@fchapoton"
}
```

The char poly gives the same answer

```
sage: p = A.characteristic_polynomial() : p
x^3 - 6*x^2 + 13*x - 11
sage: p(-1)                                                                     
-31
```




---

archive/issue_comments_435684.json:
```json
{
    "body": "Replying to [comment:2 chapoton]:\n> The char poly gives the same answer\n> {{{\n> sage: p = A.characteristic_polynomial() : p\n> x^3 - 6*x^2 + 13*x - 11\n> sage: p(-1)                                                                     \n> -31\n> }}}\n\nYes, this is how the number of regions is computed up to sign. The hyperplane arrangement seems to be sane: computing `.regions()` computes the expected (number of) regions.\n\nI asked the number of regions to double-check something and then got this scary answer...",
    "created_at": "2020-10-09T14:14:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30512#issuecomment-435684",
    "user": "@jplab"
}
```

Replying to [comment:2 chapoton]:
> The char poly gives the same answer
> {{{
> sage: p = A.characteristic_polynomial() : p
> x^3 - 6*x^2 + 13*x - 11
> sage: p(-1)                                                                     
> -31
> }}}

Yes, this is how the number of regions is computed up to sign. The hyperplane arrangement seems to be sane: computing `.regions()` computes the expected (number of) regions.

I asked the number of regions to double-check something and then got this scary answer...



---

archive/issue_comments_435685.json:
```json
{
    "body": "I encountered this problem in some example a long while ago, before I was contributing to Sage myself. A simple workaround is to have `n_regions` output `len(self.regions())`, which was good enough for me. Of course, this is much slower if one doesn\u2019t want to compute the regions anyway. I don\u2019t understand the characteristic polynomial well enough to figure out the error in there.",
    "created_at": "2020-10-09T14:26:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30512#issuecomment-435685",
    "user": "nailuj"
}
```

I encountered this problem in some example a long while ago, before I was contributing to Sage myself. A simple workaround is to have `n_regions` output `len(self.regions())`, which was good enough for me. Of course, this is much slower if one doesn’t want to compute the regions anyway. I don’t understand the characteristic polynomial well enough to figure out the error in there.



---

archive/issue_comments_435686.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30512#issuecomment-435686",
    "user": "@mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_435687.json:
```json
{
    "body": "Replying to [comment:5 nailuj]:\n> I don\u2019t understand the characteristic polynomial well enough to figure out the error in there.\n\nThe characteristic polynomial is obtained through recursive deletions and contractions of hyperplane arrangements. During this process, it may occur that some hyperplane `h` is included in an arrangement multiple times with different scalings of the defining linear expression which are not properly detected as duplicates. This is due to a defect in the method `hyperplane.primitive()` addressed in #30078.",
    "created_at": "2022-03-16T17:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30512#issuecomment-435687",
    "user": "nailuj"
}
```

Replying to [comment:5 nailuj]:
> I don’t understand the characteristic polynomial well enough to figure out the error in there.

The characteristic polynomial is obtained through recursive deletions and contractions of hyperplane arrangements. During this process, it may occur that some hyperplane `h` is included in an arrangement multiple times with different scalings of the defining linear expression which are not properly detected as duplicates. This is due to a defect in the method `hyperplane.primitive()` addressed in #30078.



---

archive/issue_comments_435688.json:
```json
{
    "body": "Is this defect solved by #30078?",
    "created_at": "2022-04-03T18:48:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30512#issuecomment-435688",
    "user": "@mkoeppe"
}
```

Is this defect solved by #30078?



---

archive/issue_comments_435689.json:
```json
{
    "body": "It seems like it is. Using the first example, I get\n\n```\nsage: A.n_regions()\n24\nsage: len(A.regions())\n24\nsage: A.characteristic_polynomial()(-1)\n-24\n```\n\nSo it is now consistent. We probably just want to add a doctest for this ticket.",
    "created_at": "2022-04-04T01:08:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30512#issuecomment-435689",
    "user": "@tscrim"
}
```

It seems like it is. Using the first example, I get

```
sage: A.n_regions()
24
sage: len(A.regions())
24
sage: A.characteristic_polynomial()(-1)
-24
```

So it is now consistent. We probably just want to add a doctest for this ticket.



---

archive/issue_comments_435690.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-04-05T12:40:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30512#issuecomment-435690",
    "user": "@kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_435691.json:
```json
{
    "body": "#30078 already adds one doctest. So we can either close it as duplicate or add another doctest. Either way is fine with me.\n----\nNew commits:",
    "created_at": "2022-04-05T12:40:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30512#issuecomment-435691",
    "user": "@kliem"
}
```

#30078 already adds one doctest. So we can either close it as duplicate or add another doctest. Either way is fine with me.
----
New commits:



---

archive/issue_comments_435692.json:
```json
{
    "body": "\n```diff\n--- a/sage/geometry/hyperplane_arrangement/arrangement.py\n+++ b/sage/geometry/hyperplane_arrangement/arrangement.py\n@@ -1179,10 +1179,10 @@\n             sage: H = HyperplaneArrangements(AA, names='xyz')\n             sage: x,y,z = H.gens()\n             sage: A = H(backend=\"normaliz\")  # optional - pynormaliz\n-            sage: for v in my_vector:        # optional - pyrormaliz\n+            sage: for v in my_vectors:       # optional - pynormaliz\n             ....:     a, b, c = v\n             ....:     A = A.add_hyperplane(a*x + b*y + c*z)\n-            sage: A.n_regions()              # optional - pyrormaliz\n+            sage: A.n_regions()              # optional - pynormaliz\n             32\n         \"\"\"\n         if self.base_ring().characteristic() != 0:\n```\n",
    "created_at": "2022-04-05T14:59:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30512#issuecomment-435692",
    "user": "@sheerluck"
}
```


```diff
--- a/sage/geometry/hyperplane_arrangement/arrangement.py
+++ b/sage/geometry/hyperplane_arrangement/arrangement.py
@@ -1179,10 +1179,10 @@
             sage: H = HyperplaneArrangements(AA, names='xyz')
             sage: x,y,z = H.gens()
             sage: A = H(backend="normaliz")  # optional - pynormaliz
-            sage: for v in my_vector:        # optional - pyrormaliz
+            sage: for v in my_vectors:       # optional - pynormaliz
             ....:     a, b, c = v
             ....:     A = A.add_hyperplane(a*x + b*y + c*z)
-            sage: A.n_regions()              # optional - pyrormaliz
+            sage: A.n_regions()              # optional - pynormaliz
             32
         """
         if self.base_ring().characteristic() != 0:
```




---

archive/issue_comments_435693.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-04-05T15:33:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30512#issuecomment-435693",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435694.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-04-06T00:51:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30512#issuecomment-435694",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_435695.json:
```json
{
    "body": "Thank you. LGTM.\n\n`@`gh-sheerluck, please add your (real) name to the reviewers (if you want).",
    "created_at": "2022-04-06T00:51:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30512#issuecomment-435695",
    "user": "@tscrim"
}
```

Thank you. LGTM.

`@`gh-sheerluck, please add your (real) name to the reviewers (if you want).



---

archive/issue_comments_435696.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-04-10T13:12:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30512#issuecomment-435696",
    "user": "@vbraun"
}
```

Resolution: fixed
