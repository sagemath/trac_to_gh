# Issue 33565: Remove runtime dependency on everything via sage_eval

Issue created by migration from https://trac.sagemath.org/ticket/33802

Original creator: mkoeppe

Original creation time: 2022-05-04 23:57:53

CC:  klee @kliem jhpalmieri @spaghettisalat @jcamp0x2a

`sage_eval` evaluates a string using the globals of `sage.all`.

It is used in some constructors and other functions - but in most uses, likely just a few bindings, namely those emitted by the preparser, are needed.

It is also used by `sage_input` to verify inputs. We run the verification with a smaller module first before falling back to `sage.all`


---

Comment by mkoeppe created at 2022-05-05 06:35:33

With this change:

```
diff --git a/src/sage/misc/sage_eval.py b/src/sage/misc/sage_eval.py
index ebd9ad6f3d..57419a8ba9 100644
--- a/src/sage/misc/sage_eval.py
+++ b/src/sage/misc/sage_eval.py
@@ -182,7 +182,13 @@ def sage_eval(source, locals=None, cmds='', preparse=True):
     if locals is None:
         locals = {}
 
-    import sage.all
+    if cmds:
+        import sage.all
+        globals = sage.all.__dict__
+    else:
+        import sage.repl.preparse_expression_runtime
+        globals = sage.repl.preparse_expression_runtime.__dict__
+
     if cmds:
         cmd_seq = cmds + '\n_sage_eval_returnval_ = ' + source
         if preparse:
@@ -192,10 +198,10 @@ def sage_eval(source, locals=None, cmds='', preparse=True):
             source = preparser.preparse(source)
 
     if cmds:
-        exec(cmd_seq, sage.all.__dict__, locals)
+        exec(cmd_seq, globals, locals)
         return locals['_sage_eval_returnval_']
     else:
-        return eval(source, sage.all.__dict__, locals)
+        return eval(source, globals, locals)
 
```

there are only a few failures (except for `growth_group.py`)

```
$ ./sage -tp $(git grep -l sage_eval)
....
sage -t --random-seed=131777733077912989056233344518802251877 src/sage/rings/asymptotic/growth_group.py  # 460 doctests failed
sage -t --random-seed=131777733077912989056233344518802251877 src/sage/rings/polynomial/polynomial_element.pyx  # 3 doctests failed
sage -t --random-seed=131777733077912989056233344518802251877 src/sage/rings/complex_mpfr.pyx  # 3 doctests failed
sage -t --random-seed=131777733077912989056233344518802251877 src/sage/matrix/matrix1.pyx  # 6 doctests failed
sage -t --random-seed=131777733077912989056233344518802251877 src/sage/misc/sage_eval.py  # 3 doctests failed
sage -t --random-seed=131777733077912989056233344518802251877 src/sage/rings/polynomial/multi_polynomial_ring.py  # 1 doctest failed
sage -t --random-seed=131777733077912989056233344518802251877 src/sage/rings/asymptotic/misc.py  # 21 doctests failed
sage -t --random-seed=131777733077912989056233344518802251877 src/sage/symbolic/units.py  # 2 doctests failed
```

----
New commits:
