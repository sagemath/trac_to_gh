# Issue 33565: Remove runtime dependency on everything via sage_eval

archive/issues_033565.json:
```json
{
    "body": "CC:  @kwankyu @kliem @jhpalmieri @spaghettisalat @jcamp0x2a\n\n`sage_eval` evaluates a string using the globals of `sage.all`.\n\nIt is used in some constructors and other functions - but in most uses, likely just a few bindings, namely those emitted by the preparser, are needed.\n\nIt is also used by `sage_input` to verify inputs. We run the verification with a smaller module first before falling back to `sage.all`\n\nIssue created by migration from https://trac.sagemath.org/ticket/33802\n\n",
    "created_at": "2022-05-04T23:57:53Z",
    "labels": [
        "component: refactoring"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Remove runtime dependency on everything via sage_eval",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33565",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @kwankyu @kliem @jhpalmieri @spaghettisalat @jcamp0x2a

`sage_eval` evaluates a string using the globals of `sage.all`.

It is used in some constructors and other functions - but in most uses, likely just a few bindings, namely those emitted by the preparser, are needed.

It is also used by `sage_input` to verify inputs. We run the verification with a smaller module first before falling back to `sage.all`

Issue created by migration from https://trac.sagemath.org/ticket/33802





---

archive/issue_comments_477146.json:
```json
{
    "body": "With this change:\n\n```\ndiff --git a/src/sage/misc/sage_eval.py b/src/sage/misc/sage_eval.py\nindex ebd9ad6f3d..57419a8ba9 100644\n--- a/src/sage/misc/sage_eval.py\n+++ b/src/sage/misc/sage_eval.py\n@@ -182,7 +182,13 @@ def sage_eval(source, locals=None, cmds='', preparse=True):\n     if locals is None:\n         locals = {}\n \n-    import sage.all\n+    if cmds:\n+        import sage.all\n+        globals = sage.all.__dict__\n+    else:\n+        import sage.repl.preparse_expression_runtime\n+        globals = sage.repl.preparse_expression_runtime.__dict__\n+\n     if cmds:\n         cmd_seq = cmds + '\\n_sage_eval_returnval_ = ' + source\n         if preparse:\n@@ -192,10 +198,10 @@ def sage_eval(source, locals=None, cmds='', preparse=True):\n             source = preparser.preparse(source)\n \n     if cmds:\n-        exec(cmd_seq, sage.all.__dict__, locals)\n+        exec(cmd_seq, globals, locals)\n         return locals['_sage_eval_returnval_']\n     else:\n-        return eval(source, sage.all.__dict__, locals)\n+        return eval(source, globals, locals)\n \n```\nthere are only a few failures (except for `growth_group.py`)\n\n```\n$ ./sage -tp $(git grep -l sage_eval)\n....\nsage -t --random-seed=131777733077912989056233344518802251877 src/sage/rings/asymptotic/growth_group.py  # 460 doctests failed\nsage -t --random-seed=131777733077912989056233344518802251877 src/sage/rings/polynomial/polynomial_element.pyx  # 3 doctests failed\nsage -t --random-seed=131777733077912989056233344518802251877 src/sage/rings/complex_mpfr.pyx  # 3 doctests failed\nsage -t --random-seed=131777733077912989056233344518802251877 src/sage/matrix/matrix1.pyx  # 6 doctests failed\nsage -t --random-seed=131777733077912989056233344518802251877 src/sage/misc/sage_eval.py  # 3 doctests failed\nsage -t --random-seed=131777733077912989056233344518802251877 src/sage/rings/polynomial/multi_polynomial_ring.py  # 1 doctest failed\nsage -t --random-seed=131777733077912989056233344518802251877 src/sage/rings/asymptotic/misc.py  # 21 doctests failed\nsage -t --random-seed=131777733077912989056233344518802251877 src/sage/symbolic/units.py  # 2 doctests failed\n```\n\n---\nNew commits:",
    "created_at": "2022-05-05T06:35:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33565",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33565#issuecomment-477146",
    "user": "https://github.com/mkoeppe"
}
```

With this change:

```
diff --git a/src/sage/misc/sage_eval.py b/src/sage/misc/sage_eval.py
index ebd9ad6f3d..57419a8ba9 100644
--- a/src/sage/misc/sage_eval.py
+++ b/src/sage/misc/sage_eval.py
@@ -182,7 +182,13 @@ def sage_eval(source, locals=None, cmds='', preparse=True):
     if locals is None:
         locals = {}
 
-    import sage.all
+    if cmds:
+        import sage.all
+        globals = sage.all.__dict__
+    else:
+        import sage.repl.preparse_expression_runtime
+        globals = sage.repl.preparse_expression_runtime.__dict__
+
     if cmds:
         cmd_seq = cmds + '\n_sage_eval_returnval_ = ' + source
         if preparse:
@@ -192,10 +198,10 @@ def sage_eval(source, locals=None, cmds='', preparse=True):
             source = preparser.preparse(source)
 
     if cmds:
-        exec(cmd_seq, sage.all.__dict__, locals)
+        exec(cmd_seq, globals, locals)
         return locals['_sage_eval_returnval_']
     else:
-        return eval(source, sage.all.__dict__, locals)
+        return eval(source, globals, locals)
 
```
there are only a few failures (except for `growth_group.py`)

```
$ ./sage -tp $(git grep -l sage_eval)
....
sage -t --random-seed=131777733077912989056233344518802251877 src/sage/rings/asymptotic/growth_group.py  # 460 doctests failed
sage -t --random-seed=131777733077912989056233344518802251877 src/sage/rings/polynomial/polynomial_element.pyx  # 3 doctests failed
sage -t --random-seed=131777733077912989056233344518802251877 src/sage/rings/complex_mpfr.pyx  # 3 doctests failed
sage -t --random-seed=131777733077912989056233344518802251877 src/sage/matrix/matrix1.pyx  # 6 doctests failed
sage -t --random-seed=131777733077912989056233344518802251877 src/sage/misc/sage_eval.py  # 3 doctests failed
sage -t --random-seed=131777733077912989056233344518802251877 src/sage/rings/polynomial/multi_polynomial_ring.py  # 1 doctest failed
sage -t --random-seed=131777733077912989056233344518802251877 src/sage/rings/asymptotic/misc.py  # 21 doctests failed
sage -t --random-seed=131777733077912989056233344518802251877 src/sage/symbolic/units.py  # 2 doctests failed
```

---
New commits:



---

archive/issue_events_088781.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-08T07:30:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33565",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33565#event-88781"
}
```
