# Issue 21927: Memory leaks in eclib interface

archive/issues_021927.json:
```json
{
    "body": "The interface from Sage to eclib introduces memory leaks since C++ objects are created but not destroyed.  In all but one place there is an appropriate dealloc method, but not for class ECModularSymbol.\n\nHere is a list, hopefully complete, all from sage.libs.eclib:\n\n- In homespace.pyx the initializer for class ModularSymbols calls new to create a C++ homespace, which is correctly deallocated\n\n- In mat.pyx, C++ matrices are created but again there is a dealloc to delete them.\n\n- In mwrank.pyx the initializer for class _Curvedata creates a C++ Curvedata via new which is correctly deallocated.  Same for class _mw with a new nw.  Same for class _two_descent and new two_descent.\n\n- But in newforms.pyx, the initializer for class ECModularSymbol calls new newforms() and has no dealloc method.\n\nIssue created by migration from https://trac.sagemath.org/ticket/22164\n\n",
    "created_at": "2017-01-10T10:14:43Z",
    "labels": [
        "interfaces",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.6",
    "title": "Memory leaks in eclib interface",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21927",
    "user": "@JohnCremona"
}
```
The interface from Sage to eclib introduces memory leaks since C++ objects are created but not destroyed.  In all but one place there is an appropriate dealloc method, but not for class ECModularSymbol.

Here is a list, hopefully complete, all from sage.libs.eclib:

- In homespace.pyx the initializer for class ModularSymbols calls new to create a C++ homespace, which is correctly deallocated

- In mat.pyx, C++ matrices are created but again there is a dealloc to delete them.

- In mwrank.pyx the initializer for class _Curvedata creates a C++ Curvedata via new which is correctly deallocated.  Same for class _mw with a new nw.  Same for class _two_descent and new two_descent.

- But in newforms.pyx, the initializer for class ECModularSymbol calls new newforms() and has no dealloc method.

Issue created by migration from https://trac.sagemath.org/ticket/22164





---

archive/issue_comments_304530.json:
```json
{
    "body": "I added #22077 and #10256 as dependencies since they  make many changes in sage.libs.eclib, but as they have missed release 7.5 (I assume) someone might consider it urgent to fix this leak before 7.5 despite that.",
    "created_at": "2017-01-10T10:16:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304530",
    "user": "@JohnCremona"
}
```

I added #22077 and #10256 as dependencies since they  make many changes in sage.libs.eclib, but as they have missed release 7.5 (I assume) someone might consider it urgent to fix this leak before 7.5 despite that.



---

archive/issue_comments_304531.json:
```json
{
    "body": "homespace? Sounds cool :-)",
    "created_at": "2017-01-10T13:02:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304531",
    "user": "@jdemeyer"
}
```

homespace? Sounds cool :-)



---

archive/issue_comments_304532.json:
```json
{
    "body": "Replying to [comment:1 cremona]:\n> I added #22077 and #10256 as dependencies since they  make many changes in sage.libs.eclib, but as they have missed release 7.5 (I assume) someone might consider it urgent to fix this leak before 7.5 despite that.\n\nAs far as I know, the memory leak is not something new. If the problem has existed for a while and people didn't complain, I don't consider it very urgent.",
    "created_at": "2017-01-10T13:03:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304532",
    "user": "@jdemeyer"
}
```

Replying to [comment:1 cremona]:
> I added #22077 and #10256 as dependencies since they  make many changes in sage.libs.eclib, but as they have missed release 7.5 (I assume) someone might consider it urgent to fix this leak before 7.5 despite that.

As far as I know, the memory leak is not something new. If the problem has existed for a while and people didn't complain, I don't consider it very urgent.



---

archive/issue_comments_304533.json:
```json
{
    "body": "That is a fair point.  The reason it came up now is that Rob Pollack and I were adding Iwasawa lambda- and mu-invariants to each of the elliptic curves in the LMFDB, which involves a one-off computation for each which uses this.  Once we had tested the code Rob was intending to run it as far as practicable, and that will only be possible once this is fixed.  And also, these computations will also use the additional functionality made available at #10256 and #22077.",
    "created_at": "2017-01-10T13:44:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304533",
    "user": "@JohnCremona"
}
```

That is a fair point.  The reason it came up now is that Rob Pollack and I were adding Iwasawa lambda- and mu-invariants to each of the elliptic curves in the LMFDB, which involves a one-off computation for each which uses this.  Once we had tested the code Rob was intending to run it as far as practicable, and that will only be possible once this is fixed.  And also, these computations will also use the additional functionality made available at #10256 and #22077.



---

archive/issue_comments_304534.json:
```json
{
    "body": "Maybe we could discuss in Edinburgh?",
    "created_at": "2017-01-10T14:00:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304534",
    "user": "@jdemeyer"
}
```

Maybe we could discuss in Edinburgh?



---

archive/issue_comments_304535.json:
```json
{
    "body": "OK, let's.  Meanwhile I am trying the same loop to 10000 as in the asksage post, and by 5000 it is using around 15g, so I stopped it and will try again with a small patch which adds a dealloc method.",
    "created_at": "2017-01-10T14:18:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304535",
    "user": "@JohnCremona"
}
```

OK, let's.  Meanwhile I am trying the same loop to 10000 as in the asksage post, and by 5000 it is using around 15g, so I stopped it and will try again with a small patch which adds a dealloc method.



---

archive/issue_comments_304536.json:
```json
{
    "body": "Report on test:  after adding the dealloc method to the ECModularSYmbol class in the cython file newforms.pyx, and running the loop again, the memory usage is a lot less but it still sits at 13g at the end of the loop to 10000.  There must be something else not getting cleared.\n\nThe exact test is\n\n```\nDB = CremonaDatabase()\nfor N in range(1,10000):\n     Cs = DB.isogeny_classes(N)\n     for C in Cs:\n         E=EllipticCurve(C[0][0])\n         print(E.label())\n         phi=E.modular_symbol()\n```\n",
    "created_at": "2017-01-11T08:43:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304536",
    "user": "@JohnCremona"
}
```

Report on test:  after adding the dealloc method to the ECModularSYmbol class in the cython file newforms.pyx, and running the loop again, the memory usage is a lot less but it still sits at 13g at the end of the loop to 10000.  There must be something else not getting cleared.

The exact test is

```
DB = CremonaDatabase()
for N in range(1,10000):
     Cs = DB.isogeny_classes(N)
     for C in Cs:
         E=EllipticCurve(C[0][0])
         print(E.label())
         phi=E.modular_symbol()
```




---

archive/issue_comments_304537.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-01-13T11:43:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304537",
    "user": "@JohnCremona"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_304538.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-01-13T11:43:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304538",
    "user": "@JohnCremona"
}
```

New commits:



---

archive/issue_comments_304539.json:
```json
{
    "body": "NB only the last commit is new to this ticket, the others are from #10256 (and #22077).",
    "created_at": "2017-01-13T11:44:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304539",
    "user": "@JohnCremona"
}
```

NB only the last commit is new to this ticket, the others are from #10256 (and #22077).



---

archive/issue_comments_304540.json:
```json
{
    "body": "I notice these lines in the __init__\n\n```\n        C = new Curve(a1,a2,a3,a4,a6)\n        CD = new Curvedata(C[0],0)\n        CR = new CurveRed(CD[0])\n```\n\nfor which I cannot find explicit \"del\"s elsewhere. Do these get deleted? I think normally every \"new\" should be paired with a \"del\". It could be that your objects disappear into another object and that deallocating them is done as part of the deallocation of that object, but then your interface have that documented and you should only access that object via the encapsulating object.",
    "created_at": "2017-01-13T16:48:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304540",
    "user": "@nbruin"
}
```

I notice these lines in the __init__

```
        C = new Curve(a1,a2,a3,a4,a6)
        CD = new Curvedata(C[0],0)
        CR = new CurveRed(CD[0])
```

for which I cannot find explicit "del"s elsewhere. Do these get deleted? I think normally every "new" should be paired with a "del". It could be that your objects disappear into another object and that deallocating them is done as part of the deallocation of that object, but then your interface have that documented and you should only access that object via the encapsulating object.



---

archive/issue_comments_304541.json:
```json
{
    "body": "I don't know the answer to that.  Perhaps I should try deallocating those too and seeing if it helps.  I did not write this wrapper and don't know cython wrapping at all well, but the difference is that thpse variables are local to the init function while the \"new newforms...\" is stored in self.",
    "created_at": "2017-01-13T17:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304541",
    "user": "@JohnCremona"
}
```

I don't know the answer to that.  Perhaps I should try deallocating those too and seeing if it helps.  I did not write this wrapper and don't know cython wrapping at all well, but the difference is that thpse variables are local to the init function while the "new newforms..." is stored in self.



---

archive/issue_comments_304542.json:
```json
{
    "body": "Replying to [comment:12 cremona]:\n> I don't know the answer to that.  Perhaps I should try deallocating those too and seeing if it helps.  I did not write this wrapper and don't know cython wrapping at all well,\n\n?? it's the C++ here (createfromcurve) that could do complicated stuff. That's yours, right?\n\n> but the difference is that thpse variables are local to the init function while the \"new newforms...\" is stored in self.\n\nCython wouldn't be able to generate \"del\"s for these automatically without extensive flow analysis, though: Just because the result of \"new\" gets assigned to a pointer variable that is local doesn't imply that the value doesn't get stored in other places as well.\n\nIn this case it does look like you should be able to at least do a `del C; del CD; del CR` without problem: their values are only used in dereferenced form `C[0],CD[0],CR[0]`.\n\nYou would know if the routines `CurveData,CurveRed,getconductor,createfromcurve` do funny stuff (especially, if they take special measures such as \"del\"-ing their arguments!)\n\nIt does look like Tom must have been in a rather big hurry when he wrote this wrapper, or otherwise had a deep-rooted contempt for reusing memory.",
    "created_at": "2017-01-14T00:15:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304542",
    "user": "@nbruin"
}
```

Replying to [comment:12 cremona]:
> I don't know the answer to that.  Perhaps I should try deallocating those too and seeing if it helps.  I did not write this wrapper and don't know cython wrapping at all well,

?? it's the C++ here (createfromcurve) that could do complicated stuff. That's yours, right?

> but the difference is that thpse variables are local to the init function while the "new newforms..." is stored in self.

Cython wouldn't be able to generate "del"s for these automatically without extensive flow analysis, though: Just because the result of "new" gets assigned to a pointer variable that is local doesn't imply that the value doesn't get stored in other places as well.

In this case it does look like you should be able to at least do a `del C; del CD; del CR` without problem: their values are only used in dereferenced form `C[0],CD[0],CR[0]`.

You would know if the routines `CurveData,CurveRed,getconductor,createfromcurve` do funny stuff (especially, if they take special measures such as "del"-ing their arguments!)

It does look like Tom must have been in a rather big hurry when he wrote this wrapper, or otherwise had a deep-rooted contempt for reusing memory.



---

archive/issue_comments_304543.json:
```json
{
    "body": "As I mentioned on the mailing list, you don't need always need to use pointers. You could use just\n\n```\ncdef mytype obj = mytype(....)  # no del needed\n```\n\ninstead of\n\n```\ncdef mytype* obj = new mytype(....)\ndel obj\n```\n\nThis might not always work and might have performance implications, but it's at least something to try.",
    "created_at": "2017-01-14T08:59:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304543",
    "user": "@jdemeyer"
}
```

As I mentioned on the mailing list, you don't need always need to use pointers. You could use just

```
cdef mytype obj = mytype(....)  # no del needed
```

instead of

```
cdef mytype* obj = new mytype(....)
del obj
```

This might not always work and might have performance implications, but it's at least something to try.



---

archive/issue_comments_304544.json:
```json
{
    "body": "If I replace\n\n```\ncdef Curve *C\n```\n\nby\n\n```\ncdef Curve C\n```\n\nI get the error\n\n```\nsage/libs/eclib/newforms.pyx:181:19: C++ class must have a nullary constructor to be stack allocated\n```\n\neven though the C++ class Curve _does_ have a nullary constructor (see line 73 in https://github.com/JohnCremona/eclib/blob/master/libsrc/eclib/curve.h).",
    "created_at": "2017-01-14T19:44:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304544",
    "user": "@JohnCremona"
}
```

If I replace

```
cdef Curve *C
```

by

```
cdef Curve C
```

I get the error

```
sage/libs/eclib/newforms.pyx:181:19: C++ class must have a nullary constructor to be stack allocated
```

even though the C++ class Curve _does_ have a nullary constructor (see line 73 in https://github.com/JohnCremona/eclib/blob/master/libsrc/eclib/curve.h).



---

archive/issue_comments_304545.json:
```json
{
    "body": "Replying to [comment:15 cremona]:\n> even though the C++ class Curve _does_ have a nullary constructor (see line 73 in https://github.com/JohnCremona/eclib/blob/master/libsrc/eclib/curve.h).\n\nIt looks like this signature isn't known to cython though, since it doesn't seem to be exposed in the `pxd` file: https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/libs/eclib/__init__.pxd?h=u/cremona/22164&id=c0306ee08b94061ef1f525cdc71d24c17e004ce3#n45",
    "created_at": "2017-01-14T22:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304545",
    "user": "@nbruin"
}
```

Replying to [comment:15 cremona]:
> even though the C++ class Curve _does_ have a nullary constructor (see line 73 in https://github.com/JohnCremona/eclib/blob/master/libsrc/eclib/curve.h).

It looks like this signature isn't known to cython though, since it doesn't seem to be exposed in the `pxd` file: https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/libs/eclib/__init__.pxd?h=u/cremona/22164&id=c0306ee08b94061ef1f525cdc71d24c17e004ce3#n45



---

archive/issue_comments_304546.json:
```json
{
    "body": "Right. Cython never reads any `.h` files, it just generates `#include <foo.h>` statements. Cython only reads the `.pxd` file and according to that, there is no nullary constructor. That's of course easily fixed by add a line `Curve()` in the `cppclass Curve`.",
    "created_at": "2017-01-15T09:17:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304546",
    "user": "@jdemeyer"
}
```

Right. Cython never reads any `.h` files, it just generates `#include <foo.h>` statements. Cython only reads the `.pxd` file and according to that, there is no nullary constructor. That's of course easily fixed by add a line `Curve()` in the `cppclass Curve`.



---

archive/issue_comments_304547.json:
```json
{
    "body": "Thanks for the tips.   I am now trying the test again after adding those nullary constructors in the pxd file.  Before that, with \"del C\" and 2 similar, it made little difference: at the end of the loop there was 13g in use according to \"top\".\n\nThere is probably a better way to see how much memory is in use, from within Sage itself.  Can someone remind me?",
    "created_at": "2017-01-15T12:45:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304547",
    "user": "@JohnCremona"
}
```

Thanks for the tips.   I am now trying the test again after adding those nullary constructors in the pxd file.  Before that, with "del C" and 2 similar, it made little difference: at the end of the loop there was 13g in use according to "top".

There is probably a better way to see how much memory is in use, from within Sage itself.  Can someone remind me?



---

archive/issue_comments_304548.json:
```json
{
    "body": "When this was first reported I did look at `gc.get_objects()` and didn't find anything suspicious. So my guess is that the leaks are not happening on the python heap, but indeed (as indicated here) on some C++ or C heap. Valgrind would probably be your best bet.",
    "created_at": "2017-01-15T20:41:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304548",
    "user": "@nbruin"
}
```

When this was first reported I did look at `gc.get_objects()` and didn't find anything suspicious. So my guess is that the leaks are not happening on the python heap, but indeed (as indicated here) on some C++ or C heap. Valgrind would probably be your best bet.



---

archive/issue_comments_304549.json:
```json
{
    "body": "You are probably right.  I had a masters student parallelise some of the linear algebra code 2 or 3 years ago (code that is running in this loop) and later found through valgrind that there was a memory leak introduced then.  This is a real nuisance -- when eclib was first put into Sage I spent quite a while fixing all the valgrind issues, some of which were hard to track down. I spent a time last summer trying to find the problem here but did not succeed (see https://github.com/JohnCremona/eclib/issues/18).\n\nI suppose this is a case of \"reported upstream, waiting for a fix there\".",
    "created_at": "2017-01-16T09:19:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304549",
    "user": "@JohnCremona"
}
```

You are probably right.  I had a masters student parallelise some of the linear algebra code 2 or 3 years ago (code that is running in this loop) and later found through valgrind that there was a memory leak introduced then.  This is a real nuisance -- when eclib was first put into Sage I spent quite a while fixing all the valgrind issues, some of which were hard to track down. I spent a time last summer trying to find the problem here but did not succeed (see https://github.com/JohnCremona/eclib/issues/18).

I suppose this is a case of "reported upstream, waiting for a fix there".



---

archive/issue_comments_304550.json:
```json
{
    "body": "I am working on fixing the leak in eclib.  Meanwhile it seems that wrapping the eclib call as follows\n\n```\n@fork\ndef work_on(C):\n    E=EllipticCurve(C)\n    print(E.label())\n    phi=E.modular_symbol()\n    sys.stdout.flush()\n    \nDB = CremonaDatabase()\n\nfor N in range(1,10000):\n     Cs = DB.isogeny_classes(N)\n     for C in Cs:\n         work_on(C[0][0])\n```\n\navoids eating up memory: on a test run, it has reached 8000 (out of 10000) and does not go over 200k according to \"top\".",
    "created_at": "2017-01-20T15:36:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304550",
    "user": "@JohnCremona"
}
```

I am working on fixing the leak in eclib.  Meanwhile it seems that wrapping the eclib call as follows

```
@fork
def work_on(C):
    E=EllipticCurve(C)
    print(E.label())
    phi=E.modular_symbol()
    sys.stdout.flush()
    
DB = CremonaDatabase()

for N in range(1,10000):
     Cs = DB.isogeny_classes(N)
     for C in Cs:
         work_on(C[0][0])
```

avoids eating up memory: on a test run, it has reached 8000 (out of 10000) and does not go over 200k according to "top".



---

archive/issue_comments_304551.json:
```json
{
    "body": "Replying to [comment:22 cremona]:\n\nI see a research article coming out of this: Implementing a stack using \"fork\".",
    "created_at": "2017-01-20T21:00:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304551",
    "user": "@nbruin"
}
```

Replying to [comment:22 cremona]:

I see a research article coming out of this: Implementing a stack using "fork".



---

archive/issue_comments_304552.json:
```json
{
    "body": "Replying to [comment:23 nbruin]:\n> Replying to [comment:22 cremona]:\n> \n> I see a research article coming out of this: Implementing a stack using \"fork\".\n\nHa ha.  If you want to be helpful, how about this:  in line 96 of https://github.com/JohnCremona/eclib/blob/master/libsrc/arith.cc\nin a class destructor, there is a delete command.  But according to valgrind the associated memory is not being deleted.  So I added a print statement just before the delete, and now it does delete -- and valgrind is happy.  But I cannot get this to work without adding a line which actually outputs something!  This still happens enve with no optimzation (-O0).",
    "created_at": "2017-01-20T21:43:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304552",
    "user": "@JohnCremona"
}
```

Replying to [comment:23 nbruin]:
> Replying to [comment:22 cremona]:
> 
> I see a research article coming out of this: Implementing a stack using "fork".

Ha ha.  If you want to be helpful, how about this:  in line 96 of https://github.com/JohnCremona/eclib/blob/master/libsrc/arith.cc
in a class destructor, there is a delete command.  But according to valgrind the associated memory is not being deleted.  So I added a print statement just before the delete, and now it does delete -- and valgrind is happy.  But I cannot get this to work without adding a line which actually outputs something!  This still happens enve with no optimzation (-O0).



---

archive/issue_comments_304553.json:
```json
{
    "body": "Replying to [comment:24 cremona]:\n> Ha ha.  If you want to be helpful, how about this:  in line 96 of https://github.com/JohnCremona/eclib/blob/master/libsrc/arith.cc\n> in a class destructor, there is a delete command.  But according to valgrind the associated memory is not being deleted.  So I added a print statement just before the delete, and now it does delete -- and valgrind is happy.\n\nIt's hard to believe a C++ compiler would make an error with something that simple. Have you verified valgrind is right, i.e., if you run something along the lines:\n\n```\n    int i;\n    primeclass *P;\n    for ( i=0; i<1000000; i++){\n        P = new primeclass;\n        P->init(10000);\n        delete P;\n    };\n```\n\ndo you see memory leaking? My guess would be that valgrind somehow misses the free ...",
    "created_at": "2017-01-21T00:10:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304553",
    "user": "@nbruin"
}
```

Replying to [comment:24 cremona]:
> Ha ha.  If you want to be helpful, how about this:  in line 96 of https://github.com/JohnCremona/eclib/blob/master/libsrc/arith.cc
> in a class destructor, there is a delete command.  But according to valgrind the associated memory is not being deleted.  So I added a print statement just before the delete, and now it does delete -- and valgrind is happy.

It's hard to believe a C++ compiler would make an error with something that simple. Have you verified valgrind is right, i.e., if you run something along the lines:

```
    int i;
    primeclass *P;
    for ( i=0; i<1000000; i++){
        P = new primeclass;
        P->init(10000);
        delete P;
    };
```

do you see memory leaking? My guess would be that valgrind somehow misses the free ...



---

archive/issue_comments_304554.json:
```json
{
    "body": "There was a logical explanation (of course) but quite a strange one.  I was running a test program from my test suite (as done by \"make check\") but running independently to use valgrind.  Using the standard test input file. However for this test, the input file contains a filename and the program attempts to open that.  In this scenario the file does not exist (the Makefile copies it from somewhere else) and the test program calls abort().  So while it is still strange that whether or not the destructor is called on abort() depends on there being code to produce output in the destructor, it was all a big red herring...",
    "created_at": "2017-01-21T09:18:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304554",
    "user": "@JohnCremona"
}
```

There was a logical explanation (of course) but quite a strange one.  I was running a test program from my test suite (as done by "make check") but running independently to use valgrind.  Using the standard test input file. However for this test, the input file contains a filename and the program attempts to open that.  In this scenario the file does not exist (the Makefile copies it from somewhere else) and the test program calls abort().  So while it is still strange that whether or not the destructor is called on abort() depends on there being code to produce output in the destructor, it was all a big red herring...



---

archive/issue_comments_304555.json:
```json
{
    "body": "I think I have fixed the memory leaks.  Rather than open a new ticket for upgrading eclib again I'll do that on this ticket, and the test that it can be accepted should include running the loop given here without memory usage growing.",
    "created_at": "2017-01-25T19:51:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304555",
    "user": "@JohnCremona"
}
```

I think I have fixed the memory leaks.  Rather than open a new ticket for upgrading eclib again I'll do that on this ticket, and the test that it can be accepted should include running the loop given here without memory usage growing.



---

archive/issue_comments_304556.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-01-27T09:10:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304556",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_304557.json:
```json
{
    "body": "The branch u/cremona/22164 at commit 290f045 now includes (1) addition of a missing dealloc, (2) addition of null constructors for 3 eclib classes so pointers are not needed when constructing these, and (crucially) (3) a new eclib version which fixes the memory leak.  It was also merged with 7.6.beta0.\n\nThe new eclib is at http://homepages.warwick.ac.uk/staff/J.E.Cremona/ftp/eclib-20170122.tar.bz2\n\nThere are no changes there except for the bug fix, so no chenges needed to Sage except the package version and checksum change.\n\nI tested this with the original loop over conductors to 10000 and the memory in use was totally under control.  \n\nPlease review!",
    "created_at": "2017-01-27T09:16:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304557",
    "user": "@JohnCremona"
}
```

The branch u/cremona/22164 at commit 290f045 now includes (1) addition of a missing dealloc, (2) addition of null constructors for 3 eclib classes so pointers are not needed when constructing these, and (crucially) (3) a new eclib version which fixes the memory leak.  It was also merged with 7.6.beta0.

The new eclib is at http://homepages.warwick.ac.uk/staff/J.E.Cremona/ftp/eclib-20170122.tar.bz2

There are no changes there except for the bug fix, so no chenges needed to Sage except the package version and checksum change.

I tested this with the original loop over conductors to 10000 and the memory in use was totally under control.  

Please review!



---

archive/issue_comments_304558.json:
```json
{
    "body": "Maybe you could add a doctest to show the memory is now under control?",
    "created_at": "2017-01-31T11:13:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304558",
    "user": "jpflori"
}
```

Maybe you could add a doctest to show the memory is now under control?



---

archive/issue_comments_304559.json:
```json
{
    "body": "That is a good idea.  I will.",
    "created_at": "2017-01-31T12:18:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304559",
    "user": "@JohnCremona"
}
```

That is a good idea.  I will.



---

archive/issue_comments_304560.json:
```json
{
    "body": "Would something like this be OK?  Before:\n\n```\nsage: get_memory_usage()\n134024.41796875\nsage: for E in cremona_curves([380,400]):\n....:     M = E.modular_symbol()\nsage: get_memory_usage()\n134070.73046875\n```\n\n\nAfter:\n\n```\nsage: get_memory_usage()\n136320.72265625\nsage: for E in cremona_curves([380,400]):\n....:     M = E.modular_symbol()\n....:     \nsage: get_memory_usage()\n136322.546875\n```\n\n\nAnything showing a greater leakage will take longer (the above is just a few seconds).  If the run goes from 11 to 400 instead then the usage goes up by 49 before and 2 after.",
    "created_at": "2017-01-31T12:25:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304560",
    "user": "@JohnCremona"
}
```

Would something like this be OK?  Before:

```
sage: get_memory_usage()
134024.41796875
sage: for E in cremona_curves([380,400]):
....:     M = E.modular_symbol()
sage: get_memory_usage()
134070.73046875
```


After:

```
sage: get_memory_usage()
136320.72265625
sage: for E in cremona_curves([380,400]):
....:     M = E.modular_symbol()
....:     
sage: get_memory_usage()
136322.546875
```


Anything showing a greater leakage will take longer (the above is just a few seconds).  If the run goes from 11 to 400 instead then the usage goes up by 49 before and 2 after.



---

archive/issue_comments_304561.json:
```json
{
    "body": "So the test should probably be something like\n\n```\nT=get_memory_usage()\nfor E in cremona_curves([380,400]):\n    M = E.modular_symbol()\nassert get_memory_usage(T) < 4\n```\n\nThe value you're getting out of this will be very much dependent on the weather and the architecture you're running on, so you have to be a bit conservative in test failure to avoid too many false positives.",
    "created_at": "2017-01-31T19:49:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304561",
    "user": "@nbruin"
}
```

So the test should probably be something like

```
T=get_memory_usage()
for E in cremona_curves([380,400]):
    M = E.modular_symbol()
assert get_memory_usage(T) < 4
```

The value you're getting out of this will be very much dependent on the weather and the architecture you're running on, so you have to be a bit conservative in test failure to avoid too many false positives.



---

archive/issue_comments_304562.json:
```json
{
    "body": "I remember discussing this for another application.\n\nThe best way to check that `foo()` does not leak memory is to run `foo()` a number of times and record the memory usage m<sub>i</sub> after each call of `foo()`. There is no memory leak if, for some index i, we have m<sub>i+j</sub> \u2264 m<sub>i</sub> for all j\u00a0=\u00a01,\u00a0...,\u00a0N (for some suitable fixed value of N like N=10).\n\nPut in a different way: there is no memory leak if you are able to run `foo()` N times where the memory never increases beyond the initial memory usage, but allowing for a few initial calls of `foo()` where the memory is allowed to increase.",
    "created_at": "2017-01-31T20:33:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304562",
    "user": "@jdemeyer"
}
```

I remember discussing this for another application.

The best way to check that `foo()` does not leak memory is to run `foo()` a number of times and record the memory usage m<sub>i</sub> after each call of `foo()`. There is no memory leak if, for some index i, we have m<sub>i+j</sub> ≤ m<sub>i</sub> for all j = 1, ..., N (for some suitable fixed value of N like N=10).

Put in a different way: there is no memory leak if you are able to run `foo()` N times where the memory never increases beyond the initial memory usage, but allowing for a few initial calls of `foo()` where the memory is allowed to increase.



---

archive/issue_comments_304563.json:
```json
{
    "body": "The trouble with using this general strategy is that elliptic curves are cached, so something like\n\n```\nsage: get_memory_usage()\n66277.4609375\nsage: for _ in range(100):\n....:     M = EllipticCurve('90a1').modular_symbol()\n....:     \nsage: get_memory_usage()\n66277.4609375\n```\n\nshows nothing useful (in this run I had already created the modular symbol for this curve).  However one could use:\n\n```\nsage: from sage.libs.eclib.newforms import ECModularSymbol\n```\n\ndirectly.\nTesting this I get the impression that there is a speed regression in the new version which needs to be looked into.  If you see the same, this will have to wait, and will be several days before I can work on it further.",
    "created_at": "2017-01-31T21:10:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304563",
    "user": "@JohnCremona"
}
```

The trouble with using this general strategy is that elliptic curves are cached, so something like

```
sage: get_memory_usage()
66277.4609375
sage: for _ in range(100):
....:     M = EllipticCurve('90a1').modular_symbol()
....:     
sage: get_memory_usage()
66277.4609375
```

shows nothing useful (in this run I had already created the modular symbol for this curve).  However one could use:

```
sage: from sage.libs.eclib.newforms import ECModularSymbol
```

directly.
Testing this I get the impression that there is a speed regression in the new version which needs to be looked into.  If you see the same, this will have to wait, and will be several days before I can work on it further.



---

archive/issue_comments_304564.json:
```json
{
    "body": "There is a speed regression compared with the version in 7.5 but I think this is already true for the eclib version already merged into 7.6, and it has a reason:  to get the normalization right for modular symbols (which is what that eclib upgrade was all about) one has to compute some periods to a certain precision, which requires computing a few hundred ap and then doing the numerical integration (summing series).  So there was a price to pay for getting the normalization right, and that should not stop this bug-fix leak fix going in.\n\nI don't have time to provide more exact data now.",
    "created_at": "2017-02-01T17:05:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304564",
    "user": "@JohnCremona"
}
```

There is a speed regression compared with the version in 7.5 but I think this is already true for the eclib version already merged into 7.6, and it has a reason:  to get the normalization right for modular symbols (which is what that eclib upgrade was all about) one has to compute some periods to a certain precision, which requires computing a few hundred ap and then doing the numerical integration (summing series).  So there was a price to pay for getting the normalization right, and that should not stop this bug-fix leak fix going in.

I don't have time to provide more exact data now.



---

archive/issue_comments_304565.json:
```json
{
    "body": "You can use\n\n```\nEllipticCurve('90a1').modular_symbol.clear_cache()\n```\n\nto clear the cache.",
    "created_at": "2017-02-01T17:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304565",
    "user": "@jdemeyer"
}
```

You can use

```
EllipticCurve('90a1').modular_symbol.clear_cache()
```

to clear the cache.



---

archive/issue_comments_304566.json:
```json
{
    "body": "I'm setting back to Needs Work while I add a test to show that the leak is fixed.",
    "created_at": "2017-02-02T09:37:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304566",
    "user": "@JohnCremona"
}
```

I'm setting back to Needs Work while I add a test to show that the leak is fixed.



---

archive/issue_comments_304567.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-02-02T09:37:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304567",
    "user": "@JohnCremona"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_304568.json:
```json
{
    "body": "OK, so I am adding this test:\n\n```\nsage: from sage.libs.eclib.newforms import ECModularSymbol\nsage: E = EllipticCurve([1,1,0,-108,-432]) # conductor 930\nsage: mem = get_memory_usage()\nsage: for _ in range(10): M = ECModularSymbol(E)\nsage: mem2 = get_memory_usage()\nsage: mem2-mem # random\n3.34375\n```\n\nwhere the above shows a leak of 3.3MB before; after, it is 0.0.",
    "created_at": "2017-02-02T09:52:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304568",
    "user": "@JohnCremona"
}
```

OK, so I am adding this test:

```
sage: from sage.libs.eclib.newforms import ECModularSymbol
sage: E = EllipticCurve([1,1,0,-108,-432]) # conductor 930
sage: mem = get_memory_usage()
sage: for _ in range(10): M = ECModularSymbol(E)
sage: mem2 = get_memory_usage()
sage: mem2-mem # random
3.34375
```

where the above shows a leak of 3.3MB before; after, it is 0.0.



---

archive/issue_comments_304569.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-02-02T10:11:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304569",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_304570.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-02-02T10:12:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304570",
    "user": "@JohnCremona"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_304571.json:
```json
{
    "body": "First of all, the branch needs to be rebased.\n\nSecond, I'm not totally convinced by the memleak test code: the `mem2 - mem < 1` seems rather arbitrary. Although, if it passes doctests, I can accept it.\n\nStill, I suggest to change\n\n```\n        sage: mem2-mem # random\n        0.75\n        sage: assert(mem2-mem < 1)\n```\n\nto\n\n```\n        sage: (mem2 - mem < 1) or (mem2 - mem)\n        True\n```\n\nThis use of `or` in doctests is a neat trick I learned from Robert Bradshaw: in case of failure, you will see the actual value of `mem2 - mem`.",
    "created_at": "2017-02-13T10:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304571",
    "user": "@jdemeyer"
}
```

First of all, the branch needs to be rebased.

Second, I'm not totally convinced by the memleak test code: the `mem2 - mem < 1` seems rather arbitrary. Although, if it passes doctests, I can accept it.

Still, I suggest to change

```
        sage: mem2-mem # random
        0.75
        sage: assert(mem2-mem < 1)
```

to

```
        sage: (mem2 - mem < 1) or (mem2 - mem)
        True
```

This use of `or` in doctests is a neat trick I learned from Robert Bradshaw: in case of failure, you will see the actual value of `mem2 - mem`.



---

archive/issue_comments_304572.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-02-13T10:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304572",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_304573.json:
```json
{
    "body": "I'll make the suggested changes.  I tested on more than one machine and found the exact difference mem2-mem was not the same in all runs.  It is certainly less than before though!   And certainly, the problem is much more severe after running several large examples, but these take too long for a doctest.",
    "created_at": "2017-02-13T10:38:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304573",
    "user": "@JohnCremona"
}
```

I'll make the suggested changes.  I tested on more than one machine and found the exact difference mem2-mem was not the same in all runs.  It is certainly less than before though!   And certainly, the problem is much more severe after running several large examples, but these take too long for a doctest.



---

archive/issue_comments_304574.json:
```json
{
    "body": "I hope you will be happy with a merge of develop into my branch rather than a literal rebase.",
    "created_at": "2017-02-13T12:17:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304574",
    "user": "@JohnCremona"
}
```

I hope you will be happy with a merge of develop into my branch rather than a literal rebase.



---

archive/issue_comments_304575.json:
```json
{
    "body": "Absolutely.",
    "created_at": "2017-02-13T12:19:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304575",
    "user": "@jdemeyer"
}
```

Absolutely.



---

archive/issue_comments_304576.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-02-13T14:29:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304576",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_304577.json:
```json
{
    "body": "OK, try this.",
    "created_at": "2017-02-13T14:30:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304577",
    "user": "@JohnCremona"
}
```

OK, try this.



---

archive/issue_comments_304578.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-02-13T14:30:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304578",
    "user": "@JohnCremona"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_304579.json:
```json
{
    "body": "Where are the eclib sources? Please put an obvious link in the ticket description.",
    "created_at": "2017-02-13T14:34:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304579",
    "user": "@jdemeyer"
}
```

Where are the eclib sources? Please put an obvious link in the ticket description.



---

archive/issue_comments_304580.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2017-02-13T14:34:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304580",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_304581.json:
```json
{
    "body": "Sorry!",
    "created_at": "2017-02-13T14:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304581",
    "user": "@JohnCremona"
}
```

Sorry!



---

archive/issue_comments_304582.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2017-02-13T14:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304582",
    "user": "@JohnCremona"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_304583.json:
```json
{
    "body": "Please add a doctest\n\n```\nsage: ECModularSymbol.__new__(ECModularSymbol)\nModular symbol with sign 0 over Rational Field attached to None\n```\n\nto show that this doesn't crash Sage.\n\nThe reason I ask this is that a non-trivial `__dealloc__` has potential to crash Sage if it makes assumptions which are not satisfied after `__new__`.\n\nHere, there is no problem because Cython initializes `self.nfs = NULL` in `__new__` and deleting a `NULL` pointer is safe.",
    "created_at": "2017-02-13T15:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304583",
    "user": "@jdemeyer"
}
```

Please add a doctest

```
sage: ECModularSymbol.__new__(ECModularSymbol)
Modular symbol with sign 0 over Rational Field attached to None
```

to show that this doesn't crash Sage.

The reason I ask this is that a non-trivial `__dealloc__` has potential to crash Sage if it makes assumptions which are not satisfied after `__new__`.

Here, there is no problem because Cython initializes `self.nfs = NULL` in `__new__` and deleting a `NULL` pointer is safe.



---

archive/issue_comments_304584.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-02-13T15:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304584",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_304585.json:
```json
{
    "body": "Apart from the doctest for `__new__`, this ticket looks good.",
    "created_at": "2017-02-13T15:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304585",
    "user": "@jdemeyer"
}
```

Apart from the doctest for `__new__`, this ticket looks good.



---

archive/issue_comments_304586.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-02-13T16:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304586",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_304587.json:
```json
{
    "body": "OK done.  I would never have thought of that...",
    "created_at": "2017-02-13T16:29:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304587",
    "user": "@JohnCremona"
}
```

OK done.  I would never have thought of that...



---

archive/issue_comments_304588.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-02-13T16:29:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304588",
    "user": "@JohnCremona"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_304589.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-02-14T09:32:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304589",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_304590.json:
```json
{
    "body": "On OSX I get:\n\n```\nsage -t --long src/sage/libs/eclib/newforms.pyx\n4157**********************************************************************\n4158File \"src/sage/libs/eclib/newforms.pyx\", line 135, in sage.libs.eclib.newforms.ECModularSymbol\n4159Failed example:\n4160    (mem2-mem < 1) or (mem2 - mem)\n4161Expected:\n4162    True\n4163Got:\n4164    2.0\n4165**********************************************************************\n41661 item had failures:\n4167   1 of  41 in sage.libs.eclib.newforms.ECModularSymbol\n4168    [96 tests, 1 failure, 60.32 s]\n4169\n```\n",
    "created_at": "2017-02-15T21:27:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304590",
    "user": "@vbraun"
}
```

On OSX I get:

```
sage -t --long src/sage/libs/eclib/newforms.pyx
4157**********************************************************************
4158File "src/sage/libs/eclib/newforms.pyx", line 135, in sage.libs.eclib.newforms.ECModularSymbol
4159Failed example:
4160    (mem2-mem < 1) or (mem2 - mem)
4161Expected:
4162    True
4163Got:
4164    2.0
4165**********************************************************************
41661 item had failures:
4167   1 of  41 in sage.libs.eclib.newforms.ECModularSymbol
4168    [96 tests, 1 failure, 60.32 s]
4169
```




---

archive/issue_comments_304591.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-02-15T21:27:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304591",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_304592.json:
```json
{
    "body": "I was afraid that something like this might happen. I suggest to either remove the test or implement [comment:35].",
    "created_at": "2017-02-15T21:42:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304592",
    "user": "@jdemeyer"
}
```

I was afraid that something like this might happen. I suggest to either remove the test or implement [comment:35].



---

archive/issue_comments_304593.json:
```json
{
    "body": "I have no way to test on OSX.  This number is going to vary a lot from machine to machine.  I only put in a test like this because an earlier reviewer wanted me to.  there is no significance at all to the memory difference except that it is less than with the old code, and there is no way to test that!\n\nI was going to suggest just removing this test, but I see that Jeroen is suggesting that his earlier proposal is implemented.  Well, I am not going to promise to do that since I am busy and it already took several days work actually fixing some leaks.",
    "created_at": "2017-02-15T21:45:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304593",
    "user": "@JohnCremona"
}
```

I have no way to test on OSX.  This number is going to vary a lot from machine to machine.  I only put in a test like this because an earlier reviewer wanted me to.  there is no significance at all to the memory difference except that it is less than with the old code, and there is no way to test that!

I was going to suggest just removing this test, but I see that Jeroen is suggesting that his earlier proposal is implemented.  Well, I am not going to promise to do that since I am busy and it already took several days work actually fixing some leaks.



---

archive/issue_comments_304594.json:
```json
{
    "body": "Replying to [comment:60 cremona]:\n> Jeroen is suggesting that his earlier proposal is implemented.\n\nPlease read my comment again carefully :-)",
    "created_at": "2017-02-16T06:44:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304594",
    "user": "@jdemeyer"
}
```

Replying to [comment:60 cremona]:
> Jeroen is suggesting that his earlier proposal is implemented.

Please read my comment again carefully :-)



---

archive/issue_comments_304595.json:
```json
{
    "body": "Yes, I spotted that.  I am not sure that Volker would be happy to have no doctest?\n\nIn fact a task I had to do today took less time than I expected so I can have a go at implementing the suggestion at 35 above.",
    "created_at": "2017-02-16T10:21:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304595",
    "user": "@JohnCremona"
}
```

Yes, I spotted that.  I am not sure that Volker would be happy to have no doctest?

In fact a task I had to do today took less time than I expected so I can have a go at implementing the suggestion at 35 above.



---

archive/issue_comments_304596.json:
```json
{
    "body": "This looks good.  AFter\n\n```\nsage: E = EllipticCurve([1,1,0,-108,-432])\nsage: def foo():\n....:     M = ECModularSymbol(E)\nsage: from sage.libs.eclib.newforms import ECModularSymbol\n```\n\nwe have\n\n```\nsage: print(get_memory_usage())\n136409.183594\nsage: for _ in range(30):\n....:     foo()\n....:     print(get_memory_usage())\n....:     \n136409.367188\n136409.367188\n136409.367188\n136409.367188\n136409.367188\n136409.367188\n136409.367188\n136409.367188\n136409.367188\n```\n\netc ad infinitum (or 30, whichever comes first).  This is a much better test since on anothe rmachine without the new version it looks like\n\n```\nsage: print(get_memory_usage())\n66302.7304688\nsage: for _ in range(30):\n....:     foo()\n....:     print(get_memory_usage())\n....:     \n66303.03125\n66303.3242188\n66303.6171875\n66303.9492188\n66304.2851562\n66304.6210938\n66304.9570312\n66305.2929688\n66305.6289062\n66305.9648438\n66306.3007812\n66306.6328125\n66306.96875\n66307.3046875\n66307.640625\n66307.9765625\n66308.3125\n66308.6484375\n66308.9804688\n66309.3164062\n66309.6523438\n66309.9882812\n66310.3242188\n66310.6601562\n66310.9960938\n66311.3320312\n66311.6640625\n66312.0\n66312.3359375\n66312.671875\n```\n\n\nThis suggest that in the doctest I should compare the memory usage after 1 and 10 calls rather than 0 and 10 as it is now.",
    "created_at": "2017-02-16T10:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304596",
    "user": "@JohnCremona"
}
```

This looks good.  AFter

```
sage: E = EllipticCurve([1,1,0,-108,-432])
sage: def foo():
....:     M = ECModularSymbol(E)
sage: from sage.libs.eclib.newforms import ECModularSymbol
```

we have

```
sage: print(get_memory_usage())
136409.183594
sage: for _ in range(30):
....:     foo()
....:     print(get_memory_usage())
....:     
136409.367188
136409.367188
136409.367188
136409.367188
136409.367188
136409.367188
136409.367188
136409.367188
136409.367188
```

etc ad infinitum (or 30, whichever comes first).  This is a much better test since on anothe rmachine without the new version it looks like

```
sage: print(get_memory_usage())
66302.7304688
sage: for _ in range(30):
....:     foo()
....:     print(get_memory_usage())
....:     
66303.03125
66303.3242188
66303.6171875
66303.9492188
66304.2851562
66304.6210938
66304.9570312
66305.2929688
66305.6289062
66305.9648438
66306.3007812
66306.6328125
66306.96875
66307.3046875
66307.640625
66307.9765625
66308.3125
66308.6484375
66308.9804688
66309.3164062
66309.6523438
66309.9882812
66310.3242188
66310.6601562
66310.9960938
66311.3320312
66311.6640625
66312.0
66312.3359375
66312.671875
```


This suggest that in the doctest I should compare the memory usage after 1 and 10 calls rather than 0 and 10 as it is now.



---

archive/issue_comments_304597.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-02-16T10:46:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304597",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_304598.json:
```json
{
    "body": "OK, here's a new version of the doctest.  It calls ECModularSymbol() twice before recording the first memory usage, then (as before) 10 more times before taking the second reading.  And to avoid comments about arbitrariness I test these for equality -- which works for me but is possibly too strict.\n\nPlease test again.",
    "created_at": "2017-02-16T10:48:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304598",
    "user": "@JohnCremona"
}
```

OK, here's a new version of the doctest.  It calls ECModularSymbol() twice before recording the first memory usage, then (as before) 10 more times before taking the second reading.  And to avoid comments about arbitrariness I test these for equality -- which works for me but is possibly too strict.

Please test again.



---

archive/issue_comments_304599.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-02-16T10:48:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304599",
    "user": "@JohnCremona"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_304600.json:
```json
{
    "body": "ping!",
    "created_at": "2017-03-10T20:27:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304600",
    "user": "@JohnCremona"
}
```

ping!



---

archive/issue_comments_304601.json:
```json
{
    "body": "Somehow I thought this ticket was already finished...",
    "created_at": "2017-03-10T21:36:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304601",
    "user": "@jdemeyer"
}
```

Somehow I thought this ticket was already finished...



---

archive/issue_comments_304602.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-03-14T18:29:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304602",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_304603.json:
```json
{
    "body": "You should mark all those memory tests as `# long time`.",
    "created_at": "2017-03-14T18:29:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304603",
    "user": "@jdemeyer"
}
```

You should mark all those memory tests as `# long time`.



---

archive/issue_comments_304604.json:
```json
{
    "body": "Replying to [comment:68 jdemeyer]:\n> You should mark all those memory tests as `# long time`.\n\nThe lines which take a long time are tagged # long time already!  So I suppose you mean the lines which call get_memory_usage() too?  That is hardly necessary, is it?",
    "created_at": "2017-03-14T19:29:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304604",
    "user": "@JohnCremona"
}
```

Replying to [comment:68 jdemeyer]:
> You should mark all those memory tests as `# long time`.

The lines which take a long time are tagged # long time already!  So I suppose you mean the lines which call get_memory_usage() too?  That is hardly necessary, is it?



---

archive/issue_comments_304605.json:
```json
{
    "body": "Replying to [comment:69 cremona]:\n> Replying to [comment:68 jdemeyer]:\n> > You should mark all those memory tests as `# long time`.\n> \n> The lines which take a long time are tagged # long time already!  So I suppose you mean the lines which call get_memory_usage() too?\n\nYes, I mostly mean the final line `(mem2==mem) or (mem2 - mem)`\n\n> That is hardly necessary, is it?\n\nTechnically you are right, but it looks strange to me to run the memory tests when you are *not* calling `ECModularSymbol(E)`. It is actually a bit dangerous since even running `mem = get_memory_usage()` might change the amount of memory allocated. So it would give me peace of mind to mark those tests as `# long time` too.",
    "created_at": "2017-03-14T19:49:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304605",
    "user": "@jdemeyer"
}
```

Replying to [comment:69 cremona]:
> Replying to [comment:68 jdemeyer]:
> > You should mark all those memory tests as `# long time`.
> 
> The lines which take a long time are tagged # long time already!  So I suppose you mean the lines which call get_memory_usage() too?

Yes, I mostly mean the final line `(mem2==mem) or (mem2 - mem)`

> That is hardly necessary, is it?

Technically you are right, but it looks strange to me to run the memory tests when you are *not* calling `ECModularSymbol(E)`. It is actually a bit dangerous since even running `mem = get_memory_usage()` might change the amount of memory allocated. So it would give me peace of mind to mark those tests as `# long time` too.



---

archive/issue_comments_304606.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-14T19:55:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304606",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_304607.json:
```json
{
    "body": "Done\n----\nNew commits:",
    "created_at": "2017-03-14T19:55:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304607",
    "user": "@JohnCremona"
}
```

Done
----
New commits:



---

archive/issue_comments_304608.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-03-14T19:55:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304608",
    "user": "@JohnCremona"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_304609.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-03-15T09:30:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304609",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_304610.json:
```json
{
    "body": "Sorry to spoil the party, but this regularly fails on OS X:\n\n```\nsage -t --long --warn-long 145.1 src/sage/libs/eclib/newforms.pyx\n**********************************************************************\nFile \"src/sage/libs/eclib/newforms.pyx\", line 137, in sage.libs.eclib.newforms.ECModularSymbol\nFailed example:\n    (mem2==mem) or (mem2 - mem)                 # long time\nExpected:\n    True\nGot:\n    1.0\n**********************************************************************\n1 item had failures:\n   1 of  42 in sage.libs.eclib.newforms.ECModularSymbol\n    [97 tests, 1 failure, 41.65 s]\nsage -t --long --warn-long 145.1 src/sage/libs/eclib/newforms.pyx\n    [97 tests, 41.31 s]\nsage -t --long --warn-long 145.1 src/sage/libs/eclib/newforms.pyx\n    [97 tests, 41.64 s]\nsage -t --long --warn-long 145.1 src/sage/libs/eclib/newforms.pyx\n**********************************************************************\nFile \"src/sage/libs/eclib/newforms.pyx\", line 137, in sage.libs.eclib.newforms.ECModularSymbol\nFailed example:\n    (mem2==mem) or (mem2 - mem)                 # long time\nExpected:\n    True\nGot:\n    2.0\n**********************************************************************\n1 item had failures:\n   1 of  42 in sage.libs.eclib.newforms.ECModularSymbol\n    [97 tests, 1 failure, 41.72 s]\nsage -t --long --warn-long 145.1 src/sage/libs/eclib/newforms.pyx\n**********************************************************************\nFile \"src/sage/libs/eclib/newforms.pyx\", line 137, in sage.libs.eclib.newforms.ECModularSymbol\nFailed example:\n    (mem2==mem) or (mem2 - mem)                 # long time\nExpected:\n    True\nGot:\n    17.0\n**********************************************************************\n1 item had failures:\n   1 of  42 in sage.libs.eclib.newforms.ECModularSymbol\n    [97 tests, 1 failure, 42.46 s]\n```\n",
    "created_at": "2017-03-15T09:30:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304610",
    "user": "@jdemeyer"
}
```

Sorry to spoil the party, but this regularly fails on OS X:

```
sage -t --long --warn-long 145.1 src/sage/libs/eclib/newforms.pyx
**********************************************************************
File "src/sage/libs/eclib/newforms.pyx", line 137, in sage.libs.eclib.newforms.ECModularSymbol
Failed example:
    (mem2==mem) or (mem2 - mem)                 # long time
Expected:
    True
Got:
    1.0
**********************************************************************
1 item had failures:
   1 of  42 in sage.libs.eclib.newforms.ECModularSymbol
    [97 tests, 1 failure, 41.65 s]
sage -t --long --warn-long 145.1 src/sage/libs/eclib/newforms.pyx
    [97 tests, 41.31 s]
sage -t --long --warn-long 145.1 src/sage/libs/eclib/newforms.pyx
    [97 tests, 41.64 s]
sage -t --long --warn-long 145.1 src/sage/libs/eclib/newforms.pyx
**********************************************************************
File "src/sage/libs/eclib/newforms.pyx", line 137, in sage.libs.eclib.newforms.ECModularSymbol
Failed example:
    (mem2==mem) or (mem2 - mem)                 # long time
Expected:
    True
Got:
    2.0
**********************************************************************
1 item had failures:
   1 of  42 in sage.libs.eclib.newforms.ECModularSymbol
    [97 tests, 1 failure, 41.72 s]
sage -t --long --warn-long 145.1 src/sage/libs/eclib/newforms.pyx
**********************************************************************
File "src/sage/libs/eclib/newforms.pyx", line 137, in sage.libs.eclib.newforms.ECModularSymbol
Failed example:
    (mem2==mem) or (mem2 - mem)                 # long time
Expected:
    True
Got:
    17.0
**********************************************************************
1 item had failures:
   1 of  42 in sage.libs.eclib.newforms.ECModularSymbol
    [97 tests, 1 failure, 42.46 s]
```




---

archive/issue_comments_304611.json:
```json
{
    "body": "What a pain.  I don't use Macs.  I do not test eclib on Macs.  If someone told me tomorrow that eclib does no longer work on some Mac system I would do absolutely nothing about it except possibly to put a warning into its documentation and wait for someone else to fix it.  Ditto cygwin.  Ditto clang, whatever that is.\n\nIt took quite a long time to track down the leak and fix it.  It has taken far longer to write a doctest which keeps people happier -- still not finished with that.  It is *obvious* that the memory used will be machine dependent, hance *stupid* to have a doctest which relies on some measure of memory.  The only sensible measure is to compare the amount of memroy in use before and after the patch, one the same machine, and the doctesting system cannot do that.\n\nPlease can we delete this doctest entirely?  It is in any case not testing that part of Sage works, only that part  of one of its dependencies does.  If that would get this into 7.6 that would be worth something.\n\nI will delete the doctest.  That is absolutely the last contribution I will make to this ticket.",
    "created_at": "2017-03-15T10:35:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304611",
    "user": "@JohnCremona"
}
```

What a pain.  I don't use Macs.  I do not test eclib on Macs.  If someone told me tomorrow that eclib does no longer work on some Mac system I would do absolutely nothing about it except possibly to put a warning into its documentation and wait for someone else to fix it.  Ditto cygwin.  Ditto clang, whatever that is.

It took quite a long time to track down the leak and fix it.  It has taken far longer to write a doctest which keeps people happier -- still not finished with that.  It is *obvious* that the memory used will be machine dependent, hance *stupid* to have a doctest which relies on some measure of memory.  The only sensible measure is to compare the amount of memroy in use before and after the patch, one the same machine, and the doctesting system cannot do that.

Please can we delete this doctest entirely?  It is in any case not testing that part of Sage works, only that part  of one of its dependencies does.  If that would get this into 7.6 that would be worth something.

I will delete the doctest.  That is absolutely the last contribution I will make to this ticket.



---

archive/issue_comments_304612.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-15T10:39:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304612",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_304613.json:
```json
{
    "body": "Replying to [comment:74 cremona]:\n> The only sensible measure is to compare the amount of memroy in use before and after the patch, one the same machine\n\nThat's not true. There are robust ways to test memory leaks, see [comment:35]. Of course, it's more work, but it can be done. Maybe we should have some Sage infrastructure for this, say `test_memory_leak(func)` for a function `func`.\n\n> I will delete the doctest.\n\nFine for me. It will allow this ticket to finally move forward.",
    "created_at": "2017-03-15T11:29:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304613",
    "user": "@jdemeyer"
}
```

Replying to [comment:74 cremona]:
> The only sensible measure is to compare the amount of memroy in use before and after the patch, one the same machine

That's not true. There are robust ways to test memory leaks, see [comment:35]. Of course, it's more work, but it can be done. Maybe we should have some Sage infrastructure for this, say `test_memory_leak(func)` for a function `func`.

> I will delete the doctest.

Fine for me. It will allow this ticket to finally move forward.



---

archive/issue_comments_304614.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-03-15T12:00:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304614",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_304615.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-03-27T20:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21927#issuecomment-304615",
    "user": "@vbraun"
}
```

Resolution: fixed
