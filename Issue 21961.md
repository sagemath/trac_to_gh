# Issue 21961: make cypari2 Python2 / Python3 compatible

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2017-01-17 18:09:13

CC:  defeo jdemeyer

Currently string handling in `cypari2` is done via `PyString_AsString` which does not exist in Python 3. We rely on Cython to make proper conversions to `bytes`.


---

Comment by vdelecroix created at 2017-01-17 23:52:39

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2017-01-17 23:52:39

Last 10 new commits:


---

Comment by jdemeyer created at 2017-01-18 11:53:57

Did you actually check that Python 3 works with this patch?


---

Comment by vdelecroix created at 2017-01-18 11:56:08

How can I do that?!

At least it works in cypari2 with commit [88bf24e](https://github.com/defeo/cypari2/commit/88bf24e073c1cd76b1ca197cb6079895f47ac7c6).


---

Comment by jdemeyer created at 2017-01-18 16:38:08

This is a much simpler version, relying on Cython to convert `str` -> `bytes`.
----
New commits:


---

Comment by jdemeyer created at 2017-01-18 17:29:39

Note: Cython converts Unicode strings to `bytes` by using `sys.getdefaultencoding()` which seems like a reasonable thing to do. In Python 2, this encoding is ASCII by default, in Python 3 it is UTF-8 by default.


---

Comment by vdelecroix created at 2017-01-19 09:50:46

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2017-01-19 09:50:46

For me it compiles but does not work in Python 3

```
>>> import cypari2
>>> pari = cypari2.Pari()
>>> pari("zeta(2)")
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "cypari2/pari_instance.pyx", line 831, in cypari2.pari_instance.Pari.__call__ (cypari2/pari_instance.c:13408)
  File "cypari2/gen.pyx", line 4534, in cypari2.gen.objtogen (cypari2/gen.c:128337)
TypeError: expected bytes, str found
```



---

Comment by vdelecroix created at 2017-01-19 10:23:13

Actually, in Cython for Python 3 given a string `s` the conversion

```
<bytes> s
```

does not do anything!! (tested with Cython version 0.25.2)


---

Comment by vdelecroix created at 2017-01-19 12:11:35

In your patch, `bytes` do not get catch in Python 3.


---

Comment by jdemeyer created at 2017-01-19 13:01:08

`<bytes>s` is *not* a conversion, it's a cast! So yes, it doesn't "do" anything and that's a feature.


---

Comment by vdelecroix created at 2017-01-19 14:45:22

With your patch, unicode are also not treated correctly (see [comment:7]).


---

Comment by vdelecroix created at 2017-01-19 15:59:07

And conversion does fail

```
Python 3.5.2
>>> bytes("hello")
Traceback (most recent call last):
...
TypeError: string argument without an encoding
```

I don't understand where the default encoding that you mentioned in [comment:6] is intended to happen.

EDIT: this command fails in the same way in Cython


---

Comment by jdemeyer created at 2017-01-19 16:40:22

The default encoding is something Cython-specific when passing `unicode` or `bytes` to C as a `char*`. It's not about converting within Python from `unicode` to `bytes`.


---

Comment by vdelecroix created at 2017-01-19 16:44:29

Replying to [comment:13 jdemeyer]:
> The default encoding is something Cython-specific when passing `unicode` or `bytes` to C as a `char*`. It's not about converting within Python from `unicode` to `bytes`.

I know and I already mentioned it in [comment:12]: the code behaves the same when compiled in Cython. You can check with

```
Python 3.5.2
>>> import cython
>>> cython.inline('bytes("hello")')
Traceback (most recent call last):
...
TypeError: string argument without an encoding
```



---

Comment by jdemeyer created at 2017-01-19 16:50:45

Replying to [comment:14 vdelecroix]:
> I know and I already mentioned it in [comment:12]: the code behaves the same when compiled in Cython.

Yes, and I already mentioned that it's _not_ about `bytes(foo)`, it's about passing `foo` as a `char*` to C.


---

Comment by git created at 2017-01-19 22:49:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-01-19 22:50:30

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-01-19 22:50:30

Does this work?


---

Comment by vdelecroix created at 2017-01-20 09:52:17

I don't think so: `bytes` and `basestring` are disjoint in Python 3. Let me try.


---

Comment by vdelecroix created at 2017-01-20 10:06:58

Actually it fails at compilation

```
ImportError: Building module cython_string failed: ['LookupError: unknown encoding: default\n']
```

The encoding used seems to be the encoding of the file, not of the system. Adding `# encoding: utf-8` at the top of the file make it works.


---

Attachment


---

Comment by vdelecroix created at 2017-01-20 12:20:04

Replying to [comment:19 vdelecroix]:
> I don't think so: `bytes` and `basestring` are disjoint in Python 3. Let me try.

Indeed

```
Python 3.5.2
>>> import cypari2
>>> pari = cypari2.Pari()
>>> pari(b"zeta(2)")
Traceback (most recent call last):
...
PariError: syntax error, unexpected variable name, expecting $end
```



---

Comment by vdelecroix created at 2017-01-20 12:25:53

New commits:


---

Comment by git created at 2017-01-20 12:26:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2017-01-20 12:26:49

please see my last commit 6c55c78 that does work in the standalone cypari.


---

Comment by vdelecroix created at 2017-01-20 13:39:07

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2017-01-21 13:19:33

Changing status from positive_review to needs_review.


---

Comment by jdemeyer created at 2017-01-21 13:19:33

Does this work too? It's a slightly more efficient version of your code.
----
New commits:


---

Comment by vdelecroix created at 2017-01-27 15:40:33

It does.


---

Comment by jdemeyer created at 2017-01-27 15:43:40

Positive review then?


---

Comment by vdelecroix created at 2017-01-27 15:45:11

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-01-29 12:04:46

Resolution: fixed
