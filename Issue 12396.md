# Issue 12396: make doesn't work properly for targets 'test' and 'micro_release'

archive/issues_012396.json:
```json
{
    "body": "Assignee: GeorgSWeber\n\nKeywords: make test micro_release\n\nI am using sage 4.8 with GNU make 3.81. When I am in `SAGE_ROOT`, if I type the commands `make test` or `make micro_release`, the shell returns an error. For `make micro_release`, the it returns the following output:\n\n```\n. local/bin/sage-env && local/bin/sage-micro_release\nlocal/bin/sage-env: 289: Bad substitution\nmkdir: cannot create directory `//matplotlib-1.0.1': Permission denied\nlocal/bin/sage-env: 475: Syntax error: \"(\" unexpected\nmake: *** [micro_release] Error 2\n```\n\nFor `make test`, it returns a longer output which ends with:\n\n```\n. local/bin/sage-env && sage-maketest\nlocal/bin/sage-env: 289: Bad substitution\nmkdir: cannot create directory `//matplotlib-1.0.1': Permission denied\nlocal/bin/sage-env: 475: Syntax error: \"(\" unexpected\nmake: *** [test] Error 2\n```\n\nThe problem appears to be because make runs each command as a sh script, but that sage-env is a bash script. A similar error message appears if I type `. local/bin/sage-env` in interactive sh.\n\nIssue created by migration from https://trac.sagemath.org/ticket/12568\n\n",
    "created_at": "2012-02-23T02:46:01Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "title": "make doesn't work properly for targets 'test' and 'micro_release'",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12396",
    "user": "itaibn"
}
```
Assignee: GeorgSWeber

Keywords: make test micro_release

I am using sage 4.8 with GNU make 3.81. When I am in `SAGE_ROOT`, if I type the commands `make test` or `make micro_release`, the shell returns an error. For `make micro_release`, the it returns the following output:

```
. local/bin/sage-env && local/bin/sage-micro_release
local/bin/sage-env: 289: Bad substitution
mkdir: cannot create directory `//matplotlib-1.0.1': Permission denied
local/bin/sage-env: 475: Syntax error: "(" unexpected
make: *** [micro_release] Error 2
```

For `make test`, it returns a longer output which ends with:

```
. local/bin/sage-env && sage-maketest
local/bin/sage-env: 289: Bad substitution
mkdir: cannot create directory `//matplotlib-1.0.1': Permission denied
local/bin/sage-env: 475: Syntax error: "(" unexpected
make: *** [test] Error 2
```

The problem appears to be because make runs each command as a sh script, but that sage-env is a bash script. A similar error message appears if I type `. local/bin/sage-env` in interactive sh.

Issue created by migration from https://trac.sagemath.org/ticket/12568





---

archive/issue_comments_146363.json:
```json
{
    "body": "A patch which fixes the bug",
    "created_at": "2012-02-23T21:38:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12396#issuecomment-146363",
    "user": "itaibn"
}
```

A patch which fixes the bug



---

archive/issue_comments_146364.json:
```json
{
    "body": "Attachment\n\nI should have done this a while ago since I already have a patch.",
    "created_at": "2012-02-27T22:47:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12396#issuecomment-146364",
    "user": "itaibn"
}
```

Attachment

I should have done this a while ago since I already have a patch.



---

archive/issue_comments_146365.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-02-27T22:47:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12396#issuecomment-146365",
    "user": "itaibn"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_146366.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-03-30T07:32:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12396#issuecomment-146366",
    "user": "jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_146367.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-03-30T07:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12396#issuecomment-146367",
    "user": "jpflori"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_146368.json:
```json
{
    "body": "I was a little too fast on this.\nAre we sure that bash will be installed on every system sage supports (and is it a sage dependency) ?\nI fear that explicitely calling bash might fail even if a compatible shell is installed.\n\nI think a better solution would be modify the sage-env header to something like \"#! /usr/bin/env bash\".\nBy the way, this file should be executable.",
    "created_at": "2012-03-30T07:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12396#issuecomment-146368",
    "user": "jpflori"
}
```

I was a little too fast on this.
Are we sure that bash will be installed on every system sage supports (and is it a sage dependency) ?
I fear that explicitely calling bash might fail even if a compatible shell is installed.

I think a better solution would be modify the sage-env header to something like "#! /usr/bin/env bash".
By the way, this file should be executable.



---

archive/issue_comments_146369.json:
```json
{
    "body": "Moreover the sage-env script is in the spkg/bin directory and not in the local/bin one (edit: this is a recent change #11073).\n\nFinally the micro_release target segfault on my machine...",
    "created_at": "2012-03-30T08:02:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12396#issuecomment-146369",
    "user": "jpflori"
}
```

Moreover the sage-env script is in the spkg/bin directory and not in the local/bin one (edit: this is a recent change #11073).

Finally the micro_release target segfault on my machine...



---

archive/issue_comments_146370.json:
```json
{
    "body": "I propose to let the test target behave like the other ones, i.e. call \"sage -t ...\" (in the end it calls sage-maketest anyway, but at least sage-env is properly called by the sage script).\n\nFor the micro_release one, I'm not sure we can do much better than the solution Itai proposed without calling sage-micro_release from the sage script to properly set SAGE_ROOT (i.e. through an option or something like that).",
    "created_at": "2012-03-30T08:41:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12396#issuecomment-146370",
    "user": "jpflori"
}
```

I propose to let the test target behave like the other ones, i.e. call "sage -t ..." (in the end it calls sage-maketest anyway, but at least sage-env is properly called by the sage script).

For the micro_release one, I'm not sure we can do much better than the solution Itai proposed without calling sage-micro_release from the sage script to properly set SAGE_ROOT (i.e. through an option or something like that).



---

archive/issue_comments_146371.json:
```json
{
    "body": "Not sure why make micro_release now and not before...\nIt does so while trying to strip libpython which is expected: http://trac.sagemath.org/sage_trac/ticket/11743#comment:3\n\nWhat's more mysterious is why it tries to strip libpython now.\nIt was updated to 2.7 in the 5.0 series but is still readonly.\n\nIn fact it did already segfault with 4.8.\nIt's just that because I used system atlas libs with my 4.8 install, it did fail before.",
    "created_at": "2012-03-30T09:10:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12396#issuecomment-146371",
    "user": "jpflori"
}
```

Not sure why make micro_release now and not before...
It does so while trying to strip libpython which is expected: http://trac.sagemath.org/sage_trac/ticket/11743#comment:3

What's more mysterious is why it tries to strip libpython now.
It was updated to 2.7 in the 5.0 series but is still readonly.

In fact it did already segfault with 4.8.
It's just that because I used system atlas libs with my 4.8 install, it did fail before.



---

archive/issue_comments_146372.json:
```json
{
    "body": "My bad once more.\nsage-env is only meant to be sourced (and only once) and should not be executable: #10469",
    "created_at": "2012-03-30T09:15:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12396#issuecomment-146372",
    "user": "jpflori"
}
```

My bad once more.
sage-env is only meant to be sourced (and only once) and should not be executable: #10469



---

archive/issue_comments_146373.json:
```json
{
    "body": "Ok here is a slightly reworked patch making the test target like the other ones.",
    "created_at": "2012-03-30T09:41:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12396#issuecomment-146373",
    "user": "jpflori"
}
```

Ok here is a slightly reworked patch making the test target like the other ones.



---

archive/issue_comments_146374.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-03-30T09:42:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12396#issuecomment-146374",
    "user": "jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_146375.json:
```json
{
    "body": "1. Obviously, `/usr/bin/env bash` should be simply `bash`.\n\n2. Then, if you don't use `sage-maketest` anymore (which is probably a good thing), remove the `sage-maketest` script.",
    "created_at": "2012-04-13T08:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12396#issuecomment-146375",
    "user": "jdemeyer"
}
```

1. Obviously, `/usr/bin/env bash` should be simply `bash`.

2. Then, if you don't use `sage-maketest` anymore (which is probably a good thing), remove the `sage-maketest` script.



---

archive/issue_comments_146376.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-04-13T08:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12396#issuecomment-146376",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_146377.json:
```json
{
    "body": "I think the sage-maketest script is used when you call \"sage -testall\" which is called by some make targets so is still necessary.",
    "created_at": "2012-04-13T08:08:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12396#issuecomment-146377",
    "user": "jpflori"
}
```

I think the sage-maketest script is used when you call "sage -testall" which is called by some make targets so is still necessary.



---

archive/issue_comments_146378.json:
```json
{
    "body": "Attachment\n\nReviewer patch; rebase on 5.0 series",
    "created_at": "2012-04-13T08:11:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12396#issuecomment-146378",
    "user": "jpflori"
}
```

Attachment

Reviewer patch; rebase on 5.0 series



---

archive/issue_comments_146379.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-04-13T08:12:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12396#issuecomment-146379",
    "user": "jpflori"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_146380.json:
```json
{
    "body": "In fact the testall option is not present in the make targets, but is defined and documented by spkg/bin/sage.\nAnyway, I don't think here is the place to remove it.",
    "created_at": "2012-04-13T08:15:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12396#issuecomment-146380",
    "user": "jpflori"
}
```

In fact the testall option is not present in the make targets, but is defined and documented by spkg/bin/sage.
Anyway, I don't think here is the place to remove it.



---

archive/issue_comments_146381.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-04-13T08:49:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12396#issuecomment-146381",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_146382.json:
```json
{
    "body": "`make micro_release` is indeed broken.  It's not surprising, as it changes the python library while `python` is running:\n\n```\nstrip \"/tmp/local/sage/local/lib/libpython2.7.so\"\nbash: line 1:  5817 Segmentation fault      local/bin/sage-micro_release\n```\n\nbut that's not relevant for this ticket.\n\nEverything else seems to work, so positive_review.",
    "created_at": "2012-04-13T08:49:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12396#issuecomment-146382",
    "user": "jdemeyer"
}
```

`make micro_release` is indeed broken.  It's not surprising, as it changes the python library while `python` is running:

```
strip "/tmp/local/sage/local/lib/libpython2.7.so"
bash: line 1:  5817 Segmentation fault      local/bin/sage-micro_release
```

but that's not relevant for this ticket.

Everything else seems to work, so positive_review.



---

archive/issue_comments_146383.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-04-19T06:42:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12396",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12396#issuecomment-146383",
    "user": "jdemeyer"
}
```

Resolution: fixed
