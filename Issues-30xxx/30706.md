# Issue 30706: Make sage.env.cython_aliases more flexible regarding what pkgconfig files for BLAS are required

archive/issues_030469.json:
```json
{
    "body": "While working on #30371, I noticed that `cblas` is not available for Ubuntu 18.04. In fact, `libblas-dev` contains a `README.if-you-look-for-libcblas` with the following content:\n\n```\n    Debian science team maintainers have merged the CBLAS ABI into\n    the libblas.so shared object. Everything you need from libcblas.so\n    can be found in libblas.so . Please link your program against it\n    instead. See also\n\n      https://lists.debian.org/debian-devel/2019/10/msg00273.html\n      https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=943712\n      https://wiki.debian.org/DebianScience/LinearAlgebraLibraries\n```\n\nSo this ticket adds support for other BLAS libraries (openplas, blas) that the user may have installed.\n\nCC:  @mkoeppe @dimpase @kiwifb @antonio-rojas @isuruf\n\nKeywords: cblas, blas\n\nBranch/Commit: 9c8641a7f6d277c969d41506d55b7cc4cc04ef8d\n\nReviewer: Matthias Koeppe, Dima Pasechnik\n\nAuthor: Tobias Diez, Matthias Koeppe\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30706\n\n",
    "closed_at": "2020-11-20T22:15:06Z",
    "created_at": "2020-10-03T19:40:36Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Make sage.env.cython_aliases more flexible regarding what pkgconfig files for BLAS are required",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30706",
    "user": "https://github.com/tobiasdiez"
}
```
While working on #30371, I noticed that `cblas` is not available for Ubuntu 18.04. In fact, `libblas-dev` contains a `README.if-you-look-for-libcblas` with the following content:

```
    Debian science team maintainers have merged the CBLAS ABI into
    the libblas.so shared object. Everything you need from libcblas.so
    can be found in libblas.so . Please link your program against it
    instead. See also

      https://lists.debian.org/debian-devel/2019/10/msg00273.html
      https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=943712
      https://wiki.debian.org/DebianScience/LinearAlgebraLibraries
```

So this ticket adds support for other BLAS libraries (openplas, blas) that the user may have installed.

CC:  @mkoeppe @dimpase @kiwifb @antonio-rojas @isuruf

Keywords: cblas, blas

Branch/Commit: 9c8641a7f6d277c969d41506d55b7cc4cc04ef8d

Reviewer: Matthias Koeppe, Dima Pasechnik

Author: Tobias Diez, Matthias Koeppe

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/30706





---

archive/issue_comments_608340.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2020-10-03T19:42:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608340",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_608341.json:
```json
{
    "body": "<a id='comment:2'></a>\n\n```\n$ cat build/pkgs/openblas/distros/debian.txt \nlibopenblas-dev\n```",
    "created_at": "2020-10-03T19:43:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608341",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>

```
$ cat build/pkgs/openblas/distros/debian.txt 
libopenblas-dev
```



---

archive/issue_comments_608342.json:
```json
{
    "body": "<a id='comment:3'></a>\nAlso with `openblas` the issue remains, as it adds a `blas.pc` file in `usr/lib/.../pkgconfig` and thus is not found via `-l cblas`. Or do I miss something?",
    "created_at": "2020-10-03T20:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608342",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:3'></a>
Also with `openblas` the issue remains, as it adds a `blas.pc` file in `usr/lib/.../pkgconfig` and thus is not found via `-l cblas`. Or do I miss something?



---

archive/issue_comments_608343.json:
```json
{
    "body": "<a id='comment:4'></a>\nAre you saying that the .pc files installed on your Ubuntu system are broken?",
    "created_at": "2020-10-03T20:26:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608343",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>
Are you saying that the .pc files installed on your Ubuntu system are broken?



---

archive/issue_comments_608344.json:
```json
{
    "body": "<a id='comment:5'></a>\nI wouldn't say broken, but there is no `cblas.pc` file (but a `blas.pc`) which is why the check in `env.py` was not successful without the committed change.",
    "created_at": "2020-10-03T20:42:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608344",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:5'></a>
I wouldn't say broken, but there is no `cblas.pc` file (but a `blas.pc`) which is why the check in `env.py` was not successful without the committed change.



---

archive/issue_comments_608345.json:
```json
{
    "body": "<a id='comment:6'></a>\nSupporting BLAS on various platforms is really tricky. See `build/pkgs/openblas/spkg-configure.m4`. To interface with system BLAS, in some configurations we create `.pc` files in `$SAGE_LOCAL`. If you don't run `./configure` and `make`, you won't have those.",
    "created_at": "2020-10-03T20:50:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608345",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>
Supporting BLAS on various platforms is really tricky. See `build/pkgs/openblas/spkg-configure.m4`. To interface with system BLAS, in some configurations we create `.pc` files in `$SAGE_LOCAL`. If you don't run `./configure` and `make`, you won't have those.



---

archive/issue_comments_608346.json:
```json
{
    "body": "<a id='comment:7'></a>\nWell, the editable install in #30371 uses only system-wide installed libraries, so things in `SAGE_LOCAL` don't matter (or do you suggest to set `SAGE_LOCAL` to say `usr` before calling configure?).\n\nWould it work to take in `env.py` the first of the libraries `openblas cblas blas` that is found using `pkgconfig.parse`?",
    "created_at": "2020-10-03T21:27:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608346",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:7'></a>
Well, the editable install in #30371 uses only system-wide installed libraries, so things in `SAGE_LOCAL` don't matter (or do you suggest to set `SAGE_LOCAL` to say `usr` before calling configure?).

Would it work to take in `env.py` the first of the libraries `openblas cblas blas` that is found using `pkgconfig.parse`?



---

archive/issue_comments_608347.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [gh-tobiasdiez](#comment%3A7):\n> Well, the editable install in #30371 uses only system-wide installed libraries, so things in `SAGE_LOCAL` don't matter\n\n\nAs I said in #30371, I think it's best to keep the focus narrow -- make #30371 work completely (i.e., pass doctests) when run from within `./sage -sh` so that `$SAGE_LOCAL` is set to a working installation of the Sage distribution.  \n\nOf course I do understand that currently technical problems prevent you from completing the build.\n\nStill, `make -k` can build everything until you get the error with the pip package or whatever is failing. Then for example the .pc files will be available.\n\n> Would it work to take in `env.py` the first of the libraries `openblas cblas blas` that is found using `pkgconfig.parse`?\n\n\nSomething like this might work.\n\nMaking `sage.env.cython_aliases` more flexible is a good approach, I would think.\n\nNote that this will need thorough testing across the supported platforms.",
    "created_at": "2020-10-03T21:42:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608347",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>
Replying to [gh-tobiasdiez](#comment%3A7):
> Well, the editable install in #30371 uses only system-wide installed libraries, so things in `SAGE_LOCAL` don't matter


As I said in #30371, I think it's best to keep the focus narrow -- make #30371 work completely (i.e., pass doctests) when run from within `./sage -sh` so that `$SAGE_LOCAL` is set to a working installation of the Sage distribution.  

Of course I do understand that currently technical problems prevent you from completing the build.

Still, `make -k` can build everything until you get the error with the pip package or whatever is failing. Then for example the .pc files will be available.

> Would it work to take in `env.py` the first of the libraries `openblas cblas blas` that is found using `pkgconfig.parse`?


Something like this might work.

Making `sage.env.cython_aliases` more flexible is a good approach, I would think.

Note that this will need thorough testing across the supported platforms.



---

archive/issue_events_090121.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "rename": {
        "from": "Migrate from cblas to blas",
        "to": "Make sage.env.cython_aliases more flexible regarding what pkgconfig files for BLAS are required"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30706#event-90121"
}
```



---

archive/issue_comments_608348.json:
```json
{
    "body": "<a id='comment:10'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                  |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|\n|[3cfe1c9](https://github.com/sagemath/sagetrac-mirror/commit/3cfe1c92ef838e8be27794355c05769f0fd1c8b4)|`Merge branch 'develop' of git://github.com/sagemath/sage into public/build/cblas`|\n|[ea4a44c](https://github.com/sagemath/sagetrac-mirror/commit/ea4a44cefcbc6a82efab8a8b7809f40e28bf0773)|`Support different blas libraries`|",
    "created_at": "2020-10-19T20:30:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608348",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                  |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|
|[3cfe1c9](https://github.com/sagemath/sagetrac-mirror/commit/3cfe1c92ef838e8be27794355c05769f0fd1c8b4)|`Merge branch 'develop' of git://github.com/sagemath/sage into public/build/cblas`|
|[ea4a44c](https://github.com/sagemath/sagetrac-mirror/commit/ea4a44cefcbc6a82efab8a8b7809f40e28bf0773)|`Support different blas libraries`|



---

archive/issue_comments_608349.json:
```json
{
    "body": "Changing commit from \"23d17ad3f89536404bce4cb25c20ff0fde2b193b\" to \"ea4a44cefcbc6a82efab8a8b7809f40e28bf0773\"",
    "created_at": "2020-10-19T20:30:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608349",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "23d17ad3f89536404bce4cb25c20ff0fde2b193b" to "ea4a44cefcbc6a82efab8a8b7809f40e28bf0773"



---

archive/issue_comments_608350.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2020-10-19T20:32:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608350",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_608351.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-While working on #30371, I noticed that cblas is not available for Ubuntu 18.04. In fact, `libblas-dev` contains a `README.if-you-look-for-libcblas` with the following content:\n+While working on #30371, I noticed that `cblas` is not available for Ubuntu 18.04. In fact, `libblas-dev` contains a `README.if-you-look-for-libcblas` with the following content:\n \n ```\n     Debian science team maintainers have merged the CBLAS ABI into\n@@ -11,4 +11,4 @@\n       https://wiki.debian.org/DebianScience/LinearAlgebraLibraries\n ```\n \n-So I suggest to migrate/rename cblas to blas. The currently submitted changes worked for an editable install, but they might lead to issues with the build process. So advice how to properly do this migration is  welcome; in fact, feel free to hijack this ticket and push the necessary changes directly.\n+So this ticket adds support for other BLAS libraries (openplas, blas) that the user may have installed.\n``````\n",
    "created_at": "2020-10-19T20:32:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608351",
    "user": "https://github.com/tobiasdiez"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-While working on #30371, I noticed that cblas is not available for Ubuntu 18.04. In fact, `libblas-dev` contains a `README.if-you-look-for-libcblas` with the following content:
+While working on #30371, I noticed that `cblas` is not available for Ubuntu 18.04. In fact, `libblas-dev` contains a `README.if-you-look-for-libcblas` with the following content:
 
 ```
     Debian science team maintainers have merged the CBLAS ABI into
@@ -11,4 +11,4 @@
       https://wiki.debian.org/DebianScience/LinearAlgebraLibraries
 ```
 
-So I suggest to migrate/rename cblas to blas. The currently submitted changes worked for an editable install, but they might lead to issues with the build process. So advice how to properly do this migration is  welcome; in fact, feel free to hijack this ticket and push the necessary changes directly.
+So this ticket adds support for other BLAS libraries (openplas, blas) that the user may have installed.
``````




---

archive/issue_comments_608352.json:
```json
{
    "body": "<a id='comment:11'></a>\nI've now added support for openblas and blas as well. So, this ticket is now ready for review.",
    "created_at": "2020-10-19T20:32:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608352",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:11'></a>
I've now added support for openblas and blas as well. So, this ticket is now ready for review.



---

archive/issue_events_090122.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-19T21:09:34Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30706#event-90122"
}
```



---

archive/issue_comments_608353.json:
```json
{
    "body": "Changing author from \"\" to \"Tobias Diez\"",
    "created_at": "2020-10-19T21:09:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608353",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Tobias Diez"



---

archive/issue_comments_608354.json:
```json
{
    "body": "<a id='comment:13'></a>\nThis is going in a good direction but it might conflict with the Sage distribution's support of selecting ATLAS instead of OpenBLAS in `configure`. We can't just go and prefer the openblas.pc without adding a configuration variable that preserves this option.",
    "created_at": "2020-10-19T22:19:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608354",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>
This is going in a good direction but it might conflict with the Sage distribution's support of selecting ATLAS instead of OpenBLAS in `configure`. We can't just go and prefer the openblas.pc without adding a configuration variable that preserves this option.



---

archive/issue_comments_608355.json:
```json
{
    "body": "<a id='comment:14'></a>\nI agree. Preference order should be overridable. You may very well want to build the whole sage with a different blas/lapack stack. What goes in env.py should be able to match whatever you build all the other sage dependencies with, regardless of the presence of openblas.pc.\n\nIf anything has to go first without override, I would prefer cblas or blas. This is a generic name and you could override things by providing a .pc in an appropriate PKG_CONFIG_PATH.",
    "created_at": "2020-10-19T22:32:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608355",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:14'></a>
I agree. Preference order should be overridable. You may very well want to build the whole sage with a different blas/lapack stack. What goes in env.py should be able to match whatever you build all the other sage dependencies with, regardless of the presence of openblas.pc.

If anything has to go first without override, I would prefer cblas or blas. This is a generic name and you could override things by providing a .pc in an appropriate PKG_CONFIG_PATH.



---

archive/issue_comments_608356.json:
```json
{
    "body": "<a id='comment:15'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                 |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------|\n|[75966fc](https://github.com/sagemath/sagetrac-mirror/commit/75966fc0c32ffc918ff7a0cad60b7381f9b3fef5)|`Put cblas first`|",
    "created_at": "2020-10-19T22:36:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608356",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                 |
|-------------------------------------------------------------------------------------------------------------------------------------------|-----------------|
|[75966fc](https://github.com/sagemath/sagetrac-mirror/commit/75966fc0c32ffc918ff7a0cad60b7381f9b3fef5)|`Put cblas first`|



---

archive/issue_comments_608357.json:
```json
{
    "body": "Changing commit from \"ea4a44cefcbc6a82efab8a8b7809f40e28bf0773\" to \"75966fc0c32ffc918ff7a0cad60b7381f9b3fef5\"",
    "created_at": "2020-10-19T22:36:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608357",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "ea4a44cefcbc6a82efab8a8b7809f40e28bf0773" to "75966fc0c32ffc918ff7a0cad60b7381f9b3fef5"



---

archive/issue_comments_608358.json:
```json
{
    "body": "<a id='comment:16'></a>\nThanks for the feedback. I wasn't sure about the order myself. I've now changed it to have `cblas` first. So if this package is installed (or a corresponding `pc` file is present), then you get the current behavior. Only in the case it's not installed we fall back to openblas.\n\nI would leave the config option for another ticket.",
    "created_at": "2020-10-19T22:40:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608358",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:16'></a>
Thanks for the feedback. I wasn't sure about the order myself. I've now changed it to have `cblas` first. So if this package is installed (or a corresponding `pc` file is present), then you get the current behavior. Only in the case it's not installed we fall back to openblas.

I would leave the config option for another ticket.



---

archive/issue_comments_608359.json:
```json
{
    "body": "<a id='comment:17'></a>\nI'll note that my patch to giac's autotools is going to be in sage 9.2 and it uses lapack.pc and blas.pc. I am bringing up giac because I am currently trying the remove `libdir` from RUNPATH in libgiac because it messes up which blas/lapack is loaded in Gentoo.",
    "created_at": "2020-10-19T23:50:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608359",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:17'></a>
I'll note that my patch to giac's autotools is going to be in sage 9.2 and it uses lapack.pc and blas.pc. I am bringing up giac because I am currently trying the remove `libdir` from RUNPATH in libgiac because it messes up which blas/lapack is loaded in Gentoo.



---

archive/issue_comments_608360.json:
```json
{
    "body": "Changing commit from \"75966fc0c32ffc918ff7a0cad60b7381f9b3fef5\" to \"273bb93bd81c1165cd7206762c91073f47186bca\"",
    "created_at": "2020-10-19T23:55:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608360",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "75966fc0c32ffc918ff7a0cad60b7381f9b3fef5" to "273bb93bd81c1165cd7206762c91073f47186bca"



---

archive/issue_comments_608361.json:
```json
{
    "body": "<a id='comment:18'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                        |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------|\n|[273bb93](https://github.com/sagemath/sagetrac-mirror/commit/273bb93bd81c1165cd7206762c91073f47186bca)|`Make cblas pc module search configurable via sage_conf`|",
    "created_at": "2020-10-19T23:55:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608361",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                        |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------|
|[273bb93](https://github.com/sagemath/sagetrac-mirror/commit/273bb93bd81c1165cd7206762c91073f47186bca)|`Make cblas pc module search configurable via sage_conf`|



---

archive/issue_comments_608362.json:
```json
{
    "body": "Changing author from \"Tobias Diez\" to \"Tobias Diez, Matthias Koeppe\"",
    "created_at": "2020-10-20T00:03:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608362",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "Tobias Diez" to "Tobias Diez, Matthias Koeppe"



---

archive/issue_comments_608363.json:
```json
{
    "body": "<a id='comment:20'></a>\nThanks for the update Matthias. The code works fine on Ubunutu with openblas installed, however fails on MacOS with openblas installed via homebrew:\n\n```\nTraceback (most recent call last):\n      File \"/Users/runner/work/sage/sage/src/.venv/lib/python3.8/site-packages/pip/_vendor/pep517/_in_process.py\", line 280, in <module>\n        main()\n      File \"/Users/runner/work/sage/sage/src/.venv/lib/python3.8/site-packages/pip/_vendor/pep517/_in_process.py\", line 263, in main\n        json_out['return_val'] = hook(**hook_input['kwargs'])\n      File \"/Users/runner/work/sage/sage/src/.venv/lib/python3.8/site-packages/pip/_vendor/pep517/_in_process.py\", line 133, in prepare_metadata_for_build_wheel\n        return hook(metadata_directory, config_settings)\n      File \"/Users/runner/work/sage/sage/src/.venv/lib/python3.8/site-packages/setuptools/build_meta.py\", line 157, in prepare_metadata_for_build_wheel\n        self.run_setup()\n      File \"/Users/runner/work/sage/sage/src/.venv/lib/python3.8/site-packages/setuptools/build_meta.py\", line 248, in run_setup\n        super(_BuildMetaLegacyBackend,\n      File \"/Users/runner/work/sage/sage/src/.venv/lib/python3.8/site-packages/setuptools/build_meta.py\", line 142, in run_setup\n        exec(compile(code, __file__, 'exec'), locals())\n      File \"setup.py\", line 90, in <module>\n        aliases = cython_aliases()\n      File \"/Users/runner/work/sage/sage/src/sage/env.py\", line 399, in cython_aliases\n        lib = next((blas_lib for blas_lib in cblas_pc_modules if pkgconfig.exists(blas_lib)))\n    StopIteration\n```\nsee https://github.com/tobiasdiez/sage/runs/1285891725?check_suite_focus=true\nIts interesting to note that also `./configure` cannot find openblas:\n`checking for openblas >= 0.2.20... no`. So I guess it's a more general issue not really related to this ticket.",
    "created_at": "2020-10-21T11:17:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608363",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:20'></a>
Thanks for the update Matthias. The code works fine on Ubunutu with openblas installed, however fails on MacOS with openblas installed via homebrew:

```
Traceback (most recent call last):
      File "/Users/runner/work/sage/sage/src/.venv/lib/python3.8/site-packages/pip/_vendor/pep517/_in_process.py", line 280, in <module>
        main()
      File "/Users/runner/work/sage/sage/src/.venv/lib/python3.8/site-packages/pip/_vendor/pep517/_in_process.py", line 263, in main
        json_out['return_val'] = hook(**hook_input['kwargs'])
      File "/Users/runner/work/sage/sage/src/.venv/lib/python3.8/site-packages/pip/_vendor/pep517/_in_process.py", line 133, in prepare_metadata_for_build_wheel
        return hook(metadata_directory, config_settings)
      File "/Users/runner/work/sage/sage/src/.venv/lib/python3.8/site-packages/setuptools/build_meta.py", line 157, in prepare_metadata_for_build_wheel
        self.run_setup()
      File "/Users/runner/work/sage/sage/src/.venv/lib/python3.8/site-packages/setuptools/build_meta.py", line 248, in run_setup
        super(_BuildMetaLegacyBackend,
      File "/Users/runner/work/sage/sage/src/.venv/lib/python3.8/site-packages/setuptools/build_meta.py", line 142, in run_setup
        exec(compile(code, __file__, 'exec'), locals())
      File "setup.py", line 90, in <module>
        aliases = cython_aliases()
      File "/Users/runner/work/sage/sage/src/sage/env.py", line 399, in cython_aliases
        lib = next((blas_lib for blas_lib in cblas_pc_modules if pkgconfig.exists(blas_lib)))
    StopIteration
```
see https://github.com/tobiasdiez/sage/runs/1285891725?check_suite_focus=true
Its interesting to note that also `./configure` cannot find openblas:
`checking for openblas >= 0.2.20... no`. So I guess it's a more general issue not really related to this ticket.



---

archive/issue_comments_608364.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [gh-tobiasdiez](#comment%3A20):\n> Thanks for the update Matthias. The code works fine on Ubunutu with openblas installed, however fails on MacOS with openblas installed via homebrew:\n\n\nDid you use the homebrew setup as explained in README.md?",
    "created_at": "2020-10-21T18:23:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608364",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'></a>
Replying to [gh-tobiasdiez](#comment%3A20):
> Thanks for the update Matthias. The code works fine on Ubunutu with openblas installed, however fails on MacOS with openblas installed via homebrew:


Did you use the homebrew setup as explained in README.md?



---

archive/issue_comments_608365.json:
```json
{
    "body": "<a id='comment:22'></a>\nNot sure, the Readme in root doesn't really contain anything about homebrew. That's what I used: https://github.com/tobiasdiez/sage/actions/runs/319537404/workflow",
    "created_at": "2020-10-21T20:03:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608365",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:22'></a>
Not sure, the Readme in root doesn't really contain anything about homebrew. That's what I used: https://github.com/tobiasdiez/sage/actions/runs/319537404/workflow



---

archive/issue_comments_608366.json:
```json
{
    "body": "<a id='comment:23'></a>\nMy bad, it's actually not in the README but is displayed at the end of ./configure:\n\n```\n# To automatically take care of homebrew messages regarding \n# keg-only packages for the current shell session:\n  $ source /Users/mkoeppe/s/sage/sage-rebasing/.homebrew-build-env\n```",
    "created_at": "2020-10-21T20:33:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608366",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:23'></a>
My bad, it's actually not in the README but is displayed at the end of ./configure:

```
# To automatically take care of homebrew messages regarding 
# keg-only packages for the current shell session:
  $ source /Users/mkoeppe/s/sage/sage-rebasing/.homebrew-build-env
```



---

archive/issue_comments_608367.json:
```json
{
    "body": "<a id='comment:25'></a>\nI just discovered that there is also a reference to `cblas` in `src/sage/misc/cython.py`. Not sure if this also needs to be changed to use the new variable `CBLAS_PC_MODULES`.\n\nMoreover, I would like suggest the following change to `sage_conf.py.in` to make this more reusable.\n\n```\nDEFAULT_CBLAS_PC_MODULE = \"@SAGE_CBLAS_PC_MODULE\" # Set to cblas in configure\n\ndef get_cblas_pc_module()\n   cblas_pc_modules = [DEFAULT_CBLAS_PC_MODULE, 'cblas', 'openblas', 'blas']\n   return next((blas_lib for blas_lib in cblas_pc_modules if pkgconfig.exists(blas_lib)))\n```",
    "created_at": "2020-11-03T00:47:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608367",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:25'></a>
I just discovered that there is also a reference to `cblas` in `src/sage/misc/cython.py`. Not sure if this also needs to be changed to use the new variable `CBLAS_PC_MODULES`.

Moreover, I would like suggest the following change to `sage_conf.py.in` to make this more reusable.

```
DEFAULT_CBLAS_PC_MODULE = "@SAGE_CBLAS_PC_MODULE" # Set to cblas in configure

def get_cblas_pc_module()
   cblas_pc_modules = [DEFAULT_CBLAS_PC_MODULE, 'cblas', 'openblas', 'blas']
   return next((blas_lib for blas_lib in cblas_pc_modules if pkgconfig.exists(blas_lib)))
```



---

archive/issue_comments_608368.json:
```json
{
    "body": "<a id='comment:26'></a>\nSearch logic should go into sage/env.py, not sage_conf.",
    "created_at": "2020-11-03T01:13:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608368",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:26'></a>
Search logic should go into sage/env.py, not sage_conf.



---

archive/issue_comments_608369.json:
```json
{
    "body": "<a id='comment:27'></a>\nReplying to [gh-tobiasdiez](#comment%3A25):\n> I just discovered that there is also a reference to `cblas` in `src/sage/misc/cython.py`. Not sure if this also needs to be changed to use the new variable `CBLAS_PC_MODULES`.\n\n\nYes, this code should be replaced by something equivalent that uses sage.env",
    "created_at": "2020-11-03T01:14:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608369",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'></a>
Replying to [gh-tobiasdiez](#comment%3A25):
> I just discovered that there is also a reference to `cblas` in `src/sage/misc/cython.py`. Not sure if this also needs to be changed to use the new variable `CBLAS_PC_MODULES`.


Yes, this code should be replaced by something equivalent that uses sage.env



---

archive/issue_comments_608370.json:
```json
{
    "body": "<a id='comment:28'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                    |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------|\n|[9c8641a](https://github.com/sagemath/sagetrac-mirror/commit/9c8641a7f6d277c969d41506d55b7cc4cc04ef8d)|`Replace other usages of cblas name`|",
    "created_at": "2020-11-03T09:12:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608370",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:28'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                    |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------|
|[9c8641a](https://github.com/sagemath/sagetrac-mirror/commit/9c8641a7f6d277c969d41506d55b7cc4cc04ef8d)|`Replace other usages of cblas name`|



---

archive/issue_comments_608371.json:
```json
{
    "body": "Changing commit from \"273bb93bd81c1165cd7206762c91073f47186bca\" to \"9c8641a7f6d277c969d41506d55b7cc4cc04ef8d\"",
    "created_at": "2020-11-03T09:12:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608371",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "273bb93bd81c1165cd7206762c91073f47186bca" to "9c8641a7f6d277c969d41506d55b7cc4cc04ef8d"



---

archive/issue_comments_608372.json:
```json
{
    "body": "<a id='comment:29'></a>\nOk, I've now refactored the code slightly and replaced the other usages of the hard-corded `cblas` in `sage/misc/cython.py` and in `sage_setup/library_order.py`.",
    "created_at": "2020-11-03T09:15:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608372",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:29'></a>
Ok, I've now refactored the code slightly and replaced the other usages of the hard-corded `cblas` in `sage/misc/cython.py` and in `sage_setup/library_order.py`.



---

archive/issue_comments_608373.json:
```json
{
    "body": "<a id='comment:30'></a>\nLooks good to me, but another reviewer is needed...",
    "created_at": "2020-11-03T16:50:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608373",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'></a>
Looks good to me, but another reviewer is needed...



---

archive/issue_comments_608374.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Matthias Koeppe, ...\"",
    "created_at": "2020-11-03T16:50:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608374",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "Matthias Koeppe, ..."



---

archive/issue_comments_608375.json:
```json
{
    "body": "<a id='comment:31'></a>\ndoes this work on platforms where cblas is present in an important way, such as arch linux?",
    "created_at": "2020-11-04T12:54:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608375",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:31'></a>
does this work on platforms where cblas is present in an important way, such as arch linux?



---

archive/issue_comments_608376.json:
```json
{
    "body": "<a id='comment:32'></a>\nThe behavior as part of building Sage-the-distribution is unchanged by this ticket.",
    "created_at": "2020-11-04T20:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608376",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:32'></a>
The behavior as part of building Sage-the-distribution is unchanged by this ticket.



---

archive/issue_comments_608377.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-11-07T21:47:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608377",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_608378.json:
```json
{
    "body": "Changing reviewer from \"Matthias Koeppe, ...\" to \"Matthias Koeppe, Dima Pasechnik\"",
    "created_at": "2020-11-07T21:47:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608378",
    "user": "https://github.com/dimpase"
}
```

Changing reviewer from "Matthias Koeppe, ..." to "Matthias Koeppe, Dima Pasechnik"



---

archive/issue_comments_608379.json:
```json
{
    "body": "<a id='comment:34'></a>\nThanks!",
    "created_at": "2020-11-08T13:33:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608379",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:34'></a>
Thanks!



---

archive/issue_comments_608380.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-11-20T22:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608380",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_608381.json:
```json
{
    "body": "Changing branch from \"public/build/cblas\" to \"9c8641a7f6d277c969d41506d55b7cc4cc04ef8d\"",
    "created_at": "2020-11-20T22:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30706#issuecomment-608381",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/build/cblas" to "9c8641a7f6d277c969d41506d55b7cc4cc04ef8d"



---

archive/issue_events_090123.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-11-20T22:15:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30706",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30706#event-90123"
}
```
