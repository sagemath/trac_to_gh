# Issue 30586: macOS: Doctest failures in some locales

archive/issues_030349.json:
```json
{
    "assignees": [],
    "body": "There are also some other locale problems that show up in doctests\n(for example https://groups.google.com/d/msg/sage-release/spalYgXKr-4/ZVsbgHIlAgAJ and https://groups.google.com/g/sage-release/c/IiGznoPMATI/m/jynWfRcmDAAJ)\n\n```\nsage -t --long --warn-long 113.2 --random-seed=0 src/sage/misc/sageinspect.py\n**********************************************************************\nFile \"src/sage/misc/sageinspect.py\", line 1497, in sage.misc.sageinspect.sage_getargspec\nFailed example:\n    sage.misc.sageinspect.sage_getargspec(r.lm)\nExpected:\n    ArgSpec(args=['self'], varargs='args', keywords='kwds', defaults=None)\nGot:\n     \u8d77\u52d5\u6e96\u5099\u4e2d\u3067\u3059 -  \u8b66\u544a\u30e1\u30c3\u30bb\u30fc\u30b8: \n    1: Setting LC_COLLATE failed, using \"C\" \n    2: Setting LC_TIME failed, using \"C\" \n    3: Setting LC_MESSAGES failed, using \"C\" \n    4: Setting LC_MONETARY failed, using \"C\" \n    ArgSpec(args=['self'], varargs='args', keywords='kwds', defaults=None)\n```\n\nPerhaps just a misconfigured system, but we should make sure to robustly set a consistent locale in which the doctests are run.\n\n\n\n\n\n\nCC:  @dimpase @orlitzky @seblabbe\n\n_Issue created by migration from https://trac.sagemath.org/ticket/30586_\n\n",
    "created_at": "2020-09-16T17:40:20Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20doctest%20framework",
        "https://github.com/sagemath/sage/labels/p4%20%E2%80%93%20minor",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "macOS: Doctest failures in some locales",
    "type": "issue",
    "updated_at": "2022-09-19T18:58:47Z",
    "url": "https://github.com/sagemath/sage/issues/30586",
    "user": "https://github.com/mkoeppe"
}
```
There are also some other locale problems that show up in doctests
(for example https://groups.google.com/d/msg/sage-release/spalYgXKr-4/ZVsbgHIlAgAJ and https://groups.google.com/g/sage-release/c/IiGznoPMATI/m/jynWfRcmDAAJ)

```
sage -t --long --warn-long 113.2 --random-seed=0 src/sage/misc/sageinspect.py
**********************************************************************
File "src/sage/misc/sageinspect.py", line 1497, in sage.misc.sageinspect.sage_getargspec
Failed example:
    sage.misc.sageinspect.sage_getargspec(r.lm)
Expected:
    ArgSpec(args=['self'], varargs='args', keywords='kwds', defaults=None)
Got:
     起動準備中です -  警告メッセージ: 
    1: Setting LC_COLLATE failed, using "C" 
    2: Setting LC_TIME failed, using "C" 
    3: Setting LC_MESSAGES failed, using "C" 
    4: Setting LC_MONETARY failed, using "C" 
    ArgSpec(args=['self'], varargs='args', keywords='kwds', defaults=None)
```

Perhaps just a misconfigured system, but we should make sure to robustly set a consistent locale in which the doctests are run.






CC:  @dimpase @orlitzky @seblabbe

_Issue created by migration from https://trac.sagemath.org/ticket/30586_





---

archive/issue_events_389678.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-16T17:40:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30586",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30586#event-389678"
}
```



---

archive/issue_events_389679.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-16T17:40:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30586",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20doctest%20framework",
    "label_color": "000080",
    "label_name": "component: doctest framework",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30586#event-389679"
}
```



---

archive/issue_events_389680.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-16T17:40:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30586",
    "label": "https://github.com/sagemath/sage/labels/p4%20%E2%80%93%20minor",
    "label_color": "ffe799",
    "label_name": "p4 \u2013 minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30586#event-389680"
}
```



---

archive/issue_events_389681.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-16T17:40:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30586",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30586#event-389681"
}
```



---

archive/issue_comments_490944.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nThis doctest is:\n\n```\n        sage: sage.misc.sageinspect.sage_getargspec(r.lm)\n```\nIt causes the R interface to start up, and then R may complain about bad locales on a misconfigured system.\n\nWe could of course force a locale in `sage -t`, but I don't think this is a pressing issue.",
    "created_at": "2020-09-23T01:37:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30586#issuecomment-490944",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'>Comment 1:</a>
This doctest is:

```
        sage: sage.misc.sageinspect.sage_getargspec(r.lm)
```
It causes the R interface to start up, and then R may complain about bad locales on a misconfigured system.

We could of course force a locale in `sage -t`, but I don't think this is a pressing issue.



---

archive/issue_comments_490945.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nIf anything, I think it would be rpy2 that should set `LC_ALL=C` before it launches its embedded copy of the R interpreter. But I really have no idea how rpy2 works (that is, if it handles locale issues transparently), so that suggestion would be premature. In any case, the cause of this error is that the R interpreter was launched with an invalid environment. For example,\n\n```\n$ LC_ALL=derp R --no-save -q\nDuring startup - Warning messages:\n1: Setting LC_CTYPE failed, using \"C\" \n2: Setting LC_COLLATE failed, using \"C\" \n3: Setting LC_TIME failed, using \"C\" \n4: Setting LC_MONETARY failed, using \"C\" \n5: Setting LC_PAPER failed, using \"C\" \n6: Setting LC_MEASUREMENT failed, using \"C\" \n>\n```\n\nI'm thinking this is not something we need to fix.",
    "created_at": "2020-09-23T03:22:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30586#issuecomment-490945",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:2'>Comment 2:</a>
If anything, I think it would be rpy2 that should set `LC_ALL=C` before it launches its embedded copy of the R interpreter. But I really have no idea how rpy2 works (that is, if it handles locale issues transparently), so that suggestion would be premature. In any case, the cause of this error is that the R interpreter was launched with an invalid environment. For example,

```
$ LC_ALL=derp R --no-save -q
During startup - Warning messages:
1: Setting LC_CTYPE failed, using "C" 
2: Setting LC_COLLATE failed, using "C" 
3: Setting LC_TIME failed, using "C" 
4: Setting LC_MONETARY failed, using "C" 
5: Setting LC_PAPER failed, using "C" 
6: Setting LC_MEASUREMENT failed, using "C" 
>
```

I'm thinking this is not something we need to fix.



---

archive/issue_events_389682.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30586",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30586#event-389682"
}
```



---

archive/issue_events_389683.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30586",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30586#event-389683"
}
```



---

archive/issue_comments_490946.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nShould this instead be reported to rpy2?\n\nhttps://github.com/rpy2/rpy2/issues",
    "created_at": "2021-03-27T14:35:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30586#issuecomment-490946",
    "user": "https://github.com/slel"
}
```

<a id='comment:4'>Comment 4:</a>
Should this instead be reported to rpy2?

https://github.com/rpy2/rpy2/issues



---

archive/issue_events_389684.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-07T19:29:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30586",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30586#event-389684"
}
```



---

archive/issue_events_389685.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-07T19:29:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30586",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30586#event-389685"
}
```



---

archive/issue_comments_490947.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nSage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-04-07T19:29:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30586",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30586#issuecomment-490947",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'>Comment 5:</a>
Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_events_389686.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30586",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30586#event-389686"
}
```



---

archive/issue_events_389687.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-22T20:35:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30586",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30586#event-389687"
}
```



---

archive/issue_events_389688.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T20:12:32Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30586",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30586#event-389688"
}
```



---

archive/issue_events_389689.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T20:12:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30586",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30586#event-389689"
}
```



---

archive/issue_events_389690.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30586",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30586#event-389690"
}
```



---

archive/issue_events_389691.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-03T15:17:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30586",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30586#event-389691"
}
```



---

archive/issue_events_389692.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30586",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30586#event-389692"
}
```



---

archive/issue_events_389693.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30586",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30586#event-389693"
}
```
