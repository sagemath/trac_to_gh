# Issue 30923: tox.ini: Add environments local-sudo-ubuntu-standard, etc.

archive/issues_030686.json:
```json
{
    "assignees": [],
    "body": "These environments would just run `sudo apt-get ...` etc. to install (but not remove!) packages, for use at the user's own risk.\n\nTo test (on an Ubuntu system):\n\n```\n    tox -e local-sudo-ubuntu-bionic-standard\n```\nor\n\n```\n    tox -e local-sudo-standard\n```\n\n\n  \n\n**CC:**  @tobiasdiez @dimpase\n\n**Branch:** [ff34897cac35061afd348cc08a6559f95f406f14](https://github.com/sagemath/sagetrac-mirror/commit/ff34897cac35061afd348cc08a6559f95f406f14)\n\n**Reviewer:** Tobias Diez, Dima Pasechnik\n\n**Author:** Matthias Koeppe\n\nIssue created by migration from https://trac.sagemath.org/ticket/30923\n\n",
    "closed_at": "2020-11-22T15:05:26Z",
    "created_at": "2020-11-15T23:38:33Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20porting",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "tox.ini: Add environments local-sudo-ubuntu-standard, etc.",
    "type": "issue",
    "updated_at": "2020-11-22T17:54:07Z",
    "url": "https://github.com/sagemath/sage/issues/30923",
    "user": "https://github.com/mkoeppe"
}
```
These environments would just run `sudo apt-get ...` etc. to install (but not remove!) packages, for use at the user's own risk.

To test (on an Ubuntu system):

```
    tox -e local-sudo-ubuntu-bionic-standard
```
or

```
    tox -e local-sudo-standard
```


  

**CC:**  @tobiasdiez @dimpase

**Branch:** [ff34897cac35061afd348cc08a6559f95f406f14](https://github.com/sagemath/sagetrac-mirror/commit/ff34897cac35061afd348cc08a6559f95f406f14)

**Reviewer:** Tobias Diez, Dima Pasechnik

**Author:** Matthias Koeppe

Issue created by migration from https://trac.sagemath.org/ticket/30923





---

archive/issue_comments_498262.json:
```json
{
    "body": "**Author:** Matthias Koeppe",
    "created_at": "2020-11-15T23:46:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498262",
    "user": "https://github.com/mkoeppe"
}
```

**Author:** Matthias Koeppe



---

archive/issue_comments_498263.json:
```json
{
    "body": "<a id='comment:2'></a>\nIs it possible to put the sudo outside? I.e. `sudo tox -r local-ubuntu-standard`?",
    "created_at": "2020-11-16T00:03:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498263",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:2'></a>
Is it possible to put the sudo outside? I.e. `sudo tox -r local-ubuntu-standard`?



---

archive/issue_comments_498264.json:
```json
{
    "body": "<a id='comment:3'></a>\nBut we would only want to do the package installation as root, not the Sage build",
    "created_at": "2020-11-16T00:06:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498264",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>
But we would only want to do the package installation as root, not the Sage build



---

archive/issue_comments_498265.json:
```json
{
    "body": "**Branch:** [u/mkoeppe/tox_ini__add_environments_local_sudo_ubuntu_standard__etc_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/tox_ini__add_environments_local_sudo_ubuntu_standard__etc_)",
    "created_at": "2020-11-16T00:07:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498265",
    "user": "https://github.com/mkoeppe"
}
```

**Branch:** [u/mkoeppe/tox_ini__add_environments_local_sudo_ubuntu_standard__etc_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/tox_ini__add_environments_local_sudo_ubuntu_standard__etc_)



---

archive/issue_comments_498266.json:
```json
{
    "body": "**Commit:** [30e624abbc52b5a5a060a4eca801e8fda303937f](https://github.com/sagemath/sagetrac-mirror/commit/30e624abbc52b5a5a060a4eca801e8fda303937f)",
    "created_at": "2020-11-16T00:07:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498266",
    "user": "https://github.com/mkoeppe"
}
```

**Commit:** [30e624abbc52b5a5a060a4eca801e8fda303937f](https://github.com/sagemath/sagetrac-mirror/commit/30e624abbc52b5a5a060a4eca801e8fda303937f)



---

archive/issue_comments_498267.json:
```json
{
    "body": "<a id='comment:5'></a>\nHere's a first approximation.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/30e624abbc52b5a5a060a4eca801e8fda303937f\">30e624a</a></td><td><code>tox.ini: Add local-sudo</code></td></tr></table>\n",
    "created_at": "2020-11-16T00:07:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498267",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>
Here's a first approximation.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/30e624abbc52b5a5a060a4eca801e8fda303937f">30e624a</a></td><td><code>tox.ini: Add local-sudo</code></td></tr></table>




---

archive/issue_comments_498268.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,2 +1,10 @@\n These environments would just run `sudo apt-get ...` etc. to install (but not remove!) packages, for use at the user's own risk.\n \n+To test (on an Ubuntu system):\n+\n+```\n+    tox -e local-sudo-ubuntu-standard\n+```\n+\n+\n+  \n``````\n",
    "created_at": "2020-11-16T00:09:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498268",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,2 +1,10 @@
 These environments would just run `sudo apt-get ...` etc. to install (but not remove!) packages, for use at the user's own risk.
 
+To test (on an Ubuntu system):
+
+```
+    tox -e local-sudo-ubuntu-standard
+```
+
+
+  
``````




---

archive/issue_comments_498269.json:
```json
{
    "body": "<a id='comment:7'></a>\nI think you forgot the confirmation `-y` after `install`: https://github.com/tobiasdiez/sage/commit/942149ee76a97628046042b7255a2d31630e7721\n\nMoreover, I was wondering if one should also read the `debian-bootstrap.txt` files.\n\nFinally, there are problems that some of the packages are not found. First, one should probably add `sudo add-apt-repository ppa:deadsnakes/ppa` since otherwise `libpython3.7-dev` is not found on ubuntu 20.04. Second, `texlive-generic-extra` doesn't exist on ubuntu 20.04.\nhttps://github.com/tobiasdiez/sage/runs/1404001507?check_suite_focus=true\n\nOther than that, looks good to me! Thanks a lot.",
    "created_at": "2020-11-16T00:50:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498269",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:7'></a>
I think you forgot the confirmation `-y` after `install`: https://github.com/tobiasdiez/sage/commit/942149ee76a97628046042b7255a2d31630e7721

Moreover, I was wondering if one should also read the `debian-bootstrap.txt` files.

Finally, there are problems that some of the packages are not found. First, one should probably add `sudo add-apt-repository ppa:deadsnakes/ppa` since otherwise `libpython3.7-dev` is not found on ubuntu 20.04. Second, `texlive-generic-extra` doesn't exist on ubuntu 20.04.
https://github.com/tobiasdiez/sage/runs/1404001507?check_suite_focus=true

Other than that, looks good to me! Thanks a lot.



---

archive/issue_comments_498270.json:
```json
{
    "body": "<a id='comment:8'></a>\nYes, I'll add bootstrap\n\nI don't think we have `libpython3.7-dev` listed in the debian.txt files any more.\n\nBut yes, handling `IGNORE_MISSING_SYSTEM_PACKAGES` needs to be done.\n\nFor deadsnakes, there's #30217. This would not be the default, but a mix-in flavor.",
    "created_at": "2020-11-16T00:55:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498270",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>
Yes, I'll add bootstrap

I don't think we have `libpython3.7-dev` listed in the debian.txt files any more.

But yes, handling `IGNORE_MISSING_SYSTEM_PACKAGES` needs to be done.

For deadsnakes, there's #30217. This would not be the default, but a mix-in flavor.



---

archive/issue_comments_498271.json:
```json
{
    "body": "<a id='comment:9'></a>\nOn a second thought, do you really thing it's the job of tox to install system packages? I would feel more comfortable to put the code into a  shell script that you can run as `build/install_system_packages ubuntu-2004`, say. (Having such a script might be a good idea anyway).",
    "created_at": "2020-11-16T00:56:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498271",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:9'></a>
On a second thought, do you really thing it's the job of tox to install system packages? I would feel more comfortable to put the code into a  shell script that you can run as `build/install_system_packages ubuntu-2004`, say. (Having such a script might be a good idea anyway).



---

archive/issue_comments_498272.json:
```json
{
    "body": "<a id='comment:10'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/75ecd11e878e34a4c508d2f983b6d7527e689f94\">75ecd11</a></td><td><code>tox.ini (local-sudo): Also use ...-bootstrap.txt</code></td></tr></table>\n",
    "created_at": "2020-11-16T00:57:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498272",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:10'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/75ecd11e878e34a4c508d2f983b6d7527e689f94">75ecd11</a></td><td><code>tox.ini (local-sudo): Also use ...-bootstrap.txt</code></td></tr></table>




---

archive/issue_comments_498273.json:
```json
{
    "body": "**Changing commit** from \"[30e624abbc52b5a5a060a4eca801e8fda303937f](https://github.com/sagemath/sagetrac-mirror/commit/30e624abbc52b5a5a060a4eca801e8fda303937f)\" to \"[75ecd11e878e34a4c508d2f983b6d7527e689f94](https://github.com/sagemath/sagetrac-mirror/commit/75ecd11e878e34a4c508d2f983b6d7527e689f94)\".",
    "created_at": "2020-11-16T00:57:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498273",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[30e624abbc52b5a5a060a4eca801e8fda303937f](https://github.com/sagemath/sagetrac-mirror/commit/30e624abbc52b5a5a060a4eca801e8fda303937f)" to "[75ecd11e878e34a4c508d2f983b6d7527e689f94](https://github.com/sagemath/sagetrac-mirror/commit/75ecd11e878e34a4c508d2f983b6d7527e689f94)".



---

archive/issue_comments_498274.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [@mkoeppe](#comment%3A8):\n> But yes, handling `IGNORE_MISSING_SYSTEM_PACKAGES` needs to be done.\n\nand/or change `texlive-generic-extra` that exist on modern ubuntu systems as well.",
    "created_at": "2020-11-16T00:59:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498274",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:11'></a>
Replying to [@mkoeppe](#comment%3A8):
> But yes, handling `IGNORE_MISSING_SYSTEM_PACKAGES` needs to be done.

and/or change `texlive-generic-extra` that exist on modern ubuntu systems as well.



---

archive/issue_comments_498275.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [git](#comment%3A10):\n> Branch pushed to git repo; I updated commit sha1. **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/75ecd11e878e34a4c508d2f983b6d7527e689f94\">75ecd11</a></td><td><code>tox.ini (local-sudo): Also use ...-bootstrap.txt</code></td></tr></table>\n\nDon't forget to change local-sudo-standard/maximal as well.",
    "created_at": "2020-11-16T01:01:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498275",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:12'></a>
Replying to [git](#comment%3A10):
> Branch pushed to git repo; I updated commit sha1. **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/75ecd11e878e34a4c508d2f983b6d7527e689f94">75ecd11</a></td><td><code>tox.ini (local-sudo): Also use ...-bootstrap.txt</code></td></tr></table>

Don't forget to change local-sudo-standard/maximal as well.



---

archive/issue_comments_498276.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [@tobiasdiez](#comment%3A9):\n> On a second thought, do you really thing it's the job of tox to install system packages? I would feel more comfortable to put the code into a  shell script that you can run as `build/install_system_packages ubuntu-2004`, say. (Having such a script might be a good idea anyway).  \n\nIt's working well with tox, in particular the environment factors give a nice compact way of expressing different configurations. \n\nAnd I definitely do not want to add user-facing scripts to Sage that promises to install all necessary system packages. We deliberately only offer system package *advice* (at the end of `./configure`). Already now users complain if that advice is not entirely accurate -- so we definitely do not want to make stronger promises! We simply do not have enough developers who could keep it up to date.\n\nBut there is a lot of room for refactoring what is in `tox.ini` into various helper scripts. I have described some possible directions in #30865 -- help is very welcome there.",
    "created_at": "2020-11-16T01:08:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498276",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>
Replying to [@tobiasdiez](#comment%3A9):
> On a second thought, do you really thing it's the job of tox to install system packages? I would feel more comfortable to put the code into a  shell script that you can run as `build/install_system_packages ubuntu-2004`, say. (Having such a script might be a good idea anyway).  

It's working well with tox, in particular the environment factors give a nice compact way of expressing different configurations. 

And I definitely do not want to add user-facing scripts to Sage that promises to install all necessary system packages. We deliberately only offer system package *advice* (at the end of `./configure`). Already now users complain if that advice is not entirely accurate -- so we definitely do not want to make stronger promises! We simply do not have enough developers who could keep it up to date.

But there is a lot of room for refactoring what is in `tox.ini` into various helper scripts. I have described some possible directions in #30865 -- help is very welcome there.



---

archive/issue_comments_498277.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [@tobiasdiez](#comment%3A12):\n> Replying to [git](#comment%3A10):\n> > Branch pushed to git repo; I updated commit sha1. New commits:\n\n> |                                                                                                                                                 |                                                  |\n> |-------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|\n> |[75ecd11](https://github.com/sagemath/sagetrac-mirror/commit/75ecd11e878e34a4c508d2f983b6d7527e689f94)|`tox.ini (local-sudo): Also use ...-bootstrap.txt`|\n> \n> Don't forget to change local-sudo-standard/maximal as well.\n\nNo, that line is also executed for these environments - by the magic of tox's factor conditions.",
    "created_at": "2020-11-16T01:09:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498277",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>
Replying to [@tobiasdiez](#comment%3A12):
> Replying to [git](#comment%3A10):
> > Branch pushed to git repo; I updated commit sha1. New commits:

> |                                                                                                                                                 |                                                  |
> |-------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|
> |[75ecd11](https://github.com/sagemath/sagetrac-mirror/commit/75ecd11e878e34a4c508d2f983b6d7527e689f94)|`tox.ini (local-sudo): Also use ...-bootstrap.txt`|
> 
> Don't forget to change local-sudo-standard/maximal as well.

No, that line is also executed for these environments - by the magic of tox's factor conditions.



---

archive/issue_comments_498278.json:
```json
{
    "body": "<a id='comment:15'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0dc79eb4b542a11aa8c226ca8cf9f0e2306698eb\">0dc79eb</a></td><td><code>build/bin/sage-print-system-package-command: Handle --no-install-recommends, --yes for systems for which write-dockerfile.sh knows these flags</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/050dcb8275b3a7e0db4c7ae3503428107bb5bf17\">050dcb8</a></td><td><code>tox.ini (local-sudo): Use --yes --no-install-recommends</code></td></tr></table>\n",
    "created_at": "2020-11-16T01:38:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498278",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:15'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0dc79eb4b542a11aa8c226ca8cf9f0e2306698eb">0dc79eb</a></td><td><code>build/bin/sage-print-system-package-command: Handle --no-install-recommends, --yes for systems for which write-dockerfile.sh knows these flags</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/050dcb8275b3a7e0db4c7ae3503428107bb5bf17">050dcb8</a></td><td><code>tox.ini (local-sudo): Use --yes --no-install-recommends</code></td></tr></table>




---

archive/issue_comments_498279.json:
```json
{
    "body": "**Changing commit** from \"[75ecd11e878e34a4c508d2f983b6d7527e689f94](https://github.com/sagemath/sagetrac-mirror/commit/75ecd11e878e34a4c508d2f983b6d7527e689f94)\" to \"[050dcb8275b3a7e0db4c7ae3503428107bb5bf17](https://github.com/sagemath/sagetrac-mirror/commit/050dcb8275b3a7e0db4c7ae3503428107bb5bf17)\".",
    "created_at": "2020-11-16T01:38:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498279",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[75ecd11e878e34a4c508d2f983b6d7527e689f94](https://github.com/sagemath/sagetrac-mirror/commit/75ecd11e878e34a4c508d2f983b6d7527e689f94)" to "[050dcb8275b3a7e0db4c7ae3503428107bb5bf17](https://github.com/sagemath/sagetrac-mirror/commit/050dcb8275b3a7e0db4c7ae3503428107bb5bf17)".



---

archive/issue_comments_498280.json:
```json
{
    "body": "<a id='comment:16'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c8fbe0beaec3a404d330aaebdf37186e9c6becec\">c8fbe0b</a></td><td><code>tox.ini (local-sudo): Ignore errors when IGNORE_MISSING_SYSTEM_PACKAGES=yes</code></td></tr></table>\n",
    "created_at": "2020-11-16T01:57:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498280",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:16'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c8fbe0beaec3a404d330aaebdf37186e9c6becec">c8fbe0b</a></td><td><code>tox.ini (local-sudo): Ignore errors when IGNORE_MISSING_SYSTEM_PACKAGES=yes</code></td></tr></table>




---

archive/issue_comments_498281.json:
```json
{
    "body": "**Changing commit** from \"[050dcb8275b3a7e0db4c7ae3503428107bb5bf17](https://github.com/sagemath/sagetrac-mirror/commit/050dcb8275b3a7e0db4c7ae3503428107bb5bf17)\" to \"[c8fbe0beaec3a404d330aaebdf37186e9c6becec](https://github.com/sagemath/sagetrac-mirror/commit/c8fbe0beaec3a404d330aaebdf37186e9c6becec)\".",
    "created_at": "2020-11-16T01:57:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498281",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[050dcb8275b3a7e0db4c7ae3503428107bb5bf17](https://github.com/sagemath/sagetrac-mirror/commit/050dcb8275b3a7e0db4c7ae3503428107bb5bf17)" to "[c8fbe0beaec3a404d330aaebdf37186e9c6becec](https://github.com/sagemath/sagetrac-mirror/commit/c8fbe0beaec3a404d330aaebdf37186e9c6becec)".



---

archive/issue_events_277296.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-11-16T02:05:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30923#event-277296"
}
```



---

archive/issue_comments_498282.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -3,8 +3,7 @@\n To test (on an Ubuntu system):\n \n ```\n-    tox -e local-sudo-ubuntu-standard\n+    tox -e local-sudo-ubuntu-bionic-standard\n ```\n \n-\n   \n``````\n",
    "created_at": "2020-11-16T02:05:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498282",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -3,8 +3,7 @@
 To test (on an Ubuntu system):
 
 ```
-    tox -e local-sudo-ubuntu-standard
+    tox -e local-sudo-ubuntu-bionic-standard
 ```
 
-
   
``````




---

archive/issue_comments_498283.json:
```json
{
    "body": "<a id='comment:18'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ff34897cac35061afd348cc08a6559f95f406f14\">ff34897</a></td><td><code>tox.ini (local): Guess the package system if it is not provided as a factor</code></td></tr></table>\n",
    "created_at": "2020-11-16T03:00:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498283",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:18'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ff34897cac35061afd348cc08a6559f95f406f14">ff34897</a></td><td><code>tox.ini (local): Guess the package system if it is not provided as a factor</code></td></tr></table>




---

archive/issue_comments_498284.json:
```json
{
    "body": "**Changing commit** from \"[c8fbe0beaec3a404d330aaebdf37186e9c6becec](https://github.com/sagemath/sagetrac-mirror/commit/c8fbe0beaec3a404d330aaebdf37186e9c6becec)\" to \"[ff34897cac35061afd348cc08a6559f95f406f14](https://github.com/sagemath/sagetrac-mirror/commit/ff34897cac35061afd348cc08a6559f95f406f14)\".",
    "created_at": "2020-11-16T03:00:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498284",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[c8fbe0beaec3a404d330aaebdf37186e9c6becec](https://github.com/sagemath/sagetrac-mirror/commit/c8fbe0beaec3a404d330aaebdf37186e9c6becec)" to "[ff34897cac35061afd348cc08a6559f95f406f14](https://github.com/sagemath/sagetrac-mirror/commit/ff34897cac35061afd348cc08a6559f95f406f14)".



---

archive/issue_comments_498285.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -5,5 +5,11 @@\n ```\n     tox -e local-sudo-ubuntu-bionic-standard\n ```\n+or\n+\n+```\n+    tox -e local-sudo-standard\n+```\n+\n \n   \n``````\n",
    "created_at": "2020-11-16T03:01:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498285",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -5,5 +5,11 @@
 ```
     tox -e local-sudo-ubuntu-bionic-standard
 ```
+or
+
+```
+    tox -e local-sudo-standard
+```
+
 
   
``````




---

archive/issue_comments_498286.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [@mkoeppe](#comment%3A13):\n> Replying to [@tobiasdiez](#comment%3A9):\n> > On a second thought, do you really thing it's the job of tox to install system packages? I would feel more comfortable to put the code into a  shell script that you can run as `build/install_system_packages ubuntu-2004`, say. (Having such a script might be a good idea anyway).  \n\n> \n> It's working well with tox, in particular the environment factors give a nice compact way of expressing different configurations. \n\nSure, but it feels a bit like you are using tox for something it wasn't designed. Normally, in a tox setting, \"environment\" refers to a virtual python env, but for sage it is the complete system env including the os and system packages. I have the feeling a more general-purpose framework like invoke would be a better solution to manage these things.\n\n> And I definitely do not want to add user-facing scripts to Sage that promises to install all necessary system packages.\n\nI didn't meant it as a user-facing script, but only for developers (i.e don't ship it).",
    "created_at": "2020-11-16T10:57:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498286",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:20'></a>
Replying to [@mkoeppe](#comment%3A13):
> Replying to [@tobiasdiez](#comment%3A9):
> > On a second thought, do you really thing it's the job of tox to install system packages? I would feel more comfortable to put the code into a  shell script that you can run as `build/install_system_packages ubuntu-2004`, say. (Having such a script might be a good idea anyway).  

> 
> It's working well with tox, in particular the environment factors give a nice compact way of expressing different configurations. 

Sure, but it feels a bit like you are using tox for something it wasn't designed. Normally, in a tox setting, "environment" refers to a virtual python env, but for sage it is the complete system env including the os and system packages. I have the feeling a more general-purpose framework like invoke would be a better solution to manage these things.

> And I definitely do not want to add user-facing scripts to Sage that promises to install all necessary system packages.

I didn't meant it as a user-facing script, but only for developers (i.e don't ship it).



---

archive/issue_comments_498287.json:
```json
{
    "body": "<a id='comment:21'></a>\nI've tested the current code in the wsl github workflow and it seems to work well: https://github.com/tobiasdiez/sage/actions/runs/365823571",
    "created_at": "2020-11-16T10:58:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498287",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:21'></a>
I've tested the current code in the wsl github workflow and it seems to work well: https://github.com/tobiasdiez/sage/actions/runs/365823571



---

archive/issue_comments_498288.json:
```json
{
    "body": "<a id='comment:22'></a>\nSounds like a positive review?",
    "created_at": "2020-11-16T18:18:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498288",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'></a>
Sounds like a positive review?



---

archive/issue_comments_498289.json:
```json
{
    "body": "**Reviewer:** Tobias Diez, ...",
    "created_at": "2020-11-16T19:45:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498289",
    "user": "https://github.com/tobiasdiez"
}
```

**Reviewer:** Tobias Diez, ...



---

archive/issue_comments_498290.json:
```json
{
    "body": "<a id='comment:23'></a>\nYes, in principle. But I cannot really judge the changes in the bash script.",
    "created_at": "2020-11-16T19:45:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498290",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:23'></a>
Yes, in principle. But I cannot really judge the changes in the bash script.



---

archive/issue_events_277297.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-11-17T22:17:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30923#event-277297"
}
```



---

archive/issue_events_277298.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-11-17T22:17:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30923#event-277298"
}
```



---

archive/issue_comments_498291.json:
```json
{
    "body": "<a id='comment:25'></a>\nok",
    "created_at": "2020-11-17T22:17:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498291",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:25'></a>
ok



---

archive/issue_comments_498292.json:
```json
{
    "body": "**Changing reviewer** from \"Tobias Diez, ...\" to \"Tobias Diez, Dima Pasechnik\".",
    "created_at": "2020-11-17T22:17:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498292",
    "user": "https://github.com/dimpase"
}
```

**Changing reviewer** from "Tobias Diez, ..." to "Tobias Diez, Dima Pasechnik".



---

archive/issue_comments_498293.json:
```json
{
    "body": "<a id='comment:26'></a>\nThanks!",
    "created_at": "2020-11-17T22:18:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498293",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:26'></a>
Thanks!



---

archive/issue_comments_498294.json:
```json
{
    "body": "<a id='comment:27'></a>\nIs it possible to call only the system package install code via tox (i.e. don't run rest of build and tests)? \n\nThat would be handy for #30371.",
    "created_at": "2020-11-21T12:51:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498294",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:27'></a>
Is it possible to call only the system package install code via tox (i.e. don't run rest of build and tests)? 

That would be handy for #30371.



---

archive/issue_comments_498295.json:
```json
{
    "body": "<a id='comment:28'></a>\nReplying to [@tobiasdiez](#comment%3A27):\n> Is it possible to call only the system package install code via tox (i.e. don't run rest of build and tests)? \n\nYes, you can pass make targets to tox, e.g., `tox -e local-sudo-standard -- configure` will only run `bootstrap`, or `tox -e local-sudo-standard -- config.status` will stop after running `./configure`",
    "created_at": "2020-11-21T18:54:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498295",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:28'></a>
Replying to [@tobiasdiez](#comment%3A27):
> Is it possible to call only the system package install code via tox (i.e. don't run rest of build and tests)? 

Yes, you can pass make targets to tox, e.g., `tox -e local-sudo-standard -- configure` will only run `bootstrap`, or `tox -e local-sudo-standard -- config.status` will stop after running `./configure`



---

archive/issue_comments_498296.json:
```json
{
    "body": "<a id='comment:29'></a>\nThanks! That kind of worked. I had to install `sudo` manually, since this is not installed by default on github actions and also not necessary.\nIt would be nice if you could try to make it work without sudo.\n\n```\nlocal-sudo-standard run-test: commands[2] | bash -c 'PACKAGES=`sed \"s/#.*//;\" build/pkgs/$(build/bin/sage-guess-package-system)*.txt`; $(build/bin/sage-print-system-package-command $(build/bin/sage-guess-package-system) --sudo --yes --no-install-recommends install $PACKAGES) || [ \"$IGNORE_MISSING_SYSTEM_PACKAGES\" = yes ] && echo \"(ignoring errors)\" '\n/usr/bin/bash: sudo: command not found\n\nERROR: InvocationError for command /usr/bin/bash -c 'PACKAGES=`sed \"s/#.*//;\" build/pkgs/$(build/bin/sage-guess-package-system)*.txt`; $(build/bin/sage-print-system-package-command $(build/bin/sage-guess-package-system) --sudo --yes --no-install-recommends install $PACKAGES) || [ \"$IGNORE_MISSING_SYSTEM_PACKAGES\" = yes ] && echo \"(ignoring errors)\" ' (exited with code 1)\n```\n\nEdit: Moreover, `DEBIAN_FRONTEND: noninteractive` was/is missing. And it fails with \n\n```\nconfigure: error: You cannot build Sage as root, switch to an unprivileged user.  (If building in a container, use --enable-build-as-root.)\n```\nFinally, `tox -e local-sudo-standard -- config.status` doesn't stop after contigure and continues with `make`, see https://github.com/tobiasdiez/sage/runs/1438029552?check_suite_focus=true\n\nSince using this tox command for ci was one of the motivations but doesn't really work at the moment without extra modifications, I'll set the ticket back to needs work.",
    "created_at": "2020-11-22T10:10:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498296",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:29'></a>
Thanks! That kind of worked. I had to install `sudo` manually, since this is not installed by default on github actions and also not necessary.
It would be nice if you could try to make it work without sudo.

```
local-sudo-standard run-test: commands[2] | bash -c 'PACKAGES=`sed "s/#.*//;" build/pkgs/$(build/bin/sage-guess-package-system)*.txt`; $(build/bin/sage-print-system-package-command $(build/bin/sage-guess-package-system) --sudo --yes --no-install-recommends install $PACKAGES) || [ "$IGNORE_MISSING_SYSTEM_PACKAGES" = yes ] && echo "(ignoring errors)" '
/usr/bin/bash: sudo: command not found

ERROR: InvocationError for command /usr/bin/bash -c 'PACKAGES=`sed "s/#.*//;" build/pkgs/$(build/bin/sage-guess-package-system)*.txt`; $(build/bin/sage-print-system-package-command $(build/bin/sage-guess-package-system) --sudo --yes --no-install-recommends install $PACKAGES) || [ "$IGNORE_MISSING_SYSTEM_PACKAGES" = yes ] && echo "(ignoring errors)" ' (exited with code 1)
```

Edit: Moreover, `DEBIAN_FRONTEND: noninteractive` was/is missing. And it fails with 

```
configure: error: You cannot build Sage as root, switch to an unprivileged user.  (If building in a container, use --enable-build-as-root.)
```
Finally, `tox -e local-sudo-standard -- config.status` doesn't stop after contigure and continues with `make`, see https://github.com/tobiasdiez/sage/runs/1438029552?check_suite_focus=true

Since using this tox command for ci was one of the motivations but doesn't really work at the moment without extra modifications, I'll set the ticket back to needs work.



---

archive/issue_events_277299.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-11-22T10:26:11Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30923#event-277299"
}
```



---

archive/issue_events_277300.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-11-22T10:26:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30923#event-277300"
}
```



---

archive/issue_events_277301.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-11-22T15:05:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30923#event-277301"
}
```



---

archive/issue_events_277302.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "40c167483f5706511593270f9b216b8f0f236706",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2020-11-22T15:05:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30923#event-277302"
}
```



---

archive/issue_comments_498297.json:
```json
{
    "body": "**Changing branch** from \"[u/mkoeppe/tox_ini__add_environments_local_sudo_ubuntu_standard__etc_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/tox_ini__add_environments_local_sudo_ubuntu_standard__etc_)\" to \"[ff34897cac35061afd348cc08a6559f95f406f14](https://github.com/sagemath/sagetrac-mirror/commit/ff34897cac35061afd348cc08a6559f95f406f14)\".",
    "created_at": "2020-11-22T15:05:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498297",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/mkoeppe/tox_ini__add_environments_local_sudo_ubuntu_standard__etc_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/tox_ini__add_environments_local_sudo_ubuntu_standard__etc_)" to "[ff34897cac35061afd348cc08a6559f95f406f14](https://github.com/sagemath/sagetrac-mirror/commit/ff34897cac35061afd348cc08a6559f95f406f14)".



---

archive/issue_comments_498298.json:
```json
{
    "body": "<a id='comment:32'></a>\nCan you make a separate ticket for that? Once a ticket is in positive review I'll only unmerge it for critical bugs, not things that would also be good to have.",
    "created_at": "2020-11-22T15:13:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498298",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:32'></a>
Can you make a separate ticket for that? Once a ticket is in positive review I'll only unmerge it for critical bugs, not things that would also be good to have.



---

archive/issue_comments_498299.json:
```json
{
    "body": "**Changing commit** from \"[ff34897cac35061afd348cc08a6559f95f406f14](https://github.com/sagemath/sagetrac-mirror/commit/ff34897cac35061afd348cc08a6559f95f406f14)\" to \"\".",
    "created_at": "2020-11-22T15:13:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498299",
    "user": "https://github.com/vbraun"
}
```

**Changing commit** from "[ff34897cac35061afd348cc08a6559f95f406f14](https://github.com/sagemath/sagetrac-mirror/commit/ff34897cac35061afd348cc08a6559f95f406f14)" to "".



---

archive/issue_comments_498300.json:
```json
{
    "body": "<a id='comment:33'></a>\nSure! It's now #30944. Sorry if I broke any (unwritten) laws; I wasn't sure about resetting it to \"needs work\".",
    "created_at": "2020-11-22T17:54:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30923#issuecomment-498300",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:33'></a>
Sure! It's now #30944. Sorry if I broke any (unwritten) laws; I wasn't sure about resetting it to "needs work".
