# Issue 30923: tox.ini: Add environments local-sudo-ubuntu-standard, etc.

archive/issues_030686.json:
```json
{
    "body": "These environments would just run `sudo apt-get ...` etc. to install (but not remove!) packages, for use at the user's own risk.\n\nTo test (on an Ubuntu system):\n\n```\n    tox -e local-sudo-ubuntu-bionic-standard\n```\nor\n\n```\n    tox -e local-sudo-standard\n```\n\n\n  \n\nCC:  @tobiasdiez @dimpase\n\nReviewer: Tobias Diez, Dima Pasechnik\n\nAuthor: Matthias Koeppe\n\nBranch: ff34897cac35061afd348cc08a6559f95f406f14\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30923\n\n",
    "closed_at": "2020-11-22T15:05:26Z",
    "created_at": "2020-11-15T23:38:33Z",
    "labels": [
        "component: porting"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "tox.ini: Add environments local-sudo-ubuntu-standard, etc.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30923",
    "user": "https://github.com/mkoeppe"
}
```
These environments would just run `sudo apt-get ...` etc. to install (but not remove!) packages, for use at the user's own risk.

To test (on an Ubuntu system):

```
    tox -e local-sudo-ubuntu-bionic-standard
```
or

```
    tox -e local-sudo-standard
```


  

CC:  @tobiasdiez @dimpase

Reviewer: Tobias Diez, Dima Pasechnik

Author: Matthias Koeppe

Branch: ff34897cac35061afd348cc08a6559f95f406f14

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/30923





---

archive/issue_comments_613497.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2020-11-15T23:46:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613497",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_comments_613498.json:
```json
{
    "body": "<a id='comment:2'></a>Is it possible to put the sudo outside? I.e. `sudo tox -r local-ubuntu-standard`?",
    "created_at": "2020-11-16T00:03:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613498",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:2'></a>Is it possible to put the sudo outside? I.e. `sudo tox -r local-ubuntu-standard`?



---

archive/issue_comments_613499.json:
```json
{
    "body": "<a id='comment:3'></a>But we would only want to do the package installation as root, not the Sage build",
    "created_at": "2020-11-16T00:06:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613499",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>But we would only want to do the package installation as root, not the Sage build



---

archive/issue_comments_613500.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/tox_ini__add_environments_local_sudo_ubuntu_standard__etc_\"",
    "created_at": "2020-11-16T00:07:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613500",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/tox_ini__add_environments_local_sudo_ubuntu_standard__etc_"



---

archive/issue_comments_613501.json:
```json
{
    "body": "Changing commit from \"\" to \"30e624abbc52b5a5a060a4eca801e8fda303937f\"",
    "created_at": "2020-11-16T00:07:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613501",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "" to "30e624abbc52b5a5a060a4eca801e8fda303937f"



---

archive/issue_comments_613502.json:
```json
{
    "body": "<a id='comment:5'></a>Here's a first approximation.\n\n---\nNew commits:",
    "created_at": "2020-11-16T00:07:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613502",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>Here's a first approximation.

---
New commits:



---

archive/issue_comments_613503.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,2 +1,10 @@\n These environments would just run `sudo apt-get ...` etc. to install (but not remove!) packages, for use at the user's own risk.\n \n+To test (on an Ubuntu system):\n+\n+```\n+    tox -e local-sudo-ubuntu-standard\n+```\n+\n+\n+  \n``````\n",
    "created_at": "2020-11-16T00:09:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613503",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,2 +1,10 @@
 These environments would just run `sudo apt-get ...` etc. to install (but not remove!) packages, for use at the user's own risk.
 
+To test (on an Ubuntu system):
+
+```
+    tox -e local-sudo-ubuntu-standard
+```
+
+
+  
``````




---

archive/issue_comments_613504.json:
```json
{
    "body": "<a id='comment:7'></a>I think you forgot the confirmation `-y` after `install`: https://github.com/tobiasdiez/sage/commit/942149ee76a97628046042b7255a2d31630e7721\n\nMoreover, I was wondering if one should also read the `debian-bootstrap.txt` files.\n\nFinally, there are problems that some of the packages are not found. First, one should probably add `sudo add-apt-repository ppa:deadsnakes/ppa` since otherwise `libpython3.7-dev` is not found on ubuntu 20.04. Second, `texlive-generic-extra` doesn't exist on ubuntu 20.04.\nhttps://github.com/tobiasdiez/sage/runs/1404001507?check_suite_focus=true\n\nOther than that, looks good to me! Thanks a lot.",
    "created_at": "2020-11-16T00:50:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613504",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:7'></a>I think you forgot the confirmation `-y` after `install`: https://github.com/tobiasdiez/sage/commit/942149ee76a97628046042b7255a2d31630e7721

Moreover, I was wondering if one should also read the `debian-bootstrap.txt` files.

Finally, there are problems that some of the packages are not found. First, one should probably add `sudo add-apt-repository ppa:deadsnakes/ppa` since otherwise `libpython3.7-dev` is not found on ubuntu 20.04. Second, `texlive-generic-extra` doesn't exist on ubuntu 20.04.
https://github.com/tobiasdiez/sage/runs/1404001507?check_suite_focus=true

Other than that, looks good to me! Thanks a lot.



---

archive/issue_comments_613505.json:
```json
{
    "body": "<a id='comment:8'></a>Yes, I'll add bootstrap\n\nI don't think we have `libpython3.7-dev` listed in the debian.txt files any more.\n\nBut yes, handling `IGNORE_MISSING_SYSTEM_PACKAGES` needs to be done.\n\nFor deadsnakes, there's #30217. This would not be the default, but a mix-in flavor.",
    "created_at": "2020-11-16T00:55:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613505",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>Yes, I'll add bootstrap

I don't think we have `libpython3.7-dev` listed in the debian.txt files any more.

But yes, handling `IGNORE_MISSING_SYSTEM_PACKAGES` needs to be done.

For deadsnakes, there's #30217. This would not be the default, but a mix-in flavor.



---

archive/issue_comments_613506.json:
```json
{
    "body": "<a id='comment:9'></a>On a second thought, do you really thing it's the job of tox to install system packages? I would feel more comfortable to put the code into a  shell script that you can run as `build/install_system_packages ubuntu-2004`, say. (Having such a script might be a good idea anyway).",
    "created_at": "2020-11-16T00:56:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613506",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:9'></a>On a second thought, do you really thing it's the job of tox to install system packages? I would feel more comfortable to put the code into a  shell script that you can run as `build/install_system_packages ubuntu-2004`, say. (Having such a script might be a good idea anyway).



---

archive/issue_comments_613507.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-16T00:57:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613507",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_613508.json:
```json
{
    "body": "Changing commit from \"30e624abbc52b5a5a060a4eca801e8fda303937f\" to \"75ecd11e878e34a4c508d2f983b6d7527e689f94\"",
    "created_at": "2020-11-16T00:57:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613508",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "30e624abbc52b5a5a060a4eca801e8fda303937f" to "75ecd11e878e34a4c508d2f983b6d7527e689f94"



---

archive/issue_comments_613509.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:8 mkoeppe]:\n> But yes, handling `IGNORE_MISSING_SYSTEM_PACKAGES` needs to be done.\n\n\nand/or change `texlive-generic-extra` that exist on modern ubuntu systems as well.",
    "created_at": "2020-11-16T00:59:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613509",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:11'></a>Replying to [comment:8 mkoeppe]:
> But yes, handling `IGNORE_MISSING_SYSTEM_PACKAGES` needs to be done.


and/or change `texlive-generic-extra` that exist on modern ubuntu systems as well.



---

archive/issue_comments_613510.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:10 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> |                                                                                                                                           |                                                  |\n> |-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|\n> |[75ecd11](https://git.sagemath.org/sage.git/commit/?id=75ecd11e878e34a4c508d2f983b6d7527e689f94)|`tox.ini (local-sudo): Also use ...-bootstrap.txt`|\n\n\nDon't forget to change local-sudo-standard/maximal as well.",
    "created_at": "2020-11-16T01:01:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613510",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:12'></a>Replying to [comment:10 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> |                                                                                                                                           |                                                  |
> |-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|
> |[75ecd11](https://git.sagemath.org/sage.git/commit/?id=75ecd11e878e34a4c508d2f983b6d7527e689f94)|`tox.ini (local-sudo): Also use ...-bootstrap.txt`|


Don't forget to change local-sudo-standard/maximal as well.



---

archive/issue_comments_613511.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:9 gh-tobiasdiez]:\n> On a second thought, do you really thing it's the job of tox to install system packages? I would feel more comfortable to put the code into a  shell script that you can run as `build/install_system_packages ubuntu-2004`, say. (Having such a script might be a good idea anyway).  \n\n\nIt's working well with tox, in particular the environment factors give a nice compact way of expressing different configurations. \n\nAnd I definitely do not want to add user-facing scripts to Sage that promises to install all necessary system packages. We deliberately only offer system package *advice* (at the end of `./configure`). Already now users complain if that advice is not entirely accurate -- so we definitely do not want to make stronger promises! We simply do not have enough developers who could keep it up to date.\n\nBut there is a lot of room for refactoring what is in `tox.ini` into various helper scripts. I have described some possible directions in #30865 -- help is very welcome there.",
    "created_at": "2020-11-16T01:08:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613511",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>Replying to [comment:9 gh-tobiasdiez]:
> On a second thought, do you really thing it's the job of tox to install system packages? I would feel more comfortable to put the code into a  shell script that you can run as `build/install_system_packages ubuntu-2004`, say. (Having such a script might be a good idea anyway).  


It's working well with tox, in particular the environment factors give a nice compact way of expressing different configurations. 

And I definitely do not want to add user-facing scripts to Sage that promises to install all necessary system packages. We deliberately only offer system package *advice* (at the end of `./configure`). Already now users complain if that advice is not entirely accurate -- so we definitely do not want to make stronger promises! We simply do not have enough developers who could keep it up to date.

But there is a lot of room for refactoring what is in `tox.ini` into various helper scripts. I have described some possible directions in #30865 -- help is very welcome there.



---

archive/issue_comments_613512.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:12 gh-tobiasdiez]:\n> Replying to [comment:10 git]:\n> > Branch pushed to git repo; I updated commit sha1. New commits:\n> > |                                                                                                                                           |                                                  |\n> > |-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|\n> > |[75ecd11](https://git.sagemath.org/sage.git/commit/?id=75ecd11e878e34a4c508d2f983b6d7527e689f94)|`tox.ini (local-sudo): Also use ...-bootstrap.txt`|\n\n> \n> Don't forget to change local-sudo-standard/maximal as well.\n\nNo, that line is also executed for these environments - by the magic of tox's factor conditions.",
    "created_at": "2020-11-16T01:09:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613512",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>Replying to [comment:12 gh-tobiasdiez]:
> Replying to [comment:10 git]:
> > Branch pushed to git repo; I updated commit sha1. New commits:
> > |                                                                                                                                           |                                                  |
> > |-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------|
> > |[75ecd11](https://git.sagemath.org/sage.git/commit/?id=75ecd11e878e34a4c508d2f983b6d7527e689f94)|`tox.ini (local-sudo): Also use ...-bootstrap.txt`|

> 
> Don't forget to change local-sudo-standard/maximal as well.

No, that line is also executed for these environments - by the magic of tox's factor conditions.



---

archive/issue_comments_613513.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-16T01:38:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613513",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_613514.json:
```json
{
    "body": "Changing commit from \"75ecd11e878e34a4c508d2f983b6d7527e689f94\" to \"050dcb8275b3a7e0db4c7ae3503428107bb5bf17\"",
    "created_at": "2020-11-16T01:38:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613514",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "75ecd11e878e34a4c508d2f983b6d7527e689f94" to "050dcb8275b3a7e0db4c7ae3503428107bb5bf17"



---

archive/issue_comments_613515.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-16T01:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613515",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_613516.json:
```json
{
    "body": "Changing commit from \"050dcb8275b3a7e0db4c7ae3503428107bb5bf17\" to \"c8fbe0beaec3a404d330aaebdf37186e9c6becec\"",
    "created_at": "2020-11-16T01:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613516",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "050dcb8275b3a7e0db4c7ae3503428107bb5bf17" to "c8fbe0beaec3a404d330aaebdf37186e9c6becec"



---

archive/issue_comments_613517.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-11-16T02:05:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613517",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_613518.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -3,8 +3,7 @@\n To test (on an Ubuntu system):\n \n ```\n-    tox -e local-sudo-ubuntu-standard\n+    tox -e local-sudo-ubuntu-bionic-standard\n ```\n \n-\n   \n``````\n",
    "created_at": "2020-11-16T02:05:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613518",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -3,8 +3,7 @@
 To test (on an Ubuntu system):
 
 ```
-    tox -e local-sudo-ubuntu-standard
+    tox -e local-sudo-ubuntu-bionic-standard
 ```
 
-
   
``````




---

archive/issue_comments_613519.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-16T03:00:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613519",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_613520.json:
```json
{
    "body": "Changing commit from \"c8fbe0beaec3a404d330aaebdf37186e9c6becec\" to \"ff34897cac35061afd348cc08a6559f95f406f14\"",
    "created_at": "2020-11-16T03:00:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613520",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c8fbe0beaec3a404d330aaebdf37186e9c6becec" to "ff34897cac35061afd348cc08a6559f95f406f14"



---

archive/issue_comments_613521.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,5 +5,11 @@\n ```\n     tox -e local-sudo-ubuntu-bionic-standard\n ```\n+or\n+\n+```\n+    tox -e local-sudo-standard\n+```\n+\n \n   \n``````\n",
    "created_at": "2020-11-16T03:01:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613521",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,5 +5,11 @@
 ```
     tox -e local-sudo-ubuntu-bionic-standard
 ```
+or
+
+```
+    tox -e local-sudo-standard
+```
+
 
   
``````




---

archive/issue_comments_613522.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:13 mkoeppe]:\n> Replying to [comment:9 gh-tobiasdiez]:\n> > On a second thought, do you really thing it's the job of tox to install system packages? I would feel more comfortable to put the code into a  shell script that you can run as `build/install_system_packages ubuntu-2004`, say. (Having such a script might be a good idea anyway).  \n\n> \n> It's working well with tox, in particular the environment factors give a nice compact way of expressing different configurations. \n\n\nSure, but it feels a bit like you are using tox for something it wasn't designed. Normally, in a tox setting, \"environment\" refers to a virtual python env, but for sage it is the complete system env including the os and system packages. I have the feeling a more general-purpose framework like invoke would be a better solution to manage these things.\n\n> And I definitely do not want to add user-facing scripts to Sage that promises to install all necessary system packages.\n\n\nI didn't meant it as a user-facing script, but only for developers (i.e don't ship it).",
    "created_at": "2020-11-16T10:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613522",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:20'></a>Replying to [comment:13 mkoeppe]:
> Replying to [comment:9 gh-tobiasdiez]:
> > On a second thought, do you really thing it's the job of tox to install system packages? I would feel more comfortable to put the code into a  shell script that you can run as `build/install_system_packages ubuntu-2004`, say. (Having such a script might be a good idea anyway).  

> 
> It's working well with tox, in particular the environment factors give a nice compact way of expressing different configurations. 


Sure, but it feels a bit like you are using tox for something it wasn't designed. Normally, in a tox setting, "environment" refers to a virtual python env, but for sage it is the complete system env including the os and system packages. I have the feeling a more general-purpose framework like invoke would be a better solution to manage these things.

> And I definitely do not want to add user-facing scripts to Sage that promises to install all necessary system packages.


I didn't meant it as a user-facing script, but only for developers (i.e don't ship it).



---

archive/issue_comments_613523.json:
```json
{
    "body": "<a id='comment:21'></a>I've tested the current code in the wsl github workflow and it seems to work well: https://github.com/tobiasdiez/sage/actions/runs/365823571",
    "created_at": "2020-11-16T10:58:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613523",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:21'></a>I've tested the current code in the wsl github workflow and it seems to work well: https://github.com/tobiasdiez/sage/actions/runs/365823571



---

archive/issue_comments_613524.json:
```json
{
    "body": "<a id='comment:22'></a>Sounds like a positive review?",
    "created_at": "2020-11-16T18:18:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613524",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'></a>Sounds like a positive review?



---

archive/issue_comments_613525.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Tobias Diez, ...\"",
    "created_at": "2020-11-16T19:45:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613525",
    "user": "https://github.com/tobiasdiez"
}
```

Changing reviewer from "" to "Tobias Diez, ..."



---

archive/issue_comments_613526.json:
```json
{
    "body": "<a id='comment:23'></a>Yes, in principle. But I cannot really judge the changes in the bash script.",
    "created_at": "2020-11-16T19:45:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613526",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:23'></a>Yes, in principle. But I cannot really judge the changes in the bash script.



---

archive/issue_comments_613527.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-11-17T22:17:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613527",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_613528.json:
```json
{
    "body": "<a id='comment:25'></a>ok",
    "created_at": "2020-11-17T22:17:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613528",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:25'></a>ok



---

archive/issue_comments_613529.json:
```json
{
    "body": "Changing reviewer from \"Tobias Diez, ...\" to \"Tobias Diez, Dima Pasechnik\"",
    "created_at": "2020-11-17T22:17:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613529",
    "user": "https://github.com/dimpase"
}
```

Changing reviewer from "Tobias Diez, ..." to "Tobias Diez, Dima Pasechnik"



---

archive/issue_comments_613530.json:
```json
{
    "body": "<a id='comment:26'></a>Thanks!",
    "created_at": "2020-11-17T22:18:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613530",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:26'></a>Thanks!



---

archive/issue_comments_613531.json:
```json
{
    "body": "<a id='comment:27'></a>Is it possible to call only the system package install code via tox (i.e. don't run rest of build and tests)? \n\nThat would be handy for #30371.",
    "created_at": "2020-11-21T12:51:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613531",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:27'></a>Is it possible to call only the system package install code via tox (i.e. don't run rest of build and tests)? 

That would be handy for #30371.



---

archive/issue_comments_613532.json:
```json
{
    "body": "<a id='comment:28'></a>Replying to [comment:27 gh-tobiasdiez]:\n> Is it possible to call only the system package install code via tox (i.e. don't run rest of build and tests)? \n\nYes, you can pass make targets to tox, e.g., `tox -e local-sudo-standard -- configure` will only run `bootstrap`, or `tox -e local-sudo-standard -- config.status` will stop after running `./configure`",
    "created_at": "2020-11-21T18:54:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613532",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:28'></a>Replying to [comment:27 gh-tobiasdiez]:
> Is it possible to call only the system package install code via tox (i.e. don't run rest of build and tests)? 

Yes, you can pass make targets to tox, e.g., `tox -e local-sudo-standard -- configure` will only run `bootstrap`, or `tox -e local-sudo-standard -- config.status` will stop after running `./configure`



---

archive/issue_comments_613533.json:
```json
{
    "body": "<a id='comment:29'></a>Thanks! That kind of worked. I had to install `sudo` manually, since this is not installed by default on github actions and also not necessary.\nIt would be nice if you could try to make it work without sudo.\n\n```\nlocal-sudo-standard run-test: commands[2] | bash -c 'PACKAGES=`sed \"s/#.*//;\" build/pkgs/$(build/bin/sage-guess-package-system)*.txt`; $(build/bin/sage-print-system-package-command $(build/bin/sage-guess-package-system) --sudo --yes --no-install-recommends install $PACKAGES) || [ \"$IGNORE_MISSING_SYSTEM_PACKAGES\" = yes ] && echo \"(ignoring errors)\" '\n/usr/bin/bash: sudo: command not found\n\nERROR: InvocationError for command /usr/bin/bash -c 'PACKAGES=`sed \"s/#.*//;\" build/pkgs/$(build/bin/sage-guess-package-system)*.txt`; $(build/bin/sage-print-system-package-command $(build/bin/sage-guess-package-system) --sudo --yes --no-install-recommends install $PACKAGES) || [ \"$IGNORE_MISSING_SYSTEM_PACKAGES\" = yes ] && echo \"(ignoring errors)\" ' (exited with code 1)\n```\n\nEdit: Moreover, `DEBIAN_FRONTEND: noninteractive` was/is missing. And it fails with \n\n```\nconfigure: error: You cannot build Sage as root, switch to an unprivileged user.  (If building in a container, use --enable-build-as-root.)\n```\nFinally, `tox -e local-sudo-standard -- config.status` doesn't stop after contigure and continues with `make`, see https://github.com/tobiasdiez/sage/runs/1438029552?check_suite_focus=true\n\nSince using this tox command for ci was one of the motivations but doesn't really work at the moment without extra modifications, I'll set the ticket back to needs work.",
    "created_at": "2020-11-22T10:10:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613533",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:29'></a>Thanks! That kind of worked. I had to install `sudo` manually, since this is not installed by default on github actions and also not necessary.
It would be nice if you could try to make it work without sudo.

```
local-sudo-standard run-test: commands[2] | bash -c 'PACKAGES=`sed "s/#.*//;" build/pkgs/$(build/bin/sage-guess-package-system)*.txt`; $(build/bin/sage-print-system-package-command $(build/bin/sage-guess-package-system) --sudo --yes --no-install-recommends install $PACKAGES) || [ "$IGNORE_MISSING_SYSTEM_PACKAGES" = yes ] && echo "(ignoring errors)" '
/usr/bin/bash: sudo: command not found

ERROR: InvocationError for command /usr/bin/bash -c 'PACKAGES=`sed "s/#.*//;" build/pkgs/$(build/bin/sage-guess-package-system)*.txt`; $(build/bin/sage-print-system-package-command $(build/bin/sage-guess-package-system) --sudo --yes --no-install-recommends install $PACKAGES) || [ "$IGNORE_MISSING_SYSTEM_PACKAGES" = yes ] && echo "(ignoring errors)" ' (exited with code 1)
```

Edit: Moreover, `DEBIAN_FRONTEND: noninteractive` was/is missing. And it fails with 

```
configure: error: You cannot build Sage as root, switch to an unprivileged user.  (If building in a container, use --enable-build-as-root.)
```
Finally, `tox -e local-sudo-standard -- config.status` doesn't stop after contigure and continues with `make`, see https://github.com/tobiasdiez/sage/runs/1438029552?check_suite_focus=true

Since using this tox command for ci was one of the motivations but doesn't really work at the moment without extra modifications, I'll set the ticket back to needs work.



---

archive/issue_comments_613534.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-11-22T10:26:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613534",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_613535.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-11-22T15:05:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613535",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_080742.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-11-22T15:05:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30923#event-80742"
}
```



---

archive/issue_comments_613536.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/tox_ini__add_environments_local_sudo_ubuntu_standard__etc_\" to \"ff34897cac35061afd348cc08a6559f95f406f14\"",
    "created_at": "2020-11-22T15:05:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613536",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mkoeppe/tox_ini__add_environments_local_sudo_ubuntu_standard__etc_" to "ff34897cac35061afd348cc08a6559f95f406f14"



---

archive/issue_comments_613537.json:
```json
{
    "body": "<a id='comment:32'></a>Can you make a separate ticket for that? Once a ticket is in positive review I'll only unmerge it for critical bugs, not things that would also be good to have.",
    "created_at": "2020-11-22T15:13:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613537",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:32'></a>Can you make a separate ticket for that? Once a ticket is in positive review I'll only unmerge it for critical bugs, not things that would also be good to have.



---

archive/issue_comments_613538.json:
```json
{
    "body": "Changing commit from \"ff34897cac35061afd348cc08a6559f95f406f14\" to \"\"",
    "created_at": "2020-11-22T15:13:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613538",
    "user": "https://github.com/vbraun"
}
```

Changing commit from "ff34897cac35061afd348cc08a6559f95f406f14" to ""



---

archive/issue_comments_613539.json:
```json
{
    "body": "<a id='comment:33'></a>Sure! It's now #30944. Sorry if I broke any (unwritten) laws; I wasn't sure about resetting it to \"needs work\".",
    "created_at": "2020-11-22T17:54:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30923",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30923#issuecomment-613539",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:33'></a>Sure! It's now #30944. Sorry if I broke any (unwritten) laws; I wasn't sure about resetting it to "needs work".
