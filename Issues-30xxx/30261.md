# Issue 30261: Meta-ticket: Immutability for manifold objects

archive/issues_030024.json:
```json
{
    "body": "CC:  @egourgoulhon @mkoeppe @tscrim\n\nKeywords: immutability\n\nTensor fields, scalar fields, sections and (bundle) connections are a priori mutable. However, according to #30181, it should be possible to make them immutable and in conclusion to make them hashable.\n\nConnections and bundle connections are already hashable even though they are not immutable. This will be changed accordingly in this ticket.\n\n- Scalar Fields: #30266\n- Scalar Fields II: #30311\n- Tensor Fields (without hash): #30274, #31255\n- Affine Connections: #30280\n- Bundle Connections: #30284\n- Sections (without hash): #30288, #31255\n- Chart Functions (without hash): #30310\n- Mixed Differential Forms: #31706\n\nIssue created by migration from https://trac.sagemath.org/ticket/30261\n\n",
    "closed_at": "2021-07-25T13:50:22Z",
    "created_at": "2020-07-31T13:29:57Z",
    "labels": [
        "component: manifolds"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Meta-ticket: Immutability for manifold objects",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30261",
    "user": "https://github.com/mjungmath"
}
```
CC:  @egourgoulhon @mkoeppe @tscrim

Keywords: immutability

Tensor fields, scalar fields, sections and (bundle) connections are a priori mutable. However, according to #30181, it should be possible to make them immutable and in conclusion to make them hashable.

Connections and bundle connections are already hashable even though they are not immutable. This will be changed accordingly in this ticket.

- Scalar Fields: #30266
- Scalar Fields II: #30311
- Tensor Fields (without hash): #30274, #31255
- Affine Connections: #30280
- Bundle Connections: #30284
- Sections (without hash): #30288, #31255
- Chart Functions (without hash): #30310
- Mixed Differential Forms: #31706

Issue created by migration from https://trac.sagemath.org/ticket/30261





---

archive/issue_comments_426308.json:
```json
{
    "body": "I haven't found any active use of the `Mutability` class in the whole Sage library. For the sake of generality, it would be good to have a class which inherits from `SageObject` and represents a mutable element. This would be good for e.g. connections. Either one adds such a class to `sage.structure.mutability` or, since the aforementioned class is not actively used anywhere, rename it accordingly (like `ElementWithMutability`) and adding an inheritance from `SageObject`. Of course, I would open another ticket for that. Probably, the `ModuleElementWithMutability` should be shifted in that file, too?\n\nThere is another issue, I have encountered due to the dependence of #30181. I simply changed the following lines in `sage.manifolds.differentiable.tensorfield`:\n\n```diff\n-from sage.structure.element import ModuleElement\n+from sage.structure.element import ModuleElementWithMutability\n\n-class TensorField(ModuleElement):\n+class TensorField(ModuleElementWithMutability):\n\n-        ModuleElement.__init__(self, parent)\n+        super().__init__(parent)\n```\n\nand I get the following error message:\n\n```\nsage: M = Manifold(2, 'M')\nsage: U = M.open_subset('U'); V = M.open_subset('V')\nsage: c_xy.<x,y> = U.chart(); c_uv.<u,v> = V.chart()\nTraceback (most recent call last)\n...\nTypeError: __init__() missing 1 required positional argument: 'tensor_type'\n```",
    "created_at": "2020-07-31T20:18:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426308",
    "user": "https://github.com/mjungmath"
}
```

I haven't found any active use of the `Mutability` class in the whole Sage library. For the sake of generality, it would be good to have a class which inherits from `SageObject` and represents a mutable element. This would be good for e.g. connections. Either one adds such a class to `sage.structure.mutability` or, since the aforementioned class is not actively used anywhere, rename it accordingly (like `ElementWithMutability`) and adding an inheritance from `SageObject`. Of course, I would open another ticket for that. Probably, the `ModuleElementWithMutability` should be shifted in that file, too?

There is another issue, I have encountered due to the dependence of #30181. I simply changed the following lines in `sage.manifolds.differentiable.tensorfield`:

```diff
-from sage.structure.element import ModuleElement
+from sage.structure.element import ModuleElementWithMutability

-class TensorField(ModuleElement):
+class TensorField(ModuleElementWithMutability):

-        ModuleElement.__init__(self, parent)
+        super().__init__(parent)
```

and I get the following error message:

```
sage: M = Manifold(2, 'M')
sage: U = M.open_subset('U'); V = M.open_subset('V')
sage: c_xy.<x,y> = U.chart(); c_uv.<u,v> = V.chart()
Traceback (most recent call last)
...
TypeError: __init__() missing 1 required positional argument: 'tensor_type'
```



---

archive/issue_comments_426309.json:
```json
{
    "body": "If you `super`, all `__init__`s need to have a compatible signature...",
    "created_at": "2020-07-31T20:36:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426309",
    "user": "https://github.com/mkoeppe"
}
```

If you `super`, all `__init__`s need to have a compatible signature...



---

archive/issue_comments_426310.json:
```json
{
    "body": "Replying to [comment:6 gh-mjungmath]:\n> For the sake of generality, it would be good to have a class which inherits from `SageObject` and represents a mutable element. This would be good for e.g. connections.\n\n\nStrong -1 This is a mixin class. Just add it to your inheritance. You don't have any Cython classes, so you can use multiple inheritance without any issues. I don't expect too many cases where having Cython is useful for elements with mutabiliy.\n\n> Probably, the `ModuleElementWithMutability` should be shifted in that file, too?\n\n\n-1 All of the ABCs for the elements are in `element.pyx`. Moving it would make it harder to find.",
    "created_at": "2020-08-01T01:48:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426310",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:6 gh-mjungmath]:
> For the sake of generality, it would be good to have a class which inherits from `SageObject` and represents a mutable element. This would be good for e.g. connections.


Strong -1 This is a mixin class. Just add it to your inheritance. You don't have any Cython classes, so you can use multiple inheritance without any issues. I don't expect too many cases where having Cython is useful for elements with mutabiliy.

> Probably, the `ModuleElementWithMutability` should be shifted in that file, too?


-1 All of the ABCs for the elements are in `element.pyx`. Moving it would make it harder to find.



---

archive/issue_comments_426311.json:
```json
{
    "body": "Replying to [comment:8 tscrim]:\n> Strong -1 This is a mixin class. Just add it to your inheritance. You don't have any Cython classes, so you can use multiple inheritance without any issues. I don't expect too many cases where having Cython is useful for elements with mutabiliy.\n\n\nYou mean\n\n```diff\n-class AffineConnection(SageObject):\n+class AffineConnection(SageObject, Mutability):\n```\n\nWhy is it working in this case? `SageObject` and `Mutability` are both Cython classes. I am a little bit confused...sorry.\n\n> \n> > Probably, the `ModuleElementWithMutability` should be shifted in that file, too?\n\n> \n> -1 All of the ABCs for the elements are in `element.pyx`. Moving it would make it harder to find.\n\n\nAlright, that makes sense.\n\n---\n\nThe inheritance above seems to cause some trouble, I think due to the `__reduce__` method in `Mutability`:\n\n```\nFile \"src/sage/manifolds/differentiable/affine_connection.py\", line 350, in sage.manifolds.differentiable.affine_connection.AffineConnection.__init__\nFailed example:\n    TestSuite(nab).run()\nExpected nothing\nGot:\n    Failure in _test_pickling:\n    Traceback (most recent call last):\n      File \"/home/michi/Projekte/sage-devel/local/lib/python3.7/site-packages/sage/misc/sage_unittest.py\", line 296, in run\n        test_method(tester=tester)\n      File \"sage/structure/sage_object.pyx\", line 639, in sage.structure.sage_object.SageObject._test_pickling (build/cythonized/sage/structure/sage_object.c:4953)\n        tester.assertEqual(loads(dumps(self)), self)\n      File \"/home/michi/Projekte/sage-devel/local/lib/python3.7/unittest/case.py\", line 839, in assertEqual\n        assertion_func(first, second, msg=msg)\n      File \"/home/michi/Projekte/sage-devel/local/lib/python3.7/unittest/case.py\", line 832, in _baseAssertEqual\n        raise self.failureException(msg)\n    AssertionError: <sage.structure.mutability.Mutability object at 0x7fc1d06dd410> != Affine connection nabla on the 3-dimensional differentiable manifold M\n    ------------------------------------------------------------\n    The following tests failed: _test_pickling\n```",
    "created_at": "2020-08-01T06:26:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426311",
    "user": "https://github.com/mjungmath"
}
```

Replying to [comment:8 tscrim]:
> Strong -1 This is a mixin class. Just add it to your inheritance. You don't have any Cython classes, so you can use multiple inheritance without any issues. I don't expect too many cases where having Cython is useful for elements with mutabiliy.


You mean

```diff
-class AffineConnection(SageObject):
+class AffineConnection(SageObject, Mutability):
```

Why is it working in this case? `SageObject` and `Mutability` are both Cython classes. I am a little bit confused...sorry.

> 
> > Probably, the `ModuleElementWithMutability` should be shifted in that file, too?

> 
> -1 All of the ABCs for the elements are in `element.pyx`. Moving it would make it harder to find.


Alright, that makes sense.

---

The inheritance above seems to cause some trouble, I think due to the `__reduce__` method in `Mutability`:

```
File "src/sage/manifolds/differentiable/affine_connection.py", line 350, in sage.manifolds.differentiable.affine_connection.AffineConnection.__init__
Failed example:
    TestSuite(nab).run()
Expected nothing
Got:
    Failure in _test_pickling:
    Traceback (most recent call last):
      File "/home/michi/Projekte/sage-devel/local/lib/python3.7/site-packages/sage/misc/sage_unittest.py", line 296, in run
        test_method(tester=tester)
      File "sage/structure/sage_object.pyx", line 639, in sage.structure.sage_object.SageObject._test_pickling (build/cythonized/sage/structure/sage_object.c:4953)
        tester.assertEqual(loads(dumps(self)), self)
      File "/home/michi/Projekte/sage-devel/local/lib/python3.7/unittest/case.py", line 839, in assertEqual
        assertion_func(first, second, msg=msg)
      File "/home/michi/Projekte/sage-devel/local/lib/python3.7/unittest/case.py", line 832, in _baseAssertEqual
        raise self.failureException(msg)
    AssertionError: <sage.structure.mutability.Mutability object at 0x7fc1d06dd410> != Affine connection nabla on the 3-dimensional differentiable manifold M
    ------------------------------------------------------------
    The following tests failed: _test_pickling
```



---

archive/issue_comments_426312.json:
```json
{
    "body": "Replying to [comment:9 gh-mjungmath]:\n> Replying to [comment:8 tscrim]:\n> > Strong -1 This is a mixin class. Just add it to your inheritance. You don't have any Cython classes, so you can use multiple inheritance without any issues. I don't expect too many cases where having Cython is useful for elements with mutabiliy.\n\n> \n> You mean\n> \n> \n> ```\n> #!diff\n> -class AffineConnection(SageObject):\n> +class AffineConnection(SageObject, Mutability):\n> ```\n> \n> Why is it working in this case? `SageObject` and `Mutability` are both Cython classes. I am a little bit confused...sorry.\n\n\nNo. A Cython class cannot inherit from multiple things, but a Python class (as you have here) can. The classes it inherits from can both be Cython classes.\n\n> ---\n> \n> The inheritance above seems to cause some trouble, I think due to the `__reduce__` method in `Mutability`:\n> \n> \n> ```\n> File \"src/sage/manifolds/differentiable/affine_connection.py\", line 350, in sage.manifolds.differentiable.affine_connection.AffineConnection.__init__\n> Failed example:\n>     TestSuite(nab).run()\n> Expected nothing\n> Got:\n>     Failure in _test_pickling:\n>     Traceback (most recent call last):\n>       File \"/home/michi/Projekte/sage-devel/local/lib/python3.7/site-packages/sage/misc/sage_unittest.py\", line 296, in run\n>         test_method(tester=tester)\n>       File \"sage/structure/sage_object.pyx\", line 639, in sage.structure.sage_object.SageObject._test_pickling (build/cythonized/sage/structure/sage_object.c:4953)\n>         tester.assertEqual(loads(dumps(self)), self)\n>       File \"/home/michi/Projekte/sage-devel/local/lib/python3.7/unittest/case.py\", line 839, in assertEqual\n>         assertion_func(first, second, msg=msg)\n>       File \"/home/michi/Projekte/sage-devel/local/lib/python3.7/unittest/case.py\", line 832, in _baseAssertEqual\n>         raise self.failureException(msg)\n>     AssertionError: <sage.structure.mutability.Mutability object at 0x7fc1d06dd410> != Affine connection nabla on the 3-dimensional differentiable manifold M\n>     ------------------------------------------------------------\n>     The following tests failed: _test_pickling\n> ```\n> \n\n\nYes, but not because it does not inherit from `SageObject`. It is purely an implementation issue trying to keep immutable objects immutable under pickling. I might argue that the `Mutability` should not have a `__reduce__`. Although some part of the issue is that you do not handle pickling in `AffineConnection`.",
    "created_at": "2020-08-01T09:31:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426312",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:9 gh-mjungmath]:
> Replying to [comment:8 tscrim]:
> > Strong -1 This is a mixin class. Just add it to your inheritance. You don't have any Cython classes, so you can use multiple inheritance without any issues. I don't expect too many cases where having Cython is useful for elements with mutabiliy.

> 
> You mean
> 
> 
> ```
> #!diff
> -class AffineConnection(SageObject):
> +class AffineConnection(SageObject, Mutability):
> ```
> 
> Why is it working in this case? `SageObject` and `Mutability` are both Cython classes. I am a little bit confused...sorry.


No. A Cython class cannot inherit from multiple things, but a Python class (as you have here) can. The classes it inherits from can both be Cython classes.

> ---
> 
> The inheritance above seems to cause some trouble, I think due to the `__reduce__` method in `Mutability`:
> 
> 
> ```
> File "src/sage/manifolds/differentiable/affine_connection.py", line 350, in sage.manifolds.differentiable.affine_connection.AffineConnection.__init__
> Failed example:
>     TestSuite(nab).run()
> Expected nothing
> Got:
>     Failure in _test_pickling:
>     Traceback (most recent call last):
>       File "/home/michi/Projekte/sage-devel/local/lib/python3.7/site-packages/sage/misc/sage_unittest.py", line 296, in run
>         test_method(tester=tester)
>       File "sage/structure/sage_object.pyx", line 639, in sage.structure.sage_object.SageObject._test_pickling (build/cythonized/sage/structure/sage_object.c:4953)
>         tester.assertEqual(loads(dumps(self)), self)
>       File "/home/michi/Projekte/sage-devel/local/lib/python3.7/unittest/case.py", line 839, in assertEqual
>         assertion_func(first, second, msg=msg)
>       File "/home/michi/Projekte/sage-devel/local/lib/python3.7/unittest/case.py", line 832, in _baseAssertEqual
>         raise self.failureException(msg)
>     AssertionError: <sage.structure.mutability.Mutability object at 0x7fc1d06dd410> != Affine connection nabla on the 3-dimensional differentiable manifold M
>     ------------------------------------------------------------
>     The following tests failed: _test_pickling
> ```
> 


Yes, but not because it does not inherit from `SageObject`. It is purely an implementation issue trying to keep immutable objects immutable under pickling. I might argue that the `Mutability` should not have a `__reduce__`. Although some part of the issue is that you do not handle pickling in `AffineConnection`.



---

archive/issue_comments_426313.json:
```json
{
    "body": "Replying to [comment:10 tscrim]:\n> > Why is it working in this case? `SageObject` and `Mutability` are both Cython classes. I am a little bit confused...sorry.\n\n> \n> No. A Cython class cannot inherit from multiple things, but a Python class (as you have here) can. The classes it inherits from can both be Cython classes.\n\n\nI'm confused because `SageObject` and `Mutability` both add methods and\n\n```diff\n-class FreeModuleTensor(ModuleElement):\n+class FreeModuleTensor(ModuleElement, Mutability):\n```\n\nwon't work. What is the difference? Is it because `ModuleElement` already is inherited?\n\n> Yes, but not because it does not inherit from `SageObject`. It is purely an implementation issue trying to keep immutable objects immutable under pickling. I might argue that the `Mutability` should not have a `__reduce__`. Although some part of the issue is that you do not handle pickling in `AffineConnection`.\n\n \nMh. Should I then overload `__reduce__` or add `set_immutable()` etc. manually? Unfortunately, I don't know much about pickling.",
    "created_at": "2020-08-01T10:17:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426313",
    "user": "https://github.com/mjungmath"
}
```

Replying to [comment:10 tscrim]:
> > Why is it working in this case? `SageObject` and `Mutability` are both Cython classes. I am a little bit confused...sorry.

> 
> No. A Cython class cannot inherit from multiple things, but a Python class (as you have here) can. The classes it inherits from can both be Cython classes.


I'm confused because `SageObject` and `Mutability` both add methods and

```diff
-class FreeModuleTensor(ModuleElement):
+class FreeModuleTensor(ModuleElement, Mutability):
```

won't work. What is the difference? Is it because `ModuleElement` already is inherited?

> Yes, but not because it does not inherit from `SageObject`. It is purely an implementation issue trying to keep immutable objects immutable under pickling. I might argue that the `Mutability` should not have a `__reduce__`. Although some part of the issue is that you do not handle pickling in `AffineConnection`.

 
Mh. Should I then overload `__reduce__` or add `set_immutable()` etc. manually? Unfortunately, I don't know much about pickling.



---

archive/issue_comments_426314.json:
```json
{
    "body": "Let's work step-wise here. Scalar fields made no problem, I have created a new ticket devoted to them: #30266.",
    "created_at": "2020-08-01T13:03:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426314",
    "user": "https://github.com/mjungmath"
}
```

Let's work step-wise here. Scalar fields made no problem, I have created a new ticket devoted to them: #30266.



---

archive/issue_comments_426315.json:
```json
{
    "body": "Changing type from defect to task.",
    "created_at": "2020-08-02T20:53:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426315",
    "user": "https://github.com/mjungmath"
}
```

Changing type from defect to task.



---

archive/issue_comments_426316.json:
```json
{
    "body": "Replying to [comment:11 gh-mjungmath]:\n> Replying to [comment:10 tscrim]:\n> > > Why is it working in this case? `SageObject` and `Mutability` are both Cython classes. I am a little bit confused...sorry.\n\n> > \n> > No. A Cython class cannot inherit from multiple things, but a Python class (as you have here) can. The classes it inherits from can both be Cython classes.\n  \n> \n> I'm confused because `SageObject` and `Mutability` both add methods and\n> \n> \n> ```\n> #!diff\n> -class FreeModuleTensor(ModuleElement):\n> +class FreeModuleTensor(ModuleElement, Mutability):\n> ```\n> \n> won't work. What is the difference? Is it because `ModuleElement` already is inherited?\n\n\nWon't work how? The difference with what? The pickling/`__reduce__` issue is because of the implementation of `Mutability`, not a Python/Cython issue. I need something more precise here.\n\n> > Yes, but not because it does not inherit from `SageObject`. It is purely an implementation issue trying to keep immutable objects immutable under pickling. I might argue that the `Mutability` should not have a `__reduce__`. Although some part of the issue is that you do not handle pickling in `AffineConnection`.\n\n>  \n> Mh. Should I then overload `__reduce__` or add `set_immutable()` etc. manually? Unfortunately, I don't know much about pickling.\n\n\nYou should overload `__reduce__`. Although I am not sure I agree with the `Mutability` having a `__reduce__` method (or at least once like that; seems counterproductive).",
    "created_at": "2020-08-03T12:08:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426316",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:11 gh-mjungmath]:
> Replying to [comment:10 tscrim]:
> > > Why is it working in this case? `SageObject` and `Mutability` are both Cython classes. I am a little bit confused...sorry.

> > 
> > No. A Cython class cannot inherit from multiple things, but a Python class (as you have here) can. The classes it inherits from can both be Cython classes.
  
> 
> I'm confused because `SageObject` and `Mutability` both add methods and
> 
> 
> ```
> #!diff
> -class FreeModuleTensor(ModuleElement):
> +class FreeModuleTensor(ModuleElement, Mutability):
> ```
> 
> won't work. What is the difference? Is it because `ModuleElement` already is inherited?


Won't work how? The difference with what? The pickling/`__reduce__` issue is because of the implementation of `Mutability`, not a Python/Cython issue. I need something more precise here.

> > Yes, but not because it does not inherit from `SageObject`. It is purely an implementation issue trying to keep immutable objects immutable under pickling. I might argue that the `Mutability` should not have a `__reduce__`. Although some part of the issue is that you do not handle pickling in `AffineConnection`.

>  
> Mh. Should I then overload `__reduce__` or add `set_immutable()` etc. manually? Unfortunately, I don't know much about pickling.


You should overload `__reduce__`. Although I am not sure I agree with the `Mutability` having a `__reduce__` method (or at least once like that; seems counterproductive).



---

archive/issue_comments_426317.json:
```json
{
    "body": "Replying to [comment:18 tscrim]:\n> You should overload `__reduce__`. Although I am not sure I agree with the `Mutability` having a `__reduce__` method (or at least once like that; seems counterproductive).\n\n\nWould you agree if I remove `__reduce__` from `Mutability`?\n\n> Won't work how? The difference with what? \n\n\nMy example above raises a type error while doctesting:\n\n```\nTypeError: multiple bases have instance lay-out conflict\n```\n\nWasn't that the original intention to write a dedicated `ModuleElementWithMutability` class? However, due to your argument, at least if I understand it correctly, this should work.",
    "created_at": "2020-08-03T12:40:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426317",
    "user": "https://github.com/mjungmath"
}
```

Replying to [comment:18 tscrim]:
> You should overload `__reduce__`. Although I am not sure I agree with the `Mutability` having a `__reduce__` method (or at least once like that; seems counterproductive).


Would you agree if I remove `__reduce__` from `Mutability`?

> Won't work how? The difference with what? 


My example above raises a type error while doctesting:

```
TypeError: multiple bases have instance lay-out conflict
```

Wasn't that the original intention to write a dedicated `ModuleElementWithMutability` class? However, due to your argument, at least if I understand it correctly, this should work.



---

archive/issue_comments_426318.json:
```json
{
    "body": "Replying to [comment:19 gh-mjungmath]:\n> Replying to [comment:18 tscrim]:\n> > You should overload `__reduce__`. Although I am not sure I agree with the `Mutability` having a `__reduce__` method (or at least once like that; seems counterproductive).\n\n> \n> Would you agree if I remove `__reduce__` from `Mutability`?\n\n\nYes, but that should be done on a separate ticket.\n\n> > Won't work how? The difference with what? \n\n> \n> My example above raises a type error while doctesting:\n> \n> \n> ```\n> TypeError: multiple bases have instance lay-out conflict\n> ```\n> \n> Wasn't that the original intention to write a dedicated `ModuleElementWithMutability` class? However, due to your argument, at least if I understand it correctly, this should work.\n\n\nThere is a technical reason with incompatible slots in the Cython classes. However, this was not the original intent of this class. The reason is Sage vectors are Cython classes, not Python classes, which only have single inheritance. So they cannot have mixin classes. All of this is done to optimize them because linear algebra needs to be fast.",
    "created_at": "2020-08-03T12:51:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426318",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:19 gh-mjungmath]:
> Replying to [comment:18 tscrim]:
> > You should overload `__reduce__`. Although I am not sure I agree with the `Mutability` having a `__reduce__` method (or at least once like that; seems counterproductive).

> 
> Would you agree if I remove `__reduce__` from `Mutability`?


Yes, but that should be done on a separate ticket.

> > Won't work how? The difference with what? 

> 
> My example above raises a type error while doctesting:
> 
> 
> ```
> TypeError: multiple bases have instance lay-out conflict
> ```
> 
> Wasn't that the original intention to write a dedicated `ModuleElementWithMutability` class? However, due to your argument, at least if I understand it correctly, this should work.


There is a technical reason with incompatible slots in the Cython classes. However, this was not the original intent of this class. The reason is Sage vectors are Cython classes, not Python classes, which only have single inheritance. So they cannot have mixin classes. All of this is done to optimize them because linear algebra needs to be fast.



---

archive/issue_comments_426319.json:
```json
{
    "body": "Changing keywords from \"immutable\" to \"immutability\".",
    "created_at": "2020-08-07T13:03:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426319",
    "user": "https://github.com/mjungmath"
}
```

Changing keywords from "immutable" to "immutability".



---

archive/issue_comments_426320.json:
```json
{
    "body": "That should be all. In case I missed something, please let me know.",
    "created_at": "2020-08-07T13:15:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426320",
    "user": "https://github.com/mjungmath"
}
```

That should be all. In case I missed something, please let me know.



---

archive/issue_events_078266.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30261#event-78266"
}
```



---

archive/issue_comments_426321.json:
```json
{
    "body": "The pickling test still fails, though #30281. See [here](https://trac.sagemath.org/ticket/30310#comment:13). Made a ticket, see #31182.",
    "created_at": "2021-01-04T18:12:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426321",
    "user": "https://github.com/mjungmath"
}
```

The pickling test still fails, though #30281. See [here](https://trac.sagemath.org/ticket/30310#comment:13). Made a ticket, see #31182.



---

archive/issue_events_078267.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-24T02:04:25Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30261#event-78267"
}
```



---

archive/issue_events_078268.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-03-24T02:04:25Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30261#event-78268"
}
```



---

archive/issue_comments_426322.json:
```json
{
    "body": "Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-24T02:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426322",
    "user": "https://github.com/mkoeppe"
}
```

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_426323.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-05-01T10:33:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426323",
    "user": "https://github.com/mjungmath"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_426324.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-05-01T10:33:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426324",
    "user": "https://github.com/mjungmath"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_426325.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2021-06-30T09:54:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426325",
    "user": "https://github.com/slel"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_426326.json:
```json
{
    "body": "By positive review, do you mean all goals of this meta-ticket are complete?\n\nWe might want to wait for #31706 to be merged before closing here.\n\nOnce that is done, maybe set the milestone here to sage-duplicate/invalid/wontfix?",
    "created_at": "2021-06-30T09:54:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426326",
    "user": "https://github.com/slel"
}
```

By positive review, do you mean all goals of this meta-ticket are complete?

We might want to wait for #31706 to be merged before closing here.

Once that is done, maybe set the milestone here to sage-duplicate/invalid/wontfix?



---

archive/issue_events_078269.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30261#event-78269"
}
```



---

archive/issue_events_078270.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30261#event-78270"
}
```



---

archive/issue_comments_426327.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426327",
    "user": "https://github.com/mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_426328.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2021-07-25T13:33:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426328",
    "user": "https://github.com/mjungmath"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_events_078271.json:
```json
{
    "actor": "https://github.com/mjungmath",
    "created_at": "2021-07-25T13:33:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30261#event-78271"
}
```



---

archive/issue_events_078272.json:
```json
{
    "actor": "https://github.com/mjungmath",
    "created_at": "2021-07-25T13:33:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30261#event-78272"
}
```



---

archive/issue_comments_426329.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-25T13:50:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30261#issuecomment-426329",
    "user": "https://github.com/slel"
}
```

Resolution: fixed



---

archive/issue_events_078273.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2021-07-25T13:50:22Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30261",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30261#event-78273"
}
```
