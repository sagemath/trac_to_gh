# Issue 30647: Make lazy_import more friendly to pyflakes and other static checkers

archive/issues_030410.json:
```json
{
    "body": "CC:  @dcoudert @tobiasdiez @fchapoton @jhpalmieri @tscrim\n\n`pyflakes` does not know about `lazy_import` and may therefore emit distracting warnings - as noted in #30616#comment:8\n\nWe introduce a new method `PythonModule.lazy_import`, which enables the following new idiom for creating lazy imports that are visible to static checkers:\n\n```\nLibBraiding = PythonModule('sage.libs.braiding', spkg='libbraiding')\nrightnormalform = LibBraiding.lazy_import(\n  'rightnormalform', namespace=None)\ncentralizer,  supersummitset = LibBraiding.lazy_import(\n  ('centralizer', 'supersummitset'), namespace=None)\n```\n\nSee also: \n- #22793 New `LazyImport` implementation based on `lazy_object_proxy`\n- #25898 Enable setting attributes on a lazy imported object\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/30647\n\n",
    "created_at": "2020-09-23T18:09:12Z",
    "labels": [
        "component: refactoring"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-wishlist",
    "title": "Make lazy_import more friendly to pyflakes and other static checkers",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30647",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @dcoudert @tobiasdiez @fchapoton @jhpalmieri @tscrim

`pyflakes` does not know about `lazy_import` and may therefore emit distracting warnings - as noted in #30616#comment:8

We introduce a new method `PythonModule.lazy_import`, which enables the following new idiom for creating lazy imports that are visible to static checkers:

```
LibBraiding = PythonModule('sage.libs.braiding', spkg='libbraiding')
rightnormalform = LibBraiding.lazy_import(
  'rightnormalform', namespace=None)
centralizer,  supersummitset = LibBraiding.lazy_import(
  ('centralizer', 'supersummitset'), namespace=None)
```

See also: 
- #22793 New `LazyImport` implementation based on `lazy_object_proxy`
- #25898 Enable setting attributes on a lazy imported object


Issue created by migration from https://trac.sagemath.org/ticket/30647





---

archive/issue_comments_433272.json:
```json
{
    "body": "> As a workaround, you could use lazy imports in conjunction with traditional imports, but place the traditional imports within a if TYPE_CHECKING: statement. That way, it won't execute at runtime, but the type checker will know about import for type checking purposes.\n\n\n(from https://github.com/microsoft/pyright/issues/954#issuecomment-675516511)",
    "created_at": "2020-09-23T18:16:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30647#issuecomment-433272",
    "user": "https://github.com/tobiasdiez"
}
```

> As a workaround, you could use lazy imports in conjunction with traditional imports, but place the traditional imports within a if TYPE_CHECKING: statement. That way, it won't execute at runtime, but the type checker will know about import for type checking purposes.


(from https://github.com/microsoft/pyright/issues/954#issuecomment-675516511)



---

archive/issue_comments_433273.json:
```json
{
    "body": "Note that the patchbot \"pyflakes plugin\" knows about lazy imports.\n\nBUT only with a basic syntax, one-liners.",
    "created_at": "2020-09-23T18:21:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30647#issuecomment-433273",
    "user": "https://github.com/fchapoton"
}
```

Note that the patchbot "pyflakes plugin" knows about lazy imports.

BUT only with a basic syntax, one-liners.



---

archive/issue_comments_433274.json:
```json
{
    "body": "Ah, OK, found it at https://github.com/sagemath/sage-patchbot/blob/master/sage_patchbot/plugins.py#L283",
    "created_at": "2020-09-23T18:28:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30647#issuecomment-433274",
    "user": "https://github.com/mkoeppe"
}
```

Ah, OK, found it at https://github.com/sagemath/sage-patchbot/blob/master/sage_patchbot/plugins.py#L283



---

archive/issue_comments_433275.json:
```json
{
    "body": "Replying to [comment:2 gh-tobiasdiez]:\n> > As a workaround, you could use lazy imports in conjunction with traditional imports, but place the traditional imports within a if TYPE_CHECKING: statement. That way, it won't execute at runtime, but the type checker will know about import for type checking purposes.\n\n> \n> (from https://github.com/microsoft/pyright/issues/954#issuecomment-675516511)\n\n\nThanks for the pointer!\n\nGiven that lazy imports are so widely used in sage, we probably don't want to use this workaround unless really necessary. It would add a lot of clutter to lots of files",
    "created_at": "2020-09-23T18:30:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30647#issuecomment-433275",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:2 gh-tobiasdiez]:
> > As a workaround, you could use lazy imports in conjunction with traditional imports, but place the traditional imports within a if TYPE_CHECKING: statement. That way, it won't execute at runtime, but the type checker will know about import for type checking purposes.

> 
> (from https://github.com/microsoft/pyright/issues/954#issuecomment-675516511)


Thanks for the pointer!

Given that lazy imports are so widely used in sage, we probably don't want to use this workaround unless really necessary. It would add a lot of clutter to lots of files



---

archive/issue_comments_433276.json:
```json
{
    "body": "A simple solution would be to make `lazy_import` return the (tuple of) lazy import objects that it creates, instead of relying on the magical namespace injection as a side effect. Then we could write\n\n```\nrightnormalform, centralizer, supersummitset = lazy_import(\n  'sage.libs.braiding',\n  ['rightnormalform', 'centralizer', 'supersummitset'],\n  feature=PythonModule('sage.libs.braiding', spkg='libbraiding'))\n```\n\nOf course, we could as well just use `LazyImport` directly:\n\n```\nLibBraiding = PythonModule('sage.libs.braiding', spkg='libbraiding')\nrightnormalform = LazyImport('sage.libs.braiding', 'rightnormalform', feature=LibBraiding)\ncentralizer     = LazyImport('sage.libs.braiding', 'centralizer',     feature=LibBraiding)\nsupersummitset  = LazyImport('sage.libs.braiding', 'supersummitset',  feature=LibBraiding)\n```",
    "created_at": "2020-09-23T18:39:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30647#issuecomment-433276",
    "user": "https://github.com/mkoeppe"
}
```

A simple solution would be to make `lazy_import` return the (tuple of) lazy import objects that it creates, instead of relying on the magical namespace injection as a side effect. Then we could write

```
rightnormalform, centralizer, supersummitset = lazy_import(
  'sage.libs.braiding',
  ['rightnormalform', 'centralizer', 'supersummitset'],
  feature=PythonModule('sage.libs.braiding', spkg='libbraiding'))
```

Of course, we could as well just use `LazyImport` directly:

```
LibBraiding = PythonModule('sage.libs.braiding', spkg='libbraiding')
rightnormalform = LazyImport('sage.libs.braiding', 'rightnormalform', feature=LibBraiding)
centralizer     = LazyImport('sage.libs.braiding', 'centralizer',     feature=LibBraiding)
supersummitset  = LazyImport('sage.libs.braiding', 'supersummitset',  feature=LibBraiding)
```



---

archive/issue_comments_433277.json:
```json
{
    "body": "Expanding on this, we could introduce a method `PythonModule.lazy_import` that would enable writing this:\n\n```\nLibBraiding = PythonModule('sage.libs.braiding', spkg='libbraiding')\nrightnormalform = LibBraiding.lazy_import('rightnormalform')\ncentralizer,  supersummitset = LibBraiding.lazy_import(\n  'centralizer', 'supersummitset')\n```",
    "created_at": "2020-09-23T18:54:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30647#issuecomment-433277",
    "user": "https://github.com/mkoeppe"
}
```

Expanding on this, we could introduce a method `PythonModule.lazy_import` that would enable writing this:

```
LibBraiding = PythonModule('sage.libs.braiding', spkg='libbraiding')
rightnormalform = LibBraiding.lazy_import('rightnormalform')
centralizer,  supersummitset = LibBraiding.lazy_import(
  'centralizer', 'supersummitset')
```



---

archive/issue_comments_433278.json:
```json
{
    "body": "I think this will not be sufficient for the static typing analysis. You would need to provide the information that `lazy_import('class')` returns an instance of `class`. \n\nMaybe one could declare it as `lazy_import(Type[C] cls) -> C` and call it via `lazy_import(sage.libs.braiding.rightnormalform)` (note that the argument is not a string). Not sure if that works.",
    "created_at": "2020-09-23T19:39:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30647#issuecomment-433278",
    "user": "https://github.com/tobiasdiez"
}
```

I think this will not be sufficient for the static typing analysis. You would need to provide the information that `lazy_import('class')` returns an instance of `class`. 

Maybe one could declare it as `lazy_import(Type[C] cls) -> C` and call it via `lazy_import(sage.libs.braiding.rightnormalform)` (note that the argument is not a string). Not sure if that works.



---

archive/issue_comments_433279.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-09-23T22:18:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30647#issuecomment-433279",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_433280.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-09-23T23:06:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30647#issuecomment-433280",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_433281.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-09-23T23:20:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30647#issuecomment-433281",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_433282.json:
```json
{
    "body": "Here's something that seems to work.",
    "created_at": "2020-09-23T23:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30647#issuecomment-433282",
    "user": "https://github.com/mkoeppe"
}
```

Here's something that seems to work.



---

archive/issue_comments_433283.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-09-23T23:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30647#issuecomment-433283",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_433284.json:
```json
{
    "body": "Replying to [comment:8 gh-tobiasdiez]:\n> I think this will not be sufficient for the static typing analysis. You would need to provide the information that `lazy_import('class')` returns an instance of `class`. \n\n\nIn the current version, I suppose one could just use a typed assignment",
    "created_at": "2020-09-23T23:22:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30647#issuecomment-433284",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:8 gh-tobiasdiez]:
> I think this will not be sufficient for the static typing analysis. You would need to provide the information that `lazy_import('class')` returns an instance of `class`. 


In the current version, I suppose one could just use a typed assignment



---

archive/issue_comments_433285.json:
```json
{
    "body": "I was hoping for a syntax such as `from sage.__lazy__.libs.braiding import rightnormalform`. I *think* this can be implemented with the python3 import machinery (https://docs.python.org/3/reference/import.html#finders-and-loaders) but haven't investigated.",
    "created_at": "2020-09-23T23:55:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30647#issuecomment-433285",
    "user": "https://github.com/mkoeppe"
}
```

I was hoping for a syntax such as `from sage.__lazy__.libs.braiding import rightnormalform`. I *think* this can be implemented with the python3 import machinery (https://docs.python.org/3/reference/import.html#finders-and-loaders) but haven't investigated.



---

archive/issue_comments_433286.json:
```json
{
    "body": "Could you please document the `feature` argument in `lazy_import.pyx`?",
    "created_at": "2020-09-29T20:02:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30647#issuecomment-433286",
    "user": "https://github.com/jhpalmieri"
}
```

Could you please document the `feature` argument in `lazy_import.pyx`?



---

archive/issue_comments_433287.json:
```json
{
    "body": "Replying to [comment:14 mkoeppe]:\n> Replying to [comment:8 gh-tobiasdiez]:\n> > I think this will not be sufficient for the static typing analysis. You would need to provide the information that `lazy_import('class')` returns an instance of `class`. \n\n> \n> In the current version, I suppose one could just use a typed assignment\n\n\nWhat do you mean with typed assignment?\nIn the previous version,\n\n```\ntry:\n    from sage.graphs.mcqd import mcqd\nexcept ImportError:\n    from sage.misc.package import PackageNotFoundError\n    raise PackageNotFoundError(\"mcqd\")\nreturn mcqd(self)\n```\nstatic type checkers can check if `mcqd` is actually a function defined in `sage.graphs.mcqd` and if `self` is allowed as an argument of `mcqd`. I doubt that they are intelligent enough to give the same information for the new version:\n\n```\nfrom sage.features import PythonModule\nMcqd = PythonModule('sage.graphs.mcqd', spkg='mcqd')\nmcqd = Mcqd.lazy_import('mcqd', namespace=None)\nreturn mcqd(self)\n```",
    "created_at": "2020-09-29T21:02:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30647#issuecomment-433287",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:14 mkoeppe]:
> Replying to [comment:8 gh-tobiasdiez]:
> > I think this will not be sufficient for the static typing analysis. You would need to provide the information that `lazy_import('class')` returns an instance of `class`. 

> 
> In the current version, I suppose one could just use a typed assignment


What do you mean with typed assignment?
In the previous version,

```
try:
    from sage.graphs.mcqd import mcqd
except ImportError:
    from sage.misc.package import PackageNotFoundError
    raise PackageNotFoundError("mcqd")
return mcqd(self)
```
static type checkers can check if `mcqd` is actually a function defined in `sage.graphs.mcqd` and if `self` is allowed as an argument of `mcqd`. I doubt that they are intelligent enough to give the same information for the new version:

```
from sage.features import PythonModule
Mcqd = PythonModule('sage.graphs.mcqd', spkg='mcqd')
mcqd = Mcqd.lazy_import('mcqd', namespace=None)
return mcqd(self)
```



---

archive/issue_comments_433288.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2020-10-01T03:58:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30647#issuecomment-433288",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_433289.json:
```json
{
    "body": "Another option would be to introduce (global) booleans that indicate whether a given library is available. E.g.\n\n```\n// e.g. in sage.distribution\ndef is_mcqd():\n   try:\n      from sage.graphs.mcqd import mcqd\n      return true \n   except ImportError:\n      return false\n   // or some other way to determine if mcqd is available\n\n// usage in another module:\n\n// at the beginning: global import\nif sage.distribution.is_mcqd():\n    from sage.graphs.mcqd import mcqd\n...\n// later in the code\nif sage.distribution.is_mcqd():\n    return mcqd(self)\nelse:\n    return ...\n```\n\nYet another solution would be the following pattern:\n\n```\ntry:\n    from sage.graphs.mcqd import mcqd as _mcqd \nexcept ImportError:\n    mcqd = None\nelse:\n    mcqd = _mcqd\n\n// later\nif mcqd:\n    return mcqd(self)\nelse:\n    return ...\n```\nsuggested in https://github.com/python/mypy/issues/1297#issuecomment-508593494.\nThis should work with mypy, not sure about pyright.",
    "created_at": "2020-10-01T14:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30647#issuecomment-433289",
    "user": "https://github.com/tobiasdiez"
}
```

Another option would be to introduce (global) booleans that indicate whether a given library is available. E.g.

```
// e.g. in sage.distribution
def is_mcqd():
   try:
      from sage.graphs.mcqd import mcqd
      return true 
   except ImportError:
      return false
   // or some other way to determine if mcqd is available

// usage in another module:

// at the beginning: global import
if sage.distribution.is_mcqd():
    from sage.graphs.mcqd import mcqd
...
// later in the code
if sage.distribution.is_mcqd():
    return mcqd(self)
else:
    return ...
```

Yet another solution would be the following pattern:

```
try:
    from sage.graphs.mcqd import mcqd as _mcqd 
except ImportError:
    mcqd = None
else:
    mcqd = _mcqd

// later
if mcqd:
    return mcqd(self)
else:
    return ...
```
suggested in https://github.com/python/mypy/issues/1297#issuecomment-508593494.
This should work with mypy, not sure about pyright.



---

archive/issue_comments_433290.json:
```json
{
    "body": "Replying to [comment:20 jhpalmieri]:\n> Could you please document the `feature` argument in `lazy_import.pyx`?\n\n\nThis has now happened in #30587.",
    "created_at": "2020-12-19T17:32:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30647#issuecomment-433290",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:20 jhpalmieri]:
> Could you please document the `feature` argument in `lazy_import.pyx`?


This has now happened in #30587.



---

archive/issue_comments_433291.json:
```json
{
    "body": "Replying to [comment:18 mkoeppe]:\n> I was hoping for a syntax such as `from sage.__lazy__.libs.braiding import rightnormalform`. I *think* this can be implemented with the python3 import machinery (https://docs.python.org/3/reference/import.html#finders-and-loaders) but haven't investigated. \n\n\nThis was previously discussed in #22752",
    "created_at": "2020-12-19T17:34:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30647#issuecomment-433291",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:18 mkoeppe]:
> I was hoping for a syntax such as `from sage.__lazy__.libs.braiding import rightnormalform`. I *think* this can be implemented with the python3 import machinery (https://docs.python.org/3/reference/import.html#finders-and-loaders) but haven't investigated. 


This was previously discussed in #22752



---

archive/issue_comments_433292.json:
```json
{
    "body": "Another solution is to provide type stub files (`__init__.pyi`), see section \"type checkers\" in https://scientific-python.org/specs/spec-0001/",
    "created_at": "2022-12-06T22:32:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30647",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30647#issuecomment-433292",
    "user": "https://github.com/mkoeppe"
}
```

Another solution is to provide type stub files (`__init__.pyi`), see section "type checkers" in https://scientific-python.org/specs/spec-0001/
