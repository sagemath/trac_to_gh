# Issue 30504: Refactor to break cyclic import in complex numbers

archive/issues_030504.json:
```json
{
    "body": "CC:  @mkoeppe @tscrim @antonio-rojas\n\nImporting `complex_mpfr` does currently not work without previously importing `sage.all`. This is because of a couple of cyclic imports (e.g. `complex_number` -> `complex_double` -> `complex_number`).\n\nIn this ticket, we break these cyclic imports by narrowing down some of the global module imports to local function-wide imports. This was not possible in the case of the `CCtoCDF` class, since there `ComplexDoubleElement` is cimported, which has to be done on the module level. I've hence extracted this class to a new module `complex_conversion.pyx`.\n\nWith these changes, the executing the following code\n\n```\nfrom sage.rings.complex_mpfr import ComplexField\nprint(ComplexField())\n```\nusing `./venv/bin/python3` works. Previously, it failed with \n\n```\n  File \"/home/tobias/sage/src/test.py\", line 1, in <module>\n    from sage.rings.complex_mpfr import ComplexField\n  File \"sage/rings/complex_mpfr.pyx\", line 1, in init sage.rings.complex_mpfr\n  File \"sage/rings/real_mpfr.pyx\", line 1, in init sage.rings.real_mpfr\n  File \"sage/libs/mpmath/utils.pyx\", line 17, in init sage.libs.mpmath.utils\nImportError: cannot import name ComplexField\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/30741\n\n",
    "closed_at": "2021-12-19T11:47:53Z",
    "created_at": "2020-10-07T18:22:49Z",
    "labels": [
        "component: refactoring"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Refactor to break cyclic import in complex numbers",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30504",
    "user": "https://github.com/tobiasdiez"
}
```
CC:  @mkoeppe @tscrim @antonio-rojas

Importing `complex_mpfr` does currently not work without previously importing `sage.all`. This is because of a couple of cyclic imports (e.g. `complex_number` -> `complex_double` -> `complex_number`).

In this ticket, we break these cyclic imports by narrowing down some of the global module imports to local function-wide imports. This was not possible in the case of the `CCtoCDF` class, since there `ComplexDoubleElement` is cimported, which has to be done on the module level. I've hence extracted this class to a new module `complex_conversion.pyx`.

With these changes, the executing the following code

```
from sage.rings.complex_mpfr import ComplexField
print(ComplexField())
```
using `./venv/bin/python3` works. Previously, it failed with 

```
  File "/home/tobias/sage/src/test.py", line 1, in <module>
    from sage.rings.complex_mpfr import ComplexField
  File "sage/rings/complex_mpfr.pyx", line 1, in init sage.rings.complex_mpfr
  File "sage/rings/real_mpfr.pyx", line 1, in init sage.rings.real_mpfr
  File "sage/libs/mpmath/utils.pyx", line 17, in init sage.libs.mpmath.utils
ImportError: cannot import name ComplexField
```

Issue created by migration from https://trac.sagemath.org/ticket/30741





---

archive/issue_comments_434931.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-10-07T18:22:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434931",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_434932.json:
```json
{
    "body": "Changes of this type need careful review regarding possible performance penalties from the import",
    "created_at": "2020-10-07T18:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434932",
    "user": "https://github.com/mkoeppe"
}
```

Changes of this type need careful review regarding possible performance penalties from the import



---

archive/issue_comments_434933.json:
```json
{
    "body": "Instead of\n\n```\n+            from sage.rings.complex_conversion import CCtoCDF\n+            return CCtoCDF(S, self)\n```\nWhy don't you add a proper `.pxd` file and does a `cimport` at module level?",
    "created_at": "2020-10-10T21:22:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434933",
    "user": "https://github.com/videlec"
}
```

Instead of

```
+            from sage.rings.complex_conversion import CCtoCDF
+            return CCtoCDF(S, self)
```
Why don't you add a proper `.pxd` file and does a `cimport` at module level?



---

archive/issue_comments_434934.json:
```json
{
    "body": "A module level `cipmort CCtoCDF` would lead again to a circular import: complex_double -> complex_conversion (for CCtoCDF) -> complex_double (for ComplexDoubleElement).",
    "created_at": "2020-10-11T10:56:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434934",
    "user": "https://github.com/tobiasdiez"
}
```

A module level `cipmort CCtoCDF` would lead again to a circular import: complex_double -> complex_conversion (for CCtoCDF) -> complex_double (for ComplexDoubleElement).



---

archive/issue_comments_434935.json:
```json
{
    "body": "Replying to [comment:4 gh-tobiasdiez]:\n> A module level `cipmort CCtoCDF` would lead again to a circular import: complex_double -> complex_conversion (for CCtoCDF) -> complex_double (for ComplexDoubleElement). \n\n\n`cimport` does **not** trigger the Python module import (the things in the `.pyx`). It is just reading the corresponding `.pxd` file.\n\nEDIT: and it is perfectly fine to have circular imports here as these are guarded with macros at the C level",
    "created_at": "2020-10-11T11:10:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434935",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:4 gh-tobiasdiez]:
> A module level `cipmort CCtoCDF` would lead again to a circular import: complex_double -> complex_conversion (for CCtoCDF) -> complex_double (for ComplexDoubleElement). 


`cimport` does **not** trigger the Python module import (the things in the `.pyx`). It is just reading the corresponding `.pxd` file.

EDIT: and it is perfectly fine to have circular imports here as these are guarded with macros at the C level



---

archive/issue_events_080120.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30504#event-80120"
}
```



---

archive/issue_comments_434936.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-10-24T23:09:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434936",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_434937.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434937",
    "user": "https://github.com/mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_080121.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30504#event-80121"
}
```



---

archive/issue_events_080122.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30504#event-80122"
}
```



---

archive/issue_comments_434938.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434938",
    "user": "https://github.com/mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_events_080123.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30504#event-80123"
}
```



---

archive/issue_events_080124.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30504#event-80124"
}
```



---

archive/issue_comments_434939.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-18T23:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434939",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_434940.json:
```json
{
    "body": "With #32612 you can also use `isinstance(..., sage.rings.abc.ComplexIntervalField)` instead of using a local import",
    "created_at": "2021-10-18T23:24:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434940",
    "user": "https://github.com/mkoeppe"
}
```

With #32612 you can also use `isinstance(..., sage.rings.abc.ComplexIntervalField)` instead of using a local import



---

archive/issue_comments_434941.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-18T23:34:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434941",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_434942.json:
```json
{
    "body": "Replying to [comment:11 mkoeppe]:\n> With #32612 you can also use `isinstance(..., sage.rings.abc.ComplexIntervalField)` instead of using a local import\n\n\nThanks for the pointer! Done",
    "created_at": "2021-10-18T23:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434942",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:11 mkoeppe]:
> With #32612 you can also use `isinstance(..., sage.rings.abc.ComplexIntervalField)` instead of using a local import


Thanks for the pointer! Done



---

archive/issue_comments_434943.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-21T07:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434943",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_434944.json:
```json
{
    "body": "still needs work or ready for review?",
    "created_at": "2021-10-21T17:17:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434944",
    "user": "https://github.com/mkoeppe"
}
```

still needs work or ready for review?



---

archive/issue_comments_434945.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-22T21:15:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434945",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_434946.json:
```json
{
    "body": "I've fixed the branch but does it actually solve anything?",
    "created_at": "2021-10-22T21:16:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434946",
    "user": "https://github.com/mkoeppe"
}
```

I've fixed the branch but does it actually solve anything?



---

archive/issue_comments_434947.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-26T21:21:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434947",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_434948.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-11-26T21:22:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434948",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_434949.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-11-26T21:22:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434949",
    "user": "https://github.com/tobiasdiez"
}
```

New commits:



---

archive/issue_comments_434950.json:
```json
{
    "body": "Thanks for the help Matthias!\n\nIt still needed a bit further cleanup, but should work now. I've updated the ticket description to discuss what didn't work before but now does.",
    "created_at": "2021-11-26T21:25:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434950",
    "user": "https://github.com/tobiasdiez"
}
```

Thanks for the help Matthias!

It still needed a bit further cleanup, but should work now. I've updated the ticket description to discuss what didn't work before but now does.



---

archive/issue_comments_434951.json:
```json
{
    "body": "Thanks, this looks good. I'll test this now also with #32601, but I don't expect problems",
    "created_at": "2021-11-26T22:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434951",
    "user": "https://github.com/mkoeppe"
}
```

Thanks, this looks good. I'll test this now also with #32601, but I don't expect problems



---

archive/issue_comments_434952.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-11-26T22:34:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434952",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_434953.json:
```json
{
    "body": "Thanks for the review!",
    "created_at": "2021-11-27T16:12:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434953",
    "user": "https://github.com/tobiasdiez"
}
```

Thanks for the review!



---

archive/issue_comments_434954.json:
```json
{
    "body": "```\nsage -t --long --warn-long 43.1 --random-seed=227602538950590531556014576097185838563 src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py\n**********************************************************************\nFile \"src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py\", line 2038, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicPD.plot\nFailed example:\n    H = h.plot(thickness=6, color=\"orange\"); H           # optional - sage.plot\nExpected:\n    Graphics object consisting of 2 graphics primitives        # optional - sage.plot\nGot:\n    Graphics object consisting of 2 graphics primitives\n**********************************************************************\n```",
    "created_at": "2021-12-06T00:21:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434954",
    "user": "https://github.com/vbraun"
}
```

```
sage -t --long --warn-long 43.1 --random-seed=227602538950590531556014576097185838563 src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py
**********************************************************************
File "src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py", line 2038, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicPD.plot
Failed example:
    H = h.plot(thickness=6, color="orange"); H           # optional - sage.plot
Expected:
    Graphics object consisting of 2 graphics primitives        # optional - sage.plot
Got:
    Graphics object consisting of 2 graphics primitives
**********************************************************************
```



---

archive/issue_comments_434955.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-12-06T00:21:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434955",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_434956.json:
```json
{
    "body": "Fixed in #32174.",
    "created_at": "2021-12-06T00:35:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434956",
    "user": "https://github.com/mkoeppe"
}
```

Fixed in #32174.



---

archive/issue_comments_434957.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-12-06T00:35:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434957",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_434958.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-12-19T11:47:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30504#issuecomment-434958",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_080125.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-12-19T11:47:53Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30504",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30504#event-80125"
}
```
