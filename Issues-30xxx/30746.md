# Issue 30746: sage.doctest.control: Replace use of sage.misc.package.list_packages

archive/issues_030509.json:
```json
{
    "body": "... by features.\n\nThis is so that users can make use of doctests conditionalized with \"# optional\" in their Sage programs even on distribution-packaged Sage installations, or for optional packages with `spkg-configure.m4` (as observed in ticket:30887#comment:28)\n\nAfter #30887, #32614, #32649 a `Feature` has a `name` attribute that can be used as the `# optional` tag for doctesting. \n\n#32174 implements global `Feature` discovery and hooks it into `sage.doctest.control`.\n\nIt remains to define `Feature`s for all remaining SPKGs that appear in `# optional` tags somewhere in the Sage library (which can be found using `git grep -l '# *optional' | xargs sed -E -n 's/^.*# *optional[ -:]*([a-zA-Z_0-9.]*).*/\\1/gp' | sort -u`). Then we can remove the use of `sage.misc.package`.\n\nThis is also preparation for #30747 (deprecate all of `sage.misc.package`)\n\nRelated: \n- #30848 `sage.doctest.control`, `sage_setup`: Do not check versions of installed packages\n\n\n**CC:**  @antonio-rojas @kiwifb simonking @dimpase @jhpalmieri @kliem @tscrim @kwankyu @orlitzky\n\n**Keywords:** sd111\n\n**Status:** new\n\n**Dependencies:** #30887, #32614, #32649\n\nIssue created by migration from https://trac.sagemath.org/ticket/30746\n\n",
    "created_at": "2020-10-08T17:06:22Z",
    "labels": [
        "component: doctest framework"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "sage.doctest.control: Replace use of sage.misc.package.list_packages",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30746",
    "user": "https://github.com/mkoeppe"
}
```
... by features.

This is so that users can make use of doctests conditionalized with "# optional" in their Sage programs even on distribution-packaged Sage installations, or for optional packages with `spkg-configure.m4` (as observed in ticket:30887#comment:28)

After #30887, #32614, #32649 a `Feature` has a `name` attribute that can be used as the `# optional` tag for doctesting. 

#32174 implements global `Feature` discovery and hooks it into `sage.doctest.control`.

It remains to define `Feature`s for all remaining SPKGs that appear in `# optional` tags somewhere in the Sage library (which can be found using `git grep -l '# *optional' | xargs sed -E -n 's/^.*# *optional[ -:]*([a-zA-Z_0-9.]*).*/\1/gp' | sort -u`). Then we can remove the use of `sage.misc.package`.

This is also preparation for #30747 (deprecate all of `sage.misc.package`)

Related: 
- #30848 `sage.doctest.control`, `sage_setup`: Do not check versions of installed packages


**CC:**  @antonio-rojas @kiwifb simonking @dimpase @jhpalmieri @kliem @tscrim @kwankyu @orlitzky

**Keywords:** sd111

**Status:** new

**Dependencies:** #30887, #32614, #32649

Issue created by migration from https://trac.sagemath.org/ticket/30746





---

archive/issue_comments_609246.json:
```json
{
    "body": "<a id='comment:1'></a>\nHow do distributions handle this currently?",
    "created_at": "2020-10-08T17:06:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609246",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>
How do distributions handle this currently?



---

archive/issue_comments_609247.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,3 +2,4 @@\n \n This is so that users can make use of doctests conditionalized with \"# optional\" in their Sage programs even on distribution-packaged Sage installations.\n \n+This is also preparation for #30747 (deprecate all of `sage.misc.package`)\n``````\n",
    "created_at": "2020-10-08T17:15:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609247",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,3 +2,4 @@
 
 This is so that users can make use of doctests conditionalized with "# optional" in their Sage programs even on distribution-packaged Sage installations.
 
+This is also preparation for #30747 (deprecate all of `sage.misc.package`)
``````




---

archive/issue_comments_609248.json:
```json
{
    "body": "<a id='comment:3'></a>\nI'm patching it out completely\n\nhttps://github.com/archlinux/svntogit-community/blob/packages/sagemath/trunk/test-optional.patch\n\nso tests depending on optional packages are skipped unless explicitely specified in the `sage -t` command",
    "created_at": "2020-10-08T17:21:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609248",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:3'></a>
I'm patching it out completely

https://github.com/archlinux/svntogit-community/blob/packages/sagemath/trunk/test-optional.patch

so tests depending on optional packages are skipped unless explicitely specified in the `sage -t` command



---

archive/issue_comments_609249.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [mkoeppe](#comment%3A1):\n> How do distributions handle this currently?\n\n\nI don't know about others but I do it badly. The current stuff allow some autodetection of what is installed by the sage package management system. That was not always the case. I remove the autodetection bits and add anything I want to test manually when running `sage -t`.",
    "created_at": "2020-10-08T19:26:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609249",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:4'></a>
Replying to [mkoeppe](#comment%3A1):
> How do distributions handle this currently?


I don't know about others but I do it badly. The current stuff allow some autodetection of what is installed by the sage package management system. That was not always the case. I remove the autodetection bits and add anything I want to test manually when running `sage -t`.



---

archive/issue_comments_609250.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-... by features.\n+... by features or `sage_conf`.\n \n This is so that users can make use of doctests conditionalized with \"# optional\" in their Sage programs even on distribution-packaged Sage installations.\n \n``````\n",
    "created_at": "2020-11-02T05:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609250",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-... by features.
+... by features or `sage_conf`.
 
 This is so that users can make use of doctests conditionalized with "# optional" in their Sage programs even on distribution-packaged Sage installations.
 
``````




---

archive/issue_comments_609251.json:
```json
{
    "body": "**Branch:** [u/mkoeppe/sage_doctest_control__replace_use_of_sage_misc_package_list_packages](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage_doctest_control__replace_use_of_sage_misc_package_list_packages)",
    "created_at": "2020-11-12T20:03:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609251",
    "user": "https://github.com/mkoeppe"
}
```

**Branch:** [u/mkoeppe/sage_doctest_control__replace_use_of_sage_misc_package_list_packages](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage_doctest_control__replace_use_of_sage_misc_package_list_packages)



---

archive/issue_comments_609252.json:
```json
{
    "body": "<a id='comment:7'></a>\n(wrong ticket)",
    "created_at": "2020-11-12T20:03:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609252",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>
(wrong ticket)



---

archive/issue_comments_609253.json:
```json
{
    "body": "**Changing branch** from \"[u/mkoeppe/sage_doctest_control__replace_use_of_sage_misc_package_list_packages](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage_doctest_control__replace_use_of_sage_misc_package_list_packages)\" to \"\".",
    "created_at": "2020-11-12T20:57:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609253",
    "user": "https://github.com/mkoeppe"
}
```

**Changing branch** from "[u/mkoeppe/sage_doctest_control__replace_use_of_sage_misc_package_list_packages](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/sage_doctest_control__replace_use_of_sage_misc_package_list_packages)" to "".



---

archive/issue_comments_609254.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"sd111\".",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609254",
    "user": "https://github.com/mkoeppe"
}
```

**Changing keywords** from "" to "sd111".



---

archive/issue_comments_609255.json:
```json
{
    "body": "<a id='comment:9'></a>\nHoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609255",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>
Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111



---

archive/issue_comments_609256.json:
```json
{
    "body": "<a id='comment:10'></a>\nSetting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609256",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>
Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_090296.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30746#event-90296"
}
```



---

archive/issue_comments_609257.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,5 +1,7 @@\n ... by features or `sage_conf`.\n \n-This is so that users can make use of doctests conditionalized with \"# optional\" in their Sage programs even on distribution-packaged Sage installations.\n+This is so that users can make use of doctests conditionalized with \"# optional\" in their Sage programs even on distribution-packaged Sage installations, or for optional packages with `spkg-configure.m4` (as observed in ticket:30887#comment:28)\n \n This is also preparation for #30747 (deprecate all of `sage.misc.package`)\n+\n+Related: #30848 `sage.doctest.control`, `sage_setup`: Do not check versions of installed packages\n``````\n",
    "created_at": "2021-07-07T19:55:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609257",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,5 +1,7 @@
 ... by features or `sage_conf`.
 
-This is so that users can make use of doctests conditionalized with "# optional" in their Sage programs even on distribution-packaged Sage installations.
+This is so that users can make use of doctests conditionalized with "# optional" in their Sage programs even on distribution-packaged Sage installations, or for optional packages with `spkg-configure.m4` (as observed in ticket:30887#comment:28)
 
 This is also preparation for #30747 (deprecate all of `sage.misc.package`)
+
+Related: #30848 `sage.doctest.control`, `sage_setup`: Do not check versions of installed packages
``````




---

archive/issue_comments_609258.json:
```json
{
    "body": "**Dependencies:** #20879",
    "created_at": "2021-07-08T20:31:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609258",
    "user": "https://github.com/mkoeppe"
}
```

**Dependencies:** #20879



---

archive/issue_comments_609259.json:
```json
{
    "body": "<a id='comment:14'></a>\nWhy the dependency on #20879? I am assuming this is a typo or the wrong ticket.",
    "created_at": "2021-07-09T00:04:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609259",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:14'></a>
Why the dependency on #20879? I am assuming this is a typo or the wrong ticket.



---

archive/issue_comments_609260.json:
```json
{
    "body": "<a id='comment:15'></a>\nYes, wrong ticket, I meant #30887.",
    "created_at": "2021-07-09T00:09:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609260",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>
Yes, wrong ticket, I meant #30887.



---

archive/issue_comments_609261.json:
```json
{
    "body": "**Changing dependencies** from \"#20879\" to \"#30887\".",
    "created_at": "2021-07-09T00:09:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609261",
    "user": "https://github.com/mkoeppe"
}
```

**Changing dependencies** from "#20879" to "#30887".



---

archive/issue_events_090297.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T02:58:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30746#event-90297"
}
```



---

archive/issue_events_090298.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T02:58:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30746#event-90298"
}
```



---

archive/issue_comments_609262.json:
```json
{
    "body": "**Changing dependencies** from \"#30887\" to \"#30887, #32614\".",
    "created_at": "2021-10-07T07:28:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609262",
    "user": "https://github.com/mkoeppe"
}
```

**Changing dependencies** from "#30887" to "#30887, #32614".



---

archive/issue_comments_609263.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,6 +1,8 @@\n-... by features or `sage_conf`.\n+... by features.\n \n This is so that users can make use of doctests conditionalized with \"# optional\" in their Sage programs even on distribution-packaged Sage installations, or for optional packages with `spkg-configure.m4` (as observed in ticket:30887#comment:28)\n+\n+The new features added in #30887, #32614 already have a `name` attribute that can be used as the \"optional\" tag for doctesting. It just needs to be hooked into `sage.doctest.control` - in the same way that #32614's `sage_features` is done.\n \n This is also preparation for #30747 (deprecate all of `sage.misc.package`)\n \n``````\n",
    "created_at": "2021-10-07T07:28:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609263",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,6 +1,8 @@
-... by features or `sage_conf`.
+... by features.
 
 This is so that users can make use of doctests conditionalized with "# optional" in their Sage programs even on distribution-packaged Sage installations, or for optional packages with `spkg-configure.m4` (as observed in ticket:30887#comment:28)
+
+The new features added in #30887, #32614 already have a `name` attribute that can be used as the "optional" tag for doctesting. It just needs to be hooked into `sage.doctest.control` - in the same way that #32614's `sage_features` is done.
 
 This is also preparation for #30747 (deprecate all of `sage.misc.package`)
 
``````




---

archive/issue_comments_609264.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -6,4 +6,6 @@\n \n This is also preparation for #30747 (deprecate all of `sage.misc.package`)\n \n-Related: #30848 `sage.doctest.control`, `sage_setup`: Do not check versions of installed packages\n+Related: \n+- #30848 `sage.doctest.control`, `sage_setup`: Do not check versions of installed packages\n+- #32174 doctests: Detect \"safe\" external features even if \"--optional=external\" is not used\n``````\n",
    "created_at": "2021-10-07T07:40:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609264",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -6,4 +6,6 @@
 
 This is also preparation for #30747 (deprecate all of `sage.misc.package`)
 
-Related: #30848 `sage.doctest.control`, `sage_setup`: Do not check versions of installed packages
+Related: 
+- #30848 `sage.doctest.control`, `sage_setup`: Do not check versions of installed packages
+- #32174 doctests: Detect "safe" external features even if "--optional=external" is not used
``````




---

archive/issue_comments_609265.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,7 +2,7 @@\n \n This is so that users can make use of doctests conditionalized with \"# optional\" in their Sage programs even on distribution-packaged Sage installations, or for optional packages with `spkg-configure.m4` (as observed in ticket:30887#comment:28)\n \n-The new features added in #30887, #32614 already have a `name` attribute that can be used as the \"optional\" tag for doctesting. It just needs to be hooked into `sage.doctest.control` - in the same way that #32614's `sage_features` is done.\n+After #30887, #32614, #32649 a `Feature` has a `name` attribute that can be used as the \"optional\" tag for doctesting. It just needs to be hooked into `sage.doctest.control` - in the same way that #32614's `sage_features` is done.\n \n This is also preparation for #30747 (deprecate all of `sage.misc.package`)\n \n``````\n",
    "created_at": "2021-10-15T04:57:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609265",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,7 +2,7 @@
 
 This is so that users can make use of doctests conditionalized with "# optional" in their Sage programs even on distribution-packaged Sage installations, or for optional packages with `spkg-configure.m4` (as observed in ticket:30887#comment:28)
 
-The new features added in #30887, #32614 already have a `name` attribute that can be used as the "optional" tag for doctesting. It just needs to be hooked into `sage.doctest.control` - in the same way that #32614's `sage_features` is done.
+After #30887, #32614, #32649 a `Feature` has a `name` attribute that can be used as the "optional" tag for doctesting. It just needs to be hooked into `sage.doctest.control` - in the same way that #32614's `sage_features` is done.
 
 This is also preparation for #30747 (deprecate all of `sage.misc.package`)
 
``````




---

archive/issue_comments_609266.json:
```json
{
    "body": "**Changing dependencies** from \"#30887, #32614\" to \"#30887, #32614, #32649\".",
    "created_at": "2021-10-15T04:57:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609266",
    "user": "https://github.com/mkoeppe"
}
```

**Changing dependencies** from "#30887, #32614" to "#30887, #32614, #32649".



---

archive/issue_comments_609267.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,10 +2,14 @@\n \n This is so that users can make use of doctests conditionalized with \"# optional\" in their Sage programs even on distribution-packaged Sage installations, or for optional packages with `spkg-configure.m4` (as observed in ticket:30887#comment:28)\n \n-After #30887, #32614, #32649 a `Feature` has a `name` attribute that can be used as the \"optional\" tag for doctesting. It just needs to be hooked into `sage.doctest.control` - in the same way that #32614's `sage_features` is done.\n+After #30887, #32614, #32649 a `Feature` has a `name` attribute that can be used as the `# optional` tag for doctesting. \n+\n+#32174 implements global `Feature` discovery and hooks it into `sage.doctest.control`.\n+\n+It remains to define `Feature`s for all remaining SPKGs that appear in `# optional` tags somewhere in the Sage library (which can be found using `git grep -l '# *optional' | xargs sed -E -n 's/^.*# *optional[ -:]*([a-zA-Z_0-9.]*).*/\\1/gp' | sort -u`). Then we can remove the use of `sage.misc.package`.\n \n This is also preparation for #30747 (deprecate all of `sage.misc.package`)\n \n Related: \n - #30848 `sage.doctest.control`, `sage_setup`: Do not check versions of installed packages\n-- #32174 doctests: Detect \"safe\" external features even if \"--optional=external\" is not used\n+\n``````\n",
    "created_at": "2021-11-16T06:53:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609267",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,10 +2,14 @@
 
 This is so that users can make use of doctests conditionalized with "# optional" in their Sage programs even on distribution-packaged Sage installations, or for optional packages with `spkg-configure.m4` (as observed in ticket:30887#comment:28)
 
-After #30887, #32614, #32649 a `Feature` has a `name` attribute that can be used as the "optional" tag for doctesting. It just needs to be hooked into `sage.doctest.control` - in the same way that #32614's `sage_features` is done.
+After #30887, #32614, #32649 a `Feature` has a `name` attribute that can be used as the `# optional` tag for doctesting. 
+
+#32174 implements global `Feature` discovery and hooks it into `sage.doctest.control`.
+
+It remains to define `Feature`s for all remaining SPKGs that appear in `# optional` tags somewhere in the Sage library (which can be found using `git grep -l '# *optional' | xargs sed -E -n 's/^.*# *optional[ -:]*([a-zA-Z_0-9.]*).*/\1/gp' | sort -u`). Then we can remove the use of `sage.misc.package`.
 
 This is also preparation for #30747 (deprecate all of `sage.misc.package`)
 
 Related: 
 - #30848 `sage.doctest.control`, `sage_setup`: Do not check versions of installed packages
-- #32174 doctests: Detect "safe" external features even if "--optional=external" is not used
+
``````




---

archive/issue_events_090299.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30746#event-90299"
}
```



---

archive/issue_events_090300.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30746#event-90300"
}
```



---

archive/issue_comments_609268.json:
```json
{
    "body": "<a id='comment:22'></a>\nI'm just seeing this now after wondering why sage keeps searching my system for random broken programs to try to use. Runtime detection of these things will not be a good long-term approach:\n\n1. You have to reimplement every spkg-configure.m4 in python for the feature check and keep them synchronized forever.\n2. Runtime checks are run over and over again. And many are going to be slow, once they are made to return the right answers.\n3. Distros track dependencies and usually don't want them to (dis)appear at runtime.\n4. If I build sage with e.g. `--disable-lrslib`, I expect it to not search my system for something that looks like lrslib and use it anyway. There has to be a way to reliably disable things.\n\nAs an alternative, you can imagine a shared location where \"features\" record their existence (think pkg-config). The simplest implementation might be to create a file named after the feature to indicate that the feature is present.\n\nOptional packages would touch `$FEATURESDIR/$PACKAGE` upon being detected or installed. That centralizes all of the detection code in spkg-configure.m4, and would eventually make `--disable-foo` work again. Distros could install a \"feature file\" for every feature that their distro package provides. Or if they don't mind the automagic dependencies, you could have (say) the \"ffmpeg\" package install the ffmpeg feature file to tell sage that ffmpeg is available. Of course this would only be done if the distro's ffmpeg package actually works with its sage. But it does allow the user to add features on a binary distro on-the-fly without the developers having to jump through too many hoops. (On Gentoo we might just make you rebuild with `USE=feature` to enable it and encode the dependency.)\n\nDepending on the scenario, this essentially runs the \"feature check\" either once or never, as `[ -f $feature ]` is free. Thus we avoid wasting time on every invocation of `sage -t`.\n\nThe file-based implementation here is not well-thought-out and probably has flaws, but it's also not what's important. What is is that the features should respect the user/distro configuration, not waste too many resources, not cause surprises, and not require any unnecessary duplication (i.e. work). Moving towards runtime-only detection is IMHO moving backwards.",
    "created_at": "2022-01-15T04:37:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609268",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:22'></a>
I'm just seeing this now after wondering why sage keeps searching my system for random broken programs to try to use. Runtime detection of these things will not be a good long-term approach:

1. You have to reimplement every spkg-configure.m4 in python for the feature check and keep them synchronized forever.
2. Runtime checks are run over and over again. And many are going to be slow, once they are made to return the right answers.
3. Distros track dependencies and usually don't want them to (dis)appear at runtime.
4. If I build sage with e.g. `--disable-lrslib`, I expect it to not search my system for something that looks like lrslib and use it anyway. There has to be a way to reliably disable things.

As an alternative, you can imagine a shared location where "features" record their existence (think pkg-config). The simplest implementation might be to create a file named after the feature to indicate that the feature is present.

Optional packages would touch `$FEATURESDIR/$PACKAGE` upon being detected or installed. That centralizes all of the detection code in spkg-configure.m4, and would eventually make `--disable-foo` work again. Distros could install a "feature file" for every feature that their distro package provides. Or if they don't mind the automagic dependencies, you could have (say) the "ffmpeg" package install the ffmpeg feature file to tell sage that ffmpeg is available. Of course this would only be done if the distro's ffmpeg package actually works with its sage. But it does allow the user to add features on a binary distro on-the-fly without the developers having to jump through too many hoops. (On Gentoo we might just make you rebuild with `USE=feature` to enable it and encode the dependency.)

Depending on the scenario, this essentially runs the "feature check" either once or never, as `[ -f $feature ]` is free. Thus we avoid wasting time on every invocation of `sage -t`.

The file-based implementation here is not well-thought-out and probably has flaws, but it's also not what's important. What is is that the features should respect the user/distro configuration, not waste too many resources, not cause surprises, and not require any unnecessary duplication (i.e. work). Moving towards runtime-only detection is IMHO moving backwards.



---

archive/issue_comments_609269.json:
```json
{
    "body": "<a id='comment:23'></a>\n+1 on a mechanism for statically declaring features present/not present, for use by downstream distributions. They could be provided through `sage_conf`.\n\n-1 on defining file system stuff, config files, etc.",
    "created_at": "2022-01-15T05:53:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609269",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:23'></a>
+1 on a mechanism for statically declaring features present/not present, for use by downstream distributions. They could be provided through `sage_conf`.

-1 on defining file system stuff, config files, etc.



---

archive/issue_comments_609270.json:
```json
{
    "body": "<a id='comment:24'></a>\nReplying to [mjo](#comment%3A22):\n> 1. You have to reimplement every spkg-configure.m4 in python for the feature check and keep them synchronized forever.\n\n\nA more positive perspective on that would be that eventually, when we can assume that there is an at least mildly usable python3 available at `./configure` time, we can replace many `spkg-configure.m4` tests by Feature tests, written in Python.",
    "created_at": "2022-01-15T05:55:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609270",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>
Replying to [mjo](#comment%3A22):
> 1. You have to reimplement every spkg-configure.m4 in python for the feature check and keep them synchronized forever.


A more positive perspective on that would be that eventually, when we can assume that there is an at least mildly usable python3 available at `./configure` time, we can replace many `spkg-configure.m4` tests by Feature tests, written in Python.



---

archive/issue_comments_609271.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [mkoeppe](#comment%3A23):\n> +1 on a mechanism for statically declaring features present/not present, for use by downstream distributions. They could be provided through `sage_conf`.\n> \n> -1 on defining file system stuff, config files, etc.\n> \n\n\nWith sleep comes clarity. Instead of something like pkg-config, why don't we literally use pkg-config for this? To each feature, associate `sage-$feature.pc`. This meets all the criteria above without any hacky wheel reinventing. Distros are already familiar with the concept. `PKG_CONFIG_PATH` tricks should let us avoid version mismatch issues when, say, a git checkout is used on a system where a distro sage is also installed.\n\n> A more positive perspective on that would be that eventually, when we can assume that there is an at least mildly usable python3 available at ./configure time, we can replace many spkg-configure.m4 tests by Feature tests, written in Python. \n\n\nMaybe in some cases, but in general we aren't going to be able to easily replace well-tested autoconf macros with hand-written python. Consequently we'll wind up with the same machinery implemented in two different places in two different languages.",
    "created_at": "2022-01-15T13:51:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609271",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:25'></a>
Replying to [mkoeppe](#comment%3A23):
> +1 on a mechanism for statically declaring features present/not present, for use by downstream distributions. They could be provided through `sage_conf`.
> 
> -1 on defining file system stuff, config files, etc.
> 


With sleep comes clarity. Instead of something like pkg-config, why don't we literally use pkg-config for this? To each feature, associate `sage-$feature.pc`. This meets all the criteria above without any hacky wheel reinventing. Distros are already familiar with the concept. `PKG_CONFIG_PATH` tricks should let us avoid version mismatch issues when, say, a git checkout is used on a system where a distro sage is also installed.

> A more positive perspective on that would be that eventually, when we can assume that there is an at least mildly usable python3 available at ./configure time, we can replace many spkg-configure.m4 tests by Feature tests, written in Python. 


Maybe in some cases, but in general we aren't going to be able to easily replace well-tested autoconf macros with hand-written python. Consequently we'll wind up with the same machinery implemented in two different places in two different languages.



---

archive/issue_comments_609272.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [mjo](#comment%3A25):\n> > A more positive perspective on that would be that eventually, when we can assume that there is an at least mildly usable python3 available at ./configure time, we can replace many spkg-configure.m4 tests by Feature tests, written in Python. \n\n> \n> Maybe in some cases, but in general we aren't going to be able to easily replace well-tested autoconf macros with hand-written python. Consequently we'll wind up with the same machinery implemented in two different places in two different languages.\n\n\nThe trickiest `spkg-configure.m4` tests are for compile-time stuff - existence of libraries and such - and they do not need to be implemented in `sage.features`.",
    "created_at": "2022-01-15T16:22:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609272",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:26'></a>
Replying to [mjo](#comment%3A25):
> > A more positive perspective on that would be that eventually, when we can assume that there is an at least mildly usable python3 available at ./configure time, we can replace many spkg-configure.m4 tests by Feature tests, written in Python. 

> 
> Maybe in some cases, but in general we aren't going to be able to easily replace well-tested autoconf macros with hand-written python. Consequently we'll wind up with the same machinery implemented in two different places in two different languages.


The trickiest `spkg-configure.m4` tests are for compile-time stuff - existence of libraries and such - and they do not need to be implemented in `sage.features`.



---

archive/issue_comments_609273.json:
```json
{
    "body": "<a id='comment:27'></a>\nA possible solution could be to go through #31277.",
    "created_at": "2022-01-15T19:47:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30746#issuecomment-609273",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'></a>
A possible solution could be to go through #31277.



---

archive/issue_events_090301.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T01:55:27Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30746#event-90301"
}
```



---

archive/issue_events_090302.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T01:55:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30746#event-90302"
}
```



---

archive/issue_events_090303.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30746#event-90303"
}
```



---

archive/issue_events_090304.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30746",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30746#event-90304"
}
```
