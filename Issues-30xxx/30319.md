# Issue 30319: Upgrade cddlib to fix wrong intersection of polytopes

archive/issues_030082.json:
```json
{
    "body": "CC:  @jplab @mkoeppe @dimpase @vbraun\n\nAs reported in [this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/514hUpM7pBY), the intersection of polytopes is sometimes very wrong\n\n```\na = Polyhedron([[0, -1, 1], [1, -1, 1], [1, 1, -1]])\nb = Polyhedron([[0.0, -0.5, 1.5], [1.0, -0.5, 1.5], [1.0, 1.5, -0.5]])\nc = a.intersection(b)\n```\nHere `c` should have been empty but is equal to `b`.\n\nWe fix it by upgrading to cddlib 0.94m, installing symlinks so that consumers of cddlib that have not been updated to work with the new header file locations (#29413) continue to work.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30319\n\n",
    "closed_at": "2021-04-01T19:45:17Z",
    "created_at": "2020-08-08T10:23:58Z",
    "labels": [
        "component: geometry",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Upgrade cddlib to fix wrong intersection of polytopes",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30319",
    "user": "https://github.com/videlec"
}
```
CC:  @jplab @mkoeppe @dimpase @vbraun

As reported in [this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/514hUpM7pBY), the intersection of polytopes is sometimes very wrong

```
a = Polyhedron([[0, -1, 1], [1, -1, 1], [1, 1, -1]])
b = Polyhedron([[0.0, -0.5, 1.5], [1.0, -0.5, 1.5], [1.0, 1.5, -0.5]])
c = a.intersection(b)
```
Here `c` should have been empty but is equal to `b`.

We fix it by upgrading to cddlib 0.94m, installing symlinks so that consumers of cddlib that have not been updated to work with the new header file locations (#29413) continue to work.

Issue created by migration from https://trac.sagemath.org/ticket/30319





---

archive/issue_comments_427181.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2020-08-08T15:10:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427181",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_427182.json:
```json
{
    "body": "Looks like a `cdd` bug.\n\n```\nsage: a = Polyhedron([[0, -1, 1], [1, -1, 1], [1, 1, -1]])\nsage: b = Polyhedron([[0.0, -0.5, 1.5], [1.0, -0.5, 1.5], [1.0, 1.5, -0.5]])\nsage: a = a.change_ring(RDF)\nsage: new_eqns = a.equations() + b.equations()\nsage: new_ieqs = a.inequalities() + b.inequalities()\nsage: Polyhedron(eqns=new_eqns, ieqs=new_ieqs[1:2]+new_ieqs[4:5], verbose=True)\n---- CDD input -----\nH-representation\nlinearity 2 1 2\nbegin\n 5 4 real\n 0.0 0.0 1.0 1.0\n -1.0 0.0 1.0 1.0\n -1.0 2.0 -1.0 0.0\n -1.0 4.0 -2.0 0.0\n 1 0 0 0\nend\n\n---- CDD output -----\nCanonicalize the matrix.\nImplicit linearity rows are:\n\nRedundant rows are:1 3 5 \n\nNonredundant representation:\nThe new row positions are as follows (orig:new).\nEach redundant row has the new number 0.\nEach deleted duplicated row has a number nagative of the row that\nrepresents its equivalence class.\n 1:0 2:1 3:0 4:2 5:0\nH-representation\nlinearity 1  1\nbegin\n 2 4 real\n -1  0  1  1\n -1  4 -2  0\nend\n\nsize = 5 x 4\nNumber Type = real\n\n---- CDD input -----\nCanonicalize the matrix.\nImplicit linearity rows are:\n\nRedundant rows are:1 3 5 \n\nNonredundant representation:\nThe new row positions are as follows (orig:new).\nEach redundant row has the new number 0.\nEach deleted duplicated row has a number nagative of the row that\nrepresents its equivalence class.\n 1:0 2:1 3:0 4:2 5:0\nH-representation\nlinearity 1  1\nbegin\n 2 4 real\n -1  0  1  1\n -1  4 -2  0\nend\n\n---- CDD output -----\nThe second representation:\nV-representation\nlinearity 1  3\nbegin\n 3 4 real\n  0  1  0  0\n  1  7.500000000E-01  1  0\n  0 -5.000000000E-01 -1  1\nend\n\nVertex incidence\necd_file: Incidence of generators and inequalities\nbegin\n  3    3\n 1 -2 : 2 \n 2 -2 : 3 \n 3 -3 : \nend\n\nVertex adjacency\nead_file: Adjacency of generators\nbegin\n  3    3\n 1 1 : 2 \n 2 1 : 1 \n 3 0 : \nend\n\nThe first (input) representation\nH-representation\nlinearity 1  1\nbegin\n 2 4 real\n -1  0  1  1\n -1  4 -2  0\nend\n\nFacet incidence\nicd_file: Incidence of inequalities and generators\nbegin\n  3    3\n 1 -3 : \n 2 -2 : 1 \n 3 -2 : 2 \nend\n\nFacet adjacency\niad_file: Adjacency of inequalities\nbegin\n  3    3\n 1 -2 : 1 \n 2 -2 : 2 \n 3 -2 : 3 \nend\n\nsize = 2 x 4\nNumber Type = real\n\n---- CDD input -----\nThe second representation:\nV-representation\nlinearity 1  3\nbegin\n 3 4 real\n  0  1  0  0\n  1  7.500000000E-01  1  0\n  0 -5.000000000E-01 -1  1\nend\n---- CDD output -----\nThe second representation:\nH-representation\nlinearity 1  3\nbegin\n 3 4 real\n  1  0  0  0\n -1  4 -2  0\n -1  0  1  1\nend\n\nsize = 3 x 4\nNumber Type = real\n\nA 2-dimensional polyhedron in RDF^3 defined as the convex hull of 1 vertex, 1 ray, 1 line\n```\n\nFor some reason `cdd` thinks that row `1` is redundant. If you drop an inequality, everything is fine.",
    "created_at": "2020-08-10T10:04:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427182",
    "user": "https://github.com/kliem"
}
```

Looks like a `cdd` bug.

```
sage: a = Polyhedron([[0, -1, 1], [1, -1, 1], [1, 1, -1]])
sage: b = Polyhedron([[0.0, -0.5, 1.5], [1.0, -0.5, 1.5], [1.0, 1.5, -0.5]])
sage: a = a.change_ring(RDF)
sage: new_eqns = a.equations() + b.equations()
sage: new_ieqs = a.inequalities() + b.inequalities()
sage: Polyhedron(eqns=new_eqns, ieqs=new_ieqs[1:2]+new_ieqs[4:5], verbose=True)
---- CDD input -----
H-representation
linearity 2 1 2
begin
 5 4 real
 0.0 0.0 1.0 1.0
 -1.0 0.0 1.0 1.0
 -1.0 2.0 -1.0 0.0
 -1.0 4.0 -2.0 0.0
 1 0 0 0
end

---- CDD output -----
Canonicalize the matrix.
Implicit linearity rows are:

Redundant rows are:1 3 5 

Nonredundant representation:
The new row positions are as follows (orig:new).
Each redundant row has the new number 0.
Each deleted duplicated row has a number nagative of the row that
represents its equivalence class.
 1:0 2:1 3:0 4:2 5:0
H-representation
linearity 1  1
begin
 2 4 real
 -1  0  1  1
 -1  4 -2  0
end

size = 5 x 4
Number Type = real

---- CDD input -----
Canonicalize the matrix.
Implicit linearity rows are:

Redundant rows are:1 3 5 

Nonredundant representation:
The new row positions are as follows (orig:new).
Each redundant row has the new number 0.
Each deleted duplicated row has a number nagative of the row that
represents its equivalence class.
 1:0 2:1 3:0 4:2 5:0
H-representation
linearity 1  1
begin
 2 4 real
 -1  0  1  1
 -1  4 -2  0
end

---- CDD output -----
The second representation:
V-representation
linearity 1  3
begin
 3 4 real
  0  1  0  0
  1  7.500000000E-01  1  0
  0 -5.000000000E-01 -1  1
end

Vertex incidence
ecd_file: Incidence of generators and inequalities
begin
  3    3
 1 -2 : 2 
 2 -2 : 3 
 3 -3 : 
end

Vertex adjacency
ead_file: Adjacency of generators
begin
  3    3
 1 1 : 2 
 2 1 : 1 
 3 0 : 
end

The first (input) representation
H-representation
linearity 1  1
begin
 2 4 real
 -1  0  1  1
 -1  4 -2  0
end

Facet incidence
icd_file: Incidence of inequalities and generators
begin
  3    3
 1 -3 : 
 2 -2 : 1 
 3 -2 : 2 
end

Facet adjacency
iad_file: Adjacency of inequalities
begin
  3    3
 1 -2 : 1 
 2 -2 : 2 
 3 -2 : 3 
end

size = 2 x 4
Number Type = real

---- CDD input -----
The second representation:
V-representation
linearity 1  3
begin
 3 4 real
  0  1  0  0
  1  7.500000000E-01  1  0
  0 -5.000000000E-01 -1  1
end
---- CDD output -----
The second representation:
H-representation
linearity 1  3
begin
 3 4 real
  1  0  0  0
 -1  4 -2  0
 -1  0  1  1
end

size = 3 x 4
Number Type = real

A 2-dimensional polyhedron in RDF^3 defined as the convex hull of 1 vertex, 1 ray, 1 line
```

For some reason `cdd` thinks that row `1` is redundant. If you drop an inequality, everything is fine.



---

archive/issue_comments_427183.json:
```json
{
    "body": "Could someone please report it upstream (i do not have a github account) ?",
    "created_at": "2020-08-14T10:28:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427183",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Could someone please report it upstream (i do not have a github account) ?



---

archive/issue_comments_427184.json:
```json
{
    "body": "https://github.com/cddlib/cddlib/issues/45",
    "created_at": "2020-08-14T11:38:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427184",
    "user": "https://github.com/kliem"
}
```

https://github.com/cddlib/cddlib/issues/45



---

archive/issue_comments_427185.json:
```json
{
    "body": "Note that with data in comment:2 one has\n\n```\nsage: Polyhedron(eqns=new_eqns)                                                                                                      \nThe empty polyhedron in RDF^3\n```\nso the emptiness should have been detected earlier.",
    "created_at": "2020-09-21T07:24:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427185",
    "user": "https://github.com/dimpase"
}
```

Note that with data in comment:2 one has

```
sage: Polyhedron(eqns=new_eqns)                                                                                                      
The empty polyhedron in RDF^3
```
so the emptiness should have been detected earlier.



---

archive/issue_comments_427186.json:
```json
{
    "body": "Are you proposing that we test whether the equations are infeasible ourselves as a workaround?\n\nSounds like a workaround that should work for us.\n\nIs `cdd` specifically excluding this case?",
    "created_at": "2020-09-21T07:51:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427186",
    "user": "https://github.com/kliem"
}
```

Are you proposing that we test whether the equations are infeasible ourselves as a workaround?

Sounds like a workaround that should work for us.

Is `cdd` specifically excluding this case?



---

archive/issue_comments_427187.json:
```json
{
    "body": "Something like\n\n```\nnew_eqns_matrix = matrix(new_eqns)\nfeasible_directions = new_eqns_matrix.right_kernel_matrix()\nif feasible_directions.column(0).is_zero():\n    initialize_empty_polyhedron()\n```\n\nshould work.",
    "created_at": "2020-09-21T08:00:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427187",
    "user": "https://github.com/kliem"
}
```

Something like

```
new_eqns_matrix = matrix(new_eqns)
feasible_directions = new_eqns_matrix.right_kernel_matrix()
if feasible_directions.column(0).is_zero():
    initialize_empty_polyhedron()
```

should work.



---

archive/issue_comments_427188.json:
```json
{
    "body": "On the other hand, with RDF data and the internal representation used by `cdd`, it is not so hard to come up with (ugly) examples on which it can fail to produce a meaningful answer.\n\nI'd say that computing `c` like in the ticket description should throw an error, \nas `a` is exact and `b` is not.\nOr at the very least print a warning like\n\n```\nsage: a = Polyhedron([[0, -1, 1], [1, -1, 1], [1, 1, -1]],base_ring=RDF) \n....: b = Polyhedron([[0.0, -0.5, 1.5], [1.0, -0.5, 1.5], [1.0, 1.5, -0.5]])                                                         \nsage: a.intersection(b)                                                                                                              \n/mnt/opt/Sage/sage-dev/local/lib/python3.8/site-packages/sage/geometry/polyhedron/backend_cdd.py:151: UserWarning: This polyhedron data is numerically complicated; cdd could not convert between the inexact V and H representation without loss of data. The resulting object might show inconsistencies.\n  warn(\"This polyhedron data is numerically complicated; cdd could not convert between the inexact V and H representation without loss of data. The resulting object might show inconsistencies.\")\nA 2-dimensional polyhedron in RDF^3 defined as the convex hull of 3 vertices\n```",
    "created_at": "2020-09-21T08:59:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427188",
    "user": "https://github.com/dimpase"
}
```

On the other hand, with RDF data and the internal representation used by `cdd`, it is not so hard to come up with (ugly) examples on which it can fail to produce a meaningful answer.

I'd say that computing `c` like in the ticket description should throw an error, 
as `a` is exact and `b` is not.
Or at the very least print a warning like

```
sage: a = Polyhedron([[0, -1, 1], [1, -1, 1], [1, 1, -1]],base_ring=RDF) 
....: b = Polyhedron([[0.0, -0.5, 1.5], [1.0, -0.5, 1.5], [1.0, 1.5, -0.5]])                                                         
sage: a.intersection(b)                                                                                                              
/mnt/opt/Sage/sage-dev/local/lib/python3.8/site-packages/sage/geometry/polyhedron/backend_cdd.py:151: UserWarning: This polyhedron data is numerically complicated; cdd could not convert between the inexact V and H representation without loss of data. The resulting object might show inconsistencies.
  warn("This polyhedron data is numerically complicated; cdd could not convert between the inexact V and H representation without loss of data. The resulting object might show inconsistencies.")
A 2-dimensional polyhedron in RDF^3 defined as the convex hull of 3 vertices
```



---

archive/issue_comments_427189.json:
```json
{
    "body": "it's also weird that no warning is printed in this case:\n\n```\nsage: a = Polyhedron([[0, -1, 1], [1, -1, 1], [1, 1, -1]])\n....: b = Polyhedron([[0.0, -0.5, 1.5], [1.0, -0.5, 1.5], [1.0, 1.5, -0.5]])      \n....: b.intersection(a)                                  \nA 2-dimensional polyhedron in RDF^3 defined as the convex hull of 3 vertices\n```\nas if seeing the exact `a` to intersect `b` with convinces cdd that everything should be fine.",
    "created_at": "2020-09-21T09:06:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427189",
    "user": "https://github.com/dimpase"
}
```

it's also weird that no warning is printed in this case:

```
sage: a = Polyhedron([[0, -1, 1], [1, -1, 1], [1, 1, -1]])
....: b = Polyhedron([[0.0, -0.5, 1.5], [1.0, -0.5, 1.5], [1.0, 1.5, -0.5]])      
....: b.intersection(a)                                  
A 2-dimensional polyhedron in RDF^3 defined as the convex hull of 3 vertices
```
as if seeing the exact `a` to intersect `b` with convinces cdd that everything should be fine.



---

archive/issue_comments_427190.json:
```json
{
    "body": "The behavior of coercing base rings is the correct and expected behaviour, I would say.\n\nThe failure of `cdd` has nothing to do with inexactness:\n\n```\nsage: a = Polyhedron([[0, -1, 1], [1, -1, 1], [1, 1, -1]], backend='cdd')                                                                                                           \nsage: b = Polyhedron([[0, -1/2, 3/2], [1, -1/2, 3/2], [1, 3/2, -1/2]], backend='cdd')                                                                                               \nsage: a.intersection(b)                                                                                                                                                             \nA 2-dimensional polyhedron in QQ^3 defined as the convex hull of 3 vertices\n```",
    "created_at": "2020-09-21T09:07:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427190",
    "user": "https://github.com/kliem"
}
```

The behavior of coercing base rings is the correct and expected behaviour, I would say.

The failure of `cdd` has nothing to do with inexactness:

```
sage: a = Polyhedron([[0, -1, 1], [1, -1, 1], [1, 1, -1]], backend='cdd')                                                                                                           
sage: b = Polyhedron([[0, -1/2, 3/2], [1, -1/2, 3/2], [1, 3/2, -1/2]], backend='cdd')                                                                                               
sage: a.intersection(b)                                                                                                                                                             
A 2-dimensional polyhedron in QQ^3 defined as the convex hull of 3 vertices
```



---

archive/issue_comments_427191.json:
```json
{
    "body": "`cdd` for some reason determines that one of the equations is redundant. After this the calculation is correct. For this reason, no warning is printed. Because converting from Vrepresention to Hrepresentation works.\n\nThe output of `cdd` is numerical consistent, but incorrect.",
    "created_at": "2020-09-21T09:09:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427191",
    "user": "https://github.com/kliem"
}
```

`cdd` for some reason determines that one of the equations is redundant. After this the calculation is correct. For this reason, no warning is printed. Because converting from Vrepresention to Hrepresentation works.

The output of `cdd` is numerical consistent, but incorrect.



---

archive/issue_comments_427192.json:
```json
{
    "body": "Replying to [comment:10 gh-kliem]:\n> The behavior of coercing base rings is the correct and expected behaviour, I would say.\n> \n> The failure of `cdd` has nothing to do with inexactness:\n\n\nOK, I see, you're right - I thought it's an inexactness issue, such as computing rank of an RDF matrix, sorry.",
    "created_at": "2020-09-21T11:05:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427192",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:10 gh-kliem]:
> The behavior of coercing base rings is the correct and expected behaviour, I would say.
> 
> The failure of `cdd` has nothing to do with inexactness:


OK, I see, you're right - I thought it's an inexactness issue, such as computing rank of an RDF matrix, sorry.



---

archive/issue_events_078533.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30319#event-78533"
}
```



---

archive/issue_comments_427193.json:
```json
{
    "body": "The fix is in \nhttps://github.com/cddlib/cddlib/releases/tag/0.94m\n\nlet's upgrade",
    "created_at": "2020-12-09T16:06:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427193",
    "user": "https://github.com/dimpase"
}
```

The fix is in 
https://github.com/cddlib/cddlib/releases/tag/0.94m

let's upgrade



---

archive/issue_comments_427194.json:
```json
{
    "body": "How important do we consider this bug. Should we reject older system installs?",
    "created_at": "2020-12-09T16:10:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427194",
    "user": "https://github.com/kliem"
}
```

How important do we consider this bug. Should we reject older system installs?



---

archive/issue_comments_427195.json:
```json
{
    "body": "Ok, it warned me because of a conflict, but I did not expect it to change the description back.",
    "created_at": "2020-12-09T16:13:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427195",
    "user": "https://github.com/kliem"
}
```

Ok, it warned me because of a conflict, but I did not expect it to change the description back.



---

archive/issue_comments_427196.json:
```json
{
    "body": "There is a bug in latte_int with the new header location that needs fixing yet:\n\nhttps://github.com/latte-int/latte/issues/15",
    "created_at": "2020-12-09T16:45:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427196",
    "user": "https://github.com/kliem"
}
```

There is a bug in latte_int with the new header location that needs fixing yet:

https://github.com/latte-int/latte/issues/15



---

archive/issue_comments_427197.json:
```json
{
    "body": "`@`mkoeppe\n\nThere is already a patch for latte, but I'm incapable of creating a patch for latte-int not latte-integral.",
    "created_at": "2020-12-09T18:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427197",
    "user": "https://github.com/kliem"
}
```

`@`mkoeppe

There is already a patch for latte, but I'm incapable of creating a patch for latte-int not latte-integral.



---

archive/issue_comments_427198.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-12-09T18:33:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427198",
    "user": "https://github.com/kliem"
}
```

New commits:



---

archive/issue_comments_427199.json:
```json
{
    "body": "Replying to [comment:17 gh-kliem]:\n> How important do we consider this bug. Should we reject older system installs?\n\nA good idea, I think.",
    "created_at": "2020-12-15T20:04:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427199",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:17 gh-kliem]:
> How important do we consider this bug. Should we reject older system installs?

A good idea, I think.



---

archive/issue_comments_427200.json:
```json
{
    "body": "I agree as well.",
    "created_at": "2020-12-15T20:17:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427200",
    "user": "https://github.com/mkoeppe"
}
```

I agree as well.



---

archive/issue_comments_427201.json:
```json
{
    "body": "It seems that the system cdd will also leak into singular:\n\n`Singular/m4/gfanlib-check.m4`:\n\n```\n  AC_CHECK_HEADERS([setoper.h cdd/setoper.h cddlib/setoper.h])\n  if test \"x$ac_cv_header_setoper_h\" = xno -a \"x$ac_cv_header_cdd_setoper_h\" = xno -a \"x$ac_cv_header_cddlib_setoper_h\" = xno\n  then\n    if test \"x$ENABLE_GFANLIB\" = \"xyes\"; then\n      AC_MSG_ERROR([Error, setoper.h is missing!])\n    fi\n```",
    "created_at": "2021-03-18T06:05:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427201",
    "user": "https://github.com/kliem"
}
```

It seems that the system cdd will also leak into singular:

`Singular/m4/gfanlib-check.m4`:

```
  AC_CHECK_HEADERS([setoper.h cdd/setoper.h cddlib/setoper.h])
  if test "x$ac_cv_header_setoper_h" = xno -a "x$ac_cv_header_cdd_setoper_h" = xno -a "x$ac_cv_header_cddlib_setoper_h" = xno
  then
    if test "x$ENABLE_GFANLIB" = "xyes"; then
      AC_MSG_ERROR([Error, setoper.h is missing!])
    fi
```



---

archive/issue_comments_427202.json:
```json
{
    "body": "Singular always prefers `<cdd/....h>` over `<cddlib/....h`. This means that on debian a system cdd will always be prefered, if I'm not mistaken.\n\nI don't know if this leads to any problems?\n\nWe could patch singular to modify the preference to `<cddlib/....h>` over `<cdd/....h>`. If we set up the path correctly, then sage's cdd will be prefered, even if there is a system cdd that is also in `<cdd/....h>`. Right??\n\nThis would be preferable in general I think (for singular as well). If there is a seperate install of cdd, it will always be in `cddlib/`.",
    "created_at": "2021-03-18T06:29:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427202",
    "user": "https://github.com/kliem"
}
```

Singular always prefers `<cdd/....h>` over `<cddlib/....h`. This means that on debian a system cdd will always be prefered, if I'm not mistaken.

I don't know if this leads to any problems?

We could patch singular to modify the preference to `<cddlib/....h>` over `<cdd/....h>`. If we set up the path correctly, then sage's cdd will be prefered, even if there is a system cdd that is also in `<cdd/....h>`. Right??

This would be preferable in general I think (for singular as well). If there is a seperate install of cdd, it will always be in `cddlib/`.



---

archive/issue_comments_427203.json:
```json
{
    "body": "I suppose we can also just install a few symlinks in cddlib's spkg-install.\nThen we could finish the present ticket without having to wait for all the dependencies.\nLater, in a followup ticket when packages have been updated, we could eliminate the symlinks again.",
    "created_at": "2021-03-18T06:32:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427203",
    "user": "https://github.com/mkoeppe"
}
```

I suppose we can also just install a few symlinks in cddlib's spkg-install.
Then we could finish the present ticket without having to wait for all the dependencies.
Later, in a followup ticket when packages have been updated, we could eliminate the symlinks again.



---

archive/issue_comments_427204.json:
```json
{
    "body": "We could to that with the symlinks and singular will pull in the correct library then, I think (at least if my assumption that the path is an ordered list and we lock for headers from sage first is correct).\n\nI don't think we have to wait on singular. It's been leaking all along prefering the `cdd` system one over sage's header. It also checks for `cddlib`, so it won't fail.",
    "created_at": "2021-03-18T06:56:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427204",
    "user": "https://github.com/kliem"
}
```

We could to that with the symlinks and singular will pull in the correct library then, I think (at least if my assumption that the path is an ordered list and we lock for headers from sage first is correct).

I don't think we have to wait on singular. It's been leaking all along prefering the `cdd` system one over sage's header. It also checks for `cddlib`, so it won't fail.



---

archive/issue_comments_427205.json:
```json
{
    "body": "gfan only checks plain cdd.h\n\nIn fact it looks to me, like gfan wouldn't be able to pick up a systems cdd at all (because the headers are in the subfolder cddlib resp. cdd). So that is actually a bug in the install system. Because if you have cdd installed in your system, but gfan not, then you won't be able to build gfan.",
    "created_at": "2021-03-18T07:54:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427205",
    "user": "https://github.com/kliem"
}
```

gfan only checks plain cdd.h

In fact it looks to me, like gfan wouldn't be able to pick up a systems cdd at all (because the headers are in the subfolder cddlib resp. cdd). So that is actually a bug in the install system. Because if you have cdd installed in your system, but gfan not, then you won't be able to build gfan.



---

archive/issue_comments_427206.json:
```json
{
    "body": "We should also update topcom's configure patch to match t, the updated version of latte. This should be easy, as we completely control topcom's configure",
    "created_at": "2021-03-18T07:55:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427206",
    "user": "https://github.com/kliem"
}
```

We should also update topcom's configure patch to match t, the updated version of latte. This should be easy, as we completely control topcom's configure



---

archive/issue_comments_427207.json:
```json
{
    "body": "Polymake is a different topic.\n\nAccording to this https://github.com/polymake/polymake/blob/c2a326f240b11a06e1b1d5fd1c2ca7278bbe60a2/bundled/cdd/support/configure.pl\n\nwe probably need to specify the path to cdd. But I wouldn't know how to make this work for the systems cdd. But then again, I don't understand perl at all.",
    "created_at": "2021-03-18T08:01:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427207",
    "user": "https://github.com/kliem"
}
```

Polymake is a different topic.

According to this https://github.com/polymake/polymake/blob/c2a326f240b11a06e1b1d5fd1c2ca7278bbe60a2/bundled/cdd/support/configure.pl

we probably need to specify the path to cdd. But I wouldn't know how to make this work for the systems cdd. But then again, I don't understand perl at all.



---

archive/issue_comments_427208.json:
```json
{
    "body": "I think if we only make sure things don't get worse as they have been, this ticket is very much doable.\n\nWe probably need a follow up ticket to fix gfan to work with systems cdd.\n\nEdit: I see, we ignore system cdd installs, if headers are in a subfolder. This is why I have cdd installed in both the system and in sage as well. I guess with the current ticket, we know exactly what we need to do, to be able to drop this.",
    "created_at": "2021-03-18T08:03:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427208",
    "user": "https://github.com/kliem"
}
```

I think if we only make sure things don't get worse as they have been, this ticket is very much doable.

We probably need a follow up ticket to fix gfan to work with systems cdd.

Edit: I see, we ignore system cdd installs, if headers are in a subfolder. This is why I have cdd installed in both the system and in sage as well. I guess with the current ticket, we know exactly what we need to do, to be able to drop this.



---

archive/issue_comments_427209.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-03-18T20:24:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427209",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_427210.json:
```json
{
    "body": "Do you know how to test for the cddlib bug in spkg-configure.m4?",
    "created_at": "2021-03-18T20:27:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427210",
    "user": "https://github.com/mkoeppe"
}
```

Do you know how to test for the cddlib bug in spkg-configure.m4?



---

archive/issue_comments_427211.json:
```json
{
    "body": "Replying to [comment:35 git]:\n> Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n> |                                                                                                                                           |               |\n> |-------------------------------------------------------------------------------------------------------------------------------------------|---------------|\n> |[308274d](https://git.sagemath.org/sage.git/commit/?id=308274d2e56ccd1cb75e471f5d59b8e0ad0111d9)|`update cddlib`|\n> |[ed3ed2a](https://git.sagemath.org/sage.git/commit/?id=ed3ed2a20f98f534d13b461d7b476fbc776928a1)|`build/pkgs/cddlib/spkg-install.in: Install symlinks for cddlib/*.h`|\n\n\nI'm a bit confused on why you deleted the work issues. Did you forget to push something?",
    "created_at": "2021-03-18T20:31:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427211",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:35 git]:
> Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
> |                                                                                                                                           |               |
> |-------------------------------------------------------------------------------------------------------------------------------------------|---------------|
> |[308274d](https://git.sagemath.org/sage.git/commit/?id=308274d2e56ccd1cb75e471f5d59b8e0ad0111d9)|`update cddlib`|
> |[ed3ed2a](https://git.sagemath.org/sage.git/commit/?id=ed3ed2a20f98f534d13b461d7b476fbc776928a1)|`build/pkgs/cddlib/spkg-install.in: Install symlinks for cddlib/*.h`|


I'm a bit confused on why you deleted the work issues. Did you forget to push something?



---

archive/issue_comments_427212.json:
```json
{
    "body": "Create a file\n\ntest.ine\n\nwith\n\n```\nH-representation\nlinearity 2 1 2\nbegin\n 5 4 real\n 0.0 0.0 1.0 1.0\n -1.0 0.0 1.0 1.0\n -1.0 2.0 -1.0 0.0\n -1.0 4.0 -2.0 0.0\n 1 0 0 0\nend\n```\n\nand run `cddexec --redcheck <test.ine`.\n\nThe line `Redundant rows are` should not contain a `1`.",
    "created_at": "2021-03-18T20:43:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427212",
    "user": "https://github.com/kliem"
}
```

Create a file

test.ine

with

```
H-representation
linearity 2 1 2
begin
 5 4 real
 0.0 0.0 1.0 1.0
 -1.0 0.0 1.0 1.0
 -1.0 2.0 -1.0 0.0
 -1.0 4.0 -2.0 0.0
 1 0 0 0
end
```

and run `cddexec --redcheck <test.ine`.

The line `Redundant rows are` should not contain a `1`.



---

archive/issue_comments_427213.json:
```json
{
    "body": "Replying to [comment:37 gh-kliem]:\n> I'm a bit confused on why you deleted the work issues. Did you forget to push something?\n\n\nI thought the result of our discussion was that by installing the symlinks, we do not have to fix anything in the other packages.",
    "created_at": "2021-03-18T20:49:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427213",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:37 gh-kliem]:
> I'm a bit confused on why you deleted the work issues. Did you forget to push something?


I thought the result of our discussion was that by installing the symlinks, we do not have to fix anything in the other packages.



---

archive/issue_comments_427214.json:
```json
{
    "body": "Or is there a package that no longer finds a prefix-less system cdd?",
    "created_at": "2021-03-18T20:50:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427214",
    "user": "https://github.com/mkoeppe"
}
```

Or is there a package that no longer finds a prefix-less system cdd?



---

archive/issue_comments_427215.json:
```json
{
    "body": "I see.\n\nOk, then technically the latte upgrade isn't a decency anymore.",
    "created_at": "2021-03-18T21:29:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427215",
    "user": "https://github.com/kliem"
}
```

I see.

Ok, then technically the latte upgrade isn't a decency anymore.



---

archive/issue_comments_427216.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-18T22:00:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427216",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_427217.json:
```json
{
    "body": "OK... the new configure check works correctly on `homebrew-macos-standard` (result: `yes` - but then the package is rejected because the headers are in the new place) and on `ubuntu-focal-standard` (result: `no`).",
    "created_at": "2021-03-18T22:23:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427217",
    "user": "https://github.com/mkoeppe"
}
```

OK... the new configure check works correctly on `homebrew-macos-standard` (result: `yes` - but then the package is rejected because the headers are in the new place) and on `ubuntu-focal-standard` (result: `no`).



---

archive/issue_comments_427218.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-03-18T22:23:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427218",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_427219.json:
```json
{
    "body": "Let's please get this fix into 9.3",
    "created_at": "2021-03-24T00:29:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427219",
    "user": "https://github.com/mkoeppe"
}
```

Let's please get this fix into 9.3



---

archive/issue_comments_427220.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-03-25T18:42:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427220",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_427221.json:
```json
{
    "body": "ok",
    "created_at": "2021-03-25T18:42:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427221",
    "user": "https://github.com/dimpase"
}
```

ok



---

archive/issue_comments_427222.json:
```json
{
    "body": "Thank you.",
    "created_at": "2021-03-25T18:52:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427222",
    "user": "https://github.com/kliem"
}
```

Thank you.



---

archive/issue_comments_427223.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-03-25T19:10:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427223",
    "user": "https://github.com/mkoeppe"
}
```

Thanks!



---

archive/issue_comments_427224.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2021-03-29T23:54:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427224",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_427225.json:
```json
{
    "body": "Setting priority to blocker to bring this ticket to the attention of the release bot.",
    "created_at": "2021-03-29T23:54:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427225",
    "user": "https://github.com/mkoeppe"
}
```

Setting priority to blocker to bring this ticket to the attention of the release bot.



---

archive/issue_comments_427226.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-04-01T19:45:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30319#issuecomment-427226",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_078534.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-04-01T19:45:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30319",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30319#event-78534"
}
```
