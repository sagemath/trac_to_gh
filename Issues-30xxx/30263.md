# Issue 30263: declare_union yields wrong results

archive/issues_030026.json:
```json
{
    "body": "(for the visualization of the posets, use #31680 and install the `dot2tex` package - without that package, the layout is quite misleading)\n\n```\nsage: M = Manifold(3, 'M')\nsage: U = M.open_subset('U'); V = M.open_subset('V'); W = M.open_subset('W')\nsage: M.declare_union(U, V, W)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-3-c7f527dcc1ea> in <module>()\n----> 1 M.declare_union(U, V, W)\n\nTypeError: declare_union() takes 3 positional arguments but 4 were given\n\nsage: def label(element): \n....:     try: \n....:         return element._name \n....:     except AttributeError: \n....:         return '[' + ', '.join(sorted(x._name for x in element)) + ']' \n\nsage: P = M.subset_poset(open_covers=True); P.plot(element_labels={element: label(element) for element in P})\n\nsage: M.declare_union(U, V.union(W))\nsage: P = M.subset_poset(open_covers=True); P.plot(element_labels={element: label(element) for element in P})\n\nsage: U.union(V).union(W)\nOpen subset U_union_V_union_W of the 3-dimensional differentiable manifold M\nsage: P = M.subset_poset(open_covers=True); P.plot(element_labels={element: label(element) for element in P})\n\nsage: U.union(V.union(W))\n3-dimensional differentiable manifold M\nsage: P = M.subset_poset(open_covers=True); P.plot(element_labels={element: label(element) for element in P})  # same\n\nsage: M.is_subset(U.union(V).union(W))                                                         \nFalse\n```\n\n#31764 adds support for arbitrary unions. But the main issue here is  the failing associativity of the union. \n\nWe fix it as follows.\n\nWhen creating a union, we update the open covers of the supersets of the members, replacing the union members by the union.\n\n\n\nCC:  @egourgoulhon @tscrim\n\nKeywords: sets, union\n\nAuthor: Matthias Koeppe\n\nBranch: u/mkoeppe/declare_union_yields_wrong_results\n\nDependencies: #31764\n\nCommit: 743f11446a96c32cde3873ebe0a907cdbd0c305b\n\nIssue created by migration from https://trac.sagemath.org/ticket/30263\n\n",
    "created_at": "2020-08-01T07:11:42Z",
    "labels": [
        "component: manifolds",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "declare_union yields wrong results",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30263",
    "user": "https://github.com/mjungmath"
}
```
(for the visualization of the posets, use #31680 and install the `dot2tex` package - without that package, the layout is quite misleading)

```
sage: M = Manifold(3, 'M')
sage: U = M.open_subset('U'); V = M.open_subset('V'); W = M.open_subset('W')
sage: M.declare_union(U, V, W)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-3-c7f527dcc1ea> in <module>()
----> 1 M.declare_union(U, V, W)

TypeError: declare_union() takes 3 positional arguments but 4 were given

sage: def label(element): 
....:     try: 
....:         return element._name 
....:     except AttributeError: 
....:         return '[' + ', '.join(sorted(x._name for x in element)) + ']' 

sage: P = M.subset_poset(open_covers=True); P.plot(element_labels={element: label(element) for element in P})

sage: M.declare_union(U, V.union(W))
sage: P = M.subset_poset(open_covers=True); P.plot(element_labels={element: label(element) for element in P})

sage: U.union(V).union(W)
Open subset U_union_V_union_W of the 3-dimensional differentiable manifold M
sage: P = M.subset_poset(open_covers=True); P.plot(element_labels={element: label(element) for element in P})

sage: U.union(V.union(W))
3-dimensional differentiable manifold M
sage: P = M.subset_poset(open_covers=True); P.plot(element_labels={element: label(element) for element in P})  # same

sage: M.is_subset(U.union(V).union(W))                                                         
False
```

#31764 adds support for arbitrary unions. But the main issue here is  the failing associativity of the union. 

We fix it as follows.

When creating a union, we update the open covers of the supersets of the members, replacing the union members by the union.



CC:  @egourgoulhon @tscrim

Keywords: sets, union

Author: Matthias Koeppe

Branch: u/mkoeppe/declare_union_yields_wrong_results

Dependencies: #31764

Commit: 743f11446a96c32cde3873ebe0a907cdbd0c305b

Issue created by migration from https://trac.sagemath.org/ticket/30263





---

archive/issue_events_078275.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30263",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30263#event-78275"
}
```



---

archive/issue_comments_426349.json:
```json
{
    "body": "<a id='comment:2'></a>Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-04-07T19:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30263#issuecomment-426349",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_events_078276.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-07T19:29:15Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30263",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30263#event-78276"
}
```



---

archive/issue_events_078277.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-07T19:29:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30263",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30263#event-78277"
}
```



---

archive/issue_comments_426350.json:
```json
{
    "body": "<a id='comment:3'></a>Unions of several subsets also appear in another form - as open covers (which are merely lists of subsets and not manifold subsets in their own right). One might ask whether this could be unified as well.",
    "created_at": "2021-04-18T17:02:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30263#issuecomment-426350",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>Unions of several subsets also appear in another form - as open covers (which are merely lists of subsets and not manifold subsets in their own right). One might ask whether this could be unified as well.



---

archive/issue_comments_426351.json:
```json
{
    "body": "<a id='comment:5'></a>An issue with the existing code is that through a sequence of `declare_union` calls, it is possible to obtain a situation in which two subsets must be the same, although `declare_union` makes a (not very effective) attempt to stop the user from doing so (by checking whether the two arguments are the same).\n\nIn terms of the poset of subsets that is defined by the `_subsets` (and `_supersets`) attributes (which is visualized by the code from #31680), this is quite problematic. \n\nThis could be solved by introducing equivalence classes of subsets - for example by keeping the `_subsets` relation acyclic and introducing an `_equal_sets` attribute; loops that update subsets will have to be modified.\nThe elements of the poset introduced in #31680 then would be equivalence classes of subsets rather than subsets.",
    "created_at": "2021-04-21T19:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30263#issuecomment-426351",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>An issue with the existing code is that through a sequence of `declare_union` calls, it is possible to obtain a situation in which two subsets must be the same, although `declare_union` makes a (not very effective) attempt to stop the user from doing so (by checking whether the two arguments are the same).

In terms of the poset of subsets that is defined by the `_subsets` (and `_supersets`) attributes (which is visualized by the code from #31680), this is quite problematic. 

This could be solved by introducing equivalence classes of subsets - for example by keeping the `_subsets` relation acyclic and introducing an `_equal_sets` attribute; loops that update subsets will have to be modified.
The elements of the poset introduced in #31680 then would be equivalence classes of subsets rather than subsets.



---

archive/issue_comments_426352.json:
```json
{
    "body": "<a id='comment:9'></a>Last 10 new commits:",
    "created_at": "2021-04-24T02:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30263#issuecomment-426352",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>Last 10 new commits:



---

archive/issue_comments_426353.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-24T20:35:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30263#issuecomment-426353",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426354.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-24T21:32:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30263#issuecomment-426354",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426355.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-25T00:33:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30263#issuecomment-426355",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426356.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-25T06:16:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30263#issuecomment-426356",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426357.json:
```json
{
    "body": "<a id='comment:20'></a>Last 10 new commits:",
    "created_at": "2021-05-03T05:51:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30263#issuecomment-426357",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>Last 10 new commits:



---

archive/issue_events_078278.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T02:58:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30263",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30263#event-78278"
}
```



---

archive/issue_events_078279.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T02:58:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30263",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30263#event-78279"
}
```



---

archive/issue_events_078280.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:41:23Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30263",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30263#event-78280"
}
```



---

archive/issue_events_078281.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:41:23Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30263",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30263#event-78281"
}
```



---

archive/issue_events_078282.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T01:55:27Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30263",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30263#event-78282"
}
```



---

archive/issue_events_078283.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T01:55:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30263",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30263#event-78283"
}
```



---

archive/issue_events_078284.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30263",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30263#event-78284"
}
```



---

archive/issue_events_078285.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30263",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30263#event-78285"
}
```
