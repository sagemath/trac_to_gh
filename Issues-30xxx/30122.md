# Issue 30122: Fix maxima/ecl unicode handling

archive/issues_029885.json:
```json
{
    "body": "Follow-up from #30106, where the following was observed:\n\n```\nsage: var('\u03be')._maxima_()\n....: \n<repr(<sage.interfaces.maxima_lib.MaximaLibElement at 0x32c1d4828>) failed: RuntimeError: ECL says: Cannot coerce string $_SAGE_VAR_\u03be to a base-string>\n```\nThe above error is due to a bug in ECL 16.1.2 and 20.4.24:\n\n```\n> (princ-to-string '\u03be)\n\"\u039e\"\n> (setf local-table (copy-readtable nil))\n> (setf (readtable-case local-table) :invert)\n:INVERT\n> (let ((*readtable* local-table) (*print-case* :upcase)) (princ-to-string '\u03be))\nCannot coerce string \u039e to a base-string\n```\nThe above code is from Maxima's `PRINT-INVERT-CASE` function in commac.lisp.\n\nUpstream issue: https://gitlab.com/embeddable-common-lisp/ecl/-/issues/602\n\n\nCC:  @mwageringel @nbruin @dimpase @spaghettisalat\n\nBranch/Commit: da56bb34222684ab6810554aaf90e98ab614f39f\n\nUpstream: Fixed upstream, but not in a stable release.\n\nReviewer: Markus Wageringel\n\nAuthor: Matthias Koeppe\n\nDependencies: #30106, #22191\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30122\n\n",
    "closed_at": "2020-07-25T22:50:59Z",
    "created_at": "2020-07-12T16:20:19Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Fix maxima/ecl unicode handling",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30122",
    "user": "https://github.com/mkoeppe"
}
```
Follow-up from #30106, where the following was observed:

```
sage: var('ξ')._maxima_()
....: 
<repr(<sage.interfaces.maxima_lib.MaximaLibElement at 0x32c1d4828>) failed: RuntimeError: ECL says: Cannot coerce string $_SAGE_VAR_ξ to a base-string>
```
The above error is due to a bug in ECL 16.1.2 and 20.4.24:

```
> (princ-to-string 'ξ)
"Ξ"
> (setf local-table (copy-readtable nil))
> (setf (readtable-case local-table) :invert)
:INVERT
> (let ((*readtable* local-table) (*print-case* :upcase)) (princ-to-string 'ξ))
Cannot coerce string Ξ to a base-string
```
The above code is from Maxima's `PRINT-INVERT-CASE` function in commac.lisp.

Upstream issue: https://gitlab.com/embeddable-common-lisp/ecl/-/issues/602


CC:  @mwageringel @nbruin @dimpase @spaghettisalat

Branch/Commit: da56bb34222684ab6810554aaf90e98ab614f39f

Upstream: Fixed upstream, but not in a stable release.

Reviewer: Markus Wageringel

Author: Matthias Koeppe

Dependencies: #30106, #22191

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/30122





---

archive/issue_comments_591991.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -12,7 +12,7 @@\n \"\u039e\"\n > (setf local-table (copy-readtable nil))\n > (setf (readtable-case local-table) :invert)\n-> :INVERT\n+:INVERT\n > (let ((*readtable* local-table) (*print-case* :upcase)) (princ-to-string '\u03be))\n Cannot coerce string \u039e to a base-string\n ```\n``````\n",
    "created_at": "2020-07-12T17:11:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30122#issuecomment-591991",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -12,7 +12,7 @@
 "Ξ"
 > (setf local-table (copy-readtable nil))
 > (setf (readtable-case local-table) :invert)
-> :INVERT
+:INVERT
 > (let ((*readtable* local-table) (*print-case* :upcase)) (princ-to-string 'ξ))
 Cannot coerce string Ξ to a base-string
 ```
``````




---

archive/issue_comments_591992.json:
```json
{
    "body": "Changing upstream from \"Not yet reported upstream; Will do shortly.\" to \"Reported upstream. No feedback yet.\"",
    "created_at": "2020-07-12T17:16:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30122#issuecomment-591992",
    "user": "https://github.com/mkoeppe"
}
```

Changing upstream from "Not yet reported upstream; Will do shortly." to "Reported upstream. No feedback yet."



---

archive/issue_comments_591993.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,24 @@\n+Follow-up from #30106, where the following was observed:\n+\n+```\n+sage: var('\u03be')._maxima_()\n+....: \n+<repr(<sage.interfaces.maxima_lib.MaximaLibElement at 0x32c1d4828>) failed: RuntimeError: ECL says: Cannot coerce string $_SAGE_VAR_\u03be to a base-string>\n+```\n+The above error is due to a bug in ECL 16.1.2 and 20.4.24:\n+\n+```\n+> (princ-to-string '\u03be)\n+\"\u039e\"\n+> (setf local-table (copy-readtable nil))\n+> (setf (readtable-case local-table) :invert)\n+:INVERT\n+> (let ((*readtable* local-table) (*print-case* :upcase)) (princ-to-string '\u03be))\n+Cannot coerce string \u039e to a base-string\n+```\n+The above code is from Maxima's `PRINT-INVERT-CASE` function in commac.lisp.\n+\n+Upstream issue: https://gitlab.com/embeddable-common-lisp/ecl/-/issues/602\n \n \n Upstream: Not yet reported upstream; Will do shortly.\n``````\n",
    "created_at": "2020-07-12T17:16:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30122#issuecomment-591993",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,24 @@
+Follow-up from #30106, where the following was observed:
+
+```
+sage: var('ξ')._maxima_()
+....: 
+<repr(<sage.interfaces.maxima_lib.MaximaLibElement at 0x32c1d4828>) failed: RuntimeError: ECL says: Cannot coerce string $_SAGE_VAR_ξ to a base-string>
+```
+The above error is due to a bug in ECL 16.1.2 and 20.4.24:
+
+```
+> (princ-to-string 'ξ)
+"Ξ"
+> (setf local-table (copy-readtable nil))
+> (setf (readtable-case local-table) :invert)
+:INVERT
+> (let ((*readtable* local-table) (*print-case* :upcase)) (princ-to-string 'ξ))
+Cannot coerce string Ξ to a base-string
+```
+The above code is from Maxima's `PRINT-INVERT-CASE` function in commac.lisp.
+
+Upstream issue: https://gitlab.com/embeddable-common-lisp/ecl/-/issues/602
 
 
 Upstream: Not yet reported upstream; Will do shortly.
``````




---

archive/issue_comments_591994.json:
```json
{
    "body": "Changing upstream from \"Reported upstream. No feedback yet.\" to \"Reported upstream. Developers acknowledge bug.\"",
    "created_at": "2020-07-13T15:40:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30122#issuecomment-591994",
    "user": "https://github.com/mkoeppe"
}
```

Changing upstream from "Reported upstream. No feedback yet." to "Reported upstream. Developers acknowledge bug."



---

archive/issue_comments_591995.json:
```json
{
    "body": "Changing upstream from \"Reported upstream. Developers acknowledge bug.\" to \"Fixed upstream, but not in a stable release.\"",
    "created_at": "2020-07-13T16:00:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30122#issuecomment-591995",
    "user": "https://github.com/mkoeppe"
}
```

Changing upstream from "Reported upstream. Developers acknowledge bug." to "Fixed upstream, but not in a stable release."



---

archive/issue_comments_591996.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/fix_maxima_ecl_unicode_handling\"",
    "created_at": "2020-07-13T16:02:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30122#issuecomment-591996",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/fix_maxima_ecl_unicode_handling"



---

archive/issue_comments_591997.json:
```json
{
    "body": "<a id='comment:6'></a>The patches are commits from the ECL `develop` branch. I have cherry-picked them to https://github.com/mkoeppe/ecl/tree/20.4.24%2Bsage\n\n---\nLast 10 new commits:",
    "created_at": "2020-07-13T16:03:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30122#issuecomment-591997",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>The patches are commits from the ECL `develop` branch. I have cherry-picked them to https://github.com/mkoeppe/ecl/tree/20.4.24%2Bsage

---
Last 10 new commits:



---

archive/issue_comments_591998.json:
```json
{
    "body": "Changing commit from \"\" to \"0ca81ec78a214f2699fb372244ab7af23d32fba6\"",
    "created_at": "2020-07-13T16:03:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30122#issuecomment-591998",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "" to "0ca81ec78a214f2699fb372244ab7af23d32fba6"



---

archive/issue_comments_591999.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2020-07-13T16:18:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30122#issuecomment-591999",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_comments_592000.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-07-13T16:18:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30122#issuecomment-592000",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_592001.json:
```json
{
    "body": "<a id='comment:8'></a>\n```\nsage: var('\u03be')._maxima_()\n_SAGE_VAR_\u03be\n```",
    "created_at": "2020-07-13T16:41:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30122#issuecomment-592001",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>
```
sage: var('ξ')._maxima_()
_SAGE_VAR_ξ
```



---

archive/issue_comments_592002.json:
```json
{
    "body": "<a id='comment:9'></a>This is great. As far as I can tell, this works correctly now. We should add a doctest, but otherwise this looks good to me.\n\nSomewhat surprisingly, this also seems to fix the conversion to Giac:\n\n```\nsage: var('\u03b1')._giac_()\nN1     # before\n\u03b1      # after\n```\nbut there is another issue with the Giac interface, for which I have opened #30133.",
    "created_at": "2020-07-13T18:32:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30122#issuecomment-592002",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:9'></a>This is great. As far as I can tell, this works correctly now. We should add a doctest, but otherwise this looks good to me.

Somewhat surprisingly, this also seems to fix the conversion to Giac:

```
sage: var('α')._giac_()
N1     # before
α      # after
```
but there is another issue with the Giac interface, for which I have opened #30133.



---

archive/issue_comments_592003.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Markus Wageringel\"",
    "created_at": "2020-07-13T18:32:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30122#issuecomment-592003",
    "user": "https://github.com/mwageringel"
}
```

Changing reviewer from "" to "Markus Wageringel"



---

archive/issue_comments_592004.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-13T18:37:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30122#issuecomment-592004",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_592005.json:
```json
{
    "body": "Changing commit from \"0ca81ec78a214f2699fb372244ab7af23d32fba6\" to \"da56bb34222684ab6810554aaf90e98ab614f39f\"",
    "created_at": "2020-07-13T18:37:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30122#issuecomment-592005",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "0ca81ec78a214f2699fb372244ab7af23d32fba6" to "da56bb34222684ab6810554aaf90e98ab614f39f"



---

archive/issue_comments_592006.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:9 gh-mwageringel]:\n> Somewhat surprisingly, this also seems to fix the conversion to Giac\n\n\nYes, everything depends on everything in Sage",
    "created_at": "2020-07-13T18:37:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30122#issuecomment-592006",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>Replying to [comment:9 gh-mwageringel]:
> Somewhat surprisingly, this also seems to fix the conversion to Giac


Yes, everything depends on everything in Sage



---

archive/issue_comments_592007.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-13T19:25:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30122#issuecomment-592007",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_592008.json:
```json
{
    "body": "<a id='comment:13'></a>Thanks!",
    "created_at": "2020-07-13T19:39:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30122#issuecomment-592008",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>Thanks!



---

archive/issue_comments_592009.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-25T22:50:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30122#issuecomment-592009",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_077615.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-07-25T22:50:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30122",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30122#event-77615"
}
```



---

archive/issue_comments_592010.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/fix_maxima_ecl_unicode_handling\" to \"da56bb34222684ab6810554aaf90e98ab614f39f\"",
    "created_at": "2020-07-25T22:50:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30122",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30122#issuecomment-592010",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mkoeppe/fix_maxima_ecl_unicode_handling" to "da56bb34222684ab6810554aaf90e98ab614f39f"
