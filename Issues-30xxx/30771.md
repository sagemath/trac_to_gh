# Issue 30771: Repair self-containedness of the wrapped spkg-install scripts for Python packages

archive/issues_030534.json:
```json
{
    "body": "Follow-up from #29500.\n\nWhen an spkg fails to install, Sage advises:\n\n```\n[pynormaliz-2.12] If you want to try to fix the problem yourself, *don't* just cd to\n[pynormaliz-2.12] /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/var/tmp/sage/build/pynormaliz-2.12 and type 'make' or whatever is appropriate.\n[pynormaliz-2.12] Instead, the following commands setup all environment variables\n[pynormaliz-2.12] correctly and load a subshell for you to debug the error:\n[pynormaliz-2.12]   (cd '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/var/tmp/sage/build/pynormaliz-2.12' && '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/sage' --buildsh)\n```\n\nIn the shell set up with this command, one used to be able to just type `./spkg-install` to re-run the (wrapped) installation script.\n\n#29500 inadvertently broke this for Python packages because `sdh_pip_install` now depends on an additional environment variable that is set in `sage-spkg`: `SAGE_SPKG_WHEELS`. This leads to the following error:\n\n```\nSuccessfully installed PyNormaliz-2.12\nRemoved build tracker: '/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-req-tracker-kweqslvi'\nmkdir: : No such file or directory\n********************************************************************************\nError storing dist/PyNormaliz-2.12-cp37-cp37m-macosx_10_9_x86_64.whl\n********************************************************************************\n```\n\nWe fix it by setting this variable in the wrapped `spkg-install` scripts.\n\n\nBlocker for 9.2 because this defect interferes with the debugging of spkg scripts; and because the priority \"critical\" seems to be ignored by the release management scripts.\n\n\nCC:  @kliem @jhpalmieri\n\nBranch/Commit: 3cd351c795a86552354569e203dc849e07e5af1c\n\nReviewer: John Palmieri\n\nAuthor: Matthias Koeppe\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30771\n\n",
    "closed_at": "2020-11-01T00:42:35Z",
    "created_at": "2020-10-15T04:26:33Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Repair self-containedness of the wrapped spkg-install scripts for Python packages",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30771",
    "user": "https://github.com/mkoeppe"
}
```
Follow-up from #29500.

When an spkg fails to install, Sage advises:

```
[pynormaliz-2.12] If you want to try to fix the problem yourself, *don't* just cd to
[pynormaliz-2.12] /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/var/tmp/sage/build/pynormaliz-2.12 and type 'make' or whatever is appropriate.
[pynormaliz-2.12] Instead, the following commands setup all environment variables
[pynormaliz-2.12] correctly and load a subshell for you to debug the error:
[pynormaliz-2.12]   (cd '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/var/tmp/sage/build/pynormaliz-2.12' && '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/sage' --buildsh)
```

In the shell set up with this command, one used to be able to just type `./spkg-install` to re-run the (wrapped) installation script.

#29500 inadvertently broke this for Python packages because `sdh_pip_install` now depends on an additional environment variable that is set in `sage-spkg`: `SAGE_SPKG_WHEELS`. This leads to the following error:

```
Successfully installed PyNormaliz-2.12
Removed build tracker: '/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-req-tracker-kweqslvi'
mkdir: : No such file or directory
********************************************************************************
Error storing dist/PyNormaliz-2.12-cp37-cp37m-macosx_10_9_x86_64.whl
********************************************************************************
```

We fix it by setting this variable in the wrapped `spkg-install` scripts.


Blocker for 9.2 because this defect interferes with the debugging of spkg scripts; and because the priority "critical" seems to be ignored by the release management scripts.


CC:  @kliem @jhpalmieri

Branch/Commit: 3cd351c795a86552354569e203dc849e07e5af1c

Reviewer: John Palmieri

Author: Matthias Koeppe

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/30771





---

archive/issue_comments_609582.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/repair_self_containedness_of_the_wrapped_spkg_install_scripts_for_python_packages\"",
    "created_at": "2020-10-15T04:30:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30771#issuecomment-609582",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/repair_self_containedness_of_the_wrapped_spkg_install_scripts_for_python_packages"



---

archive/issue_comments_609583.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2020-10-15T04:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30771#issuecomment-609583",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_comments_609584.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2020-10-15T04:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30771#issuecomment-609584",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_609585.json:
```json
{
    "body": "Changing commit from \"\" to \"3cd351c795a86552354569e203dc849e07e5af1c\"",
    "created_at": "2020-10-15T04:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30771#issuecomment-609585",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "" to "3cd351c795a86552354569e203dc849e07e5af1c"



---

archive/issue_comments_609586.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-10-15T04:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30771#issuecomment-609586",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_609587.json:
```json
{
    "body": "<a id='comment:3'></a>Can we get this into Sage 9.2 please?",
    "created_at": "2020-10-16T05:24:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30771#issuecomment-609587",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>Can we get this into Sage 9.2 please?



---

archive/issue_comments_609588.json:
```json
{
    "body": "<a id='comment:4'></a>The change seems innocuous, but I'm not sure how to test it.",
    "created_at": "2020-10-16T18:29:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30771#issuecomment-609588",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:4'></a>The change seems innocuous, but I'm not sure how to test it.



---

archive/issue_comments_609589.json:
```json
{
    "body": "<a id='comment:5'></a>Interrupt an installation of a Python package with `^C` (or provoke an error otherwise), then restart the installation as described in the ticket",
    "created_at": "2020-10-16T18:35:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30771#issuecomment-609589",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>Interrupt an installation of a Python package with `^C` (or provoke an error otherwise), then restart the installation as described in the ticket



---

archive/issue_comments_609590.json:
```json
{
    "body": "Changing reviewer from \"\" to \"John Palmieri\"",
    "created_at": "2020-10-16T19:58:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30771#issuecomment-609590",
    "user": "https://github.com/jhpalmieri"
}
```

Changing reviewer from "" to "John Palmieri"



---

archive/issue_comments_609591.json:
```json
{
    "body": "<a id='comment:6'></a>Okay, it works for me. I'm not sure why you wouldn't just try `make PKG`, but I guess for some debugging people might want to run `spkg-install` directly. It doesn't strike me as critical, but whatever.",
    "created_at": "2020-10-16T19:58:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30771#issuecomment-609591",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:6'></a>Okay, it works for me. I'm not sure why you wouldn't just try `make PKG`, but I guess for some debugging people might want to run `spkg-install` directly. It doesn't strike me as critical, but whatever.



---

archive/issue_comments_609592.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-10-16T19:58:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30771#issuecomment-609592",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_609593.json:
```json
{
    "body": "<a id='comment:7'></a>Thanks!",
    "created_at": "2020-10-16T20:08:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30771#issuecomment-609593",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>Thanks!



---

archive/issue_comments_609594.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [jhpalmieri](#comment%3A6):\n> I'm not sure why you wouldn't just try `make PKG`\n\n\nThis unpacks the tarball another time. For debugging, it is useful to make changes to the unpackaged source tree.",
    "created_at": "2020-10-16T20:09:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30771#issuecomment-609594",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>Replying to [jhpalmieri](#comment%3A6):
> I'm not sure why you wouldn't just try `make PKG`


This unpacks the tarball another time. For debugging, it is useful to make changes to the unpackaged source tree.



---

archive/issue_comments_609595.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2020-10-19T17:41:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30771#issuecomment-609595",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_609596.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -26,5 +26,5 @@\n We fix it by setting this variable in the wrapped `spkg-install` scripts.\n \n \n-Critical for 9.2 because this defect interferes with the debugging of spkg scripts.\n+Blocker for 9.2 because this defect interferes with the debugging of spkg scripts; and because the priority \"critical\" seems to be ignored by the release management scripts.\n \n``````\n",
    "created_at": "2020-10-19T17:41:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30771#issuecomment-609596",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -26,5 +26,5 @@
 We fix it by setting this variable in the wrapped `spkg-install` scripts.
 
 
-Critical for 9.2 because this defect interferes with the debugging of spkg scripts.
+Blocker for 9.2 because this defect interferes with the debugging of spkg scripts; and because the priority "critical" seems to be ignored by the release management scripts.
 
``````




---

archive/issue_comments_609597.json:
```json
{
    "body": "<a id='comment:10'></a>Better development experience can't be a blocker",
    "created_at": "2020-10-24T11:08:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30771#issuecomment-609597",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:10'></a>Better development experience can't be a blocker



---

archive/issue_comments_609598.json:
```json
{
    "body": "<a id='comment:11'></a>I don't think this is developers only. I hope that optional packages are also used by non-developers.\n\nFailure to install packages is unfortunately still common and could happen to anyone compiling sage from source. The standard debugging instruction as in the description of this ticket should work and I think such a tiny fix should go into the next master branch.",
    "created_at": "2020-10-24T12:56:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30771#issuecomment-609598",
    "user": "https://github.com/kliem"
}
```

<a id='comment:11'></a>I don't think this is developers only. I hope that optional packages are also used by non-developers.

Failure to install packages is unfortunately still common and could happen to anyone compiling sage from source. The standard debugging instruction as in the description of this ticket should work and I think such a tiny fix should go into the next master branch.



---

archive/issue_events_080228.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30771",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30771#event-80228"
}
```



---

archive/issue_comments_609599.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/repair_self_containedness_of_the_wrapped_spkg_install_scripts_for_python_packages\" to \"3cd351c795a86552354569e203dc849e07e5af1c\"",
    "created_at": "2020-11-01T00:42:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30771#issuecomment-609599",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mkoeppe/repair_self_containedness_of_the_wrapped_spkg_install_scripts_for_python_packages" to "3cd351c795a86552354569e203dc849e07e5af1c"



---

archive/issue_comments_609600.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-11-01T00:42:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30771",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30771#issuecomment-609600",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_080229.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-11-01T00:42:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30771",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30771#event-80229"
}
```
