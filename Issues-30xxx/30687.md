# Issue 30687: "make python3-clean" should always remove local/bin/python3*

archive/issues_030450.json:
```json
{
    "assignees": [],
    "body": "<div id=\"comment:0\"></div>\n\n`make python3-clean` does not remove `$SAGE_LOCAL/bin/python3*` - certainly not if  an external `python3` is used.\n\nWe do the uninstallation in an `spkg-legacy-uninstall` script.\n\n(We also repair the `spkg-legacy-uninstall` mechanism - it was broken in #29096.)\n\nCritical for Sage 9.2 because it will help avoid puzzling incremental build behavior, which could include corruption of the installed system python if that is writable for the user.\n\nCC:  @mkoeppe @orlitzky @jhpalmieri\n\nComponent: **build**\n\nAuthor: **Matthias Koeppe**\n\nBranch/Commit: **[`ad7d2c9`](https://github.com/sagemath/sagetrac-mirror/commit/ad7d2c929bf0a7d083a0734ad66df4b2751bda63)**\n\nReviewer: **John Palmieri**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/30687_\n\n",
    "closed_at": "2020-10-18T08:38:31Z",
    "created_at": "2020-10-01T11:54:01Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20build",
        "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "\"make python3-clean\" should always remove local/bin/python3*",
    "type": "issue",
    "updated_at": "2020-10-18T08:38:31Z",
    "url": "https://github.com/sagemath/sage/issues/30687",
    "user": "https://github.com/dimpase"
}
```
<div id="comment:0"></div>

`make python3-clean` does not remove `$SAGE_LOCAL/bin/python3*` - certainly not if  an external `python3` is used.

We do the uninstallation in an `spkg-legacy-uninstall` script.

(We also repair the `spkg-legacy-uninstall` mechanism - it was broken in #29096.)

Critical for Sage 9.2 because it will help avoid puzzling incremental build behavior, which could include corruption of the installed system python if that is writable for the user.

CC:  @mkoeppe @orlitzky @jhpalmieri

Component: **build**

Author: **Matthias Koeppe**

Branch/Commit: **[`ad7d2c9`](https://github.com/sagemath/sagetrac-mirror/commit/ad7d2c929bf0a7d083a0734ad66df4b2751bda63)**

Reviewer: **John Palmieri**

_Issue created by migration from https://trac.sagemath.org/ticket/30687_





---

archive/issue_events_420008.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-10-01T11:54:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30687#event-420008"
}
```



---

archive/issue_events_420009.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-10-01T11:54:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "0000b0",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30687#event-420009"
}
```



---

archive/issue_events_420010.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-10-01T11:54:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30687#event-420010"
}
```



---

archive/issue_events_420011.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-10-01T11:54:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30687#event-420011"
}
```



---

archive/issue_comments_490126.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nNot really `make python3-clean`, more like `make python3_venv-clean`; see #29708 (\"Fix switching between `--with-system-python3` and `--without-system-python3`\"). I had hoped to fix it via #29386, but this won't be ready for Sage 9.2.\n\nWe can try a hotfix for this issue by adding `build/pkgs/python3/legacy-uninstall`",
    "created_at": "2020-10-01T15:53:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490126",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:1" align="right">comment:1</div>

Not really `make python3-clean`, more like `make python3_venv-clean`; see #29708 ("Fix switching between `--with-system-python3` and `--without-system-python3`"). I had hoped to fix it via #29386, but this won't be ready for Sage 9.2.

We can try a hotfix for this issue by adding `build/pkgs/python3/legacy-uninstall`



---

archive/issue_events_420012.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-01T15:53:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30687#event-420012"
}
```



---

archive/issue_events_420013.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-01T15:53:53Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30687#event-420013"
}
```



---

archive/issue_comments_490127.json:
```json
{
    "body": "Branch: **[u/mkoeppe/_make_python3_clean__should_always_remove_local_lib_python3_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/_make_python3_clean__should_always_remove_local_lib_python3_)**",
    "created_at": "2020-10-01T17:17:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490127",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/_make_python3_clean__should_always_remove_local_lib_python3_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/_make_python3_clean__should_always_remove_local_lib_python3_)**



---

archive/issue_comments_490128.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nHere's an attempt. Untested\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0157c38bcd365310e822cfb63557d8e88bb04507\"><code>0157c38</code></a></td><td><code>build/pkgs/python3/spkg-legacy-uninstall.in: New</code></td></tr></table>\n",
    "created_at": "2020-10-01T17:17:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490128",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:4" align="right">comment:4</div>

Here's an attempt. Untested

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0157c38bcd365310e822cfb63557d8e88bb04507"><code>0157c38</code></a></td><td><code>build/pkgs/python3/spkg-legacy-uninstall.in: New</code></td></tr></table>




---

archive/issue_comments_490129.json:
```json
{
    "body": "Commit: **[`0157c38`](https://github.com/sagemath/sagetrac-mirror/commit/0157c38bcd365310e822cfb63557d8e88bb04507)**",
    "created_at": "2020-10-01T17:17:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490129",
    "user": "https://github.com/mkoeppe"
}
```

Commit: **[`0157c38`](https://github.com/sagemath/sagetrac-mirror/commit/0157c38bcd365310e822cfb63557d8e88bb04507)**



---

archive/issue_comments_490130.json:
```json
{
    "body": "Author: **Matthias Koeppe**",
    "created_at": "2020-10-02T02:09:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490130",
    "user": "https://github.com/mkoeppe"
}
```

Author: **Matthias Koeppe**



---

archive/issue_comments_490131.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\n\"Of course\" the `spkg-legacy-uninstall` mechanism is broken... It is one of the `WRAPPED_SCRIPTS` of `build/bin/sage-spkg`, but `sage_bootstrap.uninstall.legacy_uninstall` tries to execute `spkg-legacy-uninstall` directly out of `SAGE_ROOT/build` with bash...",
    "created_at": "2020-10-02T02:27:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490131",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:6" align="right">comment:6</div>

"Of course" the `spkg-legacy-uninstall` mechanism is broken... It is one of the `WRAPPED_SCRIPTS` of `build/bin/sage-spkg`, but `sage_bootstrap.uninstall.legacy_uninstall` tries to execute `spkg-legacy-uninstall` directly out of `SAGE_ROOT/build` with bash...



---

archive/issue_comments_490132.json:
```json
{
    "body": "Changed commit from **[`0157c38`](https://github.com/sagemath/sagetrac-mirror/commit/0157c38bcd365310e822cfb63557d8e88bb04507)** to **[`ad7d2c9`](https://github.com/sagemath/sagetrac-mirror/commit/ad7d2c929bf0a7d083a0734ad66df4b2751bda63)**",
    "created_at": "2020-10-02T02:44:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490132",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`0157c38`](https://github.com/sagemath/sagetrac-mirror/commit/0157c38bcd365310e822cfb63557d8e88bb04507)** to **[`ad7d2c9`](https://github.com/sagemath/sagetrac-mirror/commit/ad7d2c929bf0a7d083a0734ad66df4b2751bda63)**



---

archive/issue_comments_490133.json:
```json
{
    "body": "<div id=\"comment:7\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e55c0c156b9e5c33ce132f5453dd737dc5812781\"><code>e55c0c1</code></a></td><td><code>build/pkgs/*/spkg-legacy-uninstall: Make executable, add #!, remove .in extension</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0a2f15e4aa04d9b6c2dad95ec57cf2f9593b7044\"><code>0a2f15e</code></a></td><td><code>build/bin/sage-spkg: Do not wrap the spkg-legacy-uninstall script</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ad7d2c929bf0a7d083a0734ad66df4b2751bda63\"><code>ad7d2c9</code></a></td><td><code>build/sage_bootstrap/uninstall.py (legacy_uninstall): Execute spkg-legacy-uninstall script directly, do not go through bash</code></td></tr></table>\n",
    "created_at": "2020-10-02T02:44:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490133",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:7"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e55c0c156b9e5c33ce132f5453dd737dc5812781"><code>e55c0c1</code></a></td><td><code>build/pkgs/*/spkg-legacy-uninstall: Make executable, add #!, remove .in extension</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0a2f15e4aa04d9b6c2dad95ec57cf2f9593b7044"><code>0a2f15e</code></a></td><td><code>build/bin/sage-spkg: Do not wrap the spkg-legacy-uninstall script</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ad7d2c929bf0a7d083a0734ad66df4b2751bda63"><code>ad7d2c9</code></a></td><td><code>build/sage_bootstrap/uninstall.py (legacy_uninstall): Execute spkg-legacy-uninstall script directly, do not go through bash</code></td></tr></table>




---

archive/issue_comments_490134.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,6 @@\n-`make python3-clean` does not remove `$SAGE_LOCAL/lib/python3*` - certainly not if  an external `python3` is used. This is certainly a bug.\n+`make python3-clean` does not remove `$SAGE_LOCAL/lib/python3*` - certainly not if  an external `python3` is used.\n+\n+We do the uninstallation in an `spkg-legacy-uninstall` script.\n+\n+(We also repair the `spkg-legacy-uninstall` mechanism - it was broken in #29096.)\n+\n``````\n",
    "created_at": "2020-10-02T02:48:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490134",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,6 @@
-`make python3-clean` does not remove `$SAGE_LOCAL/lib/python3*` - certainly not if  an external `python3` is used. This is certainly a bug.
+`make python3-clean` does not remove `$SAGE_LOCAL/lib/python3*` - certainly not if  an external `python3` is used.
+
+We do the uninstallation in an `spkg-legacy-uninstall` script.
+
+(We also repair the `spkg-legacy-uninstall` mechanism - it was broken in #29096.)
+
``````




---

archive/issue_events_420014.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-02T02:48:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30687#event-420014"
}
```



---

archive/issue_comments_490135.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nSo the problem with #29096 is that the uninstall script wasn't being run by `sage-spkg`, so the conversion from `SCRIPT.in` to `SCRIPT` didn't do anything useful?\n\nI also don't understand how the use of the `spkg-legacy-uninstall` script compares to its documentation. R and gap, for example, are modern packages. Why do they need legacy uninstall scripts?",
    "created_at": "2020-10-03T19:49:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490135",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:11" align="right">comment:11</div>

So the problem with #29096 is that the uninstall script wasn't being run by `sage-spkg`, so the conversion from `SCRIPT.in` to `SCRIPT` didn't do anything useful?

I also don't understand how the use of the `spkg-legacy-uninstall` script compares to its documentation. R and gap, for example, are modern packages. Why do they need legacy uninstall scripts?



---

archive/issue_comments_490136.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@jhpalmieri](#comment%3A11):\n> So the problem with #29096 is that the uninstall script wasn't being run by `sage-spkg`, so the conversion from `SCRIPT.in` to `SCRIPT` didn't do anything useful?\n\nYes, prior to #29096 there was an inconsistency - the file `build/pkgs/SPKG/spkg-legacy-uninstall` was transformed to the wrapped script (in the temporary build location) but that was never used. Instead, `sage-spkg-uninstall` was directly invoked `spkg-legacy-uninstall`.\n\nI unfortunately overlooked this in #29096 and so the renaming broke `spkg-legacy-uninstall` for all packages - this script was no longer getting invoked for any package.\n\n> I also don't understand how the use of the `spkg-legacy-uninstall` script compares to its usage. R and gap, for example, are modern packages. Why do they need legacy uninstall scripts?\n\nI think it is for cleaning out very old installs in long-lived installation trees. \nGiven that #29096 has not led to obvious error reports, it does not seem to be an important function.",
    "created_at": "2020-10-03T19:57:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490136",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@jhpalmieri](#comment%3A11):
> So the problem with #29096 is that the uninstall script wasn't being run by `sage-spkg`, so the conversion from `SCRIPT.in` to `SCRIPT` didn't do anything useful?

Yes, prior to #29096 there was an inconsistency - the file `build/pkgs/SPKG/spkg-legacy-uninstall` was transformed to the wrapped script (in the temporary build location) but that was never used. Instead, `sage-spkg-uninstall` was directly invoked `spkg-legacy-uninstall`.

I unfortunately overlooked this in #29096 and so the renaming broke `spkg-legacy-uninstall` for all packages - this script was no longer getting invoked for any package.

> I also don't understand how the use of the `spkg-legacy-uninstall` script compares to its usage. R and gap, for example, are modern packages. Why do they need legacy uninstall scripts?

I think it is for cleaning out very old installs in long-lived installation trees. 
Given that #29096 has not led to obvious error reports, it does not seem to be an important function.



---

archive/issue_comments_490137.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nOkay, good. The ticket description says that we should remove `$SAGE_LOCAL/lib/python3*`, but the script removes `$SAGE_LOCAL/bin/python3*`. Which is correct?",
    "created_at": "2020-10-03T20:10:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490137",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:13" align="right">comment:13</div>

Okay, good. The ticket description says that we should remove `$SAGE_LOCAL/lib/python3*`, but the script removes `$SAGE_LOCAL/bin/python3*`. Which is correct?



---

archive/issue_comments_490138.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nNot sure if the original report really meant \"lib\", and I don't think there is any problem with it.  The branch, in any case, takes care of removing the problematic symlinks in \"bin\". I have update ticket summary and description.",
    "created_at": "2020-10-03T20:46:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490138",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:14" align="right">comment:14</div>

Not sure if the original report really meant "lib", and I don't think there is any problem with it.  The branch, in any case, takes care of removing the problematic symlinks in "bin". I have update ticket summary and description.



---

archive/issue_comments_490139.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-`make python3-clean` does not remove `$SAGE_LOCAL/lib/python3*` - certainly not if  an external `python3` is used.\n+`make python3-clean` does not remove `$SAGE_LOCAL/bin/python3*` - certainly not if  an external `python3` is used.\n \n We do the uninstallation in an `spkg-legacy-uninstall` script.\n \n``````\n",
    "created_at": "2020-10-03T20:46:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490139",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-`make python3-clean` does not remove `$SAGE_LOCAL/lib/python3*` - certainly not if  an external `python3` is used.
+`make python3-clean` does not remove `$SAGE_LOCAL/bin/python3*` - certainly not if  an external `python3` is used.
 
 We do the uninstallation in an `spkg-legacy-uninstall` script.
 
``````




---

archive/issue_events_420015.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-03T20:46:43Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "title_is": "\"make python3-clean\" should always remove local/bin/python3*",
    "title_was": "\"make python3-clean\" should always remove local/lib/python3*",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30687#event-420015"
}
```



---

archive/issue_comments_490140.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nThe original report did mean `lib` rather than `bin`. I guess both should be taken care of.",
    "created_at": "2020-10-03T21:34:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490140",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:15" align="right">comment:15</div>

The original report did mean `lib` rather than `bin`. I guess both should be taken care of.



---

archive/issue_comments_490141.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nIf I've built Sage with a system Python 3, I'm not sure what `make python3-clean` should do. Should it really remove all Python site libraries? If it does this, it has to somehow let the build system know to rebuild all of those packages.",
    "created_at": "2020-10-03T21:38:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490141",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:16" align="right">comment:16</div>

If I've built Sage with a system Python 3, I'm not sure what `make python3-clean` should do. Should it really remove all Python site libraries? If it does this, it has to somehow let the build system know to rebuild all of those packages.



---

archive/issue_comments_490142.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@dimpase](#comment%3A15):\n> The original report did mean `lib` rather than `bin`. I guess both should be taken care of.\n\nIf you install `python3` from spkg, then `make clean` already works because it goes through DESTDIR staging.\n\nIf you use system python3 (venv), then nothing is installed in `/usr/lib/python3.8`... except for stuff installed into `site-packages`, which have their own uninstallation procedures.",
    "created_at": "2020-10-03T21:45:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490142",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@dimpase](#comment%3A15):
> The original report did mean `lib` rather than `bin`. I guess both should be taken care of.

If you install `python3` from spkg, then `make clean` already works because it goes through DESTDIR staging.

If you use system python3 (venv), then nothing is installed in `/usr/lib/python3.8`... except for stuff installed into `site-packages`, which have their own uninstallation procedures.



---

archive/issue_comments_490143.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@jhpalmieri](#comment%3A16):\n> If I've built Sage with a system Python 3, I'm not sure what `make python3-clean` should do.\n\nIt should be a no-op because `python3` is not installed.",
    "created_at": "2020-10-03T21:53:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490143",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@jhpalmieri](#comment%3A16):
> If I've built Sage with a system Python 3, I'm not sure what `make python3-clean` should do.

It should be a no-op because `python3` is not installed.



---

archive/issue_comments_490144.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@jhpalmieri](#comment%3A16):\n> Should it really remove all Python site libraries?\n\nNo, the files that are installed there belong to the individual spkgs.",
    "created_at": "2020-10-03T21:54:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490144",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@jhpalmieri](#comment%3A16):
> Should it really remove all Python site libraries?

No, the files that are installed there belong to the individual spkgs.



---

archive/issue_comments_490145.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nRight, I understand that, so Dima, what did you have in mind?",
    "created_at": "2020-10-04T04:52:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490145",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:20" align="right">comment:20</div>

Right, I understand that, so Dima, what did you have in mind?



---

archive/issue_comments_490146.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nwhile these files are installed by individual  packages, they \"belong\" to python. \n\nAlso there should be no difference in what happens to the $SAGE_LOCAL/lib/python3*  whether python3 is installed by Sage or not. Isn't it true that cleaning a  Sage-installed Python leads to removal of  $SAGE_LOCAL/lib/python3* ?",
    "created_at": "2020-10-04T10:21:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490146",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:21" align="right">comment:21</div>

while these files are installed by individual  packages, they "belong" to python. 

Also there should be no difference in what happens to the $SAGE_LOCAL/lib/python3*  whether python3 is installed by Sage or not. Isn't it true that cleaning a  Sage-installed Python leads to removal of  $SAGE_LOCAL/lib/python3* ?



---

archive/issue_comments_490147.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@dimpase](#comment%3A21):\n> Isn't it true that cleaning a  Sage-installed Python leads to removal of  $SAGE_LOCAL/lib/python3* ?\n\nNo.  The files that belong to the package, recorded in `SAGE_LOCAL/var/lib/sage/installed` are removed.  It does not remove the installed site-packages.\n\nWhen you reinstall the python3 spkg, then dependencies cause all python packages to be rebuilt.",
    "created_at": "2020-10-04T15:30:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490147",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@dimpase](#comment%3A21):
> Isn't it true that cleaning a  Sage-installed Python leads to removal of  $SAGE_LOCAL/lib/python3* ?

No.  The files that belong to the package, recorded in `SAGE_LOCAL/var/lib/sage/installed` are removed.  It does not remove the installed site-packages.

When you reinstall the python3 spkg, then dependencies cause all python packages to be rebuilt.



---

archive/issue_comments_490148.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nReplying to [@dimpase](#comment%3A21):\n> while these files are installed by individual  packages, they \"belong\" to python. \n\nI think we need to start from the beginning here. What failure do you observe, with or without the branch on this ticket.",
    "created_at": "2020-10-04T15:32:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490148",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:23" align="right">comment:23</div>

Replying to [@dimpase](#comment%3A21):
> while these files are installed by individual  packages, they "belong" to python. 

I think we need to start from the beginning here. What failure do you observe, with or without the branch on this ticket.



---

archive/issue_comments_490149.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nweird things happen if you switch from one external python3 to another.",
    "created_at": "2020-10-04T16:04:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490149",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:24" align="right">comment:24</div>

weird things happen if you switch from one external python3 to another.



---

archive/issue_comments_490150.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nI think the branch of this ticket addresses this by making `make python3-clean` remove the interpreter symlinks and the `pyvenv.cfg`. Please try",
    "created_at": "2020-10-04T16:10:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490150",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:25" align="right">comment:25</div>

I think the branch of this ticket addresses this by making `make python3-clean` remove the interpreter symlinks and the `pyvenv.cfg`. Please try



---

archive/issue_comments_490151.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nLet's please get this ticket in.",
    "created_at": "2020-10-05T19:47:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490151",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:26" align="right">comment:26</div>

Let's please get this ticket in.



---

archive/issue_comments_490152.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nI don't have any objections to it. Dima?",
    "created_at": "2020-10-05T21:57:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490152",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:27" align="right">comment:27</div>

I don't have any objections to it. Dima?



---

archive/issue_comments_490153.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nA nitpick, but I don't like mass renaming of spkg-legacy-uninstall.in involving adding boilerplate into each of them. Couldn't build/sage_bootstrap/uninstall.py, the only place it is called from, just prepend the `#!` line?",
    "created_at": "2020-10-06T08:21:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490153",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:28" align="right">comment:28</div>

A nitpick, but I don't like mass renaming of spkg-legacy-uninstall.in involving adding boilerplate into each of them. Couldn't build/sage_bootstrap/uninstall.py, the only place it is called from, just prepend the `#!` line?



---

archive/issue_comments_490154.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nReplying to [@dimpase](#comment%3A28):\n> A nitpick, but I don't like mass renaming of spkg-legacy-uninstall.in involving adding boilerplate into each of them. Couldn't build/sage_bootstrap/uninstall.py, the only place it is called from, just prepend the `#!` line?\n\nThis is literally just undoing a change from #29096 which completely broke the use of the `spkg-legacy-uninstall` scripts. Otherwise I would agree with you.",
    "created_at": "2020-10-06T17:08:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490154",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:29" align="right">comment:29</div>

Replying to [@dimpase](#comment%3A28):
> A nitpick, but I don't like mass renaming of spkg-legacy-uninstall.in involving adding boilerplate into each of them. Couldn't build/sage_bootstrap/uninstall.py, the only place it is called from, just prepend the `#!` line?

This is literally just undoing a change from #29096 which completely broke the use of the `spkg-legacy-uninstall` scripts. Otherwise I would agree with you.



---

archive/issue_events_420016.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2020-10-06T17:08:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30687#event-420016"
}
```



---

archive/issue_events_420017.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2020-10-06T17:08:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30687#event-420017"
}
```



---

archive/issue_comments_490155.json:
```json
{
    "body": "Reviewer: **John Palmieri**",
    "created_at": "2020-10-06T17:08:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490155",
    "user": "https://github.com/jhpalmieri"
}
```

Reviewer: **John Palmieri**



---

archive/issue_comments_490156.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nThanks!",
    "created_at": "2020-10-06T17:51:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490156",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:31" align="right">comment:31</div>

Thanks!



---

archive/issue_comments_490157.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,3 +4,4 @@\n \n (We also repair the `spkg-legacy-uninstall` mechanism - it was broken in #29096.)\n \n+Critical for Sage 9.2 because it will help avoid puzzling incremental build behavior.\n``````\n",
    "created_at": "2020-10-06T18:17:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490157",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,3 +4,4 @@
 
 (We also repair the `spkg-legacy-uninstall` mechanism - it was broken in #29096.)
 
+Critical for Sage 9.2 because it will help avoid puzzling incremental build behavior.
``````




---

archive/issue_comments_490158.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,4 +4,4 @@\n \n (We also repair the `spkg-legacy-uninstall` mechanism - it was broken in #29096.)\n \n-Critical for Sage 9.2 because it will help avoid puzzling incremental build behavior.\n+Critical for Sage 9.2 because it will help avoid puzzling incremental build behavior, which could include corruption of the installed system python if that is writable for the user.\n``````\n",
    "created_at": "2020-10-15T04:55:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490158",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,4 +4,4 @@
 
 (We also repair the `spkg-legacy-uninstall` mechanism - it was broken in #29096.)
 
-Critical for Sage 9.2 because it will help avoid puzzling incremental build behavior.
+Critical for Sage 9.2 because it will help avoid puzzling incremental build behavior, which could include corruption of the installed system python if that is writable for the user.
``````




---

archive/issue_events_420018.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-15T04:55:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30687#event-420018"
}
```



---

archive/issue_events_420019.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-15T04:55:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20blocker%20/%201",
    "label_color": "ff0000",
    "label_name": "p: blocker / 1",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30687#event-420019"
}
```



---

archive/issue_events_420020.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-10-18T08:38:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30687#event-420020"
}
```



---

archive/issue_events_420021.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "dc3fc00492fecc6c0b44f0396f106ebee594c44b",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2020-10-18T08:38:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30687#event-420021"
}
```



---

archive/issue_comments_490159.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/_make_python3_clean__should_always_remove_local_lib_python3_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/_make_python3_clean__should_always_remove_local_lib_python3_)** to **[`ad7d2c9`](https://github.com/sagemath/sagetrac-mirror/commit/ad7d2c929bf0a7d083a0734ad66df4b2751bda63)**",
    "created_at": "2020-10-18T08:38:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30687",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30687#issuecomment-490159",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/mkoeppe/_make_python3_clean__should_always_remove_local_lib_python3_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/_make_python3_clean__should_always_remove_local_lib_python3_)** to **[`ad7d2c9`](https://github.com/sagemath/sagetrac-mirror/commit/ad7d2c929bf0a7d083a0734ad66df4b2751bda63)**
