# Issue 30688: Crash when expanding square root of -x

archive/issues_030451.json:
```json
{
    "body": "Before this ticket, this crashes Sage:\n\n```\nsage: assume(x < 0)\nsage: sqrt(-x).expand()\n```\nSee [comment:12](#comment%3A12) for an explanation of the cause.\n\n---\n\nOriginal title and description:\n\n**Some algebraic substitutions may crash Sage**\n\nHistory : see this [sage-release](https://groups.google.com/g/sage-release/c/6RLsvBKi84I/m/2grSEQC1CgAJ) post and the following.\n\nTL;DR: Sage crashes reproducibly on some substitutions:\n\n```\nf = function(\"f\")\nvar(\"k\")\nEq = f(x).diff(x, 2)/f(x) == k\nwith assuming(k > 0):\n    Sp = desolve(Eq, f(x), ivar=x)\nwith assuming(k == 0):\n    Sz = desolve(Eq, f(x), ivar=x)\nwith assuming(k < 0):\n    Sn = desolve(Eq, f(x), ivar=x)\nvar(\"_K1, _K2\")\nwith assuming(k < 0):\n    Sn1 = Sn.subs(sqrt(k) == I*sqrt(abs(k)))\n# Crashes Sage\n```\n\nThis may result from an incorrect backtranslation from Maxima:\n\n```\n$ sage\n... SageMath version 9.2.beta14, Release Date: 2020-09-30\n... Using Python 3.8.6. Type \"help()\" for help.\n...\nsage: var(\"k\")\nk\nsage: assume(k < 0)\nsage: f = function(\"f\")\nsage: Eq = f(x).diff(x, 2)/f(x) == k\nsage: S = desolve(Eq, f(x), ivar=x); S\n_K2*cosh(sqrt(k)*x) + I*_K1*sinh(sqrt(k)*x)\nsage: SS = maxima.subst([sqrt(k) == I*sqrt(-k)], S); SS\n_SAGE_VAR__K2*cos(sqrt(-_SAGE_VAR_k)*_SAGE_VAR_x)-_SAGE_VAR__K1*sin(sqrt(-_SAGE_VAR_k)*_SAGE_VAR_x)\nsage: SS.sage()\n# CRASH:\n------------------------------------------------------------------------\n/usr/local/sage-9/local/lib/python3.8/site-packages/cysignals/signals.cpython-38-x86_64-linux-gnu.so(+0x842b)[0x7fac8352242b]\n# Etc. ad nauseam...\n```\n\nI mark this as `blocker` since it crashes Sage on (relatively) trivial algebraic operations.\n\nInterestingly, I can't reproduce the problem in expression coming from another source:\n\n```\n$ sage\n... SageMath version 9.2.beta14, Release Date: 2020-09-30\n... Using Python 3.8.6. Type \"help()\" for help.\n...\nsage: k = var(\"k\")\nsage: assume(k < 0)\nsage: f = function(\"f\")\nsage: Eq = f(x).diff(x, 2)/f(x) == k\nsage: from sympy import sympify, dsolve\nsage: S = dsolve(*map(sympify, (Eq, f(x)))); S\nEq(f(x), C1*exp(-sqrt(k)*x) + C2*exp(sqrt(k)*x))\nsage: S._sage_()\nf(x) == C2*e^(sqrt(k)*x) + C1*e^(-sqrt(k)*x)\nsage: S.subs({sympify(sqrt(k)): sympify(I*sqrt(-k))})\nEq(f(x), C1*exp(-I*x*sqrt(-k)) + C2*exp(I*x*sqrt(-k)))\nsage: S.subs({sympify(sqrt(k)): sympify(I*sqrt(-k))})._sage_()\nf(x) == C2*e^(I*sqrt(-k)*x) + C1*e^(-I*sqrt(-k)*x)\nsage: S._sage_().subs(sqrt(k) == I*sqrt(-k))\nf(x) == C2*e^(I*sqrt(-k)*x) + C1*e^(-I*sqrt(-k)*x)\n```\n\nSince this problem appears in *compiled* code, I don't (yet) know how to tackle it. Advice welcome...\n\nDepends on #30446\n\n**CC:**  @kcrisman @slel\n\n**Branch:** [20067d34f7d50886b6efe3ba81729a381a4602a8](https://github.com/sagemath/sagetrac-mirror/commit/20067d34f7d50886b6efe3ba81729a381a4602a8)\n\n**Reviewer:** Dima Pasechnik\n\n**Author:** Dave Morris\n\nIssue created by migration from https://trac.sagemath.org/ticket/30688\n\n",
    "closed_at": "2021-03-07T17:06:29Z",
    "created_at": "2020-10-01T16:28:20Z",
    "labels": [
        "component: symbolics",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.3",
    "title": "Crash when expanding square root of -x",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/30688",
    "user": "https://github.com/EmmanuelCharpentier"
}
```
Before this ticket, this crashes Sage:

```
sage: assume(x < 0)
sage: sqrt(-x).expand()
```
See [comment:12](#comment%3A12) for an explanation of the cause.

---

Original title and description:

**Some algebraic substitutions may crash Sage**

History : see this [sage-release](https://groups.google.com/g/sage-release/c/6RLsvBKi84I/m/2grSEQC1CgAJ) post and the following.

TL;DR: Sage crashes reproducibly on some substitutions:

```
f = function("f")
var("k")
Eq = f(x).diff(x, 2)/f(x) == k
with assuming(k > 0):
    Sp = desolve(Eq, f(x), ivar=x)
with assuming(k == 0):
    Sz = desolve(Eq, f(x), ivar=x)
with assuming(k < 0):
    Sn = desolve(Eq, f(x), ivar=x)
var("_K1, _K2")
with assuming(k < 0):
    Sn1 = Sn.subs(sqrt(k) == I*sqrt(abs(k)))
# Crashes Sage
```

This may result from an incorrect backtranslation from Maxima:

```
$ sage
... SageMath version 9.2.beta14, Release Date: 2020-09-30
... Using Python 3.8.6. Type "help()" for help.
...
sage: var("k")
k
sage: assume(k < 0)
sage: f = function("f")
sage: Eq = f(x).diff(x, 2)/f(x) == k
sage: S = desolve(Eq, f(x), ivar=x); S
_K2*cosh(sqrt(k)*x) + I*_K1*sinh(sqrt(k)*x)
sage: SS = maxima.subst([sqrt(k) == I*sqrt(-k)], S); SS
_SAGE_VAR__K2*cos(sqrt(-_SAGE_VAR_k)*_SAGE_VAR_x)-_SAGE_VAR__K1*sin(sqrt(-_SAGE_VAR_k)*_SAGE_VAR_x)
sage: SS.sage()
# CRASH:
------------------------------------------------------------------------
/usr/local/sage-9/local/lib/python3.8/site-packages/cysignals/signals.cpython-38-x86_64-linux-gnu.so(+0x842b)[0x7fac8352242b]
# Etc. ad nauseam...
```

I mark this as `blocker` since it crashes Sage on (relatively) trivial algebraic operations.

Interestingly, I can't reproduce the problem in expression coming from another source:

```
$ sage
... SageMath version 9.2.beta14, Release Date: 2020-09-30
... Using Python 3.8.6. Type "help()" for help.
...
sage: k = var("k")
sage: assume(k < 0)
sage: f = function("f")
sage: Eq = f(x).diff(x, 2)/f(x) == k
sage: from sympy import sympify, dsolve
sage: S = dsolve(*map(sympify, (Eq, f(x)))); S
Eq(f(x), C1*exp(-sqrt(k)*x) + C2*exp(sqrt(k)*x))
sage: S._sage_()
f(x) == C2*e^(sqrt(k)*x) + C1*e^(-sqrt(k)*x)
sage: S.subs({sympify(sqrt(k)): sympify(I*sqrt(-k))})
Eq(f(x), C1*exp(-I*x*sqrt(-k)) + C2*exp(I*x*sqrt(-k)))
sage: S.subs({sympify(sqrt(k)): sympify(I*sqrt(-k))})._sage_()
f(x) == C2*e^(I*sqrt(-k)*x) + C1*e^(-I*sqrt(-k)*x)
sage: S._sage_().subs(sqrt(k) == I*sqrt(-k))
f(x) == C2*e^(I*sqrt(-k)*x) + C1*e^(-I*sqrt(-k)*x)
```

Since this problem appears in *compiled* code, I don't (yet) know how to tackle it. Advice welcome...

Depends on #30446

**CC:**  @kcrisman @slel

**Branch:** [20067d34f7d50886b6efe3ba81729a381a4602a8](https://github.com/sagemath/sagetrac-mirror/commit/20067d34f7d50886b6efe3ba81729a381a4602a8)

**Reviewer:** Dima Pasechnik

**Author:** Dave Morris

Issue created by migration from https://trac.sagemath.org/ticket/30688





---

archive/issue_comments_493021.json:
```json
{
    "body": "<a id='comment:1'></a>\nNot the backtranslation from Maxima (or not only) ; I have the same problem backtranslating from Sympy :\n\n```\ncharpent@zen-book-flip:~$ sage\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.2.beta14, Release Date: 2020-09-30              \u2502\n\u2502 Using Python 3.8.6. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: k=var(\"k\")                                                                \nsage: assume(k<0)                                                               \nsage: f=function(\"f\")                                                           \nsage: Eq=f(x).diff(x,2)/f(x)==k                                                 \nsage: SM=desolve(Eq, f(x), ivar=x)                                              \nsage: SM                                                                        \n_K2*cosh(sqrt(k)*x) + I*_K1*sinh(sqrt(k)*x)\nsage: from sympy import sympify                                                 \nsage: sympify(SM).subs({sympify(sqrt(k)):sympify(I*sqrt(-k))})                  \n-_K1*sin(x*sqrt(-k)) + _K2*cos(x*sqrt(-k))\nsage: sympify(SM).subs({sympify(sqrt(k)):sympify(I*sqrt(-k))})._sage_()         \n# CRASH : \n------------------------------------------------------------------------\n/usr/local/sage-9/local/lib/python3.8/site-packages/cysignals/signals.cpython-38-x86_64-linux-gnu.so(+0x842b)[0x7f5dcdf4e42b]\n```\n\nThis seems to point to `pynac`...",
    "created_at": "2020-10-01T16:57:29Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493021",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:1'></a>
Not the backtranslation from Maxima (or not only) ; I have the same problem backtranslating from Sympy :

```
charpent@zen-book-flip:~$ sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.2.beta14, Release Date: 2020-09-30              │
│ Using Python 3.8.6. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: k=var("k")                                                                
sage: assume(k<0)                                                               
sage: f=function("f")                                                           
sage: Eq=f(x).diff(x,2)/f(x)==k                                                 
sage: SM=desolve(Eq, f(x), ivar=x)                                              
sage: SM                                                                        
_K2*cosh(sqrt(k)*x) + I*_K1*sinh(sqrt(k)*x)
sage: from sympy import sympify                                                 
sage: sympify(SM).subs({sympify(sqrt(k)):sympify(I*sqrt(-k))})                  
-_K1*sin(x*sqrt(-k)) + _K2*cos(x*sqrt(-k))
sage: sympify(SM).subs({sympify(sqrt(k)):sympify(I*sqrt(-k))})._sage_()         
# CRASH : 
------------------------------------------------------------------------
/usr/local/sage-9/local/lib/python3.8/site-packages/cysignals/signals.cpython-38-x86_64-linux-gnu.so(+0x842b)[0x7f5dcdf4e42b]
```

This seems to point to `pynac`...



---

archive/issue_comments_493022.json:
```json
{
    "body": "<a id='comment:2'></a>\n#30378 seems relevant.",
    "created_at": "2020-10-01T17:03:14Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493022",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:2'></a>
#30378 seems relevant.



---

archive/issue_comments_493023.json:
```json
{
    "body": "<a id='comment:3'></a>\nThe error is trigerred by the existence of the assumption about `k`, which might trigger further transformations (which turn out to be toxic in this case).\n\nThis works:\n\n```\nf = function(\"f\")\nvar(\"k\")\nEq = f(x).diff(x, 2)/f(x) == k\nwith assuming(k > 0):\n    Sp = desolve(Eq, f(x), ivar=x)\nwith assuming(k == 0):\n    Sz = desolve(Eq, f(x), ivar=x)\nwith assuming(k < 0):\n    Sn = desolve(Eq, f(x), ivar=x)\nSn1 = Sn.subs(sqrt(k) == I*sqrt(abs(k)))\n```\n\nThis crashes Sage:\n\n```\nassume(k < 0)\nSn2 = Sn.subs(sqrt(k) == I*sqrt(abs(k)))\n```\n\nDitto when using `with assuming...`.",
    "created_at": "2020-10-01T22:50:31Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493023",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:3'></a>
The error is trigerred by the existence of the assumption about `k`, which might trigger further transformations (which turn out to be toxic in this case).

This works:

```
f = function("f")
var("k")
Eq = f(x).diff(x, 2)/f(x) == k
with assuming(k > 0):
    Sp = desolve(Eq, f(x), ivar=x)
with assuming(k == 0):
    Sz = desolve(Eq, f(x), ivar=x)
with assuming(k < 0):
    Sn = desolve(Eq, f(x), ivar=x)
Sn1 = Sn.subs(sqrt(k) == I*sqrt(abs(k)))
```

This crashes Sage:

```
assume(k < 0)
Sn2 = Sn.subs(sqrt(k) == I*sqrt(abs(k)))
```

Ditto when using `with assuming...`.



---

archive/issue_events_274947.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-10-09T13:57:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30688#event-274947"
}
```



---

archive/issue_events_274948.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-10-09T13:57:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30688#event-274948"
}
```



---

archive/issue_comments_493024.json:
```json
{
    "body": "<a id='comment:4'></a>\nGiven that our release is long overdue, and nobody works on the present ticket, I turn it to critical. ANybody proposing a branch in the next few days can of course reconsider this.",
    "created_at": "2020-10-09T13:57:09Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493024",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:4'></a>
Given that our release is long overdue, and nobody works on the present ticket, I turn it to critical. ANybody proposing a branch in the next few days can of course reconsider this.



---

archive/issue_comments_493025.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [chapoton](#comment%3A4):\n> Given that our release is long overdue, and nobody works on the present ticket, I turn it to critical. ANybody proposing a branch in the next few days can of course reconsider this.\n\n\nI'd be delighted to work on this, but the problem resides in *Cythonized library code*, the care and feeding of which I haven't the slightest idea...\n\nDo you have pointers to an introduction to working on Sage library code ?",
    "created_at": "2020-10-09T14:12:58Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493025",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:5'></a>
Replying to [chapoton](#comment%3A4):
> Given that our release is long overdue, and nobody works on the present ticket, I turn it to critical. ANybody proposing a branch in the next few days can of course reconsider this.


I'd be delighted to work on this, but the problem resides in *Cythonized library code*, the care and feeding of which I haven't the slightest idea...

Do you have pointers to an introduction to working on Sage library code ?



---

archive/issue_comments_493026.json:
```json
{
    "body": "<a id='comment:6'></a>\nA very quick check with Cocalc's available kernels (back to 8.2) shows that the following:\n\n```\nfrom __future__ import print_function\nprint(sage.version.version)\nf = function(\"f\")\nvar(\"k\")\nEq = f(x).diff(x, 2)/f(x) == k\nwith assuming(k < 0):\n    Sn = desolve(Eq, f(x), ivar=x)\nvar(\"K1,_K2\")\nwith assuming (k < 0):\n    print(Sn.subs(sqrt(k) == I*sqrt(abs(k))))\n```\n\ncrashed even in 8.2 days...\nremoving the `with assuming (x < 0):` allows it to run.",
    "created_at": "2020-10-09T14:41:00Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493026",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:6'></a>
A very quick check with Cocalc's available kernels (back to 8.2) shows that the following:

```
from __future__ import print_function
print(sage.version.version)
f = function("f")
var("k")
Eq = f(x).diff(x, 2)/f(x) == k
with assuming(k < 0):
    Sn = desolve(Eq, f(x), ivar=x)
var("K1,_K2")
with assuming (k < 0):
    print(Sn.subs(sqrt(k) == I*sqrt(abs(k))))
```

crashed even in 8.2 days...
removing the `with assuming (x < 0):` allows it to run.



---

archive/issue_events_274949.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2020-10-19T07:17:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30688#event-274949"
}
```



---

archive/issue_events_274950.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2020-10-19T07:17:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30688#event-274950"
}
```



---

archive/issue_events_274951.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2020-10-19T07:17:01Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30688#event-274951"
}
```



---

archive/issue_events_274952.json:
```json
{
    "actor": "https://github.com/EmmanuelCharpentier",
    "created_at": "2020-10-19T07:17:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30688#event-274952"
}
```



---

archive/issue_comments_493027.json:
```json
{
    "body": "<a id='comment:7'></a>\nMark as `blocker`, but for 9.3...",
    "created_at": "2020-10-19T07:17:01Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493027",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:7'></a>
Mark as `blocker`, but for 9.3...



---

archive/issue_comments_493028.json:
```json
{
    "body": "<a id='comment:8'></a>\nMight be related to #30446.",
    "created_at": "2021-01-23T18:27:15Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493028",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:8'></a>
Might be related to #30446.



---

archive/issue_events_274953.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-01-26T23:52:14Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "label": "blocker",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30688#event-274953"
}
```



---

archive/issue_events_274954.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-01-26T23:52:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30688#event-274954"
}
```



---

archive/issue_comments_493029.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [gh-mjungmath](#comment%3A8):\n> Might be related to #30446.\n\n\nstill the example from [comment:6](#comment%3A6) with #30446 installed leads to a crash.\n\nIt certainly should not be a blocker, though. There are many other ways to crash Sage, after all.",
    "created_at": "2021-01-26T23:52:14Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493029",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>
Replying to [gh-mjungmath](#comment%3A8):
> Might be related to #30446.


still the example from [comment:6](#comment%3A6) with #30446 installed leads to a crash.

It certainly should not be a blocker, though. There are many other ways to crash Sage, after all.



---

archive/issue_comments_493030.json:
```json
{
    "body": "<a id='comment:10'></a>\nHere is a shorter session that demonstrates the crash:\n\n```\nsage: assume(x < 0)\nsage: sin(sqrt(-x))\n------------------------------------------------------------------------\n(no backtrace available)\n------------------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred.\n    ...\n```\nOn `CoCalc` (v9.2), this hangs, instead of crashing, and the memory meter quickly gets over 1GB. Pynac does seem to be the problem (as suggested in [comment:1](#comment%3A1)), because I got this trace when I interrupted the process:\n\n```\nKernel last terminated by signal SIGINT.\n...\n093e2c1f06]\n/ext/sage/sage-9.2/local/lib/libpynac.so.18(_ZNK5GiNaC5power6expandEj+0x3d8)[0x7f093e38fcb8]\n/ext/sage/sage-9.2/local/lib/libpynac.so.18(_ZNK5GiNaC2ex6expandEj+0x36)[0x7f093e2c1f06]\n/ext/sage/sage-9.2/local/lib/libpynac.so.18(_ZNK5GiNaC5power6expandEj+0x3d8)[0x7f093e38fcb8]\n/ext/sage/sage-9.2/local/lib/libpynac.so.18(_ZNK5GiNaC2ex6expandEj+0x36)[0x7f093e2c1f06]\n    <these two lines repeated many more times, then>\n------------------------------------------------------------------------\nAttaching gdb to process id 7387.\nTraceback (most recent call last):\n  File \"/ext/sage/sage-9.2/local/bin/cysignals-CSI\", line 237, in <module>\n    main(args)\n  File \"/ext/sage/sage-9.2/local/bin/cysignals-CSI\", line 186, in main\n    trace = run_gdb(args.pid, not args.nocolor)\n  File \"/ext/sage/sage-9.2/local/bin/cysignals-CSI\", line 110, in run_gdb\n    stdout, stderr = cmd.communicate(gdb_commands(pid, color))\n  File \"/usr/lib/python3.8/subprocess.py\", line 1024, in communicate\n    stdout, stderr = self._communicate(input, endtime, timeout)\n  File \"/usr/lib/python3.8/subprocess.py\", line 1866, in _communicate\n    ready = selector.select(timeout)\n  File \"/usr/lib/python3.8/selectors.py\", line 415, in select\n    fd_event_list = self._selector.poll(timeout)\nKeyboardInterrupt\n```",
    "created_at": "2021-01-28T01:42:26Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493030",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:10'></a>
Here is a shorter session that demonstrates the crash:

```
sage: assume(x < 0)
sage: sin(sqrt(-x))
------------------------------------------------------------------------
(no backtrace available)
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
    ...
```
On `CoCalc` (v9.2), this hangs, instead of crashing, and the memory meter quickly gets over 1GB. Pynac does seem to be the problem (as suggested in [comment:1](#comment%3A1)), because I got this trace when I interrupted the process:

```
Kernel last terminated by signal SIGINT.
...
093e2c1f06]
/ext/sage/sage-9.2/local/lib/libpynac.so.18(_ZNK5GiNaC5power6expandEj+0x3d8)[0x7f093e38fcb8]
/ext/sage/sage-9.2/local/lib/libpynac.so.18(_ZNK5GiNaC2ex6expandEj+0x36)[0x7f093e2c1f06]
/ext/sage/sage-9.2/local/lib/libpynac.so.18(_ZNK5GiNaC5power6expandEj+0x3d8)[0x7f093e38fcb8]
/ext/sage/sage-9.2/local/lib/libpynac.so.18(_ZNK5GiNaC2ex6expandEj+0x36)[0x7f093e2c1f06]
    <these two lines repeated many more times, then>
------------------------------------------------------------------------
Attaching gdb to process id 7387.
Traceback (most recent call last):
  File "/ext/sage/sage-9.2/local/bin/cysignals-CSI", line 237, in <module>
    main(args)
  File "/ext/sage/sage-9.2/local/bin/cysignals-CSI", line 186, in main
    trace = run_gdb(args.pid, not args.nocolor)
  File "/ext/sage/sage-9.2/local/bin/cysignals-CSI", line 110, in run_gdb
    stdout, stderr = cmd.communicate(gdb_commands(pid, color))
  File "/usr/lib/python3.8/subprocess.py", line 1024, in communicate
    stdout, stderr = self._communicate(input, endtime, timeout)
  File "/usr/lib/python3.8/subprocess.py", line 1866, in _communicate
    ready = selector.select(timeout)
  File "/usr/lib/python3.8/selectors.py", line 415, in select
    fd_event_list = self._selector.poll(timeout)
KeyboardInterrupt
```



---

archive/issue_comments_493031.json:
```json
{
    "body": "<a id='comment:11'></a>\nI think the problem is even worse than it appeared.\n\n```\nsage: assume(x < 0)                                                                    \nsage: ((-x)^(1/2)).expand()                                                            \n---------------------------------------------------------------------------\nSignalError                               Traceback (most recent call last)\n<ipython-input-2-1d555cbb3a07> in <module>\n----> 1 ((-x)**(Integer(2)/Integer(3))).expand()\n\n~/development/sage-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.expand (build/cythonized/sage/symbolic/expression.cpp:30019)()\n   4820 \n   4821         cdef GEx x\n-> 4822         sig_on()\n   4823         try:\n   4824             x = self._gobj.expand(0)\n\nSignalError: Segmentation fault\n```\nI think you can replace `1/2` with `2/3` or `3/5` or pretty much any other non-integer fraction, and still get a segfault.",
    "created_at": "2021-01-30T04:47:07Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493031",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:11'></a>
I think the problem is even worse than it appeared.

```
sage: assume(x < 0)                                                                    
sage: ((-x)^(1/2)).expand()                                                            
---------------------------------------------------------------------------
SignalError                               Traceback (most recent call last)
<ipython-input-2-1d555cbb3a07> in <module>
----> 1 ((-x)**(Integer(2)/Integer(3))).expand()

~/development/sage-9.2/local/lib/python3.7/site-packages/sage/symbolic/expression.pyx in sage.symbolic.expression.Expression.expand (build/cythonized/sage/symbolic/expression.cpp:30019)()
   4820 
   4821         cdef GEx x
-> 4822         sig_on()
   4823         try:
   4824             x = self._gobj.expand(0)

SignalError: Segmentation fault
```
I think you can replace `1/2` with `2/3` or `3/5` or pretty much any other non-integer fraction, and still get a segfault.



---

archive/issue_comments_493032.json:
```json
{
    "body": "<a id='comment:12'></a>\nI think I found the bug. The definition of the `power::expand` method in ginac's `power.cpp` file includes the following snippet:\n\n```\n// search for positive/negative factors\n                for (const auto & elem : m.seq) {\n\tconst ex& e = m.recombine_pair_to_ex(elem);\n\tif (e.is_positive())\n\t\tprodseq.push_back(pow(e, exponent).expand(options));\n\telse if (e.info(info_flags::negative)) {\n\t\tprodseq.push_back(pow(-e, exponent).expand(options));\n\t\tpossign = !possign;\n\t} else\n\t\tpowseq.push_back(elem);\n}\n```\nThis is part of the code that calculates the expansion of a power of a product: `(a1 * a2 * ... * an)^c`, when `c` is not an integer. The `else if` clause says that if some factor `ai` is negative, then we first need to calculate the expansion of `(-ai)^c`. However, suppose `n = 2` and `a1 =  -1`. Then this says that before we calculate `(-a2)^c`, we need to calculate `(-a2)^c`. This is an infinite loop. \n\nI think it will be easy to fix. I can't do it right now, but I should have time to write a patch in the next couple of days.",
    "created_at": "2021-01-30T09:38:22Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493032",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:12'></a>
I think I found the bug. The definition of the `power::expand` method in ginac's `power.cpp` file includes the following snippet:

```
// search for positive/negative factors
                for (const auto & elem : m.seq) {
	const ex& e = m.recombine_pair_to_ex(elem);
	if (e.is_positive())
		prodseq.push_back(pow(e, exponent).expand(options));
	else if (e.info(info_flags::negative)) {
		prodseq.push_back(pow(-e, exponent).expand(options));
		possign = !possign;
	} else
		powseq.push_back(elem);
}
```
This is part of the code that calculates the expansion of a power of a product: `(a1 * a2 * ... * an)^c`, when `c` is not an integer. The `else if` clause says that if some factor `ai` is negative, then we first need to calculate the expansion of `(-ai)^c`. However, suppose `n = 2` and `a1 =  -1`. Then this says that before we calculate `(-a2)^c`, we need to calculate `(-a2)^c`. This is an infinite loop. 

I think it will be easy to fix. I can't do it right now, but I should have time to write a patch in the next couple of days.



---

archive/issue_comments_493033.json:
```json
{
    "body": "<a id='comment:13'></a>\nThanks for working on this. As you know, pynac is based on an old fork of ginac - so the question is also whether this bug was fixed upstream.",
    "created_at": "2021-01-30T11:43:03Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493033",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:13'></a>
Thanks for working on this. As you know, pynac is based on an old fork of ginac - so the question is also whether this bug was fixed upstream.



---

archive/issue_comments_493034.json:
```json
{
    "body": "<a id='comment:14'></a>\nThis is what one has in Ginac upstream: https://ginac.de/reference/power_8cpp_source.html\n\n```c++\n        // search for positive/negative factors\n         for (auto & cit : m.seq) {\n             ex e=m.recombine_pair_to_ex(cit);\n             if (e.info(info_flags::positive))\n                 prodseq.push_back(pow(e, exponent).expand(options));\n             else if (e.info(info_flags::negative)) {\n                 prodseq.push_back(pow(-e, exponent).expand(options));\n                 possign = !possign;\n             } else\n                 powseq.push_back(cit);\n         }\n```\nLooks like it's still basically the same, but I'm not 100% sure.",
    "created_at": "2021-01-30T11:49:33Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493034",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:14'></a>
This is what one has in Ginac upstream: https://ginac.de/reference/power_8cpp_source.html

```c++
        // search for positive/negative factors
         for (auto & cit : m.seq) {
             ex e=m.recombine_pair_to_ex(cit);
             if (e.info(info_flags::positive))
                 prodseq.push_back(pow(e, exponent).expand(options));
             else if (e.info(info_flags::negative)) {
                 prodseq.push_back(pow(-e, exponent).expand(options));
                 possign = !possign;
             } else
                 powseq.push_back(cit);
         }
```
Looks like it's still basically the same, but I'm not 100% sure.



---

archive/issue_comments_493035.json:
```json
{
    "body": "<a id='comment:15'></a>\nI don't know c++ or ginac, but I don't see any meaningful difference, so I don't think the ginac upstream fixed this.\n\nPatching pynac to comment out the `else if` clause does eliminate the errors, so I am confident that this is indeed the bug we were looking for. However, it might be better to fix this `else if` clause, instead of just removing it. For example, with the clause removed, we have\n\n```\nsage: var(\"a b\");\nsage: assume(a < 0)\nsage: assume(b < 0)\nsage: sqrt(a*b).expand()\nsqrt(a*b)\n```\nIf we fix the clause, then I think the output would instead be `sqrt(-a) * sqrt(-b)`. I don't know whether that's really an improvement, but I think it's what the developers of ginac and pynac intended.\n\nI will think about how to do that, but it's great if someone who knows something about ginac (and/or c++) wants to chime in.",
    "created_at": "2021-01-30T20:38:37Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493035",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:15'></a>
I don't know c++ or ginac, but I don't see any meaningful difference, so I don't think the ginac upstream fixed this.

Patching pynac to comment out the `else if` clause does eliminate the errors, so I am confident that this is indeed the bug we were looking for. However, it might be better to fix this `else if` clause, instead of just removing it. For example, with the clause removed, we have

```
sage: var("a b");
sage: assume(a < 0)
sage: assume(b < 0)
sage: sqrt(a*b).expand()
sqrt(a*b)
```
If we fix the clause, then I think the output would instead be `sqrt(-a) * sqrt(-b)`. I don't know whether that's really an improvement, but I think it's what the developers of ginac and pynac intended.

I will think about how to do that, but it's great if someone who knows something about ginac (and/or c++) wants to chime in.



---

archive/issue_comments_493036.json:
```json
{
    "body": "**Branch:** [public/30688](https://github.com/sagemath/sagetrac-mirror/tree/public/30688)",
    "created_at": "2021-01-30T20:46:38Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493036",
    "user": "https://github.com/DaveWitteMorris"
}
```

**Branch:** [public/30688](https://github.com/sagemath/sagetrac-mirror/tree/public/30688)



---

archive/issue_events_274955.json:
```json
{
    "actor": "https://github.com/DaveWitteMorris",
    "created_at": "2021-01-30T20:57:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30688#event-274955"
}
```



---

archive/issue_comments_493037.json:
```json
{
    "body": "<a id='comment:17'></a>\nSetting to \"needs review\" to ask the patchbots whether they think that deleting the `else if` clause is a viable option (and to encourage comments from human reviewers).\n\ndimpase already knows this, but for others who are following the thread: As pointed out by mkoeppe in [#30446 comment:17](https://github.com/sagemath/sage/issues/30446#comment:17), we will actually need a new pynac tarball, not just a patch, when we have decided how to fix this. But I think a patch is good enough for now.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/050b28e8911e5a440a4d91caf4da641b824154ac\">050b28e</a></td><td><code>trac 30688 patch infinite loop in pynac</code></td></tr></table>\n",
    "created_at": "2021-01-30T20:57:02Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493037",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:17'></a>
Setting to "needs review" to ask the patchbots whether they think that deleting the `else if` clause is a viable option (and to encourage comments from human reviewers).

dimpase already knows this, but for others who are following the thread: As pointed out by mkoeppe in [#30446 comment:17](https://github.com/sagemath/sage/issues/30446#comment:17), we will actually need a new pynac tarball, not just a patch, when we have decided how to fix this. But I think a patch is good enough for now.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/050b28e8911e5a440a4d91caf4da641b824154ac">050b28e</a></td><td><code>trac 30688 patch infinite loop in pynac</code></td></tr></table>




---

archive/issue_comments_493038.json:
```json
{
    "body": "**Commit:** [050b28e8911e5a440a4d91caf4da641b824154ac](https://github.com/sagemath/sagetrac-mirror/commit/050b28e8911e5a440a4d91caf4da641b824154ac)",
    "created_at": "2021-01-30T20:57:02Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493038",
    "user": "https://github.com/DaveWitteMorris"
}
```

**Commit:** [050b28e8911e5a440a4d91caf4da641b824154ac](https://github.com/sagemath/sagetrac-mirror/commit/050b28e8911e5a440a4d91caf4da641b824154ac)



---

archive/issue_comments_493039.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [gh-DaveWitteMorris](#comment%3A15):\n> I don't know c++ or ginac, but I don't see any meaningful difference, so I don't think the ginac upstream fixed this.\n\n\nThere is a difference in the type of `e` - in the new version it is `ex`, in the old one it is a reference (a kind of smart pointer) of type `ex`.\n\nThe way I read this code is that it is forming the product in `prodseq`, which is a stack, into which you push by calling its `push_back()` member function (if you an get the sign, at all).\n\nThen, after the end of this loop, ~10 lines later, `prodseq` is checked for being non-empty, and the terms\nare extracted from it.\n\n```c++\n\t// If positive/negative factors are found, then extract them.\n\t// In either case we set a flag to avoid the second run on a part\n\t// which does not have positive/negative terms.\nif (!prodseq.empty()) {\n\tex newbasis = coef*mul(powseq);\n\tex_to<basic>(newbasis).setflag(status_flags::purely_indefinite);\n\treturn ((new mul(prodseq))->setflag(status_flags::dynallocated)*(new power(newbasis, exponent))->setflag(status_flags::dynallocated).expand(options)).expand(options);\n} \nex_to<basic>(basis).setflag(status_flags::purely_indefinite);\n```\n\nI don't see where an infinite loop you talk about in [comment:12](#comment%3A12) occurs.\nPerhaps the bug is actually in that dreadfully long `return` statement.\nThis bit in https://ginac.de/reference/power_8cpp_source.html is much less\ncrazy.",
    "created_at": "2021-01-30T22:15:58Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493039",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:18'></a>
Replying to [gh-DaveWitteMorris](#comment%3A15):
> I don't know c++ or ginac, but I don't see any meaningful difference, so I don't think the ginac upstream fixed this.


There is a difference in the type of `e` - in the new version it is `ex`, in the old one it is a reference (a kind of smart pointer) of type `ex`.

The way I read this code is that it is forming the product in `prodseq`, which is a stack, into which you push by calling its `push_back()` member function (if you an get the sign, at all).

Then, after the end of this loop, ~10 lines later, `prodseq` is checked for being non-empty, and the terms
are extracted from it.

```c++
	// If positive/negative factors are found, then extract them.
	// In either case we set a flag to avoid the second run on a part
	// which does not have positive/negative terms.
if (!prodseq.empty()) {
	ex newbasis = coef*mul(powseq);
	ex_to<basic>(newbasis).setflag(status_flags::purely_indefinite);
	return ((new mul(prodseq))->setflag(status_flags::dynallocated)*(new power(newbasis, exponent))->setflag(status_flags::dynallocated).expand(options)).expand(options);
} 
ex_to<basic>(basis).setflag(status_flags::purely_indefinite);
```

I don't see where an infinite loop you talk about in [comment:12](#comment%3A12) occurs.
Perhaps the bug is actually in that dreadfully long `return` statement.
This bit in https://ginac.de/reference/power_8cpp_source.html is much less
crazy.



---

archive/issue_comments_493040.json:
```json
{
    "body": "<a id='comment:19'></a>\nOK, I understand now - indeed, [comment:12](#comment%3A12) says that there is a recursion happening in this loop for negative terms. \n\nWhat I don't understand is why only negative terms are a problem.\n\nProbably one needs to rewrite this part modelling on `expand_mul()` in the same file.",
    "created_at": "2021-01-31T01:46:41Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493040",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:19'></a>
OK, I understand now - indeed, [comment:12](#comment%3A12) says that there is a recursion happening in this loop for negative terms. 

What I don't understand is why only negative terms are a problem.

Probably one needs to rewrite this part modelling on `expand_mul()` in the same file.



---

archive/issue_comments_493041.json:
```json
{
    "body": "<a id='comment:20'></a>\nOpened https://github.com/pynac/pynac/issues/368 - hopefully people knowing GiNaC code can comment.",
    "created_at": "2021-01-31T13:15:59Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493041",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:20'></a>
Opened https://github.com/pynac/pynac/issues/368 - hopefully people knowing GiNaC code can comment.



---

archive/issue_comments_493042.json:
```json
{
    "body": "<a id='comment:21'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6ea4bc6074b7fd5606277aee7c140d786fc4b75d\">6ea4bc6</a></td><td><code>doctests and minor edits</code></td></tr></table>\n",
    "created_at": "2021-02-01T19:47:34Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493042",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6ea4bc6074b7fd5606277aee7c140d786fc4b75d">6ea4bc6</a></td><td><code>doctests and minor edits</code></td></tr></table>




---

archive/issue_comments_493043.json:
```json
{
    "body": "**Changing commit** from \"[050b28e8911e5a440a4d91caf4da641b824154ac](https://github.com/sagemath/sagetrac-mirror/commit/050b28e8911e5a440a4d91caf4da641b824154ac)\" to \"[6ea4bc6074b7fd5606277aee7c140d786fc4b75d](https://github.com/sagemath/sagetrac-mirror/commit/6ea4bc6074b7fd5606277aee7c140d786fc4b75d)\".",
    "created_at": "2021-02-01T19:47:34Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493043",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[050b28e8911e5a440a4d91caf4da641b824154ac](https://github.com/sagemath/sagetrac-mirror/commit/050b28e8911e5a440a4d91caf4da641b824154ac)" to "[6ea4bc6074b7fd5606277aee7c140d786fc4b75d](https://github.com/sagemath/sagetrac-mirror/commit/6ea4bc6074b7fd5606277aee7c140d786fc4b75d)".



---

archive/issue_events_274956.json:
```json
{
    "actor": "https://github.com/DaveWitteMorris",
    "created_at": "2021-02-01T19:57:01Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "rename": {
        "from": "Some algebraic substitutions may crash Sage",
        "to": "Crash when expanding square root of -x"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30688#event-274956"
}
```



---

archive/issue_comments_493044.json:
```json
{
    "body": "<a id='comment:22'></a>\nI suggest we close this critical ticket by applying my patch that comments out the `else if` clause. A follow up ticket can discuss a better way to handle factors that are negative, but that ticket would have minor priority.\n\nI don't know anything about packaging and making tarballs. @dimpase, would that be easy for you to do? (Or perhaps add it to the tarball in #30446?) I could probably figure out how to post a PR to https://github.com/pynac/pynac, if that would be helpful.\n\nI downloaded vanilla ginac and did some testing in C++. I was unable to get an infinite loop. It may be there, but it is definitely harder to access there than in sage. For example, vanilla ginac does not provide a straightforward way to declare a variable to be negative. (Of course, my lack of expertise is also an issue.)\n\n\\\\\n> What I don't understand is why only negative terms are a problem.\n\n\nThe expression `e` (or what I called `ai`) is only one term, so it is definitely shorter than the entire product, so the recursive call `pow(e, exponent).expand(options)` is safe. That is why positive terms do not give an infinite loop. The problem with negative terms is that they call `pow(-e, exponent).expand(options)`. But `-e` (in other words, `-1 * e`) might be the entire product, in which case this is an infinite loop.",
    "created_at": "2021-02-01T19:57:01Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493044",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:22'></a>
I suggest we close this critical ticket by applying my patch that comments out the `else if` clause. A follow up ticket can discuss a better way to handle factors that are negative, but that ticket would have minor priority.

I don't know anything about packaging and making tarballs. @dimpase, would that be easy for you to do? (Or perhaps add it to the tarball in #30446?) I could probably figure out how to post a PR to https://github.com/pynac/pynac, if that would be helpful.

I downloaded vanilla ginac and did some testing in C++. I was unable to get an infinite loop. It may be there, but it is definitely harder to access there than in sage. For example, vanilla ginac does not provide a straightforward way to declare a variable to be negative. (Of course, my lack of expertise is also an issue.)

\\
> What I don't understand is why only negative terms are a problem.


The expression `e` (or what I called `ai`) is only one term, so it is definitely shorter than the entire product, so the recursive call `pow(e, exponent).expand(options)` is safe. That is why positive terms do not give an infinite loop. The problem with negative terms is that they call `pow(-e, exponent).expand(options)`. But `-e` (in other words, `-1 * e`) might be the entire product, in which case this is an infinite loop.



---

archive/issue_comments_493045.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,18 @@\n+\n+This crashes sage:\n+\n+```\n+sage: assume(x < 0)\n+sage: sqrt(-x).expand()\n+```\n+See [comment:12](#comment%3A12) for an explanation of the cause.\n+\n+---\n+\n+Original title and description:\n+\n+**Some algebraic substitutions may crash Sage**\n+\n History : see this [sage-release](https://groups.google.com/g/sage-release/c/6RLsvBKi84I/m/2grSEQC1CgAJ) post and the following.\n \n TL; DR : Sage crashes reproducibly on some substitutions :\n``````\n",
    "created_at": "2021-02-01T19:57:01Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493045",
    "user": "https://github.com/DaveWitteMorris"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,18 @@
+
+This crashes sage:
+
+```
+sage: assume(x < 0)
+sage: sqrt(-x).expand()
+```
+See [comment:12](#comment%3A12) for an explanation of the cause.
+
+---
+
+Original title and description:
+
+**Some algebraic substitutions may crash Sage**
+
 History : see this [sage-release](https://groups.google.com/g/sage-release/c/6RLsvBKi84I/m/2grSEQC1CgAJ) post and the following.
 
 TL; DR : Sage crashes reproducibly on some substitutions :
``````




---

archive/issue_comments_493046.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [gh-DaveWitteMorris](#comment%3A22):\n> I suggest we close this critical ticket by applying my patch that comments out the `else if` clause. A follow up ticket can discuss a better way to handle factors that are negative, but that ticket would have minor priority.\n\n\n\nCommenting out the whole `else if` codebranch would result in some expressions being left\nunexpanded, no?\n \n> \n> I don't know anything about packaging and making tarballs. @dimpase, would that be easy for you to do? (Or perhaps add it to the tarball in #30446?) I could probably figure out how to post a PR to https://github.com/pynac/pynac, if that would be helpful.\n> \n\n\nwe can just do a package patch, no need to make a new tarball.\nAnd this patch is just the output of `git diff` in the right repo,\nstored as `build/pkgs/pynac/patches/<name>.patch`\n\n\n> I downloaded vanilla ginac and did some testing in C++. I was unable to get an infinite loop. It may be there, but it is definitely harder to access there than in sage. For example, vanilla ginac does not provide a straightforward way to declare a variable to be negative. (Of course, my lack of expertise is also an issue.)\n\n\nCould you put your try somewhere on the github?\nIt'd save me time to try to get a better test case.\n\n> \n> \\\\\n> > What I don't understand is why only negative terms are a problem.\n\n> \n> The expression `e` (or what I called `ai`) is only one term, so it is definitely shorter than the entire product, so the recursive call `pow(e, exponent).expand(options)` is safe. That is why positive terms do not give an infinite loop. The problem with negative terms is that they call `pow(-e, exponent).expand(options)`. But `-e` (in other words, `-1 * e`) might be the entire product, in which case this is an infinite loop.\n\n\nyes, this looks to be the case. A proper way to fix this might be to get the\nexpression \"length\" in this case and if it is 2, tag it as \"expanded\".\n(Doing this in C++ is a bit of work - mostly to understand the API)",
    "created_at": "2021-02-01T20:14:04Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493046",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:23'></a>
Replying to [gh-DaveWitteMorris](#comment%3A22):
> I suggest we close this critical ticket by applying my patch that comments out the `else if` clause. A follow up ticket can discuss a better way to handle factors that are negative, but that ticket would have minor priority.



Commenting out the whole `else if` codebranch would result in some expressions being left
unexpanded, no?
 
> 
> I don't know anything about packaging and making tarballs. @dimpase, would that be easy for you to do? (Or perhaps add it to the tarball in #30446?) I could probably figure out how to post a PR to https://github.com/pynac/pynac, if that would be helpful.
> 


we can just do a package patch, no need to make a new tarball.
And this patch is just the output of `git diff` in the right repo,
stored as `build/pkgs/pynac/patches/<name>.patch`


> I downloaded vanilla ginac and did some testing in C++. I was unable to get an infinite loop. It may be there, but it is definitely harder to access there than in sage. For example, vanilla ginac does not provide a straightforward way to declare a variable to be negative. (Of course, my lack of expertise is also an issue.)


Could you put your try somewhere on the github?
It'd save me time to try to get a better test case.

> 
> \\
> > What I don't understand is why only negative terms are a problem.

> 
> The expression `e` (or what I called `ai`) is only one term, so it is definitely shorter than the entire product, so the recursive call `pow(e, exponent).expand(options)` is safe. That is why positive terms do not give an infinite loop. The problem with negative terms is that they call `pow(-e, exponent).expand(options)`. But `-e` (in other words, `-1 * e`) might be the entire product, in which case this is an infinite loop.


yes, this looks to be the case. A proper way to fix this might be to get the
expression "length" in this case and if it is 2, tag it as "expanded".
(Doing this in C++ is a bit of work - mostly to understand the API)



---

archive/issue_comments_493047.json:
```json
{
    "body": "<a id='comment:24'></a>\nI think that almost every calculation that uses the `else if` clause gives a crash now. Since there haven't been any complaints until recently, it must be very uncommon. (Further evidence is that the patch doesn't give any doctest failures on my computer with `sage -t -l -p 2 --optional=sage --all`.) This is really a corner case that has little or no impact, so I think that deleting the clause is the right thing to do for this ticket. It actually would not mean that the expressions would not be expanded, just that they would not be expanded in this particular way: I think `sqrt(A*B)` would sometimes be expanded as `sqrt((A*B).expand())`, instead of `sqrt((-A).expand()) * sqrt((-B).expand())`. However, as I said, I think this \"improved\" expansion has rarely been applied to a negative factor.\n\nDo I need to do something to get the patchbots to test this PR? I edited `build/pkgs/pynac/package-version.txt` in this latest PR, hoping that it would help.",
    "created_at": "2021-02-01T20:47:55Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493047",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:24'></a>
I think that almost every calculation that uses the `else if` clause gives a crash now. Since there haven't been any complaints until recently, it must be very uncommon. (Further evidence is that the patch doesn't give any doctest failures on my computer with `sage -t -l -p 2 --optional=sage --all`.) This is really a corner case that has little or no impact, so I think that deleting the clause is the right thing to do for this ticket. It actually would not mean that the expressions would not be expanded, just that they would not be expanded in this particular way: I think `sqrt(A*B)` would sometimes be expanded as `sqrt((A*B).expand())`, instead of `sqrt((-A).expand()) * sqrt((-B).expand())`. However, as I said, I think this "improved" expansion has rarely been applied to a negative factor.

Do I need to do something to get the patchbots to test this PR? I edited `build/pkgs/pynac/package-version.txt` in this latest PR, hoping that it would help.



---

archive/issue_comments_493048.json:
```json
{
    "body": "<a id='comment:25'></a>\nI tried lots of things, but here is the best one that I could come up with by using my almost nonexistent understanding of ginac and c++:\n\n```\n#include <iostream>\n#include <ginac/ginac.h>\nusing namespace std;\nusing namespace GiNaC;\n\nclass negsymbol : public symbol { \n    public:\n    bool info(unsigned inf) const\n    {\n        if (inf == info_flags::negative) {\n            return 1;}\n        return inherited::info(inf);\n    }\n};\n\nint main()\n{\n    realsymbol x(\"x\");\n    negsymbol y;\n    numeric r(3,5);    \n    cout << pow(x * y, r).expand() << endl;\n    cout << y.info(info_flags::negative) << endl;\n    cout << tree << x * y ;\n}\n```\nAfter a warning message from `-Wundefined-var-template`, the output is\n\n```\n(x*symbol3)^(3/5)\n1\nmul @0x7fa050c091e0, hash=0x7ece0009, flags=0x3, nops=2\n    x (symbol) @0x7fa050c09190, serial=2, hash=0x4d1fe6f1, flags=0xf, domain=1\n    1 (numeric) @0x7fa050c06410, hash=0x160af41d, flags=0xf\n    -----\n     (symbol) @0x7fa050c090b0, serial=3, hash=0x7ecebd84, flags=0xf, domain=0\n    1 (numeric) @0x7fa050c06410, hash=0x160af41d, flags=0xf\n    =====\n```\nI think the `else if` clause is not triggered, because `y` is stored as `y^1` in the product, and ginac does not know that `y^1` is negative (even though `y` is negative). I do not know how to get ginac to realize that `y^1` is negative.\n\nIf I change `negsymbol y` to `possymbol y`, then the output is\n\n```\nsymbol3^(3/5)*x^(3/5)\n0\nmul @0x7fd3add07800, hash=0x693c001c, flags=0x3, nops=2\n     (symbol) @0x7fd3add076d0, serial=3, hash=0x693c85bf, flags=0xf, domain=2\n    1 (numeric) @0x7fd3add04a30, hash=0x160af41d, flags=0xf\n    -----\n    x (symbol) @0x7fd3add077b0, serial=2, hash=0x76bbb6f1, flags=0xf, domain=1\n    1 (numeric) @0x7fd3add04a30, hash=0x160af41d, flags=0xf\n    =====\n```\nThis means that the `if` clause was triggered, as it should be.",
    "created_at": "2021-02-01T20:53:50Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493048",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:25'></a>
I tried lots of things, but here is the best one that I could come up with by using my almost nonexistent understanding of ginac and c++:

```
#include <iostream>
#include <ginac/ginac.h>
using namespace std;
using namespace GiNaC;

class negsymbol : public symbol { 
    public:
    bool info(unsigned inf) const
    {
        if (inf == info_flags::negative) {
            return 1;}
        return inherited::info(inf);
    }
};

int main()
{
    realsymbol x("x");
    negsymbol y;
    numeric r(3,5);    
    cout << pow(x * y, r).expand() << endl;
    cout << y.info(info_flags::negative) << endl;
    cout << tree << x * y ;
}
```
After a warning message from `-Wundefined-var-template`, the output is

```
(x*symbol3)^(3/5)
1
mul @0x7fa050c091e0, hash=0x7ece0009, flags=0x3, nops=2
    x (symbol) @0x7fa050c09190, serial=2, hash=0x4d1fe6f1, flags=0xf, domain=1
    1 (numeric) @0x7fa050c06410, hash=0x160af41d, flags=0xf
    -----
     (symbol) @0x7fa050c090b0, serial=3, hash=0x7ecebd84, flags=0xf, domain=0
    1 (numeric) @0x7fa050c06410, hash=0x160af41d, flags=0xf
    =====
```
I think the `else if` clause is not triggered, because `y` is stored as `y^1` in the product, and ginac does not know that `y^1` is negative (even though `y` is negative). I do not know how to get ginac to realize that `y^1` is negative.

If I change `negsymbol y` to `possymbol y`, then the output is

```
symbol3^(3/5)*x^(3/5)
0
mul @0x7fd3add07800, hash=0x693c001c, flags=0x3, nops=2
     (symbol) @0x7fd3add076d0, serial=3, hash=0x693c85bf, flags=0xf, domain=2
    1 (numeric) @0x7fd3add04a30, hash=0x160af41d, flags=0xf
    -----
    x (symbol) @0x7fd3add077b0, serial=2, hash=0x76bbb6f1, flags=0xf, domain=1
    1 (numeric) @0x7fd3add04a30, hash=0x160af41d, flags=0xf
    =====
```
This means that the `if` clause was triggered, as it should be.



---

archive/issue_comments_493049.json:
```json
{
    "body": "**Dependencies:** #30446",
    "created_at": "2021-02-02T00:56:30Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493049",
    "user": "https://github.com/dimpase"
}
```

**Dependencies:** #30446



---

archive/issue_events_274957.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-02-02T00:56:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30688#event-274957"
}
```



---

archive/issue_events_274958.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-02-02T00:56:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30688#event-274958"
}
```



---

archive/issue_comments_493050.json:
```json
{
    "body": "**Reviewer:** Dima Pasechnik",
    "created_at": "2021-02-02T00:56:30Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493050",
    "user": "https://github.com/dimpase"
}
```

**Reviewer:** Dima Pasechnik



---

archive/issue_comments_493051.json:
```json
{
    "body": "<a id='comment:26'></a>\nOK, I'm at loss here. \n\nAnyway,let's get your patch in, but please rebase it over\nthe branch of #30446\n(i.e. it should be for pynac 0.7.27, not the current one)",
    "created_at": "2021-02-02T00:56:30Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493051",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:26'></a>
OK, I'm at loss here. 

Anyway,let's get your patch in, but please rebase it over
the branch of #30446
(i.e. it should be for pynac 0.7.27, not the current one)



---

archive/issue_comments_493052.json:
```json
{
    "body": "**Changing branch** from \"[public/30688](https://github.com/sagemath/sagetrac-mirror/tree/public/30688)\" to \"[public/30688r1](https://github.com/sagemath/sagetrac-mirror/tree/public/30688r1)\".",
    "created_at": "2021-02-03T07:15:27Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493052",
    "user": "https://github.com/DaveWitteMorris"
}
```

**Changing branch** from "[public/30688](https://github.com/sagemath/sagetrac-mirror/tree/public/30688)" to "[public/30688r1](https://github.com/sagemath/sagetrac-mirror/tree/public/30688r1)".



---

archive/issue_events_274959.json:
```json
{
    "actor": "https://github.com/DaveWitteMorris",
    "created_at": "2021-02-03T07:17:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30688#event-274959"
}
```



---

archive/issue_events_274960.json:
```json
{
    "actor": "https://github.com/DaveWitteMorris",
    "created_at": "2021-02-03T07:17:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30688#event-274960"
}
```



---

archive/issue_comments_493053.json:
```json
{
    "body": "<a id='comment:28'></a>\nOK, I always having trouble doing a rebase, but I think I eventually got it correct.\n\nI changed the package version to 0.7.27.p1 -- is that correct?\n\n---\n**Last 10 new commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/182b3d22106e206a95d9ffbf2104f5c2a32dd3b5\">182b3d2</a></td><td><code>sage -package fix-checksum: Handle package classes, ignore non-normal packages</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9a57cf605cfab70a449b8a86ca2ac87f7f7d9a07\">9a57cf6</a></td><td><code>pynac update</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/563940e8554fe96a16fdf669c03f895aacf27b3c\">563940e</a></td><td><code>doctest from #30446</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/51def3cc9203861a11404019d68ed90937d9f017\">51def3c</a></td><td><code>sane version name</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4834dc8a7ab300c57921986e847972030b0547ca\">4834dc8</a></td><td><code>remove upstreamed patch</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/214712de4fd44f9e703cfffc7cccced7b5757a12\">214712d</a></td><td><code>tarball update</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ccdf77cba4f57f2e8f595dbeefb2fb604d9f9ace\">ccdf77c</a></td><td><code>update SPKG.rst</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fab55597384838f263bf4855461cc7a4de579ed7\">fab5559</a></td><td><code>trac 30688 patch infinite loop in pynac</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/23875bd195b3981f5017bebfff94ca62d4481221\">23875bd</a></td><td><code>doctests and minor edits</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/20067d34f7d50886b6efe3ba81729a381a4602a8\">20067d3</a></td><td><code>update package version</code></td></tr></table>\n",
    "created_at": "2021-02-03T07:17:52Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493053",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:28'></a>
OK, I always having trouble doing a rebase, but I think I eventually got it correct.

I changed the package version to 0.7.27.p1 -- is that correct?

---
**Last 10 new commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/182b3d22106e206a95d9ffbf2104f5c2a32dd3b5">182b3d2</a></td><td><code>sage -package fix-checksum: Handle package classes, ignore non-normal packages</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9a57cf605cfab70a449b8a86ca2ac87f7f7d9a07">9a57cf6</a></td><td><code>pynac update</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/563940e8554fe96a16fdf669c03f895aacf27b3c">563940e</a></td><td><code>doctest from #30446</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/51def3cc9203861a11404019d68ed90937d9f017">51def3c</a></td><td><code>sane version name</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4834dc8a7ab300c57921986e847972030b0547ca">4834dc8</a></td><td><code>remove upstreamed patch</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/214712de4fd44f9e703cfffc7cccced7b5757a12">214712d</a></td><td><code>tarball update</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ccdf77cba4f57f2e8f595dbeefb2fb604d9f9ace">ccdf77c</a></td><td><code>update SPKG.rst</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fab55597384838f263bf4855461cc7a4de579ed7">fab5559</a></td><td><code>trac 30688 patch infinite loop in pynac</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/23875bd195b3981f5017bebfff94ca62d4481221">23875bd</a></td><td><code>doctests and minor edits</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/20067d34f7d50886b6efe3ba81729a381a4602a8">20067d3</a></td><td><code>update package version</code></td></tr></table>




---

archive/issue_comments_493054.json:
```json
{
    "body": "**Author:** Dave Morris",
    "created_at": "2021-02-03T07:17:52Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493054",
    "user": "https://github.com/DaveWitteMorris"
}
```

**Author:** Dave Morris



---

archive/issue_comments_493055.json:
```json
{
    "body": "**Changing commit** from \"[6ea4bc6074b7fd5606277aee7c140d786fc4b75d](https://github.com/sagemath/sagetrac-mirror/commit/6ea4bc6074b7fd5606277aee7c140d786fc4b75d)\" to \"[20067d34f7d50886b6efe3ba81729a381a4602a8](https://github.com/sagemath/sagetrac-mirror/commit/20067d34f7d50886b6efe3ba81729a381a4602a8)\".",
    "created_at": "2021-02-03T07:17:52Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493055",
    "user": "https://github.com/DaveWitteMorris"
}
```

**Changing commit** from "[6ea4bc6074b7fd5606277aee7c140d786fc4b75d](https://github.com/sagemath/sagetrac-mirror/commit/6ea4bc6074b7fd5606277aee7c140d786fc4b75d)" to "[20067d34f7d50886b6efe3ba81729a381a4602a8](https://github.com/sagemath/sagetrac-mirror/commit/20067d34f7d50886b6efe3ba81729a381a4602a8)".



---

archive/issue_comments_493056.json:
```json
{
    "body": "<a id='comment:29'></a>\nFollowup ticket: I opened #31337 for reimplementing the `else if` clause.",
    "created_at": "2021-02-04T05:03:16Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493056",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:29'></a>
Followup ticket: I opened #31337 for reimplementing the `else if` clause.



---

archive/issue_events_274961.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-02-27T15:14:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30688#event-274961"
}
```



---

archive/issue_events_274962.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2021-02-27T15:14:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30688#event-274962"
}
```



---

archive/issue_comments_493057.json:
```json
{
    "body": "<a id='comment:31'></a>\nOK,good.",
    "created_at": "2021-02-27T15:14:23Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493057",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:31'></a>
OK,good.



---

archive/issue_events_274963.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-07T17:06:29Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30688#event-274963"
}
```



---

archive/issue_events_274964.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "a7f0295eabd1985c40a38fe87e2f66ffd1f0a3e5",
    "created_at": "2021-03-07T17:06:29Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30688#event-274964"
}
```



---

archive/issue_comments_493058.json:
```json
{
    "body": "**Changing branch** from \"[public/30688r1](https://github.com/sagemath/sagetrac-mirror/tree/public/30688r1)\" to \"[20067d34f7d50886b6efe3ba81729a381a4602a8](https://github.com/sagemath/sagetrac-mirror/commit/20067d34f7d50886b6efe3ba81729a381a4602a8)\".",
    "created_at": "2021-03-07T17:06:29Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493058",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[public/30688r1](https://github.com/sagemath/sagetrac-mirror/tree/public/30688r1)" to "[20067d34f7d50886b6efe3ba81729a381a4602a8](https://github.com/sagemath/sagetrac-mirror/commit/20067d34f7d50886b6efe3ba81729a381a4602a8)".



---

archive/issue_comments_493059.json:
```json
{
    "body": "**Changing commit** from \"[20067d34f7d50886b6efe3ba81729a381a4602a8](https://github.com/sagemath/sagetrac-mirror/commit/20067d34f7d50886b6efe3ba81729a381a4602a8)\" to \"\".",
    "created_at": "2021-03-07T18:21:10Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493059",
    "user": "https://github.com/slel"
}
```

**Changing commit** from "[20067d34f7d50886b6efe3ba81729a381a4602a8](https://github.com/sagemath/sagetrac-mirror/commit/20067d34f7d50886b6efe3ba81729a381a4602a8)" to "".



---

archive/issue_comments_493060.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,5 +1,4 @@\n-\n-This crashes sage:\n+Before this ticket, this crashes Sage:\n \n ```\n sage: assume(x < 0)\n@@ -15,42 +14,42 @@\n \n History : see this [sage-release](https://groups.google.com/g/sage-release/c/6RLsvBKi84I/m/2grSEQC1CgAJ) post and the following.\n \n-TL; DR : Sage crashes reproducibly on some substitutions :\n+TL;DR: Sage crashes reproducibly on some substitutions:\n \n ```\n-f=function(\"f\")\n+f = function(\"f\")\n var(\"k\")\n-Eq=f(x).diff(x,2)/f(x)==k\n-with assuming(k>0):Sp=desolve(Eq,f(x),ivar=x)\n-with assuming(k==0):Sz=desolve(Eq,f(x),ivar=x)\n-with assuming(k<0):Sn=desolve(Eq,f(x),ivar=x)\n-var(\"_K1,_K2\")\n-with assuming(k<0): Sn1=Sn.subs(sqrt(k)==I*sqrt(abs(k)))\n+Eq = f(x).diff(x, 2)/f(x) == k\n+with assuming(k > 0):\n+    Sp = desolve(Eq, f(x), ivar=x)\n+with assuming(k == 0):\n+    Sz = desolve(Eq, f(x), ivar=x)\n+with assuming(k < 0):\n+    Sn = desolve(Eq, f(x), ivar=x)\n+var(\"_K1, _K2\")\n+with assuming(k < 0):\n+    Sn1 = Sn.subs(sqrt(k) == I*sqrt(abs(k)))\n # Crashes Sage\n ```\n \n-This may result from an incorrect backtranslation from Maxima :\n+This may result from an incorrect backtranslation from Maxima:\n \n ```\n-charpent@zen-book-flip:~$ sage\n-\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n-\u2502 SageMath version 9.2.beta14, Release Date: 2020-09-30              \u2502\n-\u2502 Using Python 3.8.6. Type \"help()\" for help.                        \u2502\n-\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n-\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n-\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n-\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\n-sage: var(\"k\")                                                                  \n+$ sage\n+... SageMath version 9.2.beta14, Release Date: 2020-09-30\n+... Using Python 3.8.6. Type \"help()\" for help.\n+...\n+sage: var(\"k\")\n k\n-sage: assume(k<0)                                                               \n-sage: f=function(\"f\")                                                           \n-sage: Eq=f(x).diff(x,2)/f(x)==k                                                 \n-sage: S=desolve(Eq, f(x), ivar=x); S                                            \n+sage: assume(k < 0)\n+sage: f = function(\"f\")\n+sage: Eq = f(x).diff(x, 2)/f(x) == k\n+sage: S = desolve(Eq, f(x), ivar=x); S\n _K2*cosh(sqrt(k)*x) + I*_K1*sinh(sqrt(k)*x)\n-sage: SS=maxima.subst([sqrt(k)==I*sqrt(-k)], S); SS                             \n+sage: SS = maxima.subst([sqrt(k) == I*sqrt(-k)], S); SS\n _SAGE_VAR__K2*cos(sqrt(-_SAGE_VAR_k)*_SAGE_VAR_x)-_SAGE_VAR__K1*sin(sqrt(-_SAGE_VAR_k)*_SAGE_VAR_x)\n-sage: SS.sage()                                                                 \n-# CRASH :\n+sage: SS.sage()\n+# CRASH:\n ------------------------------------------------------------------------\n /usr/local/sage-9/local/lib/python3.8/site-packages/cysignals/signals.cpython-38-x86_64-linux-gnu.so(+0x842b)[0x7fac8352242b]\n # Etc. ad nauseam...\n@@ -58,31 +57,27 @@\n \n I mark this as `blocker` since it crashes Sage on (relatively) trivial algebraic operations.\n \n-Interestingly, I can't reproduce the problem in expression coming from another source :\n+Interestingly, I can't reproduce the problem in expression coming from another source:\n \n ```\n-charpent@zen-book-flip:~$ sage\n-\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n-\u2502 SageMath version 9.2.beta14, Release Date: 2020-09-30              \u2502\n-\u2502 Using Python 3.8.6. Type \"help()\" for help.                        \u2502\n-\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n-\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n-\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n-\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\n-sage: k=var(\"k\")                                                                \n-sage: assume(k<0)                                                               \n-sage: f=function(\"f\")                                                           \n-sage: Eq=f(x).diff(x,2)/f(x)==k                                                 \n-sage: from sympy import sympify, dsolve                                         \n-sage: S=dsolve(*map(sympify, (Eq, f(x)))); S                                    \n+$ sage\n+... SageMath version 9.2.beta14, Release Date: 2020-09-30\n+... Using Python 3.8.6. Type \"help()\" for help.\n+...\n+sage: k = var(\"k\")\n+sage: assume(k < 0)\n+sage: f = function(\"f\")\n+sage: Eq = f(x).diff(x, 2)/f(x) == k\n+sage: from sympy import sympify, dsolve\n+sage: S = dsolve(*map(sympify, (Eq, f(x)))); S\n Eq(f(x), C1*exp(-sqrt(k)*x) + C2*exp(sqrt(k)*x))\n-sage: S._sage_()                                                                \n+sage: S._sage_()\n f(x) == C2*e^(sqrt(k)*x) + C1*e^(-sqrt(k)*x)\n-sage: S.subs({sympify(sqrt(k)):sympify(I*sqrt(-k))})                            \n+sage: S.subs({sympify(sqrt(k)): sympify(I*sqrt(-k))})\n Eq(f(x), C1*exp(-I*x*sqrt(-k)) + C2*exp(I*x*sqrt(-k)))\n-sage: S.subs({sympify(sqrt(k)):sympify(I*sqrt(-k))})._sage_()                   \n+sage: S.subs({sympify(sqrt(k)): sympify(I*sqrt(-k))})._sage_()\n f(x) == C2*e^(I*sqrt(-k)*x) + C1*e^(-I*sqrt(-k)*x)\n-sage: S._sage_().subs(sqrt(k)==I*sqrt(-k))                                      \n+sage: S._sage_().subs(sqrt(k) == I*sqrt(-k))\n f(x) == C2*e^(I*sqrt(-k)*x) + C1*e^(-I*sqrt(-k)*x)\n ```\n \n``````\n",
    "created_at": "2021-03-07T18:21:10Z",
    "issue": "https://github.com/sagemath/sage/issues/30688",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30688#issuecomment-493060",
    "user": "https://github.com/slel"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,5 +1,4 @@
-
-This crashes sage:
+Before this ticket, this crashes Sage:
 
 ```
 sage: assume(x < 0)
@@ -15,42 +14,42 @@
 
 History : see this [sage-release](https://groups.google.com/g/sage-release/c/6RLsvBKi84I/m/2grSEQC1CgAJ) post and the following.
 
-TL; DR : Sage crashes reproducibly on some substitutions :
+TL;DR: Sage crashes reproducibly on some substitutions:
 
 ```
-f=function("f")
+f = function("f")
 var("k")
-Eq=f(x).diff(x,2)/f(x)==k
-with assuming(k>0):Sp=desolve(Eq,f(x),ivar=x)
-with assuming(k==0):Sz=desolve(Eq,f(x),ivar=x)
-with assuming(k<0):Sn=desolve(Eq,f(x),ivar=x)
-var("_K1,_K2")
-with assuming(k<0): Sn1=Sn.subs(sqrt(k)==I*sqrt(abs(k)))
+Eq = f(x).diff(x, 2)/f(x) == k
+with assuming(k > 0):
+    Sp = desolve(Eq, f(x), ivar=x)
+with assuming(k == 0):
+    Sz = desolve(Eq, f(x), ivar=x)
+with assuming(k < 0):
+    Sn = desolve(Eq, f(x), ivar=x)
+var("_K1, _K2")
+with assuming(k < 0):
+    Sn1 = Sn.subs(sqrt(k) == I*sqrt(abs(k)))
 # Crashes Sage
 ```
 
-This may result from an incorrect backtranslation from Maxima :
+This may result from an incorrect backtranslation from Maxima:
 
 ```
-charpent@zen-book-flip:~$ sage
-┌────────────────────────────────────────────────────────────────────┐
-│ SageMath version 9.2.beta14, Release Date: 2020-09-30              │
-│ Using Python 3.8.6. Type "help()" for help.                        │
-└────────────────────────────────────────────────────────────────────┘
-┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
-┃ Warning: this is a prerelease version, and it may be unstable.     ┃
-┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
-sage: var("k")                                                                  
+$ sage
+... SageMath version 9.2.beta14, Release Date: 2020-09-30
+... Using Python 3.8.6. Type "help()" for help.
+...
+sage: var("k")
 k
-sage: assume(k<0)                                                               
-sage: f=function("f")                                                           
-sage: Eq=f(x).diff(x,2)/f(x)==k                                                 
-sage: S=desolve(Eq, f(x), ivar=x); S                                            
+sage: assume(k < 0)
+sage: f = function("f")
+sage: Eq = f(x).diff(x, 2)/f(x) == k
+sage: S = desolve(Eq, f(x), ivar=x); S
 _K2*cosh(sqrt(k)*x) + I*_K1*sinh(sqrt(k)*x)
-sage: SS=maxima.subst([sqrt(k)==I*sqrt(-k)], S); SS                             
+sage: SS = maxima.subst([sqrt(k) == I*sqrt(-k)], S); SS
 _SAGE_VAR__K2*cos(sqrt(-_SAGE_VAR_k)*_SAGE_VAR_x)-_SAGE_VAR__K1*sin(sqrt(-_SAGE_VAR_k)*_SAGE_VAR_x)
-sage: SS.sage()                                                                 
-# CRASH :
+sage: SS.sage()
+# CRASH:
 ------------------------------------------------------------------------
 /usr/local/sage-9/local/lib/python3.8/site-packages/cysignals/signals.cpython-38-x86_64-linux-gnu.so(+0x842b)[0x7fac8352242b]
 # Etc. ad nauseam...
@@ -58,31 +57,27 @@
 
 I mark this as `blocker` since it crashes Sage on (relatively) trivial algebraic operations.
 
-Interestingly, I can't reproduce the problem in expression coming from another source :
+Interestingly, I can't reproduce the problem in expression coming from another source:
 
 ```
-charpent@zen-book-flip:~$ sage
-┌────────────────────────────────────────────────────────────────────┐
-│ SageMath version 9.2.beta14, Release Date: 2020-09-30              │
-│ Using Python 3.8.6. Type "help()" for help.                        │
-└────────────────────────────────────────────────────────────────────┘
-┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
-┃ Warning: this is a prerelease version, and it may be unstable.     ┃
-┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
-sage: k=var("k")                                                                
-sage: assume(k<0)                                                               
-sage: f=function("f")                                                           
-sage: Eq=f(x).diff(x,2)/f(x)==k                                                 
-sage: from sympy import sympify, dsolve                                         
-sage: S=dsolve(*map(sympify, (Eq, f(x)))); S                                    
+$ sage
+... SageMath version 9.2.beta14, Release Date: 2020-09-30
+... Using Python 3.8.6. Type "help()" for help.
+...
+sage: k = var("k")
+sage: assume(k < 0)
+sage: f = function("f")
+sage: Eq = f(x).diff(x, 2)/f(x) == k
+sage: from sympy import sympify, dsolve
+sage: S = dsolve(*map(sympify, (Eq, f(x)))); S
 Eq(f(x), C1*exp(-sqrt(k)*x) + C2*exp(sqrt(k)*x))
-sage: S._sage_()                                                                
+sage: S._sage_()
 f(x) == C2*e^(sqrt(k)*x) + C1*e^(-sqrt(k)*x)
-sage: S.subs({sympify(sqrt(k)):sympify(I*sqrt(-k))})                            
+sage: S.subs({sympify(sqrt(k)): sympify(I*sqrt(-k))})
 Eq(f(x), C1*exp(-I*x*sqrt(-k)) + C2*exp(I*x*sqrt(-k)))
-sage: S.subs({sympify(sqrt(k)):sympify(I*sqrt(-k))})._sage_()                   
+sage: S.subs({sympify(sqrt(k)): sympify(I*sqrt(-k))})._sage_()
 f(x) == C2*e^(I*sqrt(-k)*x) + C1*e^(-I*sqrt(-k)*x)
-sage: S._sage_().subs(sqrt(k)==I*sqrt(-k))                                      
+sage: S._sage_().subs(sqrt(k) == I*sqrt(-k))
 f(x) == C2*e^(I*sqrt(-k)*x) + C1*e^(-I*sqrt(-k)*x)
 ```
 
``````

