# Issue 30576: Python 3.6: Fix locale/encoding issues in docbuild, then re-enable Python 3.6

archive/issues_030339.json:
```json
{
    "body": "Follow-up from #15791, #29033, #30053, the latter of which disabled use of system Python 3.6.\n\nWith Python 3.6, there is a failure building the documentation on `ubuntu-bionic-standard` (using `/usr/bin/python3.6`, https://github.com/mkoeppe/sage/runs/1106251169):\n\n```\n  [dochtml]   UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 2661: ordinal not in range(128)\n  [dochtml] Full log file: logs/dochtml.log\nMakefile:1876: recipe for target 'doc-html' failed\n```\n\nThis is coming from #30002 \"force C locale in docbuild and remove some obsolete stuff\", which added this:\n\n```\nbuild/bin/sage-site:    export LANG=C # to ensure it is possible to scrape out non-EN locale warnings\n```\nIn the present ticket, we rework the fix in #30002 so that it works with Python 3.6 too (in which setting the \"C\" locale sabotages UTF-8 operation.)\n\n\n\nSupporting Python 3.6 allows Sage to use the system Python on some older Linux distributions that are still in widespread use in scientific computing, including centos-8 and fedora-{26,27,28} (although Python 3.7.x packages are also available for these). See #29033 for more details.\n\nFor the unrelated failures in the Sphinx package installation that #29033 tried to work around, see #30008.  \n(#30008 is a dependency of this ticket merely for the convenience of testing.)\n\n---\n\nReferences:\n- https://www.python.org/dev/peps/pep-0538/ \"Coercing the legacy C locale to a UTF-8 based locale\"\n- https://www.python.org/dev/peps/pep-0540/ \"Add a new UTF-8 mode\"\n- https://bugzilla.redhat.com/attachment.cgi?id=1233034&action=diff\n\n\n\nCC:  @antonio-rojas @dimpase @slel @orlitzky @kiwifb @embray @fchapoton\n\nBranch/Commit: 945c8c58b23cf7b8e5c15cb69c0ac4dbcd184cb5\n\nReviewer: S\u00e9bastien Labb\u00e9\n\nAuthor: Matthias Koeppe\n\nDependencies: #30008\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30576\n\n",
    "closed_at": "2020-09-27T09:10:02Z",
    "created_at": "2020-09-15T15:18:32Z",
    "labels": [
        "component: build",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Python 3.6: Fix locale/encoding issues in docbuild, then re-enable Python 3.6",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30576",
    "user": "https://github.com/mkoeppe"
}
```
Follow-up from #15791, #29033, #30053, the latter of which disabled use of system Python 3.6.

With Python 3.6, there is a failure building the documentation on `ubuntu-bionic-standard` (using `/usr/bin/python3.6`, https://github.com/mkoeppe/sage/runs/1106251169):

```
  [dochtml]   UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 2661: ordinal not in range(128)
  [dochtml] Full log file: logs/dochtml.log
Makefile:1876: recipe for target 'doc-html' failed
```

This is coming from #30002 "force C locale in docbuild and remove some obsolete stuff", which added this:

```
build/bin/sage-site:    export LANG=C # to ensure it is possible to scrape out non-EN locale warnings
```
In the present ticket, we rework the fix in #30002 so that it works with Python 3.6 too (in which setting the "C" locale sabotages UTF-8 operation.)



Supporting Python 3.6 allows Sage to use the system Python on some older Linux distributions that are still in widespread use in scientific computing, including centos-8 and fedora-{26,27,28} (although Python 3.7.x packages are also available for these). See #29033 for more details.

For the unrelated failures in the Sphinx package installation that #29033 tried to work around, see #30008.  
(#30008 is a dependency of this ticket merely for the convenience of testing.)

---

References:
- https://www.python.org/dev/peps/pep-0538/ "Coercing the legacy C locale to a UTF-8 based locale"
- https://www.python.org/dev/peps/pep-0540/ "Add a new UTF-8 mode"
- https://bugzilla.redhat.com/attachment.cgi?id=1233034&action=diff



CC:  @antonio-rojas @dimpase @slel @orlitzky @kiwifb @embray @fchapoton

Branch/Commit: 945c8c58b23cf7b8e5c15cb69c0ac4dbcd184cb5

Reviewer: Sébastien Labbé

Author: Matthias Koeppe

Dependencies: #30008

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/30576





---

archive/issue_comments_432193.json:
```json
{
    "body": "<a id='comment:1'></a>Posting my branch containing few changes that need to be done in order to build doc with ubuntu 18.04 bionic and python 3.6.\n\nThe changes are not sufficient. Other similar issues arise when sphinx is running...\n\n---\nNew commits:",
    "created_at": "2020-09-15T15:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30576",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30576#issuecomment-432193",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:1'></a>Posting my branch containing few changes that need to be done in order to build doc with ubuntu 18.04 bionic and python 3.6.

The changes are not sufficient. Other similar issues arise when sphinx is running...

---
New commits:



---

archive/issue_comments_432194.json:
```json
{
    "body": "<a id='comment:2'></a>Two comments here:\n\n- fixing the issues in the posted branch took a while because there are many `try - except` clauses in the doc-building which eat up all of the useful tracebacks.\n- I think the remaining issues are just WARNINGS that breaks the docbuild because we decided at some point in the past to consider WARNINGS as errors (which is fine). I base this observation on some hacky modifications I did in the `src/sage_setup/docbuild/sphinxbuild.py`. To confirm this, do you know if there is a way to build sage documentation by considering warnings just as warnings?",
    "created_at": "2020-09-16T08:44:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30576",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30576#issuecomment-432194",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:2'></a>Two comments here:

- fixing the issues in the posted branch took a while because there are many `try - except` clauses in the doc-building which eat up all of the useful tracebacks.
- I think the remaining issues are just WARNINGS that breaks the docbuild because we decided at some point in the past to consider WARNINGS as errors (which is fine). I base this observation on some hacky modifications I did in the `src/sage_setup/docbuild/sphinxbuild.py`. To confirm this, do you know if there is a way to build sage documentation by considering warnings just as warnings?



---

archive/issue_comments_432195.json:
```json
{
    "body": "<a id='comment:3'></a>Warnings one keeps getting are errors in processing function arguments, i.e. in introspecting Python code. Ignoring them would give you a broken doc.\n\n```\nerror while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.complete_primary_decomposition: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)\n```\n\nI think the problems come from a new(ish) sphinx which is run as a backend for our custom docbuilder, and anyway the move from Python 3.6 to 3.7 was somewhat big as far as utf-8 support is concerned.\n\nI really think that fully supporting 3.6 is hard, and we have better things to do. Python has solved this problem by moving to 3.7, let's not reinvent the wheel here.",
    "created_at": "2020-09-16T09:46:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30576",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30576#issuecomment-432195",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>Warnings one keeps getting are errors in processing function arguments, i.e. in introspecting Python code. Ignoring them would give you a broken doc.

```
error while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.complete_primary_decomposition: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)
```

I think the problems come from a new(ish) sphinx which is run as a backend for our custom docbuilder, and anyway the move from Python 3.6 to 3.7 was somewhat big as far as utf-8 support is concerned.

I really think that fully supporting 3.6 is hard, and we have better things to do. Python has solved this problem by moving to 3.7, let's not reinvent the wheel here.



---

archive/issue_comments_432196.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-09-16T23:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30576",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30576#issuecomment-432196",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_432197.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:3 dimpase]:\n> Warnings one keeps getting are errors in processing function arguments, i.e. in introspecting Python code. Ignoring them would give you a broken doc.\n> \n> ```\n> error while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.complete_primary_decomposition: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)\n> ```\n\n\nThere are 2 things I don't understand here:\n\n- 4774 is an integer which is larger then the length of the string of the doc of `complete_primary_decomposition` method\n\n```\nsage: len(sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular\n....: _repr.complete_primary_decomposition.__doc__)                             \n3284\n```\n\n- when I look at the html documentation of that method (after building the doc while ignoring the warnings with some hacky changes in `sphinxbuild.py`), I see no problem",
    "created_at": "2020-09-17T07:05:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30576",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30576#issuecomment-432197",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:11'></a>Replying to [comment:3 dimpase]:
> Warnings one keeps getting are errors in processing function arguments, i.e. in introspecting Python code. Ignoring them would give you a broken doc.
> 
> ```
> error while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.complete_primary_decomposition: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)
> ```


There are 2 things I don't understand here:

- 4774 is an integer which is larger then the length of the string of the doc of `complete_primary_decomposition` method

```
sage: len(sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular
....: _repr.complete_primary_decomposition.__doc__)                             
3284
```

- when I look at the html documentation of that method (after building the doc while ignoring the warnings with some hacky changes in `sphinxbuild.py`), I see no problem



---

archive/issue_comments_432198.json:
```json
{
    "body": "<a id='comment:12'></a>>  - when I look at the html documentation of that method (after building the doc while ignoring the warnings with some hacky changes in `sphinxbuild.py`), I see no problem\n\n\nWith the current branch with no hacky changes, I can build the documentation with the flag `--keep-going`:\n\n```\nMAKE='make -j8' make build\nMAKE='make -j8' ./sage --docbuild --no-pdf-links --keep-going all html\n```\n\nI am now trying to see what is wrong with the output doc...",
    "created_at": "2020-09-17T08:30:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30576",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30576#issuecomment-432198",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:12'></a>>  - when I look at the html documentation of that method (after building the doc while ignoring the warnings with some hacky changes in `sphinxbuild.py`), I see no problem


With the current branch with no hacky changes, I can build the documentation with the flag `--keep-going`:

```
MAKE='make -j8' make build
MAKE='make -j8' ./sage --docbuild --no-pdf-links --keep-going all html
```

I am now trying to see what is wrong with the output doc...



---

archive/issue_comments_432199.json:
```json
{
    "body": "Attachment [error.log](tarball://root/attachments/some-uuid/ticket30576/error.log) by @seblabbe created at 2020-09-17 14:44:38",
    "created_at": "2020-09-17T14:44:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30576",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30576#issuecomment-432199",
    "user": "https://github.com/seblabbe"
}
```

Attachment [error.log](tarball://root/attachments/some-uuid/ticket30576/error.log) by @seblabbe created at 2020-09-17 14:44:38



---

archive/issue_comments_432200.json:
```json
{
    "body": "<a id='comment:13'></a>the command\n\n```\nMAKE='make -j8' build/bin/sage-logger -p './sage --docbuild --no-pdf-links --keep-going all html ' logs/dochtml-keepgoing.log\ncd logs\ngrep error dochtml-keepgoing.log > error.log\n```\ngives relatively few errors (see 112 lines error.log attached). Very often it is the same error, for example, 60 of them are related to crystals code either `can't decode byte 0xe2 in position 6257` or `can't decode byte 0xc3 in position 3272` or `can't decode byte 0xcc in position 7825`.\n\nI still do no know to which doc string these positions are refering to.",
    "created_at": "2020-09-17T14:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30576",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30576#issuecomment-432200",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:13'></a>the command

```
MAKE='make -j8' build/bin/sage-logger -p './sage --docbuild --no-pdf-links --keep-going all html ' logs/dochtml-keepgoing.log
cd logs
grep error dochtml-keepgoing.log > error.log
```
gives relatively few errors (see 112 lines error.log attached). Very often it is the same error, for example, 60 of them are related to crystals code either `can't decode byte 0xe2 in position 6257` or `can't decode byte 0xc3 in position 3272` or `can't decode byte 0xcc in position 7825`.

I still do no know to which doc string these positions are refering to.



---

archive/issue_comments_432201.json:
```json
{
    "body": "<a id='comment:14'></a>Hint:\n\n```\n$ python3 -q\n>>> b'\\xe2'.decode('latin1')\n'\u00e2'\n>>> b'\\xc3'.decode('latin1')\n'\u00c3'\n>>> b'\\xcc'.decode('latin1')\n'\u00cc'\n>>>\n```",
    "created_at": "2020-09-17T15:20:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30576",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30576#issuecomment-432201",
    "user": "https://github.com/slel"
}
```

<a id='comment:14'></a>Hint:

```
$ python3 -q
>>> b'\xe2'.decode('latin1')
'â'
>>> b'\xc3'.decode('latin1')
'Ã'
>>> b'\xcc'.decode('latin1')
'Ì'
>>>
```



---

archive/issue_comments_432202.json:
```json
{
    "body": "<a id='comment:15'></a>But these symbols do not occur in the crystals code:\n\n```\n$ cd SAGE_ROOT\n$ git grep \u00c3 *.py *pyx\n$ git grep \u00e2 *.py *pyx\nsrc/sage/combinat/ncsf_qsym/tutorial.py:MacMahon, Knuth, Kreweras, Gl\u00e2nffrwd Thomas, Stanley. In 1984, Gessel\n$ git grep \u00cc *.py *pyx\n```",
    "created_at": "2020-09-17T15:32:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30576",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30576#issuecomment-432202",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:15'></a>But these symbols do not occur in the crystals code:

```
$ cd SAGE_ROOT
$ git grep Ã *.py *pyx
$ git grep â *.py *pyx
src/sage/combinat/ncsf_qsym/tutorial.py:MacMahon, Knuth, Kreweras, Glânffrwd Thomas, Stanley. In 1984, Gessel
$ git grep Ì *.py *pyx
```



---

archive/issue_comments_432203.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2020-09-22T23:41:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30576",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30576#issuecomment-432203",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_432204.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-09-22T23:57:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30576",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30576#issuecomment-432204",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_432205.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-09-23T00:18:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30576",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30576#issuecomment-432205",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_432206.json:
```json
{
    "body": "<a id='comment:22'></a>On Ubuntu 18.04, after uninstalling python3.8 so that python3.6 gets picked up by `./configure`:\n\n```\n## -------------------------------------------------------- ##                        \n## Checking whether SageMath should install SPKG python3... ##                        ## -------------------------------------------------------- ##                        \nconfigure:30688: checking whether any of sqlite libpng bzip2 xz libffi is installed as\n or will be installed as SPKG                                                         \nconfigure:30697: result: no                                                           \nconfigure:30707: checking for python3 >= 3.6, < 3.9 with modules sqlite3, ctypes, math\n, hashlib, crypt, readline, socket, zlib, distutils.core                              \nconfigure:30713: result:                                                              \nconfigure:30728: checking ... whether /usr/bin/python3.6 is good                                                                      \nconfigure:30921: result: yes                                                          \nconfigure:30923: checking for python3 >= 3.6, < 3.9 with modules sqlite3, ctypes, math\n, hashlib, crypt, readline, socket, zlib, distutils.core                              \nconfigure:30982: result: /usr/bin/python3.6                                           \nconfigure:30997: will use system package and not install SPKG python3    \n```\nI confirm that `make doc` now works ok. From me, it is a positive review.\n\nI let someone change the status to positive review if no problem occurs on the github actions side.",
    "created_at": "2020-09-23T10:58:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30576",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30576#issuecomment-432206",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:22'></a>On Ubuntu 18.04, after uninstalling python3.8 so that python3.6 gets picked up by `./configure`:

```
## -------------------------------------------------------- ##                        
## Checking whether SageMath should install SPKG python3... ##                        ## -------------------------------------------------------- ##                        
configure:30688: checking whether any of sqlite libpng bzip2 xz libffi is installed as
 or will be installed as SPKG                                                         
configure:30697: result: no                                                           
configure:30707: checking for python3 >= 3.6, < 3.9 with modules sqlite3, ctypes, math
, hashlib, crypt, readline, socket, zlib, distutils.core                              
configure:30713: result:                                                              
configure:30728: checking ... whether /usr/bin/python3.6 is good                                                                      
configure:30921: result: yes                                                          
configure:30923: checking for python3 >= 3.6, < 3.9 with modules sqlite3, ctypes, math
, hashlib, crypt, readline, socket, zlib, distutils.core                              
configure:30982: result: /usr/bin/python3.6                                           
configure:30997: will use system package and not install SPKG python3    
```
I confirm that `make doc` now works ok. From me, it is a positive review.

I let someone change the status to positive review if no problem occurs on the github actions side.



---

archive/issue_comments_432207.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-09-23T12:02:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30576",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30576#issuecomment-432207",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_432208.json:
```json
{
    "body": "<a id='comment:24'></a>Thanks for testing!\n\nAlso `ubuntu-bionic-standard` on GH Action is fixed (https://github.com/mkoeppe/sage/runs/1152418788). The failures seen in https://github.com/mkoeppe/sage/actions/runs/267855732 (for example for `ubuntu-bionic-minimal`) come from an unrelated ticket that I merged in the same branch.",
    "created_at": "2020-09-23T12:02:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30576",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30576#issuecomment-432208",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>Thanks for testing!

Also `ubuntu-bionic-standard` on GH Action is fixed (https://github.com/mkoeppe/sage/runs/1152418788). The failures seen in https://github.com/mkoeppe/sage/actions/runs/267855732 (for example for `ubuntu-bionic-minimal`) come from an unrelated ticket that I merged in the same branch.



---

archive/issue_events_079500.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-09-27T09:10:02Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30576",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30576#event-79500"
}
```



---

archive/issue_comments_432209.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-09-27T09:10:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30576",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30576#issuecomment-432209",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
