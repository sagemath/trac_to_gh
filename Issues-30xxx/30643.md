# Issue 30643: cygwin-minimal, cygwin-standard: scipy build fails: 'u_int' has not been declared

archive/issues_030406.json:
```json
{
    "body": "https://github.com/mkoeppe/sage/runs/1153050152\n\n```\nIn file included from /usr/include/sys/config.h:5,\n                   from /usr/include/_ansi.h:11,\n                   from /usr/include/sys/reent.h:13,\n                   from /usr/include/math.h:5,\n                   from /usr/lib/gcc/x86_64-pc-cygwin/10/include/c++/cmath:45,\n                   from scipy/spatial/ckdtree/src/query.cxx:1:\n  /usr/include/sys/features.h:255: note: this is the location of the previous definition\n    255 | #define __BSD_VISIBLE  0\n        |\n  In file included from /cygdrive/d/a/sage/sage/local/include/python3.8/pyport.h:219,\n                   from /cygdrive/d/a/sage/sage/local/include/python3.8/Python.h:63,\n                   from /cygdrive/d/a/sage/sage/local/lib/python3.8/site-packages/numpy/core/include/numpy/npy_common.h:11,\n                   from scipy/spatial/ckdtree/src/ckdtree_decl.h:10,\n                   from scipy/spatial/ckdtree/src/query.cxx:13:\n  /usr/include/sys/time.h:106:34: error: 'u_int' has not been declared\n    106 | bintime_mul(struct bintime *_bt, u_int _x)\n        |                                  ^~~~~\n  g++: scipy/spatial/ckdtree/src/build.cxx\n```\n\nAlso seen in `cygwin-standard` (https://github.com/sagemath/sage/runs/1190880811)\n\n\nBlocker for 9.2 because it is a regression in platform support\n\nCC:  @embray @darijgr @slel @tscrim\n\nBranch/Commit: 454308f9d599da0266c24d45534127c8283381a0\n\nReviewer: Erik Bray\n\nAuthor: Matthias Koeppe\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30643\n\n",
    "closed_at": "2020-10-18T08:38:28Z",
    "created_at": "2020-09-23T12:17:57Z",
    "labels": [
        "component: porting: cygwin",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "cygwin-minimal, cygwin-standard: scipy build fails: 'u_int' has not been declared",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30643",
    "user": "https://github.com/mkoeppe"
}
```
https://github.com/mkoeppe/sage/runs/1153050152

```
In file included from /usr/include/sys/config.h:5,
                   from /usr/include/_ansi.h:11,
                   from /usr/include/sys/reent.h:13,
                   from /usr/include/math.h:5,
                   from /usr/lib/gcc/x86_64-pc-cygwin/10/include/c++/cmath:45,
                   from scipy/spatial/ckdtree/src/query.cxx:1:
  /usr/include/sys/features.h:255: note: this is the location of the previous definition
    255 | #define __BSD_VISIBLE  0
        |
  In file included from /cygdrive/d/a/sage/sage/local/include/python3.8/pyport.h:219,
                   from /cygdrive/d/a/sage/sage/local/include/python3.8/Python.h:63,
                   from /cygdrive/d/a/sage/sage/local/lib/python3.8/site-packages/numpy/core/include/numpy/npy_common.h:11,
                   from scipy/spatial/ckdtree/src/ckdtree_decl.h:10,
                   from scipy/spatial/ckdtree/src/query.cxx:13:
  /usr/include/sys/time.h:106:34: error: 'u_int' has not been declared
    106 | bintime_mul(struct bintime *_bt, u_int _x)
        |                                  ^~~~~
  g++: scipy/spatial/ckdtree/src/build.cxx
```

Also seen in `cygwin-standard` (https://github.com/sagemath/sage/runs/1190880811)


Blocker for 9.2 because it is a regression in platform support

CC:  @embray @darijgr @slel @tscrim

Branch/Commit: 454308f9d599da0266c24d45534127c8283381a0

Reviewer: Erik Bray

Author: Matthias Koeppe

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/30643





---

archive/issue_comments_606036.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -20,3 +20,5 @@\n         |                                  ^~~~~\n   g++: scipy/spatial/ckdtree/src/build.cxx\n ```\n+\n+Also seen in `cygwin-standard` (https://github.com/sagemath/sage/runs/1190880811)\n``````\n",
    "created_at": "2020-10-01T03:54:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606036",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -20,3 +20,5 @@
         |                                  ^~~~~
   g++: scipy/spatial/ckdtree/src/build.cxx
 ```
+
+Also seen in `cygwin-standard` (https://github.com/sagemath/sage/runs/1190880811)
``````




---

archive/issue_comments_606037.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2020-10-01T03:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606037",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_606038.json:
```json
{
    "body": "<a id='comment:3'></a>This build problem that we see on the CI infrastructure could use help from a real Cygwin user",
    "created_at": "2020-10-02T18:42:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606038",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>This build problem that we see on the CI infrastructure could use help from a real Cygwin user



---

archive/issue_comments_606039.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2020-10-08T17:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606039",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_606040.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -22,3 +22,6 @@\n ```\n \n Also seen in `cygwin-standard` (https://github.com/sagemath/sage/runs/1190880811)\n+\n+\n+Blocker for 9.2 because it is a regression in platform support\n``````\n",
    "created_at": "2020-10-08T17:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606040",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -22,3 +22,6 @@
 ```
 
 Also seen in `cygwin-standard` (https://github.com/sagemath/sage/runs/1190880811)
+
+
+Blocker for 9.2 because it is a regression in platform support
``````




---

archive/issue_comments_606041.json:
```json
{
    "body": "<a id='comment:5'></a>Possibly relevant: https://stackoverflow.com/questions/39786845/cygwin-g-compiling-with-python-h-duplicated-definition-of-bsd-visible",
    "created_at": "2020-10-10T23:58:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606041",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:5'></a>Possibly relevant: https://stackoverflow.com/questions/39786845/cygwin-g-compiling-with-python-h-duplicated-definition-of-bsd-visible



---

archive/issue_comments_606042.json:
```json
{
    "body": "<a id='comment:6'></a>What Cygwin version is it using?  This might be a newly introduced issue in one of Cygwin's libc headers.\n\nI'm still on an older version that doesn't have this problem:\n\n```\n$ uname -a\nCYGWIN_NT-10.0 <Hostname> 3.0.7(0.338/5/3) 2019-04-30 18:08 x86_64 Cygwin\n```",
    "created_at": "2020-10-13T14:42:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606042",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>What Cygwin version is it using?  This might be a newly introduced issue in one of Cygwin's libc headers.

I'm still on an older version that doesn't have this problem:

```
$ uname -a
CYGWIN_NT-10.0 <Hostname> 3.0.7(0.338/5/3) 2019-04-30 18:08 x86_64 Cygwin
```



---

archive/issue_comments_606043.json:
```json
{
    "body": "<a id='comment:7'></a>I've seen issues like this before.  The problem is visible in this line from the log:\n\n```\n  [scipy-1.5.2]     error: Command \"g++ -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -I/cygdrive/d/a/sage/sage/local/include/python3.8 -I/cygdrive/d/a/sage/sage/local/lib/python3.8/site-packages/numpy/core/include -Iscipy/_lib -Iscipy/_build_utils/src -Iscipy/spatial/ckdtree/src -I/cygdrive/d/a/sage/sage/local/lib/python3.8/site-packages/numpy/core/include -I/cygdrive/d/a/sage/sage/local/include/python3.8 -c scipy/spatial/ckdtree/src/query.cxx -o build/temp.cygwin-3.1.7-x86_64-3.8/scipy/spatial/ckdtree/src/query.o -MMD -MF build/temp.cygwin-3.1.7-x86_64-3.8/scipy/spatial/ckdtree/src/query.o.d -std=c++14\" failed with exit status 1\n```\n\nIn Cygwin's libc, `__BSD_VISIBLE = 0` by default, because when using `-std=c[++]<nn>` flags it defined `__STRICT_ANSI__` and non-ANSI C extensions are not declared as you can see with the following test program:\n\n```\n$ cat bsd_visible.c\n#include <stdio.h>\n#include <sys/features.h>\n\n#if defined(__STRICT_ANSI__)\n#define DEFINED__STRICT_ANSI__ 1\n#else\n#define DEFINED__STRICT_ANSI__ 0\n#endif\n\nint main(void) {\n    printf(\"defined(__STRICT_ANSI__) = %d\\n\", DEFINED__STRICT_ANSI__);\n    printf(\"__BSD_VISIBLE = %d\\n\", __BSD_VISIBLE);\n    return 0;\n}\n```\n\n```\n$ g++ -std=c++14 bsd_visible.c -o bsd_visible\n$ ./bsd_visible.exe\ndefined(__STRICT_ANSI__) = 1\n__BSD_VISIBLE = 0\n```\n\n\nHowever, if you compile with `-std=gnu[++]<nn>` the \"kitchen sink\" is enabled:\n\n```\n$ g++ -std=gnu++14 bsd_visible.c -o bsd_visible\n$ ./bsd_visible.exe\ndefined(__STRICT_ANSI__) = 0\n__BSD_VISIBLE = 1\n```\n\nYou can also work around this by defining the `_GNU_SOURCE` macro e.g. when building SciPy.  This might be the easiest workaround:\n\n```\n$ g++ -std=c++14 -D_GNU_SOURCE bsd_visible.c -o bsd_visible\n$ ./bsd_visible.exe\ndefined(__STRICT_ANSI__) = 1\n__BSD_VISIBLE = 1\n```",
    "created_at": "2020-10-13T15:06:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606043",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>I've seen issues like this before.  The problem is visible in this line from the log:

```
  [scipy-1.5.2]     error: Command "g++ -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -I/cygdrive/d/a/sage/sage/local/include/python3.8 -I/cygdrive/d/a/sage/sage/local/lib/python3.8/site-packages/numpy/core/include -Iscipy/_lib -Iscipy/_build_utils/src -Iscipy/spatial/ckdtree/src -I/cygdrive/d/a/sage/sage/local/lib/python3.8/site-packages/numpy/core/include -I/cygdrive/d/a/sage/sage/local/include/python3.8 -c scipy/spatial/ckdtree/src/query.cxx -o build/temp.cygwin-3.1.7-x86_64-3.8/scipy/spatial/ckdtree/src/query.o -MMD -MF build/temp.cygwin-3.1.7-x86_64-3.8/scipy/spatial/ckdtree/src/query.o.d -std=c++14" failed with exit status 1
```

In Cygwin's libc, `__BSD_VISIBLE = 0` by default, because when using `-std=c[++]<nn>` flags it defined `__STRICT_ANSI__` and non-ANSI C extensions are not declared as you can see with the following test program:

```
$ cat bsd_visible.c
#include <stdio.h>
#include <sys/features.h>

#if defined(__STRICT_ANSI__)
#define DEFINED__STRICT_ANSI__ 1
#else
#define DEFINED__STRICT_ANSI__ 0
#endif

int main(void) {
    printf("defined(__STRICT_ANSI__) = %d\n", DEFINED__STRICT_ANSI__);
    printf("__BSD_VISIBLE = %d\n", __BSD_VISIBLE);
    return 0;
}
```

```
$ g++ -std=c++14 bsd_visible.c -o bsd_visible
$ ./bsd_visible.exe
defined(__STRICT_ANSI__) = 1
__BSD_VISIBLE = 0
```


However, if you compile with `-std=gnu[++]<nn>` the "kitchen sink" is enabled:

```
$ g++ -std=gnu++14 bsd_visible.c -o bsd_visible
$ ./bsd_visible.exe
defined(__STRICT_ANSI__) = 0
__BSD_VISIBLE = 1
```

You can also work around this by defining the `_GNU_SOURCE` macro e.g. when building SciPy.  This might be the easiest workaround:

```
$ g++ -std=c++14 -D_GNU_SOURCE bsd_visible.c -o bsd_visible
$ ./bsd_visible.exe
defined(__STRICT_ANSI__) = 1
__BSD_VISIBLE = 1
```



---

archive/issue_comments_606044.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:6 embray]:\n> What Cygwin version is it using?  This might be a newly introduced issue in one of Cygwin's libc headers.\n\n\nThe GH runs always use the most current version. I was not able to reproduce the error on my Windows 10 tablet (both with Cygwin 3.1.4 and after upgrading to the current 3.1.7). So whether the error shows up seems to depend in a subtle way on the list of Cygwin packages installed. I'm investigating this at the moment.",
    "created_at": "2020-10-13T16:37:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606044",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>Replying to [comment:6 embray]:
> What Cygwin version is it using?  This might be a newly introduced issue in one of Cygwin's libc headers.


The GH runs always use the most current version. I was not able to reproduce the error on my Windows 10 tablet (both with Cygwin 3.1.4 and after upgrading to the current 3.1.7). So whether the error shows up seems to depend in a subtle way on the list of Cygwin packages installed. I'm investigating this at the moment.



---

archive/issue_comments_606045.json:
```json
{
    "body": "<a id='comment:9'></a>It would most likely be caused by something that changed in newlib.  I can't see any obvious culprits in the the history.  But in fact it seems like what was changed was actually fixing something that shouldn't have worked in the first place.  Once of the workarounds I suggested above should be used.",
    "created_at": "2020-10-13T16:51:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606045",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>It would most likely be caused by something that changed in newlib.  I can't see any obvious culprits in the the history.  But in fact it seems like what was changed was actually fixing something that shouldn't have worked in the first place.  Once of the workarounds I suggested above should be used.



---

archive/issue_comments_606046.json:
```json
{
    "body": "Changing reviewer from \"\" to \"https://github.com/mkoeppe/sage/actions/runs/304938502\"",
    "created_at": "2020-10-13T18:05:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606046",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "https://github.com/mkoeppe/sage/actions/runs/304938502"



---

archive/issue_comments_606047.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/cygwin_minimal__cygwin_standard__scipy_build_fails___u_int__has_not_been_declared\"",
    "created_at": "2020-10-13T18:05:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606047",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/cygwin_minimal__cygwin_standard__scipy_build_fails___u_int__has_not_been_declared"



---

archive/issue_comments_606048.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:7 embray]:\n> You can also work around this by defining the `_GNU_SOURCE` macro e.g. when building SciPy.  This might be the easiest workaround:\n> \n> \n> ```\n> $ g++ -std=c++14 -D_GNU_SOURCE bsd_visible.c -o bsd_visible\n> $ ./bsd_visible.exe\n> defined(__STRICT_ANSI__) = 1\n> __BSD_VISIBLE = 1\n> ```\n\n\nThanks a lot. I'm trying this solution now. Let's see how this goes.\n\n---\nNew commits:",
    "created_at": "2020-10-13T18:14:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606048",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>Replying to [comment:7 embray]:
> You can also work around this by defining the `_GNU_SOURCE` macro e.g. when building SciPy.  This might be the easiest workaround:
> 
> 
> ```
> $ g++ -std=c++14 -D_GNU_SOURCE bsd_visible.c -o bsd_visible
> $ ./bsd_visible.exe
> defined(__STRICT_ANSI__) = 1
> __BSD_VISIBLE = 1
> ```


Thanks a lot. I'm trying this solution now. Let's see how this goes.

---
New commits:



---

archive/issue_comments_606049.json:
```json
{
    "body": "Changing commit from \"\" to \"454308f9d599da0266c24d45534127c8283381a0\"",
    "created_at": "2020-10-13T18:14:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606049",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "" to "454308f9d599da0266c24d45534127c8283381a0"



---

archive/issue_comments_606050.json:
```json
{
    "body": "<a id='comment:13'></a>This seems to have done the trick. See https://github.com/mkoeppe/sage/runs/1250401299?check_suite_focus=true",
    "created_at": "2020-10-14T05:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606050",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>This seems to have done the trick. See https://github.com/mkoeppe/sage/runs/1250401299?check_suite_focus=true



---

archive/issue_comments_606051.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2020-10-14T05:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606051",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_comments_606052.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-10-14T05:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606052",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_606053.json:
```json
{
    "body": "<a id='comment:14'></a>Great!",
    "created_at": "2020-10-14T12:33:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606053",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'></a>Great!



---

archive/issue_comments_606054.json:
```json
{
    "body": "Changing reviewer from \"https://github.com/mkoeppe/sage/actions/runs/304938502\" to \"Erik Bray\"",
    "created_at": "2020-10-14T12:33:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606054",
    "user": "https://github.com/embray"
}
```

Changing reviewer from "https://github.com/mkoeppe/sage/actions/runs/304938502" to "Erik Bray"



---

archive/issue_comments_606055.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-10-14T12:33:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606055",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_606056.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/cygwin_minimal__cygwin_standard__scipy_build_fails___u_int__has_not_been_declared\" to \"454308f9d599da0266c24d45534127c8283381a0\"",
    "created_at": "2020-10-18T08:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606056",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mkoeppe/cygwin_minimal__cygwin_standard__scipy_build_fails___u_int__has_not_been_declared" to "454308f9d599da0266c24d45534127c8283381a0"



---

archive/issue_comments_606057.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-10-18T08:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30643#issuecomment-606057",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_079695.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-10-18T08:38:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30643",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30643#event-79695"
}
```
