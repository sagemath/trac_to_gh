# Issue 30008: After #30053, sphinx 3.1.2 does not build on ubuntu-{trusty,xenial,bionic}, debian-jessie, centos-7 (again)

archive/issues_029771.json:
```json
{
    "body": "`sage-system-python` is the Python that we use to download and unpack upstream archives.  We allow a very wide range of Python versions.\n\nAfter #30053 undid the change in #29033, we are again running into locale / encoding problems with early (pre-3.7) versions of Python used as `sage-system-python`.\n\nThis is a blocker ticket for Sage 9.2 because it is a severe regression in platform support compared to Sage 9.1.\n\nOriginally reported on this ticket:\n\n```\n/sage/build/bin/sage-spkg: line 73: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8): No such file or directory\n/sage/build/bin/sage-spkg: line 73: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)\nFound local metadata for sphinx-3.0.4.p0\nbash: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)\nAttempting to download package Sphinx-3.0.4.tar.gz from mirrors\nhttp://mirrors.xmission.com/sage/spkg/upstream/sphinx/Sphinx-3.0.4.tar.gz\n[......................................................................]\nsphinx-3.0.4.p0\n====================================================\nSetting up build directory for sphinx-3.0.4.p0\nbash: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)\nTraceback (most recent call last):\n  File \"/sage/build/bin/sage-uncompress-spkg\", line 23, in <module>\n    run()\n  File \"/sage/build/bin/../sage_bootstrap/uncompress/cmdline.py\", line 72, in run\n    unpack_archive(archive, dirname)\n  File \"/sage/build/bin/../sage_bootstrap/uncompress/action.py\", line 68, in unpack_archive\n    archive.extractall(members=archive.names)\n  File \"/sage/build/bin/../sage_bootstrap/uncompress/tar_file.py\", line 96, in extractall\n    **kwargs)\n  File \"/usr/lib64/python3.6/tarfile.py\", line 2010, in extractall\n    numeric_owner=numeric_owner)\n  File \"/usr/lib64/python3.6/tarfile.py\", line 2052, in extract\n    numeric_owner=numeric_owner)\n  File \"/sage/build/bin/../sage_bootstrap/uncompress/tar_file.py\", line 122, in _extract_member\n    **kwargs)\n  File \"/usr/lib64/python3.6/tarfile.py\", line 2122, in _extract_member\n    self.makefile(tarinfo, targetpath)\n  File \"/usr/lib64/python3.6/tarfile.py\", line 2163, in makefile\n    with bltn_open(targetpath, \"wb\") as target:\nUnicodeEncodeError: 'ascii' codec can't encode character '\\xe4' in position 45: ordinal not in range(128)\n************************************************************************\nError: failed to extract /sage/upstream/Sphinx-3.0.4.tar.gz\n************************************************************************\nPlease email sage-devel (http://groups.google.com/group/sage-devel)\nexplaining the problem and including the log file\n  /sage/logs/pkgs/sphinx-3.0.4.p0.log\nDescribe your computer, operating system, etc.\n************************************************************************\n```\n\nSee e.g. https://github.com/sagemath/sage/runs/811777719?check_suite_focus=true\n\nBut now (https://github.com/mkoeppe/sage/runs/1141520147) we see it for `ubuntu-trusty-minimal` (where `sage-system-python` is python 3.4).\n\nWe fix this problem by making locale fixes in the `sage-system-python` script. See e.g. https://github.com/mkoeppe/sage/runs/1142310012 for a run with the present ticket.\n\n\n\n\nDepends on #30053\n\n**CC:**  @vbraun @dimpase @orlitzky @jhpalmieri @seblabbe\n\n**Branch/Commit:** [ff0dbc622b8b3f4ce467a0324c3fdbd134df24e3](https://github.com/sagemath/sagetrac-mirror/commit/ff0dbc622b8b3f4ce467a0324c3fdbd134df24e3)\n\n**Reviewer:** Jonathan Kliem, S\u00e9bastien Labb\u00e9\n\n**Author:** Matthias Koeppe\n\nIssue created by migration from https://trac.sagemath.org/ticket/30008\n\n",
    "closed_at": "2020-09-27T09:10:05Z",
    "created_at": "2020-06-28T12:44:02Z",
    "labels": [
        "component: packages: standard",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.2",
    "title": "After #30053, sphinx 3.1.2 does not build on ubuntu-{trusty,xenial,bionic}, debian-jessie, centos-7 (again)",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/30008",
    "user": "https://github.com/kliem"
}
```
`sage-system-python` is the Python that we use to download and unpack upstream archives.  We allow a very wide range of Python versions.

After #30053 undid the change in #29033, we are again running into locale / encoding problems with early (pre-3.7) versions of Python used as `sage-system-python`.

This is a blocker ticket for Sage 9.2 because it is a severe regression in platform support compared to Sage 9.1.

Originally reported on this ticket:

```
/sage/build/bin/sage-spkg: line 73: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8): No such file or directory
/sage/build/bin/sage-spkg: line 73: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
Found local metadata for sphinx-3.0.4.p0
bash: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
Attempting to download package Sphinx-3.0.4.tar.gz from mirrors
http://mirrors.xmission.com/sage/spkg/upstream/sphinx/Sphinx-3.0.4.tar.gz
[......................................................................]
sphinx-3.0.4.p0
====================================================
Setting up build directory for sphinx-3.0.4.p0
bash: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8)
Traceback (most recent call last):
  File "/sage/build/bin/sage-uncompress-spkg", line 23, in <module>
    run()
  File "/sage/build/bin/../sage_bootstrap/uncompress/cmdline.py", line 72, in run
    unpack_archive(archive, dirname)
  File "/sage/build/bin/../sage_bootstrap/uncompress/action.py", line 68, in unpack_archive
    archive.extractall(members=archive.names)
  File "/sage/build/bin/../sage_bootstrap/uncompress/tar_file.py", line 96, in extractall
    **kwargs)
  File "/usr/lib64/python3.6/tarfile.py", line 2010, in extractall
    numeric_owner=numeric_owner)
  File "/usr/lib64/python3.6/tarfile.py", line 2052, in extract
    numeric_owner=numeric_owner)
  File "/sage/build/bin/../sage_bootstrap/uncompress/tar_file.py", line 122, in _extract_member
    **kwargs)
  File "/usr/lib64/python3.6/tarfile.py", line 2122, in _extract_member
    self.makefile(tarinfo, targetpath)
  File "/usr/lib64/python3.6/tarfile.py", line 2163, in makefile
    with bltn_open(targetpath, "wb") as target:
UnicodeEncodeError: 'ascii' codec can't encode character '\xe4' in position 45: ordinal not in range(128)
************************************************************************
Error: failed to extract /sage/upstream/Sphinx-3.0.4.tar.gz
************************************************************************
Please email sage-devel (http://groups.google.com/group/sage-devel)
explaining the problem and including the log file
  /sage/logs/pkgs/sphinx-3.0.4.p0.log
Describe your computer, operating system, etc.
************************************************************************
```

See e.g. https://github.com/sagemath/sage/runs/811777719?check_suite_focus=true

But now (https://github.com/mkoeppe/sage/runs/1141520147) we see it for `ubuntu-trusty-minimal` (where `sage-system-python` is python 3.4).

We fix this problem by making locale fixes in the `sage-system-python` script. See e.g. https://github.com/mkoeppe/sage/runs/1142310012 for a run with the present ticket.




Depends on #30053

**CC:**  @vbraun @dimpase @orlitzky @jhpalmieri @seblabbe

**Branch/Commit:** [ff0dbc622b8b3f4ce467a0324c3fdbd134df24e3](https://github.com/sagemath/sagetrac-mirror/commit/ff0dbc622b8b3f4ce467a0324c3fdbd134df24e3)

**Reviewer:** Jonathan Kliem, Sébastien Labbé

**Author:** Matthias Koeppe

Issue created by migration from https://trac.sagemath.org/ticket/30008





---

archive/issue_comments_477636.json:
```json
{
    "body": "<a id='comment:1'></a>\nThat's a very strange error",
    "created_at": "2020-06-28T15:48:35Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477636",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>
That's a very strange error



---

archive/issue_comments_477637.json:
```json
{
    "body": "<a id='comment:2'></a>\nhttps://bugs.python.org/issue17153",
    "created_at": "2020-06-28T15:50:13Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477637",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>
https://bugs.python.org/issue17153



---

archive/issue_comments_477638.json:
```json
{
    "body": "<a id='comment:4'></a>\nPerhaps #30001 happens to fix it?",
    "created_at": "2020-06-29T19:30:27Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477638",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>
Perhaps #30001 happens to fix it?



---

archive/issue_comments_477639.json:
```json
{
    "body": "<a id='comment:5'></a>\nTesting here:\n\nhttps://github.com/kliem/sage/pull/17/checks",
    "created_at": "2020-06-29T19:36:59Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477639",
    "user": "https://github.com/kliem"
}
```

<a id='comment:5'></a>
Testing here:

https://github.com/kliem/sage/pull/17/checks



---

archive/issue_comments_477640.json:
```json
{
    "body": "<a id='comment:6'></a>\nNo, doesn't help. At least not as it is now.",
    "created_at": "2020-06-30T05:12:35Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477640",
    "user": "https://github.com/kliem"
}
```

<a id='comment:6'></a>
No, doesn't help. At least not as it is now.



---

archive/issue_comments_477641.json:
```json
{
    "body": "<a id='comment:7'></a>\nAccording to this\n\nhttps://www.noreplied.com/how-to-fixed-cannot-change-locale-utf-8-error-in-centos-7/\n\none should add `LC_CTYPE=\"en_US.UTF-8\"` to `/etc/environment`. Very unsatisfying fix for someone without root privileges.\n\nThis appears to be a bug with centos 7, which is merely exposed now.",
    "created_at": "2020-06-30T19:23:37Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477641",
    "user": "https://github.com/kliem"
}
```

<a id='comment:7'></a>
According to this

https://www.noreplied.com/how-to-fixed-cannot-change-locale-utf-8-error-in-centos-7/

one should add `LC_CTYPE="en_US.UTF-8"` to `/etc/environment`. Very unsatisfying fix for someone without root privileges.

This appears to be a bug with centos 7, which is merely exposed now.



---

archive/issue_comments_477642.json:
```json
{
    "body": "<a id='comment:8'></a>\nJust exporting this environment variable setting in `build/bin/sage-spkg` should be enough. No need for a systemwide setting",
    "created_at": "2020-06-30T19:36:36Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477642",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>
Just exporting this environment variable setting in `build/bin/sage-spkg` should be enough. No need for a systemwide setting



---

archive/issue_comments_477643.json:
```json
{
    "body": "<a id='comment:9'></a>\nOk. Testing this now. https://github.com/kliem/sage/pull/19/checks",
    "created_at": "2020-07-01T15:40:20Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477643",
    "user": "https://github.com/kliem"
}
```

<a id='comment:9'></a>
Ok. Testing this now. https://github.com/kliem/sage/pull/19/checks



---

archive/issue_comments_477644.json:
```json
{
    "body": "<a id='comment:10'></a>\napparently should be fixed by #30053",
    "created_at": "2020-07-05T15:20:58Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477644",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>
apparently should be fixed by #30053



---

archive/issue_events_267960.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-07-23T20:31:26Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30008#event-267960"
}
```



---

archive/issue_events_267961.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-07-23T20:31:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "label": "invalid",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30008#event-267961"
}
```



---

archive/issue_events_267962.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-07-23T20:31:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30008#event-267962"
}
```



---

archive/issue_comments_477645.json:
```json
{
    "body": "<a id='comment:11'></a>\nIt appears that things fixed itself: https://github.com/sagemath/sage/actions/runs/166309975",
    "created_at": "2020-07-23T20:31:26Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477645",
    "user": "https://github.com/kliem"
}
```

<a id='comment:11'></a>
It appears that things fixed itself: https://github.com/sagemath/sage/actions/runs/166309975



---

archive/issue_comments_477646.json:
```json
{
    "body": "<a id='comment:12'></a>\nIn any case, let's take care of all locale issues in #30053.",
    "created_at": "2020-07-23T22:36:15Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477646",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>
In any case, let's take care of all locale issues in #30053.



---

archive/issue_events_267963.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-07-23T22:36:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30008#event-267963"
}
```



---

archive/issue_events_267964.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-07-23T22:36:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30008#event-267964"
}
```



---

archive/issue_comments_477647.json:
```json
{
    "body": "**Reviewer:** Matthias Koeppe",
    "created_at": "2020-07-24T04:49:02Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477647",
    "user": "https://github.com/mkoeppe"
}
```

**Reviewer:** Matthias Koeppe



---

archive/issue_comments_477648.json:
```json
{
    "body": "<a id='comment:14'></a>\nAlso the upgrade to Sphinx 3.1.2 is complete at #30001 and was merged in Sage 9.2.beta5.",
    "created_at": "2020-07-26T17:42:34Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477648",
    "user": "https://github.com/slel"
}
```

<a id='comment:14'></a>
Also the upgrade to Sphinx 3.1.2 is complete at #30001 and was merged in Sage 9.2.beta5.



---

archive/issue_events_267965.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-09-01T23:03:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30008#event-267965"
}
```



---

archive/issue_events_267966.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-09-01T23:03:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30008#event-267966"
}
```



---

archive/issue_events_267967.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-09-01T23:03:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "label": "duplicate",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30008#event-267967"
}
```



---

archive/issue_events_267968.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-21T04:42:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "label": "duplicate",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30008#event-267968"
}
```



---

archive/issue_events_267969.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-21T04:42:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30008#event-267969"
}
```



---

archive/issue_comments_477649.json:
```json
{
    "body": "**Dependencies:** #30053",
    "created_at": "2020-09-21T04:49:28Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477649",
    "user": "https://github.com/mkoeppe"
}
```

**Dependencies:** #30053



---

archive/issue_events_267970.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-21T04:49:28Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "rename": {
        "from": "sphinx 3.0.4 does not build on centos 7",
        "to": "After #30053, sphinx 3.1.2 does not build on ubuntu-trusty, centos-7 (again)"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30008#event-267970"
}
```



---

archive/issue_comments_477650.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,8 @@\n+`sage-system-python` is the Python that we use to download and unpack upstream archives.  We allow a very wide range of Python versions.\n+\n+After #30053 undid the change in #29033, we are again running into locale / encoding problems with early (pre-3.7) versions of Python used as `sage-system-python`.\n+\n+Originally reported on this ticket:\n \n ```\n /sage/build/bin/sage-spkg: line 73: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8): No such file or directory\n@@ -42,3 +47,11 @@\n ```\n \n See e.g. https://github.com/sagemath/sage/runs/811777719?check_suite_focus=true\n+\n+But now (https://github.com/mkoeppe/sage/runs/1141520147) we see it for `ubuntu-trusty-minimal` (where `sage-system-python` is python 3.4).\n+\n+We fix this problem by making locale fixes in the `sage-system-python` script.\n+\n+\n+\n+\n``````\n",
    "created_at": "2020-09-21T04:49:28Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477650",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,8 @@
+`sage-system-python` is the Python that we use to download and unpack upstream archives.  We allow a very wide range of Python versions.
+
+After #30053 undid the change in #29033, we are again running into locale / encoding problems with early (pre-3.7) versions of Python used as `sage-system-python`.
+
+Originally reported on this ticket:
 
 ```
 /sage/build/bin/sage-spkg: line 73: warning: setlocale: LC_ALL: cannot change locale (C.UTF-8): No such file or directory
@@ -42,3 +47,11 @@
 ```
 
 See e.g. https://github.com/sagemath/sage/runs/811777719?check_suite_focus=true
+
+But now (https://github.com/mkoeppe/sage/runs/1141520147) we see it for `ubuntu-trusty-minimal` (where `sage-system-python` is python 3.4).
+
+We fix this problem by making locale fixes in the `sage-system-python` script.
+
+
+
+
``````




---

archive/issue_events_267971.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-21T04:53:39Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "rename": {
        "from": "After #30053, sphinx 3.1.2 does not build on ubuntu-trusty, centos-7 (again)",
        "to": "After #30053, sphinx 3.1.2 does not build on ubuntu-{trusty,xenial,bionic}, debian-jessie, centos-7 (again)"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30008#event-267971"
}
```



---

archive/issue_comments_477651.json:
```json
{
    "body": "**Branch:** [u/mkoeppe/after__30053__sphinx_3_1_2_does_not_build_on_ubuntu__trusty_xenial_bionic___debian_jessie__centos_7__again_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/after__30053__sphinx_3_1_2_does_not_build_on_ubuntu__trusty_xenial_bionic___debian_jessie__centos_7__again_)",
    "created_at": "2020-09-21T05:21:30Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477651",
    "user": "https://github.com/mkoeppe"
}
```

**Branch:** [u/mkoeppe/after__30053__sphinx_3_1_2_does_not_build_on_ubuntu__trusty_xenial_bionic___debian_jessie__centos_7__again_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/after__30053__sphinx_3_1_2_does_not_build_on_ubuntu__trusty_xenial_bionic___debian_jessie__centos_7__again_)



---

archive/issue_comments_477652.json:
```json
{
    "body": "**Commit:** [9403629235ffb078c0eda9a46154d882c62760b2](https://github.com/sagemath/sagetrac-mirror/commit/9403629235ffb078c0eda9a46154d882c62760b2)",
    "created_at": "2020-09-21T05:38:04Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477652",
    "user": "https://github.com/mkoeppe"
}
```

**Commit:** [9403629235ffb078c0eda9a46154d882c62760b2](https://github.com/sagemath/sagetrac-mirror/commit/9403629235ffb078c0eda9a46154d882c62760b2)



---

archive/issue_comments_477653.json:
```json
{
    "body": "**Changing reviewer** from \"Matthias Koeppe\" to \"https://github.com/mkoeppe/sage/actions/runs/264540655\".",
    "created_at": "2020-09-21T05:38:04Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477653",
    "user": "https://github.com/mkoeppe"
}
```

**Changing reviewer** from "Matthias Koeppe" to "https://github.com/mkoeppe/sage/actions/runs/264540655".



---

archive/issue_comments_477654.json:
```json
{
    "body": "**Author:** Matthias Koeppe",
    "created_at": "2020-09-21T05:38:04Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477654",
    "user": "https://github.com/mkoeppe"
}
```

**Author:** Matthias Koeppe



---

archive/issue_comments_477655.json:
```json
{
    "body": "<a id='comment:20'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9403629235ffb078c0eda9a46154d882c62760b2\">9403629</a></td><td><code>build/bin/sage-system-python: Work around LC_ALL=C</code></td></tr></table>\n",
    "created_at": "2020-09-21T05:38:04Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477655",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9403629235ffb078c0eda9a46154d882c62760b2">9403629</a></td><td><code>build/bin/sage-system-python: Work around LC_ALL=C</code></td></tr></table>




---

archive/issue_comments_477656.json:
```json
{
    "body": "<a id='comment:21'></a>\nOn Ubuntu 18.04 + beta12 + #30053 (+ #30606, the other branch I am working on now), I do not confirm this issue for building sphinx: `sage -f sphinx` works correctly. version 3.1.2.p0 to be more precise.",
    "created_at": "2020-09-21T09:26:21Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477656",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:21'></a>
On Ubuntu 18.04 + beta12 + #30053 (+ #30606, the other branch I am working on now), I do not confirm this issue for building sphinx: `sage -f sphinx` works correctly. version 3.1.2.p0 to be more precise.



---

archive/issue_comments_477657.json:
```json
{
    "body": "<a id='comment:22'></a>\nthe error in the ticket description comes from Python 3.6. Is this outdated, in view of #30053, as the locale is staying `C` locale?\n\nWhat is the commit in [comment:20](#comment%3A20) doing? I am lost.",
    "created_at": "2020-09-21T12:44:36Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477657",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:22'></a>
the error in the ticket description comes from Python 3.6. Is this outdated, in view of #30053, as the locale is staying `C` locale?

What is the commit in [comment:20](#comment%3A20) doing? I am lost.



---

archive/issue_comments_477658.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [dimpase](#comment%3A22):\n> the error in the ticket description comes from Python 3.6. Is this outdated, in view of #30053, as the locale is staying `C` locale?\n\n`build/bin/sage-system-python` finds the Python that we use for downloading and unpacking packages. \n\nIt is unrelated to the python that we try to find in `build/pkgs/python3/spkg-configure.m4` (which rejects Python 3.6 after #30053).\n\n`build/bin/sage-system-python` can use any of the Pythons listed in `build/tox.ini`. In particular, it can be an early 3.x series Python. For these, `LC_ALL=C` disables UTF-8 operation, which causes the errors described on this ticket. \n\nLook at the GH Actions links in the ticket description to see it in action.",
    "created_at": "2020-09-21T15:07:26Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477658",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:23'></a>
Replying to [dimpase](#comment%3A22):
> the error in the ticket description comes from Python 3.6. Is this outdated, in view of #30053, as the locale is staying `C` locale?

`build/bin/sage-system-python` finds the Python that we use for downloading and unpacking packages. 

It is unrelated to the python that we try to find in `build/pkgs/python3/spkg-configure.m4` (which rejects Python 3.6 after #30053).

`build/bin/sage-system-python` can use any of the Pythons listed in `build/tox.ini`. In particular, it can be an early 3.x series Python. For these, `LC_ALL=C` disables UTF-8 operation, which causes the errors described on this ticket. 

Look at the GH Actions links in the ticket description to see it in action.



---

archive/issue_comments_477659.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -50,8 +50,7 @@\n \n But now (https://github.com/mkoeppe/sage/runs/1141520147) we see it for `ubuntu-trusty-minimal` (where `sage-system-python` is python 3.4).\n \n-We fix this problem by making locale fixes in the `sage-system-python` script.\n+We fix this problem by making locale fixes in the `sage-system-python` script. See e.g. https://github.com/mkoeppe/sage/runs/1142310012 for a run with the present ticket.\n \n \n \n-\n``````\n",
    "created_at": "2020-09-21T15:10:32Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477659",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -50,8 +50,7 @@
 
 But now (https://github.com/mkoeppe/sage/runs/1141520147) we see it for `ubuntu-trusty-minimal` (where `sage-system-python` is python 3.4).
 
-We fix this problem by making locale fixes in the `sage-system-python` script.
+We fix this problem by making locale fixes in the `sage-system-python` script. See e.g. https://github.com/mkoeppe/sage/runs/1142310012 for a run with the present ticket.
 
 
 
-
``````




---

archive/issue_events_267972.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-21T17:00:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30008#event-267972"
}
```



---

archive/issue_comments_477660.json:
```json
{
    "body": "<a id='comment:25'></a>\nReady for review",
    "created_at": "2020-09-21T17:00:58Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477660",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'></a>
Ready for review



---

archive/issue_comments_477661.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [slabbe](#comment%3A21):\n> On Ubuntu 18.04 + beta12 + #30053 (+ #30606, the other branch I am working on now), I do not confirm this issue for building sphinx: `sage -f sphinx` works correctly. version 3.1.2.p0 to be more precise.\n\nYou probably have a better version of python in the front of the path than what is the default on Ubuntu 18.04. You can check this with `build/bin/sage-system-python --version`.",
    "created_at": "2020-09-21T17:46:50Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477661",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:26'></a>
Replying to [slabbe](#comment%3A21):
> On Ubuntu 18.04 + beta12 + #30053 (+ #30606, the other branch I am working on now), I do not confirm this issue for building sphinx: `sage -f sphinx` works correctly. version 3.1.2.p0 to be more precise.

You probably have a better version of python in the front of the path than what is the default on Ubuntu 18.04. You can check this with `build/bin/sage-system-python --version`.



---

archive/issue_comments_477662.json:
```json
{
    "body": "<a id='comment:27'></a>\nWhy again are we trying to extract a tarball with python?\n\nThe problem here isn't really the `C` locale, it's that Sphinx ships files with non-ascii characters in them...\n\n```\n$ ls tests/roots/test-images/ | tail -n 1\n-rw-r--r-- 1 mjo mjo  65K 2020-08-13 11:46 testim\u00e4ge.png\n```\n\nand we don't specify an encoding, which ultimately leaves it up to the locale.\n\nIgnoring the fact that reimplementing this is absurd, we should be able to set the filename encoding to utf8 here without touching the locale at all.",
    "created_at": "2020-09-21T18:57:17Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477662",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:27'></a>
Why again are we trying to extract a tarball with python?

The problem here isn't really the `C` locale, it's that Sphinx ships files with non-ascii characters in them...

```
$ ls tests/roots/test-images/ | tail -n 1
-rw-r--r-- 1 mjo mjo  65K 2020-08-13 11:46 testimäge.png
```

and we don't specify an encoding, which ultimately leaves it up to the locale.

Ignoring the fact that reimplementing this is absurd, we should be able to set the filename encoding to utf8 here without touching the locale at all.



---

archive/issue_comments_477663.json:
```json
{
    "body": "<a id='comment:28'></a>\nReplying to [mjo](#comment%3A27):\n> Why again are we trying to extract a tarball with python?\n\nThis question is not within the scope of this ticket",
    "created_at": "2020-09-21T19:26:28Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477663",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:28'></a>
Replying to [mjo](#comment%3A27):
> Why again are we trying to extract a tarball with python?

This question is not within the scope of this ticket



---

archive/issue_comments_477664.json:
```json
{
    "body": "<a id='comment:29'></a>\nReplying to [mjo](#comment%3A27):\n> The problem here isn't really the `C` locale\n\nYes, it is specifically the problem with setting the `C` locale explicitly. This is explained well in https://www.python.org/dev/peps/pep-0538/",
    "created_at": "2020-09-21T19:31:14Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477664",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:29'></a>
Replying to [mjo](#comment%3A27):
> The problem here isn't really the `C` locale

Yes, it is specifically the problem with setting the `C` locale explicitly. This is explained well in https://www.python.org/dev/peps/pep-0538/



---

archive/issue_comments_477665.json:
```json
{
    "body": "<a id='comment:30'></a>\nReplying to [mjo](#comment%3A27):\n> we should be able to set the filename encoding to utf8 here without touching the locale at all.\n\nWe are using the `tarfile` module as supplied by the system python.",
    "created_at": "2020-09-21T19:32:24Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477665",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'></a>
Replying to [mjo](#comment%3A27):
> we should be able to set the filename encoding to utf8 here without touching the locale at all.

We are using the `tarfile` module as supplied by the system python.



---

archive/issue_comments_477666.json:
```json
{
    "body": "**Changing reviewer** from \"https://github.com/mkoeppe/sage/actions/runs/264540655\" to \"https://github.com/mkoeppe/sage/actions/runs/264540655, ...\".",
    "created_at": "2020-09-21T19:40:52Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477666",
    "user": "https://github.com/mkoeppe"
}
```

**Changing reviewer** from "https://github.com/mkoeppe/sage/actions/runs/264540655" to "https://github.com/mkoeppe/sage/actions/runs/264540655, ...".



---

archive/issue_comments_477667.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,6 +1,8 @@\n `sage-system-python` is the Python that we use to download and unpack upstream archives.  We allow a very wide range of Python versions.\n \n After #30053 undid the change in #29033, we are again running into locale / encoding problems with early (pre-3.7) versions of Python used as `sage-system-python`.\n+\n+This is a blocker ticket for Sage 9.2 because it is a severe regression in platform support compared to Sage 9.1.\n \n Originally reported on this ticket:\n \n``````\n",
    "created_at": "2020-09-21T19:42:25Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477667",
    "user": "https://github.com/mkoeppe"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,6 +1,8 @@
 `sage-system-python` is the Python that we use to download and unpack upstream archives.  We allow a very wide range of Python versions.
 
 After #30053 undid the change in #29033, we are again running into locale / encoding problems with early (pre-3.7) versions of Python used as `sage-system-python`.
+
+This is a blocker ticket for Sage 9.2 because it is a severe regression in platform support compared to Sage 9.1.
 
 Originally reported on this ticket:
 
``````




---

archive/issue_comments_477668.json:
```json
{
    "body": "<a id='comment:33'></a>\nI'm not willing to install a version of python from 2014 to test it, but setting `tarfile.ENCODING = 'utf-8'` probably solves this in a much better way, since we know what the encoding is.",
    "created_at": "2020-09-21T19:47:22Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477668",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:33'></a>
I'm not willing to install a version of python from 2014 to test it, but setting `tarfile.ENCODING = 'utf-8'` probably solves this in a much better way, since we know what the encoding is.



---

archive/issue_comments_477669.json:
```json
{
    "body": "<a id='comment:34'></a>\nReplying to [mjo](#comment%3A33):\n> I'm not willing to install a version of python from 2014 to test it\n\nYou don't have to. We have the GH Actions to test it. The link with the runs and results is in the \"Reviewer field\".",
    "created_at": "2020-09-21T20:03:02Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477669",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'></a>
Replying to [mjo](#comment%3A33):
> I'm not willing to install a version of python from 2014 to test it

You don't have to. We have the GH Actions to test it. The link with the runs and results is in the "Reviewer field".



---

archive/issue_comments_477670.json:
```json
{
    "body": "<a id='comment:35'></a>\nReplying to [mjo](#comment%3A33):\n> setting `tarfile.ENCODING = 'utf-8'` probably solves this in a much better way, since we know what the encoding is.\n\nNo, that is absolutely not the correct fix because the default (obtained using `sys.getfilesystemencoding()` or `sys.getdefaultencoding()`) is correct. See https://docs.python.org/2.6/library/tarfile.html#tar-unicode (Python 2.6 is the earliest version that we support for `sage-system-python`).\n\nThe specific problem is that if someone puts a `LC_ALL=C`, the default encodings are set to ASCII. This is what causes the breakage, and this is what the current ticket fixes.\n\nNeeds review.",
    "created_at": "2020-09-21T20:08:22Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477670",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:35'></a>
Replying to [mjo](#comment%3A33):
> setting `tarfile.ENCODING = 'utf-8'` probably solves this in a much better way, since we know what the encoding is.

No, that is absolutely not the correct fix because the default (obtained using `sys.getfilesystemencoding()` or `sys.getdefaultencoding()`) is correct. See https://docs.python.org/2.6/library/tarfile.html#tar-unicode (Python 2.6 is the earliest version that we support for `sage-system-python`).

The specific problem is that if someone puts a `LC_ALL=C`, the default encodings are set to ASCII. This is what causes the breakage, and this is what the current ticket fixes.

Needs review.



---

archive/issue_comments_477671.json:
```json
{
    "body": "<a id='comment:36'></a>\nSetting the locale to `C` causes the default guess to be wrong, but we *know* the correct encoding. And the `utf-8` encoding is available \"everywhere,\" unlike the locales that we're guessing at in your branch. Finally, changing the system locale to affect one tarfile is like setting your house on fire to stop the faucet from leaking.",
    "created_at": "2020-09-21T20:19:40Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477671",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:36'></a>
Setting the locale to `C` causes the default guess to be wrong, but we *know* the correct encoding. And the `utf-8` encoding is available "everywhere," unlike the locales that we're guessing at in your branch. Finally, changing the system locale to affect one tarfile is like setting your house on fire to stop the faucet from leaking.



---

archive/issue_comments_477672.json:
```json
{
    "body": "<a id='comment:37'></a>\nReplying to [mjo](#comment%3A36):\n> Finally, changing the system locale to affect one tarfile is like [...]\n\nIt is very localized, and it undoes the damage done by #30053's `sage-spkg` doing exactly what you seem to be criticizing here - namely setting the system locale for all its subprocesses.",
    "created_at": "2020-09-21T20:48:37Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477672",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:37'></a>
Replying to [mjo](#comment%3A36):
> Finally, changing the system locale to affect one tarfile is like [...]

It is very localized, and it undoes the damage done by #30053's `sage-spkg` doing exactly what you seem to be criticizing here - namely setting the system locale for all its subprocesses.



---

archive/issue_comments_477673.json:
```json
{
    "body": "<a id='comment:38'></a>\nReplying to [mjo](#comment%3A36):\n> we *know* the correct encoding. \n\nThis is of course a good point. We can just decide that our tarballs have utf-8 pathnames.  I will test the approach with setting `tarfile.ENCODING`.\n\nNevertheless, removing the `C` locale setting in `sage-system-python` would still be good because there could be other parts that are affected by this unsuitable setting.",
    "created_at": "2020-09-21T20:59:04Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477673",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:38'></a>
Replying to [mjo](#comment%3A36):
> we *know* the correct encoding. 

This is of course a good point. We can just decide that our tarballs have utf-8 pathnames.  I will test the approach with setting `tarfile.ENCODING`.

Nevertheless, removing the `C` locale setting in `sage-system-python` would still be good because there could be other parts that are affected by this unsuitable setting.



---

archive/issue_events_267973.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-21T20:59:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30008#event-267973"
}
```



---

archive/issue_events_267974.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-21T20:59:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30008#event-267974"
}
```



---

archive/issue_comments_477674.json:
```json
{
    "body": "<a id='comment:40'></a>\nAnd #30053 just put things back the way they were before we tried to switch to `C.UTF-8`. We need to set *some* locale, because otherwise the behavior of standard utilities in spkg-install and spkg-check scripts is unknowable. For example, this branch can choose the `en_US.utf8` locale. How do grep ranges work there? According to https://www.gnu.org/software/grep/manual/html_node/Character-Classes-and-Bracket-Expressions.html,\n\n> In the default C locale, the sorting sequence is the native character order; for example, \u2018[a-d]\u2019 is equivalent to \u2018[abcd]\u2019. In other locales, the sorting sequence is not specified, and \u2018[a-d]\u2019 might be equivalent to \u2018[abcd]\u2019 or to \u2018[aBbCcDd]\u2019, or it might fail to match any character, or the set of characters that it matches might even be erratic. To obtain the traditional interpretation of bracket expressions, you can use the \u2018C\u2019 locale by setting the LC_ALL environment variable to the value \u2018C\u2019.\n\nMucking with this is bad luck.",
    "created_at": "2020-09-21T21:05:29Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477674",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:40'></a>
And #30053 just put things back the way they were before we tried to switch to `C.UTF-8`. We need to set *some* locale, because otherwise the behavior of standard utilities in spkg-install and spkg-check scripts is unknowable. For example, this branch can choose the `en_US.utf8` locale. How do grep ranges work there? According to https://www.gnu.org/software/grep/manual/html_node/Character-Classes-and-Bracket-Expressions.html,

> In the default C locale, the sorting sequence is the native character order; for example, ‘[a-d]’ is equivalent to ‘[abcd]’. In other locales, the sorting sequence is not specified, and ‘[a-d]’ might be equivalent to ‘[abcd]’ or to ‘[aBbCcDd]’, or it might fail to match any character, or the set of characters that it matches might even be erratic. To obtain the traditional interpretation of bracket expressions, you can use the ‘C’ locale by setting the LC_ALL environment variable to the value ‘C’.

Mucking with this is bad luck.



---

archive/issue_comments_477675.json:
```json
{
    "body": "<a id='comment:41'></a>\nReplying to [mjo](#comment%3A40):\n> And #30053 just put things back the way they were before we tried to switch to `C.UTF-8`.\n\nYes, it was a good change for that ticket, which is why I agreed with the change there.\n\nBut it affects the Pythons that run below it.\n(1) the `sage-system-python` - which the present ticket addresses\n(2) the python3 from which we build our venv -- which is yet to be addressed in #30576 if we want to support python 3.6.",
    "created_at": "2020-09-21T21:20:37Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477675",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:41'></a>
Replying to [mjo](#comment%3A40):
> And #30053 just put things back the way they were before we tried to switch to `C.UTF-8`.

Yes, it was a good change for that ticket, which is why I agreed with the change there.

But it affects the Pythons that run below it.
(1) the `sage-system-python` - which the present ticket addresses
(2) the python3 from which we build our venv -- which is yet to be addressed in #30576 if we want to support python 3.6.



---

archive/issue_comments_477676.json:
```json
{
    "body": "<a id='comment:42'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ff0dbc622b8b3f4ce467a0324c3fdbd134df24e3\">ff0dbc6</a></td><td><code>build/sage_bootstrap/uncompress/tar_file.py: Fix encoding to utf-8</code></td></tr></table>\n",
    "created_at": "2020-09-21T21:28:43Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477676",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:42'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ff0dbc622b8b3f4ce467a0324c3fdbd134df24e3">ff0dbc6</a></td><td><code>build/sage_bootstrap/uncompress/tar_file.py: Fix encoding to utf-8</code></td></tr></table>




---

archive/issue_comments_477677.json:
```json
{
    "body": "**Changing commit** from \"[9403629235ffb078c0eda9a46154d882c62760b2](https://github.com/sagemath/sagetrac-mirror/commit/9403629235ffb078c0eda9a46154d882c62760b2)\" to \"[ff0dbc622b8b3f4ce467a0324c3fdbd134df24e3](https://github.com/sagemath/sagetrac-mirror/commit/ff0dbc622b8b3f4ce467a0324c3fdbd134df24e3)\".",
    "created_at": "2020-09-21T21:28:43Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477677",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[9403629235ffb078c0eda9a46154d882c62760b2](https://github.com/sagemath/sagetrac-mirror/commit/9403629235ffb078c0eda9a46154d882c62760b2)" to "[ff0dbc622b8b3f4ce467a0324c3fdbd134df24e3](https://github.com/sagemath/sagetrac-mirror/commit/ff0dbc622b8b3f4ce467a0324c3fdbd134df24e3)".



---

archive/issue_events_267975.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-21T21:41:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30008#event-267975"
}
```



---

archive/issue_events_267976.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-21T21:41:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30008#event-267976"
}
```



---

archive/issue_comments_477678.json:
```json
{
    "body": "**Changing reviewer** from \"https://github.com/mkoeppe/sage/actions/runs/264540655, ...\" to \"https://github.com/mkoeppe/sage/actions/runs/265853210, ...\".",
    "created_at": "2020-09-21T21:41:16Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477678",
    "user": "https://github.com/mkoeppe"
}
```

**Changing reviewer** from "https://github.com/mkoeppe/sage/actions/runs/264540655, ..." to "https://github.com/mkoeppe/sage/actions/runs/265853210, ...".



---

archive/issue_comments_477679.json:
```json
{
    "body": "**Changing reviewer** from \"https://github.com/mkoeppe/sage/actions/runs/265853210, ...\" to \"https://github.com/mkoeppe/sage/actions/runs/265872338, ...\".",
    "created_at": "2020-09-21T21:55:27Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477679",
    "user": "https://github.com/mkoeppe"
}
```

**Changing reviewer** from "https://github.com/mkoeppe/sage/actions/runs/265853210, ..." to "https://github.com/mkoeppe/sage/actions/runs/265872338, ...".



---

archive/issue_comments_477680.json:
```json
{
    "body": "<a id='comment:45'></a>\nNeeds review.",
    "created_at": "2020-09-22T13:57:40Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477680",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:45'></a>
Needs review.



---

archive/issue_comments_477681.json:
```json
{
    "body": "<a id='comment:46'></a>\nReplying to [mkoeppe](#comment%3A26):\n> You probably have a better version of python in the front of the path than what is the default on Ubuntu 18.04. You can check this with `build/bin/sage-system-python --version`.\n\nI have:\n\n```\n$ build/bin/sage-system-python --version\nPython 2.7.17\n```\n\nI don't know how to properly review this ticket. With ubuntu-bionic 18.04, I do not have problem. So what I can do is to check that with the branch, I still don't have a problem. Should I do some kind of make distclean? For now, I just pulled that branch on top of freshly built beta13, and I am currently running make ptestlong. Will report later.",
    "created_at": "2020-09-22T20:05:56Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477681",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:46'></a>
Replying to [mkoeppe](#comment%3A26):
> You probably have a better version of python in the front of the path than what is the default on Ubuntu 18.04. You can check this with `build/bin/sage-system-python --version`.

I have:

```
$ build/bin/sage-system-python --version
Python 2.7.17
```

I don't know how to properly review this ticket. With ubuntu-bionic 18.04, I do not have problem. So what I can do is to check that with the branch, I still don't have a problem. Should I do some kind of make distclean? For now, I just pulled that branch on top of freshly built beta13, and I am currently running make ptestlong. Will report later.



---

archive/issue_comments_477682.json:
```json
{
    "body": "<a id='comment:47'></a>\nThe tests have already run on GH Actions. It is not necessary to run them again to review this ticket.",
    "created_at": "2020-09-22T20:18:05Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477682",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:47'></a>
The tests have already run on GH Actions. It is not necessary to run them again to review this ticket.



---

archive/issue_comments_477683.json:
```json
{
    "body": "<a id='comment:48'></a>\nThe problem shows on machines where sage-system-python is python 3.x with x < 7.\n\nIt's probably not a good idea to try to uninstall python2 to review this ticket, but you could try to shadow it",
    "created_at": "2020-09-22T20:20:07Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477683",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:48'></a>
The problem shows on machines where sage-system-python is python 3.x with x < 7.

It's probably not a good idea to try to uninstall python2 to review this ticket, but you could try to shadow it



---

archive/issue_comments_477684.json:
```json
{
    "body": "<a id='comment:49'></a>\nReplying to [mkoeppe](#comment%3A48):\n> you could try to shadow it \n\ntell me how to shadow, I will try that tomorrow. How can I make `sage-system-python` to use:\n\n```\n$ which python3.6\n/usr/bin/python3.6\n```\n?",
    "created_at": "2020-09-22T20:58:40Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477684",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:49'></a>
Replying to [mkoeppe](#comment%3A48):
> you could try to shadow it 

tell me how to shadow, I will try that tomorrow. How can I make `sage-system-python` to use:

```
$ which python3.6
/usr/bin/python3.6
```
?



---

archive/issue_comments_477685.json:
```json
{
    "body": "<a id='comment:50'></a>\n\n```\nmkdir /somewhere && ln -s /usr/bin/python3.6 /somewhere/python \nexport PATH=/somewhere:$PATH\n```",
    "created_at": "2020-09-22T22:36:09Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477685",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:50'></a>

```
mkdir /somewhere && ln -s /usr/bin/python3.6 /somewhere/python 
export PATH=/somewhere:$PATH
```



---

archive/issue_comments_477686.json:
```json
{
    "body": "<a id='comment:51'></a>\nDoesn't the tarball commit alone fix issue without the locale voodoo?",
    "created_at": "2020-09-23T01:07:44Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477686",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:51'></a>
Doesn't the tarball commit alone fix issue without the locale voodoo?



---

archive/issue_comments_477687.json:
```json
{
    "body": "<a id='comment:52'></a>\nIt does fix the issue, but it is best not to pass a locale to python 3.6 that we know to break things.",
    "created_at": "2020-09-23T01:09:37Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477687",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:52'></a>
It does fix the issue, but it is best not to pass a locale to python 3.6 that we know to break things.



---

archive/issue_events_267977.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-09-23T06:34:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30008#event-267977"
}
```



---

archive/issue_events_267978.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-09-23T06:34:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30008#event-267978"
}
```



---

archive/issue_comments_477688.json:
```json
{
    "body": "<a id='comment:53'></a>\nSeems to work fine and looks good to me.",
    "created_at": "2020-09-23T06:34:39Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477688",
    "user": "https://github.com/kliem"
}
```

<a id='comment:53'></a>
Seems to work fine and looks good to me.



---

archive/issue_comments_477689.json:
```json
{
    "body": "**Changing reviewer** from \"https://github.com/mkoeppe/sage/actions/runs/265872338, ...\" to \"Jonathan Kliem\".",
    "created_at": "2020-09-23T06:34:39Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477689",
    "user": "https://github.com/kliem"
}
```

**Changing reviewer** from "https://github.com/mkoeppe/sage/actions/runs/265872338, ..." to "Jonathan Kliem".



---

archive/issue_comments_477690.json:
```json
{
    "body": "<a id='comment:54'></a>\nReplying to [mkoeppe](#comment%3A50):\n> \n> ```\n> mkdir /somewhere && ln -s /usr/bin/python3.6 /somewhere/python \n> export PATH=/somewhere:$PATH\n> ```\n> \n\nIndeed, the above shadowing method works:\n\n```\n$ build/bin/sage-system-python --version\nPython 3.6.9\n```\nI can now reproduce the issue with Ubuntu 18.04 + 9.2.beta13 and I confirm that the current branch fixes it.",
    "created_at": "2020-09-23T10:03:23Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477690",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:54'></a>
Replying to [mkoeppe](#comment%3A50):
> 
> ```
> mkdir /somewhere && ln -s /usr/bin/python3.6 /somewhere/python 
> export PATH=/somewhere:$PATH
> ```
> 

Indeed, the above shadowing method works:

```
$ build/bin/sage-system-python --version
Python 3.6.9
```
I can now reproduce the issue with Ubuntu 18.04 + 9.2.beta13 and I confirm that the current branch fixes it.



---

archive/issue_comments_477691.json:
```json
{
    "body": "**Changing reviewer** from \"Jonathan Kliem\" to \"Jonathan Kliem, S\u00e9bastien Labb\u00e9\".",
    "created_at": "2020-09-23T10:03:23Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477691",
    "user": "https://github.com/seblabbe"
}
```

**Changing reviewer** from "Jonathan Kliem" to "Jonathan Kliem, Sébastien Labbé".



---

archive/issue_comments_477692.json:
```json
{
    "body": "<a id='comment:55'></a>\nThanks everyone!",
    "created_at": "2020-09-23T11:57:07Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477692",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:55'></a>
Thanks everyone!



---

archive/issue_comments_477693.json:
```json
{
    "body": "**Changing branch** from \"[u/mkoeppe/after__30053__sphinx_3_1_2_does_not_build_on_ubuntu__trusty_xenial_bionic___debian_jessie__centos_7__again_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/after__30053__sphinx_3_1_2_does_not_build_on_ubuntu__trusty_xenial_bionic___debian_jessie__centos_7__again_)\" to \"[ff0dbc622b8b3f4ce467a0324c3fdbd134df24e3](https://github.com/sagemath/sagetrac-mirror/commit/ff0dbc622b8b3f4ce467a0324c3fdbd134df24e3)\".",
    "created_at": "2020-09-27T09:10:05Z",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30008#issuecomment-477693",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/mkoeppe/after__30053__sphinx_3_1_2_does_not_build_on_ubuntu__trusty_xenial_bionic___debian_jessie__centos_7__again_](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/after__30053__sphinx_3_1_2_does_not_build_on_ubuntu__trusty_xenial_bionic___debian_jessie__centos_7__again_)" to "[ff0dbc622b8b3f4ce467a0324c3fdbd134df24e3](https://github.com/sagemath/sagetrac-mirror/commit/ff0dbc622b8b3f4ce467a0324c3fdbd134df24e3)".



---

archive/issue_events_267979.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-09-27T09:10:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30008#event-267979"
}
```



---

archive/issue_events_267980.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "af71febd648d698376ede3da75a6e417665da3dd",
    "created_at": "2020-09-27T09:10:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/30008",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30008#event-267980"
}
```
