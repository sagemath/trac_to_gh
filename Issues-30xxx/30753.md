# Issue 30753: Further improvements in method subgraph

archive/issues_030516.json:
```json
{
    "body": "We add a fast method `subgraph_given_vertices` to `CGraphBackend`. This method allows fast subgraph creation including copying.\nAlso improvements in `subgraph` with a case forgotten in #30510.\n\nBefore #30665:\n\n```\nsage: G = graphs.Grid2dGraph(100, 100)  # dynamic sparse                                                                                                                            \nsage: V = list(G)                                                                                                                                                                   \nsage: %timeit H = G.subgraph(V[:50], algorithm='add')                                                                                                                               \n280 \u00b5s \u00b1 465 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\nsage: %timeit H = G.copy()                                                                                                                                                          \n30.3 ms \u00b1 72.8 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\n                                                                                                                                                                              \nsage: G = G.copy(immutable=True)  # static sparse                                                                                                                                   \nsage: %timeit H = G.subgraph(V[:50], algorithm='add')                                                                                                                               \n553 \u00b5s \u00b1 373 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\nsage: %timeit H = G.copy(immutable=False)                                                                                                                                           \n31.6 ms \u00b1 91.6 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\n                                                                                                                                                                               \nsage: G = graphs.CompleteGraph(1000)  # dynamic dense                                                                                                                               \nsage: V = list(G)                                                                                                                                                                   \nsage: %timeit H = G.subgraph(V[:50], algorithm='add')                                                                                                                               \n54.2 ms \u00b1 54.6 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\nsage: %timeit H = G.copy()                                                                                                                                                          \n527 ms \u00b1 663 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\n```\n\nWith #30665 and #30769:\n\n```\nsage: G = graphs.Grid2dGraph(100, 100)  # dynamic sparse                                                                                                                                                                                                                                                                                                                   \nsage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          \nsage: %timeit H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                      \n257 \u00b5s \u00b1 356 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\nsage: %timeit H = G.copy()                                                                                                                                                                                                                                                                                                                                                 \n26.4 ms \u00b1 146 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\n                                                                                                                                                                                                                                                                                                                                                                     \nsage: G = G.copy(immutable=True)  # static sparse                                                                                                                                                                                                                                                                                                                          \nsage: %timeit H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                      \n521 \u00b5s \u00b1 308 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\nsage: %timeit H = G.copy(immutable=False)                                                                                                                                                                                                                                                                                                                                  \n28.3 ms \u00b1 95.2 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\n\nsage: G = graphs.CompleteGraph(1000)  # dynamic dense                                                                                                                                                                                                                                                                                                                      \nsage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          \nsage: %timeit H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                      \n51.6 ms \u00b1 64.6 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\nsage: %timeit H = G.copy()                                                                                                                                                                                                                                                                                                                                                 \n429 ms \u00b1 1.23 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\n```\n\nWith this ticket:\n\n```\nsage: G = graphs.Grid2dGraph(100, 100)  # dynamic sparse                                                                                                                                                                                                                                                                                                                                     \nsage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          \nsage: %timeit H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                      \n80.9 \u00b5s \u00b1 19.1 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\nsage: %timeit H = G.copy()                                                                                                                                                                                                                                                                                                                                                 \n15.4 ms \u00b1 10.4 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n\nsage: G = G.copy(immutable=True)  # static sparse                                                                                                                                                                                                                                                                                                                                           \nsage: %timeit H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                      \n327 \u00b5s \u00b1 1.04 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\nsage: %timeit H = G.copy(immutable=False)                                                                                                                                                                                                                                                                                                                                  \n20.3 ms \u00b1 23 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\n\nsage: G = graphs.CompleteGraph(1000)  # dynamic dense                                                                                                                                                                                                                                                                                                                             \nsage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          \nsage: %timeit H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                      \n1.03 ms \u00b1 10.6 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\nsage: %timeit H = G.copy()                                                                                                                                                                                                                                                                                                                                                 \n269 ms \u00b1 3.08 ms per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\n```\n\nCC:  @kliem\n\nBranch/Commit: 40bacf03c0633affd490bac998856618879ba271\n\nReviewer: David Coudert\n\nAuthor: David Coudert, Jonathan Kliem\n\nDependencies: #30665, #30769\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30753\n\n",
    "closed_at": "2020-11-07T16:23:58Z",
    "created_at": "2020-10-11T12:25:56Z",
    "labels": [
        "component: graph theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Further improvements in method subgraph",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30753",
    "user": "https://github.com/dcoudert"
}
```
We add a fast method `subgraph_given_vertices` to `CGraphBackend`. This method allows fast subgraph creation including copying.
Also improvements in `subgraph` with a case forgotten in #30510.

Before #30665:

```
sage: G = graphs.Grid2dGraph(100, 100)  # dynamic sparse                                                                                                                            
sage: V = list(G)                                                                                                                                                                   
sage: %timeit H = G.subgraph(V[:50], algorithm='add')                                                                                                                               
280 µs ± 465 ns per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit H = G.copy()                                                                                                                                                          
30.3 ms ± 72.8 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
                                                                                                                                                                              
sage: G = G.copy(immutable=True)  # static sparse                                                                                                                                   
sage: %timeit H = G.subgraph(V[:50], algorithm='add')                                                                                                                               
553 µs ± 373 ns per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit H = G.copy(immutable=False)                                                                                                                                           
31.6 ms ± 91.6 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
                                                                                                                                                                               
sage: G = graphs.CompleteGraph(1000)  # dynamic dense                                                                                                                               
sage: V = list(G)                                                                                                                                                                   
sage: %timeit H = G.subgraph(V[:50], algorithm='add')                                                                                                                               
54.2 ms ± 54.6 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
sage: %timeit H = G.copy()                                                                                                                                                          
527 ms ± 663 µs per loop (mean ± std. dev. of 7 runs, 1 loop each)
```

With #30665 and #30769:

```
sage: G = graphs.Grid2dGraph(100, 100)  # dynamic sparse                                                                                                                                                                                                                                                                                                                   
sage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          
sage: %timeit H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                      
257 µs ± 356 ns per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit H = G.copy()                                                                                                                                                                                                                                                                                                                                                 
26.4 ms ± 146 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
                                                                                                                                                                                                                                                                                                                                                                     
sage: G = G.copy(immutable=True)  # static sparse                                                                                                                                                                                                                                                                                                                          
sage: %timeit H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                      
521 µs ± 308 ns per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit H = G.copy(immutable=False)                                                                                                                                                                                                                                                                                                                                  
28.3 ms ± 95.2 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)

sage: G = graphs.CompleteGraph(1000)  # dynamic dense                                                                                                                                                                                                                                                                                                                      
sage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          
sage: %timeit H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                      
51.6 ms ± 64.6 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
sage: %timeit H = G.copy()                                                                                                                                                                                                                                                                                                                                                 
429 ms ± 1.23 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
```

With this ticket:

```
sage: G = graphs.Grid2dGraph(100, 100)  # dynamic sparse                                                                                                                                                                                                                                                                                                                                     
sage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          
sage: %timeit H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                      
80.9 µs ± 19.1 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit H = G.copy()                                                                                                                                                                                                                                                                                                                                                 
15.4 ms ± 10.4 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)

sage: G = G.copy(immutable=True)  # static sparse                                                                                                                                                                                                                                                                                                                                           
sage: %timeit H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                      
327 µs ± 1.04 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit H = G.copy(immutable=False)                                                                                                                                                                                                                                                                                                                                  
20.3 ms ± 23 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)

sage: G = graphs.CompleteGraph(1000)  # dynamic dense                                                                                                                                                                                                                                                                                                                             
sage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          
sage: %timeit H = G.subgraph(V[:50], algorithm='add')                                                                                                                                                                                                                                                                                                                      
1.03 ms ± 10.6 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit H = G.copy()                                                                                                                                                                                                                                                                                                                                                 
269 ms ± 3.08 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
```

CC:  @kliem

Branch/Commit: 40bacf03c0633affd490bac998856618879ba271

Reviewer: David Coudert

Author: David Coudert, Jonathan Kliem

Dependencies: #30665, #30769

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/30753





---

archive/issue_comments_435268.json:
```json
{
    "body": "<a id='comment:1'></a>I'm not sure if the threshold for selecting default algorithm is still best possible. At least, we have improved both algorithms.\n\n---\nNew commits:",
    "created_at": "2020-10-11T12:29:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435268",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:1'></a>I'm not sure if the threshold for selecting default algorithm is still best possible. At least, we have improved both algorithms.

---
New commits:



---

archive/issue_comments_435269.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-10-11T12:29:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435269",
    "user": "https://github.com/dcoudert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_435270.json:
```json
{
    "body": "<a id='comment:3'></a>Currently, the default algorithm is `'delete'` if the number of vertices of the subgraph is at least 5% of the number of vertices of the graph. But following tests suggest that `'add'` is faster when the number of vertices of the subgraph is up to 90%... so we should change the threshold to e.g. 90%. Do you agree ?\n\n```\nsage: G = graphs.Grid2dGraph(100, 100)\nsage: V = list(G)\nsage: %timeit H = G.subgraph(V[:50], algorithm=None)   # use add\n219 \u00b5s \u00b1 7.56 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\nsage: %timeit H = G.subgraph(V[:50], algorithm='add')\n213 \u00b5s \u00b1 10.9 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\nsage: %timeit H = G.subgraph(V[:50], algorithm='delete')\n62.3 ms \u00b1 1.64 ms per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\n\nsage: %timeit H = G.subgraph(V[:500], algorithm=None)  # use add\n1.85 ms \u00b1 35.4 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\nsage: %timeit H = G.subgraph(V[:500], algorithm='add')\n1.99 ms \u00b1 70.7 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\nsage: %timeit H = G.subgraph(V[:500], algorithm='delete')\n64 ms \u00b1 1.14 ms per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\n\nsage: %timeit H = G.subgraph(V[:5000], algorithm=None)  # use delete but add is faster here\n53 ms \u00b1 1.1 ms per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\nsage: %timeit H = G.subgraph(V[:5000], algorithm='add')\n23.7 ms \u00b1 229 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\nsage: %timeit H = G.subgraph(V[:5000], algorithm='delete')\n52.3 ms \u00b1 636 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\n```\n\n```\nsage: G = graphs.CompleteGraph(1000)                                                                                                \nsage: V = list(G)                                                                                                                   \nsage: %timeit H = G.subgraph(V[:50], algorithm=None)  # use 'add'\n17.9 ms \u00b1 408 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\nsage: %timeit H = G.subgraph(V[:50], algorithm='add')\n19.5 ms \u00b1 441 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\nsage: %timeit H = G.subgraph(V[:50], algorithm='delete')\n962 ms \u00b1 14.9 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\n\nsage: %timeit H = G.subgraph(V[:100], algorithm=None)  # use 'delete' but 'add' is faster\n962 ms \u00b1 20.5 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\nsage: %timeit H = G.subgraph(V[:100], algorithm='add')\n38 ms \u00b1 828 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\nsage: %timeit H = G.subgraph(V[:100], algorithm='delete')\n959 ms \u00b1 18.3 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\n\nsage: %timeit H = G.subgraph(V[:500], algorithm=None)  # use 'delete' but 'add' is faster\n949 ms \u00b1 18.1 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\nsage: %timeit H = G.subgraph(V[:500], algorithm='add')\n283 ms \u00b1 15.3 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\nsage: %timeit H = G.subgraph(V[:100], algorithm='delete')\n982 ms \u00b1 32.2 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\n\nsage: %timeit H = G.subgraph(V[:800], algorithm=None)  # use 'delete' but 'add' is faster\n918 ms \u00b1 35.2 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\nsage: %timeit H = G.subgraph(V[:800], algorithm='add')\n643 ms \u00b1 19.4 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\nsage: %timeit H = G.subgraph(V[:800], algorithm='delete')\n909 ms \u00b1 35.6 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\n\nsage: %timeit H = G.subgraph(V[:900], algorithm=None)  # use 'delete' but 'add' is faster\n862 ms \u00b1 19.1 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\nsage: %timeit H = G.subgraph(V[:900], algorithm='add')\n735 ms \u00b1 16.7 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\n```",
    "created_at": "2020-10-11T12:57:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435270",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:3'></a>Currently, the default algorithm is `'delete'` if the number of vertices of the subgraph is at least 5% of the number of vertices of the graph. But following tests suggest that `'add'` is faster when the number of vertices of the subgraph is up to 90%... so we should change the threshold to e.g. 90%. Do you agree ?

```
sage: G = graphs.Grid2dGraph(100, 100)
sage: V = list(G)
sage: %timeit H = G.subgraph(V[:50], algorithm=None)   # use add
219 µs ± 7.56 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit H = G.subgraph(V[:50], algorithm='add')
213 µs ± 10.9 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit H = G.subgraph(V[:50], algorithm='delete')
62.3 ms ± 1.64 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)

sage: %timeit H = G.subgraph(V[:500], algorithm=None)  # use add
1.85 ms ± 35.4 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit H = G.subgraph(V[:500], algorithm='add')
1.99 ms ± 70.7 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit H = G.subgraph(V[:500], algorithm='delete')
64 ms ± 1.14 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)

sage: %timeit H = G.subgraph(V[:5000], algorithm=None)  # use delete but add is faster here
53 ms ± 1.1 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
sage: %timeit H = G.subgraph(V[:5000], algorithm='add')
23.7 ms ± 229 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
sage: %timeit H = G.subgraph(V[:5000], algorithm='delete')
52.3 ms ± 636 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
```

```
sage: G = graphs.CompleteGraph(1000)                                                                                                
sage: V = list(G)                                                                                                                   
sage: %timeit H = G.subgraph(V[:50], algorithm=None)  # use 'add'
17.9 ms ± 408 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: %timeit H = G.subgraph(V[:50], algorithm='add')
19.5 ms ± 441 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: %timeit H = G.subgraph(V[:50], algorithm='delete')
962 ms ± 14.9 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)

sage: %timeit H = G.subgraph(V[:100], algorithm=None)  # use 'delete' but 'add' is faster
962 ms ± 20.5 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
sage: %timeit H = G.subgraph(V[:100], algorithm='add')
38 ms ± 828 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
sage: %timeit H = G.subgraph(V[:100], algorithm='delete')
959 ms ± 18.3 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)

sage: %timeit H = G.subgraph(V[:500], algorithm=None)  # use 'delete' but 'add' is faster
949 ms ± 18.1 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
sage: %timeit H = G.subgraph(V[:500], algorithm='add')
283 ms ± 15.3 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
sage: %timeit H = G.subgraph(V[:100], algorithm='delete')
982 ms ± 32.2 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)

sage: %timeit H = G.subgraph(V[:800], algorithm=None)  # use 'delete' but 'add' is faster
918 ms ± 35.2 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
sage: %timeit H = G.subgraph(V[:800], algorithm='add')
643 ms ± 19.4 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
sage: %timeit H = G.subgraph(V[:800], algorithm='delete')
909 ms ± 35.6 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)

sage: %timeit H = G.subgraph(V[:900], algorithm=None)  # use 'delete' but 'add' is faster
862 ms ± 19.1 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
sage: %timeit H = G.subgraph(V[:900], algorithm='add')
735 ms ± 16.7 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
```



---

archive/issue_comments_435271.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-10-11T16:45:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435271",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435272.json:
```json
{
    "body": "<a id='comment:5'></a>I change the threshold for default algorithm to use use `'delete'` when the subgraph has at least 90% of the vertices and `'add'` otherwise. It seems faster this way. I updated some doctests (mostly changes in orderings).",
    "created_at": "2020-10-11T16:48:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435272",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:5'></a>I change the threshold for default algorithm to use use `'delete'` when the subgraph has at least 90% of the vertices and `'add'` otherwise. It seems faster this way. I updated some doctests (mostly changes in orderings).



---

archive/issue_comments_435273.json:
```json
{
    "body": "<a id='comment:6'></a>The example in this ticket might imply, that #30665 should be put back onto needs work.\n\nI see a huge slowdown.",
    "created_at": "2020-10-12T06:41:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435273",
    "user": "https://github.com/kliem"
}
```

<a id='comment:6'></a>The example in this ticket might imply, that #30665 should be put back onto needs work.

I see a huge slowdown.



---

archive/issue_comments_435274.json:
```json
{
    "body": "<a id='comment:7'></a>OK, so may be we should wait for the finalization of #30665 before changing the threshold.",
    "created_at": "2020-10-12T07:07:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435274",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:7'></a>OK, so may be we should wait for the finalization of #30665 before changing the threshold.



---

archive/issue_comments_435275.json:
```json
{
    "body": "<a id='comment:8'></a>I think I'm done with #30665.\n\nHowever, I could open another ticket and implement a subgraph iterator in the backend:\nGiven a list of vertices, iterate over all edges in the induced subgraph. This should be much faster.",
    "created_at": "2020-10-12T07:50:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435275",
    "user": "https://github.com/kliem"
}
```

<a id='comment:8'></a>I think I'm done with #30665.

However, I could open another ticket and implement a subgraph iterator in the backend:
Given a list of vertices, iterate over all edges in the induced subgraph. This should be much faster.



---

archive/issue_comments_435276.json:
```json
{
    "body": "<a id='comment:9'></a>We can give it a try, at least for simple cases.\nYou can either do it here (the branch is public) or in a separate ticket but it might be harder to ensure that all changes are consistent (i.e., improve the situation).",
    "created_at": "2020-10-12T08:57:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435276",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:9'></a>We can give it a try, at least for simple cases.
You can either do it here (the branch is public) or in a separate ticket but it might be harder to ensure that all changes are consistent (i.e., improve the situation).



---

archive/issue_comments_435277.json:
```json
{
    "body": "<a id='comment:10'></a>I would say, it is definitely worth it. But I have only a draft now with some todos.\n\nIn particular, this should speedup the copy method:\n\n```\nsage: G = graphs.Grid2dGraph(100, 100)                                                                                                                                                                                                                                                                                                                                     \nsage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          \nsage: %timeit H = G.copy()                                                                                                                                                                                                                                                                                                                                                 \n31.1 ms \u00b1 183 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\nsage: %timeit H = G.subgraph(V[:10000], algorithm='add')                                                                                                                                                                                                                                                                                                                   \n16.6 ms \u00b1 15.7 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n```",
    "created_at": "2020-10-12T15:06:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435277",
    "user": "https://github.com/kliem"
}
```

<a id='comment:10'></a>I would say, it is definitely worth it. But I have only a draft now with some todos.

In particular, this should speedup the copy method:

```
sage: G = graphs.Grid2dGraph(100, 100)                                                                                                                                                                                                                                                                                                                                     
sage: V = list(G)                                                                                                                                                                                                                                                                                                                                                          
sage: %timeit H = G.copy()                                                                                                                                                                                                                                                                                                                                                 
31.1 ms ± 183 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
sage: %timeit H = G.subgraph(V[:10000], algorithm='add')                                                                                                                                                                                                                                                                                                                   
16.6 ms ± 15.7 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
```



---

archive/issue_comments_435278.json:
```json
{
    "body": "<a id='comment:11'></a>Btw, `subgraph_by_deleting` should only be used in place or if the backend has an optimized copy method (which appears to be not the case yet).\n\nNot sure about the special subgraphs yet, which are not obtained by just reducing the number of vertices.",
    "created_at": "2020-10-12T15:11:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435278",
    "user": "https://github.com/kliem"
}
```

<a id='comment:11'></a>Btw, `subgraph_by_deleting` should only be used in place or if the backend has an optimized copy method (which appears to be not the case yet).

Not sure about the special subgraphs yet, which are not obtained by just reducing the number of vertices.



---

archive/issue_comments_435279.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2020-10-12T15:13:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435279",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_435280.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-10-12T15:15:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435280",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435281.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-10-12T15:24:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435281",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_435282.json:
```json
{
    "body": "<a id='comment:16'></a>I'm not sure about this last commit as it has a different number than in #30665. Is it normal ?",
    "created_at": "2020-10-12T22:11:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435282",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:16'></a>I'm not sure about this last commit as it has a different number than in #30665. Is it normal ?



---

archive/issue_comments_435283.json:
```json
{
    "body": "<a id='comment:17'></a>This usually happens to me when cherry picking. I can rebase at some point on #30665.",
    "created_at": "2020-10-13T05:58:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435283",
    "user": "https://github.com/kliem"
}
```

<a id='comment:17'></a>This usually happens to me when cherry picking. I can rebase at some point on #30665.



---

archive/issue_comments_435284.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-10-13T06:54:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435284",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_435285.json:
```json
{
    "body": "<a id='comment:19'></a>- may be the method `obtain_subgraph` could be renamed like `subgraph_given_vertices` or something more explicit with respect what it actually do.\n- there is a line `cdef CGraph` to remove\n- instead of `max(b_vertices_2)`, why not using the size or capacity of bitset `active_vertices` ? or may be the size of `b_vertices` ?\n- Somehow, before starting to add vertices to `other`, we should call `realloc` with appropriate size, thus avoiding multiple calls.\n- I have no clue how to deal with multiple edges here.\n\n- Concerning methods `add` and `delete`, I fully agree that now `delete` should be used only when `inplace is True or algorithm == 'delete'`. The  `add` method is now way faster and should be the default one, without threshold.",
    "created_at": "2020-10-13T11:29:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435285",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:19'></a>- may be the method `obtain_subgraph` could be renamed like `subgraph_given_vertices` or something more explicit with respect what it actually do.
- there is a line `cdef CGraph` to remove
- instead of `max(b_vertices_2)`, why not using the size or capacity of bitset `active_vertices` ? or may be the size of `b_vertices` ?
- Somehow, before starting to add vertices to `other`, we should call `realloc` with appropriate size, thus avoiding multiple calls.
- I have no clue how to deal with multiple edges here.

- Concerning methods `add` and `delete`, I fully agree that now `delete` should be used only when `inplace is True or algorithm == 'delete'`. The  `add` method is now way faster and should be the default one, without threshold.



---

archive/issue_comments_435286.json:
```json
{
    "body": "<a id='comment:20'></a>I'll keep that in mind.\n\nConcerning the multiedges, unfortunately I shbould clean up dense and sparse graphs backend a bit first. Otherwise, I think it is not a problem.\n\nIf ``self`` is mutliedge, it will simply try to make ``other`` multiedge. If other is dense, this will raise an error.\n\nIf I do things right, optimizing `is_subgraph` afterwards should be easy. In particual this can be used to check equality fast.",
    "created_at": "2020-10-13T11:52:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435286",
    "user": "https://github.com/kliem"
}
```

<a id='comment:20'></a>I'll keep that in mind.

Concerning the multiedges, unfortunately I shbould clean up dense and sparse graphs backend a bit first. Otherwise, I think it is not a problem.

If ``self`` is mutliedge, it will simply try to make ``other`` multiedge. If other is dense, this will raise an error.

If I do things right, optimizing `is_subgraph` afterwards should be easy. In particual this can be used to check equality fast.



---

archive/issue_comments_435287.json:
```json
{
    "body": "<a id='comment:21'></a>So may be for the moment, we can use the new method for graphs without multiple edges only and let other cases in the todo list (i.e., raise `NotImplementedError` if called on a graph with multiple edges).\n\nIt's cool if we can also optimize other methods. The work you have already done for iterating edges plus these optimizations of the subgraph method makes significant speed ups for the entire graph module :))",
    "created_at": "2020-10-13T12:15:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435287",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:21'></a>So may be for the moment, we can use the new method for graphs without multiple edges only and let other cases in the todo list (i.e., raise `NotImplementedError` if called on a graph with multiple edges).

It's cool if we can also optimize other methods. The work you have already done for iterating edges plus these optimizations of the subgraph method makes significant speed ups for the entire graph module :))



---

archive/issue_comments_435288.json:
```json
{
    "body": "<a id='comment:22'></a>The current method does not even work for labeled graphs.\n\nGive me a day or so and I'll see if I can figure things out.",
    "created_at": "2020-10-13T13:53:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435288",
    "user": "https://github.com/kliem"
}
```

<a id='comment:22'></a>The current method does not even work for labeled graphs.

Give me a day or so and I'll see if I can figure things out.



---

archive/issue_comments_435289.json:
```json
{
    "body": "<a id='comment:23'></a>This is basically working.\n\nWhat is missing:\n\n- Documentation.\n- Cleanup.\n- Exposure in `__init__` of `DiGraph` and `Graph` to speed up e.g. copy.\n- (Maybe) Heuristics when to delete instead of add:\n  As long as there are no improved copying methods, I changed the deletion subgraph to first obtain the subgraph induced by the given vertices instead of making a copy. Depending on the input of `edges` and `edge_property`, this might be better than adding, but maybe in not so many cases. And in those cases it might be more natural to obtain a subgraph first and then delete edges.\n \n---\nLast 10 new commits:",
    "created_at": "2020-10-14T14:45:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435289",
    "user": "https://github.com/kliem"
}
```

<a id='comment:23'></a>This is basically working.

What is missing:

- Documentation.
- Cleanup.
- Exposure in `__init__` of `DiGraph` and `Graph` to speed up e.g. copy.
- (Maybe) Heuristics when to delete instead of add:
  As long as there are no improved copying methods, I changed the deletion subgraph to first obtain the subgraph induced by the given vertices instead of making a copy. Depending on the input of `edges` and `edge_property`, this might be better than adding, but maybe in not so many cases. And in those cases it might be more natural to obtain a subgraph first and then delete edges.
 
---
Last 10 new commits:



---

archive/issue_comments_435290.json:
```json
{
    "body": "<a id='comment:24'></a>This is really nice and I observe some speed up at least when doctesting the graph module :))",
    "created_at": "2020-10-14T16:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435290",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:24'></a>This is really nice and I observe some speed up at least when doctesting the graph module :))



---

archive/issue_comments_435291.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-10-14T19:27:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435291",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435292.json:
```json
{
    "body": "<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2020-10-14T19:44:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435292",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_435293.json:
```json
{
    "body": "<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-10-15T09:09:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435293",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435294.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-10-15T09:10:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435294",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_435295.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-10-15T09:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435295",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_435296.json:
```json
{
    "body": "<a id='comment:31'></a>It's not easy to review the changes done in this ticket as it depends on two other big tickets.\nNonetheless, so far all my tests are successful and show serious speed up with respect previous design. Method subgraph was a bottleneck in several of my own code.",
    "created_at": "2020-10-15T09:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435296",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:31'></a>It's not easy to review the changes done in this ticket as it depends on two other big tickets.
Nonetheless, so far all my tests are successful and show serious speed up with respect previous design. Method subgraph was a bottleneck in several of my own code.



---

archive/issue_events_080180.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-11-07T16:23:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30753#event-80180"
}
```



---

archive/issue_comments_435297.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-11-07T16:23:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30753",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30753#issuecomment-435297",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
