# Issue 30725: macOS: spkg-install scripts that force use of clang conflict with '-march=native'

archive/issues_030488.json:
```json
{
    "body": "Several packages force the use of `clang` because they cannot be built with a real gcc due to the use of Apple language extensions in system header files. \n\nFor these packages, the use of `-march=native` introduced in #27122 causes build errors because `clang` does not understand these flags (even though `/usr/bin/gcc` does).\n\nTickets where code setting the compiler was explicitly introduced: #22999 (cmake), ....\n\n```\n$ git grep MACOSX_VERSION\nbuild/pkgs/curl/spkg-install.in:        echo \"OS X 10.$[$MACOSX_VERSION-4] Building with clang and --with-darwinssl.\"\nbuild/pkgs/psutil/spkg-install.in:    echo \"OS X 10.$[$MACOSX_VERSION-4] Building with clang.\"\nbuild/pkgs/python3/spkg-build.in:        echo \"OS X 10.$[$MACOSX_VERSION-4] Building with clang.\"\nbuild/pkgs/r/spkg-install.in:        echo \"OS X 10.$[$MACOSX_VERSION-4] Building with clang.\"\n```\n\nTo test:\n\n```\ntox -e local-homebrew-macos-minimal\ntox -e local-homebrew-macos-minimal -- cmake curl gmp\ntox -e local-homebrew-macos-minimal -- ptest\n```\n\nTo test with a real gcc (using a gcc-10 installed from homebrew):\n\n```\ntox -e local-direct-gcc_10 -- cmake curl gmp python3 psutil r\n```\n\n\nCC:  @jhpalmieri @dimpase @kliem @zlscherr @kiwifb @seblabbe\n\nBranch/Commit: f56e65e25f23e69aee0d37080c046d36d7f349ed\n\nReviewer: Jonathan Kliem, Matthias Koeppe\n\nAuthor: Matthias Koeppe, Jonathan Kliem\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30725\n\n",
    "closed_at": "2021-01-31T20:53:57Z",
    "created_at": "2020-10-05T02:07:31Z",
    "labels": [
        "component: porting",
        "blocker"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "macOS: spkg-install scripts that force use of clang conflict with '-march=native'",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30725",
    "user": "https://github.com/mkoeppe"
}
```
Several packages force the use of `clang` because they cannot be built with a real gcc due to the use of Apple language extensions in system header files. 

For these packages, the use of `-march=native` introduced in #27122 causes build errors because `clang` does not understand these flags (even though `/usr/bin/gcc` does).

Tickets where code setting the compiler was explicitly introduced: #22999 (cmake), ....

```
$ git grep MACOSX_VERSION
build/pkgs/curl/spkg-install.in:        echo "OS X 10.$[$MACOSX_VERSION-4] Building with clang and --with-darwinssl."
build/pkgs/psutil/spkg-install.in:    echo "OS X 10.$[$MACOSX_VERSION-4] Building with clang."
build/pkgs/python3/spkg-build.in:        echo "OS X 10.$[$MACOSX_VERSION-4] Building with clang."
build/pkgs/r/spkg-install.in:        echo "OS X 10.$[$MACOSX_VERSION-4] Building with clang."
```

To test:

```
tox -e local-homebrew-macos-minimal
tox -e local-homebrew-macos-minimal -- cmake curl gmp
tox -e local-homebrew-macos-minimal -- ptest
```

To test with a real gcc (using a gcc-10 installed from homebrew):

```
tox -e local-direct-gcc_10 -- cmake curl gmp python3 psutil r
```


CC:  @jhpalmieri @dimpase @kliem @zlscherr @kiwifb @seblabbe

Branch/Commit: f56e65e25f23e69aee0d37080c046d36d7f349ed

Reviewer: Jonathan Kliem, Matthias Koeppe

Author: Matthias Koeppe, Jonathan Kliem

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/30725





---

archive/issue_comments_608067.json:
```json
{
    "body": "Changing priority from minor to blocker.",
    "created_at": "2021-01-16T17:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608067",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from minor to blocker.



---

archive/issue_comments_608068.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,5 @@\n+This code in several spkg-install scripts is long outdated. But now, after #27122, it causes breakage\n+\n ```\n $ git grep MACOSX_VERSION\n build/pkgs/curl/spkg-install.in:    if [ $MACOSX_VERSION -ge 16 ]; then\n``````\n",
    "created_at": "2021-01-16T18:01:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608068",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,5 @@
+This code in several spkg-install scripts is long outdated. But now, after #27122, it causes breakage
+
 ```
 $ git grep MACOSX_VERSION
 build/pkgs/curl/spkg-install.in:    if [ $MACOSX_VERSION -ge 16 ]; then
``````




---

archive/issue_comments_608069.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#31186\"",
    "created_at": "2021-01-16T18:02:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608069",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "" to "#31186"



---

archive/issue_comments_608070.json:
```json
{
    "body": "Changing dependencies from \"#31186\" to \"\"",
    "created_at": "2021-01-18T01:15:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608070",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "#31186" to ""



---

archive/issue_comments_608071.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,7 @@\n-This code in several spkg-install scripts is long outdated. But now, after #27122, it causes breakage\n+This code in several spkg-install scripts is long outdated. But now, after #27122, it causes breakage.\n+\n+Tickets where code setting the compiler was explicitly introduced: #22999 (cmake), ....\n+\n \n ```\n $ git grep MACOSX_VERSION\n``````\n",
    "created_at": "2021-01-18T01:36:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608071",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,7 @@
-This code in several spkg-install scripts is long outdated. But now, after #27122, it causes breakage
+This code in several spkg-install scripts is long outdated. But now, after #27122, it causes breakage.
+
+Tickets where code setting the compiler was explicitly introduced: #22999 (cmake), ....
+
 
 ```
 $ git grep MACOSX_VERSION
``````




---

archive/issue_comments_608072.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/macos__spkg_install__remove_outdated__building_with_clang__code___which_conflicts_with___march_native_\"",
    "created_at": "2021-01-18T01:43:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608072",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/macos__spkg_install__remove_outdated__building_with_clang__code___which_conflicts_with___march_native_"



---

archive/issue_comments_608073.json:
```json
{
    "body": "<a id='comment:8'></a>Those bits should have gone when I \"normalised\" clang for building sage on OS X. We were probably planing to remove them at a later stage and forgot.\n\nWell, the opportunity is clearly now.\n\n---\nNew commits:",
    "created_at": "2021-01-18T01:47:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608073",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:8'></a>Those bits should have gone when I "normalised" clang for building sage on OS X. We were probably planing to remove them at a later stage and forgot.

Well, the opportunity is clearly now.

---
New commits:



---

archive/issue_comments_608074.json:
```json
{
    "body": "Changing commit from \"\" to \"3fd3388757aec91dd5a4b65ccc6e623e55c307c1\"",
    "created_at": "2021-01-18T01:47:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608074",
    "user": "https://github.com/kiwifb"
}
```

Changing commit from "" to "3fd3388757aec91dd5a4b65ccc6e623e55c307c1"



---

archive/issue_comments_608075.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -18,3 +18,11 @@\n build/pkgs/r/spkg-install.in:    if [ $MACOSX_VERSION -ge 16 ]; then\n build/pkgs/r/spkg-install.in:        echo \"OS X 10.$[$MACOSX_VERSION-4] Building with clang.\"\n ```\n+\n+Configurations to test:\n+\n+```\n+tox -e local-homebrew-macos-minimal-gcc_10\n+tox -e local-homebrew-macos-minimal\n+```\n+\n``````\n",
    "created_at": "2021-01-18T01:49:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608075",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -18,3 +18,11 @@
 build/pkgs/r/spkg-install.in:    if [ $MACOSX_VERSION -ge 16 ]; then
 build/pkgs/r/spkg-install.in:        echo "OS X 10.$[$MACOSX_VERSION-4] Building with clang."
 ```
+
+Configurations to test:
+
+```
+tox -e local-homebrew-macos-minimal-gcc_10
+tox -e local-homebrew-macos-minimal
+```
+
``````




---

archive/issue_comments_608076.json:
```json
{
    "body": "<a id='comment:10'></a>Also several of these packages have been updated since and are able to build with an actual gcc on macOS. We have tickets for some packages where this is still broken: #29613 (givaro)",
    "created_at": "2021-01-18T01:58:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608076",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>Also several of these packages have been updated since and are able to build with an actual gcc on macOS. We have tickets for some packages where this is still broken: #29613 (givaro)



---

archive/issue_comments_608077.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -19,10 +19,11 @@\n build/pkgs/r/spkg-install.in:        echo \"OS X 10.$[$MACOSX_VERSION-4] Building with clang.\"\n ```\n \n-Configurations to test:\n+To test:\n \n ```\n-tox -e local-homebrew-macos-minimal-gcc_10\n tox -e local-homebrew-macos-minimal\n+tox -e local-homebrew-macos-minimal -- cmake curl gmp\n+tox -e local-homebrew-macos-minimal -- ptest\n ```\n \n``````\n",
    "created_at": "2021-01-18T03:52:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608077",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -19,10 +19,11 @@
 build/pkgs/r/spkg-install.in:        echo "OS X 10.$[$MACOSX_VERSION-4] Building with clang."
 ```
 
-Configurations to test:
+To test:
 
 ```
-tox -e local-homebrew-macos-minimal-gcc_10
 tox -e local-homebrew-macos-minimal
+tox -e local-homebrew-macos-minimal -- cmake curl gmp
+tox -e local-homebrew-macos-minimal -- ptest
 ```
 
``````




---

archive/issue_comments_608078.json:
```json
{
    "body": "Changing commit from \"3fd3388757aec91dd5a4b65ccc6e623e55c307c1\" to \"2a3981932d00235d13afc32edf76c1699dbbabc5\"",
    "created_at": "2021-01-18T05:26:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608078",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "3fd3388757aec91dd5a4b65ccc6e623e55c307c1" to "2a3981932d00235d13afc32edf76c1699dbbabc5"



---

archive/issue_comments_608079.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-01-18T05:26:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608079",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_608080.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2021-01-18T05:27:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608080",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_comments_608081.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-01-18T05:27:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608081",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_608082.json:
```json
{
    "body": "Changing reviewer from \"\" to \"https://github.com/kliem/sage/pull/34/checks\"",
    "created_at": "2021-01-18T06:48:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608082",
    "user": "https://github.com/kliem"
}
```

Changing reviewer from "" to "https://github.com/kliem/sage/pull/34/checks"



---

archive/issue_comments_608083.json:
```json
{
    "body": "<a id='comment:15'></a>I have tested the configuration in the ticket description successfully.\n\nBut testing with the `gcc-10` from homebrew, I am still running into issues with macOS header files that are not compatible with gcc.\n\n```\n  [cmake-3.18.2] installing. Log file: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/logs/pkgs/cmake-3.18.2.log\n  [cmake-3.18.2] error installing, exit status 1. End of log file:\n  [cmake-3.18.2]   /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/System/Library/Frameworks/ImageIO.framework/Headers/CGImageAnimation.h:42:15: error: expected unqualified-id before '^' token\n  [cmake-3.18.2]      42 | typedef void (^CGImageSourceAnimationBlock)(size_t index, CGImageRef image, bool* stop);\n  [cmake-3.18.2]         |               ^\n```",
    "created_at": "2021-01-18T07:01:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608083",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>I have tested the configuration in the ticket description successfully.

But testing with the `gcc-10` from homebrew, I am still running into issues with macOS header files that are not compatible with gcc.

```
  [cmake-3.18.2] installing. Log file: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/logs/pkgs/cmake-3.18.2.log
  [cmake-3.18.2] error installing, exit status 1. End of log file:
  [cmake-3.18.2]   /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/System/Library/Frameworks/ImageIO.framework/Headers/CGImageAnimation.h:42:15: error: expected unqualified-id before '^' token
  [cmake-3.18.2]      42 | typedef void (^CGImageSourceAnimationBlock)(size_t index, CGImageRef image, bool* stop);
  [cmake-3.18.2]         |               ^
```



---

archive/issue_comments_608084.json:
```json
{
    "body": "<a id='comment:16'></a>Btw, to prevent breackage because of `-march=native`, one can also `export CFLAGS=CFLAGS_NON_NATIVE` etc. right after setting the compiler to clang.",
    "created_at": "2021-01-18T07:03:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608084",
    "user": "https://github.com/kliem"
}
```

<a id='comment:16'></a>Btw, to prevent breackage because of `-march=native`, one can also `export CFLAGS=CFLAGS_NON_NATIVE` etc. right after setting the compiler to clang.



---

archive/issue_comments_608085.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-01-18T07:08:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608085",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_608086.json:
```json
{
    "body": "<a id='comment:17'></a>Yes, if simple fixes such as package upgrades don't fix it, that's what we should do.",
    "created_at": "2021-01-18T07:08:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608086",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>Yes, if simple fixes such as package upgrades don't fix it, that's what we should do.



---

archive/issue_comments_608087.json:
```json
{
    "body": "<a id='comment:18'></a>Upgrade of cmake to 3.19.3 (#31258) does not fix this",
    "created_at": "2021-01-18T07:50:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608087",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'></a>Upgrade of cmake to 3.19.3 (#31258) does not fix this



---

archive/issue_comments_608088.json:
```json
{
    "body": "<a id='comment:19'></a>I don't understand - I presume one still cannot build all of Sage on macOS using \"real\" gcc.\n\nWhy is this a blocker?",
    "created_at": "2021-01-18T16:39:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608088",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:19'></a>I don't understand - I presume one still cannot build all of Sage on macOS using "real" gcc.

Why is this a blocker?



---

archive/issue_comments_608089.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:19 dimpase]:\n> I don't understand - I presume one still cannot build all of Sage on macOS using \"real\" gcc.\n\n\nYes, this is what the experiment with `cmake` has just revealed.\n\n> Why is this a blocker?\n\n\nWhen Apple's compiler is invoked as `clang` instead of `gcc`, it does not understand the same flags. So #27122 leads to build errors.",
    "created_at": "2021-01-18T17:32:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608089",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>Replying to [comment:19 dimpase]:
> I don't understand - I presume one still cannot build all of Sage on macOS using "real" gcc.


Yes, this is what the experiment with `cmake` has just revealed.

> Why is this a blocker?


When Apple's compiler is invoked as `clang` instead of `gcc`, it does not understand the same flags. So #27122 leads to build errors.



---

archive/issue_comments_608090.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,21 +1,14 @@\n-This code in several spkg-install scripts is long outdated. But now, after #27122, it causes breakage.\n+Several packages force the use of `clang` because they cannot be built with a real gcc due to the use of Apple language extensions in system header files. \n+\n+For these packages, the use of `-march=native` introduced in #27122 causes build errors because `clang` does not understand these flags (even though `/usr/bin/gcc` does).\n \n Tickets where code setting the compiler was explicitly introduced: #22999 (cmake), ....\n \n-\n ```\n $ git grep MACOSX_VERSION\n-build/pkgs/curl/spkg-install.in:    if [ $MACOSX_VERSION -ge 16 ]; then\n build/pkgs/curl/spkg-install.in:        echo \"OS X 10.$[$MACOSX_VERSION-4] Building with clang and --with-darwinssl.\"\n-build/pkgs/pari/spkg-install.in:MACOSX_VERSION=`uname -r | awk -F. '{print $1}'`\n-build/pkgs/pari/spkg-install.in:if [ $MACOSX_VERSION -ge 14 ]; then\n-build/pkgs/psutil/spkg-install.in:if [ \"$UNAME\" = \"Darwin\" ] && [ $MACOSX_VERSION -ge 16 ]; then\n build/pkgs/psutil/spkg-install.in:    echo \"OS X 10.$[$MACOSX_VERSION-4] Building with clang.\"\n-build/pkgs/python3/spkg-build.in:    if [ $MACOSX_VERSION -ge 16 ]; then\n build/pkgs/python3/spkg-build.in:        echo \"OS X 10.$[$MACOSX_VERSION-4] Building with clang.\"\n-build/pkgs/r/spkg-install.in:    if [ $MACOSX_VERSION -ge 14 ]; then\n-build/pkgs/r/spkg-install.in:        echo \"OS X 10.$[$MACOSX_VERSION-4] Configuring R without aqua support.\"\n-build/pkgs/r/spkg-install.in:    if [ $MACOSX_VERSION -ge 16 ]; then\n build/pkgs/r/spkg-install.in:        echo \"OS X 10.$[$MACOSX_VERSION-4] Building with clang.\"\n ```\n \n``````\n",
    "created_at": "2021-01-18T17:59:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608090",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,21 +1,14 @@
-This code in several spkg-install scripts is long outdated. But now, after #27122, it causes breakage.
+Several packages force the use of `clang` because they cannot be built with a real gcc due to the use of Apple language extensions in system header files. 
+
+For these packages, the use of `-march=native` introduced in #27122 causes build errors because `clang` does not understand these flags (even though `/usr/bin/gcc` does).
 
 Tickets where code setting the compiler was explicitly introduced: #22999 (cmake), ....
 
-
 ```
 $ git grep MACOSX_VERSION
-build/pkgs/curl/spkg-install.in:    if [ $MACOSX_VERSION -ge 16 ]; then
 build/pkgs/curl/spkg-install.in:        echo "OS X 10.$[$MACOSX_VERSION-4] Building with clang and --with-darwinssl."
-build/pkgs/pari/spkg-install.in:MACOSX_VERSION=`uname -r | awk -F. '{print $1}'`
-build/pkgs/pari/spkg-install.in:if [ $MACOSX_VERSION -ge 14 ]; then
-build/pkgs/psutil/spkg-install.in:if [ "$UNAME" = "Darwin" ] && [ $MACOSX_VERSION -ge 16 ]; then
 build/pkgs/psutil/spkg-install.in:    echo "OS X 10.$[$MACOSX_VERSION-4] Building with clang."
-build/pkgs/python3/spkg-build.in:    if [ $MACOSX_VERSION -ge 16 ]; then
 build/pkgs/python3/spkg-build.in:        echo "OS X 10.$[$MACOSX_VERSION-4] Building with clang."
-build/pkgs/r/spkg-install.in:    if [ $MACOSX_VERSION -ge 14 ]; then
-build/pkgs/r/spkg-install.in:        echo "OS X 10.$[$MACOSX_VERSION-4] Configuring R without aqua support."
-build/pkgs/r/spkg-install.in:    if [ $MACOSX_VERSION -ge 16 ]; then
 build/pkgs/r/spkg-install.in:        echo "OS X 10.$[$MACOSX_VERSION-4] Building with clang."
 ```
 
``````




---

archive/issue_comments_608091.json:
```json
{
    "body": "<a id='comment:22'></a>The `curl` build also fails:\n\n```\nvtls/darwinssl.c: In function 'show_verbose_server_cert':\nvtls/darwinssl.c:2711:6: error: 'SecTrustEvaluateAsync' undeclared (first use in this function); did you mean 'SecTrustEvaluate'?\n 2711 |   if(SecTrustEvaluateAsync != NULL) {\n      |      ^~~~~~~~~~~~~~~~~~~~~\n      |      SecTrustEvaluate\n```\nAn update to current curl (#31260) does not fix this. Either version works fine with clang.",
    "created_at": "2021-01-18T18:31:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608091",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'></a>The `curl` build also fails:

```
vtls/darwinssl.c: In function 'show_verbose_server_cert':
vtls/darwinssl.c:2711:6: error: 'SecTrustEvaluateAsync' undeclared (first use in this function); did you mean 'SecTrustEvaluate'?
 2711 |   if(SecTrustEvaluateAsync != NULL) {
      |      ^~~~~~~~~~~~~~~~~~~~~
      |      SecTrustEvaluate
```
An update to current curl (#31260) does not fix this. Either version works fine with clang.



---

archive/issue_comments_608092.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -20,3 +20,9 @@\n tox -e local-homebrew-macos-minimal -- ptest\n ```\n \n+To test with a real gcc:\n+\n+```\n+tox -e local-direct-gcc_10 -- cmake curl gmp python3 psutil r\n+```\n+\n``````\n",
    "created_at": "2021-01-18T18:36:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608092",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -20,3 +20,9 @@
 tox -e local-homebrew-macos-minimal -- ptest
 ```
 
+To test with a real gcc:
+
+```
+tox -e local-direct-gcc_10 -- cmake curl gmp python3 psutil r
+```
+
``````




---

archive/issue_comments_608093.json:
```json
{
    "body": "<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-01-18T18:37:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608093",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_608094.json:
```json
{
    "body": "Changing commit from \"2a3981932d00235d13afc32edf76c1699dbbabc5\" to \"c6e30eab754c20f53ceef40508a223c590f06cb1\"",
    "created_at": "2021-01-18T18:37:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608094",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "2a3981932d00235d13afc32edf76c1699dbbabc5" to "c6e30eab754c20f53ceef40508a223c590f06cb1"



---

archive/issue_comments_608095.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [comment:16 gh-kliem]:\n> Btw, to prevent breackage because of `-march=native`, one can also `export CFLAGS=CFLAGS_NON_NATIVE` etc. right after setting the compiler to clang.\n\n\nI have backed out the previous attempt and will use this approach now.",
    "created_at": "2021-01-18T18:37:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608095",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'></a>Replying to [comment:16 gh-kliem]:
> Btw, to prevent breackage because of `-march=native`, one can also `export CFLAGS=CFLAGS_NON_NATIVE` etc. right after setting the compiler to clang.


I have backed out the previous attempt and will use this approach now.



---

archive/issue_comments_608096.json:
```json
{
    "body": "<a id='comment:26'></a>Are you saying that `CC=clang CXX=clang++ ./configure && make` does not work any more on macOS - or it does, but not setting CC and CXX breaks down? \n\nInvoking Apple's clang as gcc is a kludge that sooner or later should become a problem, are you saying  it already is one?",
    "created_at": "2021-01-18T18:39:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608096",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:26'></a>Are you saying that `CC=clang CXX=clang++ ./configure && make` does not work any more on macOS - or it does, but not setting CC and CXX breaks down? 

Invoking Apple's clang as gcc is a kludge that sooner or later should become a problem, are you saying  it already is one?



---

archive/issue_comments_608097.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:26 dimpase]:\n> Are you saying that `CC=clang CXX=clang++ ./configure && make` does not work any more on macOS - or it does,\n\n\nIt does work - in this case, these compilers will be tested for what flags they accept.\n\n> but not setting CC and CXX breaks down? \n\n\nThat's right. The issue arises from the `spkg-install` scripts changing the compiler to `clang` and continuing to use CFLAGS that have been determined by the configure script for a different compiler (`/usr/bin/gcc`).",
    "created_at": "2021-01-18T18:49:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608097",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'></a>Replying to [comment:26 dimpase]:
> Are you saying that `CC=clang CXX=clang++ ./configure && make` does not work any more on macOS - or it does,


It does work - in this case, these compilers will be tested for what flags they accept.

> but not setting CC and CXX breaks down? 


That's right. The issue arises from the `spkg-install` scripts changing the compiler to `clang` and continuing to use CFLAGS that have been determined by the configure script for a different compiler (`/usr/bin/gcc`).



---

archive/issue_comments_608098.json:
```json
{
    "body": "<a id='comment:28'></a>Oh, so on macOS `/usr/bin/gcc` has become a *different* from `/usr/bin/clang` (or whatever the path is) front-end to \"real\" clang? Thanks, Apple, this is a great help.",
    "created_at": "2021-01-18T19:07:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608098",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:28'></a>Oh, so on macOS `/usr/bin/gcc` has become a *different* from `/usr/bin/clang` (or whatever the path is) front-end to "real" clang? Thanks, Apple, this is a great help.



---

archive/issue_comments_608099.json:
```json
{
    "body": "<a id='comment:29'></a>Yes, they have different interfaces.",
    "created_at": "2021-01-18T19:08:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608099",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:29'></a>Yes, they have different interfaces.



---

archive/issue_comments_608100.json:
```json
{
    "body": "<a id='comment:30'></a>It is more like `/usr/bin/gcc` is a front end that can filter command line options specific to gcc. This is not a new behavior. And this is a problem now that we have committed to some specific gcc options.",
    "created_at": "2021-01-18T19:09:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608100",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:30'></a>It is more like `/usr/bin/gcc` is a front end that can filter command line options specific to gcc. This is not a new behavior. And this is a problem now that we have committed to some specific gcc options.



---

archive/issue_comments_608101.json:
```json
{
    "body": "<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-01-18T19:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608101",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_608102.json:
```json
{
    "body": "Changing commit from \"c6e30eab754c20f53ceef40508a223c590f06cb1\" to \"9b0eb15897bbde3ad5e440b26d714f637516e91d\"",
    "created_at": "2021-01-18T19:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608102",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c6e30eab754c20f53ceef40508a223c590f06cb1" to "9b0eb15897bbde3ad5e440b26d714f637516e91d"



---

archive/issue_comments_608103.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-01-18T19:29:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608103",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_608104.json:
```json
{
    "body": "Changing reviewer from \"https://github.com/kliem/sage/pull/34/checks\" to \"\"",
    "created_at": "2021-01-18T19:29:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608104",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "https://github.com/kliem/sage/pull/34/checks" to ""



---

archive/issue_comments_608105.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -20,7 +20,7 @@\n tox -e local-homebrew-macos-minimal -- ptest\n ```\n \n-To test with a real gcc:\n+To test with a real gcc (using a gcc-10 installed from homebrew):\n \n ```\n tox -e local-direct-gcc_10 -- cmake curl gmp python3 psutil r\n``````\n",
    "created_at": "2021-01-18T19:30:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608105",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -20,7 +20,7 @@
 tox -e local-homebrew-macos-minimal -- ptest
 ```
 
-To test with a real gcc:
+To test with a real gcc (using a gcc-10 installed from homebrew):
 
 ```
 tox -e local-direct-gcc_10 -- cmake curl gmp python3 psutil r
``````




---

archive/issue_comments_608106.json:
```json
{
    "body": "Changing reviewer from \"\" to \"https://github.com/mkoeppe/sage/actions/runs/496953211, https://github.com/mkoeppe/sage/actions/runs/496953208, ...\"",
    "created_at": "2021-01-19T20:40:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608106",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "https://github.com/mkoeppe/sage/actions/runs/496953211, https://github.com/mkoeppe/sage/actions/runs/496953208, ..."



---

archive/issue_comments_608107.json:
```json
{
    "body": "Changing commit from \"9b0eb15897bbde3ad5e440b26d714f637516e91d\" to \"f56e65e25f23e69aee0d37080c046d36d7f349ed\"",
    "created_at": "2021-01-20T10:16:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608107",
    "user": "https://github.com/kliem"
}
```

Changing commit from "9b0eb15897bbde3ad5e440b26d714f637516e91d" to "f56e65e25f23e69aee0d37080c046d36d7f349ed"



---

archive/issue_comments_608108.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/macos__spkg_install__remove_outdated__building_with_clang__code___which_conflicts_with___march_native_\" to \"u/gh-kliem/macos__spkg_install__remove_outdated__building_with_clang__code___which_conflicts_with___march_native_\"",
    "created_at": "2021-01-20T10:16:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608108",
    "user": "https://github.com/kliem"
}
```

Changing branch from "u/mkoeppe/macos__spkg_install__remove_outdated__building_with_clang__code___which_conflicts_with___march_native_" to "u/gh-kliem/macos__spkg_install__remove_outdated__building_with_clang__code___which_conflicts_with___march_native_"



---

archive/issue_comments_608109.json:
```json
{
    "body": "<a id='comment:35'></a>R does not use `-march=native` anyway.\n`python/spkg-build.in` is set up a bit different. `$CFLAGS` contains other stuff and `$EXTRA_CFLAGS` is contains the old `$CFLAGS`, so we need to set `$EXTRA_CFLAGS`.\n\nAnyway, I think the main problem is that we run `testcfags.sh` before setting the compiler.\nWe might as well run this for `$CFLAGS` as well after possibly changing the compiler.\n\n---\nNew commits:",
    "created_at": "2021-01-20T10:16:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608109",
    "user": "https://github.com/kliem"
}
```

<a id='comment:35'></a>R does not use `-march=native` anyway.
`python/spkg-build.in` is set up a bit different. `$CFLAGS` contains other stuff and `$EXTRA_CFLAGS` is contains the old `$CFLAGS`, so we need to set `$EXTRA_CFLAGS`.

Anyway, I think the main problem is that we run `testcfags.sh` before setting the compiler.
We might as well run this for `$CFLAGS` as well after possibly changing the compiler.

---
New commits:



---

archive/issue_comments_608110.json:
```json
{
    "body": "Changing reviewer from \"https://github.com/mkoeppe/sage/actions/runs/496953211, https://github.com/mkoeppe/sage/actions/runs/496953208, ...\" to \"https://github.com/mkoeppe/sage/actions/runs/496953211, https://github.com/mkoeppe/sage/actions/runs/496953208, Jonathan Kliem\"",
    "created_at": "2021-01-20T10:16:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608110",
    "user": "https://github.com/kliem"
}
```

Changing reviewer from "https://github.com/mkoeppe/sage/actions/runs/496953211, https://github.com/mkoeppe/sage/actions/runs/496953208, ..." to "https://github.com/mkoeppe/sage/actions/runs/496953211, https://github.com/mkoeppe/sage/actions/runs/496953208, Jonathan Kliem"



---

archive/issue_comments_608111.json:
```json
{
    "body": "Changing reviewer from \"https://github.com/mkoeppe/sage/actions/runs/496953211, https://github.com/mkoeppe/sage/actions/runs/496953208, Jonathan Kliem\" to \"https://github.com/mkoeppe/sage/actions/runs/496953211, https://github.com/mkoeppe/sage/actions/runs/496953208, Jonathan Kliem, https://github.com/kliem/sage/actions/runs/498284561\"",
    "created_at": "2021-01-20T10:24:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608111",
    "user": "https://github.com/kliem"
}
```

Changing reviewer from "https://github.com/mkoeppe/sage/actions/runs/496953211, https://github.com/mkoeppe/sage/actions/runs/496953208, Jonathan Kliem" to "https://github.com/mkoeppe/sage/actions/runs/496953211, https://github.com/mkoeppe/sage/actions/runs/496953208, Jonathan Kliem, https://github.com/kliem/sage/actions/runs/498284561"



---

archive/issue_comments_608112.json:
```json
{
    "body": "<a id='comment:37'></a>Replying to [comment:35 gh-kliem]:\n> R does not use `-march=native` anyway.\n\n\n... is it ignoring CFLAGS?",
    "created_at": "2021-01-20T20:50:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608112",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:37'></a>Replying to [comment:35 gh-kliem]:
> R does not use `-march=native` anyway.


... is it ignoring CFLAGS?



---

archive/issue_comments_608113.json:
```json
{
    "body": "<a id='comment:38'></a>No, it already uses `CFLAGS_NON_NATIVE`.\n\n```\n 10 # #29170: Compilation errors caused by a silently failing configure check\n 11 # \"for type of 'hidden' Fortran character lengths\"\n 12 # on ubuntu-bionic-minimal, ubuntu-eoan/focal-minimal, debian-buster/bullseye/sid-minimal,\n 13 # linuxmint-19.3-minimal, archlinux-latest-minimal\n 14 CFLAGS=\"$CFLAGS_NON_NATIVE -fPIC\"\n 15 FCFLAGS=\"$FCFLAGS_NON_NATIVE -fPIC\"\n```",
    "created_at": "2021-01-20T20:59:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608113",
    "user": "https://github.com/kliem"
}
```

<a id='comment:38'></a>No, it already uses `CFLAGS_NON_NATIVE`.

```
 10 # #29170: Compilation errors caused by a silently failing configure check
 11 # "for type of 'hidden' Fortran character lengths"
 12 # on ubuntu-bionic-minimal, ubuntu-eoan/focal-minimal, debian-buster/bullseye/sid-minimal,
 13 # linuxmint-19.3-minimal, archlinux-latest-minimal
 14 CFLAGS="$CFLAGS_NON_NATIVE -fPIC"
 15 FCFLAGS="$FCFLAGS_NON_NATIVE -fPIC"
```



---

archive/issue_comments_608114.json:
```json
{
    "body": "<a id='comment:39'></a>Ah, OK, thanks",
    "created_at": "2021-01-20T21:00:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608114",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:39'></a>Ah, OK, thanks



---

archive/issue_comments_608115.json:
```json
{
    "body": "<a id='comment:40'></a>R was one of the things that crashed or didn't build with `-march=native` (don't remember), so I disalbed it in #27122.",
    "created_at": "2021-01-20T21:00:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608115",
    "user": "https://github.com/kliem"
}
```

<a id='comment:40'></a>R was one of the things that crashed or didn't build with `-march=native` (don't remember), so I disalbed it in #27122.



---

archive/issue_comments_608116.json:
```json
{
    "body": "<a id='comment:41'></a>My tests finished. Not very sucessfull though. Looks like zlib failed for many mac runs.\n\nAlso ubuntu-bionic-minimal and debian-buster-minimal failed because somehow ssl wasn't available and the pytest failed (or the server did not reply).\n\nAnyway. There are several different ways to fix `python3/spkg-build.in` of course.",
    "created_at": "2021-01-21T07:36:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608116",
    "user": "https://github.com/kliem"
}
```

<a id='comment:41'></a>My tests finished. Not very sucessfull though. Looks like zlib failed for many mac runs.

Also ubuntu-bionic-minimal and debian-buster-minimal failed because somehow ssl wasn't available and the pytest failed (or the server did not reply).

Anyway. There are several different ways to fix `python3/spkg-build.in` of course.



---

archive/issue_comments_608117.json:
```json
{
    "body": "<a id='comment:42'></a>Replying to [comment:41 gh-kliem]:\n> My tests finished. Not very sucessfull though. Looks like zlib failed for many mac runs.\n> \n> Also ubuntu-bionic-minimal and debian-buster-minimal failed because somehow ssl wasn't available and the pytest failed (or the server did not reply).\n\n\nOne needs to merge a few tickets that fix up the GH Actions runs.",
    "created_at": "2021-01-21T22:58:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608117",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:42'></a>Replying to [comment:41 gh-kliem]:
> My tests finished. Not very sucessfull though. Looks like zlib failed for many mac runs.
> 
> Also ubuntu-bionic-minimal and debian-buster-minimal failed because somehow ssl wasn't available and the pytest failed (or the server did not reply).


One needs to merge a few tickets that fix up the GH Actions runs.



---

archive/issue_comments_608118.json:
```json
{
    "body": "<a id='comment:43'></a>Replying to [comment:41 gh-kliem]:\n> There are several different ways to fix `python3/spkg-build.in` of course.\n\n\nAre you satisfied with the version that you pushed?",
    "created_at": "2021-01-21T22:59:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608118",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:43'></a>Replying to [comment:41 gh-kliem]:
> There are several different ways to fix `python3/spkg-build.in` of course.


Are you satisfied with the version that you pushed?



---

archive/issue_comments_608119.json:
```json
{
    "body": "Changing reviewer from \"https://github.com/mkoeppe/sage/actions/runs/496953211, https://github.com/mkoeppe/sage/actions/runs/496953208, Jonathan Kliem, https://github.com/kliem/sage/actions/runs/498284561\" to \"https://github.com/mkoeppe/sage/actions/runs/502363182, Jonathan Kliem\"",
    "created_at": "2021-01-21T23:02:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608119",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "https://github.com/mkoeppe/sage/actions/runs/496953211, https://github.com/mkoeppe/sage/actions/runs/496953208, Jonathan Kliem, https://github.com/kliem/sage/actions/runs/498284561" to "https://github.com/mkoeppe/sage/actions/runs/502363182, Jonathan Kliem"



---

archive/issue_comments_608120.json:
```json
{
    "body": "<a id='comment:45'></a>Replying to [comment:43 mkoeppe]:\n> Replying to [comment:41 gh-kliem]:\n> > There are several different ways to fix `python3/spkg-build.in` of course.\n\n> \n> Are you satisfied with the version that you pushed?\n\n\nYes.",
    "created_at": "2021-01-22T06:54:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608120",
    "user": "https://github.com/kliem"
}
```

<a id='comment:45'></a>Replying to [comment:43 mkoeppe]:
> Replying to [comment:41 gh-kliem]:
> > There are several different ways to fix `python3/spkg-build.in` of course.

> 
> Are you satisfied with the version that you pushed?


Yes.



---

archive/issue_comments_608121.json:
```json
{
    "body": "<a id='comment:46'></a>And I'm also happy with your changes.\n\nI'm just waiting on an okay, that this fixes things.",
    "created_at": "2021-01-22T06:54:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608121",
    "user": "https://github.com/kliem"
}
```

<a id='comment:46'></a>And I'm also happy with your changes.

I'm just waiting on an okay, that this fixes things.



---

archive/issue_comments_608122.json:
```json
{
    "body": "<a id='comment:47'></a>Is this supposed to fix issues around using /usr/bin/python3 on Big Sur? With this ticket if I configure with-python=/usr/bin/python3 and then do make Cython I still get\n\n\n```\ngcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -march=native -I/Users/zscherr/sage/develop/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c /private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-rpwm0h2y/Cython/Plex/Scanners.c -o build/temp.macosx-10.14.6-x86_64-3.8/private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-rpwm0h2y/Cython/Plex/Scanners.o\n  clang: error: the clang compiler does not support '-march=native'\n  error: command 'gcc' failed with exit status 1\n```",
    "created_at": "2021-01-22T22:02:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608122",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:47'></a>Is this supposed to fix issues around using /usr/bin/python3 on Big Sur? With this ticket if I configure with-python=/usr/bin/python3 and then do make Cython I still get


```
gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -march=native -I/Users/zscherr/sage/develop/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c /private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-rpwm0h2y/Cython/Plex/Scanners.c -o build/temp.macosx-10.14.6-x86_64-3.8/private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-rpwm0h2y/Cython/Plex/Scanners.o
  clang: error: the clang compiler does not support '-march=native'
  error: command 'gcc' failed with exit status 1
```



---

archive/issue_comments_608123.json:
```json
{
    "body": "<a id='comment:48'></a>Does it go away, if you additionally pull in #31228?\n\nThis one just disables `-march=native` regardless, if the compiler of system python does not understand it. What might be more clever, is to just disable `-march=native` in the definition of `sdh_pip_install`.",
    "created_at": "2021-01-22T22:20:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608123",
    "user": "https://github.com/kliem"
}
```

<a id='comment:48'></a>Does it go away, if you additionally pull in #31228?

This one just disables `-march=native` regardless, if the compiler of system python does not understand it. What might be more clever, is to just disable `-march=native` in the definition of `sdh_pip_install`.



---

archive/issue_comments_608124.json:
```json
{
    "body": "<a id='comment:49'></a>Replying to [comment:47 gh-zlscherr]:\n> Is this supposed to fix issues around using /usr/bin/python3 on Big Sur? \n\nNo, it's only a first step",
    "created_at": "2021-01-22T22:42:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608124",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:49'></a>Replying to [comment:47 gh-zlscherr]:
> Is this supposed to fix issues around using /usr/bin/python3 on Big Sur? 

No, it's only a first step



---

archive/issue_comments_608125.json:
```json
{
    "body": "<a id='comment:50'></a>Replying to [comment:48 gh-kliem]:\n> Does it go away, if you additionally pull in #31228?\n> \n> This one just disables `-march=native` regardless, if the compiler of system python does not understand it. What might be more clever, is to just disable `-march=native` in the definition of `sdh_pip_install`.\n\n\nThanks! Yes, with this ticket and #31228 I can get python packages (at least cython) to build again using system python.  I'll continue to check to make sure everything builds.",
    "created_at": "2021-01-22T23:55:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608125",
    "user": "https://github.com/zlscherr"
}
```

<a id='comment:50'></a>Replying to [comment:48 gh-kliem]:
> Does it go away, if you additionally pull in #31228?
> 
> This one just disables `-march=native` regardless, if the compiler of system python does not understand it. What might be more clever, is to just disable `-march=native` in the definition of `sdh_pip_install`.


Thanks! Yes, with this ticket and #31228 I can get python packages (at least cython) to build again using system python.  I'll continue to check to make sure everything builds.



---

archive/issue_comments_608126.json:
```json
{
    "body": "<a id='comment:51'></a>I think this is good to go.",
    "created_at": "2021-01-23T10:07:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608126",
    "user": "https://github.com/kliem"
}
```

<a id='comment:51'></a>I think this is good to go.



---

archive/issue_comments_608127.json:
```json
{
    "body": "Changing reviewer from \"https://github.com/mkoeppe/sage/actions/runs/502363182, Jonathan Kliem\" to \"Jonathan Kliem\"",
    "created_at": "2021-01-23T10:07:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608127",
    "user": "https://github.com/kliem"
}
```

Changing reviewer from "https://github.com/mkoeppe/sage/actions/runs/502363182, Jonathan Kliem" to "Jonathan Kliem"



---

archive/issue_comments_608128.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-01-23T10:07:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608128",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_608129.json:
```json
{
    "body": "Changing author from \"Matthias Koeppe\" to \"Matthias Koeppe, Jonathan Kliem\"",
    "created_at": "2021-01-23T17:41:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608129",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "Matthias Koeppe" to "Matthias Koeppe, Jonathan Kliem"



---

archive/issue_comments_608130.json:
```json
{
    "body": "Changing reviewer from \"Jonathan Kliem\" to \"Jonathan Kliem, Matthias Koeppe\"",
    "created_at": "2021-01-23T17:41:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608130",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "Jonathan Kliem" to "Jonathan Kliem, Matthias Koeppe"



---

archive/issue_events_080070.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-01-31T20:53:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30725#event-80070"
}
```



---

archive/issue_comments_608131.json:
```json
{
    "body": "Changing branch from \"u/gh-kliem/macos__spkg_install__remove_outdated__building_with_clang__code___which_conflicts_with___march_native_\" to \"f56e65e25f23e69aee0d37080c046d36d7f349ed\"",
    "created_at": "2021-01-31T20:53:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608131",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/gh-kliem/macos__spkg_install__remove_outdated__building_with_clang__code___which_conflicts_with___march_native_" to "f56e65e25f23e69aee0d37080c046d36d7f349ed"



---

archive/issue_comments_608132.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-01-31T20:53:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30725#issuecomment-608132",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
