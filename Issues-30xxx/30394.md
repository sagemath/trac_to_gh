# Issue 30394: Graphs: add antipodal check and folding of graphs

archive/issues_030157.json:
```json
{
    "body": "Add a method to check whether an undirected graph is antipodal and a method to compute the antipodal folding of an undirected graph.\n\nCC:  @dimpase\n\nBranch/Commit: 9dbb93d683410ad205e5f346f4c030928b93666d\n\nReviewer: David Coudert\n\nAuthor: Ivo Maffei\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30394\n\n",
    "closed_at": "2020-08-30T08:38:50Z",
    "created_at": "2020-08-19T16:28:05Z",
    "labels": [
        "component: graph theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Graphs: add antipodal check and folding of graphs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30394",
    "user": "https://github.com/Ivo-Maffei"
}
```
Add a method to check whether an undirected graph is antipodal and a method to compute the antipodal folding of an undirected graph.

CC:  @dimpase

Branch/Commit: 9dbb93d683410ad205e5f346f4c030928b93666d

Reviewer: David Coudert

Author: Ivo Maffei

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/30394





---

archive/issue_comments_429191.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2020-08-19T16:28:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429191",
    "user": "https://github.com/Ivo-Maffei"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_429192.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-08-19T16:28:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429192",
    "user": "https://github.com/Ivo-Maffei"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_429193.json:
```json
{
    "body": "<a id='comment:3'></a>check simple cases: 0 or 1 vertex, not connected\n\nin folded graphs, it would be nice to have a way to check if the input is antipodal, either calling `is_antipodal`, or using appropriate tests during the construction (if any).\n\nConcerning the construction of the antipodal graph, I have an idea of a better/faster solution than what you propose. I will do some tests and come back to you.",
    "created_at": "2020-08-20T08:33:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429193",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:3'></a>check simple cases: 0 or 1 vertex, not connected

in folded graphs, it would be nice to have a way to check if the input is antipodal, either calling `is_antipodal`, or using appropriate tests during the construction (if any).

Concerning the construction of the antipodal graph, I have an idea of a better/faster solution than what you propose. I will do some tests and come back to you.



---

archive/issue_comments_429194.json:
```json
{
    "body": "<a id='comment:4'></a>also, the current construction for antipodal graphs, `G = self.distance_graph(self.diameter())`, contains all the vertices of `G`. Is it correct according the definition of antipodal graphs ?",
    "created_at": "2020-08-20T08:53:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429194",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:4'></a>also, the current construction for antipodal graphs, `G = self.distance_graph(self.diameter())`, contains all the vertices of `G`. Is it correct according the definition of antipodal graphs ?



---

archive/issue_comments_429195.json:
```json
{
    "body": "<a id='comment:5'></a>The idea to build the antipodal graph is the following (adding only the vertices involved in an antipodal pair):\n\n```\ndef antipodal_graph(G):\n    \"\"\"\n    Return the antipodal graph of ``G``.\n    \"\"\"\n    ecc = G.eccentricity(algorithm=\"DHV\", with_labels=True)\n    diam = max(ecc.values())\n    # Get the list of antipodal vertices, i.e., with eccentricity = diameter\n    V = [u for u, ecc_u in ecc.items() if ecc_u == diam]\n\n    E = set()\n    for u in V:\n        for v, d in G.breadth_first_search(u, report_distance=True):\n            if d == diam:\n                E.add(frozenset((u, v)))\n\n    name = f\"antipodal graph of {G.name()}\"\n    return Graph([V, E], format='vertices_and_edges', name=name)\n```\nIt is interesting for large graphs (e.g., >= 1000 nodes), and significant speed up can be obtained using Cython.\nAlso, the space complexity is in `O(n)`, while the current method has space complexity in `O(n^2)`.\n\nThe main idea is to:\n- first compute the eccentricity of the vertices. The DHV algorithm is fast in practice and usually compute distances from a few vertices.\n- Then, for each vertex with eccentricity = diameter, we search for the antipodal pairs.\n\nIt can be done quickly on large graphs. But of course it is not interesting for graphs like `JohnsonGraph(10, 5)`.\n\nThis can be done in another ticket. It requires some care to get a fast implementation.",
    "created_at": "2020-08-20T09:21:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429195",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:5'></a>The idea to build the antipodal graph is the following (adding only the vertices involved in an antipodal pair):

```
def antipodal_graph(G):
    """
    Return the antipodal graph of ``G``.
    """
    ecc = G.eccentricity(algorithm="DHV", with_labels=True)
    diam = max(ecc.values())
    # Get the list of antipodal vertices, i.e., with eccentricity = diameter
    V = [u for u, ecc_u in ecc.items() if ecc_u == diam]

    E = set()
    for u in V:
        for v, d in G.breadth_first_search(u, report_distance=True):
            if d == diam:
                E.add(frozenset((u, v)))

    name = f"antipodal graph of {G.name()}"
    return Graph([V, E], format='vertices_and_edges', name=name)
```
It is interesting for large graphs (e.g., >= 1000 nodes), and significant speed up can be obtained using Cython.
Also, the space complexity is in `O(n)`, while the current method has space complexity in `O(n^2)`.

The main idea is to:
- first compute the eccentricity of the vertices. The DHV algorithm is fast in practice and usually compute distances from a few vertices.
- Then, for each vertex with eccentricity = diameter, we search for the antipodal pairs.

It can be done quickly on large graphs. But of course it is not interesting for graphs like `JohnsonGraph(10, 5)`.

This can be done in another ticket. It requires some care to get a fast implementation.



---

archive/issue_comments_429196.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:4 dcoudert]:\n> also, the current construction for antipodal graphs, `G = self.distance_graph(self.diameter())`, contains all the vertices of `G`. Is it correct according the definition of antipodal graphs ?\n\nProbably depends on your definition of antipodal graph. The definition I believe to be the most common is:\nGiven a graph G, the antipodal graph of G, denoted by A(G), has the same vertex set of G and two vertices are adjacent if their distance in G is equal to the diameter of G. If G is disconnected we define its diameter to be (plus) infinity.\n\nIf you know any other definition that ends up being more useful in some scenarios, then let me know.\n\nHowever, note that I never call `G = self.distance_graph(self.diameter())` the antipodal graph of `self`, but only the distance-d graph.\n\nThe current implementations are rather slow so if your proposal is actually faster is very appreciated. However, I don't think your proposal computes the same graph as the straightforward `self.distance_graph(self.diameter())` since some vertices can be left out.\n\nI'll fix your review comments, try speed things up and get back to you.",
    "created_at": "2020-08-20T10:11:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429196",
    "user": "https://github.com/Ivo-Maffei"
}
```

<a id='comment:6'></a>Replying to [comment:4 dcoudert]:
> also, the current construction for antipodal graphs, `G = self.distance_graph(self.diameter())`, contains all the vertices of `G`. Is it correct according the definition of antipodal graphs ?

Probably depends on your definition of antipodal graph. The definition I believe to be the most common is:
Given a graph G, the antipodal graph of G, denoted by A(G), has the same vertex set of G and two vertices are adjacent if their distance in G is equal to the diameter of G. If G is disconnected we define its diameter to be (plus) infinity.

If you know any other definition that ends up being more useful in some scenarios, then let me know.

However, note that I never call `G = self.distance_graph(self.diameter())` the antipodal graph of `self`, but only the distance-d graph.

The current implementations are rather slow so if your proposal is actually faster is very appreciated. However, I don't think your proposal computes the same graph as the straightforward `self.distance_graph(self.diameter())` since some vertices can be left out.

I'll fix your review comments, try speed things up and get back to you.



---

archive/issue_comments_429197.json:
```json
{
    "body": "<a id='comment:7'></a>to get the same vertex set, it suffices to use `Graph([G, E], ...)`.",
    "created_at": "2020-08-20T10:14:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429197",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:7'></a>to get the same vertex set, it suffices to use `Graph([G, E], ...)`.



---

archive/issue_comments_429198.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-20T12:04:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429198",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_429199.json:
```json
{
    "body": "<a id='comment:9'></a>A few things:\n\nI can't think of any disconnected antipodal graph to check what `folded_graph` would do.\nAt the moment `folded_graph` and `is_antipodal` raise a `ValueError` when the graph is empty as \"its diameter is undefined\".\nI personally don't like this, and I would set `is_antipodal` to True and the `folded_graph` would be empty, but this might be unnatural.\n\nI tried your implementation of `antipodal_graph` in a cython file (sage\\graphs\\generators\\distance_regular.pyx) and it seems very slow (not sure why). So I wrote another `antipodal_graph` method which is pretty straight-forward and tested them a bit on a large graph\n\n```sage\nsage: from sage.graphs.generators.distance_regular import antipodal_graph1, antipodal_graph2                                                                                                                                                  \nsage: G = graphs.JohnsonGraph(14, 7)                                                                                                                                                                                                          \nsage: G                                                                                                                                                                                                                                       \nJohnson graph with parameters 14,7: Graph on 3432 vertices\nsage: %timeit antipodal_graph1(G)                                                                                                                                                                                                             \n29.3 s \u00b1 814 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\nsage: %time antipodal_graph2(G)\n# don't know; stopped after > 3 min\n```\n\nI don't think the filtering `V = [u for u, ecc_u in ecc.items() if ecc_u == diam]` is any good in this scenario as all eccentricities are equal to the diameter 7.\n\nUnless you spot some obvious mistake I did, I think I'll open another ticket to get a fast implementation of `antipodal_graph`.",
    "created_at": "2020-08-20T12:11:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429199",
    "user": "https://github.com/Ivo-Maffei"
}
```

<a id='comment:9'></a>A few things:

I can't think of any disconnected antipodal graph to check what `folded_graph` would do.
At the moment `folded_graph` and `is_antipodal` raise a `ValueError` when the graph is empty as "its diameter is undefined".
I personally don't like this, and I would set `is_antipodal` to True and the `folded_graph` would be empty, but this might be unnatural.

I tried your implementation of `antipodal_graph` in a cython file (sage\graphs\generators\distance_regular.pyx) and it seems very slow (not sure why). So I wrote another `antipodal_graph` method which is pretty straight-forward and tested them a bit on a large graph

```sage
sage: from sage.graphs.generators.distance_regular import antipodal_graph1, antipodal_graph2                                                                                                                                                  
sage: G = graphs.JohnsonGraph(14, 7)                                                                                                                                                                                                          
sage: G                                                                                                                                                                                                                                       
Johnson graph with parameters 14,7: Graph on 3432 vertices
sage: %timeit antipodal_graph1(G)                                                                                                                                                                                                             
29.3 s ± 814 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
sage: %time antipodal_graph2(G)
# don't know; stopped after > 3 min
```

I don't think the filtering `V = [u for u, ecc_u in ecc.items() if ecc_u == diam]` is any good in this scenario as all eccentricities are equal to the diameter 7.

Unless you spot some obvious mistake I did, I think I'll open another ticket to get a fast implementation of `antipodal_graph`.



---

archive/issue_comments_429200.json:
```json
{
    "body": "<a id='comment:10'></a>Your implementation of `antipodal_graph2` is less efficient than mine. Indeed, you compute BFS from all vertices, while my proposal is to compute BFS only from vertices with eccentricity the diameter.\nOf course, in a graph like the `JohnsonGraph` where all vertices have for eccentricity the diameter, my method will be slower than the basic method. But if you try on a 2D grid graph, the proposed method should be way faster. In such graph, the DHV algorithm will compute all eccentricities with about 8 BFS, and then you have to compute BFS from only 4 vertices to get the result.\nThis is related to a research project I'm currently working on, and that can be used to enumerate (antipodal) pairs quickly and using few memory.\n\n\nA separate ticket is much better. I don't have time yet to work on it and will ask Vipul Gupta to help.\n\nRoughly, to be efficient, it must be implemented using `short_digraph` (see `distances_all_pairs.pyx`), and call low level methods. However, I realize that we have several improvement to do before in `distances_all_pairs.pyx` to avoid extra conversions from one format to the other (not difficult).",
    "created_at": "2020-08-20T13:05:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429200",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:10'></a>Your implementation of `antipodal_graph2` is less efficient than mine. Indeed, you compute BFS from all vertices, while my proposal is to compute BFS only from vertices with eccentricity the diameter.
Of course, in a graph like the `JohnsonGraph` where all vertices have for eccentricity the diameter, my method will be slower than the basic method. But if you try on a 2D grid graph, the proposed method should be way faster. In such graph, the DHV algorithm will compute all eccentricities with about 8 BFS, and then you have to compute BFS from only 4 vertices to get the result.
This is related to a research project I'm currently working on, and that can be used to enumerate (antipodal) pairs quickly and using few memory.


A separate ticket is much better. I don't have time yet to work on it and will ask Vipul Gupta to help.

Roughly, to be efficient, it must be implemented using `short_digraph` (see `distances_all_pairs.pyx`), and call low level methods. However, I realize that we have several improvement to do before in `distances_all_pairs.pyx` to avoid extra conversions from one format to the other (not difficult).



---

archive/issue_comments_429201.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-20T13:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429201",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_429202.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-20T14:05:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429202",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_429203.json:
```json
{
    "body": "<a id='comment:13'></a>let us limit this ticket to the distance regular case, and deal with a general case on another ticket.",
    "created_at": "2020-08-22T08:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429203",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:13'></a>let us limit this ticket to the distance regular case, and deal with a general case on another ticket.



---

archive/issue_comments_429204.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-22T10:40:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429204",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_429205.json:
```json
{
    "body": "<a id='comment:15'></a>I pushed minor corrections. In particular, for the mapping int -> cliques, we can simply use a list.",
    "created_at": "2020-08-22T10:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429205",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:15'></a>I pushed minor corrections. In particular, for the mapping int -> cliques, we can simply use a list.



---

archive/issue_comments_429206.json:
```json
{
    "body": "<a id='comment:16'></a>LGTM.",
    "created_at": "2020-08-22T10:43:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429206",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:16'></a>LGTM.



---

archive/issue_comments_429207.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-22T10:43:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429207",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_429208.json:
```json
{
    "body": "<a id='comment:17'></a>Merge conflict",
    "created_at": "2020-08-23T22:23:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429208",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:17'></a>Merge conflict



---

archive/issue_comments_429209.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-08-23T22:23:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429209",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_429210.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-24T09:42:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429210",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_429211.json:
```json
{
    "body": "<a id='comment:19'></a>Nothing major, just a conflict with #30355",
    "created_at": "2020-08-24T09:44:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429211",
    "user": "https://github.com/Ivo-Maffei"
}
```

<a id='comment:19'></a>Nothing major, just a conflict with #30355



---

archive/issue_comments_429212.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2020-08-24T09:44:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429212",
    "user": "https://github.com/Ivo-Maffei"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_429213.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-08-30T08:38:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30394#issuecomment-429213",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_078807.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-08-30T08:38:50Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30394",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30394#event-78807"
}
```
