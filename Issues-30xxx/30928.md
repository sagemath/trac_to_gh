# Issue 30928: Backslash line continuation broken when defining a callable symbolic expression

archive/issues_030691.json:
```json
{
    "assignees": [],
    "body": "As reported in https://groups.google.com/g/sage-devel/c/XD1VtG0TOEk/m/Lo6L8YBGCgAJ, we have currently (Sage 9.2 and 9.3.beta1):\n\n```\nsage: f(x) = x \\ \n....:        + 1                                                                                    \n  File \"<ipython-input-1-a5c1e14e19da>\", line 1\n    __tmp__=var(\"x\"); f = symbolic_expression(x  * BackslashOperator() * ).function(x)\n                                                                         ^\nSyntaxError: invalid syntax\n```\nThere was no such issue with Sage 9.1 and lower. \n\nCC:  @jcamp0x2a @slel\n\nKeywords: **callable symbolic expression, backslash, preparser**\n\nBranch/Commit: **[64c5757](https://github.com/sagemath/sagetrac-mirror/commit/64c5757b4fb67d492f0c64cf7d3bda2d3616b56c)**\n\nReviewer: **Steven Trogdon, Eric Gourgoulhon**\n\nAuthor: **Joshua Campbell**\n\nComponent: **symbolics**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/30928_\n\n",
    "closed_at": "2020-12-05T22:13:29Z",
    "created_at": "2020-11-16T16:42:16Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20symbolics",
        "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Backslash line continuation broken when defining a callable symbolic expression",
    "type": "issue",
    "updated_at": "2020-12-05T22:13:29Z",
    "url": "https://github.com/sagemath/sage/issues/30928",
    "user": "https://github.com/egourgoulhon"
}
```
As reported in https://groups.google.com/g/sage-devel/c/XD1VtG0TOEk/m/Lo6L8YBGCgAJ, we have currently (Sage 9.2 and 9.3.beta1):

```
sage: f(x) = x \ 
....:        + 1                                                                                    
  File "<ipython-input-1-a5c1e14e19da>", line 1
    __tmp__=var("x"); f = symbolic_expression(x  * BackslashOperator() * ).function(x)
                                                                         ^
SyntaxError: invalid syntax
```
There was no such issue with Sage 9.1 and lower. 

CC:  @jcamp0x2a @slel

Keywords: **callable symbolic expression, backslash, preparser**

Branch/Commit: **[64c5757](https://github.com/sagemath/sagetrac-mirror/commit/64c5757b4fb67d492f0c64cf7d3bda2d3616b56c)**

Reviewer: **Steven Trogdon, Eric Gourgoulhon**

Author: **Joshua Campbell**

Component: **symbolics**

_Issue created by migration from https://trac.sagemath.org/ticket/30928_





---

archive/issue_events_426570.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2020-11-16T16:42:16Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30928#event-426570"
}
```



---

archive/issue_events_426571.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2020-11-16T16:42:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20symbolics",
    "label_color": "0000ff",
    "label_name": "c: symbolics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30928#event-426571"
}
```



---

archive/issue_events_426572.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2020-11-16T16:42:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30928#event-426572"
}
```



---

archive/issue_events_426573.json:
```json
{
    "actor": "https://github.com/egourgoulhon",
    "created_at": "2020-11-16T16:42:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30928#event-426573"
}
```



---

archive/issue_comments_495613.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nThe issue is already there in Sage 9.2.beta14.",
    "created_at": "2020-11-16T16:42:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495613",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:1" align="right">comment:1</div>

The issue is already there in Sage 9.2.beta14.



---

archive/issue_comments_495614.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nFWIW, in Sage 9.3.beta1, we have\n\n```\nsage: preparse(r\"f(x) = x \\ + 1\")                                                                  \n'__tmp__=var(\"x\"); f = symbolic_expression(x  * BackslashOperator() * + Integer(1)).function(x)'\n```\nwhich is correct, while in the reported issue the second line is entirely missing after `BackslahOperator() *`, which triggers the syntax error.",
    "created_at": "2020-11-17T07:59:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495614",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:2" align="right">comment:2</div>

FWIW, in Sage 9.3.beta1, we have

```
sage: preparse(r"f(x) = x \ + 1")                                                                  
'__tmp__=var("x"); f = symbolic_expression(x  * BackslashOperator() * + Integer(1)).function(x)'
```
which is correct, while in the reported issue the second line is entirely missing after `BackslahOperator() *`, which triggers the syntax error.



---

archive/issue_comments_495615.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThe bug could arise from the upgrade to ipython 7 performed in #28197 (merged in Sage 9.2.beta8) or from the follow-up ticket #30417 (merged in Sage 9.2.beta11).",
    "created_at": "2020-11-17T08:07:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495615",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:3" align="right">comment:3</div>

The bug could arise from the upgrade to ipython 7 performed in #28197 (merged in Sage 9.2.beta8) or from the follow-up ticket #30417 (merged in Sage 9.2.beta11).



---

archive/issue_comments_495616.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nI may be off base, but the following may be important\n\n```\nsage: from sage.repl.interpreter import get_test_shell                                                                                                                                               \nsage: shell = get_test_shell()                                                                                                                                                                       \nsage: shell.run_cell('f(x) = x \\ + 1')                                                                                                                                                               \n<input>:1: DeprecationWarning: invalid escape sequence \\ \n<>:1: DeprecationWarning: invalid escape sequence \\ \n<ipython-input-19-e03ae3fa6f44>:1: DeprecationWarning: invalid escape sequence \\ \n  shell.run_cell('f(x) = x \\ + 1')\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n<ipython-input-19-81598207d80e> in <module>\n----> 1 __tmp__=var(\"x\"); f = symbolic_expression(x  * BackslashOperator() * + Integer(1)).function(x)\n\n/local/sage-git/sage/local/lib/python3.8/site-packages/sage/misc/misc.py in __mul__(self, right)\n    829             (0.0, 0.5, 1.0, 1.5, 2.0)\n    830         \"\"\"\n--> 831         return self.left._backslash_(right)\n    832 \n    833 \n\n/local/sage-git/sage/local/lib/python3.8/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__getattr__ (build/cythonized/sage/structure/element.c:4701)()\n    491             AttributeError: 'LeftZeroSemigroup_with_category.element_class' object has no attribute 'blah_blah'\n    492         \"\"\"\n--> 493         return self.getattr_from_category(name)\n    494 \n    495     cdef getattr_from_category(self, name):\n\n/local/sage-git/sage/local/lib/python3.8/site-packages/sage/structure/element.pyx in sage.structure.element.Element.getattr_from_category (build/cythonized/sage/structure/element.c:4813)()\n    504         else:\n    505             cls = P._abstract_element_class\n--> 506         return getattr_from_other_class(self, cls, name)\n    507 \n    508     def __dir__(self):\n\n/local/sage-git/sage/local/lib/python3.8/site-packages/sage/cpython/getattr.pyx in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2620)()\n    370         dummy_error_message.cls = type(self)\n    371         dummy_error_message.name = name\n--> 372         raise AttributeError(dummy_error_message)\n    373     attribute = <object>attr\n    374     # Check for a descriptor (__get__ in Python)\n\nAttributeError: 'sage.symbolic.expression.Expression' object has no attribute '_backslash_'\n<ExecutionResult object at 7f213d0cd130, execution_count=None error_before_exec=None error_in_exec='sage.symbolic.expression.Expression' object has no attribute '_backslash_' info=<ExecutionInfo object at 7f213d09fc40, raw_cell=\"f(x) = x \\ + 1\" store_history=False silent=False shell_futures=True> result=None>\n```",
    "created_at": "2020-11-18T00:22:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495616",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:4" align="right">comment:4</div>

I may be off base, but the following may be important

```
sage: from sage.repl.interpreter import get_test_shell                                                                                                                                               
sage: shell = get_test_shell()                                                                                                                                                                       
sage: shell.run_cell('f(x) = x \ + 1')                                                                                                                                                               
<input>:1: DeprecationWarning: invalid escape sequence \ 
<>:1: DeprecationWarning: invalid escape sequence \ 
<ipython-input-19-e03ae3fa6f44>:1: DeprecationWarning: invalid escape sequence \ 
  shell.run_cell('f(x) = x \ + 1')
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-19-81598207d80e> in <module>
----> 1 __tmp__=var("x"); f = symbolic_expression(x  * BackslashOperator() * + Integer(1)).function(x)

/local/sage-git/sage/local/lib/python3.8/site-packages/sage/misc/misc.py in __mul__(self, right)
    829             (0.0, 0.5, 1.0, 1.5, 2.0)
    830         """
--> 831         return self.left._backslash_(right)
    832 
    833 

/local/sage-git/sage/local/lib/python3.8/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__getattr__ (build/cythonized/sage/structure/element.c:4701)()
    491             AttributeError: 'LeftZeroSemigroup_with_category.element_class' object has no attribute 'blah_blah'
    492         """
--> 493         return self.getattr_from_category(name)
    494 
    495     cdef getattr_from_category(self, name):

/local/sage-git/sage/local/lib/python3.8/site-packages/sage/structure/element.pyx in sage.structure.element.Element.getattr_from_category (build/cythonized/sage/structure/element.c:4813)()
    504         else:
    505             cls = P._abstract_element_class
--> 506         return getattr_from_other_class(self, cls, name)
    507 
    508     def __dir__(self):

/local/sage-git/sage/local/lib/python3.8/site-packages/sage/cpython/getattr.pyx in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2620)()
    370         dummy_error_message.cls = type(self)
    371         dummy_error_message.name = name
--> 372         raise AttributeError(dummy_error_message)
    373     attribute = <object>attr
    374     # Check for a descriptor (__get__ in Python)

AttributeError: 'sage.symbolic.expression.Expression' object has no attribute '_backslash_'
<ExecutionResult object at 7f213d0cd130, execution_count=None error_before_exec=None error_in_exec='sage.symbolic.expression.Expression' object has no attribute '_backslash_' info=<ExecutionInfo object at 7f213d09fc40, raw_cell="f(x) = x \ + 1" store_history=False silent=False shell_futures=True> result=None>
```



---

archive/issue_comments_495617.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nI get the same if `f(x) = x \\ + 1` is typed at the sage prompt. So probably not the correct thing to try.",
    "created_at": "2020-11-18T00:47:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495617",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:5" align="right">comment:5</div>

I get the same if `f(x) = x \ + 1` is typed at the sage prompt. So probably not the correct thing to try.



---

archive/issue_comments_495618.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@strogdon](#comment:5):\n> I get the same if `f(x) = x \\ + 1` is typed at the sage prompt. So probably not the correct thing to try.\n\nYes probably; moreover `shell.run_cell(r'f(x) = x \\ + 1')` yields the same `AttributeError` in Sage 9.1, where everything is fine with backslash line continuation.",
    "created_at": "2020-11-18T08:16:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495618",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@strogdon](#comment:5):
> I get the same if `f(x) = x \ + 1` is typed at the sage prompt. So probably not the correct thing to try.

Yes probably; moreover `shell.run_cell(r'f(x) = x \ + 1')` yields the same `AttributeError` in Sage 9.1, where everything is fine with backslash line continuation.



---

archive/issue_comments_495619.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nSome data points. I think `sage/repl/preparser.py` and perhaps `sage/repl/interpreter.py` need significant changes. Adding `print` statements as\n\n```diff\ndiff --git a/src/sage/repl/interpreter.py b/src/sage/repl/interpreter.py\nindex b70345f940..206041e4a1 100644\n--- a/src/sage/repl/interpreter.py\n+++ b/src/sage/repl/interpreter.py\n@@ -444,6 +444,7 @@ def SagePreparseTransformer(lines):\n         sage: # instead of [\"'''\", 'abc-Integer(1)-Integer(2)', \"'''\"]\n \n     \"\"\"\n+    print('we are now in sage.repl.interpreter.SagePreparseTransformer')\n     lines_out = []\n     reset = True\n     for line in lines:\ndiff --git a/src/sage/repl/preparse.py b/src/sage/repl/preparse.py\nindex 3619fd9e54..2073caa855 100644\n--- a/src/sage/repl/preparse.py\n+++ b/src/sage/repl/preparse.py\n@@ -1745,6 +1745,8 @@ def preparse(line, reset=True, do_time=False, ignore_prompts=False,\n         quote_state = None\n \n     L = line.lstrip()\n+    print('result of L = line.lstrip() in sage.repl.preparse')\n+    print(L)\n     if len(L) > 0 and L[0] in ['#', '!']:\n         return line\n```\nI see:\n\n```\nsage: f(x) = x \\ \n....:        + 1                                                                \nwe are now in sage.repl.interpreter.SagePreparseTransformer\nresult of L = line.lstrip() in sage.repl.preparse\nf(x) = x \\\n\nresult of L = line.lstrip() in sage.repl.preparse\n+ 1\n\nwe are now in sage.repl.interpreter.SagePreparseTransformer\nresult of L = line.lstrip() in sage.repl.preparse\nf(x) = x \\\n\nresult of L = line.lstrip() in sage.repl.preparse\n+ 1\n\n  File \"<ipython-input-1-a5c1e14e19da>\", line 1\n    __tmp__=var(\"x\"); f = symbolic_expression(x  * BackslashOperator() * ).function(x)\n                                                                         ^\nSyntaxError: invalid syntax\n```\nNote that `preparse` is called from `interpreter` and it is called twice! I don't believe it should be called twice. Furthermore `preparse` treats the input as two separate lines instead of one line separated by the `\\` continuation character. This results in `\\` being interpreted as the `* BackslashOperator() *`. I'm unable to test for a properly-functioning Sage.",
    "created_at": "2020-11-20T06:22:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495619",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:7" align="right">comment:7</div>

Some data points. I think `sage/repl/preparser.py` and perhaps `sage/repl/interpreter.py` need significant changes. Adding `print` statements as

```diff
diff --git a/src/sage/repl/interpreter.py b/src/sage/repl/interpreter.py
index b70345f940..206041e4a1 100644
--- a/src/sage/repl/interpreter.py
+++ b/src/sage/repl/interpreter.py
@@ -444,6 +444,7 @@ def SagePreparseTransformer(lines):
         sage: # instead of ["'''", 'abc-Integer(1)-Integer(2)', "'''"]
 
     """
+    print('we are now in sage.repl.interpreter.SagePreparseTransformer')
     lines_out = []
     reset = True
     for line in lines:
diff --git a/src/sage/repl/preparse.py b/src/sage/repl/preparse.py
index 3619fd9e54..2073caa855 100644
--- a/src/sage/repl/preparse.py
+++ b/src/sage/repl/preparse.py
@@ -1745,6 +1745,8 @@ def preparse(line, reset=True, do_time=False, ignore_prompts=False,
         quote_state = None
 
     L = line.lstrip()
+    print('result of L = line.lstrip() in sage.repl.preparse')
+    print(L)
     if len(L) > 0 and L[0] in ['#', '!']:
         return line
```
I see:

```
sage: f(x) = x \ 
....:        + 1                                                                
we are now in sage.repl.interpreter.SagePreparseTransformer
result of L = line.lstrip() in sage.repl.preparse
f(x) = x \

result of L = line.lstrip() in sage.repl.preparse
+ 1

we are now in sage.repl.interpreter.SagePreparseTransformer
result of L = line.lstrip() in sage.repl.preparse
f(x) = x \

result of L = line.lstrip() in sage.repl.preparse
+ 1

  File "<ipython-input-1-a5c1e14e19da>", line 1
    __tmp__=var("x"); f = symbolic_expression(x  * BackslashOperator() * ).function(x)
                                                                         ^
SyntaxError: invalid syntax
```
Note that `preparse` is called from `interpreter` and it is called twice! I don't believe it should be called twice. Furthermore `preparse` treats the input as two separate lines instead of one line separated by the `\` continuation character. This results in `\` being interpreted as the `* BackslashOperator() *`. I'm unable to test for a properly-functioning Sage.



---

archive/issue_comments_495620.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nI think this may have been introduced by the transition to IPython 7 and how its new input transformer API deals with lines. For example, commenting out the backslash substitution altogether in [preparse.py](https://github.com/sagemath/sage/blob/9.3.beta1/src/sage/repl/preparse.py#L1807) still yields:\n\n```python\nsage: f(x) = x \\\n....:        + 1\n  File \"<ipython-input-1-bc21d2198ee4>\", line 1\n    __tmp__=var(\"x\"); f = symbolic_expression(x \\).function(x)\n                                                              ^\nSyntaxError: unexpected character after line continuation character\n```\n\nIn the old IPython [input transformer docs](https://ipython.org/ipython-doc/3/config/inputtransforms.html#string-based-transformations), it appears there were three types of transformer: physical line, logical line, and python line. In the [same docs](https://ipython.readthedocs.io/en/stable/config/inputtransforms.html#string-based-transformations) for IPython 7, there now only appears to be two: cleanup and post.\n\nJudging by the change to [ipython_extension.py](https://github.com/sagemath/sagetrac-mirror/blob/f55701e735b9cad2a04370b48f1148984477046a/src/sage/repl/ipython_extension.py) for #28197, it looks like the SagePromptTransformer was moved from \"physical line\" to \"cleanup\" and SagePreparseTransformer from \"python line\" to \"post\".\n\nI'm wondering if that \"post\" is not quite the same as the old \"python line\" however and functions more like the old \"logical line\". That could explain why #30417 that I fixed arose in the first place.\n\nI have a couple ideas for how to patch this in the short term, but neither is likely to be particularly elegant. I'll play around with them and see if I can get something pushed in the next couple days.\n\nI agree with @strogdon that some significant changes/cleanup are needed in the preparser and interpreter in order to fix this properly. I know there was talk in #28974 about building a proper grammar and parser for Sage to remove the need for all these regex kludges. Would be a large undertaking though.",
    "created_at": "2020-11-20T20:32:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495620",
    "user": "https://github.com/jcamp0x2a"
}
```

<div id="comment:9" align="right">comment:9</div>

I think this may have been introduced by the transition to IPython 7 and how its new input transformer API deals with lines. For example, commenting out the backslash substitution altogether in [preparse.py](https://github.com/sagemath/sage/blob/9.3.beta1/src/sage/repl/preparse.py#L1807) still yields:

```python
sage: f(x) = x \
....:        + 1
  File "<ipython-input-1-bc21d2198ee4>", line 1
    __tmp__=var("x"); f = symbolic_expression(x \).function(x)
                                                              ^
SyntaxError: unexpected character after line continuation character
```

In the old IPython [input transformer docs](https://ipython.org/ipython-doc/3/config/inputtransforms.html#string-based-transformations), it appears there were three types of transformer: physical line, logical line, and python line. In the [same docs](https://ipython.readthedocs.io/en/stable/config/inputtransforms.html#string-based-transformations) for IPython 7, there now only appears to be two: cleanup and post.

Judging by the change to [ipython_extension.py](https://github.com/sagemath/sagetrac-mirror/blob/f55701e735b9cad2a04370b48f1148984477046a/src/sage/repl/ipython_extension.py) for #28197, it looks like the SagePromptTransformer was moved from "physical line" to "cleanup" and SagePreparseTransformer from "python line" to "post".

I'm wondering if that "post" is not quite the same as the old "python line" however and functions more like the old "logical line". That could explain why #30417 that I fixed arose in the first place.

I have a couple ideas for how to patch this in the short term, but neither is likely to be particularly elegant. I'll play around with them and see if I can get something pushed in the next couple days.

I agree with @strogdon that some significant changes/cleanup are needed in the preparser and interpreter in order to fix this properly. I know there was talk in #28974 about building a proper grammar and parser for Sage to remove the need for all these regex kludges. Would be a large undertaking though.



---

archive/issue_comments_495621.json:
```json
{
    "body": "Commit: **[68afcdb](https://github.com/sagemath/sagetrac-mirror/commit/68afcdb5b7ebf42e1a5c35e894759978d1bb1391)**",
    "created_at": "2020-11-21T23:28:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495621",
    "user": "https://github.com/jcamp0x2a"
}
```

Commit: **[68afcdb](https://github.com/sagemath/sagetrac-mirror/commit/68afcdb5b7ebf42e1a5c35e894759978d1bb1391)**



---

archive/issue_comments_495622.json:
```json
{
    "body": "Branch: **[u/gh-jcamp0x2a/30928-backslash-continuation](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-jcamp0x2a/30928-backslash-continuation)**",
    "created_at": "2020-11-21T23:28:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495622",
    "user": "https://github.com/jcamp0x2a"
}
```

Branch: **[u/gh-jcamp0x2a/30928-backslash-continuation](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-jcamp0x2a/30928-backslash-continuation)**



---

archive/issue_comments_495623.json:
```json
{
    "body": "Author: **Joshua Campbell**",
    "created_at": "2020-11-21T23:28:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495623",
    "user": "https://github.com/jcamp0x2a"
}
```

Author: **Joshua Campbell**



---

archive/issue_comments_495624.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nI've pushed a potential fix.\n\n- `preparse` removes backslash+newline combinations, putting such constructions onto the same line. This happens after `strip_string_literals` so we don't have to worry about backslash continuations inside strings, and it happens before `preparse_calculus` so that it can surround the entire thing with a `symbolic_expression` call.\n\n- For the IPython use case, I've just squashed the list of lines into a single string and passed that to `preparse` instead of going line-by-line. The prompts should've already been removed by the `SagePromptTransformer` so I think that's a safe operation. Also, since IPython has already handled the `%` magic commands immediately prior to our `SagePreparseTransformer`, I removed the explicit check for them.\n\n- I've done something similar for the `preparse_file` use case with the complication of supporting `load` and `attach` statements. Basically, just calls `preparse` on batches between such statements and between them and the beginning/end of file.\n\nAs predicted: not the most elegant fix, and there's a fair chance I broke another edge case somewhere in the process. I'm not sure how else to fix it without tearing up a bunch of the existing preparser code. Input most welcome! :)\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/68afcdb5b7ebf42e1a5c35e894759978d1bb1391\">68afcdb</a></td><td><code>Fix backslash continuation for symbolic expressions</code></td></tr></table>\n",
    "created_at": "2020-11-21T23:28:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495624",
    "user": "https://github.com/jcamp0x2a"
}
```

<div id="comment:10" align="right">comment:10</div>

I've pushed a potential fix.

- `preparse` removes backslash+newline combinations, putting such constructions onto the same line. This happens after `strip_string_literals` so we don't have to worry about backslash continuations inside strings, and it happens before `preparse_calculus` so that it can surround the entire thing with a `symbolic_expression` call.

- For the IPython use case, I've just squashed the list of lines into a single string and passed that to `preparse` instead of going line-by-line. The prompts should've already been removed by the `SagePromptTransformer` so I think that's a safe operation. Also, since IPython has already handled the `%` magic commands immediately prior to our `SagePreparseTransformer`, I removed the explicit check for them.

- I've done something similar for the `preparse_file` use case with the complication of supporting `load` and `attach` statements. Basically, just calls `preparse` on batches between such statements and between them and the beginning/end of file.

As predicted: not the most elegant fix, and there's a fair chance I broke another edge case somewhere in the process. I'm not sure how else to fix it without tearing up a bunch of the existing preparser code. Input most welcome! :)

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/68afcdb5b7ebf42e1a5c35e894759978d1bb1391">68afcdb</a></td><td><code>Fix backslash continuation for symbolic expressions</code></td></tr></table>




---

archive/issue_events_426574.json:
```json
{
    "actor": "https://github.com/jcamp0x2a",
    "created_at": "2020-11-21T23:28:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30928#event-426574"
}
```



---

archive/issue_comments_495625.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nInitial testing indicates that line continuation is now working. However, regardless the input after the `sage: ` prompt, that input is parsed twice. Perhaps this is a separate issue or maybe not an issue? \n\nExample:\n\n```\nsage: f(x) = x \\ \n....:        + 1 \\ \n....:        + x^2                                                                                                                                                                                   \nwe are now in sage.repl.interpreter.SagePreparseTransformer\nresult of L = line.lstrip() in sage.repl.preparse\nf(x) = x \\\n       + 1 \\\n       + x^2\n\nwe are now in sage.repl.interpreter.SagePreparseTransformer\nresult of L = line.lstrip() in sage.repl.preparse\nf(x) = x \\\n       + 1 \\\n       + x^2\n\nsage: f(x)                                                                                                                                                                                           \nwe are now in sage.repl.interpreter.SagePreparseTransformer\nresult of L = line.lstrip() in sage.repl.preparse\nf(x)\n\nwe are now in sage.repl.interpreter.SagePreparseTransformer\nresult of L = line.lstrip() in sage.repl.preparse\nf(x)\n\nx^2 + x + 1\n```",
    "created_at": "2020-11-22T02:09:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495625",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:11" align="right">comment:11</div>

Initial testing indicates that line continuation is now working. However, regardless the input after the `sage: ` prompt, that input is parsed twice. Perhaps this is a separate issue or maybe not an issue? 

Example:

```
sage: f(x) = x \ 
....:        + 1 \ 
....:        + x^2                                                                                                                                                                                   
we are now in sage.repl.interpreter.SagePreparseTransformer
result of L = line.lstrip() in sage.repl.preparse
f(x) = x \
       + 1 \
       + x^2

we are now in sage.repl.interpreter.SagePreparseTransformer
result of L = line.lstrip() in sage.repl.preparse
f(x) = x \
       + 1 \
       + x^2

sage: f(x)                                                                                                                                                                                           
we are now in sage.repl.interpreter.SagePreparseTransformer
result of L = line.lstrip() in sage.repl.preparse
f(x)

we are now in sage.repl.interpreter.SagePreparseTransformer
result of L = line.lstrip() in sage.repl.preparse
f(x)

x^2 + x + 1
```



---

archive/issue_comments_495626.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nHmm... perhaps this is an IPython quirk? For example, running an IPython installed completely independently of Sage:\n\n```\n$ ~/.local/bin/ipython3\nPython 3.6.9 (default, Oct  8 2020, 12:12:24)\nType 'copyright', 'credits' or 'license' for more information\nIPython 7.16.1 -- An enhanced Interactive Python. Type '?' for help.\n\nIn [1]: def transform(lines):\n   ...:     print(lines)\n   ...:     return lines\n   ...:\n\nIn [2]: get_ipython().input_transformers_post.append(transform)\n\nIn [3]: 2 + 2\n['2 + 2\\n']\n['2 + 2\\n']\nOut[3]: 4\n```",
    "created_at": "2020-11-22T03:44:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495626",
    "user": "https://github.com/jcamp0x2a"
}
```

<div id="comment:12" align="right">comment:12</div>

Hmm... perhaps this is an IPython quirk? For example, running an IPython installed completely independently of Sage:

```
$ ~/.local/bin/ipython3
Python 3.6.9 (default, Oct  8 2020, 12:12:24)
Type 'copyright', 'credits' or 'license' for more information
IPython 7.16.1 -- An enhanced Interactive Python. Type '?' for help.

In [1]: def transform(lines):
   ...:     print(lines)
   ...:     return lines
   ...:

In [2]: get_ipython().input_transformers_post.append(transform)

In [3]: 2 + 2
['2 + 2\n']
['2 + 2\n']
Out[3]: 4
```



---

archive/issue_comments_495627.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nSame here with `Python 3.8.6`. Bug or feature?",
    "created_at": "2020-11-22T04:23:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495627",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:13" align="right">comment:13</div>

Same here with `Python 3.8.6`. Bug or feature?



---

archive/issue_comments_495628.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@strogdon](#comment:13):\n> Same here with `Python 3.8.6`. Bug or feature?\n\nLooks like intended behavior:\n\n- Issue: [11714](https://github.com/ipython/ipython/issues/11714#issuecomment-490283360) \"Arrow printed twice for autocall\"\n\n- Pull request: [12456](https://github.com/ipython/ipython/pull/12456/files#diff-c8a2543c61a63c87847b7aef4884365e6939107d66784aeb3d0c355449967469R65) \"Allow to mark transformers as having side effects\"\n\nThe new `has_side_effects` attribute would only work in IPython >= 7.17.0, and Sage only requires 7.13.0. Besides, the only side effects here *should* be our debugging print outs, so I vote to just let IPython do its thing.\n\nI'll add a bit about that attribute in `SagePreparseTransformer`'s docstring for those that stumble across this in the future.",
    "created_at": "2020-11-22T16:23:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495628",
    "user": "https://github.com/jcamp0x2a"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@strogdon](#comment:13):
> Same here with `Python 3.8.6`. Bug or feature?

Looks like intended behavior:

- Issue: [11714](https://github.com/ipython/ipython/issues/11714#issuecomment-490283360) "Arrow printed twice for autocall"

- Pull request: [12456](https://github.com/ipython/ipython/pull/12456/files#diff-c8a2543c61a63c87847b7aef4884365e6939107d66784aeb3d0c355449967469R65) "Allow to mark transformers as having side effects"

The new `has_side_effects` attribute would only work in IPython >= 7.17.0, and Sage only requires 7.13.0. Besides, the only side effects here *should* be our debugging print outs, so I vote to just let IPython do its thing.

I'll add a bit about that attribute in `SagePreparseTransformer`'s docstring for those that stumble across this in the future.



---

archive/issue_comments_495629.json:
```json
{
    "body": "<div id=\"comment:15\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e45c71789eb151c5c3c9d15cca17deb9ff3d135c\">e45c717</a></td><td><code>Explain duplicated print outs in SagePreparseTransformer</code></td></tr></table>\n",
    "created_at": "2020-11-22T16:49:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495629",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:15"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e45c71789eb151c5c3c9d15cca17deb9ff3d135c">e45c717</a></td><td><code>Explain duplicated print outs in SagePreparseTransformer</code></td></tr></table>




---

archive/issue_comments_495630.json:
```json
{
    "body": "Changed commit from **[68afcdb](https://github.com/sagemath/sagetrac-mirror/commit/68afcdb5b7ebf42e1a5c35e894759978d1bb1391)** to **[e45c717](https://github.com/sagemath/sagetrac-mirror/commit/e45c71789eb151c5c3c9d15cca17deb9ff3d135c)**",
    "created_at": "2020-11-22T16:49:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495630",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[68afcdb](https://github.com/sagemath/sagetrac-mirror/commit/68afcdb5b7ebf42e1a5c35e894759978d1bb1391)** to **[e45c717](https://github.com/sagemath/sagetrac-mirror/commit/e45c71789eb151c5c3c9d15cca17deb9ff3d135c)**



---

archive/issue_comments_495631.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@jcamp0x2a](#comment:14):\n> Replying to [@strogdon](#comment:13):\n> > Same here with `Python 3.8.6`. Bug or feature?\n\n> \n> Looks like intended behavior:\n> \n> - Issue: [11714](https://github.com/ipython/ipython/issues/11714#issuecomment-490283360) \"Arrow printed twice for autocall\"\n> \n> - Pull request: [12456](https://github.com/ipython/ipython/pull/12456/files#diff-c8a2543c61a63c87847b7aef4884365e6939107d66784aeb3d0c355449967469R65) \"Allow to mark transformers as having side effects\"\n> \n\nGood spotting this. I tried to search the ipython git repo bugs for this without success. I never considered that it was related to a closed issue. I have ipython-7.18.1 here on my Gentoo laptop. Your above `ipython` example, after importing `inputtransformer2` from `IPython.core` and then setting `inputtransformer2.has_side_effects = True`, does work\n\n```\nIn [5]: 2 + 2\n['2 + 2\\n']\nOut[5]: 4\n```\n\nI'm satisfied with this, but will wait to see if @egourgoulhon has any comments.",
    "created_at": "2020-11-23T01:39:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495631",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@jcamp0x2a](#comment:14):
> Replying to [@strogdon](#comment:13):
> > Same here with `Python 3.8.6`. Bug or feature?

> 
> Looks like intended behavior:
> 
> - Issue: [11714](https://github.com/ipython/ipython/issues/11714#issuecomment-490283360) "Arrow printed twice for autocall"
> 
> - Pull request: [12456](https://github.com/ipython/ipython/pull/12456/files#diff-c8a2543c61a63c87847b7aef4884365e6939107d66784aeb3d0c355449967469R65) "Allow to mark transformers as having side effects"
> 

Good spotting this. I tried to search the ipython git repo bugs for this without success. I never considered that it was related to a closed issue. I have ipython-7.18.1 here on my Gentoo laptop. Your above `ipython` example, after importing `inputtransformer2` from `IPython.core` and then setting `inputtransformer2.has_side_effects = True`, does work

```
In [5]: 2 + 2
['2 + 2\n']
Out[5]: 4
```

I'm satisfied with this, but will wait to see if @egourgoulhon has any comments.



---

archive/issue_comments_495632.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@strogdon](#comment:16):\n> I'm satisfied with this, but will wait to see if @egourgoulhon has any comments.\n\nOr if anyone else has comments.",
    "created_at": "2020-11-23T01:46:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495632",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@strogdon](#comment:16):
> I'm satisfied with this, but will wait to see if @egourgoulhon has any comments.

Or if anyone else has comments.



---

archive/issue_comments_495633.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nThanks for the fix!\n\nI made a few tests and everything is OK. So I am +1 for a positive review, once the pyflake error reported by the patchbot error has been fixed.",
    "created_at": "2020-11-23T12:25:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495633",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:18" align="right">comment:18</div>

Thanks for the fix!

I made a few tests and everything is OK. So I am +1 for a positive review, once the pyflake error reported by the patchbot error has been fixed.



---

archive/issue_comments_495634.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nBtw, while making tests for this ticket branch, I found another error:\n\n```\nsage: f(x) = (x +  \n....:         1)                                                                                    \n  File \"<ipython-input-10-ae23cb631161>\", line 1\n    __tmp__=var(\"x\"); f = symbolic_expression((x + ).function(x)\n                                                   ^\nSyntaxError: invalid syntax\n```\nBut this does not pertain to the current ticket: it is already here in Sage 9.1.",
    "created_at": "2020-11-23T12:28:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495634",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:19" align="right">comment:19</div>

Btw, while making tests for this ticket branch, I found another error:

```
sage: f(x) = (x +  
....:         1)                                                                                    
  File "<ipython-input-10-ae23cb631161>", line 1
    __tmp__=var("x"); f = symbolic_expression((x + ).function(x)
                                                   ^
SyntaxError: invalid syntax
```
But this does not pertain to the current ticket: it is already here in Sage 9.1.



---

archive/issue_comments_495635.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@egourgoulhon](#comment:18):\n> Thanks for the fix!\n> \n> I made a few tests and everything is OK. So I am +1 for a positive review, once the pyflake error reported by the patchbot error has been fixed.\n> \n\nI think this is the same false positive that was identified in [#30417 comment:8](https://github.com/sagemath/sage/issues/30417#comment:8). Trying to ignore it with `# noqa` didn't work, so I will use [an assertion](https://stackoverflow.com/questions/5033727/how-do-i-get-pyflakes-to-ignore-a-statement/12121404#12121404) to silence pyflakes for good.",
    "created_at": "2020-11-23T16:17:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495635",
    "user": "https://github.com/jcamp0x2a"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@egourgoulhon](#comment:18):
> Thanks for the fix!
> 
> I made a few tests and everything is OK. So I am +1 for a positive review, once the pyflake error reported by the patchbot error has been fixed.
> 

I think this is the same false positive that was identified in [#30417 comment:8](https://github.com/sagemath/sage/issues/30417#comment:8). Trying to ignore it with `# noqa` didn't work, so I will use [an assertion](https://stackoverflow.com/questions/5033727/how-do-i-get-pyflakes-to-ignore-a-statement/12121404#12121404) to silence pyflakes for good.



---

archive/issue_comments_495636.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@egourgoulhon](#comment:19):\n> Btw, while making tests for this ticket branch, I found another error:\n> \n> ```\n> sage: f(x) = (x +  \n> ....:         1)                                                                                    \n>   File \"<ipython-input-10-ae23cb631161>\", line 1\n>     __tmp__=var(\"x\"); f = symbolic_expression((x + ).function(x)\n>                                                    ^\n> SyntaxError: invalid syntax\n> ```\n> But this does not pertain to the current ticket: it is already here in Sage 9.1. \n\nThe code is still fresh in my mind, and this seems like a trivial fix, so I'm going to try to knock it out here. If it's not as trivial as I thought, though, I'll spin off a new ticket and put this back into review.",
    "created_at": "2020-11-23T16:26:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495636",
    "user": "https://github.com/jcamp0x2a"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@egourgoulhon](#comment:19):
> Btw, while making tests for this ticket branch, I found another error:
> 
> ```
> sage: f(x) = (x +  
> ....:         1)                                                                                    
>   File "<ipython-input-10-ae23cb631161>", line 1
>     __tmp__=var("x"); f = symbolic_expression((x + ).function(x)
>                                                    ^
> SyntaxError: invalid syntax
> ```
> But this does not pertain to the current ticket: it is already here in Sage 9.1. 

The code is still fresh in my mind, and this seems like a trivial fix, so I'm going to try to knock it out here. If it's not as trivial as I thought, though, I'll spin off a new ticket and put this back into review.



---

archive/issue_events_426575.json:
```json
{
    "actor": "https://github.com/jcamp0x2a",
    "created_at": "2020-11-23T16:26:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30928#event-426575"
}
```



---

archive/issue_events_426576.json:
```json
{
    "actor": "https://github.com/jcamp0x2a",
    "created_at": "2020-11-23T16:26:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30928#event-426576"
}
```



---

archive/issue_comments_495637.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [@jcamp0x2a](#comment:21):\n> The code is still fresh in my mind, and this seems like a trivial fix, so I'm going to try to knock it out here. If it's not as trivial as I thought, though, I'll spin off a new ticket and put this back into review.\n\nOK very good!",
    "created_at": "2020-11-23T16:44:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495637",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [@jcamp0x2a](#comment:21):
> The code is still fresh in my mind, and this seems like a trivial fix, so I'm going to try to knock it out here. If it's not as trivial as I thought, though, I'll spin off a new ticket and put this back into review.

OK very good!



---

archive/issue_comments_495638.json:
```json
{
    "body": "Changed commit from **[e45c717](https://github.com/sagemath/sagetrac-mirror/commit/e45c71789eb151c5c3c9d15cca17deb9ff3d135c)** to **[64c5757](https://github.com/sagemath/sagetrac-mirror/commit/64c5757b4fb67d492f0c64cf7d3bda2d3616b56c)**",
    "created_at": "2020-11-23T17:56:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495638",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[e45c717](https://github.com/sagemath/sagetrac-mirror/commit/e45c71789eb151c5c3c9d15cca17deb9ff3d135c)** to **[64c5757](https://github.com/sagemath/sagetrac-mirror/commit/64c5757b4fb67d492f0c64cf7d3bda2d3616b56c)**



---

archive/issue_comments_495639.json:
```json
{
    "body": "<div id=\"comment:23\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/09b499cc1b1da0b2119563463f5c0da7d431f78e\">09b499c</a></td><td><code>Silence false positive from pyflakes</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/64c5757b4fb67d492f0c64cf7d3bda2d3616b56c\">64c5757</a></td><td><code>preparse_calculus: allow vars to span mulitple lines</code></td></tr></table>\n",
    "created_at": "2020-11-23T17:56:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495639",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:23"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/09b499cc1b1da0b2119563463f5c0da7d431f78e">09b499c</a></td><td><code>Silence false positive from pyflakes</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/64c5757b4fb67d492f0c64cf7d3bda2d3616b56c">64c5757</a></td><td><code>preparse_calculus: allow vars to span mulitple lines</code></td></tr></table>




---

archive/issue_events_426577.json:
```json
{
    "actor": "https://github.com/jcamp0x2a",
    "created_at": "2020-11-23T18:05:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30928#event-426577"
}
```



---

archive/issue_events_426578.json:
```json
{
    "actor": "https://github.com/jcamp0x2a",
    "created_at": "2020-11-23T18:05:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30928#event-426578"
}
```



---

archive/issue_comments_495640.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nNot trivial. Forgot about nested parentheses/braces/brackets. A regular expression is really ill-suited to handling that, so `preparse_calculus` is going to need some work. Can use backslash continuations as a workaround for now.\n\nOn the bright side, I *was* able to quickly add support for breaking the parameter list onto multiple lines like so:\n\n```python\nf(a,\n  b,\n  c,\n  d) = a + b*2 + c*3 + d*4\n```\n\n...and we'll see what pyflakes has to say now. :)",
    "created_at": "2020-11-23T18:05:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495640",
    "user": "https://github.com/jcamp0x2a"
}
```

<div id="comment:24" align="right">comment:24</div>

Not trivial. Forgot about nested parentheses/braces/brackets. A regular expression is really ill-suited to handling that, so `preparse_calculus` is going to need some work. Can use backslash continuations as a workaround for now.

On the bright side, I *was* able to quickly add support for breaking the parameter list onto multiple lines like so:

```python
f(a,
  b,
  c,
  d) = a + b*2 + c*3 + d*4
```

...and we'll see what pyflakes has to say now. :)



---

archive/issue_comments_495641.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@jcamp0x2a](#comment:24):\n> Not trivial. Forgot about nested parentheses/braces/brackets. A regular expression is really ill-suited to handling that, so `preparse_calculus` is going to need some work. Can use backslash continuations as a workaround for now.\n\nCreated #30953 to track this.",
    "created_at": "2020-11-23T18:13:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495641",
    "user": "https://github.com/jcamp0x2a"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@jcamp0x2a](#comment:24):
> Not trivial. Forgot about nested parentheses/braces/brackets. A regular expression is really ill-suited to handling that, so `preparse_calculus` is going to need some work. Can use backslash continuations as a workaround for now.

Created #30953 to track this.



---

archive/issue_comments_495642.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nNot sure what the source of the Darwin failures is. Every thing is fine here with `beta2`. I believe I've seen other false negative failures on Darwin.",
    "created_at": "2020-11-25T05:26:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495642",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:26" align="right">comment:26</div>

Not sure what the source of the Darwin failures is. Every thing is fine here with `beta2`. I believe I've seen other false negative failures on Darwin.



---

archive/issue_comments_495643.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@strogdon](#comment:26):\n> Not sure what the source of the Darwin failures is. Every thing is fine here with `beta2`. I believe I've seen other false negative failures on Darwin.\n\nYea, doesn't look like a very happy patchbot. :) Looking through it's history, I don't see a single green TestsPassed result, so I don't think it's due to anything introduced here.",
    "created_at": "2020-11-25T05:34:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495643",
    "user": "https://github.com/jcamp0x2a"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@strogdon](#comment:26):
> Not sure what the source of the Darwin failures is. Every thing is fine here with `beta2`. I believe I've seen other false negative failures on Darwin.

Yea, doesn't look like a very happy patchbot. :) Looking through it's history, I don't see a single green TestsPassed result, so I don't think it's due to anything introduced here.



---

archive/issue_events_426579.json:
```json
{
    "actor": "https://github.com/strogdon",
    "created_at": "2020-11-25T05:39:51Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30928#event-426579"
}
```



---

archive/issue_events_426580.json:
```json
{
    "actor": "https://github.com/strogdon",
    "created_at": "2020-11-25T05:39:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30928#event-426580"
}
```



---

archive/issue_comments_495644.json:
```json
{
    "body": "Reviewer: **Steven Trogdon**",
    "created_at": "2020-11-25T05:39:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495644",
    "user": "https://github.com/strogdon"
}
```

Reviewer: **Steven Trogdon**



---

archive/issue_comments_495645.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nEric please add your name to reviewers if you agree.",
    "created_at": "2020-11-25T05:39:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495645",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:28" align="right">comment:28</div>

Eric please add your name to reviewers if you agree.



---

archive/issue_comments_495646.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nThank you very much for having fixed this!",
    "created_at": "2020-11-25T10:04:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495646",
    "user": "https://github.com/egourgoulhon"
}
```

<div id="comment:29" align="right">comment:29</div>

Thank you very much for having fixed this!



---

archive/issue_comments_495647.json:
```json
{
    "body": "Changed reviewer from **Steven Trogdon** to **Steven Trogdon, Eric Gourgoulhon**",
    "created_at": "2020-11-25T10:04:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495647",
    "user": "https://github.com/egourgoulhon"
}
```

Changed reviewer from **Steven Trogdon** to **Steven Trogdon, Eric Gourgoulhon**



---

archive/issue_comments_495648.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nReplying to [@egourgoulhon](#comment:29):\n> Thank you very much for having fixed this!\n\nYou are most welcome!\n\nI'm going to spend some time brainstorming ways to make the preparser more robust, potentially including building that proper grammar/parser I mentioned earlier. Might have to be a year-long goal for 2021, though. :)",
    "created_at": "2020-11-25T16:32:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495648",
    "user": "https://github.com/jcamp0x2a"
}
```

<div id="comment:30" align="right">comment:30</div>

Replying to [@egourgoulhon](#comment:29):
> Thank you very much for having fixed this!

You are most welcome!

I'm going to spend some time brainstorming ways to make the preparser more robust, potentially including building that proper grammar/parser I mentioned earlier. Might have to be a year-long goal for 2021, though. :)



---

archive/issue_comments_495649.json:
```json
{
    "body": "Changed branch from **[u/gh-jcamp0x2a/30928-backslash-continuation](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-jcamp0x2a/30928-backslash-continuation)** to **[64c5757](https://github.com/sagemath/sagetrac-mirror/commit/64c5757b4fb67d492f0c64cf7d3bda2d3616b56c)**",
    "created_at": "2020-12-05T22:13:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30928#issuecomment-495649",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/gh-jcamp0x2a/30928-backslash-continuation](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-jcamp0x2a/30928-backslash-continuation)** to **[64c5757](https://github.com/sagemath/sagetrac-mirror/commit/64c5757b4fb67d492f0c64cf7d3bda2d3616b56c)**



---

archive/issue_events_426581.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-12-05T22:13:29Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30928#event-426581"
}
```



---

archive/issue_events_426582.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "f844baa06b227e198d3ebabdbbe29379d38c1f64",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2020-12-05T22:13:29Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/30928",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30928#event-426582"
}
```
