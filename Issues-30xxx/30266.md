# Issue 30266: Immutability for scalar fields

archive/issues_030029.json:
```json
{
    "body": "This ticket adds the immutability and hashability for scalar fields.\n\nSee #30261.\n\nCC:  @egourgoulhon @tscrim @mkoeppe\n\nKeywords: immutability\n\nBranch/Commit: 1912193c1c40222a7ce606e318fb1c5d5126cca4\n\nReviewer: Matthias Koeppe\n\nAuthor: Michael Jung\n\nDependencies: #30181\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30266\n\n",
    "closed_at": "2020-08-09T08:47:24Z",
    "created_at": "2020-08-01T12:56:35Z",
    "labels": [
        "component: manifolds"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Immutability for scalar fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30266",
    "user": "https://github.com/mjungmath"
}
```
This ticket adds the immutability and hashability for scalar fields.

See #30261.

CC:  @egourgoulhon @tscrim @mkoeppe

Keywords: immutability

Branch/Commit: 1912193c1c40222a7ce606e318fb1c5d5126cca4

Reviewer: Matthias Koeppe

Author: Michael Jung

Dependencies: #30181

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/30266





---

archive/issue_comments_455110.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n+This ticket adds the immutability and hashability for scalar fields.\n \n+See #30261.\n \n Comment: 1\n \n```\n",
    "created_at": "2020-08-01T12:59:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455110",
    "user": "https://github.com/mjungmath"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,6 @@
+This ticket adds the immutability and hashability for scalar fields.
 
+See #30261.
 
 Comment: 1
 
```




---

archive/issue_comments_455111.json:
```json
{
    "body": "Changing keywords from \"\" to \"immutability\".",
    "created_at": "2020-08-01T12:59:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455111",
    "user": "https://github.com/mjungmath"
}
```

Changing keywords from "" to "immutability".



---

archive/issue_comments_455112.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to manifolds.",
    "created_at": "2020-08-01T12:59:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455112",
    "user": "https://github.com/mjungmath"
}
```

Changing component from PLEASE CHANGE to manifolds.



---

archive/issue_comments_455113.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-08-01T12:59:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455113",
    "user": "https://github.com/mjungmath"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_455114.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2020-08-01T12:59:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455114",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_455115.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2020-08-01T12:59:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455115",
    "user": "https://github.com/mjungmath"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_455116.json:
```json
{
    "body": "<a id='comment:4'></a>Is the hash input okay? Or should it be something more unique?",
    "created_at": "2020-08-01T13:03:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455116",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:4'></a>Is the hash input okay? Or should it be something more unique?



---

archive/issue_comments_455117.json:
```json
{
    "body": "<a id='comment:5'></a>Given that `ScalarField_repr_` does not print any contents, this hash does not seem to be useful to distinguish non-equal elements. This will degrade the performance of sets to that of lists.\n\nMore importantly, it must be ensured that `f == g` implies `hash(f) == hash(g)`. Because equality does not take names into account but `repr` does, this is currently not satisfied.",
    "created_at": "2020-08-01T13:21:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455117",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>Given that `ScalarField_repr_` does not print any contents, this hash does not seem to be useful to distinguish non-equal elements. This will degrade the performance of sets to that of lists.

More importantly, it must be ensured that `f == g` implies `hash(f) == hash(g)`. Because equality does not take names into account but `repr` does, this is currently not satisfied.



---

archive/issue_comments_455118.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 mkoeppe]:\n> Given that `ScalarField_repr_` does not print any contents, this hash does not seem to be useful to distinguish non-equal elements. This will degrade the performance of sets to that of lists.\n> \n> More importantly, it must be ensured that `f == g` implies `hash(f) == hash(g)`. Because equality does not take names into account but `repr` does, this is currently not satisfied.\n> \n\n\nI just copied the ideas from the elsewhere in the Sage code. This means that most `hash` functions are implemented wrong.\n\nAre you sure it is not `f is g` implies `hash(f) == hash(g)`? `f == g` implies `hash(f) == hash(g)` is barely possible in cases where coercions apply, isn't it?",
    "created_at": "2020-08-01T13:27:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455118",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:6'></a>Replying to [comment:5 mkoeppe]:
> Given that `ScalarField_repr_` does not print any contents, this hash does not seem to be useful to distinguish non-equal elements. This will degrade the performance of sets to that of lists.
> 
> More importantly, it must be ensured that `f == g` implies `hash(f) == hash(g)`. Because equality does not take names into account but `repr` does, this is currently not satisfied.
> 


I just copied the ideas from the elsewhere in the Sage code. This means that most `hash` functions are implemented wrong.

Are you sure it is not `f is g` implies `hash(f) == hash(g)`? `f == g` implies `hash(f) == hash(g)` is barely possible in cases where coercions apply, isn't it?



---

archive/issue_comments_455119.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 gh-mjungmath]:\n> Are you sure it is not `f is g` implies `hash(f) == hash(g)`? \n\n\nThis implication is trivially true.",
    "created_at": "2020-08-01T13:31:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455119",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>Replying to [comment:6 gh-mjungmath]:
> Are you sure it is not `f is g` implies `hash(f) == hash(g)`? 


This implication is trivially true.



---

archive/issue_comments_455120.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 mkoeppe]:\n> Replying to [comment:6 gh-mjungmath]:\n> > Are you sure it is not `f is g` implies `hash(f) == hash(g)`? \n\n> \n> This implication is trivially true.\n\n\nOh, yes, this is obviously right. >.< :D",
    "created_at": "2020-08-01T13:38:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455120",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:8'></a>Replying to [comment:7 mkoeppe]:
> Replying to [comment:6 gh-mjungmath]:
> > Are you sure it is not `f is g` implies `hash(f) == hash(g)`? 

> 
> This implication is trivially true.


Oh, yes, this is obviously right. >.< :D



---

archive/issue_comments_455121.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:6 gh-mjungmath]:\n> Replying to [comment:5 mkoeppe]:\n> > Given that `ScalarField_repr_` does not print any contents, this hash does not seem to be useful to distinguish non-equal elements. This will degrade the performance of sets to that of lists.\n> > \n> > More importantly, it must be ensured that `f == g` implies `hash(f) == hash(g)`. Because equality does not take names into account but `repr` does, this is currently not satisfied.\n> > \n\n> \n> I just copied the ideas from the elsewhere in the Sage code. This means that most `hash` functions are implemented wrong.\n\n\nAh yes, I see, apparently that were cases where the string representation cannot be changed. Due to the fact that we allow restrictions as coercion, `hash(self._manifold)` seem to be the only choice.\n\nI will add a related doctest for this particular case.\n\nThank you.",
    "created_at": "2020-08-01T13:44:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455121",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:9'></a>Replying to [comment:6 gh-mjungmath]:
> Replying to [comment:5 mkoeppe]:
> > Given that `ScalarField_repr_` does not print any contents, this hash does not seem to be useful to distinguish non-equal elements. This will degrade the performance of sets to that of lists.
> > 
> > More importantly, it must be ensured that `f == g` implies `hash(f) == hash(g)`. Because equality does not take names into account but `repr` does, this is currently not satisfied.
> > 

> 
> I just copied the ideas from the elsewhere in the Sage code. This means that most `hash` functions are implemented wrong.


Ah yes, I see, apparently that were cases where the string representation cannot be changed. Due to the fact that we allow restrictions as coercion, `hash(self._manifold)` seem to be the only choice.

I will add a related doctest for this particular case.

Thank you.



---

archive/issue_comments_455122.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-01T14:15:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455122",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_455123.json:
```json
{
    "body": "<a id='comment:11'></a>This should be better.",
    "created_at": "2020-08-01T14:15:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455123",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:11'></a>This should be better.



---

archive/issue_comments_455124.json:
```json
{
    "body": "<a id='comment:12'></a>Is that `hash` function okay? I have added a short `f == g` implies `hash(f) == hash(g)` test.\n\nPatchbot is green, btw.",
    "created_at": "2020-08-02T09:59:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455124",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:12'></a>Is that `hash` function okay? I have added a short `f == g` implies `hash(f) == hash(g)` test.

Patchbot is green, btw.



---

archive/issue_comments_455125.json:
```json
{
    "body": "<a id='comment:13'></a>Since #30116, scalar fields can be compared on common domains. I added the check of the hash condition in the doctest for this particular comparison.",
    "created_at": "2020-08-02T21:29:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455125",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:13'></a>Since #30116, scalar fields can be compared on common domains. I added the check of the hash condition in the doctest for this particular comparison.



---

archive/issue_comments_455126.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2020-08-02T21:31:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455126",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_455127.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-02T21:36:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455127",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_455128.json:
```json
{
    "body": "<a id='comment:16'></a>Patchbot is green.",
    "created_at": "2020-08-03T09:02:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455128",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:16'></a>Patchbot is green.



---

archive/issue_comments_455129.json:
```json
{
    "body": "<a id='comment:17'></a>I believe for `_richcmp_` you also have `self is not other`, but you should double check this.",
    "created_at": "2020-08-03T12:04:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455129",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:17'></a>I believe for `_richcmp_` you also have `self is not other`, but you should double check this.



---

archive/issue_comments_455130.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:17 tscrim]:\n> I believe for `_richcmp_` you also have `self is not other`, but you should double check this.\n\n\nIn #30116, I used `if self is other:` instead. Is that what you mean?",
    "created_at": "2020-08-03T12:39:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455130",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:18'></a>Replying to [comment:17 tscrim]:
> I believe for `_richcmp_` you also have `self is not other`, but you should double check this.


In #30116, I used `if self is other:` instead. Is that what you mean?



---

archive/issue_comments_455131.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:18 gh-mjungmath]:\n> Replying to [comment:17 tscrim]:\n> > I believe for `_richcmp_` you also have `self is not other`, but you should double check this.\n\n> \n> In #30116, I used `if self is other:` instead. Is that what you mean?\n\n\nAh, I missed it there. Yes, I mean that, and I think it is unnecessary because the coercion framework through `__eq__` handles that case. However, I don't trust myself here, so it is worth checking.",
    "created_at": "2020-08-03T12:53:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455131",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:19'></a>Replying to [comment:18 gh-mjungmath]:
> Replying to [comment:17 tscrim]:
> > I believe for `_richcmp_` you also have `self is not other`, but you should double check this.

> 
> In #30116, I used `if self is other:` instead. Is that what you mean?


Ah, I missed it there. Yes, I mean that, and I think it is unnecessary because the coercion framework through `__eq__` handles that case. However, I don't trust myself here, so it is worth checking.



---

archive/issue_comments_455132.json:
```json
{
    "body": "<a id='comment:20'></a>I changed the whole `_richcmp_` to `return False` and tried `f == f`. It returned `False`. So, no prior instance check here. For fun, I did the same with the opposite: no prior check there, too.",
    "created_at": "2020-08-03T13:35:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455132",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:20'></a>I changed the whole `_richcmp_` to `return False` and tried `f == f`. It returned `False`. So, no prior instance check here. For fun, I did the same with the opposite: no prior check there, too.



---

archive/issue_comments_455133.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-03T22:32:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455133",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_455134.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:20 gh-mjungmath]:\n> I changed the whole `_richcmp_` to `return False` and tried `f == f`. It returned `False`. So, no prior instance check here. For fun, I did the same with the opposite: no prior check there, too.\n\n\nThank you for checking. `:)`",
    "created_at": "2020-08-04T00:25:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455134",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:22'></a>Replying to [comment:20 gh-mjungmath]:
> I changed the whole `_richcmp_` to `return False` and tried `f == f`. It returned `False`. So, no prior instance check here. For fun, I did the same with the opposite: no prior check there, too.


Thank you for checking. `:)`



---

archive/issue_comments_455135.json:
```json
{
    "body": "<a id='comment:23'></a>Unfortunately I am too busy right now to do the review. I can probably do it next week, but if someone else wants to step up and do it, please go ahead.",
    "created_at": "2020-08-04T00:27:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455135",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:23'></a>Unfortunately I am too busy right now to do the review. I can probably do it next week, but if someone else wants to step up and do it, please go ahead.



---

archive/issue_comments_455136.json:
```json
{
    "body": "<a id='comment:24'></a>One question btw: must `1 == f` also imply `hash(1) == hash(f)`. The former can be fulfilled due to the coercion framework, the latter is rather difficult since both have different types. Is it enough for this condition to be fulfilled for objects of the same type?",
    "created_at": "2020-08-04T07:52:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455136",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:24'></a>One question btw: must `1 == f` also imply `hash(1) == hash(f)`. The former can be fulfilled due to the coercion framework, the latter is rather difficult since both have different types. Is it enough for this condition to be fulfilled for objects of the same type?



---

archive/issue_comments_455137.json:
```json
{
    "body": "<a id='comment:25'></a>For the ring of integers modulo some number, this behavior is not satisfied:\n\n```\nsage: 3 == GF(2)(3)\nTrue\nsage: hash(3) == hash(GF(2)(3))\nFalse\n```",
    "created_at": "2020-08-04T15:00:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455137",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:25'></a>For the ring of integers modulo some number, this behavior is not satisfied:

```
sage: 3 == GF(2)(3)
True
sage: hash(3) == hash(GF(2)(3))
False
```



---

archive/issue_comments_455138.json:
```json
{
    "body": "<a id='comment:26'></a>Ensuring that this implication holds across coercion is very difficult, and it is done in Sage on a \"best effort\" basis -- such as for QQ as the fraction field of ZZ.\n\nThe rule of thumb is that if we form sets, they should be of elements of the same parent so that no coercion is involved.  Likewise for the keys of dictionaries.",
    "created_at": "2020-08-04T15:09:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455138",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:26'></a>Ensuring that this implication holds across coercion is very difficult, and it is done in Sage on a "best effort" basis -- such as for QQ as the fraction field of ZZ.

The rule of thumb is that if we form sets, they should be of elements of the same parent so that no coercion is involved.  Likewise for the keys of dictionaries.



---

archive/issue_comments_455139.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:26 mkoeppe]:\n> Ensuring that this implication holds across coercion is very difficult, and it is done in Sage on a \"best effort\" basis -- such as for QQ as the fraction field of ZZ.\n> \n> The rule of thumb is that if we form sets, they should be of elements of the same parent so that no coercion is involved.  Likewise for the keys of dictionaries.\n\n\nSince the restriction is set as a coercion, and they live in different sets, maybe we should make the hash more unique? Namely:\n\n```diff\n-        return hash((type(self).__name__, self._manifold))\n+        return hash((type(self).__name__, self._domain))\n```\n\nIf that is what we want, I will, of course, adapt the doctest section.",
    "created_at": "2020-08-04T15:19:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455139",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:27'></a>Replying to [comment:26 mkoeppe]:
> Ensuring that this implication holds across coercion is very difficult, and it is done in Sage on a "best effort" basis -- such as for QQ as the fraction field of ZZ.
> 
> The rule of thumb is that if we form sets, they should be of elements of the same parent so that no coercion is involved.  Likewise for the keys of dictionaries.


Since the restriction is set as a coercion, and they live in different sets, maybe we should make the hash more unique? Namely:

```diff
-        return hash((type(self).__name__, self._manifold))
+        return hash((type(self).__name__, self._domain))
```

If that is what we want, I will, of course, adapt the doctest section.



---

archive/issue_comments_455140.json:
```json
{
    "body": "<a id='comment:28'></a>I haven't followed the discussion regarding restriction and equality, so I would need more context here.",
    "created_at": "2020-08-04T15:46:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455140",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:28'></a>I haven't followed the discussion regarding restriction and equality, so I would need more context here.



---

archive/issue_comments_455141.json:
```json
{
    "body": "<a id='comment:29'></a>Replying to [comment:28 mkoeppe]:\n> I haven't followed the discussion regarding restriction and equality, so I would need more context here.\n\n\nSorry, sure. See #30116 for the discussion.\n\nManifolds allows coercions from scalar fields on `M` to scalar fields on `U`, where `U` is a subset of `M`, i.e. a restriction. Since #30116, the equality check compares scalar fields on a common subset and returns `True` if they are the same on that domain. Nevertheless, both scalar fields on different domains are still distinct objects defined in distinct sets.",
    "created_at": "2020-08-04T15:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455141",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:29'></a>Replying to [comment:28 mkoeppe]:
> I haven't followed the discussion regarding restriction and equality, so I would need more context here.


Sorry, sure. See #30116 for the discussion.

Manifolds allows coercions from scalar fields on `M` to scalar fields on `U`, where `U` is a subset of `M`, i.e. a restriction. Since #30116, the equality check compares scalar fields on a common subset and returns `True` if they are the same on that domain. Nevertheless, both scalar fields on different domains are still distinct objects defined in distinct sets.



---

archive/issue_comments_455142.json:
```json
{
    "body": "<a id='comment:30'></a>You probably discussed this on that ticket, but this kind of \"equality\" relation is not transitive without strong assumptions such as analyticity and connectedness, is it?",
    "created_at": "2020-08-04T16:01:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455142",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'></a>You probably discussed this on that ticket, but this kind of "equality" relation is not transitive without strong assumptions such as analyticity and connectedness, is it?



---

archive/issue_comments_455143.json:
```json
{
    "body": "<a id='comment:31'></a>Replying to [comment:30 mkoeppe]:\n> You probably discussed this on that ticket, but this kind of \"equality\" relation is not transitive without strong assumptions such as analyticity and connectedness, is it?\n\n\nActually, we didn't. But that is a crucial point! Without analyticity, which is not necessarily given, the transitivity is definitely violated.\n\nHowever, coercible objects have to be comparable, right?",
    "created_at": "2020-08-04T16:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455143",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:31'></a>Replying to [comment:30 mkoeppe]:
> You probably discussed this on that ticket, but this kind of "equality" relation is not transitive without strong assumptions such as analyticity and connectedness, is it?


Actually, we didn't. But that is a crucial point! Without analyticity, which is not necessarily given, the transitivity is definitely violated.

However, coercible objects have to be comparable, right?



---

archive/issue_comments_455144.json:
```json
{
    "body": "<a id='comment:32'></a>In general I don't think you should feel obligated to use the coercion framework for comparisons just because you use it for arithmetic. It's just a tool.",
    "created_at": "2020-08-04T16:23:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455144",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:32'></a>In general I don't think you should feel obligated to use the coercion framework for comparisons just because you use it for arithmetic. It's just a tool.



---

archive/issue_comments_455145.json:
```json
{
    "body": "<a id='comment:33'></a>Replying to [comment:32 mkoeppe]:\n> In general I don't think you should feel obligated to use the coercion framework for comparisons just because you use it for arithmetic. It's just a tool.\n\n\nProbably you're right. The documentation, however, is not very explicit on that. I changed the ticket above to \"needs info\" and left a question. Perhaps you can take a short look?",
    "created_at": "2020-08-04T16:26:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455145",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:33'></a>Replying to [comment:32 mkoeppe]:
> In general I don't think you should feel obligated to use the coercion framework for comparisons just because you use it for arithmetic. It's just a tool.


Probably you're right. The documentation, however, is not very explicit on that. I changed the ticket above to "needs info" and left a question. Perhaps you can take a short look?



---

archive/issue_comments_455146.json:
```json
{
    "body": "<a id='comment:34'></a>I just want to mention that your contributions are always very beneficial. Thank you very much! :)",
    "created_at": "2020-08-04T16:35:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455146",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:34'></a>I just want to mention that your contributions are always very beneficial. Thank you very much! :)



---

archive/issue_comments_455147.json:
```json
{
    "body": "<a id='comment:35'></a>But soon I'll start bothering you with lots of naive questions about differential geometry... ;)",
    "created_at": "2020-08-04T16:46:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455147",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:35'></a>But soon I'll start bothering you with lots of naive questions about differential geometry... ;)



---

archive/issue_comments_455148.json:
```json
{
    "body": "<a id='comment:36'></a>Replying to [comment:35 mkoeppe]:\n> But soon I'll start bothering you with lots of naive questions about differential geometry... ;)\n\n\nThat's only fair. ;)",
    "created_at": "2020-08-04T16:56:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455148",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:36'></a>Replying to [comment:35 mkoeppe]:
> But soon I'll start bothering you with lots of naive questions about differential geometry... ;)


That's only fair. ;)



---

archive/issue_comments_455149.json:
```json
{
    "body": "<a id='comment:37'></a>I will remove the dependence from #30116 again.",
    "created_at": "2020-08-04T17:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455149",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:37'></a>I will remove the dependence from #30116 again.



---

archive/issue_comments_455150.json:
```json
{
    "body": "<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-04T17:17:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455150",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_455151.json:
```json
{
    "body": "<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-04T17:18:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455151",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_455152.json:
```json
{
    "body": "<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-08-04T17:27:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455152",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_455153.json:
```json
{
    "body": "<a id='comment:41'></a>Here we go. Let's see what our friend the patchbot says...",
    "created_at": "2020-08-04T17:28:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455153",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:41'></a>Here we go. Let's see what our friend the patchbot says...



---

archive/issue_comments_455154.json:
```json
{
    "body": "<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-04T17:50:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455154",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_455155.json:
```json
{
    "body": "<a id='comment:43'></a>Patchbot is satisfied.",
    "created_at": "2020-08-04T20:24:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455155",
    "user": "https://github.com/mjungmath"
}
```

<a id='comment:43'></a>Patchbot is satisfied.



---

archive/issue_comments_455156.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-04T21:46:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455156",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_078289.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-08-09T08:47:24Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30266#event-78289"
}
```



---

archive/issue_comments_455157.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-08-09T08:47:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30266",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30266#issuecomment-455157",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
