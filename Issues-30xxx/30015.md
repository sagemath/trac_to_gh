# Issue 30015: Schlegel projection breaks convexity

archive/issues_029778.json:
```json
{
    "body": "The documentation string of `.schlegel_projection` reads:\n\n```\n   Return the Schlegel projection.\n\n   * The polyhedron is translated such that its \"center()\" is at the\n     origin.\n\n   * The vertices are then normalized to the unit sphere\n\n   * The normalized points are stereographically projected from a\n     point slightly outside of the sphere.\n```\n\nWhen normalizing to the unit sphere this (potentially) completely breaks the convexity of the object. \n\nMinimal example:\n\n```\nsage: fcube = polytopes.hypercube(4)\nsage: tfcube = fcube.face_truncation(fcube.faces(0)[0])\nsage: sp = tfcube.schlegel_projection()\nsage: sp.plot()\nLaunched html viewer for Graphics3d Object\n```\n\nThe pentagons are not planar although they should in a schlegel diagram.\n\nThe scaling to the unit sphere should be removed to preserve convexity.\n\nThis ticket fixes the projection while de-duplicating some code.\n\nFOLLOW-UP: Fix .plot() and .show() to have a better behaviour of smaller dimensional objects.\n\nCC:  @kliem @laisrast\n\nKeywords: polytope, schlegel\n\nBranch/Commit: f10d5714bc757db8ec8910359931fb1bcb0dbb29\n\nReviewer: Jonathan Kliem\n\nAuthor: Jean-Philippe Labb\u00e9\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30015\n\n",
    "closed_at": "2020-11-29T11:57:59Z",
    "created_at": "2020-06-29T09:13:13Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Schlegel projection breaks convexity",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30015",
    "user": "https://github.com/jplab"
}
```
The documentation string of `.schlegel_projection` reads:

```
   Return the Schlegel projection.

   * The polyhedron is translated such that its "center()" is at the
     origin.

   * The vertices are then normalized to the unit sphere

   * The normalized points are stereographically projected from a
     point slightly outside of the sphere.
```

When normalizing to the unit sphere this (potentially) completely breaks the convexity of the object. 

Minimal example:

```
sage: fcube = polytopes.hypercube(4)
sage: tfcube = fcube.face_truncation(fcube.faces(0)[0])
sage: sp = tfcube.schlegel_projection()
sage: sp.plot()
Launched html viewer for Graphics3d Object
```

The pentagons are not planar although they should in a schlegel diagram.

The scaling to the unit sphere should be removed to preserve convexity.

This ticket fixes the projection while de-duplicating some code.

FOLLOW-UP: Fix .plot() and .show() to have a better behaviour of smaller dimensional objects.

CC:  @kliem @laisrast

Keywords: polytope, schlegel

Branch/Commit: f10d5714bc757db8ec8910359931fb1bcb0dbb29

Reviewer: Jonathan Kliem

Author: Jean-Philippe Labb√©

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/30015





---

archive/issue_comments_450964.json:
```json
{
    "body": "<a id='comment:1'></a>Is this the bug you showed during your presentation at sd109?",
    "created_at": "2020-06-29T09:15:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450964",
    "user": "https://github.com/kliem"
}
```

<a id='comment:1'></a>Is this the bug you showed during your presentation at sd109?



---

archive/issue_comments_450965.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-10-06T14:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450965",
    "user": "https://github.com/jplab"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_450966.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2020-10-06T14:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450966",
    "user": "https://github.com/jplab"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_450967.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -28,6 +28,8 @@\n \n The scaling to the unit sphere should be removed to preserve convexity.\n \n+This ticket fixes the projection while de-duplicating some code.\n+\n Comment: 1\n \n Issue created by migration from https://trac.sagemath.org/ticket/30015\n```\n",
    "created_at": "2020-10-06T14:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450967",
    "user": "https://github.com/jplab"
}
```

Description changed:
```diff
--- 
+++ 
@@ -28,6 +28,8 @@
 
 The scaling to the unit sphere should be removed to preserve convexity.
 
+This ticket fixes the projection while de-duplicating some code.
+
 Comment: 1
 
 Issue created by migration from https://trac.sagemath.org/ticket/30015
```




---

archive/issue_comments_450968.json:
```json
{
    "body": "<a id='comment:3'></a>Replying to [comment:1 gh-kliem]:\n> Is this the bug you showed during your presentation at sd109?\n\n?",
    "created_at": "2020-10-06T14:45:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450968",
    "user": "https://github.com/kliem"
}
```

<a id='comment:3'></a>Replying to [comment:1 gh-kliem]:
> Is this the bug you showed during your presentation at sd109?

?



---

archive/issue_comments_450969.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:3 gh-kliem]:\n> Replying to [comment:1 gh-kliem]:\n> > Is this the bug you showed during your presentation at sd109?\n\n> ?\nNo, that one had to do with plotting in 3d and having missing faces or so. This one is really different: it was providing a wrong output.\n\nFurther, the method is improved and made more user-friendly, one just needs to be fed a facet and a positive number to get a schlegel diagram. Close to 0, the projection point is very close to the barycenter of the facet, otherwise, getting away in the direction of the representative point of the locus of points that see that facet.\n\nGiven these 2 things, this provides a projection of the polyhedron (think typically of something in 4d) into the affine hull of the facet, and that image is then transformed orthonormally into 3d and then the picture is drawn.",
    "created_at": "2020-10-06T14:54:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450969",
    "user": "https://github.com/jplab"
}
```

<a id='comment:4'></a>Replying to [comment:3 gh-kliem]:
> Replying to [comment:1 gh-kliem]:
> > Is this the bug you showed during your presentation at sd109?

> ?
No, that one had to do with plotting in 3d and having missing faces or so. This one is really different: it was providing a wrong output.

Further, the method is improved and made more user-friendly, one just needs to be fed a facet and a positive number to get a schlegel diagram. Close to 0, the projection point is very close to the barycenter of the facet, otherwise, getting away in the direction of the representative point of the locus of points that see that facet.

Given these 2 things, this provides a projection of the polyhedron (think typically of something in 4d) into the affine hull of the facet, and that image is then transformed orthonormally into 3d and then the picture is drawn.



---

archive/issue_comments_450970.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-10-06T15:12:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450970",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_450971.json:
```json
{
    "body": "<a id='comment:5'></a>Ach...\n\n```\nsage: cp = polytopes.cyclic_polytope(4,8).polar()                                                                                                                                                                  \nsage: cp.schlegel_projection()                                                                                                                                                                                     \nTraceback (most recent call last)\n[snip]\n\n~/sage/local/lib/python3.8/site-packages/sage/geometry/polyhedron/plot.py in __call__(self, x)\n    302         segment = Polyhedron(vertices=[vector(RDF, x),self.projection_point])\n    303         # The intersection of the segment with the facet\n--> 304         preimage = (segment & self.facet).vertices()[0].vector()\n    305         # The transformation matrix acts on the right:\n    306         return preimage*self.A + self.b\n\nIndexError: tuple index out of range\n```\n\nThat line is an overkill... I should probably change it to something a bit simpler than taking the intersection.\n\nThe problem occurs prior to this, this is an artefact from the older version, somehow it is already converted to RDF before and then no intersection is found.\n\nThis example is likely to be one the extreme side, but it is good to fix this now.",
    "created_at": "2020-10-06T15:12:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450971",
    "user": "https://github.com/jplab"
}
```

<a id='comment:5'></a>Ach...

```
sage: cp = polytopes.cyclic_polytope(4,8).polar()                                                                                                                                                                  
sage: cp.schlegel_projection()                                                                                                                                                                                     
Traceback (most recent call last)
[snip]

~/sage/local/lib/python3.8/site-packages/sage/geometry/polyhedron/plot.py in __call__(self, x)
    302         segment = Polyhedron(vertices=[vector(RDF, x),self.projection_point])
    303         # The intersection of the segment with the facet
--> 304         preimage = (segment & self.facet).vertices()[0].vector()
    305         # The transformation matrix acts on the right:
    306         return preimage*self.A + self.b

IndexError: tuple index out of range
```

That line is an overkill... I should probably change it to something a bit simpler than taking the intersection.

The problem occurs prior to this, this is an artefact from the older version, somehow it is already converted to RDF before and then no intersection is found.

This example is likely to be one the extreme side, but it is good to fix this now.



---

archive/issue_comments_450972.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 jipilab]:\n> Ach...\n> \n> \n> ```\n> sage: cp = polytopes.cyclic_polytope(4,8).polar()                                                                                                                                                                  \n> sage: cp.schlegel_projection()                                                                                                                                                                                     \n> Traceback (most recent call last)\n> [snip]\n> \n> ~/sage/local/lib/python3.8/site-packages/sage/geometry/polyhedron/plot.py in __call__(self, x)\n>     302         segment = Polyhedron(vertices=[vector(RDF, x),self.projection_point])\n>     303         # The intersection of the segment with the facet\n> --> 304         preimage = (segment & self.facet).vertices()[0].vector()\n>     305         # The transformation matrix acts on the right:\n>     306         return preimage*self.A + self.b\n> \n> IndexError: tuple index out of range\n> ```\n> \n> That line is an overkill... I should probably change it to something a bit simpler than taking the intersection.\n> \n\n\nIn Ziegler's book (Lectures on Polytopes) page 133, there is a nice formula for computing the intersection point.",
    "created_at": "2020-10-07T14:30:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450972",
    "user": "https://github.com/LaisRast"
}
```

<a id='comment:6'></a>Replying to [comment:5 jipilab]:
> Ach...
> 
> 
> ```
> sage: cp = polytopes.cyclic_polytope(4,8).polar()                                                                                                                                                                  
> sage: cp.schlegel_projection()                                                                                                                                                                                     
> Traceback (most recent call last)
> [snip]
> 
> ~/sage/local/lib/python3.8/site-packages/sage/geometry/polyhedron/plot.py in __call__(self, x)
>     302         segment = Polyhedron(vertices=[vector(RDF, x),self.projection_point])
>     303         # The intersection of the segment with the facet
> --> 304         preimage = (segment & self.facet).vertices()[0].vector()
>     305         # The transformation matrix acts on the right:
>     306         return preimage*self.A + self.b
> 
> IndexError: tuple index out of range
> ```
> 
> That line is an overkill... I should probably change it to something a bit simpler than taking the intersection.
> 


In Ziegler's book (Lectures on Polytopes) page 133, there is a nice formula for computing the intersection point.



---

archive/issue_comments_450973.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 gh-LaisRast]:\n> In Ziegler's book (Lectures on Polytopes) page 133, there is a nice formula for computing the intersection point.\n\nThanks for the pointer, that will do. There is still the issue that at that moment, one deals already with `RDF`, but having a direct formula should improve it. (There is still the danger of dividing by 0...)",
    "created_at": "2020-10-09T14:20:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450973",
    "user": "https://github.com/jplab"
}
```

<a id='comment:7'></a>Replying to [comment:6 gh-LaisRast]:
> In Ziegler's book (Lectures on Polytopes) page 133, there is a nice formula for computing the intersection point.

Thanks for the pointer, that will do. There is still the issue that at that moment, one deals already with `RDF`, but having a direct formula should improve it. (There is still the danger of dividing by 0...)



---

archive/issue_comments_450974.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-10-09T14:50:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450974",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_450975.json:
```json
{
    "body": "<a id='comment:9'></a>I still get an error at line 917 in `base.py`, there is a NaN... which I believe is coming from this division. Hmm. I'll see what can be done.",
    "created_at": "2020-10-09T14:51:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450975",
    "user": "https://github.com/jplab"
}
```

<a id='comment:9'></a>I still get an error at line 917 in `base.py`, there is a NaN... which I believe is coming from this division. Hmm. I'll see what can be done.



---

archive/issue_comments_450976.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-10-14T16:43:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450976",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_450977.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-10-14T16:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450977",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_450978.json:
```json
{
    "body": "<a id='comment:11'></a>That should do it.",
    "created_at": "2020-10-14T16:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450978",
    "user": "https://github.com/jplab"
}
```

<a id='comment:11'></a>That should do it.



---

archive/issue_comments_450979.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-10-15T08:02:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450979",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_450980.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-10-15T08:02:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450980",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_events_077141.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30015#event-77141"
}
```



---

archive/issue_comments_450981.json:
```json
{
    "body": "<a id='comment:15'></a>- `# There is no 4-d screen, we must project down to 3d`\n\n  Either `3-d` or `4d` I would say.\n\n- \n\n```\n+        if not locus_polyhedron.relative_interior_contains(projection_point):\n+            raise ValueError(\"the chosen position is too large\")\n```\n  If you enter `position=-1`, this is the error you see, which is somewhat strange. (Of course bullshit gives bullshit, but maybe we can be nice here.)",
    "created_at": "2020-10-27T13:00:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450981",
    "user": "https://github.com/kliem"
}
```

<a id='comment:15'></a>- `# There is no 4-d screen, we must project down to 3d`

  Either `3-d` or `4d` I would say.

- 

```
+        if not locus_polyhedron.relative_interior_contains(projection_point):
+            raise ValueError("the chosen position is too large")
```
  If you enter `position=-1`, this is the error you see, which is somewhat strange. (Of course bullshit gives bullshit, but maybe we can be nice here.)



---

archive/issue_comments_450982.json:
```json
{
    "body": "<a id='comment:16'></a>There is a trailing space in the preimage line.",
    "created_at": "2020-10-27T13:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450982",
    "user": "https://github.com/kliem"
}
```

<a id='comment:16'></a>There is a trailing space in the preimage line.



---

archive/issue_comments_450983.json:
```json
{
    "body": "<a id='comment:17'></a>- The biggest trouble with schlegel is that the default position now seems to be much too close !(?)\n\n  Take a look at at\n\n  `polytopes.six_hundred_cell().plot()` etc.\n\n  The default position that works good for stacking, seems to be too close for schlegel projection.\n\n- Even worse: `polytopes.permutahedron(4).show()` isn't orthonormally projected anymore.",
    "created_at": "2020-10-27T13:26:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450983",
    "user": "https://github.com/kliem"
}
```

<a id='comment:17'></a>- The biggest trouble with schlegel is that the default position now seems to be much too close !(?)

  Take a look at at

  `polytopes.six_hundred_cell().plot()` etc.

  The default position that works good for stacking, seems to be too close for schlegel projection.

- Even worse: `polytopes.permutahedron(4).show()` isn't orthonormally projected anymore.



---

archive/issue_comments_450984.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-10-27T13:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450984",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_450985.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-17T08:08:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450985",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_450986.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:17 gh-kliem]:\n> - The biggest trouble with schlegel is that the default position now seems to be much too close !(?)\n> \n>   Take a look at at\n> \n>   `polytopes.six_hundred_cell().plot()` etc.\n> \n>   The default position that works good for stacking, seems to be too close for schlegel projection.\n\n\nDefaulting behavior will never be perfect.\n\n> \n> - Even worse: `polytopes.permutahedron(4).show()` isn't orthonormally projected anymore.\n\n\nIt was a mere coincidence that it was orthonormally projected by the method show (!).\nThis indicates that if one has a lower dimensional object (<=3) in an ambient dimension which is strictly larger than 3, one would prefer to visualize (by default) the object in its affine hull, and that, orthonormally projected. This is what you mean?\n\nIn this case, this is a different ticket fixing the `.show()/.plot()` methods. This ticket fixes the schlegel projection which it does...",
    "created_at": "2020-11-17T08:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450986",
    "user": "https://github.com/jplab"
}
```

<a id='comment:20'></a>Replying to [comment:17 gh-kliem]:
> - The biggest trouble with schlegel is that the default position now seems to be much too close !(?)
> 
>   Take a look at at
> 
>   `polytopes.six_hundred_cell().plot()` etc.
> 
>   The default position that works good for stacking, seems to be too close for schlegel projection.


Defaulting behavior will never be perfect.

> 
> - Even worse: `polytopes.permutahedron(4).show()` isn't orthonormally projected anymore.


It was a mere coincidence that it was orthonormally projected by the method show (!).
This indicates that if one has a lower dimensional object (<=3) in an ambient dimension which is strictly larger than 3, one would prefer to visualize (by default) the object in its affine hull, and that, orthonormally projected. This is what you mean?

In this case, this is a different ticket fixing the `.show()/.plot()` methods. This ticket fixes the schlegel projection which it does...



---

archive/issue_comments_450987.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,36 @@\n+The documentation string of `.schlegel_projection` reads:\n \n+```\n+   Return the Schlegel projection.\n+\n+   * The polyhedron is translated such that its \"center()\" is at the\n+     origin.\n+\n+   * The vertices are then normalized to the unit sphere\n+\n+   * The normalized points are stereographically projected from a\n+     point slightly outside of the sphere.\n+```\n+\n+When normalizing to the unit sphere this (potentially) completely breaks the convexity of the object. \n+\n+Minimal example:\n+\n+```\n+sage: fcube = polytopes.hypercube(4)\n+sage: tfcube = fcube.face_truncation(fcube.faces(0)[0])\n+sage: sp = tfcube.schlegel_projection()\n+sage: sp.plot()\n+Launched html viewer for Graphics3d Object\n+```\n+\n+The pentagons are not planar although they should in a schlegel diagram.\n+\n+The scaling to the unit sphere should be removed to preserve convexity.\n+\n+This ticket fixes the projection while de-duplicating some code.\n+\n+FOLLOW-UP: Fix .plot() and .show() to have a better behaviour of smaller dimensional objects.\n \n Comment: 1\n \n```\n",
    "created_at": "2020-11-17T08:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450987",
    "user": "https://github.com/jplab"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,36 @@
+The documentation string of `.schlegel_projection` reads:
 
+```
+   Return the Schlegel projection.
+
+   * The polyhedron is translated such that its "center()" is at the
+     origin.
+
+   * The vertices are then normalized to the unit sphere
+
+   * The normalized points are stereographically projected from a
+     point slightly outside of the sphere.
+```
+
+When normalizing to the unit sphere this (potentially) completely breaks the convexity of the object. 
+
+Minimal example:
+
+```
+sage: fcube = polytopes.hypercube(4)
+sage: tfcube = fcube.face_truncation(fcube.faces(0)[0])
+sage: sp = tfcube.schlegel_projection()
+sage: sp.plot()
+Launched html viewer for Graphics3d Object
+```
+
+The pentagons are not planar although they should in a schlegel diagram.
+
+The scaling to the unit sphere should be removed to preserve convexity.
+
+This ticket fixes the projection while de-duplicating some code.
+
+FOLLOW-UP: Fix .plot() and .show() to have a better behaviour of smaller dimensional objects.
 
 Comment: 1
 
```




---

archive/issue_comments_450988.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-11-17T08:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450988",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_450989.json:
```json
{
    "body": "<a id='comment:21'></a>Thank you for exposing the `position` argument.\n\nOf course default behavior will never be perfect, but it is stupid to be stuck with an awful default and don't know how to change it.\n\nIf I'm now unhappy with the default, I can inspect the `plot` method to find the option I need.\n\n`polytopes.permutehdron(4).show()` was orthonormally projected because the default for ambient dimension `4` is (previous to this ticket) schlegel projection. So it was orthonormal for the wrong reasons. Nevertheless, it worked.\n\nHow about adding\n\n```diff\ndiff --git a/src/sage/geometry/polyhedron/base.py b/src/sage/geometry/polyhedron/base.py\nindex 59eeb0aa41..f3551f6045 100644\n--- a/src/sage/geometry/polyhedron/base.py\n+++ b/src/sage/geometry/polyhedron/base.py\n@@ -1040,6 +1040,8 @@ class Polyhedron_base(Element):\n             elif polyhedron.dimension() == 4:\n                 # There is no 4-d screen, we must project down to 3d\n                 return polyhedron.schlegel_projection(position=position)\n+            elif polyhedron.dim() <= 3:\n+                return polyhedron.affine_hull_projection(orthonormal=True, extend=True).projection()\n             else:\n                 return polyhedron.projection()\n```\n\nto this ticket? Then this won't be a regression in that way.",
    "created_at": "2020-11-17T08:54:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450989",
    "user": "https://github.com/kliem"
}
```

<a id='comment:21'></a>Thank you for exposing the `position` argument.

Of course default behavior will never be perfect, but it is stupid to be stuck with an awful default and don't know how to change it.

If I'm now unhappy with the default, I can inspect the `plot` method to find the option I need.

`polytopes.permutehdron(4).show()` was orthonormally projected because the default for ambient dimension `4` is (previous to this ticket) schlegel projection. So it was orthonormal for the wrong reasons. Nevertheless, it worked.

How about adding

```diff
diff --git a/src/sage/geometry/polyhedron/base.py b/src/sage/geometry/polyhedron/base.py
index 59eeb0aa41..f3551f6045 100644
--- a/src/sage/geometry/polyhedron/base.py
+++ b/src/sage/geometry/polyhedron/base.py
@@ -1040,6 +1040,8 @@ class Polyhedron_base(Element):
             elif polyhedron.dimension() == 4:
                 # There is no 4-d screen, we must project down to 3d
                 return polyhedron.schlegel_projection(position=position)
+            elif polyhedron.dim() <= 3:
+                return polyhedron.affine_hull_projection(orthonormal=True, extend=True).projection()
             else:
                 return polyhedron.projection()
```

to this ticket? Then this won't be a regression in that way.



---

archive/issue_comments_450990.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:20 jipilab]:\n> [...]\n> \n> In this case, this is a different ticket fixing the `.show()/.plot()` methods. This ticket fixes the schlegel projection which it does...\n\n\nBut you have introduced a change in this ticket, this is why I propose to \"fix\" it here. At least some temporary solution we can live with.\n\nThe default plotting method before this ticket for `polytopes.permutahedron(4)` was schlegel projection. You changed this to just projection.",
    "created_at": "2020-11-17T09:44:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450990",
    "user": "https://github.com/kliem"
}
```

<a id='comment:22'></a>Replying to [comment:20 jipilab]:
> [...]
> 
> In this case, this is a different ticket fixing the `.show()/.plot()` methods. This ticket fixes the schlegel projection which it does...


But you have introduced a change in this ticket, this is why I propose to "fix" it here. At least some temporary solution we can live with.

The default plotting method before this ticket for `polytopes.permutahedron(4)` was schlegel projection. You changed this to just projection.



---

archive/issue_comments_450991.json:
```json
{
    "body": "<a id='comment:23'></a>Ok sure.\n\nBut again: it was not doing an orthonormal projection, otherwise the minimal non-working example in the ticket description would not occur. It was a mere accident because the permutahedron realization given there is inscribed.\n\nThe above addition looks good to me. I would even prioritize it over `polyhedron.dimension() == 4`, because... I guess that whenever you have an object that is at most dimension 3, you would like to see \"it\" exactly how it is, and I actually would give an option to turn off the orthonormal if the user wants to.\nThen, if the object has dimension 4, it will do the schlegel projection (without respect at all to the ambient dimension, which make more sense to me).\n\nI'll have another round of look at it.",
    "created_at": "2020-11-17T16:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450991",
    "user": "https://github.com/jplab"
}
```

<a id='comment:23'></a>Ok sure.

But again: it was not doing an orthonormal projection, otherwise the minimal non-working example in the ticket description would not occur. It was a mere accident because the permutahedron realization given there is inscribed.

The above addition looks good to me. I would even prioritize it over `polyhedron.dimension() == 4`, because... I guess that whenever you have an object that is at most dimension 3, you would like to see "it" exactly how it is, and I actually would give an option to turn off the orthonormal if the user wants to.
Then, if the object has dimension 4, it will do the schlegel projection (without respect at all to the ambient dimension, which make more sense to me).

I'll have another round of look at it.



---

archive/issue_comments_450992.json:
```json
{
    "body": "<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-18T13:31:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450992",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_450993.json:
```json
{
    "body": "<a id='comment:25'></a>It should be all fixed now. I changed the default behavior for when the locus polyhedron is compact, to take the midpoint of the line segment. The rest is unchanged. Further, I exposed the option to remove orthonormality in the plotting...\n\nHave a look at:\n\n```\nsage: p = polytopes.six_hundred_cell()                                                                                                                                                                             \nsage: p.show(position=4,point={'size':0},frame=False)\n```",
    "created_at": "2020-11-18T13:34:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450993",
    "user": "https://github.com/jplab"
}
```

<a id='comment:25'></a>It should be all fixed now. I changed the default behavior for when the locus polyhedron is compact, to take the midpoint of the line segment. The rest is unchanged. Further, I exposed the option to remove orthonormality in the plotting...

Have a look at:

```
sage: p = polytopes.six_hundred_cell()                                                                                                                                                                             
sage: p.show(position=4,point={'size':0},frame=False)
```



---

archive/issue_comments_450994.json:
```json
{
    "body": "<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-18T13:44:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450994",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:26'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_450995.json:
```json
{
    "body": "<a id='comment:27'></a>... Ok. So ready for review again... It should be a small improvement on the plotting procedure. To me it makes more sense as of now. (see the internal `def project` function which decides what to do...)",
    "created_at": "2020-11-18T13:45:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450995",
    "user": "https://github.com/jplab"
}
```

<a id='comment:27'></a>... Ok. So ready for review again... It should be a small improvement on the plotting procedure. To me it makes more sense as of now. (see the internal `def project` function which decides what to do...)



---

archive/issue_comments_450996.json:
```json
{
    "body": "<a id='comment:28'></a>\n```diff\n-        def project(polyhedron,ortho):\n+        def project(polyhedron, ortho):\n```\n\n```diff\n-        projection = project(self,orthonormal)\n+        projection = project(self, orthonormal)\n```\n\nI propose the following doctest to show that this has been fixed::\n\n```\nsage: fcube = polytopes.hypercube(4)                                                                                                                                                \nsage: tfcube = fcube.face_truncation(fcube.faces(0)[0])                                                                                                                             \nsage: sp = tfcube.schlegel_projection()                                                                                                                                             \nsage: for face in tfcube.faces(2): \n....:     vertices = face.ambient_Vrepresentation() \n....:     indices = [sp.coord_index_of(vector(x)) for x in vertices] \n....:     projected_vertices = [sp.transformed_coords[i] for i in indices] \n....:     assert Polyhedron(projected_vertices).dim() == 2 \n```\n\nThis line here is hard to read due to the underscore. I would exchange it for something else:\n\n```\nineq = [_ for _ in facet.ambient_Hrepresentation() if _.is_inequality()][0]\n```\n\n```diff\n+        A, b = self.facet.as_polyhedron().affine_hull_projection(as_affine_map=True, orthonormal=True,extend=True)\n-        A,b = self.facet.as_polyhedron().affine_hull_projection(as_affine_map=True, orthonormal=True, extend=True)\n```\n\n```diff\n-        self.projection_point = vector(RDF,projection_point)\n+        self.projection_point = vector(RDF, projection_point)\n```",
    "created_at": "2020-11-19T07:49:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450996",
    "user": "https://github.com/kliem"
}
```

<a id='comment:28'></a>
```diff
-        def project(polyhedron,ortho):
+        def project(polyhedron, ortho):
```

```diff
-        projection = project(self,orthonormal)
+        projection = project(self, orthonormal)
```

I propose the following doctest to show that this has been fixed::

```
sage: fcube = polytopes.hypercube(4)                                                                                                                                                
sage: tfcube = fcube.face_truncation(fcube.faces(0)[0])                                                                                                                             
sage: sp = tfcube.schlegel_projection()                                                                                                                                             
sage: for face in tfcube.faces(2): 
....:     vertices = face.ambient_Vrepresentation() 
....:     indices = [sp.coord_index_of(vector(x)) for x in vertices] 
....:     projected_vertices = [sp.transformed_coords[i] for i in indices] 
....:     assert Polyhedron(projected_vertices).dim() == 2 
```

This line here is hard to read due to the underscore. I would exchange it for something else:

```
ineq = [_ for _ in facet.ambient_Hrepresentation() if _.is_inequality()][0]
```

```diff
+        A, b = self.facet.as_polyhedron().affine_hull_projection(as_affine_map=True, orthonormal=True,extend=True)
-        A,b = self.facet.as_polyhedron().affine_hull_projection(as_affine_map=True, orthonormal=True, extend=True)
```

```diff
-        self.projection_point = vector(RDF,projection_point)
+        self.projection_point = vector(RDF, projection_point)
```



---

archive/issue_comments_450997.json:
```json
{
    "body": "<a id='comment:29'></a>Once done, you can put it on positive review on my behalf.\n\nThank you for fixing this. It's great to have this.",
    "created_at": "2020-11-19T07:53:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450997",
    "user": "https://github.com/kliem"
}
```

<a id='comment:29'></a>Once done, you can put it on positive review on my behalf.

Thank you for fixing this. It's great to have this.



---

archive/issue_comments_450998.json:
```json
{
    "body": "<a id='comment:30'></a>With your ticket, how do I obtain a decent picture of `polytopes.cyclic_polytope(4,10)`?\n\nOr maybe one should really choose better points on the moment curve for pictures. The pairwise euclidean distance of the vertices behaves awful.",
    "created_at": "2020-11-19T12:21:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450998",
    "user": "https://github.com/kliem"
}
```

<a id='comment:30'></a>With your ticket, how do I obtain a decent picture of `polytopes.cyclic_polytope(4,10)`?

Or maybe one should really choose better points on the moment curve for pictures. The pairwise euclidean distance of the vertices behaves awful.



---

archive/issue_comments_450999.json:
```json
{
    "body": "<a id='comment:31'></a>I guess you can basically forget the last comment. It is just to note that the current realization doesn't work for pictures.\n\nAnyway, if you agree to the changes I suggested, I can also do them.",
    "created_at": "2020-11-21T11:55:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-450999",
    "user": "https://github.com/kliem"
}
```

<a id='comment:31'></a>I guess you can basically forget the last comment. It is just to note that the current realization doesn't work for pictures.

Anyway, if you agree to the changes I suggested, I can also do them.



---

archive/issue_comments_451000.json:
```json
{
    "body": "<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-22T11:56:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-451000",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_451001.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-11-22T11:56:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-451001",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_451002.json:
```json
{
    "body": "<a id='comment:34'></a>Replying to [comment:30 gh-kliem]:\n> With your ticket, how do I obtain a decent picture of `polytopes.cyclic_polytope(4,10)`?\n> \n> Or maybe one should really choose better points on the moment curve for pictures. The pairwise euclidean distance of the vertices behaves awful.\n\n\nThere isn't really any good choice of parameters to get \"a nice picture\" of the cyclic polytope on the moment curve.\n\nA better choice would be to essentially add the cyclic polytope construction on the trigonometric curve so that the coordinates all have the same \"scale\". ... another nice thing that would be easy to implement and that's not too hard.",
    "created_at": "2020-11-22T11:58:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-451002",
    "user": "https://github.com/jplab"
}
```

<a id='comment:34'></a>Replying to [comment:30 gh-kliem]:
> With your ticket, how do I obtain a decent picture of `polytopes.cyclic_polytope(4,10)`?
> 
> Or maybe one should really choose better points on the moment curve for pictures. The pairwise euclidean distance of the vertices behaves awful.


There isn't really any good choice of parameters to get "a nice picture" of the cyclic polytope on the moment curve.

A better choice would be to essentially add the cyclic polytope construction on the trigonometric curve so that the coordinates all have the same "scale". ... another nice thing that would be easy to implement and that's not too hard.



---

archive/issue_comments_451003.json:
```json
{
    "body": "<a id='comment:35'></a>Typos, to be fixed here or in a follow-up ticket.\n\n```diff\n-        A different values of ``position`` changes the projection::\n+        A different value of ``position`` changes the projection::\n```\n\n```diff\n-        sees more than one facet resulting in a error::\n+        sees more than one facet resulting in an error::\n```",
    "created_at": "2020-11-22T22:36:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-451003",
    "user": "https://github.com/slel"
}
```

<a id='comment:35'></a>Typos, to be fixed here or in a follow-up ticket.

```diff
-        A different values of ``position`` changes the projection::
+        A different value of ``position`` changes the projection::
```

```diff
-        sees more than one facet resulting in a error::
+        sees more than one facet resulting in an error::
```



---

archive/issue_comments_451004.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-11-29T11:57:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30015#issuecomment-451004",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_077142.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-11-29T11:57:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30015",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30015#event-77142"
}
```
