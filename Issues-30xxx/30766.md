# Issue 30766: Experimental support for Python 3.10 in Sage 9.5

archive/issues_030529.json:
```json
{
    "body": "This is to support Python 3.10, which was released on 2021-10-04.\nhttps://docs.python.org/3.10/whatsnew/changelog.html#changelog\n\nThanks to the following tickets, Sage is mostly ready for \nPython 3.10 in addition to 3.9, 3.8, 3.7.\n\n- needs Cython 0.29.23 (#31445)\n- #31855 Patch/upgrade `gmpy2` to add python 3.10 support\n- #31856 Upgrade `pyzmq`, `babel` - to fix `error: implicit declaration of function 'PyObject_AsWriteBuffer' is invalid in C99` with pyzmq-19.0.2 \n- #32815 `numpy`\n- #32837 `cffi`: Update to 1.15.0\n- #32852 Update `traitlets` to 5.1.1 (for python 3.9.8, 3.10)\n- #32671 Update `pip` to 21.3.1, `distlib` to 0.3.3\n- #31295 Meta-ticket: Replace imports from deprecated `distutils`\n- #32930 IPython/Jupyter upgrade for python 3.10 support\n- #33013 Fix tests with Python 3.10\n\nIn this ticket, we enable use of system Python 3.10 but issue a warning regarding its experimental status for Sage. \n\nThe ticket does not include the upgrade of the `python3` SPKG to Python 3.10.  Many systems already ship Python 3.10.  To test, thanks to https://wiki.sagemath.org/ReleaseTours/sage-9.5#Separate_virtual_environment_for_Python_packages, a full rebuild of the Sage distribution is not necessary - only the Python packages will be  built from scratch in a separate venv.\n\nRelated:\n\n- [PEP 619 -- Python 3.10 Release Schedule](https://www.python.org/dev/peps/pep-0619/)\n- [What's new in Python 3.10](https://docs.python.org/3.10/whatsnew/3.10.html)\n- #30767: Upgrade to Python 3.10\n- #30184: Support Python 3.9\n- #30384: Adopt the \u201ctime window-based\u201d policy for support of Python versions from NEP 29\n\n\nCC:  @mkoeppe @slel @kiwifb @tornaria @antonio-rojas\n\nKeywords: upgrade, python\n\nReviewer: Antonio Rojas, Matthias Koeppe\n\nAuthor: Matthias Koeppe, Gonzalo Tornar\u00eda\n\nBranch: df9f1d4ced4264f65ab704f725f6f5879b012796\n\nDependencies: #33013, #32930, #33040\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30766\n\n",
    "closed_at": "2022-01-01T00:23:38Z",
    "created_at": "2020-10-13T21:33:40Z",
    "labels": [
        "component: packages: standard",
        "critical"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Experimental support for Python 3.10 in Sage 9.5",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30766",
    "user": "https://github.com/slel"
}
```
This is to support Python 3.10, which was released on 2021-10-04.
https://docs.python.org/3.10/whatsnew/changelog.html#changelog

Thanks to the following tickets, Sage is mostly ready for 
Python 3.10 in addition to 3.9, 3.8, 3.7.

- needs Cython 0.29.23 (#31445)
- #31855 Patch/upgrade `gmpy2` to add python 3.10 support
- #31856 Upgrade `pyzmq`, `babel` - to fix `error: implicit declaration of function 'PyObject_AsWriteBuffer' is invalid in C99` with pyzmq-19.0.2 
- #32815 `numpy`
- #32837 `cffi`: Update to 1.15.0
- #32852 Update `traitlets` to 5.1.1 (for python 3.9.8, 3.10)
- #32671 Update `pip` to 21.3.1, `distlib` to 0.3.3
- #31295 Meta-ticket: Replace imports from deprecated `distutils`
- #32930 IPython/Jupyter upgrade for python 3.10 support
- #33013 Fix tests with Python 3.10

In this ticket, we enable use of system Python 3.10 but issue a warning regarding its experimental status for Sage. 

The ticket does not include the upgrade of the `python3` SPKG to Python 3.10.  Many systems already ship Python 3.10.  To test, thanks to https://wiki.sagemath.org/ReleaseTours/sage-9.5#Separate_virtual_environment_for_Python_packages, a full rebuild of the Sage distribution is not necessary - only the Python packages will be  built from scratch in a separate venv.

Related:

- [PEP 619 -- Python 3.10 Release Schedule](https://www.python.org/dev/peps/pep-0619/)
- [What's new in Python 3.10](https://docs.python.org/3.10/whatsnew/3.10.html)
- #30767: Upgrade to Python 3.10
- #30184: Support Python 3.9
- #30384: Adopt the “time window-based” policy for support of Python versions from NEP 29


CC:  @mkoeppe @slel @kiwifb @tornaria @antonio-rojas

Keywords: upgrade, python

Reviewer: Antonio Rojas, Matthias Koeppe

Author: Matthias Koeppe, Gonzalo Tornaría

Branch: df9f1d4ced4264f65ab704f725f6f5879b012796

Dependencies: #33013, #32930, #33040

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/30766





---

archive/issue_comments_435399.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to task.",
    "created_at": "2020-10-13T21:44:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435399",
    "user": "https://github.com/slel"
}
```

Changing type from PLEASE CHANGE to task.



---

archive/issue_comments_435400.json:
```json
{
    "body": "Changing keywords from \"\" to \"upgrade, python\".",
    "created_at": "2020-10-13T21:44:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435400",
    "user": "https://github.com/slel"
}
```

Changing keywords from "" to "upgrade, python".



---

archive/issue_comments_435401.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to packages: standard.",
    "created_at": "2020-10-13T21:44:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435401",
    "user": "https://github.com/slel"
}
```

Changing component from PLEASE CHANGE to packages: standard.



---

archive/issue_events_080210.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-14T18:29:25Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30766#event-80210"
}
```



---

archive/issue_comments_435402.json:
```json
{
    "body": "<a id='comment:8'></a>New commits:",
    "created_at": "2021-05-24T23:56:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435402",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>New commits:



---

archive/issue_comments_435403.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-25T00:03:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435403",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435404.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-25T00:06:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435404",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435405.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-25T00:20:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435405",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435406.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2021-05-25T00:29:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435406",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_435407.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-25T00:46:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435407",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_080211.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-11T21:20:26Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30766#event-80211"
}
```



---

archive/issue_events_080212.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-11T21:20:26Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30766#event-80212"
}
```



---

archive/issue_comments_435408.json:
```json
{
    "body": "<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-09-15T23:59:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435408",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_435409.json:
```json
{
    "body": "<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-16T00:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435409",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435410.json:
```json
{
    "body": "<a id='comment:29'></a>\n```\n  [scipy-1.6.3]   ERROR: Package 'scipy' requires a different Python: 3.10.0 not in '<3.10,>=3.7'\n```",
    "created_at": "2021-09-16T00:53:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435410",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:29'></a>
```
  [scipy-1.6.3]   ERROR: Package 'scipy' requires a different Python: 3.10.0 not in '<3.10,>=3.7'
```



---

archive/issue_comments_435411.json:
```json
{
    "body": "<a id='comment:30'></a>\n```\n  [pplpy-0.8.6]   Copying package files from temporary location /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/var/tmp/sage/build/pplpy-0.8.6/inst to /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1\n  [pplpy-0.8.6]   Running post-install script for pplpy-0.8.6.\n  [pplpy-0.8.6]   Traceback (most recent call last):\n  [pplpy-0.8.6]     File \"/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/bin/sphinx-build\", line 5, in <module>\n  [pplpy-0.8.6]       from sphinx.cmd.build import main\n  [pplpy-0.8.6]     File \"/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sphinx/cmd/build.py\", line 25, in <module>\n  [pplpy-0.8.6]       from sphinx.application import Sphinx\n  [pplpy-0.8.6]     File \"/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sphinx/application.py\", line 31, in <module>\n  [pplpy-0.8.6]       from sphinx.config import Config\n  [pplpy-0.8.6]     File \"/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sphinx/config.py\", line 21, in <module>\n  [pplpy-0.8.6]       from sphinx.util import logging\n  [pplpy-0.8.6]     File \"/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sphinx/util/__init__.py\", line 41, in <module>\n  [pplpy-0.8.6]       from sphinx.util.typing import PathMatcher\n  [pplpy-0.8.6]     File \"/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sphinx/util/typing.py\", line 37, in <module>\n  [pplpy-0.8.6]       from types import Union as types_Union\n  [pplpy-0.8.6]   ImportError: cannot import name 'Union' from 'types' (/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/types.py)\n  [pplpy-0.8.6]   make[5]: *** [html] Error 1\n  [pplpy-0.8.6]   cp: build/html/*: No such file or directory\n```",
    "created_at": "2021-09-16T00:53:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435411",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'></a>
```
  [pplpy-0.8.6]   Copying package files from temporary location /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/var/tmp/sage/build/pplpy-0.8.6/inst to /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1
  [pplpy-0.8.6]   Running post-install script for pplpy-0.8.6.
  [pplpy-0.8.6]   Traceback (most recent call last):
  [pplpy-0.8.6]     File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/bin/sphinx-build", line 5, in <module>
  [pplpy-0.8.6]       from sphinx.cmd.build import main
  [pplpy-0.8.6]     File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sphinx/cmd/build.py", line 25, in <module>
  [pplpy-0.8.6]       from sphinx.application import Sphinx
  [pplpy-0.8.6]     File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sphinx/application.py", line 31, in <module>
  [pplpy-0.8.6]       from sphinx.config import Config
  [pplpy-0.8.6]     File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sphinx/config.py", line 21, in <module>
  [pplpy-0.8.6]       from sphinx.util import logging
  [pplpy-0.8.6]     File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sphinx/util/__init__.py", line 41, in <module>
  [pplpy-0.8.6]       from sphinx.util.typing import PathMatcher
  [pplpy-0.8.6]     File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sphinx/util/typing.py", line 37, in <module>
  [pplpy-0.8.6]       from types import Union as types_Union
  [pplpy-0.8.6]   ImportError: cannot import name 'Union' from 'types' (/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/types.py)
  [pplpy-0.8.6]   make[5]: *** [html] Error 1
  [pplpy-0.8.6]   cp: build/html/*: No such file or directory
```



---

archive/issue_comments_435412.json:
```json
{
    "body": "<a id='comment:32'></a>Replying to [comment:29 mkoeppe]:\n> {{{\n>   [scipy-1.6.3]   ERROR: Package 'scipy' requires a different Python: 3.10.0 not in '<3.10,>=3.7'\n> }}}\n\nIt does not look like a 1.6.4 is in preparation (https://github.com/scipy/scipy/commits/maintenance/1.6.x)... so I guess we'll have to do the update to 1.7.x in #32105",
    "created_at": "2021-09-16T01:15:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435412",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:32'></a>Replying to [comment:29 mkoeppe]:
> {{{
>   [scipy-1.6.3]   ERROR: Package 'scipy' requires a different Python: 3.10.0 not in '<3.10,>=3.7'
> }}}

It does not look like a 1.6.4 is in preparation (https://github.com/scipy/scipy/commits/maintenance/1.6.x)... so I guess we'll have to do the update to 1.7.x in #32105



---

archive/issue_comments_435413.json:
```json
{
    "body": "<a id='comment:33'></a>Workaround for the `scipy` install problem: `--ignore-requires-python` (new commits in #32492)",
    "created_at": "2021-09-16T01:44:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435413",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:33'></a>Workaround for the `scipy` install problem: `--ignore-requires-python` (new commits in #32492)



---

archive/issue_comments_435414.json:
```json
{
    "body": "<a id='comment:34'></a>Replying to [comment:30 mkoeppe]:\n> {{{\n>   [pplpy-0.8.6]       from types import Union as types_Union\n>   [pplpy-0.8.6]   ImportError: cannot import name 'Union' from 'types' (/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/types.py)\n>   [pplpy-0.8.6]   make[5]: *** [html] Error 1\n>   [pplpy-0.8.6]   cp: build/html/*: No such file or directory\n> }}}\n\nFixed by the sphinx upgrade in #32518",
    "created_at": "2021-09-16T01:45:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435414",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'></a>Replying to [comment:30 mkoeppe]:
> {{{
>   [pplpy-0.8.6]       from types import Union as types_Union
>   [pplpy-0.8.6]   ImportError: cannot import name 'Union' from 'types' (/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/types.py)
>   [pplpy-0.8.6]   make[5]: *** [html] Error 1
>   [pplpy-0.8.6]   cp: build/html/*: No such file or directory
> }}}

Fixed by the sphinx upgrade in #32518



---

archive/issue_comments_435415.json:
```json
{
    "body": "<a id='comment:36'></a>`cvxopt` build fails, needs https://github.com/cvxopt/cvxopt/pull/190",
    "created_at": "2021-09-16T01:52:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435415",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:36'></a>`cvxopt` build fails, needs https://github.com/cvxopt/cvxopt/pull/190



---

archive/issue_comments_435416.json:
```json
{
    "body": "<a id='comment:38'></a>Replying to [comment:36 mkoeppe]:\n> `cvxopt` build fails, needs https://github.com/cvxopt/cvxopt/pull/190\n\nThat's #32519",
    "created_at": "2021-09-16T02:00:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435416",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:38'></a>Replying to [comment:36 mkoeppe]:
> `cvxopt` build fails, needs https://github.com/cvxopt/cvxopt/pull/190

That's #32519



---

archive/issue_comments_435417.json:
```json
{
    "body": "<a id='comment:40'></a>Tests (via #30767) run at https://github.com/mkoeppe/sage/actions/runs/1239984523 -- all `-minimal` builds will use python 3.10.0rc1",
    "created_at": "2021-09-16T02:29:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435417",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:40'></a>Tests (via #30767) run at https://github.com/mkoeppe/sage/actions/runs/1239984523 -- all `-minimal` builds will use python 3.10.0rc1



---

archive/issue_comments_435418.json:
```json
{
    "body": "<a id='comment:42'></a>`distutils` deprecation -> #32565:\n\n```\nsage -t --long --random-seed=0 src/sage/plot/plot.py\n**********************************************************************\nFile \"src/sage/plot/plot.py\", line 513, in sage.plot.plot\nFailed example:\n    os.system(\"sage -c \\\"if 'matplotlib' in sys.modules: sys.exit(1)\\\"\") # long time\nExpected:\n    0\nGot:\n    /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sage/features/__init__.py:55: DeprecationWarning: The distutils package is deprecated and slated for removal in Python 3.12. Use setuptools or check PEP 632 for potential alternatives\n      from distutils.errors import CCompilerError\n    0\n```",
    "created_at": "2021-09-16T03:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435418",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:42'></a>`distutils` deprecation -> #32565:

```
sage -t --long --random-seed=0 src/sage/plot/plot.py
**********************************************************************
File "src/sage/plot/plot.py", line 513, in sage.plot.plot
Failed example:
    os.system("sage -c \"if 'matplotlib' in sys.modules: sys.exit(1)\"") # long time
Expected:
    0
Got:
    /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sage/features/__init__.py:55: DeprecationWarning: The distutils package is deprecated and slated for removal in Python 3.12. Use setuptools or check PEP 632 for potential alternatives
      from distutils.errors import CCompilerError
    0
```



---

archive/issue_comments_435419.json:
```json
{
    "body": "<a id='comment:43'></a>Many failures from improved error messages -> #32520\n\n```\nsage -t --long --random-seed=0 src/sage/geometry/polyhedron/base.py\n**********************************************************************\nFile \"src/sage/geometry/polyhedron/base.py\", line 214, in sage.geometry.polyhedron.base.Polyhedron_base.__init__\nFailed example:\n    p = Polyhedron_field(parent, Vrep, 'nonsense',  # py3\n                         Vrep_minimal=True, Hrep_minimal=True, pref_rep='Vrep')\nExpected:\n    Traceback (most recent call last):\n    ...\n    TypeError: _init_Hrepresentation() takes 3 positional arguments but 9 were given\nGot:\n    <BLANKLINE>\n    Traceback (most recent call last):\n...\n    TypeError: Polyhedron_field._init_Hrepresentation() takes 3 positional arguments but 9 were given\n**********************************************************************\n```",
    "created_at": "2021-09-16T03:36:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435419",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:43'></a>Many failures from improved error messages -> #32520

```
sage -t --long --random-seed=0 src/sage/geometry/polyhedron/base.py
**********************************************************************
File "src/sage/geometry/polyhedron/base.py", line 214, in sage.geometry.polyhedron.base.Polyhedron_base.__init__
Failed example:
    p = Polyhedron_field(parent, Vrep, 'nonsense',  # py3
                         Vrep_minimal=True, Hrep_minimal=True, pref_rep='Vrep')
Expected:
    Traceback (most recent call last):
    ...
    TypeError: _init_Hrepresentation() takes 3 positional arguments but 9 were given
Got:
    <BLANKLINE>
    Traceback (most recent call last):
...
    TypeError: Polyhedron_field._init_Hrepresentation() takes 3 positional arguments but 9 were given
**********************************************************************
```



---

archive/issue_comments_435420.json:
```json
{
    "body": "<a id='comment:44'></a>Stricter parser:\n\n```\nsage -t --long --random-seed=0 src/sage/schemes/riemann_surfaces/riemann_surface.py\n**********************************************************************\nFile \"src/sage/schemes/riemann_surfaces/riemann_surface.py\", line 1393, in sage.schemes.riemann_surfaces.riemann_surface.RiemannSurface.make_zw_interpolator\nFailed example:\n    all(f(*g(i*0.1)).abs() < 1e-13for i in range(10))\nExpected:\n    True\nGot:\n    DeprecationWarning: invalid decimal literal\n    True\n```",
    "created_at": "2021-09-16T03:40:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435420",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:44'></a>Stricter parser:

```
sage -t --long --random-seed=0 src/sage/schemes/riemann_surfaces/riemann_surface.py
**********************************************************************
File "src/sage/schemes/riemann_surfaces/riemann_surface.py", line 1393, in sage.schemes.riemann_surfaces.riemann_surface.RiemannSurface.make_zw_interpolator
Failed example:
    all(f(*g(i*0.1)).abs() < 1e-13for i in range(10))
Expected:
    True
Got:
    DeprecationWarning: invalid decimal literal
    True
```



---

archive/issue_comments_435421.json:
```json
{
    "body": "<a id='comment:45'></a>Sage numbers no longer accepted:\n\n```\nsage -t --long --random-seed=0 src/sage/tests/cmdline.py\n**********************************************************************\nFile \"src/sage/tests/cmdline.py\", line 104, in sage.tests.cmdline.test_executable\nFailed example:\n    (out, err, ret) = test_executable([\"sleep\", \"1\"], timeout=0.1)\nExpected:\n    Traceback (most recent call last):\n    ...\n    RuntimeError: timeout in test_executable()\nGot:\n    <BLANKLINE>\n    Traceback (most recent call last):\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sage/doctest/forker.py\", line 704, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1098, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.tests.cmdline.test_executable[5]>\", line 1, in <module>\n        (out, err, ret) = test_executable([\"sleep\", \"1\"], timeout=RealNumber('0.1'))\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sage/tests/cmdline.py\", line 769, in test_executable\n        rlist = select.select(rfd, [], [], timeout)[0]\n    TypeError: timeout must be a float or None\n```\n\n```\nsage -t --long --random-seed=0 src/sage_docbuild/utils.py\n**********************************************************************\nFile \"src/sage_docbuild/utils.py\", line 91, in sage_docbuild.utils\nFailed example:\n    build_many(target, range(8), processes=8)\nExpected:\n    Traceback (most recent call last):\n    ...\n    ZeroDivisionError: rational division by zero\nGot:\n    <BLANKLINE>\n    Traceback (most recent call last):\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sage/doctest/forker.py\", line 704, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1098, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage_docbuild.utils[6]>\", line 1, in <module>\n        build_many(target, range(Integer(8)), processes=Integer(8))\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sage_docbuild/utils.py\", line 289, in build_many\n        raise worker_exc.original_exception\n    TypeError: 'sage.rings.real_mpfr.RealLiteral' object cannot be interpreted as an integer\n```",
    "created_at": "2021-09-16T03:40:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435421",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:45'></a>Sage numbers no longer accepted:

```
sage -t --long --random-seed=0 src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 104, in sage.tests.cmdline.test_executable
Failed example:
    (out, err, ret) = test_executable(["sleep", "1"], timeout=0.1)
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: timeout in test_executable()
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sage/doctest/forker.py", line 704, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sage/doctest/forker.py", line 1098, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.tests.cmdline.test_executable[5]>", line 1, in <module>
        (out, err, ret) = test_executable(["sleep", "1"], timeout=RealNumber('0.1'))
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sage/tests/cmdline.py", line 769, in test_executable
        rlist = select.select(rfd, [], [], timeout)[0]
    TypeError: timeout must be a float or None
```

```
sage -t --long --random-seed=0 src/sage_docbuild/utils.py
**********************************************************************
File "src/sage_docbuild/utils.py", line 91, in sage_docbuild.utils
Failed example:
    build_many(target, range(8), processes=8)
Expected:
    Traceback (most recent call last):
    ...
    ZeroDivisionError: rational division by zero
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sage/doctest/forker.py", line 704, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sage/doctest/forker.py", line 1098, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_docbuild.utils[6]>", line 1, in <module>
        build_many(target, range(Integer(8)), processes=Integer(8))
      File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.10.0rc1/lib/python3.10/site-packages/sage_docbuild/utils.py", line 289, in build_many
        raise worker_exc.original_exception
    TypeError: 'sage.rings.real_mpfr.RealLiteral' object cannot be interpreted as an integer
```



---

archive/issue_comments_435422.json:
```json
{
    "body": "<a id='comment:46'></a>inspect:\n\n```\nsage -t --long --random-seed=0 src/sage/misc/sageinspect.py\n**********************************************************************\nFile \"src/sage/misc/sageinspect.py\", line 1561, in sage.misc.sageinspect.sage_getargspec\nFailed example:\n    shell.run_cell('f??')\nExpected:\n    ...the source code string...\nGot:\n    ---------------------------------------------------------------------------\n    OSError                                   Traceback (most recent call last)\n```",
    "created_at": "2021-09-16T03:45:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435422",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:46'></a>inspect:

```
sage -t --long --random-seed=0 src/sage/misc/sageinspect.py
**********************************************************************
File "src/sage/misc/sageinspect.py", line 1561, in sage.misc.sageinspect.sage_getargspec
Failed example:
    shell.run_cell('f??')
Expected:
    ...the source code string...
Got:
    ---------------------------------------------------------------------------
    OSError                                   Traceback (most recent call last)
```



---

archive/issue_comments_435423.json:
```json
{
    "body": "<a id='comment:47'></a>\n```\nsage -t --long --random-seed=0 src/sage/categories/loop_crystals.py\n**********************************************************************\nFile \"src/sage/categories/loop_crystals.py\", line 115, in sage.categories.loop_crystals.LoopCrystals.ParentMethods.digraph\nFailed example:\n    G.latex_options()  # optional - dot2tex\nExpected:\n    LaTeX options for Digraph on 29 vertices:\n    {...'edge_options': <function ... at ...>...}\nGot:\n    LaTeX options for Digraph on 29 vertices: {}\n```",
    "created_at": "2021-09-16T03:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435423",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:47'></a>
```
sage -t --long --random-seed=0 src/sage/categories/loop_crystals.py
**********************************************************************
File "src/sage/categories/loop_crystals.py", line 115, in sage.categories.loop_crystals.LoopCrystals.ParentMethods.digraph
Failed example:
    G.latex_options()  # optional - dot2tex
Expected:
    LaTeX options for Digraph on 29 vertices:
    {...'edge_options': <function ... at ...>...}
Got:
    LaTeX options for Digraph on 29 vertices: {}
```



---

archive/issue_comments_435424.json:
```json
{
    "body": "<a id='comment:48'></a>\n```\nsage -t --long --random-seed=0 src/sage/cpython/atexit.pyx\n**********************************************************************\nFile \"src/sage/cpython/atexit.pyx\", line 61, in sage.cpython.atexit\nFailed example:\n    with restore_atexit(clear=True):\n        atexit._run_exitfuncs()  # Should be none registered\n        atexit.register(handler, 1, 2, c=3)\n        with restore_atexit():\n            atexit._run_exitfuncs()  # Run just registered handler\n        atexit._run_exitfuncs()  # Handler should be run again\nExpected:\n    <function handler at 0x...>\n    ((1, 2), {'c': 3})\n    ((1, 2), {'c': 3})\nGot:\n    <function handler at 0x357023a30>\n    ((1, 2), {'c': 3})\n```",
    "created_at": "2021-09-16T05:03:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435424",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:48'></a>
```
sage -t --long --random-seed=0 src/sage/cpython/atexit.pyx
**********************************************************************
File "src/sage/cpython/atexit.pyx", line 61, in sage.cpython.atexit
Failed example:
    with restore_atexit(clear=True):
        atexit._run_exitfuncs()  # Should be none registered
        atexit.register(handler, 1, 2, c=3)
        with restore_atexit():
            atexit._run_exitfuncs()  # Run just registered handler
        atexit._run_exitfuncs()  # Handler should be run again
Expected:
    <function handler at 0x...>
    ((1, 2), {'c': 3})
    ((1, 2), {'c': 3})
Got:
    <function handler at 0x357023a30>
    ((1, 2), {'c': 3})
```



---

archive/issue_comments_435425.json:
```json
{
    "body": "<a id='comment:50'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-28T19:15:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435425",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:50'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435426.json:
```json
{
    "body": "<a id='comment:52'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-28T19:26:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435426",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:52'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435427.json:
```json
{
    "body": "<a id='comment:53'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-09-28T19:27:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435427",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:53'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435428.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-10-05T17:33:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435428",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_435429.json:
```json
{
    "body": "<a id='comment:58'></a>I'm testing c73bc97 using system python 3.10 (void linux).\n\nCompilation succeeds. Then running `./sage` gives:\n\n```\n/opt/sage/sage-git/local/lib/python3.10/site-packages/prompt_toolkit/application/application.py:882: DeprecationWarning: There is no current event loop\n  loop = get_event_loop()\nsage: ...\n```\nRunning `./sage -tp 8 --all` gives:\n- lots of crashes apparently related to cysignals; stack trace starts with\n\n```\n/opt/sage/sage-git/local/lib/python3.10/site-packages/cysignals/signals.cpython-310-x86_64-linux-gnu.so(+0x7e30)[0x7f2c06dbae30]\n/opt/sage/sage-git/local/lib/python3.10/site-packages/cysignals/signals.cpython-310-x86_64-linux-gnu.so(+0x7ee9)[0x7f2c06dbaee9]\n/opt/sage/sage-git/local/lib/python3.10/site-packages/cysignals/signals.cpython-310-x86_64-linux-gnu.so(+0xafd5)[0x7f2c06dbdfd5]\n/usr/lib/libc.so.6(+0x3d000)[0x7f2c07fcb000]\n/opt/sage/sage-git/local/lib/python3.10/site-packages/sage/cpython/atexit.cpython-310-x86_64-linux-gnu.so(+0x5131)[0x7f2c073e1131]\n/opt/sage/sage-git/local/lib/python3.10/site-packages/sage/cpython/atexit.cpython-310-x86_64-linux-gnu.so(+0x5932)[0x7f2c073e1932]\n/usr/lib/libpython3.10.so.1.0(+0xec50e)[0x7f2c0824050e]\n/usr/lib/libpython3.10.so.1.0(_PyEval_EvalFrameDefault+0x47d8)[0x7f2c081bdd68]\n...\n```\n- more deprecation warnings\n\n```\n/opt/sage/sage-git/local/bin/cysignals-CSI:44: DeprecationWarning: The distutils package is deprecated and slated for removal in Python 3.12. Use setuptools or check PEP 632 for potential alternatives\n```\n\nAll I'm doing is, starting with a clean copy of c73bc97\n\n```\n$ ./bootstrap\n$ ./configure\n$ make build -j12\n$ ./sage -tp 8 --all\n```\n\nI have logs, let me know if you need more info.\n\nMy goal is packaging sage for void linux, but it's already migrated to python 3.10 so this is a blocker.",
    "created_at": "2021-11-09T13:09:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435429",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:58'></a>I'm testing c73bc97 using system python 3.10 (void linux).

Compilation succeeds. Then running `./sage` gives:

```
/opt/sage/sage-git/local/lib/python3.10/site-packages/prompt_toolkit/application/application.py:882: DeprecationWarning: There is no current event loop
  loop = get_event_loop()
sage: ...
```
Running `./sage -tp 8 --all` gives:
- lots of crashes apparently related to cysignals; stack trace starts with

```
/opt/sage/sage-git/local/lib/python3.10/site-packages/cysignals/signals.cpython-310-x86_64-linux-gnu.so(+0x7e30)[0x7f2c06dbae30]
/opt/sage/sage-git/local/lib/python3.10/site-packages/cysignals/signals.cpython-310-x86_64-linux-gnu.so(+0x7ee9)[0x7f2c06dbaee9]
/opt/sage/sage-git/local/lib/python3.10/site-packages/cysignals/signals.cpython-310-x86_64-linux-gnu.so(+0xafd5)[0x7f2c06dbdfd5]
/usr/lib/libc.so.6(+0x3d000)[0x7f2c07fcb000]
/opt/sage/sage-git/local/lib/python3.10/site-packages/sage/cpython/atexit.cpython-310-x86_64-linux-gnu.so(+0x5131)[0x7f2c073e1131]
/opt/sage/sage-git/local/lib/python3.10/site-packages/sage/cpython/atexit.cpython-310-x86_64-linux-gnu.so(+0x5932)[0x7f2c073e1932]
/usr/lib/libpython3.10.so.1.0(+0xec50e)[0x7f2c0824050e]
/usr/lib/libpython3.10.so.1.0(_PyEval_EvalFrameDefault+0x47d8)[0x7f2c081bdd68]
...
```
- more deprecation warnings

```
/opt/sage/sage-git/local/bin/cysignals-CSI:44: DeprecationWarning: The distutils package is deprecated and slated for removal in Python 3.12. Use setuptools or check PEP 632 for potential alternatives
```

All I'm doing is, starting with a clean copy of c73bc97

```
$ ./bootstrap
$ ./configure
$ make build -j12
$ ./sage -tp 8 --all
```

I have logs, let me know if you need more info.

My goal is packaging sage for void linux, but it's already migrated to python 3.10 so this is a blocker.



---

archive/issue_comments_435430.json:
```json
{
    "body": "<a id='comment:62'></a>After updating the last cysignals (unreleased 1.11.0, needed for Fedora 35) I put below the failed tests. I get some errors as in previous posts (I needed to restart several times due to many cysignal crashes); by the way `make ptestlong` produced many such crashes while `sage -t -a -p8` worked better. \n\nThe prompt_toolkit warning disappears with the 3.0.22 version.\n\n\n```\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/functions/log.py  # 3 doctests failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/functions/other.py  # 1 doctest failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/interfaces/fricas.py  # 110 doctests failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/misc/sageinspect.py  # 1 doctest failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/schemes/riemann_surfaces/riemann_surface.py  # 1 doctest failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/symbolic/integration/external.py  # 13 doctests failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/symbolic/integration/integral.py  # 3 doctests failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/tests/cmdline.py  # Timed out\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/calculus/calculus.py  # 6 doctests failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/calculus/desolvers.py  # 13 doctests failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/combinat/posets/posets.py  # 1 doctest failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/rings/real_mpfr.pyx  # 1 doctest failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/functions/gamma.py  # 4 doctests failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/matrix/matrix1.pyx  # 4 doctests failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/functions/error.py  # 1 doctest failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/plot/colors.py  # 5 doctests failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/geometry/hyperbolic_space/hyperbolic_model.py  # 1 doctest failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/symbolic/expression_conversions.py  # 16 doctests failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/functions/generalized.py  # 1 doctest failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/schemes/elliptic_curves/lseries_ell.py  # 2 doctests failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/lfunctions/pari.py  # 1 doctest failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/structure/unique_representation.py  # 1 doctest failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage_docbuild/utils.py  # 2 doctests failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/libs/giac/__init__.py  # 7 doctests failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/lfunctions/lcalc.py  # 2 doctests failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/symbolic/callable.py  # 5 doctests failed\nsage -t --random-seed=186690325287508787735378550154836726084 src/sage/cpython/atexit.pyx  # 6 doctests failed\n```",
    "created_at": "2021-11-24T22:57:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435430",
    "user": "https://github.com/enriqueartal"
}
```

<a id='comment:62'></a>After updating the last cysignals (unreleased 1.11.0, needed for Fedora 35) I put below the failed tests. I get some errors as in previous posts (I needed to restart several times due to many cysignal crashes); by the way `make ptestlong` produced many such crashes while `sage -t -a -p8` worked better. 

The prompt_toolkit warning disappears with the 3.0.22 version.


```
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/functions/log.py  # 3 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/functions/other.py  # 1 doctest failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/interfaces/fricas.py  # 110 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/misc/sageinspect.py  # 1 doctest failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/schemes/riemann_surfaces/riemann_surface.py  # 1 doctest failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/symbolic/integration/external.py  # 13 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/symbolic/integration/integral.py  # 3 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/tests/cmdline.py  # Timed out
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/calculus/calculus.py  # 6 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/calculus/desolvers.py  # 13 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/combinat/posets/posets.py  # 1 doctest failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/rings/real_mpfr.pyx  # 1 doctest failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/functions/gamma.py  # 4 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/matrix/matrix1.pyx  # 4 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/functions/error.py  # 1 doctest failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/plot/colors.py  # 5 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/geometry/hyperbolic_space/hyperbolic_model.py  # 1 doctest failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/symbolic/expression_conversions.py  # 16 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/functions/generalized.py  # 1 doctest failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/schemes/elliptic_curves/lseries_ell.py  # 2 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/lfunctions/pari.py  # 1 doctest failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/structure/unique_representation.py  # 1 doctest failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage_docbuild/utils.py  # 2 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/libs/giac/__init__.py  # 7 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/lfunctions/lcalc.py  # 2 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/symbolic/callable.py  # 5 doctests failed
sage -t --random-seed=186690325287508787735378550154836726084 src/sage/cpython/atexit.pyx  # 6 doctests failed
```



---

archive/issue_comments_435431.json:
```json
{
    "body": "<a id='comment:64'></a>Replying to [comment:58 tornaria]:\n> Running `./sage -tp 8 --all` gives:\n> - lots of crashes apparently related to cysignals; stack trace starts with\n> \n> ```\n> /opt/sage/sage-git/local/lib/python3.10/site-packages/cysignals/signals.cpython-310-x86_64-linux-gnu.so(+0x7e30)[0x7f2c06dbae30]\n> /opt/sage/sage-git/local/lib/python3.10/site-packages/cysignals/signals.cpython-310-x86_64-linux-gnu.so(+0x7ee9)[0x7f2c06dbaee9]\n> /opt/sage/sage-git/local/lib/python3.10/site-packages/cysignals/signals.cpython-310-x86_64-linux-gnu.so(+0xafd5)[0x7f2c06dbdfd5]\n> /usr/lib/libc.so.6(+0x3d000)[0x7f2c07fcb000]\n> /opt/sage/sage-git/local/lib/python3.10/site-packages/sage/cpython/atexit.cpython-310-x86_64-linux-gnu.so(+0x5131)[0x7f2c073e1131]\n> /opt/sage/sage-git/local/lib/python3.10/site-packages/sage/cpython/atexit.cpython-310-x86_64-linux-gnu.so(+0x5932)[0x7f2c073e1932]\n> /usr/lib/libpython3.10.so.1.0(+0xec50e)[0x7f2c0824050e]\n> /usr/lib/libpython3.10.so.1.0(_PyEval_EvalFrameDefault+0x47d8)[0x7f2c081bdd68]\n> ...\n> ```\n\n\nJust updated to 3.10 and am also seeing this when running doctests, but not 100% of the times. Any idea where this comes from?",
    "created_at": "2021-12-10T19:13:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435431",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:64'></a>Replying to [comment:58 tornaria]:
> Running `./sage -tp 8 --all` gives:
> - lots of crashes apparently related to cysignals; stack trace starts with
> 
> ```
> /opt/sage/sage-git/local/lib/python3.10/site-packages/cysignals/signals.cpython-310-x86_64-linux-gnu.so(+0x7e30)[0x7f2c06dbae30]
> /opt/sage/sage-git/local/lib/python3.10/site-packages/cysignals/signals.cpython-310-x86_64-linux-gnu.so(+0x7ee9)[0x7f2c06dbaee9]
> /opt/sage/sage-git/local/lib/python3.10/site-packages/cysignals/signals.cpython-310-x86_64-linux-gnu.so(+0xafd5)[0x7f2c06dbdfd5]
> /usr/lib/libc.so.6(+0x3d000)[0x7f2c07fcb000]
> /opt/sage/sage-git/local/lib/python3.10/site-packages/sage/cpython/atexit.cpython-310-x86_64-linux-gnu.so(+0x5131)[0x7f2c073e1131]
> /opt/sage/sage-git/local/lib/python3.10/site-packages/sage/cpython/atexit.cpython-310-x86_64-linux-gnu.so(+0x5932)[0x7f2c073e1932]
> /usr/lib/libpython3.10.so.1.0(+0xec50e)[0x7f2c0824050e]
> /usr/lib/libpython3.10.so.1.0(_PyEval_EvalFrameDefault+0x47d8)[0x7f2c081bdd68]
> ...
> ```


Just updated to 3.10 and am also seeing this when running doctests, but not 100% of the times. Any idea where this comes from?



---

archive/issue_comments_435432.json:
```json
{
    "body": "<a id='comment:65'></a>The crash is happening in the `__Pyx_INCREF` call here\n\n```\n    /* \"sage/cpython/atexit.pyx\":188\n *         else:\n *             kwargs = {}\n *         exithandlers.append((<object>callback.func,             # <<<<<<<<<<<<<<\n *                                 <object>callback.args,\n *                                 kwargs))\n */\n    __pyx_t_1 = PyTuple_New(3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 188, __pyx_L1_error)\n    __Pyx_GOTREF(__pyx_t_1);\n    __Pyx_INCREF(((PyObject *)__pyx_v_callback.func));\n    __Pyx_GIVEREF(((PyObject *)__pyx_v_callback.func));\n    PyTuple_SET_ITEM(__pyx_t_1, 0, ((PyObject *)__pyx_v_callback.func));\n```",
    "created_at": "2021-12-10T20:09:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435432",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:65'></a>The crash is happening in the `__Pyx_INCREF` call here

```
    /* "sage/cpython/atexit.pyx":188
 *         else:
 *             kwargs = {}
 *         exithandlers.append((<object>callback.func,             # <<<<<<<<<<<<<<
 *                                 <object>callback.args,
 *                                 kwargs))
 */
    __pyx_t_1 = PyTuple_New(3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 188, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_INCREF(((PyObject *)__pyx_v_callback.func));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_callback.func));
    PyTuple_SET_ITEM(__pyx_t_1, 0, ((PyObject *)__pyx_v_callback.func));
```



---

archive/issue_comments_435433.json:
```json
{
    "body": "<a id='comment:66'></a>Update: the segfault seems to happen when running tests iff there is another sage-runtests process running. After interrupting the doctests, the `sage-runtests` process takes a long time to get cleaned up, and if you try to run tests again in the meantime you will get the segfault.",
    "created_at": "2021-12-11T09:57:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435433",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:66'></a>Update: the segfault seems to happen when running tests iff there is another sage-runtests process running. After interrupting the doctests, the `sage-runtests` process takes a long time to get cleaned up, and if you try to run tests again in the meantime you will get the segfault.



---

archive/issue_comments_435434.json:
```json
{
    "body": "<a id='comment:67'></a>After #33013, the only remaining issues in `sagelib` are\n\n```\nsage -t --long /usr/lib/python3.10/site-packages/sage/tests/cmdline.py  # 3 doctests failed\nsage -t --long /usr/lib/python3.10/site-packages/sage/doctest/test.py  # 16 doctests failed\n```\nwhich are caused by the spawned `sage-runtests` child processes segfaulting as mentioned above, and\n\n```\nsage -t --long /usr/lib/python3.10/site-packages/sage/cpython/atexit.pyx  # 6 doctests failed\n```\nwhich are likely related.",
    "created_at": "2021-12-12T09:13:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435434",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:67'></a>After #33013, the only remaining issues in `sagelib` are

```
sage -t --long /usr/lib/python3.10/site-packages/sage/tests/cmdline.py  # 3 doctests failed
sage -t --long /usr/lib/python3.10/site-packages/sage/doctest/test.py  # 16 doctests failed
```
which are caused by the spawned `sage-runtests` child processes segfaulting as mentioned above, and

```
sage -t --long /usr/lib/python3.10/site-packages/sage/cpython/atexit.pyx  # 6 doctests failed
```
which are likely related.



---

archive/issue_comments_435435.json:
```json
{
    "body": "<a id='comment:68'></a>Indeed, running tests in parallel breaks badly but running them *not* in parallel goes very far.\n\nThis is what I got with `./sage -t --all`:\n\n```\n----------------------------------------------------------------------\nsage -t --random-seed=231622868948624456778064911551695162592 src/sage/tests/cmdline.py  # 5 doctests failed\nsage -t --random-seed=231622868948624456778064911551695162592 src/sage/quivers/algebra_elements.pxi  # 1 doctest failed\nsage -t --random-seed=231622868948624456778064911551695162592 src/sage/cpython/atexit.pyx  # 6 doctests failed\nsage -t --random-seed=231622868948624456778064911551695162592 src/sage/interfaces/sage0.py  # 1 doctest failed\nsage -t --random-seed=231622868948624456778064911551695162592 src/sage_docbuild/utils.py  # 2 doctests failed\n----------------------------------------------------------------------\n```\n\nMaybe I missed some patch, e.g a few failures are distutils deprecation warnings in `.../venv-python3.10/lib/python3.10/site-packages/matplotlib/__init__.py:88`.\n\nWhat I used is beta8 + #30766 + #33013. What did I miss?\n\n\nMaybe someone can rebase on top of beta8 so we all work on top of a common point?\n\n---\n\nAs for the failure: it seems the atexit module internals have changed in python3.10, a quick look seems to suggest that per-module state was changed to per-thread state; `sage.cpython.atexit` is probably doing something wrong which manifests when there is more than one thread.\n\nOn the positive side, now the structs and some functions are declared in (internal) headers so it might be possible to implement this in a more robust way (formerly everything was in a C file and it seems `sage.python.atexit` copied a bunch of stuff which now may be incorrect).\n\nWhat are the chances that sagemath 9.5 can support system python 3.10? I've been working to get sagemath into voidlinux but they won't accept a vendored python.",
    "created_at": "2021-12-14T13:23:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435435",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:68'></a>Indeed, running tests in parallel breaks badly but running them *not* in parallel goes very far.

This is what I got with `./sage -t --all`:

```
----------------------------------------------------------------------
sage -t --random-seed=231622868948624456778064911551695162592 src/sage/tests/cmdline.py  # 5 doctests failed
sage -t --random-seed=231622868948624456778064911551695162592 src/sage/quivers/algebra_elements.pxi  # 1 doctest failed
sage -t --random-seed=231622868948624456778064911551695162592 src/sage/cpython/atexit.pyx  # 6 doctests failed
sage -t --random-seed=231622868948624456778064911551695162592 src/sage/interfaces/sage0.py  # 1 doctest failed
sage -t --random-seed=231622868948624456778064911551695162592 src/sage_docbuild/utils.py  # 2 doctests failed
----------------------------------------------------------------------
```

Maybe I missed some patch, e.g a few failures are distutils deprecation warnings in `.../venv-python3.10/lib/python3.10/site-packages/matplotlib/__init__.py:88`.

What I used is beta8 + #30766 + #33013. What did I miss?


Maybe someone can rebase on top of beta8 so we all work on top of a common point?

---

As for the failure: it seems the atexit module internals have changed in python3.10, a quick look seems to suggest that per-module state was changed to per-thread state; `sage.cpython.atexit` is probably doing something wrong which manifests when there is more than one thread.

On the positive side, now the structs and some functions are declared in (internal) headers so it might be possible to implement this in a more robust way (formerly everything was in a C file and it seems `sage.python.atexit` copied a bunch of stuff which now may be incorrect).

What are the chances that sagemath 9.5 can support system python 3.10? I've been working to get sagemath into voidlinux but they won't accept a vendored python.



---

archive/issue_comments_435436.json:
```json
{
    "body": "<a id='comment:69'></a>I would suggest that we defer full support for Python 3.10 to Sage 9.6\nbut already accept system Python 3.10 with a warning",
    "created_at": "2021-12-17T17:12:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435436",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:69'></a>I would suggest that we defer full support for Python 3.10 to Sage 9.6
but already accept system Python 3.10 with a warning



---

archive/issue_comments_435437.json:
```json
{
    "body": "<a id='comment:70'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-12-17T17:38:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435437",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:70'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_435438.json:
```json
{
    "body": "Changing type from task to enhancement.",
    "created_at": "2021-12-17T17:39:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435438",
    "user": "https://github.com/mkoeppe"
}
```

Changing type from task to enhancement.



---

archive/issue_comments_435439.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-12-17T17:39:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435439",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_435440.json:
```json
{
    "body": "<a id='comment:73'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2021-12-17T17:42:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435440",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:73'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_435441.json:
```json
{
    "body": "<a id='comment:75'></a>Replying to [comment:68 tornaria]:\n> Maybe someone can rebase [...] so we all work on top of a common point?\n\n\nDone",
    "created_at": "2021-12-17T22:27:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435441",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:75'></a>Replying to [comment:68 tornaria]:
> Maybe someone can rebase [...] so we all work on top of a common point?


Done



---

archive/issue_comments_435442.json:
```json
{
    "body": "<a id='comment:76'></a>Replying to [comment:68 tornaria]:\n> As for the failure: it seems the atexit module internals have changed in python3.10, a quick look seems to suggest that per-module state was changed to per-thread state; `sage.cpython.atexit` is probably doing something wrong which manifests when there is more than one thread.\n\n\nThere is an unreleased change related to `atexit` mentioned in https://docs.python.org/3.10/whatsnew/changelog.html#core-and-builtins",
    "created_at": "2021-12-17T22:28:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435442",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:76'></a>Replying to [comment:68 tornaria]:
> As for the failure: it seems the atexit module internals have changed in python3.10, a quick look seems to suggest that per-module state was changed to per-thread state; `sage.cpython.atexit` is probably doing something wrong which manifests when there is more than one thread.


There is an unreleased change related to `atexit` mentioned in https://docs.python.org/3.10/whatsnew/changelog.html#core-and-builtins



---

archive/issue_comments_435443.json:
```json
{
    "body": "<a id='comment:77'></a>I've put this change as a patch on #30767. It looks like it fixes the crashes in `make ptest`",
    "created_at": "2021-12-18T00:35:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435443",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:77'></a>I've put this change as a patch on #30767. It looks like it fixes the crashes in `make ptest`



---

archive/issue_comments_435444.json:
```json
{
    "body": "<a id='comment:78'></a>However, I get these failures:\n\n```\nsage -t --random-seed=335595092046712014150830110238612394725 src/sage/cpython/atexit.pyx\n**********************************************************************\nFile \"src/sage/cpython/atexit.pyx\", line 61, in sage.cpython.atexit\nFailed example:\n    with restore_atexit(clear=True):\n        atexit._run_exitfuncs()  # Should be none registered\n        atexit.register(handler, 1, 2, c=3)\n        with restore_atexit():\n            atexit._run_exitfuncs()  # Run just registered handler\n        atexit._run_exitfuncs()  # Handler should be run again\nExpected:\n    <function handler at 0x...>\n    ((1, 2), {'c': 3})\n    ((1, 2), {'c': 3})\nGot:\n    <function handler at 0x1727cc940>\n    ((1, 2), {'c': 3})\n**********************************************************************\nFile \"src/sage/cpython/atexit.pyx\", line 77, in sage.cpython.atexit\nFailed example:\n    with restore_atexit(clear=False, run=True):\n        # original handlers are run when exiting the context\n        pass\nExpected:\n    ((4, 5), {'d': 6})\n    ((1, 2), {'c': 3})\nGot:\n    <BLANKLINE>\n**********************************************************************\nFile \"src/sage/cpython/atexit.pyx\", line 85, in sage.cpython.atexit\nFailed example:\n    atexit._run_exitfuncs()\nExpected:\n    ((4, 5), {'d': 6})\n    ((1, 2), {'c': 3})\nGot:\n    <BLANKLINE>\n**********************************************************************\nFile \"src/sage/cpython/atexit.pyx\", line 97, in sage.cpython.atexit\nFailed example:\n    print(\"Initial exit handlers:\\n{}\".format(_get_exithandlers()))\nExpected:\n    Initial exit handlers:\n    [(<function handler at 0x...>, (1, 2), {'c': 3}),\n     (<function handler at 0x...>, (4, 5), {'d': 6})]\nGot:\n    Initial exit handlers:\n    []\n**********************************************************************\nFile \"src/sage/cpython/atexit.pyx\", line 104, in sage.cpython.atexit\nFailed example:\n    print(\"After restore_atexit:\\n{}\".format(_get_exithandlers()))\nExpected:\n    After restore_atexit:\n    [(<function handler at 0x...>, (1, 2), {'c': 3}),\n     (<function handler at 0x...>, (4, 5), {'d': 6})]\nGot:\n    After restore_atexit:\n    []\n**********************************************************************\nFile \"src/sage/cpython/atexit.pyx\", line 114, in sage.cpython.atexit\nFailed example:\n    print(\"After restore_atexit with clear=True:\\n{}\".format(\n          _get_exithandlers()))\nExpected:\n    After restore_atexit with clear=True:\n    [(<function handler at 0x...>, (1, 2), {'c': 3}),\n     (<function handler at 0x...>, (4, 5), {'d': 6})]\nGot:\n    After restore_atexit with clear=True:\n    []\n**********************************************************************\n1 item had failures:\n   6 of  20 in sage.cpython.atexit\n    [19 tests, 6 failures, 0.03 s]\n```",
    "created_at": "2021-12-18T01:12:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435444",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:78'></a>However, I get these failures:

```
sage -t --random-seed=335595092046712014150830110238612394725 src/sage/cpython/atexit.pyx
**********************************************************************
File "src/sage/cpython/atexit.pyx", line 61, in sage.cpython.atexit
Failed example:
    with restore_atexit(clear=True):
        atexit._run_exitfuncs()  # Should be none registered
        atexit.register(handler, 1, 2, c=3)
        with restore_atexit():
            atexit._run_exitfuncs()  # Run just registered handler
        atexit._run_exitfuncs()  # Handler should be run again
Expected:
    <function handler at 0x...>
    ((1, 2), {'c': 3})
    ((1, 2), {'c': 3})
Got:
    <function handler at 0x1727cc940>
    ((1, 2), {'c': 3})
**********************************************************************
File "src/sage/cpython/atexit.pyx", line 77, in sage.cpython.atexit
Failed example:
    with restore_atexit(clear=False, run=True):
        # original handlers are run when exiting the context
        pass
Expected:
    ((4, 5), {'d': 6})
    ((1, 2), {'c': 3})
Got:
    <BLANKLINE>
**********************************************************************
File "src/sage/cpython/atexit.pyx", line 85, in sage.cpython.atexit
Failed example:
    atexit._run_exitfuncs()
Expected:
    ((4, 5), {'d': 6})
    ((1, 2), {'c': 3})
Got:
    <BLANKLINE>
**********************************************************************
File "src/sage/cpython/atexit.pyx", line 97, in sage.cpython.atexit
Failed example:
    print("Initial exit handlers:\n{}".format(_get_exithandlers()))
Expected:
    Initial exit handlers:
    [(<function handler at 0x...>, (1, 2), {'c': 3}),
     (<function handler at 0x...>, (4, 5), {'d': 6})]
Got:
    Initial exit handlers:
    []
**********************************************************************
File "src/sage/cpython/atexit.pyx", line 104, in sage.cpython.atexit
Failed example:
    print("After restore_atexit:\n{}".format(_get_exithandlers()))
Expected:
    After restore_atexit:
    [(<function handler at 0x...>, (1, 2), {'c': 3}),
     (<function handler at 0x...>, (4, 5), {'d': 6})]
Got:
    After restore_atexit:
    []
**********************************************************************
File "src/sage/cpython/atexit.pyx", line 114, in sage.cpython.atexit
Failed example:
    print("After restore_atexit with clear=True:\n{}".format(
          _get_exithandlers()))
Expected:
    After restore_atexit with clear=True:
    [(<function handler at 0x...>, (1, 2), {'c': 3}),
     (<function handler at 0x...>, (4, 5), {'d': 6})]
Got:
    After restore_atexit with clear=True:
    []
**********************************************************************
1 item had failures:
   6 of  20 in sage.cpython.atexit
    [19 tests, 6 failures, 0.03 s]
```



---

archive/issue_comments_435445.json:
```json
{
    "body": "<a id='comment:80'></a>The python patch also fixes the crashes for me. Besides those six failures in `sage.cpython.atexit`, I'm also getting\n\n```\n**********************************************************************\nFile \"/usr/lib/python3.10/site-packages/sage/doctest/test.py\", line 509, in sage.doctest.test\nFailed example:\n    os.path.isfile(F)  # long time\nExpected:\n    False\nGot:\n    True\n**********************************************************************\n```\n\nLooks like `atexit` integration is totally broken, but it shouldn't affect normal Sage usage.",
    "created_at": "2021-12-18T18:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435445",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:80'></a>The python patch also fixes the crashes for me. Besides those six failures in `sage.cpython.atexit`, I'm also getting

```
**********************************************************************
File "/usr/lib/python3.10/site-packages/sage/doctest/test.py", line 509, in sage.doctest.test
Failed example:
    os.path.isfile(F)  # long time
Expected:
    False
Got:
    True
**********************************************************************
```

Looks like `atexit` integration is totally broken, but it shouldn't affect normal Sage usage.



---

archive/issue_comments_435446.json:
```json
{
    "body": "<a id='comment:81'></a>I think we should just disable all of `sage.cpython.atexit` on Python 3.10 for Sage 9.5",
    "created_at": "2021-12-18T18:42:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435446",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:81'></a>I think we should just disable all of `sage.cpython.atexit` on Python 3.10 for Sage 9.5



---

archive/issue_comments_435447.json:
```json
{
    "body": "<a id='comment:82'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-18T21:35:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435447",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:82'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435448.json:
```json
{
    "body": "<a id='comment:83'></a>This fixes the segfaults for me with (unpatched) Python 3.10 from homebrew.\n\nIt looks like doctest timeouts are not correctly reported with this change on Python 3.10\n\n```\nsage -t --random-seed=15134756989416810321066706961638592844 src/sage/manifolds/differentiable/integrated_curve.py\n    Error in doctesting framework (no result returned)\n```\n\nBut I think this is good enough for Sage 9.5.",
    "created_at": "2021-12-18T21:40:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435448",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:83'></a>This fixes the segfaults for me with (unpatched) Python 3.10 from homebrew.

It looks like doctest timeouts are not correctly reported with this change on Python 3.10

```
sage -t --random-seed=15134756989416810321066706961638592844 src/sage/manifolds/differentiable/integrated_curve.py
    Error in doctesting framework (no result returned)
```

But I think this is good enough for Sage 9.5.



---

archive/issue_comments_435449.json:
```json
{
    "body": "<a id='comment:84'></a>[atexit.pyx commit](https://git.sagemath.org/sage.git/commit/?id=b5c73996062c71a9326aafddaf465f6a56b40fe0) fixes the segfaults for [tox-docker-gentoo-python3.10-standard](https://github.com/sheerluck/sage/actions/runs/1597115166)",
    "created_at": "2021-12-19T06:11:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435449",
    "user": "https://github.com/sheerluck"
}
```

<a id='comment:84'></a>[atexit.pyx commit](https://git.sagemath.org/sage.git/commit/?id=b5c73996062c71a9326aafddaf465f6a56b40fe0) fixes the segfaults for [tox-docker-gentoo-python3.10-standard](https://github.com/sheerluck/sage/actions/runs/1597115166)



---

archive/issue_comments_435450.json:
```json
{
    "body": "<a id='comment:85'></a>Thanks for testing!",
    "created_at": "2021-12-19T06:17:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435450",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:85'></a>Thanks for testing!



---

archive/issue_comments_435451.json:
```json
{
    "body": "<a id='comment:86'></a>The `atexit` patch is causing many test failures in `sage.tests.cmdline` and `sage.doctest.test` for me, with either patched or unpatched python. If you're using patched python (or the upcoming 3.10.2), it makes things notably worse. \n\nWhat about just disallowing system 3.10.0 and 3.10.1?",
    "created_at": "2021-12-19T09:07:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435451",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:86'></a>The `atexit` patch is causing many test failures in `sage.tests.cmdline` and `sage.doctest.test` for me, with either patched or unpatched python. If you're using patched python (or the upcoming 3.10.2), it makes things notably worse. 

What about just disallowing system 3.10.0 and 3.10.1?



---

archive/issue_comments_435452.json:
```json
{
    "body": "<a id='comment:87'></a>Actually it is not just those two modules: doctesting is completely broken with the patch. These are the first few lines of `sage -t -l /usr/lib/python3.10/site-packages/sage`\n\n```\ntoo many failed tests, not using stored timings\nRunning doctests with ID 2021-12-19-10-34-37-4bb8d646.\nUsing --optional=cvxopt,dochtml,pip,rpy2,sage,sage.geometry.polyhedron,sage.rings.real_double\nDoctesting 3480 files.\nsage -t --long --random-seed=323685807291696861763886820074125782219 /usr/lib/python3.10/site-packages/sage/all.py\n    Error in doctesting framework (no result returned)\n**********************************************************************\nTests run before error:\nsage: import gc ## line 13 ##\nsage: import inspect ## line 14 ##\nsage: from sage import * ## line 15 ##\nsage: frames = [x for x in gc.get_objects() if inspect.isframe(x)] ## line 16 ##\nsage: allowed = [\n    'IPython', 'prompt_toolkit', 'jedi',     # sage dependencies\n    'threading', 'multiprocessing',  # doctest dependencies\n    '__main__', 'sage.doctest',      # doctesting\n    'signal', 'enum', 'types'        # may appear in Python 3\n] ## line 21 ##\nsage: def is_not_allowed(frame):\n    module = inspect.getmodule(frame)\n    if module is None: return False\n    return not any(module.__name__.startswith(name) for name in allowed) ## line 27 ##\nsage: [inspect.getmodule(f).__name__ for f in frames if is_not_allowed(f)] ## line 31 ##\n[]\nsage: type(interacts) ## line 36 ##\n<class 'sage.misc.lazy_import.LazyImport'>\nsage: interacts ## line 38 ##\n<module 'sage.interacts.all' from '/usr/lib/python3.10/site-packages/sage/interacts/all.py'>\nsage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 40 ##\n0\nsage: 'log' in sage_globals() ## line 315 ##\nTrue\nsage: 'MatrixSpace' in sage_globals() ## line 317 ##\nTrue\nsage: 'Permutations' in sage_globals() ## line 319 ##\nTrue\nsage: 'TheWholeUniverse' in sage_globals() ## line 321 ##\nFalse\nsage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 323 ##\n0\n\n**********************************************************************\nsage -t --long --random-seed=323685807291696861763886820074125782219 /usr/lib/python3.10/site-packages/sage/all_cmdline.py\n    Error in doctesting framework (no result returned)\n**********************************************************************\nTests run before error:\n\n**********************************************************************\nsage -t --long --random-seed=323685807291696861763886820074125782219 /usr/lib/python3.10/site-packages/sage/version.py\n    Error in doctesting framework (no result returned)\n**********************************************************************\nTests run before error:\n\n**********************************************************************\nsage -t --long --random-seed=323685807291696861763886820074125782219 /usr/lib/python3.10/site-packages/sage/env.py\n    Error in doctesting framework (no result returned)\n**********************************************************************\nTests run before error:\n```",
    "created_at": "2021-12-19T09:37:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435452",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:87'></a>Actually it is not just those two modules: doctesting is completely broken with the patch. These are the first few lines of `sage -t -l /usr/lib/python3.10/site-packages/sage`

```
too many failed tests, not using stored timings
Running doctests with ID 2021-12-19-10-34-37-4bb8d646.
Using --optional=cvxopt,dochtml,pip,rpy2,sage,sage.geometry.polyhedron,sage.rings.real_double
Doctesting 3480 files.
sage -t --long --random-seed=323685807291696861763886820074125782219 /usr/lib/python3.10/site-packages/sage/all.py
    Error in doctesting framework (no result returned)
**********************************************************************
Tests run before error:
sage: import gc ## line 13 ##
sage: import inspect ## line 14 ##
sage: from sage import * ## line 15 ##
sage: frames = [x for x in gc.get_objects() if inspect.isframe(x)] ## line 16 ##
sage: allowed = [
    'IPython', 'prompt_toolkit', 'jedi',     # sage dependencies
    'threading', 'multiprocessing',  # doctest dependencies
    '__main__', 'sage.doctest',      # doctesting
    'signal', 'enum', 'types'        # may appear in Python 3
] ## line 21 ##
sage: def is_not_allowed(frame):
    module = inspect.getmodule(frame)
    if module is None: return False
    return not any(module.__name__.startswith(name) for name in allowed) ## line 27 ##
sage: [inspect.getmodule(f).__name__ for f in frames if is_not_allowed(f)] ## line 31 ##
[]
sage: type(interacts) ## line 36 ##
<class 'sage.misc.lazy_import.LazyImport'>
sage: interacts ## line 38 ##
<module 'sage.interacts.all' from '/usr/lib/python3.10/site-packages/sage/interacts/all.py'>
sage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 40 ##
0
sage: 'log' in sage_globals() ## line 315 ##
True
sage: 'MatrixSpace' in sage_globals() ## line 317 ##
True
sage: 'Permutations' in sage_globals() ## line 319 ##
True
sage: 'TheWholeUniverse' in sage_globals() ## line 321 ##
False
sage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 323 ##
0

**********************************************************************
sage -t --long --random-seed=323685807291696861763886820074125782219 /usr/lib/python3.10/site-packages/sage/all_cmdline.py
    Error in doctesting framework (no result returned)
**********************************************************************
Tests run before error:

**********************************************************************
sage -t --long --random-seed=323685807291696861763886820074125782219 /usr/lib/python3.10/site-packages/sage/version.py
    Error in doctesting framework (no result returned)
**********************************************************************
Tests run before error:

**********************************************************************
sage -t --long --random-seed=323685807291696861763886820074125782219 /usr/lib/python3.10/site-packages/sage/env.py
    Error in doctesting framework (no result returned)
**********************************************************************
Tests run before error:
```



---

archive/issue_comments_435453.json:
```json
{
    "body": "<a id='comment:88'></a>Same here: the atexit patch causes a lot of doctest failures, either when running tests in parallel or serially.\n\nJust removing that last commit makes things way better, I can now run tests in parallel with only\n\n```\n----------------------------------------------------------------------\nsage -t --random-seed=184890811937734492121783958395067560107 src/sage/cpython/atexit.pyx  # 6 doctests failed\nsage -t --random-seed=184890811937734492121783958395067560107 src/sage_docbuild/utils.py  # 2 doctests failed\nsage -t --random-seed=184890811937734492121783958395067560107 src/sage/tests/cmdline.py  # 7 doctests failed\n----------------------------------------------------------------------\n```\n(I used had trouble all over the place when running tests in parallel, the difference may be due to merging #32930 which I wasn't applying before).\n\nTo be precise I'm using beta8 + #30766 (02aa94c) + #33020 (715277c) + #33040 (d865a54).",
    "created_at": "2021-12-19T17:15:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435453",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:88'></a>Same here: the atexit patch causes a lot of doctest failures, either when running tests in parallel or serially.

Just removing that last commit makes things way better, I can now run tests in parallel with only

```
----------------------------------------------------------------------
sage -t --random-seed=184890811937734492121783958395067560107 src/sage/cpython/atexit.pyx  # 6 doctests failed
sage -t --random-seed=184890811937734492121783958395067560107 src/sage_docbuild/utils.py  # 2 doctests failed
sage -t --random-seed=184890811937734492121783958395067560107 src/sage/tests/cmdline.py  # 7 doctests failed
----------------------------------------------------------------------
```
(I used had trouble all over the place when running tests in parallel, the difference may be due to merging #32930 which I wasn't applying before).

To be precise I'm using beta8 + #30766 (02aa94c) + #33020 (715277c) + #33040 (d865a54).



---

archive/issue_comments_435454.json:
```json
{
    "body": "<a id='comment:89'></a>Same thing with Fedora 35",
    "created_at": "2021-12-19T17:50:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435454",
    "user": "https://github.com/enriqueartal"
}
```

<a id='comment:89'></a>Same thing with Fedora 35



---

archive/issue_comments_435455.json:
```json
{
    "body": "<a id='comment:90'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-12-19T19:23:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435455",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:90'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_435456.json:
```json
{
    "body": "<a id='comment:91'></a>Here's a better version, please test",
    "created_at": "2021-12-19T19:23:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435456",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:91'></a>Here's a better version, please test



---

archive/issue_comments_435457.json:
```json
{
    "body": "<a id='comment:92'></a>Replying to [comment:91 mkoeppe]:\n> Here's a better version, please test\n\n\nRunning a second `sage-runtests` instance while there is another one running still segfaults. In particular, all tests that spawn a `sage-runtests` subprocess in `sage.doctest.test` segfault. This is with unpatched Python 3.10.1",
    "created_at": "2021-12-19T21:04:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435457",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:92'></a>Replying to [comment:91 mkoeppe]:
> Here's a better version, please test


Running a second `sage-runtests` instance while there is another one running still segfaults. In particular, all tests that spawn a `sage-runtests` subprocess in `sage.doctest.test` segfault. This is with unpatched Python 3.10.1



---

archive/issue_comments_435458.json:
```json
{
    "body": "<a id='comment:93'></a>Also, I noticed that `sage -t -a` still segfaults with a patched Python (regardless of whether the `atexit` patch is applied or not)",
    "created_at": "2021-12-19T21:09:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435458",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:93'></a>Also, I noticed that `sage -t -a` still segfaults with a patched Python (regardless of whether the `atexit` patch is applied or not)



---

archive/issue_comments_435459.json:
```json
{
    "body": "<a id='comment:94'></a>For me only one failed test (system giac 1.7.0.13):\n\n```\nRunning doctests with ID 2021-12-19-22-38-22-94239956.\nGit branch: t/30766/support_python_3_10\nUsing --optional=build,dochtml,fedora,pip,sage,sage.geometry.polyhedron,sage.rings.real_double,sage_spkg\nDoctesting 1 file.\nsage -t --warn-long 41.6 --random-seed=81937132960239439330694293571411830858 src/sage/libs/giac/__init__.py\n**********************************************************************\nFile \"src/sage/libs/giac/__init__.py\", line 18, in sage.libs.giac\nFailed example:\n    B = gb_giac(I.gens()) # random\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.libs.giac[3]>\", line 1, in <module>\n        B = gb_giac(I.gens()) # random\n      File \"/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/libs/giac/__init__.py\", line 118, in wrapper\n        return func(*args, **kwds)\n      File \"/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/libs/giac/__init__.py\", line 353, in groebner_basis\n        gb_giac = F.gbasis(list(var_names), giac_order)\n      File \"sage/libs/giac/auto-methods.pxi\", line 6442, in sage.libs.giac.giac.GiacMethods_base.gbasis (build/cythonized/sage/libs/giac/giac.cpp:56012)\n        return GiacMethods['gbasis'](self,*args)\n      File \"sage/libs/giac/giac.pyx\", line 2102, in sage.libs.giac.giac.GiacFunction.__call__ (build/cythonized/sage/libs/giac/giac.cpp:153070)\n        sig_on()\n    RuntimeError: Aborted\n**********************************************************************\nFile \"src/sage/libs/giac/__init__.py\", line 19, in sage.libs.giac\nFailed example:\n    B\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.libs.giac[4]>\", line 1, in <module>\n        B\n    NameError: name 'B' is not defined\n**********************************************************************\nFile \"src/sage/libs/giac/__init__.py\", line 175, in sage.libs.giac.?\nFailed example:\n    B=gb_giac(I.gens());B\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.libs.giac.?[3]>\", line 1, in <module>\n        B=gb_giac(I.gens());B\n      File \"/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/libs/giac/__init__.py\", line 118, in wrapper\n        return func(*args, **kwds)\n      File \"/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/libs/giac/__init__.py\", line 353, in groebner_basis\n        gb_giac = F.gbasis(list(var_names), giac_order)\n      File \"sage/libs/giac/auto-methods.pxi\", line 6442, in sage.libs.giac.giac.GiacMethods_base.gbasis (build/cythonized/sage/libs/giac/giac.cpp:56012)\n        return GiacMethods['gbasis'](self,*args)\n      File \"sage/libs/giac/giac.pyx\", line 2102, in sage.libs.giac.giac.GiacFunction.__call__ (build/cythonized/sage/libs/giac/giac.cpp:153070)\n        sig_on()\n    RuntimeError: Aborted\n**********************************************************************\nFile \"src/sage/libs/giac/__init__.py\", line 179, in sage.libs.giac.?\nFailed example:\n    B.is_groebner()\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.libs.giac.?[4]>\", line 1, in <module>\n        B.is_groebner()\n    NameError: name 'B' is not defined\n**********************************************************************\nFile \"src/sage/libs/giac/__init__.py\", line 186, in sage.libs.giac.?\nFailed example:\n    B = gb_giac(I.gens(), elim_variables=[P.gen(0), P.gen(2)])\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.libs.giac.?[7]>\", line 1, in <module>\n        B = gb_giac(I.gens(), elim_variables=[P.gen(Integer(0)), P.gen(Integer(2))])\n      File \"/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/libs/giac/__init__.py\", line 118, in wrapper\n        return func(*args, **kwds)\n      File \"/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/libs/giac/__init__.py\", line 356, in groebner_basis\n        gb_giac = F.eliminate(list(elim_variables), 'gbasis')\n      File \"sage/libs/giac/auto-methods.pxi\", line 4884, in sage.libs.giac.giac.GiacMethods_base.eliminate (build/cythonized/sage/libs/giac/giac.cpp:45540)\n        return GiacMethods['eliminate'](self,*args)\n      File \"sage/libs/giac/giac.pyx\", line 2102, in sage.libs.giac.giac.GiacFunction.__call__ (build/cythonized/sage/libs/giac/giac.cpp:153070)\n        sig_on()\n    RuntimeError: Aborted\n**********************************************************************\nFile \"src/sage/libs/giac/__init__.py\", line 189, in sage.libs.giac.?\nFailed example:\n    B.is_groebner()\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.libs.giac.?[8]>\", line 1, in <module>\n        B.is_groebner()\n    NameError: name 'B' is not defined\n**********************************************************************\nFile \"src/sage/libs/giac/__init__.py\", line 191, in sage.libs.giac.?\nFailed example:\n    B.ideal() == I.elimination_ideal([P.gen(0), P.gen(2)])\nException raised:\n    Traceback (most recent call last):\n      File \"/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.libs.giac.?[9]>\", line 1, in <module>\n        B.ideal() == I.elimination_ideal([P.gen(Integer(0)), P.gen(Integer(2))])\n    NameError: name 'B' is not defined\n**********************************************************************\n2 items had failures:\n   2 of   6 in sage.libs.giac\n   5 of  33 in sage.libs.giac.?\n    [56 tests, 7 failures, 0.41 s]\n----------------------------------------------------------------------\nsage -t --warn-long 41.6 --random-seed=81937132960239439330694293571411830858 src/sage/libs/giac/__init__.py  # 7 doctests failed\n----------------------------------------------------------------------\nTotal time for all tests: 0.4 seconds\n    cpu time: 0.3 seconds\n    cumulative wall time: 0.4 seconds\nPytest is not installed, skip checking tests that rely on it.\n```",
    "created_at": "2021-12-19T21:42:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435459",
    "user": "https://github.com/enriqueartal"
}
```

<a id='comment:94'></a>For me only one failed test (system giac 1.7.0.13):

```
Running doctests with ID 2021-12-19-22-38-22-94239956.
Git branch: t/30766/support_python_3_10
Using --optional=build,dochtml,fedora,pip,sage,sage.geometry.polyhedron,sage.rings.real_double,sage_spkg
Doctesting 1 file.
sage -t --warn-long 41.6 --random-seed=81937132960239439330694293571411830858 src/sage/libs/giac/__init__.py
**********************************************************************
File "src/sage/libs/giac/__init__.py", line 18, in sage.libs.giac
Failed example:
    B = gb_giac(I.gens()) # random
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.giac[3]>", line 1, in <module>
        B = gb_giac(I.gens()) # random
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/libs/giac/__init__.py", line 118, in wrapper
        return func(*args, **kwds)
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/libs/giac/__init__.py", line 353, in groebner_basis
        gb_giac = F.gbasis(list(var_names), giac_order)
      File "sage/libs/giac/auto-methods.pxi", line 6442, in sage.libs.giac.giac.GiacMethods_base.gbasis (build/cythonized/sage/libs/giac/giac.cpp:56012)
        return GiacMethods['gbasis'](self,*args)
      File "sage/libs/giac/giac.pyx", line 2102, in sage.libs.giac.giac.GiacFunction.__call__ (build/cythonized/sage/libs/giac/giac.cpp:153070)
        sig_on()
    RuntimeError: Aborted
**********************************************************************
File "src/sage/libs/giac/__init__.py", line 19, in sage.libs.giac
Failed example:
    B
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.giac[4]>", line 1, in <module>
        B
    NameError: name 'B' is not defined
**********************************************************************
File "src/sage/libs/giac/__init__.py", line 175, in sage.libs.giac.?
Failed example:
    B=gb_giac(I.gens());B
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.giac.?[3]>", line 1, in <module>
        B=gb_giac(I.gens());B
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/libs/giac/__init__.py", line 118, in wrapper
        return func(*args, **kwds)
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/libs/giac/__init__.py", line 353, in groebner_basis
        gb_giac = F.gbasis(list(var_names), giac_order)
      File "sage/libs/giac/auto-methods.pxi", line 6442, in sage.libs.giac.giac.GiacMethods_base.gbasis (build/cythonized/sage/libs/giac/giac.cpp:56012)
        return GiacMethods['gbasis'](self,*args)
      File "sage/libs/giac/giac.pyx", line 2102, in sage.libs.giac.giac.GiacFunction.__call__ (build/cythonized/sage/libs/giac/giac.cpp:153070)
        sig_on()
    RuntimeError: Aborted
**********************************************************************
File "src/sage/libs/giac/__init__.py", line 179, in sage.libs.giac.?
Failed example:
    B.is_groebner()
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.giac.?[4]>", line 1, in <module>
        B.is_groebner()
    NameError: name 'B' is not defined
**********************************************************************
File "src/sage/libs/giac/__init__.py", line 186, in sage.libs.giac.?
Failed example:
    B = gb_giac(I.gens(), elim_variables=[P.gen(0), P.gen(2)])
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.giac.?[7]>", line 1, in <module>
        B = gb_giac(I.gens(), elim_variables=[P.gen(Integer(0)), P.gen(Integer(2))])
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/libs/giac/__init__.py", line 118, in wrapper
        return func(*args, **kwds)
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/libs/giac/__init__.py", line 356, in groebner_basis
        gb_giac = F.eliminate(list(elim_variables), 'gbasis')
      File "sage/libs/giac/auto-methods.pxi", line 4884, in sage.libs.giac.giac.GiacMethods_base.eliminate (build/cythonized/sage/libs/giac/giac.cpp:45540)
        return GiacMethods['eliminate'](self,*args)
      File "sage/libs/giac/giac.pyx", line 2102, in sage.libs.giac.giac.GiacFunction.__call__ (build/cythonized/sage/libs/giac/giac.cpp:153070)
        sig_on()
    RuntimeError: Aborted
**********************************************************************
File "src/sage/libs/giac/__init__.py", line 189, in sage.libs.giac.?
Failed example:
    B.is_groebner()
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.giac.?[8]>", line 1, in <module>
        B.is_groebner()
    NameError: name 'B' is not defined
**********************************************************************
File "src/sage/libs/giac/__init__.py", line 191, in sage.libs.giac.?
Failed example:
    B.ideal() == I.elimination_ideal([P.gen(0), P.gen(2)])
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/sagedev/local/var/lib/sage/venv-python3.9.7/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.libs.giac.?[9]>", line 1, in <module>
        B.ideal() == I.elimination_ideal([P.gen(Integer(0)), P.gen(Integer(2))])
    NameError: name 'B' is not defined
**********************************************************************
2 items had failures:
   2 of   6 in sage.libs.giac
   5 of  33 in sage.libs.giac.?
    [56 tests, 7 failures, 0.41 s]
----------------------------------------------------------------------
sage -t --warn-long 41.6 --random-seed=81937132960239439330694293571411830858 src/sage/libs/giac/__init__.py  # 7 doctests failed
----------------------------------------------------------------------
Total time for all tests: 0.4 seconds
    cpu time: 0.3 seconds
    cumulative wall time: 0.4 seconds
Pytest is not installed, skip checking tests that rely on it.
```



---

archive/issue_comments_435460.json:
```json
{
    "body": "<a id='comment:95'></a>I change the workarounds by an attempt at a \"proper\" fix.\n\nWith this all the doctests in `src/sage/cpython/atexit.pyx` pass, both with bundled python 3.9.7 and with my system python 3.10.\n\nI'm still to run the whole testsuite; I am still getting failures in `src/sage_docbuild/utils.py` but I think they are due to the deprecation warnings caused by matplotlib and should go away when I apply #33040 which I forgot to do.\n\nShould #33040 be merged into this ticket as a dependency? Am I the only one having problems caused by old matplotlib?\n\n---\nNew commits:",
    "created_at": "2021-12-19T22:10:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435460",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:95'></a>I change the workarounds by an attempt at a "proper" fix.

With this all the doctests in `src/sage/cpython/atexit.pyx` pass, both with bundled python 3.9.7 and with my system python 3.10.

I'm still to run the whole testsuite; I am still getting failures in `src/sage_docbuild/utils.py` but I think they are due to the deprecation warnings caused by matplotlib and should go away when I apply #33040 which I forgot to do.

Should #33040 be merged into this ticket as a dependency? Am I the only one having problems caused by old matplotlib?

---
New commits:



---

archive/issue_comments_435461.json:
```json
{
    "body": "<a id='comment:96'></a>Notes on the implementation:\n\nEverything is in the `cdef extern from *` block where I moved the definition of `struct atexit_callback` and a new function `_atexit_callbacks()`.\n\nThe C implementation for python 3.9 is short and should be equivalent to what was before. The implementation for 3.10 is even shorter since structs are now defined in (internal) python headers.\n\nThe argument to `_atexit_callbacks()` should be the atexit module as in the body of `_get_exithandlers()`. This is not necessary for python 3.10 but it seemed simpler to have the same declaration for both cases so there are no conditionals outside the `cdef extern from *` block.",
    "created_at": "2021-12-19T22:22:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435461",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:96'></a>Notes on the implementation:

Everything is in the `cdef extern from *` block where I moved the definition of `struct atexit_callback` and a new function `_atexit_callbacks()`.

The C implementation for python 3.9 is short and should be equivalent to what was before. The implementation for 3.10 is even shorter since structs are now defined in (internal) python headers.

The argument to `_atexit_callbacks()` should be the atexit module as in the body of `_get_exithandlers()`. This is not necessary for python 3.10 but it seemed simpler to have the same declaration for both cases so there are no conditionals outside the `cdef extern from *` block.



---

archive/issue_comments_435462.json:
```json
{
    "body": "<a id='comment:98'></a>Looks good to me but it needs to be tested also on Python < 3.10",
    "created_at": "2021-12-19T22:26:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435462",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:98'></a>Looks good to me but it needs to be tested also on Python < 3.10



---

archive/issue_comments_435463.json:
```json
{
    "body": "<a id='comment:100'></a>Replying to [comment:98 mkoeppe]:\n> Looks good to me but it needs to be tested also on Python < 3.10\n\n\nAbsolutely! I did one test by passing `--without-system-python3` to configure but more testing would be desirable.\n\nAlthough I think the changes should really be nil for python < 3.10; would it be useful for review if I split the patch in two parts where the first part just refactors the existing code and the second part adds the new code for python 3.10? With some luck the first part visibly does nothing, and the second part will only add code conditional to python >= 3.10.",
    "created_at": "2021-12-19T23:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435463",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:100'></a>Replying to [comment:98 mkoeppe]:
> Looks good to me but it needs to be tested also on Python < 3.10


Absolutely! I did one test by passing `--without-system-python3` to configure but more testing would be desirable.

Although I think the changes should really be nil for python < 3.10; would it be useful for review if I split the patch in two parts where the first part just refactors the existing code and the second part adds the new code for python 3.10? With some luck the first part visibly does nothing, and the second part will only add code conditional to python >= 3.10.



---

archive/issue_comments_435464.json:
```json
{
    "body": "<a id='comment:101'></a>Replying to [comment:100 tornaria]:\n> would it be useful for review if I split the patch in two parts where the first part just refactors the existing code and the second part adds the new code for python 3.10?\n\n\nNo, it's fine as is",
    "created_at": "2021-12-19T23:03:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435464",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:101'></a>Replying to [comment:100 tornaria]:
> would it be useful for review if I split the patch in two parts where the first part just refactors the existing code and the second part adds the new code for python 3.10?


No, it's fine as is



---

archive/issue_comments_435465.json:
```json
{
    "body": "<a id='comment:2'></a>My full clean build with python 3.10 finished with the following doctest failure:\n\n```\nsage -t --random-seed=262548395979960264449538514011341238171 src/sage_docbuild/utils.py\n**********************************************************************\nFile \"src/sage_docbuild/utils.py\", line 91, in sage_docbuild.utils\nFailed example:\n    build_many(target, range(8), processes=8)\nExpected:\n    Traceback (most recent call last):\n    ...\n    ZeroDivisionError: rational division by zero\nGot:\n    <BLANKLINE>\n    Traceback (most recent call last):\n      File \"/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage_docbuild.utils[6]>\", line 1, in <module>\n        build_many(target, range(Integer(8)), processes=Integer(8))\n      File \"/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage_docbuild/utils.py\", line 289, in build_many\n        raise worker_exc.original_exception\n    TypeError: 'sage.rings.real_mpfr.RealLiteral' object cannot be interpreted as an integer\n**********************************************************************\nFile \"src/sage_docbuild/utils.py\", line 110, in sage_docbuild.utils\nFailed example:\n    build_many(target, range(8), processes=8)\nExpected:\n    Traceback (most recent call last):\n    ...\n    WorkerDiedException: worker for 4 died with non-zero exit code -9\nGot:\n    <BLANKLINE>\n    Traceback (most recent call last):\n      File \"/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage_docbuild.utils[8]>\", line 1, in <module>\n        build_many(target, range(Integer(8)), processes=Integer(8))\n      File \"/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage_docbuild/utils.py\", line 289, in build_many\n        raise worker_exc.original_exception\n    TypeError: 'sage.rings.real_mpfr.RealLiteral' object cannot be interpreted as an integer\n**********************************************************************\n1 item had failures:\n   2 of  10 in sage_docbuild.utils\n    [9 tests, 2 failures, 1.43 s]\n```",
    "created_at": "2021-12-19T23:04:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435465",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:2'></a>My full clean build with python 3.10 finished with the following doctest failure:

```
sage -t --random-seed=262548395979960264449538514011341238171 src/sage_docbuild/utils.py
**********************************************************************
File "src/sage_docbuild/utils.py", line 91, in sage_docbuild.utils
Failed example:
    build_many(target, range(8), processes=8)
Expected:
    Traceback (most recent call last):
    ...
    ZeroDivisionError: rational division by zero
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_docbuild.utils[6]>", line 1, in <module>
        build_many(target, range(Integer(8)), processes=Integer(8))
      File "/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage_docbuild/utils.py", line 289, in build_many
        raise worker_exc.original_exception
    TypeError: 'sage.rings.real_mpfr.RealLiteral' object cannot be interpreted as an integer
**********************************************************************
File "src/sage_docbuild/utils.py", line 110, in sage_docbuild.utils
Failed example:
    build_many(target, range(8), processes=8)
Expected:
    Traceback (most recent call last):
    ...
    WorkerDiedException: worker for 4 died with non-zero exit code -9
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_docbuild.utils[8]>", line 1, in <module>
        build_many(target, range(Integer(8)), processes=Integer(8))
      File "/usr/lib/sage-9.5.beta8/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage_docbuild/utils.py", line 289, in build_many
        raise worker_exc.original_exception
    TypeError: 'sage.rings.real_mpfr.RealLiteral' object cannot be interpreted as an integer
**********************************************************************
1 item had failures:
   2 of  10 in sage_docbuild.utils
    [9 tests, 2 failures, 1.43 s]
```



---

archive/issue_comments_435466.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-20T01:38:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435466",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435467.json:
```json
{
    "body": "<a id='comment:4'></a>This seems to be the root cause:\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.5.beta8, Release Date: 2021-12-12               \u2502\n\u2502 Using Python 3.10.1. Type \"help()\" for help.                       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: import time\nsage: time.sleep(0.5)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-2-b448069dbb3c> in <module>\n----> 1 time.sleep(RealNumber('0.5'))\n\nTypeError: 'sage.rings.real_mpfr.RealLiteral' object cannot be interpreted as an integer\n```\n\nNow the same thing `--without-system-python`:\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.5.beta8, Release Date: 2021-12-12               \u2502\n\u2502 Using Python 3.9.7. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: import time\nsage: time.sleep(0.5)\n<ipython-input-2-b448069dbb3c>:1: DeprecationWarning: an integer is required (got type sage.rings.real_mpfr.RealLiteral).  Implicit conversion to integers using __int__ is deprecated, and may be removed in a future version of Python.\n  time.sleep(RealNumber('0.5'))\n```",
    "created_at": "2021-12-20T01:38:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435467",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:4'></a>This seems to be the root cause:

```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.5.beta8, Release Date: 2021-12-12               │
│ Using Python 3.10.1. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: import time
sage: time.sleep(0.5)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-2-b448069dbb3c> in <module>
----> 1 time.sleep(RealNumber('0.5'))

TypeError: 'sage.rings.real_mpfr.RealLiteral' object cannot be interpreted as an integer
```

Now the same thing `--without-system-python`:

```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.5.beta8, Release Date: 2021-12-12               │
│ Using Python 3.9.7. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: import time
sage: time.sleep(0.5)
<ipython-input-2-b448069dbb3c>:1: DeprecationWarning: an integer is required (got type sage.rings.real_mpfr.RealLiteral).  Implicit conversion to integers using __int__ is deprecated, and may be removed in a future version of Python.
  time.sleep(RealNumber('0.5'))
```



---

archive/issue_comments_435468.json:
```json
{
    "body": "<a id='comment:5'></a>Everything passes now for me using system python 3.10.1 on void linux:\n\n```\n$ ./sage -tp 36 --optional sage,optional,build --all\n...\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 236.9 seconds\n    cpu time: 7024.5 seconds\n    cumulative wall time: 6565.8 seconds\n```",
    "created_at": "2021-12-20T01:57:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435468",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:5'></a>Everything passes now for me using system python 3.10.1 on void linux:

```
$ ./sage -tp 36 --optional sage,optional,build --all
...
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 236.9 seconds
    cpu time: 7024.5 seconds
    cumulative wall time: 6565.8 seconds
```



---

archive/issue_comments_435469.json:
```json
{
    "body": "<a id='comment:7'></a>All tests passing here too, thanks!",
    "created_at": "2021-12-20T15:41:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435469",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:7'></a>All tests passing here too, thanks!



---

archive/issue_comments_435470.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-20T15:41:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435470",
    "user": "https://github.com/antonio-rojas"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_435471.json:
```json
{
    "body": "<a id='comment:8'></a>Thanks!",
    "created_at": "2021-12-20T19:57:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435471",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>Thanks!



---

archive/issue_comments_435472.json:
```json
{
    "body": "<a id='comment:9'></a>The dependency #33040 needs review so that we can get this ticket merged.",
    "created_at": "2021-12-20T19:57:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435472",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>The dependency #33040 needs review so that we can get this ticket merged.



---

archive/issue_events_080213.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-01-01T00:23:38Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30766#event-80213"
}
```



---

archive/issue_comments_435473.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-01-01T00:23:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435473",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_435474.json:
```json
{
    "body": "<a id='comment:1'></a>Something regressed in 9.5.rc0 which is causing distutils deprecation warnings\n\n```\nFile \"/usr/lib/python3.10/site-packages/sage/env.py\", line 359, in sage.env.sage_include_directories\nFailed example:\n    sage.env.sage_include_directories()\nExpected:\n    ['.../include/python...',\n    '.../python.../numpy/core/include']\nGot:\n    doctest:warning\n      File \"/usr/bin/sage-runtests\", line 155, in <module>\n        err = DC.run()\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/control.py\", line 1256, in run\n        self.run_doctests()\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/control.py\", line 957, in run_doctests\n        self.dispatcher.dispatch()\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 2004, in dispatch\n        self.parallel_dispatch()\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1899, in parallel_dispatch\n        w.start()  # This might take some time\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 2173, in start\n        super(DocTestWorker, self).start()\n      File \"/usr/lib/python3.10/multiprocessing/process.py\", line 121, in start\n        self._popen = self._Popen(self)\n      File \"/usr/lib/python3.10/multiprocessing/context.py\", line 224, in _Popen\n        return _default_context.get_context().Process._Popen(process_obj)\n      File \"/usr/lib/python3.10/multiprocessing/context.py\", line 277, in _Popen\n        return Popen(process_obj)\n      File \"/usr/lib/python3.10/multiprocessing/popen_fork.py\", line 19, in __init__\n        self._launch(process_obj)\n      File \"/usr/lib/python3.10/multiprocessing/popen_fork.py\", line 71, in _launch\n        code = process_obj._bootstrap(parent_sentinel=child_r)\n      File \"/usr/lib/python3.10/multiprocessing/process.py\", line 315, in _bootstrap\n        self.run()\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 2145, in run\n        task(self.options, self.outtmpfile, msgpipe, self.result_queue)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 2475, in __call__\n        doctests, extras = self._run(runner, options, results)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 2527, in _run\n        result = runner.run(test)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 861, in run\n        return self._run(test, compileflags, out)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.env.sage_include_directories[1]>\", line 1, in <module>\n        sage.env.sage_include_directories()\n      File \"/usr/lib/python3.10/site-packages/sage/env.py\", line 375, in sage_include_directories\n        import distutils.sysconfig\n      File \"<frozen importlib._bootstrap>\", line 1027, in _find_and_load\n      File \"<frozen importlib._bootstrap>\", line 992, in _find_and_load_unlocked\n      File \"<frozen importlib._bootstrap>\", line 241, in _call_with_frames_removed\n      File \"<frozen importlib._bootstrap>\", line 1027, in _find_and_load\n      File \"<frozen importlib._bootstrap>\", line 1006, in _find_and_load_unlocked\n      File \"<frozen importlib._bootstrap>\", line 688, in _load_unlocked\n      File \"<frozen importlib._bootstrap_external>\", line 883, in exec_module\n      File \"<frozen importlib._bootstrap>\", line 241, in _call_with_frames_removed\n      File \"/usr/lib/python3.10/distutils/__init__.py\", line 19, in <module>\n        warnings.warn(_DEPRECATION_MESSAGE,\n      File \"/usr/lib/python3.10/warnings.py\", line 109, in _showwarnmsg\n        sw(msg.message, msg.category, msg.filename, msg.lineno,\n    :\n    DeprecationWarning: The distutils package is deprecated and slated for removal in Python 3.12. Use setuptools or check PEP 632 for potential alternatives\n    doctest:warning\n      File \"/usr/bin/sage-runtests\", line 155, in <module>\n        err = DC.run()\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/control.py\", line 1256, in run\n        self.run_doctests()\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/control.py\", line 957, in run_doctests\n        self.dispatcher.dispatch()\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 2004, in dispatch\n        self.parallel_dispatch()\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1899, in parallel_dispatch\n        w.start()  # This might take some time\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 2173, in start\n        super(DocTestWorker, self).start()\n      File \"/usr/lib/python3.10/multiprocessing/process.py\", line 121, in start\n        self._popen = self._Popen(self)\n      File \"/usr/lib/python3.10/multiprocessing/context.py\", line 224, in _Popen\n        return _default_context.get_context().Process._Popen(process_obj)\n      File \"/usr/lib/python3.10/multiprocessing/context.py\", line 277, in _Popen\n        return Popen(process_obj)\n      File \"/usr/lib/python3.10/multiprocessing/popen_fork.py\", line 19, in __init__\n        self._launch(process_obj)\n      File \"/usr/lib/python3.10/multiprocessing/popen_fork.py\", line 71, in _launch\n        code = process_obj._bootstrap(parent_sentinel=child_r)\n      File \"/usr/lib/python3.10/multiprocessing/process.py\", line 315, in _bootstrap\n        self.run()\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 2145, in run\n        task(self.options, self.outtmpfile, msgpipe, self.result_queue)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 2475, in __call__\n        doctests, extras = self._run(runner, options, results)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 2527, in _run\n        result = runner.run(test)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 861, in run\n        return self._run(test, compileflags, out)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 694, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/usr/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1088, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.env.sage_include_directories[1]>\", line 1, in <module>\n        sage.env.sage_include_directories()\n      File \"/usr/lib/python3.10/site-packages/sage/env.py\", line 375, in sage_include_directories\n        import distutils.sysconfig\n      File \"<frozen importlib._bootstrap>\", line 1027, in _find_and_load\n      File \"<frozen importlib._bootstrap>\", line 1006, in _find_and_load_unlocked\n      File \"<frozen importlib._bootstrap>\", line 688, in _load_unlocked\n      File \"<frozen importlib._bootstrap_external>\", line 883, in exec_module\n      File \"<frozen importlib._bootstrap>\", line 241, in _call_with_frames_removed\n      File \"/usr/lib/python3.10/distutils/sysconfig.py\", line 58, in <module>\n        warnings.warn(\n      File \"/usr/lib/python3.10/warnings.py\", line 109, in _showwarnmsg\n        sw(msg.message, msg.category, msg.filename, msg.lineno,\n    :\n    DeprecationWarning: The distutils.sysconfig module is deprecated, use sysconfig instead\n    ['/usr/lib/python3.10/site-packages',\n     '/usr/include/python3.10',\n     '/usr/lib/python3.10/site-packages/numpy/core/include']\n**********************************************************************\n```\nThese didn't happen with 9.5.beta9 + this branch.",
    "created_at": "2022-01-09T13:39:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435474",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:1'></a>Something regressed in 9.5.rc0 which is causing distutils deprecation warnings

```
File "/usr/lib/python3.10/site-packages/sage/env.py", line 359, in sage.env.sage_include_directories
Failed example:
    sage.env.sage_include_directories()
Expected:
    ['.../include/python...',
    '.../python.../numpy/core/include']
Got:
    doctest:warning
      File "/usr/bin/sage-runtests", line 155, in <module>
        err = DC.run()
      File "/usr/lib/python3.10/site-packages/sage/doctest/control.py", line 1256, in run
        self.run_doctests()
      File "/usr/lib/python3.10/site-packages/sage/doctest/control.py", line 957, in run_doctests
        self.dispatcher.dispatch()
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 2004, in dispatch
        self.parallel_dispatch()
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1899, in parallel_dispatch
        w.start()  # This might take some time
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 2173, in start
        super(DocTestWorker, self).start()
      File "/usr/lib/python3.10/multiprocessing/process.py", line 121, in start
        self._popen = self._Popen(self)
      File "/usr/lib/python3.10/multiprocessing/context.py", line 224, in _Popen
        return _default_context.get_context().Process._Popen(process_obj)
      File "/usr/lib/python3.10/multiprocessing/context.py", line 277, in _Popen
        return Popen(process_obj)
      File "/usr/lib/python3.10/multiprocessing/popen_fork.py", line 19, in __init__
        self._launch(process_obj)
      File "/usr/lib/python3.10/multiprocessing/popen_fork.py", line 71, in _launch
        code = process_obj._bootstrap(parent_sentinel=child_r)
      File "/usr/lib/python3.10/multiprocessing/process.py", line 315, in _bootstrap
        self.run()
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 2145, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 2475, in __call__
        doctests, extras = self._run(runner, options, results)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 2527, in _run
        result = runner.run(test)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 861, in run
        return self._run(test, compileflags, out)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.env.sage_include_directories[1]>", line 1, in <module>
        sage.env.sage_include_directories()
      File "/usr/lib/python3.10/site-packages/sage/env.py", line 375, in sage_include_directories
        import distutils.sysconfig
      File "<frozen importlib._bootstrap>", line 1027, in _find_and_load
      File "<frozen importlib._bootstrap>", line 992, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
      File "<frozen importlib._bootstrap>", line 1027, in _find_and_load
      File "<frozen importlib._bootstrap>", line 1006, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 688, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 883, in exec_module
      File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
      File "/usr/lib/python3.10/distutils/__init__.py", line 19, in <module>
        warnings.warn(_DEPRECATION_MESSAGE,
      File "/usr/lib/python3.10/warnings.py", line 109, in _showwarnmsg
        sw(msg.message, msg.category, msg.filename, msg.lineno,
    :
    DeprecationWarning: The distutils package is deprecated and slated for removal in Python 3.12. Use setuptools or check PEP 632 for potential alternatives
    doctest:warning
      File "/usr/bin/sage-runtests", line 155, in <module>
        err = DC.run()
      File "/usr/lib/python3.10/site-packages/sage/doctest/control.py", line 1256, in run
        self.run_doctests()
      File "/usr/lib/python3.10/site-packages/sage/doctest/control.py", line 957, in run_doctests
        self.dispatcher.dispatch()
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 2004, in dispatch
        self.parallel_dispatch()
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1899, in parallel_dispatch
        w.start()  # This might take some time
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 2173, in start
        super(DocTestWorker, self).start()
      File "/usr/lib/python3.10/multiprocessing/process.py", line 121, in start
        self._popen = self._Popen(self)
      File "/usr/lib/python3.10/multiprocessing/context.py", line 224, in _Popen
        return _default_context.get_context().Process._Popen(process_obj)
      File "/usr/lib/python3.10/multiprocessing/context.py", line 277, in _Popen
        return Popen(process_obj)
      File "/usr/lib/python3.10/multiprocessing/popen_fork.py", line 19, in __init__
        self._launch(process_obj)
      File "/usr/lib/python3.10/multiprocessing/popen_fork.py", line 71, in _launch
        code = process_obj._bootstrap(parent_sentinel=child_r)
      File "/usr/lib/python3.10/multiprocessing/process.py", line 315, in _bootstrap
        self.run()
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 2145, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 2475, in __call__
        doctests, extras = self._run(runner, options, results)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 2527, in _run
        result = runner.run(test)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 861, in run
        return self._run(test, compileflags, out)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.10/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.env.sage_include_directories[1]>", line 1, in <module>
        sage.env.sage_include_directories()
      File "/usr/lib/python3.10/site-packages/sage/env.py", line 375, in sage_include_directories
        import distutils.sysconfig
      File "<frozen importlib._bootstrap>", line 1027, in _find_and_load
      File "<frozen importlib._bootstrap>", line 1006, in _find_and_load_unlocked
      File "<frozen importlib._bootstrap>", line 688, in _load_unlocked
      File "<frozen importlib._bootstrap_external>", line 883, in exec_module
      File "<frozen importlib._bootstrap>", line 241, in _call_with_frames_removed
      File "/usr/lib/python3.10/distutils/sysconfig.py", line 58, in <module>
        warnings.warn(
      File "/usr/lib/python3.10/warnings.py", line 109, in _showwarnmsg
        sw(msg.message, msg.category, msg.filename, msg.lineno,
    :
    DeprecationWarning: The distutils.sysconfig module is deprecated, use sysconfig instead
    ['/usr/lib/python3.10/site-packages',
     '/usr/include/python3.10',
     '/usr/lib/python3.10/site-packages/numpy/core/include']
**********************************************************************
```
These didn't happen with 9.5.beta9 + this branch.



---

archive/issue_comments_435475.json:
```json
{
    "body": "<a id='comment:112'></a>Replying to [comment:111 arojas]:\n> Something regressed in 9.5.rc0 which is causing distutils deprecation warnings\n\n\nThis comes from #32938, in particular form the removal of\n\n```\nfrom Cython.Build.Dependencies import strip_string_literals as cython_strip_string_literals\n```\nfrom `sage.doctest.parsing`. That import used to throw a `distutils` deprecation warning that for some reason was ignored during doctesting, and now that it's gone the warning is printed when doctesting any module that calls `distutils.sysconfig`.",
    "created_at": "2022-01-09T15:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435475",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:112'></a>Replying to [comment:111 arojas]:
> Something regressed in 9.5.rc0 which is causing distutils deprecation warnings


This comes from #32938, in particular form the removal of

```
from Cython.Build.Dependencies import strip_string_literals as cython_strip_string_literals
```
from `sage.doctest.parsing`. That import used to throw a `distutils` deprecation warning that for some reason was ignored during doctesting, and now that it's gone the warning is printed when doctesting any module that calls `distutils.sysconfig`.



---

archive/issue_comments_435476.json:
```json
{
    "body": "<a id='comment:3'></a>adding `internet` to `--optional=` shows that all `context=SSLContext()` [should be replaced with](https://docs.python.org/3/library/ssl.html#ssl.create_default_context) `context=ssl.create_default_context()`",
    "created_at": "2022-01-09T16:05:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435476",
    "user": "https://github.com/sheerluck"
}
```

<a id='comment:3'></a>adding `internet` to `--optional=` shows that all `context=SSLContext()` [should be replaced with](https://docs.python.org/3/library/ssl.html#ssl.create_default_context) `context=ssl.create_default_context()`



---

archive/issue_comments_435477.json:
```json
{
    "body": "<a id='comment:4'></a>These three seem to fix all the warnings for me (numpy 1.22 from system via #29665)\n\n```\n--- a/src/sage/all.py\t2022-01-09 15:34:29.833828362 -0300\n+++ b/src/sage/all.py\t2022-01-09 15:39:40.150091390 -0300\n@@ -96,6 +96,15 @@\n warnings.filterwarnings('ignore', category=DeprecationWarning,\n                         module='pythran')\n \n+warnings.filterwarnings('ignore', category=DeprecationWarning,\n+\t\t\tmodule='numpy', message='.*distutils.*')\n+\n+warnings.filterwarnings('ignore', category=DeprecationWarning,\n+\t\t\tmodule='sage.env', message='.*distutils.*')\n+\n+warnings.filterwarnings('ignore', category=DeprecationWarning,\n+\t\t\tmodule='sage.features', message='.*distutils.*')\n+\n ################ end setup warnings ###############################\n \n \n```\n\nEdit: fixed paths in the patch.",
    "created_at": "2022-01-09T18:46:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435477",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:4'></a>These three seem to fix all the warnings for me (numpy 1.22 from system via #29665)

```
--- a/src/sage/all.py	2022-01-09 15:34:29.833828362 -0300
+++ b/src/sage/all.py	2022-01-09 15:39:40.150091390 -0300
@@ -96,6 +96,15 @@
 warnings.filterwarnings('ignore', category=DeprecationWarning,
                         module='pythran')
 
+warnings.filterwarnings('ignore', category=DeprecationWarning,
+			module='numpy', message='.*distutils.*')
+
+warnings.filterwarnings('ignore', category=DeprecationWarning,
+			module='sage.env', message='.*distutils.*')
+
+warnings.filterwarnings('ignore', category=DeprecationWarning,
+			module='sage.features', message='.*distutils.*')
+
 ################ end setup warnings ###############################
 
 
```

Edit: fixed paths in the patch.



---

archive/issue_comments_435478.json:
```json
{
    "body": "<a id='comment:5'></a>Please see and review #33135.",
    "created_at": "2022-01-09T19:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30766",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30766#issuecomment-435478",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:5'></a>Please see and review #33135.
