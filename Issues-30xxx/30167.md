# Issue 30167: Add pyright and pycodestyle checks as Github actions

archive/issues_030167.json:
```json
{
    "body": "CC:  @saraedum @mkoeppe @fchapoton @mjungmath @embray @slel @dimpase\n\nKeywords: code style, lint\n\nCurrently, the linters (pycodestyle, pyflakes, ...) run as plugins of patchbot. This has a few disadvantages: a) the lint results depend on the version of the tools installed by the owner of the patchbot b) it takes quite some time until the results are available and c) you need people to run the patchbot.\n\nThis ticket adds pyright, relint and pycodestyle checks as Github actions. They run really fast (about 2min), have reliable results as the version of the linters can be controlled and uses Github server instead of people's machines.\n\nAlthough only those rules are activated that are also run by the patchbot, the pycodestyle and relint checks currently fail with a lot of errors. See https://github.com/tobiasdiez/sage/actions/runs/352364668. Thus, making these tests pass requires more work by the sage community.\n\nWhat is left to do is to add the integration of the github action output to trac - #30877\n\nIssue created by migration from https://trac.sagemath.org/ticket/30404\n\n",
    "closed_at": "2020-11-20T22:15:09Z",
    "created_at": "2020-08-20T11:33:38Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Add pyright and pycodestyle checks as Github actions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30167",
    "user": "https://github.com/tobiasdiez"
}
```
CC:  @saraedum @mkoeppe @fchapoton @mjungmath @embray @slel @dimpase

Keywords: code style, lint

Currently, the linters (pycodestyle, pyflakes, ...) run as plugins of patchbot. This has a few disadvantages: a) the lint results depend on the version of the tools installed by the owner of the patchbot b) it takes quite some time until the results are available and c) you need people to run the patchbot.

This ticket adds pyright, relint and pycodestyle checks as Github actions. They run really fast (about 2min), have reliable results as the version of the linters can be controlled and uses Github server instead of people's machines.

Although only those rules are activated that are also run by the patchbot, the pycodestyle and relint checks currently fail with a lot of errors. See https://github.com/tobiasdiez/sage/actions/runs/352364668. Thus, making these tests pass requires more work by the sage community.

What is left to do is to add the integration of the github action output to trac - #30877

Issue created by migration from https://trac.sagemath.org/ticket/30404





---

archive/issue_comments_429446.json:
```json
{
    "body": "Option A: I think this is politically impossible. I know that some of the contributors here have (or at least had) strong feelings about github. That likely did not improve with Microsoft buying them.\n\nOption B*: Every branch here is already mirrored on [GitLab](GitLab). I believe what's missing here is better docs: https://gitlab.com/sagemath/dev/trac\n\nOption C*: You could add the linter to [GitLab](GitLab) CI. If I remember embray's comments correctly it's really easy to write a trac plugin that shows the gitlab CI status here on trac.",
    "created_at": "2020-08-20T11:59:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429446",
    "user": "https://github.com/saraedum"
}
```

Option A: I think this is politically impossible. I know that some of the contributors here have (or at least had) strong feelings about github. That likely did not improve with Microsoft buying them.

Option B*: Every branch here is already mirrored on [GitLab](GitLab). I believe what's missing here is better docs: https://gitlab.com/sagemath/dev/trac

Option C*: You could add the linter to [GitLab](GitLab) CI. If I remember embray's comments correctly it's really easy to write a trac plugin that shows the gitlab CI status here on trac.



---

archive/issue_comments_429447.json:
```json
{
    "body": "Note there's also https://github.com/sagemath/sagetrac-mirror - but I don't know at what intervals it is mirrored.",
    "created_at": "2020-08-20T12:44:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429447",
    "user": "https://github.com/mkoeppe"
}
```

Note there's also https://github.com/sagemath/sagetrac-mirror - but I don't know at what intervals it is mirrored.



---

archive/issue_comments_429448.json:
```json
{
    "body": "Perfect `@`mkoeppe! In this case, the integration should be fairly straightforward and amounts to adding the adding a link to the badge, by\n\n\n```\n<a href=\"https://github.com/sagemath/sagetrac-mirror/actions?query=workflow%3ALint+branch%3BRANCH\"><img src=\"https://github.com/sagemath/sagetrac-mirror/workflows/Lint/badge.svg?branch=BRANCH&event=push\"/></a>\n```\n\n\nGiving something similar to\n\n![](https://github.com/tobiasdiez/sage/workflows/Lint/badge.svg?branch=patch-2&event=push)\n\nwith a link to https://github.com/tobiasdiez/sage/actions?query=workflow%3ALint+branch%3Apatch-2\n(its sadly not possible to directly link to the workflow output)\n\nThis leaves the following todo list:\n- Restrict current github actions to master and develop branch\n- Activate gitub actions in sagetrac-mirror\n- Add the link to the badge to trac\n\nI can do the first task. Could somebody else then do point 2 and 3?",
    "created_at": "2020-08-20T13:33:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429448",
    "user": "https://github.com/tobiasdiez"
}
```

Perfect `@`mkoeppe! In this case, the integration should be fairly straightforward and amounts to adding the adding a link to the badge, by


```
<a href="https://github.com/sagemath/sagetrac-mirror/actions?query=workflow%3ALint+branch%3BRANCH"><img src="https://github.com/sagemath/sagetrac-mirror/workflows/Lint/badge.svg?branch=BRANCH&event=push"/></a>
```


Giving something similar to

![](https://github.com/tobiasdiez/sage/workflows/Lint/badge.svg?branch=patch-2&event=push)

with a link to https://github.com/tobiasdiez/sage/actions?query=workflow%3ALint+branch%3Apatch-2
(its sadly not possible to directly link to the workflow output)

This leaves the following todo list:
- Restrict current github actions to master and develop branch
- Activate gitub actions in sagetrac-mirror
- Add the link to the badge to trac

I can do the first task. Could somebody else then do point 2 and 3?



---

archive/issue_comments_429449.json:
```json
{
    "body": "My suggestion is to first focus on local operation. For example, finding a place for the  pycodestyle configuration in the Sage source tree (this should not be configured in  `.github/workflows/`, nor in the patchbot sources!) -- perhaps this should go to `src/tox.ini`, and then provide corresponding documentation on how to run it and why. Next, change the patchbot so that it uses the configuration from that file. This will make sure that things don't fall out of sync.",
    "created_at": "2020-08-20T13:35:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429449",
    "user": "https://github.com/mkoeppe"
}
```

My suggestion is to first focus on local operation. For example, finding a place for the  pycodestyle configuration in the Sage source tree (this should not be configured in  `.github/workflows/`, nor in the patchbot sources!) -- perhaps this should go to `src/tox.ini`, and then provide corresponding documentation on how to run it and why. Next, change the patchbot so that it uses the configuration from that file. This will make sure that things don't fall out of sync.



---

archive/issue_comments_429450.json:
```json
{
    "body": "Changing keywords from \"\" to \"code style, lint\".",
    "created_at": "2020-08-20T14:28:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429450",
    "user": "https://github.com/slel"
}
```

Changing keywords from "" to "code style, lint".



---

archive/issue_comments_429451.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2020-08-20T14:28:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429451",
    "user": "https://github.com/slel"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_429452.json:
```json
{
    "body": "Moving the config to src/tox.ini is done in #30408.\n\nShould I continue with the above plan and restrict the current github workflows to the master & develop branch?",
    "created_at": "2020-08-20T18:58:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429452",
    "user": "https://github.com/tobiasdiez"
}
```

Moving the config to src/tox.ini is done in #30408.

Should I continue with the above plan and restrict the current github workflows to the master & develop branch?



---

archive/issue_comments_429453.json:
```json
{
    "body": "Take a look at the other workflows from my portability tests. They are configured to run on every push to a tag and on every pull request. That's I think also the right granularity for the new workflow",
    "created_at": "2020-08-21T00:18:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429453",
    "user": "https://github.com/mkoeppe"
}
```

Take a look at the other workflows from my portability tests. They are configured to run on every push to a tag and on every pull request. That's I think also the right granularity for the new workflow



---

archive/issue_comments_429454.json:
```json
{
    "body": "Replying to [comment:7 gh-tobiasdiez]:\n> Moving the config to src/tox.ini is done in #30408.\n\n\nYou could make #30408 a dependency of this ticket & merge in the branch",
    "created_at": "2020-08-21T00:19:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429454",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:7 gh-tobiasdiez]:
> Moving the config to src/tox.ini is done in #30408.


You could make #30408 a dependency of this ticket & merge in the branch



---

archive/issue_comments_429455.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-08-22T11:12:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429455",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_429456.json:
```json
{
    "body": "I've now changed the workflow to use tox, which is enabled by #30408. Moreover, I realized based on the above comment by mkoeppe that the other Github actions are already restricted to only run on pushes with tags. Thus, they don't run on normal pushes to sagetrac-mirror, so no further action needed there.\n\n\n\n\n> They are configured to run on every push to a tag and on every pull request. That's I think also the right granularity for the new workflow\n\n\nI think the lint workflow should run on every push and pull request. In this way, the developer gets immediate feedback, and this is similar to the patchbot that also runs on every \"push\".\nMoreover, they run very quickly so there is no problem in running them on every push.\n\nSo this leaves the following todo's.\n- Peer-review this ticket\n- Activate gitub actions in sagetrac-mirror\n- Merge the dependencies #30408, #30361\n- Double check that the workflow runs successful on sagetrac-mirror\n- Merge\n- Add the link to the badge to trac as described above\n\nAfterwards, the workflow can be extended to include further linters. It might also be good to later add a basic build & doctest workflow that runs on every push.\n\n---\nNew commits:",
    "created_at": "2020-08-22T11:12:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429456",
    "user": "https://github.com/tobiasdiez"
}
```

I've now changed the workflow to use tox, which is enabled by #30408. Moreover, I realized based on the above comment by mkoeppe that the other Github actions are already restricted to only run on pushes with tags. Thus, they don't run on normal pushes to sagetrac-mirror, so no further action needed there.




> They are configured to run on every push to a tag and on every pull request. That's I think also the right granularity for the new workflow


I think the lint workflow should run on every push and pull request. In this way, the developer gets immediate feedback, and this is similar to the patchbot that also runs on every "push".
Moreover, they run very quickly so there is no problem in running them on every push.

So this leaves the following todo's.
- Peer-review this ticket
- Activate gitub actions in sagetrac-mirror
- Merge the dependencies #30408, #30361
- Double check that the workflow runs successful on sagetrac-mirror
- Merge
- Add the link to the badge to trac as described above

Afterwards, the workflow can be extended to include further linters. It might also be good to later add a basic build & doctest workflow that runs on every push.

---
New commits:



---

archive/issue_comments_429457.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-09-05T18:49:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429457",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_429458.json:
```json
{
    "body": "`@`mkoeppe, what should I do here? The dependencies are rather indirect (it works without #30361, it just tests more code). Moreover, this github action is currently nowhere invoked and hence not checked / tested....",
    "created_at": "2020-09-05T20:09:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429458",
    "user": "https://github.com/tobiasdiez"
}
```

`@`mkoeppe, what should I do here? The dependencies are rather indirect (it works without #30361, it just tests more code). Moreover, this github action is currently nowhere invoked and hence not checked / tested....



---

archive/issue_comments_429459.json:
```json
{
    "body": "Ticket description: \"The pyright check currently fails, as there is no configuration file\"",
    "created_at": "2020-09-05T20:13:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429459",
    "user": "https://github.com/mkoeppe"
}
```

Ticket description: "The pyright check currently fails, as there is no configuration file"



---

archive/issue_comments_429460.json:
```json
{
    "body": "Yes, but even with the configuration files added the github workflow fails as there is no typing information yet(and the one added in #29775 is not complete) and pycodestyle reports over 600 errors as well.\n\nFixing these points requires more effort from the whole sage community.\n\nThe aim of this ticket is to add the github actions so that one has a consistent check, which at some point in the future hopefully turns green.",
    "created_at": "2020-09-06T11:36:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429460",
    "user": "https://github.com/tobiasdiez"
}
```

Yes, but even with the configuration files added the github workflow fails as there is no typing information yet(and the one added in #29775 is not complete) and pycodestyle reports over 600 errors as well.

Fixing these points requires more effort from the whole sage community.

The aim of this ticket is to add the github actions so that one has a consistent check, which at some point in the future hopefully turns green.



---

archive/issue_comments_429461.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-09-06T11:36:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429461",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_429462.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-09-18T21:52:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429462",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_429463.json:
```json
{
    "body": "Should invoke relint as well (added in #30467).",
    "created_at": "2020-09-18T21:52:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429463",
    "user": "https://github.com/tobiasdiez"
}
```

Should invoke relint as well (added in #30467).



---

archive/issue_comments_429464.json:
```json
{
    "body": "Could just run all tox environments...",
    "created_at": "2020-09-18T21:54:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429464",
    "user": "https://github.com/mkoeppe"
}
```

Could just run all tox environments...



---

archive/issue_events_078843.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30167#event-78843"
}
```



---

archive/issue_comments_429465.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-08T14:21:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429465",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_429466.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-11-08T14:31:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429466",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_429467.json:
```json
{
    "body": "I've now added relint. This is now ready for review.",
    "created_at": "2020-11-08T14:31:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429467",
    "user": "https://github.com/tobiasdiez"
}
```

I've now added relint. This is now ready for review.



---

archive/issue_comments_429468.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-11-09T04:03:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429468",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_429469.json:
```json
{
    "body": "This seems to work well. \n\nI have moved the part of the ticket description that describes Trac integration to the new ticket #30877. But actually, given that the new push mirror for Trac ended up using GitLab instead of GitHub (see #30736), you should probably look into creating [GitLab](GitLab) pipelines for the same checks.",
    "created_at": "2020-11-09T04:03:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429469",
    "user": "https://github.com/mkoeppe"
}
```

This seems to work well. 

I have moved the part of the ticket description that describes Trac integration to the new ticket #30877. But actually, given that the new push mirror for Trac ended up using GitLab instead of GitHub (see #30736), you should probably look into creating [GitLab](GitLab) pipelines for the same checks.



---

archive/issue_comments_429470.json:
```json
{
    "body": "Thanks for the review!\n\nI think you can make a good argument to have both Gitlab as well as Github as push mirrors.",
    "created_at": "2020-11-09T11:22:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429470",
    "user": "https://github.com/tobiasdiez"
}
```

Thanks for the review!

I think you can make a good argument to have both Gitlab as well as Github as push mirrors.



---

archive/issue_comments_429471.json:
```json
{
    "body": "reviewer name missing",
    "created_at": "2020-11-09T14:36:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429471",
    "user": "https://github.com/fchapoton"
}
```

reviewer name missing



---

archive/issue_comments_429472.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-11-20T22:15:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30167#issuecomment-429472",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_078844.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-11-20T22:15:09Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30167",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30167#event-78844"
}
```
