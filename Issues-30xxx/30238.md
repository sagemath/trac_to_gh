# Issue 30238: Make RecursivelyEnumeratedSet_forest a subclass of RecursivelyEnumeratedSet_generic

archive/issues_030001.json:
```json
{
    "assignees": [],
    "body": "As a follow up of #16351, we integrate the class `RecursivelyEnumeratedSet_forest` as a subclass of `RecursivelyEnumeratedSet_generic` implementing the following change:\n\n```diff\n-class RecursivelyEnumeratedSet_forest(Parent):\n+class RecursivelyEnumeratedSet_forest(RecursivelyEnumeratedSet_generic):\n```\n\nand consequential changes.\n\nI was hoping this to be enough to activate few methods like `to_digraph` from the generic class that I like to use but are currently not available for the forest type. But unfortunately, the implementation of breadth first search for forest type does not yet take into account the `max_depth` argument. That will be dealt in another ticket.\n\nCC:  @tscrim\n\nBranch/Commit: **[u/slabbe/30238](https://github.com/sagemath/sagetrac-mirror/tree/u/slabbe/30238) @ [`7b65a95`](https://github.com/sagemath/sagetrac-mirror/commit/7b65a9580ad87a79308c18d49023189decc5aa1d)**\n\nAuthor: **S\u00e9bastien Labb\u00e9**\n\nComponent: **combinatorics**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/30238_\n\n",
    "created_at": "2020-07-28T12:38:13Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20combinatorics",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement",
        "https://github.com/sagemath/sage/labels/needs%20work"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Make RecursivelyEnumeratedSet_forest a subclass of RecursivelyEnumeratedSet_generic",
    "type": "issue",
    "updated_at": "2022-08-31T02:51:13Z",
    "url": "https://github.com/sagemath/sage/issues/30238",
    "user": "https://github.com/seblabbe"
}
```
As a follow up of #16351, we integrate the class `RecursivelyEnumeratedSet_forest` as a subclass of `RecursivelyEnumeratedSet_generic` implementing the following change:

```diff
-class RecursivelyEnumeratedSet_forest(Parent):
+class RecursivelyEnumeratedSet_forest(RecursivelyEnumeratedSet_generic):
```

and consequential changes.

I was hoping this to be enough to activate few methods like `to_digraph` from the generic class that I like to use but are currently not available for the forest type. But unfortunately, the implementation of breadth first search for forest type does not yet take into account the `max_depth` argument. That will be dealt in another ticket.

CC:  @tscrim

Branch/Commit: **[u/slabbe/30238](https://github.com/sagemath/sagetrac-mirror/tree/u/slabbe/30238) @ [`7b65a95`](https://github.com/sagemath/sagetrac-mirror/commit/7b65a9580ad87a79308c18d49023189decc5aa1d)**

Author: **Sébastien Labbé**

Component: **combinatorics**

_Issue created by migration from https://trac.sagemath.org/ticket/30238_





---

archive/issue_events_416481.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2020-07-28T12:38:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416481"
}
```



---

archive/issue_events_416482.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2020-07-28T12:38:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20combinatorics",
    "label_color": "0000ff",
    "label_name": "c: combinatorics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416482"
}
```



---

archive/issue_events_416483.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2020-07-28T12:38:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416483"
}
```



---

archive/issue_events_416484.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2020-07-28T12:38:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416484"
}
```



---

archive/issue_comments_479489.json:
```json
{
    "body": "Commit: **[`d180dc5`](https://github.com/sagemath/sagetrac-mirror/commit/d180dc502b2ba3edb9d4077fc24dacc0c18208b7)**",
    "created_at": "2020-07-28T12:40:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479489",
    "user": "https://github.com/seblabbe"
}
```

Commit: **[`d180dc5`](https://github.com/sagemath/sagetrac-mirror/commit/d180dc502b2ba3edb9d4077fc24dacc0c18208b7)**



---

archive/issue_comments_479490.json:
```json
{
    "body": "Branch: **[u/slabbe/30238](https://github.com/sagemath/sagetrac-mirror/tree/u/slabbe/30238)**",
    "created_at": "2020-07-28T12:40:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479490",
    "user": "https://github.com/seblabbe"
}
```

Branch: **[u/slabbe/30238](https://github.com/sagemath/sagetrac-mirror/tree/u/slabbe/30238)**



---

archive/issue_comments_479491.json:
```json
{
    "body": "<div id=\"comment:1\"></div>\n\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2b310e8029c54cf30bab7637219ae49b84d99f82\">2b310e8</a></td><td><code>first change</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d180dc502b2ba3edb9d4077fc24dacc0c18208b7\">d180dc5</a></td><td><code>30238:Make RecursivelyEnumeratedSet_forest a subclass of RecursivelyEnumeratedSet_generic</code></td></tr></table>\n",
    "created_at": "2020-07-28T12:40:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479491",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:1"></div>

New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2b310e8029c54cf30bab7637219ae49b84d99f82">2b310e8</a></td><td><code>first change</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d180dc502b2ba3edb9d4077fc24dacc0c18208b7">d180dc5</a></td><td><code>30238:Make RecursivelyEnumeratedSet_forest a subclass of RecursivelyEnumeratedSet_generic</code></td></tr></table>




---

archive/issue_events_416485.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2020-07-28T12:40:51Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416485"
}
```



---

archive/issue_comments_479492.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nNote: I am changing the ordering of the input of the init method of `RecursivelyEnumeratedSet_forest` to match the one of `RecursivelyEnumeratedSet_generic`. This might break code using `RecursivelyEnumeratedSet_forest` if such code exists. One option is to make this ticket less intrusive by preserving the previous ordering for the init of `RecursivelyEnumeratedSet_forest`.\n\nThis is transparent for the code based on the function `RecursivelyEnumeratedSet`. The problem was only if people were using directly `RecursivelyEnumeratedSet_forest`.",
    "created_at": "2020-07-28T12:52:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479492",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:2" align="right">comment:2</div>

Note: I am changing the ordering of the input of the init method of `RecursivelyEnumeratedSet_forest` to match the one of `RecursivelyEnumeratedSet_generic`. This might break code using `RecursivelyEnumeratedSet_forest` if such code exists. One option is to make this ticket less intrusive by preserving the previous ordering for the init of `RecursivelyEnumeratedSet_forest`.

This is transparent for the code based on the function `RecursivelyEnumeratedSet`. The problem was only if people were using directly `RecursivelyEnumeratedSet_forest`.



---

archive/issue_events_416486.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-07-28T16:58:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416486"
}
```



---

archive/issue_events_416487.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-07-28T16:58:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416487"
}
```



---

archive/issue_comments_479493.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\npatchbot indicates doctest failures",
    "created_at": "2020-07-28T16:58:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479493",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:3" align="right">comment:3</div>

patchbot indicates doctest failures



---

archive/issue_comments_479494.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nok, I will work on that.",
    "created_at": "2020-07-29T21:14:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479494",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:4" align="right">comment:4</div>

ok, I will work on that.



---

archive/issue_comments_479495.json:
```json
{
    "body": "Changed commit from **[`d180dc5`](https://github.com/sagemath/sagetrac-mirror/commit/d180dc502b2ba3edb9d4077fc24dacc0c18208b7)** to **[`cc0b7ae`](https://github.com/sagemath/sagetrac-mirror/commit/cc0b7ae3d7d32bb13334bc06617ae64888f3d29d)**",
    "created_at": "2020-07-30T09:24:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479495",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`d180dc5`](https://github.com/sagemath/sagetrac-mirror/commit/d180dc502b2ba3edb9d4077fc24dacc0c18208b7)** to **[`cc0b7ae`](https://github.com/sagemath/sagetrac-mirror/commit/cc0b7ae3d7d32bb13334bc06617ae64888f3d29d)**



---

archive/issue_comments_479496.json:
```json
{
    "body": "<div id=\"comment:5\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/41aaa0a1d4fdd5fb9cabc33f00cbb2fe8eb2c699\">41aaa0a</a></td><td><code>30238: fix pycodestyle in map_reduce.py</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cc0b7ae3d7d32bb13334bc06617ae64888f3d29d\">cc0b7ae</a></td><td><code>30238: adapt sage library code with the algorithm->enumeration change</code></td></tr></table>\n",
    "created_at": "2020-07-30T09:24:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479496",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:5"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/41aaa0a1d4fdd5fb9cabc33f00cbb2fe8eb2c699">41aaa0a</a></td><td><code>30238: fix pycodestyle in map_reduce.py</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cc0b7ae3d7d32bb13334bc06617ae64888f3d29d">cc0b7ae</a></td><td><code>30238: adapt sage library code with the algorithm->enumeration change</code></td></tr></table>




---

archive/issue_comments_479497.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nI am changing the status to needs review just to see what the patchbot says. Locally, I still have at least the following issues, but I did not tested the whole library.\n\n```\n----------------------------------------------------------------------\nsage -t --random-seed=0 combinat/subsets_pairwise.py  # 1 doctest failed\nsage -t --random-seed=0 combinat/posets/hasse_diagram.py  # 2 doctests failed\n----------------------------------------------------------------------   \n```",
    "created_at": "2020-07-30T09:27:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479497",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:6" align="right">comment:6</div>

I am changing the status to needs review just to see what the patchbot says. Locally, I still have at least the following issues, but I did not tested the whole library.

```
----------------------------------------------------------------------
sage -t --random-seed=0 combinat/subsets_pairwise.py  # 1 doctest failed
sage -t --random-seed=0 combinat/posets/hasse_diagram.py  # 2 doctests failed
----------------------------------------------------------------------   
```



---

archive/issue_events_416488.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2020-07-30T09:27:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416488"
}
```



---

archive/issue_events_416489.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2020-07-30T09:27:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416489"
}
```



---

archive/issue_comments_479498.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nI will need help to fix the above issue. Here is how to reproduce the error:\n\n```\nsage: from sage.combinat.subsets_pairwise import PairwiseCompatibleSubsets\nsage: def predicate(x,y): return gcd(x,y) == 1\nsage: P = PairwiseCompatibleSubsets( [4,5,6,8,9], predicate); P\nAn enumerated set with a forest structure\nsage: import __main__; __main__.predicate = predicate\nsage: TestSuite(P).run()\nFailure in _test_pickling:\n...\nTraceback (most recent call last):\n...\nTypeError: classname(=PairwiseCompatibleSubsets_with_category) does not start \nwith RecursivelyEnumeratedSet but \nisinstance(self, RecursivelyEnumeratedSet_generic) returns True\n------------------------------------------------------------\nThe following tests failed: _test_pickling\n```\n\nThis is due to the fact that a `__reduce__` method exists in the class `RecursivelyEnumeratedSet_generic` which is now used by `RecursivelyEnumeratedSet_forest`. But the current `__reduce__` method is not able to detect properly that self is an instance of `RecursivelyEnumeratedSet_forest` when the class is a class derivated from `RecursivelyEnumeratedSet_forest`. Testing `classname.startswith('RecursivelyEnumeratedSet_forest')` just does not work if the class name is `PairwiseCompatibleSubsets_with_category` for instance.\n\nReplacing the code based on the name of the class by `hasattr(self, 'map_reduce')` or more naturally by ` isinstance(self, RecursivelyEnumeratedSet_forest)` does not work because it gives a `maximum recursion depth exceeded` error:\n\n```diff\ndiff --git a/src/sage/sets/recursively_enumerated_set.pyx b/src/sage/sets/recursively_enumerated_set.pyx\nindex 2ca2dde..b2f5455 100644\n--- a/src/sage/sets/recursively_enumerated_set.pyx\n+++ b/src/sage/sets/recursively_enumerated_set.pyx\n@@ -539,6 +539,14 @@ cdef class RecursivelyEnumeratedSet_generic(Parent):\n             struct = 'forest'\n         elif classname.startswith('RecursivelyEnumeratedSet_generic'):\n             struct = None\n+        # this creates the following error\n+        # RecursionError: maximum recursion depth exceeded while calling a Python object\n+        #elif hasattr(self, 'map_reduce'):\n+        #    struct = 'forest'\n+        # this creates the following error\n+        # RecursionError: maximum recursion depth exceeded while calling a Python object\n+        #elif isinstance(self, RecursivelyEnumeratedSet_forest):\n+        #    struct = 'forest'\n         else:\n             A = isinstance(self, RecursivelyEnumeratedSet_generic)\n             raise TypeError(\"classname(={}) does not start with\"\n```\n\nI guess that code is based on `classname` to avoid that `RecursionError`. But I don't understand where the `RecursionError` comes from. Travis do you know?",
    "created_at": "2020-07-30T11:38:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479498",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:7" align="right">comment:7</div>

I will need help to fix the above issue. Here is how to reproduce the error:

```
sage: from sage.combinat.subsets_pairwise import PairwiseCompatibleSubsets
sage: def predicate(x,y): return gcd(x,y) == 1
sage: P = PairwiseCompatibleSubsets( [4,5,6,8,9], predicate); P
An enumerated set with a forest structure
sage: import __main__; __main__.predicate = predicate
sage: TestSuite(P).run()
Failure in _test_pickling:
...
Traceback (most recent call last):
...
TypeError: classname(=PairwiseCompatibleSubsets_with_category) does not start 
with RecursivelyEnumeratedSet but 
isinstance(self, RecursivelyEnumeratedSet_generic) returns True
------------------------------------------------------------
The following tests failed: _test_pickling
```

This is due to the fact that a `__reduce__` method exists in the class `RecursivelyEnumeratedSet_generic` which is now used by `RecursivelyEnumeratedSet_forest`. But the current `__reduce__` method is not able to detect properly that self is an instance of `RecursivelyEnumeratedSet_forest` when the class is a class derivated from `RecursivelyEnumeratedSet_forest`. Testing `classname.startswith('RecursivelyEnumeratedSet_forest')` just does not work if the class name is `PairwiseCompatibleSubsets_with_category` for instance.

Replacing the code based on the name of the class by `hasattr(self, 'map_reduce')` or more naturally by ` isinstance(self, RecursivelyEnumeratedSet_forest)` does not work because it gives a `maximum recursion depth exceeded` error:

```diff
diff --git a/src/sage/sets/recursively_enumerated_set.pyx b/src/sage/sets/recursively_enumerated_set.pyx
index 2ca2dde..b2f5455 100644
--- a/src/sage/sets/recursively_enumerated_set.pyx
+++ b/src/sage/sets/recursively_enumerated_set.pyx
@@ -539,6 +539,14 @@ cdef class RecursivelyEnumeratedSet_generic(Parent):
             struct = 'forest'
         elif classname.startswith('RecursivelyEnumeratedSet_generic'):
             struct = None
+        # this creates the following error
+        # RecursionError: maximum recursion depth exceeded while calling a Python object
+        #elif hasattr(self, 'map_reduce'):
+        #    struct = 'forest'
+        # this creates the following error
+        # RecursionError: maximum recursion depth exceeded while calling a Python object
+        #elif isinstance(self, RecursivelyEnumeratedSet_forest):
+        #    struct = 'forest'
         else:
             A = isinstance(self, RecursivelyEnumeratedSet_generic)
             raise TypeError("classname(={}) does not start with"
```

I guess that code is based on `classname` to avoid that `RecursionError`. But I don't understand where the `RecursionError` comes from. Travis do you know?



---

archive/issue_comments_479499.json:
```json
{
    "body": "Changed commit from **[`cc0b7ae`](https://github.com/sagemath/sagetrac-mirror/commit/cc0b7ae3d7d32bb13334bc06617ae64888f3d29d)** to **[`df88874`](https://github.com/sagemath/sagetrac-mirror/commit/df88874609fc3337cd178796616c90f9dcd29114)**",
    "created_at": "2020-07-30T12:53:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479499",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`cc0b7ae`](https://github.com/sagemath/sagetrac-mirror/commit/cc0b7ae3d7d32bb13334bc06617ae64888f3d29d)** to **[`df88874`](https://github.com/sagemath/sagetrac-mirror/commit/df88874609fc3337cd178796616c90f9dcd29114)**



---

archive/issue_comments_479500.json:
```json
{
    "body": "<div id=\"comment:8\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/df88874609fc3337cd178796616c90f9dcd29114\">df88874</a></td><td><code>30238:using isinstance in __reduce__</code></td></tr></table>\n",
    "created_at": "2020-07-30T12:53:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479500",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:8"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/df88874609fc3337cd178796616c90f9dcd29114">df88874</a></td><td><code>30238:using isinstance in __reduce__</code></td></tr></table>




---

archive/issue_comments_479501.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nI updated `__reduce__` to use `isinstance` instead which is more robust.\n\nThe next step is to fix the following Recursion error which I still do not understand:\n\n```\nsage: from sage.combinat.subsets_pairwise import PairwiseCompatibleSubsets\nsage: def predicate(x,y): return gcd(x,y) == 1\nsage: P = PairwiseCompatibleSubsets( [4,5,6,8,9], predicate); P\nAn enumerated set with a forest structure\nsage: dumps(P)\nTraceback (most recent call last):\n...\nRecursionError: maximum recursion depth exceeded while calling a Python object\n```",
    "created_at": "2020-07-30T12:57:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479501",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:9" align="right">comment:9</div>

I updated `__reduce__` to use `isinstance` instead which is more robust.

The next step is to fix the following Recursion error which I still do not understand:

```
sage: from sage.combinat.subsets_pairwise import PairwiseCompatibleSubsets
sage: def predicate(x,y): return gcd(x,y) == 1
sage: P = PairwiseCompatibleSubsets( [4,5,6,8,9], predicate); P
An enumerated set with a forest structure
sage: dumps(P)
Traceback (most recent call last):
...
RecursionError: maximum recursion depth exceeded while calling a Python object
```



---

archive/issue_comments_479502.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nIt appears that the error comes from the reduction of the `.post_process`. When the latter is a method then there is a recursive call. A minimal example is\n\n```\nsage: class A: \n....:     def a(self): pass \n....:     def __reduce__(self): \n....:         return (A, (self.a,))                                                                                                                                                                                 \nsage: import pickle                                                                                                                                                                                                 \nsage: pickle.dumps(A())                                                                                                                                                                                             \n---------------------------------------------------------------------------\nRecursionError                            Traceback (most recent call last)\n<ipython-input-4-c96af998f575> in <module>\n----> 1 pickle.dumps(A())\n\nRecursionError: maximum recursion depth exceeded\n```",
    "created_at": "2020-07-30T22:50:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479502",
    "user": "https://github.com/videlec"
}
```

<div id="comment:10" align="right">comment:10</div>

It appears that the error comes from the reduction of the `.post_process`. When the latter is a method then there is a recursive call. A minimal example is

```
sage: class A: 
....:     def a(self): pass 
....:     def __reduce__(self): 
....:         return (A, (self.a,))                                                                                                                                                                                 
sage: import pickle                                                                                                                                                                                                 
sage: pickle.dumps(A())                                                                                                                                                                                             
---------------------------------------------------------------------------
RecursionError                            Traceback (most recent call last)
<ipython-input-4-c96af998f575> in <module>
----> 1 pickle.dumps(A())

RecursionError: maximum recursion depth exceeded
```



---

archive/issue_comments_479503.json:
```json
{
    "body": "<div id=\"comment:11\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3192a9e4b80285c2255b8ddc8a0f7b0698b55f91\">3192a9e</a></td><td><code>30238:fixing the RecursionError</code></td></tr></table>\n",
    "created_at": "2020-07-31T09:19:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479503",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:11"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3192a9e4b80285c2255b8ddc8a0f7b0698b55f91">3192a9e</a></td><td><code>30238:fixing the RecursionError</code></td></tr></table>




---

archive/issue_comments_479504.json:
```json
{
    "body": "Changed commit from **[`df88874`](https://github.com/sagemath/sagetrac-mirror/commit/df88874609fc3337cd178796616c90f9dcd29114)** to **[`3192a9e`](https://github.com/sagemath/sagetrac-mirror/commit/3192a9e4b80285c2255b8ddc8a0f7b0698b55f91)**",
    "created_at": "2020-07-31T09:19:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479504",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`df88874`](https://github.com/sagemath/sagetrac-mirror/commit/df88874609fc3337cd178796616c90f9dcd29114)** to **[`3192a9e`](https://github.com/sagemath/sagetrac-mirror/commit/3192a9e4b80285c2255b8ddc8a0f7b0698b55f91)**



---

archive/issue_comments_479505.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nThank you Vincent. So, I managed to fix the Recursion error. Now, the same doctests fail for a different reason. I will work on that later.\n\nOne feature of `RecursivelyEnumeratedSet_forest` is that you can inherit from this class, define your own children and post_process method and it will work (even if you don't provide them in the init). The fact that `RecursivelyEnumeratedSet_generic` provides a `__reduce__` method, I think it forces the classes inheriting from `RecursivelyEnumeratedSet_forest` to also overwrite the `__reduce__` method. Why does `RecursivelyEnumeratedSet_generic` need a `__reduce__` method in the first place?",
    "created_at": "2020-07-31T09:27:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479505",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:12" align="right">comment:12</div>

Thank you Vincent. So, I managed to fix the Recursion error. Now, the same doctests fail for a different reason. I will work on that later.

One feature of `RecursivelyEnumeratedSet_forest` is that you can inherit from this class, define your own children and post_process method and it will work (even if you don't provide them in the init). The fact that `RecursivelyEnumeratedSet_generic` provides a `__reduce__` method, I think it forces the classes inheriting from `RecursivelyEnumeratedSet_forest` to also overwrite the `__reduce__` method. Why does `RecursivelyEnumeratedSet_generic` need a `__reduce__` method in the first place?



---

archive/issue_events_416490.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2020-07-31T09:27:47Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416490"
}
```



---

archive/issue_events_416491.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2020-07-31T09:27:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416491"
}
```



---

archive/issue_comments_479506.json:
```json
{
    "body": "Changed commit from **[`3192a9e`](https://github.com/sagemath/sagetrac-mirror/commit/3192a9e4b80285c2255b8ddc8a0f7b0698b55f91)** to **[`7b65a95`](https://github.com/sagemath/sagetrac-mirror/commit/7b65a9580ad87a79308c18d49023189decc5aa1d)**",
    "created_at": "2020-07-31T15:42:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479506",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`3192a9e`](https://github.com/sagemath/sagetrac-mirror/commit/3192a9e4b80285c2255b8ddc8a0f7b0698b55f91)** to **[`7b65a95`](https://github.com/sagemath/sagetrac-mirror/commit/7b65a9580ad87a79308c18d49023189decc5aa1d)**



---

archive/issue_comments_479507.json:
```json
{
    "body": "<div id=\"comment:14\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7b65a9580ad87a79308c18d49023189decc5aa1d\">7b65a95</a></td><td><code>30238:fixing one doctest</code></td></tr></table>\n",
    "created_at": "2020-07-31T15:42:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479507",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:14"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7b65a9580ad87a79308c18d49023189decc5aa1d">7b65a95</a></td><td><code>30238:fixing one doctest</code></td></tr></table>




---

archive/issue_comments_479508.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@seblabbe](#comment:12):\n> One feature of `RecursivelyEnumeratedSet_forest` is that you can inherit from this class, define your own children and post_process method and it will work (even if you don't provide them in the init). The fact that `RecursivelyEnumeratedSet_generic` provides a `__reduce__` method, I think it forces the classes inheriting from `RecursivelyEnumeratedSet_forest` to also overwrite the `__reduce__` method. Why does `RecursivelyEnumeratedSet_generic` need a `__reduce__` method in the first place?\n\nMy guess is so that it pickles well when used to build other objects; e.g., as the basis for a `CombinatorialFreeModule`.",
    "created_at": "2020-08-02T03:26:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479508",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@seblabbe](#comment:12):
> One feature of `RecursivelyEnumeratedSet_forest` is that you can inherit from this class, define your own children and post_process method and it will work (even if you don't provide them in the init). The fact that `RecursivelyEnumeratedSet_generic` provides a `__reduce__` method, I think it forces the classes inheriting from `RecursivelyEnumeratedSet_forest` to also overwrite the `__reduce__` method. Why does `RecursivelyEnumeratedSet_generic` need a `__reduce__` method in the first place?

My guess is so that it pickles well when used to build other objects; e.g., as the basis for a `CombinatorialFreeModule`.



---

archive/issue_events_416492.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-05T19:21:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416492"
}
```



---

archive/issue_events_416493.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-05T19:21:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416493"
}
```



---

archive/issue_comments_479509.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nSetting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479509",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:17" align="right">comment:17</div>

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_416494.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416494"
}
```



---

archive/issue_events_416495.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416495"
}
```



---

archive/issue_events_416496.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416496"
}
```



---

archive/issue_events_416497.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416497"
}
```



---

archive/issue_comments_479510.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nSetting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30238#issuecomment-479510",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:18" align="right">comment:18</div>

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_events_416498.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416498"
}
```



---

archive/issue_events_416499.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-18T19:24:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416499"
}
```



---

archive/issue_events_416500.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T20:27:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416500"
}
```



---

archive/issue_events_416501.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-02T20:27:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416501"
}
```



---

archive/issue_events_416502.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416502"
}
```



---

archive/issue_events_416503.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30238",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30238#event-416503"
}
```
