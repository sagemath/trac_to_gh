# Issue 30865: sage_bootstrap: Update/extend "sage -package", fix "make download"

archive/issues_030628.json:
```json
{
    "body": "(from #29146, #30861)\n\nThere are several places where the spkg (`build/pkgs/*/`) and system package information (`build/pkgs/*/distros/*.txt`) is parsed:\n- `bootstrap`\n- `src/doc/bootstrap`\n- `build/bin/write_dockerfile.sh`\n- `build/bin/sage-get-system-packages`\n- `tox.ini` (for `local-homebrew`, `local-conda`)\n- `.github/workflows/ci-wsl.yml` (using powershell)\n- `src/bin/sage-download-upstream`\n- `m4/sage_spkg_*.m4`\n\nThe purpose of this ticket is to prepare refactoring of this code by extending the `sage_bootstrap` package.\n- We update `sage_bootstrap.package` so that it understands non-normal packages (i.e., script and pip packages, which do not have `checksums.ini`)\n- We change `sage -package list` so it supports the following invocations:\n  - `sage -package list :standard: :optional:` (several \"classes\" (types), not just one)\n  - `sage -package list --has-file=spkg-configure.m4 :standard:` (needed for `bootstrap`, `src/doc/bootstrap`)\n  - `sage -package list --has-file=spkg-configure.m4 --has-file=distros/debian.txt :standard: :optional:` (needed for `build/bin/write-dockerfile.sh`, `tox.ini`)\n  - `sage -package list --has-file=SPKG.rst :all:` (needed for `src/doc/bootstrap`)\n- We fix and extend `sage -package download` (follow up from #30648) so it supports\n  - `sage -package download :all:` (again - was broken)\n  - `sage -package download --allow-upstream :all:` (allows retrieving from `upstream_url`)\n  and use it for `make download` (#29896), removing `src/bin/sage-download-upstream`\n\nTo run the testsuite of `sage_bootstrap`, use\n\n```\n  (cd build && tox)\n```\n\n\n\nFollow-up:\n- The actual refactoring of the above scripts (#30947, #30951, #30968, ...)\n- Wishlist item: `sage -package list --not-source=pip :optional: :experimental:` (would simplify `bootstrap`)\n\n\n\nCC:  @seblabbe @tobiasdiez @slel @jhpalmieri @vbraun\n\nReviewer: S\u00e9bastien Labb\u00e9\n\nAuthor: Matthias Koeppe\n\nBranch: f33c3635ba36440b260644c127dcc94e12c3ab40\n\nDependencies: #30648\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30865\n\n",
    "closed_at": "2020-11-29T11:57:50Z",
    "created_at": "2020-11-04T22:01:05Z",
    "labels": [
        "component: build: configure"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "sage_bootstrap: Update/extend \"sage -package\", fix \"make download\"",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30865",
    "user": "https://github.com/mkoeppe"
}
```
(from #29146, #30861)

There are several places where the spkg (`build/pkgs/*/`) and system package information (`build/pkgs/*/distros/*.txt`) is parsed:
- `bootstrap`
- `src/doc/bootstrap`
- `build/bin/write_dockerfile.sh`
- `build/bin/sage-get-system-packages`
- `tox.ini` (for `local-homebrew`, `local-conda`)
- `.github/workflows/ci-wsl.yml` (using powershell)
- `src/bin/sage-download-upstream`
- `m4/sage_spkg_*.m4`

The purpose of this ticket is to prepare refactoring of this code by extending the `sage_bootstrap` package.
- We update `sage_bootstrap.package` so that it understands non-normal packages (i.e., script and pip packages, which do not have `checksums.ini`)
- We change `sage -package list` so it supports the following invocations:
  - `sage -package list :standard: :optional:` (several "classes" (types), not just one)
  - `sage -package list --has-file=spkg-configure.m4 :standard:` (needed for `bootstrap`, `src/doc/bootstrap`)
  - `sage -package list --has-file=spkg-configure.m4 --has-file=distros/debian.txt :standard: :optional:` (needed for `build/bin/write-dockerfile.sh`, `tox.ini`)
  - `sage -package list --has-file=SPKG.rst :all:` (needed for `src/doc/bootstrap`)
- We fix and extend `sage -package download` (follow up from #30648) so it supports
  - `sage -package download :all:` (again - was broken)
  - `sage -package download --allow-upstream :all:` (allows retrieving from `upstream_url`)
  and use it for `make download` (#29896), removing `src/bin/sage-download-upstream`

To run the testsuite of `sage_bootstrap`, use

```
  (cd build && tox)
```



Follow-up:
- The actual refactoring of the above scripts (#30947, #30951, #30968, ...)
- Wishlist item: `sage -package list --not-source=pip :optional: :experimental:` (would simplify `bootstrap`)



CC:  @seblabbe @tobiasdiez @slel @jhpalmieri @vbraun

Reviewer: Sébastien Labbé

Author: Matthias Koeppe

Branch: f33c3635ba36440b260644c127dcc94e12c3ab40

Dependencies: #30648

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/30865





---

archive/issue_comments_604475.json:
```json
{
    "body": "<a id='comment:1'></a>\nDevelopers interested in improving the system package advice may want to work on this ticket",
    "created_at": "2020-11-05T18:27:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604475",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>
Developers interested in improving the system package advice may want to work on this ticket



---

archive/issue_comments_604476.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2020-11-19T17:58:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604476",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_comments_604477.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -6,7 +6,12 @@\n - `tox.ini` (for `local-homebrew`, `local-conda`)\n - `.github/workflows/ci-wsl.yml` (using powershell)\n \n-The purpose of this ticket is to refactor it by reimplementing it as a new Python module of the `sage_bootstrap` package.\n+The purpose of this ticket is to refactor it by extending the `sage_bootstrap` package.\n \n \n+To run the testsuite of `sage_bootstrap`, use\n \n+```\n+  (cd build && tox)\n+```\n+\n``````\n",
    "created_at": "2020-11-19T17:58:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604477",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -6,7 +6,12 @@
 - `tox.ini` (for `local-homebrew`, `local-conda`)
 - `.github/workflows/ci-wsl.yml` (using powershell)
 
-The purpose of this ticket is to refactor it by reimplementing it as a new Python module of the `sage_bootstrap` package.
+The purpose of this ticket is to refactor it by extending the `sage_bootstrap` package.
 
 
+To run the testsuite of `sage_bootstrap`, use
 
+```
+  (cd build && tox)
+```
+
``````




---

archive/issue_events_098665.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "rename": {
        "from": "sage_bootstrap: Implement system package tools",
        "to": "sage_bootstrap: Update/extend system package tools"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30865#event-98665"
}
```



---

archive/issue_comments_604478.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/sage_bootstrap__update_extend_system_package_tools\"",
    "created_at": "2020-11-19T18:04:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604478",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/sage_bootstrap__update_extend_system_package_tools"



---

archive/issue_comments_604479.json:
```json
{
    "body": "<a id='comment:4'></a>\nNew commits:\n|                                                                                                                                          |                                                                                       |\n|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------|\n|[2265048](https://github.com/sagemath/sagetrac-mirror/commit/226504812ada55ed17c0d7c2578ec579ac101b4d)|`sage_bootstrap.package: Handle non-normal packages (which have no checksums.ini etc.)`|\n|[c405d10](https://github.com/sagemath/sagetrac-mirror/commit/c405d1026b35e181f114ebffb4b4452a0b22b75b)|`sage_bootstrap.package.Package._init_type: Do not accept 'script' or 'pip' any more`|",
    "created_at": "2020-11-19T18:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604479",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>
New commits:
|                                                                                                                                          |                                                                                       |
|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------|
|[2265048](https://github.com/sagemath/sagetrac-mirror/commit/226504812ada55ed17c0d7c2578ec579ac101b4d)|`sage_bootstrap.package: Handle non-normal packages (which have no checksums.ini etc.)`|
|[c405d10](https://github.com/sagemath/sagetrac-mirror/commit/c405d1026b35e181f114ebffb4b4452a0b22b75b)|`sage_bootstrap.package.Package._init_type: Do not accept 'script' or 'pip' any more`|



---

archive/issue_comments_604480.json:
```json
{
    "body": "Changing commit from \"\" to \"c405d1026b35e181f114ebffb4b4452a0b22b75b\"",
    "created_at": "2020-11-19T18:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604480",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "" to "c405d1026b35e181f114ebffb4b4452a0b22b75b"



---

archive/issue_comments_604481.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -7,7 +7,13 @@\n - `.github/workflows/ci-wsl.yml` (using powershell)\n \n The purpose of this ticket is to refactor it by extending the `sage_bootstrap` package.\n-\n+- We update `sage_bootstrap.package` so that it understands non-normal packages (i.e., script and pip packages, which do not have `checksums.ini`)\n+- We change `sage -package list` so it supports the following invocations:\n+  - `sage -package list :standard: :optional:` (several \"classes\" (types), not just one)\n+  - `sage -package list --has-file=spkg-configure.m4 :standard:` (needed for `bootstrap`, `src/doc/bootstrap`)\n+  - `sage -package list --has-file=spkg-configure.m4 --has-file=distros/debian.txt :standard: :optional:` (needed for `build/bin/write-dockerfile.sh`, `tox.ini`)\n+  - `sage -package list --has-file=SPKG.rst :all:` (needed for `src/doc/bootstrap`)\n+  - `sage -package list --not-source=pip :optional: :experimental:` (needed for `bootstrap`)\n \n To run the testsuite of `sage_bootstrap`, use\n \n``````\n",
    "created_at": "2020-11-19T18:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604481",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -7,7 +7,13 @@
 - `.github/workflows/ci-wsl.yml` (using powershell)
 
 The purpose of this ticket is to refactor it by extending the `sage_bootstrap` package.
-
+- We update `sage_bootstrap.package` so that it understands non-normal packages (i.e., script and pip packages, which do not have `checksums.ini`)
+- We change `sage -package list` so it supports the following invocations:
+  - `sage -package list :standard: :optional:` (several "classes" (types), not just one)
+  - `sage -package list --has-file=spkg-configure.m4 :standard:` (needed for `bootstrap`, `src/doc/bootstrap`)
+  - `sage -package list --has-file=spkg-configure.m4 --has-file=distros/debian.txt :standard: :optional:` (needed for `build/bin/write-dockerfile.sh`, `tox.ini`)
+  - `sage -package list --has-file=SPKG.rst :all:` (needed for `src/doc/bootstrap`)
+  - `sage -package list --not-source=pip :optional: :experimental:` (needed for `bootstrap`)
 
 To run the testsuite of `sage_bootstrap`, use
 
``````




---

archive/issue_comments_604482.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#30648\"",
    "created_at": "2020-11-19T18:56:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604482",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "" to "#30648"



---

archive/issue_comments_604483.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -14,6 +14,8 @@\n   - `sage -package list --has-file=spkg-configure.m4 --has-file=distros/debian.txt :standard: :optional:` (needed for `build/bin/write-dockerfile.sh`, `tox.ini`)\n   - `sage -package list --has-file=SPKG.rst :all:` (needed for `src/doc/bootstrap`)\n   - `sage -package list --not-source=pip :optional: :experimental:` (needed for `bootstrap`)\n+- We fix and extend `sage -package download` likewise (follow up from #30648) so it (again) supports\n+  - `sage -package download :all:`\n \n To run the testsuite of `sage_bootstrap`, use\n \n``````\n",
    "created_at": "2020-11-19T19:02:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604483",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -14,6 +14,8 @@
   - `sage -package list --has-file=spkg-configure.m4 --has-file=distros/debian.txt :standard: :optional:` (needed for `build/bin/write-dockerfile.sh`, `tox.ini`)
   - `sage -package list --has-file=SPKG.rst :all:` (needed for `src/doc/bootstrap`)
   - `sage -package list --not-source=pip :optional: :experimental:` (needed for `bootstrap`)
+- We fix and extend `sage -package download` likewise (follow up from #30648) so it (again) supports
+  - `sage -package download :all:`
 
 To run the testsuite of `sage_bootstrap`, use
 
``````




---

archive/issue_comments_604484.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -14,8 +14,9 @@\n   - `sage -package list --has-file=spkg-configure.m4 --has-file=distros/debian.txt :standard: :optional:` (needed for `build/bin/write-dockerfile.sh`, `tox.ini`)\n   - `sage -package list --has-file=SPKG.rst :all:` (needed for `src/doc/bootstrap`)\n   - `sage -package list --not-source=pip :optional: :experimental:` (needed for `bootstrap`)\n-- We fix and extend `sage -package download` likewise (follow up from #30648) so it (again) supports\n-  - `sage -package download :all:`\n+- We fix and extend `sage -package download` likewise (follow up from #30648) so it supports\n+  - `sage -package download :all:` (again - was broken)\n+  - `sage -package download --allow-upstream :all:` (allows retrieving from `upstream_url`)\n \n To run the testsuite of `sage_bootstrap`, use\n \n``````\n",
    "created_at": "2020-11-19T19:07:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604484",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -14,8 +14,9 @@
   - `sage -package list --has-file=spkg-configure.m4 --has-file=distros/debian.txt :standard: :optional:` (needed for `build/bin/write-dockerfile.sh`, `tox.ini`)
   - `sage -package list --has-file=SPKG.rst :all:` (needed for `src/doc/bootstrap`)
   - `sage -package list --not-source=pip :optional: :experimental:` (needed for `bootstrap`)
-- We fix and extend `sage -package download` likewise (follow up from #30648) so it (again) supports
-  - `sage -package download :all:`
+- We fix and extend `sage -package download` likewise (follow up from #30648) so it supports
+  - `sage -package download :all:` (again - was broken)
+  - `sage -package download --allow-upstream :all:` (allows retrieving from `upstream_url`)
 
 To run the testsuite of `sage_bootstrap`, use
 
``````




---

archive/issue_comments_604485.json:
```json
{
    "body": "Changing commit from \"c405d1026b35e181f114ebffb4b4452a0b22b75b\" to \"3f9131304c9d0f93b76e6d85f1cbddb4be2e8c9c\"",
    "created_at": "2020-11-19T20:12:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604485",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c405d1026b35e181f114ebffb4b4452a0b22b75b" to "3f9131304c9d0f93b76e6d85f1cbddb4be2e8c9c"



---

archive/issue_comments_604486.json:
```json
{
    "body": "<a id='comment:8'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                 |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------|\n|[e463513](https://github.com/sagemath/sagetrac-mirror/commit/e4635137337490ce452945728c8667f3f51b5b40)|`30648: download_cls -> download`|\n|[0b343d1](https://github.com/sagemath/sagetrac-mirror/commit/0b343d135cc8a5e8eb91e91cc4f35418f21aa037)|`Merge commit 'e4635137337490ce452945728c8667f3f51b5b40' of git://trac.sagemath.org/sage into t/30865/sage_bootstrap__update_extend_system_package_tools`|\n|[5fc8441](https://github.com/sagemath/sagetrac-mirror/commit/5fc844185e5bdfe6a5aa788f60ee08fa6798a0fe)|`sage_bootstrap.app.Application.download_cls: Pass allow_upstream to download`|\n|[794a15c](https://github.com/sagemath/sagetrac-mirror/commit/794a15cee2cb02110cbc0b0a10a6922665245601)|`sage_bootstrap.cndline: Back to using download_cls`|\n|[6369bb4](https://github.com/sagemath/sagetrac-mirror/commit/6369bb4b7467333285cd418bc85e09b9cddb297a)|`sage -package list: Handle --has-file, multiple package classes (types)`|\n|[4fbf753](https://github.com/sagemath/sagetrac-mirror/commit/4fbf753a72bed9f8a945718a2d1421ff0359cc3d)|`src/doc/en/installation/source.rst: Remove outdated documentation on old-style packages`|\n|[7082715](https://github.com/sagemath/sagetrac-mirror/commit/70827151aaa338fdff4c476f0f99ef6fea263e87)|`Makefile: Update documentation of 'make download'`|\n|[3f91313](https://github.com/sagemath/sagetrac-mirror/commit/3f9131304c9d0f93b76e6d85f1cbddb4be2e8c9c)|`src/bin/sage-download-upstream: Remove, use 'sage --package download' instead`|",
    "created_at": "2020-11-19T20:12:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604486",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                 |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------|
|[e463513](https://github.com/sagemath/sagetrac-mirror/commit/e4635137337490ce452945728c8667f3f51b5b40)|`30648: download_cls -> download`|
|[0b343d1](https://github.com/sagemath/sagetrac-mirror/commit/0b343d135cc8a5e8eb91e91cc4f35418f21aa037)|`Merge commit 'e4635137337490ce452945728c8667f3f51b5b40' of git://trac.sagemath.org/sage into t/30865/sage_bootstrap__update_extend_system_package_tools`|
|[5fc8441](https://github.com/sagemath/sagetrac-mirror/commit/5fc844185e5bdfe6a5aa788f60ee08fa6798a0fe)|`sage_bootstrap.app.Application.download_cls: Pass allow_upstream to download`|
|[794a15c](https://github.com/sagemath/sagetrac-mirror/commit/794a15cee2cb02110cbc0b0a10a6922665245601)|`sage_bootstrap.cndline: Back to using download_cls`|
|[6369bb4](https://github.com/sagemath/sagetrac-mirror/commit/6369bb4b7467333285cd418bc85e09b9cddb297a)|`sage -package list: Handle --has-file, multiple package classes (types)`|
|[4fbf753](https://github.com/sagemath/sagetrac-mirror/commit/4fbf753a72bed9f8a945718a2d1421ff0359cc3d)|`src/doc/en/installation/source.rst: Remove outdated documentation on old-style packages`|
|[7082715](https://github.com/sagemath/sagetrac-mirror/commit/70827151aaa338fdff4c476f0f99ef6fea263e87)|`Makefile: Update documentation of 'make download'`|
|[3f91313](https://github.com/sagemath/sagetrac-mirror/commit/3f9131304c9d0f93b76e6d85f1cbddb4be2e8c9c)|`src/bin/sage-download-upstream: Remove, use 'sage --package download' instead`|



---

archive/issue_comments_604487.json:
```json
{
    "body": "<a id='comment:9'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                     |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------|\n|[69f7ea8](https://github.com/sagemath/sagetrac-mirror/commit/69f7ea84ec245d5f4229121e5923d2f3544462ce)|`sage_bootstrap.PackageClass: Accept several arguments, simplify use`|\n|[40d6604](https://github.com/sagemath/sagetrac-mirror/commit/40d6604247dd78c7158f37dfcb3c7a27977358be)|`sage_bootstrap.package.Package.has_file: New, use it`|\n|[6475263](https://github.com/sagemath/sagetrac-mirror/commit/6475263f75d73b3c18e4f6797d198a632f3e5660)|`sage_bootstrap.PackageClass: Handle filter has_files, simplify use`|\n|[769f635](https://github.com/sagemath/sagetrac-mirror/commit/769f635e3458c161aab71404b5c0e25c5f7a350e)|`sage_bootstrap.tarball: Raise an error if attempting to download a tarball of a non-normal package`|\n|[f6b79bb](https://github.com/sagemath/sagetrac-mirror/commit/f6b79bbc89bfe65a166dc0855ab62f93f90b7b88)|`sage_bootstrap.app.download_cls: Only attempt to download tarballs for normal packages (with checksums.ini)`|",
    "created_at": "2020-11-19T20:42:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604487",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                     |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------|
|[69f7ea8](https://github.com/sagemath/sagetrac-mirror/commit/69f7ea84ec245d5f4229121e5923d2f3544462ce)|`sage_bootstrap.PackageClass: Accept several arguments, simplify use`|
|[40d6604](https://github.com/sagemath/sagetrac-mirror/commit/40d6604247dd78c7158f37dfcb3c7a27977358be)|`sage_bootstrap.package.Package.has_file: New, use it`|
|[6475263](https://github.com/sagemath/sagetrac-mirror/commit/6475263f75d73b3c18e4f6797d198a632f3e5660)|`sage_bootstrap.PackageClass: Handle filter has_files, simplify use`|
|[769f635](https://github.com/sagemath/sagetrac-mirror/commit/769f635e3458c161aab71404b5c0e25c5f7a350e)|`sage_bootstrap.tarball: Raise an error if attempting to download a tarball of a non-normal package`|
|[f6b79bb](https://github.com/sagemath/sagetrac-mirror/commit/f6b79bbc89bfe65a166dc0855ab62f93f90b7b88)|`sage_bootstrap.app.download_cls: Only attempt to download tarballs for normal packages (with checksums.ini)`|



---

archive/issue_comments_604488.json:
```json
{
    "body": "Changing commit from \"3f9131304c9d0f93b76e6d85f1cbddb4be2e8c9c\" to \"f6b79bbc89bfe65a166dc0855ab62f93f90b7b88\"",
    "created_at": "2020-11-19T20:42:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604488",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "3f9131304c9d0f93b76e6d85f1cbddb4be2e8c9c" to "f6b79bbc89bfe65a166dc0855ab62f93f90b7b88"



---

archive/issue_comments_604489.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -13,10 +13,10 @@\n   - `sage -package list --has-file=spkg-configure.m4 :standard:` (needed for `bootstrap`, `src/doc/bootstrap`)\n   - `sage -package list --has-file=spkg-configure.m4 --has-file=distros/debian.txt :standard: :optional:` (needed for `build/bin/write-dockerfile.sh`, `tox.ini`)\n   - `sage -package list --has-file=SPKG.rst :all:` (needed for `src/doc/bootstrap`)\n-  - `sage -package list --not-source=pip :optional: :experimental:` (needed for `bootstrap`)\n-- We fix and extend `sage -package download` likewise (follow up from #30648) so it supports\n+- We fix and extend `sage -package download` (follow up from #30648) so it supports\n   - `sage -package download :all:` (again - was broken)\n   - `sage -package download --allow-upstream :all:` (allows retrieving from `upstream_url`)\n+  and use it for `make download` (#29896).\n \n To run the testsuite of `sage_bootstrap`, use\n \n@@ -24,3 +24,6 @@\n   (cd build && tox)\n ```\n \n+Follow-up wishlist item:\n+- `sage -package list --not-source=pip :optional: :experimental:` (would simplify `bootstrap`)\n+\n``````\n",
    "created_at": "2020-11-19T20:43:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604489",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -13,10 +13,10 @@
   - `sage -package list --has-file=spkg-configure.m4 :standard:` (needed for `bootstrap`, `src/doc/bootstrap`)
   - `sage -package list --has-file=spkg-configure.m4 --has-file=distros/debian.txt :standard: :optional:` (needed for `build/bin/write-dockerfile.sh`, `tox.ini`)
   - `sage -package list --has-file=SPKG.rst :all:` (needed for `src/doc/bootstrap`)
-  - `sage -package list --not-source=pip :optional: :experimental:` (needed for `bootstrap`)
-- We fix and extend `sage -package download` likewise (follow up from #30648) so it supports
+- We fix and extend `sage -package download` (follow up from #30648) so it supports
   - `sage -package download :all:` (again - was broken)
   - `sage -package download --allow-upstream :all:` (allows retrieving from `upstream_url`)
+  and use it for `make download` (#29896).
 
 To run the testsuite of `sage_bootstrap`, use
 
@@ -24,3 +24,6 @@
   (cd build && tox)
 ```
 
+Follow-up wishlist item:
+- `sage -package list --not-source=pip :optional: :experimental:` (would simplify `bootstrap`)
+
``````




---

archive/issue_comments_604490.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-11-19T20:43:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604490",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_604491.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,10 +1,14 @@\n (from #29146, #30861)\n \n There are several places where the system package information (`build/pkgs/*/distros/*.txt`) is parsed:\n+- `bootstrap`\n+- `src/doc/bootstrap`\n - `build/bin/write_dockerfile.sh`\n - `build/bin/sage-get-system-packages`\n - `tox.ini` (for `local-homebrew`, `local-conda`)\n - `.github/workflows/ci-wsl.yml` (using powershell)\n+- `src/bin/sage-download-upstream`\n+- `m4/sage_spkg_*.m4`\n \n The purpose of this ticket is to refactor it by extending the `sage_bootstrap` package.\n - We update `sage_bootstrap.package` so that it understands non-normal packages (i.e., script and pip packages, which do not have `checksums.ini`)\n@@ -16,7 +20,7 @@\n - We fix and extend `sage -package download` (follow up from #30648) so it supports\n   - `sage -package download :all:` (again - was broken)\n   - `sage -package download --allow-upstream :all:` (allows retrieving from `upstream_url`)\n-  and use it for `make download` (#29896).\n+  and use it for `make download` (#29896), removing `src/bin/sage-download-upstream`\n \n To run the testsuite of `sage_bootstrap`, use\n \n``````\n",
    "created_at": "2020-11-19T20:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604491",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,10 +1,14 @@
 (from #29146, #30861)
 
 There are several places where the system package information (`build/pkgs/*/distros/*.txt`) is parsed:
+- `bootstrap`
+- `src/doc/bootstrap`
 - `build/bin/write_dockerfile.sh`
 - `build/bin/sage-get-system-packages`
 - `tox.ini` (for `local-homebrew`, `local-conda`)
 - `.github/workflows/ci-wsl.yml` (using powershell)
+- `src/bin/sage-download-upstream`
+- `m4/sage_spkg_*.m4`
 
 The purpose of this ticket is to refactor it by extending the `sage_bootstrap` package.
 - We update `sage_bootstrap.package` so that it understands non-normal packages (i.e., script and pip packages, which do not have `checksums.ini`)
@@ -16,7 +20,7 @@
 - We fix and extend `sage -package download` (follow up from #30648) so it supports
   - `sage -package download :all:` (again - was broken)
   - `sage -package download --allow-upstream :all:` (allows retrieving from `upstream_url`)
-  and use it for `make download` (#29896).
+  and use it for `make download` (#29896), removing `src/bin/sage-download-upstream`
 
 To run the testsuite of `sage_bootstrap`, use
 
``````




---

archive/issue_comments_604492.json:
```json
{
    "body": "<a id='comment:12'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                               |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|\n|[4be654b](https://github.com/sagemath/sagetrac-mirror/commit/4be654b22e7961c615b8103bad5c1f8832e18482)|`sage_bootstrap.cmdline: Initialize has_files filter correctly`|",
    "created_at": "2020-11-19T20:54:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604492",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                               |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|
|[4be654b](https://github.com/sagemath/sagetrac-mirror/commit/4be654b22e7961c615b8103bad5c1f8832e18482)|`sage_bootstrap.cmdline: Initialize has_files filter correctly`|



---

archive/issue_comments_604493.json:
```json
{
    "body": "Changing commit from \"f6b79bbc89bfe65a166dc0855ab62f93f90b7b88\" to \"4be654b22e7961c615b8103bad5c1f8832e18482\"",
    "created_at": "2020-11-19T20:54:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604493",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "f6b79bbc89bfe65a166dc0855ab62f93f90b7b88" to "4be654b22e7961c615b8103bad5c1f8832e18482"



---

archive/issue_comments_604494.json:
```json
{
    "body": "<a id='comment:13'></a>\nReady for review",
    "created_at": "2020-11-19T20:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604494",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>
Ready for review



---

archive/issue_comments_604495.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -10,7 +10,7 @@\n - `src/bin/sage-download-upstream`\n - `m4/sage_spkg_*.m4`\n \n-The purpose of this ticket is to refactor it by extending the `sage_bootstrap` package.\n+The purpose of this ticket is to prepare refactoring of this code by extending the `sage_bootstrap` package.\n - We update `sage_bootstrap.package` so that it understands non-normal packages (i.e., script and pip packages, which do not have `checksums.ini`)\n - We change `sage -package list` so it supports the following invocations:\n   - `sage -package list :standard: :optional:` (several \"classes\" (types), not just one)\n@@ -28,6 +28,10 @@\n   (cd build && tox)\n ```\n \n-Follow-up wishlist item:\n-- `sage -package list --not-source=pip :optional: :experimental:` (would simplify `bootstrap`)\n \n+\n+Follow-up:\n+- The actual refactoring of the above scripts\n+- Wishlist item: `sage -package list --not-source=pip :optional: :experimental:` (would simplify `bootstrap`)\n+\n+\n``````\n",
    "created_at": "2020-11-19T20:56:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604495",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -10,7 +10,7 @@
 - `src/bin/sage-download-upstream`
 - `m4/sage_spkg_*.m4`
 
-The purpose of this ticket is to refactor it by extending the `sage_bootstrap` package.
+The purpose of this ticket is to prepare refactoring of this code by extending the `sage_bootstrap` package.
 - We update `sage_bootstrap.package` so that it understands non-normal packages (i.e., script and pip packages, which do not have `checksums.ini`)
 - We change `sage -package list` so it supports the following invocations:
   - `sage -package list :standard: :optional:` (several "classes" (types), not just one)
@@ -28,6 +28,10 @@
   (cd build && tox)
 ```
 
-Follow-up wishlist item:
-- `sage -package list --not-source=pip :optional: :experimental:` (would simplify `bootstrap`)
 
+
+Follow-up:
+- The actual refactoring of the above scripts
+- Wishlist item: `sage -package list --not-source=pip :optional: :experimental:` (would simplify `bootstrap`)
+
+
``````




---

archive/issue_comments_604496.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n (from #29146, #30861)\n \n-There are several places where the system package information (`build/pkgs/*/distros/*.txt`) is parsed:\n+There are several places where the spkg (`build/pkgs/*/`) and system package information (`build/pkgs/*/distros/*.txt`) is parsed:\n - `bootstrap`\n - `src/doc/bootstrap`\n - `build/bin/write_dockerfile.sh`\n``````\n",
    "created_at": "2020-11-19T20:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604496",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 (from #29146, #30861)
 
-There are several places where the system package information (`build/pkgs/*/distros/*.txt`) is parsed:
+There are several places where the spkg (`build/pkgs/*/`) and system package information (`build/pkgs/*/distros/*.txt`) is parsed:
 - `bootstrap`
 - `src/doc/bootstrap`
 - `build/bin/write_dockerfile.sh`
``````




---

archive/issue_events_098666.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "rename": {
        "from": "sage_bootstrap: Update/extend system package tools",
        "to": "sage_bootstrap: Update/extend \"sage -package\", fix \"make download\""
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30865#event-98666"
}
```



---

archive/issue_comments_604497.json:
```json
{
    "body": "<a id='comment:16'></a>\nThe current branch is doing this:\n\n```diff\n-    def download_cls(self, package_name_or_class):\n+    def download_cls(self, package_name_or_class, allow_upstream=False):\n```\n\nSo should the change I made in #30648 be reverted then?\n\n(I recall that the problem fixed in #30648 was that `download_cls` method had no argument `allow_upstream` where `download` method did, so I changed `download_cls` to `download`. But at the time, I was wondering if that was the good fix. Because another fix could have been to add the `allow_upstream` argument to the `download_cls` method which you are doing in this branch)",
    "created_at": "2020-11-22T09:18:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604497",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:16'></a>
The current branch is doing this:

```diff
-    def download_cls(self, package_name_or_class):
+    def download_cls(self, package_name_or_class, allow_upstream=False):
```

So should the change I made in #30648 be reverted then?

(I recall that the problem fixed in #30648 was that `download_cls` method had no argument `allow_upstream` where `download` method did, so I changed `download_cls` to `download`. But at the time, I was wondering if that was the good fix. Because another fix could have been to add the `allow_upstream` argument to the `download_cls` method which you are doing in this branch)



---

archive/issue_comments_604498.json:
```json
{
    "body": "<a id='comment:17'></a>\nDoing `+=` on lists creates a new list in memory as opposed to `append` or `extend`:\n\n```\nsage: L = list(range(10))                                                       \nsage: K = list('abcd')                                                          \nsage: id(L)                                                                     \n140556349258880\nsage: id(L+K)                                                                   \n140556349147776\nsage: L.extend(K)                                                               \nsage: id(L)                                                                     \n140556349258880\n```\nSo using `+=` to append elements to a list uses a quadratic amount of memory until the garbage collector gets called.\n\nSo I would suggest the following change:\n\n```diff\n- self.names += [package_name_or_class]\n+ self.names.append(package_name_or_class)\n```\n\nas well as (5 times):\n\n```diff\n- self.names += [pkg.name for pkg in Package.all() if predicate(pkg)]\n+ self.names.extend(pkg.name for pkg in Package.all() if predicate(pkg))\n```",
    "created_at": "2020-11-22T09:49:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604498",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:17'></a>
Doing `+=` on lists creates a new list in memory as opposed to `append` or `extend`:

```
sage: L = list(range(10))                                                       
sage: K = list('abcd')                                                          
sage: id(L)                                                                     
140556349258880
sage: id(L+K)                                                                   
140556349147776
sage: L.extend(K)                                                               
sage: id(L)                                                                     
140556349258880
```
So using `+=` to append elements to a list uses a quadratic amount of memory until the garbage collector gets called.

So I would suggest the following change:

```diff
- self.names += [package_name_or_class]
+ self.names.append(package_name_or_class)
```

as well as (5 times):

```diff
- self.names += [pkg.name for pkg in Package.all() if predicate(pkg)]
+ self.names.extend(pkg.name for pkg in Package.all() if predicate(pkg))
```



---

archive/issue_comments_604499.json:
```json
{
    "body": "<a id='comment:18'></a>\nI will try the branch later today, and come back with further comments if I have.",
    "created_at": "2020-11-22T09:50:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604499",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:18'></a>
I will try the branch later today, and come back with further comments if I have.



---

archive/issue_comments_604500.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [slabbe](#comment%3A16):\n> The current branch is doing this:\n> \n> ```\n> #!diff\n> -    def download_cls(self, package_name_or_class):\n> +    def download_cls(self, package_name_or_class, allow_upstream=False):\n> ```\n> \n> So should the change I made in #30648 be reverted then?\n\n\nYes, in fact I have already reverted it as part of the branch on this ticket.",
    "created_at": "2020-11-22T20:25:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604500",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'></a>
Replying to [slabbe](#comment%3A16):
> The current branch is doing this:
> 
> ```
> #!diff
> -    def download_cls(self, package_name_or_class):
> +    def download_cls(self, package_name_or_class, allow_upstream=False):
> ```
> 
> So should the change I made in #30648 be reverted then?


Yes, in fact I have already reverted it as part of the branch on this ticket.



---

archive/issue_comments_604501.json:
```json
{
    "body": "Changing commit from \"4be654b22e7961c615b8103bad5c1f8832e18482\" to \"b762c3dfee999746ad0b8507460178ee6a63966b\"",
    "created_at": "2020-11-22T20:28:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604501",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "4be654b22e7961c615b8103bad5c1f8832e18482" to "b762c3dfee999746ad0b8507460178ee6a63966b"



---

archive/issue_comments_604502.json:
```json
{
    "body": "<a id='comment:20'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                           |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------|\n|[b762c3d](https://github.com/sagemath/sagetrac-mirror/commit/b762c3dfee999746ad0b8507460178ee6a63966b)|`sage_bootstrap.expand_class: Use .append, .extend instead of += for lists`|",
    "created_at": "2020-11-22T20:28:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604502",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                           |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------|
|[b762c3d](https://github.com/sagemath/sagetrac-mirror/commit/b762c3dfee999746ad0b8507460178ee6a63966b)|`sage_bootstrap.expand_class: Use .append, .extend instead of += for lists`|



---

archive/issue_comments_604503.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -31,7 +31,7 @@\n \n \n Follow-up:\n-- The actual refactoring of the above scripts\n+- The actual refactoring of the above scripts (#30947, ...)\n - Wishlist item: `sage -package list --not-source=pip :optional: :experimental:` (would simplify `bootstrap`)\n \n \n``````\n",
    "created_at": "2020-11-22T20:58:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604503",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -31,7 +31,7 @@
 
 
 Follow-up:
-- The actual refactoring of the above scripts
+- The actual refactoring of the above scripts (#30947, ...)
 - Wishlist item: `sage -package list --not-source=pip :optional: :experimental:` (would simplify `bootstrap`)
 
 
``````




---

archive/issue_comments_604504.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -31,7 +31,7 @@\n \n \n Follow-up:\n-- The actual refactoring of the above scripts (#30947, ...)\n+- The actual refactoring of the above scripts (#30947, #30951, ...)\n - Wishlist item: `sage -package list --not-source=pip :optional: :experimental:` (would simplify `bootstrap`)\n \n \n``````\n",
    "created_at": "2020-11-23T02:29:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604504",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -31,7 +31,7 @@
 
 
 Follow-up:
-- The actual refactoring of the above scripts (#30947, ...)
+- The actual refactoring of the above scripts (#30947, #30951, ...)
 - Wishlist item: `sage -package list --not-source=pip :optional: :experimental:` (would simplify `bootstrap`)
 
 
``````




---

archive/issue_comments_604505.json:
```json
{
    "body": "<a id='comment:23'></a>\nReplying to [mkoeppe](#comment%3A19):\n> Yes, in fact I have already reverted it as part of the branch on this ticket.\n\n\nOk, yes, I agree. Since #30648 is not in sage yet, this is why I don't see it in the diff.",
    "created_at": "2020-11-23T08:35:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604505",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:23'></a>
Replying to [mkoeppe](#comment%3A19):
> Yes, in fact I have already reverted it as part of the branch on this ticket.


Ok, yes, I agree. Since #30648 is not in sage yet, this is why I don't see it in the diff.



---

archive/issue_comments_604506.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-11-23T09:51:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604506",
    "user": "https://github.com/seblabbe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_604507.json:
```json
{
    "body": "<a id='comment:24'></a>\n> (cd build && tox)\n\n\nI did that. It finishes with a big list of typos and says that there were errors while running the tests. When I scroll back, I can't see the errors, because the typos takes all of the lines in the finite history of the terminal. Are the output of tox logged somewhere?\n\nI find it weird to call it `class` of package and use `cls` (which is often use for representing a Python class. Maybe `nature` of the package? Anyway, this is out of topic.\n\n(0) I confirm that `sage --package list` works with inputs such as \n`--has-file=spkg-configure.m4`, `--has-file=distros/debian.txt`, `--has-file=SPKG.rst`. Also `sage --package download` works. Also `make download` works.\n\nSorry, I still have few more comments listed below.\n\n(1) When I read the documentation of `sage --package`, I don't know what `Sage Bootstrap Library` means. I suggest to add a sentence in the file `sage_bootstrap.cmdline.py` to explain it. Something as follows, but please replace the verb `deal` with any more precise verb:\n\n```diff\n description = \\\n \"\"\"\n Sage Bootstrap Library\n+\n+It deals with all of the packages in SageMath.\n \"\"\"\n```\n\n(2) I don't like the following error message:\n\n```\n$ sage --package list :standardd:\nTraceback (most recent call last):\n  File \"/home/slabbe/GitBox/sage/build/bin/sage-package\", line 42, in <module>\n    run()\n  File \"/home/slabbe/GitBox/sage/build/bin/../sage_bootstrap/cmdline.py\", line 306, in run\n    app.list_cls(*args.package_class, has_files=args.has_files)\n  File \"/home/slabbe/GitBox/sage/build/bin/../sage_bootstrap/app.py\", line 69, in list_cls\n    pc = PackageClass(*package_classes, **filters)\n  File \"/home/slabbe/GitBox/sage/build/bin/../sage_bootstrap/expand_class.py\", line 48, in __init__\n    raise ValueError('Package name cannot start with \":\", got %s', package_name_or_class)\nValueError: ('Package name cannot start with \":\", got %s', ':standardd:')\n```\n\nIt tells me the input cannot start with \":\", but this is false, as `:standard:` is accepted.\n\nThus, I would suggest the following change in `sage_bootstrap/expand_class.py`:\n\n```diff\n             else:\n-                if package_name_or_class.startswith(':'):\n-                    raise ValueError('Package name cannot start with \":\", got %s', package_name_or_class)\n-                if package_name_or_class.endswith(':'):\n-                    raise ValueError('Package name cannot end with \":\", got %s', package_name_or_class)\n+                if package_name_or_class.startswith(':') or package_name_or_class.endswith(':'):\n+                    raise ValueError('Valid package classes are :all:, :standard:, :optional:, :experimental: or :huge:, got %s', package_name_or_class)\n                 self.names.append(package_name_or_class)\n```\n\nQuestion: do you confirm that the following is a desirable feature?\n\n```\n$ sage --package list pari\npari\n```\n\n(3) Finally, in `build/sage_bootstrap/package.py`, I suggest:\n\n```diff\n-        if pattern:\n-            return self.tarball_pattern.replace('VERSION', self.version)\n+        if pattern:\n+            return pattern.replace('VERSION', self.version)\n```\n\n(4) Question: What is the meaning of the expression `non-normal` in the file `build/sage_bootstrap/tarball.py` ?\n\nI am currently waiting for the report of `make ptestlong`.",
    "created_at": "2020-11-23T09:51:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604507",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:24'></a>
> (cd build && tox)


I did that. It finishes with a big list of typos and says that there were errors while running the tests. When I scroll back, I can't see the errors, because the typos takes all of the lines in the finite history of the terminal. Are the output of tox logged somewhere?

I find it weird to call it `class` of package and use `cls` (which is often use for representing a Python class. Maybe `nature` of the package? Anyway, this is out of topic.

(0) I confirm that `sage --package list` works with inputs such as 
`--has-file=spkg-configure.m4`, `--has-file=distros/debian.txt`, `--has-file=SPKG.rst`. Also `sage --package download` works. Also `make download` works.

Sorry, I still have few more comments listed below.

(1) When I read the documentation of `sage --package`, I don't know what `Sage Bootstrap Library` means. I suggest to add a sentence in the file `sage_bootstrap.cmdline.py` to explain it. Something as follows, but please replace the verb `deal` with any more precise verb:

```diff
 description = \
 """
 Sage Bootstrap Library
+
+It deals with all of the packages in SageMath.
 """
```

(2) I don't like the following error message:

```
$ sage --package list :standardd:
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/build/bin/sage-package", line 42, in <module>
    run()
  File "/home/slabbe/GitBox/sage/build/bin/../sage_bootstrap/cmdline.py", line 306, in run
    app.list_cls(*args.package_class, has_files=args.has_files)
  File "/home/slabbe/GitBox/sage/build/bin/../sage_bootstrap/app.py", line 69, in list_cls
    pc = PackageClass(*package_classes, **filters)
  File "/home/slabbe/GitBox/sage/build/bin/../sage_bootstrap/expand_class.py", line 48, in __init__
    raise ValueError('Package name cannot start with ":", got %s', package_name_or_class)
ValueError: ('Package name cannot start with ":", got %s', ':standardd:')
```

It tells me the input cannot start with ":", but this is false, as `:standard:` is accepted.

Thus, I would suggest the following change in `sage_bootstrap/expand_class.py`:

```diff
             else:
-                if package_name_or_class.startswith(':'):
-                    raise ValueError('Package name cannot start with ":", got %s', package_name_or_class)
-                if package_name_or_class.endswith(':'):
-                    raise ValueError('Package name cannot end with ":", got %s', package_name_or_class)
+                if package_name_or_class.startswith(':') or package_name_or_class.endswith(':'):
+                    raise ValueError('Valid package classes are :all:, :standard:, :optional:, :experimental: or :huge:, got %s', package_name_or_class)
                 self.names.append(package_name_or_class)
```

Question: do you confirm that the following is a desirable feature?

```
$ sage --package list pari
pari
```

(3) Finally, in `build/sage_bootstrap/package.py`, I suggest:

```diff
-        if pattern:
-            return self.tarball_pattern.replace('VERSION', self.version)
+        if pattern:
+            return pattern.replace('VERSION', self.version)
```

(4) Question: What is the meaning of the expression `non-normal` in the file `build/sage_bootstrap/tarball.py` ?

I am currently waiting for the report of `make ptestlong`.



---

archive/issue_comments_604508.json:
```json
{
    "body": "<a id='comment:25'></a>\nThe `make ptestlong` finished with:\n\n```\n----------------------------------------------------------------------\nsage -t --long --random-seed=0 src/sage/interfaces/singular.py  # Killed due to segmentation fault\n----------------------------------------------------------------------\n```\nwhich is unrelated to this ticket.",
    "created_at": "2020-11-23T09:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604508",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:25'></a>
The `make ptestlong` finished with:

```
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/interfaces/singular.py  # Killed due to segmentation fault
----------------------------------------------------------------------
```
which is unrelated to this ticket.



---

archive/issue_comments_604509.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [slabbe](#comment%3A25):\n> The `make ptestlong` finished with:\n> \n> ```\n> ----------------------------------------------------------------------\n> sage -t --long --random-seed=0 src/sage/interfaces/singular.py  # Killed due to segmentation fault\n> ----------------------------------------------------------------------\n> ```\n> which is unrelated to this ticket.\n\n\nIndeed that is different, and tracked at #30945.",
    "created_at": "2020-11-23T11:54:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604509",
    "user": "https://github.com/slel"
}
```

<a id='comment:26'></a>
Replying to [slabbe](#comment%3A25):
> The `make ptestlong` finished with:
> 
> ```
> ----------------------------------------------------------------------
> sage -t --long --random-seed=0 src/sage/interfaces/singular.py  # Killed due to segmentation fault
> ----------------------------------------------------------------------
> ```
> which is unrelated to this ticket.


Indeed that is different, and tracked at #30945.



---

archive/issue_comments_604510.json:
```json
{
    "body": "Changing reviewer from \"\" to \"S\u00e9bastien Labb\u00e9\"",
    "created_at": "2020-11-23T14:41:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604510",
    "user": "https://github.com/seblabbe"
}
```

Changing reviewer from "" to "Sébastien Labbé"



---

archive/issue_comments_604511.json:
```json
{
    "body": "<a id='comment:28'></a>\nReplying to [slabbe](#comment%3A24):\n> > (cd build && tox)\n\n> \n> I did that. It finishes with a big list of typos \n\n\nIf it shows typos, then you probably ran `sage -tox`, not `tox`. If you don't have tox in your global environment, you can use `(cd build && sage -sh -c tox)`.\n\n> Are the output of tox logged somewhere?\n\n\nYes, it creates a subdirectory `.tox`, where you'll find logs.",
    "created_at": "2020-11-23T18:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604511",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:28'></a>
Replying to [slabbe](#comment%3A24):
> > (cd build && tox)

> 
> I did that. It finishes with a big list of typos 


If it shows typos, then you probably ran `sage -tox`, not `tox`. If you don't have tox in your global environment, you can use `(cd build && sage -sh -c tox)`.

> Are the output of tox logged somewhere?


Yes, it creates a subdirectory `.tox`, where you'll find logs.



---

archive/issue_comments_604512.json:
```json
{
    "body": "<a id='comment:29'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                  |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|\n|[51db2a9](https://github.com/sagemath/sagetrac-mirror/commit/51db2a9e3bbbe730846c00831991a3e7b8ff5b31)|`sage_bootstrap: Eliminate terminology 'package class' in help and error messages`|",
    "created_at": "2020-11-23T19:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604512",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:29'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                  |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|
|[51db2a9](https://github.com/sagemath/sagetrac-mirror/commit/51db2a9e3bbbe730846c00831991a3e7b8ff5b31)|`sage_bootstrap: Eliminate terminology 'package class' in help and error messages`|



---

archive/issue_comments_604513.json:
```json
{
    "body": "Changing commit from \"b762c3dfee999746ad0b8507460178ee6a63966b\" to \"51db2a9e3bbbe730846c00831991a3e7b8ff5b31\"",
    "created_at": "2020-11-23T19:01:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604513",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "b762c3dfee999746ad0b8507460178ee6a63966b" to "51db2a9e3bbbe730846c00831991a3e7b8ff5b31"



---

archive/issue_comments_604514.json:
```json
{
    "body": "<a id='comment:30'></a>\nReplying to [slabbe](#comment%3A24):\n> I find it weird to call it `class` of package and use `cls` (which is often use for representing a Python class. Maybe `nature` of the package? Anyway, this is out of topic.\n\n\nI agree. I have now made a change to eliminate this (unexplained) terminology from user-facing messages.  But I haven't changed the class name `PackageClass` or argument names, to keep the diff small.",
    "created_at": "2020-11-23T19:04:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604514",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'></a>
Replying to [slabbe](#comment%3A24):
> I find it weird to call it `class` of package and use `cls` (which is often use for representing a Python class. Maybe `nature` of the package? Anyway, this is out of topic.


I agree. I have now made a change to eliminate this (unexplained) terminology from user-facing messages.  But I haven't changed the class name `PackageClass` or argument names, to keep the diff small.



---

archive/issue_comments_604515.json:
```json
{
    "body": "<a id='comment:31'></a>\nReplying to [slabbe](#comment%3A24):\n> (4) Question: What is the meaning of the expression `non-normal` in the file `build/sage_bootstrap/tarball.py` ?\n\n\nThis is referring to https://doc.sagemath.org/html/en/developer/packaging.html#package-source-types",
    "created_at": "2020-11-23T19:05:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604515",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:31'></a>
Replying to [slabbe](#comment%3A24):
> (4) Question: What is the meaning of the expression `non-normal` in the file `build/sage_bootstrap/tarball.py` ?


This is referring to https://doc.sagemath.org/html/en/developer/packaging.html#package-source-types



---

archive/issue_comments_604516.json:
```json
{
    "body": "<a id='comment:32'></a>\nReplying to [slabbe](#comment%3A24):\n> I would suggest the following change in `sage_bootstrap/expand_class.py`:\n> \n> \n> ```\n> #!diff\n>              else:\n> -                if package_name_or_class.startswith(':'):\n> -                    raise ValueError('Package name cannot start with \":\", got %s', package_name_or_class)\n> -                if package_name_or_class.endswith(':'):\n> -                    raise ValueError('Package name cannot end with \":\", got %s', package_name_or_class)\n> +                if package_name_or_class.startswith(':') or package_name_or_class.endswith(':'):\n> +                    raise ValueError('Valid package classes are :all:, :standard:, :optional:, :experimental: or :huge:, got %s', package_name_or_class)\n>                  self.names.append(package_name_or_class)\n> ```\n\n\nI have made a similar change in the above commit.\n\n> Question: do you confirm that the following is a desirable feature?\n> \n> ```\n> $ sage --package list pari\n> pari\n> ```\n\n\nYes, this is a feature, and the above commit documents it.",
    "created_at": "2020-11-23T19:07:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604516",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:32'></a>
Replying to [slabbe](#comment%3A24):
> I would suggest the following change in `sage_bootstrap/expand_class.py`:
> 
> 
> ```
> #!diff
>              else:
> -                if package_name_or_class.startswith(':'):
> -                    raise ValueError('Package name cannot start with ":", got %s', package_name_or_class)
> -                if package_name_or_class.endswith(':'):
> -                    raise ValueError('Package name cannot end with ":", got %s', package_name_or_class)
> +                if package_name_or_class.startswith(':') or package_name_or_class.endswith(':'):
> +                    raise ValueError('Valid package classes are :all:, :standard:, :optional:, :experimental: or :huge:, got %s', package_name_or_class)
>                  self.names.append(package_name_or_class)
> ```


I have made a similar change in the above commit.

> Question: do you confirm that the following is a desirable feature?
> 
> ```
> $ sage --package list pari
> pari
> ```


Yes, this is a feature, and the above commit documents it.



---

archive/issue_comments_604517.json:
```json
{
    "body": "Changing commit from \"51db2a9e3bbbe730846c00831991a3e7b8ff5b31\" to \"c0a0329d842ad8745789f8bf61bc456f0473e1fe\"",
    "created_at": "2020-11-23T19:19:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604517",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "51db2a9e3bbbe730846c00831991a3e7b8ff5b31" to "c0a0329d842ad8745789f8bf61bc456f0473e1fe"



---

archive/issue_comments_604518.json:
```json
{
    "body": "<a id='comment:33'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                            |\n|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------|\n|[c0a0329](https://github.com/sagemath/sagetrac-mirror/commit/c0a0329d842ad8745789f8bf61bc456f0473e1fe)|`sage_bootstrap.cmdline: Expand description`|",
    "created_at": "2020-11-23T19:19:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604518",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                            |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------|
|[c0a0329](https://github.com/sagemath/sagetrac-mirror/commit/c0a0329d842ad8745789f8bf61bc456f0473e1fe)|`sage_bootstrap.cmdline: Expand description`|



---

archive/issue_comments_604519.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-11-23T19:20:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604519",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_604520.json:
```json
{
    "body": "<a id='comment:35'></a>\nReplying to [mkoeppe](#comment%3A28):\n> If it shows typos, then you probably ran `sage -tox`, not `tox`. If you don't have tox in your global environment, you can use `(cd build && sage -sh -c tox)`.\n\n\nWell, I first did `sudo apt install tox` on a Ubuntu 18.04 but, then I got problems because that tox is using python2. So, your guess is right, that was after the run of `sage -tox`.\n \n> > Are the output of tox logged somewhere?\n\n> \n> Yes, it creates a subdirectory `.tox`, where you'll find logs.\n\n\nGreat. Thank you.",
    "created_at": "2020-11-23T21:48:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604520",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:35'></a>
Replying to [mkoeppe](#comment%3A28):
> If it shows typos, then you probably ran `sage -tox`, not `tox`. If you don't have tox in your global environment, you can use `(cd build && sage -sh -c tox)`.


Well, I first did `sudo apt install tox` on a Ubuntu 18.04 but, then I got problems because that tox is using python2. So, your guess is right, that was after the run of `sage -tox`.
 
> > Are the output of tox logged somewhere?

> 
> Yes, it creates a subdirectory `.tox`, where you'll find logs.


Great. Thank you.



---

archive/issue_comments_604521.json:
```json
{
    "body": "<a id='comment:36'></a>\nThanks for the answers and commits, I will check this tomorrow morning Bordeaux time.\n\n[I think my comment (3) is still not fixed (well, it is just a small detail).]",
    "created_at": "2020-11-23T21:53:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604521",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:36'></a>
Thanks for the answers and commits, I will check this tomorrow morning Bordeaux time.

[I think my comment (3) is still not fixed (well, it is just a small detail).]



---

archive/issue_comments_604522.json:
```json
{
    "body": "<a id='comment:37'></a>\nReplying to [slabbe](#comment%3A35):\n> I first did `sudo apt install tox` on a Ubuntu 18.04 but, then I got problems because that tox is using python2. \n\n\nThat should actually work too.  `sage_bootstrap` is designed to work on a wide range of Python versions including 2.x.  `tox` provisions virtual environments to test the package with each available Python version.  To run it with a specific Python version, you can do `tox -e py37` etc. It does not matter on what version of Python tox itself runs.",
    "created_at": "2020-11-23T23:25:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604522",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:37'></a>
Replying to [slabbe](#comment%3A35):
> I first did `sudo apt install tox` on a Ubuntu 18.04 but, then I got problems because that tox is using python2. 


That should actually work too.  `sage_bootstrap` is designed to work on a wide range of Python versions including 2.x.  `tox` provisions virtual environments to test the package with each available Python version.  To run it with a specific Python version, you can do `tox -e py37` etc. It does not matter on what version of Python tox itself runs.



---

archive/issue_comments_604523.json:
```json
{
    "body": "Changing commit from \"c0a0329d842ad8745789f8bf61bc456f0473e1fe\" to \"f33c3635ba36440b260644c127dcc94e12c3ab40\"",
    "created_at": "2020-11-23T23:28:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604523",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c0a0329d842ad8745789f8bf61bc456f0473e1fe" to "f33c3635ba36440b260644c127dcc94e12c3ab40"



---

archive/issue_comments_604524.json:
```json
{
    "body": "<a id='comment:38'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                               |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|\n|[f33c363](https://github.com/sagemath/sagetrac-mirror/commit/f33c3635ba36440b260644c127dcc94e12c3ab40)|`sage_bootstrap.package.Package.tarball_pattern: Simplify code`|",
    "created_at": "2020-11-23T23:28:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604524",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:38'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                               |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|
|[f33c363](https://github.com/sagemath/sagetrac-mirror/commit/f33c3635ba36440b260644c127dcc94e12c3ab40)|`sage_bootstrap.package.Package.tarball_pattern: Simplify code`|



---

archive/issue_comments_604525.json:
```json
{
    "body": "<a id='comment:39'></a>\nReplying to [mkoeppe](#comment%3A37):\n> Replying to [slabbe](#comment%3A35):\n> > I first did `sudo apt install tox` on a Ubuntu 18.04 but, then I got problems because that tox is using python2. \n\n> \n> That should actually work too.  `sage_bootstrap` is designed to work on a wide range of Python versions including 2.x.  `tox` provisions virtual environments to test the package with each available Python version.  To run it with a specific Python version, you can do `tox -e py37` etc. It does not matter on what version of Python tox itself runs.\n\n\nOk, I see. But after `cd build`, the tox command prints few lines and seems to get stuck:\n\n```\n$ cd build\n$ tox\nGLOB sdist-make: /home/slabbe/GitBox/sage/build/setup.py\npy26 create: /home/slabbe/GitBox/sage/build/.tox/py26\nERROR: InterpreterNotFound: python2.6\npy27 create: /home/slabbe/GitBox/sage/build/.tox/py27\npy27 inst: /home/slabbe/GitBox/sage/build/.tox/dist/sage_bootstrap-1.0.zip\npy27 installed: DEPRECATION: Python 2.7 reached the end of its life on January 1st, 2020. Please upgrade your Python as Python 2.7 is no longer maintained. pip 21.0 will drop support for Python 2.7 in January 2021. More details about Python 2 support in pip can be found at https://pip.pypa.io/en/latest/development/release-process/#python-2-support pip 21.0 will remove support for this functionality.,pkg-resources==0.0.0,sage-bootstrap @ file:///home/slabbe/GitBox/sage/build/.tox/dist/sage_bootstrap-1.0.zip\npy27 runtests: PYTHONHASHSEED='3230691582'\npy27 runtests: commands[0] | python2.7 -m unittest discover\n......\n```",
    "created_at": "2020-11-24T08:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604525",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:39'></a>
Replying to [mkoeppe](#comment%3A37):
> Replying to [slabbe](#comment%3A35):
> > I first did `sudo apt install tox` on a Ubuntu 18.04 but, then I got problems because that tox is using python2. 

> 
> That should actually work too.  `sage_bootstrap` is designed to work on a wide range of Python versions including 2.x.  `tox` provisions virtual environments to test the package with each available Python version.  To run it with a specific Python version, you can do `tox -e py37` etc. It does not matter on what version of Python tox itself runs.


Ok, I see. But after `cd build`, the tox command prints few lines and seems to get stuck:

```
$ cd build
$ tox
GLOB sdist-make: /home/slabbe/GitBox/sage/build/setup.py
py26 create: /home/slabbe/GitBox/sage/build/.tox/py26
ERROR: InterpreterNotFound: python2.6
py27 create: /home/slabbe/GitBox/sage/build/.tox/py27
py27 inst: /home/slabbe/GitBox/sage/build/.tox/dist/sage_bootstrap-1.0.zip
py27 installed: DEPRECATION: Python 2.7 reached the end of its life on January 1st, 2020. Please upgrade your Python as Python 2.7 is no longer maintained. pip 21.0 will drop support for Python 2.7 in January 2021. More details about Python 2 support in pip can be found at https://pip.pypa.io/en/latest/development/release-process/#python-2-support pip 21.0 will remove support for this functionality.,pkg-resources==0.0.0,sage-bootstrap @ file:///home/slabbe/GitBox/sage/build/.tox/dist/sage_bootstrap-1.0.zip
py27 runtests: PYTHONHASHSEED='3230691582'
py27 runtests: commands[0] | python2.7 -m unittest discover
......
```



---

archive/issue_comments_604526.json:
```json
{
    "body": "<a id='comment:40'></a>\nActually, it did not get stuck, but I obtain three errors after few minutes:\n\n```\n$ tox\nGLOB sdist-make: /home/slabbe/GitBox/sage/build/setup.py\npy26 create: /home/slabbe/GitBox/sage/build/.tox/py26\nERROR: InterpreterNotFound: python2.6\npy27 create: /home/slabbe/GitBox/sage/build/.tox/py27\npy27 inst: /home/slabbe/GitBox/sage/build/.tox/dist/sage_bootstrap-1.0.zip\npy27 installed: DEPRECATION: Python 2.7 reached the end of its life on January 1st, 2020. Please upgrade your Python as Python 2.7 is no longer maintained. pip 21.0 will drop support for Python 2.7 in January 2021. More details about Python 2 support in pip can be found at https://pip.pypa.io/en/latest/development/release-process/#python-2-support pip 21.0 will remove support for this functionality.,pkg-resources==0.0.0,sage-bootstrap @ file:///home/slabbe/GitBox/sage/build/.tox/dist/sage_bootstrap-1.0.zip\npy27 runtests: PYTHONHASHSEED='3230691582'\npy27 runtests: commands[0] | python2.7 -m unittest discover\n......FF..............[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]\n[......................................................................]\n......F........ERROR [package|all:249]: Failed to open pari\n..\n======================================================================\nFAIL: test_error (test.test_download.DownloadTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/slabbe/GitBox/sage/build/test/test_download.py\", line 49, in test_error\n    self.assertIsNotFoundError(log.messages())\n  File \"/home/slabbe/GitBox/sage/build/test/test_download.py\", line 64, in assertIsNotFoundError\n    \"[Errno 404] Not Found: '//files.sagemath.org/sage_bootstrap/this_url_does_not_exist'\"))\nAssertionError: False is not true\n\n======================================================================\nFAIL: test_ignore_errors (test.test_download.DownloadTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/slabbe/GitBox/sage/build/test/test_download.py\", line 57, in test_ignore_errors\n    self.assertIsNotFoundError(log.messages())\n  File \"/home/slabbe/GitBox/sage/build/test/test_download.py\", line 64, in assertIsNotFoundError\n    \"[Errno 404] Not Found: '//files.sagemath.org/sage_bootstrap/this_url_does_not_exist'\"))\nAssertionError: False is not true\n\n======================================================================\nFAIL: test_checksum (test.test_tarball.TarballTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/slabbe/GitBox/sage/build/test/test_tarball.py\", line 59, in test_checksum\n    '[......................................................................]\\n')\nAssertionError: '[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]\\n[......................................................................]\\n' != '[......................................................................]\\n'\n\n----------------------------------------------------------------------\nRan 39 tests in 228.835s\n\nFAILED (failures=3)\n```\n\nAfter that it seems tox does the same with other version of Python it finds on the system. With python 3.6, it returns two errors instead of three (the `test_checksum` does not fail).\n\nLet me now check whether this is related to the current ticket or not by rerunning it after a `git checkout develop`.",
    "created_at": "2020-11-24T08:11:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604526",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:40'></a>
Actually, it did not get stuck, but I obtain three errors after few minutes:

```
$ tox
GLOB sdist-make: /home/slabbe/GitBox/sage/build/setup.py
py26 create: /home/slabbe/GitBox/sage/build/.tox/py26
ERROR: InterpreterNotFound: python2.6
py27 create: /home/slabbe/GitBox/sage/build/.tox/py27
py27 inst: /home/slabbe/GitBox/sage/build/.tox/dist/sage_bootstrap-1.0.zip
py27 installed: DEPRECATION: Python 2.7 reached the end of its life on January 1st, 2020. Please upgrade your Python as Python 2.7 is no longer maintained. pip 21.0 will drop support for Python 2.7 in January 2021. More details about Python 2 support in pip can be found at https://pip.pypa.io/en/latest/development/release-process/#python-2-support pip 21.0 will remove support for this functionality.,pkg-resources==0.0.0,sage-bootstrap @ file:///home/slabbe/GitBox/sage/build/.tox/dist/sage_bootstrap-1.0.zip
py27 runtests: PYTHONHASHSEED='3230691582'
py27 runtests: commands[0] | python2.7 -m unittest discover
......FF..............[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]
[......................................................................]
......F........ERROR [package|all:249]: Failed to open pari
..
======================================================================
FAIL: test_error (test.test_download.DownloadTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 49, in test_error
    self.assertIsNotFoundError(log.messages())
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 64, in assertIsNotFoundError
    "[Errno 404] Not Found: '//files.sagemath.org/sage_bootstrap/this_url_does_not_exist'"))
AssertionError: False is not true

======================================================================
FAIL: test_ignore_errors (test.test_download.DownloadTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 57, in test_ignore_errors
    self.assertIsNotFoundError(log.messages())
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 64, in assertIsNotFoundError
    "[Errno 404] Not Found: '//files.sagemath.org/sage_bootstrap/this_url_does_not_exist'"))
AssertionError: False is not true

======================================================================
FAIL: test_checksum (test.test_tarball.TarballTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/build/test/test_tarball.py", line 59, in test_checksum
    '[......................................................................]\n')
AssertionError: '[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]\n[......................................................................]\n' != '[......................................................................]\n'

----------------------------------------------------------------------
Ran 39 tests in 228.835s

FAILED (failures=3)
```

After that it seems tox does the same with other version of Python it finds on the system. With python 3.6, it returns two errors instead of three (the `test_checksum` does not fail).

Let me now check whether this is related to the current ticket or not by rerunning it after a `git checkout develop`.



---

archive/issue_comments_604527.json:
```json
{
    "body": "<a id='comment:41'></a>\nI also get errors with 9.3.beta1, but not exactly the same. `test_ignore_errors` and `test_error`  both fails as with the branch. But `test_download` fails only on 9.3.beta1 whereas `test_checksum` fails only with the current branch.\n\n```\n======================================================================\nFAIL: test_error (test.test_download.DownloadTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/slabbe/GitBox/sage/build/test/test_download.py\", line 49, in test_error\n    self.assertIsNotFoundError(log.messages())\n  File \"/home/slabbe/GitBox/sage/build/test/test_download.py\", line 63, in assertIsNotFoundError\n    self.assertTrue(messages[0][1].endswith(\nAssertionError: False is not true\n\n======================================================================\nFAIL: test_ignore_errors (test.test_download.DownloadTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/slabbe/GitBox/sage/build/test/test_download.py\", line 57, in test_ignore_errors\n    self.assertIsNotFoundError(log.messages())\n  File \"/home/slabbe/GitBox/sage/build/test/test_download.py\", line 63, in assertIsNotFoundError\n    self.assertTrue(messages[0][1].endswith(\nAssertionError: False is not true\n\n======================================================================\nFAIL: test_download (test.test_package_cmdline.SagePackageTestCase)\n----------------------------------------------------------------------\nTraceback (most recent call last):\n  File \"/home/slabbe/GitBox/sage/build/test/test_package_cmdline.py\", line 115, in test_download\n    self.assertTrue(stderr.startswith('Using cached file'))\nAssertionError: False is not true\n\n----------------------------------------------------------------------\nRan 39 tests in 134.424s\n\nFAILED (failures=3)\n```\n\nI don't know how much this is related to the current ticket. From my point of view, I give a positive review to the commits done up to now.\n\nMatthias, I let you change the status to positive review if you think the tox issues are unrelated or if they can be dealt in another ticket.",
    "created_at": "2020-11-24T08:32:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604527",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:41'></a>
I also get errors with 9.3.beta1, but not exactly the same. `test_ignore_errors` and `test_error`  both fails as with the branch. But `test_download` fails only on 9.3.beta1 whereas `test_checksum` fails only with the current branch.

```
======================================================================
FAIL: test_error (test.test_download.DownloadTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 49, in test_error
    self.assertIsNotFoundError(log.messages())
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 63, in assertIsNotFoundError
    self.assertTrue(messages[0][1].endswith(
AssertionError: False is not true

======================================================================
FAIL: test_ignore_errors (test.test_download.DownloadTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 57, in test_ignore_errors
    self.assertIsNotFoundError(log.messages())
  File "/home/slabbe/GitBox/sage/build/test/test_download.py", line 63, in assertIsNotFoundError
    self.assertTrue(messages[0][1].endswith(
AssertionError: False is not true

======================================================================
FAIL: test_download (test.test_package_cmdline.SagePackageTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/slabbe/GitBox/sage/build/test/test_package_cmdline.py", line 115, in test_download
    self.assertTrue(stderr.startswith('Using cached file'))
AssertionError: False is not true

----------------------------------------------------------------------
Ran 39 tests in 134.424s

FAILED (failures=3)
```

I don't know how much this is related to the current ticket. From my point of view, I give a positive review to the commits done up to now.

Matthias, I let you change the status to positive review if you think the tox issues are unrelated or if they can be dealt in another ticket.



---

archive/issue_comments_604528.json:
```json
{
    "body": "<a id='comment:42'></a>\nThank you!\n\n(I also get the additional `test_checksum` failure on this branch. This test only passes on a release tag; this is not specific to this ticket. The other failures, also not specific to this ticket, should be investigated on a separate ticket.)",
    "created_at": "2020-11-24T17:28:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604528",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:42'></a>
Thank you!

(I also get the additional `test_checksum` failure on this branch. This test only passes on a release tag; this is not specific to this ticket. The other failures, also not specific to this ticket, should be investigated on a separate ticket.)



---

archive/issue_comments_604529.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-11-24T17:28:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604529",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_604530.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -31,7 +31,7 @@\n \n \n Follow-up:\n-- The actual refactoring of the above scripts (#30947, #30951, ...)\n+- The actual refactoring of the above scripts (#30947, #30951, #30968, ...)\n - Wishlist item: `sage -package list --not-source=pip :optional: :experimental:` (would simplify `bootstrap`)\n \n \n``````\n",
    "created_at": "2020-11-27T04:05:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604530",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -31,7 +31,7 @@
 
 
 Follow-up:
-- The actual refactoring of the above scripts (#30947, #30951, ...)
+- The actual refactoring of the above scripts (#30947, #30951, #30968, ...)
 - Wishlist item: `sage -package list --not-source=pip :optional: :experimental:` (would simplify `bootstrap`)
 
 
``````




---

archive/issue_comments_604531.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/sage_bootstrap__update_extend_system_package_tools\" to \"f33c3635ba36440b260644c127dcc94e12c3ab40\"",
    "created_at": "2020-11-29T11:57:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604531",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mkoeppe/sage_bootstrap__update_extend_system_package_tools" to "f33c3635ba36440b260644c127dcc94e12c3ab40"



---

archive/issue_comments_604532.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-11-29T11:57:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604532",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_098667.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-11-29T11:57:50Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30865#event-98667"
}
```



---

archive/issue_comments_604533.json:
```json
{
    "body": "<a id='comment:45'></a>\nI tried `make download` and it failed to download scipoptsuite.\n\nWhich is expected. Indeed, reading from the last scipoptsuite ticket:\n\n- #24662: Upgrade scipoptsuite to 5.0.1\n\n> Upstream archive: <snip>\n> (DO NOT put on sage servers -- we cannot redistribute this archive)\n\n\nHow do we deal with that?",
    "created_at": "2020-12-10T02:18:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604533",
    "user": "https://github.com/slel"
}
```

<a id='comment:45'></a>
I tried `make download` and it failed to download scipoptsuite.

Which is expected. Indeed, reading from the last scipoptsuite ticket:

- #24662: Upgrade scipoptsuite to 5.0.1

> Upstream archive: <snip>
> (DO NOT put on sage servers -- we cannot redistribute this archive)


How do we deal with that?



---

archive/issue_comments_604534.json:
```json
{
    "body": "Changing commit from \"f33c3635ba36440b260644c127dcc94e12c3ab40\" to \"\"",
    "created_at": "2020-12-10T02:18:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604534",
    "user": "https://github.com/slel"
}
```

Changing commit from "f33c3635ba36440b260644c127dcc94e12c3ab40" to ""



---

archive/issue_comments_604535.json:
```json
{
    "body": "<a id='comment:46'></a>\nReplying to [slelievre](#comment%3A45):\n> > (DO NOT put on sage servers -- we cannot redistribute this archive)\n\n> \n> How do we deal with that?\n\n\nLet's discuss this on #31034",
    "created_at": "2020-12-10T03:20:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30865",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30865#issuecomment-604535",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:46'></a>
Replying to [slelievre](#comment%3A45):
> > (DO NOT put on sage servers -- we cannot redistribute this archive)

> 
> How do we deal with that?


Let's discuss this on #31034
