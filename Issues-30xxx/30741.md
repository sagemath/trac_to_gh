# Issue 30741: Refactor to break cyclic import in complex numbers

archive/issues_030504.json:
```json
{
    "assignees": [],
    "body": "Importing `complex_mpfr` does currently not work without previously importing `sage.all`. This is because of a couple of cyclic imports (e.g. `complex_number` -> `complex_double` -> `complex_number`).\n\nIn this ticket, we break these cyclic imports by narrowing down some of the global module imports to local function-wide imports. This was not possible in the case of the `CCtoCDF` class, since there `ComplexDoubleElement` is cimported, which has to be done on the module level. I've hence extracted this class to a new module `complex_conversion.pyx`.\n\nWith these changes, the executing the following code\n\n```\nfrom sage.rings.complex_mpfr import ComplexField\nprint(ComplexField())\n```\nusing `./venv/bin/python3` works. Previously, it failed with \n\n```\n  File \"/home/tobias/sage/src/test.py\", line 1, in <module>\n    from sage.rings.complex_mpfr import ComplexField\n  File \"sage/rings/complex_mpfr.pyx\", line 1, in init sage.rings.complex_mpfr\n  File \"sage/rings/real_mpfr.pyx\", line 1, in init sage.rings.real_mpfr\n  File \"sage/libs/mpmath/utils.pyx\", line 17, in init sage.libs.mpmath.utils\nImportError: cannot import name ComplexField\n```\n\nDepends on #32612\nDepends on #32610\nDepends on #32174\n\nCC:  @mkoeppe @tscrim @antonio-rojas\n\nBranch/Commit: **[401fee5](https://github.com/sagemath/sagetrac-mirror/commit/401fee537e209218e4e6795fd2522e5f1817e46a)**\n\nReviewer: **Matthias Koeppe**\n\nAuthor: **Tobias Diez**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/30741_\n\n",
    "closed_at": "2021-12-19T11:47:53Z",
    "created_at": "2020-10-07T18:22:49Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/refactoring",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.5",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Refactor to break cyclic import in complex numbers",
    "type": "issue",
    "updated_at": "2021-12-19T11:47:53Z",
    "url": "https://github.com/sagemath/sage/issues/30741",
    "user": "https://github.com/tobiasdiez"
}
```
Importing `complex_mpfr` does currently not work without previously importing `sage.all`. This is because of a couple of cyclic imports (e.g. `complex_number` -> `complex_double` -> `complex_number`).

In this ticket, we break these cyclic imports by narrowing down some of the global module imports to local function-wide imports. This was not possible in the case of the `CCtoCDF` class, since there `ComplexDoubleElement` is cimported, which has to be done on the module level. I've hence extracted this class to a new module `complex_conversion.pyx`.

With these changes, the executing the following code

```
from sage.rings.complex_mpfr import ComplexField
print(ComplexField())
```
using `./venv/bin/python3` works. Previously, it failed with 

```
  File "/home/tobias/sage/src/test.py", line 1, in <module>
    from sage.rings.complex_mpfr import ComplexField
  File "sage/rings/complex_mpfr.pyx", line 1, in init sage.rings.complex_mpfr
  File "sage/rings/real_mpfr.pyx", line 1, in init sage.rings.real_mpfr
  File "sage/libs/mpmath/utils.pyx", line 17, in init sage.libs.mpmath.utils
ImportError: cannot import name ComplexField
```

Depends on #32612
Depends on #32610
Depends on #32174

CC:  @mkoeppe @tscrim @antonio-rojas

Branch/Commit: **[401fee5](https://github.com/sagemath/sagetrac-mirror/commit/401fee537e209218e4e6795fd2522e5f1817e46a)**

Reviewer: **Matthias Koeppe**

Author: **Tobias Diez**

_Issue created by migration from https://trac.sagemath.org/ticket/30741_





---

archive/issue_events_405712.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-10-07T18:22:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405712"
}
```



---

archive/issue_events_405713.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-10-07T18:22:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "label": "https://github.com/sagemath/sage/labels/refactoring",
    "label_color": "696969",
    "label_name": "refactoring",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405713"
}
```



---

archive/issue_events_405714.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-10-07T18:22:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405714"
}
```



---

archive/issue_events_405715.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-10-07T18:22:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405715"
}
```



---

archive/issue_events_405716.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-10-07T18:22:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405716"
}
```



---

archive/issue_comments_494182.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nChanges of this type need careful review regarding possible performance penalties from the import",
    "created_at": "2020-10-07T18:39:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494182",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'>Comment 2:</a>
Changes of this type need careful review regarding possible performance penalties from the import



---

archive/issue_comments_494183.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nInstead of\n\n```\n+            from sage.rings.complex_conversion import CCtoCDF\n+            return CCtoCDF(S, self)\n```\nWhy don't you add a proper `.pxd` file and does a `cimport` at module level?",
    "created_at": "2020-10-10T21:22:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494183",
    "user": "https://github.com/videlec"
}
```

<a id='comment:3'>Comment 3:</a>
Instead of

```
+            from sage.rings.complex_conversion import CCtoCDF
+            return CCtoCDF(S, self)
```
Why don't you add a proper `.pxd` file and does a `cimport` at module level?



---

archive/issue_comments_494184.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nA module level `cipmort CCtoCDF` would lead again to a circular import: complex_double -> complex_conversion (for CCtoCDF) -> complex_double (for ComplexDoubleElement).",
    "created_at": "2020-10-11T10:56:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494184",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:4'>Comment 4:</a>
A module level `cipmort CCtoCDF` would lead again to a circular import: complex_double -> complex_conversion (for CCtoCDF) -> complex_double (for ComplexDoubleElement).



---

archive/issue_comments_494185.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nReplying to [@tobiasdiez](#comment%3A4):\n> A module level `cipmort CCtoCDF` would lead again to a circular import: complex_double -> complex_conversion (for CCtoCDF) -> complex_double (for ComplexDoubleElement). \n\n`cimport` does **not** trigger the Python module import (the things in the `.pyx`). It is just reading the corresponding `.pxd` file.\n\nEDIT: and it is perfectly fine to have circular imports here as these are guarded with macros at the C level",
    "created_at": "2020-10-11T11:10:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494185",
    "user": "https://github.com/videlec"
}
```

<a id='comment:5'>Comment 5:</a>
Replying to [@tobiasdiez](#comment%3A4):
> A module level `cipmort CCtoCDF` would lead again to a circular import: complex_double -> complex_conversion (for CCtoCDF) -> complex_double (for ComplexDoubleElement). 

`cimport` does **not** trigger the Python module import (the things in the `.pyx`). It is just reading the corresponding `.pxd` file.

EDIT: and it is perfectly fine to have circular imports here as these are guarded with macros at the C level



---

archive/issue_events_405717.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405717"
}
```



---

archive/issue_events_405718.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405718"
}
```



---

archive/issue_events_405719.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T23:09:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405719"
}
```



---

archive/issue_events_405720.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T23:09:59Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405720"
}
```



---

archive/issue_comments_494186.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nSetting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494186",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'>Comment 8:</a>
Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_405721.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405721"
}
```



---

archive/issue_events_405722.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405722"
}
```



---

archive/issue_comments_494187.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nSetting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494187",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'>Comment 9:</a>
Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_events_405723.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405723"
}
```



---

archive/issue_events_405724.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405724"
}
```



---

archive/issue_comments_494188.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cf611048ff9d8c502372124298fa39edef577dba\">cf61104</a></td><td><code>Merge branch 'develop' of git://github.com/sagemath/sage into public/refactoring/complexCycle</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/381dc6775681d03335473fccab218ddece3f9c54\">381dc67</a></td><td><code>Add pxd file</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1d0d20ddde4e921c2f2160de465d6ffd09b7f7ea\">1d0d20d</a></td><td><code>Try global cimport</code></td></tr></table>\n",
    "created_at": "2021-10-18T23:16:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494188",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:10'>Comment 10:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cf611048ff9d8c502372124298fa39edef577dba">cf61104</a></td><td><code>Merge branch 'develop' of git://github.com/sagemath/sage into public/refactoring/complexCycle</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/381dc6775681d03335473fccab218ddece3f9c54">381dc67</a></td><td><code>Add pxd file</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1d0d20ddde4e921c2f2160de465d6ffd09b7f7ea">1d0d20d</a></td><td><code>Try global cimport</code></td></tr></table>




---

archive/issue_comments_494189.json:
```json
{
    "body": "Changed commit from **[8c220db](https://github.com/sagemath/sagetrac-mirror/commit/8c220dbf9c335dbd91050743720604c25f42116b)** to **[1d0d20d](https://github.com/sagemath/sagetrac-mirror/commit/1d0d20ddde4e921c2f2160de465d6ffd09b7f7ea)**",
    "created_at": "2021-10-18T23:16:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494189",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[8c220db](https://github.com/sagemath/sagetrac-mirror/commit/8c220dbf9c335dbd91050743720604c25f42116b)** to **[1d0d20d](https://github.com/sagemath/sagetrac-mirror/commit/1d0d20ddde4e921c2f2160de465d6ffd09b7f7ea)**



---

archive/issue_comments_494190.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nWith #32612 you can also use `isinstance(..., sage.rings.abc.ComplexIntervalField)` instead of using a local import",
    "created_at": "2021-10-18T23:24:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494190",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'>Comment 11:</a>
With #32612 you can also use `isinstance(..., sage.rings.abc.ComplexIntervalField)` instead of using a local import



---

archive/issue_comments_494191.json:
```json
{
    "body": "Changed commit from **[1d0d20d](https://github.com/sagemath/sagetrac-mirror/commit/1d0d20ddde4e921c2f2160de465d6ffd09b7f7ea)** to **[dfa1de0](https://github.com/sagemath/sagetrac-mirror/commit/dfa1de0aa95482f5cc181ff9ea86d47bfe0c8ffb)**",
    "created_at": "2021-10-18T23:34:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494191",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[1d0d20d](https://github.com/sagemath/sagetrac-mirror/commit/1d0d20ddde4e921c2f2160de465d6ffd09b7f7ea)** to **[dfa1de0](https://github.com/sagemath/sagetrac-mirror/commit/dfa1de0aa95482f5cc181ff9ea86d47bfe0c8ffb)**



---

archive/issue_comments_494192.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dfa1de0aa95482f5cc181ff9ea86d47bfe0c8ffb\">dfa1de0</a></td><td><code>Use sage.rings.abc.ComplexIntervalField instead of soon-deprecated class</code></td></tr></table>\n",
    "created_at": "2021-10-18T23:34:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494192",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:12'>Comment 12:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dfa1de0aa95482f5cc181ff9ea86d47bfe0c8ffb">dfa1de0</a></td><td><code>Use sage.rings.abc.ComplexIntervalField instead of soon-deprecated class</code></td></tr></table>




---

archive/issue_comments_494193.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nReplying to [@mkoeppe](#comment%3A11):\n> With #32612 you can also use `isinstance(..., sage.rings.abc.ComplexIntervalField)` instead of using a local import\n\nThanks for the pointer! Done",
    "created_at": "2021-10-18T23:34:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494193",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:13'>Comment 13:</a>
Replying to [@mkoeppe](#comment%3A11):
> With #32612 you can also use `isinstance(..., sage.rings.abc.ComplexIntervalField)` instead of using a local import

Thanks for the pointer! Done



---

archive/issue_comments_494194.json:
```json
{
    "body": "Dependencies: **#32612**",
    "created_at": "2021-10-18T23:34:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494194",
    "user": "https://github.com/tobiasdiez"
}
```

Dependencies: **#32612**



---

archive/issue_comments_494195.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3f2d873dd3d43ea9403dcec8879c03500ed01b20\">3f2d873</a></td><td><code>Merge branch 'develop' of git://github.com/sagemath/sage into public/refactoring/complexCycle</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/acf57b5ac084863e88559c4db68320ff2333a8ea\">acf57b5</a></td><td><code>Fix typo</code></td></tr></table>\n",
    "created_at": "2021-10-21T07:57:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494195",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:15'>Comment 15:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3f2d873dd3d43ea9403dcec8879c03500ed01b20">3f2d873</a></td><td><code>Merge branch 'develop' of git://github.com/sagemath/sage into public/refactoring/complexCycle</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/acf57b5ac084863e88559c4db68320ff2333a8ea">acf57b5</a></td><td><code>Fix typo</code></td></tr></table>




---

archive/issue_comments_494196.json:
```json
{
    "body": "Changed commit from **[dfa1de0](https://github.com/sagemath/sagetrac-mirror/commit/dfa1de0aa95482f5cc181ff9ea86d47bfe0c8ffb)** to **[acf57b5](https://github.com/sagemath/sagetrac-mirror/commit/acf57b5ac084863e88559c4db68320ff2333a8ea)**",
    "created_at": "2021-10-21T07:57:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494196",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[dfa1de0](https://github.com/sagemath/sagetrac-mirror/commit/dfa1de0aa95482f5cc181ff9ea86d47bfe0c8ffb)** to **[acf57b5](https://github.com/sagemath/sagetrac-mirror/commit/acf57b5ac084863e88559c4db68320ff2333a8ea)**



---

archive/issue_comments_494197.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nstill needs work or ready for review?",
    "created_at": "2021-10-21T17:17:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494197",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'>Comment 16:</a>
still needs work or ready for review?



---

archive/issue_comments_494198.json:
```json
{
    "body": "Changed commit from **[acf57b5](https://github.com/sagemath/sagetrac-mirror/commit/acf57b5ac084863e88559c4db68320ff2333a8ea)** to **[fb09fda](https://github.com/sagemath/sagetrac-mirror/commit/fb09fdaffba263b6ae023713498cbf75675cd079)**",
    "created_at": "2021-10-22T21:15:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494198",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[acf57b5](https://github.com/sagemath/sagetrac-mirror/commit/acf57b5ac084863e88559c4db68320ff2333a8ea)** to **[fb09fda](https://github.com/sagemath/sagetrac-mirror/commit/fb09fdaffba263b6ae023713498cbf75675cd079)**



---

archive/issue_comments_494199.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fb09fdaffba263b6ae023713498cbf75675cd079\">fb09fda</a></td><td><code>Fix up imports</code></td></tr></table>\n",
    "created_at": "2021-10-22T21:15:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494199",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:17'>Comment 17:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fb09fdaffba263b6ae023713498cbf75675cd079">fb09fda</a></td><td><code>Fix up imports</code></td></tr></table>




---

archive/issue_comments_494200.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nI've fixed the branch but does it actually solve anything?",
    "created_at": "2021-10-22T21:16:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494200",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'>Comment 18:</a>
I've fixed the branch but does it actually solve anything?



---

archive/issue_comments_494201.json:
```json
{
    "body": "Changed dependencies from **#32612** to **#32612, #32610**",
    "created_at": "2021-10-22T21:20:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494201",
    "user": "https://github.com/mkoeppe"
}
```

Changed dependencies from **#32612** to **#32612, #32610**



---

archive/issue_comments_494202.json:
```json
{
    "body": "<a id='comment:21'>Comment 21:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/55da35851678aa95041d4f781f710c7a95195387\">55da358</a></td><td><code>Merge branch 'develop' of https://github.com/sagemath/sage into public/refactoring/complexCycle</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/401fee537e209218e4e6795fd2522e5f1817e46a\">401fee5</a></td><td><code>Remove cycle around complex_double</code></td></tr></table>\n",
    "created_at": "2021-11-26T21:21:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494202",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:21'>Comment 21:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/55da35851678aa95041d4f781f710c7a95195387">55da358</a></td><td><code>Merge branch 'develop' of https://github.com/sagemath/sage into public/refactoring/complexCycle</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/401fee537e209218e4e6795fd2522e5f1817e46a">401fee5</a></td><td><code>Remove cycle around complex_double</code></td></tr></table>




---

archive/issue_comments_494203.json:
```json
{
    "body": "Changed commit from **[fb09fda](https://github.com/sagemath/sagetrac-mirror/commit/fb09fdaffba263b6ae023713498cbf75675cd079)** to **[401fee5](https://github.com/sagemath/sagetrac-mirror/commit/401fee537e209218e4e6795fd2522e5f1817e46a)**",
    "created_at": "2021-11-26T21:21:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494203",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[fb09fda](https://github.com/sagemath/sagetrac-mirror/commit/fb09fdaffba263b6ae023713498cbf75675cd079)** to **[401fee5](https://github.com/sagemath/sagetrac-mirror/commit/401fee537e209218e4e6795fd2522e5f1817e46a)**



---

archive/issue_events_405725.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2021-11-26T21:22:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405725"
}
```



---

archive/issue_events_405726.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2021-11-26T21:22:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405726"
}
```



---

archive/issue_comments_494204.json:
```json
{
    "body": "<a id='comment:22'>Comment 22:</a>\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/55da35851678aa95041d4f781f710c7a95195387\">55da358</a></td><td><code>Merge branch 'develop' of https://github.com/sagemath/sage into public/refactoring/complexCycle</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/401fee537e209218e4e6795fd2522e5f1817e46a\">401fee5</a></td><td><code>Remove cycle around complex_double</code></td></tr></table>\n",
    "created_at": "2021-11-26T21:22:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494204",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:22'>Comment 22:</a>
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/55da35851678aa95041d4f781f710c7a95195387">55da358</a></td><td><code>Merge branch 'develop' of https://github.com/sagemath/sage into public/refactoring/complexCycle</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/401fee537e209218e4e6795fd2522e5f1817e46a">401fee5</a></td><td><code>Remove cycle around complex_double</code></td></tr></table>




---

archive/issue_comments_494205.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,20 @@\n-Importing `complex_number` does currently not work without previously importing `sage.all`. This is because of a couple of cyclic imports (e.g. `complex_number` -> `complex_double` -> `complex_number`).\n+Importing `complex_mpfr` does currently not work without previously importing `sage.all`. This is because of a couple of cyclic imports (e.g. `complex_number` -> `complex_double` -> `complex_number`).\n \n In this ticket, we break these cyclic imports by narrowing down some of the global module imports to local function-wide imports. This was not possible in the case of the `CCtoCDF` class, since there `ComplexDoubleElement` is cimported, which has to be done on the module level. I've hence extracted this class to a new module `complex_conversion.pyx`.\n+\n+With these changes, the executing the following code\n+\n+```\n+from sage.rings.complex_mpfr import ComplexField\n+print(ComplexField())\n+```\n+using `./venv/bin/python3` works. Previously, it failed with \n+\n+```\n+  File \"/home/tobias/sage/src/test.py\", line 1, in <module>\n+    from sage.rings.complex_mpfr import ComplexField\n+  File \"sage/rings/complex_mpfr.pyx\", line 1, in init sage.rings.complex_mpfr\n+  File \"sage/rings/real_mpfr.pyx\", line 1, in init sage.rings.real_mpfr\n+  File \"sage/libs/mpmath/utils.pyx\", line 17, in init sage.libs.mpmath.utils\n+ImportError: cannot import name ComplexField\n+```\n``````\n",
    "created_at": "2021-11-26T21:22:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494205",
    "user": "https://github.com/tobiasdiez"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,20 @@
-Importing `complex_number` does currently not work without previously importing `sage.all`. This is because of a couple of cyclic imports (e.g. `complex_number` -> `complex_double` -> `complex_number`).
+Importing `complex_mpfr` does currently not work without previously importing `sage.all`. This is because of a couple of cyclic imports (e.g. `complex_number` -> `complex_double` -> `complex_number`).
 
 In this ticket, we break these cyclic imports by narrowing down some of the global module imports to local function-wide imports. This was not possible in the case of the `CCtoCDF` class, since there `ComplexDoubleElement` is cimported, which has to be done on the module level. I've hence extracted this class to a new module `complex_conversion.pyx`.
+
+With these changes, the executing the following code
+
+```
+from sage.rings.complex_mpfr import ComplexField
+print(ComplexField())
+```
+using `./venv/bin/python3` works. Previously, it failed with 
+
+```
+  File "/home/tobias/sage/src/test.py", line 1, in <module>
+    from sage.rings.complex_mpfr import ComplexField
+  File "sage/rings/complex_mpfr.pyx", line 1, in init sage.rings.complex_mpfr
+  File "sage/rings/real_mpfr.pyx", line 1, in init sage.rings.real_mpfr
+  File "sage/libs/mpmath/utils.pyx", line 17, in init sage.libs.mpmath.utils
+ImportError: cannot import name ComplexField
+```
``````




---

archive/issue_comments_494206.json:
```json
{
    "body": "<a id='comment:23'>Comment 23:</a>\nThanks for the help Matthias!\n\nIt still needed a bit further cleanup, but should work now. I've updated the ticket description to discuss what didn't work before but now does.",
    "created_at": "2021-11-26T21:25:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494206",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:23'>Comment 23:</a>
Thanks for the help Matthias!

It still needed a bit further cleanup, but should work now. I've updated the ticket description to discuss what didn't work before but now does.



---

archive/issue_comments_494207.json:
```json
{
    "body": "<a id='comment:24'>Comment 24:</a>\nThanks, this looks good. I'll test this now also with #32601, but I don't expect problems",
    "created_at": "2021-11-26T22:12:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494207",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'>Comment 24:</a>
Thanks, this looks good. I'll test this now also with #32601, but I don't expect problems



---

archive/issue_comments_494208.json:
```json
{
    "body": "Reviewer: **Matthias Koeppe**",
    "created_at": "2021-11-26T22:12:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494208",
    "user": "https://github.com/mkoeppe"
}
```

Reviewer: **Matthias Koeppe**



---

archive/issue_events_405727.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-11-26T22:34:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405727"
}
```



---

archive/issue_events_405728.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-11-26T22:34:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405728"
}
```



---

archive/issue_comments_494209.json:
```json
{
    "body": "<a id='comment:26'>Comment 26:</a>\nThanks for the review!",
    "created_at": "2021-11-27T16:12:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494209",
    "user": "https://github.com/tobiasdiez"
}
```

<a id='comment:26'>Comment 26:</a>
Thanks for the review!



---

archive/issue_comments_494210.json:
```json
{
    "body": "<a id='comment:27'>Comment 27:</a>\n\n```\nsage -t --long --warn-long 43.1 --random-seed=227602538950590531556014576097185838563 src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py\n**********************************************************************\nFile \"src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py\", line 2038, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicPD.plot\nFailed example:\n    H = h.plot(thickness=6, color=\"orange\"); H           # optional - sage.plot\nExpected:\n    Graphics object consisting of 2 graphics primitives        # optional - sage.plot\nGot:\n    Graphics object consisting of 2 graphics primitives\n**********************************************************************\n```",
    "created_at": "2021-12-06T00:21:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494210",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:27'>Comment 27:</a>

```
sage -t --long --warn-long 43.1 --random-seed=227602538950590531556014576097185838563 src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py
**********************************************************************
File "src/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py", line 2038, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicPD.plot
Failed example:
    H = h.plot(thickness=6, color="orange"); H           # optional - sage.plot
Expected:
    Graphics object consisting of 2 graphics primitives        # optional - sage.plot
Got:
    Graphics object consisting of 2 graphics primitives
**********************************************************************
```



---

archive/issue_events_405729.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-12-06T00:21:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405729"
}
```



---

archive/issue_events_405730.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-12-06T00:21:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405730"
}
```



---

archive/issue_comments_494211.json:
```json
{
    "body": "<a id='comment:28'>Comment 28:</a>\nFixed in #32174.",
    "created_at": "2021-12-06T00:35:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494211",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:28'>Comment 28:</a>
Fixed in #32174.



---

archive/issue_events_405731.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-06T00:35:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405731"
}
```



---

archive/issue_events_405732.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-06T00:35:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405732"
}
```



---

archive/issue_comments_494212.json:
```json
{
    "body": "Changed dependencies from **#32612, #32610** to **#32612, #32610, #32174**",
    "created_at": "2021-12-06T00:35:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494212",
    "user": "https://github.com/mkoeppe"
}
```

Changed dependencies from **#32612, #32610** to **#32612, #32610, #32174**



---

archive/issue_events_405733.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-12-19T11:47:53Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405733"
}
```



---

archive/issue_events_405734.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "feae8f588b6cc45ee0794b88c7f83b6b1b1cd98f",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2021-12-19T11:47:53Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30741#event-405734"
}
```



---

archive/issue_comments_494213.json:
```json
{
    "body": "Changed branch from **[public/refactoring/complexCycle](https://github.com/sagemath/sagetrac-mirror/tree/public/refactoring/complexCycle)** to **[401fee5](https://github.com/sagemath/sagetrac-mirror/commit/401fee537e209218e4e6795fd2522e5f1817e46a)**",
    "created_at": "2021-12-19T11:47:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30741",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30741#issuecomment-494213",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/refactoring/complexCycle](https://github.com/sagemath/sagetrac-mirror/tree/public/refactoring/complexCycle)** to **[401fee5](https://github.com/sagemath/sagetrac-mirror/commit/401fee537e209218e4e6795fd2522e5f1817e46a)**
