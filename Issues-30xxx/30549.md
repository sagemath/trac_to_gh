# Issue 30549: Remove all the bitset access from cython files in combinatorial polyhedron

archive/issues_030312.json:
```json
{
    "body": "This goal of this ticket is to use `data_structures/biteset.pxi` for the bitset stuff in combinatorial polyhedron and cleanly seperate algorithm and data structure.\n\nThis ticket is mostly resolved in smaller tickets:\n- #30596: Outsource functions in bitset.pxi that can be optimized by intrinsics \n- #30597: Define a sparse bitset structure \n- #30601: Move bitset.pxi to bitset_base.pxd\n- #30598: Define a new data structure for a combinatorial face \n- #30599: Define a new data structure for a list of combinatorial faces   - \n\nChanges are:\n\n1. Move functions optimizable by intrinsics to a seperate file (`\tsrc/sage/data_structures/bitset_intrinsics.h`). (See #27103 and #27122.)\n2. Allow most functions in `bitset.pxi` for fuzed types [fuzed types](https://cython.readthedocs.io/en/latest/src/userguide/fusedtypes.html,), such that an (yet to be enriched) bitset data structure specialized for combinatorial faces can use it.\n3. Move `bitset.pxi` to `bitset_base.pxd`.\n4. Define a data structure `face_s` that gathers properties of a face and corresponding functions.\n5. Define a data structure `face_list_s` that gathers properties of a list of faces and corresponding functions.\n6. The two flavors of the algorithm (simple and standard) are set up as templates by abusing fuzed types. This makes the code much easier to read. Only the changes will be seperated in the code while the compiler compiles two seperate branches for both flavors.\n\nThe features of those changes are mainly:\n\n- Less involved signatures of functions.\n- Removing duplications of code.\n- New flavors of the algorithm can be implemented without messing up all the files.\n- We may enrich `face_s` without changing all our code.\n- Intrinsics can easily applied to bitsets in general.\n\nCC:  @jplab @laisrast @tscrim\n\nKeywords: combinatorial polyhedron, bitsets\n\nBranch/Commit: 82a747d6fabf5cf8d366851d2dfbcbf7cd57eabc\n\nReviewer: Travis Scrimshaw\n\nAuthor: Jonathan Kliem\n\nDependencies: #30529\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30549\n\n",
    "closed_at": "2020-12-13T20:30:42Z",
    "created_at": "2020-09-10T14:58:52Z",
    "labels": [
        "component: geometry"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Remove all the bitset access from cython files in combinatorial polyhedron",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30549",
    "user": "https://github.com/kliem"
}
```
This goal of this ticket is to use `data_structures/biteset.pxi` for the bitset stuff in combinatorial polyhedron and cleanly seperate algorithm and data structure.

This ticket is mostly resolved in smaller tickets:
- #30596: Outsource functions in bitset.pxi that can be optimized by intrinsics 
- #30597: Define a sparse bitset structure 
- #30601: Move bitset.pxi to bitset_base.pxd
- #30598: Define a new data structure for a combinatorial face 
- #30599: Define a new data structure for a list of combinatorial faces   - 

Changes are:

1. Move functions optimizable by intrinsics to a seperate file (`	src/sage/data_structures/bitset_intrinsics.h`). (See #27103 and #27122.)
2. Allow most functions in `bitset.pxi` for fuzed types [fuzed types](https://cython.readthedocs.io/en/latest/src/userguide/fusedtypes.html,), such that an (yet to be enriched) bitset data structure specialized for combinatorial faces can use it.
3. Move `bitset.pxi` to `bitset_base.pxd`.
4. Define a data structure `face_s` that gathers properties of a face and corresponding functions.
5. Define a data structure `face_list_s` that gathers properties of a list of faces and corresponding functions.
6. The two flavors of the algorithm (simple and standard) are set up as templates by abusing fuzed types. This makes the code much easier to read. Only the changes will be seperated in the code while the compiler compiles two seperate branches for both flavors.

The features of those changes are mainly:

- Less involved signatures of functions.
- Removing duplications of code.
- New flavors of the algorithm can be implemented without messing up all the files.
- We may enrich `face_s` without changing all our code.
- Intrinsics can easily applied to bitsets in general.

CC:  @jplab @laisrast @tscrim

Keywords: combinatorial polyhedron, bitsets

Branch/Commit: 82a747d6fabf5cf8d366851d2dfbcbf7cd57eabc

Reviewer: Travis Scrimshaw

Author: Jonathan Kliem

Dependencies: #30529

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/30549





---

archive/issue_comments_461178.json:
```json
{
    "body": "<a id='comment:1'></a>It's a patch bomb, I know. If anyone knows a reasonable way around it, I'll do it.\n\nCurrently, this is working again and I'm happy. And it's so much easier to do some something from then on.\n\nMost of the changes in the cython files are trivial (took me a while to figure out everything though).\n\nThe current branch is a bit of regression with non-simple-non-simplicial polyhedra. It can take much longer. One thing is the unnecessary union of coatoms. Also the branch prediction seems to be bad, because one could know much earlier that the coatom check is useless. I'll think about a solution that works well.\n\nWe waste a bit of memory by also allocating enough space for the coatoms in each case, but I wouldn't worry about it for now. In a worst case scenario this needs twice as much memory and much less in many scenarios that have less equal number of vertices/facets. Memory was never an issue for me, it was always time.",
    "created_at": "2020-09-10T19:31:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461178",
    "user": "https://github.com/kliem"
}
```

<a id='comment:1'></a>It's a patch bomb, I know. If anyone knows a reasonable way around it, I'll do it.

Currently, this is working again and I'm happy. And it's so much easier to do some something from then on.

Most of the changes in the cython files are trivial (took me a while to figure out everything though).

The current branch is a bit of regression with non-simple-non-simplicial polyhedra. It can take much longer. One thing is the unnecessary union of coatoms. Also the branch prediction seems to be bad, because one could know much earlier that the coatom check is useless. I'll think about a solution that works well.

We waste a bit of memory by also allocating enough space for the coatoms in each case, but I wouldn't worry about it for now. In a worst case scenario this needs twice as much memory and much less in many scenarios that have less equal number of vertices/facets. Memory was never an issue for me, it was always time.



---

archive/issue_comments_461179.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-09-11T14:21:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461179",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_461180.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-09-11T14:53:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461180",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_461181.json:
```json
{
    "body": "<a id='comment:3'></a>I'm happy with the ticket as it is.\n\nUsing templates for the two algorithmic variants, the branch prediction has improved significantly. For extreme cases (see below), things got a bit slower. I don't know why.\n\nIn a future ticket one can spare allocating the memory for the coatoms in case we are not using the simple/simplicial algorithm. It doesn't seem to make a difference in runtime.\n\nThis is an example of slight slowdown:\n\n```\nsage: P = polytopes.permutahedron(6)                                                                                                                                  \nsage: Q = P.base_extend(QQ).polar(in_affine_span=True)                                                                                                                \nsage: R = P.join(Q)                                                                                                                                                   \nsage: C = CombinatorialPolyhedron(R)                                                                                                                                  \nsage: %time _ = C.f_vector()                                                                                                                                              \nCPU times: user 1min 12s, sys: 28.8 ms, total: 1min 12s\nWall time: 1min 12s\n```\nThis is 10 seconds faster on #30040.\n\nI could also play around with constants etc.\n\nThis could also all be because the compiler ignores my `inline` instructions in places.\n\nAnyway, I can live with the slight slowdown for now, because the structure is so much better for further improvements.\n\nAny suggestions on how to improve things are welcome.",
    "created_at": "2020-09-11T14:53:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461181",
    "user": "https://github.com/kliem"
}
```

<a id='comment:3'></a>I'm happy with the ticket as it is.

Using templates for the two algorithmic variants, the branch prediction has improved significantly. For extreme cases (see below), things got a bit slower. I don't know why.

In a future ticket one can spare allocating the memory for the coatoms in case we are not using the simple/simplicial algorithm. It doesn't seem to make a difference in runtime.

This is an example of slight slowdown:

```
sage: P = polytopes.permutahedron(6)                                                                                                                                  
sage: Q = P.base_extend(QQ).polar(in_affine_span=True)                                                                                                                
sage: R = P.join(Q)                                                                                                                                                   
sage: C = CombinatorialPolyhedron(R)                                                                                                                                  
sage: %time _ = C.f_vector()                                                                                                                                              
CPU times: user 1min 12s, sys: 28.8 ms, total: 1min 12s
Wall time: 1min 12s
```
This is 10 seconds faster on #30040.

I could also play around with constants etc.

This could also all be because the compiler ignores my `inline` instructions in places.

Anyway, I can live with the slight slowdown for now, because the structure is so much better for further improvements.

Any suggestions on how to improve things are welcome.



---

archive/issue_comments_461182.json:
```json
{
    "body": "<a id='comment:4'></a>https://cython.readthedocs.io/en/latest/src/userguide/fusedtypes.html\n\nIf this is better, I could move almost everything back to cython again.\n\nThe only thing that really needs to be in C/C++ are those 4 functions that I want to optimize with intrinsics later on (there are going to be a few more, but they are all tiny).\nTo my knowledge you cannot do something like\n\n```\n#if __AVX__\ndef foo(): return 1\n#elif __SSE4_1__\ndef foo(): return 2\n#else\ndef foo(): return 3\n#endif\n```\nin cython.\n\nHowever I don't know how the performance is, when you include critical `C/C++` function via `cdef extern from` that will be called a huge number of times.",
    "created_at": "2020-09-11T15:26:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461182",
    "user": "https://github.com/kliem"
}
```

<a id='comment:4'></a>https://cython.readthedocs.io/en/latest/src/userguide/fusedtypes.html

If this is better, I could move almost everything back to cython again.

The only thing that really needs to be in C/C++ are those 4 functions that I want to optimize with intrinsics later on (there are going to be a few more, but they are all tiny).
To my knowledge you cannot do something like

```
#if __AVX__
def foo(): return 1
#elif __SSE4_1__
def foo(): return 2
#else
def foo(): return 3
#endif
```
in cython.

However I don't know how the performance is, when you include critical `C/C++` function via `cdef extern from` that will be called a huge number of times.



---

archive/issue_comments_461183.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2020-09-11T18:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461183",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_461184.json:
```json
{
    "body": "<a id='comment:5'></a>Also I'm happy with it now, the current status would force to move quite a lot of `bitsets` to C++. If I want to do it (which I'm not sure of yet) I would need to ask other people about it.\n\nSo for now this is a design proposal.",
    "created_at": "2020-09-11T18:22:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461184",
    "user": "https://github.com/kliem"
}
```

<a id='comment:5'></a>Also I'm happy with it now, the current status would force to move quite a lot of `bitsets` to C++. If I want to do it (which I'm not sure of yet) I would need to ask other people about it.

So for now this is a design proposal.



---

archive/issue_comments_461185.json:
```json
{
    "body": "<a id='comment:6'></a>I like it much better now.\n\nTimings with this ticket (branch `u/gh-kliem/use_face_structure`):\n\n(Note that I didn't apply new tricks to the algorithm. Only the data structure has changed.)\n\n```\nsage: P = polytopes.permutahedron(8, backend='normaliz')                                                                                                                            \nsage: C = CombinatorialPolyhedron(P)                                                                                                                                                \nsage: %time _ = C.f_vector()                                                                                                                                                        \nCPU times: user 648 ms, sys: 15 \u00b5s, total: 648 ms\nWall time: 648 ms\n\nsage: P = polytopes.associahedron(['A',10], backend='normaliz')                                                                                                                     \nsage: C = CombinatorialPolyhedron(P)                                                                                                                                                \nsage: %time _ = C.f_vector()                                                                                                                                                        \nCPU times: user 1.97 s, sys: 0 ns, total: 1.97 s\nWall time: 1.97 s\n\nsage: P = polytopes.permutahedron(7)                                                                                                                                                \nsage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                       \nsage: C = CombinatorialPolyhedron(P1)                                                                                                                                               \nsage: %time _ = C.f_vector()                                                                                                                                                        \nCPU times: user 242 ms, sys: 0 ns, total: 242 ms\nWall time: 241 ms\n\nsage: P = polytopes.hypercube(12)                                                                                                                                                   \nsage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                       \nsage: C = CombinatorialPolyhedron(P1)                                                                                                                                               \nsage: %time _ = C.f_vector()                                                                                                                                                        \nCPU times: user 430 ms, sys: 0 ns, total: 430 ms\nWall time: 429 ms\n\nsage: P = polytopes.permutahedron(6)                                                                                                                                                \nsage: Q = P.base_extend(QQ).polar(in_affine_span=True)                                                                                                                              \nsage: R = P.join(Q)                                                                                                                                                                 \nsage: C = CombinatorialPolyhedron(R)                                                                                                                                                \nsage: %time _ = C.f_vector()                                                                                                                                                        \nCPU times: user 1min 11s, sys: 31.8 ms, total: 1min 11s\nWall time: 1min 11s\n```\n\nTimings on #30040:\n\n```\nsage: P = polytopes.permutahedron(8, backend='normaliz')                                                                                                                            \nsage: C = CombinatorialPolyhedron(P)                                                                                                                                                \nsage: %time _ = C.f_vector()                                                                                                                                                        \nCPU times: user 680 ms, sys: 0 ns, total: 680 ms\nWall time: 679 ms\n\nsage: P = polytopes.associahedron(['A',10], backend='normaliz')                                                                                                                     \nsage: C = CombinatorialPolyhedron(P)                                                                                                                                                \nsage: %time _ = C.f_vector()                                                                                                                                                        \nCPU times: user 2.2 s, sys: 45 \u00b5s, total: 2.2 s\nWall time: 2.2 s\n\nsage: P = polytopes.permutahedron(7)                                                                                                                                                \nsage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                       \nsage: C = CombinatorialPolyhedron(P1)                                                                                                                                               \nsage: %time _ = C.f_vector()                                                                                                                                                        \nCPU times: user 240 ms, sys: 0 ns, total: 240 ms\nWall time: 239 ms\n\nsage: P = polytopes.hypercube(12)                                                                                                                                                   \nsage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                       \nsage: C = CombinatorialPolyhedron(P1)                                                                                                                                               \nsage: %time _ = C.f_vector()                                                                                                                                                        \nCPU times: user 414 ms, sys: 0 ns, total: 414 ms\nWall time: 413 ms\n\nsage: P = polytopes.permutahedron(6)                                                                                                                                                \nsage: Q = P.base_extend(QQ).polar(in_affine_span=True)                                                                                                                              \nsage: R = P.join(Q)                                                                                                                                                                 \nsage: C = CombinatorialPolyhedron(R)                                                                                                                                                \nsage: %time _ = C.f_vector()                                                                                                                                                        \nCPU times: user 1min 4s, sys: 51.6 ms, total: 1min 4s\nWall time: 1min 4s\n```\n\nSo I would say that there is no performance-wise reason to reject the changes.\n\nThe branch indicates a bit, how this could be split into seperate tickets that are doable to review.\n\n---\nLast 10 new commits:",
    "created_at": "2020-09-16T09:24:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461185",
    "user": "https://github.com/kliem"
}
```

<a id='comment:6'></a>I like it much better now.

Timings with this ticket (branch `u/gh-kliem/use_face_structure`):

(Note that I didn't apply new tricks to the algorithm. Only the data structure has changed.)

```
sage: P = polytopes.permutahedron(8, backend='normaliz')                                                                                                                            
sage: C = CombinatorialPolyhedron(P)                                                                                                                                                
sage: %time _ = C.f_vector()                                                                                                                                                        
CPU times: user 648 ms, sys: 15 µs, total: 648 ms
Wall time: 648 ms

sage: P = polytopes.associahedron(['A',10], backend='normaliz')                                                                                                                     
sage: C = CombinatorialPolyhedron(P)                                                                                                                                                
sage: %time _ = C.f_vector()                                                                                                                                                        
CPU times: user 1.97 s, sys: 0 ns, total: 1.97 s
Wall time: 1.97 s

sage: P = polytopes.permutahedron(7)                                                                                                                                                
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                       
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                               
sage: %time _ = C.f_vector()                                                                                                                                                        
CPU times: user 242 ms, sys: 0 ns, total: 242 ms
Wall time: 241 ms

sage: P = polytopes.hypercube(12)                                                                                                                                                   
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                       
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                               
sage: %time _ = C.f_vector()                                                                                                                                                        
CPU times: user 430 ms, sys: 0 ns, total: 430 ms
Wall time: 429 ms

sage: P = polytopes.permutahedron(6)                                                                                                                                                
sage: Q = P.base_extend(QQ).polar(in_affine_span=True)                                                                                                                              
sage: R = P.join(Q)                                                                                                                                                                 
sage: C = CombinatorialPolyhedron(R)                                                                                                                                                
sage: %time _ = C.f_vector()                                                                                                                                                        
CPU times: user 1min 11s, sys: 31.8 ms, total: 1min 11s
Wall time: 1min 11s
```

Timings on #30040:

```
sage: P = polytopes.permutahedron(8, backend='normaliz')                                                                                                                            
sage: C = CombinatorialPolyhedron(P)                                                                                                                                                
sage: %time _ = C.f_vector()                                                                                                                                                        
CPU times: user 680 ms, sys: 0 ns, total: 680 ms
Wall time: 679 ms

sage: P = polytopes.associahedron(['A',10], backend='normaliz')                                                                                                                     
sage: C = CombinatorialPolyhedron(P)                                                                                                                                                
sage: %time _ = C.f_vector()                                                                                                                                                        
CPU times: user 2.2 s, sys: 45 µs, total: 2.2 s
Wall time: 2.2 s

sage: P = polytopes.permutahedron(7)                                                                                                                                                
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                       
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                               
sage: %time _ = C.f_vector()                                                                                                                                                        
CPU times: user 240 ms, sys: 0 ns, total: 240 ms
Wall time: 239 ms

sage: P = polytopes.hypercube(12)                                                                                                                                                   
sage: P1 = P.stack(next(P.face_generator(1)))                                                                                                                                       
sage: C = CombinatorialPolyhedron(P1)                                                                                                                                               
sage: %time _ = C.f_vector()                                                                                                                                                        
CPU times: user 414 ms, sys: 0 ns, total: 414 ms
Wall time: 413 ms

sage: P = polytopes.permutahedron(6)                                                                                                                                                
sage: Q = P.base_extend(QQ).polar(in_affine_span=True)                                                                                                                              
sage: R = P.join(Q)                                                                                                                                                                 
sage: C = CombinatorialPolyhedron(R)                                                                                                                                                
sage: %time _ = C.f_vector()                                                                                                                                                        
CPU times: user 1min 4s, sys: 51.6 ms, total: 1min 4s
Wall time: 1min 4s
```

So I would say that there is no performance-wise reason to reject the changes.

The branch indicates a bit, how this could be split into seperate tickets that are doable to review.

---
Last 10 new commits:



---

archive/issue_comments_461186.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,16 +1,26 @@\n-This ticket removes all the top level bitset access. The algorithm is cleanly separated from the data structure now.\n+This goal of this ticket is to use `data_structures/biteset.pxi` for the bitset stuff in combinatorial polyhedron and cleanly seperate algorithm and data structure.\n \n-There is a new file `bitsets.cpp` (already introduced in #30528). This file should eventually be merged with `data_structures/bitsets.pxd` (and now one can see that such a thing is possible).\n+This ticket should eventually be resolved in many smaller tickets.\n \n-There is a file `face.cpp` that grabs what seems to be useful to define a face.\n+Changes are:\n \n-There is `face_list.cpp`. Here a list of faces is defined as a structure and some common methods that make sense for lists of faces are defined (such as intersect a face with a list of other faces and `get_next_level`).\n+1. Move functions optimizable by intrinsics to a seperate file (`\tsrc/sage/data_structures/bitset_intrinsics.h`). (See #27103 and #27122.)\n \n-There are two new structures: `face_list_struct` and `face_struct`. `face_list_struct` is more or less public. `face_struct` is pretty much private. Only the provided functions should be used with it.\n+2. Allow most functions in `bitset.pxi` for fuzed types [fuzed types](https://cython.readthedocs.io/en/latest/src/userguide/fusedtypes.html,), such that an (yet to be enriched) bitset data structure specialized for combinatorial faces can use it.\n \n-The signatures of functions/methods became a lot easier. Cython files do not have to worry about alignment or `face_length` etc. Memory allocation is still done by `MemoryAllocator`. The low level file iteratively requests all the memory to define a face.\n+3. Define a data structure `face_s` that gathers properties of a face and corresponding functions.\n \n-With this ticket, one can easily adapt the data structure for combinatorial faces to almost anything one likes. Hopefully without changing the cython files.\n+4. Define a data structure `face_list_s` that gathers properties of a list of faces and corresponding functions.\n+\n+5. The two flavors of the algorithm (simple and standard) are set up as templates by abusing fuzed types. This makes the code much easier to read. Only the changes will be seperated in the code while the compiler compiles two seperate branches for both flavors.\n+\n+The features of those changes are mainly:\n+\n+- Less involved signatures of functions.\n+- Removing duplications of code.\n+- New flavors of the algorithm can be implemented without messing up all the files.\n+- We may enrich `face_s` without changing all our code.\n+- Intrinsics can easily applied to bitsets in general.\n \n Author: Jonathan Kliem\n \n```\n",
    "created_at": "2020-09-16T09:43:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461186",
    "user": "https://github.com/kliem"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,16 +1,26 @@
-This ticket removes all the top level bitset access. The algorithm is cleanly separated from the data structure now.
+This goal of this ticket is to use `data_structures/biteset.pxi` for the bitset stuff in combinatorial polyhedron and cleanly seperate algorithm and data structure.
 
-There is a new file `bitsets.cpp` (already introduced in #30528). This file should eventually be merged with `data_structures/bitsets.pxd` (and now one can see that such a thing is possible).
+This ticket should eventually be resolved in many smaller tickets.
 
-There is a file `face.cpp` that grabs what seems to be useful to define a face.
+Changes are:
 
-There is `face_list.cpp`. Here a list of faces is defined as a structure and some common methods that make sense for lists of faces are defined (such as intersect a face with a list of other faces and `get_next_level`).
+1. Move functions optimizable by intrinsics to a seperate file (`	src/sage/data_structures/bitset_intrinsics.h`). (See #27103 and #27122.)
 
-There are two new structures: `face_list_struct` and `face_struct`. `face_list_struct` is more or less public. `face_struct` is pretty much private. Only the provided functions should be used with it.
+2. Allow most functions in `bitset.pxi` for fuzed types [fuzed types](https://cython.readthedocs.io/en/latest/src/userguide/fusedtypes.html,), such that an (yet to be enriched) bitset data structure specialized for combinatorial faces can use it.
 
-The signatures of functions/methods became a lot easier. Cython files do not have to worry about alignment or `face_length` etc. Memory allocation is still done by `MemoryAllocator`. The low level file iteratively requests all the memory to define a face.
+3. Define a data structure `face_s` that gathers properties of a face and corresponding functions.
 
-With this ticket, one can easily adapt the data structure for combinatorial faces to almost anything one likes. Hopefully without changing the cython files.
+4. Define a data structure `face_list_s` that gathers properties of a list of faces and corresponding functions.
+
+5. The two flavors of the algorithm (simple and standard) are set up as templates by abusing fuzed types. This makes the code much easier to read. Only the changes will be seperated in the code while the compiler compiles two seperate branches for both flavors.
+
+The features of those changes are mainly:
+
+- Less involved signatures of functions.
+- Removing duplications of code.
+- New flavors of the algorithm can be implemented without messing up all the files.
+- We may enrich `face_s` without changing all our code.
+- Intrinsics can easily applied to bitsets in general.
 
 Author: Jonathan Kliem
 
```




---

archive/issue_comments_461187.json:
```json
{
    "body": "<a id='comment:9'></a>I posted on sage devel on whether the proposed design is acceptable:\nhttps://groups.google.com/g/sage-devel/c/jD9BY5Ozlko",
    "created_at": "2020-09-16T10:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461187",
    "user": "https://github.com/kliem"
}
```

<a id='comment:9'></a>I posted on sage devel on whether the proposed design is acceptable:
https://groups.google.com/g/sage-devel/c/jD9BY5Ozlko



---

archive/issue_comments_461188.json:
```json
{
    "body": "<a id='comment:10'></a>I am essentially happy with this ticket, but I want to wait and see what happens with the design discussion before going forward.",
    "created_at": "2020-09-17T00:07:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461188",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:10'></a>I am essentially happy with this ticket, but I want to wait and see what happens with the design discussion before going forward.



---

archive/issue_comments_461189.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,28 @@\n+This goal of this ticket is to use `data_structures/biteset.pxi` for the bitset stuff in combinatorial polyhedron and cleanly seperate algorithm and data structure.\n \n+This ticket is mostly resolved in smaller tickets:\n+- #30596: Outsource functions in bitset.pxi that can be optimized by intrinsics \n+- #30597: Define a sparse bitset structure \n+- #30601: Move bitset.pxi to bitset_base.pxd\n+- #30598: Define a new data structure for a combinatorial face \n+- #30599: Define a new data structure for a list of combinatorial faces   - \n+\n+Changes are:\n+\n+1. Move functions optimizable by intrinsics to a seperate file (`\tsrc/sage/data_structures/bitset_intrinsics.h`). (See #27103 and #27122.)\n+2. Allow most functions in `bitset.pxi` for fuzed types [fuzed types](https://cython.readthedocs.io/en/latest/src/userguide/fusedtypes.html,), such that an (yet to be enriched) bitset data structure specialized for combinatorial faces can use it.\n+3. Move `bitset.pxi` to `bitset_base.pxd`.\n+4. Define a data structure `face_s` that gathers properties of a face and corresponding functions.\n+5. Define a data structure `face_list_s` that gathers properties of a list of faces and corresponding functions.\n+6. The two flavors of the algorithm (simple and standard) are set up as templates by abusing fuzed types. This makes the code much easier to read. Only the changes will be seperated in the code while the compiler compiles two seperate branches for both flavors.\n+\n+The features of those changes are mainly:\n+\n+- Less involved signatures of functions.\n+- Removing duplications of code.\n+- New flavors of the algorithm can be implemented without messing up all the files.\n+- We may enrich `face_s` without changing all our code.\n+- Intrinsics can easily applied to bitsets in general.\n \n Author: Jonathan Kliem\n \n```\n",
    "created_at": "2020-09-18T16:23:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461189",
    "user": "https://github.com/kliem"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,28 @@
+This goal of this ticket is to use `data_structures/biteset.pxi` for the bitset stuff in combinatorial polyhedron and cleanly seperate algorithm and data structure.
 
+This ticket is mostly resolved in smaller tickets:
+- #30596: Outsource functions in bitset.pxi that can be optimized by intrinsics 
+- #30597: Define a sparse bitset structure 
+- #30601: Move bitset.pxi to bitset_base.pxd
+- #30598: Define a new data structure for a combinatorial face 
+- #30599: Define a new data structure for a list of combinatorial faces   - 
+
+Changes are:
+
+1. Move functions optimizable by intrinsics to a seperate file (`	src/sage/data_structures/bitset_intrinsics.h`). (See #27103 and #27122.)
+2. Allow most functions in `bitset.pxi` for fuzed types [fuzed types](https://cython.readthedocs.io/en/latest/src/userguide/fusedtypes.html,), such that an (yet to be enriched) bitset data structure specialized for combinatorial faces can use it.
+3. Move `bitset.pxi` to `bitset_base.pxd`.
+4. Define a data structure `face_s` that gathers properties of a face and corresponding functions.
+5. Define a data structure `face_list_s` that gathers properties of a list of faces and corresponding functions.
+6. The two flavors of the algorithm (simple and standard) are set up as templates by abusing fuzed types. This makes the code much easier to read. Only the changes will be seperated in the code while the compiler compiles two seperate branches for both flavors.
+
+The features of those changes are mainly:
+
+- Less involved signatures of functions.
+- Removing duplications of code.
+- New flavors of the algorithm can be implemented without messing up all the files.
+- We may enrich `face_s` without changing all our code.
+- Intrinsics can easily applied to bitsets in general.
 
 Author: Jonathan Kliem
 
```




---

archive/issue_comments_461190.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2020-09-18T16:24:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461190",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_461191.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2020-09-18T16:25:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461191",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_461192.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-10-26T07:32:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461192",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_461193.json:
```json
{
    "body": "<a id='comment:17'></a>Red branch.\n\nI'll fix it, once all the dependencies are in.",
    "created_at": "2020-11-11T09:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461193",
    "user": "https://github.com/kliem"
}
```

<a id='comment:17'></a>Red branch.

I'll fix it, once all the dependencies are in.



---

archive/issue_comments_461194.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-11-11T09:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461194",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_461195.json:
```json
{
    "body": "<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-11-27T08:37:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461195",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_461196.json:
```json
{
    "body": "<a id='comment:21'></a>Ok, this is back on needs review. Almost all dependencies are gone now.",
    "created_at": "2020-11-27T08:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461196",
    "user": "https://github.com/kliem"
}
```

<a id='comment:21'></a>Ok, this is back on needs review. Almost all dependencies are gone now.



---

archive/issue_comments_461197.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-11-27T08:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461197",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_461198.json:
```json
{
    "body": "<a id='comment:22'></a>`# The universe.` <-- Great comment.\n\nLGTM. Hopefully this won't have any issues with other systems that some of the other tickets had.",
    "created_at": "2020-12-07T23:16:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461198",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:22'></a>`# The universe.` <-- Great comment.

LGTM. Hopefully this won't have any issues with other systems that some of the other tickets had.



---

archive/issue_comments_461199.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-12-07T23:16:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461199",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_461200.json:
```json
{
    "body": "<a id='comment:23'></a>Thank you.\n\nYes, I think it is way more stable, as it just exposes bitsets, which has been working for a while now.\n\nI just didn't think, the intermediate solutions to the end.",
    "created_at": "2020-12-08T07:06:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461200",
    "user": "https://github.com/kliem"
}
```

<a id='comment:23'></a>Thank you.

Yes, I think it is way more stable, as it just exposes bitsets, which has been working for a while now.

I just didn't think, the intermediate solutions to the end.



---

archive/issue_comments_461201.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-12-13T20:30:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30549#issuecomment-461201",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_079383.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-12-13T20:30:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30549",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30549#event-79383"
}
```
