# Issue 30966: another wave of cleanup for pbori

archive/issues_030729.json:
```json
{
    "assignees": [],
    "body": "after suggestions of lgtm and flake8\n\nCC:  @tscrim @slel\n\nBranch/Commit: **[ce6f9b9](https://github.com/sagemath/sagetrac-mirror/commit/ce6f9b9991a84266a919cb7c385bd8d1eb374530)**\n\nReviewer: **Samuel Leli\u00e8vre**\n\nAuthor: **Fr\u00e9d\u00e9ric Chapoton**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/30966_\n\n",
    "closed_at": "2020-12-13T00:42:10Z",
    "created_at": "2020-11-26T09:06:41Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20commutative%20algebra",
        "https://github.com/sagemath/sage/labels/p4%20%E2%80%93%20minor",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.3",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "another wave of cleanup for pbori",
    "type": "issue",
    "updated_at": "2020-12-13T00:42:10Z",
    "url": "https://github.com/sagemath/sage/issues/30966",
    "user": "https://github.com/fchapoton"
}
```
after suggestions of lgtm and flake8

CC:  @tscrim @slel

Branch/Commit: **[ce6f9b9](https://github.com/sagemath/sagetrac-mirror/commit/ce6f9b9991a84266a919cb7c385bd8d1eb374530)**

Reviewer: **Samuel Lelièvre**

Author: **Frédéric Chapoton**

_Issue created by migration from https://trac.sagemath.org/ticket/30966_





---

archive/issue_events_394940.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-11-26T09:06:41Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30966",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30966#event-394940"
}
```



---

archive/issue_events_394941.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-11-26T09:06:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30966",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20commutative%20algebra",
    "label_color": "0000ff",
    "label_name": "component: commutative algebra",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30966#event-394941"
}
```



---

archive/issue_events_394942.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-11-26T09:06:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30966",
    "label": "https://github.com/sagemath/sage/labels/p4%20%E2%80%93%20minor",
    "label_color": "ffe799",
    "label_name": "p4 \u2013 minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30966#event-394942"
}
```



---

archive/issue_events_394943.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-11-26T09:06:41Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30966",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30966#event-394943"
}
```



---

archive/issue_comments_499182.json:
```json
{
    "body": "Branch: **[u/chapoton/30966](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/30966)**",
    "created_at": "2020-11-26T09:07:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30966#issuecomment-499182",
    "user": "https://github.com/fchapoton"
}
```

Branch: **[u/chapoton/30966](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/30966)**



---

archive/issue_comments_499183.json:
```json
{
    "body": "Commit: **[ce6f9b9](https://github.com/sagemath/sagetrac-mirror/commit/ce6f9b9991a84266a919cb7c385bd8d1eb374530)**",
    "created_at": "2020-11-26T09:07:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30966#issuecomment-499183",
    "user": "https://github.com/fchapoton"
}
```

Commit: **[ce6f9b9](https://github.com/sagemath/sagetrac-mirror/commit/ce6f9b9991a84266a919cb7c385bd8d1eb374530)**



---

archive/issue_comments_499184.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ce6f9b9991a84266a919cb7c385bd8d1eb374530\">ce6f9b9</a></td><td><code>next wave of cleanup for pbori</code></td></tr></table>\n",
    "created_at": "2020-11-26T09:07:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30966#issuecomment-499184",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:1'>Comment 1:</a>
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ce6f9b9991a84266a919cb7c385bd8d1eb374530">ce6f9b9</a></td><td><code>next wave of cleanup for pbori</code></td></tr></table>




---

archive/issue_events_394944.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-11-26T09:07:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30966",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30966#event-394944"
}
```



---

archive/issue_comments_499185.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nbot is morally green, please review (should be rather easy)",
    "created_at": "2020-11-27T10:54:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30966#issuecomment-499185",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:2'>Comment 2:</a>
bot is morally green, please review (should be rather easy)



---

archive/issue_comments_499186.json:
```json
{
    "body": "Reviewer: **Samuel Leli\u00e8vre**",
    "created_at": "2020-11-27T13:06:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30966#issuecomment-499186",
    "user": "https://github.com/slel"
}
```

Reviewer: **Samuel Lelièvre**



---

archive/issue_comments_499187.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nGood changes.\n\nBelow are some ideas for further changes in the immediate\nvicinity of proposed changes; but clearly out of scope,\nand none needs be done here.\n\nOne could fix more mutable default arguments for the\n`__init__` method of the class `Multiblock` in\n`src/sage/rings/polynomial/pbori/blocks.py`... but\nalso elsewhere:\n\n```bash\n$ git grep \"def .*=\\[\" .\n```\n\nOne could refactor the `dimacs_encode_clause` method of the\n`CNFEncoder` class in `src/sage/rings/polynomial/pbori/cnf.py`,\nsuppressing the auxiliary `get_sign` function and favouring\niterators over lists:\n\n```diff\n     def dimacs_encode_clause(self, c):\n-        def get_sign(value):\n-            if value == 1:\n-                return 1\n-            return -1\n-\n-        items = sorted(c.items(), reverse=True)\n-        return \" \".join([str(v) for v in [\n-            get_sign(value) * self.to_dimacs_index(variable)\n-            for (variable, value) in items] + [0]])\n+        vv = (self.to_dimacs_index(variable) if value == 1\n+              else -self.to_dimacs_index(variable)\n+              for (variable, value) in sorted(c.items(), reverse=True))\n+        return \" \".join(str(v) for v in vv) + \" 0\"\n```\n\nIn `src/sage/rings/polynomial/pbori/gbcore.py`, replacing\n`*` by `*` in a string seems pointless... so maybe change:\n\n```diff\n     for key in options:\n         newkey = key\n-        for prefix in ['', 'use_', 'opt_allow_', 'opt_']:\n+        for prefix in ['use_', 'opt_allow_', 'opt_']:\n             newkey = newkey.replace(prefix, '')\n         filtered[newkey] = options[key]\n```",
    "created_at": "2020-11-27T13:06:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30966#issuecomment-499187",
    "user": "https://github.com/slel"
}
```

<a id='comment:3'>Comment 3:</a>
Good changes.

Below are some ideas for further changes in the immediate
vicinity of proposed changes; but clearly out of scope,
and none needs be done here.

One could fix more mutable default arguments for the
`__init__` method of the class `Multiblock` in
`src/sage/rings/polynomial/pbori/blocks.py`... but
also elsewhere:

```bash
$ git grep "def .*=\[" .
```

One could refactor the `dimacs_encode_clause` method of the
`CNFEncoder` class in `src/sage/rings/polynomial/pbori/cnf.py`,
suppressing the auxiliary `get_sign` function and favouring
iterators over lists:

```diff
     def dimacs_encode_clause(self, c):
-        def get_sign(value):
-            if value == 1:
-                return 1
-            return -1
-
-        items = sorted(c.items(), reverse=True)
-        return " ".join([str(v) for v in [
-            get_sign(value) * self.to_dimacs_index(variable)
-            for (variable, value) in items] + [0]])
+        vv = (self.to_dimacs_index(variable) if value == 1
+              else -self.to_dimacs_index(variable)
+              for (variable, value) in sorted(c.items(), reverse=True))
+        return " ".join(str(v) for v in vv) + " 0"
```

In `src/sage/rings/polynomial/pbori/gbcore.py`, replacing
`*` by `*` in a string seems pointless... so maybe change:

```diff
     for key in options:
         newkey = key
-        for prefix in ['', 'use_', 'opt_allow_', 'opt_']:
+        for prefix in ['use_', 'opt_allow_', 'opt_']:
             newkey = newkey.replace(prefix, '')
         filtered[newkey] = options[key]
```



---

archive/issue_events_394945.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2020-11-27T13:06:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30966",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30966#event-394945"
}
```



---

archive/issue_events_394946.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2020-11-27T13:06:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30966",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30966#event-394946"
}
```



---

archive/issue_comments_499188.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nSalut,\nen fait pbori est un bazar total, presque sans documentation, et c'est un code orphelin qui a \u00e9t\u00e9 mis dans sage r\u00e9cemment, sans satisfaire aucun de nos crit\u00e8res habituels de qualit\u00e9. Maintenant, quelqu'un doit nettoyer tout \u00e7a.",
    "created_at": "2020-11-27T13:37:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30966#issuecomment-499188",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:4'>Comment 4:</a>
Salut,
en fait pbori est un bazar total, presque sans documentation, et c'est un code orphelin qui a été mis dans sage récemment, sans satisfaire aucun de nos critères habituels de qualité. Maintenant, quelqu'un doit nettoyer tout ça.



---

archive/issue_comments_499189.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nReplying to [@fchapoton](#comment%3A4):\n> Salut,\n> en fait pbori est un bazar total, presque sans documentation, et c'est un code orphelin qui a \u00e9t\u00e9 mis dans sage r\u00e9cemment, sans satisfaire aucun de nos crit\u00e8res habituels de qualit\u00e9. Maintenant, quelqu'un doit nettoyer tout \u00e7a.\n\nEt tu peux pointer le doigt vers moi. Mais le code est mort autrement. Il a re\u00e7u bien plus d'attention depuis qu'il est dans sage que dans les 4 derni\u00e8res ann\u00e9es. J'est encore la responsabilit\u00e9 de la \"library\", 15 styles de code diff\u00e9rents dans le m\u00eame fichier sans probl\u00e8me, manque de documentation, tout a fait similaire :(",
    "created_at": "2020-12-07T00:52:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30966#issuecomment-499189",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:5'>Comment 5:</a>
Replying to [@fchapoton](#comment%3A4):
> Salut,
> en fait pbori est un bazar total, presque sans documentation, et c'est un code orphelin qui a été mis dans sage récemment, sans satisfaire aucun de nos critères habituels de qualité. Maintenant, quelqu'un doit nettoyer tout ça.

Et tu peux pointer le doigt vers moi. Mais le code est mort autrement. Il a reçu bien plus d'attention depuis qu'il est dans sage que dans les 4 dernières années. J'est encore la responsabilité de la "library", 15 styles de code différents dans le même fichier sans problème, manque de documentation, tout a fait similaire :(



---

archive/issue_events_394947.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-12-13T00:42:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30966",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30966#event-394947"
}
```



---

archive/issue_events_394948.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "2a3296d3a7e39e54a224b3062f8cfe51cd4accd5",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2020-12-13T00:42:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/30966",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30966#event-394948"
}
```



---

archive/issue_comments_499190.json:
```json
{
    "body": "Changed branch from **[u/chapoton/30966](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/30966)** to **[ce6f9b9](https://github.com/sagemath/sagetrac-mirror/commit/ce6f9b9991a84266a919cb7c385bd8d1eb374530)**",
    "created_at": "2020-12-13T00:42:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30966",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30966#issuecomment-499190",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/chapoton/30966](https://github.com/sagemath/sagetrac-mirror/tree/u/chapoton/30966)** to **[ce6f9b9](https://github.com/sagemath/sagetrac-mirror/commit/ce6f9b9991a84266a919cb7c385bd8d1eb374530)**
