# Issue 30499: deepcopy() fails for lift_map from residue field of a number field

archive/issues_030262.json:
```json
{
    "body": "In sage 9.2 & 9.0 deepcopying the lift_map from a residue field at a prime does not finish because of recursion error\n\n```\nsage: R.<x> = ZZ[]\nsage: f = x^2-2\nsage: K.<a> = NumberField(f)\nsage: P = K(2).factor()[0][0]\nsage: F = K.residue_field(P)\nsage: m = F.lift_map()\nsage: deepcopy(m)\n```\ngives\n\n```\n---------------------------------------------------------------------------\nRecursionError                            Traceback (most recent call last)\n<ipython-input-26-c84bb92e2658> in <module>()\n----> 1 deepcopy(m)\n\n/home/sage/sage/local/lib/python3.7/copy.py in deepcopy(x, memo, _nil)\n    178                     y = x\n    179                 else:\n--> 180                     y = _reconstruct(x, memo, *rv)\n    181\n    182     # If is its own copy, don't memoize.\n\n/home/sage/sage/local/lib/python3.7/copy.py in _reconstruct(x, memo, func, args, state, listiter, dictiter, deepcopy)\n    272     if deep and args:\n    273         args = (deepcopy(arg, memo) for arg in args)\n--> 274     y = func(*args)\n    275     if deep:\n    276         memo[id(x)] = y\n\n/home/sage/sage/local/lib/python3.7/copy.py in <genexpr>(.0)\n    271     deep = memo is not None\n    272     if deep and args:\n--> 273         args = (deepcopy(arg, memo) for arg in args)\n    274     y = func(*args)\n    275     if deep:\n\n/home/sage/sage/local/lib/python3.7/copy.py in deepcopy(x, memo, _nil)\n    148     copier = _deepcopy_dispatch.get(cls)\n    149     if copier:\n--> 150         y = copier(x, memo)\n    151     else:\n    152         try:\n\n/home/sage/sage/local/lib/python3.7/copy.py in _deepcopy_dict(x, memo, deepcopy)\n    238     memo[id(x)] = y\n    239     for key, value in x.items():\n--> 240         y[deepcopy(key, memo)] = deepcopy(value, memo)\n    241     return y\n    242 d[dict] = _deepcopy_dict\n\n... last 5 frames repeated, from the frame below ...\n\n/home/sage/sage/local/lib/python3.7/copy.py in deepcopy(x, memo, _nil)\n    178                     y = x\n    179                 else:\n--> 180                     y = _reconstruct(x, memo, *rv)\n    181\n    182     # If is its own copy, don't memoize.\n\nRecursionError: maximum recursion depth exceeded in comparison\n```\n\nand doing the following causes a segfault and crashes Sage\n\n```\nsage: sys.setrecursionlimit(2**30)\nsage: deepcopy(m)\n{{{\n\n\n\n**CC:**  @pjbruin @mjungmath\n\n**Keywords:** deepcopy, lift_map\n\nIssue created by migration from https://trac.sagemath.org/ticket/30499\n\n",
    "created_at": "2020-09-03T18:39:42Z",
    "labels": [
        "component: number theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "deepcopy() fails for lift_map from residue field of a number field",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30499",
    "user": "https://github.com/walnutmonster"
}
```
In sage 9.2 & 9.0 deepcopying the lift_map from a residue field at a prime does not finish because of recursion error

```
sage: R.<x> = ZZ[]
sage: f = x^2-2
sage: K.<a> = NumberField(f)
sage: P = K(2).factor()[0][0]
sage: F = K.residue_field(P)
sage: m = F.lift_map()
sage: deepcopy(m)
```
gives

```
---------------------------------------------------------------------------
RecursionError                            Traceback (most recent call last)
<ipython-input-26-c84bb92e2658> in <module>()
----> 1 deepcopy(m)

/home/sage/sage/local/lib/python3.7/copy.py in deepcopy(x, memo, _nil)
    178                     y = x
    179                 else:
--> 180                     y = _reconstruct(x, memo, *rv)
    181
    182     # If is its own copy, don't memoize.

/home/sage/sage/local/lib/python3.7/copy.py in _reconstruct(x, memo, func, args, state, listiter, dictiter, deepcopy)
    272     if deep and args:
    273         args = (deepcopy(arg, memo) for arg in args)
--> 274     y = func(*args)
    275     if deep:
    276         memo[id(x)] = y

/home/sage/sage/local/lib/python3.7/copy.py in <genexpr>(.0)
    271     deep = memo is not None
    272     if deep and args:
--> 273         args = (deepcopy(arg, memo) for arg in args)
    274     y = func(*args)
    275     if deep:

/home/sage/sage/local/lib/python3.7/copy.py in deepcopy(x, memo, _nil)
    148     copier = _deepcopy_dispatch.get(cls)
    149     if copier:
--> 150         y = copier(x, memo)
    151     else:
    152         try:

/home/sage/sage/local/lib/python3.7/copy.py in _deepcopy_dict(x, memo, deepcopy)
    238     memo[id(x)] = y
    239     for key, value in x.items():
--> 240         y[deepcopy(key, memo)] = deepcopy(value, memo)
    241     return y
    242 d[dict] = _deepcopy_dict

... last 5 frames repeated, from the frame below ...

/home/sage/sage/local/lib/python3.7/copy.py in deepcopy(x, memo, _nil)
    178                     y = x
    179                 else:
--> 180                     y = _reconstruct(x, memo, *rv)
    181
    182     # If is its own copy, don't memoize.

RecursionError: maximum recursion depth exceeded in comparison
```

and doing the following causes a segfault and crashes Sage

```
sage: sys.setrecursionlimit(2**30)
sage: deepcopy(m)
{{{



**CC:**  @pjbruin @mjungmath

**Keywords:** deepcopy, lift_map

Issue created by migration from https://trac.sagemath.org/ticket/30499





---

archive/issue_comments_490523.json:
```json
{
    "body": "<a id='comment:1'></a>\nI don't think the `deepcopy` protocol is implemented for Sage objects. Most Sage objects are immutable.",
    "created_at": "2020-09-04T17:34:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30499#issuecomment-490523",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>
I don't think the `deepcopy` protocol is implemented for Sage objects. Most Sage objects are immutable.



---

archive/issue_events_277710.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30499",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30499#event-277710"
}
```



---

archive/issue_events_277711.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30499",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30499#event-277711"
}
```



---

archive/issue_events_277712.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-02T20:21:54Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30499",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30499#event-277712"
}
```



---

archive/issue_events_277713.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-04-02T20:21:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30499",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30499#event-277713"
}
```



---

archive/issue_comments_490524.json:
```json
{
    "body": "<a id='comment:4'></a>\nMoving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage",
    "created_at": "2021-04-02T20:21:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30499#issuecomment-490524",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>
Moving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage



---

archive/issue_events_277714.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T02:58:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30499",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30499#event-277714"
}
```



---

archive/issue_events_277715.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T02:58:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30499",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30499#event-277715"
}
```



---

archive/issue_comments_490525.json:
```json
{
    "body": "<a id='comment:6'></a>\nThis will be fixed in #32478",
    "created_at": "2021-09-06T05:52:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30499#issuecomment-490525",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>
This will be fixed in #32478



---

archive/issue_comments_490526.json:
```json
{
    "body": "**Dependencies:** #32478",
    "created_at": "2021-09-06T05:52:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30499#issuecomment-490526",
    "user": "https://github.com/mkoeppe"
}
```

**Dependencies:** #32478



---

archive/issue_comments_490527.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [mkoeppe](#comment%3A6):\n> This will be fixed in #32478\n... actually no",
    "created_at": "2021-09-09T21:39:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30499#issuecomment-490527",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>
Replying to [mkoeppe](#comment%3A6):
> This will be fixed in #32478
... actually no



---

archive/issue_comments_490528.json:
```json
{
    "body": "**Changing dependencies** from \"#32478\" to \"\".",
    "created_at": "2021-09-09T21:39:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30499",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30499#issuecomment-490528",
    "user": "https://github.com/mkoeppe"
}
```

**Changing dependencies** from "#32478" to "".



---

archive/issue_events_277716.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30499",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30499#event-277716"
}
```



---

archive/issue_events_277717.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30499",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30499#event-277717"
}
```



---

archive/issue_events_277718.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-01T21:16:35Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30499",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30499#event-277718"
}
```



---

archive/issue_events_277719.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-01T21:16:35Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30499",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30499#event-277719"
}
```



---

archive/issue_events_277720.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30499",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30499#event-277720"
}
```



---

archive/issue_events_277721.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30499",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30499#event-277721"
}
```
