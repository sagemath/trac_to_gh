# Issue 30053: Python 3.7+: setlocale: LC_ALL: cannot change locale (C.UTF-8) from build/bin/sage-spkg and in doctests; disable use of system Python 3.6

archive/issues_029816.json:
```json
{
    "assignees": [],
    "body": "In #29033 in `build/bin/sage-spkg` LC_ALL was changed to C.UTF-8\nHowever, not all systems have it. \n\nSee also:\n- #22659\n\nFollow-up:\n- #30008 Fix sage-system-python\n- #30586 macOS: Doctest failures in some locales\n- #30576 Python 3.6: Fix locale/encoding issues, then re-enable Python 3.6\n\n\n\nCC:  @antonio-rojas @mkoeppe @slel @orlitzky @kiwifb @embray @fchapoton\n\nBranch: **[be47518](https://github.com/sagemath/sagetrac-mirror/commit/be47518c1019d37e11bbac9a3268d69b196691c8)**\n\nReviewer: **Matthias Koeppe, Dima Pasechnik**\n\nAuthor: **Dima Pasechnik, Matthias Koeppe**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/30053_\n\n",
    "closed_at": "2020-09-19T13:24:05Z",
    "created_at": "2020-07-03T12:25:54Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20build",
        "https://github.com/sagemath/sage/labels/p1%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.2",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Python 3.7+: setlocale: LC_ALL: cannot change locale (C.UTF-8) from build/bin/sage-spkg and in doctests; disable use of system Python 3.6",
    "type": "issue",
    "updated_at": "2020-09-21T05:38:44Z",
    "url": "https://github.com/sagemath/sage/issues/30053",
    "user": "https://github.com/dimpase"
}
```
In #29033 in `build/bin/sage-spkg` LC_ALL was changed to C.UTF-8
However, not all systems have it. 

See also:
- #22659

Follow-up:
- #30008 Fix sage-system-python
- #30586 macOS: Doctest failures in some locales
- #30576 Python 3.6: Fix locale/encoding issues, then re-enable Python 3.6



CC:  @antonio-rojas @mkoeppe @slel @orlitzky @kiwifb @embray @fchapoton

Branch: **[be47518](https://github.com/sagemath/sagetrac-mirror/commit/be47518c1019d37e11bbac9a3268d69b196691c8)**

Reviewer: **Matthias Koeppe, Dima Pasechnik**

Author: **Dima Pasechnik, Matthias Koeppe**

_Issue created by migration from https://trac.sagemath.org/ticket/30053_





---

archive/issue_events_395539.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-07-03T12:25:54Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395539"
}
```



---

archive/issue_events_395540.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-07-03T12:25:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395540"
}
```



---

archive/issue_comments_478615.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\nan easy way out is just to check whether the locale change worked, and if not, use `C` locale, not `C.UTF-8`. Perhaps print a warning.",
    "created_at": "2020-07-04T10:04:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478615",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'>Comment 3:</a>
an easy way out is just to check whether the locale change worked, and if not, use `C` locale, not `C.UTF-8`. Perhaps print a warning.



---

archive/issue_events_395541.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-07-04T10:42:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395541"
}
```



---

archive/issue_events_395542.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-07-04T10:42:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20build",
    "label_color": "000080",
    "label_name": "component: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395542"
}
```



---

archive/issue_comments_478616.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nReplying to [@dimpase](#comment%3A3):\n> an easy way out is just to check whether the locale change worked, and if not, use `C` locale, not `C.UTF-8`.\n\n+1",
    "created_at": "2020-07-04T15:26:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478616",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'>Comment 5:</a>
Replying to [@dimpase](#comment%3A3):
> an easy way out is just to check whether the locale change worked, and if not, use `C` locale, not `C.UTF-8`.

+1



---

archive/issue_events_395543.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-07-05T12:13:24Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395543"
}
```



---

archive/issue_comments_478617.json:
```json
{
    "body": "Author: **Dima Pasechnik**",
    "created_at": "2020-07-05T12:13:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478617",
    "user": "https://github.com/dimpase"
}
```

Author: **Dima Pasechnik**



---

archive/issue_comments_478618.json:
```json
{
    "body": "Commit: **[37e042c](https://github.com/sagemath/sagetrac-mirror/commit/37e042c44d71e841e19fcf70b6995a0f9b3c4ec2)**",
    "created_at": "2020-07-05T12:13:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478618",
    "user": "https://github.com/dimpase"
}
```

Commit: **[37e042c](https://github.com/sagemath/sagetrac-mirror/commit/37e042c44d71e841e19fcf70b6995a0f9b3c4ec2)**



---

archive/issue_comments_478619.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/37e042c44d71e841e19fcf70b6995a0f9b3c4ec2\">37e042c</a></td><td><code>only use locale C.UTF-8 if available, else C</code></td></tr></table>\n",
    "created_at": "2020-07-05T12:13:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478619",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:6'>Comment 6:</a>
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/37e042c44d71e841e19fcf70b6995a0f9b3c4ec2">37e042c</a></td><td><code>only use locale C.UTF-8 if available, else C</code></td></tr></table>




---

archive/issue_comments_478620.json:
```json
{
    "body": "Branch: **[u/dimpase/build/careful_with_C_UTF8](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/build/careful_with_C_UTF8)**",
    "created_at": "2020-07-05T12:13:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478620",
    "user": "https://github.com/dimpase"
}
```

Branch: **[u/dimpase/build/careful_with_C_UTF8](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/build/careful_with_C_UTF8)**



---

archive/issue_comments_478621.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nEither this ticket is a duplicate of #30008 or it should make #30008 obsolete.",
    "created_at": "2020-07-05T13:06:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478621",
    "user": "https://github.com/kliem"
}
```

<a id='comment:7'>Comment 7:</a>
Either this ticket is a duplicate of #30008 or it should make #30008 obsolete.



---

archive/issue_comments_478622.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nI started test runs:\n\nhttps://github.com/kliem/sage/pull/20/checks",
    "created_at": "2020-07-05T13:15:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478622",
    "user": "https://github.com/kliem"
}
```

<a id='comment:8'>Comment 8:</a>
I started test runs:

https://github.com/kliem/sage/pull/20/checks



---

archive/issue_comments_478623.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nthis ticket was a result of a bug report on Arch, not centos. Hopefully it works for #30008 too.",
    "created_at": "2020-07-05T15:19:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478623",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'>Comment 9:</a>
this ticket was a result of a bug report on Arch, not centos. Hopefully it works for #30008 too.



---

archive/issue_comments_478624.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nTests did not complete, because the 9.2.beta3 tests fail everywhere.\n\nhttps://github.com/sagemath/sage/actions/runs/157607524\n\nIs this a github issue or have we broken sage?\n\n```\n Step 13/18 : RUN ./bootstrap\n ---> Running in 89427ef5c1c4\nrm -rf config configure build/make/Makefile-auto.in\nrm -f src/doc/en/installation/*.txt\nrm -rf src/doc/en/reference/spkg/*.rst\nrm -f src/doc/en/reference/repl/*.txt\nsrc/doc/bootstrap:48: installing src/doc/en/installation/arch.txt and src/doc/en/installation/arch-optional.txt\nsrc/doc/bootstrap:48: installing src/doc/en/installation/debian.txt and src/doc/en/installation/debian-optional.txt\nsrc/doc/bootstrap:48: installing src/doc/en/installation/fedora.txt and src/doc/en/installation/fedora-optional.txt\nsrc/doc/bootstrap:48: installing src/doc/en/installation/cygwin.txt and src/doc/en/installation/cygwin-optional.txt\nsrc/doc/bootstrap:48: installing src/doc/en/installation/homebrew.txt and src/doc/en/installation/homebrew-optional.txt\nsrc/doc/bootstrap:55: installing src/doc/en/reference/spkg/*.rst\nsrc/doc/bootstrap:83: installing src/doc/en/reference/repl/options.txt\nsrc/doc/bootstrap: line 84: src/doc/en/reference/repl/options.txt: No such file or directory\nThe command '/bin/sh -c ./bootstrap' returned a non-zero code: 1\n```",
    "created_at": "2020-07-05T15:38:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478624",
    "user": "https://github.com/kliem"
}
```

<a id='comment:10'>Comment 10:</a>
Tests did not complete, because the 9.2.beta3 tests fail everywhere.

https://github.com/sagemath/sage/actions/runs/157607524

Is this a github issue or have we broken sage?

```
 Step 13/18 : RUN ./bootstrap
 ---> Running in 89427ef5c1c4
rm -rf config configure build/make/Makefile-auto.in
rm -f src/doc/en/installation/*.txt
rm -rf src/doc/en/reference/spkg/*.rst
rm -f src/doc/en/reference/repl/*.txt
src/doc/bootstrap:48: installing src/doc/en/installation/arch.txt and src/doc/en/installation/arch-optional.txt
src/doc/bootstrap:48: installing src/doc/en/installation/debian.txt and src/doc/en/installation/debian-optional.txt
src/doc/bootstrap:48: installing src/doc/en/installation/fedora.txt and src/doc/en/installation/fedora-optional.txt
src/doc/bootstrap:48: installing src/doc/en/installation/cygwin.txt and src/doc/en/installation/cygwin-optional.txt
src/doc/bootstrap:48: installing src/doc/en/installation/homebrew.txt and src/doc/en/installation/homebrew-optional.txt
src/doc/bootstrap:55: installing src/doc/en/reference/spkg/*.rst
src/doc/bootstrap:83: installing src/doc/en/reference/repl/options.txt
src/doc/bootstrap: line 84: src/doc/en/reference/repl/options.txt: No such file or directory
The command '/bin/sh -c ./bootstrap' returned a non-zero code: 1
```



---

archive/issue_comments_478625.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nI just found #30064. Edit: I was cc on that, but I didn't realize how serious this is.\n\nOk. I'll run a new test then.",
    "created_at": "2020-07-05T15:39:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478625",
    "user": "https://github.com/kliem"
}
```

<a id='comment:11'>Comment 11:</a>
I just found #30064. Edit: I was cc on that, but I didn't realize how serious this is.

Ok. I'll run a new test then.



---

archive/issue_comments_478626.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nThis breaks building sphinx on windows.\n\nhttps://github.com/kliem/sage/runs/838933940\n\nSame error as #30008.\n\nAs far as I understand the problem is that we need some sort of UTF to make the sphinx build work.\nIt appears that on `cygwin` the default is better than `C` and `C.UTF-8` does not work.\nSo maybe `C` is not the best alternative for `C.UTF-8`.\n\nBtw, strangely centos 7 appears to work with the current beta. I don't know what happened. (And I don't know yet, if this behavior is stable).",
    "created_at": "2020-07-05T19:03:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478626",
    "user": "https://github.com/kliem"
}
```

<a id='comment:12'>Comment 12:</a>
This breaks building sphinx on windows.

https://github.com/kliem/sage/runs/838933940

Same error as #30008.

As far as I understand the problem is that we need some sort of UTF to make the sphinx build work.
It appears that on `cygwin` the default is better than `C` and `C.UTF-8` does not work.
So maybe `C` is not the best alternative for `C.UTF-8`.

Btw, strangely centos 7 appears to work with the current beta. I don't know what happened. (And I don't know yet, if this behavior is stable).



---

archive/issue_events_395544.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-07-05T19:03:47Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395544"
}
```



---

archive/issue_events_395545.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-07-05T19:03:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395545"
}
```



---

archive/issue_comments_478627.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nAnd it breaks centos 8.",
    "created_at": "2020-07-06T05:53:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478627",
    "user": "https://github.com/kliem"
}
```

<a id='comment:13'>Comment 13:</a>
And it breaks centos 8.



---

archive/issue_comments_478628.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nReplying to [@kliem](#comment%3A12):\n> This breaks building sphinx on windows.\n> \n> https://github.com/kliem/sage/runs/838933940\n> \n> Same error as #30008.\n> \n> As far as I understand the problem is that we need some sort of UTF to make the sphinx build work.\n> It appears that on `cygwin` the default is better than `C` and `C.UTF-8` does not work.\n> So maybe `C` is not the best alternative for `C.UTF-8`.\n\nI'm not sure what you mean here.  `C.UTF-8` is supported on Cygwin and is in fact the default locale in absence of any other settings: https://www.cygwin.com/cygwin-ug-net/setup-locale.html\n\n> The default locale in the absence of the aforementioned locale environment variables is \"C.UTF-8\".",
    "created_at": "2020-07-06T11:07:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478628",
    "user": "https://github.com/embray"
}
```

<a id='comment:14'>Comment 14:</a>
Replying to [@kliem](#comment%3A12):
> This breaks building sphinx on windows.
> 
> https://github.com/kliem/sage/runs/838933940
> 
> Same error as #30008.
> 
> As far as I understand the problem is that we need some sort of UTF to make the sphinx build work.
> It appears that on `cygwin` the default is better than `C` and `C.UTF-8` does not work.
> So maybe `C` is not the best alternative for `C.UTF-8`.

I'm not sure what you mean here.  `C.UTF-8` is supported on Cygwin and is in fact the default locale in absence of any other settings: https://www.cygwin.com/cygwin-ug-net/setup-locale.html

> The default locale in the absence of the aforementioned locale environment variables is "C.UTF-8".



---

archive/issue_comments_478629.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nthe error `UnicodeEncodeError: 'ascii' codec can't encode character '\\xe4' in position 45: ordinal not in range(128)`:\n\n```\n2020-07-05T16:29:58.1676169Z [sphinx-3.0.4.p0] installing. Log file: /cygdrive/d/a/sage/sage/logs/pkgs/sphinx-3.0.4.p0.log\n2020-07-05T16:30:01.7883565Z   [sphinx-3.0.4.p0] error installing, exit status 1. End of log file:\n2020-07-05T16:30:01.8141086Z   [sphinx-3.0.4.p0]   Found local metadata for sphinx-3.0.4.p0\n2020-07-05T16:30:01.8155620Z   [sphinx-3.0.4.p0]   Attempting to download package Sphinx-3.0.4.tar.gz from mirrors\n2020-07-05T16:30:01.8169727Z   [sphinx-3.0.4.p0]   http://mirrors.mit.edu/sage/spkg/upstream/sphinx/Sphinx-3.0.4.tar.gz\n2020-07-05T16:30:01.8174798Z   [sphinx-3.0.4.p0]   [......................................................................]\n2020-07-05T16:30:01.8191111Z   [sphinx-3.0.4.p0]   sphinx-3.0.4.p0\n2020-07-05T16:30:01.8193080Z   [sphinx-3.0.4.p0]   ====================================================\n2020-07-05T16:30:01.8197343Z   [sphinx-3.0.4.p0]   Setting up build directory for sphinx-3.0.4.p0\n2020-07-05T16:30:01.8217424Z   [sphinx-3.0.4.p0]   Traceback (most recent call last):\n2020-07-05T16:30:01.8221790Z   [sphinx-3.0.4.p0]     File \"/cygdrive/d/a/sage/sage/build/bin/sage-uncompress-spkg\", line 23, in <module>\n2020-07-05T16:30:01.8222267Z   [sphinx-3.0.4.p0]       run()\n2020-07-05T16:30:01.8222576Z   [sphinx-3.0.4.p0]     File \"/cygdrive/d/a/sage/sage/build/bin/../sage_bootstrap/uncompress/cmdline.py\", line 72, in run\n2020-07-05T16:30:01.8222857Z   [sphinx-3.0.4.p0]       unpack_archive(archive, dirname)\n2020-07-05T16:30:01.8223251Z   [sphinx-3.0.4.p0]     File \"/cygdrive/d/a/sage/sage/build/bin/../sage_bootstrap/uncompress/action.py\", line 68, in unpack_archive\n2020-07-05T16:30:01.8223583Z   [sphinx-3.0.4.p0]       archive.extractall(members=archive.names)\n2020-07-05T16:30:01.8223861Z   [sphinx-3.0.4.p0]     File \"/cygdrive/d/a/sage/sage/build/bin/../sage_bootstrap/uncompress/tar_file.py\", line 96, in extractall\n2020-07-05T16:30:01.8224117Z   [sphinx-3.0.4.p0]       **kwargs)\n2020-07-05T16:30:01.8224323Z   [sphinx-3.0.4.p0]     File \"/usr/lib/python3.6/tarfile.py\", line 2010, in extractall\n2020-07-05T16:30:01.8224793Z   [sphinx-3.0.4.p0]       numeric_owner=numeric_owner)\n2020-07-05T16:30:01.8225151Z   [sphinx-3.0.4.p0]     File \"/usr/lib/python3.6/tarfile.py\", line 2052, in extract\n2020-07-05T16:30:01.8225442Z   [sphinx-3.0.4.p0]       numeric_owner=numeric_owner)\n2020-07-05T16:30:01.8225898Z   [sphinx-3.0.4.p0]     File \"/cygdrive/d/a/sage/sage/build/bin/../sage_bootstrap/uncompress/tar_file.py\", line 122, in _extract_member\n2020-07-05T16:30:01.8226166Z   [sphinx-3.0.4.p0]       **kwargs)\n2020-07-05T16:30:01.8226601Z   [sphinx-3.0.4.p0]     File \"/usr/lib/python3.6/tarfile.py\", line 2122, in _extract_member\n2020-07-05T16:30:01.8226883Z   [sphinx-3.0.4.p0]       self.makefile(tarinfo, targetpath)\n2020-07-05T16:30:01.8227488Z   [sphinx-3.0.4.p0]     File \"/usr/lib/python3.6/tarfile.py\", line 2163, in makefile\n2020-07-05T16:30:01.8227940Z   [sphinx-3.0.4.p0]       with bltn_open(targetpath, \"wb\") as target:\n2020-07-05T16:30:01.8228249Z   [sphinx-3.0.4.p0]   UnicodeEncodeError: 'ascii' codec can't encode character '\\xe4' in position 45: ordinal not in range(128)\n2020-07-05T16:30:01.8228542Z   [sphinx-3.0.4.p0]   ************************************************************************\n2020-07-05T16:30:01.8228988Z   [sphinx-3.0.4.p0]   Error: failed to extract /cygdrive/d/a/sage/sage/upstream/Sphinx-3.0.4.tar.gz\n2020-07-05T16:30:01.8229264Z   [sphinx-3.0.4.p0]   ************************************************************************\n2020-07-05T16:30:01.8229537Z   [sphinx-3.0.4.p0] Full log file: /cygdrive/d/a/sage/sage/logs/pkgs/sphinx-3.0.4.p0.log\n```",
    "created_at": "2020-07-06T11:13:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478629",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:15'>Comment 15:</a>
the error `UnicodeEncodeError: 'ascii' codec can't encode character '\xe4' in position 45: ordinal not in range(128)`:

```
2020-07-05T16:29:58.1676169Z [sphinx-3.0.4.p0] installing. Log file: /cygdrive/d/a/sage/sage/logs/pkgs/sphinx-3.0.4.p0.log
2020-07-05T16:30:01.7883565Z   [sphinx-3.0.4.p0] error installing, exit status 1. End of log file:
2020-07-05T16:30:01.8141086Z   [sphinx-3.0.4.p0]   Found local metadata for sphinx-3.0.4.p0
2020-07-05T16:30:01.8155620Z   [sphinx-3.0.4.p0]   Attempting to download package Sphinx-3.0.4.tar.gz from mirrors
2020-07-05T16:30:01.8169727Z   [sphinx-3.0.4.p0]   http://mirrors.mit.edu/sage/spkg/upstream/sphinx/Sphinx-3.0.4.tar.gz
2020-07-05T16:30:01.8174798Z   [sphinx-3.0.4.p0]   [......................................................................]
2020-07-05T16:30:01.8191111Z   [sphinx-3.0.4.p0]   sphinx-3.0.4.p0
2020-07-05T16:30:01.8193080Z   [sphinx-3.0.4.p0]   ====================================================
2020-07-05T16:30:01.8197343Z   [sphinx-3.0.4.p0]   Setting up build directory for sphinx-3.0.4.p0
2020-07-05T16:30:01.8217424Z   [sphinx-3.0.4.p0]   Traceback (most recent call last):
2020-07-05T16:30:01.8221790Z   [sphinx-3.0.4.p0]     File "/cygdrive/d/a/sage/sage/build/bin/sage-uncompress-spkg", line 23, in <module>
2020-07-05T16:30:01.8222267Z   [sphinx-3.0.4.p0]       run()
2020-07-05T16:30:01.8222576Z   [sphinx-3.0.4.p0]     File "/cygdrive/d/a/sage/sage/build/bin/../sage_bootstrap/uncompress/cmdline.py", line 72, in run
2020-07-05T16:30:01.8222857Z   [sphinx-3.0.4.p0]       unpack_archive(archive, dirname)
2020-07-05T16:30:01.8223251Z   [sphinx-3.0.4.p0]     File "/cygdrive/d/a/sage/sage/build/bin/../sage_bootstrap/uncompress/action.py", line 68, in unpack_archive
2020-07-05T16:30:01.8223583Z   [sphinx-3.0.4.p0]       archive.extractall(members=archive.names)
2020-07-05T16:30:01.8223861Z   [sphinx-3.0.4.p0]     File "/cygdrive/d/a/sage/sage/build/bin/../sage_bootstrap/uncompress/tar_file.py", line 96, in extractall
2020-07-05T16:30:01.8224117Z   [sphinx-3.0.4.p0]       **kwargs)
2020-07-05T16:30:01.8224323Z   [sphinx-3.0.4.p0]     File "/usr/lib/python3.6/tarfile.py", line 2010, in extractall
2020-07-05T16:30:01.8224793Z   [sphinx-3.0.4.p0]       numeric_owner=numeric_owner)
2020-07-05T16:30:01.8225151Z   [sphinx-3.0.4.p0]     File "/usr/lib/python3.6/tarfile.py", line 2052, in extract
2020-07-05T16:30:01.8225442Z   [sphinx-3.0.4.p0]       numeric_owner=numeric_owner)
2020-07-05T16:30:01.8225898Z   [sphinx-3.0.4.p0]     File "/cygdrive/d/a/sage/sage/build/bin/../sage_bootstrap/uncompress/tar_file.py", line 122, in _extract_member
2020-07-05T16:30:01.8226166Z   [sphinx-3.0.4.p0]       **kwargs)
2020-07-05T16:30:01.8226601Z   [sphinx-3.0.4.p0]     File "/usr/lib/python3.6/tarfile.py", line 2122, in _extract_member
2020-07-05T16:30:01.8226883Z   [sphinx-3.0.4.p0]       self.makefile(tarinfo, targetpath)
2020-07-05T16:30:01.8227488Z   [sphinx-3.0.4.p0]     File "/usr/lib/python3.6/tarfile.py", line 2163, in makefile
2020-07-05T16:30:01.8227940Z   [sphinx-3.0.4.p0]       with bltn_open(targetpath, "wb") as target:
2020-07-05T16:30:01.8228249Z   [sphinx-3.0.4.p0]   UnicodeEncodeError: 'ascii' codec can't encode character '\xe4' in position 45: ordinal not in range(128)
2020-07-05T16:30:01.8228542Z   [sphinx-3.0.4.p0]   ************************************************************************
2020-07-05T16:30:01.8228988Z   [sphinx-3.0.4.p0]   Error: failed to extract /cygdrive/d/a/sage/sage/upstream/Sphinx-3.0.4.tar.gz
2020-07-05T16:30:01.8229264Z   [sphinx-3.0.4.p0]   ************************************************************************
2020-07-05T16:30:01.8229537Z   [sphinx-3.0.4.p0] Full log file: /cygdrive/d/a/sage/sage/logs/pkgs/sphinx-3.0.4.p0.log
```



---

archive/issue_comments_478630.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\ncould it be that `locale` on Cygwin is not installed by default?\n\nHowever, https://www.cygwin.com/cygwin-ug-net/setup-locale.html says:\n\n```\nNote\nFor a list of locales supported by your Windows machine, use the new locale -a command, which is part of the Cygwin package. For a description see locale(1)\n```",
    "created_at": "2020-07-06T11:15:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478630",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:16'>Comment 16:</a>
could it be that `locale` on Cygwin is not installed by default?

However, https://www.cygwin.com/cygwin-ug-net/setup-locale.html says:

```
Note
For a list of locales supported by your Windows machine, use the new locale -a command, which is part of the Cygwin package. For a description see locale(1)
```



---

archive/issue_comments_478631.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nReplying to [@kliem](#comment%3A8):\n> I started test runs:\n> \n> https://github.com/kliem/sage/pull/20/checks\n\nI just started rerunning those tests on top of the current beta. Maybe that stuff just goes away by itself.",
    "created_at": "2020-07-12T19:40:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478631",
    "user": "https://github.com/kliem"
}
```

<a id='comment:17'>Comment 17:</a>
Replying to [@kliem](#comment%3A8):
> I started test runs:
> 
> https://github.com/kliem/sage/pull/20/checks

I just started rerunning those tests on top of the current beta. Maybe that stuff just goes away by itself.



---

archive/issue_comments_478632.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nStill causes this error.",
    "created_at": "2020-07-12T22:31:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478632",
    "user": "https://github.com/kliem"
}
```

<a id='comment:18'>Comment 18:</a>
Still causes this error.



---

archive/issue_comments_478633.json:
```json
{
    "body": "<a id='comment:19'>Comment 19:</a>\nIf the centos issue is caused by the sphinx upgrade (according to #30008), why is it blocking this? This is meant to fix another (very annoying) issue on Arch.",
    "created_at": "2020-07-23T19:31:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478633",
    "user": "https://github.com/antonio-rojas"
}
```

<a id='comment:19'>Comment 19:</a>
If the centos issue is caused by the sphinx upgrade (according to #30008), why is it blocking this? This is meant to fix another (very annoying) issue on Arch.



---

archive/issue_comments_478634.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nIt appears that #30008 fixed itself. However, this here broke the cygwin sphinx build, last I checked.\n\nIt have no clue what is going on, but with this ticket we go from passing to failing.",
    "created_at": "2020-07-23T20:33:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478634",
    "user": "https://github.com/kliem"
}
```

<a id='comment:20'>Comment 20:</a>
It appears that #30008 fixed itself. However, this here broke the cygwin sphinx build, last I checked.

It have no clue what is going on, but with this ticket we go from passing to failing.



---

archive/issue_comments_478635.json:
```json
{
    "body": "<a id='comment:21'>Comment 21:</a>\nIt seems a default setting on Cygwin is `LANG=en_US.UTF-8`. Perhaps we can try to only set `LC_ALL` if `LANG` is not already set or something like this.",
    "created_at": "2020-07-23T21:09:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478635",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'>Comment 21:</a>
It seems a default setting on Cygwin is `LANG=en_US.UTF-8`. Perhaps we can try to only set `LC_ALL` if `LANG` is not already set or something like this.



---

archive/issue_comments_478636.json:
```json
{
    "body": "<a id='comment:22'>Comment 22:</a>\nAlso it should be investigated whether it was really necessary to add this line in #29033 to achieve Python 3.6 support. In particular note that `sage-uncompress-spkg` uses `sage-system-python` (which can even be python2) -- which really has nothing to do with Python 3.6 support (which is about `PYTHON_FOR_VENV`).",
    "created_at": "2020-07-23T22:42:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478636",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'>Comment 22:</a>
Also it should be investigated whether it was really necessary to add this line in #29033 to achieve Python 3.6 support. In particular note that `sage-uncompress-spkg` uses `sage-system-python` (which can even be python2) -- which really has nothing to do with Python 3.6 support (which is about `PYTHON_FOR_VENV`).



---

archive/issue_comments_478637.json:
```json
{
    "body": "<a id='comment:25'>Comment 25:</a>\nWhat problems arise if we drop the locale mangling entirely? Trac #15791 doesn't mention a problem.",
    "created_at": "2020-08-05T14:19:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478637",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:25'>Comment 25:</a>
What problems arise if we drop the locale mangling entirely? Trac #15791 doesn't mention a problem.



---

archive/issue_events_395546.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-11T01:41:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395546"
}
```



---

archive/issue_events_395547.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-11T01:41:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "label": "https://github.com/sagemath/sage/labels/p1%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395547"
}
```



---

archive/issue_comments_478638.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,2 +1,5 @@\n In #29033 in `build/bin/sage-spkg` LC_ALL was changed to C.UTF-8\n However, not all systems have it. \n+\n+There are also some other locale problems that show up in doctests\n+(for example https://groups.google.com/d/msg/sage-release/spalYgXKr-4/ZVsbgHIlAgAJ)\n``````\n",
    "created_at": "2020-08-12T00:05:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478638",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,2 +1,5 @@
 In #29033 in `build/bin/sage-spkg` LC_ALL was changed to C.UTF-8
 However, not all systems have it. 
+
+There are also some other locale problems that show up in doctests
+(for example https://groups.google.com/d/msg/sage-release/spalYgXKr-4/ZVsbgHIlAgAJ)
``````




---

archive/issue_events_395548.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-12T00:07:34Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "title_is": "setlocale: LC_ALL: cannot change locale (C.UTF-8) from build/bin/sage-spkg and in doctests",
    "title_was": "setlocale: LC_ALL: cannot change locale (C.UTF-8) from build/bin/sage-spkg",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395548"
}
```



---

archive/issue_comments_478639.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -3,3 +3,7 @@\n \n There are also some other locale problems that show up in doctests\n (for example https://groups.google.com/d/msg/sage-release/spalYgXKr-4/ZVsbgHIlAgAJ)\n+\n+\n+See also:\n+- #22659\n``````\n",
    "created_at": "2020-08-12T00:08:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478639",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -3,3 +3,7 @@
 
 There are also some other locale problems that show up in doctests
 (for example https://groups.google.com/d/msg/sage-release/spalYgXKr-4/ZVsbgHIlAgAJ)
+
+
+See also:
+- #22659
``````




---

archive/issue_comments_478640.json:
```json
{
    "body": "<a id='comment:30'>Comment 30:</a>\nI am not sure if this is related, but while compiling Cypari on macOS, every file gives a warning of this type:\n\n```\n     Colperl: warning: Setting locale failed.\n    perl: warning: Please check that your locale settings:\n        LC_ALL = \"C.UTF-8\",\n        LC_TERMINAL = \"iTerm2\",\n        LANG = \"de_DE.UTF-8\"\n        are supported and installed on your system.\n    perl: warning: Falling back to a fallback locale (\"de_DE.UTF-8\").\n```\nThe fallback that is used seems to work for me, though.",
    "created_at": "2020-08-26T16:19:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478640",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:30'>Comment 30:</a>
I am not sure if this is related, but while compiling Cypari on macOS, every file gives a warning of this type:

```
     Colperl: warning: Setting locale failed.
    perl: warning: Please check that your locale settings:
        LC_ALL = "C.UTF-8",
        LC_TERMINAL = "iTerm2",
        LANG = "de_DE.UTF-8"
        are supported and installed on your system.
    perl: warning: Falling back to a fallback locale ("de_DE.UTF-8").
```
The fallback that is used seems to work for me, though.



---

archive/issue_comments_478641.json:
```json
{
    "body": "<a id='comment:31'>Comment 31:</a>\nI just did a fresh build with `LC_ALL=C` and see no outstanding problems (python-3.7.8).\n\nMaybe we should just revert that line? Why rock the boat?\n\nErik is the only other person who might know why it was added.",
    "created_at": "2020-08-29T01:47:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478641",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:31'>Comment 31:</a>
I just did a fresh build with `LC_ALL=C` and see no outstanding problems (python-3.7.8).

Maybe we should just revert that line? Why rock the boat?

Erik is the only other person who might know why it was added.



---

archive/issue_comments_478642.json:
```json
{
    "body": "<a id='comment:32'>Comment 32:</a>\nThis will need testing on `centos-8` with Python 3.6",
    "created_at": "2020-08-29T04:17:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478642",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:32'>Comment 32:</a>
This will need testing on `centos-8` with Python 3.6



---

archive/issue_comments_478643.json:
```json
{
    "body": "<a id='comment:33'>Comment 33:</a>\nReplying to [@orlitzky](#comment%3A31):\n> I just did a fresh build with `LC_ALL=C` and see no outstanding problems (python-3.7.8).\n> \n> Maybe we should just revert that line? Why rock the boat?\n\nNo. This was added for reasons.  Specifically to ensure compatibility between how Python 3.6 and Python 3.7 set the default encoding.  Without this, there were bugs on Python 3.6 with Python not using a unicode character encoding by default.  See https://www.python.org/dev/peps/pep-0538/\n\n> The simplest way to deal with this problem for currently released versions of CPython is to explicitly set a more sensible locale when launching the application. For example:\n\n>\n>     LC_CTYPE=C.UTF-8 python3 ...\n> The C.UTF-8 locale is a full locale definition that uses UTF-8 for the LC_CTYPE category, and the same settings as the C locale for all other categories (including LC_COLLATE). It is offered by a number of Linux distributions (including Debian, Ubuntu, Fedora, Alpine and Android) as an alternative to the ASCII-based C locale. Some other platforms (such as HP-UX) offer an equivalent locale definition under the name C.utf8.\n> \n> Mac OS X and other *BSD systems have taken a different approach: instead of offering a C.UTF-8 locale, they offer a partial UTF-8 locale that only defines the LC_CTYPE category. On such systems, the preferred environmental locale adjustment is to set LC_CTYPE=UTF-8 rather than to set LC_ALL or LANG. \n\nPerhaps this should also try the `LC_CTYPE=UTF-8` mentioned here.  Otherwise Dima's approach makes sense, though it can't guarantee that everything will just work on those systems.  I can't recall exactly what broke without it but I do recall there was something.  With Python 3.7 (the default when not using the system Python) this shouldn't be a problem since Python will basically force a UTF-8 locale for itself.",
    "created_at": "2020-08-31T13:04:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478643",
    "user": "https://github.com/embray"
}
```

<a id='comment:33'>Comment 33:</a>
Replying to [@orlitzky](#comment%3A31):
> I just did a fresh build with `LC_ALL=C` and see no outstanding problems (python-3.7.8).
> 
> Maybe we should just revert that line? Why rock the boat?

No. This was added for reasons.  Specifically to ensure compatibility between how Python 3.6 and Python 3.7 set the default encoding.  Without this, there were bugs on Python 3.6 with Python not using a unicode character encoding by default.  See https://www.python.org/dev/peps/pep-0538/

> The simplest way to deal with this problem for currently released versions of CPython is to explicitly set a more sensible locale when launching the application. For example:

>
>     LC_CTYPE=C.UTF-8 python3 ...
> The C.UTF-8 locale is a full locale definition that uses UTF-8 for the LC_CTYPE category, and the same settings as the C locale for all other categories (including LC_COLLATE). It is offered by a number of Linux distributions (including Debian, Ubuntu, Fedora, Alpine and Android) as an alternative to the ASCII-based C locale. Some other platforms (such as HP-UX) offer an equivalent locale definition under the name C.utf8.
> 
> Mac OS X and other *BSD systems have taken a different approach: instead of offering a C.UTF-8 locale, they offer a partial UTF-8 locale that only defines the LC_CTYPE category. On such systems, the preferred environmental locale adjustment is to set LC_CTYPE=UTF-8 rather than to set LC_ALL or LANG. 

Perhaps this should also try the `LC_CTYPE=UTF-8` mentioned here.  Otherwise Dima's approach makes sense, though it can't guarantee that everything will just work on those systems.  I can't recall exactly what broke without it but I do recall there was something.  With Python 3.7 (the default when not using the system Python) this shouldn't be a problem since Python will basically force a UTF-8 locale for itself.



---

archive/issue_comments_478644.json:
```json
{
    "body": "<a id='comment:34'>Comment 34:</a>\nReplying to [@embray](#comment%3A33):\n\n> \n> Perhaps this should also try the `LC_CTYPE=UTF-8` mentioned here.  Otherwise Dima's approach makes sense, though it can't guarantee that everything will just work on those systems.  I can't recall exactly what broke without it but I do recall there was something.  With Python 3.7 (the default when not using the system Python) this shouldn't be a problem since Python will basically force a UTF-8 locale for itself.\n\nHow about only doing this `export LC_...=` on Python3.x with x<7 ?\nThis should in particular make Arch people (apparently Arch has no C.UTF-8 or a similar locale,\neverything UTF-8 there is language-specific) happy, as their Python is new enough.",
    "created_at": "2020-08-31T13:09:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478644",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:34'>Comment 34:</a>
Replying to [@embray](#comment%3A33):

> 
> Perhaps this should also try the `LC_CTYPE=UTF-8` mentioned here.  Otherwise Dima's approach makes sense, though it can't guarantee that everything will just work on those systems.  I can't recall exactly what broke without it but I do recall there was something.  With Python 3.7 (the default when not using the system Python) this shouldn't be a problem since Python will basically force a UTF-8 locale for itself.

How about only doing this `export LC_...=` on Python3.x with x<7 ?
This should in particular make Arch people (apparently Arch has no C.UTF-8 or a similar locale,
everything UTF-8 there is language-specific) happy, as their Python is new enough.



---

archive/issue_comments_478645.json:
```json
{
    "body": "<a id='comment:35'>Comment 35:</a>\nOk, thanks for the information. I think the major take-away from PEP538 is,\n\n> With this change, any *nix platform that does not offer at least one of the C.UTF-8, C.utf8 or UTF-8 locales as part of its standard configuration would only be considered a fully supported platform for CPython 3.7+ deployments when a suitable locale other than the default C locale is configured explicitly (e.g. en_AU.UTF-8, zh_CN.gb18030).\n\nI'm pretty sure we have files that actually need the UTF-8 encoding by now, so that rules out the possibility of \"doing nothing\" (leaving `LC_ALL=C` or `LC_CTYPE=C`) on python-3.6. And if we want to make python-3.6 work the way that python-3.7 does, then we're in the same situation as upstream is with respect to C.UTF-8: we have to consider python-3.6 with no C.UTF-8 (or equivalent) unsupported.\n\nSo I see two real options left:\n\n1. Try to set the locale to `C.UTF-8` or `C.utf8` or `UTF-8` when python-3.6 is being used, and declare the system unsupported if we can't. If python-3.7+ is being used, we can set the locale to `C`, and it will coerce the locale to something utf8ish on its own. In either case, a lack of utf8 locale would be unsupported.\n2. Don't set a locale at all, and rely on the distribution/user to set a utf8 locale by default. This would result in some confusing grep/sort behavior (they're locale-dependent), but maybe we could be extra careful in our SPKGs to work around that, so that e.g. `en_US.UTF-8` would work too.\n\nLong-term, as one of the largest python projects in existence, I think we probably have to suck it up and go with (1), even though it pains me to require a locale that glibc doesn't even ship and isn't POSIX. Whatever decisions python makes, we're stuck with.",
    "created_at": "2020-08-31T14:05:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478645",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:35'>Comment 35:</a>
Ok, thanks for the information. I think the major take-away from PEP538 is,

> With this change, any *nix platform that does not offer at least one of the C.UTF-8, C.utf8 or UTF-8 locales as part of its standard configuration would only be considered a fully supported platform for CPython 3.7+ deployments when a suitable locale other than the default C locale is configured explicitly (e.g. en_AU.UTF-8, zh_CN.gb18030).

I'm pretty sure we have files that actually need the UTF-8 encoding by now, so that rules out the possibility of "doing nothing" (leaving `LC_ALL=C` or `LC_CTYPE=C`) on python-3.6. And if we want to make python-3.6 work the way that python-3.7 does, then we're in the same situation as upstream is with respect to C.UTF-8: we have to consider python-3.6 with no C.UTF-8 (or equivalent) unsupported.

So I see two real options left:

1. Try to set the locale to `C.UTF-8` or `C.utf8` or `UTF-8` when python-3.6 is being used, and declare the system unsupported if we can't. If python-3.7+ is being used, we can set the locale to `C`, and it will coerce the locale to something utf8ish on its own. In either case, a lack of utf8 locale would be unsupported.
2. Don't set a locale at all, and rely on the distribution/user to set a utf8 locale by default. This would result in some confusing grep/sort behavior (they're locale-dependent), but maybe we could be extra careful in our SPKGs to work around that, so that e.g. `en_US.UTF-8` would work too.

Long-term, as one of the largest python projects in existence, I think we probably have to suck it up and go with (1), even though it pains me to require a locale that glibc doesn't even ship and isn't POSIX. Whatever decisions python makes, we're stuck with.



---

archive/issue_comments_478646.json:
```json
{
    "body": "<a id='comment:36'>Comment 36:</a>\nReplying to [@dimpase](#comment%3A34):\n> \n> How about only doing this `export LC_...=` on Python3.x with x<7 ?\n> This should in particular make Arch people (apparently Arch has no C.UTF-8 or a similar locale,\n> everything UTF-8 there is language-specific) happy, as their Python is new enough.\n\nI think a combination of this and the current branch is the best we can do. On python-3.6, we should try to set `LC_ALL` to `C.UTF-8`, `C.utf8`, or `UTF-8`. If we can't, then we should leave it alone and pray that the user's locale is compatible with all of our SPKGs. That situation would be unsupported by sage.\n\nOn python-3.7+, we can set `LC_ALL=C`, and python itself will try to pick an appropriate UTF-8 version of the locale. What does python on arch do in this situation? It's possible that python itself will fail to find a suitable UTF-8 locale, but there's not a lot we can do if upstream python insists on a nonstandard locale. Arch will just have to reconsider their decision unless they want to be not-fully supported by upstream python-3.7+.",
    "created_at": "2020-08-31T14:15:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478646",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:36'>Comment 36:</a>
Replying to [@dimpase](#comment%3A34):
> 
> How about only doing this `export LC_...=` on Python3.x with x<7 ?
> This should in particular make Arch people (apparently Arch has no C.UTF-8 or a similar locale,
> everything UTF-8 there is language-specific) happy, as their Python is new enough.

I think a combination of this and the current branch is the best we can do. On python-3.6, we should try to set `LC_ALL` to `C.UTF-8`, `C.utf8`, or `UTF-8`. If we can't, then we should leave it alone and pray that the user's locale is compatible with all of our SPKGs. That situation would be unsupported by sage.

On python-3.7+, we can set `LC_ALL=C`, and python itself will try to pick an appropriate UTF-8 version of the locale. What does python on arch do in this situation? It's possible that python itself will fail to find a suitable UTF-8 locale, but there's not a lot we can do if upstream python insists on a nonstandard locale. Arch will just have to reconsider their decision unless they want to be not-fully supported by upstream python-3.7+.



---

archive/issue_comments_478647.json:
```json
{
    "body": "<a id='comment:37'>Comment 37:</a>\nPersonally I don't care what glibc or POSIX say on this.  I think 1) is a fine option.",
    "created_at": "2020-08-31T14:18:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478647",
    "user": "https://github.com/embray"
}
```

<a id='comment:37'>Comment 37:</a>
Personally I don't care what glibc or POSIX say on this.  I think 1) is a fine option.



---

archive/issue_comments_478648.json:
```json
{
    "body": "<a id='comment:38'>Comment 38:</a>\nApparently we carry the C.UTF-8 patch in Gentoo for systemd, who definitely don't care about portability:\n\nhttps://github.com/systemd/systemd/pull/10742",
    "created_at": "2020-08-31T14:29:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478648",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:38'>Comment 38:</a>
Apparently we carry the C.UTF-8 patch in Gentoo for systemd, who definitely don't care about portability:

https://github.com/systemd/systemd/pull/10742



---

archive/issue_comments_478649.json:
```json
{
    "body": "<a id='comment:39'>Comment 39:</a>\nIs anyone working on this?",
    "created_at": "2020-09-07T18:37:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478649",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:39'>Comment 39:</a>
Is anyone working on this?



---

archive/issue_comments_478650.json:
```json
{
    "body": "<a id='comment:40'>Comment 40:</a>\nSage-the-python-library can't realistically support anything that CPython does not; Its 2020, who in their right mind doesn't support utf-8? Better diagnostics for non-compliant systems would be great but imho not a blocker.",
    "created_at": "2020-09-08T07:53:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478650",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:40'>Comment 40:</a>
Sage-the-python-library can't realistically support anything that CPython does not; Its 2020, who in their right mind doesn't support utf-8? Better diagnostics for non-compliant systems would be great but imho not a blocker.



---

archive/issue_events_395549.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-09-08T07:53:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "label": "https://github.com/sagemath/sage/labels/p1%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395549"
}
```



---

archive/issue_events_395550.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-09-08T07:53:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395550"
}
```



---

archive/issue_comments_478651.json:
```json
{
    "body": "<a id='comment:41'>Comment 41:</a>\nReplying to [@vbraun](#comment%3A40):\n> Sage-the-python-library can't realistically support anything that CPython does not; Its 2020, who in their right mind doesn't support utf-8? Better diagnostics for non-compliant systems would be great but imho not a blocker.\n\nThese systems do support UTF-8, but not the (as of yet) non-standard `C.UTF-8` locale.\n\nThe current branch has the right idea, but since python-3.6 and python-3.7 act differently, it can be made a bit more precise. With python-3.7+, we can set `LC_ALL=C` and let python do the guessing. (Maybe it doesn't succeed, but officially Not Our Problem at that point.) With python-3.6, we can check for the `C.UTF-8` locale and set it when found, with a fallback to `LC_ALL=C`. The current branch does this unconditionally but, it should only do it for python-3.6 and we should check the other equivalent names `C.utf8` and `UTF-8` too.\n\nI think it's worthwhile to not output a million scary error messages in the sage-9.2 release on these systems that have done nothing wrong. At the very least, we owe it to the Arch maintainers who do a lot for sage and would have to field the resulting bug reports (or patch this themselves). I'm sure there are BSDs where this is problematic too.",
    "created_at": "2020-09-08T14:16:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478651",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:41'>Comment 41:</a>
Replying to [@vbraun](#comment%3A40):
> Sage-the-python-library can't realistically support anything that CPython does not; Its 2020, who in their right mind doesn't support utf-8? Better diagnostics for non-compliant systems would be great but imho not a blocker.

These systems do support UTF-8, but not the (as of yet) non-standard `C.UTF-8` locale.

The current branch has the right idea, but since python-3.6 and python-3.7 act differently, it can be made a bit more precise. With python-3.7+, we can set `LC_ALL=C` and let python do the guessing. (Maybe it doesn't succeed, but officially Not Our Problem at that point.) With python-3.6, we can check for the `C.UTF-8` locale and set it when found, with a fallback to `LC_ALL=C`. The current branch does this unconditionally but, it should only do it for python-3.6 and we should check the other equivalent names `C.utf8` and `UTF-8` too.

I think it's worthwhile to not output a million scary error messages in the sage-9.2 release on these systems that have done nothing wrong. At the very least, we owe it to the Arch maintainers who do a lot for sage and would have to field the resulting bug reports (or patch this themselves). I'm sure there are BSDs where this is problematic too.



---

archive/issue_comments_478652.json:
```json
{
    "body": "<a id='comment:42'>Comment 42:</a>\nArch locales maintainers just need to get C.UTF-8 locale, they are being silly  (their argument - \"it's an evil coming from Debian\" - and I'm told they don't reopen the corresponding issue, as it's \"decided\". Meanwhile everybody else has C.UTF-8 locale, it's just them who don't)",
    "created_at": "2020-09-10T15:30:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478652",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:42'>Comment 42:</a>
Arch locales maintainers just need to get C.UTF-8 locale, they are being silly  (their argument - "it's an evil coming from Debian" - and I'm told they don't reopen the corresponding issue, as it's "decided". Meanwhile everybody else has C.UTF-8 locale, it's just them who don't)



---

archive/issue_comments_478653.json:
```json
{
    "body": "<a id='comment:43'>Comment 43:</a>\nIt's a blocker because it is a regression regarding platform support.\n\nCan we please get a fix done?",
    "created_at": "2020-09-10T15:55:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478653",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:43'>Comment 43:</a>
It's a blocker because it is a regression regarding platform support.

Can we please get a fix done?



---

archive/issue_events_395551.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-10T15:55:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395551"
}
```



---

archive/issue_events_395552.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-10T15:55:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "label": "https://github.com/sagemath/sage/labels/p1%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395552"
}
```



---

archive/issue_comments_478654.json:
```json
{
    "body": "<a id='comment:44'>Comment 44:</a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e5f6663372fab14c6a386004a925de59be216f31\">e5f6663</a></td><td><code>only use locale C.UTF-8 if available, else C</code></td></tr></table>\n",
    "created_at": "2020-09-10T16:05:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478654",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:44'>Comment 44:</a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e5f6663372fab14c6a386004a925de59be216f31">e5f6663</a></td><td><code>only use locale C.UTF-8 if available, else C</code></td></tr></table>




---

archive/issue_comments_478655.json:
```json
{
    "body": "Changed commit from **[37e042c](https://github.com/sagemath/sagetrac-mirror/commit/37e042c44d71e841e19fcf70b6995a0f9b3c4ec2)** to **[e5f6663](https://github.com/sagemath/sagetrac-mirror/commit/e5f6663372fab14c6a386004a925de59be216f31)**",
    "created_at": "2020-09-10T16:05:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478655",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[37e042c](https://github.com/sagemath/sagetrac-mirror/commit/37e042c44d71e841e19fcf70b6995a0f9b3c4ec2)** to **[e5f6663](https://github.com/sagemath/sagetrac-mirror/commit/e5f6663372fab14c6a386004a925de59be216f31)**



---

archive/issue_comments_478656.json:
```json
{
    "body": "<a id='comment:45'>Comment 45:</a>\nrebased over the latest beta",
    "created_at": "2020-09-10T16:07:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478656",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:45'>Comment 45:</a>
rebased over the latest beta



---

archive/issue_comments_478657.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,6 +4,17 @@\n There are also some other locale problems that show up in doctests\n (for example https://groups.google.com/d/msg/sage-release/spalYgXKr-4/ZVsbgHIlAgAJ)\n \n+And a failure building the documentation on `ubuntu-bionic-standard` (using `/usr/bin/python3.6`, https://github.com/mkoeppe/sage/runs/1106251169):\n+\n+```\n+  [dochtml]   UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 2661: ordinal not in range(128)\n+  [dochtml] Full log file: logs/dochtml.log\n+Makefile:1876: recipe for target 'doc-html' failed\n+```\n+\n+\n+\n+\n \n See also:\n - #22659\n``````\n",
    "created_at": "2020-09-13T03:19:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478657",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,6 +4,17 @@
 There are also some other locale problems that show up in doctests
 (for example https://groups.google.com/d/msg/sage-release/spalYgXKr-4/ZVsbgHIlAgAJ)
 
+And a failure building the documentation on `ubuntu-bionic-standard` (using `/usr/bin/python3.6`, https://github.com/mkoeppe/sage/runs/1106251169):
+
+```
+  [dochtml]   UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 2661: ordinal not in range(128)
+  [dochtml] Full log file: logs/dochtml.log
+Makefile:1876: recipe for target 'doc-html' failed
+```
+
+
+
+
 
 See also:
 - #22659
``````




---

archive/issue_comments_478658.json:
```json
{
    "body": "<a id='comment:47'>Comment 47:</a>\nUsing a freshly installed Ubuntu 18.04 (bionic) and with some french settings set somewhere so that `$ git pull` returns `D\u00e9j\u00e0 \u00e0 jour`, a french equivalent for `Already up to date`, running make on `9.2.beta12` yields the `[dochtml] UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 2661: ordinal not in range(128)` error, see [this post](https://groups.google.com/g/sage-release/c/hobZzw74Rv0/m/bIvvvlXhAAAJ), right from the start of the build of the documentation.\n\nWith beta12 + current branch, I still get the same error after  `make doc-clean && make`.",
    "created_at": "2020-09-14T12:24:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478658",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:47'>Comment 47:</a>
Using a freshly installed Ubuntu 18.04 (bionic) and with some french settings set somewhere so that `$ git pull` returns `Dj  jour`, a french equivalent for `Already up to date`, running make on `9.2.beta12` yields the `[dochtml] UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 2661: ordinal not in range(128)` error, see [this post](https://groups.google.com/g/sage-release/c/hobZzw74Rv0/m/bIvvvlXhAAAJ), right from the start of the build of the documentation.

With beta12 + current branch, I still get the same error after  `make doc-clean && make`.



---

archive/issue_comments_478659.json:
```json
{
    "body": "<a id='comment:48'>Comment 48:</a>\nThat being said, I now see where it comes from:\n\n```\nsage: with open('src/doc/en/reference/references/index.rst', 'r') as f: s = f.read()                              \nsage: s[2600:2700]                                                                                   \n' characteristic,* The Open Book Series, vol. 2, no. 1, pp. 37\u201353, Jan. 2019.\\n\\n.. [ABZ2007] \\\\R. Aharo'\nsage: s[2661:2700]                                                                                   \n'\u201353, Jan. 2019.\\n\\n.. [ABZ2007] \\\\R. Aharo'\n```\n\nThe character `\u2013` has many occurrences in that file and is possibly not the only occurrence of a nonascii character (for example names of authors...). So, I am not sure replacing them by `--` is the correct fix. And I don't see how this is related at all with the `C.UTF-8` configuration.",
    "created_at": "2020-09-14T12:41:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478659",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:48'>Comment 48:</a>
That being said, I now see where it comes from:

```
sage: with open('src/doc/en/reference/references/index.rst', 'r') as f: s = f.read()                              
sage: s[2600:2700]                                                                                   
' characteristic,* The Open Book Series, vol. 2, no. 1, pp. 3753, Jan. 2019.\n\n.. [ABZ2007] \\R. Aharo'
sage: s[2661:2700]                                                                                   
'53, Jan. 2019.\n\n.. [ABZ2007] \\R. Aharo'
```

The character `` has many occurrences in that file and is possibly not the only occurrence of a nonascii character (for example names of authors...). So, I am not sure replacing them by `--` is the correct fix. And I don't see how this is related at all with the `C.UTF-8` configuration.



---

archive/issue_comments_478660.json:
```json
{
    "body": "<a id='comment:49'>Comment 49:</a>\nSo your machine has no C.UTF-8 locale installed, right?",
    "created_at": "2020-09-14T13:37:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478660",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:49'>Comment 49:</a>
So your machine has no C.UTF-8 locale installed, right?



---

archive/issue_comments_478661.json:
```json
{
    "body": "<a id='comment:50'>Comment 50:</a>\nHow can I figure this out? If it can help, I have this:\n\n```\n$ locale\nLANG=fr_CA.UTF-8\nLANGUAGE=fr_CA:fr_FR:en_GB:en\nLC_CTYPE=\"fr_CA.UTF-8\"\nLC_NUMERIC=fr_FR.UTF-8\nLC_TIME=fr_FR.UTF-8\nLC_COLLATE=\"fr_CA.UTF-8\"\nLC_MONETARY=fr_FR.UTF-8\nLC_MESSAGES=\"fr_CA.UTF-8\"\nLC_PAPER=fr_FR.UTF-8\nLC_NAME=fr_FR.UTF-8\nLC_ADDRESS=fr_FR.UTF-8\nLC_TELEPHONE=fr_FR.UTF-8\nLC_MEASUREMENT=fr_FR.UTF-8\nLC_IDENTIFICATION=fr_FR.UTF-8\nLC_ALL=\nslabbe@miami ~ $ man locale\nslabbe@miami ~ $ locale -a\nC\nC.UTF-8\nen_AG\nen_AG.utf8\nen_AU.utf8\nen_BW.utf8\nen_CA.utf8\nen_DK.utf8\nen_GB.utf8\nen_HK.utf8\nen_IE.utf8\nen_IL\nen_IL.utf8\nen_IN\nen_IN.utf8\nen_NG\nen_NG.utf8\nen_NZ.utf8\nen_PH.utf8\nen_SG.utf8\nen_US.utf8\nen_ZA.utf8\nen_ZM\nen_ZM.utf8\nen_ZW.utf8\nfr_BE.utf8\nfr_CA.utf8\nfr_CH.utf8\nfrench\nfr_FR\nfr_FR.iso88591\nfr_FR.utf8\nfr_LU.utf8\nPOSIX\n```",
    "created_at": "2020-09-14T13:50:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478661",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:50'>Comment 50:</a>
How can I figure this out? If it can help, I have this:

```
$ locale
LANG=fr_CA.UTF-8
LANGUAGE=fr_CA:fr_FR:en_GB:en
LC_CTYPE="fr_CA.UTF-8"
LC_NUMERIC=fr_FR.UTF-8
LC_TIME=fr_FR.UTF-8
LC_COLLATE="fr_CA.UTF-8"
LC_MONETARY=fr_FR.UTF-8
LC_MESSAGES="fr_CA.UTF-8"
LC_PAPER=fr_FR.UTF-8
LC_NAME=fr_FR.UTF-8
LC_ADDRESS=fr_FR.UTF-8
LC_TELEPHONE=fr_FR.UTF-8
LC_MEASUREMENT=fr_FR.UTF-8
LC_IDENTIFICATION=fr_FR.UTF-8
LC_ALL=
slabbe@miami ~ $ man locale
slabbe@miami ~ $ locale -a
C
C.UTF-8
en_AG
en_AG.utf8
en_AU.utf8
en_BW.utf8
en_CA.utf8
en_DK.utf8
en_GB.utf8
en_HK.utf8
en_IE.utf8
en_IL
en_IL.utf8
en_IN
en_IN.utf8
en_NG
en_NG.utf8
en_NZ.utf8
en_PH.utf8
en_SG.utf8
en_US.utf8
en_ZA.utf8
en_ZM
en_ZM.utf8
en_ZW.utf8
fr_BE.utf8
fr_CA.utf8
fr_CH.utf8
french
fr_FR
fr_FR.iso88591
fr_FR.utf8
fr_LU.utf8
POSIX
```



---

archive/issue_comments_478662.json:
```json
{
    "body": "<a id='comment:51'>Comment 51:</a>\nin \n\n```\n+if test x`locale -a | grep C\\.UTF-8` != x; then\n+ export LC_ALL=C.UTF-8;\n+else\n+ export LC_ALL=C;\n+fi\n```\nbit of this branch, could you change both `LC_ALL` to `LC_CTYPE` and try if it helps?",
    "created_at": "2020-09-14T13:55:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478662",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:51'>Comment 51:</a>
in 

```
+if test x`locale -a | grep C\.UTF-8` != x; then
+ export LC_ALL=C.UTF-8;
+else
+ export LC_ALL=C;
+fi
```
bit of this branch, could you change both `LC_ALL` to `LC_CTYPE` and try if it helps?



---

archive/issue_comments_478663.json:
```json
{
    "body": "<a id='comment:52'>Comment 52:</a>\nReplying to [@dimpase](#comment%3A51):\n> bit of this branch, could you change both `LC_ALL` to `LC_CTYPE` and try if it helps?\n\nSame error after make doc-clean and make.",
    "created_at": "2020-09-14T14:49:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478663",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:52'>Comment 52:</a>
Replying to [@dimpase](#comment%3A51):
> bit of this branch, could you change both `LC_ALL` to `LC_CTYPE` and try if it helps?

Same error after make doc-clean and make.



---

archive/issue_comments_478664.json:
```json
{
    "body": "<a id='comment:53'>Comment 53:</a>\nTo me, it seems like an error of the following kind. That is we are opening the `src/doc/en/reference/references/index.rst` file as a `bytes` type, and at some place (where?), we decode the bytes to ascii and then we get `UnicodeDecodeError` because it is not ascii at all. Here is a way to reproduce the same error message:\n\n```\nsage: with open('src/doc/en/reference/references/index.rst', 'rb') as f: b = f.read()                \nsage: b.decode('ascii')                                                                              \n---------------------------------------------------------------------------\nUnicodeDecodeError                        Traceback (most recent call last)\n<ipython-input-13-498050d5a3fb> in <module>\n----> 1 b.decode('ascii')\n\nUnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 2661: ordinal not in range(128)\nsage: s = b.decode('utf-8') \n```\nI am adding Fr\u00e9d\u00e9ric in cc since he fixed a lot of those `UnicodeDecodeError` in recent times with the passage to Python 3.\n\nAlso, why this works in Python3.8 and not in Python3.6 ?",
    "created_at": "2020-09-14T14:54:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478664",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:53'>Comment 53:</a>
To me, it seems like an error of the following kind. That is we are opening the `src/doc/en/reference/references/index.rst` file as a `bytes` type, and at some place (where?), we decode the bytes to ascii and then we get `UnicodeDecodeError` because it is not ascii at all. Here is a way to reproduce the same error message:

```
sage: with open('src/doc/en/reference/references/index.rst', 'rb') as f: b = f.read()                
sage: b.decode('ascii')                                                                              
---------------------------------------------------------------------------
UnicodeDecodeError                        Traceback (most recent call last)
<ipython-input-13-498050d5a3fb> in <module>
----> 1 b.decode('ascii')

UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 2661: ordinal not in range(128)
sage: s = b.decode('utf-8') 
```
I am adding Frdric in cc since he fixed a lot of those `UnicodeDecodeError` in recent times with the passage to Python 3.

Also, why this works in Python3.8 and not in Python3.6 ?



---

archive/issue_comments_478665.json:
```json
{
    "body": "<a id='comment:54'>Comment 54:</a>\nperhaps Python 3.6 needs an extra punch in form of \n\n```diff\n--- a/src/sage/docs/conf.py\n+++ b/src/sage/docs/conf.py\n@@ -36,6 +36,7 @@ plot_pre_code = \"\"\"\n # Set locale to prevent having commas in decimal numbers\n # in tachyon input (see https://trac.sagemath.org/ticket/28971)\n import locale\n+locale.setlocale(LC_ALL, '')\n locale.setlocale(locale.LC_NUMERIC, 'C')\n def sphinx_plot(graphics, **kwds):\n     import matplotlib.image as mpimg\n```\ncould you try this, without what's suggested in [comment:51](#comment%3A51) ?\n\nThere is a comment \n\n```\nAccording to POSIX, a program which has not called setlocale(LC_ALL, '') runs using the \nportable 'C' locale. Calling setlocale(LC_ALL, '') lets it use the default locale as defined by the LANG variable. Since we do not want to interfere with the current locale setting we thus emulate the behavior in the way described above.\n```\nin https://docs.python.org/3.6/library/locale.html which makes me think it might be what's needed.",
    "created_at": "2020-09-14T15:04:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478665",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:54'>Comment 54:</a>
perhaps Python 3.6 needs an extra punch in form of 

```diff
--- a/src/sage/docs/conf.py
+++ b/src/sage/docs/conf.py
@@ -36,6 +36,7 @@ plot_pre_code = """
 # Set locale to prevent having commas in decimal numbers
 # in tachyon input (see https://trac.sagemath.org/ticket/28971)
 import locale
+locale.setlocale(LC_ALL, '')
 locale.setlocale(locale.LC_NUMERIC, 'C')
 def sphinx_plot(graphics, **kwds):
     import matplotlib.image as mpimg
```
could you try this, without what's suggested in [comment:51](#comment%3A51) ?

There is a comment 

```
According to POSIX, a program which has not called setlocale(LC_ALL, '') runs using the 
portable 'C' locale. Calling setlocale(LC_ALL, '') lets it use the default locale as defined by the LANG variable. Since we do not want to interfere with the current locale setting we thus emulate the behavior in the way described above.
```
in https://docs.python.org/3.6/library/locale.html which makes me think it might be what's needed.



---

archive/issue_comments_478666.json:
```json
{
    "body": "<a id='comment:55'>Comment 55:</a>\nThe name `C.UTF-8` isn't sufficient; you have to check for the others too. On Gentoo:\n\n```\n$ locale -a\nC\nC.utf8\nPOSIX\nen_US\nen_US.iso88591\nen_US.utf8\n```",
    "created_at": "2020-09-14T15:07:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478666",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:55'>Comment 55:</a>
The name `C.UTF-8` isn't sufficient; you have to check for the others too. On Gentoo:

```
$ locale -a
C
C.utf8
POSIX
en_US
en_US.iso88591
en_US.utf8
```



---

archive/issue_comments_478667.json:
```json
{
    "body": "<a id='comment:56'>Comment 56:</a>\nReplying to [@dimpase](#comment%3A54):\n> could you try this, without what's suggested in [comment:51](#comment%3A51) ?\n\nI get the same error after make doc-clean && make. In fact adding a line `print('AAAAAAAAAAAAA')` a this place does not print any `AAAAAAAAA...` on my screen, so I wonder if that code is really executed before the error occurs.",
    "created_at": "2020-09-14T15:23:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478667",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:56'>Comment 56:</a>
Replying to [@dimpase](#comment%3A54):
> could you try this, without what's suggested in [comment:51](#comment%3A51) ?

I get the same error after make doc-clean && make. In fact adding a line `print('AAAAAAAAAAAAA')` a this place does not print any `AAAAAAAAA...` on my screen, so I wonder if that code is really executed before the error occurs.



---

archive/issue_comments_478668.json:
```json
{
    "body": "<a id='comment:57'>Comment 57:</a>\nAAAAA, indeed (headbang on kbd)\nhere is the fix, I think\n\n```diff\n--- a/src/doc/en/reference/conf_sub.py\n+++ b/src/doc/en/reference/conf_sub.py\n@@ -20,7 +20,7 @@ ref_src = os.path.join(SAGE_DOC_SRC, 'en', 'reference')\n ref_out = os.path.join(SAGE_DOC, 'html', 'en', 'reference')\n \n # We use the main document's title, if we can find it.\n-rst_file = open('index.rst', 'r')\n+rst_file = open('index.rst', 'r', encoding='utf-8')\n rst_lines = rst_file.read().splitlines()\n rst_file.close()\n \n```\n\nindeed, that's one place in our homebaked docbuilder that opens UTF-8-encoded files without specifying them as UTF, and Python 3.6 does not like it.",
    "created_at": "2020-09-14T20:04:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478668",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:57'>Comment 57:</a>
AAAAA, indeed (headbang on kbd)
here is the fix, I think

```diff
--- a/src/doc/en/reference/conf_sub.py
+++ b/src/doc/en/reference/conf_sub.py
@@ -20,7 +20,7 @@ ref_src = os.path.join(SAGE_DOC_SRC, 'en', 'reference')
 ref_out = os.path.join(SAGE_DOC, 'html', 'en', 'reference')
 
 # We use the main document's title, if we can find it.
-rst_file = open('index.rst', 'r')
+rst_file = open('index.rst', 'r', encoding='utf-8')
 rst_lines = rst_file.read().splitlines()
 rst_file.close()
 
```

indeed, that's one place in our homebaked docbuilder that opens UTF-8-encoded files without specifying them as UTF, and Python 3.6 does not like it.



---

archive/issue_comments_478669.json:
```json
{
    "body": "<a id='comment:58'>Comment 58:</a>\nthere are also many more missing `encoding='utf-8'` in `open()` on source files in the docbuilder.\n\nand perhaps on other text files too. all these lead to these `UnicodeDecodeError: 'ascii' codec can't decode byte...`\n\nShould we just abandon the idea to support random system Python 3.6, they are just broken in this way...",
    "created_at": "2020-09-14T21:04:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478669",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:58'>Comment 58:</a>
there are also many more missing `encoding='utf-8'` in `open()` on source files in the docbuilder.

and perhaps on other text files too. all these lead to these `UnicodeDecodeError: 'ascii' codec can't decode byte...`

Should we just abandon the idea to support random system Python 3.6, they are just broken in this way...



---

archive/issue_comments_478670.json:
```json
{
    "body": "<a id='comment:59'>Comment 59:</a>\nWorse, there are files with lots of utf-8 stuff, sitting in `r\"\"\"...\"\"\"` multiline comments, e.g.\n`src/sage/algebras/lie_algebras/lie_algebra_element.pyx`, and they cause problems too.",
    "created_at": "2020-09-14T21:18:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478670",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:59'>Comment 59:</a>
Worse, there are files with lots of utf-8 stuff, sitting in `r"""..."""` multiline comments, e.g.
`src/sage/algebras/lie_algebras/lie_algebra_element.pyx`, and they cause problems too.



---

archive/issue_comments_478671.json:
```json
{
    "body": "<a id='comment:60'>Comment 60:</a>\nthis is with Ubuntu 18.04 native Python 3.6:\n\n```\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.complete_primary_decomposition: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.genus: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.primary_decomposition_complete: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)\n[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal.degree_of_semi_regularity:8: WARNING: Inline interpreted text or phrase reference start-string without end-string.\n[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal.degree_of_semi_regularity:9: WARNING: Block quote ends without a blank line; unexpected unindent.\n[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal.degree_of_semi_regularity:23: WARNING: Inline interpreted text or phrase reference start-string without end-string.\n[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal.degree_of_semi_regularity:24: WARNING: Block quote ends without a blank line; unexpected unindent.\n[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.associated_primes:4: WARNING: Inline interpreted text or phrase reference start-string without end-string.\n[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.associated_primes:7: WARNING: Block quote ends without a blank line; unexpected unindent.\n[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.primary_decomposition:4: WARNING: Inline interpreted text or phrase reference start-string without end-string.\n[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.primary_decomposition:6: WARNING: Block quote ends without a blank line; unexpected unindent.\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.hamming_weight: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.inverse_series_trunc: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.is_one: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.is_term: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.is_zero: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.list: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.number_of_terms: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.truncate: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.is_term: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.list: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.truncate: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.generic_power_trunc: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial._mul_trunc_: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)\n[dochtml] [polynomia] The inventory files are in local/share/doc/sage/inventory/en/reference/polynomial_rings.\n[dochtml] Error building the documentation.\n[dochtml] Traceback (most recent call last):\n[dochtml]   File \"/usr/lib/python3.6/runpy.py\", line 193, in _run_module_as_main\n[dochtml]     \"__main__\", mod_spec)\n[dochtml]   File \"/usr/lib/python3.6/runpy.py\", line 85, in _run_code\n[dochtml]     exec(code, run_globals)\n[dochtml]   File \"/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__main__.py\", line 2, in <module>\n[dochtml]     main()\n[dochtml]   File \"/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py\", line 1730, in main\n[dochtml]     builder()\n[dochtml]   File \"/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py\", line 344, in _wrapper\n[dochtml]     getattr(get_builder(document), 'inventory')(*args, **kwds)\n[dochtml]   File \"/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py\", line 570, in _wrapper\n[dochtml]     self._build_everything_except_bibliography(lang, format, *args, **kwds)\n[dochtml]   File \"/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py\", line 556, in _build_everything_except_bibliography\n[dochtml]     build_many(build_ref_doc, non_references)\n[dochtml]   File \"/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py\", line 296, in build_many\n[dochtml]     _build_many(target, args, processes=NUM_THREADS)\n[dochtml]   File \"/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/utils.py\", line 291, in build_many\n[dochtml]     raise worker_exc.original_exception\n[dochtml] OSError: WARNING: error while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.complete_primary_decomposition: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)\n```\n\nif anyone wants to sort all this out, be my guest.",
    "created_at": "2020-09-14T21:20:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478671",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:60'>Comment 60:</a>
this is with Ubuntu 18.04 native Python 3.6:

```
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.complete_primary_decomposition: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.genus: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.primary_decomposition_complete: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)
[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal.degree_of_semi_regularity:8: WARNING: Inline interpreted text or phrase reference start-string without end-string.
[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal.degree_of_semi_regularity:9: WARNING: Block quote ends without a blank line; unexpected unindent.
[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal.degree_of_semi_regularity:23: WARNING: Inline interpreted text or phrase reference start-string without end-string.
[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal.degree_of_semi_regularity:24: WARNING: Block quote ends without a blank line; unexpected unindent.
[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.associated_primes:4: WARNING: Inline interpreted text or phrase reference start-string without end-string.
[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.associated_primes:7: WARNING: Block quote ends without a blank line; unexpected unindent.
[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.primary_decomposition:4: WARNING: Inline interpreted text or phrase reference start-string without end-string.
[dochtml] [polynomia] /home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py:docstring of sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.primary_decomposition:6: WARNING: Block quote ends without a blank line; unexpected unindent.
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.hamming_weight: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.inverse_series_trunc: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.is_one: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.is_term: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.is_zero: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.list: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.number_of_terms: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial.truncate: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.is_term: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.list: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial_generic_dense.truncate: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.generic_power_trunc: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] WARNING: error while formatting arguments for sage.rings.polynomial.polynomial_element.Polynomial._mul_trunc_: 'ascii' codec can't decode byte 0xc3 in position 8166: ordinal not in range(128)
[dochtml] [polynomia] The inventory files are in local/share/doc/sage/inventory/en/reference/polynomial_rings.
[dochtml] Error building the documentation.
[dochtml] Traceback (most recent call last):
[dochtml]   File "/usr/lib/python3.6/runpy.py", line 193, in _run_module_as_main
[dochtml]     "__main__", mod_spec)
[dochtml]   File "/usr/lib/python3.6/runpy.py", line 85, in _run_code
[dochtml]     exec(code, run_globals)
[dochtml]   File "/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
[dochtml]     main()
[dochtml]   File "/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py", line 1730, in main
[dochtml]     builder()
[dochtml]   File "/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py", line 344, in _wrapper
[dochtml]     getattr(get_builder(document), 'inventory')(*args, **kwds)
[dochtml]   File "/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py", line 570, in _wrapper
[dochtml]     self._build_everything_except_bibliography(lang, format, *args, **kwds)
[dochtml]   File "/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py", line 556, in _build_everything_except_bibliography
[dochtml]     build_many(build_ref_doc, non_references)
[dochtml]   File "/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py", line 296, in build_many
[dochtml]     _build_many(target, args, processes=NUM_THREADS)
[dochtml]   File "/home/dima/sage/dev/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/utils.py", line 291, in build_many
[dochtml]     raise worker_exc.original_exception
[dochtml] OSError: WARNING: error while formatting arguments for sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.complete_primary_decomposition: 'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)
```

if anyone wants to sort all this out, be my guest.



---

archive/issue_comments_478672.json:
```json
{
    "body": "<a id='comment:61'>Comment 61:</a>\nplease push your branch if you started to do some changes using utf-8 encodings. I will take a look tomorrow europe time.",
    "created_at": "2020-09-14T21:27:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478672",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:61'>Comment 61:</a>
please push your branch if you started to do some changes using utf-8 encodings. I will take a look tomorrow europe time.



---

archive/issue_comments_478673.json:
```json
{
    "body": "<a id='comment:62'>Comment 62:</a>\nBecause `build_many` catches the error, it is difficult to debug. The following change allows to see the real error:\n\n```diff\ndiff --git a/src/sage_setup/docbuild/__init__.py b/src/sage_setup/docbuild/__init__.py\nindex 0841f429e7..c9e08214f3 100644\n--- a/src/sage_setup/docbuild/__init__.py\n+++ b/src/sage_setup/docbuild/__init__.py\n@@ -292,6 +292,8 @@ def build_many(target, args):\n     Thin wrapper around `sage_setup.docbuild.utils.build_many` which uses the\n     docbuild settings ``NUM_THREADS`` and ``ABORT_ON_ERROR``.\n     \"\"\"\n+    for arg in args:\n+        target(arg)\n     try:\n         _build_many(target, args, processes=NUM_THREADS)\n     except BaseException as exc:\n```\n\nwhich is:\n\n```\n[dochtml]   File \"/home/slabbe/GitBox/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py\", line 296, in build_many\n[dochtml]     target(arg)\n[dochtml]   File \"/home/slabbe/GitBox/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py\", line 79, in build_ref_doc\n[dochtml]     getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)\n[dochtml]   File \"/home/slabbe/GitBox/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py\", line 763, in _wrapper\n[dochtml]     for module_name in self.get_all_included_modules():\n[dochtml]   File \"/home/slabbe/GitBox/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py\", line 927, in get_all_included_modules\n[dochtml]     for module in self.get_modules(filename):\n[dochtml]   File \"/home/slabbe/GitBox/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py\", line 1009, in get_modules\n[dochtml]     lines = f.readlines()\n[dochtml]   File \"/usr/lib/python3.6/encodings/ascii.py\", line 26, in decode\n[dochtml]     return codecs.ascii_decode(input, self.errors)[0]\n[dochtml] UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 2661: ordinal not in range(128)\n```\n\nBut indeed, I see that adding a `encoding='utf-8'` at this place is not sufficient.",
    "created_at": "2020-09-15T09:29:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478673",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:62'>Comment 62:</a>
Because `build_many` catches the error, it is difficult to debug. The following change allows to see the real error:

```diff
diff --git a/src/sage_setup/docbuild/__init__.py b/src/sage_setup/docbuild/__init__.py
index 0841f429e7..c9e08214f3 100644
--- a/src/sage_setup/docbuild/__init__.py
+++ b/src/sage_setup/docbuild/__init__.py
@@ -292,6 +292,8 @@ def build_many(target, args):
     Thin wrapper around `sage_setup.docbuild.utils.build_many` which uses the
     docbuild settings ``NUM_THREADS`` and ``ABORT_ON_ERROR``.
     """
+    for arg in args:
+        target(arg)
     try:
         _build_many(target, args, processes=NUM_THREADS)
     except BaseException as exc:
```

which is:

```
[dochtml]   File "/home/slabbe/GitBox/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py", line 296, in build_many
[dochtml]     target(arg)
[dochtml]   File "/home/slabbe/GitBox/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py", line 79, in build_ref_doc
[dochtml]     getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)
[dochtml]   File "/home/slabbe/GitBox/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py", line 763, in _wrapper
[dochtml]     for module_name in self.get_all_included_modules():
[dochtml]   File "/home/slabbe/GitBox/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py", line 927, in get_all_included_modules
[dochtml]     for module in self.get_modules(filename):
[dochtml]   File "/home/slabbe/GitBox/sage/local/lib/python3.6/site-packages/sage_setup/docbuild/__init__.py", line 1009, in get_modules
[dochtml]     lines = f.readlines()
[dochtml]   File "/usr/lib/python3.6/encodings/ascii.py", line 26, in decode
[dochtml]     return codecs.ascii_decode(input, self.errors)[0]
[dochtml] UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 2661: ordinal not in range(128)
```

But indeed, I see that adding a `encoding='utf-8'` at this place is not sufficient.



---

archive/issue_comments_478674.json:
```json
{
    "body": "<a id='comment:63'>Comment 63:</a>\nIt is not sifficient, and I get the codec errors on a file where I cleaned all non-ascii away (sic!).\n\nI am giving up on this. I think the code is too new for Python 3.6, and I don't think we should invest time in a version that will be EOL by the end of 2021. \n\nPeople who only have Python 3.6 can build Python.",
    "created_at": "2020-09-15T09:31:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478674",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:63'>Comment 63:</a>
It is not sifficient, and I get the codec errors on a file where I cleaned all non-ascii away (sic!).

I am giving up on this. I think the code is too new for Python 3.6, and I don't think we should invest time in a version that will be EOL by the end of 2021. 

People who only have Python 3.6 can build Python.



---

archive/issue_comments_478675.json:
```json
{
    "body": "<a id='comment:64'>Comment 64:</a>\nWe already have some code in Sage that was taken from Python 3.7, in src/sage/misc/sageinspect.py, which is used in docbuilding, perhaps it is too new, e.g. \n\n```\ndef formatannotation(annotation, base_module=None):\n    \"\"\"\n    This is taken from Python 3.7's inspect.py; the only change is to\n    add documentation.\n...\n```\n\ncode from `sageinspect.py` is used in \"formatting arguments\", the error shown in [comment:60](#comment%3A60).",
    "created_at": "2020-09-15T09:36:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478675",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:64'>Comment 64:</a>
We already have some code in Sage that was taken from Python 3.7, in src/sage/misc/sageinspect.py, which is used in docbuilding, perhaps it is too new, e.g. 

```
def formatannotation(annotation, base_module=None):
    """
    This is taken from Python 3.7's inspect.py; the only change is to
    add documentation.
...
```

code from `sageinspect.py` is used in "formatting arguments", the error shown in [comment:60](#comment%3A60).



---

archive/issue_comments_478676.json:
```json
{
    "body": "<a id='comment:65'>Comment 65:</a>\nI think I will surrender too. I posted the changes that needs to be done on the branch [u/slabbe/30053](https://github.com/sagemath/sagetrac-mirror/commits/u/slabbe/30053) to get Python3.6 to work. As you, I now get the error\n\n```\n[dochtml] OSError: WARNING: error while formatting arguments for \nsage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.complete_primary_decomposition:\n'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)\n```",
    "created_at": "2020-09-15T11:31:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478676",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:65'>Comment 65:</a>
I think I will surrender too. I posted the changes that needs to be done on the branch [u/slabbe/30053](https://github.com/sagemath/sagetrac-mirror/commits/u/slabbe/30053) to get Python3.6 to work. As you, I now get the error

```
[dochtml] OSError: WARNING: error while formatting arguments for 
sage.rings.polynomial.multi_polynomial_ideal.MPolynomialIdeal_singular_repr.complete_primary_decomposition:
'ascii' codec can't decode byte 0xc2 in position 4774: ordinal not in range(128)
```



---

archive/issue_comments_478677.json:
```json
{
    "body": "<a id='comment:66'>Comment 66:</a>\nthis ticket helps if one is on python 3.x for x>6. As to 3.6, well, it's apparently hard, as Sage code and perhaps sphinx are too new for it.",
    "created_at": "2020-09-15T12:01:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478677",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:66'>Comment 66:</a>
this ticket helps if one is on python 3.x for x>6. As to 3.6, well, it's apparently hard, as Sage code and perhaps sphinx are too new for it.



---

archive/issue_comments_478678.json:
```json
{
    "body": "Dependencies: **#30551**",
    "created_at": "2020-09-15T12:01:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478678",
    "user": "https://github.com/dimpase"
}
```

Dependencies: **#30551**



---

archive/issue_events_395553.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-09-15T12:01:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395553"
}
```



---

archive/issue_events_395554.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-09-15T12:01:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395554"
}
```



---

archive/issue_comments_478679.json:
```json
{
    "body": "<a id='comment:67'>Comment 67:</a>\nOn python >= 3.7, `LC_ALL=C` is sufficient, because python itself will attempt to find a UTF-8 version of that locale.\n\n(It may be only a semantic difference, but then the non-existence of `C.UTF-8` on some systems becomes Not Our Problem.)",
    "created_at": "2020-09-15T12:06:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478679",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:67'>Comment 67:</a>
On python >= 3.7, `LC_ALL=C` is sufficient, because python itself will attempt to find a UTF-8 version of that locale.

(It may be only a semantic difference, but then the non-existence of `C.UTF-8` on some systems becomes Not Our Problem.)



---

archive/issue_comments_478680.json:
```json
{
    "body": "<a id='comment:68'>Comment 68:</a>\nthis patch sets LC_ALL to a meaningful value. Do you want it always to be `C` ?",
    "created_at": "2020-09-15T14:20:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478680",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:68'>Comment 68:</a>
this patch sets LC_ALL to a meaningful value. Do you want it always to be `C` ?



---

archive/issue_comments_478681.json:
```json
{
    "body": "<a id='comment:69'>Comment 69:</a>\nReplying to [@dimpase](#comment%3A68):\n> this patch sets LC_ALL to a meaningful value. Do you want it always to be `C` ?\n\nYes, if we're going to throw python-3.6 under the bus in this release.\n\n`LC_ALL=C` is the standard choice, and python >= 3.7 already treat `LC_ALL=C` magically. That's what \"PEP 538 -- Coercing the legacy C locale to a UTF-8 based locale\" is about.",
    "created_at": "2020-09-15T14:51:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478681",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:69'>Comment 69:</a>
Replying to [@dimpase](#comment%3A68):
> this patch sets LC_ALL to a meaningful value. Do you want it always to be `C` ?

Yes, if we're going to throw python-3.6 under the bus in this release.

`LC_ALL=C` is the standard choice, and python >= 3.7 already treat `LC_ALL=C` magically. That's what "PEP 538 -- Coercing the legacy C locale to a UTF-8 based locale" is about.



---

archive/issue_comments_478682.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -3,14 +3,6 @@\n \n There are also some other locale problems that show up in doctests\n (for example https://groups.google.com/d/msg/sage-release/spalYgXKr-4/ZVsbgHIlAgAJ)\n-\n-And a failure building the documentation on `ubuntu-bionic-standard` (using `/usr/bin/python3.6`, https://github.com/mkoeppe/sage/runs/1106251169):\n-\n-```\n-  [dochtml]   UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 2661: ordinal not in range(128)\n-  [dochtml] Full log file: logs/dochtml.log\n-Makefile:1876: recipe for target 'doc-html' failed\n-```\n \n \n \n``````\n",
    "created_at": "2020-09-15T15:19:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478682",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -3,14 +3,6 @@
 
 There are also some other locale problems that show up in doctests
 (for example https://groups.google.com/d/msg/sage-release/spalYgXKr-4/ZVsbgHIlAgAJ)
-
-And a failure building the documentation on `ubuntu-bionic-standard` (using `/usr/bin/python3.6`, https://github.com/mkoeppe/sage/runs/1106251169):
-
-```
-  [dochtml]   UnicodeDecodeError: 'ascii' codec can't decode byte 0xe2 in position 2661: ordinal not in range(128)
-  [dochtml] Full log file: logs/dochtml.log
-Makefile:1876: recipe for target 'doc-html' failed
-```
 
 
 
``````




---

archive/issue_comments_478683.json:
```json
{
    "body": "<a id='comment:70'>Comment 70:</a>\nLet's refocus this ticket (blocker for Sage 9.2) on solving the issues for Python 3.7+\n\nTo me Python 3.6 support is a \"wishlist\" item, but not a blocker. I have created a separate ticket for it: #30576",
    "created_at": "2020-09-15T15:19:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478683",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:70'>Comment 70:</a>
Let's refocus this ticket (blocker for Sage 9.2) on solving the issues for Python 3.7+

To me Python 3.6 support is a "wishlist" item, but not a blocker. I have created a separate ticket for it: #30576



---

archive/issue_events_395555.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-15T15:20:33Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "title_is": "Python 3.7+: setlocale: LC_ALL: cannot change locale (C.UTF-8) from build/bin/sage-spkg and in doctests",
    "title_was": "setlocale: LC_ALL: cannot change locale (C.UTF-8) from build/bin/sage-spkg and in doctests",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395555"
}
```



---

archive/issue_comments_478684.json:
```json
{
    "body": "<a id='comment:72'>Comment 72:</a>\nwhat are the 3.7+ problems left here?\nI presume all of them have plain C locale, so it all should work, no?",
    "created_at": "2020-09-15T16:20:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478684",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:72'>Comment 72:</a>
what are the 3.7+ problems left here?
I presume all of them have plain C locale, so it all should work, no?



---

archive/issue_comments_478685.json:
```json
{
    "body": "<a id='comment:73'>Comment 73:</a>\nReplying to [@dimpase](#comment%3A72):\n> what are the 3.7+ problems left here?\n> I presume all of them have plain C locale, so it all should work, no?\n\nNone, but AFAIK there were none before we started messing with the locale, either.\n\nIf no one is going to fix the python-3.6 problems, we should just drop it from the list of supported system pythons and revert this to `LC_ALL=C`. That's simpler and leaves us with one fewer locale problem to debug in the future.",
    "created_at": "2020-09-15T23:19:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478685",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:73'>Comment 73:</a>
Replying to [@dimpase](#comment%3A72):
> what are the 3.7+ problems left here?
> I presume all of them have plain C locale, so it all should work, no?

None, but AFAIK there were none before we started messing with the locale, either.

If no one is going to fix the python-3.6 problems, we should just drop it from the list of supported system pythons and revert this to `LC_ALL=C`. That's simpler and leaves us with one fewer locale problem to debug in the future.



---

archive/issue_comments_478686.json:
```json
{
    "body": "<a id='comment:74'>Comment 74:</a>\nI wouldn't close the door on python 3.6 yet, so let's get this patch in please.",
    "created_at": "2020-09-16T00:22:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478686",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:74'>Comment 74:</a>
I wouldn't close the door on python 3.6 yet, so let's get this patch in please.



---

archive/issue_comments_478687.json:
```json
{
    "body": "<a id='comment:75'>Comment 75:</a>\nReplying to [@mkoeppe](#comment%3A74):\n> I wouldn't close the door on python 3.6 yet, so let's get this patch in please.\n\nIt still isn't sufficient for python-3.6, even if someone does fix the other problems. The name `C.UTF-8` isn't standard because... it's not standardized yet. On Gentoo, it's `C.utf8`, and elsewhere apparently (per the PEP) it's called simply `UTF-8`. All of them should be checked/tried, and we should really only be doing it if python-3.6 is in use. That way, when we drop python-3.6, we're left with just `LC_ALL=C` again.\n\nAlso keep in mind that if no one actually fixes the other problems with python-3.6, the door is closed regardless.",
    "created_at": "2020-09-16T00:38:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478687",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:75'>Comment 75:</a>
Replying to [@mkoeppe](#comment%3A74):
> I wouldn't close the door on python 3.6 yet, so let's get this patch in please.

It still isn't sufficient for python-3.6, even if someone does fix the other problems. The name `C.UTF-8` isn't standard because... it's not standardized yet. On Gentoo, it's `C.utf8`, and elsewhere apparently (per the PEP) it's called simply `UTF-8`. All of them should be checked/tried, and we should really only be doing it if python-3.6 is in use. That way, when we drop python-3.6, we're left with just `LC_ALL=C` again.

Also keep in mind that if no one actually fixes the other problems with python-3.6, the door is closed regardless.



---

archive/issue_comments_478688.json:
```json
{
    "body": "<a id='comment:76'>Comment 76:</a>\nReplying to [@orlitzky](#comment%3A75):\n> Replying to [@mkoeppe](#comment%3A74):\n> > I wouldn't close the door on python 3.6 yet, so let's get this patch in please.\n\n> \n> It still isn't sufficient for python-3.6\n\nYes, I know, that's why I opened the separate ticket #30576 for that.",
    "created_at": "2020-09-16T01:59:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478688",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:76'>Comment 76:</a>
Replying to [@orlitzky](#comment%3A75):
> Replying to [@mkoeppe](#comment%3A74):
> > I wouldn't close the door on python 3.6 yet, so let's get this patch in please.

> 
> It still isn't sufficient for python-3.6

Yes, I know, that's why I opened the separate ticket #30576 for that.



---

archive/issue_comments_478689.json:
```json
{
    "body": "<a id='comment:77'>Comment 77:</a>\nthere is no harm in adding this, anyway, thus, over to bots.",
    "created_at": "2020-09-16T08:28:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478689",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:77'>Comment 77:</a>
there is no harm in adding this, anyway, thus, over to bots.



---

archive/issue_events_395556.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-09-16T08:28:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395556"
}
```



---

archive/issue_events_395557.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-09-16T08:28:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395557"
}
```



---

archive/issue_comments_478690.json:
```json
{
    "body": "Reviewer: **Matthias Koeppe, Dima Pasechnik**",
    "created_at": "2020-09-16T08:28:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478690",
    "user": "https://github.com/dimpase"
}
```

Reviewer: **Matthias Koeppe, Dima Pasechnik**



---

archive/issue_comments_478691.json:
```json
{
    "body": "Changed dependencies from **#30551** to none",
    "created_at": "2020-09-16T08:30:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478691",
    "user": "https://github.com/dimpase"
}
```

Changed dependencies from **#30551** to none



---

archive/issue_comments_478692.json:
```json
{
    "body": "<a id='comment:78'>Comment 78:</a>\nI've also removed #30551 as a dependency - after all whether Python 3.6 is (somewhat) supported (IMHO docbuilding is the main problem there)\ncan be sorted out later.",
    "created_at": "2020-09-16T08:30:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478692",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:78'>Comment 78:</a>
I've also removed #30551 as a dependency - after all whether Python 3.6 is (somewhat) supported (IMHO docbuilding is the main problem there)
can be sorted out later.



---

archive/issue_comments_478693.json:
```json
{
    "body": "<a id='comment:79'>Comment 79:</a>\nReplying to [@mkoeppe](#comment%3A76):\n> \n> Yes, I know, that's why I opened the separate ticket #30576 for that.\n\nThe stuff on ticket #30576 isn't what I was referring to...\n\n\nReplying to [@dimpase](#comment%3A77):\n> there is no harm in adding this, anyway, thus, over to bots.\n\nThe harm is that now we have additional locale problems to debug for a change that doesn't solve anything. With python-3.7, there are now three different configurations:\n\n* The `C.UTF-8` locale exists and is used.\n* No utf8 locale exists, so `C` is used.\n* A utf8 locale is available, but your grep doesn't find it, so we wind up with `C` on a machine that could have a utf8 locale.\n\nWhy, when `LC_ALL=C` unconditionally works fine and had been in there for ages?\n\n*If* someone wants to fix python-3.6, we should add these hacks only for python-3.6, and we should try the alternate names `C.utf8` and `UTF-8`, too.",
    "created_at": "2020-09-16T14:24:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478693",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:79'>Comment 79:</a>
Replying to [@mkoeppe](#comment%3A76):
> 
> Yes, I know, that's why I opened the separate ticket #30576 for that.

The stuff on ticket #30576 isn't what I was referring to...


Replying to [@dimpase](#comment%3A77):
> there is no harm in adding this, anyway, thus, over to bots.

The harm is that now we have additional locale problems to debug for a change that doesn't solve anything. With python-3.7, there are now three different configurations:

* The `C.UTF-8` locale exists and is used.
* No utf8 locale exists, so `C` is used.
* A utf8 locale is available, but your grep doesn't find it, so we wind up with `C` on a machine that could have a utf8 locale.

Why, when `LC_ALL=C` unconditionally works fine and had been in there for ages?

*If* someone wants to fix python-3.6, we should add these hacks only for python-3.6, and we should try the alternate names `C.utf8` and `UTF-8`, too.



---

archive/issue_comments_478694.json:
```json
{
    "body": "<a id='comment:80'>Comment 80:</a>\nBranch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ff6f4a68d4f396cb5f10e9918e5942113f739aa1\">ff6f4a6</a></td><td><code>assume Python 3.7 or better</code></td></tr></table>\n",
    "created_at": "2020-09-16T15:06:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478694",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:80'>Comment 80:</a>
Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ff6f4a68d4f396cb5f10e9918e5942113f739aa1">ff6f4a6</a></td><td><code>assume Python 3.7 or better</code></td></tr></table>




---

archive/issue_events_395558.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2020-09-16T15:06:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395558"
}
```



---

archive/issue_events_395559.json:
```json
{
    "actor": "https://github.com/sagetrac-git",
    "created_at": "2020-09-16T15:06:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395559"
}
```



---

archive/issue_comments_478695.json:
```json
{
    "body": "Changed commit from **[e5f6663](https://github.com/sagemath/sagetrac-mirror/commit/e5f6663372fab14c6a386004a925de59be216f31)** to **[ff6f4a6](https://github.com/sagemath/sagetrac-mirror/commit/ff6f4a68d4f396cb5f10e9918e5942113f739aa1)**",
    "created_at": "2020-09-16T15:06:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478695",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[e5f6663](https://github.com/sagemath/sagetrac-mirror/commit/e5f6663372fab14c6a386004a925de59be216f31)** to **[ff6f4a6](https://github.com/sagemath/sagetrac-mirror/commit/ff6f4a68d4f396cb5f10e9918e5942113f739aa1)**



---

archive/issue_comments_478696.json:
```json
{
    "body": "<a id='comment:81'>Comment 81:</a>\nOK, so how about this?",
    "created_at": "2020-09-16T15:07:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478696",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:81'>Comment 81:</a>
OK, so how about this?



---

archive/issue_comments_478697.json:
```json
{
    "body": "<a id='comment:82'>Comment 82:</a>\nI think that's the best solution, possibly combined with dropping 3.6 from the list of system pythons that we accept. Portability is nice and all, but we're wasting a lot of time trying to support an evolutionary dead-end with py3.6.",
    "created_at": "2020-09-16T15:17:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478697",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:82'>Comment 82:</a>
I think that's the best solution, possibly combined with dropping 3.6 from the list of system pythons that we accept. Portability is nice and all, but we're wasting a lot of time trying to support an evolutionary dead-end with py3.6.



---

archive/issue_comments_478698.json:
```json
{
    "body": "<a id='comment:83'>Comment 83:</a>\nFine with me - then please also adjust python3's spkg-configure...",
    "created_at": "2020-09-16T16:16:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478698",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:83'>Comment 83:</a>
Fine with me - then please also adjust python3's spkg-configure...



---

archive/issue_comments_478699.json:
```json
{
    "body": "Changed commit from **[ff6f4a6](https://github.com/sagemath/sagetrac-mirror/commit/ff6f4a68d4f396cb5f10e9918e5942113f739aa1)** to **[64c3a8a](https://github.com/sagemath/sagetrac-mirror/commit/64c3a8a6c99e916b68dfec6a2cd1346b023916e9)**",
    "created_at": "2020-09-16T16:46:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478699",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[ff6f4a6](https://github.com/sagemath/sagetrac-mirror/commit/ff6f4a68d4f396cb5f10e9918e5942113f739aa1)** to **[64c3a8a](https://github.com/sagemath/sagetrac-mirror/commit/64c3a8a6c99e916b68dfec6a2cd1346b023916e9)**



---

archive/issue_comments_478700.json:
```json
{
    "body": "<a id='comment:84'>Comment 84:</a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/64c3a8a6c99e916b68dfec6a2cd1346b023916e9\">64c3a8a</a></td><td><code>only test python3, to be 3.7 or 3.8</code></td></tr></table>\n",
    "created_at": "2020-09-16T16:46:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478700",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:84'>Comment 84:</a>
Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/64c3a8a6c99e916b68dfec6a2cd1346b023916e9">64c3a8a</a></td><td><code>only test python3, to be 3.7 or 3.8</code></td></tr></table>




---

archive/issue_comments_478701.json:
```json
{
    "body": "<a id='comment:85'>Comment 85:</a>\nReplying to [@mkoeppe](#comment%3A83):\n> Fine with me - then please also adjust python3's spkg-configure...\n\nfixed, as discussed - only test `python3`, to be either 3.7 or 3.8.\n\nPlease review",
    "created_at": "2020-09-16T16:47:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478701",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:85'>Comment 85:</a>
Replying to [@mkoeppe](#comment%3A83):
> Fine with me - then please also adjust python3's spkg-configure...

fixed, as discussed - only test `python3`, to be either 3.7 or 3.8.

Please review



---

archive/issue_comments_478702.json:
```json
{
    "body": "Changed branch from **[u/dimpase/build/careful_with_C_UTF8](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/build/careful_with_C_UTF8)** to **[u/mkoeppe/build/careful_with_C_UTF8](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/build/careful_with_C_UTF8)**",
    "created_at": "2020-09-16T17:11:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478702",
    "user": "https://github.com/mkoeppe"
}
```

Changed branch from **[u/dimpase/build/careful_with_C_UTF8](https://github.com/sagemath/sagetrac-mirror/tree/u/dimpase/build/careful_with_C_UTF8)** to **[u/mkoeppe/build/careful_with_C_UTF8](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/build/careful_with_C_UTF8)**



---

archive/issue_comments_478703.json:
```json
{
    "body": "<a id='comment:87'>Comment 87:</a>\nI have made an adjustment. I don't like mixing the change discussed in #30546 into this ticket\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/be47518c1019d37e11bbac9a3268d69b196691c8\">be47518</a></td><td><code>build/pkgs/python3/spkg-configure.m4: Use 'python >= 3.7'; keep checking for 'python3.8, python3.7'</code></td></tr></table>\n",
    "created_at": "2020-09-16T17:12:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478703",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:87'>Comment 87:</a>
I have made an adjustment. I don't like mixing the change discussed in #30546 into this ticket

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/be47518c1019d37e11bbac9a3268d69b196691c8">be47518</a></td><td><code>build/pkgs/python3/spkg-configure.m4: Use 'python >= 3.7'; keep checking for 'python3.8, python3.7'</code></td></tr></table>




---

archive/issue_comments_478704.json:
```json
{
    "body": "Changed commit from **[64c3a8a](https://github.com/sagemath/sagetrac-mirror/commit/64c3a8a6c99e916b68dfec6a2cd1346b023916e9)** to **[be47518](https://github.com/sagemath/sagetrac-mirror/commit/be47518c1019d37e11bbac9a3268d69b196691c8)**",
    "created_at": "2020-09-16T17:12:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478704",
    "user": "https://github.com/mkoeppe"
}
```

Changed commit from **[64c3a8a](https://github.com/sagemath/sagetrac-mirror/commit/64c3a8a6c99e916b68dfec6a2cd1346b023916e9)** to **[be47518](https://github.com/sagemath/sagetrac-mirror/commit/be47518c1019d37e11bbac9a3268d69b196691c8)**



---

archive/issue_comments_478705.json:
```json
{
    "body": "<a id='comment:88'>Comment 88:</a>\nRationale: The changed search behavior would lead to confusing reports on sage-release.",
    "created_at": "2020-09-16T17:14:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478705",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:88'>Comment 88:</a>
Rationale: The changed search behavior would lead to confusing reports on sage-release.



---

archive/issue_comments_478706.json:
```json
{
    "body": "Changed author from **Dima Pasechnik** to **Dima Pasechnik, Matthias Koeppe**",
    "created_at": "2020-09-16T17:16:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478706",
    "user": "https://github.com/mkoeppe"
}
```

Changed author from **Dima Pasechnik** to **Dima Pasechnik, Matthias Koeppe**



---

archive/issue_events_395560.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-16T17:16:57Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395560"
}
```



---

archive/issue_events_395561.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-16T17:16:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395561"
}
```



---

archive/issue_comments_478707.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,11 +1,5 @@\n In #29033 in `build/bin/sage-spkg` LC_ALL was changed to C.UTF-8\n However, not all systems have it. \n-\n-There are also some other locale problems that show up in doctests\n-(for example https://groups.google.com/d/msg/sage-release/spalYgXKr-4/ZVsbgHIlAgAJ)\n-\n-\n-\n \n \n See also:\n``````\n",
    "created_at": "2020-09-16T17:34:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478707",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,11 +1,5 @@
 In #29033 in `build/bin/sage-spkg` LC_ALL was changed to C.UTF-8
 However, not all systems have it. 
-
-There are also some other locale problems that show up in doctests
-(for example https://groups.google.com/d/msg/sage-release/spalYgXKr-4/ZVsbgHIlAgAJ)
-
-
-
 
 
 See also:
``````




---

archive/issue_events_395562.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-16T17:34:17Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "title_is": "Python 3.7+: setlocale: LC_ALL: cannot change locale (C.UTF-8) from build/bin/sage-spkg and in doctests; disable use of system Python 3.6",
    "title_was": "Python 3.7+: setlocale: LC_ALL: cannot change locale (C.UTF-8) from build/bin/sage-spkg and in doctests",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395562"
}
```



---

archive/issue_comments_478708.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,3 +4,9 @@\n \n See also:\n - #22659\n+\n+Follow-up:\n+- #30586 macOS: Doctest failures in some locales\n+- #30576 Python 3.6: Fix locale/encoding issues, then re-enable Python 3.6\n+\n+\n``````\n",
    "created_at": "2020-09-16T17:40:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478708",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,3 +4,9 @@
 
 See also:
 - #22659
+
+Follow-up:
+- #30586 macOS: Doctest failures in some locales
+- #30576 Python 3.6: Fix locale/encoding issues, then re-enable Python 3.6
+
+
``````




---

archive/issue_comments_478709.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,19 @@\n In #29033 in `build/bin/sage-spkg` LC_ALL was changed to C.UTF-8\n However, not all systems have it. \n \n+There are a few more places that explicitly set locale variables (`LANG` and `LC_*`):\n+\n+```\n+build/bin/sage-site:    export LANG=C # to ensure it is possible to scrape out non-EN locale warnings\n+build/bin/sage-spkg: export LC_ALL=C;\n+build/pkgs/gap/spkg-check.in:export LC_CTYPE=en_US.UTF-8\n+build/pkgs/pari/spkg-install.in:LANG=C\n+build/tox.ini:    LC_ALL = C\n+docker/Dockerfile:ENV LC_ALL C.UTF-8\n+src/sage/docs/conf.py:locale.setlocale(locale.LC_NUMERIC, 'C')\n+src/sage/interfaces/gap.py:            sage: gap = Gap(env={'LC_CTYPE': 'en_US.UTF-8'})\n+src/sage/interfaces/jmoldata.py:            env['LC_ALL'] = 'C'\n+```\n \n See also:\n - #22659\n``````\n",
    "created_at": "2020-09-17T00:31:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478709",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,19 @@
 In #29033 in `build/bin/sage-spkg` LC_ALL was changed to C.UTF-8
 However, not all systems have it. 
 
+There are a few more places that explicitly set locale variables (`LANG` and `LC_*`):
+
+```
+build/bin/sage-site:    export LANG=C # to ensure it is possible to scrape out non-EN locale warnings
+build/bin/sage-spkg: export LC_ALL=C;
+build/pkgs/gap/spkg-check.in:export LC_CTYPE=en_US.UTF-8
+build/pkgs/pari/spkg-install.in:LANG=C
+build/tox.ini:    LC_ALL = C
+docker/Dockerfile:ENV LC_ALL C.UTF-8
+src/sage/docs/conf.py:locale.setlocale(locale.LC_NUMERIC, 'C')
+src/sage/interfaces/gap.py:            sage: gap = Gap(env={'LC_CTYPE': 'en_US.UTF-8'})
+src/sage/interfaces/jmoldata.py:            env['LC_ALL'] = 'C'
+```
 
 See also:
 - #22659
``````




---

archive/issue_comments_478710.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,19 +1,5 @@\n In #29033 in `build/bin/sage-spkg` LC_ALL was changed to C.UTF-8\n However, not all systems have it. \n-\n-There are a few more places that explicitly set locale variables (`LANG` and `LC_*`):\n-\n-```\n-build/bin/sage-site:    export LANG=C # to ensure it is possible to scrape out non-EN locale warnings\n-build/bin/sage-spkg: export LC_ALL=C;\n-build/pkgs/gap/spkg-check.in:export LC_CTYPE=en_US.UTF-8\n-build/pkgs/pari/spkg-install.in:LANG=C\n-build/tox.ini:    LC_ALL = C\n-docker/Dockerfile:ENV LC_ALL C.UTF-8\n-src/sage/docs/conf.py:locale.setlocale(locale.LC_NUMERIC, 'C')\n-src/sage/interfaces/gap.py:            sage: gap = Gap(env={'LC_CTYPE': 'en_US.UTF-8'})\n-src/sage/interfaces/jmoldata.py:            env['LC_ALL'] = 'C'\n-```\n \n See also:\n - #22659\n``````\n",
    "created_at": "2020-09-17T00:32:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478710",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,19 +1,5 @@
 In #29033 in `build/bin/sage-spkg` LC_ALL was changed to C.UTF-8
 However, not all systems have it. 
-
-There are a few more places that explicitly set locale variables (`LANG` and `LC_*`):
-
-```
-build/bin/sage-site:    export LANG=C # to ensure it is possible to scrape out non-EN locale warnings
-build/bin/sage-spkg: export LC_ALL=C;
-build/pkgs/gap/spkg-check.in:export LC_CTYPE=en_US.UTF-8
-build/pkgs/pari/spkg-install.in:LANG=C
-build/tox.ini:    LC_ALL = C
-docker/Dockerfile:ENV LC_ALL C.UTF-8
-src/sage/docs/conf.py:locale.setlocale(locale.LC_NUMERIC, 'C')
-src/sage/interfaces/gap.py:            sage: gap = Gap(env={'LC_CTYPE': 'en_US.UTF-8'})
-src/sage/interfaces/jmoldata.py:            env['LC_ALL'] = 'C'
-```
 
 See also:
 - #22659
``````




---

archive/issue_comments_478711.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/build/careful_with_C_UTF8](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/build/careful_with_C_UTF8)** to **[be47518](https://github.com/sagemath/sagetrac-mirror/commit/be47518c1019d37e11bbac9a3268d69b196691c8)**",
    "created_at": "2020-09-19T13:24:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478711",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/mkoeppe/build/careful_with_C_UTF8](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/build/careful_with_C_UTF8)** to **[be47518](https://github.com/sagemath/sagetrac-mirror/commit/be47518c1019d37e11bbac9a3268d69b196691c8)**



---

archive/issue_events_395563.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-09-19T13:24:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395563"
}
```



---

archive/issue_events_395564.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "a7608327d4be555b37c0c35b46a0f9aeac7237c1",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2020-09-19T13:24:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30053#event-395564"
}
```



---

archive/issue_comments_478712.json:
```json
{
    "body": "Changed commit from **[be47518](https://github.com/sagemath/sagetrac-mirror/commit/be47518c1019d37e11bbac9a3268d69b196691c8)** to none",
    "created_at": "2020-09-21T05:38:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478712",
    "user": "https://github.com/mkoeppe"
}
```

Changed commit from **[be47518](https://github.com/sagemath/sagetrac-mirror/commit/be47518c1019d37e11bbac9a3268d69b196691c8)** to none



---

archive/issue_comments_478713.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,6 +5,7 @@\n - #22659\n \n Follow-up:\n+- #30008 Fix sage-system-python\n - #30586 macOS: Doctest failures in some locales\n - #30576 Python 3.6: Fix locale/encoding issues, then re-enable Python 3.6\n \n``````\n",
    "created_at": "2020-09-21T05:38:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30053",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30053#issuecomment-478713",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,6 +5,7 @@
 - #22659
 
 Follow-up:
+- #30008 Fix sage-system-python
 - #30586 macOS: Doctest failures in some locales
 - #30576 Python 3.6: Fix locale/encoding issues, then re-enable Python 3.6
 
``````

