# Issue 30417: preparsing multi-line strings is broken

archive/issues_030180.json:
```json
{
    "body": "As of the IPython 7 upgrade #28197, preparsing multiline strings does not work anymore. The preparser alters multiline strings, even though it should not:\n\n```\nsage: \"\"\"\n....: abc-1-2\n....: \"\"\"\n'\\nabc-Integer(1)-Integer(2)\\n'    # expected: '\\nabc-1-2\\n'\n```\n\nReported on [devel](https://groups.google.com/forum/#!topic/sage-devel/JV2XwptndKM).\n\nCC:  @antonio-rojas @jhpalmieri @kliem @novoselt\n\nReviewer: Jonathan Kliem\n\nAuthor: Joshua Campbell\n\nBranch: 282fda95b6baf610dae1f3ee9c694fe74b824eb6\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30417\n\n",
    "closed_at": "2020-09-01T23:00:24Z",
    "created_at": "2020-08-21T20:25:10Z",
    "labels": [
        "component: misc",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "preparsing multi-line strings is broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30417",
    "user": "https://github.com/mwageringel"
}
```
As of the IPython 7 upgrade #28197, preparsing multiline strings does not work anymore. The preparser alters multiline strings, even though it should not:

```
sage: """
....: abc-1-2
....: """
'\nabc-Integer(1)-Integer(2)\n'    # expected: '\nabc-1-2\n'
```

Reported on [devel](https://groups.google.com/forum/#!topic/sage-devel/JV2XwptndKM).

CC:  @antonio-rojas @jhpalmieri @kliem @novoselt

Reviewer: Jonathan Kliem

Author: Joshua Campbell

Branch: 282fda95b6baf610dae1f3ee9c694fe74b824eb6

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/30417





---

archive/issue_comments_600503.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2020-08-21T21:54:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600503",
    "user": "https://github.com/novoselt"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_600504.json:
```json
{
    "body": "<a id='comment:1'></a>This makes pretty much all my interacts unusable with no sensible workaround to fix it. I doubt I am the only user with this issue.",
    "created_at": "2020-08-21T21:54:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600504",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:1'></a>This makes pretty much all my interacts unusable with no sensible workaround to fix it. I doubt I am the only user with this issue.



---

archive/issue_comments_600505.json:
```json
{
    "body": "<a id='comment:2'></a>Note that this only happens in the sage shell not during doctesting. If you run this during a doctest, you get the following:\n\n```\nFile \"src/sage/__init__.py\", line 54, in sage.isfunction\nFailed example:\n    '''\n    abc-1-2\n    '''\nExpected nothing\nGot:\n    '\\nabc-1-2\\n'\n```\n\nSo this is exactly what we want. #29139 has a doctest that works find during doctesting but not in real life.",
    "created_at": "2020-08-22T13:04:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600505",
    "user": "https://github.com/kliem"
}
```

<a id='comment:2'></a>Note that this only happens in the sage shell not during doctesting. If you run this during a doctest, you get the following:

```
File "src/sage/__init__.py", line 54, in sage.isfunction
Failed example:
    '''
    abc-1-2
    '''
Expected nothing
Got:
    '\nabc-1-2\n'
```

So this is exactly what we want. #29139 has a doctest that works find during doctesting but not in real life.



---

archive/issue_comments_600506.json:
```json
{
    "body": "<a id='comment:3'></a>Replying to [comment:2 gh-kliem]:\n> Note that this only happens in the sage shell not during doctesting.\n\n\nI assume that is because `BackendDoctest` does not inherit from `BackendIPython`, so doctesting alone will not in general detect this kind of IPython issues.",
    "created_at": "2020-08-22T13:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600506",
    "user": "https://github.com/mwageringel"
}
```

<a id='comment:3'></a>Replying to [comment:2 gh-kliem]:
> Note that this only happens in the sage shell not during doctesting.


I assume that is because `BackendDoctest` does not inherit from `BackendIPython`, so doctesting alone will not in general detect this kind of IPython issues.



---

archive/issue_comments_600507.json:
```json
{
    "body": "<a id='comment:4'></a>I think I was able to track this down and have pushed a branch with an attempt at a fix. The state of whether/which set of quotes we were in wasn't being carried over across lines of input. This fixes the example code in the description and a few other trivial multi-line strings I was able to come up with off the top of my head, but would appreciate if someone could throw it at some real world examples.",
    "created_at": "2020-08-26T00:05:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600507",
    "user": "https://github.com/jcamp0x2a"
}
```

<a id='comment:4'></a>I think I was able to track this down and have pushed a branch with an attempt at a fix. The state of whether/which set of quotes we were in wasn't being carried over across lines of input. This fixes the example code in the description and a few other trivial multi-line strings I was able to come up with off the top of my head, but would appreciate if someone could throw it at some real world examples.



---

archive/issue_comments_600508.json:
```json
{
    "body": "Changing commit from \"\" to \"282fda95b6baf610dae1f3ee9c694fe74b824eb6\"",
    "created_at": "2020-08-26T00:05:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600508",
    "user": "https://github.com/jcamp0x2a"
}
```

Changing commit from "" to "282fda95b6baf610dae1f3ee9c694fe74b824eb6"



---

archive/issue_comments_600509.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-08-26T00:05:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600509",
    "user": "https://github.com/jcamp0x2a"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_600510.json:
```json
{
    "body": "Changing author from \"\" to \"Joshua Campbell\"",
    "created_at": "2020-08-26T00:05:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600510",
    "user": "https://github.com/jcamp0x2a"
}
```

Changing author from "" to "Joshua Campbell"



---

archive/issue_comments_600511.json:
```json
{
    "body": "Changing branch from \"\" to \"u/gh-jcamp0x2a/30417\"",
    "created_at": "2020-08-26T00:05:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600511",
    "user": "https://github.com/jcamp0x2a"
}
```

Changing branch from "" to "u/gh-jcamp0x2a/30417"



---

archive/issue_comments_600512.json:
```json
{
    "body": "<a id='comment:5'></a>Apparently this does the job. Looks fine to me.\n\nWe could remove an unused import, while we are touching the file anyway:\n\n```\n+src/sage/repl/interpreter.py:780:13 'line_profiler' imported but unused\n```",
    "created_at": "2020-08-26T06:21:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600512",
    "user": "https://github.com/kliem"
}
```

<a id='comment:5'></a>Apparently this does the job. Looks fine to me.

We could remove an unused import, while we are touching the file anyway:

```
+src/sage/repl/interpreter.py:780:13 'line_profiler' imported but unused
```



---

archive/issue_comments_600513.json:
```json
{
    "body": "<a id='comment:6'></a>Thanks for figuring this out.",
    "created_at": "2020-08-26T06:21:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600513",
    "user": "https://github.com/kliem"
}
```

<a id='comment:6'></a>Thanks for figuring this out.



---

archive/issue_comments_600514.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:5 gh-kliem]:\n> We could remove an unused import, while we are touching the file anyway:\n> \n> \n> ```\n> +src/sage/repl/interpreter.py:780:13 'line_profiler' imported but unused\n> ```\n\n\nI believe that warning is a false positive. Removing the import breaks over 80% of the doctests in `interpreter.py`. The import is surrounded by a try-catch, so I think the intent is to check that the import *could* be done without actually needing it at the moment.\n\nThanks for taking a look at it!",
    "created_at": "2020-08-26T15:26:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600514",
    "user": "https://github.com/jcamp0x2a"
}
```

<a id='comment:7'></a>Replying to [comment:5 gh-kliem]:
> We could remove an unused import, while we are touching the file anyway:
> 
> 
> ```
> +src/sage/repl/interpreter.py:780:13 'line_profiler' imported but unused
> ```


I believe that warning is a false positive. Removing the import breaks over 80% of the doctests in `interpreter.py`. The import is surrounded by a try-catch, so I think the intent is to check that the import *could* be done without actually needing it at the moment.

Thanks for taking a look at it!



---

archive/issue_comments_600515.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:7 gh-jcamp0x2a]:\n> I believe that warning is a false positive. Removing the import breaks over 80% of the doctests in `interpreter.py`. The import is surrounded by a try-catch, so I think the intent is to check that the import *could* be done without actually needing it at the moment.\n\n\nSorry, sorry. When I commented out the import, I forgot that in Python you need a `pass` statement in an empty block. That's what broke the doctests, not removing the import.\n\nThat said, I think my understanding of the import's intent is still correct, and thus it shouldn't be removed. Here's the full block of code for context:\n\n```python\n# Load the %lprun extension if available\ntry:\n    import line_profiler\nexcept ImportError:\n    pass\nelse:\n    self.extensions.append('line_profiler')\n```",
    "created_at": "2020-08-26T19:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600515",
    "user": "https://github.com/jcamp0x2a"
}
```

<a id='comment:8'></a>Replying to [comment:7 gh-jcamp0x2a]:
> I believe that warning is a false positive. Removing the import breaks over 80% of the doctests in `interpreter.py`. The import is surrounded by a try-catch, so I think the intent is to check that the import *could* be done without actually needing it at the moment.


Sorry, sorry. When I commented out the import, I forgot that in Python you need a `pass` statement in an empty block. That's what broke the doctests, not removing the import.

That said, I think my understanding of the import's intent is still correct, and thus it shouldn't be removed. Here's the full block of code for context:

```python
# Load the %lprun extension if available
try:
    import line_profiler
except ImportError:
    pass
else:
    self.extensions.append('line_profiler')
```



---

archive/issue_comments_600516.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 gh-jcamp0x2a]:\n> I think my understanding of the import's intent is still correct, and thus it shouldn't be removed. \n\n\nI agree",
    "created_at": "2020-08-27T01:28:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600516",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>Replying to [comment:8 gh-jcamp0x2a]:
> I think my understanding of the import's intent is still correct, and thus it shouldn't be removed. 


I agree



---

archive/issue_comments_600517.json:
```json
{
    "body": "<a id='comment:10'></a>Sorry for keeping you busy. I usually trust those `pyflakles` warnings blindly, because usually it is right. But in this case this seems to be not the case.",
    "created_at": "2020-08-27T05:11:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600517",
    "user": "https://github.com/kliem"
}
```

<a id='comment:10'></a>Sorry for keeping you busy. I usually trust those `pyflakles` warnings blindly, because usually it is right. But in this case this seems to be not the case.



---

archive/issue_comments_600518.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jonathan Kliem\"",
    "created_at": "2020-08-27T06:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600518",
    "user": "https://github.com/kliem"
}
```

Changing reviewer from "" to "Jonathan Kliem"



---

archive/issue_comments_600519.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-27T06:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600519",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_600520.json:
```json
{
    "body": "<a id='comment:11'></a>Ok. Looks good to me.",
    "created_at": "2020-08-27T06:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600520",
    "user": "https://github.com/kliem"
}
```

<a id='comment:11'></a>Ok. Looks good to me.



---

archive/issue_comments_600521.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-09-01T23:00:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600521",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_600522.json:
```json
{
    "body": "Changing branch from \"u/gh-jcamp0x2a/30417\" to \"282fda95b6baf610dae1f3ee9c694fe74b824eb6\"",
    "created_at": "2020-09-01T23:00:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600522",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/gh-jcamp0x2a/30417" to "282fda95b6baf610dae1f3ee9c694fe74b824eb6"



---

archive/issue_events_078884.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-09-01T23:00:24Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30417#event-78884"
}
```



---

archive/issue_comments_600523.json:
```json
{
    "body": "Changing commit from \"282fda95b6baf610dae1f3ee9c694fe74b824eb6\" to \"\"",
    "created_at": "2020-11-17T08:08:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600523",
    "user": "https://github.com/egourgoulhon"
}
```

Changing commit from "282fda95b6baf610dae1f3ee9c694fe74b824eb6" to ""



---

archive/issue_comments_600524.json:
```json
{
    "body": "<a id='comment:13'></a>See #30928 for a possible follow-up.",
    "created_at": "2020-11-17T08:08:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30417",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30417#issuecomment-600524",
    "user": "https://github.com/egourgoulhon"
}
```

<a id='comment:13'></a>See #30928 for a possible follow-up.
