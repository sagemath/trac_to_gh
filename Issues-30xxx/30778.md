# Issue 30778: sage.doctest.control: Exclude doctests in files via file directives ''# sage.doctest: optional - xyz'

archive/issues_030541.json:
```json
{
    "body": "CC:  simonking @kiwifb @roed314 @saraedum @nthiery @videlec\n\nKeywords: sd111\n\nWhen a file is marked `# sage.doctest: optional - xyz`, we omit it from doctesting unless `--optional=xyz` is given.\n\nThis will save us from having to add lots of `# optional - ...` tags to files in the course of modularization (#29705)\n\nWe do this by extending `sage.doctest.control.skipfile`, which already parses files for `# nodoctest` file directives.\n\nPrevious related proposals/discussions: #3260, #20427\n\nAlso related: #30746\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/30778\n\n",
    "closed_at": "2021-10-10T10:17:16Z",
    "created_at": "2020-10-16T20:58:54Z",
    "labels": [
        "component: doctest framework"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "sage.doctest.control: Exclude doctests in files via file directives ''# sage.doctest: optional - xyz'",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30778",
    "user": "https://github.com/mkoeppe"
}
```
CC:  simonking @kiwifb @roed314 @saraedum @nthiery @videlec

Keywords: sd111

When a file is marked `# sage.doctest: optional - xyz`, we omit it from doctesting unless `--optional=xyz` is given.

This will save us from having to add lots of `# optional - ...` tags to files in the course of modularization (#29705)

We do this by extending `sage.doctest.control.skipfile`, which already parses files for `# nodoctest` file directives.

Previous related proposals/discussions: #3260, #20427

Also related: #30746


Issue created by migration from https://trac.sagemath.org/ticket/30778





---

archive/issue_events_080248.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-16T22:00:48Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30778#event-80248"
}
```



---

archive/issue_comments_435657.json:
```json
{
    "body": "Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435657",
    "user": "https://github.com/mkoeppe"
}
```

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111



---

archive/issue_comments_435658.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd111\".",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435658",
    "user": "https://github.com/mkoeppe"
}
```

Changing keywords from "" to "sd111".



---

archive/issue_events_080249.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-12T19:01:39Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30778#event-80249"
}
```



---

archive/issue_events_080250.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-12T19:01:39Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30778#event-80250"
}
```



---

archive/issue_comments_435659.json:
```json
{
    "body": "We could also parse a directive \"# doctest: optional - ...\" in the file header",
    "created_at": "2021-02-17T21:37:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435659",
    "user": "https://github.com/mkoeppe"
}
```

We could also parse a directive "# doctest: optional - ..." in the file header



---

archive/issue_comments_435660.json:
```json
{
    "body": "Replying to [comment:6 mkoeppe]:\n> We could also parse a directive \"# doctest: optional - ...\" in the file header\n\n\nThis has been discussed in the past and rejected, on the grounds that the directive is hidden when people look at the reference manual or just do `x.method?`, so they may expect those tests to work all the time. For any of these proposed directives, the corresponding page in the reference manual should have a clear warning. I don't know what to do about the help string for each relevant method/function/class. It's overkill to modify the help string based on such a directive, right?",
    "created_at": "2021-02-18T00:26:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435660",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:6 mkoeppe]:
> We could also parse a directive "# doctest: optional - ..." in the file header


This has been discussed in the past and rejected, on the grounds that the directive is hidden when people look at the reference manual or just do `x.method?`, so they may expect those tests to work all the time. For any of these proposed directives, the corresponding page in the reference manual should have a clear warning. I don't know what to do about the help string for each relevant method/function/class. It's overkill to modify the help string based on such a directive, right?



---

archive/issue_comments_435661.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-02-18T00:26:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435661",
    "user": "https://github.com/jhpalmieri"
}
```

New commits:



---

archive/issue_comments_435662.json:
```json
{
    "body": "Replying to [comment:8 jhpalmieri]:\n> Replying to [comment:6 mkoeppe]:\n> > We could also parse a directive \"# doctest: optional - ...\" in the file header\n\n> \n> This has been discussed in the past and rejected\n\n\nI was trying to find the ticket with this discussion but did not succeed\n\n---\nNew commits:",
    "created_at": "2021-02-18T00:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435662",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:8 jhpalmieri]:
> Replying to [comment:6 mkoeppe]:
> > We could also parse a directive "# doctest: optional - ..." in the file header

> 
> This has been discussed in the past and rejected


I was trying to find the ticket with this discussion but did not succeed

---
New commits:



---

archive/issue_comments_435663.json:
```json
{
    "body": "There is certainly an open question here. I don't think it's only a matter of marking up the doctests with \"optional\" tags. With modularization going forward, we need to find a way to inform the user that some Python module is provided by a particular distribution package. I think this information should be attached to the module name instead of cluttering the doctests.",
    "created_at": "2021-02-18T00:37:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435663",
    "user": "https://github.com/mkoeppe"
}
```

There is certainly an open question here. I don't think it's only a matter of marking up the doctests with "optional" tags. With modularization going forward, we need to find a way to inform the user that some Python module is provided by a particular distribution package. I think this information should be attached to the module name instead of cluttering the doctests.



---

archive/issue_comments_435664.json:
```json
{
    "body": "Until we have a more systematic solution for this, I would just suggest that we add an admonition to the module documentation that says something like: \"The classes in this module require the optional package `rpy2` to be installed\"",
    "created_at": "2021-02-18T00:59:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435664",
    "user": "https://github.com/mkoeppe"
}
```

Until we have a more systematic solution for this, I would just suggest that we add an admonition to the module documentation that says something like: "The classes in this module require the optional package `rpy2` to be installed"



---

archive/issue_comments_435665.json:
```json
{
    "body": "OK, found some previous discussion: #3260, #20427",
    "created_at": "2021-02-18T01:02:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435665",
    "user": "https://github.com/mkoeppe"
}
```

OK, found some previous discussion: #3260, #20427



---

archive/issue_comments_435666.json:
```json
{
    "body": "Looks like this topic is showing up every 4-6 years.\n\nWhat has changed now is that modularization (#29705) would introduce LOTS of new optional tags if we don't find a systematic solution.",
    "created_at": "2021-02-18T01:07:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435666",
    "user": "https://github.com/mkoeppe"
}
```

Looks like this topic is showing up every 4-6 years.

What has changed now is that modularization (#29705) would introduce LOTS of new optional tags if we don't find a systematic solution.



---

archive/issue_comments_435667.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-02-18T01:08:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435667",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_435668.json:
```json
{
    "body": "How about a change like this?\n\n```diff\ndiff --git a/src/sage/doctest/control.py b/src/sage/doctest/control.py\nindex 6e75131fb3..0b10e19552 100644\n--- a/src/sage/doctest/control.py\n+++ b/src/sage/doctest/control.py\n@@ -216,6 +216,10 @@ def skipfile(filename, tested_optional_tags=False):\n     - ``tested_optional_tags`` - a list or tuple or set of optional tags to test,\n       or ``False`` (no optional test) or ``True`` (all optional tests)\n \n+    If ``filename`` contains a line of the form ``\"# sage.doctest:\n+    optional - xyz\")``, then this will return ``False`` if \"xyz\" is in\n+    ``tested_optional_tags``. Otherwise, it returns the matching line.\n+\n     EXAMPLES::\n \n         sage: from sage.doctest.control import skipfile\n@@ -231,9 +235,11 @@ def skipfile(filename, tested_optional_tags=False):\n         sage: with open(filename, \"w\") as f:\n         ....:     _ = f.write(\"# sage.doctest: optional - xyz\")\n         sage: skipfile(filename, False)\n+        '# sage.doctest: optional - xyz'\n+        sage: bool(skipfile(filename, False))\n         True\n         sage: skipfile(filename, ['abc'])\n-        True\n+        '# sage.doctest: optional - xyz'\n         sage: skipfile(filename, ['abc', 'xyz'])\n         False\n         sage: skipfile(filename, True)\n@@ -252,11 +258,11 @@ def skipfile(filename, tested_optional_tags=False):\n                 m = optionalfiledirective_regex.match(line)\n                 if m:\n                     if tested_optional_tags is False:\n-                        return True\n+                        return m.group(0)\n                     optional_tags = parse_optional_tags('#' + m.group(2))\n                     extra = optional_tags - set(tested_optional_tags)\n                     if extra:\n-                        return True\n+                        return m.group(0)\n             line_count += 1\n             if line_count >= 10:\n                 break\ndiff --git a/src/sage/misc/sageinspect.py b/src/sage/misc/sageinspect.py\nindex a37edbbffc..670a4aa4e6 100644\n--- a/src/sage/misc/sageinspect.py\n+++ b/src/sage/misc/sageinspect.py\n@@ -2031,6 +2031,15 @@ def sage_getdoc(obj, obj_name='', embedded_override=False):\n         return ''\n     r = sage_getdoc_original(obj)\n     s = sage.misc.sagedoc.format(r, embedded=(embedded_override or EMBEDDED_MODE))\n+    f = sage_getfile(obj)\n+    if f:\n+        from sage.doctest.control import skipfile\n+        skip = skipfile(f)\n+        if skip:\n+            warn = \"\"\"WARNING: the enclosing module is marked '{}',\n+so doctests may not pass.\"\"\".format(skip)\n+            s = warn + \"\\n\\n\" + s\n+        pass\n \n     # Fix object naming\n     if obj_name != '':\n```\nThen the help message printed by `obj?` will include a warning if the file is tagged to be skipped. Is it okay if `skipfile` returns a string instead of just `True`?",
    "created_at": "2021-02-19T00:30:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435668",
    "user": "https://github.com/jhpalmieri"
}
```

How about a change like this?

```diff
diff --git a/src/sage/doctest/control.py b/src/sage/doctest/control.py
index 6e75131fb3..0b10e19552 100644
--- a/src/sage/doctest/control.py
+++ b/src/sage/doctest/control.py
@@ -216,6 +216,10 @@ def skipfile(filename, tested_optional_tags=False):
     - ``tested_optional_tags`` - a list or tuple or set of optional tags to test,
       or ``False`` (no optional test) or ``True`` (all optional tests)
 
+    If ``filename`` contains a line of the form ``"# sage.doctest:
+    optional - xyz")``, then this will return ``False`` if "xyz" is in
+    ``tested_optional_tags``. Otherwise, it returns the matching line.
+
     EXAMPLES::
 
         sage: from sage.doctest.control import skipfile
@@ -231,9 +235,11 @@ def skipfile(filename, tested_optional_tags=False):
         sage: with open(filename, "w") as f:
         ....:     _ = f.write("# sage.doctest: optional - xyz")
         sage: skipfile(filename, False)
+        '# sage.doctest: optional - xyz'
+        sage: bool(skipfile(filename, False))
         True
         sage: skipfile(filename, ['abc'])
-        True
+        '# sage.doctest: optional - xyz'
         sage: skipfile(filename, ['abc', 'xyz'])
         False
         sage: skipfile(filename, True)
@@ -252,11 +258,11 @@ def skipfile(filename, tested_optional_tags=False):
                 m = optionalfiledirective_regex.match(line)
                 if m:
                     if tested_optional_tags is False:
-                        return True
+                        return m.group(0)
                     optional_tags = parse_optional_tags('#' + m.group(2))
                     extra = optional_tags - set(tested_optional_tags)
                     if extra:
-                        return True
+                        return m.group(0)
             line_count += 1
             if line_count >= 10:
                 break
diff --git a/src/sage/misc/sageinspect.py b/src/sage/misc/sageinspect.py
index a37edbbffc..670a4aa4e6 100644
--- a/src/sage/misc/sageinspect.py
+++ b/src/sage/misc/sageinspect.py
@@ -2031,6 +2031,15 @@ def sage_getdoc(obj, obj_name='', embedded_override=False):
         return ''
     r = sage_getdoc_original(obj)
     s = sage.misc.sagedoc.format(r, embedded=(embedded_override or EMBEDDED_MODE))
+    f = sage_getfile(obj)
+    if f:
+        from sage.doctest.control import skipfile
+        skip = skipfile(f)
+        if skip:
+            warn = """WARNING: the enclosing module is marked '{}',
+so doctests may not pass.""".format(skip)
+            s = warn + "\n\n" + s
+        pass
 
     # Fix object naming
     if obj_name != '':
```
Then the help message printed by `obj?` will include a warning if the file is tagged to be skipped. Is it okay if `skipfile` returns a string instead of just `True`?



---

archive/issue_comments_435669.json:
```json
{
    "body": "I like this idea. How about using `m.group(2)` instead? I don't think the reader needs to know about the syntax of the `# sage.doctest:` directive",
    "created_at": "2021-02-19T01:05:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435669",
    "user": "https://github.com/mkoeppe"
}
```

I like this idea. How about using `m.group(2)` instead? I don't think the reader needs to know about the syntax of the `# sage.doctest:` directive



---

archive/issue_comments_435670.json:
```json
{
    "body": "How about this? I also added a bit to the developer's guide.\n\n---\nNew commits:",
    "created_at": "2021-02-19T04:06:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435670",
    "user": "https://github.com/jhpalmieri"
}
```

How about this? I also added a bit to the developer's guide.

---
New commits:



---

archive/issue_comments_435671.json:
```json
{
    "body": "Are there any files in the Sage library now that we want to use this feature on?  I think having some examples (in this ticket or a followup) would be good.\n\nThere are also a couple test failures reported by the patchbot.",
    "created_at": "2021-03-04T19:19:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435671",
    "user": "https://github.com/roed314"
}
```

Are there any files in the Sage library now that we want to use this feature on?  I think having some examples (in this ticket or a followup) would be good.

There are also a couple test failures reported by the patchbot.



---

archive/issue_comments_435672.json:
```json
{
    "body": "Replying to [comment:23 roed]:\n> Are there any files in the Sage library now that we want to use this feature on?  I think having some examples (in this ticket or a followup) would be good.\n\n\nIt makes sense for optional extension modules, such as sage.matrix.matrix_gfpn_dense (but I don't know if there are others). Indeed the doctests are one reason why my optional package p_group_cohomology is not part of the sage library, although is is mostly written in Python and Cython and would thus fit well into the Sage library (but should still be an optional package).",
    "created_at": "2021-03-04T20:02:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435672",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:23 roed]:
> Are there any files in the Sage library now that we want to use this feature on?  I think having some examples (in this ticket or a followup) would be good.


It makes sense for optional extension modules, such as sage.matrix.matrix_gfpn_dense (but I don't know if there are others). Indeed the doctests are one reason why my optional package p_group_cohomology is not part of the sage library, although is is mostly written in Python and Cython and would thus fit well into the Sage library (but should still be an optional package).



---

archive/issue_comments_435673.json:
```json
{
    "body": "Yes, so let's do #30787...",
    "created_at": "2021-03-04T20:07:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435673",
    "user": "https://github.com/mkoeppe"
}
```

Yes, so let's do #30787...



---

archive/issue_comments_435674.json:
```json
{
    "body": "Replying to [comment:23 roed]:\n> Are there any files in the Sage library now that we want to use this feature on?  I think having some examples (in this ticket or a followup) would be good.\n\n\nIndeed it would be best to test this on files that are in tree but could be made \"optional\" via the same mechanism that we already use for extensions modules depending on optional packages. Candidates are:\n- modules depending on `giac`\n- modules depending on `brial`\n- modules depending on `ntl`\n- more - see #30666\n\nSince this will require modification of `setup.py`, it's best to do this on top of #31377, #30912",
    "created_at": "2021-03-04T22:34:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435674",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:23 roed]:
> Are there any files in the Sage library now that we want to use this feature on?  I think having some examples (in this ticket or a followup) would be good.


Indeed it would be best to test this on files that are in tree but could be made "optional" via the same mechanism that we already use for extensions modules depending on optional packages. Candidates are:
- modules depending on `giac`
- modules depending on `brial`
- modules depending on `ntl`
- more - see #30666

Since this will require modification of `setup.py`, it's best to do this on top of #31377, #30912



---

archive/issue_comments_435675.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-03-04T22:46:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435675",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_435676.json:
```json
{
    "body": "... and on top of #30383 because we need to make it possible to use `configure --disable-...` for at least one standard package.",
    "created_at": "2021-03-06T00:32:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435676",
    "user": "https://github.com/mkoeppe"
}
```

... and on top of #30383 because we need to make it possible to use `configure --disable-...` for at least one standard package.



---

archive/issue_events_080251.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30778#event-80251"
}
```



---

archive/issue_events_080252.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30778#event-80252"
}
```



---

archive/issue_comments_435677.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435677",
    "user": "https://github.com/mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_435678.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-01T18:36:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435678",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435679.json:
```json
{
    "body": "This could still use some examples, as mentioned in comment:23 and comment:26.",
    "created_at": "2021-10-01T18:37:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435679",
    "user": "https://github.com/jhpalmieri"
}
```

This could still use some examples, as mentioned in comment:23 and comment:26.



---

archive/issue_comments_435680.json:
```json
{
    "body": "As an example, we could apply it to `src/sage/matrix/matrix_gfpn_dense.pyx` and remove the line-by-line annotations \"# optional: meataxe\".\n\nHowever, as `git grep 'sage:' src/sage/matrix/matrix_gfpn_dense.pyx` shows, there are some doctest lines that are not marked optional. Not sure if they have any value by themselves.",
    "created_at": "2021-10-01T19:39:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435680",
    "user": "https://github.com/mkoeppe"
}
```

As an example, we could apply it to `src/sage/matrix/matrix_gfpn_dense.pyx` and remove the line-by-line annotations "# optional: meataxe".

However, as `git grep 'sage:' src/sage/matrix/matrix_gfpn_dense.pyx` shows, there are some doctest lines that are not marked optional. Not sure if they have any value by themselves.



---

archive/issue_comments_435681.json:
```json
{
    "body": "`@`SimonKing: would you object if we skipped all tests in `src/sage/matrix/matrix_gfpn_dense.pyx` unless `meataxe` is installed? I've skimmed through and don't see anything that (I hope) isn't tested elsewhere for other matrix implementations, but you know this file pretty well.",
    "created_at": "2021-10-01T22:31:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435681",
    "user": "https://github.com/jhpalmieri"
}
```

`@`SimonKing: would you object if we skipped all tests in `src/sage/matrix/matrix_gfpn_dense.pyx` unless `meataxe` is installed? I've skimmed through and don't see anything that (I hope) isn't tested elsewhere for other matrix implementations, but you know this file pretty well.



---

archive/issue_comments_435682.json:
```json
{
    "body": "Replying to [comment:36 jhpalmieri]:\n> `@`SimonKing: would you object if we skipped all tests in `src/sage/matrix/matrix_gfpn_dense.pyx` unless `meataxe` is installed? I've skimmed through and don't see anything that (I hope) isn't tested elsewhere for other matrix implementations, but you know this file pretty well.\n\n\nI did not intend to create new tests for other matrix implementations. So, I wouldn't object to make all the module's tests optional. In fact, this is what I asked for since I first created the module.",
    "created_at": "2021-10-02T06:13:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435682",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:36 jhpalmieri]:
> `@`SimonKing: would you object if we skipped all tests in `src/sage/matrix/matrix_gfpn_dense.pyx` unless `meataxe` is installed? I've skimmed through and don't see anything that (I hope) isn't tested elsewhere for other matrix implementations, but you know this file pretty well.


I did not intend to create new tests for other matrix implementations. So, I wouldn't object to make all the module's tests optional. In fact, this is what I asked for since I first created the module.



---

archive/issue_comments_435683.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-10-02T15:49:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435683",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_435684.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-10-02T15:49:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435684",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_435685.json:
```json
{
    "body": "(untested)",
    "created_at": "2021-10-02T16:29:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435685",
    "user": "https://github.com/mkoeppe"
}
```

(untested)



---

archive/issue_comments_435686.json:
```json
{
    "body": "This is working for me the way that I think it should: commands like `make ptestlong` or `./sage -tp src/sage/matrix/` ignore `matrix_gfpn_dense.pyx`, but if you specify the file explicitly (or let the shell specify it with `./sage -tp src/sage/matrix/matrix_g*`), then it gets tested, and of course many tests fail. I think that's the right behavior.",
    "created_at": "2021-10-02T22:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435686",
    "user": "https://github.com/jhpalmieri"
}
```

This is working for me the way that I think it should: commands like `make ptestlong` or `./sage -tp src/sage/matrix/` ignore `matrix_gfpn_dense.pyx`, but if you specify the file explicitly (or let the shell specify it with `./sage -tp src/sage/matrix/matrix_g*`), then it gets tested, and of course many tests fail. I think that's the right behavior.



---

archive/issue_comments_435687.json:
```json
{
    "body": "Remains to put something in the documentation of `matrix_gfpn_dense.pyx`, as discussed in comment:8, comment:13, comment:14",
    "created_at": "2021-10-02T22:17:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435687",
    "user": "https://github.com/mkoeppe"
}
```

Remains to put something in the documentation of `matrix_gfpn_dense.pyx`, as discussed in comment:8, comment:13, comment:14



---

archive/issue_comments_435688.json:
```json
{
    "body": "Replying to [comment:42 mkoeppe]:\n> Remains to put something in the documentation of `matrix_gfpn_dense.pyx`, as discussed in comment:8, comment:13, comment:14\n\n\nThis is easy enough to do manually. It would be nice to autodetect the line `# sage.doctest: optional - meataxe`, but do we want to do that here or a follow-up ticket?",
    "created_at": "2021-10-03T19:41:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435688",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:42 mkoeppe]:
> Remains to put something in the documentation of `matrix_gfpn_dense.pyx`, as discussed in comment:8, comment:13, comment:14


This is easy enough to do manually. It would be nice to autodetect the line `# sage.doctest: optional - meataxe`, but do we want to do that here or a follow-up ticket?



---

archive/issue_comments_435689.json:
```json
{
    "body": "Let's do this manually for this ticket first",
    "created_at": "2021-10-03T20:27:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435689",
    "user": "https://github.com/mkoeppe"
}
```

Let's do this manually for this ticket first



---

archive/issue_comments_435690.json:
```json
{
    "body": "In #32614 I now define some new optional tags, in particular a tag `sage.matrix.matrix_gfpn_dense`. So if we depend on that ticket, we could now write `# sage.doctest: optional - sage.matrix.matrix_gfpn_dense`; and in the module documentation we could refer to the class providing the feature (`sage__matrix__matrix_gfpn_dense`)",
    "created_at": "2021-10-03T23:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435690",
    "user": "https://github.com/mkoeppe"
}
```

In #32614 I now define some new optional tags, in particular a tag `sage.matrix.matrix_gfpn_dense`. So if we depend on that ticket, we could now write `# sage.doctest: optional - sage.matrix.matrix_gfpn_dense`; and in the module documentation we could refer to the class providing the feature (`sage__matrix__matrix_gfpn_dense`)



---

archive/issue_comments_435691.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-06T04:17:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435691",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_435692.json:
```json
{
    "body": "I've kept it simple and just added a note in the docstring.\n\nBut do we actually build HTML documentation for optional compiled modules at all?",
    "created_at": "2021-10-06T04:18:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435692",
    "user": "https://github.com/mkoeppe"
}
```

I've kept it simple and just added a note in the docstring.

But do we actually build HTML documentation for optional compiled modules at all?



---

archive/issue_comments_435693.json:
```json
{
    "body": "I'm happy with your changes on the ticket: positive review for those parts.",
    "created_at": "2021-10-07T18:22:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435693",
    "user": "https://github.com/jhpalmieri"
}
```

I'm happy with your changes on the ticket: positive review for those parts.



---

archive/issue_comments_435694.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-10-07T18:23:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435694",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_435695.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-10-07T18:23:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435695",
    "user": "https://github.com/mkoeppe"
}
```

Thanks!



---

archive/issue_events_080253.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-10-10T10:17:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30778#event-80253"
}
```



---

archive/issue_comments_435696.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-10-10T10:17:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30778",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30778#issuecomment-435696",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
