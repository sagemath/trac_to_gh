# Issue 30146: #29843 introduces a bug in Polyhedron().linear_transformation

archive/issues_029909.json:
```json
{
    "body": "In 9.2.beta5 applying linear transformations to a polyhedron containing a ray is broken:\n\n```\nsage: Polyhedron(rays=[(0,1)]).linear_transformation(identity_matrix(2))\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-185-3c5f2df4fe7c> in <module>()\n----> 1 Polyhedron(rays=[(Integer(0),Integer(1))]).linear_transformation(identity_matrix(Integer(2)))\n\n/opt/sage/sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py in linear_transformation(self, linear_transf, new_base_ring)\n   5093 \n   5094             sage: P = Polyhedron([(0,0),(1,1)], base_ring=ZZ)\n-> 5095             sage: P.intersection(P)\n   5096             A 1-dimensional polyhedron in ZZ^2 defined as the convex hull of 2 vertices\n   5097             sage: Q = Polyhedron([(0,1),(1,0)], base_ring=ZZ)\n\n/opt/sage/sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py in __init__(self, parent, Vrep, Hrep, Vrep_minimal, Hrep_minimal, pref_rep, **kwds)\n    218         # TODO: find something better *but* fast\n    219         return hash((self.dim(),\n--> 220                      self.ambient_dim(),\n    221                      self.n_Hrepresentation(),\n    222                      self.n_Vrepresentation(),\n\n/opt/sage/sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/backend_ppl.py in _init_from_Vrepresentation(self, vertices, rays, lines, minimize, verbose)\n     75             d = LCM_list([denominator(r_i) for r_i in r])\n     76             if d.is_one():\n---> 77                 gs.insert(ray(Linear_Expression(r, 0)))\n     78             else:\n     79                 dr = [ d*r_i for r_i in r ]\n\nppl/generator.pyx in ppl.generator.Generator.ray()\n\nppl/generator.pyx in ppl.generator.Generator.ray()\n\nValueError: PPL::ray(e):\ne == 0, but the origin cannot be a ray.\n```\n\nthis used to work just fine in 9.2.beta4.\n\n`git bisect` seems to blame the regression on #29843\n\nCC:  @jplab @laisrast @kliem @mkoeppe\n\nKeywords: combinatorial polyhedron, linear transformation\n\nBranch/Commit: [c9c7b63f1ed9fda028044385920f2b7849cfbd2b](https://github.com/sagemath/sagetrac-mirror/commit/c9c7b63f1ed9fda028044385920f2b7849cfbd2b)\n\nReviewer: Matthias Koeppe\n\nAuthor: Jonathan Kliem\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30146\n\n",
    "closed_at": "2020-07-28T22:34:36Z",
    "created_at": "2020-07-14T21:48:44Z",
    "labels": [
        "component: geometry",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "#29843 introduces a bug in Polyhedron().linear_transformation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30146",
    "user": "https://github.com/etn40ff"
}
```
In 9.2.beta5 applying linear transformations to a polyhedron containing a ray is broken:

```
sage: Polyhedron(rays=[(0,1)]).linear_transformation(identity_matrix(2))
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-185-3c5f2df4fe7c> in <module>()
----> 1 Polyhedron(rays=[(Integer(0),Integer(1))]).linear_transformation(identity_matrix(Integer(2)))

/opt/sage/sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py in linear_transformation(self, linear_transf, new_base_ring)
   5093 
   5094             sage: P = Polyhedron([(0,0),(1,1)], base_ring=ZZ)
-> 5095             sage: P.intersection(P)
   5096             A 1-dimensional polyhedron in ZZ^2 defined as the convex hull of 2 vertices
   5097             sage: Q = Polyhedron([(0,1),(1,0)], base_ring=ZZ)

/opt/sage/sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/base.py in __init__(self, parent, Vrep, Hrep, Vrep_minimal, Hrep_minimal, pref_rep, **kwds)
    218         # TODO: find something better *but* fast
    219         return hash((self.dim(),
--> 220                      self.ambient_dim(),
    221                      self.n_Hrepresentation(),
    222                      self.n_Vrepresentation(),

/opt/sage/sage/local/lib/python3.7/site-packages/sage/geometry/polyhedron/backend_ppl.py in _init_from_Vrepresentation(self, vertices, rays, lines, minimize, verbose)
     75             d = LCM_list([denominator(r_i) for r_i in r])
     76             if d.is_one():
---> 77                 gs.insert(ray(Linear_Expression(r, 0)))
     78             else:
     79                 dr = [ d*r_i for r_i in r ]

ppl/generator.pyx in ppl.generator.Generator.ray()

ppl/generator.pyx in ppl.generator.Generator.ray()

ValueError: PPL::ray(e):
e == 0, but the origin cannot be a ray.
```

this used to work just fine in 9.2.beta4.

`git bisect` seems to blame the regression on #29843

CC:  @jplab @laisrast @kliem @mkoeppe

Keywords: combinatorial polyhedron, linear transformation

Branch/Commit: [c9c7b63f1ed9fda028044385920f2b7849cfbd2b](https://github.com/sagemath/sagetrac-mirror/commit/c9c7b63f1ed9fda028044385920f2b7849cfbd2b)

Reviewer: Matthias Koeppe

Author: Jonathan Kliem

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/30146





---

archive/issue_comments_593274.json:
```json
{
    "body": "<a id='comment:2'></a>\nThanks for catching this. This is another friendly reminder that working on those test suites is really useful.",
    "created_at": "2020-07-15T05:57:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30146",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30146#issuecomment-593274",
    "user": "https://github.com/kliem"
}
```

<a id='comment:2'></a>
Thanks for catching this. This is another friendly reminder that working on those test suites is really useful.



---

archive/issue_comments_593275.json:
```json
{
    "body": "Changing commit from \"\" to \"4eff4137dfac9c656bb8e50343be76efae2974ae\"",
    "created_at": "2020-07-15T05:57:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30146",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30146#issuecomment-593275",
    "user": "https://github.com/kliem"
}
```

Changing commit from "" to "4eff4137dfac9c656bb8e50343be76efae2974ae"



---

archive/issue_comments_593276.json:
```json
{
    "body": "Changing author from \"\" to \"Jonathan Kliem\"",
    "created_at": "2020-07-15T05:57:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30146",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30146#issuecomment-593276",
    "user": "https://github.com/kliem"
}
```

Changing author from "" to "Jonathan Kliem"



---

archive/issue_comments_593277.json:
```json
{
    "body": "<a id='comment:3'></a>\nNew commits:\n|                                                                                                                                          |                             |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------|\n|[07e4ab1](https://github.com/sagemath/sagetrac-mirror/commit/07e4ab1c319a420b00bdf5e43199d3195ba1efa3)|`fix bog introduced by 39843`|\n|[4eff413](https://github.com/sagemath/sagetrac-mirror/commit/4eff4137dfac9c656bb8e50343be76efae2974ae)|`add tiny testsuite to doctest`|",
    "created_at": "2020-07-15T05:57:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30146",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30146#issuecomment-593277",
    "user": "https://github.com/kliem"
}
```

<a id='comment:3'></a>
New commits:
|                                                                                                                                          |                             |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------|
|[07e4ab1](https://github.com/sagemath/sagetrac-mirror/commit/07e4ab1c319a420b00bdf5e43199d3195ba1efa3)|`fix bog introduced by 39843`|
|[4eff413](https://github.com/sagemath/sagetrac-mirror/commit/4eff4137dfac9c656bb8e50343be76efae2974ae)|`add tiny testsuite to doctest`|



---

archive/issue_comments_593278.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-07-15T05:57:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30146",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30146#issuecomment-593278",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_593279.json:
```json
{
    "body": "Changing branch from \"\" to \"public/30146\"",
    "created_at": "2020-07-15T05:57:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30146",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30146#issuecomment-593279",
    "user": "https://github.com/kliem"
}
```

Changing branch from "" to "public/30146"



---

archive/issue_comments_593280.json:
```json
{
    "body": "<a id='comment:4'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                        |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------|\n|[7fe6b43](https://github.com/sagemath/sagetrac-mirror/commit/7fe6b43d2ab3adde507fe745726b82c3bbc8059d)|`One transposition only`|",
    "created_at": "2020-07-15T07:28:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30146",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30146#issuecomment-593280",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                        |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------|
|[7fe6b43](https://github.com/sagemath/sagetrac-mirror/commit/7fe6b43d2ab3adde507fe745726b82c3bbc8059d)|`One transposition only`|



---

archive/issue_comments_593281.json:
```json
{
    "body": "Changing commit from \"4eff4137dfac9c656bb8e50343be76efae2974ae\" to \"7fe6b43d2ab3adde507fe745726b82c3bbc8059d\"",
    "created_at": "2020-07-15T07:28:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30146",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30146#issuecomment-593281",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "4eff4137dfac9c656bb8e50343be76efae2974ae" to "7fe6b43d2ab3adde507fe745726b82c3bbc8059d"



---

archive/issue_comments_593282.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [git](#comment%3A4):\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> |                                                                                                                                           |                        |\n> |-------------------------------------------------------------------------------------------------------------------------------------------|------------------------|\n> |[7fe6b43](https://github.com/sagemath/sagetrac-mirror/commit/7fe6b43d2ab3adde507fe745726b82c3bbc8059d)|`One transposition only`|\n\n\nI was thinking about that one. At first glance this might be a bit weird, because the matrix is supposed to act from the left. However it is shorter and easier to read I guess (and slightly faster I suppose).",
    "created_at": "2020-07-15T07:33:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30146",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30146#issuecomment-593282",
    "user": "https://github.com/kliem"
}
```

<a id='comment:5'></a>
Replying to [git](#comment%3A4):
> Branch pushed to git repo; I updated commit sha1. New commits:
> |                                                                                                                                           |                        |
> |-------------------------------------------------------------------------------------------------------------------------------------------|------------------------|
> |[7fe6b43](https://github.com/sagemath/sagetrac-mirror/commit/7fe6b43d2ab3adde507fe745726b82c3bbc8059d)|`One transposition only`|


I was thinking about that one. At first glance this might be a bit weird, because the matrix is supposed to act from the left. However it is shorter and easier to read I guess (and slightly faster I suppose).



---

archive/issue_comments_593283.json:
```json
{
    "body": "Changing commit from \"7fe6b43d2ab3adde507fe745726b82c3bbc8059d\" to \"c9c7b63f1ed9fda028044385920f2b7849cfbd2b\"",
    "created_at": "2020-07-19T06:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30146",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30146#issuecomment-593283",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "7fe6b43d2ab3adde507fe745726b82c3bbc8059d" to "c9c7b63f1ed9fda028044385920f2b7849cfbd2b"



---

archive/issue_comments_593284.json:
```json
{
    "body": "<a id='comment:6'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                       |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------|\n|[c9c7b63](https://github.com/sagemath/sagetrac-mirror/commit/c9c7b63f1ed9fda028044385920f2b7849cfbd2b)|`missed preceeding `sage:` of doctests`|",
    "created_at": "2020-07-19T06:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30146",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30146#issuecomment-593284",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                       |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------|
|[c9c7b63](https://github.com/sagemath/sagetrac-mirror/commit/c9c7b63f1ed9fda028044385920f2b7849cfbd2b)|`missed preceeding `sage:` of doctests`|



---

archive/issue_comments_593285.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-22T07:35:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30146",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30146#issuecomment-593285",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_593286.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Matthias Koeppe\"",
    "created_at": "2020-07-22T07:35:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30146",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30146#issuecomment-593286",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "Matthias Koeppe"



---

archive/issue_comments_593287.json:
```json
{
    "body": "<a id='comment:8'></a>\nThank you.",
    "created_at": "2020-07-22T07:39:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30146",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30146#issuecomment-593287",
    "user": "https://github.com/kliem"
}
```

<a id='comment:8'></a>
Thank you.



---

archive/issue_events_087641.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-07-28T22:34:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30146",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30146#event-87641"
}
```



---

archive/issue_comments_593288.json:
```json
{
    "body": "Changing branch from \"public/30146\" to \"c9c7b63f1ed9fda028044385920f2b7849cfbd2b\"",
    "created_at": "2020-07-28T22:34:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30146",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30146#issuecomment-593288",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/30146" to "c9c7b63f1ed9fda028044385920f2b7849cfbd2b"



---

archive/issue_comments_593289.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-28T22:34:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30146",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30146#issuecomment-593289",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
