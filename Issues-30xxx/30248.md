# Issue 30248: Normaliz backend is broken with double description input

archive/issues_030011.json:
```json
{
    "body": "This bug was found while manipulating hyperplane arrangements.\n\nA minimal example to reproduce the bug is:\n\n```\nsage: p1 = Polyhedron(backend='normaliz', base_ring=AA, rays=[(AA(0), AA(0), AA(1)), (AA(0), AA(1), AA(-1)), (AA(1), AA(0), AA(-1))], vertices=[(AA(0), AA(0), AA(0))])\nsage: p1\nA 3-dimensional polyhedron in AA^3 defined as the convex hull of 1 vertex and 3 rays\nsage: -p1\nA 3-dimensional polyhedron in AA^3 defined as the convex hull of 1 vertex and 3 lines\nsage: p2 = Polyhedron(backend='normaliz', base_ring=AA, rays=[(AA(-1), AA(0), AA(1)), (AA(-1), AA(1), AA(0)), (AA(0), AA(0), AA(-1))], vertices=[(AA(0), AA(0), AA(0))])\nsage: p2\nA 3-dimensional polyhedron in AA^3 defined as the convex hull of 1 vertex and 3 rays\nsage: -p2\nA 3-dimensional polyhedron in AA^3 defined as the convex hull of 1 vertex and 3 lines\n```\n\nLooking at `dilation` it seems that dilation is not the problem, it does the right thing, but the `parent.element_class` call messes things up.\n\nNotice that changing the base ring to `QQ` or `ZZ` or removing the `'normaliz'` backend, one does not get the error... This is nasty.\n\nIn the hyperplane arrangement, there are some rational regions, and some irrational regions...\n\nCC:  @kliem @laisrast @mkoeppe @tscrim\n\nKeywords: polytope, backend, normaliz, hyperplane, regions\n\nBranch/Commit: 83453fb76a747556812266da84afb98b64fc7eab\n\nReviewer: Travis Scrimshaw\n\nAuthor: Jean-Philippe Labb\u00e9\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30248\n\n",
    "closed_at": "2020-08-09T08:47:31Z",
    "created_at": "2020-07-29T14:17:26Z",
    "labels": [
        "component: geometry",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Normaliz backend is broken with double description input",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30248",
    "user": "https://github.com/jplab"
}
```
This bug was found while manipulating hyperplane arrangements.

A minimal example to reproduce the bug is:

```
sage: p1 = Polyhedron(backend='normaliz', base_ring=AA, rays=[(AA(0), AA(0), AA(1)), (AA(0), AA(1), AA(-1)), (AA(1), AA(0), AA(-1))], vertices=[(AA(0), AA(0), AA(0))])
sage: p1
A 3-dimensional polyhedron in AA^3 defined as the convex hull of 1 vertex and 3 rays
sage: -p1
A 3-dimensional polyhedron in AA^3 defined as the convex hull of 1 vertex and 3 lines
sage: p2 = Polyhedron(backend='normaliz', base_ring=AA, rays=[(AA(-1), AA(0), AA(1)), (AA(-1), AA(1), AA(0)), (AA(0), AA(0), AA(-1))], vertices=[(AA(0), AA(0), AA(0))])
sage: p2
A 3-dimensional polyhedron in AA^3 defined as the convex hull of 1 vertex and 3 rays
sage: -p2
A 3-dimensional polyhedron in AA^3 defined as the convex hull of 1 vertex and 3 lines
```

Looking at `dilation` it seems that dilation is not the problem, it does the right thing, but the `parent.element_class` call messes things up.

Notice that changing the base ring to `QQ` or `ZZ` or removing the `'normaliz'` backend, one does not get the error... This is nasty.

In the hyperplane arrangement, there are some rational regions, and some irrational regions...

CC:  @kliem @laisrast @mkoeppe @tscrim

Keywords: polytope, backend, normaliz, hyperplane, regions

Branch/Commit: 83453fb76a747556812266da84afb98b64fc7eab

Reviewer: Travis Scrimshaw

Author: Jean-Philippe Labbé

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/30248





---

archive/issue_comments_595244.json:
```json
{
    "body": "<a id='comment:1'></a>Notice that normaliz doesn't use precomputed double description yet (waiting for the package upgrade). I suspect intitialzing from inequaltities doesn't work correctly and there is an even simpler one line example for this.",
    "created_at": "2020-07-29T15:52:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30248#issuecomment-595244",
    "user": "https://github.com/kliem"
}
```

<a id='comment:1'></a>Notice that normaliz doesn't use precomputed double description yet (waiting for the package upgrade). I suspect intitialzing from inequaltities doesn't work correctly and there is an even simpler one line example for this.



---

archive/issue_comments_595245.json:
```json
{
    "body": "<a id='comment:2'></a>What might be causing it, is passing a generator for the inequalries (in this case you cannot get the error with the normal constructor).\n\nIf we iterate twice through it (only for number fields), the second time you obviosly don't get anything, which explains the three lines.\n\nOne solution may be to make a tuple out of the generators, once we decided what we dispose in `Polyhedron_base.__init__`. The main reason for the generators is that we do not want to generate something, which we dispose of a few lines later.",
    "created_at": "2020-07-29T16:11:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30248#issuecomment-595245",
    "user": "https://github.com/kliem"
}
```

<a id='comment:2'></a>What might be causing it, is passing a generator for the inequalries (in this case you cannot get the error with the normal constructor).

If we iterate twice through it (only for number fields), the second time you obviosly don't get anything, which explains the three lines.

One solution may be to make a tuple out of the generators, once we decided what we dispose in `Polyhedron_base.__init__`. The main reason for the generators is that we do not want to generate something, which we dispose of a few lines later.



---

archive/issue_comments_595246.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2020-07-29T17:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30248#issuecomment-595246",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_595247.json:
```json
{
    "body": "<a id='comment:4'></a>Found it.\n\nLine 858 and 859 in `backend_normaliz` in the method `_compute_nmz_data_lists_and_field`, which is called by `_init_H_representation`.\n\nThe fact that the base ring is enforced to be `AA` while the data is really in `QQ` is taken care of by these 2 lines (normaliz should be used and not Qnormaliz). But! Since dilation ships 2 maps for the Hreps, the `data_lists` are empty at that point!\n\nOuff! Ok, I think this shouldn't be too hard to fix.\n\n...this is a sign that this use-case was not really tested... It pops up when one wants to deal with lots of sorts of polyhedra and eventually need to fix a base ring (done in Hyperplane arrangements). Oiii.",
    "created_at": "2020-07-30T08:11:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30248#issuecomment-595247",
    "user": "https://github.com/jplab"
}
```

<a id='comment:4'></a>Found it.

Line 858 and 859 in `backend_normaliz` in the method `_compute_nmz_data_lists_and_field`, which is called by `_init_H_representation`.

The fact that the base ring is enforced to be `AA` while the data is really in `QQ` is taken care of by these 2 lines (normaliz should be used and not Qnormaliz). But! Since dilation ships 2 maps for the Hreps, the `data_lists` are empty at that point!

Ouff! Ok, I think this shouldn't be too hard to fix.

...this is a sign that this use-case was not really tested... It pops up when one wants to deal with lots of sorts of polyhedra and eventually need to fix a base ring (done in Hyperplane arrangements). Oiii.



---

archive/issue_comments_595248.json:
```json
{
    "body": "<a id='comment:5'></a>I implemented a few test suite methods already. If you run a test suite on your polyhedron, does it succeed?",
    "created_at": "2020-07-30T08:28:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30248#issuecomment-595248",
    "user": "https://github.com/kliem"
}
```

<a id='comment:5'></a>I implemented a few test suite methods already. If you run a test suite on your polyhedron, does it succeed?



---

archive/issue_comments_595249.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-07-30T09:07:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30248#issuecomment-595249",
    "user": "https://github.com/jplab"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_595250.json:
```json
{
    "body": "<a id='comment:6'></a>New commits:",
    "created_at": "2020-07-30T09:07:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30248#issuecomment-595250",
    "user": "https://github.com/jplab"
}
```

<a id='comment:6'></a>New commits:



---

archive/issue_comments_595251.json:
```json
{
    "body": "Changing commit from \"\" to \"83453fb76a747556812266da84afb98b64fc7eab\"",
    "created_at": "2020-07-30T09:07:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30248#issuecomment-595251",
    "user": "https://github.com/jplab"
}
```

Changing commit from "" to "83453fb76a747556812266da84afb98b64fc7eab"



---

archive/issue_comments_595252.json:
```json
{
    "body": "Changing branch from \"\" to \"public/30248\"",
    "created_at": "2020-07-30T09:07:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30248#issuecomment-595252",
    "user": "https://github.com/jplab"
}
```

Changing branch from "" to "public/30248"



---

archive/issue_comments_595253.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [gh-kliem](#comment%3A5):\n> I implemented a few test suite methods already. If you run a test suite on your polyhedron, does it succeed?\n\n\nYes. It seems so.",
    "created_at": "2020-07-30T09:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30248#issuecomment-595253",
    "user": "https://github.com/jplab"
}
```

<a id='comment:7'></a>Replying to [gh-kliem](#comment%3A5):
> I implemented a few test suite methods already. If you run a test suite on your polyhedron, does it succeed?


Yes. It seems so.



---

archive/issue_comments_595254.json:
```json
{
    "body": "Changing author from \"\" to \"Jean-Philippe Labb\u00e9\"",
    "created_at": "2020-07-30T09:17:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30248#issuecomment-595254",
    "user": "https://github.com/jplab"
}
```

Changing author from "" to "Jean-Philippe Labbé"



---

archive/issue_comments_595255.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [jipilab](#comment%3A7):\n> Replying to [gh-kliem](#comment%3A5):\n> > I implemented a few test suite methods already. If you run a test suite on your polyhedron, does it succeed?\n\n> \n> Yes. It seems so.\n\n\nOK. Then this is a friendly reminder to go on with it.",
    "created_at": "2020-07-30T09:43:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30248#issuecomment-595255",
    "user": "https://github.com/kliem"
}
```

<a id='comment:9'></a>Replying to [jipilab](#comment%3A7):
> Replying to [gh-kliem](#comment%3A5):
> > I implemented a few test suite methods already. If you run a test suite on your polyhedron, does it succeed?

> 
> Yes. It seems so.


OK. Then this is a friendly reminder to go on with it.



---

archive/issue_comments_595256.json:
```json
{
    "body": "<a id='comment:10'></a>Ping! I think it would be important to have this ticket in the next release...",
    "created_at": "2020-08-05T09:07:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30248#issuecomment-595256",
    "user": "https://github.com/jplab"
}
```

<a id='comment:10'></a>Ping! I think it would be important to have this ticket in the next release...



---

archive/issue_comments_595257.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-05T11:07:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30248#issuecomment-595257",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_595258.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Travis Scrimshaw\"",
    "created_at": "2020-08-05T11:07:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30248#issuecomment-595258",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "" to "Travis Scrimshaw"



---

archive/issue_comments_595259.json:
```json
{
    "body": "<a id='comment:11'></a>LGTM.",
    "created_at": "2020-08-05T11:07:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30248#issuecomment-595259",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:11'></a>LGTM.



---

archive/issue_comments_595260.json:
```json
{
    "body": "Changing branch from \"public/30248\" to \"83453fb76a747556812266da84afb98b64fc7eab\"",
    "created_at": "2020-08-09T08:47:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30248#issuecomment-595260",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/30248" to "83453fb76a747556812266da84afb98b64fc7eab"



---

archive/issue_events_078224.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-08-09T08:47:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30248",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30248#event-78224"
}
```



---

archive/issue_comments_595261.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-08-09T08:47:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30248#issuecomment-595261",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
