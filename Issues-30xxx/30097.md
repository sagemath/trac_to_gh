# Issue 30097: Second instance of MaximaLib

archive/issues_029860.json:
```json
{
    "body": "Maxima essentially just uses a single Common Lisp package `:MAXIMA`.\n\nAfter loading Maxima into ECL at the beginning of `sage.interfaces.maxima_lib`, we just rename the package `:MAXIMA` to `:MAXIMA_LIB` and remove maxima from `*MODULES*`. \n\nBecause `maxima_lib.py` is written in a style using lots of global variables, we duplicate this module using a symlink.  (This can be improved in a follow-up ticket.)\nImporting `sage.interfaces.maxima_lib_2` loads another copy of Maxima using `REQUIRE`, and renames the package `:MAXIMA` to `:MAXIMA_LIB_2`.\n\nThe global name `maxima` is now imported from `sage.interfaces.maxima_lib_2` instead of `sage.interfaces.maxima`, so it uses the 2nd copy of the maxima library interface.\n\nThe two copies of maxima are isolated from each other::\n\n```\nsage: maxima(\"xyz: 123\")\n123\nsage: maxima_calculus(\"xyz\")\nxyz\nsage: maxima(\"xyz\")\n123\n```\n\nThe global name `Maxima` still refers to the pexpect interface class.\n\nDetails:\n\nWe make `:COMMON-LISP-USER` the default package. During `maxima_eval`, we bind `*PACKAGE*` to the correct package object. We replace the use of the `#$` read macro by a direct use of `MREAD` (while binding `*PACKAGE`). During `$LOAD`, we temporarily set up a package nickname `:MAXIMA` so that the loaded Lisp files can do `(IN-PACKAGE :MAXIMA)`. \n\n\n\nCC:  @dimpase @nbruin jpflori @EmmanuelCharpentier\n\nAuthor: Matthias Koeppe\n\nBranch: u/mkoeppe/several_instances_of_maximalib\n\nStatus: needs_work\n\nDependencies: #30105\n\nCommit: a3b58ad46c77173591e3151a860b2bde53e11c91\n\nIssue created by migration from https://trac.sagemath.org/ticket/30097\n\n",
    "created_at": "2020-07-09T03:08:25Z",
    "labels": [
        "component: interfaces"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Second instance of MaximaLib",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30097",
    "user": "https://github.com/mkoeppe"
}
```
Maxima essentially just uses a single Common Lisp package `:MAXIMA`.

After loading Maxima into ECL at the beginning of `sage.interfaces.maxima_lib`, we just rename the package `:MAXIMA` to `:MAXIMA_LIB` and remove maxima from `*MODULES*`. 

Because `maxima_lib.py` is written in a style using lots of global variables, we duplicate this module using a symlink.  (This can be improved in a follow-up ticket.)
Importing `sage.interfaces.maxima_lib_2` loads another copy of Maxima using `REQUIRE`, and renames the package `:MAXIMA` to `:MAXIMA_LIB_2`.

The global name `maxima` is now imported from `sage.interfaces.maxima_lib_2` instead of `sage.interfaces.maxima`, so it uses the 2nd copy of the maxima library interface.

The two copies of maxima are isolated from each other::

```
sage: maxima("xyz: 123")
123
sage: maxima_calculus("xyz")
xyz
sage: maxima("xyz")
123
```

The global name `Maxima` still refers to the pexpect interface class.

Details:

We make `:COMMON-LISP-USER` the default package. During `maxima_eval`, we bind `*PACKAGE*` to the correct package object. We replace the use of the `#$` read macro by a direct use of `MREAD` (while binding `*PACKAGE`). During `$LOAD`, we temporarily set up a package nickname `:MAXIMA` so that the loaded Lisp files can do `(IN-PACKAGE :MAXIMA)`. 



CC:  @dimpase @nbruin jpflori @EmmanuelCharpentier

Author: Matthias Koeppe

Branch: u/mkoeppe/several_instances_of_maximalib

Status: needs_work

Dependencies: #30105

Commit: a3b58ad46c77173591e3151a860b2bde53e11c91

Issue created by migration from https://trac.sagemath.org/ticket/30097





---

archive/issue_comments_452209.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -24,6 +24,13 @@\n # loaded another copy!\n \\`\\`\\`\n \n+In \\`maxima_eval\\`, we bind \\`*PACKAGE*\\` to the correct package object. We replace the use of the \\`#$\\` read macro by a direct use of \\`MACSYMA-READ-STRING\\` (from the correct package).\n+\n+Because \\`maxima_lib.py\\` is written in a style using lots of global variables, we duplicate this module using a symlink.  This can be improved in a follow-up ticket.\n+\n+\n+\n+\n Comment: 1\n \n Summary: Several instances of MaximaLib\n```\n",
    "created_at": "2020-07-09T04:47:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452209",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -24,6 +24,13 @@
 # loaded another copy!
 \`\`\`
 
+In \`maxima_eval\`, we bind \`*PACKAGE*\` to the correct package object. We replace the use of the \`#$\` read macro by a direct use of \`MACSYMA-READ-STRING\` (from the correct package).
+
+Because \`maxima_lib.py\` is written in a style using lots of global variables, we duplicate this module using a symlink.  This can be improved in a follow-up ticket.
+
+
+
+
 Comment: 1
 
 Summary: Several instances of MaximaLib
```




---

archive/issue_comments_452210.json:
```json
{
    "body": "<a id='comment:3'></a>New commits:",
    "created_at": "2020-07-09T06:00:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452210",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>New commits:



---

archive/issue_comments_452211.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-09T06:51:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452211",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452212.json:
```json
{
    "body": "<a id='comment:5'></a>Unfinished, setting it to needs-review so that the patchbot runs",
    "created_at": "2020-07-09T06:55:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452212",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>Unfinished, setting it to needs-review so that the patchbot runs



---

archive/issue_comments_452213.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-07-09T06:55:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452213",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_452214.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-09T07:55:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452214",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452215.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-09T08:10:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452215",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452216.json:
```json
{
    "body": "<a id='comment:8'></a>More work to be done, but some preliminary testing makes sense",
    "created_at": "2020-07-09T08:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452216",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>More work to be done, but some preliminary testing makes sense



---

archive/issue_comments_452217.json:
```json
{
    "body": "<a id='comment:9'></a>Are you planning to use this to switch SR to maxima_lib ?",
    "created_at": "2020-07-09T13:40:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452217",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>Are you planning to use this to switch SR to maxima_lib ?



---

archive/issue_comments_452218.json:
```json
{
    "body": "<a id='comment:10'></a>`SR` is already using maxima_lib.",
    "created_at": "2020-07-09T14:03:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452218",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>`SR` is already using maxima_lib.



---

archive/issue_comments_452219.json:
```json
{
    "body": "<a id='comment:11'></a>I hope to switch the remaining uses of maxima, mostly in doctests, to the second copy of `maxima_lib` when this ticket is ready, so that we can retire maxima_pexpect.",
    "created_at": "2020-07-09T14:05:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452219",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>I hope to switch the remaining uses of maxima, mostly in doctests, to the second copy of `maxima_lib` when this ticket is ready, so that we can retire maxima_pexpect.



---

archive/issue_comments_452220.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-09T14:36:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452220",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452221.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-09T14:57:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452221",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452222.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,25 @@\n+Maxima essentially just uses a single Common Lisp package \\`:MAXIMA\\`.\n+\n+After loading Maxima, we just rename the package and remove maxima from \\`*MODULES*\\` Then we can load another copy.\n+\n+Because \\`maxima_lib.py\\` is written in a style using lots of global variables, we duplicate this module using a symlink.  (This can be improved in a follow-up ticket.)\n+\n+The global name \\`maxima\\` is now imported from \\`sage.interfaces.maxima_lib_2\\` (the second copy, which operates in the Common Lisp package \\`MAXIMA_LIB_2\\`.\n+\n+The two copies of maxima are isolated from each other::\n+\n+\\`\\`\\`\n+sage: maxima(\"xyz: 123\")\n+123\n+sage: maxima_calculus(\"xyz\")\n+xyz\n+sage: maxima(\"xyz\")\n+123\n+\n+In \\`maxima_eval\\`, we bind \\`*PACKAGE*\\` to the correct package object. We replace the use of the \\`#$\\` read macro by a direct use of \\`MACSYMA-READ-STRING\\` (from the correct package).\n+\n+\n+\n \n \n Comment: 1\n```\n",
    "created_at": "2020-07-09T14:57:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452222",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,25 @@
+Maxima essentially just uses a single Common Lisp package \`:MAXIMA\`.
+
+After loading Maxima, we just rename the package and remove maxima from \`*MODULES*\` Then we can load another copy.
+
+Because \`maxima_lib.py\` is written in a style using lots of global variables, we duplicate this module using a symlink.  (This can be improved in a follow-up ticket.)
+
+The global name \`maxima\` is now imported from \`sage.interfaces.maxima_lib_2\` (the second copy, which operates in the Common Lisp package \`MAXIMA_LIB_2\`.
+
+The two copies of maxima are isolated from each other::
+
+\`\`\`
+sage: maxima("xyz: 123")
+123
+sage: maxima_calculus("xyz")
+xyz
+sage: maxima("xyz")
+123
+
+In \`maxima_eval\`, we bind \`*PACKAGE*\` to the correct package object. We replace the use of the \`#$\` read macro by a direct use of \`MACSYMA-READ-STRING\` (from the correct package).
+
+
+
 
 
 Comment: 1
```




---

archive/issue_comments_452223.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,29 @@\n+Maxima essentially just uses a single Common Lisp package \\`:MAXIMA\\`.\n+\n+After loading Maxima into ECL at the beginning of \\`sage.interfaces.maxima_lib\\`, we just rename the package \\`:MAXIMA\\` to \\`:MAXIMA_LIB\\` and remove maxima from \\`*MODULES*\\`. \n+\n+Because \\`maxima_lib.py\\` is written in a style using lots of global variables, we duplicate this module using a symlink.  (This can be improved in a follow-up ticket.)\n+Importing \\`sage.interfaces.maxima_lib_2\\` loads another copy of Maxima using \\`REQUIRE\\`, and renames the package \\`:MAXIMA\\` to \\`:MAXIMA_LIB_2\\`.\n+\n+The global name \\`maxima\\` is now imported from \\`sage.interfaces.maxima_lib_2\\` instead of \\`sage.interfaces.maxima\\`, so it uses the 2nd copy of the maxima library interface.\n+\n+The two copies of maxima are isolated from each other::\n+\n+\\`\\`\\`\n+sage: maxima(\"xyz: 123\")\n+123\n+sage: maxima_calculus(\"xyz\")\n+xyz\n+sage: maxima(\"xyz\")\n+123\n+\\`\\`\\`\n+\n+The global name \\`Maxima\\` still refers to the pexpect interface class.\n+\n+Details:\n+\n+We make \\`:COMMON-LISP-USER\\` the default package. During \\`maxima_eval\\`, we bind \\`*PACKAGE*\\` to the correct package object. We replace the use of the \\`#$\\` read macro by a direct use of \\`MREAD\\` (while binding \\`*PACKAGE\\`). During \\`$LOAD\\`, we temporarily set up a package nickname \\`:MAXIMA\\` so that the loaded Lisp files can do \\`(IN-PACKAGE :MAXIMA)\\`. \n+\n \n \n Comment: 1\n```\n",
    "created_at": "2020-07-09T15:09:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452223",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,29 @@
+Maxima essentially just uses a single Common Lisp package \`:MAXIMA\`.
+
+After loading Maxima into ECL at the beginning of \`sage.interfaces.maxima_lib\`, we just rename the package \`:MAXIMA\` to \`:MAXIMA_LIB\` and remove maxima from \`*MODULES*\`. 
+
+Because \`maxima_lib.py\` is written in a style using lots of global variables, we duplicate this module using a symlink.  (This can be improved in a follow-up ticket.)
+Importing \`sage.interfaces.maxima_lib_2\` loads another copy of Maxima using \`REQUIRE\`, and renames the package \`:MAXIMA\` to \`:MAXIMA_LIB_2\`.
+
+The global name \`maxima\` is now imported from \`sage.interfaces.maxima_lib_2\` instead of \`sage.interfaces.maxima\`, so it uses the 2nd copy of the maxima library interface.
+
+The two copies of maxima are isolated from each other::
+
+\`\`\`
+sage: maxima("xyz: 123")
+123
+sage: maxima_calculus("xyz")
+xyz
+sage: maxima("xyz")
+123
+\`\`\`
+
+The global name \`Maxima\` still refers to the pexpect interface class.
+
+Details:
+
+We make \`:COMMON-LISP-USER\` the default package. During \`maxima_eval\`, we bind \`*PACKAGE*\` to the correct package object. We replace the use of the \`#$\` read macro by a direct use of \`MREAD\` (while binding \`*PACKAGE\`). During \`$LOAD\`, we temporarily set up a package nickname \`:MAXIMA\` so that the loaded Lisp files can do \`(IN-PACKAGE :MAXIMA)\`. 
+
 
 
 Comment: 1
```




---

archive/issue_comments_452224.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-09T15:10:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452224",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452225.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-09T15:32:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452225",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452226.json:
```json
{
    "body": "<a id='comment:19'></a>Ready for testing/review",
    "created_at": "2020-07-09T15:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452226",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'></a>Ready for testing/review



---

archive/issue_comments_452227.json:
```json
{
    "body": "<a id='comment:20'></a>Some details still need to be fixed: \n- When ECL objects are passed to an interface object, it needs to be checked that it is for the correct copy of the package. \n- The doctests do not really test the second copy\n- Some doctests fail because things now print with their package:\n\n```\nFile \"src/sage/interfaces/maxima_lib_2.py\", line 1509, in sage.interfaces.maxima_lib_2.dummy_integrate\nFailed example:\n    f.ecl()\nExpected:\n    <ECL: ((%INTEGRATE SIMP) (($F SIMP) $X) $X)>\nGot:\n    <ECL: ((MAXIMA_LIB::%INTEGRATE MAXIMA_LIB::SIMP)\n     ((MAXIMA_LIB::$F MAXIMA_LIB::SIMP) MAXIMA_LIB::$X) MAXIMA_LIB::$X)>\n```",
    "created_at": "2020-07-09T18:15:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452227",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>Some details still need to be fixed: 
- When ECL objects are passed to an interface object, it needs to be checked that it is for the correct copy of the package. 
- The doctests do not really test the second copy
- Some doctests fail because things now print with their package:

```
File "src/sage/interfaces/maxima_lib_2.py", line 1509, in sage.interfaces.maxima_lib_2.dummy_integrate
Failed example:
    f.ecl()
Expected:
    <ECL: ((%INTEGRATE SIMP) (($F SIMP) $X) $X)>
Got:
    <ECL: ((MAXIMA_LIB::%INTEGRATE MAXIMA_LIB::SIMP)
     ((MAXIMA_LIB::$F MAXIMA_LIB::SIMP) MAXIMA_LIB::$X) MAXIMA_LIB::$X)>
```



---

archive/issue_comments_452228.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-09T19:51:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452228",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452229.json:
```json
{
    "body": "<a id='comment:22'></a>It's nice you can do it, but do we need it? I suspect that the remaining uses of the maxima interface in library code don't actually need to be isolated from the calculus instance.\n\nIf you do think it's worth supporting multiple instances of maxima_lib interfaces, then I think it shouldn't be hardcoded at only 2 copies. I think it's possible (with some hackery) to have multiple instances of the same module in python:\n\nhttps://stackoverflow.com/questions/11170949/how-to-make-a-copy-of-a-python-module-at-runtime\n\nthe trick would now be to somehow parametrize the name of the corresponding package in ecl, but that should be quite solvable (if all else fails, we could park a global counter somewhere outside the maxima_lib package -- for instance in ECL if all else fails -- that it can use to see how many copies already exist)\n\nA thing to be careful about it that in CL, at least for the REPL, there is global state as to what the \"current package\" is. I'm not 100% sure that this isn't somewhere relied upon for maxima.\n\n---\n\nIf we're going down this route, you probably want reconsider the placement of some of the initialization code too. I think there might be some things in maxima_lib that prime it towards  \"calculus\" use. Having a \"vanilla\" maxima_lib interface would be one of the uses I could see.",
    "created_at": "2020-07-09T20:29:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452229",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:22'></a>It's nice you can do it, but do we need it? I suspect that the remaining uses of the maxima interface in library code don't actually need to be isolated from the calculus instance.

If you do think it's worth supporting multiple instances of maxima_lib interfaces, then I think it shouldn't be hardcoded at only 2 copies. I think it's possible (with some hackery) to have multiple instances of the same module in python:

https://stackoverflow.com/questions/11170949/how-to-make-a-copy-of-a-python-module-at-runtime

the trick would now be to somehow parametrize the name of the corresponding package in ecl, but that should be quite solvable (if all else fails, we could park a global counter somewhere outside the maxima_lib package -- for instance in ECL if all else fails -- that it can use to see how many copies already exist)

A thing to be careful about it that in CL, at least for the REPL, there is global state as to what the "current package" is. I'm not 100% sure that this isn't somewhere relied upon for maxima.

---

If we're going down this route, you probably want reconsider the placement of some of the initialization code too. I think there might be some things in maxima_lib that prime it towards  "calculus" use. Having a "vanilla" maxima_lib interface would be one of the uses I could see.



---

archive/issue_comments_452230.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:22 nbruin]:\n> It's nice you can do it, but do we need it? I suspect that the remaining uses of the maxima interface in library code don't actually need to be isolated from the calculus instance.\n\n\nThat's a good point and certainly worth checking; I hope we can find and change such uses as part of #30071.\n\nBut there are lots of uses of maxima in doctests too.  If we switch these ones over to `maxima_calculus`, this might be advertising potentially unsafe uses to users. \n\nAnd the doctests are what have prompted this ticket -- we currently have problems with the Maxima pexpect on Cygwin on #22191 (update ECL to 20.4.24).\n\nLet's have this discussion -- on concrete uses of maxima -- on #30071.",
    "created_at": "2020-07-09T21:31:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452230",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:23'></a>Replying to [comment:22 nbruin]:
> It's nice you can do it, but do we need it? I suspect that the remaining uses of the maxima interface in library code don't actually need to be isolated from the calculus instance.


That's a good point and certainly worth checking; I hope we can find and change such uses as part of #30071.

But there are lots of uses of maxima in doctests too.  If we switch these ones over to `maxima_calculus`, this might be advertising potentially unsafe uses to users. 

And the doctests are what have prompted this ticket -- we currently have problems with the Maxima pexpect on Cygwin on #22191 (update ECL to 20.4.24).

Let's have this discussion -- on concrete uses of maxima -- on #30071.



---

archive/issue_comments_452231.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:22 nbruin]:\n> If you do think it's worth supporting multiple instances of maxima_lib interfaces, then I think it shouldn't be hardcoded at only 2 copies. I think it's possible (with some hackery) to have multiple instances of the same module in python:\n> \n> https://stackoverflow.com/questions/11170949/how-to-make-a-copy-of-a-python-module-at-runtime\n\n\nInstead of doing this, I think it would be better to rewrite the Python module so that the module globals are placed in the interface object instead. Trivial to do, but a huge patch, which is why I haven't done this on this ticket.\n\n> A thing to be careful about it that in CL, at least for the REPL, there is global state as to what the \"current package\" is. I'm not 100% sure that this isn't somewhere relied upon for maxima.\n\n\nYes, my current code is taking care of this already. There are just some minor details remaining.",
    "created_at": "2020-07-09T21:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452231",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>Replying to [comment:22 nbruin]:
> If you do think it's worth supporting multiple instances of maxima_lib interfaces, then I think it shouldn't be hardcoded at only 2 copies. I think it's possible (with some hackery) to have multiple instances of the same module in python:
> 
> https://stackoverflow.com/questions/11170949/how-to-make-a-copy-of-a-python-module-at-runtime


Instead of doing this, I think it would be better to rewrite the Python module so that the module globals are placed in the interface object instead. Trivial to do, but a huge patch, which is why I haven't done this on this ticket.

> A thing to be careful about it that in CL, at least for the REPL, there is global state as to what the "current package" is. I'm not 100% sure that this isn't somewhere relied upon for maxima.


Yes, my current code is taking care of this already. There are just some minor details remaining.



---

archive/issue_comments_452232.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-10T05:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452232",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452233.json:
```json
{
    "body": "<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-10T21:51:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452233",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452234.json:
```json
{
    "body": "<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2020-07-11T19:51:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452234",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_452235.json:
```json
{
    "body": "<a id='comment:29'></a>there are things like\n\n```\nsage -t --long --warn-long 177.3 src/doc/en/constructions/plotting.rst\n**********************************************************************\nFile \"src/doc/en/constructions/plotting.rst\", line 216, in doc.en.constructions.plotting\nFailed example:\n    maxima.eval('load(\"plotdf\");')\nExpected:\n    '\".../share/maxima/.../share/dynamics/plotdf.lisp\"'\nGot:\n    '\\\\\"/home/scratch2/dimpase/sage/sage/local/share/maxima/5.42.2/share/dynamics/plotdf.lisp\\\\\"'\n**********************************************************************\n```\nand LISP errors such as\n\n```\nFile \"src/sage/symbolic/expression.pyx\", line 12389, in sage.symbolic.expression.Expression.integral\nFailed example:\n    sin(x).integral(x)\nException raised:\n    Traceback (most recent call last):\n      File \"/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/doctest/forker.py\", line 707, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/doctest/forker.py\", line 1131, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.symbolic.expression.Expression.integral[1]>\", line 1, in <module>\n        sin(x).integral(x)\n      File \"sage/symbolic/expression.pyx\", line 12437, in sage.symbolic.expression.Expression.integral (build/cythonized/sage/symbolic/expression.cpp:64526)\n        return integral(self, *args, **kwds)\n      File \"/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/symbolic/integration/integral.py\", line 963, in integrate\n        return indefinite_integral(expression, v, hold=hold)\n      File \"sage/symbolic/function.pyx\", line 1138, in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:12274)\n        res = super(BuiltinFunction, self).__call__(\n      File \"sage/symbolic/function.pyx\", line 602, in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.cpp:7051)\n        res = g_function_eval2(self._serial, (<Expression>args[0])._gobj,\n      File \"/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/symbolic/integration/integral.py\", line 117, in _eval_\n        A = integrator(f, x)\n      File \"/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/symbolic/integration/external.py\", line 44, in maxima_integrator\n        result = maxima.sr_integral(expression,v)\n      File \"/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/interfaces/maxima_lib.py\", line 877, in sr_integral\n        return max_to_sr(maxima_eval(([max_integrate],[sr_to_max(SR(a)) for a in args])))\n      File \"/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/interfaces/maxima_lib.py\", line 1763, in max_to_sr\n        sage_expr=SR(maxima(expr))\n      File \"/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/interfaces/interface.py\", line 303, in __call__\n        result = self._coerce_from_special_method(x)\n      File \"/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/interfaces/maxima_lib.py\", line 472, in _coerce_from_special_method\n        return MaximaLibElement(self,self._create(x))\n      File \"/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/interfaces/maxima_lib.py\", line 690, in _create\n        maxima_eval([[msetq], maxima_read(name), value])\n      File \"sage/libs/ecl.pyx\", line 852, in sage.libs.ecl.EclObject.__call__ (build/cythonized/sage/libs/ecl.c:8507)\n        return ecl_wrap(ecl_safe_apply(self.obj,(<EclObject>lispargs).obj))\n      File \"sage/libs/ecl.pyx\", line 365, in sage.libs.ecl.ecl_safe_apply (build/cythonized/sage/libs/ecl.c:5835)\n        raise RuntimeError(\"ECL says: {}\".format(\n    RuntimeError: ECL says: In form\n    ((MAXIMA_LIB_2::%COS MAXIMA_LIB_2::SIMP) MAXIMA_LIB::|$_SAGE_VAR_x|)\n    FUNCTION: Not a valid argument (MAXIMA_LIB_2::%COS MAXIMA_LIB_2::SIMP).\n```",
    "created_at": "2020-07-18T12:04:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452235",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:29'></a>there are things like

```
sage -t --long --warn-long 177.3 src/doc/en/constructions/plotting.rst
**********************************************************************
File "src/doc/en/constructions/plotting.rst", line 216, in doc.en.constructions.plotting
Failed example:
    maxima.eval('load("plotdf");')
Expected:
    '".../share/maxima/.../share/dynamics/plotdf.lisp"'
Got:
    '\\"/home/scratch2/dimpase/sage/sage/local/share/maxima/5.42.2/share/dynamics/plotdf.lisp\\"'
**********************************************************************
```
and LISP errors such as

```
File "src/sage/symbolic/expression.pyx", line 12389, in sage.symbolic.expression.Expression.integral
Failed example:
    sin(x).integral(x)
Exception raised:
    Traceback (most recent call last):
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/doctest/forker.py", line 707, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/doctest/forker.py", line 1131, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.symbolic.expression.Expression.integral[1]>", line 1, in <module>
        sin(x).integral(x)
      File "sage/symbolic/expression.pyx", line 12437, in sage.symbolic.expression.Expression.integral (build/cythonized/sage/symbolic/expression.cpp:64526)
        return integral(self, *args, **kwds)
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/symbolic/integration/integral.py", line 963, in integrate
        return indefinite_integral(expression, v, hold=hold)
      File "sage/symbolic/function.pyx", line 1138, in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:12274)
        res = super(BuiltinFunction, self).__call__(
      File "sage/symbolic/function.pyx", line 602, in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.cpp:7051)
        res = g_function_eval2(self._serial, (<Expression>args[0])._gobj,
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/symbolic/integration/integral.py", line 117, in _eval_
        A = integrator(f, x)
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/symbolic/integration/external.py", line 44, in maxima_integrator
        result = maxima.sr_integral(expression,v)
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/interfaces/maxima_lib.py", line 877, in sr_integral
        return max_to_sr(maxima_eval(([max_integrate],[sr_to_max(SR(a)) for a in args])))
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/interfaces/maxima_lib.py", line 1763, in max_to_sr
        sage_expr=SR(maxima(expr))
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/interfaces/interface.py", line 303, in __call__
        result = self._coerce_from_special_method(x)
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/interfaces/maxima_lib.py", line 472, in _coerce_from_special_method
        return MaximaLibElement(self,self._create(x))
      File "/home/scratch2/dimpase/sage/sage/local/lib64/python3.7/site-packages/sage/interfaces/maxima_lib.py", line 690, in _create
        maxima_eval([[msetq], maxima_read(name), value])
      File "sage/libs/ecl.pyx", line 852, in sage.libs.ecl.EclObject.__call__ (build/cythonized/sage/libs/ecl.c:8507)
        return ecl_wrap(ecl_safe_apply(self.obj,(<EclObject>lispargs).obj))
      File "sage/libs/ecl.pyx", line 365, in sage.libs.ecl.ecl_safe_apply (build/cythonized/sage/libs/ecl.c:5835)
        raise RuntimeError("ECL says: {}".format(
    RuntimeError: ECL says: In form
    ((MAXIMA_LIB_2::%COS MAXIMA_LIB_2::SIMP) MAXIMA_LIB::|$_SAGE_VAR_x|)
    FUNCTION: Not a valid argument (MAXIMA_LIB_2::%COS MAXIMA_LIB_2::SIMP).
```



---

archive/issue_comments_452236.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-07-18T16:38:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452236",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_events_077507.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-05T19:21:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30097#event-77507"
}
```



---

archive/issue_comments_452237.json:
```json
{
    "body": "<a id='comment:32'></a>Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452237",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:32'></a>Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_events_077508.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30097#event-77508"
}
```



---

archive/issue_events_077509.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30097#event-77509"
}
```



---

archive/issue_comments_452238.json:
```json
{
    "body": "<a id='comment:34'></a>Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30097#issuecomment-452238",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:34'></a>Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_events_077510.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30097#event-77510"
}
```



---

archive/issue_events_077511.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30097#event-77511"
}
```



---

archive/issue_events_077512.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30097#event-77512"
}
```



---

archive/issue_events_077513.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-12-14T02:04:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30097#event-77513"
}
```



---

archive/issue_events_077514.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T00:06:20Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30097#event-77514"
}
```



---

archive/issue_events_077515.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T00:06:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30097#event-77515"
}
```



---

archive/issue_events_077516.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30097#event-77516"
}
```



---

archive/issue_events_077517.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30097",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30097#event-77517"
}
```
