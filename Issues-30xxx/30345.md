# Issue 30345: build/make/Makefile.in: Filter out "-j" from sub-make invocations to avoid excessive parallel load

archive/issues_030108.json:
```json
{
    "body": "Fixup from #30153, where recursive invocations of `$(MAKE)` for `SPKG-no-deps` targets were added.\n\nThe recursive invocation of $(MAKE) seems to lead to builds with extremely high parallel load when `MAKE=\"make -j8\"` as recommended in Sage build documentation. This may be part of why lately many builds on GH Actions are failing.\n\n\n\nCC:  @orlitzky @kliem @jhpalmieri\n\nBranch/Commit: 701b4ceec489024aa76617a276cf7a9cec4adeb3\n\nReviewer: Dima Pasechnik\n\nAuthor: Matthias Koeppe\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30345\n\n",
    "closed_at": "2020-08-16T22:33:23Z",
    "created_at": "2020-08-13T01:11:07Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "build/make/Makefile.in: Filter out \"-j\" from sub-make invocations to avoid excessive parallel load",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30345",
    "user": "https://github.com/mkoeppe"
}
```
Fixup from #30153, where recursive invocations of `$(MAKE)` for `SPKG-no-deps` targets were added.

The recursive invocation of $(MAKE) seems to lead to builds with extremely high parallel load when `MAKE="make -j8"` as recommended in Sage build documentation. This may be part of why lately many builds on GH Actions are failing.



CC:  @orlitzky @kliem @jhpalmieri

Branch/Commit: 701b4ceec489024aa76617a276cf7a9cec4adeb3

Reviewer: Dima Pasechnik

Author: Matthias Koeppe

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/30345





---

archive/issue_comments_456481.json:
```json
{
    "body": "<a id='comment:1'></a>Example, from https://github.com/mkoeppe/sage/runs/977866778:\n\n```\nmake[1]: Entering directory '/sage/build/make'\nmake -j8 yasm-no-deps\nmake -j8 gf2x-no-deps\nmake -j8 boost_cropped-no-deps\nmake -j8 zlib-no-deps\nmake -j8 xz-no-deps\nmake -j8 ncurses-no-deps\nmake -j8 bzip2-no-deps\nmake -j8 libffi-no-deps\nmake[2]: Entering directory '/sage/build/make'\nmake[2]: warning: -jN forced in submake: disabling jobserver mode.\nmake[2]: Entering directory '/sage/build/make'\nmake[2]: Entering directory '/sage/build/make'\nmake[2]: warning: -jN forced in submake: disabling jobserver mode.\nmake[2]: Entering directory '/sage/build/make'\nmake[2]: warning: -jN forced in submake: disabling jobserver mode.\nmake[2]: Entering directory '/sage/build/make'\nmake[2]: warning: -jN forced in submake: disabling jobserver mode.\nmake[2]: Entering directory '/sage/build/make'\nmake[2]: warning: -jN forced in submake: disabling jobserver mode.\nmake[2]: warning: -jN forced in submake: disabling jobserver mode.\nmake[2]: Entering directory '/sage/build/make'\nmake[2]: warning: -jN forced in submake: disabling jobserver mode.\n```\nLooks like 64 parallel jobs to me...",
    "created_at": "2020-08-13T01:12:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30345#issuecomment-456481",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>Example, from https://github.com/mkoeppe/sage/runs/977866778:

```
make[1]: Entering directory '/sage/build/make'
make -j8 yasm-no-deps
make -j8 gf2x-no-deps
make -j8 boost_cropped-no-deps
make -j8 zlib-no-deps
make -j8 xz-no-deps
make -j8 ncurses-no-deps
make -j8 bzip2-no-deps
make -j8 libffi-no-deps
make[2]: Entering directory '/sage/build/make'
make[2]: warning: -jN forced in submake: disabling jobserver mode.
make[2]: Entering directory '/sage/build/make'
make[2]: Entering directory '/sage/build/make'
make[2]: warning: -jN forced in submake: disabling jobserver mode.
make[2]: Entering directory '/sage/build/make'
make[2]: warning: -jN forced in submake: disabling jobserver mode.
make[2]: Entering directory '/sage/build/make'
make[2]: warning: -jN forced in submake: disabling jobserver mode.
make[2]: Entering directory '/sage/build/make'
make[2]: warning: -jN forced in submake: disabling jobserver mode.
make[2]: warning: -jN forced in submake: disabling jobserver mode.
make[2]: Entering directory '/sage/build/make'
make[2]: warning: -jN forced in submake: disabling jobserver mode.
```
Looks like 64 parallel jobs to me...



---

archive/issue_comments_456482.json:
```json
{
    "body": "<a id='comment:4'></a>New commits:",
    "created_at": "2020-08-13T01:45:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30345#issuecomment-456482",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>New commits:



---

archive/issue_comments_456483.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-08-13T01:45:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30345#issuecomment-456483",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_456484.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-08-13T05:38:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30345#issuecomment-456484",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_456485.json:
```json
{
    "body": "<a id='comment:5'></a>Now I see \n\n```\nmake --no-print-directory planarity-no-deps\nmake[2]: warning: jobserver unavailable: using -j1.  Add `+' to parent make rule.\nsage-logger -p 'SAGE_CHECK=warn sage-spkg -y -o   planarity-3.0.0.5.p0' \n```\ne.g. at https://github.com/mkoeppe/sage/runs/978617323",
    "created_at": "2020-08-13T05:38:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30345#issuecomment-456485",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>Now I see 

```
make --no-print-directory planarity-no-deps
make[2]: warning: jobserver unavailable: using -j1.  Add `+' to parent make rule.
sage-logger -p 'SAGE_CHECK=warn sage-spkg -y -o   planarity-3.0.0.5.p0' 
```
e.g. at https://github.com/mkoeppe/sage/runs/978617323



---

archive/issue_comments_456486.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-13T05:51:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30345#issuecomment-456486",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_456487.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-08-13T05:51:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30345#issuecomment-456487",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_456488.json:
```json
{
    "body": "<a id='comment:8'></a>what is the meaning of this syntax:\n\n```\nMAKE_REC = $(MAKE:-j%=)\n```\nin Makefile.in ?",
    "created_at": "2020-08-13T09:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30345#issuecomment-456488",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>what is the meaning of this syntax:

```
MAKE_REC = $(MAKE:-j%=)
```
in Makefile.in ?



---

archive/issue_comments_456489.json:
```json
{
    "body": "<a id='comment:9'></a>This is going to wind up doing the wrong thing in a lot of places but I'm not sure how to fix it. Using the top-level makefile as a convenient way to run high-level commands means that we have two different interpretations of the `-j` argument,\n\n1. How many high-level commands do you want to run at the same time?\n2. How many parallel build processes do you want to run when the high-level command being executed is to install a package?\n\nRight now we don't distinguish them. For example, I want to build each spkg with 4 threads, not try to build 4 spkgs at the same time. Maybe a new sage-specific variable like `SAGE_BUILD_JOBS` could be used to pass the right `-j` argument to sub-make while the top-level make would always be invoked with `-j1`. Just an idea.\n\nIn any case... can some of these recursive calls be eliminated? E.g. this one...\n\n```\n# The 2 preliminary build phases: base and toolchain.                           \nbase-toolchain: _clean-broken-gcc base\n        $(MAKE) toolchain\n```\n\ncan probably be eliminated by making `_clean-broken-gcc base` a prerequisite for `toolchain`. Then `base-toolchain` can simply depend on both, if it needs to be kept around at all. But we could probably make other stuff depend on `base toolchain` instead of `base-toolchain` afterwards.",
    "created_at": "2020-08-13T11:23:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30345#issuecomment-456489",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:9'></a>This is going to wind up doing the wrong thing in a lot of places but I'm not sure how to fix it. Using the top-level makefile as a convenient way to run high-level commands means that we have two different interpretations of the `-j` argument,

1. How many high-level commands do you want to run at the same time?
2. How many parallel build processes do you want to run when the high-level command being executed is to install a package?

Right now we don't distinguish them. For example, I want to build each spkg with 4 threads, not try to build 4 spkgs at the same time. Maybe a new sage-specific variable like `SAGE_BUILD_JOBS` could be used to pass the right `-j` argument to sub-make while the top-level make would always be invoked with `-j1`. Just an idea.

In any case... can some of these recursive calls be eliminated? E.g. this one...

```
# The 2 preliminary build phases: base and toolchain.                           
base-toolchain: _clean-broken-gcc base
        $(MAKE) toolchain
```

can probably be eliminated by making `_clean-broken-gcc base` a prerequisite for `toolchain`. Then `base-toolchain` can simply depend on both, if it needs to be kept around at all. But we could probably make other stuff depend on `base toolchain` instead of `base-toolchain` afterwards.



---

archive/issue_comments_456490.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:8 dimpase]:\n> what is the meaning of this syntax:\n> \n> ```\n> MAKE_REC = $(MAKE:-j%=)\n> ```\n> in Makefile.in ?\n\nThis is an instance of pattern substitution $(VARIABLE:FROM=TO), https://www.gnu.org/software/make/manual/html_node/Substitution-Refs.html",
    "created_at": "2020-08-13T14:23:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30345#issuecomment-456490",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>Replying to [comment:8 dimpase]:
> what is the meaning of this syntax:
> 
> ```
> MAKE_REC = $(MAKE:-j%=)
> ```
> in Makefile.in ?

This is an instance of pattern substitution $(VARIABLE:FROM=TO), https://www.gnu.org/software/make/manual/html_node/Substitution-Refs.html



---

archive/issue_comments_456491.json:
```json
{
    "body": "<a id='comment:11'></a>Let me just quickly say that the present ticket is a hotfix for breakage caused by #30153. Let's please keep the scope limited so we can it into the next beta.\n\nFor the big picture discussion regarding this whole mess of why we even recommend `MAKE=\"make -j8\" make build` instead of the more common `make -j8 build`, let's continue on #21610",
    "created_at": "2020-08-13T14:35:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30345#issuecomment-456491",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>Let me just quickly say that the present ticket is a hotfix for breakage caused by #30153. Let's please keep the scope limited so we can it into the next beta.

For the big picture discussion regarding this whole mess of why we even recommend `MAKE="make -j8" make build` instead of the more common `make -j8 build`, let's continue on #21610



---

archive/issue_comments_456492.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2020-08-14T15:42:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30345#issuecomment-456492",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_456493.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-15T07:38:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30345#issuecomment-456493",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_456494.json:
```json
{
    "body": "<a id='comment:13'></a>it does the job, let us get it in.\n\nAs to recommendation for setting MAKE, it could be due to an outdated `make`, as discussed on #21610",
    "created_at": "2020-08-15T07:38:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30345#issuecomment-456494",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:13'></a>it does the job, let us get it in.

As to recommendation for setting MAKE, it could be due to an outdated `make`, as discussed on #21610



---

archive/issue_comments_456495.json:
```json
{
    "body": "<a id='comment:14'></a>Thank you!",
    "created_at": "2020-08-15T13:38:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30345#issuecomment-456495",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>Thank you!



---

archive/issue_comments_456496.json:
```json
{
    "body": "<a id='comment:15'></a>Follow-up: #30369",
    "created_at": "2020-08-15T13:41:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30345#issuecomment-456496",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>Follow-up: #30369



---

archive/issue_comments_456497.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-08-16T22:33:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30345#issuecomment-456497",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_078613.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-08-16T22:33:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30345",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30345#event-78613"
}
```
