# Issue 30153: Repair "sage -b" broken by #29411

archive/issues_029916.json:
```json
{
    "body": "(from jhpalmieri, #30123)\n\nNote that sage -b doesn't work any more: it tries to do `cd \"$SAGE_SRC\" && $MAKE`, but `SAGE_SRC/Makefile.in` was removed in #29411. (If you have done an incremental build, the Makefile is still there.)\n\n\nCC:  @jhpalmieri @orlitzky @kliem\n\nReviewer: John Palmieri, Matthias Koeppe\n\nAuthor: Matthias Koeppe, John Palmieri, Michael Orlitzky\n\nBranch: 2d95def4348b61e9b4706f940c13e4cbb188654d\n\nDependencies: #30128\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30153\n\n",
    "closed_at": "2020-07-28T22:34:38Z",
    "created_at": "2020-07-16T04:47:30Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Repair \"sage -b\" broken by #29411",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30153",
    "user": "https://github.com/mkoeppe"
}
```
(from jhpalmieri, #30123)

Note that sage -b doesn't work any more: it tries to do `cd "$SAGE_SRC" && $MAKE`, but `SAGE_SRC/Makefile.in` was removed in #29411. (If you have done an incremental build, the Makefile is still there.)


CC:  @jhpalmieri @orlitzky @kliem

Reviewer: John Palmieri, Matthias Koeppe

Author: Matthias Koeppe, John Palmieri, Michael Orlitzky

Branch: 2d95def4348b61e9b4706f940c13e4cbb188654d

Dependencies: #30128

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/30153





---

archive/issue_comments_453041.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2020-07-16T19:31:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453041",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_453042.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-07-16T19:31:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453042",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_453043.json:
```json
{
    "body": "<a id='comment:3'></a>Can you base this on #30128 and then source sage-env-config before sage-env in that new Makefile target?",
    "created_at": "2020-07-16T19:45:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453043",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:3'></a>Can you base this on #30128 and then source sage-env-config before sage-env in that new Makefile target?



---

archive/issue_comments_453044.json:
```json
{
    "body": "<a id='comment:4'></a>- If I touch a `.pyx` file and do `sage -b`, nothing happens: `make: `sagelib-no-deps' is up to date.`\n- Same with `sage --ba-force`: nothing happens, even though this is supposed to force rebuilding everything in the Sage library.\n- It looks like the logger is invoked, and it didn't used to be. This might be a good change, not sure, but it is a change.\n- `git status` reports that the empty file `build/make/sagelib-no-deps` is present and untracked. Does `sagelib-no-deps` need to be added as a phony target, or something like that?",
    "created_at": "2020-07-16T20:16:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453044",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:4'></a>- If I touch a `.pyx` file and do `sage -b`, nothing happens: `make: `sagelib-no-deps' is up to date.`
- Same with `sage --ba-force`: nothing happens, even though this is supposed to force rebuilding everything in the Sage library.
- It looks like the logger is invoked, and it didn't used to be. This might be a good change, not sure, but it is a change.
- `git status` reports that the empty file `build/make/sagelib-no-deps` is present and untracked. Does `sagelib-no-deps` need to be added as a phony target, or something like that?



---

archive/issue_comments_453045.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:3 mjo]:\n> Can you base this on #30128 and then source sage-env-config before sage-env in that new Makefile target?\n\nSure, will do",
    "created_at": "2020-07-16T20:17:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453045",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>Replying to [comment:3 mjo]:
> Can you base this on #30128 and then source sage-env-config before sage-env in that new Makefile target?

Sure, will do



---

archive/issue_comments_453046.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:4 jhpalmieri]:\n> - `git status` reports that the empty file `build/make/sagelib-no-deps` is present and untracked. Does `sagelib-no-deps` need to be added as a phony target, or something like that?\n \nYes... will fix it",
    "created_at": "2020-07-16T20:18:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453046",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>Replying to [comment:4 jhpalmieri]:
> - `git status` reports that the empty file `build/make/sagelib-no-deps` is present and untracked. Does `sagelib-no-deps` need to be added as a phony target, or something like that?
 
Yes... will fix it



---

archive/issue_comments_453047.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-07-16T20:25:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453047",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_453048.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-16T20:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453048",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453049.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:4 jhpalmieri]:\n> - If I touch a `.pyx` file and do `sage -b`, nothing happens: `make: `sagelib-no-deps' is up to date.`\n> - Same with `sage --ba-force`: nothing happens, even though this is supposed to force rebuilding everything in the Sage library.\n\n\nThis should be fixed now.\n\n> - It looks like the logger is invoked, and it didn't used to be. This might be a good change, not sure, but it is a change.\n\n\nYes, it was convenient to go through the Makefile, and I think this change is good as it improves uniformity.",
    "created_at": "2020-07-16T20:28:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453049",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:9'></a>Replying to [comment:4 jhpalmieri]:
> - If I touch a `.pyx` file and do `sage -b`, nothing happens: `make: `sagelib-no-deps' is up to date.`
> - Same with `sage --ba-force`: nothing happens, even though this is supposed to force rebuilding everything in the Sage library.


This should be fixed now.

> - It looks like the logger is invoked, and it didn't used to be. This might be a good change, not sure, but it is a change.


Yes, it was convenient to go through the Makefile, and I think this change is good as it improves uniformity.



---

archive/issue_comments_453050.json:
```json
{
    "body": "<a id='comment:11'></a>I think this works. The first time I got a file `build/make/sagelib-no-deps`, but maybe I forgot to run `./bootstrap`/`.configure`/etc. It's working now.\n\n- Can we add a comment in `Makefile.in` explaining what `$(1)-no-deps` is and how it should be used? I'm guessing that it tries to build the package but ignores its dependencies. Does that have any uses aside from the Sage library? I've made an attempt.\n\n- For pip packages, you have added `$(1)-clean` a second time to the `.PHONY` list. Should there be a `$(1)-uninstall` target for these? In that case, change one `$(1)-clean` to `$(1)-uninstall`.\n\nCould we change the build rules so that\n\n```\n$$(INST)/$(1)-$(2)\n```\njust does `$(1)-build-deps` and `$(1)-no-deps`? It would cut out a tiny bit of code duplication. I guess we can't force the dependencies to be built before the package, so maybe not.",
    "created_at": "2020-07-16T22:12:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453050",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:11'></a>I think this works. The first time I got a file `build/make/sagelib-no-deps`, but maybe I forgot to run `./bootstrap`/`.configure`/etc. It's working now.

- Can we add a comment in `Makefile.in` explaining what `$(1)-no-deps` is and how it should be used? I'm guessing that it tries to build the package but ignores its dependencies. Does that have any uses aside from the Sage library? I've made an attempt.

- For pip packages, you have added `$(1)-clean` a second time to the `.PHONY` list. Should there be a `$(1)-uninstall` target for these? In that case, change one `$(1)-clean` to `$(1)-uninstall`.

Could we change the build rules so that

```
$$(INST)/$(1)-$(2)
```
just does `$(1)-build-deps` and `$(1)-no-deps`? It would cut out a tiny bit of code duplication. I guess we can't force the dependencies to be built before the package, so maybe not.



---

archive/issue_comments_453051.json:
```json
{
    "body": "<a id='comment:13'></a>By the way, we should deprecate `sage --ba-force`: #30160.\n\n---\nNew commits:",
    "created_at": "2020-07-16T22:24:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453051",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:13'></a>By the way, we should deprecate `sage --ba-force`: #30160.

---
New commits:



---

archive/issue_comments_453052.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:11 jhpalmieri]:\n> - Can we add a comment in `Makefile.in` explaining what `$(1)-no-deps` is and how it should be used? I'm guessing that it tries to build the package but ignores its dependencies. Does that have any uses aside from the Sage library? I've made an attempt.\n\n\nThanks very much, this is perfect.\n\nRegarding other uses - we could reimplement `sage -p` in terms of this. I just wasn't sure if we want to do this on the same ticket.\n\n> - For pip packages, you have added `$(1)-clean` a second time to the `.PHONY` list. Should there be a `$(1)-uninstall` target for these? In that case, change one `$(1)-clean` to `$(1)-uninstall`.\n\n\nThanks for catching this. I think you fixed it already. For deprecating/renaming `-clean` to `-uninstall`, we have #29097. Probably best not to do everything on one ticket.\n\n> Could we change the build rules so that\n> \n> ```\n> $$(INST)/$(1)-$(2)\n> ```\n> just does `$(1)-build-deps` and `$(1)-no-deps`? It would cut out a tiny bit of code duplication. I guess we can't force the dependencies to be built before the package, so maybe not.\n\n\nI don't see an elegant way to do this, unfortunately.",
    "created_at": "2020-07-16T22:29:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453052",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>Replying to [comment:11 jhpalmieri]:
> - Can we add a comment in `Makefile.in` explaining what `$(1)-no-deps` is and how it should be used? I'm guessing that it tries to build the package but ignores its dependencies. Does that have any uses aside from the Sage library? I've made an attempt.


Thanks very much, this is perfect.

Regarding other uses - we could reimplement `sage -p` in terms of this. I just wasn't sure if we want to do this on the same ticket.

> - For pip packages, you have added `$(1)-clean` a second time to the `.PHONY` list. Should there be a `$(1)-uninstall` target for these? In that case, change one `$(1)-clean` to `$(1)-uninstall`.


Thanks for catching this. I think you fixed it already. For deprecating/renaming `-clean` to `-uninstall`, we have #29097. Probably best not to do everything on one ticket.

> Could we change the build rules so that
> 
> ```
> $$(INST)/$(1)-$(2)
> ```
> just does `$(1)-build-deps` and `$(1)-no-deps`? It would cut out a tiny bit of code duplication. I guess we can't force the dependencies to be built before the package, so maybe not.


I don't see an elegant way to do this, unfortunately.



---

archive/issue_comments_453053.json:
```json
{
    "body": "<a id='comment:16'></a>This looks okay to me. Positive review on your contributions.",
    "created_at": "2020-07-17T20:50:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453053",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:16'></a>This looks okay to me. Positive review on your contributions.



---

archive/issue_comments_453054.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-17T21:41:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453054",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_453055.json:
```json
{
    "body": "<a id='comment:17'></a>Thanks!",
    "created_at": "2020-07-17T21:41:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453055",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>Thanks!



---

archive/issue_comments_453056.json:
```json
{
    "body": "<a id='comment:18'></a>Late to the party, sorry. I think my new commit factors out the no-deps code as requested.\n\nIf I missed something or if you'd rather do it on another ticket, just put the old branch back and mark it as positive review again. Everything is working now.",
    "created_at": "2020-07-17T23:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453056",
    "user": "https://github.com/orlitzky"
}
```

<a id='comment:18'></a>Late to the party, sorry. I think my new commit factors out the no-deps code as requested.

If I missed something or if you'd rather do it on another ticket, just put the old branch back and mark it as positive review again. Everything is working now.



---

archive/issue_comments_453057.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2020-07-17T23:30:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453057",
    "user": "https://github.com/orlitzky"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_453058.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-17T23:34:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453058",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_453059.json:
```json
{
    "body": "<a id='comment:19'></a>Thanks.",
    "created_at": "2020-07-17T23:34:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453059",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'></a>Thanks.



---

archive/issue_comments_453060.json:
```json
{
    "body": "<a id='comment:21'></a>Merged 9.2.beta6\n\n---\nNew commits:",
    "created_at": "2020-07-25T23:13:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453060",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'></a>Merged 9.2.beta6

---
New commits:



---

archive/issue_events_077748.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-07-28T22:34:38Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30153#event-77748"
}
```



---

archive/issue_comments_453061.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-28T22:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453061",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_453062.json:
```json
{
    "body": "<a id='comment:23'></a>I think the recursive invocation of $(MAKE) leads to builds with extremely high parallel load when `MAKE=\"make -j8\"` as recommended in Sage build documentation. I think this is part of why lately many builds on GH Actions are failing. To be fixed in #30345",
    "created_at": "2020-08-13T01:11:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30153",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30153#issuecomment-453062",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:23'></a>I think the recursive invocation of $(MAKE) leads to builds with extremely high parallel load when `MAKE="make -j8"` as recommended in Sage build documentation. I think this is part of why lately many builds on GH Actions are failing. To be fixed in #30345
