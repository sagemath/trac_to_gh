# Issue 30520: Fix sign of symbolic product product(1 - q^k, k, 1, N)

archive/issues_030283.json:
```json
{
    "body": "Reported at [Ask Sage question 53345](https://ask.sagemath.org/question/53345).\n\nThe output for this product\nhas an incorrect leading minus sign:\n\n```\nsage: N, q, k = SR.var('N, q, k')\nsage: product(1 - q^k, k, 1, N)\n-(-1)^N*product(q^k - 1, k, 1, N)\n```\n\nExpected:\n\n```\nsage: N, q, k = SR.var('N, q, k')\nsage: product(1 - q^k, k, 1, N)\n(-1)^N*product(q^k - 1, k, 1, N)\n```\n\nFixed in Maxima by this commit:\n\n- https://sourceforge.net/p/maxima/code/ci/762fd858d2a25fa1b8b6f5423909adbc365b3c5a/\n\n\nCC:  @davewittemorris @macrakis @robert-dodier @kcrisman @nbruin @slel\n\nKeywords: maxima\n\nBranch/Commit: 69c02357d69915d7d2b97b92bd6a0a16cd14eedc\n\nReviewer: Samuel Leli\u00e8vre\n\nAuthor: Dave Morris\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30520\n\n",
    "closed_at": "2021-07-25T13:25:52Z",
    "created_at": "2020-09-07T07:25:34Z",
    "labels": [
        "component: symbolics",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Fix sign of symbolic product product(1 - q^k, k, 1, N)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30520",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```
Reported at [Ask Sage question 53345](https://ask.sagemath.org/question/53345).

The output for this product
has an incorrect leading minus sign:

```
sage: N, q, k = SR.var('N, q, k')
sage: product(1 - q^k, k, 1, N)
-(-1)^N*product(q^k - 1, k, 1, N)
```

Expected:

```
sage: N, q, k = SR.var('N, q, k')
sage: product(1 - q^k, k, 1, N)
(-1)^N*product(q^k - 1, k, 1, N)
```

Fixed in Maxima by this commit:

- https://sourceforge.net/p/maxima/code/ci/762fd858d2a25fa1b8b6f5423909adbc365b3c5a/


CC:  @davewittemorris @macrakis @robert-dodier @kcrisman @nbruin @slel

Keywords: maxima

Branch/Commit: 69c02357d69915d7d2b97b92bd6a0a16cd14eedc

Reviewer: Samuel Lelièvre

Author: Dave Morris

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/30520





---

archive/issue_comments_602999.json:
```json
{
    "body": "<a id='comment:1'></a>\nFWIW, Sympy doesn't seem to be able to pull this one:\n\n```\nsage: from sympy import Product                                                 \nsage: from sympy.abc import j, p, q                                             \nsage: foo=Product(1-q^j, [j,1,p]); foo                                          \nProduct(1 - q**j, (j, 1, p))\nsage: type(foo)                                                                 \n<class 'sympy.concrete.products.Product'>\nsage: foo.doit()                                                                \nProduct(1 - q**j, (j, 1, p))\n```\n\nMathematica isn't more helpful:\n\n```\nsage: bar=mathematica(\"Product[1-q^j, {j, 1, p}]\"); bar                         \nQPochhammer[q, q, p]\n```\n\nGiac's answer can't be believed :\n\n```\nage: var(\"j,q,p\")                                                              \n(j, q, p)\nsage: gargs=list(map(giac, [1-q^j,j,1,p,1]))                                    \nsage: gargs                                                                     \n[-q^j+1, j, 1, p, 1]\nsage: libgiac.product(*gargs)                                                   \n-q+1\n```\n\nHTH, but doubting it...",
    "created_at": "2020-09-07T11:12:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-602999",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:1'></a>
FWIW, Sympy doesn't seem to be able to pull this one:

```
sage: from sympy import Product                                                 
sage: from sympy.abc import j, p, q                                             
sage: foo=Product(1-q^j, [j,1,p]); foo                                          
Product(1 - q**j, (j, 1, p))
sage: type(foo)                                                                 
<class 'sympy.concrete.products.Product'>
sage: foo.doit()                                                                
Product(1 - q**j, (j, 1, p))
```

Mathematica isn't more helpful:

```
sage: bar=mathematica("Product[1-q^j, {j, 1, p}]"); bar                         
QPochhammer[q, q, p]
```

Giac's answer can't be believed :

```
age: var("j,q,p")                                                              
(j, q, p)
sage: gargs=list(map(giac, [1-q^j,j,1,p,1]))                                    
sage: gargs                                                                     
[-q^j+1, j, 1, p, 1]
sage: libgiac.product(*gargs)                                                   
-q+1
```

HTH, but doubting it...



---

archive/issue_comments_603000.json:
```json
{
    "body": "<a id='comment:2'></a>\nfor what it's worth, it's either in the interface to maxima in `maxima_eval` or in maxima itself, what ultimately gets called is:\n\n```\nsage: var('n,q,i')\n(n, q, i)\nsage: expr = 1 - q**i\nsage: from sage.interfaces import maxima_lib\nsage: sage.interfaces.maxima_lib.maxima.sr_prod(expr, i, 1, n)\n-(-1)^n*product(q^i - 1, i, 1, n)\n```\nI couldn't reproduce this on pure maxima, but I have never used it before, so it may well be there. \n\nEDIT: it may also be in the final conversion `max_to_sr`",
    "created_at": "2020-09-10T02:47:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603000",
    "user": "https://github.com/heluani"
}
```

<a id='comment:2'></a>
for what it's worth, it's either in the interface to maxima in `maxima_eval` or in maxima itself, what ultimately gets called is:

```
sage: var('n,q,i')
(n, q, i)
sage: expr = 1 - q**i
sage: from sage.interfaces import maxima_lib
sage: sage.interfaces.maxima_lib.maxima.sr_prod(expr, i, 1, n)
-(-1)^n*product(q^i - 1, i, 1, n)
```
I couldn't reproduce this on pure maxima, but I have never used it before, so it may well be there. 

EDIT: it may also be in the final conversion `max_to_sr`



---

archive/issue_comments_603001.json:
```json
{
    "body": "<a id='comment:3'></a>\nA simple case\n\n```\nsage: from sage.calculus.calculus import symbolic_product                       \nsage: var('x,n')                                                                \n(x, n)\nsage:  symbolic_product(-x**2,x,1,n)                                            \n-(-1)^n*factorial(n)^2\n```",
    "created_at": "2020-09-11T12:41:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603001",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:3'></a>
A simple case

```
sage: from sage.calculus.calculus import symbolic_product                       
sage: var('x,n')                                                                
(x, n)
sage:  symbolic_product(-x**2,x,1,n)                                            
-(-1)^n*factorial(n)^2
```



---

archive/issue_comments_603002.json:
```json
{
    "body": "<a id='comment:4'></a>\nThis seems to happen in `max_simplify_prod`. Before:\n\n```\nipdb> p maxima_eval(([max_prod],[sr_to_max(SR(a)) for a in args]))              \n<ECL: ((%PRODUCT SIMP) ((MTIMES SIMP) -1 ((MEXPT SIMP) |$_SAGE_VAR_x| 2))\n |$_SAGE_VAR_x| 1 |$_SAGE_VAR_n|)>\n```\nand after:\n\n```\nipdb> p maxima_eval([max_simplify_prod, ([max_prod],[sr_to_max(SR(a)) for a in a\nrgs])])                                                                         \n<ECL: ((MTIMES SIMP) ((MEXPT SIMP) -1 ((MPLUS SIMP) -1 |$_SAGE_VAR_n|))\n ((MEXPT SIMP) ((MFACTORIAL SIMP) |$_SAGE_VAR_n|) 2))>\n```",
    "created_at": "2020-09-11T12:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603002",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:4'></a>
This seems to happen in `max_simplify_prod`. Before:

```
ipdb> p maxima_eval(([max_prod],[sr_to_max(SR(a)) for a in args]))              
<ECL: ((%PRODUCT SIMP) ((MTIMES SIMP) -1 ((MEXPT SIMP) |$_SAGE_VAR_x| 2))
 |$_SAGE_VAR_x| 1 |$_SAGE_VAR_n|)>
```
and after:

```
ipdb> p maxima_eval([max_simplify_prod, ([max_prod],[sr_to_max(SR(a)) for a in a
rgs])])                                                                         
<ECL: ((MTIMES SIMP) ((MEXPT SIMP) -1 ((MPLUS SIMP) -1 |$_SAGE_VAR_n|))
 ((MEXPT SIMP) ((MFACTORIAL SIMP) |$_SAGE_VAR_n|) 2))>
```



---

archive/issue_events_079299.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30520#event-79299"
}
```



---

archive/issue_comments_603003.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,10 +1,19 @@\n-As reported on [this ask question](https://ask.sagemath.org/question/53345/sage-symbolic-math-simplification-error/):\n+Reported at [Ask Sage question 53345](https://ask.sagemath.org/question/53345).\n+\n+Before this ticket, the output for this product\n+has an incorrect leading minus sign:\n \n ```\n-sage: var('N,q,k')\n-(N, q, k)\n-sage: product(1-q^k, k, 1, N)\n+sage: N, q, k = SR.var('N, q, k')\n+sage: product(1 - q^k, k, 1, N)\n -(-1)^N*product(q^k - 1, k, 1, N)\n ```\n \n-The result should be `(-1)<sup>N*product(q</sup>k - 1, k, 1, N)` without a leading minus sign.\n+After this ticket, the output is correct:\n+\n+```\n+sage: N, q, k = SR.var('N, q, k')\n+sage: product(1 - q^k, k, 1, N)\n+(-1)^N*product(q^k - 1, k, 1, N)\n+```\n+\n``````\n",
    "created_at": "2021-03-24T18:59:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603003",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,10 +1,19 @@
-As reported on [this ask question](https://ask.sagemath.org/question/53345/sage-symbolic-math-simplification-error/):
+Reported at [Ask Sage question 53345](https://ask.sagemath.org/question/53345).
+
+Before this ticket, the output for this product
+has an incorrect leading minus sign:
 
 ```
-sage: var('N,q,k')
-(N, q, k)
-sage: product(1-q^k, k, 1, N)
+sage: N, q, k = SR.var('N, q, k')
+sage: product(1 - q^k, k, 1, N)
 -(-1)^N*product(q^k - 1, k, 1, N)
 ```
 
-The result should be `(-1)<sup>N*product(q</sup>k - 1, k, 1, N)` without a leading minus sign.
+After this ticket, the output is correct:
+
+```
+sage: N, q, k = SR.var('N, q, k')
+sage: product(1 - q^k, k, 1, N)
+(-1)^N*product(q^k - 1, k, 1, N)
+```
+
``````




---

archive/issue_comments_603004.json:
```json
{
    "body": "<a id='comment:6'></a>\nAny insights from Maxima or Sage symbolics experts?",
    "created_at": "2021-03-24T18:59:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603004",
    "user": "https://github.com/slel"
}
```

<a id='comment:6'></a>
Any insights from Maxima or Sage symbolics experts?



---

archive/issue_comments_603005.json:
```json
{
    "body": "<a id='comment:7'></a>\nHi, thanks for the Maxima problem report.\n\nI was unable to reproduce this in Maxima 5.44.0/SBCL 2.0.0/Windows 10.\n\nCould you please report the details necessary to reproduce the problem:\n* The exact version of Maxima/SBCL/OS you're using.\n* The exact commands that were passed to Maxima.\n* Any non-default global settings that Sage uses when calling Maxima.\n* What does max_simplify_product do?\n* What the var(...) declaration/statement does in Maxima terms. Does it declare anything special about those variables?\n* What does \"before this ticket\" and \"after this ticket\" mean? Was it run on different versions of Maxima? If so, which ones?\nThanks,\n\n            -s",
    "created_at": "2021-03-24T20:16:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603005",
    "user": "https://github.com/macrakis"
}
```

<a id='comment:7'></a>
Hi, thanks for the Maxima problem report.

I was unable to reproduce this in Maxima 5.44.0/SBCL 2.0.0/Windows 10.

Could you please report the details necessary to reproduce the problem:
* The exact version of Maxima/SBCL/OS you're using.
* The exact commands that were passed to Maxima.
* Any non-default global settings that Sage uses when calling Maxima.
* What does max_simplify_product do?
* What the var(...) declaration/statement does in Maxima terms. Does it declare anything special about those variables?
* What does "before this ticket" and "after this ticket" mean? Was it run on different versions of Maxima? If so, which ones?
Thanks,

            -s



---

archive/issue_comments_603006.json:
```json
{
    "body": "Changing keywords from \"\" to \"maxima\".",
    "created_at": "2021-03-25T00:22:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603006",
    "user": "https://github.com/slel"
}
```

Changing keywords from "" to "maxima".



---

archive/issue_comments_603007.json:
```json
{
    "body": "<a id='comment:8'></a>\nApologies for cc-ing you. Rather than in Maxima,\nthe bug might well be in Sage's interface to it.\n\nIn Sage, the bug can lead to wrong results as in\n\n```\nsage: from sage.calculus.calculus import symbolic_product                       \nsage: x, n = SR.var('x,n')\nsage: symbolic_product(-x**2, x, 1, n)\n-(-1)^n*factorial(n)^2\n```\nor cause an error to be raised as in\n\n```\nsage: symbolic_product(-x, x, 1, n)\nTraceback (most recent call last)\n...\nRuntimeError: ECL says: Error executing code in Maxima: factorial: factorial of negative integer -1 not defined.\n```\n\nNot sure what exactly gets sent to Maxima in those cases.\n\nI have Maxima 5.44.0, ECL 21.2.1, macOS 10.14.6.\n\n```\nsage: pv = installed_packages()  # package versions\nsage: print(', '.join(f'{p} {pv[p]}' for p in ['maxima', 'ecl']))\nmaxima 5.44.0, ecl 21.2.1\n```\n\nSage calls Maxima with [the following global settings](https://github.com/sagemath/sage/blob/9.3.rc0/src/sage/interfaces/maxima_lib.py#L168-L179):\n\n```\nbesselexpand : true ;\ndisplay2d : false ;\ndomain : complex ;\nkeepfloat : true ;\nload(to_poly_solve) ;\nload(simplify_sum) ;\nload(diag) ;\nnolabels : true ;\n```\n\n\"Before this ticket\" is the observed bug.\n\"After this ticket\" is the goal (so far not reached).",
    "created_at": "2021-03-25T00:22:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603007",
    "user": "https://github.com/slel"
}
```

<a id='comment:8'></a>
Apologies for cc-ing you. Rather than in Maxima,
the bug might well be in Sage's interface to it.

In Sage, the bug can lead to wrong results as in

```
sage: from sage.calculus.calculus import symbolic_product                       
sage: x, n = SR.var('x,n')
sage: symbolic_product(-x**2, x, 1, n)
-(-1)^n*factorial(n)^2
```
or cause an error to be raised as in

```
sage: symbolic_product(-x, x, 1, n)
Traceback (most recent call last)
...
RuntimeError: ECL says: Error executing code in Maxima: factorial: factorial of negative integer -1 not defined.
```

Not sure what exactly gets sent to Maxima in those cases.

I have Maxima 5.44.0, ECL 21.2.1, macOS 10.14.6.

```
sage: pv = installed_packages()  # package versions
sage: print(', '.join(f'{p} {pv[p]}' for p in ['maxima', 'ecl']))
maxima 5.44.0, ecl 21.2.1
```

Sage calls Maxima with [the following global settings](https://github.com/sagemath/sage/blob/9.3.rc0/src/sage/interfaces/maxima_lib.py#L168-L179):

```
besselexpand : true ;
display2d : false ;
domain : complex ;
keepfloat : true ;
load(to_poly_solve) ;
load(simplify_sum) ;
load(diag) ;
nolabels : true ;
```

"Before this ticket" is the observed bug.
"After this ticket" is the goal (so far not reached).



---

archive/issue_comments_603008.json:
```json
{
    "body": "<a id='comment:9'></a>\n> * What does max_simplify_product do?\n \n[Here](https://github.com/sagemath/sage/blob/9.3.rc0/src/sage/interfaces/maxima_lib.py#L238):\n\n```\nmax_simplify_prod=EclObject(\"$SIMPLIFY_PRODUCT\")\n```\nwhich is presumably in the contributed `simplify_sum` package, more precisely [here](https://github.com/andrejv/maxima/blob/master/share/solve_rec/solve_rec.mac#L1026).  I had trouble finding references in the official documentation, though.\n> * What the var(...) declaration/statement does in Maxima terms. Does it declare anything special about those variables?\n \nNo.",
    "created_at": "2021-03-25T01:20:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603008",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:9'></a>
> * What does max_simplify_product do?
 
[Here](https://github.com/sagemath/sage/blob/9.3.rc0/src/sage/interfaces/maxima_lib.py#L238):

```
max_simplify_prod=EclObject("$SIMPLIFY_PRODUCT")
```
which is presumably in the contributed `simplify_sum` package, more precisely [here](https://github.com/andrejv/maxima/blob/master/share/solve_rec/solve_rec.mac#L1026).  I had trouble finding references in the official documentation, though.
> * What the var(...) declaration/statement does in Maxima terms. Does it declare anything special about those variables?
 
No.



---

archive/issue_comments_603009.json:
```json
{
    "body": "<a id='comment:10'></a>\n`\"Before this ticket\" is the observed bug. \"After this ticket\" is the goal (so far not reached).` I know this is just a convention, but, um, this is pretty confusing; I don't see how anyone who was not already among the cognoscenti would know what it means. \"Observed\" and \"expected behavior\" seems adequate.\n\nI can't be sure about what's going on here, but I speculate the error is coming out of `simplify_product` in the `simplify_sum` code. \n\n```\nsimplify_product ('product(1 - f(k), k, 1, N));\n => (-1)^(N-1)*'product(f(k)-1,k,1,N)\n```\nThe leading term is off by 1 (right?) -- I think this is the origin of the stray -1 which was observed.",
    "created_at": "2021-03-25T02:40:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603009",
    "user": "https://github.com/robert-dodier"
}
```

<a id='comment:10'></a>
`"Before this ticket" is the observed bug. "After this ticket" is the goal (so far not reached).` I know this is just a convention, but, um, this is pretty confusing; I don't see how anyone who was not already among the cognoscenti would know what it means. "Observed" and "expected behavior" seems adequate.

I can't be sure about what's going on here, but I speculate the error is coming out of `simplify_product` in the `simplify_sum` code. 

```
simplify_product ('product(1 - f(k), k, 1, N));
 => (-1)^(N-1)*'product(f(k)-1,k,1,N)
```
The leading term is off by 1 (right?) -- I think this is the origin of the stray -1 which was observed.



---

archive/issue_comments_603010.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,7 +1,6 @@\n Reported at [Ask Sage question 53345](https://ask.sagemath.org/question/53345).\n \n-Before this ticket, the output for this product\n-has an incorrect leading minus sign:\n+Observed: incorrect leading minus sign:\n \n ```\n sage: N, q, k = SR.var('N, q, k')\n@@ -9,7 +8,7 @@\n -(-1)^N*product(q^k - 1, k, 1, N)\n ```\n \n-After this ticket, the output is correct:\n+Expected:\n \n ```\n sage: N, q, k = SR.var('N, q, k')\n``````\n",
    "created_at": "2021-03-25T02:53:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603010",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,7 +1,6 @@
 Reported at [Ask Sage question 53345](https://ask.sagemath.org/question/53345).
 
-Before this ticket, the output for this product
-has an incorrect leading minus sign:
+Observed: incorrect leading minus sign:
 
 ```
 sage: N, q, k = SR.var('N, q, k')
@@ -9,7 +8,7 @@
 -(-1)^N*product(q^k - 1, k, 1, N)
 ```
 
-After this ticket, the output is correct:
+Expected:
 
 ```
 sage: N, q, k = SR.var('N, q, k')
``````




---

archive/issue_comments_603011.json:
```json
{
    "body": "<a id='comment:11'></a>\nThanks for the rephrasing suggestion and your thoughts on the problem.",
    "created_at": "2021-03-25T02:53:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603011",
    "user": "https://github.com/slel"
}
```

<a id='comment:11'></a>
Thanks for the rephrasing suggestion and your thoughts on the problem.



---

archive/issue_comments_603012.json:
```json
{
    "body": "<a id='comment:12'></a>\n`@`gh-robert-dodier: Yes, I think you are right. In line 1112 of [the file suggested by kcrisman](https://github.com/andrejv/maxima/blob/master/share/solve_rec/solve_rec.mac#L1026), the code for `simplify_product` says:\n\n```\n(-1)^(hi-lo)*simplify_product(apply(nounify('product), [-term, %n, lo, hi]))\n```\nIf I understand correctly, then this is an off-by-one error: the number of terms in the product is `hi - lo + 1` because `hi` and `lo` are both included.",
    "created_at": "2021-03-25T02:56:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603012",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:12'></a>
`@`gh-robert-dodier: Yes, I think you are right. In line 1112 of [the file suggested by kcrisman](https://github.com/andrejv/maxima/blob/master/share/solve_rec/solve_rec.mac#L1026), the code for `simplify_product` says:

```
(-1)^(hi-lo)*simplify_product(apply(nounify('product), [-term, %n, lo, hi]))
```
If I understand correctly, then this is an off-by-one error: the number of terms in the product is `hi - lo + 1` because `hi` and `lo` are both included.



---

archive/issue_comments_603013.json:
```json
{
    "body": "<a id='comment:13'></a>\nI located the copy of that file in my Sage installation:\n\n```\n$ cd $(sage -c 'print(SAGE_ROOT)')\n$ find . -name \"solve_rec.mac\"\n./local/share/maxima/5.44.0/share/solve_rec/solve_rec.mac\n```\nand changed line 1112 as suggested by Dave.\n\nNow I get the correct product from the ticket description:\n\n```\nsage: N, q, k = SR.var('N, q, k')\nsage: product(1 - q^k, k, 1, N)\n(-1)^N*product(q^k - 1, k, 1, N)\n```\nand for the sum of `-x^2`:\n\n```\nsage: from sage.calculus.calculus import symbolic_product\nsage: x, n = SR.var('x, n')\nsage: symbolic_product(-x**2, x, 1, n)\n(-1)^n*factorial(n)^2\n```\nbut this still gives trouble:\n\n```\nsage: from sage.calculus.calculus import symbolic_product\nsage: x, n = SR.var('x, n')\nsage: symbolic_product(-x, x, 1, n)\n#0: simplify_product(product='product(-_SAGE_VAR_x,_SAGE_VAR_x,1,_SAGE_VAR_n))\n...\nTraceback (most recent call last)\n...\nRuntimeError: ECL says: Error executing code in Maxima: factorial: factorial of negative integer -1 not defined.\n```\nIt would be nice to fix that too.",
    "created_at": "2021-03-25T03:08:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603013",
    "user": "https://github.com/slel"
}
```

<a id='comment:13'></a>
I located the copy of that file in my Sage installation:

```
$ cd $(sage -c 'print(SAGE_ROOT)')
$ find . -name "solve_rec.mac"
./local/share/maxima/5.44.0/share/solve_rec/solve_rec.mac
```
and changed line 1112 as suggested by Dave.

Now I get the correct product from the ticket description:

```
sage: N, q, k = SR.var('N, q, k')
sage: product(1 - q^k, k, 1, N)
(-1)^N*product(q^k - 1, k, 1, N)
```
and for the sum of `-x^2`:

```
sage: from sage.calculus.calculus import symbolic_product
sage: x, n = SR.var('x, n')
sage: symbolic_product(-x**2, x, 1, n)
(-1)^n*factorial(n)^2
```
but this still gives trouble:

```
sage: from sage.calculus.calculus import symbolic_product
sage: x, n = SR.var('x, n')
sage: symbolic_product(-x, x, 1, n)
#0: simplify_product(product='product(-_SAGE_VAR_x,_SAGE_VAR_x,1,_SAGE_VAR_n))
...
Traceback (most recent call last)
...
RuntimeError: ECL says: Error executing code in Maxima: factorial: factorial of negative integer -1 not defined.
```
It would be nice to fix that too.



---

archive/issue_comments_603014.json:
```json
{
    "body": "<a id='comment:14'></a>\nI've come to the same conclusion. I think this patch fixes it:\n\n```\n$ git diff\ndiff --git a/share/solve_rec/solve_rec.mac b/share/solve_rec/solve_rec.mac\nindex 2727db808..8979e3f1d 100644\n--- a/share/solve_rec/solve_rec.mac\n+++ b/share/solve_rec/solve_rec.mac\n@@ -1109,7 +1109,7 @@ simplify_product(prod) := block(\n         prod\n     )\n     else if part(term, 0)=\"-\" and length(args(term))=1 then\n-      (-1)^(hi-lo)*simplify_product(apply(nounify('product), [-term, %n, lo, hi]))\n+      (-1)^(hi-lo+1)*simplify_product(apply(nounify('product), [-term, %n, lo, hi]))\n     /* Give up! */\n     else\n       p%*apply(nounify('product), [factor(term), %n, lo, hi])\n```\n\nAlthough the existing, incorrect code is exercised by the unit tests (rtest_simplify_sum and rtest_solve_rec), fixing it does not change any results! Not sure what's going on there; I guess it is a happy accident. Or not. \n\nAnyway I will add a few unit tests and commit the patch.",
    "created_at": "2021-03-25T03:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603014",
    "user": "https://github.com/robert-dodier"
}
```

<a id='comment:14'></a>
I've come to the same conclusion. I think this patch fixes it:

```
$ git diff
diff --git a/share/solve_rec/solve_rec.mac b/share/solve_rec/solve_rec.mac
index 2727db808..8979e3f1d 100644
--- a/share/solve_rec/solve_rec.mac
+++ b/share/solve_rec/solve_rec.mac
@@ -1109,7 +1109,7 @@ simplify_product(prod) := block(
         prod
     )
     else if part(term, 0)="-" and length(args(term))=1 then
-      (-1)^(hi-lo)*simplify_product(apply(nounify('product), [-term, %n, lo, hi]))
+      (-1)^(hi-lo+1)*simplify_product(apply(nounify('product), [-term, %n, lo, hi]))
     /* Give up! */
     else
       p%*apply(nounify('product), [factor(term), %n, lo, hi])
```

Although the existing, incorrect code is exercised by the unit tests (rtest_simplify_sum and rtest_solve_rec), fixing it does not change any results! Not sure what's going on there; I guess it is a happy accident. Or not. 

Anyway I will add a few unit tests and commit the patch.



---

archive/issue_comments_603015.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,7 @@\n Reported at [Ask Sage question 53345](https://ask.sagemath.org/question/53345).\n \n-Observed: incorrect leading minus sign:\n+Before this ticket, the output for this product\n+has an incorrect leading minus sign:\n \n ```\n sage: N, q, k = SR.var('N, q, k')\n@@ -8,7 +9,7 @@\n -(-1)^N*product(q^k - 1, k, 1, N)\n ```\n \n-Expected:\n+After this ticket, the output is correct:\n \n ```\n sage: N, q, k = SR.var('N, q, k')\n``````\n",
    "created_at": "2021-03-25T03:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603015",
    "user": "https://github.com/robert-dodier"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,7 @@
 Reported at [Ask Sage question 53345](https://ask.sagemath.org/question/53345).
 
-Observed: incorrect leading minus sign:
+Before this ticket, the output for this product
+has an incorrect leading minus sign:
 
 ```
 sage: N, q, k = SR.var('N, q, k')
@@ -8,7 +9,7 @@
 -(-1)^N*product(q^k - 1, k, 1, N)
 ```
 
-Expected:
+After this ticket, the output is correct:
 
 ```
 sage: N, q, k = SR.var('N, q, k')
``````




---

archive/issue_comments_603016.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [slelievre](#comment%3A13):\n\n> but this still gives trouble:\n> \n> ```\n> sage: from sage.calculus.calculus import symbolic_product\n> sage: x, n = SR.var('x, n')\n> sage: symbolic_product(-x, x, 1, n)\n> #0: simplify_product(product='product(-_SAGE_VAR_x,_SAGE_VAR_x,1,_SAGE_VAR_n))\n> ...\n> Traceback (most recent call last)\n> ...\n> RuntimeError: ECL says: Error executing code in Maxima: factorial: factorial of negative integer -1 not defined.\n> ```\n> It would be nice to fix that too.\n\n\nWell, that's a different bug, although it's in the same file; looks like it is in the stanza which begins `if freeof(%n,aa) and freeof(%n,bb)` around line 1096. In the interest of clarity, I would suggest opening a separate bug report about it.",
    "created_at": "2021-03-25T03:25:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603016",
    "user": "https://github.com/robert-dodier"
}
```

<a id='comment:15'></a>
Replying to [slelievre](#comment%3A13):

> but this still gives trouble:
> 
> ```
> sage: from sage.calculus.calculus import symbolic_product
> sage: x, n = SR.var('x, n')
> sage: symbolic_product(-x, x, 1, n)
> #0: simplify_product(product='product(-_SAGE_VAR_x,_SAGE_VAR_x,1,_SAGE_VAR_n))
> ...
> Traceback (most recent call last)
> ...
> RuntimeError: ECL says: Error executing code in Maxima: factorial: factorial of negative integer -1 not defined.
> ```
> It would be nice to fix that too.


Well, that's a different bug, although it's in the same file; looks like it is in the stanza which begins `if freeof(%n,aa) and freeof(%n,bb)` around line 1096. In the interest of clarity, I would suggest opening a separate bug report about it.



---

archive/issue_comments_603017.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [gh-robert-dodier](#comment%3A15):\n> Replying to [slelievre](#comment%3A13):\n> \n> > but this still gives trouble:\n> > \n> > ```\n> > sage: from sage.calculus.calculus import symbolic_product\n> > sage: x, n = SR.var('x, n')\n> > sage: symbolic_product(-x, x, 1, n)\n> > #0: simplify_product(product='product(-_SAGE_VAR_x,_SAGE_VAR_x,1,_SAGE_VAR_n))\n> > ...\n> > Traceback (most recent call last)\n> > ...\n> > RuntimeError: ECL says: Error executing code in Maxima: factorial: factorial of negative integer -1 not defined.\n> > ```\n> > It would be nice to fix that too.\n\n> \n> Well, that's a different bug, although it's in the same file; looks like it is in the stanza which begins `if freeof(%n,aa) and freeof(%n,bb)` around line 1096. In the interest of clarity, I would suggest opening a separate bug report about it.\n\n\nYou are right. This is now tracked at #31557.",
    "created_at": "2021-03-25T03:35:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603017",
    "user": "https://github.com/slel"
}
```

<a id='comment:16'></a>
Replying to [gh-robert-dodier](#comment%3A15):
> Replying to [slelievre](#comment%3A13):
> 
> > but this still gives trouble:
> > 
> > ```
> > sage: from sage.calculus.calculus import symbolic_product
> > sage: x, n = SR.var('x, n')
> > sage: symbolic_product(-x, x, 1, n)
> > #0: simplify_product(product='product(-_SAGE_VAR_x,_SAGE_VAR_x,1,_SAGE_VAR_n))
> > ...
> > Traceback (most recent call last)
> > ...
> > RuntimeError: ECL says: Error executing code in Maxima: factorial: factorial of negative integer -1 not defined.
> > ```
> > It would be nice to fix that too.

> 
> Well, that's a different bug, although it's in the same file; looks like it is in the stanza which begins `if freeof(%n,aa) and freeof(%n,bb)` around line 1096. In the interest of clarity, I would suggest opening a separate bug report about it.


You are right. This is now tracked at #31557.



---

archive/issue_comments_603018.json:
```json
{
    "body": "<a id='comment:17'></a>\nFixed (to the best of my knowledge; no doubt you'll want to verify for Sage) by commit 762fd85 on maxima-code/master which applies the patch for simplify_product shown above.",
    "created_at": "2021-03-25T18:16:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603018",
    "user": "https://github.com/robert-dodier"
}
```

<a id='comment:17'></a>
Fixed (to the best of my knowledge; no doubt you'll want to verify for Sage) by commit 762fd85 on maxima-code/master which applies the patch for simplify_product shown above.



---

archive/issue_comments_603019.json:
```json
{
    "body": "<a id='comment:18'></a>\nThanks!",
    "created_at": "2021-03-25T18:17:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603019",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:18'></a>
Thanks!



---

archive/issue_comments_603020.json:
```json
{
    "body": "<a id='comment:19'></a>\nShould we apply the upstream commit fixing this\nas a patch or wait for the next Maxima release?",
    "created_at": "2021-04-21T19:43:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603020",
    "user": "https://github.com/slel"
}
```

<a id='comment:19'></a>
Should we apply the upstream commit fixing this
as a patch or wait for the next Maxima release?



---

archive/issue_comments_603021.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n Reported at [Ask Sage question 53345](https://ask.sagemath.org/question/53345).\n \n-Before this ticket, the output for this product\n+The output for this product\n has an incorrect leading minus sign:\n \n ```\n@@ -9,7 +9,7 @@\n -(-1)^N*product(q^k - 1, k, 1, N)\n ```\n \n-After this ticket, the output is correct:\n+Expected:\n \n ```\n sage: N, q, k = SR.var('N, q, k')\n@@ -17,3 +17,7 @@\n (-1)^N*product(q^k - 1, k, 1, N)\n ```\n \n+Fixed in Maxima by this commit:\n+\n+- https://sourceforge.net/p/maxima/code/ci/762fd858d2a25fa1b8b6f5423909adbc365b3c5a/\n+\n``````\n",
    "created_at": "2021-04-21T19:43:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603021",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 Reported at [Ask Sage question 53345](https://ask.sagemath.org/question/53345).
 
-Before this ticket, the output for this product
+The output for this product
 has an incorrect leading minus sign:
 
 ```
@@ -9,7 +9,7 @@
 -(-1)^N*product(q^k - 1, k, 1, N)
 ```
 
-After this ticket, the output is correct:
+Expected:
 
 ```
 sage: N, q, k = SR.var('N, q, k')
@@ -17,3 +17,7 @@
 (-1)^N*product(q^k - 1, k, 1, N)
 ```
 
+Fixed in Maxima by this commit:
+
+- https://sourceforge.net/p/maxima/code/ci/762fd858d2a25fa1b8b6f5423909adbc365b3c5a/
+
``````




---

archive/issue_comments_603022.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [slelievre](#comment%3A19):\n> Should we apply the upstream commit fixing this\n> as a patch or wait for the next Maxima release?\n\n\nFor what it's worth, a new Maxima version is on the horizon; it is being discussed on the mailing list, although no work on it has been announced. So my guess is that a new version will appear in, let's say, one to three months. I don't know whether that implies you should wait or not.",
    "created_at": "2021-04-21T20:33:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603022",
    "user": "https://github.com/robert-dodier"
}
```

<a id='comment:20'></a>
Replying to [slelievre](#comment%3A19):
> Should we apply the upstream commit fixing this
> as a patch or wait for the next Maxima release?


For what it's worth, a new Maxima version is on the horizon; it is being discussed on the mailing list, although no work on it has been announced. So my guess is that a new version will appear in, let's say, one to three months. I don't know whether that implies you should wait or not.



---

archive/issue_comments_603023.json:
```json
{
    "body": "<a id='comment:21'></a>\nMoving to 9.4, as 9.3 has been released.",
    "created_at": "2021-05-10T17:42:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603023",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'></a>
Moving to 9.4, as 9.3 has been released.



---

archive/issue_events_079300.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-05-10T17:42:09Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30520#event-79300"
}
```



---

archive/issue_events_079301.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-05-10T17:42:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30520#event-79301"
}
```



---

archive/issue_comments_603024.json:
```json
{
    "body": "Changing branch from \"\" to \"public/30520\"",
    "created_at": "2021-07-03T05:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603024",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing branch from "" to "public/30520"



---

archive/issue_comments_603025.json:
```json
{
    "body": "Changing commit from \"\" to \"69c02357d69915d7d2b97b92bd6a0a16cd14eedc\"",
    "created_at": "2021-07-03T05:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603025",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing commit from "" to "69c02357d69915d7d2b97b92bd6a0a16cd14eedc"



---

archive/issue_comments_603026.json:
```json
{
    "body": "Changing author from \"\" to \"Dave Morris\"",
    "created_at": "2021-07-03T05:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603026",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing author from "" to "Dave Morris"



---

archive/issue_comments_603027.json:
```json
{
    "body": "<a id='comment:23'></a>\nThis was [fixed in maxima 5.45](https://sourceforge.net/p/maxima/code/ci/master/tree/changelogs/ChangeLog-5.45.md). Ticket #31876 did the upgrade in sage. The PR just adds a doctest.",
    "created_at": "2021-07-03T05:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603027",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:23'></a>
This was [fixed in maxima 5.45](https://sourceforge.net/p/maxima/code/ci/master/tree/changelogs/ChangeLog-5.45.md). Ticket #31876 did the upgrade in sage. The PR just adds a doctest.



---

archive/issue_comments_603028.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2021-07-03T05:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603028",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing priority from major to minor.



---

archive/issue_comments_603029.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-07-03T05:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603029",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_603030.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Samuel Leli\u00e8vre\"",
    "created_at": "2021-07-03T05:56:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603030",
    "user": "https://github.com/slel"
}
```

Changing reviewer from "" to "Samuel Lelièvre"



---

archive/issue_comments_603031.json:
```json
{
    "body": "<a id='comment:24'></a>\nLovely.",
    "created_at": "2021-07-03T05:56:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603031",
    "user": "https://github.com/slel"
}
```

<a id='comment:24'></a>
Lovely.



---

archive/issue_comments_603032.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-03T05:56:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603032",
    "user": "https://github.com/slel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_079302.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-07-25T13:25:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30520#event-79302"
}
```



---

archive/issue_comments_603033.json:
```json
{
    "body": "Changing branch from \"public/30520\" to \"69c02357d69915d7d2b97b92bd6a0a16cd14eedc\"",
    "created_at": "2021-07-25T13:25:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603033",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/30520" to "69c02357d69915d7d2b97b92bd6a0a16cd14eedc"



---

archive/issue_comments_603034.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-25T13:25:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30520",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30520#issuecomment-603034",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
