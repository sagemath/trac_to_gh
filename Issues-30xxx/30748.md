# Issue 30748: Convert startup methods to context manager

archive/issues_030511.json:
```json
{
    "assignees": [],
    "body": "<div id=\"comment:0\"></div>\n\nConvert startup methods to context manager, and convert runtime warning about resolved lazy imports to doctest.\n\nThis fixes a bug that prevents importing the main all module (e.g. in the context of pytest - see #33531).\n\nDepends on #31080\n\nCC:  @mkoeppe @fchapoton @tscrim\n\nComponent: **build**\n\nKeywords: **sd111**\n\nAuthor: **Tobias Diez**\n\nBranch/Commit: **[public/build/startupWarning](https://github.com/sagemath/sagetrac-mirror/tree/public/build/startupWarning) @ [`264aa53`](https://github.com/sagemath/sagetrac-mirror/commit/264aa53e8b47dd5ebb3b53d26f8f47c8ff2d5beb)**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/30748_\n\n",
    "created_at": "2020-10-08T21:53:33Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20build",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement",
        "https://github.com/sagemath/sage/labels/needs%20review"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Convert startup methods to context manager",
    "type": "issue",
    "updated_at": "2022-09-19T18:58:47Z",
    "url": "https://github.com/sagemath/sage/issues/30748",
    "user": "https://github.com/tobiasdiez"
}
```
<div id="comment:0"></div>

Convert startup methods to context manager, and convert runtime warning about resolved lazy imports to doctest.

This fixes a bug that prevents importing the main all module (e.g. in the context of pytest - see #33531).

Depends on #31080

CC:  @mkoeppe @fchapoton @tscrim

Component: **build**

Keywords: **sd111**

Author: **Tobias Diez**

Branch/Commit: **[public/build/startupWarning](https://github.com/sagemath/sagetrac-mirror/tree/public/build/startupWarning) @ [`264aa53`](https://github.com/sagemath/sagetrac-mirror/commit/264aa53e8b47dd5ebb3b53d26f8f47c8ff2d5beb)**

_Issue created by migration from https://trac.sagemath.org/ticket/30748_





---

archive/issue_events_420954.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-10-08T21:53:33Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420954"
}
```



---

archive/issue_events_420955.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-10-08T21:53:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "0000b0",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420955"
}
```



---

archive/issue_events_420956.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-10-08T21:53:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420956"
}
```



---

archive/issue_events_420957.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-10-08T21:53:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420957"
}
```



---

archive/issue_events_420958.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-10-08T21:53:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420958"
}
```



---

archive/issue_comments_491282.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nPerhaps the start_startup....finish_startup could be a context manager?",
    "created_at": "2020-10-08T22:14:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491282",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:2" align="right">comment:2</div>

Perhaps the start_startup....finish_startup could be a context manager?



---

archive/issue_comments_491283.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nI like the idea! Where is the startup code located? I couldn't find the global \"import sage.all\". \n\nSecond question, is how LazyImport gets access to the global startup guard. Should this be done via `global`?",
    "created_at": "2020-10-09T07:52:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491283",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:3" align="right">comment:3</div>

I like the idea! Where is the startup code located? I couldn't find the global "import sage.all". 

Second question, is how LazyImport gets access to the global startup guard. Should this be done via `global`?



---

archive/issue_comments_491284.json:
```json
{
    "body": "Changed commit from **[`99ae00c`](https://github.com/sagemath/sagetrac-mirror/commit/99ae00c2ecb1ffcb8895697f34861f05dea840e6)** to **[`11882e5`](https://github.com/sagemath/sagetrac-mirror/commit/11882e531bc80f6397f00d6a5a095b97a9e93804)**",
    "created_at": "2020-10-11T15:28:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491284",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`99ae00c`](https://github.com/sagemath/sagetrac-mirror/commit/99ae00c2ecb1ffcb8895697f34861f05dea840e6)** to **[`11882e5`](https://github.com/sagemath/sagetrac-mirror/commit/11882e531bc80f6397f00d6a5a095b97a9e93804)**



---

archive/issue_comments_491285.json:
```json
{
    "body": "<div id=\"comment:4\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/11882e531bc80f6397f00d6a5a095b97a9e93804\"><code>11882e5</code></a></td><td><code>Use context manager</code></td></tr></table>\n",
    "created_at": "2020-10-11T15:28:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491285",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:4"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/11882e531bc80f6397f00d6a5a095b97a9e93804"><code>11882e5</code></a></td><td><code>Use context manager</code></td></tr></table>




---

archive/issue_comments_491286.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nI've now implemented the idea with the context manager.",
    "created_at": "2020-10-11T15:28:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491286",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:5" align="right">comment:5</div>

I've now implemented the idea with the context manager.



---

archive/issue_events_420959.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "milestone_number": null,
    "milestone_title": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420959"
}
```



---

archive/issue_events_420960.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420960"
}
```



---

archive/issue_comments_491287.json:
```json
{
    "body": "Changed commit from **[`11882e5`](https://github.com/sagemath/sagetrac-mirror/commit/11882e531bc80f6397f00d6a5a095b97a9e93804)** to **[`6a52fbf`](https://github.com/sagemath/sagetrac-mirror/commit/6a52fbf72d83b2488845f4caeb15798ed5a217e7)**",
    "created_at": "2020-11-02T19:53:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491287",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`11882e5`](https://github.com/sagemath/sagetrac-mirror/commit/11882e531bc80f6397f00d6a5a095b97a9e93804)** to **[`6a52fbf`](https://github.com/sagemath/sagetrac-mirror/commit/6a52fbf72d83b2488845f4caeb15798ed5a217e7)**



---

archive/issue_comments_491288.json:
```json
{
    "body": "<div id=\"comment:7\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6a52fbf72d83b2488845f4caeb15798ed5a217e7\"><code>6a52fbf</code></a></td><td><code>Remove lazy import finish startup</code></td></tr></table>\n",
    "created_at": "2020-11-02T19:53:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491288",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:7"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6a52fbf72d83b2488845f4caeb15798ed5a217e7"><code>6a52fbf</code></a></td><td><code>Remove lazy import finish startup</code></td></tr></table>




---

archive/issue_events_420961.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-11-05T18:40:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420961"
}
```



---

archive/issue_events_420962.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-11-05T18:40:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420962"
}
```



---

archive/issue_comments_491289.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nDoctests fail (are not in the correct format), see patchbot output",
    "created_at": "2020-11-05T18:40:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491289",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:8" align="right">comment:8</div>

Doctests fail (are not in the correct format), see patchbot output



---

archive/issue_comments_491290.json:
```json
{
    "body": "<div id=\"comment:9\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f96025e08caeb0b747a391243860c562ebd515a1\"><code>f96025e</code></a></td><td><code>Merge branch 'develop' of git://github.com/sagemath/sage into public/build/startupWarning</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b952bb5661206b5614dfe6117c27021627b19616\"><code>b952bb5</code></a></td><td><code>Fix doctests</code></td></tr></table>\n",
    "created_at": "2020-11-07T20:25:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491290",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:9"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f96025e08caeb0b747a391243860c562ebd515a1"><code>f96025e</code></a></td><td><code>Merge branch 'develop' of git://github.com/sagemath/sage into public/build/startupWarning</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b952bb5661206b5614dfe6117c27021627b19616"><code>b952bb5</code></a></td><td><code>Fix doctests</code></td></tr></table>




---

archive/issue_comments_491291.json:
```json
{
    "body": "Changed commit from **[`6a52fbf`](https://github.com/sagemath/sagetrac-mirror/commit/6a52fbf72d83b2488845f4caeb15798ed5a217e7)** to **[`b952bb5`](https://github.com/sagemath/sagetrac-mirror/commit/b952bb5661206b5614dfe6117c27021627b19616)**",
    "created_at": "2020-11-07T20:25:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491291",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`6a52fbf`](https://github.com/sagemath/sagetrac-mirror/commit/6a52fbf72d83b2488845f4caeb15798ed5a217e7)** to **[`b952bb5`](https://github.com/sagemath/sagetrac-mirror/commit/b952bb5661206b5614dfe6117c27021627b19616)**



---

archive/issue_comments_491292.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nShould be fixed now.",
    "created_at": "2020-11-07T20:26:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491292",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:10" align="right">comment:10</div>

Should be fixed now.



---

archive/issue_events_420963.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-11-07T20:26:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420963"
}
```



---

archive/issue_events_420964.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-11-07T20:26:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420964"
}
```



---

archive/issue_comments_491293.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nPatchbot still complains",
    "created_at": "2020-11-08T00:01:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491293",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:11" align="right">comment:11</div>

Patchbot still complains



---

archive/issue_comments_491294.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nThe pyflakes warnings are not related to my changes, and the additional startup_module is also expected since `startup_guard` is now a new class. So I'm not sure what I can/should do.",
    "created_at": "2020-11-08T13:30:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491294",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:12" align="right">comment:12</div>

The pyflakes warnings are not related to my changes, and the additional startup_module is also expected since `startup_guard` is now a new class. So I'm not sure what I can/should do.



---

archive/issue_events_420965.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-11-09T03:35:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420965"
}
```



---

archive/issue_events_420966.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-11-09T03:35:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420966"
}
```



---

archive/issue_comments_491295.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@mkoeppe](#comment%3A11):\n> Patchbot still complains\n\n... take a look at \"shortlog\" and you will see many errors.",
    "created_at": "2020-11-09T03:35:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491295",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@mkoeppe](#comment%3A11):
> Patchbot still complains

... take a look at "shortlog" and you will see many errors.



---

archive/issue_comments_491296.json:
```json
{
    "body": "Changed commit from **[`b952bb5`](https://github.com/sagemath/sagetrac-mirror/commit/b952bb5661206b5614dfe6117c27021627b19616)** to **[`c6857dd`](https://github.com/sagemath/sagetrac-mirror/commit/c6857ddffa15533845133867febbad1b7f854d4d)**",
    "created_at": "2020-11-09T11:03:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491296",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`b952bb5`](https://github.com/sagemath/sagetrac-mirror/commit/b952bb5661206b5614dfe6117c27021627b19616)** to **[`c6857dd`](https://github.com/sagemath/sagetrac-mirror/commit/c6857ddffa15533845133867febbad1b7f854d4d)**



---

archive/issue_comments_491297.json:
```json
{
    "body": "<div id=\"comment:14\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c6857ddffa15533845133867febbad1b7f854d4d\"><code>c6857dd</code></a></td><td><code>Hopefully fix doctest</code></td></tr></table>\n",
    "created_at": "2020-11-09T11:03:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491297",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:14"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c6857ddffa15533845133867febbad1b7f854d4d"><code>c6857dd</code></a></td><td><code>Hopefully fix doctest</code></td></tr></table>




---

archive/issue_events_420967.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-11-09T11:05:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420967"
}
```



---

archive/issue_events_420968.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-11-09T11:05:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420968"
}
```



---

archive/issue_comments_491298.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nAh thanks, wasn't aware of these links before. Should be fixed now (hopefully).",
    "created_at": "2020-11-09T11:05:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491298",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:15" align="right">comment:15</div>

Ah thanks, wasn't aware of these links before. Should be fixed now (hopefully).



---

archive/issue_comments_491299.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nplease set back to needs review when the doctests succeed",
    "created_at": "2020-11-09T16:58:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491299",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:16" align="right">comment:16</div>

please set back to needs review when the doctests succeed



---

archive/issue_events_420969.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-11-09T16:58:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420969"
}
```



---

archive/issue_events_420970.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-11-09T16:58:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420970"
}
```



---

archive/issue_comments_491300.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nSorry, I thought I've fixed all doctests.\n\nOn a closer inspection, now a lot of doctests are failing because of this warnings `print('Option ``at_startup=True`` for lazy import {0} not needed anymore'.format(self._name))`. I have to admit I don't really understand the purpose of this message, but I guess it should be shown if `lazy_import` is used with `at_startup = true` but sage is actually not loading at this point. If that's the case, then the current output of these doctests seems to be correct now, but I'm not sure why these warnings were not shown before.",
    "created_at": "2020-11-09T21:12:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491300",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:17" align="right">comment:17</div>

Sorry, I thought I've fixed all doctests.

On a closer inspection, now a lot of doctests are failing because of this warnings `print('Option ``at_startup=True`` for lazy import {0} not needed anymore'.format(self._name))`. I have to admit I don't really understand the purpose of this message, but I guess it should be shown if `lazy_import` is used with `at_startup = true` but sage is actually not loading at this point. If that's the case, then the current output of these doctests seems to be correct now, but I'm not sure why these warnings were not shown before.



---

archive/issue_comments_491301.json:
```json
{
    "body": "Changed commit from **[`c6857dd`](https://github.com/sagemath/sagetrac-mirror/commit/c6857ddffa15533845133867febbad1b7f854d4d)** to **[`23da14b`](https://github.com/sagemath/sagetrac-mirror/commit/23da14b03ee782934119597465f8ab1f9db5318f)**",
    "created_at": "2020-11-12T09:39:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491301",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`c6857dd`](https://github.com/sagemath/sagetrac-mirror/commit/c6857ddffa15533845133867febbad1b7f854d4d)** to **[`23da14b`](https://github.com/sagemath/sagetrac-mirror/commit/23da14b03ee782934119597465f8ab1f9db5318f)**



---

archive/issue_comments_491302.json:
```json
{
    "body": "<div id=\"comment:18\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/23da14b03ee782934119597465f8ab1f9db5318f\"><code>23da14b</code></a></td><td><code>Wrap each sage.all import in startup guard</code></td></tr></table>\n",
    "created_at": "2020-11-12T09:39:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491302",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:18"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/23da14b03ee782934119597465f8ab1f9db5318f"><code>23da14b</code></a></td><td><code>Wrap each sage.all import in startup guard</code></td></tr></table>




---

archive/issue_comments_491303.json:
```json
{
    "body": "Changed commit from **[`23da14b`](https://github.com/sagemath/sagetrac-mirror/commit/23da14b03ee782934119597465f8ab1f9db5318f)** to **[`2f4055e`](https://github.com/sagemath/sagetrac-mirror/commit/2f4055e37bea3705a2ab165da42c32363801ddae)**",
    "created_at": "2020-11-12T10:07:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491303",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`23da14b`](https://github.com/sagemath/sagetrac-mirror/commit/23da14b03ee782934119597465f8ab1f9db5318f)** to **[`2f4055e`](https://github.com/sagemath/sagetrac-mirror/commit/2f4055e37bea3705a2ab165da42c32363801ddae)**



---

archive/issue_comments_491304.json:
```json
{
    "body": "<div id=\"comment:19\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2f4055e37bea3705a2ab165da42c32363801ddae\"><code>2f4055e</code></a></td><td><code>Specify that exit was succesful</code></td></tr></table>\n",
    "created_at": "2020-11-12T10:07:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491304",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:19"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2f4055e37bea3705a2ab165da42c32363801ddae"><code>2f4055e</code></a></td><td><code>Specify that exit was succesful</code></td></tr></table>




---

archive/issue_events_420971.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-11-12T11:04:11Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420971"
}
```



---

archive/issue_events_420972.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-11-12T11:04:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420972"
}
```



---

archive/issue_comments_491305.json:
```json
{
    "body": "<div id=\"comment:21\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d4d94a8dec4d876517974bc94de3b83ede14061f\"><code>d4d94a8</code></a></td><td><code>Indeed replace exception by print statement</code></td></tr></table>\n",
    "created_at": "2020-11-12T12:01:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491305",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:21"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d4d94a8dec4d876517974bc94de3b83ede14061f"><code>d4d94a8</code></a></td><td><code>Indeed replace exception by print statement</code></td></tr></table>




---

archive/issue_comments_491306.json:
```json
{
    "body": "Changed commit from **[`2f4055e`](https://github.com/sagemath/sagetrac-mirror/commit/2f4055e37bea3705a2ab165da42c32363801ddae)** to **[`d4d94a8`](https://github.com/sagemath/sagetrac-mirror/commit/d4d94a8dec4d876517974bc94de3b83ede14061f)**",
    "created_at": "2020-11-12T12:01:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491306",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`2f4055e`](https://github.com/sagemath/sagetrac-mirror/commit/2f4055e37bea3705a2ab165da42c32363801ddae)** to **[`d4d94a8`](https://github.com/sagemath/sagetrac-mirror/commit/d4d94a8dec4d876517974bc94de3b83ede14061f)**



---

archive/issue_comments_491307.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nI would appreciate if this could be reviewed relatively soon, as it's blocking my local development (I've to include it in every branch I'm working on). Thanks!",
    "created_at": "2020-12-06T15:03:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491307",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:22" align="right">comment:22</div>

I would appreciate if this could be reviewed relatively soon, as it's blocking my local development (I've to include it in every branch I'm working on). Thanks!



---

archive/issue_comments_491308.json:
```json
{
    "body": "Changed keywords from none to **sd111**",
    "created_at": "2020-12-06T18:17:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491308",
    "user": "https://github.com/mkoeppe"
}
```

Changed keywords from none to **sd111**



---

archive/issue_comments_491309.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nHoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111",
    "created_at": "2020-12-06T18:17:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491309",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:24" align="right">comment:24</div>

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111



---

archive/issue_comments_491310.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nDid you had a chance to look at this ticket during the Sage days?",
    "created_at": "2020-12-18T21:54:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491310",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:25" align="right">comment:25</div>

Did you had a chance to look at this ticket during the Sage days?



---

archive/issue_comments_491311.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nYes, briefly. Overall I'm not convinced by the change to a context manager (which I had suggested). So let's please split this ticket please into a minimal change (error to warning) and defer the change to using a context manager for later consideration.",
    "created_at": "2020-12-19T05:28:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491311",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:26" align="right">comment:26</div>

Yes, briefly. Overall I'm not convinced by the change to a context manager (which I had suggested). So let's please split this ticket please into a minimal change (error to warning) and defer the change to using a context manager for later consideration.



---

archive/issue_comments_491312.json:
```json
{
    "body": "Dependencies: **#31080**",
    "created_at": "2020-12-19T09:08:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491312",
    "user": "https://github.com/tobiasdiez"
}
```

Dependencies: **#31080**



---

archive/issue_comments_491313.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1 @@\n-In #22752 it was introduced that when a lazy import is used during startup, then an RuntimeException is thrown. This leads to problems if you want to use code with lazy imports in a library mode (e.g. in standalone tests or python scripts). To support these use cases, I've degraded the exception to a print statement.\n-\n-Another possible solution would be to also introduce a `start_startup` method that is used at the very beginning of loading sage, and then only consider everything between `start_startup` and `finish_startup` as \"startup\".\n+Convert startup methods to context manager.\n``````\n",
    "created_at": "2020-12-19T09:08:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491313",
    "user": "https://github.com/tobiasdiez"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1 @@
-In #22752 it was introduced that when a lazy import is used during startup, then an RuntimeException is thrown. This leads to problems if you want to use code with lazy imports in a library mode (e.g. in standalone tests or python scripts). To support these use cases, I've degraded the exception to a print statement.
-
-Another possible solution would be to also introduce a `start_startup` method that is used at the very beginning of loading sage, and then only consider everything between `start_startup` and `finish_startup` as "startup".
+Convert startup methods to context manager.
``````




---

archive/issue_comments_491314.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nOk, I've extracted it to #31080. But I would still ask you to also review this ticket, as otherwise I have to subtract it from some of my other tickets (which is not as easy as just pulling the new version of a branch).\n\nWhy don't you like the context manager? I think it's the right tool, as we are managing a local state.",
    "created_at": "2020-12-19T09:08:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491314",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:27" align="right">comment:27</div>

Ok, I've extracted it to #31080. But I would still ask you to also review this ticket, as otherwise I have to subtract it from some of my other tickets (which is not as easy as just pulling the new version of a branch).

Why don't you like the context manager? I think it's the right tool, as we are managing a local state.



---

archive/issue_events_420973.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-12-19T09:08:32Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "title_is": "Convert startup methods to context manager",
    "title_was": "Replace startup exception by warning",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420973"
}
```



---

archive/issue_comments_491315.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nMaking changes always has a cost, and the benefit here is not clear.\n\nWe only have a small number of developers who know about the details of the issues with circular imports in sage. Changing code makes it harder for them to contribute later.",
    "created_at": "2020-12-19T17:42:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491315",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:29" align="right">comment:29</div>

Making changes always has a cost, and the benefit here is not clear.

We only have a small number of developers who know about the details of the issues with circular imports in sage. Changing code makes it harder for them to contribute later.



---

archive/issue_comments_491316.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nReplying to [@tobiasdiez](#comment%3A27):\n> Why don't you like the context manager? I think it's the right tool, as we are managing a local state.\n\nI also thought it could be the right tool -- but I think it's best to revisit it in the context of the modularization of the core of sagelib (tickets such as #29865)",
    "created_at": "2020-12-19T18:19:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491316",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:30" align="right">comment:30</div>

Replying to [@tobiasdiez](#comment%3A27):
> Why don't you like the context manager? I think it's the right tool, as we are managing a local state.

I also thought it could be the right tool -- but I think it's best to revisit it in the context of the modularization of the core of sagelib (tickets such as #29865)



---

archive/issue_comments_491317.json:
```json
{
    "body": "<div id=\"comment:31\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a462713ac1fcb11cee4df5ff845615013c2b2355\"><code>a462713</code></a></td><td><code>Verify that no imports are resolved by doctest</code></td></tr></table>\n",
    "created_at": "2020-12-19T21:25:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491317",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:31"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a462713ac1fcb11cee4df5ff845615013c2b2355"><code>a462713</code></a></td><td><code>Verify that no imports are resolved by doctest</code></td></tr></table>




---

archive/issue_comments_491318.json:
```json
{
    "body": "Changed commit from **[`d4d94a8`](https://github.com/sagemath/sagetrac-mirror/commit/d4d94a8dec4d876517974bc94de3b83ede14061f)** to **[`a462713`](https://github.com/sagemath/sagetrac-mirror/commit/a462713ac1fcb11cee4df5ff845615013c2b2355)**",
    "created_at": "2020-12-19T21:25:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491318",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`d4d94a8`](https://github.com/sagemath/sagetrac-mirror/commit/d4d94a8dec4d876517974bc94de3b83ede14061f)** to **[`a462713`](https://github.com/sagemath/sagetrac-mirror/commit/a462713ac1fcb11cee4df5ff845615013c2b2355)**



---

archive/issue_comments_491319.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nI've thought about this again and realized that one actually would like to neither throw an error nor print an error message. Instead one should try to catch the resolved import already during development time. Thus, I've now implemented it as a doctest that fails as soon as there are resolved imports during startup.\n\nWhat do you think?",
    "created_at": "2020-12-19T21:27:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491319",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:32" align="right">comment:32</div>

I've thought about this again and realized that one actually would like to neither throw an error nor print an error message. Instead one should try to catch the resolved import already during development time. Thus, I've now implemented it as a doctest that fails as soon as there are resolved imports during startup.

What do you think?



---

archive/issue_comments_491320.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nI think I agree but this is orthogonal to the conversion to a context manager -- so shouldn't this be done in #31080 instead?",
    "created_at": "2020-12-19T21:47:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491320",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:33" align="right">comment:33</div>

I think I agree but this is orthogonal to the conversion to a context manager -- so shouldn't this be done in #31080 instead?



---

archive/issue_comments_491321.json:
```json
{
    "body": "Changed commit from **[`a462713`](https://github.com/sagemath/sagetrac-mirror/commit/a462713ac1fcb11cee4df5ff845615013c2b2355)** to **[`1b597a0`](https://github.com/sagemath/sagetrac-mirror/commit/1b597a0e76511747c26ab02a39fe12eb9159fd14)**",
    "created_at": "2020-12-20T11:34:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491321",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`a462713`](https://github.com/sagemath/sagetrac-mirror/commit/a462713ac1fcb11cee4df5ff845615013c2b2355)** to **[`1b597a0`](https://github.com/sagemath/sagetrac-mirror/commit/1b597a0e76511747c26ab02a39fe12eb9159fd14)**



---

archive/issue_comments_491322.json:
```json
{
    "body": "<div id=\"comment:34\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1b597a0e76511747c26ab02a39fe12eb9159fd14\"><code>1b597a0</code></a></td><td><code>Fix syntax</code></td></tr></table>\n",
    "created_at": "2020-12-20T11:34:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491322",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:34"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1b597a0e76511747c26ab02a39fe12eb9159fd14"><code>1b597a0</code></a></td><td><code>Fix syntax</code></td></tr></table>




---

archive/issue_comments_491323.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nI needed the context manager to write the tests.\n\n> but I think it's best to revisit it in the context of the modularization of the core of sagelib (tickets such as #29865) \n\nWhat does the context manager has to do with modularization? It sets only the IS_STARTUP flag...",
    "created_at": "2020-12-20T11:35:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491323",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:35" align="right">comment:35</div>

I needed the context manager to write the tests.

> but I think it's best to revisit it in the context of the modularization of the core of sagelib (tickets such as #29865) 

What does the context manager has to do with modularization? It sets only the IS_STARTUP flag...



---

archive/issue_comments_491324.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nHow is the startup phase defined?",
    "created_at": "2020-12-20T18:18:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491324",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:36" align="right">comment:36</div>

How is the startup phase defined?



---

archive/issue_comments_491325.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nIt's essentially equivalent to \"during the import of sage.all\", but not quite. There are a few imports in sage.all that are are outside of the startup phase (and I didn't change anything there). The new context manger makes this quite clear: startup phase = everything between enter/exit of the startup_guard (or, equivalently, within the `with startup_guard` block).",
    "created_at": "2020-12-20T19:36:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491325",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:37" align="right">comment:37</div>

It's essentially equivalent to "during the import of sage.all", but not quite. There are a few imports in sage.all that are are outside of the startup phase (and I didn't change anything there). The new context manger makes this quite clear: startup phase = everything between enter/exit of the startup_guard (or, equivalently, within the `with startup_guard` block).



---

archive/issue_comments_491326.json:
```json
{
    "body": "Changed commit from **[`1b597a0`](https://github.com/sagemath/sagetrac-mirror/commit/1b597a0e76511747c26ab02a39fe12eb9159fd14)** to **[`c581af7`](https://github.com/sagemath/sagetrac-mirror/commit/c581af7263b2f5164d1e613e368dc6612f638c33)**",
    "created_at": "2020-12-20T19:39:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491326",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`1b597a0`](https://github.com/sagemath/sagetrac-mirror/commit/1b597a0e76511747c26ab02a39fe12eb9159fd14)** to **[`c581af7`](https://github.com/sagemath/sagetrac-mirror/commit/c581af7263b2f5164d1e613e368dc6612f638c33)**



---

archive/issue_comments_491327.json:
```json
{
    "body": "<div id=\"comment:38\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c581af7263b2f5164d1e613e368dc6612f638c33\"><code>c581af7</code></a></td><td><code>Fix syntax error</code></td></tr></table>\n",
    "created_at": "2020-12-20T19:39:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491327",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:38"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c581af7263b2f5164d1e613e368dc6612f638c33"><code>c581af7</code></a></td><td><code>Fix syntax error</code></td></tr></table>




---

archive/issue_comments_491328.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nReplying to [@tobiasdiez](#comment%3A37):\n> It's essentially equivalent to \"during the import of sage.all\", but not quite. There are a few imports in sage.all that are are outside of the startup phase (and I didn't change anything there). The new context manger makes this quite clear: startup phase = everything between enter/exit of the startup_guard (or, equivalently, within the `with startup_guard` block).\n\nWell, the concept of `sage.all` will certainly be affected by the modularization...",
    "created_at": "2020-12-20T19:49:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491328",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:39" align="right">comment:39</div>

Replying to [@tobiasdiez](#comment%3A37):
> It's essentially equivalent to "during the import of sage.all", but not quite. There are a few imports in sage.all that are are outside of the startup phase (and I didn't change anything there). The new context manger makes this quite clear: startup phase = everything between enter/exit of the startup_guard (or, equivalently, within the `with startup_guard` block).

Well, the concept of `sage.all` will certainly be affected by the modularization...



---

archive/issue_comments_491329.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nSure, but in a modularized setting you probably don't need this check since it's only purpose right now is to make sure that lazy imports are indeed lazy and not already resolved during startup. If that's the case for sage.all, then it's also the case for sub-modules.\n\nIn either case, the startup context manager will make it easy to define also other parts as startup in a modularized setting in case this is necessary.",
    "created_at": "2020-12-20T19:56:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491329",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:40" align="right">comment:40</div>

Sure, but in a modularized setting you probably don't need this check since it's only purpose right now is to make sure that lazy imports are indeed lazy and not already resolved during startup. If that's the case for sage.all, then it's also the case for sub-modules.

In either case, the startup context manager will make it easy to define also other parts as startup in a modularized setting in case this is necessary.



---

archive/issue_comments_491330.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nWithout code that's a little bit too vague, which is why it's too early to do this ticket. In particular, it's unclear whether a single flag / context manager can really do the job for several modules.",
    "created_at": "2020-12-20T20:04:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491330",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:41" align="right">comment:41</div>

Without code that's a little bit too vague, which is why it's too early to do this ticket. In particular, it's unclear whether a single flag / context manager can really do the job for several modules.



---

archive/issue_comments_491331.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nI agree, but the new code is still an improvement over the current one in my opinion (which used a custom-build context manager in some sense). So can we please not hold this ticket off, just because there might be possible changes in the future...\n\nMoreover, the startup manager can easily be extended to handle multiple startup contexts by passing the context name as an argument to the `startup` method, including neasting etc because we use a context manager (which is not easily possible with the current code).",
    "created_at": "2020-12-20T20:34:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491331",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:42" align="right">comment:42</div>

I agree, but the new code is still an improvement over the current one in my opinion (which used a custom-build context manager in some sense). So can we please not hold this ticket off, just because there might be possible changes in the future...

Moreover, the startup manager can easily be extended to handle multiple startup contexts by passing the context name as an argument to the `startup` method, including neasting etc because we use a context manager (which is not easily possible with the current code).



---

archive/issue_comments_491332.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nReplying to [@tobiasdiez](#comment%3A35):\n> I needed the context manager to write the tests.\n\nI don't think so, the same thing can be done in the original code",
    "created_at": "2020-12-20T20:41:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491332",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:43" align="right">comment:43</div>

Replying to [@tobiasdiez](#comment%3A35):
> I needed the context manager to write the tests.

I don't think so, the same thing can be done in the original code



---

archive/issue_comments_491333.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nBy the way, I would guess that also the print message \n\n```\n   print(f\"Option ``at_startup=True`` for lazy import {self._name} not needed anymore\"`\n```\nshould be handled in the doctest as well instead of printing at runtime.",
    "created_at": "2020-12-20T20:47:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491333",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:44" align="right">comment:44</div>

By the way, I would guess that also the print message 

```
   print(f"Option ``at_startup=True`` for lazy import {self._name} not needed anymore"`
```
should be handled in the doctest as well instead of printing at runtime.



---

archive/issue_comments_491334.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nReplying to [@mkoeppe](#comment%3A43):\n> Replying to [@tobiasdiez](#comment%3A35):\n> > I needed the context manager to write the tests.\n> \n> \n> I don't think so, the same thing can be done in the original code\n\nI was not able to, but you are invited to try (although its more time effective to just review this ticket...).",
    "created_at": "2020-12-20T20:49:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491334",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:45" align="right">comment:45</div>

Replying to [@mkoeppe](#comment%3A43):
> Replying to [@tobiasdiez](#comment%3A35):
> > I needed the context manager to write the tests.
> 
> 
> I don't think so, the same thing can be done in the original code

I was not able to, but you are invited to try (although its more time effective to just review this ticket...).



---

archive/issue_comments_491335.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nReplying to [@mkoeppe](#comment%3A44):\n> By the way, I would guess that also the print message \n> \n> ```\n>    print(f\"Option ``at_startup=True`` for lazy import {self._name} not needed anymore\"`\n> ```\n> should be handled in the doctest as well instead of printing at runtime.\n\nGood point, something for a followup ticket.",
    "created_at": "2020-12-20T20:50:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491335",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:46" align="right">comment:46</div>

Replying to [@mkoeppe](#comment%3A44):
> By the way, I would guess that also the print message 
> 
> ```
>    print(f"Option ``at_startup=True`` for lazy import {self._name} not needed anymore"`
> ```
> should be handled in the doctest as well instead of printing at runtime.

Good point, something for a followup ticket.



---

archive/issue_comments_491336.json:
```json
{
    "body": "<div id=\"comment:47\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7647fc2b97359689c059fb3408d06710948c4f1e\"><code>7647fc2</code></a></td><td><code>Merge branch 'develop' of git://github.com/sagemath/sage into public/build/startupWarning</code></td></tr></table>\n",
    "created_at": "2020-12-29T10:24:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491336",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:47"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7647fc2b97359689c059fb3408d06710948c4f1e"><code>7647fc2</code></a></td><td><code>Merge branch 'develop' of git://github.com/sagemath/sage into public/build/startupWarning</code></td></tr></table>




---

archive/issue_comments_491337.json:
```json
{
    "body": "Changed commit from **[`c581af7`](https://github.com/sagemath/sagetrac-mirror/commit/c581af7263b2f5164d1e613e368dc6612f638c33)** to **[`7647fc2`](https://github.com/sagemath/sagetrac-mirror/commit/7647fc2b97359689c059fb3408d06710948c4f1e)**",
    "created_at": "2020-12-29T10:24:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491337",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`c581af7`](https://github.com/sagemath/sagetrac-mirror/commit/c581af7263b2f5164d1e613e368dc6612f638c33)** to **[`7647fc2`](https://github.com/sagemath/sagetrac-mirror/commit/7647fc2b97359689c059fb3408d06710948c4f1e)**



---

archive/issue_comments_491338.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-Convert startup methods to context manager.\n+Convert startup methods to context manager, and convert runtime warning about resolved lazy imports to doctest.\n``````\n",
    "created_at": "2020-12-29T10:25:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491338",
    "user": "https://github.com/tobiasdiez"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1 @@
-Convert startup methods to context manager.
+Convert startup methods to context manager, and convert runtime warning about resolved lazy imports to doctest.
``````




---

archive/issue_comments_491339.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\nHow should we proceed with this ticket?",
    "created_at": "2021-01-15T12:19:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491339",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:49" align="right">comment:49</div>

How should we proceed with this ticket?



---

archive/issue_comments_491340.json:
```json
{
    "body": "<div id=\"comment:50\" align=\"right\">comment:50</div>\n\nAs previously suggested, we defer it until the design constraints from modularization become clearer.",
    "created_at": "2021-01-15T18:25:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491340",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:50" align="right">comment:50</div>

As previously suggested, we defer it until the design constraints from modularization become clearer.



---

archive/issue_events_420974.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-15T18:25:44Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420974"
}
```



---

archive/issue_events_420975.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-15T18:25:44Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420975"
}
```



---

archive/issue_comments_491341.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nWhat's the status of the modularization? Any new input that is relevant for this PR?",
    "created_at": "2021-05-18T07:41:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491341",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:51" align="right">comment:51</div>

What's the status of the modularization? Any new input that is relevant for this PR?



---

archive/issue_events_420976.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420976"
}
```



---

archive/issue_events_420977.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T00:44:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420977"
}
```



---

archive/issue_comments_491342.json:
```json
{
    "body": "<div id=\"comment:52\" align=\"right\">comment:52</div>\n\nSetting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491342",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:52" align="right">comment:52</div>

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_events_420978.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2021-11-30T00:24:20Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420978"
}
```



---

archive/issue_events_420979.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2021-11-30T00:24:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420979"
}
```



---

archive/issue_events_420980.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-11-30T00:59:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420980"
}
```



---

archive/issue_events_420981.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-11-30T00:59:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420981"
}
```



---

archive/issue_comments_491343.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">comment:54</div>\n\nWe now have a number of small, medium, and large distributions (see #29705 for distribution names in boldface, in particular on tickets that need review), so the question of how to organize startup could be investigated with concrete examples.",
    "created_at": "2021-11-30T00:59:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491343",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:54" align="right">comment:54</div>

We now have a number of small, medium, and large distributions (see #29705 for distribution names in boldface, in particular on tickets that need review), so the question of how to organize startup could be investigated with concrete examples.



---

archive/issue_comments_491344.json:
```json
{
    "body": "Changed commit from **[`7647fc2`](https://github.com/sagemath/sagetrac-mirror/commit/7647fc2b97359689c059fb3408d06710948c4f1e)** to **[`87cba2d`](https://github.com/sagemath/sagetrac-mirror/commit/87cba2d211c112741350d60a4d495b1de02f5c97)**",
    "created_at": "2021-11-30T14:51:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491344",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`7647fc2`](https://github.com/sagemath/sagetrac-mirror/commit/7647fc2b97359689c059fb3408d06710948c4f1e)** to **[`87cba2d`](https://github.com/sagemath/sagetrac-mirror/commit/87cba2d211c112741350d60a4d495b1de02f5c97)**



---

archive/issue_comments_491345.json:
```json
{
    "body": "<div id=\"comment:55\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9ed6d2c21298aee4f18e3d649590e1e322998e9e\"><code>9ed6d2c</code></a></td><td><code>Merge branch 'develop' of https://github.com/sagemath/sage into public/build/startupWarning</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/87cba2d211c112741350d60a4d495b1de02f5c97\"><code>87cba2d</code></a></td><td><code>Remove unnecessary code in doctest forker</code></td></tr></table>\n",
    "created_at": "2021-11-30T14:51:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491345",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:55"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9ed6d2c21298aee4f18e3d649590e1e322998e9e"><code>9ed6d2c</code></a></td><td><code>Merge branch 'develop' of https://github.com/sagemath/sage into public/build/startupWarning</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/87cba2d211c112741350d60a4d495b1de02f5c97"><code>87cba2d</code></a></td><td><code>Remove unnecessary code in doctest forker</code></td></tr></table>




---

archive/issue_comments_491346.json:
```json
{
    "body": "Changed commit from **[`87cba2d`](https://github.com/sagemath/sagetrac-mirror/commit/87cba2d211c112741350d60a4d495b1de02f5c97)** to **[`c34c014`](https://github.com/sagemath/sagetrac-mirror/commit/c34c014645f04987796df7134c158dd8a5b05486)**",
    "created_at": "2021-11-30T15:44:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491346",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`87cba2d`](https://github.com/sagemath/sagetrac-mirror/commit/87cba2d211c112741350d60a4d495b1de02f5c97)** to **[`c34c014`](https://github.com/sagemath/sagetrac-mirror/commit/c34c014645f04987796df7134c158dd8a5b05486)**



---

archive/issue_comments_491347.json:
```json
{
    "body": "<div id=\"comment:56\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8421f6b4a3bb64521460cd0213289d17800fb891\"><code>8421f6b</code></a></td><td><code>Fix test</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c34c014645f04987796df7134c158dd8a5b05486\"><code>c34c014</code></a></td><td><code>Use three states to represent startup</code></td></tr></table>\n",
    "created_at": "2021-11-30T15:44:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491347",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:56"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8421f6b4a3bb64521460cd0213289d17800fb891"><code>8421f6b</code></a></td><td><code>Fix test</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c34c014645f04987796df7134c158dd8a5b05486"><code>c34c014</code></a></td><td><code>Use three states to represent startup</code></td></tr></table>




---

archive/issue_comments_491348.json:
```json
{
    "body": "<div id=\"comment:57\" align=\"right\">comment:57</div>\n\nAs far as I can see (please correct me if I'm wrong), the other (distribution) packages don't use `sage.all` and thus shouldn't be affected by the changes to the startup guard.\n\nI've now introduced a third \"startup state\" (Uninitialized) that represents that sage is used without `sage.all` (or before `sage.all` is imported), e.g. in a modularized environment. This makes it possible to fix #32619 in a more ergonomic way.\n\nFrom my point of view this is ready for review.",
    "created_at": "2021-11-30T16:18:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491348",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:57" align="right">comment:57</div>

As far as I can see (please correct me if I'm wrong), the other (distribution) packages don't use `sage.all` and thus shouldn't be affected by the changes to the startup guard.

I've now introduced a third "startup state" (Uninitialized) that represents that sage is used without `sage.all` (or before `sage.all` is imported), e.g. in a modularized environment. This makes it possible to fix #32619 in a more ergonomic way.

From my point of view this is ready for review.



---

archive/issue_events_420982.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2021-11-30T16:18:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420982"
}
```



---

archive/issue_events_420983.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2021-11-30T16:18:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420983"
}
```



---

archive/issue_comments_491349.json:
```json
{
    "body": "<div id=\"comment:58\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/339fd660b7d6dfefb9527bc524ea9c71aa57465e\"><code>339fd66</code></a></td><td><code>Fix typo</code></td></tr></table>\n",
    "created_at": "2021-11-30T16:29:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491349",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:58"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/339fd660b7d6dfefb9527bc524ea9c71aa57465e"><code>339fd66</code></a></td><td><code>Fix typo</code></td></tr></table>




---

archive/issue_comments_491350.json:
```json
{
    "body": "Changed commit from **[`c34c014`](https://github.com/sagemath/sagetrac-mirror/commit/c34c014645f04987796df7134c158dd8a5b05486)** to **[`339fd66`](https://github.com/sagemath/sagetrac-mirror/commit/339fd660b7d6dfefb9527bc524ea9c71aa57465e)**",
    "created_at": "2021-11-30T16:29:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491350",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`c34c014`](https://github.com/sagemath/sagetrac-mirror/commit/c34c014645f04987796df7134c158dd8a5b05486)** to **[`339fd66`](https://github.com/sagemath/sagetrac-mirror/commit/339fd660b7d6dfefb9527bc524ea9c71aa57465e)**



---

archive/issue_comments_491351.json:
```json
{
    "body": "<div id=\"comment:59\" align=\"right\">comment:59</div>\n\nThis looks like a good solution. I'll take a closer look soon and test it with the modularized distributions",
    "created_at": "2021-11-30T18:31:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491351",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:59" align="right">comment:59</div>

This looks like a good solution. I'll take a closer look soon and test it with the modularized distributions



---

archive/issue_comments_491352.json:
```json
{
    "body": "<div id=\"comment:60\" align=\"right\">comment:60</div>\n\nReplying to [@mkoeppe](#comment%3A59):\n> This looks like a good solution. I'll take a closer look soon and test it with the modularized distributions\n\nDid you already found the time to test it?",
    "created_at": "2021-12-28T18:00:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491352",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:60" align="right">comment:60</div>

Replying to [@mkoeppe](#comment%3A59):
> This looks like a good solution. I'll take a closer look soon and test it with the modularized distributions

Did you already found the time to test it?



---

archive/issue_comments_491353.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n Convert startup methods to context manager, and convert runtime warning about resolved lazy imports to doctest.\n+\n+This fixes a bug that prevents importing the main all module (e.g. in the context of pytest).\n``````\n",
    "created_at": "2022-03-20T16:53:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491353",
    "user": "https://github.com/tobiasdiez"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,3 @@
 Convert startup methods to context manager, and convert runtime warning about resolved lazy imports to doctest.
+
+This fixes a bug that prevents importing the main all module (e.g. in the context of pytest).
``````




---

archive/issue_comments_491354.json:
```json
{
    "body": "<div id=\"comment:62\" align=\"right\">comment:62</div>\n\nI have been testing this for a while now with #32432, and there are no problems. (As you point out in [comment:57](#comment%3A57), it's not really being invoked in this context). On the other hand, I don't have additional evidence yet that this change going in a useful direction for modularization.",
    "created_at": "2022-03-20T17:01:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491354",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:62" align="right">comment:62</div>

I have been testing this for a while now with #32432, and there are no problems. (As you point out in [comment:57](#comment%3A57), it's not really being invoked in this context). On the other hand, I don't have additional evidence yet that this change going in a useful direction for modularization.



---

archive/issue_comments_491355.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,3 @@\n Convert startup methods to context manager, and convert runtime warning about resolved lazy imports to doctest.\n \n-This fixes a bug that prevents importing the main all module (e.g. in the context of pytest).\n+This fixes a bug that prevents importing the main all module (e.g. in the context of pytest - see #33531).\n``````\n",
    "created_at": "2022-03-20T17:06:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491355",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,3 @@
 Convert startup methods to context manager, and convert runtime warning about resolved lazy imports to doctest.
 
-This fixes a bug that prevents importing the main all module (e.g. in the context of pytest).
+This fixes a bug that prevents importing the main all module (e.g. in the context of pytest - see #33531).
``````




---

archive/issue_comments_491356.json:
```json
{
    "body": "<div id=\"comment:64\" align=\"right\">comment:64</div>\n\nI confirm that it fixes the error shown by `./sage -t src/sage/all.py` noted in the ticket description of #33531 (the error is replaced by 21 pytest warnings).\n\nTests pass.",
    "created_at": "2022-03-20T17:16:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491356",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:64" align="right">comment:64</div>

I confirm that it fixes the error shown by `./sage -t src/sage/all.py` noted in the ticket description of #33531 (the error is replaced by 21 pytest warnings).

Tests pass.



---

archive/issue_comments_491357.json:
```json
{
    "body": "<div id=\"comment:65\" align=\"right\">comment:65</div>\n\nI think having an explicit start and endpoint for the resolution of the lazy imports is already an improvement as it converts the state management to a local thing, removing the \"external\" component.\n\nAlso the design should be flexible enough to incorporate new needs that may arise in the context of modularization.",
    "created_at": "2022-03-20T17:17:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491357",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:65" align="right">comment:65</div>

I think having an explicit start and endpoint for the resolution of the lazy imports is already an improvement as it converts the state management to a local thing, removing the "external" component.

Also the design should be flexible enough to incorporate new needs that may arise in the context of modularization.



---

archive/issue_comments_491358.json:
```json
{
    "body": "<div id=\"comment:66\" align=\"right\">comment:66</div>\n\nReplying to [@tobiasdiez](#comment%3A65):\n> I think having an explicit start and endpoint for the resolution of the lazy imports is already an improvement\n\nYes, it's good that there's a start now.",
    "created_at": "2022-03-20T17:19:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491358",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:66" align="right">comment:66</div>

Replying to [@tobiasdiez](#comment%3A65):
> I think having an explicit start and endpoint for the resolution of the lazy imports is already an improvement

Yes, it's good that there's a start now.



---

archive/issue_comments_491359.json:
```json
{
    "body": "<div id=\"comment:67\" align=\"right\">comment:67</div>\n\nBut I don't understand the semantics of `startup`. Why would it allow going from FINISHED back to RUNNING?",
    "created_at": "2022-03-20T17:20:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491359",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:67" align="right">comment:67</div>

But I don't understand the semantics of `startup`. Why would it allow going from FINISHED back to RUNNING?



---

archive/issue_comments_491360.json:
```json
{
    "body": "<div id=\"comment:68\" align=\"right\">comment:68</div>\n\nThat's needed due to the nature of how the doctests are invoked. At the beginning sage/all is imported, so the state is already \"FINISHED\". In order to write a meaningful test, one has to be able to reset this state (this is similar to the old test_fake_startup method).",
    "created_at": "2022-03-20T17:25:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491360",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:68" align="right">comment:68</div>

That's needed due to the nature of how the doctests are invoked. At the beginning sage/all is imported, so the state is already "FINISHED". In order to write a meaningful test, one has to be able to reset this state (this is similar to the old test_fake_startup method).



---

archive/issue_comments_491361.json:
```json
{
    "body": "<div id=\"comment:69\" align=\"right\">comment:69</div>\n\nI think I would prefer it if this only-for-doctesting behavior was invoked explicitly. I think in normal operation, it should just remain in FINISHED.",
    "created_at": "2022-03-20T17:35:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491361",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:69" align="right">comment:69</div>

I think I would prefer it if this only-for-doctesting behavior was invoked explicitly. I think in normal operation, it should just remain in FINISHED.



---

archive/issue_comments_491362.json:
```json
{
    "body": "<div id=\"comment:70\" align=\"right\">comment:70</div>\n\nAnd actually I don't think `startup_guard` should be a new separate module.",
    "created_at": "2022-03-20T17:38:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491362",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:70" align="right">comment:70</div>

And actually I don't think `startup_guard` should be a new separate module.



---

archive/issue_comments_491363.json:
```json
{
    "body": "<div id=\"comment:71\" align=\"right\">comment:71</div>\n\nReplying to [@mkoeppe](#comment%3A69):\n> I think I would prefer it if this only-for-doctesting behavior was invoked explicitly. I think in normal operation, it should just remain in FINISHED.\n\nI'm not sure, but what output would you expect from\n\n```\nwith startup_guard.startup():\n   print(startup_guard.startup_state)\n\nprint(startup_guard.startup_state)\n\nwith startup_guard.startup():\n   print(startup_guard.startup_state)\n```\nSince this is now a proper guard, for me \"RUNNING, FINISHED, RUNNING\" feels correctly.",
    "created_at": "2022-03-20T17:44:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491363",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:71" align="right">comment:71</div>

Replying to [@mkoeppe](#comment%3A69):
> I think I would prefer it if this only-for-doctesting behavior was invoked explicitly. I think in normal operation, it should just remain in FINISHED.

I'm not sure, but what output would you expect from

```
with startup_guard.startup():
   print(startup_guard.startup_state)

print(startup_guard.startup_state)

with startup_guard.startup():
   print(startup_guard.startup_state)
```
Since this is now a proper guard, for me "RUNNING, FINISHED, RUNNING" feels correctly.



---

archive/issue_comments_491364.json:
```json
{
    "body": "<div id=\"comment:72\" align=\"right\">comment:72</div>\n\nReplying to [@mkoeppe](#comment%3A70):\n> And actually I don't think `startup_guard` should be a new separate module. \n\nWhere would you put it?",
    "created_at": "2022-03-20T17:45:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491364",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:72" align="right">comment:72</div>

Replying to [@mkoeppe](#comment%3A70):
> And actually I don't think `startup_guard` should be a new separate module. 

Where would you put it?



---

archive/issue_comments_491365.json:
```json
{
    "body": "<div id=\"comment:73\" align=\"right\">comment:73</div>\n\nWhere it was - lazy_import.",
    "created_at": "2022-03-20T17:52:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491365",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:73" align="right">comment:73</div>

Where it was - lazy_import.



---

archive/issue_comments_491366.json:
```json
{
    "body": "<div id=\"comment:74\" align=\"right\">comment:74</div>\n\nReplying to [@tobiasdiez](#comment%3A71):\n> Since this is now a proper guard, for me \"RUNNING, FINISHED, RUNNING\" feels correctly.\n\nIt makes no sense to discuss this abstractly, without reference to what the guard protects.",
    "created_at": "2022-03-20T17:55:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491366",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:74" align="right">comment:74</div>

Replying to [@tobiasdiez](#comment%3A71):
> Since this is now a proper guard, for me "RUNNING, FINISHED, RUNNING" feels correctly.

It makes no sense to discuss this abstractly, without reference to what the guard protects.



---

archive/issue_comments_491367.json:
```json
{
    "body": "<div id=\"comment:75\" align=\"right\">comment:75</div>\n\nReplying to [@mkoeppe](#comment%3A73):\n> Where it was - lazy_import.\n\nI guess these points are connected. For me the guard is a general \"we in the progress of starting sage\", which is then used by the lazy import feature to decide how imports during the startup are handled. But the startup guard could for example also used to control logging or other things.",
    "created_at": "2022-03-20T18:02:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491367",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:75" align="right">comment:75</div>

Replying to [@mkoeppe](#comment%3A73):
> Where it was - lazy_import.

I guess these points are connected. For me the guard is a general "we in the progress of starting sage", which is then used by the lazy import feature to decide how imports during the startup are handled. But the startup guard could for example also used to control logging or other things.



---

archive/issue_comments_491368.json:
```json
{
    "body": "<div id=\"comment:76\" align=\"right\">comment:76</div>\n\nReplying to [@mkoeppe](#comment%3A74):\n> Replying to [@tobiasdiez](#comment%3A71):\n> > Since this is now a proper guard, for me \"RUNNING, FINISHED, RUNNING\" feels correctly.\n> \n> \n> It makes no sense to discuss this abstractly, without reference to what the guard protects.\n\nThat feels like an abstract answer (a bit of pun intended). Of course the startup guard signals that sage is starting (or if you want that lazy imports are lazy). So with that, what is the expected behavior of\n\n```\nwith startup_guard.startup():\n   lazy_import(xyz1)\n\nlazy_import(xyz2)\n\nwith startup_guard.startup():\n   lazy_import(xyz3)\n```\n\nI would say only xyz2 should be imported directly, while 1 and 3 are only imported lazily.",
    "created_at": "2022-03-20T18:05:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491368",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:76" align="right">comment:76</div>

Replying to [@mkoeppe](#comment%3A74):
> Replying to [@tobiasdiez](#comment%3A71):
> > Since this is now a proper guard, for me "RUNNING, FINISHED, RUNNING" feels correctly.
> 
> 
> It makes no sense to discuss this abstractly, without reference to what the guard protects.

That feels like an abstract answer (a bit of pun intended). Of course the startup guard signals that sage is starting (or if you want that lazy imports are lazy). So with that, what is the expected behavior of

```
with startup_guard.startup():
   lazy_import(xyz1)

lazy_import(xyz2)

with startup_guard.startup():
   lazy_import(xyz3)
```

I would say only xyz2 should be imported directly, while 1 and 3 are only imported lazily.



---

archive/issue_comments_491369.json:
```json
{
    "body": "<div id=\"comment:77\" align=\"right\">comment:77</div>\n\nReplying to [@tobiasdiez](#comment%3A76):\n> I would say only xyz2 should be imported directly, while 1 and 3 are only imported lazily. \n\nNo, that's absolutely not what the intended semantics is. lazy imports are always lazy.",
    "created_at": "2022-03-20T18:10:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491369",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:77" align="right">comment:77</div>

Replying to [@tobiasdiez](#comment%3A76):
> I would say only xyz2 should be imported directly, while 1 and 3 are only imported lazily. 

No, that's absolutely not what the intended semantics is. lazy imports are always lazy.



---

archive/issue_events_420984.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-20T18:12:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420984"
}
```



---

archive/issue_events_420985.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-20T18:12:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420985"
}
```



---

archive/issue_comments_491370.json:
```json
{
    "body": "<div id=\"comment:79\" align=\"right\">comment:79</div>\n\nReplying to [@tobiasdiez](#comment%3A75):\n> For me the guard is a general \"we in the progress of starting sage\", which is then used by the lazy import feature to decide how imports during the startup are handled. But the startup guard could for example also used to control logging or other things.\n\nI'd say this is speculative/premature abstraction. It's first necessary to capture the intended semantics for the actual use case.",
    "created_at": "2022-03-20T18:23:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491370",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:79" align="right">comment:79</div>

Replying to [@tobiasdiez](#comment%3A75):
> For me the guard is a general "we in the progress of starting sage", which is then used by the lazy import feature to decide how imports during the startup are handled. But the startup guard could for example also used to control logging or other things.

I'd say this is speculative/premature abstraction. It's first necessary to capture the intended semantics for the actual use case.



---

archive/issue_comments_491371.json:
```json
{
    "body": "<div id=\"comment:80\" align=\"right\">comment:80</div>\n\nReplying to [@mkoeppe](#comment%3A79):\n> Replying to [@tobiasdiez](#comment%3A75):\n> > For me the guard is a general \"we in the progress of starting sage\", which is then used by the lazy import feature to decide how imports during the startup are handled. But the startup guard could for example also used to control logging or other things.\n> \n> \n> I'd say this is speculative/premature abstraction. It's first necessary to capture the intended semantics for the actual use case.\n\nThe code above was of course only meant schematically. Read \"what should be imported directly\" as \"what is the output of _get_imports_resolved_at_startup\".",
    "created_at": "2022-03-20T18:47:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491371",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:80" align="right">comment:80</div>

Replying to [@mkoeppe](#comment%3A79):
> Replying to [@tobiasdiez](#comment%3A75):
> > For me the guard is a general "we in the progress of starting sage", which is then used by the lazy import feature to decide how imports during the startup are handled. But the startup guard could for example also used to control logging or other things.
> 
> 
> I'd say this is speculative/premature abstraction. It's first necessary to capture the intended semantics for the actual use case.

The code above was of course only meant schematically. Read "what should be imported directly" as "what is the output of _get_imports_resolved_at_startup".



---

archive/issue_events_420986.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-04-05T15:13:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420986"
}
```



---

archive/issue_events_420987.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-04-05T15:13:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420987"
}
```



---

archive/issue_events_420988.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-10T17:28:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420988"
}
```



---

archive/issue_events_420989.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-10T17:28:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420989"
}
```



---

archive/issue_comments_491372.json:
```json
{
    "body": "<div id=\"comment:82\" align=\"right\">comment:82</div>\n\nWell, the review says: Someone needs to figure out the semantics before pushing this code.",
    "created_at": "2022-04-10T17:28:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491372",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:82" align="right">comment:82</div>

Well, the review says: Someone needs to figure out the semantics before pushing this code.



---

archive/issue_events_420990.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-11T17:19:39Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "milestone_number": null,
    "milestone_title": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420990"
}
```



---

archive/issue_events_420991.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-04-11T17:19:39Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420991"
}
```



---

archive/issue_comments_491373.json:
```json
{
    "body": "Changed commit from **[`339fd66`](https://github.com/sagemath/sagetrac-mirror/commit/339fd660b7d6dfefb9527bc524ea9c71aa57465e)** to **[`998e9e6`](https://github.com/sagemath/sagetrac-mirror/commit/998e9e62af2a25792d0450af0a7f23cc7f4225a1)**",
    "created_at": "2022-04-11T17:22:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491373",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`339fd66`](https://github.com/sagemath/sagetrac-mirror/commit/339fd660b7d6dfefb9527bc524ea9c71aa57465e)** to **[`998e9e6`](https://github.com/sagemath/sagetrac-mirror/commit/998e9e62af2a25792d0450af0a7f23cc7f4225a1)**



---

archive/issue_comments_491374.json:
```json
{
    "body": "<div id=\"comment:84\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/998e9e62af2a25792d0450af0a7f23cc7f4225a1\"><code>998e9e6</code></a></td><td><code>Merge branch 'develop' into public/build/startupWarning</code></td></tr></table>\n",
    "created_at": "2022-04-11T17:22:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491374",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:84"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/998e9e62af2a25792d0450af0a7f23cc7f4225a1"><code>998e9e6</code></a></td><td><code>Merge branch 'develop' into public/build/startupWarning</code></td></tr></table>




---

archive/issue_comments_491375.json:
```json
{
    "body": "<div id=\"comment:85\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/567465572d55907dae5f790385e3663c64d3c838\"><code>5674655</code></a></td><td><code>Narrow down scope of lock</code></td></tr></table>\n",
    "created_at": "2022-04-11T17:51:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491375",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:85"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/567465572d55907dae5f790385e3663c64d3c838"><code>5674655</code></a></td><td><code>Narrow down scope of lock</code></td></tr></table>




---

archive/issue_comments_491376.json:
```json
{
    "body": "Changed commit from **[`998e9e6`](https://github.com/sagemath/sagetrac-mirror/commit/998e9e62af2a25792d0450af0a7f23cc7f4225a1)** to **[`5674655`](https://github.com/sagemath/sagetrac-mirror/commit/567465572d55907dae5f790385e3663c64d3c838)**",
    "created_at": "2022-04-11T17:51:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491376",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`998e9e6`](https://github.com/sagemath/sagetrac-mirror/commit/998e9e62af2a25792d0450af0a7f23cc7f4225a1)** to **[`5674655`](https://github.com/sagemath/sagetrac-mirror/commit/567465572d55907dae5f790385e3663c64d3c838)**



---

archive/issue_comments_491377.json:
```json
{
    "body": "<div id=\"comment:86\" align=\"right\">comment:86</div>\n\nI've narrowed down the scope of the lock/guard. What do you think?",
    "created_at": "2022-04-11T17:51:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491377",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:86" align="right">comment:86</div>

I've narrowed down the scope of the lock/guard. What do you think?



---

archive/issue_comments_491378.json:
```json
{
    "body": "<div id=\"comment:87\" align=\"right\">comment:87</div>\n\nThanks, this is better for the discussion of the needed semantics.\n\nSo what needs to be figured out is: What should happen if\n1) There is a sequence of two start ups.\n2) Two startups are nested.",
    "created_at": "2022-04-11T17:55:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491378",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:87" align="right">comment:87</div>

Thanks, this is better for the discussion of the needed semantics.

So what needs to be figured out is: What should happen if
1) There is a sequence of two start ups.
2) Two startups are nested.



---

archive/issue_comments_491379.json:
```json
{
    "body": "<div id=\"comment:88\" align=\"right\">comment:88</div>\n\nThat feels like an academic issues since the actual code doesn't use either of these constructions and can easily be changed if these situations occur in the future.",
    "created_at": "2022-04-11T22:42:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491379",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:88" align="right">comment:88</div>

That feels like an academic issues since the actual code doesn't use either of these constructions and can easily be changed if these situations occur in the future.



---

archive/issue_comments_491380.json:
```json
{
    "body": "<div id=\"comment:89\" align=\"right\">comment:89</div>\n\nIt's just hard to see what the improvement brought by the ticket would be. Replacing True/False by LOCKED/UNLOCKED can't count as an improvement; and the semantics is made murkier, not clearer (see [comment:69](#comment%3A69)).",
    "created_at": "2022-04-11T23:29:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491380",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:89" align="right">comment:89</div>

It's just hard to see what the improvement brought by the ticket would be. Replacing True/False by LOCKED/UNLOCKED can't count as an improvement; and the semantics is made murkier, not clearer (see [comment:69](#comment%3A69)).



---

archive/issue_comments_491381.json:
```json
{
    "body": "<div id=\"comment:90\" align=\"right\">comment:90</div>\n\nReplying to [@mkoeppe](#comment%3A87):\n> What should happen if\n> 1) There is a sequence of two start ups.\n\nFor example, if a user tries to reload the module `sage.all`.",
    "created_at": "2022-04-11T23:35:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491381",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:90" align="right">comment:90</div>

Replying to [@mkoeppe](#comment%3A87):
> What should happen if
> 1) There is a sequence of two start ups.

For example, if a user tries to reload the module `sage.all`.



---

archive/issue_comments_491382.json:
```json
{
    "body": "<div id=\"comment:91\" align=\"right\">comment:91</div>\n\nReplying to [@mkoeppe](#comment%3A89):\n> It's just hard to see what the improvement brought by the ticket would be. Replacing True/False by LOCKED/UNLOCKED can't count as an improvement; and the semantics is made murkier, not clearer (see [comment:69](#comment%3A69)).\n\nAs written in the ticket description, the ticket fixes a bug with importing (using importlib) the sage all module.\n\nAnd yes, replacing the boolean by an enum is an improvement by itself, https://stackoverflow.com/questions/4337942/using-enum-vs-boolean.",
    "created_at": "2022-04-13T20:18:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491382",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:91" align="right">comment:91</div>

Replying to [@mkoeppe](#comment%3A89):
> It's just hard to see what the improvement brought by the ticket would be. Replacing True/False by LOCKED/UNLOCKED can't count as an improvement; and the semantics is made murkier, not clearer (see [comment:69](#comment%3A69)).

As written in the ticket description, the ticket fixes a bug with importing (using importlib) the sage all module.

And yes, replacing the boolean by an enum is an improvement by itself, https://stackoverflow.com/questions/4337942/using-enum-vs-boolean.



---

archive/issue_comments_491383.json:
```json
{
    "body": "<div id=\"comment:92\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cfd791cd837efc9d28c14306922bb429b2a43fe3\"><code>cfd791c</code></a></td><td><code>Fix sage.all</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/264aa53e8b47dd5ebb3b53d26f8f47c8ff2d5beb\"><code>264aa53</code></a></td><td><code>Fix lazy_import as well</code></td></tr></table>\n",
    "created_at": "2022-04-13T20:27:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491383",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:92"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cfd791cd837efc9d28c14306922bb429b2a43fe3"><code>cfd791c</code></a></td><td><code>Fix sage.all</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/264aa53e8b47dd5ebb3b53d26f8f47c8ff2d5beb"><code>264aa53</code></a></td><td><code>Fix lazy_import as well</code></td></tr></table>




---

archive/issue_comments_491384.json:
```json
{
    "body": "Changed commit from **[`5674655`](https://github.com/sagemath/sagetrac-mirror/commit/567465572d55907dae5f790385e3663c64d3c838)** to **[`264aa53`](https://github.com/sagemath/sagetrac-mirror/commit/264aa53e8b47dd5ebb3b53d26f8f47c8ff2d5beb)**",
    "created_at": "2022-04-13T20:27:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491384",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`5674655`](https://github.com/sagemath/sagetrac-mirror/commit/567465572d55907dae5f790385e3663c64d3c838)** to **[`264aa53`](https://github.com/sagemath/sagetrac-mirror/commit/264aa53e8b47dd5ebb3b53d26f8f47c8ff2d5beb)**



---

archive/issue_events_420992.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-05-22T23:51:01Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420992"
}
```



---

archive/issue_events_420993.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-05-22T23:51:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420993"
}
```



---

archive/issue_events_420994.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-24T15:35:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420994"
}
```



---

archive/issue_events_420995.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-05-24T15:35:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420995"
}
```



---

archive/issue_comments_491385.json:
```json
{
    "body": "<div id=\"comment:94\" align=\"right\">comment:94</div>\n\ncomment:87 is still unaddressed. Besides, the new term \"lock\" suggests that the mechanism is related concurrency (it isn't). Introducing a new term does not help clarify the semantics.",
    "created_at": "2022-05-24T15:35:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491385",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:94" align="right">comment:94</div>

comment:87 is still unaddressed. Besides, the new term "lock" suggests that the mechanism is related concurrency (it isn't). Introducing a new term does not help clarify the semantics.



---

archive/issue_comments_491386.json:
```json
{
    "body": "<div id=\"comment:95\" align=\"right\">comment:95</div>\n\nReplying to [@mkoeppe](#comment%3A94):\n> comment:87 is still unaddressed. Besides, the new term \"lock\" suggests that the mechanism is related concurrency (it isn't). Introducing a new term does not help clarify the semantics.\n> \n\nThere is a doctest describing the behavior of two sequential locks, the behavior of nested locks is not further specified as we don't need it yet (but as with this simplest implementation the both locks share the global \"lock\" variable, the state is in \"locked\" until the nested lock exits and then switches to \"unlocked\").\n\nI'm open for suggestions for how to improve the terminology. I thought that \"locked\" is pretty standard for a \"guard\", e.g. file locks. \"Started\"/\"Not started\" or \"Initialized/Not initialized\" is confusing with how sequential locks work.",
    "created_at": "2022-05-25T14:22:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491386",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:95" align="right">comment:95</div>

Replying to [@mkoeppe](#comment%3A94):
> comment:87 is still unaddressed. Besides, the new term "lock" suggests that the mechanism is related concurrency (it isn't). Introducing a new term does not help clarify the semantics.
> 

There is a doctest describing the behavior of two sequential locks, the behavior of nested locks is not further specified as we don't need it yet (but as with this simplest implementation the both locks share the global "lock" variable, the state is in "locked" until the nested lock exits and then switches to "unlocked").

I'm open for suggestions for how to improve the terminology. I thought that "locked" is pretty standard for a "guard", e.g. file locks. "Started"/"Not started" or "Initialized/Not initialized" is confusing with how sequential locks work.



---

archive/issue_events_420996.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-05-25T14:22:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420996"
}
```



---

archive/issue_events_420997.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2022-05-25T14:22:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420997"
}
```



---

archive/issue_comments_491387.json:
```json
{
    "body": "<div id=\"comment:96\" align=\"right\">comment:96</div>\n\nReplying to [@tobiasdiez](#comment%3A95):\n> I thought that \"locked\" is pretty standard for a \"guard\", e.g. file locks. \"Started\"/\"Not started\" or \"Initialized/Not initialized\" is confusing with how sequential locks work.\n\nYes, file locks are locks. They protect against concurrent operations.\n\nThe start-up guard has nothing to do with concurrency. It just makes no sense to work with this analogy.",
    "created_at": "2022-05-25T16:37:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491387",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:96" align="right">comment:96</div>

Replying to [@tobiasdiez](#comment%3A95):
> I thought that "locked" is pretty standard for a "guard", e.g. file locks. "Started"/"Not started" or "Initialized/Not initialized" is confusing with how sequential locks work.

Yes, file locks are locks. They protect against concurrent operations.

The start-up guard has nothing to do with concurrency. It just makes no sense to work with this analogy.



---

archive/issue_comments_491388.json:
```json
{
    "body": "<div id=\"comment:97\" align=\"right\">comment:97</div>\n\nIn other words, still [comment:74](#comment%3A74)",
    "created_at": "2022-05-25T17:12:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491388",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:97" align="right">comment:97</div>

In other words, still [comment:74](#comment%3A74)



---

archive/issue_comments_491389.json:
```json
{
    "body": "<div id=\"comment:98\" align=\"right\">comment:98</div>\n\nReplying to [@mkoeppe](#comment%3A97):\n> In other words, still [comment:74](#comment%3A74)\n\nThat concerned the more general version, now the purpose and scope of the lock should be clear.",
    "created_at": "2022-05-25T20:01:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491389",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:98" align="right">comment:98</div>

Replying to [@mkoeppe](#comment%3A97):
> In other words, still [comment:74](#comment%3A74)

That concerned the more general version, now the purpose and scope of the lock should be clear.



---

archive/issue_comments_491390.json:
```json
{
    "body": "<div id=\"comment:99\" align=\"right\">comment:99</div>\n\nWell, it clearly isn't clear, as I said in [comment:96](#comment%3A96). Try to explain it in the documentation or in the ticket.",
    "created_at": "2022-05-25T20:08:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491390",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:99" align="right">comment:99</div>

Well, it clearly isn't clear, as I said in [comment:96](#comment%3A96). Try to explain it in the documentation or in the ticket.



---

archive/issue_comments_491391.json:
```json
{
    "body": "<div id=\"comment:100\" align=\"right\">comment:100</div>\n\ncomment:74 is: You are trying to explain things in too much generality, based on an abstraction that you have come up with. But the abstraction does not capture the purpose of the startup guard mechanism: What exactly is the guard intended to protect?\nShort of explaining this, you are essentially trying to explain to me what a bit is.",
    "created_at": "2022-05-25T20:19:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491391",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:100" align="right">comment:100</div>

comment:74 is: You are trying to explain things in too much generality, based on an abstraction that you have come up with. But the abstraction does not capture the purpose of the startup guard mechanism: What exactly is the guard intended to protect?
Short of explaining this, you are essentially trying to explain to me what a bit is.



---

archive/issue_comments_491392.json:
```json
{
    "body": "<div id=\"comment:101\" align=\"right\">comment:101</div>\n\nThe purpose of the guard/lock/whatever you want to call it is the same as in the develop branch: when the guard is active, lazy imports should not be resolved. The only difference is that the guard has to be activated now explicitly.",
    "created_at": "2022-05-25T21:11:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491392",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:101" align="right">comment:101</div>

The purpose of the guard/lock/whatever you want to call it is the same as in the develop branch: when the guard is active, lazy imports should not be resolved. The only difference is that the guard has to be activated now explicitly.



---

archive/issue_comments_491393.json:
```json
{
    "body": "<div id=\"comment:102\" align=\"right\">comment:102</div>\n\nReplying to [@tobiasdiez](#comment%3A101):\n>  when the guard is active, lazy imports should not be resolved.\n\nNo, that's not what it does.",
    "created_at": "2022-05-25T21:27:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491393",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:102" align="right">comment:102</div>

Replying to [@tobiasdiez](#comment%3A101):
>  when the guard is active, lazy imports should not be resolved.

No, that's not what it does.



---

archive/issue_comments_491394.json:
```json
{
    "body": "<div id=\"comment:103\" align=\"right\">comment:103</div>\n\nReplying to [@mkoeppe](#comment%3A102):\n> Replying to [@tobiasdiez](#comment%3A101):\n> >  when the guard is active, lazy imports should not be resolved.\n> \n> \n> No, that's not what it does.\n\nSo what is it doing then?",
    "created_at": "2022-05-25T21:44:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491394",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:103" align="right">comment:103</div>

Replying to [@mkoeppe](#comment%3A102):
> Replying to [@tobiasdiez](#comment%3A101):
> >  when the guard is active, lazy imports should not be resolved.
> 
> 
> No, that's not what it does.

So what is it doing then?



---

archive/issue_comments_491395.json:
```json
{
    "body": "<div id=\"comment:104\" align=\"right\">comment:104</div>\n\nYou can see it in the source code of `LazyImport._get_object` - it does not change what is resolved when or anything. It only informs developers (by printing warnings) whether the laziness was effective or if the module was imported anyway.",
    "created_at": "2022-05-25T22:05:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491395",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:104" align="right">comment:104</div>

You can see it in the source code of `LazyImport._get_object` - it does not change what is resolved when or anything. It only informs developers (by printing warnings) whether the laziness was effective or if the module was imported anyway.



---

archive/issue_comments_491396.json:
```json
{
    "body": "<div id=\"comment:105\" align=\"right\">comment:105</div>\n\nYes, but isn't this a qualification of what \"should\" in \"lazy import should not be resolved\" means? Also from the ticket description: \"convert runtime warning about resolved lazy imports to doctest.\"\n\nAnyway, now that we agree on the terminology, do you still have questions about the serial behavior?",
    "created_at": "2022-05-26T10:05:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491396",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:105" align="right">comment:105</div>

Yes, but isn't this a qualification of what "should" in "lazy import should not be resolved" means? Also from the ticket description: "convert runtime warning about resolved lazy imports to doctest."

Anyway, now that we agree on the terminology, do you still have questions about the serial behavior?



---

archive/issue_comments_491397.json:
```json
{
    "body": "<div id=\"comment:106\" align=\"right\">comment:106</div>\n\nReplying to [@tobiasdiez](#comment%3A105):\n> Yes, but isn't this a qualification of what \"should\" in \"lazy import should not be resolved\" means?\n\nOK, I now understand what you meant by \"should\".",
    "created_at": "2022-05-26T14:20:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491397",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:106" align="right">comment:106</div>

Replying to [@tobiasdiez](#comment%3A105):
> Yes, but isn't this a qualification of what "should" in "lazy import should not be resolved" means?

OK, I now understand what you meant by "should".



---

archive/issue_comments_491398.json:
```json
{
    "body": "<div id=\"comment:107\" align=\"right\">comment:107</div>\n\nReplying to [@tobiasdiez](#comment%3A105):\n> do you still have questions about the serial behavior?\n\nYes. You are changing the serial behavior in this ticket. Why is this change an improvement over what's in the develop branch?",
    "created_at": "2022-05-26T14:26:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491398",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:107" align="right">comment:107</div>

Replying to [@tobiasdiez](#comment%3A105):
> do you still have questions about the serial behavior?

Yes. You are changing the serial behavior in this ticket. Why is this change an improvement over what's in the develop branch?



---

archive/issue_comments_491399.json:
```json
{
    "body": "<div id=\"comment:108\" align=\"right\">comment:108</div>\n\nReplying to [@tobiasdiez](#comment%3A105):\n> now that we agree on the terminology\n\nWe don't. It's not a lock, so please don't introduce this terminology in the ticket.",
    "created_at": "2022-05-26T15:36:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491399",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:108" align="right">comment:108</div>

Replying to [@tobiasdiez](#comment%3A105):
> now that we agree on the terminology

We don't. It's not a lock, so please don't introduce this terminology in the ticket.



---

archive/issue_comments_491400.json:
```json
{
    "body": "<div id=\"comment:109\" align=\"right\">comment:109</div>\n\nReplying to [@mkoeppe](#comment%3A107):\n> Replying to [@tobiasdiez](#comment%3A105):\n> > do you still have questions about the serial behavior?\n> \n> \n> Yes. You are changing the serial behavior in this ticket. Why is this change an improvement over what's in the develop branch?\n\nIt's not really a change, the start/end methods were just called test_fake_startup/ensure_startup_finished. The improvement is currently only visible in the tests, as this is the only place where it is used. But I think it may be handy also in the `all` script to have more freedom on how to order/group imports there without being constrained by the lazy import guard.",
    "created_at": "2022-05-27T16:48:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491400",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:109" align="right">comment:109</div>

Replying to [@mkoeppe](#comment%3A107):
> Replying to [@tobiasdiez](#comment%3A105):
> > do you still have questions about the serial behavior?
> 
> 
> Yes. You are changing the serial behavior in this ticket. Why is this change an improvement over what's in the develop branch?

It's not really a change, the start/end methods were just called test_fake_startup/ensure_startup_finished. The improvement is currently only visible in the tests, as this is the only place where it is used. But I think it may be handy also in the `all` script to have more freedom on how to order/group imports there without being constrained by the lazy import guard.



---

archive/issue_comments_491401.json:
```json
{
    "body": "<div id=\"comment:110\" align=\"right\">comment:110</div>\n\nReplying to [@mkoeppe](#comment%3A108):\n> Replying to [@tobiasdiez](#comment%3A105):\n> > now that we agree on the terminology\n> \n> \n> We don't. It's not a lock, so please don't introduce this terminology in the ticket.\n\ncomment:95",
    "created_at": "2022-05-27T16:50:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491401",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:110" align="right">comment:110</div>

Replying to [@mkoeppe](#comment%3A108):
> Replying to [@tobiasdiez](#comment%3A105):
> > now that we agree on the terminology
> 
> 
> We don't. It's not a lock, so please don't introduce this terminology in the ticket.

comment:95



---

archive/issue_comments_491402.json:
```json
{
    "body": "<div id=\"comment:111\" align=\"right\">comment:111</div>\n\nIn [comment:95](#comment%3A95) you called it a \"sequential lock\". It isn't.",
    "created_at": "2022-05-27T21:41:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491402",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:111" align="right">comment:111</div>

In [comment:95](#comment%3A95) you called it a "sequential lock". It isn't.



---

archive/issue_comments_491403.json:
```json
{
    "body": "<div id=\"comment:112\" align=\"right\">comment:112</div>\n\nOr is your reference to [comment:95](#comment%3A95) \"I'm open for suggestions\"?\n\nLet's see. A \"lock\" is locked or unlocked. A \"guard\" is ... active/inactive? engaged/disengaged? on/off?\n\nAnything like this sounds fine, I don't have a preference. It's just important to avoid using words that can be mistaken as standard technical terms when there is no relation.",
    "created_at": "2022-05-27T21:45:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491403",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:112" align="right">comment:112</div>

Or is your reference to [comment:95](#comment%3A95) "I'm open for suggestions"?

Let's see. A "lock" is locked or unlocked. A "guard" is ... active/inactive? engaged/disengaged? on/off?

Anything like this sounds fine, I don't have a preference. It's just important to avoid using words that can be mistaken as standard technical terms when there is no relation.



---

archive/issue_comments_491404.json:
```json
{
    "body": "<div id=\"comment:113\" align=\"right\">comment:113</div>\n\nReplying to [@tobiasdiez](#comment%3A109):\n> Replying to [@mkoeppe](#comment%3A107):\n> > Replying to [@tobiasdiez](#comment%3A105):\n> > > do you still have questions about the serial behavior?\n> > \n> > \n> > Yes. You are changing the serial behavior in this ticket. Why is this change an improvement over what's in the develop branch?\n> \n> \n> It's not really a change, the start/end methods were just called test_fake_startup/ensure_startup_finished.\n\nOK, that's not quite where I wanted to take the discussion. \n\nLet's please ignore the old doctesting-only helper functions - they have no relevance for discussing the semantics. \n\nIn `develop`, `finish_startup` can only be called once, and an error is raised otherwise; and then there is `ensure_startup_finished`, which can be called multiple times and which is a no-op if it was called before.\n\n> [...] I think it may be handy also in the `all` script to have more freedom on how to order/group imports there without being constrained by the lazy import guard.\n\nYes, I am interested in this -- which is why I brought up the scenarios of sequences of such startup-guarded blocks and also nested startup-guarded blocks in [comment:87](#comment%3A87). \n\nSo with the changes on this ticket, it becomes possible to have a sequence of two startup-guarded blocks:\n\n```\nwith ...:\n    Block 1\nwith ...:\n    Block 2\n```\nI think we both agree on what the first block should do. Now, why should the second one behave as you implemented?",
    "created_at": "2022-05-27T22:22:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491404",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:113" align="right">comment:113</div>

Replying to [@tobiasdiez](#comment%3A109):
> Replying to [@mkoeppe](#comment%3A107):
> > Replying to [@tobiasdiez](#comment%3A105):
> > > do you still have questions about the serial behavior?
> > 
> > 
> > Yes. You are changing the serial behavior in this ticket. Why is this change an improvement over what's in the develop branch?
> 
> 
> It's not really a change, the start/end methods were just called test_fake_startup/ensure_startup_finished.

OK, that's not quite where I wanted to take the discussion. 

Let's please ignore the old doctesting-only helper functions - they have no relevance for discussing the semantics. 

In `develop`, `finish_startup` can only be called once, and an error is raised otherwise; and then there is `ensure_startup_finished`, which can be called multiple times and which is a no-op if it was called before.

> [...] I think it may be handy also in the `all` script to have more freedom on how to order/group imports there without being constrained by the lazy import guard.

Yes, I am interested in this -- which is why I brought up the scenarios of sequences of such startup-guarded blocks and also nested startup-guarded blocks in [comment:87](#comment%3A87). 

So with the changes on this ticket, it becomes possible to have a sequence of two startup-guarded blocks:

```
with ...:
    Block 1
with ...:
    Block 2
```
I think we both agree on what the first block should do. Now, why should the second one behave as you implemented?



---

archive/issue_comments_491405.json:
```json
{
    "body": "<div id=\"comment:114\" align=\"right\">comment:114</div>\n\nBecause its not important in which block the lazy import is placed, it's only important whether it's guarded or not. What other implementation would you suggest?",
    "created_at": "2022-05-28T21:23:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491405",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:114" align="right">comment:114</div>

Because its not important in which block the lazy import is placed, it's only important whether it's guarded or not. What other implementation would you suggest?



---

archive/issue_comments_491406.json:
```json
{
    "body": "<div id=\"comment:115\" align=\"right\">comment:115</div>\n\nReplying to [@tobiasdiez](#comment%3A114):\n> Because its not important in which block the lazy import is placed, it's only important whether it's guarded or not.\n\nBut *why* do you think that this the right semantics?",
    "created_at": "2022-05-28T21:33:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491406",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:115" align="right">comment:115</div>

Replying to [@tobiasdiez](#comment%3A114):
> Because its not important in which block the lazy import is placed, it's only important whether it's guarded or not.

But *why* do you think that this the right semantics?



---

archive/issue_comments_491407.json:
```json
{
    "body": "<div id=\"comment:116\" align=\"right\">comment:116</div>\n\nIt seemed the most logical and easy to implement solution, that worked well with the currently only use case of the tests. What other implementation do you have in mind? Make the second block a noop?",
    "created_at": "2022-05-29T08:18:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491407",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:116" align="right">comment:116</div>

It seemed the most logical and easy to implement solution, that worked well with the currently only use case of the tests. What other implementation do you have in mind? Make the second block a noop?



---

archive/issue_comments_491408.json:
```json
{
    "body": "<div id=\"comment:117\" align=\"right\">comment:117</div>\n\nReplying to [@tobiasdiez](#comment%3A116):\n> Make the second block a noop? \n\nYes, a kind of no-op is what I had in mind.\n\nIn the current code, this structure does not appear lexically (and I don't have a use case for it in modularization):\n\n```\nwith ...:\n    Block 1\nwith ...:\n    Block 2\n```\nHowever, this sequence will be executed when a user reloads the `sage.all` module using `importlib.reload`.\n(Currently this is an error. And of course it is unclear if reloading actually can be made to work properly, given that we have so much complicated global state.)\n\nSo in this situation, in the second block, it would makes no sense to do any of the tracking of resolved lazy imports and emitting warnings. The startup was done already.",
    "created_at": "2022-05-29T22:52:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491408",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:117" align="right">comment:117</div>

Replying to [@tobiasdiez](#comment%3A116):
> Make the second block a noop? 

Yes, a kind of no-op is what I had in mind.

In the current code, this structure does not appear lexically (and I don't have a use case for it in modularization):

```
with ...:
    Block 1
with ...:
    Block 2
```
However, this sequence will be executed when a user reloads the `sage.all` module using `importlib.reload`.
(Currently this is an error. And of course it is unclear if reloading actually can be made to work properly, given that we have so much complicated global state.)

So in this situation, in the second block, it would makes no sense to do any of the tracking of resolved lazy imports and emitting warnings. The startup was done already.



---

archive/issue_comments_491409.json:
```json
{
    "body": "<div id=\"comment:118\" align=\"right\">comment:118</div>\n\nOn the other hand, this structure:\n\n```\nwith ...:\n    with ...:\n        Block 1\n    with ...:\n        Block 2\n    Block 3\n```\nwould appear in the course of modularization in some follow-up ticket of #29941, #28925. Blocks 1 and 2 would be imports done by modules like `sage.all__sagemath_environment`, `sage.all__sagemath_objects`.",
    "created_at": "2022-05-29T22:59:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491409",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:118" align="right">comment:118</div>

On the other hand, this structure:

```
with ...:
    with ...:
        Block 1
    with ...:
        Block 2
    Block 3
```
would appear in the course of modularization in some follow-up ticket of #29941, #28925. Blocks 1 and 2 would be imports done by modules like `sage.all__sagemath_environment`, `sage.all__sagemath_objects`.



---

archive/issue_comments_491410.json:
```json
{
    "body": "<div id=\"comment:119\" align=\"right\">comment:119</div>\n\nReplying to [@mkoeppe](#comment%3A117):\n> Replying to [@tobiasdiez](#comment%3A116):\n> > Make the second block a noop? \n> \n> \n> Yes, a kind of no-op is what I had in mind.\n> \n> In the current code, this structure does not appear lexically (and I don't have a use case for it in modularization):\n> \n> ```\n> with ...:\n>     Block 1\n> with ...:\n>     Block 2\n> ```\n> However, this sequence will be executed when a user reloads the `sage.all` module using `importlib.reload`.\n> (Currently this is an error. And of course it is unclear if reloading actually can be made to work properly, given that we have so much complicated global state.)\n> \n> So in this situation, in the second block, it would makes no sense to do any of the tracking of resolved lazy imports and emitting warnings. The startup was done already.\n\nIn this use case the current implementation is almost noop, since now the guard is only checked in the doctests and no warnings are issued.",
    "created_at": "2022-05-30T10:46:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491410",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:119" align="right">comment:119</div>

Replying to [@mkoeppe](#comment%3A117):
> Replying to [@tobiasdiez](#comment%3A116):
> > Make the second block a noop? 
> 
> 
> Yes, a kind of no-op is what I had in mind.
> 
> In the current code, this structure does not appear lexically (and I don't have a use case for it in modularization):
> 
> ```
> with ...:
>     Block 1
> with ...:
>     Block 2
> ```
> However, this sequence will be executed when a user reloads the `sage.all` module using `importlib.reload`.
> (Currently this is an error. And of course it is unclear if reloading actually can be made to work properly, given that we have so much complicated global state.)
> 
> So in this situation, in the second block, it would makes no sense to do any of the tracking of resolved lazy imports and emitting warnings. The startup was done already.

In this use case the current implementation is almost noop, since now the guard is only checked in the doctests and no warnings are issued.



---

archive/issue_comments_491411.json:
```json
{
    "body": "<div id=\"comment:120\" align=\"right\">comment:120</div>\n\nReplying to [@mkoeppe](#comment%3A118):\n> On the other hand, this structure:\n> \n> ```\n> with ...:\n>     with ...:\n>         Block 1\n>     with ...:\n>         Block 2\n>     Block 3\n> ```\n> would appear in the course of modularization in some follow-up ticket of #29941, #28925. Blocks 1 and 2 would be imports done by modules like `sage.all__sagemath_environment`, `sage.all__sagemath_objects`.\n\nIn my opinion, the submodules shouldn't have their own startup scripts. The all script is one of the things that make sage so hard to use as a library. But if the nested structure does arise in the future, then the implementation of the guard can easily be changed to accommodate of this.",
    "created_at": "2022-05-30T10:53:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491411",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:120" align="right">comment:120</div>

Replying to [@mkoeppe](#comment%3A118):
> On the other hand, this structure:
> 
> ```
> with ...:
>     with ...:
>         Block 1
>     with ...:
>         Block 2
>     Block 3
> ```
> would appear in the course of modularization in some follow-up ticket of #29941, #28925. Blocks 1 and 2 would be imports done by modules like `sage.all__sagemath_environment`, `sage.all__sagemath_objects`.

In my opinion, the submodules shouldn't have their own startup scripts. The all script is one of the things that make sage so hard to use as a library. But if the nested structure does arise in the future, then the implementation of the guard can easily be changed to accommodate of this.



---

archive/issue_comments_491412.json:
```json
{
    "body": "<div id=\"comment:121\" align=\"right\">comment:121</div>\n\nReplying to [@tobiasdiez](#comment%3A120):\n> Replying to [@mkoeppe](#comment%3A118):\n> > imports done by modules like `sage.all__sagemath_environment`, `sage.all__sagemath_objects`.\n> \n> \n> In my opinion, the submodules shouldn't have their own startup scripts. The all script is one of the things that make sage so hard to use as a library. \n\nThe `all` scripts have two purposes: (1) To orchestrate startup, and I agree with you that the library should be changed to make it unnecessary - that's #33580. (2) To fill the top-level namespace that is available at the `sage:` prompt. And this is not going away.",
    "created_at": "2022-05-30T18:47:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491412",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:121" align="right">comment:121</div>

Replying to [@tobiasdiez](#comment%3A120):
> Replying to [@mkoeppe](#comment%3A118):
> > imports done by modules like `sage.all__sagemath_environment`, `sage.all__sagemath_objects`.
> 
> 
> In my opinion, the submodules shouldn't have their own startup scripts. The all script is one of the things that make sage so hard to use as a library. 

The `all` scripts have two purposes: (1) To orchestrate startup, and I agree with you that the library should be changed to make it unnecessary - that's #33580. (2) To fill the top-level namespace that is available at the `sage:` prompt. And this is not going away.



---

archive/issue_comments_491413.json:
```json
{
    "body": "<div id=\"comment:122\" align=\"right\">comment:122</div>\n\nReplying to [@tobiasdiez](#comment%3A120):\n> But if the nested structure does arise in the future\n\nWell, it will, as I said in [comment:118](#comment%3A118).\n\n> then the implementation of the guard can easily be changed to accommodate of this. \n\nIn your current branch you are introducing a public interface (including new terminology) for the `GuardState`. That's not a good way forward when we already know that it does not capture what is needed.",
    "created_at": "2022-05-30T19:00:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491413",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:122" align="right">comment:122</div>

Replying to [@tobiasdiez](#comment%3A120):
> But if the nested structure does arise in the future

Well, it will, as I said in [comment:118](#comment%3A118).

> then the implementation of the guard can easily be changed to accommodate of this. 

In your current branch you are introducing a public interface (including new terminology) for the `GuardState`. That's not a good way forward when we already know that it does not capture what is needed.



---

archive/issue_comments_491414.json:
```json
{
    "body": "<div id=\"comment:123\" align=\"right\">comment:123</div>\n\nReplying to [@tobiasdiez](#comment%3A119):\n> Replying to [@mkoeppe](#comment%3A117):\n> > Replying to [@tobiasdiez](#comment%3A116):\n> > > Make the second block a noop? \n> > \n> > \n> > Yes, a kind of no-op is what I had in mind.\n> > [...] this sequence will be executed when a user reloads the `sage.all` module using `importlib.reload`. [...]\n> > \n> > So in this situation, in the second block, it would makes no sense to do any of the tracking of resolved lazy imports and emitting warnings. The startup was done already.\n> \n> \n> In this use case the current implementation is almost noop, since now the guard is only checked in the doctests and no warnings are issued. \n\nNot no-op enough. The doctests can also be invoked from within a running Sage.",
    "created_at": "2022-05-30T20:31:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491414",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:123" align="right">comment:123</div>

Replying to [@tobiasdiez](#comment%3A119):
> Replying to [@mkoeppe](#comment%3A117):
> > Replying to [@tobiasdiez](#comment%3A116):
> > > Make the second block a noop? 
> > 
> > 
> > Yes, a kind of no-op is what I had in mind.
> > [...] this sequence will be executed when a user reloads the `sage.all` module using `importlib.reload`. [...]
> > 
> > So in this situation, in the second block, it would makes no sense to do any of the tracking of resolved lazy imports and emitting warnings. The startup was done already.
> 
> 
> In this use case the current implementation is almost noop, since now the guard is only checked in the doctests and no warnings are issued. 

Not no-op enough. The doctests can also be invoked from within a running Sage.



---

archive/issue_comments_491415.json:
```json
{
    "body": "<div id=\"comment:124\" align=\"right\">comment:124</div>\n\nReplying to [@mkoeppe](#comment%3A121):\n> (2) To fill the top-level namespace that is available at the `sage:` prompt. And this is not going away.\n\nBut you only have one prompt so one global guard should be sufficient. I don't see the need why the submodule needs its own guard, or even why it's the responsibility of the module to declare what methods should be available in the sage prompt in the first place.",
    "created_at": "2022-05-30T20:36:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491415",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:124" align="right">comment:124</div>

Replying to [@mkoeppe](#comment%3A121):
> (2) To fill the top-level namespace that is available at the `sage:` prompt. And this is not going away.

But you only have one prompt so one global guard should be sufficient. I don't see the need why the submodule needs its own guard, or even why it's the responsibility of the module to declare what methods should be available in the sage prompt in the first place.



---

archive/issue_comments_491416.json:
```json
{
    "body": "<div id=\"comment:125\" align=\"right\">comment:125</div>\n\nReplying to [@mkoeppe](#comment%3A123):\n> Replying to [@tobiasdiez](#comment%3A119):\n> > Replying to [@mkoeppe](#comment%3A117):\n> > > Replying to [@tobiasdiez](#comment%3A116):\n> > > > Make the second block a noop? \n> > > \n> > > \n> > > Yes, a kind of no-op is what I had in mind.\n> > > [...] this sequence will be executed when a user reloads the `sage.all` module using `importlib.reload`. [...]\n> > > \n> > > So in this situation, in the second block, it would makes no sense to do any of the tracking of resolved lazy imports and emitting warnings. The startup was done already.\n> > \n> > \n> > In this use case the current implementation is almost noop, since now the guard is only checked in the doctests and no warnings are issued. \n> \n> \n> Not no-op enough. The doctests can also be invoked from within a running Sage.\n\nThe test would still only fail if there are already resolved lazy imports in the first load.",
    "created_at": "2022-05-30T20:38:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491416",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:125" align="right">comment:125</div>

Replying to [@mkoeppe](#comment%3A123):
> Replying to [@tobiasdiez](#comment%3A119):
> > Replying to [@mkoeppe](#comment%3A117):
> > > Replying to [@tobiasdiez](#comment%3A116):
> > > > Make the second block a noop? 
> > > 
> > > 
> > > Yes, a kind of no-op is what I had in mind.
> > > [...] this sequence will be executed when a user reloads the `sage.all` module using `importlib.reload`. [...]
> > > 
> > > So in this situation, in the second block, it would makes no sense to do any of the tracking of resolved lazy imports and emitting warnings. The startup was done already.
> > 
> > 
> > In this use case the current implementation is almost noop, since now the guard is only checked in the doctests and no warnings are issued. 
> 
> 
> Not no-op enough. The doctests can also be invoked from within a running Sage.

The test would still only fail if there are already resolved lazy imports in the first load.



---

archive/issue_comments_491417.json:
```json
{
    "body": "<div id=\"comment:126\" align=\"right\">comment:126</div>\n\nReplying to [@tobiasdiez](#comment%3A124):\n> Replying to [@mkoeppe](#comment%3A121):\n> > (2) To fill the top-level namespace that is available at the `sage:` prompt. And this is not going away.\n> \n> \n> But you only have one prompt \n\nNope. See https://doc.sagemath.org/html/en/developer/packaging_sage_library.html#testing-distribution-packages\n\n> I don't see the need why the submodule needs its own guard, or even why it's the responsibility of the module \n\nNot the module, the distribution.",
    "created_at": "2022-05-30T20:40:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491417",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:126" align="right">comment:126</div>

Replying to [@tobiasdiez](#comment%3A124):
> Replying to [@mkoeppe](#comment%3A121):
> > (2) To fill the top-level namespace that is available at the `sage:` prompt. And this is not going away.
> 
> 
> But you only have one prompt 

Nope. See https://doc.sagemath.org/html/en/developer/packaging_sage_library.html#testing-distribution-packages

> I don't see the need why the submodule needs its own guard, or even why it's the responsibility of the module 

Not the module, the distribution.



---

archive/issue_comments_491418.json:
```json
{
    "body": "<div id=\"comment:127\" align=\"right\">comment:127</div>\n\nReplying to [@tobiasdiez](#comment%3A125):\n> Replying to [@mkoeppe](#comment%3A123):\n> > Not no-op enough. The doctests can also be invoked from within a running Sage.\n> \n> \n> The test would still only fail if there are already resolved lazy imports in the first load. \n\nThere are two types warnings, right? Let's break the analysis down by type.",
    "created_at": "2022-05-30T20:41:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30748#issuecomment-491418",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:127" align="right">comment:127</div>

Replying to [@tobiasdiez](#comment%3A125):
> Replying to [@mkoeppe](#comment%3A123):
> > Not no-op enough. The doctests can also be invoked from within a running Sage.
> 
> 
> The test would still only fail if there are already resolved lazy imports in the first load. 

There are two types warnings, right? Let's break the analysis down by type.



---

archive/issue_events_420998.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420998"
}
```



---

archive/issue_events_420999.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30748",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30748#event-420999"
}
```
