# Issue 30010: Split sage_setup.docbuild out to a separate distribution sage_docbuild

archive/issues_029773.json:
```json
{
    "body": "`sage_setup.docbuild`, created in #19127, has very different dependencies compared to `sage_setup`:\n\nIt depends on `sagelib` and `sphinx`, \nwhereas the rest of `sage_setup` is for building `sagelib`.\n\nWe remove the nesting within `sage_setup`, creating a new top-level package `sage_docbuild`.\n\nWe split it out as a separate pip-installable distribution package `sage_docbuild`.  \n\nUsing the `spkg-src` script, a pip-installable tarball can be generated, which could be uploaded to PyPI -- for the use by external packages that want to build documentation.\n\nThis is preparation for #29868 (pip-installable packages sagemath-doc-src, sagemath-doc-inventory, sagemath-doc-html, sagemath-doc-pdf)\n\n\n\nCC:  @kiwifb @jhpalmieri @isuruf @mwageringel @haraldschilly @mezzarobba\n\nKeywords: sd111\n\nBranch/Commit: aaab1d3713d1bd2afb922466a086f8e85849a02d\n\nReviewer: John Palmieri\n\nAuthor: Matthias Koeppe\n\nDependencies: #31344, #31353\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/30010\n\n",
    "closed_at": "2021-03-09T00:00:35Z",
    "created_at": "2020-06-28T16:16:39Z",
    "labels": [
        "component: refactoring"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Split sage_setup.docbuild out to a separate distribution sage_docbuild",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30010",
    "user": "https://github.com/mkoeppe"
}
```
`sage_setup.docbuild`, created in #19127, has very different dependencies compared to `sage_setup`:

It depends on `sagelib` and `sphinx`, 
whereas the rest of `sage_setup` is for building `sagelib`.

We remove the nesting within `sage_setup`, creating a new top-level package `sage_docbuild`.

We split it out as a separate pip-installable distribution package `sage_docbuild`.  

Using the `spkg-src` script, a pip-installable tarball can be generated, which could be uploaded to PyPI -- for the use by external packages that want to build documentation.

This is preparation for #29868 (pip-installable packages sagemath-doc-src, sagemath-doc-inventory, sagemath-doc-html, sagemath-doc-pdf)



CC:  @kiwifb @jhpalmieri @isuruf @mwageringel @haraldschilly @mezzarobba

Keywords: sd111

Branch/Commit: aaab1d3713d1bd2afb922466a086f8e85849a02d

Reviewer: John Palmieri

Author: Matthias Koeppe

Dependencies: #31344, #31353

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/30010





---

archive/issue_comments_450863.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -3,7 +3,10 @@\n It depends on `sagelib` and `sphinx`, \n whereas the rest of `sage_setup` is for building `sagelib`.\n \n-We split it out.\n+We split it out as a separate distutils package `sage_setup-docbuild`.\n+\n+Because some external packages use `sage_setup.docbuild` to build their own documentation, we do not change the package hierarchy. Instead we turn `sage_setup` into a native namespace package.\n+\n \n Comment: 1\n \n``````\n",
    "created_at": "2020-07-13T19:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450863",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -3,7 +3,10 @@
 It depends on `sagelib` and `sphinx`, 
 whereas the rest of `sage_setup` is for building `sagelib`.
 
-We split it out.
+We split it out as a separate distutils package `sage_setup-docbuild`.
+
+Because some external packages use `sage_setup.docbuild` to build their own documentation, we do not change the package hierarchy. Instead we turn `sage_setup` into a native namespace package.
+
 
 Comment: 1
 
``````




---

archive/issue_comments_450864.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,11 @@\n+`sage_setup.docbuild` has very different dependencies:\n+\n+It depends on `sagelib` and `sphinx`, \n+whereas the rest of `sage_setup` is for building `sagelib`.\n+\n+We split it out as a separate distutils package `sage_setup.docbuild`.\n+\n+Because some external packages use `sage_setup.docbuild` to build their own documentation, we do not change the package hierarchy. Instead we turn `sage_setup` into a native namespace package.\n \n \n Comment: 1\n``````\n",
    "created_at": "2020-07-13T20:40:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450864",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,11 @@
+`sage_setup.docbuild` has very different dependencies:
+
+It depends on `sagelib` and `sphinx`, 
+whereas the rest of `sage_setup` is for building `sagelib`.
+
+We split it out as a separate distutils package `sage_setup.docbuild`.
+
+Because some external packages use `sage_setup.docbuild` to build their own documentation, we do not change the package hierarchy. Instead we turn `sage_setup` into a native namespace package.
 
 
 Comment: 1
``````




---

archive/issue_comments_450865.json:
```json
{
    "body": "<a id='comment:7'></a>Last 10 new commits:",
    "created_at": "2020-07-13T21:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450865",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>Last 10 new commits:



---

archive/issue_comments_450866.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-07-14T00:06:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450866",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_450867.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,14 @@\n+`sage_setup.docbuild` has very different dependencies:\n+\n+It depends on `sagelib` and `sphinx`, \n+whereas the rest of `sage_setup` is for building `sagelib`.\n+\n+We split it out as a separate distutils package `sage_setup.docbuild`.  \n+\n+Because some external packages use `sage_setup.docbuild` to build their own documentation, we do not change the package hierarchy. Instead we turn `sage_setup` into a native namespace package.\n+\n+\n+Using the `spkg-src` script, a pip-installable tarball can be generated, which could be uploaded to PyPI -- for the use by external packages that want to build documentation.\n \n \n Comment: 1\n``````\n",
    "created_at": "2020-07-14T02:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450867",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,14 @@
+`sage_setup.docbuild` has very different dependencies:
+
+It depends on `sagelib` and `sphinx`, 
+whereas the rest of `sage_setup` is for building `sagelib`.
+
+We split it out as a separate distutils package `sage_setup.docbuild`.  
+
+Because some external packages use `sage_setup.docbuild` to build their own documentation, we do not change the package hierarchy. Instead we turn `sage_setup` into a native namespace package.
+
+
+Using the `spkg-src` script, a pip-installable tarball can be generated, which could be uploaded to PyPI -- for the use by external packages that want to build documentation.
 
 
 Comment: 1
``````




---

archive/issue_comments_450868.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-15T18:55:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450868",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_450869.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-15T19:25:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450869",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_450870.json:
```json
{
    "body": "<a id='comment:13'></a>In the new `spkg-install` file, why\n\n```\n. sage-dist-helpers\n```\nWhy do this at all, and if you're going to do it, why not use `source` instead of `.`, to be consistent with how `sage-spkg` does things?",
    "created_at": "2020-07-20T22:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450870",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:13'></a>In the new `spkg-install` file, why

```
. sage-dist-helpers
```
Why do this at all, and if you're going to do it, why not use `source` instead of `.`, to be consistent with how `sage-spkg` does things?



---

archive/issue_comments_450871.json:
```json
{
    "body": "<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-20T22:37:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450871",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:14'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_450872.json:
```json
{
    "body": "<a id='comment:15'></a>Thanks. This was a leftover from when I was using `sdh_pip_install`.",
    "created_at": "2020-07-20T22:38:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450872",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>Thanks. This was a leftover from when I was using `sdh_pip_install`.



---

archive/issue_comments_450873.json:
```json
{
    "body": "<a id='comment:16'></a>Can you please add `sage_setup_docbuild` to `DOC_DEPENDENCIES` in `build/make/Makefile.in`?\n\nEdit: No, sorry, it's already there. I just built Sage and it build `sage_setup_docbuild` at the end, after the documentation. I don't know why.",
    "created_at": "2020-07-21T00:03:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450873",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:16'></a>Can you please add `sage_setup_docbuild` to `DOC_DEPENDENCIES` in `build/make/Makefile.in`?

Edit: No, sorry, it's already there. I just built Sage and it build `sage_setup_docbuild` at the end, after the documentation. I don't know why.



---

archive/issue_comments_450874.json:
```json
{
    "body": "<a id='comment:17'></a>Hm... it's possible that it is always built because its dependency sagelib is always built...",
    "created_at": "2020-07-21T00:46:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450874",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>Hm... it's possible that it is always built because its dependency sagelib is always built...



---

archive/issue_comments_450875.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-10T01:19:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450875",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_450876.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-10T01:21:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450876",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_077120.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-05T19:21:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30010#event-77120"
}
```



---

archive/issue_comments_450877.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-09-08T22:56:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450877",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_450878.json:
```json
{
    "body": "<a id='comment:23'></a>I wrote these comments before the most recent change, but I think they are still relevant:\n\nI propose the following change:\n\n```diff\ndiff --git a/build/pkgs/sage_setup_docbuild/dependencies b/build/pkgs/sage_setup_docbuild/dependencies\nindex 20f527f0f1..b21990c270 100644\n--- a/build/pkgs/sage_setup_docbuild/dependencies\n+++ b/build/pkgs/sage_setup_docbuild/dependencies\n@@ -1 +1 @@\n-$(PYTHON) sphinx six | $(PYTHON_TOOLCHAIN) sagelib\n+$(PYTHON) sphinx | $(PYTHON_TOOLCHAIN) sagelib\ndiff --git a/build/pkgs/sage_setup_docbuild/src/requirements.txt b/build/pkgs/sage_setup_docbuild/src/requirements.txt\nindex 2dedc630e9..4e5dd84d0e 100644\n--- a/build/pkgs/sage_setup_docbuild/src/requirements.txt\n+++ b/build/pkgs/sage_setup_docbuild/src/requirements.txt\n@@ -1,3 +1,2 @@\n #sage\n sphinx\n-six\ndiff --git a/src/sage_setup/docbuild/ext/sage_autodoc.py b/src/sage_setup/docbuild/ext/sage_autodoc.py\nindex 032365d6bd..92d19b883e 100644\n--- a/src/sage_setup/docbuild/ext/sage_autodoc.py\n+++ b/src/sage_setup/docbuild/ext/sage_autodoc.py\n@@ -26,8 +26,6 @@ AUTHORS:\n - Kwankyu Lee (2018-12-26): rebase on the latest sphinx.ext.autodoc\n \n \"\"\"\n-from six import PY2, itervalues, text_type, class_types, string_types\n-\n import inspect\n import re\n import sys\n@@ -1176,27 +1174,19 @@ class ClassDocumenter(DocstringSignatureMixin, ModuleLevelDocumenter):\n         if ret:\n             module = getattr(self.object, '__module__', False)\n             name = getattr(self.object, '__name__', False)\n-            if PY2:\n-                if name and module:\n-                    cls = getattr(sys.modules[module], name, None)\n-                    self.doc_as_attr = (self.objpath != name.split('.') and\n-                                        self.object is cls)\n-                else:\n-                    self.doc_as_attr = True\n+            qualname = getattr(self.object, '__qualname__', name)\n+            if qualname and module:\n+                # walk the standard attribute lookup path for this object\n+                qualname_parts = qualname.split('.')\n+                cls = getattr(sys.modules[module], qualname_parts[0], None)\n+                for part in qualname_parts[1:]:\n+                    if cls is None:\n+                        break\n+                    cls = getattr(cls, part, None)\n+                self.doc_as_attr = (self.objpath != qualname_parts and\n+                                    self.object is cls)\n             else:\n-                qualname = getattr(self.object, '__qualname__', name)\n-                if qualname and module:\n-                    # walk the standard attribute lookup path for this object\n-                    qualname_parts = qualname.split('.')\n-                    cls = getattr(sys.modules[module], qualname_parts[0], None)\n-                    for part in qualname_parts[1:]:\n-                        if cls is None:\n-                            break\n-                        cls = getattr(cls, part, None)\n-                    self.doc_as_attr = (self.objpath != qualname_parts and\n-                                        self.object is cls)\n-                else:\n-                    self.doc_as_attr = True\n+                self.doc_as_attr = True\n         return ret\n \n     def format_args(self):\n\n```\n\n- Also, I don't understand the \"tarball\" aspects of this. There is no tarball, is there? So why have `spkg-src`?\n\n- Is it built in `build/pkgs/sage_setup_docbuild/src/`? After building, I see new directories `build` and `sage_setup.docbuild.egg-info` there.\n\n- The installation log file says `package init file 'sage_setup/__init__.py' not found (or not a regular file)`. I assume this is not a big issue, since everything worked after installation.",
    "created_at": "2020-09-08T23:09:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450878",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:23'></a>I wrote these comments before the most recent change, but I think they are still relevant:

I propose the following change:

```diff
diff --git a/build/pkgs/sage_setup_docbuild/dependencies b/build/pkgs/sage_setup_docbuild/dependencies
index 20f527f0f1..b21990c270 100644
--- a/build/pkgs/sage_setup_docbuild/dependencies
+++ b/build/pkgs/sage_setup_docbuild/dependencies
@@ -1 +1 @@
-$(PYTHON) sphinx six | $(PYTHON_TOOLCHAIN) sagelib
+$(PYTHON) sphinx | $(PYTHON_TOOLCHAIN) sagelib
diff --git a/build/pkgs/sage_setup_docbuild/src/requirements.txt b/build/pkgs/sage_setup_docbuild/src/requirements.txt
index 2dedc630e9..4e5dd84d0e 100644
--- a/build/pkgs/sage_setup_docbuild/src/requirements.txt
+++ b/build/pkgs/sage_setup_docbuild/src/requirements.txt
@@ -1,3 +1,2 @@
 #sage
 sphinx
-six
diff --git a/src/sage_setup/docbuild/ext/sage_autodoc.py b/src/sage_setup/docbuild/ext/sage_autodoc.py
index 032365d6bd..92d19b883e 100644
--- a/src/sage_setup/docbuild/ext/sage_autodoc.py
+++ b/src/sage_setup/docbuild/ext/sage_autodoc.py
@@ -26,8 +26,6 @@ AUTHORS:
 - Kwankyu Lee (2018-12-26): rebase on the latest sphinx.ext.autodoc
 
 """
-from six import PY2, itervalues, text_type, class_types, string_types
-
 import inspect
 import re
 import sys
@@ -1176,27 +1174,19 @@ class ClassDocumenter(DocstringSignatureMixin, ModuleLevelDocumenter):
         if ret:
             module = getattr(self.object, '__module__', False)
             name = getattr(self.object, '__name__', False)
-            if PY2:
-                if name and module:
-                    cls = getattr(sys.modules[module], name, None)
-                    self.doc_as_attr = (self.objpath != name.split('.') and
-                                        self.object is cls)
-                else:
-                    self.doc_as_attr = True
+            qualname = getattr(self.object, '__qualname__', name)
+            if qualname and module:
+                # walk the standard attribute lookup path for this object
+                qualname_parts = qualname.split('.')
+                cls = getattr(sys.modules[module], qualname_parts[0], None)
+                for part in qualname_parts[1:]:
+                    if cls is None:
+                        break
+                    cls = getattr(cls, part, None)
+                self.doc_as_attr = (self.objpath != qualname_parts and
+                                    self.object is cls)
             else:
-                qualname = getattr(self.object, '__qualname__', name)
-                if qualname and module:
-                    # walk the standard attribute lookup path for this object
-                    qualname_parts = qualname.split('.')
-                    cls = getattr(sys.modules[module], qualname_parts[0], None)
-                    for part in qualname_parts[1:]:
-                        if cls is None:
-                            break
-                        cls = getattr(cls, part, None)
-                    self.doc_as_attr = (self.objpath != qualname_parts and
-                                        self.object is cls)
-                else:
-                    self.doc_as_attr = True
+                self.doc_as_attr = True
         return ret
 
     def format_args(self):

```

- Also, I don't understand the "tarball" aspects of this. There is no tarball, is there? So why have `spkg-src`?

- Is it built in `build/pkgs/sage_setup_docbuild/src/`? After building, I see new directories `build` and `sage_setup.docbuild.egg-info` there.

- The installation log file says `package init file 'sage_setup/__init__.py' not found (or not a regular file)`. I assume this is not a big issue, since everything worked after installation.



---

archive/issue_comments_450879.json:
```json
{
    "body": "<a id='comment:24'></a>I agree with these changes; could you push them to the branch please?",
    "created_at": "2020-09-09T00:31:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450879",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>I agree with these changes; could you push them to the branch please?



---

archive/issue_comments_450880.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [comment:23 jhpalmieri]:\n> - Also, I don't understand the \"tarball\" aspects of this. There is no tarball, is there? So why have `spkg-src`?\n\n\nThe spkg-src script can build a tarball for the purpose of uploading a source distribution to PyPI.\n\n> - Is it built in `build/pkgs/sage_setup_docbuild/src/`? After building, I see new directories `build` and `sage_setup.docbuild.egg-info` there.\n\n\nThat's right. \n\nI should probably add a `sage_setup_docbuild-clean` target that deletes them.\n\n> - The installation log file says `package init file 'sage_setup/__init__.py' not found (or not a regular file)`. I assume this is not a big issue, since everything worked after installation.\n\n\nThis is not an error. `sage_setup` is now a native namespace package - these do not have `__init__.py` files.",
    "created_at": "2020-09-09T00:37:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450880",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'></a>Replying to [comment:23 jhpalmieri]:
> - Also, I don't understand the "tarball" aspects of this. There is no tarball, is there? So why have `spkg-src`?


The spkg-src script can build a tarball for the purpose of uploading a source distribution to PyPI.

> - Is it built in `build/pkgs/sage_setup_docbuild/src/`? After building, I see new directories `build` and `sage_setup.docbuild.egg-info` there.


That's right. 

I should probably add a `sage_setup_docbuild-clean` target that deletes them.

> - The installation log file says `package init file 'sage_setup/__init__.py' not found (or not a regular file)`. I assume this is not a big issue, since everything worked after installation.


This is not an error. `sage_setup` is now a native namespace package - these do not have `__init__.py` files.



---

archive/issue_comments_450881.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-09-09T02:34:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450881",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_450882.json:
```json
{
    "body": "<a id='comment:27'></a>Adding a `sage_setup_docbuild-clean` would be nice, and/or an `spkg-postinst` script \u2014\u00a0can happen either here or on another ticket.\n\n---\nNew commits:",
    "created_at": "2020-09-09T02:34:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450882",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:27'></a>Adding a `sage_setup_docbuild-clean` would be nice, and/or an `spkg-postinst` script — can happen either here or on another ticket.

---
New commits:



---

archive/issue_comments_450883.json:
```json
{
    "body": "<a id='comment:28'></a>Thank you. I think I'll be doing the cleaning via #29386.",
    "created_at": "2020-09-09T03:51:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450883",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:28'></a>Thank you. I think I'll be doing the cleaning via #29386.



---

archive/issue_comments_450884.json:
```json
{
    "body": "<a id='comment:29'></a>I'm getting lots of \n\n```\nsage -t --long --warn-long 44.0 --random-seed=0 src/sage_setup/find.py\n**********************************************************************\nFile \"src/sage_setup/find.py\", line 38, in sage_setup.find.read_distribution\nFailed example:\n    from sage_setup.find import read_distribution\nException raised:\n    Traceback (most recent call last):\n      File \"/home/release/Sage/local/lib/python3.8/site-packages/sage/doctest/forker.py\", line 720, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/release/Sage/local/lib/python3.8/site-packages/sage/doctest/forker.py\", line 1145, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage_setup.find.read_distribution[1]>\", line 1, in <module>\n        from sage_setup.find import read_distribution\n    ModuleNotFoundError: No module named 'sage_setup.find'\n**********************************************************************\n```\nAre incremental builds supported?",
    "created_at": "2020-09-27T18:00:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450884",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:29'></a>I'm getting lots of 

```
sage -t --long --warn-long 44.0 --random-seed=0 src/sage_setup/find.py
**********************************************************************
File "src/sage_setup/find.py", line 38, in sage_setup.find.read_distribution
Failed example:
    from sage_setup.find import read_distribution
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 720, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1145, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_setup.find.read_distribution[1]>", line 1, in <module>
        from sage_setup.find import read_distribution
    ModuleNotFoundError: No module named 'sage_setup.find'
**********************************************************************
```
Are incremental builds supported?



---

archive/issue_comments_450885.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-09-27T18:00:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450885",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_450886.json:
```json
{
    "body": "<a id='comment:30'></a>I'll revisit this ticket at the start of the 9.3 series",
    "created_at": "2020-09-27T18:11:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450886",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'></a>I'll revisit this ticket at the start of the 9.3 series



---

archive/issue_events_077121.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-11-14T06:39:22Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30010#event-77121"
}
```



---

archive/issue_events_077122.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-11-14T06:39:22Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30010#event-77122"
}
```



---

archive/issue_comments_450887.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd111\".",
    "created_at": "2020-12-06T17:46:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450887",
    "user": "https://github.com/mkoeppe"
}
```

Changing keywords from "" to "sd111".



---

archive/issue_comments_450888.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,14 @@\n+`sage_setup.docbuild` has very different dependencies compared to `sage_setup`:\n+\n+It depends on `sagelib` and `sphinx`, \n+whereas the rest of `sage_setup` is for building `sagelib`.\n+\n+We split it out as a separate distutils package `sage_docbuild`.  \n+\n+Using the `spkg-src` script, a pip-installable tarball can be generated, which could be uploaded to PyPI -- for the use by external packages that want to build documentation.\n+\n+This is preparation for #29868 (pip-installable packages sagemath-doc-src, sagemath-doc-inventory, sagemath-doc-html, sagemath-doc-pdf)\n+\n \n \n Comment: 1\n``````\n",
    "created_at": "2021-02-21T18:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450888",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,14 @@
+`sage_setup.docbuild` has very different dependencies compared to `sage_setup`:
+
+It depends on `sagelib` and `sphinx`, 
+whereas the rest of `sage_setup` is for building `sagelib`.
+
+We split it out as a separate distutils package `sage_docbuild`.  
+
+Using the `spkg-src` script, a pip-installable tarball can be generated, which could be uploaded to PyPI -- for the use by external packages that want to build documentation.
+
+This is preparation for #29868 (pip-installable packages sagemath-doc-src, sagemath-doc-inventory, sagemath-doc-html, sagemath-doc-pdf)
+
 
 
 Comment: 1
``````




---

archive/issue_comments_450889.json:
```json
{
    "body": "<a id='comment:36'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-21T19:22:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450889",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:36'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_450890.json:
```json
{
    "body": "<a id='comment:37'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-21T19:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450890",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:37'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_450891.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-02-21T19:33:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450891",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_events_077123.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-21T19:33:48Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "milestone": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30010#event-77123"
}
```



---

archive/issue_events_077124.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-21T19:33:48Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30010#event-77124"
}
```



---

archive/issue_comments_450892.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,16 @@\n+`sage_setup.docbuild` has very different dependencies compared to `sage_setup`:\n+\n+It depends on `sagelib` and `sphinx`, \n+whereas the rest of `sage_setup` is for building `sagelib`.\n+\n+We remove the nesting within `sage_setup`, creating a new top-level package `sage_docbuild`.\n+\n+We split it out as a separate pip-installable distribution package `sage_docbuild`.  \n+\n+Using the `spkg-src` script, a pip-installable tarball can be generated, which could be uploaded to PyPI -- for the use by external packages that want to build documentation.\n+\n+This is preparation for #29868 (pip-installable packages sagemath-doc-src, sagemath-doc-inventory, sagemath-doc-html, sagemath-doc-pdf)\n+\n \n \n Comment: 1\n``````\n",
    "created_at": "2021-02-21T19:35:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450892",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,16 @@
+`sage_setup.docbuild` has very different dependencies compared to `sage_setup`:
+
+It depends on `sagelib` and `sphinx`, 
+whereas the rest of `sage_setup` is for building `sagelib`.
+
+We remove the nesting within `sage_setup`, creating a new top-level package `sage_docbuild`.
+
+We split it out as a separate pip-installable distribution package `sage_docbuild`.  
+
+Using the `spkg-src` script, a pip-installable tarball can be generated, which could be uploaded to PyPI -- for the use by external packages that want to build documentation.
+
+This is preparation for #29868 (pip-installable packages sagemath-doc-src, sagemath-doc-inventory, sagemath-doc-html, sagemath-doc-pdf)
+
 
 
 Comment: 1
``````




---

archive/issue_comments_450893.json:
```json
{
    "body": "<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-21T19:47:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450893",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_450894.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,16 @@\n+`sage_setup.docbuild`, created in #19127, has very different dependencies compared to `sage_setup`:\n+\n+It depends on `sagelib` and `sphinx`, \n+whereas the rest of `sage_setup` is for building `sagelib`.\n+\n+We remove the nesting within `sage_setup`, creating a new top-level package `sage_docbuild`.\n+\n+We split it out as a separate pip-installable distribution package `sage_docbuild`.  \n+\n+Using the `spkg-src` script, a pip-installable tarball can be generated, which could be uploaded to PyPI -- for the use by external packages that want to build documentation.\n+\n+This is preparation for #29868 (pip-installable packages sagemath-doc-src, sagemath-doc-inventory, sagemath-doc-html, sagemath-doc-pdf)\n+\n \n \n Comment: 1\n``````\n",
    "created_at": "2021-02-21T23:32:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450894",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,16 @@
+`sage_setup.docbuild`, created in #19127, has very different dependencies compared to `sage_setup`:
+
+It depends on `sagelib` and `sphinx`, 
+whereas the rest of `sage_setup` is for building `sagelib`.
+
+We remove the nesting within `sage_setup`, creating a new top-level package `sage_docbuild`.
+
+We split it out as a separate pip-installable distribution package `sage_docbuild`.  
+
+Using the `spkg-src` script, a pip-installable tarball can be generated, which could be uploaded to PyPI -- for the use by external packages that want to build documentation.
+
+This is preparation for #29868 (pip-installable packages sagemath-doc-src, sagemath-doc-inventory, sagemath-doc-html, sagemath-doc-pdf)
+
 
 
 Comment: 1
``````




---

archive/issue_comments_450895.json:
```json
{
    "body": "<a id='comment:43'></a>Doctesting fails for me:\n\n```\n./sage -t -p --all --long --logfile=logs/ptestlong.log\nRunning doctests with ID 2021-02-23-09-29-26-45521505.\nGit branch: t/30010/split_sage_setup_docbuild_out_to_a_separate_package\nUsing --optional=build,dochtml,homebrew,pip,sage,sage_spkg\nDoctesting entire Sage library.\nTraceback (most recent call last):\n  File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/src/bin/sage-runtests\", line 182, in <module>\n    err = DC.run()\n  File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/control.py\", line 1206, in run\n    self.expand_files_into_sources()\n  File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/control.py\", line 790, in expand_files_into_sources\n    self.sources = [FileDocTestSource(path, self.options) for path in expand()]\n  File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/control.py\", line 790, in <listcomp>\n    self.sources = [FileDocTestSource(path, self.options) for path in expand()]\n  File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/sources.py\", line 527, in __init__\n    raise ValueError(\"unknown file extension %r\"%ext)\nValueError: unknown file extension ''\nmake: *** [ptestlong] Error 1\n```",
    "created_at": "2021-02-23T19:02:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450895",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:43'></a>Doctesting fails for me:

```
./sage -t -p --all --long --logfile=logs/ptestlong.log
Running doctests with ID 2021-02-23-09-29-26-45521505.
Git branch: t/30010/split_sage_setup_docbuild_out_to_a_separate_package
Using --optional=build,dochtml,homebrew,pip,sage,sage_spkg
Doctesting entire Sage library.
Traceback (most recent call last):
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/src/bin/sage-runtests", line 182, in <module>
    err = DC.run()
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/control.py", line 1206, in run
    self.expand_files_into_sources()
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/control.py", line 790, in expand_files_into_sources
    self.sources = [FileDocTestSource(path, self.options) for path in expand()]
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/control.py", line 790, in <listcomp>
    self.sources = [FileDocTestSource(path, self.options) for path in expand()]
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/sources.py", line 527, in __init__
    raise ValueError("unknown file extension %r"%ext)
ValueError: unknown file extension ''
make: *** [ptestlong] Error 1
```



---

archive/issue_comments_450896.json:
```json
{
    "body": "<a id='comment:44'></a>I think the problem is this:\n\n```diff\ndiff --git a/src/sage/doctest/control.py b/src/sage/doctest/control.py\nindex 7d2b84b9c3..eafcf924de 100644\n--- a/src/sage/doctest/control.py\n+++ b/src/sage/doctest/control.py\n@@ -697,6 +697,7 @@ class DocTestController(SageObject):\n             # don't make sense to run outside a build environment\n             if have_git:\n                 self.files.append(opj(SAGE_SRC, 'sage_setup'))\n+                self.files.append(opj(SAGE_SRC, 'sage_doctest'))\n             self.files.append(SAGE_DOC_SRC)\n \n         if self.options.all or (self.options.new and not have_git):\n```\nShould `sage_doctest` be `sage_docbuild` instead?",
    "created_at": "2021-02-23T19:31:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450896",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:44'></a>I think the problem is this:

```diff
diff --git a/src/sage/doctest/control.py b/src/sage/doctest/control.py
index 7d2b84b9c3..eafcf924de 100644
--- a/src/sage/doctest/control.py
+++ b/src/sage/doctest/control.py
@@ -697,6 +697,7 @@ class DocTestController(SageObject):
             # don't make sense to run outside a build environment
             if have_git:
                 self.files.append(opj(SAGE_SRC, 'sage_setup'))
+                self.files.append(opj(SAGE_SRC, 'sage_doctest'))
             self.files.append(SAGE_DOC_SRC)
 
         if self.options.all or (self.options.new and not have_git):
```
Should `sage_doctest` be `sage_docbuild` instead?



---

archive/issue_comments_450897.json:
```json
{
    "body": "<a id='comment:45'></a>Yes, thanks for catching this! Please push it to the ticket",
    "created_at": "2021-02-23T19:37:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450897",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:45'></a>Yes, thanks for catching this! Please push it to the ticket



---

archive/issue_comments_450898.json:
```json
{
    "body": "<a id='comment:47'></a>The directory structure looks very strange: inside `SAGE_ROOT/build/pkgs/sage_docbuild/src/` I see\n\n```\nbuild\n  lib\n     build\n        lib\n           build\n              lib\n                 build\n                    lib\n                       sage_docbuild\n                 sage_docbuild\n           sage_docbuild\n     sage_docbuild\n```\nwhere indentations indicate levels of subdirectories. For example, I see `SAGE_ROOT/build/pkgs/sage_docbuild/src/build/lib/build/lib/build/lib/build/lib/sage_docbuild`. All of the `sage_docbuild` directories look identical.\n\n---\nNew commits:",
    "created_at": "2021-02-23T21:10:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450898",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:47'></a>The directory structure looks very strange: inside `SAGE_ROOT/build/pkgs/sage_docbuild/src/` I see

```
build
  lib
     build
        lib
           build
              lib
                 build
                    lib
                       sage_docbuild
                 sage_docbuild
           sage_docbuild
     sage_docbuild
```
where indentations indicate levels of subdirectories. For example, I see `SAGE_ROOT/build/pkgs/sage_docbuild/src/build/lib/build/lib/build/lib/build/lib/sage_docbuild`. All of the `sage_docbuild` directories look identical.

---
New commits:



---

archive/issue_comments_450899.json:
```json
{
    "body": "<a id='comment:49'></a>Thanks for catching this! This commit should fix it\n\n---\nNew commits:",
    "created_at": "2021-02-23T21:19:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450899",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:49'></a>Thanks for catching this! This commit should fix it

---
New commits:



---

archive/issue_comments_450900.json:
```json
{
    "body": "<a id='comment:50'></a>Perhaps for another ticket, but shouldn't `make distclean` clean up build artifacts like those subdirectories of `build/pkgs/PKG/src/`? To test the most recent change, I had to delete the extraneous stuff by hand, or alternatively start with a fresh tarball. Since I'm testing with various branches combined (to allow docbuilding to succeed on my Mac, for example), I would rather not use a fresh tarball in these situations.",
    "created_at": "2021-02-23T22:15:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450900",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:50'></a>Perhaps for another ticket, but shouldn't `make distclean` clean up build artifacts like those subdirectories of `build/pkgs/PKG/src/`? To test the most recent change, I had to delete the extraneous stuff by hand, or alternatively start with a fresh tarball. Since I'm testing with various branches combined (to allow docbuilding to succeed on my Mac, for example), I would rather not use a fresh tarball in these situations.



---

archive/issue_comments_450901.json:
```json
{
    "body": "<a id='comment:51'></a>Yes, a target `sage_docbuild-clean` is definitely missing, I'll add one.",
    "created_at": "2021-02-23T23:29:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450901",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:51'></a>Yes, a target `sage_docbuild-clean` is definitely missing, I'll add one.



---

archive/issue_comments_450902.json:
```json
{
    "body": "<a id='comment:52'></a>Replying to [comment:50 jhpalmieri]:\n> I would rather not use a fresh tarball in these situations.\n\n\nWhat works really well for me is `git worktree` - easy to create a new \"distclean\" copy of the branch with this",
    "created_at": "2021-02-23T23:31:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450902",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:52'></a>Replying to [comment:50 jhpalmieri]:
> I would rather not use a fresh tarball in these situations.


What works really well for me is `git worktree` - easy to create a new "distclean" copy of the branch with this



---

archive/issue_comments_450903.json:
```json
{
    "body": "<a id='comment:53'></a>I get this at the start of doctesting:\n\n```\n    ModuleNotFoundError in doctesting framework\n**********************************************************************\nTraceback (most recent call last):\n  File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 2508, in __call__\n    doctests, extras = self._run(runner, options, results)\n  File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 2551, in _run\n    doctests, extras = self.source.create_doctests(sage_namespace)\n  File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/sources.py\", line 733, in create_doctests\n    load(filename, namespace) # errors raised here will be caught in DocTestTask\n  File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/repl/load.py\", line 252, in load\n    exec(code, globals)\n  File \"./clean.py\", line 18, in <module>\nModuleNotFoundError: No module named 'sage_setup.find'\n```\nleading to\n\n```\nsage -t --long --random-seed=0 src/sage_setup/clean.py  # ModuleNotFoundError in doctesting framework\n```\nand then I get other doctest failures:\n\n```\nsage -t --long --random-seed=0 src/sage_setup/find.py  # 6 doctests failed\nsage -t --long --random-seed=0 src/sage_setup/util.py  # 2 doctests failed\nsage -t --long --random-seed=0 src/sage_setup/optional_extension.py  # 2 doctests failed\n```\nThese all have a similar form:\n\n```\n**********************************************************************\nFile \"src/sage_setup/find.py\", line 38, in sage_setup.find.read_distribution\nFailed example:\n    from sage_setup.find import read_distribution\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 714, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1133, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage_setup.find.read_distribution[1]>\", line 1, in <module>\n        from sage_setup.find import read_distribution\n    ModuleNotFoundError: No module named 'sage_setup.find'\n**********************************************************************\nFile \"src/sage_setup/find.py\", line 92, in sage_setup.find.find_python_sources\nFailed example:\n    from sage_setup.find import find_python_sources\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 714, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/forker.py\", line 1133, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage_setup.find.find_python_sources[1]>\", line 1, in <module>\n        from sage_setup.find import find_python_sources\n    ModuleNotFoundError: No module named 'sage_setup.find'\n```",
    "created_at": "2021-02-23T23:52:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450903",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:53'></a>I get this at the start of doctesting:

```
    ModuleNotFoundError in doctesting framework
**********************************************************************
Traceback (most recent call last):
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2508, in __call__
    doctests, extras = self._run(runner, options, results)
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2551, in _run
    doctests, extras = self.source.create_doctests(sage_namespace)
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/sources.py", line 733, in create_doctests
    load(filename, namespace) # errors raised here will be caught in DocTestTask
  File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/repl/load.py", line 252, in load
    exec(code, globals)
  File "./clean.py", line 18, in <module>
ModuleNotFoundError: No module named 'sage_setup.find'
```
leading to

```
sage -t --long --random-seed=0 src/sage_setup/clean.py  # ModuleNotFoundError in doctesting framework
```
and then I get other doctest failures:

```
sage -t --long --random-seed=0 src/sage_setup/find.py  # 6 doctests failed
sage -t --long --random-seed=0 src/sage_setup/util.py  # 2 doctests failed
sage -t --long --random-seed=0 src/sage_setup/optional_extension.py  # 2 doctests failed
```
These all have a similar form:

```
**********************************************************************
File "src/sage_setup/find.py", line 38, in sage_setup.find.read_distribution
Failed example:
    from sage_setup.find import read_distribution
Exception raised:
    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_setup.find.read_distribution[1]>", line 1, in <module>
        from sage_setup.find import read_distribution
    ModuleNotFoundError: No module named 'sage_setup.find'
**********************************************************************
File "src/sage_setup/find.py", line 92, in sage_setup.find.find_python_sources
Failed example:
    from sage_setup.find import find_python_sources
Exception raised:
    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage_setup.find.find_python_sources[1]>", line 1, in <module>
        from sage_setup.find import find_python_sources
    ModuleNotFoundError: No module named 'sage_setup.find'
```



---

archive/issue_comments_450904.json:
```json
{
    "body": "<a id='comment:54'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-24T01:46:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450904",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:54'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_450905.json:
```json
{
    "body": "<a id='comment:55'></a>I don't know how to reproduce the `ModuleNotFoundError`... could you run `make sagelib-clean sagelib` and test again?",
    "created_at": "2021-02-24T01:58:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450905",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:55'></a>I don't know how to reproduce the `ModuleNotFoundError`... could you run `make sagelib-clean sagelib` and test again?



---

archive/issue_comments_450906.json:
```json
{
    "body": "<a id='comment:56'></a>Replying to [comment:55 mkoeppe]:\n> I don't know how to reproduce the `ModuleNotFoundError`... could you run `make sagelib-clean sagelib` and test again?\n\n\nI did that and got the same failures. This was with Sage's own Python and #18272. Then I switched to just this branch and used homebrew's Python and got the same errors.",
    "created_at": "2021-02-24T05:01:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450906",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:56'></a>Replying to [comment:55 mkoeppe]:
> I don't know how to reproduce the `ModuleNotFoundError`... could you run `make sagelib-clean sagelib` and test again?


I did that and got the same failures. This was with Sage's own Python and #18272. Then I switched to just this branch and used homebrew's Python and got the same errors.



---

archive/issue_comments_450907.json:
```json
{
    "body": "<a id='comment:57'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-24T06:08:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450907",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:57'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_450908.json:
```json
{
    "body": "<a id='comment:58'></a>Thanks for testing - I've found the problem now. As a leftover from the previous version of the branch, `sage_setup` had lost its `__init__.py` file, causing an incomplete installation of it in `site-packages`",
    "created_at": "2021-02-24T06:10:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450908",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:58'></a>Thanks for testing - I've found the problem now. As a leftover from the previous version of the branch, `sage_setup` had lost its `__init__.py` file, causing an incomplete installation of it in `site-packages`



---

archive/issue_comments_450909.json:
```json
{
    "body": "<a id='comment:59'></a>Now the `ext` directory is missing from `build/pkgs/sage_docbuild/src/build/lib/sage_docbuild` and similarly for `local/lib/python3.9/site-packages/sage_docbuild`, so the documentation fails to build. It thinks it succeeds \u2014 no error \u2014 but the log file says things like\n\n```\nBuilding ja/a_tour_of_sage.\n\n[a_tour_of] Extension error:\n[a_tour_of] Could not import extension sage_docbuild.ext.inventory_builder (exception: No module named 'sage_docbuild.ext')\nBuild finished. The built documents can be found in /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/share/doc/sage/html/ja/a_tour_of_sage\n```",
    "created_at": "2021-02-24T18:21:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450909",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:59'></a>Now the `ext` directory is missing from `build/pkgs/sage_docbuild/src/build/lib/sage_docbuild` and similarly for `local/lib/python3.9/site-packages/sage_docbuild`, so the documentation fails to build. It thinks it succeeds — no error — but the log file says things like

```
Building ja/a_tour_of_sage.

[a_tour_of] Extension error:
[a_tour_of] Could not import extension sage_docbuild.ext.inventory_builder (exception: No module named 'sage_docbuild.ext')
Build finished. The built documents can be found in /Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.3.beta7/local/share/doc/sage/html/ja/a_tour_of_sage
```



---

archive/issue_comments_450910.json:
```json
{
    "body": "<a id='comment:60'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-24T18:58:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450910",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:60'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_450911.json:
```json
{
    "body": "<a id='comment:61'></a>Sorry, thanks for your patience with this. I was using `find_namespace_packages` wrong, now I have just replaced it with an explicit list of packages.",
    "created_at": "2021-02-24T18:59:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450911",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:61'></a>Sorry, thanks for your patience with this. I was using `find_namespace_packages` wrong, now I have just replaced it with an explicit list of packages.



---

archive/issue_comments_450912.json:
```json
{
    "body": "<a id='comment:62'></a>Can you explain the `dependencies` file? \n\n```\n$(PYTHON) sphinx ../pkgs/sage_docbuild/src/sage_docbuild/*.py ../pkgs/sage_docbuild/src/sage_docbuild/ext/*.py | $(PYTHON_TOOLCHAIN) sagelib\n```\nI don't know what `.../*.py` is supposed to accomplish: how does `make` know what py files are supposed to be there or what to do with those targets?",
    "created_at": "2021-02-25T00:59:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450912",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:62'></a>Can you explain the `dependencies` file? 

```
$(PYTHON) sphinx ../pkgs/sage_docbuild/src/sage_docbuild/*.py ../pkgs/sage_docbuild/src/sage_docbuild/ext/*.py | $(PYTHON_TOOLCHAIN) sagelib
```
I don't know what `.../*.py` is supposed to accomplish: how does `make` know what py files are supposed to be there or what to do with those targets?



---

archive/issue_comments_450913.json:
```json
{
    "body": "<a id='comment:63'></a>These dependencies point to `$SAGE_SRC/docbuild` (going through the symbolic link at `$SAGE_ROOT/build/pkgs/sage_docbuild/src`). `make` expands the wildcard pattern to the source file names there. When they are newer than the timestamp file `$SAGE_LOCAL/var/lib/sage/installed/sage_docbuild-9.3.beta7`, this triggers a rebuild/reinstallation of the package `sage_docbuild`.",
    "created_at": "2021-02-25T01:33:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450913",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:63'></a>These dependencies point to `$SAGE_SRC/docbuild` (going through the symbolic link at `$SAGE_ROOT/build/pkgs/sage_docbuild/src`). `make` expands the wildcard pattern to the source file names there. When they are newer than the timestamp file `$SAGE_LOCAL/var/lib/sage/installed/sage_docbuild-9.3.beta7`, this triggers a rebuild/reinstallation of the package `sage_docbuild`.



---

archive/issue_comments_450914.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-02-25T04:16:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450914",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_450915.json:
```json
{
    "body": "<a id='comment:64'></a>Okay, thanks, that makes sense. This is working for me now, both building from scratch and upgrading from #31344.",
    "created_at": "2021-02-25T04:16:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450915",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:64'></a>Okay, thanks, that makes sense. This is working for me now, both building from scratch and upgrading from #31344.



---

archive/issue_comments_450916.json:
```json
{
    "body": "<a id='comment:65'></a>Thank you!",
    "created_at": "2021-02-25T04:39:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450916",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:65'></a>Thank you!



---

archive/issue_comments_450917.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-03-09T00:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30010#issuecomment-450917",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_077125.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-03-09T00:00:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30010",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30010#event-77125"
}
```
