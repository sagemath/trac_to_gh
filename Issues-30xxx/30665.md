# Issue 30665: Optimize edge iterator for graphs

archive/issues_030428.json:
```json
{
    "body": "This ticket reorganizes and improves the iterator over edges in the graph backends.\n\nCurrently, the code is duplicated for dense and sparse graphs. Also the iterator works by creating successive lists of neighbors. Mostly, an iterator should not create lists of things.\n\nIn case of multiple edges, it might be desirable to create lists of all arcs from `u` to `v`. Otherwise we might risk segmentation faults, if messing with the graph while iterating through it.\n\nWe expose an unsorted edge iterator.\n\nBefore:\n\n```\nsage: G = Graph(loops=False, multiedges=False) \n....: G.add_edges([(i, (i+85)%100) for i in range(100)]) \n....: G.add_edges([(i, (i+37)%100) for i in range(100)]) \n....: G.add_edges([(i, (i+83)%100) for i in range(100)])                                                                                                                                                                                                                                                                                             \nsage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              \n103 \u00b5s \u00b1 10.4 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\nsage: H = G.copy()\nsage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       \n268 \u00b5s \u00b1 2.43 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n\nsage: G = Graph(loops=False, multiedges=False, sparse=False) \n....: G.add_edges([(i, (i+85)%100) for i in range(100)]) \n....: G.add_edges([(i, (i+37)%100) for i in range(100)]) \n....: G.add_edges([(i, (i+83)%100) for i in range(100)])                                                                                                                                                                                                                                                                                                           \nsage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              \n228 \u00b5s \u00b1 40.5 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\nsage: H = G.copy()\nsage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       \n380 \u00b5s \u00b1 2.07 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n\n\nsage: G = Graph(loops=False, multiedges=True) \n....: G.add_edges([(i, (i+85)%100, j) for j in range(20) for i in range(100)]) \n....: G.add_edges([(i, (i+37)%100, j) for j in range(20) for i in range(100)]) \n....: G.add_edges([(i, (i+83)%100, j) for j in range(20) for i in range(100)])                                                                                                                                                                                                                                                                                             \nsage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              \n2.22 ms \u00b1 412 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\nsage: H = G.copy()\nsage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       \n2.94 ms \u00b1 51.1 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n```\n\nAfter:\n\n```\nsage: G = Graph(loops=False, multiedges=False) \n....: G.add_edges([(i, (i+85)%100) for i in range(100)]) \n....: G.add_edges([(i, (i+37)%100) for i in range(100)]) \n....: G.add_edges([(i, (i+83)%100) for i in range(100)])                                                                                                                                                                                                                                                                                                                   \nsage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              \n66.2 \u00b5s \u00b1 693 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\nsage: %timeit edges = list(G.edge_iterator(sort_vertices=False))                                                                                                                                                                                                                                                                                                                 \n50.1 \u00b5s \u00b1 404 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\nsage: H = G.copy()                                                    \nsage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       \n244 \u00b5s \u00b1 13.2 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n\n\nsage: G = Graph(loops=False, multiedges=False, sparse=False) \n....: G.add_edges([(i, (i+85)%100) for i in range(100)]) \n....: G.add_edges([(i, (i+37)%100) for i in range(100)]) \n....: G.add_edges([(i, (i+83)%100) for i in range(100)])                                                                                                                                                                                                                                                                                                                   \nsage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              \n125 \u00b5s \u00b1 597 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\nsage: %timeit edges = list(G.edge_iterator(sort_vertices=False))                                                                                                                                                                                                                                                                                                                 \n112 \u00b5s \u00b1 1.22 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\nsage: H = G.copy()  \nsage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       \n318 \u00b5s \u00b1 44.4 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n\nsage: G = Graph(loops=False, multiedges=True) \n....: G.add_edges([(i, (i+85)%100, j) for j in range(20) for i in range(100)]) \n....: G.add_edges([(i, (i+37)%100, j) for j in range(20) for i in range(100)]) \n....: G.add_edges([(i, (i+83)%100, j) for j in range(20) for i in range(100)])                                                                                                                                                                                                                                                                                             \nsage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              \n1.05 ms \u00b1 3.2 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\nsage: %timeit edges = list(G.edge_iterator(sort_vertices=False))                                                                                                                                                                                                                                                                                                                 \n1.02 ms \u00b1 40.4 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\nsage: H = G.copy()  \nsage: %timeit H == G                                                                                                                                                                \n2.19 ms \u00b1 28.5 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n```\n\n**Keywords:** edge iterator, graph\n\n**Branch/Commit:** [8beb57302c92d17f4b703e53a1170aa0acd80920](https://github.com/sagemath/sagetrac-mirror/commit/8beb57302c92d17f4b703e53a1170aa0acd80920)\n\n**Reviewer:** David Coudert\n\n**Author:** Jonathan Kliem\n\nIssue created by migration from https://trac.sagemath.org/ticket/30665\n\n",
    "closed_at": "2020-10-31T18:07:21Z",
    "created_at": "2020-09-26T07:55:28Z",
    "labels": [
        "component: graph theory",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.3",
    "title": "Optimize edge iterator for graphs",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/30665",
    "user": "https://github.com/kliem"
}
```
This ticket reorganizes and improves the iterator over edges in the graph backends.

Currently, the code is duplicated for dense and sparse graphs. Also the iterator works by creating successive lists of neighbors. Mostly, an iterator should not create lists of things.

In case of multiple edges, it might be desirable to create lists of all arcs from `u` to `v`. Otherwise we might risk segmentation faults, if messing with the graph while iterating through it.

We expose an unsorted edge iterator.

Before:

```
sage: G = Graph(loops=False, multiedges=False) 
....: G.add_edges([(i, (i+85)%100) for i in range(100)]) 
....: G.add_edges([(i, (i+37)%100) for i in range(100)]) 
....: G.add_edges([(i, (i+83)%100) for i in range(100)])                                                                                                                                                                                                                                                                                             
sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              
103 µs ± 10.4 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: H = G.copy()
sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
268 µs ± 2.43 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)

sage: G = Graph(loops=False, multiedges=False, sparse=False) 
....: G.add_edges([(i, (i+85)%100) for i in range(100)]) 
....: G.add_edges([(i, (i+37)%100) for i in range(100)]) 
....: G.add_edges([(i, (i+83)%100) for i in range(100)])                                                                                                                                                                                                                                                                                                           
sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              
228 µs ± 40.5 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: H = G.copy()
sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
380 µs ± 2.07 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)


sage: G = Graph(loops=False, multiedges=True) 
....: G.add_edges([(i, (i+85)%100, j) for j in range(20) for i in range(100)]) 
....: G.add_edges([(i, (i+37)%100, j) for j in range(20) for i in range(100)]) 
....: G.add_edges([(i, (i+83)%100, j) for j in range(20) for i in range(100)])                                                                                                                                                                                                                                                                                             
sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              
2.22 ms ± 412 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: H = G.copy()
sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
2.94 ms ± 51.1 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
```

After:

```
sage: G = Graph(loops=False, multiedges=False) 
....: G.add_edges([(i, (i+85)%100) for i in range(100)]) 
....: G.add_edges([(i, (i+37)%100) for i in range(100)]) 
....: G.add_edges([(i, (i+83)%100) for i in range(100)])                                                                                                                                                                                                                                                                                                                   
sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              
66.2 µs ± 693 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit edges = list(G.edge_iterator(sort_vertices=False))                                                                                                                                                                                                                                                                                                                 
50.1 µs ± 404 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: H = G.copy()                                                    
sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
244 µs ± 13.2 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)


sage: G = Graph(loops=False, multiedges=False, sparse=False) 
....: G.add_edges([(i, (i+85)%100) for i in range(100)]) 
....: G.add_edges([(i, (i+37)%100) for i in range(100)]) 
....: G.add_edges([(i, (i+83)%100) for i in range(100)])                                                                                                                                                                                                                                                                                                                   
sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              
125 µs ± 597 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: %timeit edges = list(G.edge_iterator(sort_vertices=False))                                                                                                                                                                                                                                                                                                                 
112 µs ± 1.22 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
sage: H = G.copy()  
sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
318 µs ± 44.4 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)

sage: G = Graph(loops=False, multiedges=True) 
....: G.add_edges([(i, (i+85)%100, j) for j in range(20) for i in range(100)]) 
....: G.add_edges([(i, (i+37)%100, j) for j in range(20) for i in range(100)]) 
....: G.add_edges([(i, (i+83)%100, j) for j in range(20) for i in range(100)])                                                                                                                                                                                                                                                                                             
sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              
1.05 ms ± 3.2 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit edges = list(G.edge_iterator(sort_vertices=False))                                                                                                                                                                                                                                                                                                                 
1.02 ms ± 40.4 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: H = G.copy()  
sage: %timeit H == G                                                                                                                                                                
2.19 ms ± 28.5 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
```

**Keywords:** edge iterator, graph

**Branch/Commit:** [8beb57302c92d17f4b703e53a1170aa0acd80920](https://github.com/sagemath/sagetrac-mirror/commit/8beb57302c92d17f4b703e53a1170aa0acd80920)

**Reviewer:** David Coudert

**Author:** Jonathan Kliem

Issue created by migration from https://trac.sagemath.org/ticket/30665





---

archive/issue_comments_492267.json:
```json
{
    "body": "**Branch:** [u/gh-kliem/graphs_improve_edge_iterator](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-kliem/graphs_improve_edge_iterator)",
    "created_at": "2020-09-26T09:09:52Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492267",
    "user": "https://github.com/kliem"
}
```

**Branch:** [u/gh-kliem/graphs_improve_edge_iterator](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-kliem/graphs_improve_edge_iterator)



---

archive/issue_comments_492268.json:
```json
{
    "body": "<a id='comment:2'></a>\n**Branch pushed to git repo; I updated commit sha1.** **Last 10 new commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b8597a071a9db5920a54165f88ac5c600aa7c73c\">b8597a0</a></td><td><code>implement next_in_neighbor_unsafe for dense graph and use it</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2813ed7e44f0b8817cc66962f34748e288ea2873\">2813ed7</a></td><td><code>copyright edit</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7d7beaca31e858715e7baaaec44e7ef7a5f76c8e\">7d7beac</a></td><td><code>document new methods</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ad9486cde5a4f7da6afe68570ec5dbb8213fdd46\">ad9486c</a></td><td><code>fit design of dense grpah to sparse graph</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/45921caaee759728c5854de5f4c2f5f8b42128f7\">45921ca</a></td><td><code>implement `out_neighbors_unsafe` and `in_neighbors_unsafe` for CGraphs</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e58dfa9649087d2bd78880b347ca6fc02a2f35a0\">e58dfa9</a></td><td><code>somehow working version</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a140b0836503af1015c0fca1d232cd27e53abafb\">a140b08</a></td><td><code>let next_neighbor set the arc</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2e6a311b33a9c7749e51a271630e9d9e67c3a765\">2e6a311</a></td><td><code>somehow working version</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1f5a6405a07fba86f22bb435309fb0cea51f6f27\">1f5a640</a></td><td><code>fix incorrect doctests; iterator_edges is only supposed to be called in the undirected case</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/86fdd80d12e24f314b9fe291e7a20c033dcff3ac\">86fdd80</a></td><td><code>clean up</code></td></tr></table>\n",
    "created_at": "2020-09-26T09:10:06Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492268",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>
**Branch pushed to git repo; I updated commit sha1.** **Last 10 new commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b8597a071a9db5920a54165f88ac5c600aa7c73c">b8597a0</a></td><td><code>implement next_in_neighbor_unsafe for dense graph and use it</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2813ed7e44f0b8817cc66962f34748e288ea2873">2813ed7</a></td><td><code>copyright edit</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7d7beaca31e858715e7baaaec44e7ef7a5f76c8e">7d7beac</a></td><td><code>document new methods</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ad9486cde5a4f7da6afe68570ec5dbb8213fdd46">ad9486c</a></td><td><code>fit design of dense grpah to sparse graph</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/45921caaee759728c5854de5f4c2f5f8b42128f7">45921ca</a></td><td><code>implement `out_neighbors_unsafe` and `in_neighbors_unsafe` for CGraphs</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e58dfa9649087d2bd78880b347ca6fc02a2f35a0">e58dfa9</a></td><td><code>somehow working version</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a140b0836503af1015c0fca1d232cd27e53abafb">a140b08</a></td><td><code>let next_neighbor set the arc</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2e6a311b33a9c7749e51a271630e9d9e67c3a765">2e6a311</a></td><td><code>somehow working version</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1f5a6405a07fba86f22bb435309fb0cea51f6f27">1f5a640</a></td><td><code>fix incorrect doctests; iterator_edges is only supposed to be called in the undirected case</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/86fdd80d12e24f314b9fe291e7a20c033dcff3ac">86fdd80</a></td><td><code>clean up</code></td></tr></table>




---

archive/issue_comments_492269.json:
```json
{
    "body": "**Commit:** [86fdd80d12e24f314b9fe291e7a20c033dcff3ac](https://github.com/sagemath/sagetrac-mirror/commit/86fdd80d12e24f314b9fe291e7a20c033dcff3ac)",
    "created_at": "2020-09-26T09:10:06Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492269",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Commit:** [86fdd80d12e24f314b9fe291e7a20c033dcff3ac](https://github.com/sagemath/sagetrac-mirror/commit/86fdd80d12e24f314b9fe291e7a20c033dcff3ac)



---

archive/issue_comments_492270.json:
```json
{
    "body": "<a id='comment:3'></a>\nin method `next_in_neighbor_unsafe` in `dense_graph.pyx`,  instead of `for i in range(u, self.active_vertices.size)`, you could use `bitset_next(self.active_vertices, u)`.",
    "created_at": "2020-09-26T10:49:22Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492270",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:3'></a>
in method `next_in_neighbor_unsafe` in `dense_graph.pyx`,  instead of `for i in range(u, self.active_vertices.size)`, you could use `bitset_next(self.active_vertices, u)`.



---

archive/issue_comments_492271.json:
```json
{
    "body": "**Changing commit** from \"[86fdd80d12e24f314b9fe291e7a20c033dcff3ac](https://github.com/sagemath/sagetrac-mirror/commit/86fdd80d12e24f314b9fe291e7a20c033dcff3ac)\" to \"[90659358abd6cc5f1fad387cb085a0d5f351c4c3](https://github.com/sagemath/sagetrac-mirror/commit/90659358abd6cc5f1fad387cb085a0d5f351c4c3)\".",
    "created_at": "2020-09-26T13:33:40Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492271",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[86fdd80d12e24f314b9fe291e7a20c033dcff3ac](https://github.com/sagemath/sagetrac-mirror/commit/86fdd80d12e24f314b9fe291e7a20c033dcff3ac)" to "[90659358abd6cc5f1fad387cb085a0d5f351c4c3](https://github.com/sagemath/sagetrac-mirror/commit/90659358abd6cc5f1fad387cb085a0d5f351c4c3)".



---

archive/issue_comments_492272.json:
```json
{
    "body": "<a id='comment:4'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3a65a5c3f0302dfe719bcf81e74d71fd2e974497\">3a65a5c</a></td><td><code>merge in multiple edges</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/66ce9411ad69f8bf0de346f1f953540ff48e367b\">66ce941</a></td><td><code>expose unsorted</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/90659358abd6cc5f1fad387cb085a0d5f351c4c3\">9065935</a></td><td><code>remove duplications</code></td></tr></table>\n",
    "created_at": "2020-09-26T13:33:40Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492272",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3a65a5c3f0302dfe719bcf81e74d71fd2e974497">3a65a5c</a></td><td><code>merge in multiple edges</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/66ce9411ad69f8bf0de346f1f953540ff48e367b">66ce941</a></td><td><code>expose unsorted</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/90659358abd6cc5f1fad387cb085a0d5f351c4c3">9065935</a></td><td><code>remove duplications</code></td></tr></table>




---

archive/issue_comments_492273.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [@dcoudert](#comment%3A3):\n> in method `next_in_neighbor_unsafe` in `dense_graph.pyx`,  instead of `for i in range(u, self.active_vertices.size)`, you could use `bitset_next(self.active_vertices, u)`.\n\nI'm not sure I understand.\n\nThere are a bunch of bitsets (a total of `self.active_vertices.size - u`) and I'm trying to figure out, if one of them contains `v`. I don't see, how to apply `bitset_next` in this situation.\n\ndense graphs shouldn't reimplement bitsets for their edges, but that is a different story.",
    "created_at": "2020-09-26T13:44:28Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492273",
    "user": "https://github.com/kliem"
}
```

<a id='comment:5'></a>
Replying to [@dcoudert](#comment%3A3):
> in method `next_in_neighbor_unsafe` in `dense_graph.pyx`,  instead of `for i in range(u, self.active_vertices.size)`, you could use `bitset_next(self.active_vertices, u)`.

I'm not sure I understand.

There are a bunch of bitsets (a total of `self.active_vertices.size - u`) and I'm trying to figure out, if one of them contains `v`. I don't see, how to apply `bitset_next` in this situation.

dense graphs shouldn't reimplement bitsets for their edges, but that is a different story.



---

archive/issue_comments_492274.json:
```json
{
    "body": "<a id='comment:6'></a>\nI'm just saying that we can do something like:\n\n```\ncdef size_t i = u\nwhile i != -1:\n    if self.edges[place + i * self.num_longs] & word:\n        return i\n    i = bitset_next(self.active_vertices, i)\nreturn -1\n```\nI don't know if it is faster or not for dense graphs.",
    "created_at": "2020-09-26T13:53:30Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492274",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:6'></a>
I'm just saying that we can do something like:

```
cdef size_t i = u
while i != -1:
    if self.edges[place + i * self.num_longs] & word:
        return i
    i = bitset_next(self.active_vertices, i)
return -1
```
I don't know if it is faster or not for dense graphs.



---

archive/issue_comments_492275.json:
```json
{
    "body": "<a id='comment:7'></a>\nOk. Sure. It is cleaner.",
    "created_at": "2020-09-26T13:54:42Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492275",
    "user": "https://github.com/kliem"
}
```

<a id='comment:7'></a>
Ok. Sure. It is cleaner.



---

archive/issue_comments_492276.json:
```json
{
    "body": "<a id='comment:8'></a>\nBtw, `bitset_next(foo, i)` will give the next element including `i`.\n\nContrary to that `next_in_neighbor_unsafe(v, u, l)` will give the next element not including `u`. The reason for this is that in sparse graphs the arcs are grouped into a couple of trees according to `u & hash_mask`. So it is much easier to obtain the next arc in the same tree. So `next_in_neighbor_unsafe` will sort the `u`s not by total order but different.\n\nI don't want `CGraph` to know how this works, so this way `CGraph` can just trust the specification to figure out, what would be the next neighbor.",
    "created_at": "2020-09-26T14:32:24Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492276",
    "user": "https://github.com/kliem"
}
```

<a id='comment:8'></a>
Btw, `bitset_next(foo, i)` will give the next element including `i`.

Contrary to that `next_in_neighbor_unsafe(v, u, l)` will give the next element not including `u`. The reason for this is that in sparse graphs the arcs are grouped into a couple of trees according to `u & hash_mask`. So it is much easier to obtain the next arc in the same tree. So `next_in_neighbor_unsafe` will sort the `u`s not by total order but different.

I don't want `CGraph` to know how this works, so this way `CGraph` can just trust the specification to figure out, what would be the next neighbor.



---

archive/issue_comments_492277.json:
```json
{
    "body": "<a id='comment:9'></a>\nFor now I would leave static sparse as it is and just define `iterator_unsorted_edges = iterator_edges`.\n\nIn order to specify `next_in_neighbor_unsafe` for static sparse efficiently, one should add something like `u_index` to the signature. I don't know if there is much need for it.",
    "created_at": "2020-09-26T14:40:22Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492277",
    "user": "https://github.com/kliem"
}
```

<a id='comment:9'></a>
For now I would leave static sparse as it is and just define `iterator_unsorted_edges = iterator_edges`.

In order to specify `next_in_neighbor_unsafe` for static sparse efficiently, one should add something like `u_index` to the signature. I don't know if there is much need for it.



---

archive/issue_comments_492278.json:
```json
{
    "body": "<a id='comment:10'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2de7ce2d89ba7810398b92e1211f6bc72ea9e4f7\">2de7ce2</a></td><td><code>switch u and v in place</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bd5aa2fa8195f8473e3a4360c57d0ebd94e4cbba\">bd5aa2f</a></td><td><code>fix for directed multiedge graphs with labels</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/aace5f75af9bcf108446a4c86644c37684c9bd5d\">aace5f7</a></td><td><code>use unsorted edges to speed up equality check</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/1a85353a799f43804ade03a18afc9603c773abea\">1a85353</a></td><td><code>reviewers suggestion</code></td></tr></table>\n",
    "created_at": "2020-09-26T14:41:12Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492278",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2de7ce2d89ba7810398b92e1211f6bc72ea9e4f7">2de7ce2</a></td><td><code>switch u and v in place</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bd5aa2fa8195f8473e3a4360c57d0ebd94e4cbba">bd5aa2f</a></td><td><code>fix for directed multiedge graphs with labels</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/aace5f75af9bcf108446a4c86644c37684c9bd5d">aace5f7</a></td><td><code>use unsorted edges to speed up equality check</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/1a85353a799f43804ade03a18afc9603c773abea">1a85353</a></td><td><code>reviewers suggestion</code></td></tr></table>




---

archive/issue_comments_492279.json:
```json
{
    "body": "**Changing commit** from \"[90659358abd6cc5f1fad387cb085a0d5f351c4c3](https://github.com/sagemath/sagetrac-mirror/commit/90659358abd6cc5f1fad387cb085a0d5f351c4c3)\" to \"[1a85353a799f43804ade03a18afc9603c773abea](https://github.com/sagemath/sagetrac-mirror/commit/1a85353a799f43804ade03a18afc9603c773abea)\".",
    "created_at": "2020-09-26T14:41:12Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492279",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[90659358abd6cc5f1fad387cb085a0d5f351c4c3](https://github.com/sagemath/sagetrac-mirror/commit/90659358abd6cc5f1fad387cb085a0d5f351c4c3)" to "[1a85353a799f43804ade03a18afc9603c773abea](https://github.com/sagemath/sagetrac-mirror/commit/1a85353a799f43804ade03a18afc9603c773abea)".



---

archive/issue_comments_492280.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -3,3 +3,81 @@\n Currently, the code is duplicated for dense and sparse graphs. Also the iterator works by creating successive lists of neighbors. Mostly, an iterator should not create lists of things.\n \n In case of multiple edges, it might be desirable to create lists of all arcs from `u` to `v`. Otherwise we might risk segmentation faults, if messing with the graph while iterating through it.\n+\n+We expose an unsorted edge iterator.\n+\n+Before:\n+\n+```\n+sage: G = Graph(loops=False, multiedges=False) \n+....: G.add_edges([(i, (i+85)%100) for i in range(100)]) \n+....: G.add_edges([(i, (i+37)%100) for i in range(100)]) \n+....: G.add_edges([(i, (i+83)%100) for i in range(100)])                                                                                                                                                                                                                                                                                             \n+sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              \n+103 \u00b5s \u00b1 10.4 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n+sage: H = G.copy()\n+sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       \n+268 \u00b5s \u00b1 2.43 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n+\n+sage: G = Graph(loops=False, multiedges=False, sparse=False) \n+....: G.add_edges([(i, (i+85)%100) for i in range(100)]) \n+....: G.add_edges([(i, (i+37)%100) for i in range(100)]) \n+....: G.add_edges([(i, (i+83)%100) for i in range(100)])                                                                                                                                                                                                                                                                                                           \n+sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              \n+228 \u00b5s \u00b1 40.5 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n+sage: H = G.copy()\n+sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       \n+380 \u00b5s \u00b1 2.07 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n+\n+\n+sage: G = Graph(loops=False, multiedges=True) \n+....: G.add_edges([(i, (i+85)%100, j) for j in range(20) for i in range(100)]) \n+....: G.add_edges([(i, (i+37)%100, j) for j in range(20) for i in range(100)]) \n+....: G.add_edges([(i, (i+83)%100, j) for j in range(20) for i in range(100)])                                                                                                                                                                                                                                                                                             \n+sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              \n+2.22 ms \u00b1 412 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n+sage: H = G.copy()\n+sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       \n+2.94 ms \u00b1 51.1 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n+```\n+\n+After:\n+\n+```\n+sage: G = Graph(loops=False, multiedges=False) \n+....: G.add_edges([(i, (i+85)%100) for i in range(100)]) \n+....: G.add_edges([(i, (i+37)%100) for i in range(100)]) \n+....: G.add_edges([(i, (i+83)%100) for i in range(100)])                                                                                                                                                                                                                                                                                                                   \n+sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              \n+66.2 \u00b5s \u00b1 693 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n+sage: %timeit edges = list(G.edge_iterator(unsorted=True))                                                                                                                                                                                                                                                                                                                 \n+50.1 \u00b5s \u00b1 404 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n+sage: H = G.copy()                                                    \n+sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       \n+244 \u00b5s \u00b1 13.2 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n+\n+\n+sage: G = Graph(loops=False, multiedges=False, sparse=False) \n+....: G.add_edges([(i, (i+85)%100) for i in range(100)]) \n+....: G.add_edges([(i, (i+37)%100) for i in range(100)]) \n+....: G.add_edges([(i, (i+83)%100) for i in range(100)])                                                                                                                                                                                                                                                                                                                   \n+sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              \n+125 \u00b5s \u00b1 597 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n+sage: %timeit edges = list(G.edge_iterator(unsorted=True))                                                                                                                                                                                                                                                                                                                 \n+112 \u00b5s \u00b1 1.22 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n+sage: H = G.copy()  \n+sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       \n+318 \u00b5s \u00b1 44.4 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n+\n+sage: G = Graph(loops=False, multiedges=True) \n+....: G.add_edges([(i, (i+85)%100, j) for j in range(20) for i in range(100)]) \n+....: G.add_edges([(i, (i+37)%100, j) for j in range(20) for i in range(100)]) \n+....: G.add_edges([(i, (i+83)%100, j) for j in range(20) for i in range(100)])                                                                                                                                                                                                                                                                                             \n+sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              \n+1.05 ms \u00b1 3.2 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n+sage: %timeit edges = list(G.edge_iterator(unsorted=True))                                                                                                                                                                                                                                                                                                                 \n+1.02 ms \u00b1 40.4 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n+sage: H = G.copy()  \n+sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       \n+2.81 ms \u00b1 725 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n+```\n``````\n",
    "created_at": "2020-09-26T14:57:13Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492280",
    "user": "https://github.com/kliem"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -3,3 +3,81 @@
 Currently, the code is duplicated for dense and sparse graphs. Also the iterator works by creating successive lists of neighbors. Mostly, an iterator should not create lists of things.
 
 In case of multiple edges, it might be desirable to create lists of all arcs from `u` to `v`. Otherwise we might risk segmentation faults, if messing with the graph while iterating through it.
+
+We expose an unsorted edge iterator.
+
+Before:
+
+```
+sage: G = Graph(loops=False, multiedges=False) 
+....: G.add_edges([(i, (i+85)%100) for i in range(100)]) 
+....: G.add_edges([(i, (i+37)%100) for i in range(100)]) 
+....: G.add_edges([(i, (i+83)%100) for i in range(100)])                                                                                                                                                                                                                                                                                             
+sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              
+103 µs ± 10.4 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
+sage: H = G.copy()
+sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
+268 µs ± 2.43 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
+
+sage: G = Graph(loops=False, multiedges=False, sparse=False) 
+....: G.add_edges([(i, (i+85)%100) for i in range(100)]) 
+....: G.add_edges([(i, (i+37)%100) for i in range(100)]) 
+....: G.add_edges([(i, (i+83)%100) for i in range(100)])                                                                                                                                                                                                                                                                                                           
+sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              
+228 µs ± 40.5 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
+sage: H = G.copy()
+sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
+380 µs ± 2.07 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
+
+
+sage: G = Graph(loops=False, multiedges=True) 
+....: G.add_edges([(i, (i+85)%100, j) for j in range(20) for i in range(100)]) 
+....: G.add_edges([(i, (i+37)%100, j) for j in range(20) for i in range(100)]) 
+....: G.add_edges([(i, (i+83)%100, j) for j in range(20) for i in range(100)])                                                                                                                                                                                                                                                                                             
+sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              
+2.22 ms ± 412 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
+sage: H = G.copy()
+sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
+2.94 ms ± 51.1 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
+```
+
+After:
+
+```
+sage: G = Graph(loops=False, multiedges=False) 
+....: G.add_edges([(i, (i+85)%100) for i in range(100)]) 
+....: G.add_edges([(i, (i+37)%100) for i in range(100)]) 
+....: G.add_edges([(i, (i+83)%100) for i in range(100)])                                                                                                                                                                                                                                                                                                                   
+sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              
+66.2 µs ± 693 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
+sage: %timeit edges = list(G.edge_iterator(unsorted=True))                                                                                                                                                                                                                                                                                                                 
+50.1 µs ± 404 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
+sage: H = G.copy()                                                    
+sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
+244 µs ± 13.2 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
+
+
+sage: G = Graph(loops=False, multiedges=False, sparse=False) 
+....: G.add_edges([(i, (i+85)%100) for i in range(100)]) 
+....: G.add_edges([(i, (i+37)%100) for i in range(100)]) 
+....: G.add_edges([(i, (i+83)%100) for i in range(100)])                                                                                                                                                                                                                                                                                                                   
+sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              
+125 µs ± 597 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
+sage: %timeit edges = list(G.edge_iterator(unsorted=True))                                                                                                                                                                                                                                                                                                                 
+112 µs ± 1.22 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
+sage: H = G.copy()  
+sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
+318 µs ± 44.4 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
+
+sage: G = Graph(loops=False, multiedges=True) 
+....: G.add_edges([(i, (i+85)%100, j) for j in range(20) for i in range(100)]) 
+....: G.add_edges([(i, (i+37)%100, j) for j in range(20) for i in range(100)]) 
+....: G.add_edges([(i, (i+83)%100, j) for j in range(20) for i in range(100)])                                                                                                                                                                                                                                                                                             
+sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              
+1.05 ms ± 3.2 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
+sage: %timeit edges = list(G.edge_iterator(unsorted=True))                                                                                                                                                                                                                                                                                                                 
+1.02 ms ± 40.4 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
+sage: H = G.copy()  
+sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
+2.81 ms ± 725 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
+```
``````




---

archive/issue_comments_492281.json:
```json
{
    "body": "**Changing commit** from \"[1a85353a799f43804ade03a18afc9603c773abea](https://github.com/sagemath/sagetrac-mirror/commit/1a85353a799f43804ade03a18afc9603c773abea)\" to \"[4920ec8452527d3cd73048af6a74976575f9c7c0](https://github.com/sagemath/sagetrac-mirror/commit/4920ec8452527d3cd73048af6a74976575f9c7c0)\".",
    "created_at": "2020-09-26T15:05:34Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492281",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[1a85353a799f43804ade03a18afc9603c773abea](https://github.com/sagemath/sagetrac-mirror/commit/1a85353a799f43804ade03a18afc9603c773abea)" to "[4920ec8452527d3cd73048af6a74976575f9c7c0](https://github.com/sagemath/sagetrac-mirror/commit/4920ec8452527d3cd73048af6a74976575f9c7c0)".



---

archive/issue_comments_492282.json:
```json
{
    "body": "<a id='comment:12'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4920ec8452527d3cd73048af6a74976575f9c7c0\">4920ec8</a></td><td><code>document that an iterator can be used to relabel edges</code></td></tr></table>\n",
    "created_at": "2020-09-26T15:05:34Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492282",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4920ec8452527d3cd73048af6a74976575f9c7c0">4920ec8</a></td><td><code>document that an iterator can be used to relabel edges</code></td></tr></table>




---

archive/issue_comments_492283.json:
```json
{
    "body": "<a id='comment:13'></a>\nCode uses an edge iterator to relabel or vertices for example.\n\nI documented that this is somewhat safe. This was one of my problem. In between I had segmentation faults because of this, because I was storing pointers to nodes, which were no longer valid.",
    "created_at": "2020-09-26T15:06:56Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492283",
    "user": "https://github.com/kliem"
}
```

<a id='comment:13'></a>
Code uses an edge iterator to relabel or vertices for example.

I documented that this is somewhat safe. This was one of my problem. In between I had segmentation faults because of this, because I was storing pointers to nodes, which were no longer valid.



---

archive/issue_events_274664.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-09-26T15:11:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30665#event-274664"
}
```



---

archive/issue_comments_492284.json:
```json
{
    "body": "<a id='comment:14'></a>\nI pretty much happy with it for now.\n\nI even managed to reduce the overall number of lines in the code while optimizing.\n\nThere are some optimizations that were simply not necessary. The compiler will figure out case distinctions like `label` pretty good itself. If not, it usually doesn't matter for performance. I guess there are some cases, were compilers are pretty bad, but here it works all right and there is no need to duplicate code.",
    "created_at": "2020-09-26T15:11:33Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492284",
    "user": "https://github.com/kliem"
}
```

<a id='comment:14'></a>
I pretty much happy with it for now.

I even managed to reduce the overall number of lines in the code while optimizing.

There are some optimizations that were simply not necessary. The compiler will figure out case distinctions like `label` pretty good itself. If not, it usually doesn't matter for performance. I guess there are some cases, were compilers are pretty bad, but here it works all right and there is no need to duplicate code.



---

archive/issue_comments_492285.json:
```json
{
    "body": "<a id='comment:15'></a>\nThis is nice.\n\nYou added `unsorted` to `edge_iterator`. You could also add it to `edges` and to  `EdgesView` in `views.pyx`. We can of course let that for another ticket. We will have to check in many methods if we can benefit from this new parameter or not. Reducing the number of places where we sort is an important objective.",
    "created_at": "2020-09-26T15:48:57Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492285",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:15'></a>
This is nice.

You added `unsorted` to `edge_iterator`. You could also add it to `edges` and to  `EdgesView` in `views.pyx`. We can of course let that for another ticket. We will have to check in many methods if we can benefit from this new parameter or not. Reducing the number of places where we sort is an important objective.



---

archive/issue_comments_492286.json:
```json
{
    "body": "<a id='comment:16'></a>\nOnce this is in you may want to check whether this also solves\nother \"edge\"-y tickets:\n\n- https://trac.sagemath.org/query?order=id&desc=1&status=!closed&summary=~edge",
    "created_at": "2020-09-26T16:11:33Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492286",
    "user": "https://github.com/slel"
}
```

<a id='comment:16'></a>
Once this is in you may want to check whether this also solves
other "edge"-y tickets:

- https://trac.sagemath.org/query?order=id&desc=1&status=!closed&summary=~edge



---

archive/issue_comments_492287.json:
```json
{
    "body": "<a id='comment:17'></a>\nPatchbot reports doctest failures :\n\nThere is a problem in `src/sage/combinat/cluster_algebra_quiver/mutation_class.py`\naround line 520, where one iterates over edges and modify the edges at the same time (direct access to the backend).",
    "created_at": "2020-09-27T06:53:53Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492287",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:17'></a>
Patchbot reports doctest failures :

There is a problem in `src/sage/combinat/cluster_algebra_quiver/mutation_class.py`
around line 520, where one iterates over edges and modify the edges at the same time (direct access to the backend).



---

archive/issue_comments_492288.json:
```json
{
    "body": "<a id='comment:18'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5fc372298b06c774a61da17098b335e0eb9a018d\">5fc3722</a></td><td><code>fix wrong usage and document it</code></td></tr></table>\n",
    "created_at": "2020-09-27T17:22:19Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492288",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5fc372298b06c774a61da17098b335e0eb9a018d">5fc3722</a></td><td><code>fix wrong usage and document it</code></td></tr></table>




---

archive/issue_comments_492289.json:
```json
{
    "body": "**Changing commit** from \"[4920ec8452527d3cd73048af6a74976575f9c7c0](https://github.com/sagemath/sagetrac-mirror/commit/4920ec8452527d3cd73048af6a74976575f9c7c0)\" to \"[5fc372298b06c774a61da17098b335e0eb9a018d](https://github.com/sagemath/sagetrac-mirror/commit/5fc372298b06c774a61da17098b335e0eb9a018d)\".",
    "created_at": "2020-09-27T17:22:19Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492289",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[4920ec8452527d3cd73048af6a74976575f9c7c0](https://github.com/sagemath/sagetrac-mirror/commit/4920ec8452527d3cd73048af6a74976575f9c7c0)" to "[5fc372298b06c774a61da17098b335e0eb9a018d](https://github.com/sagemath/sagetrac-mirror/commit/5fc372298b06c774a61da17098b335e0eb9a018d)".



---

archive/issue_comments_492290.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [@fchapoton](#comment%3A17):\n> Patchbot reports doctest failures :\n> \n> There is a problem in `src/sage/combinat/cluster_algebra_quiver/mutation_class.py`\n> around line 520, where one iterates over edges and modify the edges at the same time (direct access to the backend). \n\nThank you. That was an easy one. I think it is just wrong to modify the vertices and not specify ``vertices``. It is difficult to know, what a user wants at this point.\n\nI fixed it and documented this.\n\nIt is also kind of wrong to modify the edges while iterating, but as long as the vertices are well-defined this works and its the users problem to deal with whether new edges will appear in this run or not (unless you modify the current edge, like relabeling or deleting, then things are well-defined).",
    "created_at": "2020-09-27T17:29:56Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492290",
    "user": "https://github.com/kliem"
}
```

<a id='comment:19'></a>
Replying to [@fchapoton](#comment%3A17):
> Patchbot reports doctest failures :
> 
> There is a problem in `src/sage/combinat/cluster_algebra_quiver/mutation_class.py`
> around line 520, where one iterates over edges and modify the edges at the same time (direct access to the backend). 

Thank you. That was an easy one. I think it is just wrong to modify the vertices and not specify ``vertices``. It is difficult to know, what a user wants at this point.

I fixed it and documented this.

It is also kind of wrong to modify the edges while iterating, but as long as the vertices are well-defined this works and its the users problem to deal with whether new edges will appear in this run or not (unless you modify the current edge, like relabeling or deleting, then things are well-defined).



---

archive/issue_comments_492291.json:
```json
{
    "body": "<a id='comment:20'></a>\nIt is generally unsafe to modify the graph while iterating over the edges.\nSi I'm not sure the proposed modification is sufficient to solve the issue",
    "created_at": "2020-09-28T09:53:25Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492291",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:20'></a>
It is generally unsafe to modify the graph while iterating over the edges.
Si I'm not sure the proposed modification is sufficient to solve the issue



---

archive/issue_comments_492292.json:
```json
{
    "body": "<a id='comment:21'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5e91e9976bac1db76f819bca9c3c14f704cdaa11\">5e91e99</a></td><td><code>make iterator saver</code></td></tr></table>\n",
    "created_at": "2020-09-28T10:04:23Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492292",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5e91e9976bac1db76f819bca9c3c14f704cdaa11">5e91e99</a></td><td><code>make iterator saver</code></td></tr></table>




---

archive/issue_comments_492293.json:
```json
{
    "body": "**Changing commit** from \"[5fc372298b06c774a61da17098b335e0eb9a018d](https://github.com/sagemath/sagetrac-mirror/commit/5fc372298b06c774a61da17098b335e0eb9a018d)\" to \"[5e91e9976bac1db76f819bca9c3c14f704cdaa11](https://github.com/sagemath/sagetrac-mirror/commit/5e91e9976bac1db76f819bca9c3c14f704cdaa11)\".",
    "created_at": "2020-09-28T10:04:23Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492293",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[5fc372298b06c774a61da17098b335e0eb9a018d](https://github.com/sagemath/sagetrac-mirror/commit/5fc372298b06c774a61da17098b335e0eb9a018d)" to "[5e91e9976bac1db76f819bca9c3c14f704cdaa11](https://github.com/sagemath/sagetrac-mirror/commit/5e91e9976bac1db76f819bca9c3c14f704cdaa11)".



---

archive/issue_comments_492294.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [@dcoudert](#comment%3A20):\n> It is generally unsafe to modify the graph while iterating over the edges.\n> Si I'm not sure the proposed modification is sufficient to solve the issue\n\nI agree that iterating over something while modifying it, is not a good idea usually. It is nice, if you can relabel edges or delete some of them, without getting a complete list.\n\nI added a quick check, that `v_int` is still and active vertex. This indeed was a big issue (potentially segmentation fault), but also the only issue I can think of (which doesn't mean that it is the only one). Here are my thoughts about it:\n\n`next_neighbor_unsafe` will just pick the next neighbor as long as `v_int` is an active vertex. If there are multiple arcs, they will be cached in a list, before yielding anything. This way things should be safe.\n\nHowever, if you delete an edge and then add one, it might happen that the meaning of `v_int` changes. I think, this is the users problem. You shouldn't ask for all edges out of a vertex and then along the way delete it and assume that things are fine.\n\nIf you have multiple arcs and delete them after obtaining the first arc was yield by the iterator, this is the users problem. The other arcs will still be output, but things should be safe as long as you use safe methods.\n\nIf you add/delete/modify edges, things are fine otherwise. However, it might happen that a new edge will be yield by the iterator or not (according to internal order). If you use the edge iterator to relabel edges things are fine, as long as you do not have multiple edges. (Once you have seen an edge `(1,2)`, you know that it will not be output according to internal order again.)",
    "created_at": "2020-09-28T10:21:12Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492294",
    "user": "https://github.com/kliem"
}
```

<a id='comment:22'></a>
Replying to [@dcoudert](#comment%3A20):
> It is generally unsafe to modify the graph while iterating over the edges.
> Si I'm not sure the proposed modification is sufficient to solve the issue

I agree that iterating over something while modifying it, is not a good idea usually. It is nice, if you can relabel edges or delete some of them, without getting a complete list.

I added a quick check, that `v_int` is still and active vertex. This indeed was a big issue (potentially segmentation fault), but also the only issue I can think of (which doesn't mean that it is the only one). Here are my thoughts about it:

`next_neighbor_unsafe` will just pick the next neighbor as long as `v_int` is an active vertex. If there are multiple arcs, they will be cached in a list, before yielding anything. This way things should be safe.

However, if you delete an edge and then add one, it might happen that the meaning of `v_int` changes. I think, this is the users problem. You shouldn't ask for all edges out of a vertex and then along the way delete it and assume that things are fine.

If you have multiple arcs and delete them after obtaining the first arc was yield by the iterator, this is the users problem. The other arcs will still be output, but things should be safe as long as you use safe methods.

If you add/delete/modify edges, things are fine otherwise. However, it might happen that a new edge will be yield by the iterator or not (according to internal order). If you use the edge iterator to relabel edges things are fine, as long as you do not have multiple edges. (Once you have seen an edge `(1,2)`, you know that it will not be output according to internal order again.)



---

archive/issue_comments_492295.json:
```json
{
    "body": "<a id='comment:23'></a>\nOK, we can let it like that for the moment. This patch has only exhibit an issue in that code that is now fixed.\nIf something goes wrong, a specific bug will be raised by a user.",
    "created_at": "2020-09-28T14:12:31Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492295",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:23'></a>
OK, we can let it like that for the moment. This patch has only exhibit an issue in that code that is now fixed.
If something goes wrong, a specific bug will be raised by a user.



---

archive/issue_comments_492296.json:
```json
{
    "body": "<a id='comment:24'></a>\nI know. It's not like this was very stable before. In my opinion the only difference is, that before the edge iterator cached all arcs from `v`, yield them all and then went on to the next vertex.\n\nNow, we only cache all arcs from `v` to `u`. If there is only one arc, there is nothing to cache.\n\nEither way, you can make the iterator behave strangely, by modifying the graph along the way. It shouldn't crash hard, this I think is important. Also the strange behavior should be somewhat foreseeable: If you add an arc `(1,2)` along the way, it would be strange if `(3,4)` appears twice now. It would be okay, if `(1,2)` pops up again at some point.\nIf you delete an edge, I think it would even be fine, if it still appears in the iterator (even so it doesn't), but all the other edges should be yield correctly regardless.",
    "created_at": "2020-09-28T14:34:37Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492296",
    "user": "https://github.com/kliem"
}
```

<a id='comment:24'></a>
I know. It's not like this was very stable before. In my opinion the only difference is, that before the edge iterator cached all arcs from `v`, yield them all and then went on to the next vertex.

Now, we only cache all arcs from `v` to `u`. If there is only one arc, there is nothing to cache.

Either way, you can make the iterator behave strangely, by modifying the graph along the way. It shouldn't crash hard, this I think is important. Also the strange behavior should be somewhat foreseeable: If you add an arc `(1,2)` along the way, it would be strange if `(3,4)` appears twice now. It would be okay, if `(1,2)` pops up again at some point.
If you delete an edge, I think it would even be fine, if it still appears in the iterator (even so it doesn't), but all the other edges should be yield correctly regardless.



---

archive/issue_comments_492297.json:
```json
{
    "body": "<a id='comment:25'></a>\nCan you add the new `unsorted` parameter to `edges` and `EdgesView` ?",
    "created_at": "2020-09-28T14:52:11Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492297",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:25'></a>
Can you add the new `unsorted` parameter to `edges` and `EdgesView` ?



---

archive/issue_comments_492298.json:
```json
{
    "body": "<a id='comment:26'></a>\nSure. What about naming it `sorted` instead of unsorted (not in the backend), but for `edges`, `EdgesView`, `edge_iterator`?",
    "created_at": "2020-09-28T14:56:19Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492298",
    "user": "https://github.com/kliem"
}
```

<a id='comment:26'></a>
Sure. What about naming it `sorted` instead of unsorted (not in the backend), but for `edges`, `EdgesView`, `edge_iterator`?



---

archive/issue_comments_492299.json:
```json
{
    "body": "<a id='comment:27'></a>\nWell, `edges` and `EgesView` already have parameter `sort` to sort or not the edges. The new parameter must be sufficiently different. I'm not sure of the best choice...",
    "created_at": "2020-09-28T15:05:37Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492299",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:27'></a>
Well, `edges` and `EgesView` already have parameter `sort` to sort or not the edges. The new parameter must be sufficiently different. I'm not sure of the best choice...



---

archive/issue_comments_492300.json:
```json
{
    "body": "<a id='comment:28'></a>\nHow about `sort_ends`?",
    "created_at": "2020-09-28T15:07:06Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492300",
    "user": "https://github.com/kliem"
}
```

<a id='comment:28'></a>
How about `sort_ends`?



---

archive/issue_comments_492301.json:
```json
{
    "body": "<a id='comment:29'></a>\nBoth `sort_ends` and `sort_vertices` are good to me.",
    "created_at": "2020-09-28T15:09:53Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492301",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:29'></a>
Both `sort_ends` and `sort_vertices` are good to me.



---

archive/issue_comments_492302.json:
```json
{
    "body": "**Changing commit** from \"[5e91e9976bac1db76f819bca9c3c14f704cdaa11](https://github.com/sagemath/sagetrac-mirror/commit/5e91e9976bac1db76f819bca9c3c14f704cdaa11)\" to \"[98269fd36424e58ddc76de2a204ad7ae668d6bb6](https://github.com/sagemath/sagetrac-mirror/commit/98269fd36424e58ddc76de2a204ad7ae668d6bb6)\".",
    "created_at": "2020-09-28T17:41:58Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492302",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[5e91e9976bac1db76f819bca9c3c14f704cdaa11](https://github.com/sagemath/sagetrac-mirror/commit/5e91e9976bac1db76f819bca9c3c14f704cdaa11)" to "[98269fd36424e58ddc76de2a204ad7ae668d6bb6](https://github.com/sagemath/sagetrac-mirror/commit/98269fd36424e58ddc76de2a204ad7ae668d6bb6)".



---

archive/issue_comments_492303.json:
```json
{
    "body": "<a id='comment:30'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/98269fd36424e58ddc76de2a204ad7ae668d6bb6\">98269fd</a></td><td><code>expose `sort_vertices`</code></td></tr></table>\n",
    "created_at": "2020-09-28T17:41:58Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492303",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/98269fd36424e58ddc76de2a204ad7ae668d6bb6">98269fd</a></td><td><code>expose `sort_vertices`</code></td></tr></table>




---

archive/issue_comments_492304.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -50,7 +50,7 @@\n ....: G.add_edges([(i, (i+83)%100) for i in range(100)])                                                                                                                                                                                                                                                                                                                   \n sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              \n 66.2 \u00b5s \u00b1 693 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n-sage: %timeit edges = list(G.edge_iterator(unsorted=True))                                                                                                                                                                                                                                                                                                                 \n+sage: %timeit edges = list(G.edge_iterator(sort_vertices=False))                                                                                                                                                                                                                                                                                                                 \n 50.1 \u00b5s \u00b1 404 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n sage: H = G.copy()                                                    \n sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       \n@@ -63,7 +63,7 @@\n ....: G.add_edges([(i, (i+83)%100) for i in range(100)])                                                                                                                                                                                                                                                                                                                   \n sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              \n 125 \u00b5s \u00b1 597 ns per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n-sage: %timeit edges = list(G.edge_iterator(unsorted=True))                                                                                                                                                                                                                                                                                                                 \n+sage: %timeit edges = list(G.edge_iterator(sort_vertices=False))                                                                                                                                                                                                                                                                                                                 \n 112 \u00b5s \u00b1 1.22 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10000 loops each)\n sage: H = G.copy()  \n sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       \n@@ -75,7 +75,7 @@\n ....: G.add_edges([(i, (i+83)%100, j) for j in range(20) for i in range(100)])                                                                                                                                                                                                                                                                                             \n sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              \n 1.05 ms \u00b1 3.2 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n-sage: %timeit edges = list(G.edge_iterator(unsorted=True))                                                                                                                                                                                                                                                                                                                 \n+sage: %timeit edges = list(G.edge_iterator(sort_vertices=False))                                                                                                                                                                                                                                                                                                                 \n 1.02 ms \u00b1 40.4 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n sage: H = G.copy()  \n sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       \n``````\n",
    "created_at": "2020-09-28T17:44:20Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492304",
    "user": "https://github.com/kliem"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -50,7 +50,7 @@
 ....: G.add_edges([(i, (i+83)%100) for i in range(100)])                                                                                                                                                                                                                                                                                                                   
 sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              
 66.2 µs ± 693 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
-sage: %timeit edges = list(G.edge_iterator(unsorted=True))                                                                                                                                                                                                                                                                                                                 
+sage: %timeit edges = list(G.edge_iterator(sort_vertices=False))                                                                                                                                                                                                                                                                                                                 
 50.1 µs ± 404 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
 sage: H = G.copy()                                                    
 sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
@@ -63,7 +63,7 @@
 ....: G.add_edges([(i, (i+83)%100) for i in range(100)])                                                                                                                                                                                                                                                                                                                   
 sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              
 125 µs ± 597 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
-sage: %timeit edges = list(G.edge_iterator(unsorted=True))                                                                                                                                                                                                                                                                                                                 
+sage: %timeit edges = list(G.edge_iterator(sort_vertices=False))                                                                                                                                                                                                                                                                                                                 
 112 µs ± 1.22 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
 sage: H = G.copy()  
 sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
@@ -75,7 +75,7 @@
 ....: G.add_edges([(i, (i+83)%100, j) for j in range(20) for i in range(100)])                                                                                                                                                                                                                                                                                             
 sage: %timeit edges = list(G.edge_iterator())                                                                                                                                                                                                                                                                                                                              
 1.05 ms ± 3.2 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
-sage: %timeit edges = list(G.edge_iterator(unsorted=True))                                                                                                                                                                                                                                                                                                                 
+sage: %timeit edges = list(G.edge_iterator(sort_vertices=False))                                                                                                                                                                                                                                                                                                                 
 1.02 ms ± 40.4 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
 sage: H = G.copy()  
 sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
``````




---

archive/issue_comments_492305.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -78,6 +78,6 @@\n sage: %timeit edges = list(G.edge_iterator(sort_vertices=False))                                                                                                                                                                                                                                                                                                                 \n 1.02 ms \u00b1 40.4 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n sage: H = G.copy()  \n-sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       \n-2.81 ms \u00b1 725 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n+sage: %timeit H == G                                                                                                                                                                \n+2.19 ms \u00b1 28.5 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n ```\n``````\n",
    "created_at": "2020-09-28T17:45:22Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492305",
    "user": "https://github.com/kliem"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -78,6 +78,6 @@
 sage: %timeit edges = list(G.edge_iterator(sort_vertices=False))                                                                                                                                                                                                                                                                                                                 
 1.02 ms ± 40.4 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
 sage: H = G.copy()  
-sage: %timeit H == G                                                                                                                                                                                                                                                                                                                                                       
-2.81 ms ± 725 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
+sage: %timeit H == G                                                                                                                                                                
+2.19 ms ± 28.5 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
 ```
``````




---

archive/issue_comments_492306.json:
```json
{
    "body": "<a id='comment:33'></a>\nLGTM.\n\nThanks a lot.",
    "created_at": "2020-10-02T15:42:18Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492306",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:33'></a>
LGTM.

Thanks a lot.



---

archive/issue_events_274665.json:
```json
{
    "actor": "https://github.com/dcoudert",
    "created_at": "2020-10-02T15:42:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30665#event-274665"
}
```



---

archive/issue_events_274666.json:
```json
{
    "actor": "https://github.com/dcoudert",
    "created_at": "2020-10-02T15:42:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30665#event-274666"
}
```



---

archive/issue_comments_492307.json:
```json
{
    "body": "**Reviewer:** David Coudert",
    "created_at": "2020-10-02T15:42:18Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492307",
    "user": "https://github.com/dcoudert"
}
```

**Reviewer:** David Coudert



---

archive/issue_comments_492308.json:
```json
{
    "body": "<a id='comment:34'></a>\nThank you for reviewing.",
    "created_at": "2020-10-02T18:06:22Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492308",
    "user": "https://github.com/kliem"
}
```

<a id='comment:34'></a>
Thank you for reviewing.



---

archive/issue_comments_492309.json:
```json
{
    "body": "<a id='comment:35'></a>\nThere is a slowdown in the case that we do not access all vertices:\n\nBefore:\n\n```\nsage: G = graphs.Grid2dGraph(100, 100)                                                                                                                                              \nsage: V = list(G)                                                                                                                                                                   \nsage: %timeit list(G.edge_iterator(V[:500]))                                                                                                                                        \n454 \u00b5s \u00b1 266 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n```\nAfter:\n\n```\nsage: G = graphs.Grid2dGraph(100, 100)                                                                                                                                              \nsage: V = list(G)                                                                                                                                                                   \nsage: %timeit list(G.edge_iterator(V[:500]))                                                                                                                                        \n2.72 ms \u00b1 1.4 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n```",
    "created_at": "2020-10-12T06:49:55Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492309",
    "user": "https://github.com/kliem"
}
```

<a id='comment:35'></a>
There is a slowdown in the case that we do not access all vertices:

Before:

```
sage: G = graphs.Grid2dGraph(100, 100)                                                                                                                                              
sage: V = list(G)                                                                                                                                                                   
sage: %timeit list(G.edge_iterator(V[:500]))                                                                                                                                        
454 µs ± 266 ns per loop (mean ± std. dev. of 7 runs, 1000 loops each)
```
After:

```
sage: G = graphs.Grid2dGraph(100, 100)                                                                                                                                              
sage: V = list(G)                                                                                                                                                                   
sage: %timeit list(G.edge_iterator(V[:500]))                                                                                                                                        
2.72 ms ± 1.4 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
```



---

archive/issue_events_274667.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-10-12T06:49:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30665#event-274667"
}
```



---

archive/issue_events_274668.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-10-12T06:49:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30665#event-274668"
}
```



---

archive/issue_comments_492310.json:
```json
{
    "body": "**Changing commit** from \"[98269fd36424e58ddc76de2a204ad7ae668d6bb6](https://github.com/sagemath/sagetrac-mirror/commit/98269fd36424e58ddc76de2a204ad7ae668d6bb6)\" to \"[737e0f8011cb417059d23202abbab9dea41051c8](https://github.com/sagemath/sagetrac-mirror/commit/737e0f8011cb417059d23202abbab9dea41051c8)\".",
    "created_at": "2020-10-12T07:40:08Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492310",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[98269fd36424e58ddc76de2a204ad7ae668d6bb6](https://github.com/sagemath/sagetrac-mirror/commit/98269fd36424e58ddc76de2a204ad7ae668d6bb6)" to "[737e0f8011cb417059d23202abbab9dea41051c8](https://github.com/sagemath/sagetrac-mirror/commit/737e0f8011cb417059d23202abbab9dea41051c8)".



---

archive/issue_comments_492311.json:
```json
{
    "body": "<a id='comment:36'></a>\n**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **Last 10 new commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/59fb90645153eed4d1518bee393e56e1cd300973\">59fb906</a></td><td><code>remove duplications</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4944027438df442e3c224e827169e9ecd0873bd1\">4944027</a></td><td><code>switch u and v in place</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/38c6031f821cc03f2af12d28ee4c7af7b418f5b0\">38c6031</a></td><td><code>fix for directed multiedge graphs with labels</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/dbd17efdd818dd6ff22ee27a5380aeba8051fc6f\">dbd17ef</a></td><td><code>use unsorted edges to speed up equality check</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5f7b30df7304b43e22dcda24f8b4e1d6b2468659\">5f7b30d</a></td><td><code>reviewers suggestion</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/002ec5d147b2539f14ad00621eed4d8a8812dae2\">002ec5d</a></td><td><code>document that an iterator can be used to relabel edges</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5deaa25b900ff90d287bada4a4cd014c6b70c7bf\">5deaa25</a></td><td><code>fix wrong usage and document it</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d7c27ebfe76a59b609a35f0830c54b9fbd762ef1\">d7c27eb</a></td><td><code>make iterator saver</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/86b0ba6b515dd5dd9f882817b38ecc0e8d9fc0dc\">86b0ba6</a></td><td><code>expose `sort_vertices`</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/737e0f8011cb417059d23202abbab9dea41051c8\">737e0f8</a></td><td><code>lookup in bitset is much faster</code></td></tr></table>\n",
    "created_at": "2020-10-12T07:40:08Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492311",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:36'></a>
**Branch pushed to git repo; I updated commit sha1. This was a forced push.** **Last 10 new commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/59fb90645153eed4d1518bee393e56e1cd300973">59fb906</a></td><td><code>remove duplications</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4944027438df442e3c224e827169e9ecd0873bd1">4944027</a></td><td><code>switch u and v in place</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/38c6031f821cc03f2af12d28ee4c7af7b418f5b0">38c6031</a></td><td><code>fix for directed multiedge graphs with labels</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/dbd17efdd818dd6ff22ee27a5380aeba8051fc6f">dbd17ef</a></td><td><code>use unsorted edges to speed up equality check</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5f7b30df7304b43e22dcda24f8b4e1d6b2468659">5f7b30d</a></td><td><code>reviewers suggestion</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/002ec5d147b2539f14ad00621eed4d8a8812dae2">002ec5d</a></td><td><code>document that an iterator can be used to relabel edges</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5deaa25b900ff90d287bada4a4cd014c6b70c7bf">5deaa25</a></td><td><code>fix wrong usage and document it</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d7c27ebfe76a59b609a35f0830c54b9fbd762ef1">d7c27eb</a></td><td><code>make iterator saver</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/86b0ba6b515dd5dd9f882817b38ecc0e8d9fc0dc">86b0ba6</a></td><td><code>expose `sort_vertices`</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/737e0f8011cb417059d23202abbab9dea41051c8">737e0f8</a></td><td><code>lookup in bitset is much faster</code></td></tr></table>




---

archive/issue_comments_492312.json:
```json
{
    "body": "<a id='comment:37'></a>\nOne simple commit:\n\nBefore this ticket:\n\n```\nsage: G = graphs.Grid2dGraph(100, 100)                                                                                                                                              \nsage: V = list(G)                                                                                                                                                                   \nsage: %timeit list(G.edge_iterator(V[:500]))                                                                                                                                        \n449 \u00b5s \u00b1 588 ns per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\nsage: %timeit list(G.edge_iterator(V[:5000]))                                                                                                                                       \n4.97 ms \u00b1 4.5 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n\nsage: G = graphs.CompleteGraph(1000)                                                                                                                                                \nsage: V = list(G)                                                                                                                                                                   \nsage: %timeit list(G.edge_iterator(V[:100]))                                                                                                                                        \n20.1 ms \u00b1 24.2 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\nsage: %timeit list(G.edge_iterator(V[:800]))                                                                                                                                        \n130 ms \u00b1 1.45 ms per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\n```\n\nWith this ticket:\n\n```\nsage: G = graphs.Grid2dGraph(100, 100)                                                                                                                                              \nsage: V = list(G)                                                                                                                                                                   \nsage: %timeit list(G.edge_iterator(V[:500]))                                                                                                                                        \n377 \u00b5s \u00b1 2.14 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\nsage: %timeit list(G.edge_iterator(V[:500], sort_vertices=False))                                                                                                                   \n338 \u00b5s \u00b1 2.08 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\nsage: %timeit list(G.edge_iterator(V[:5000]))                                                                                                                                       \n4.3 ms \u00b1 4.44 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\nsage: %timeit list(G.edge_iterator(V[:5000], sort_vertices=False))                                                                                                                  \n3.85 ms \u00b1 2.35 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n\nsage: G = graphs.CompleteGraph(1000)                                                                                                                                                \nsage: V = list(G)                                                                                                                                                                                                                                                                                                          \nsage: %timeit list(G.edge_iterator(V[:100], sort_vertices=False))                                                                                                                   \n14.8 ms \u00b1 103 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\nsage: %timeit list(G.edge_iterator(V[:800]))                                                                                                                                        \n102 ms \u00b1 67 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\nsage: %timeit list(G.edge_iterator(V[:800], sort_vertices=False))                                                                                                                   \n92.3 ms \u00b1 1.61 ms per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\nsage: %timeit list(G.edge_iterator())  # note that this is still slower, so we gain something by requesting only some vertices                                                                                                                                     \n110 ms \u00b1 177 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\n```",
    "created_at": "2020-10-12T07:48:03Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492312",
    "user": "https://github.com/kliem"
}
```

<a id='comment:37'></a>
One simple commit:

Before this ticket:

```
sage: G = graphs.Grid2dGraph(100, 100)                                                                                                                                              
sage: V = list(G)                                                                                                                                                                   
sage: %timeit list(G.edge_iterator(V[:500]))                                                                                                                                        
449 µs ± 588 ns per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit list(G.edge_iterator(V[:5000]))                                                                                                                                       
4.97 ms ± 4.5 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)

sage: G = graphs.CompleteGraph(1000)                                                                                                                                                
sage: V = list(G)                                                                                                                                                                   
sage: %timeit list(G.edge_iterator(V[:100]))                                                                                                                                        
20.1 ms ± 24.2 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
sage: %timeit list(G.edge_iterator(V[:800]))                                                                                                                                        
130 ms ± 1.45 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
```

With this ticket:

```
sage: G = graphs.Grid2dGraph(100, 100)                                                                                                                                              
sage: V = list(G)                                                                                                                                                                   
sage: %timeit list(G.edge_iterator(V[:500]))                                                                                                                                        
377 µs ± 2.14 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit list(G.edge_iterator(V[:500], sort_vertices=False))                                                                                                                   
338 µs ± 2.08 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
sage: %timeit list(G.edge_iterator(V[:5000]))                                                                                                                                       
4.3 ms ± 4.44 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: %timeit list(G.edge_iterator(V[:5000], sort_vertices=False))                                                                                                                  
3.85 ms ± 2.35 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)

sage: G = graphs.CompleteGraph(1000)                                                                                                                                                
sage: V = list(G)                                                                                                                                                                                                                                                                                                          
sage: %timeit list(G.edge_iterator(V[:100], sort_vertices=False))                                                                                                                   
14.8 ms ± 103 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: %timeit list(G.edge_iterator(V[:800]))                                                                                                                                        
102 ms ± 67 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
sage: %timeit list(G.edge_iterator(V[:800], sort_vertices=False))                                                                                                                   
92.3 ms ± 1.61 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
sage: %timeit list(G.edge_iterator())  # note that this is still slower, so we gain something by requesting only some vertices                                                                                                                                     
110 ms ± 177 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
```



---

archive/issue_events_274669.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-10-12T07:48:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30665#event-274669"
}
```



---

archive/issue_events_274670.json:
```json
{
    "actor": "https://github.com/kliem",
    "created_at": "2020-10-12T07:48:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30665#event-274670"
}
```



---

archive/issue_comments_492313.json:
```json
{
    "body": "<a id='comment:38'></a>\nI have numerous failing doctests like:\n\n```\n**********************************************************************\nFile \"src/sage/graphs/independent_sets.pyx\", line 164, in sage.graphs.independent_sets.IndependentSets.__init__\nFailed example:\n    for i in range(5):\n        check_with_subgraph_search(graphs.RandomGNP(11, .3))\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/dcoudert/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py\", line 720, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/dcoudert/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py\", line 1145, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.graphs.independent_sets.IndependentSets.__init__[8]>\", line 2, in <module>\n        check_with_subgraph_search(graphs.RandomGNP(Integer(11), RealNumber('.3')))\n      File \"<doctest sage.graphs.independent_sets.IndependentSets.__init__[7]>\", line 3, in check_with_subgraph_search\n        if not all(G.subgraph(l).is_independent_set() for l in IS):\n      File \"<doctest sage.graphs.independent_sets.IndependentSets.__init__[7]>\", line 3, in <genexpr>\n        if not all(G.subgraph(l).is_independent_set() for l in IS):\n      File \"/Users/dcoudert/sage/local/lib/python3.8/site-packages/sage/graphs/generic_graph.py\", line 12589, in subgraph\n        return self._subgraph_by_adding(vertices=vertices, edges=edges,\n      File \"/Users/dcoudert/sage/local/lib/python3.8/site-packages/sage/graphs/generic_graph.py\", line 12724, in _subgraph_by_adding\n        edges_to_keep = [e for e in self.edges(vertices=vertices, sort=False)\n      File \"/Users/dcoudert/sage/local/lib/python3.8/site-packages/sage/graphs/generic_graph.py\", line 12724, in <listcomp>\n        edges_to_keep = [e for e in self.edges(vertices=vertices, sort=False)\n      File \"sage/graphs/views.pyx\", line 438, in __iter__ (build/cythonized/sage/graphs/views.c:3991)\n        yield from self._iter_unsorted(vertices)\n      File \"sage/graphs/views.pyx\", line 410, in _iter_unsorted (build/cythonized/sage/graphs/views.c:3607)\n        yield from self._graph._backend.iterator_edges(vertices, self._labels)\n      File \"sage/graphs/base/c_graph.pyx\", line 3683, in _iterator_edges (build/cythonized/sage/graphs/base/c_graph.cpp:25263)\n        b_vertices = FrozenBitset(foo for foo in b_vertices_2 if foo >= 0)\n      File \"sage/data_structures/bitset.pyx\", line 398, in sage.data_structures.bitset.FrozenBitset.__init__ (build/cythonized/sage/data_structures/bitset.c:2753)\n        raise ValueError(\"Bitsets must not be empty\")\n    ValueError: Bitsets must not be empty\n**********************************************************************\nFile \"src/sage/graphs/views.pyx\", line 209, in sage.graphs.views.EdgesView\nFailed example:\n    E = EdgesView(G, vertices=[0, 3], labels=False, sort=True); E\nExpected:\n    []\nGot:\n    <repr(<sage.graphs.views.EdgesView at 0x15bfdef40>) failed: ValueError: Bitsets must not be empty>\n```",
    "created_at": "2020-10-12T09:03:37Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492313",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:38'></a>
I have numerous failing doctests like:

```
**********************************************************************
File "src/sage/graphs/independent_sets.pyx", line 164, in sage.graphs.independent_sets.IndependentSets.__init__
Failed example:
    for i in range(5):
        check_with_subgraph_search(graphs.RandomGNP(11, .3))
Exception raised:
    Traceback (most recent call last):
      File "/Users/dcoudert/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 720, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/dcoudert/sage/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1145, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.independent_sets.IndependentSets.__init__[8]>", line 2, in <module>
        check_with_subgraph_search(graphs.RandomGNP(Integer(11), RealNumber('.3')))
      File "<doctest sage.graphs.independent_sets.IndependentSets.__init__[7]>", line 3, in check_with_subgraph_search
        if not all(G.subgraph(l).is_independent_set() for l in IS):
      File "<doctest sage.graphs.independent_sets.IndependentSets.__init__[7]>", line 3, in <genexpr>
        if not all(G.subgraph(l).is_independent_set() for l in IS):
      File "/Users/dcoudert/sage/local/lib/python3.8/site-packages/sage/graphs/generic_graph.py", line 12589, in subgraph
        return self._subgraph_by_adding(vertices=vertices, edges=edges,
      File "/Users/dcoudert/sage/local/lib/python3.8/site-packages/sage/graphs/generic_graph.py", line 12724, in _subgraph_by_adding
        edges_to_keep = [e for e in self.edges(vertices=vertices, sort=False)
      File "/Users/dcoudert/sage/local/lib/python3.8/site-packages/sage/graphs/generic_graph.py", line 12724, in <listcomp>
        edges_to_keep = [e for e in self.edges(vertices=vertices, sort=False)
      File "sage/graphs/views.pyx", line 438, in __iter__ (build/cythonized/sage/graphs/views.c:3991)
        yield from self._iter_unsorted(vertices)
      File "sage/graphs/views.pyx", line 410, in _iter_unsorted (build/cythonized/sage/graphs/views.c:3607)
        yield from self._graph._backend.iterator_edges(vertices, self._labels)
      File "sage/graphs/base/c_graph.pyx", line 3683, in _iterator_edges (build/cythonized/sage/graphs/base/c_graph.cpp:25263)
        b_vertices = FrozenBitset(foo for foo in b_vertices_2 if foo >= 0)
      File "sage/data_structures/bitset.pyx", line 398, in sage.data_structures.bitset.FrozenBitset.__init__ (build/cythonized/sage/data_structures/bitset.c:2753)
        raise ValueError("Bitsets must not be empty")
    ValueError: Bitsets must not be empty
**********************************************************************
File "src/sage/graphs/views.pyx", line 209, in sage.graphs.views.EdgesView
Failed example:
    E = EdgesView(G, vertices=[0, 3], labels=False, sort=True); E
Expected:
    []
Got:
    <repr(<sage.graphs.views.EdgesView at 0x15bfdef40>) failed: ValueError: Bitsets must not be empty>
```



---

archive/issue_comments_492314.json:
```json
{
    "body": "<a id='comment:39'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/07b7a8ea5d44447cd8b66d00d7a4485b2dd4b8ec\">07b7a8e</a></td><td><code>bitset must not be empty</code></td></tr></table>\n",
    "created_at": "2020-10-12T09:18:41Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492314",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:39'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/07b7a8ea5d44447cd8b66d00d7a4485b2dd4b8ec">07b7a8e</a></td><td><code>bitset must not be empty</code></td></tr></table>




---

archive/issue_comments_492315.json:
```json
{
    "body": "**Changing commit** from \"[737e0f8011cb417059d23202abbab9dea41051c8](https://github.com/sagemath/sagetrac-mirror/commit/737e0f8011cb417059d23202abbab9dea41051c8)\" to \"[07b7a8ea5d44447cd8b66d00d7a4485b2dd4b8ec](https://github.com/sagemath/sagetrac-mirror/commit/07b7a8ea5d44447cd8b66d00d7a4485b2dd4b8ec)\".",
    "created_at": "2020-10-12T09:18:41Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492315",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[737e0f8011cb417059d23202abbab9dea41051c8](https://github.com/sagemath/sagetrac-mirror/commit/737e0f8011cb417059d23202abbab9dea41051c8)" to "[07b7a8ea5d44447cd8b66d00d7a4485b2dd4b8ec](https://github.com/sagemath/sagetrac-mirror/commit/07b7a8ea5d44447cd8b66d00d7a4485b2dd4b8ec)".



---

archive/issue_comments_492316.json:
```json
{
    "body": "<a id='comment:40'></a>\nRight.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/07b7a8ea5d44447cd8b66d00d7a4485b2dd4b8ec\">07b7a8e</a></td><td><code>bitset must not be empty</code></td></tr></table>\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/07b7a8ea5d44447cd8b66d00d7a4485b2dd4b8ec\">07b7a8e</a></td><td><code>bitset must not be empty</code></td></tr></table>\n",
    "created_at": "2020-10-12T09:19:00Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492316",
    "user": "https://github.com/kliem"
}
```

<a id='comment:40'></a>
Right.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/07b7a8ea5d44447cd8b66d00d7a4485b2dd4b8ec">07b7a8e</a></td><td><code>bitset must not be empty</code></td></tr></table>

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/07b7a8ea5d44447cd8b66d00d7a4485b2dd4b8ec">07b7a8e</a></td><td><code>bitset must not be empty</code></td></tr></table>




---

archive/issue_comments_492317.json:
```json
{
    "body": "<a id='comment:41'></a>\nIt's much better like that.\n\nWe have the case `len(vertices) == 1`. Why not adding the case `not vertices` (empty).",
    "created_at": "2020-10-12T09:34:38Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492317",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:41'></a>
It's much better like that.

We have the case `len(vertices) == 1`. Why not adding the case `not vertices` (empty).



---

archive/issue_comments_492318.json:
```json
{
    "body": "**Changing commit** from \"[07b7a8ea5d44447cd8b66d00d7a4485b2dd4b8ec](https://github.com/sagemath/sagetrac-mirror/commit/07b7a8ea5d44447cd8b66d00d7a4485b2dd4b8ec)\" to \"[957b4cc9eae331af65b64e8e83fa49d35403f4f7](https://github.com/sagemath/sagetrac-mirror/commit/957b4cc9eae331af65b64e8e83fa49d35403f4f7)\".",
    "created_at": "2020-10-12T09:45:58Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492318",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[07b7a8ea5d44447cd8b66d00d7a4485b2dd4b8ec](https://github.com/sagemath/sagetrac-mirror/commit/07b7a8ea5d44447cd8b66d00d7a4485b2dd4b8ec)" to "[957b4cc9eae331af65b64e8e83fa49d35403f4f7](https://github.com/sagemath/sagetrac-mirror/commit/957b4cc9eae331af65b64e8e83fa49d35403f4f7)".



---

archive/issue_comments_492319.json:
```json
{
    "body": "<a id='comment:42'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/957b4cc9eae331af65b64e8e83fa49d35403f4f7\">957b4cc</a></td><td><code>check if vertices are empty</code></td></tr></table>\n",
    "created_at": "2020-10-12T09:45:58Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492319",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:42'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/957b4cc9eae331af65b64e8e83fa49d35403f4f7">957b4cc</a></td><td><code>check if vertices are empty</code></td></tr></table>




---

archive/issue_comments_492320.json:
```json
{
    "body": "<a id='comment:43'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b7d739fc55cfedba11be5ab9868312281772a7cf\">b7d739f</a></td><td><code>check for bitset capacity</code></td></tr></table>\n",
    "created_at": "2020-10-12T15:23:58Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492320",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:43'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b7d739fc55cfedba11be5ab9868312281772a7cf">b7d739f</a></td><td><code>check for bitset capacity</code></td></tr></table>




---

archive/issue_comments_492321.json:
```json
{
    "body": "**Changing commit** from \"[957b4cc9eae331af65b64e8e83fa49d35403f4f7](https://github.com/sagemath/sagetrac-mirror/commit/957b4cc9eae331af65b64e8e83fa49d35403f4f7)\" to \"[b7d739fc55cfedba11be5ab9868312281772a7cf](https://github.com/sagemath/sagetrac-mirror/commit/b7d739fc55cfedba11be5ab9868312281772a7cf)\".",
    "created_at": "2020-10-12T15:23:58Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492321",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[957b4cc9eae331af65b64e8e83fa49d35403f4f7](https://github.com/sagemath/sagetrac-mirror/commit/957b4cc9eae331af65b64e8e83fa49d35403f4f7)" to "[b7d739fc55cfedba11be5ab9868312281772a7cf](https://github.com/sagemath/sagetrac-mirror/commit/b7d739fc55cfedba11be5ab9868312281772a7cf)".



---

archive/issue_comments_492322.json:
```json
{
    "body": "<a id='comment:44'></a>\nA bug I noticed while trying to make #30753 work.",
    "created_at": "2020-10-12T15:24:26Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492322",
    "user": "https://github.com/kliem"
}
```

<a id='comment:44'></a>
A bug I noticed while trying to make #30753 work.



---

archive/issue_comments_492323.json:
```json
{
    "body": "<a id='comment:45'></a>\nLGTM and better than previous version. Thank you.",
    "created_at": "2020-10-12T22:10:58Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492323",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:45'></a>
LGTM and better than previous version. Thank you.



---

archive/issue_events_274671.json:
```json
{
    "actor": "https://github.com/dcoudert",
    "created_at": "2020-10-12T22:10:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30665#event-274671"
}
```



---

archive/issue_events_274672.json:
```json
{
    "actor": "https://github.com/dcoudert",
    "created_at": "2020-10-12T22:10:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30665#event-274672"
}
```



---

archive/issue_comments_492324.json:
```json
{
    "body": "**Changing commit** from \"[b7d739fc55cfedba11be5ab9868312281772a7cf](https://github.com/sagemath/sagetrac-mirror/commit/b7d739fc55cfedba11be5ab9868312281772a7cf)\" to \"[8beb57302c92d17f4b703e53a1170aa0acd80920](https://github.com/sagemath/sagetrac-mirror/commit/8beb57302c92d17f4b703e53a1170aa0acd80920)\".",
    "created_at": "2020-10-14T19:29:47Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492324",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[b7d739fc55cfedba11be5ab9868312281772a7cf](https://github.com/sagemath/sagetrac-mirror/commit/b7d739fc55cfedba11be5ab9868312281772a7cf)" to "[8beb57302c92d17f4b703e53a1170aa0acd80920](https://github.com/sagemath/sagetrac-mirror/commit/8beb57302c92d17f4b703e53a1170aa0acd80920)".



---

archive/issue_events_274673.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/git",
    "created_at": "2020-10-14T19:29:47Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30665#event-274673"
}
```



---

archive/issue_events_274674.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/git",
    "created_at": "2020-10-14T19:29:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30665#event-274674"
}
```



---

archive/issue_comments_492325.json:
```json
{
    "body": "<a id='comment:46'></a>\n**Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8beb57302c92d17f4b703e53a1170aa0acd80920\">8beb573</a></td><td><code>bitset capacity is +1 to last index</code></td></tr></table>\n",
    "created_at": "2020-10-14T19:29:47Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492325",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:46'></a>
**Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8beb57302c92d17f4b703e53a1170aa0acd80920">8beb573</a></td><td><code>bitset capacity is +1 to last index</code></td></tr></table>




---

archive/issue_comments_492326.json:
```json
{
    "body": "<a id='comment:47'></a>\nTiny change. Sorry, but it was wrong before.",
    "created_at": "2020-10-14T19:40:51Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492326",
    "user": "https://github.com/kliem"
}
```

<a id='comment:47'></a>
Tiny change. Sorry, but it was wrong before.



---

archive/issue_comments_492327.json:
```json
{
    "body": "<a id='comment:48'></a>\nLGTM.",
    "created_at": "2020-10-15T09:19:30Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492327",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:48'></a>
LGTM.



---

archive/issue_events_274675.json:
```json
{
    "actor": "https://github.com/dcoudert",
    "created_at": "2020-10-15T09:19:30Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30665#event-274675"
}
```



---

archive/issue_events_274676.json:
```json
{
    "actor": "https://github.com/dcoudert",
    "created_at": "2020-10-15T09:19:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30665#event-274676"
}
```



---

archive/issue_events_274677.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "milestone": "sage-9.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30665#event-274677"
}
```



---

archive/issue_events_274678.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-10-24T20:15:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "milestone": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30665#event-274678"
}
```



---

archive/issue_events_274679.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-10-31T18:07:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30665#event-274679"
}
```



---

archive/issue_events_274680.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "fa3b68ef1dd4cdb06ae73447182e6b01514d37a6",
    "created_at": "2020-10-31T18:07:21Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30665#event-274680"
}
```



---

archive/issue_comments_492328.json:
```json
{
    "body": "**Changing branch** from \"[u/gh-kliem/graphs_improve_edge_iterator](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-kliem/graphs_improve_edge_iterator)\" to \"[8beb57302c92d17f4b703e53a1170aa0acd80920](https://github.com/sagemath/sagetrac-mirror/commit/8beb57302c92d17f4b703e53a1170aa0acd80920)\".",
    "created_at": "2020-10-31T18:07:21Z",
    "issue": "https://github.com/sagemath/sage/issues/30665",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30665#issuecomment-492328",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/gh-kliem/graphs_improve_edge_iterator](https://github.com/sagemath/sagetrac-mirror/tree/u/gh-kliem/graphs_improve_edge_iterator)" to "[8beb57302c92d17f4b703e53a1170aa0acd80920](https://github.com/sagemath/sagetrac-mirror/commit/8beb57302c92d17f4b703e53a1170aa0acd80920)".
