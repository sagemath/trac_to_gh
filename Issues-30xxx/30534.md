# Issue 30534: Repackage pynac as a pip-installable package

archive/issues_030297.json:
```json
{
    "assignees": [],
    "body": "Pynac has a compile-time dependency on the Python library\nbut is not installed using Python package infrastructure.\nThis is problematic because Python users cannot install it\nusing standard Python tools - for example for testing\ndifferent Python versions.\n\n- [Pynac home](http://pynac.org)\n- [Pynac repo](https://github.com/pynac/pynac)\n\nIt would make sense for `src/sage/libs/pynac/pynac.pxd` and `pynac_wrap.h` to be shipped with this Python package, introducing a dependency on Cython.  (The only thing blocking this is `from sage.libs.gmp.types cimport mpz_t, mpq_t, mpz_ptr, mpq_ptr` - but that can be fixed by some minimal cut&paste.)\n\n(The other parts of `src/sage/libs/pynac`, `constant.pxd`, `constant.pyx`, `pynac.pyx` use various imports from sage and must remain in `sage.libs.pynac`)\n\n\nUnfortunately, there is an unrelated project that has claimed the name \"Pynac\" on pypi.org: https://pypi.org/project/Pynac\n\n\n\nDepends on #30446\nDepends on #31064\n\nCC:  @rwst @slel @tobiasdiez @williamstein @kiwifb @tscrim @kliem @videlec @embray\n\nKeywords: **pynac, sd110, sd111**\n\nUpstream: **Reported upstream. No feedback yet.**\n\nReviewer: **Fran\u00e7ois Bissey**\n\nComponent: **packages: standard**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/30534_\n\n",
    "closed_at": "2021-08-26T02:08:43Z",
    "created_at": "2020-09-09T00:46:09Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
        "https://github.com/sagemath/sage/labels/enhancement",
        "https://github.com/sagemath/sage/labels/invalid"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Repackage pynac as a pip-installable package",
    "type": "issue",
    "updated_at": "2021-08-27T16:09:47Z",
    "url": "https://github.com/sagemath/sage/issues/30534",
    "user": "https://github.com/mkoeppe"
}
```
Pynac has a compile-time dependency on the Python library
but is not installed using Python package infrastructure.
This is problematic because Python users cannot install it
using standard Python tools - for example for testing
different Python versions.

- [Pynac home](http://pynac.org)
- [Pynac repo](https://github.com/pynac/pynac)

It would make sense for `src/sage/libs/pynac/pynac.pxd` and `pynac_wrap.h` to be shipped with this Python package, introducing a dependency on Cython.  (The only thing blocking this is `from sage.libs.gmp.types cimport mpz_t, mpq_t, mpz_ptr, mpq_ptr` - but that can be fixed by some minimal cut&paste.)

(The other parts of `src/sage/libs/pynac`, `constant.pxd`, `constant.pyx`, `pynac.pyx` use various imports from sage and must remain in `sage.libs.pynac`)


Unfortunately, there is an unrelated project that has claimed the name "Pynac" on pypi.org: https://pypi.org/project/Pynac



Depends on #30446
Depends on #31064

CC:  @rwst @slel @tobiasdiez @williamstein @kiwifb @tscrim @kliem @videlec @embray

Keywords: **pynac, sd110, sd111**

Upstream: **Reported upstream. No feedback yet.**

Reviewer: **François Bissey**

Component: **packages: standard**

_Issue created by migration from https://trac.sagemath.org/ticket/30534_





---

archive/issue_events_417820.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-09T00:46:09Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30534#event-417820"
}
```



---

archive/issue_events_417821.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-09T00:46:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20packages%3A%20standard",
    "label_color": "0000b0",
    "label_name": "c: packages: standard",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30534#event-417821"
}
```



---

archive/issue_events_417822.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-09T00:46:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30534#event-417822"
}
```



---

archive/issue_events_417823.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-09-09T00:46:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30534#event-417823"
}
```



---

archive/issue_comments_486778.json:
```json
{
    "body": "Changed keywords from none to **pynac**",
    "created_at": "2020-09-09T15:17:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486778",
    "user": "https://github.com/slel"
}
```

Changed keywords from none to **pynac**



---

archive/issue_comments_486779.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,10 @@\n-pynac has a compile-time dependency on the python library but is not installed using Python package infrastructure. This is problematic because Python users cannot install it using standard Python tools - for example for testing different python versions.\n+Pynac has a compile-time dependency on the Python library\n+but is not installed using Python package infrastructure.\n+This is problematic because Python users cannot install it\n+using standard Python tools - for example for testing\n+different Python versions.\n+\n+- [Pynac home](http://pynac.org)\n+- [Pynac repo](https://github.com/pynac/pynac)\n \n \n``````\n",
    "created_at": "2020-09-09T15:17:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486779",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,10 @@
-pynac has a compile-time dependency on the python library but is not installed using Python package infrastructure. This is problematic because Python users cannot install it using standard Python tools - for example for testing different python versions.
+Pynac has a compile-time dependency on the Python library
+but is not installed using Python package infrastructure.
+This is problematic because Python users cannot install it
+using standard Python tools - for example for testing
+different Python versions.
+
+- [Pynac home](http://pynac.org)
+- [Pynac repo](https://github.com/pynac/pynac)
 
 
``````




---

archive/issue_comments_486780.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nCc-ing Ralf Stephan who maintains Pynac.",
    "created_at": "2020-09-09T15:17:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486780",
    "user": "https://github.com/slel"
}
```

<div id="comment:1" align="right">comment:1</div>

Cc-ing Ralf Stephan who maintains Pynac.



---

archive/issue_comments_486781.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -7,4 +7,8 @@\n - [Pynac home](http://pynac.org)\n - [Pynac repo](https://github.com/pynac/pynac)\n \n+It would make sense for `src/sage/libs/pynac/pynac.pxd` and `pynac_wrap.h` to be shipped with this Python package, introducing a dependency on Cython.  (The only thing blocking this is `from sage.libs.gmp.types cimport mpz_t, mpq_t, mpz_ptr, mpq_ptr` - but that can be fixed by some minimal cut&paste.)\n \n+(The other parts of `src/sage/libs/pynac`, `constant.pxd`, `constant.pyx`, `pynac.pyx` use various imports from sage and must remain in `sage.libs.pynac`)\n+\n+\n``````\n",
    "created_at": "2020-09-13T03:11:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486781",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -7,4 +7,8 @@
 - [Pynac home](http://pynac.org)
 - [Pynac repo](https://github.com/pynac/pynac)
 
+It would make sense for `src/sage/libs/pynac/pynac.pxd` and `pynac_wrap.h` to be shipped with this Python package, introducing a dependency on Cython.  (The only thing blocking this is `from sage.libs.gmp.types cimport mpz_t, mpq_t, mpz_ptr, mpq_ptr` - but that can be fixed by some minimal cut&paste.)
 
+(The other parts of `src/sage/libs/pynac`, `constant.pxd`, `constant.pyx`, `pynac.pyx` use various imports from sage and must remain in `sage.libs.pynac`)
+
+
``````




---

archive/issue_comments_486782.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -12,3 +12,6 @@\n (The other parts of `src/sage/libs/pynac`, `constant.pxd`, `constant.pyx`, `pynac.pyx` use various imports from sage and must remain in `sage.libs.pynac`)\n \n \n+Unfortunately, there is an unrelated project that has claimed the name \"Pynac\" on pypi.org: https://pypi.org/project/Pynac\n+\n+\n``````\n",
    "created_at": "2020-09-13T16:37:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486782",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -12,3 +12,6 @@
 (The other parts of `src/sage/libs/pynac`, `constant.pxd`, `constant.pyx`, `pynac.pyx` use various imports from sage and must remain in `sage.libs.pynac`)
 
 
+Unfortunately, there is an unrelated project that has claimed the name "Pynac" on pypi.org: https://pypi.org/project/Pynac
+
+
``````




---

archive/issue_comments_486783.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\n> Unfortunately, there is an unrelated project\n> that has claimed the name \"Pynac\" on pypi.org:\n\n>\n> \u200bhttps://pypi.org/project/Pynac\n\nCollision between\n\n- Pynac = \"Py-Dynac\" = Python bindings for the Dynac particle tracking code\n- Pynac = \"Py-GiNaC\" = Python derivative of the C++ library GiNaC\n\nPossible solutions:\n\n- rename these projects to Py-Dynac and Py-GiNaC, or Pydynac and Pyginac\n- no renaming but use the name pyginac on PyPI for \"Py-GiNaC\"\n\nNote:\n\n- \"Py-Dynac\" got the pynac name on PyPI\n- \"Py-GiNaC\" got the pynac.org domain name\n\nRegardless of how we handle getting \"Py-GiNaC\" on PyPI,\na disambiguation note in both \"Pynac\" projects would be\nnice, with links to each other.\n\nI will propose changes via pull requests or other\nto add such a note in relevant places.",
    "created_at": "2020-09-14T00:24:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486783",
    "user": "https://github.com/slel"
}
```

<div id="comment:4" align="right">comment:4</div>

> Unfortunately, there is an unrelated project
> that has claimed the name "Pynac" on pypi.org:

>
> ​https://pypi.org/project/Pynac

Collision between

- Pynac = "Py-Dynac" = Python bindings for the Dynac particle tracking code
- Pynac = "Py-GiNaC" = Python derivative of the C++ library GiNaC

Possible solutions:

- rename these projects to Py-Dynac and Py-GiNaC, or Pydynac and Pyginac
- no renaming but use the name pyginac on PyPI for "Py-GiNaC"

Note:

- "Py-Dynac" got the pynac name on PyPI
- "Py-GiNaC" got the pynac.org domain name

Regardless of how we handle getting "Py-GiNaC" on PyPI,
a disambiguation note in both "Pynac" projects would be
nice, with links to each other.

I will propose changes via pull requests or other
to add such a note in relevant places.



---

archive/issue_comments_486784.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nOr use pynac-ginac as the PyPI name (more discoverable?).",
    "created_at": "2020-09-14T00:28:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486784",
    "user": "https://github.com/slel"
}
```

<div id="comment:5" align="right">comment:5</div>

Or use pynac-ginac as the PyPI name (more discoverable?).



---

archive/issue_comments_486785.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nWe briefly discussed it at sd110.\n\n  From William Stein (CoCalc) to Everyone: (1:37 PM)\n\u2029  py-ginac is pretty good.",
    "created_at": "2020-10-30T21:15:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486785",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:7" align="right">comment:7</div>

We briefly discussed it at sd110.

  From William Stein (CoCalc) to Everyone: (1:37 PM)
   py-ginac is pretty good.



---

archive/issue_comments_486786.json:
```json
{
    "body": "Changed keywords from **pynac** to **pynac, sd110**",
    "created_at": "2020-10-30T21:15:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486786",
    "user": "https://github.com/mkoeppe"
}
```

Changed keywords from **pynac** to **pynac, sd110**



---

archive/issue_comments_486787.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nThere is already some `py_ginac` somewhere :\n\nhttp://moebinv.sourceforge.net/pyGiNaC.html",
    "created_at": "2020-11-05T13:53:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486787",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:9" align="right">comment:9</div>

There is already some `py_ginac` somewhere :

http://moebinv.sourceforge.net/pyGiNaC.html



---

archive/issue_comments_486788.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@fchapoton](#comment%3A9):\n> There is already some `py_ginac` somewhere :\n> \n> http://moebinv.sourceforge.net/pyGiNaC.html\n\nThanks for the pointer.  This appears to be an active project. \nFrom https://sourceforge.net/projects/pyginac.moebinv.p/: \n\n  \"This is a refresh and maintained version of the previous stalled project https://sourceforge.net/projects/pyginac/ It works with the current version of GiNaC.\"\n\nThe source (git) is at https://sourceforge.net/p/moebinv/pyginac/code/ci/master/tree/\n\nIt provides the Python packages `cginac` and `ginac`.",
    "created_at": "2020-11-06T23:17:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486788",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@fchapoton](#comment%3A9):
> There is already some `py_ginac` somewhere :
> 
> http://moebinv.sourceforge.net/pyGiNaC.html

Thanks for the pointer.  This appears to be an active project. 
From https://sourceforge.net/projects/pyginac.moebinv.p/: 

  "This is a refresh and maintained version of the previous stalled project https://sourceforge.net/projects/pyginac/ It works with the current version of GiNaC."

The source (git) is at https://sourceforge.net/p/moebinv/pyginac/code/ci/master/tree/

It provides the Python packages `cginac` and `ginac`.



---

archive/issue_comments_486789.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nIt calls itself \"pyGiNaC\" but it does not define a distribution of this name. It must be built using scons and is not pip-installable - so it also does not claim a project name on PyPI.",
    "created_at": "2020-11-06T23:26:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486789",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:11" align="right">comment:11</div>

It calls itself "pyGiNaC" but it does not define a distribution of this name. It must be built using scons and is not pip-installable - so it also does not claim a project name on PyPI.



---

archive/issue_comments_486790.json:
```json
{
    "body": "Upstream: **Reported upstream. No feedback yet.**",
    "created_at": "2020-11-10T18:50:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486790",
    "user": "https://github.com/mkoeppe"
}
```

Upstream: **Reported upstream. No feedback yet.**



---

archive/issue_comments_486791.json:
```json
{
    "body": "Changed keywords from **pynac, sd110** to **pynac, sd110, sd111**",
    "created_at": "2020-12-06T17:48:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486791",
    "user": "https://github.com/mkoeppe"
}
```

Changed keywords from **pynac, sd110** to **pynac, sd110, sd111**



---

archive/issue_events_417824.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30534#event-417824"
}
```



---

archive/issue_events_417825.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-02-13T20:51:01Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30534#event-417825"
}
```



---

archive/issue_comments_486792.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nSetting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486792",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:14" align="right">comment:14</div>

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_486793.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nhttps://github.com/pynac/pynac/pull/371",
    "created_at": "2021-02-28T03:44:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486793",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:15" align="right">comment:15</div>

https://github.com/pynac/pynac/pull/371



---

archive/issue_comments_486794.json:
```json
{
    "body": "Dependencies: **#30446**",
    "created_at": "2021-02-28T04:02:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486794",
    "user": "https://github.com/mkoeppe"
}
```

Dependencies: **#30446**



---

archive/issue_comments_486795.json:
```json
{
    "body": "Branch: **[u/mkoeppe/repackage_pynac_as_a_pip_installable_package](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/repackage_pynac_as_a_pip_installable_package)**",
    "created_at": "2021-02-28T04:31:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486795",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/repackage_pynac_as_a_pip_installable_package](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/repackage_pynac_as_a_pip_installable_package)**



---

archive/issue_comments_486796.json:
```json
{
    "body": "<div id=\"comment:18\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/44e4dd88ade4ef49f9dde054b3d75f4b57a4956a\"><code>44e4dd8</code></a></td><td><code>Fixup</code></td></tr></table>\n",
    "created_at": "2021-02-28T06:15:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486796",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:18"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/44e4dd88ade4ef49f9dde054b3d75f4b57a4956a"><code>44e4dd8</code></a></td><td><code>Fixup</code></td></tr></table>




---

archive/issue_comments_486797.json:
```json
{
    "body": "Commit: **[`44e4dd8`](https://github.com/sagemath/sagetrac-mirror/commit/44e4dd88ade4ef49f9dde054b3d75f4b57a4956a)**",
    "created_at": "2021-02-28T06:15:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486797",
    "user": "https://github.com/sagetrac-git"
}
```

Commit: **[`44e4dd8`](https://github.com/sagemath/sagetrac-mirror/commit/44e4dd88ade4ef49f9dde054b3d75f4b57a4956a)**



---

archive/issue_comments_486798.json:
```json
{
    "body": "Author: **Matthias Koeppe, ...**",
    "created_at": "2021-02-28T07:05:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486798",
    "user": "https://github.com/mkoeppe"
}
```

Author: **Matthias Koeppe, ...**



---

archive/issue_comments_486799.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nThe new package installs correctly. `sage.libs.pynac` needs more work.",
    "created_at": "2021-02-28T07:05:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486799",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:19" align="right">comment:19</div>

The new package installs correctly. `sage.libs.pynac` needs more work.



---

archive/issue_comments_486800.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nI think I'll need some help here from people who know about `import` and `cimport` in Cython...",
    "created_at": "2021-02-28T20:37:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486800",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:21" align="right">comment:21</div>

I think I'll need some help here from people who know about `import` and `cimport` in Cython...



---

archive/issue_comments_486801.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nWith what aspects? Just when to use one versus the other?",
    "created_at": "2021-02-28T21:43:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486801",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:22" align="right">comment:22</div>

With what aspects? Just when to use one versus the other?



---

archive/issue_comments_486802.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nI am getting runtime linker errors like the following on this branch:\n\n```\n[dochtml]     import sage.libs.pynac.pynac # initialize pynac before .ring\n[dochtml] ImportError: dlopen(/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-darwin.so, 2): Symbol not found: __ZN5GiNaC12library_initD1Ev\n[dochtml]   Referenced from: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-darwin.so\n[dochtml]   Expected in: flat namespace\n[dochtml]  in /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-darwin.so\n```",
    "created_at": "2021-02-28T21:55:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486802",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:23" align="right">comment:23</div>

I am getting runtime linker errors like the following on this branch:

```
[dochtml]     import sage.libs.pynac.pynac # initialize pynac before .ring
[dochtml] ImportError: dlopen(/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-darwin.so, 2): Symbol not found: __ZN5GiNaC12library_initD1Ev
[dochtml]   Referenced from: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-darwin.so
[dochtml]   Expected in: flat namespace
[dochtml]  in /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-darwin.so
```



---

archive/issue_comments_486803.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nThat is beyond my knowledge as it has something to do with how the packages are linked. Perhaps looking at how [p_group_cohomology](https://github.com/sagemath/p_group_cohomology) does its setup might have a clue?\n\nErik, do you know about these things or know a good person to ask?",
    "created_at": "2021-02-28T23:37:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486803",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:24" align="right">comment:24</div>

That is beyond my knowledge as it has something to do with how the packages are linked. Perhaps looking at how [p_group_cohomology](https://github.com/sagemath/p_group_cohomology) does its setup might have a clue?

Erik, do you know about these things or know a good person to ask?



---

archive/issue_comments_486804.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nThe double leading underscore is very strange. If you remove one it becomes simply\n\n```\n$ c++filt -n _ZN5GiNaC12library_initD1Ev\nGiNaC::library_init::~library_init()\n```\nbut with two, it is nothing. Some naming or interface is not set right.",
    "created_at": "2021-02-28T23:42:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486804",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:25" align="right">comment:25</div>

The double leading underscore is very strange. If you remove one it becomes simply

```
$ c++filt -n _ZN5GiNaC12library_initD1Ev
GiNaC::library_init::~library_init()
```
but with two, it is nothing. Some naming or interface is not set right.



---

archive/issue_comments_486805.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nFirst of all let me remark that I wasn't even able to build it at all until I manually removed all files in `build/pkgs/sagelib/src/build/cythonized/sage/libs/pynac/`.\n\nUntil then there was still the old `pynac_wrap.h` dangling around and it did not clean itself.",
    "created_at": "2021-03-01T08:33:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486805",
    "user": "https://github.com/kliem"
}
```

<div id="comment:26" align="right">comment:26</div>

First of all let me remark that I wasn't even able to build it at all until I manually removed all files in `build/pkgs/sagelib/src/build/cythonized/sage/libs/pynac/`.

Until then there was still the old `pynac_wrap.h` dangling around and it did not clean itself.



---

archive/issue_comments_486806.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nAnd something isn't right about `pynac/setup.py`:\n\n```\n(sage-sh) kliem@cofio:sage$ python\nPython 3.7.3 (default, Jul 25 2020, 13:03:44) \n[GCC 8.3.0] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> from ginac.pynac import *\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nModuleNotFoundError: No module named 'ginac.pynac'\n>>> from ginac.libpynac import *\nSegmentation fault\n```",
    "created_at": "2021-03-01T08:49:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486806",
    "user": "https://github.com/kliem"
}
```

<div id="comment:27" align="right">comment:27</div>

And something isn't right about `pynac/setup.py`:

```
(sage-sh) kliem@cofio:sage$ python
Python 3.7.3 (default, Jul 25 2020, 13:03:44) 
[GCC 8.3.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> from ginac.pynac import *
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
ModuleNotFoundError: No module named 'ginac.pynac'
>>> from ginac.libpynac import *
Segmentation fault
```



---

archive/issue_comments_486807.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nI even get segementation fault in ipython when it tries to load the modules of ginac.",
    "created_at": "2021-03-01T08:50:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486807",
    "user": "https://github.com/kliem"
}
```

<div id="comment:28" align="right">comment:28</div>

I even get segementation fault in ipython when it tries to load the modules of ginac.



---

archive/issue_comments_486808.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nThis part in `numeric.cpp` leads to a segmentation fault when importing the module:\n\n```\n3321 #ifdef PYNAC_HAVE_LIBGIAC\n3322 giac::gen* numeric::to_giacgen(giac::context* cptr) const\n3323 {\n3324         if (t == LONG)\n3325                 return new giac::gen(v._long);\n3326 +----  7 lines: if (t == MPZ) {-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n3333 +---- 10 lines: if (t == MPQ) {-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n3343         else\n3344                 return nullptr;\n3345 }\n3346 #endif\n```\n\ngiac might not be linked correctly, but I don't know. Also `./bootstrap` is missing from `setup.py`. Just running `./configure` isn't working.",
    "created_at": "2021-03-01T13:39:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486808",
    "user": "https://github.com/kliem"
}
```

<div id="comment:29" align="right">comment:29</div>

This part in `numeric.cpp` leads to a segmentation fault when importing the module:

```
3321 #ifdef PYNAC_HAVE_LIBGIAC
3322 giac::gen* numeric::to_giacgen(giac::context* cptr) const
3323 {
3324         if (t == LONG)
3325                 return new giac::gen(v._long);
3326 +----  7 lines: if (t == MPZ) {-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
3333 +---- 10 lines: if (t == MPQ) {-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
3343         else
3344                 return nullptr;
3345 }
3346 #endif
```

giac might not be linked correctly, but I don't know. Also `./bootstrap` is missing from `setup.py`. Just running `./configure` isn't working.



---

archive/issue_comments_486809.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nAlso I would guess that you need to include the header files as `depends=...`.\n\nWhat is definitely missing is `gmptypes`. Also it seems weird that you name the module `ginac.libpynac` but then you cimport `from ginac.pynac import *` in `pynac.pyx`. This isn't defined.\n\nAnyway, if I know just `./bootstrap; make` `pynac` and then include the folder `ginac`, then I'm back to your orignal problem.\n\nFirst I got:\n\n```\nImportError: /home/mi/kliem/Applications/pynac/ginac/pynac.cpython-37m-x86_64-linux-gnu.so: undefined symbol: _ZTVN5GiNaC9containerISt6vectorEE\n```\n\nThis I made go away by declaring things static in `pynac_wrap.h`. Then I get the original error about `library_init`.\n\nThe class `library_init` is defined in `ex.h`. However, the methods are then defined in `utils.cpp`.\n\nBut even if I change this, the error doesn't go ayay. By now, I don't understand anything anymore.",
    "created_at": "2021-03-01T15:33:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486809",
    "user": "https://github.com/kliem"
}
```

<div id="comment:30" align="right">comment:30</div>

Also I would guess that you need to include the header files as `depends=...`.

What is definitely missing is `gmptypes`. Also it seems weird that you name the module `ginac.libpynac` but then you cimport `from ginac.pynac import *` in `pynac.pyx`. This isn't defined.

Anyway, if I know just `./bootstrap; make` `pynac` and then include the folder `ginac`, then I'm back to your orignal problem.

First I got:

```
ImportError: /home/mi/kliem/Applications/pynac/ginac/pynac.cpython-37m-x86_64-linux-gnu.so: undefined symbol: _ZTVN5GiNaC9containerISt6vectorEE
```

This I made go away by declaring things static in `pynac_wrap.h`. Then I get the original error about `library_init`.

The class `library_init` is defined in `ex.h`. However, the methods are then defined in `utils.cpp`.

But even if I change this, the error doesn't go ayay. By now, I don't understand anything anymore.



---

archive/issue_comments_486810.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nI noticed while building the package that giac is automagically detected and used. Current sage package explicitly disable it. I remember chatting with Ralph when he made it available and that it was currently broken. So, first thing will be to disable it.",
    "created_at": "2021-03-01T20:25:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486810",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:31" align="right">comment:31</div>

I noticed while building the package that giac is automagically detected and used. Current sage package explicitly disable it. I remember chatting with Ralph when he made it available and that it was currently broken. So, first thing will be to disable it.



---

archive/issue_comments_486811.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nSee https://github.com/pynac/pynac/pull/372 \"configure: Change default to --with-giac=no\"",
    "created_at": "2021-03-01T20:28:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486811",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:32" align="right">comment:32</div>

See https://github.com/pynac/pynac/pull/372 "configure: Change default to --with-giac=no"



---

archive/issue_comments_486812.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nI pulled on your python_package branch, I guess I should have used the attached tarball.",
    "created_at": "2021-03-01T20:30:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486812",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:33" align="right">comment:33</div>

I pulled on your python_package branch, I guess I should have used the attached tarball.



---

archive/issue_comments_486813.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nI've just the branch into `python_package` and will also prepare a new tarball",
    "created_at": "2021-03-01T20:33:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486813",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:34" align="right">comment:34</div>

I've just the branch into `python_package` and will also prepare a new tarball



---

archive/issue_comments_486814.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nReplying to [@kliem](#comment%3A30):\n> Also it seems weird that you name the module `ginac.libpynac` but then you cimport `from ginac.pynac import *` in `pynac.pyx`. This isn't defined.\n\nThanks, renamed now",
    "created_at": "2021-03-01T20:35:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486814",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:35" align="right">comment:35</div>

Replying to [@kliem](#comment%3A30):
> Also it seems weird that you name the module `ginac.libpynac` but then you cimport `from ginac.pynac import *` in `pynac.pyx`. This isn't defined.

Thanks, renamed now



---

archive/issue_comments_486815.json:
```json
{
    "body": "<div id=\"comment:36\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0a161295b890ebc9aeae59802b1327b7654e3ad7\"><code>0a16129</code></a></td><td><code>WIP</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/72da71ac5f262afae58655ceccc2da30954e2175\"><code>72da71a</code></a></td><td><code>pynac 0.7.27.p16</code></td></tr></table>\n",
    "created_at": "2021-03-01T20:37:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486815",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:36"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0a161295b890ebc9aeae59802b1327b7654e3ad7"><code>0a16129</code></a></td><td><code>WIP</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/72da71ac5f262afae58655ceccc2da30954e2175"><code>72da71a</code></a></td><td><code>pynac 0.7.27.p16</code></td></tr></table>




---

archive/issue_comments_486816.json:
```json
{
    "body": "Changed commit from **[`44e4dd8`](https://github.com/sagemath/sagetrac-mirror/commit/44e4dd88ade4ef49f9dde054b3d75f4b57a4956a)** to **[`72da71a`](https://github.com/sagemath/sagetrac-mirror/commit/72da71ac5f262afae58655ceccc2da30954e2175)**",
    "created_at": "2021-03-01T20:37:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486816",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`44e4dd8`](https://github.com/sagemath/sagetrac-mirror/commit/44e4dd88ade4ef49f9dde054b3d75f4b57a4956a)** to **[`72da71a`](https://github.com/sagemath/sagetrac-mirror/commit/72da71ac5f262afae58655ceccc2da30954e2175)**



---

archive/issue_comments_486817.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nOK, so pulling from your branch and building with my system packages and tools on gentoo with `python setup.py install --prefix=$someprefix` I cannot see anything obviously wrong with what is installed. `ldd -r pynac.cpython-39-x86_64-linux-gnu.so` just report what I am expecting to be missing, that is symbols from python itself.\n\nI am not currently setup for compiling on OS X, which may have trickier issue at linking.",
    "created_at": "2021-03-01T20:44:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486817",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:37" align="right">comment:37</div>

OK, so pulling from your branch and building with my system packages and tools on gentoo with `python setup.py install --prefix=$someprefix` I cannot see anything obviously wrong with what is installed. `ldd -r pynac.cpython-39-x86_64-linux-gnu.so` just report what I am expecting to be missing, that is symbols from python itself.

I am not currently setup for compiling on OS X, which may have trickier issue at linking.



---

archive/issue_comments_486818.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nReplying to [@kliem](#comment%3A29):\n> Also `./bootstrap` is missing from `setup.py`. Just running `./configure` isn't working.\n\nI've now added some instructions to the README",
    "created_at": "2021-03-01T20:58:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486818",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:38" align="right">comment:38</div>

Replying to [@kliem](#comment%3A29):
> Also `./bootstrap` is missing from `setup.py`. Just running `./configure` isn't working.

I've now added some instructions to the README



---

archive/issue_comments_486819.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nhttps://github.com/kliem/pynac/tree/python_package\n\nI did some experiments. Not all changes in this branch are necessary to get things to work. In particular, I did many experiments trying to avoid this segmentation fault, but I couldn't find something. It's ipython specific. Sage just complains about linkage.\n\nAs reported above I get a weird segmentation fault, whenever I import `ginac.pynac`.\n\nIt goes away magically, if I import `ginac.gmptypes` beforehand. I don't know why.\n\nGetting sage to start still does not work, because\n\n```\nImportError: /srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/libs/pynac/pynac.cpython-37m-x86_64-linux-gnu.so: undefined symbol: _ZN5GiNaC8py_funcsE\n```\n\nI don't know why it would be undefined. It is sage specific. In an Ipython session it is fine even if I add something that uses it to `ginac/pynac.pyx'\n\n```diff\n+cdef py_gcd(n, k):\n+    return n*k\n+\n+\n+def init_function_table():\n+    py_funcs.py_gcd = &py_gcd\n+\n```\n\nIf I pip install this, I can run this function just fine in ipython:\n\n```\n(sage-sh) kliem@cofio:pynac$ ipython\nPython 3.7.3 (default, Jul 25 2020, 13:03:44) \nType 'copyright', 'credits' or 'license' for more information\nIPython 7.13.0 -- An enhanced Interactive Python. Type '?' for help.\n\nIn [1]: from ginac import gmptypes                                                                                                                                                                                                                                             \n\nIn [2]: from ginac.pynac import *                                                                                                                                                                                                                                              \n\nIn [3]: init_function_table()  \n```\n\nWhat is even more strange about this segementation fault is that in sage on develop branch I can run `import os` beforehand to fix this. This does not work in ipython.",
    "created_at": "2021-03-01T21:36:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486819",
    "user": "https://github.com/kliem"
}
```

<div id="comment:39" align="right">comment:39</div>

https://github.com/kliem/pynac/tree/python_package

I did some experiments. Not all changes in this branch are necessary to get things to work. In particular, I did many experiments trying to avoid this segmentation fault, but I couldn't find something. It's ipython specific. Sage just complains about linkage.

As reported above I get a weird segmentation fault, whenever I import `ginac.pynac`.

It goes away magically, if I import `ginac.gmptypes` beforehand. I don't know why.

Getting sage to start still does not work, because

```
ImportError: /srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/libs/pynac/pynac.cpython-37m-x86_64-linux-gnu.so: undefined symbol: _ZN5GiNaC8py_funcsE
```

I don't know why it would be undefined. It is sage specific. In an Ipython session it is fine even if I add something that uses it to `ginac/pynac.pyx'

```diff
+cdef py_gcd(n, k):
+    return n*k
+
+
+def init_function_table():
+    py_funcs.py_gcd = &py_gcd
+
```

If I pip install this, I can run this function just fine in ipython:

```
(sage-sh) kliem@cofio:pynac$ ipython
Python 3.7.3 (default, Jul 25 2020, 13:03:44) 
Type 'copyright', 'credits' or 'license' for more information
IPython 7.13.0 -- An enhanced Interactive Python. Type '?' for help.

In [1]: from ginac import gmptypes                                                                                                                                                                                                                                             

In [2]: from ginac.pynac import *                                                                                                                                                                                                                                              

In [3]: init_function_table()  
```

What is even more strange about this segementation fault is that in sage on develop branch I can run `import os` beforehand to fix this. This does not work in ipython.



---

archive/issue_comments_486820.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nTrying to build this branch from vanilla sage, pynac building fails miserably, unlike my simple build from from your git fork. I could import pynac.ginac when build from your git repo, but here I get\n\n```\n  Error compiling Cython file:\n  ------------------------------------------------------------\n  ...\n  # (at your option) any later version.\n  #                  http://www.gnu.org/licenses/\n  #*****************************************************************************\n\n  from cpython cimport *\n  from ginac.pynac cimport *\n  ^\n  ------------------------------------------------------------\n\n  ginac/pynac.pyx:18:0: 'ginac/pynac.pxd' not found\n\n  Error compiling Cython file:\n  ------------------------------------------------------------\n  ...\n      defined by GiNaC. This allows us to prevent collisions with C++ level\n      special functions when a user asks to construct a symbolic function\n      with the same name.\n      \"\"\"\n      global GINAC_FN_SERIAL\n      GINAC_FN_SERIAL = g_registered_functions().size()\n                       ^\n  ------------------------------------------------------------\n\n  ginac/pynac.pyx:30:22: undeclared name not builtin: g_registered_functions\n  Compiling ginac/pynac.pyx because it changed.\n  [1/1] Cythonizing ginac/pynac.pyx\n```",
    "created_at": "2021-03-01T21:38:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486820",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:40" align="right">comment:40</div>

Trying to build this branch from vanilla sage, pynac building fails miserably, unlike my simple build from from your git fork. I could import pynac.ginac when build from your git repo, but here I get

```
  Error compiling Cython file:
  ------------------------------------------------------------
  ...
  # (at your option) any later version.
  #                  http://www.gnu.org/licenses/
  #*****************************************************************************

  from cpython cimport *
  from ginac.pynac cimport *
  ^
  ------------------------------------------------------------

  ginac/pynac.pyx:18:0: 'ginac/pynac.pxd' not found

  Error compiling Cython file:
  ------------------------------------------------------------
  ...
      defined by GiNaC. This allows us to prevent collisions with C++ level
      special functions when a user asks to construct a symbolic function
      with the same name.
      """
      global GINAC_FN_SERIAL
      GINAC_FN_SERIAL = g_registered_functions().size()
                       ^
  ------------------------------------------------------------

  ginac/pynac.pyx:30:22: undeclared name not builtin: g_registered_functions
  Compiling ginac/pynac.pyx because it changed.
  [1/1] Cythonizing ginac/pynac.pyx
```



---

archive/issue_comments_486821.json:
```json
{
    "body": "<div id=\"comment:41\"></div>\n\nBranch pushed to git repo; I updated commit sha1. Last 10 new commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cea4cd5aed351f19c0d6129e1e508c1d7179c751\"><code>cea4cd5</code></a></td><td><code>ci-cygwin-standard.yml: More stages, continue-on-error: true</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cf31b79036db96b5fd9e0b22f44c3692bc22356b\"><code>cf31b79</code></a></td><td><code>Fixup after cherry-pick</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/073124cb21874ec02071377adcde9e5cbe895426\"><code>073124c</code></a></td><td><code>Merge branch 't/31084/makefile__add__ptest__targets_that_do_not_depend_on_the_docbuild' into t/31064/ci_cygwin__yml__adjust_to_new_script_packages__bootstrap___prereq</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8769bd66363a757f8917f8b59c149b4807649234\"><code>8769bd6</code></a></td><td><code>.github/workflows/ci-cygwin-*.yml: Separate docbuild and ptest</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/38262228db0391e9bc8cda5bf06982d6d0db12ca\"><code>3826222</code></a></td><td><code>Fix up stage iv</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/598b0c233a501dba64b66c26577d533c826d9ad5\"><code>598b0c2</code></a></td><td><code>local-cygwin-choco: Do not pass through PATH, use full pathname of choco instead</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d65299c666b9ed71a8f93cfb0b830c15d9e923f8\"><code>d65299c</code></a></td><td><code>Merge branch 't/29124/script-packages-prereq-toolchain-bootstrap' into t/31064/ci_cygwin__yml__adjust_to_new_script_packages__bootstrap___prereq</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a5e405116fa41c9afb3c5f46fbde2489616d267f\"><code>a5e4051</code></a></td><td><code>Merge branch 't/30944/tox__improve_local_sudo_ubuntu_standard' into t/31064/ci_cygwin__yml__adjust_to_new_script_packages__bootstrap___prereq</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/42f4458e3ae857f82759b3c9490ab34306a15f4d\"><code>42f4458</code></a></td><td><code>Merge tag '9.3.beta7' into t/31064/ci_cygwin__yml__adjust_to_new_script_packages__bootstrap___prereq</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f24d6466798713a884877b0fa4afb1c6b20d29fb\"><code>f24d646</code></a></td><td><code>Merge #31064</code></td></tr></table>\n",
    "created_at": "2021-03-02T02:42:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486821",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:41"></div>

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cea4cd5aed351f19c0d6129e1e508c1d7179c751"><code>cea4cd5</code></a></td><td><code>ci-cygwin-standard.yml: More stages, continue-on-error: true</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cf31b79036db96b5fd9e0b22f44c3692bc22356b"><code>cf31b79</code></a></td><td><code>Fixup after cherry-pick</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/073124cb21874ec02071377adcde9e5cbe895426"><code>073124c</code></a></td><td><code>Merge branch 't/31084/makefile__add__ptest__targets_that_do_not_depend_on_the_docbuild' into t/31064/ci_cygwin__yml__adjust_to_new_script_packages__bootstrap___prereq</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8769bd66363a757f8917f8b59c149b4807649234"><code>8769bd6</code></a></td><td><code>.github/workflows/ci-cygwin-*.yml: Separate docbuild and ptest</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/38262228db0391e9bc8cda5bf06982d6d0db12ca"><code>3826222</code></a></td><td><code>Fix up stage iv</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/598b0c233a501dba64b66c26577d533c826d9ad5"><code>598b0c2</code></a></td><td><code>local-cygwin-choco: Do not pass through PATH, use full pathname of choco instead</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d65299c666b9ed71a8f93cfb0b830c15d9e923f8"><code>d65299c</code></a></td><td><code>Merge branch 't/29124/script-packages-prereq-toolchain-bootstrap' into t/31064/ci_cygwin__yml__adjust_to_new_script_packages__bootstrap___prereq</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a5e405116fa41c9afb3c5f46fbde2489616d267f"><code>a5e4051</code></a></td><td><code>Merge branch 't/30944/tox__improve_local_sudo_ubuntu_standard' into t/31064/ci_cygwin__yml__adjust_to_new_script_packages__bootstrap___prereq</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/42f4458e3ae857f82759b3c9490ab34306a15f4d"><code>42f4458</code></a></td><td><code>Merge tag '9.3.beta7' into t/31064/ci_cygwin__yml__adjust_to_new_script_packages__bootstrap___prereq</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f24d6466798713a884877b0fa4afb1c6b20d29fb"><code>f24d646</code></a></td><td><code>Merge #31064</code></td></tr></table>




---

archive/issue_comments_486822.json:
```json
{
    "body": "Changed commit from **[`72da71a`](https://github.com/sagemath/sagetrac-mirror/commit/72da71ac5f262afae58655ceccc2da30954e2175)** to **[`f24d646`](https://github.com/sagemath/sagetrac-mirror/commit/f24d6466798713a884877b0fa4afb1c6b20d29fb)**",
    "created_at": "2021-03-02T02:42:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486822",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`72da71a`](https://github.com/sagemath/sagetrac-mirror/commit/72da71ac5f262afae58655ceccc2da30954e2175)** to **[`f24d646`](https://github.com/sagemath/sagetrac-mirror/commit/f24d6466798713a884877b0fa4afb1c6b20d29fb)**



---

archive/issue_comments_486823.json:
```json
{
    "body": "Changed dependencies from **#30446** to **#30446, #31064**",
    "created_at": "2021-03-02T02:42:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486823",
    "user": "https://github.com/mkoeppe"
}
```

Changed dependencies from **#30446** to **#30446, #31064**



---

archive/issue_comments_486824.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nI have pushed a few more changes to the pynac branch and have set up testing against this ticket - running at https://github.com/mkoeppe/pynac/runs/2010476345",
    "created_at": "2021-03-02T05:42:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486824",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:43" align="right">comment:43</div>

I have pushed a few more changes to the pynac branch and have set up testing against this ticket - running at https://github.com/mkoeppe/pynac/runs/2010476345



---

archive/issue_comments_486825.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nYes, same error here. `ginac/pynax.pdx` is missing from the configure file now.\n\nAfter adding it, the build runs fine. Sage doens't start with the same stupid error:\n\n```\nImportError: /srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/libs/pynac/pynac.cpython-37m-x86_64-linux-gnu.so: undefined symbol: _ZN5GiNaC8py_funcsE\n```\n\nThe segmentation fault in ipython went away for an `ImportError`:\n\n```\nImportError: /srv/public/kliem/sage/local/lib/python3.7/site-packages/ginac/pynac.cpython-37m-x86_64-linux-gnu.so: undefined symbol: _ZN4giac25i_lex_is_strictly_greaterERKNS_7index_mES2_\n```\n\n\nReplying to [@kiwifb](#comment%3A40):\n> Trying to build this branch from vanilla sage, pynac building fails miserably, unlike my simple build from from your git fork. I could import pynac.ginac when build from your git repo, but here I get\n> \n> ```\n>   Error compiling Cython file:\n>   ------------------------------------------------------------\n>   ...\n>   # (at your option) any later version.\n>   #                  http://www.gnu.org/licenses/\n>   #*****************************************************************************\n> \n>   from cpython cimport *\n>   from ginac.pynac cimport *\n>   ^\n>   ------------------------------------------------------------\n> \n>   ginac/pynac.pyx:18:0: 'ginac/pynac.pxd' not found\n> \n>   Error compiling Cython file:\n>   ------------------------------------------------------------\n>   ...\n>       defined by GiNaC. This allows us to prevent collisions with C++ level\n>       special functions when a user asks to construct a symbolic function\n>       with the same name.\n>       \"\"\"\n>       global GINAC_FN_SERIAL\n>       GINAC_FN_SERIAL = g_registered_functions().size()\n>                        ^\n>   ------------------------------------------------------------\n> \n>   ginac/pynac.pyx:30:22: undeclared name not builtin: g_registered_functions\n>   Compiling ginac/pynac.pyx because it changed.\n>   [1/1] Cythonizing ginac/pynac.pyx\n> ```",
    "created_at": "2021-03-02T06:37:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486825",
    "user": "https://github.com/kliem"
}
```

<div id="comment:44" align="right">comment:44</div>

Yes, same error here. `ginac/pynax.pdx` is missing from the configure file now.

After adding it, the build runs fine. Sage doens't start with the same stupid error:

```
ImportError: /srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/libs/pynac/pynac.cpython-37m-x86_64-linux-gnu.so: undefined symbol: _ZN5GiNaC8py_funcsE
```

The segmentation fault in ipython went away for an `ImportError`:

```
ImportError: /srv/public/kliem/sage/local/lib/python3.7/site-packages/ginac/pynac.cpython-37m-x86_64-linux-gnu.so: undefined symbol: _ZN4giac25i_lex_is_strictly_greaterERKNS_7index_mES2_
```


Replying to [@kiwifb](#comment%3A40):
> Trying to build this branch from vanilla sage, pynac building fails miserably, unlike my simple build from from your git fork. I could import pynac.ginac when build from your git repo, but here I get
> 
> ```
>   Error compiling Cython file:
>   ------------------------------------------------------------
>   ...
>   # (at your option) any later version.
>   #                  http://www.gnu.org/licenses/
>   #*****************************************************************************
> 
>   from cpython cimport *
>   from ginac.pynac cimport *
>   ^
>   ------------------------------------------------------------
> 
>   ginac/pynac.pyx:18:0: 'ginac/pynac.pxd' not found
> 
>   Error compiling Cython file:
>   ------------------------------------------------------------
>   ...
>       defined by GiNaC. This allows us to prevent collisions with C++ level
>       special functions when a user asks to construct a symbolic function
>       with the same name.
>       """
>       global GINAC_FN_SERIAL
>       GINAC_FN_SERIAL = g_registered_functions().size()
>                        ^
>   ------------------------------------------------------------
> 
>   ginac/pynac.pyx:30:22: undeclared name not builtin: g_registered_functions
>   Compiling ginac/pynac.pyx because it changed.
>   [1/1] Cythonizing ginac/pynac.pyx
> ```



---

archive/issue_comments_486826.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nReplying to [@kliem](#comment%3A26):\n> First of all let me remark that I wasn't even able to build it at all until I manually removed all files in `build/pkgs/sagelib/src/build/cythonized/sage/libs/pynac/`.\n> \n> Until then there was still the old `pynac_wrap.h` dangling around and it did not clean itself.\n\nHas anyone experienced this? This seems to be a bug in our build system?",
    "created_at": "2021-03-02T06:46:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486826",
    "user": "https://github.com/kliem"
}
```

<div id="comment:45" align="right">comment:45</div>

Replying to [@kliem](#comment%3A26):
> First of all let me remark that I wasn't even able to build it at all until I manually removed all files in `build/pkgs/sagelib/src/build/cythonized/sage/libs/pynac/`.
> 
> Until then there was still the old `pynac_wrap.h` dangling around and it did not clean itself.

Has anyone experienced this? This seems to be a bug in our build system?



---

archive/issue_comments_486827.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nReplying to [@kliem](#comment%3A44):\n> Yes, same error here. `ginac/pynax.pdx` is missing from the configure file now.\n\n`pynac.pxd` is generated by `setup.py` from `pynac.pxd.in` via the `configure` script.\nInstallation of the new package can be seen to succeed in https://github.com/mkoeppe/pynac/runs/2010476345",
    "created_at": "2021-03-02T06:51:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486827",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:46" align="right">comment:46</div>

Replying to [@kliem](#comment%3A44):
> Yes, same error here. `ginac/pynax.pdx` is missing from the configure file now.

`pynac.pxd` is generated by `setup.py` from `pynac.pxd.in` via the `configure` script.
Installation of the new package can be seen to succeed in https://github.com/mkoeppe/pynac/runs/2010476345



---

archive/issue_comments_486828.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\nReplying to [@kliem](#comment%3A45):\n> Replying to [@kliem](#comment%3A26):\n> > First of all let me remark that I wasn't even able to build it at all until I manually removed all files in `build/pkgs/sagelib/src/build/cythonized/sage/libs/pynac/`.\n> > \n> > Until then there was still the old `pynac_wrap.h` dangling around and it did not clean itself.\n\n> \n> Has anyone experienced this? This seems to be a bug in our build system?\n\nYes, quite possible that the install cleaner only handles Python modules and extensions but not package data.",
    "created_at": "2021-03-02T06:53:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486828",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:47" align="right">comment:47</div>

Replying to [@kliem](#comment%3A45):
> Replying to [@kliem](#comment%3A26):
> > First of all let me remark that I wasn't even able to build it at all until I manually removed all files in `build/pkgs/sagelib/src/build/cythonized/sage/libs/pynac/`.
> > 
> > Until then there was still the old `pynac_wrap.h` dangling around and it did not clean itself.

> 
> Has anyone experienced this? This seems to be a bug in our build system?

Yes, quite possible that the install cleaner only handles Python modules and extensions but not package data.



---

archive/issue_comments_486829.json:
```json
{
    "body": "Changed commit from **[`f24d646`](https://github.com/sagemath/sagetrac-mirror/commit/f24d6466798713a884877b0fa4afb1c6b20d29fb)** to **[`c0805f5`](https://github.com/sagemath/sagetrac-mirror/commit/c0805f54143cab58d56e351c19cb5b28944f0148)**",
    "created_at": "2021-03-02T07:02:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486829",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`f24d646`](https://github.com/sagemath/sagetrac-mirror/commit/f24d6466798713a884877b0fa4afb1c6b20d29fb)** to **[`c0805f5`](https://github.com/sagemath/sagetrac-mirror/commit/c0805f54143cab58d56e351c19cb5b28944f0148)**



---

archive/issue_comments_486830.json:
```json
{
    "body": "<div id=\"comment:48\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c0805f54143cab58d56e351c19cb5b28944f0148\"><code>c0805f5</code></a></td><td><code>build/pkgs/pynac: Use 9c89d8bbc723456b2d94efb78ca1df1820694ff0</code></td></tr></table>\n",
    "created_at": "2021-03-02T07:02:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486830",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:48"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c0805f54143cab58d56e351c19cb5b28944f0148"><code>c0805f5</code></a></td><td><code>build/pkgs/pynac: Use 9c89d8bbc723456b2d94efb78ca1df1820694ff0</code></td></tr></table>




---

archive/issue_comments_486831.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\nJust packaged up current HEAD of my pynac `python_package` branch.",
    "created_at": "2021-03-02T07:03:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486831",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:49" align="right">comment:49</div>

Just packaged up current HEAD of my pynac `python_package` branch.



---

archive/issue_comments_486832.json:
```json
{
    "body": "Attachment: **[py-ginac-0.7.27.tar.gz](https://github.com/sagemath/sage/files/ticket30534/py-ginac-0.7.27.tar.gz)**",
    "created_at": "2021-03-02T07:07:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486832",
    "user": "https://github.com/mkoeppe"
}
```

Attachment: **[py-ginac-0.7.27.tar.gz](https://github.com/sagemath/sage/files/ticket30534/py-ginac-0.7.27.tar.gz)**



---

archive/issue_comments_486833.json:
```json
{
    "body": "<div id=\"comment:50\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/93fe11f753cff24f7d81f00b91ec393bcbfc1721\"><code>93fe11f</code></a></td><td><code>build/pkgs/pynac: Use 5701911df8f00c99bc7c7ed676360729200fb726</code></td></tr></table>\n",
    "created_at": "2021-03-02T07:08:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486833",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:50"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/93fe11f753cff24f7d81f00b91ec393bcbfc1721"><code>93fe11f</code></a></td><td><code>build/pkgs/pynac: Use 5701911df8f00c99bc7c7ed676360729200fb726</code></td></tr></table>




---

archive/issue_comments_486834.json:
```json
{
    "body": "Changed commit from **[`c0805f5`](https://github.com/sagemath/sagetrac-mirror/commit/c0805f54143cab58d56e351c19cb5b28944f0148)** to **[`93fe11f`](https://github.com/sagemath/sagetrac-mirror/commit/93fe11f753cff24f7d81f00b91ec393bcbfc1721)**",
    "created_at": "2021-03-02T07:08:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486834",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`c0805f5`](https://github.com/sagemath/sagetrac-mirror/commit/c0805f54143cab58d56e351c19cb5b28944f0148)** to **[`93fe11f`](https://github.com/sagemath/sagetrac-mirror/commit/93fe11f753cff24f7d81f00b91ec393bcbfc1721)**



---

archive/issue_comments_486835.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\n(and another time.)",
    "created_at": "2021-03-02T07:08:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486835",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:51" align="right">comment:51</div>

(and another time.)



---

archive/issue_comments_486836.json:
```json
{
    "body": "<div id=\"comment:52\" align=\"right\">comment:52</div>\n\nThis is fixed with the new attachment. Before there was a version where `ginac/pynac.pxd` was missing from configure for some reason.\n\nReplying to [@mkoeppe](#comment%3A46):\n> Replying to [@kliem](#comment%3A44):\n> > Yes, same error here. `ginac/pynax.pdx` is missing from the configure file now.\n\n> \n> `pynac.pxd` is generated by `setup.py` from `pynac.pxd.in` via the `configure` script.\n> Installation of the new package can be seen to succeed in https://github.com/mkoeppe/pynac/runs/2010476345\n> \n> \n\n>",
    "created_at": "2021-03-02T07:23:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486836",
    "user": "https://github.com/kliem"
}
```

<div id="comment:52" align="right">comment:52</div>

This is fixed with the new attachment. Before there was a version where `ginac/pynac.pxd` was missing from configure for some reason.

Replying to [@mkoeppe](#comment%3A46):
> Replying to [@kliem](#comment%3A44):
> > Yes, same error here. `ginac/pynax.pdx` is missing from the configure file now.

> 
> `pynac.pxd` is generated by `setup.py` from `pynac.pxd.in` via the `configure` script.
> Installation of the new package can be seen to succeed in https://github.com/mkoeppe/pynac/runs/2010476345
> 
> 

>



---

archive/issue_comments_486837.json:
```json
{
    "body": "<div id=\"comment:53\" align=\"right\">comment:53</div>\n\nWith the new branch I can now do `from ginac.pynac import *` without an error raising in `ipython`. The `ImportError` when loading sage itself still persists.",
    "created_at": "2021-03-02T07:24:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486837",
    "user": "https://github.com/kliem"
}
```

<div id="comment:53" align="right">comment:53</div>

With the new branch I can now do `from ginac.pynac import *` without an error raising in `ipython`. The `ImportError` when loading sage itself still persists.



---

archive/issue_comments_486838.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">comment:54</div>\n\nSo maybe this module needs to include something on runtime and this doesn't work. So `from ginac.pynac import *` works fine, but the `cimport` doesn't.\n\nIn my experiments, the `os.path.dirname(__file__)` in the setup file didn't do anything. Maybe the `include_dirs` are set up wrong?",
    "created_at": "2021-03-02T07:33:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486838",
    "user": "https://github.com/kliem"
}
```

<div id="comment:54" align="right">comment:54</div>

So maybe this module needs to include something on runtime and this doesn't work. So `from ginac.pynac import *` works fine, but the `cimport` doesn't.

In my experiments, the `os.path.dirname(__file__)` in the setup file didn't do anything. Maybe the `include_dirs` are set up wrong?



---

archive/issue_comments_486839.json:
```json
{
    "body": "<div id=\"comment:55\" align=\"right\">comment:55</div>\n\nOK, tried with all the new stuff. Stopped at the documentation again but different symbol than in [comment:23](#comment%3A23)\n\n```\n[dochtml] ImportError: /home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so: undefined symbol: _ZN5GiNaC8py_funcsE\n```\nwhich is\n\n```\n$ c++filt -n _ZN5GiNaC8py_funcsE\nGiNaC::py_funcs\n```",
    "created_at": "2021-03-02T09:59:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486839",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:55" align="right">comment:55</div>

OK, tried with all the new stuff. Stopped at the documentation again but different symbol than in [comment:23](#comment%3A23)

```
[dochtml] ImportError: /home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so: undefined symbol: _ZN5GiNaC8py_funcsE
```
which is

```
$ c++filt -n _ZN5GiNaC8py_funcsE
GiNaC::py_funcs
```



---

archive/issue_comments_486840.json:
```json
{
    "body": "<div id=\"comment:56\" align=\"right\">comment:56</div>\n\nRunning `ldd`, removing python calls and going through `c++filt -n` the following symbols are undefined  and should be replaced by calls since you cannot link to the python module\n\n```\nldd -r /home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so | grep _Z | c++filt -n\nundefined symbol: GiNaC::py_funcs       (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: vtable for GiNaC::container<std::vector>      (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: typeinfo for GiNaC::numeric   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: typeinfo for GiNaC::symbol    (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::library_init::~library_init()  (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::container<std::vector>::tinfo_static   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: vtable for GiNaC::constant    (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::I      (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::_num0_bp       (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: typeinfo for GiNaC::pseries   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: typeinfo for GiNaC::basic     (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::function::function(unsigned int, GiNaC::ex const&, GiNaC::ex const&)   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::library_init::library_init()   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: ginac_pyinit_Float(_object*)  (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::function::function(unsigned int, std::vector<GiNaC::ex, std::allocator<GiNaC::ex> > const&, bool)      (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: ginac_pyinit_I(_object*)      (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: std::vector<GiNaC::ex, std::allocator<GiNaC::ex> >::~vector() (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::relational::decide() const     (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::function::function(unsigned int, GiNaC::ex const&, GiNaC::ex const&, GiNaC::ex const&) (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::ex::sorted_op(unsigned long) const     (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::ex::construct_from_basic(GiNaC::basic const&)  (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::pseries::is_terminating() const        (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::function::function(unsigned int)       (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::function::registered_functions()       (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::ex::compare(GiNaC::ex const&) const    (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::numeric::to_pyobject() const   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::relational::the_operator() const       (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::function::function(unsigned int, GiNaC::ex const&)     (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::ex::construct_from_int(int)    (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::constant::constant()   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::basic::hold() const    (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: ginac_pyinit_Integer(_object*)        (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::basic::operator=(GiNaC::basic const&)  (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\n```",
    "created_at": "2021-03-02T10:48:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486840",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:56" align="right">comment:56</div>

Running `ldd`, removing python calls and going through `c++filt -n` the following symbols are undefined  and should be replaced by calls since you cannot link to the python module

```
ldd -r /home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so | grep _Z | c++filt -n
undefined symbol: GiNaC::py_funcs       (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: vtable for GiNaC::container<std::vector>      (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: typeinfo for GiNaC::numeric   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: typeinfo for GiNaC::symbol    (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::library_init::~library_init()  (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::container<std::vector>::tinfo_static   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: vtable for GiNaC::constant    (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::I      (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::_num0_bp       (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: typeinfo for GiNaC::pseries   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: typeinfo for GiNaC::basic     (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::function::function(unsigned int, GiNaC::ex const&, GiNaC::ex const&)   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::library_init::library_init()   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: ginac_pyinit_Float(_object*)  (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::function::function(unsigned int, std::vector<GiNaC::ex, std::allocator<GiNaC::ex> > const&, bool)      (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: ginac_pyinit_I(_object*)      (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: std::vector<GiNaC::ex, std::allocator<GiNaC::ex> >::~vector() (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::relational::decide() const     (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::function::function(unsigned int, GiNaC::ex const&, GiNaC::ex const&, GiNaC::ex const&) (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::ex::sorted_op(unsigned long) const     (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::ex::construct_from_basic(GiNaC::basic const&)  (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::pseries::is_terminating() const        (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::function::function(unsigned int)       (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::function::registered_functions()       (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::ex::compare(GiNaC::ex const&) const    (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::numeric::to_pyobject() const   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::relational::the_operator() const       (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::function::function(unsigned int, GiNaC::ex const&)     (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::ex::construct_from_int(int)    (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::constant::constant()   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::basic::hold() const    (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: ginac_pyinit_Integer(_object*)        (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::basic::operator=(GiNaC::basic const&)  (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
```



---

archive/issue_comments_486841.json:
```json
{
    "body": "<div id=\"comment:57\" align=\"right\">comment:57</div>\n\nLooks like trying to pull in everything to `sage.libs.pynac` by `from ginac.pynac cimport *` is a mistake and instead all modules that need pynac should `cimport` more specifically from `ginac.pynac`",
    "created_at": "2021-03-02T16:17:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486841",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:57" align="right">comment:57</div>

Looks like trying to pull in everything to `sage.libs.pynac` by `from ginac.pynac cimport *` is a mistake and instead all modules that need pynac should `cimport` more specifically from `ginac.pynac`



---

archive/issue_comments_486842.json:
```json
{
    "body": "<div id=\"comment:58\" align=\"right\">comment:58</div>\n\nReplying to [@mkoeppe](#comment%3A57):\n> Looks like trying to pull in everything to `sage.libs.pynac` by `from ginac.pynac cimport *` is a mistake and instead all modules that need pynac should `cimport` more specifically from `ginac.pynac`\n\nBut why does\n\n```\nsage: cython(''' \n....: from sage.libs.pynac.pynac cimport * \n....: ''')    \n```\n\nworks just fine on develop? I would say that things should work just fine, once everything is set up correctly. However, I don't know how to resolve the problems as I'm currently not even able to `cimport` from my own little two files project.",
    "created_at": "2021-03-02T17:11:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486842",
    "user": "https://github.com/kliem"
}
```

<div id="comment:58" align="right">comment:58</div>

Replying to [@mkoeppe](#comment%3A57):
> Looks like trying to pull in everything to `sage.libs.pynac` by `from ginac.pynac cimport *` is a mistake and instead all modules that need pynac should `cimport` more specifically from `ginac.pynac`

But why does

```
sage: cython(''' 
....: from sage.libs.pynac.pynac cimport * 
....: ''')    
```

works just fine on develop? I would say that things should work just fine, once everything is set up correctly. However, I don't know how to resolve the problems as I'm currently not even able to `cimport` from my own little two files project.



---

archive/issue_comments_486843.json:
```json
{
    "body": "<div id=\"comment:59\" align=\"right\">comment:59</div>\n\nI might have found the problem:\n\nIn `setup.py`:\n\n```diff\n-       package_data = {'ginac': ['*.pxd', '*.h', '*.hpp']},\n+       package_data = {'ginac': ['*.pxd', '*.h', '*.hpp', '*.cpp']},\n```\n\nThis will place the `.cpp` files in the correct directory. We need them, because when we cimport we recompile some of them. When the `.cpp` files are not there, we get the missing symbols.\n\nAfter doing this, I get a new error:\n\n```\n[sagelib-9.3.beta7] g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-rpath-link,/srv/public/kliem/sage/local/lib -L/srv/public/kliem/sage/local/lib -Wl,-rpath,/srv/public/kliem/sage/local/lib -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.7/build/cythonized/sage/libs/pynac/constant.o -lflint -lgmp -lginac -o build/lib.linux-x86_64-3.7/sage/libs/pynac/constant.cpython-37m-x86_64-linux-gnu.so -L/srv/public/kliem/sage/local/lib -lfactory -lntl -lgmp -lomalloc -lsingular_resources\n[sagelib-9.3.beta7] /usr/bin/ld: cannot find -lginac\n[sagelib-9.3.beta7] collect2: error: ld returned 1 exit status\n[sagelib-9.3.beta7] g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-rpath-link,/srv/public/kliem/sage/local/lib -L/srv/public/kliem/sage/local/lib -Wl,-rpath,/srv/public/kliem/sage/local/lib -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.7/build/cythonized/sage/symbolic/ring.o -lflint -lgmp -lginac -o build/lib.linux-x86_64-3.7/sage/symbolic/ring.cpython-37m-x86_64-linux-gnu.so -L/srv/public/kliem/sage/local/lib -lfactory -lntl -lgmp -lomalloc -lsingular_resources\n[sagelib-9.3.beta7] /usr/bin/ld: cannot find -lginac\n[sagelib-9.3.beta7] collect2: error: ld returned 1 exit status\n[sagelib-9.3.beta7] g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-rpath-link,/srv/public/kliem/sage/local/lib -L/srv/public/kliem/sage/local/lib -Wl,-rpath,/srv/public/kliem/sage/local/lib -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.7/build/cythonized/sage/symbolic/function.o -lflint -lgmp -lginac -o build/lib.linux-x86_64-3.7/sage/symbolic/function.cpython-37m-x86_64-linux-gnu.so -L/srv/public/kliem/sage/local/lib -lfactory -lntl -lgmp -lomalloc -lsingular_resources\n[sagelib-9.3.beta7] /usr/bin/ld: cannot find -lginac\n[sagelib-9.3.beta7] collect2: error: ld returned 1 exit status\n[sagelib-9.3.beta7] g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-rpath-link,/srv/public/kliem/sage/local/lib -L/srv/public/kliem/sage/local/lib -Wl,-rpath,/srv/public/kliem/sage/local/lib -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.7/build/cythonized/sage/libs/pynac/pynac.o -L/srv/public/kliem/sage/local/lib -lgsl -lflint -lgmp -lm -lopenblas -lginac -o build/lib.linux-x86_64-3.7/sage/libs/pynac/pynac.cpython-37m-x86_64-linux-gnu.so -L/srv/public/kliem/sage/local/lib -lfactory -lntl -lgmp -lomalloc -lsingular_resources\n[sagelib-9.3.beta7] /usr/bin/ld: cannot find -lginac\n[sagelib-9.3.beta7] collect2: error: ld returned 1 exit status\n[sagelib-9.3.beta7] g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-rpath-link,/srv/public/kliem/sage/local/lib -L/srv/public/kliem/sage/local/lib -Wl,-rpath,/srv/public/kliem/sage/local/lib -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.7/build/cythonized/sage/symbolic/expression.o -lflint -lgmp -lginac -o build/lib.linux-x86_64-3.7/sage/symbolic/expression.cpython-37m-x86_64-linux-gnu.so -L/srv/public/kliem/sage/local/lib -lfactory -lntl -lgmp -lomalloc -lsingular_resources -lpari\n[sagelib-9.3.beta7] /usr/bin/ld: cannot find -lginac\n[sagelib-9.3.beta7] collect2: error: ld returned 1 exit status\n[sagelib-9.3.beta7] error: command 'g++' failed with exit status 1\n```\n\nBut I think, this might be easier to resolve.",
    "created_at": "2021-03-02T18:22:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486843",
    "user": "https://github.com/kliem"
}
```

<div id="comment:59" align="right">comment:59</div>

I might have found the problem:

In `setup.py`:

```diff
-       package_data = {'ginac': ['*.pxd', '*.h', '*.hpp']},
+       package_data = {'ginac': ['*.pxd', '*.h', '*.hpp', '*.cpp']},
```

This will place the `.cpp` files in the correct directory. We need them, because when we cimport we recompile some of them. When the `.cpp` files are not there, we get the missing symbols.

After doing this, I get a new error:

```
[sagelib-9.3.beta7] g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-rpath-link,/srv/public/kliem/sage/local/lib -L/srv/public/kliem/sage/local/lib -Wl,-rpath,/srv/public/kliem/sage/local/lib -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.7/build/cythonized/sage/libs/pynac/constant.o -lflint -lgmp -lginac -o build/lib.linux-x86_64-3.7/sage/libs/pynac/constant.cpython-37m-x86_64-linux-gnu.so -L/srv/public/kliem/sage/local/lib -lfactory -lntl -lgmp -lomalloc -lsingular_resources
[sagelib-9.3.beta7] /usr/bin/ld: cannot find -lginac
[sagelib-9.3.beta7] collect2: error: ld returned 1 exit status
[sagelib-9.3.beta7] g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-rpath-link,/srv/public/kliem/sage/local/lib -L/srv/public/kliem/sage/local/lib -Wl,-rpath,/srv/public/kliem/sage/local/lib -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.7/build/cythonized/sage/symbolic/ring.o -lflint -lgmp -lginac -o build/lib.linux-x86_64-3.7/sage/symbolic/ring.cpython-37m-x86_64-linux-gnu.so -L/srv/public/kliem/sage/local/lib -lfactory -lntl -lgmp -lomalloc -lsingular_resources
[sagelib-9.3.beta7] /usr/bin/ld: cannot find -lginac
[sagelib-9.3.beta7] collect2: error: ld returned 1 exit status
[sagelib-9.3.beta7] g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-rpath-link,/srv/public/kliem/sage/local/lib -L/srv/public/kliem/sage/local/lib -Wl,-rpath,/srv/public/kliem/sage/local/lib -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.7/build/cythonized/sage/symbolic/function.o -lflint -lgmp -lginac -o build/lib.linux-x86_64-3.7/sage/symbolic/function.cpython-37m-x86_64-linux-gnu.so -L/srv/public/kliem/sage/local/lib -lfactory -lntl -lgmp -lomalloc -lsingular_resources
[sagelib-9.3.beta7] /usr/bin/ld: cannot find -lginac
[sagelib-9.3.beta7] collect2: error: ld returned 1 exit status
[sagelib-9.3.beta7] g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-rpath-link,/srv/public/kliem/sage/local/lib -L/srv/public/kliem/sage/local/lib -Wl,-rpath,/srv/public/kliem/sage/local/lib -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.7/build/cythonized/sage/libs/pynac/pynac.o -L/srv/public/kliem/sage/local/lib -lgsl -lflint -lgmp -lm -lopenblas -lginac -o build/lib.linux-x86_64-3.7/sage/libs/pynac/pynac.cpython-37m-x86_64-linux-gnu.so -L/srv/public/kliem/sage/local/lib -lfactory -lntl -lgmp -lomalloc -lsingular_resources
[sagelib-9.3.beta7] /usr/bin/ld: cannot find -lginac
[sagelib-9.3.beta7] collect2: error: ld returned 1 exit status
[sagelib-9.3.beta7] g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-rpath-link,/srv/public/kliem/sage/local/lib -L/srv/public/kliem/sage/local/lib -Wl,-rpath,/srv/public/kliem/sage/local/lib -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.7/build/cythonized/sage/symbolic/expression.o -lflint -lgmp -lginac -o build/lib.linux-x86_64-3.7/sage/symbolic/expression.cpython-37m-x86_64-linux-gnu.so -L/srv/public/kliem/sage/local/lib -lfactory -lntl -lgmp -lomalloc -lsingular_resources -lpari
[sagelib-9.3.beta7] /usr/bin/ld: cannot find -lginac
[sagelib-9.3.beta7] collect2: error: ld returned 1 exit status
[sagelib-9.3.beta7] error: command 'g++' failed with exit status 1
```

But I think, this might be easier to resolve.



---

archive/issue_comments_486844.json:
```json
{
    "body": "<div id=\"comment:60\" align=\"right\">comment:60</div>\n\nThis can't be the right fix. The .cpp files should not be installed.",
    "created_at": "2021-03-02T18:26:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486844",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:60" align="right">comment:60</div>

This can't be the right fix. The .cpp files should not be installed.



---

archive/issue_comments_486845.json:
```json
{
    "body": "<div id=\"comment:61\" align=\"right\">comment:61</div>\n\nWhere's that `-lginac` coming from??",
    "created_at": "2021-03-02T18:30:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486845",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:61" align="right">comment:61</div>

Where's that `-lginac` coming from??



---

archive/issue_comments_486846.json:
```json
{
    "body": "<div id=\"comment:62\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b4da02f2732e16a646c097c67c06c80686ba391f\"><code>b4da02f</code></a></td><td><code>cimport directly from ginac.pynac</code></td></tr></table>\n",
    "created_at": "2021-03-02T18:32:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486846",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:62"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b4da02f2732e16a646c097c67c06c80686ba391f"><code>b4da02f</code></a></td><td><code>cimport directly from ginac.pynac</code></td></tr></table>




---

archive/issue_comments_486847.json:
```json
{
    "body": "Changed commit from **[`93fe11f`](https://github.com/sagemath/sagetrac-mirror/commit/93fe11f753cff24f7d81f00b91ec393bcbfc1721)** to **[`b4da02f`](https://github.com/sagemath/sagetrac-mirror/commit/b4da02f2732e16a646c097c67c06c80686ba391f)**",
    "created_at": "2021-03-02T18:32:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486847",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`93fe11f`](https://github.com/sagemath/sagetrac-mirror/commit/93fe11f753cff24f7d81f00b91ec393bcbfc1721)** to **[`b4da02f`](https://github.com/sagemath/sagetrac-mirror/commit/b4da02f2732e16a646c097c67c06c80686ba391f)**



---

archive/issue_comments_486848.json:
```json
{
    "body": "<div id=\"comment:63\" align=\"right\">comment:63</div>\n\nSame problem. Same undefined symbol.\n\nReplying to [@sagetrac-git](#comment%3A62):\n> Branch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b4da02f2732e16a646c097c67c06c80686ba391f\"><code>b4da02f</code></a></td><td><code>cimport directly from ginac.pynac</code></td></tr></table>\n",
    "created_at": "2021-03-02T18:43:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486848",
    "user": "https://github.com/kliem"
}
```

<div id="comment:63" align="right">comment:63</div>

Same problem. Same undefined symbol.

Replying to [@sagetrac-git](#comment%3A62):
> Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b4da02f2732e16a646c097c67c06c80686ba391f"><code>b4da02f</code></a></td><td><code>cimport directly from ginac.pynac</code></td></tr></table>




---

archive/issue_comments_486849.json:
```json
{
    "body": "<div id=\"comment:64\" align=\"right\">comment:64</div>\n\nReplying to [@mkoeppe](#comment%3A60):\n> This can't be the right fix. The .cpp files should not be installed.\n\nWhen you cimport you recompile `.pxd` file. And by this it is trying to recompile everything that was included there. If the corresponding `.cpp` files aren't found, there is a problem with that.\n\nIf we don't want to recompile everything, then we should put the `cdef extern from` into `pynac.pyx` and only do the type definitions in `pynax.pxd`.",
    "created_at": "2021-03-02T18:46:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486849",
    "user": "https://github.com/kliem"
}
```

<div id="comment:64" align="right">comment:64</div>

Replying to [@mkoeppe](#comment%3A60):
> This can't be the right fix. The .cpp files should not be installed.

When you cimport you recompile `.pxd` file. And by this it is trying to recompile everything that was included there. If the corresponding `.cpp` files aren't found, there is a problem with that.

If we don't want to recompile everything, then we should put the `cdef extern from` into `pynac.pyx` and only do the type definitions in `pynax.pxd`.



---

archive/issue_comments_486850.json:
```json
{
    "body": "<div id=\"comment:65\" align=\"right\">comment:65</div>\n\nReplying to [@kliem](#comment%3A64):\n> we should put the `cdef extern from` into `pynac.pyx` and only do the type definitions in `pynax.pxd`.\n\nI don't know about this mechanism, but it sounds like what I am looking for. Could you elaborate on this or push a change to the branch?",
    "created_at": "2021-03-02T18:51:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486850",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:65" align="right">comment:65</div>

Replying to [@kliem](#comment%3A64):
> we should put the `cdef extern from` into `pynac.pyx` and only do the type definitions in `pynax.pxd`.

I don't know about this mechanism, but it sounds like what I am looking for. Could you elaborate on this or push a change to the branch?



---

archive/issue_comments_486851.json:
```json
{
    "body": "<div id=\"comment:66\" align=\"right\">comment:66</div>\n\nI'll check, if that fixes things.",
    "created_at": "2021-03-02T18:54:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486851",
    "user": "https://github.com/kliem"
}
```

<div id="comment:66" align="right">comment:66</div>

I'll check, if that fixes things.



---

archive/issue_comments_486852.json:
```json
{
    "body": "<div id=\"comment:67\" align=\"right\">comment:67</div>\n\nI don't know, if that will work. I get many errors and by no means do I know how to fix them.\n\nE.g.\n\n```\n[pynac-0.7.28.p18]   gcc -DNDEBUG -g -fwrapv -O2 -Wall -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 -fPIC -Iginac -I./ginac -I. -I. -I/srv/public/kliem/sage/local/lib/python3.7/site-packages/pip/_vendor/pep517 -I/srv/public/kliem/sage/local -I/usr/lib/python37.zip -I/usr/lib/python3.7 -I/usr/lib/python3.7/lib-dynload -I/srv/public/kliem/sage/local/lib/python3.7/site-packages -I/srv/public/kliem/sage/local/include -I/usr/include/python3.7m -c ginac/pynac.cpp -o build/temp.linux-x86_64-3.7/ginac/pynac.o -std=c++11 -DSING_NDEBUG -DOM_NDEBUG -DSING_NDEBUG -DOM_NDEBUG -I/srv/public/kliem/sage/local/include\n[pynac-0.7.28.p18]   ginac/pynac.cpp:1875:50: error: no declaration matches '__pyx_t_5ginac_5pynac_GFunctionOptVector& GiNaC::function::registered_functions()'\n[pynac-0.7.28.p18]    static __pyx_t_5ginac_5pynac_GFunctionOptVector &GiNaC::function::registered_functions(void); /*proto*/\n[pynac-0.7.28.p18]                                                     ^~~~~\n[pynac-0.7.28.p18]   In file included from ginac/ginac.h:54,\n[pynac-0.7.28.p18]                    from ginac/pynac_wrap.h:13,\n[pynac-0.7.28.p18]                    from ginac/pynac.cpp:786:\n[pynac-0.7.28.p18]   ginac/function.h:409:41: note: candidate is: 'static std::vector<GiNaC::function_options>& GiNaC::function::registered_functions()'\n[pynac-0.7.28.p18]     static std::vector<function_options> & registered_functions();\n[pynac-0.7.28.p18]                                            ^~~~~~~~~~~~~~~~~~~~\n[pynac-0.7.28.p18]   ginac/function.h:340:7: note: 'class GiNaC::function' defined here\n[pynac-0.7.28.p18]    class function : public exprseq\n```\n\nI don't even know if it is possible to import a `cppclass` in the `.pyx` part and to define in in the header then.\n\nThis option is definitely not mentioned here: https://cython.readthedocs.io/en/latest/src/userguide/wrapping_CPlusPlus.html\n\nThe problem with this entire setup is that ginac was never properly compiled and linked as a C++ module. I have the feeling that you are trying to achieve something that cython doesn't want you to do.\n\n- If you have a C++ library you can create a cython header for this and directly expose the cpp classes via that header (e.g. you can create a pip installable GMP header that uses an existing GMP installation).\n- If you have some C++ files and you want to expose them directly by a cython wrapper, but the header of this wrapper will recompile your files and thus every module cimporting from this wrapper needs to be able to recompile this as well.\n- You can create a proper wrapper class of a cpp class. This class can be used by other modules without recompiling the actual cpp class.\n\nThis is what the picture looks like to me.",
    "created_at": "2021-03-03T10:13:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486852",
    "user": "https://github.com/kliem"
}
```

<div id="comment:67" align="right">comment:67</div>

I don't know, if that will work. I get many errors and by no means do I know how to fix them.

E.g.

```
[pynac-0.7.28.p18]   gcc -DNDEBUG -g -fwrapv -O2 -Wall -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 -fPIC -Iginac -I./ginac -I. -I. -I/srv/public/kliem/sage/local/lib/python3.7/site-packages/pip/_vendor/pep517 -I/srv/public/kliem/sage/local -I/usr/lib/python37.zip -I/usr/lib/python3.7 -I/usr/lib/python3.7/lib-dynload -I/srv/public/kliem/sage/local/lib/python3.7/site-packages -I/srv/public/kliem/sage/local/include -I/usr/include/python3.7m -c ginac/pynac.cpp -o build/temp.linux-x86_64-3.7/ginac/pynac.o -std=c++11 -DSING_NDEBUG -DOM_NDEBUG -DSING_NDEBUG -DOM_NDEBUG -I/srv/public/kliem/sage/local/include
[pynac-0.7.28.p18]   ginac/pynac.cpp:1875:50: error: no declaration matches '__pyx_t_5ginac_5pynac_GFunctionOptVector& GiNaC::function::registered_functions()'
[pynac-0.7.28.p18]    static __pyx_t_5ginac_5pynac_GFunctionOptVector &GiNaC::function::registered_functions(void); /*proto*/
[pynac-0.7.28.p18]                                                     ^~~~~
[pynac-0.7.28.p18]   In file included from ginac/ginac.h:54,
[pynac-0.7.28.p18]                    from ginac/pynac_wrap.h:13,
[pynac-0.7.28.p18]                    from ginac/pynac.cpp:786:
[pynac-0.7.28.p18]   ginac/function.h:409:41: note: candidate is: 'static std::vector<GiNaC::function_options>& GiNaC::function::registered_functions()'
[pynac-0.7.28.p18]     static std::vector<function_options> & registered_functions();
[pynac-0.7.28.p18]                                            ^~~~~~~~~~~~~~~~~~~~
[pynac-0.7.28.p18]   ginac/function.h:340:7: note: 'class GiNaC::function' defined here
[pynac-0.7.28.p18]    class function : public exprseq
```

I don't even know if it is possible to import a `cppclass` in the `.pyx` part and to define in in the header then.

This option is definitely not mentioned here: https://cython.readthedocs.io/en/latest/src/userguide/wrapping_CPlusPlus.html

The problem with this entire setup is that ginac was never properly compiled and linked as a C++ module. I have the feeling that you are trying to achieve something that cython doesn't want you to do.

- If you have a C++ library you can create a cython header for this and directly expose the cpp classes via that header (e.g. you can create a pip installable GMP header that uses an existing GMP installation).
- If you have some C++ files and you want to expose them directly by a cython wrapper, but the header of this wrapper will recompile your files and thus every module cimporting from this wrapper needs to be able to recompile this as well.
- You can create a proper wrapper class of a cpp class. This class can be used by other modules without recompiling the actual cpp class.

This is what the picture looks like to me.



---

archive/issue_comments_486853.json:
```json
{
    "body": "<div id=\"comment:68\" align=\"right\">comment:68</div>\n\nI digged into a bit. Not that I know a solution now, but at least I understand somehow what is going on.\n\nThe question is really what we want. `cdef extern from` in a `.pxd`-file assumes that every file cimporting this is linked against the same library or has access to the same sources. I don't think we can change this. So the way this is we must either compile ginac as a library and link against it or ship the sources (the later being really awful, because we have plenty of duplications and it takes forever to compile).\n\nYou can use `cdef extern` in the `pyx` however and expose the definitions in the header. This seems a very clean way of doing it, but there are tons of obstructions along the way. E.g. the functions must be declared static: https://cython.readthedocs.io/en/latest/src/userguide/external_C_code.html#implementing-functions-in-c",
    "created_at": "2021-07-01T07:52:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486853",
    "user": "https://github.com/kliem"
}
```

<div id="comment:68" align="right">comment:68</div>

I digged into a bit. Not that I know a solution now, but at least I understand somehow what is going on.

The question is really what we want. `cdef extern from` in a `.pxd`-file assumes that every file cimporting this is linked against the same library or has access to the same sources. I don't think we can change this. So the way this is we must either compile ginac as a library and link against it or ship the sources (the later being really awful, because we have plenty of duplications and it takes forever to compile).

You can use `cdef extern` in the `pyx` however and expose the definitions in the header. This seems a very clean way of doing it, but there are tons of obstructions along the way. E.g. the functions must be declared static: https://cython.readthedocs.io/en/latest/src/userguide/external_C_code.html#implementing-functions-in-c



---

archive/issue_comments_486854.json:
```json
{
    "body": "<div id=\"comment:69\" align=\"right\">comment:69</div>\n\nAnd apparently with a cppclass it works even in the header? (Different project, but there it seemed to work.)\n\nI'm confused. I will see, if I can find out, what is causing the problem.",
    "created_at": "2021-07-01T07:57:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486854",
    "user": "https://github.com/kliem"
}
```

<div id="comment:69" align="right">comment:69</div>

And apparently with a cppclass it works even in the header? (Different project, but there it seemed to work.)

I'm confused. I will see, if I can find out, what is causing the problem.



---

archive/issue_comments_486855.json:
```json
{
    "body": "<div id=\"comment:70\" align=\"right\">comment:70</div>\n\nThanks for looking into this!",
    "created_at": "2021-07-01T16:29:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486855",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:70" align="right">comment:70</div>

Thanks for looking into this!



---

archive/issue_events_417826.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:16:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30534#event-417826"
}
```



---

archive/issue_events_417827.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-07-19T01:16:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30534#event-417827"
}
```



---

archive/issue_events_417828.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-16T17:27:55Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "milestone_number": null,
    "milestone_title": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30534#event-417828"
}
```



---

archive/issue_comments_486856.json:
```json
{
    "body": "Changed author from **Matthias Koeppe, ...** to none",
    "created_at": "2021-08-16T17:27:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486856",
    "user": "https://github.com/mkoeppe"
}
```

Changed author from **Matthias Koeppe, ...** to none



---

archive/issue_comments_486857.json:
```json
{
    "body": "<div id=\"comment:72\" align=\"right\">comment:72</div>\n\nNew approach: #32386 (Merge pynac as src/sage/symbolics/ginac)",
    "created_at": "2021-08-16T17:27:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486857",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:72" align="right">comment:72</div>

New approach: #32386 (Merge pynac as src/sage/symbolics/ginac)



---

archive/issue_events_417829.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-16T20:11:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30534#event-417829"
}
```



---

archive/issue_events_417830.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2021-08-16T21:04:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30534#event-417830"
}
```



---

archive/issue_events_417831.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2021-08-16T21:04:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30534#event-417831"
}
```



---

archive/issue_comments_486858.json:
```json
{
    "body": "Reviewer: **Fran\u00e7ois Bissey**",
    "created_at": "2021-08-16T21:04:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486858",
    "user": "https://github.com/kiwifb"
}
```

Reviewer: **François Bissey**



---

archive/issue_comments_486859.json:
```json
{
    "body": "<div id=\"comment:74\" align=\"right\">comment:74</div>\n\nSure, let's try the other way.",
    "created_at": "2021-08-16T21:04:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486859",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:74" align="right">comment:74</div>

Sure, let's try the other way.



---

archive/issue_events_417832.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-26T02:08:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30534#event-417832"
}
```



---

archive/issue_events_417833.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-26T02:08:43Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30534#event-417833"
}
```



---

archive/issue_comments_486860.json:
```json
{
    "body": "<div id=\"comment:76\" align=\"right\">comment:76</div>\n\nRemoving the branch to avoid confusion in the future.",
    "created_at": "2021-08-27T16:09:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486860",
    "user": "https://github.com/kliem"
}
```

<div id="comment:76" align="right">comment:76</div>

Removing the branch to avoid confusion in the future.



---

archive/issue_comments_486861.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/repackage_pynac_as_a_pip_installable_package](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/repackage_pynac_as_a_pip_installable_package)** to none",
    "created_at": "2021-08-27T16:09:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486861",
    "user": "https://github.com/kliem"
}
```

Changed branch from **[u/mkoeppe/repackage_pynac_as_a_pip_installable_package](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/repackage_pynac_as_a_pip_installable_package)** to none



---

archive/issue_comments_486862.json:
```json
{
    "body": "Changed commit from **[`b4da02f`](https://github.com/sagemath/sagetrac-mirror/commit/b4da02f2732e16a646c097c67c06c80686ba391f)** to none",
    "created_at": "2021-08-27T16:09:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30534",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30534#issuecomment-486862",
    "user": "https://github.com/kliem"
}
```

Changed commit from **[`b4da02f`](https://github.com/sagemath/sagetrac-mirror/commit/b4da02f2732e16a646c097c67c06c80686ba391f)** to none
