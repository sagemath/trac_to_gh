# Issue 30940: src/bin/sage-list-packages: Make it work if SAGE_ROOT is not available

archive/issues_030703.json:
```json
{
    "body": "CC:  @videlec @tobiasdiez @seblabbe @tobihan @jhpalmieri @fchapoton @kliem @slel\n\nKeywords: sd111\n\nIn this case we can still retrieve the installed versions from the installation records `$SAGE_LOCAL/var/lib/sage/installed` (in the case of the sage distribution), but we will not be able to provide all details such as `remote_version`.\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/30940\n\n",
    "closed_at": "2021-01-03T12:15:46Z",
    "created_at": "2020-11-21T01:08:57Z",
    "labels": [
        "component: build",
        "critical"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "src/bin/sage-list-packages: Make it work if SAGE_ROOT is not available",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30940",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @videlec @tobiasdiez @seblabbe @tobihan @jhpalmieri @fchapoton @kliem @slel

Keywords: sd111

In this case we can still retrieve the installed versions from the installation records `$SAGE_LOCAL/var/lib/sage/installed` (in the case of the sage distribution), but we will not be able to provide all details such as `remote_version`.



Issue created by migration from https://trac.sagemath.org/ticket/30940





---

archive/issue_comments_438428.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-11-21T01:12:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438428",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_438429.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-11-21T01:14:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438429",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_438430.json:
```json
{
    "body": "I think the previous code was easier to understand: if SAGE_PKGS is None, we don't need to go through the following for loop. But now one has to understand that the iteration is over an empty list. Better to exit the method early. \n\n```\n-    if not SAGE_PKGS:\n-        return {}\n-\n-    try:\n-        lp = os.listdir(SAGE_PKGS)\n-    except FileNotFoundError:\n-        return {}\n+    if SAGE_PKGS:\n+        try:\n+            lp = os.listdir(SAGE_PKGS)\n+        except FileNotFoundError:\n+            pass\n     for ...\n```\n\nMoreover, I was wondering if the name normalization is ok as it changes the output of a public facing method and thus might break user scripts.\n\nOtherwise it looks good to me.",
    "created_at": "2020-12-05T19:17:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438430",
    "user": "https://github.com/tobiasdiez"
}
```

I think the previous code was easier to understand: if SAGE_PKGS is None, we don't need to go through the following for loop. But now one has to understand that the iteration is over an empty list. Better to exit the method early. 

```
-    if not SAGE_PKGS:
-        return {}
-
-    try:
-        lp = os.listdir(SAGE_PKGS)
-    except FileNotFoundError:
-        return {}
+    if SAGE_PKGS:
+        try:
+            lp = os.listdir(SAGE_PKGS)
+        except FileNotFoundError:
+            pass
     for ...
```

Moreover, I was wondering if the name normalization is ok as it changes the output of a public facing method and thus might break user scripts.

Otherwise it looks good to me.



---

archive/issue_comments_438431.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-12-05T19:17:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438431",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_438432.json:
```json
{
    "body": "Replying to [comment:6 gh-tobiasdiez]:\n> I was wondering if the name normalization is ok as it changes the output of a public facing method and thus might break user scripts.\n\n\nGood point, I'll make this normalization optional",
    "created_at": "2020-12-05T19:29:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438432",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:6 gh-tobiasdiez]:
> I was wondering if the name normalization is ok as it changes the output of a public facing method and thus might break user scripts.


Good point, I'll make this normalization optional



---

archive/issue_comments_438433.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-06T02:25:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438433",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_438434.json:
```json
{
    "body": "Replying to [comment:6 gh-tobiasdiez]:\n> I think the previous code was easier to understand: if SAGE_PKGS is None, we don't need to go through the following for loop. But now one has to understand that the iteration is over an empty list. Better to exit the method early. \n\n\nThanks, done.",
    "created_at": "2020-12-06T02:26:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438434",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:6 gh-tobiasdiez]:
> I think the previous code was easier to understand: if SAGE_PKGS is None, we don't need to go through the following for loop. But now one has to understand that the iteration is over an empty list. Better to exit the method early. 


Thanks, done.



---

archive/issue_comments_438435.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-12-06T02:26:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438435",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_438436.json:
```json
{
    "body": "Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438436",
    "user": "https://github.com/mkoeppe"
}
```

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111



---

archive/issue_comments_438437.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd111\".",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438437",
    "user": "https://github.com/mkoeppe"
}
```

Changing keywords from "" to "sd111".



---

archive/issue_comments_438438.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-12-06T22:36:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438438",
    "user": "https://github.com/tobiasdiez"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_438439.json:
```json
{
    "body": "Code-wise it looks good to me now, thanks for the update!",
    "created_at": "2020-12-06T22:36:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438439",
    "user": "https://github.com/tobiasdiez"
}
```

Code-wise it looks good to me now, thanks for the update!



---

archive/issue_comments_438440.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2020-12-07T19:12:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438440",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_438441.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2020-12-07T19:12:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438441",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_438442.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-12-07T19:12:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438442",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_438443.json:
```json
{
    "body": "Merged current beta",
    "created_at": "2020-12-07T19:12:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438443",
    "user": "https://github.com/mkoeppe"
}
```

Merged current beta



---

archive/issue_comments_438444.json:
```json
{
    "body": "```\n**********************************************************************\nFile \"src/sage/misc/package.py\", line 384, in sage.misc.package.is_package_installed\nFailed example:\n    for pkg in list_packages(pkg_sources=('pip'), local=True):  # optional - build\n        assert not is_package_installed(pkg), \"pip package is installed: {}\".format(pkg)\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage/doctest/forker.py\", line 714, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage/doctest/forker.py\", line 1133, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.misc.package.is_package_installed[3]>\", line 2, in <module>\n        assert not is_package_installed(pkg), \"pip package is installed: {}\".format(pkg)\n    AssertionError: pip package is installed: zope_interface\n**********************************************************************\nFile \"src/sage/misc/package.py\", line 454, in sage.misc.package.standard_packages\nFailed example:\n    installed[0], installed[-1]  # optional - build\nExpected:\n    ('alabaster', 'zn_poly')\nGot:\n    ('alabaster', 'zope_interface')\n**********************************************************************\n```",
    "created_at": "2020-12-14T06:08:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438444",
    "user": "https://github.com/vbraun"
}
```

```
**********************************************************************
File "src/sage/misc/package.py", line 384, in sage.misc.package.is_package_installed
Failed example:
    for pkg in list_packages(pkg_sources=('pip'), local=True):  # optional - build
        assert not is_package_installed(pkg), "pip package is installed: {}".format(pkg)
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 714, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage/doctest/forker.py", line 1133, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.package.is_package_installed[3]>", line 2, in <module>
        assert not is_package_installed(pkg), "pip package is installed: {}".format(pkg)
    AssertionError: pip package is installed: zope_interface
**********************************************************************
File "src/sage/misc/package.py", line 454, in sage.misc.package.standard_packages
Failed example:
    installed[0], installed[-1]  # optional - build
Expected:
    ('alabaster', 'zn_poly')
Got:
    ('alabaster', 'zope_interface')
**********************************************************************
```



---

archive/issue_comments_438445.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-12-14T06:08:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438445",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_438446.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-14T17:36:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438446",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_438447.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-12-14T17:36:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438447",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_438448.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-16T23:49:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438448",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_438449.json:
```json
{
    "body": "Let's please get this ticket in.",
    "created_at": "2020-12-20T20:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438449",
    "user": "https://github.com/mkoeppe"
}
```

Let's please get this ticket in.



---

archive/issue_comments_438450.json:
```json
{
    "body": "I would expect an empty line before and after\n\n```\n        def normalize(name):\n            if normalization is None:\n                return name\n            elif normalization == 'spkg':\n                return name.lower().replace('-', '_').replace('.', '_')\n            else:\n                raise NotImplementedError(f'normalization {normalization} is not implemented')\n```",
    "created_at": "2020-12-28T09:02:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438450",
    "user": "https://github.com/kliem"
}
```

I would expect an empty line before and after

```
        def normalize(name):
            if normalization is None:
                return name
            elif normalization == 'spkg':
                return name.lower().replace('-', '_').replace('.', '_')
            else:
                raise NotImplementedError(f'normalization {normalization} is not implemented')
```



---

archive/issue_comments_438451.json:
```json
{
    "body": "Why do we do it as a string here?\n\n```\npkg['remote_version'] = 'none'\n```",
    "created_at": "2020-12-28T10:07:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438451",
    "user": "https://github.com/kliem"
}
```

Why do we do it as a string here?

```
pkg['remote_version'] = 'none'
```



---

archive/issue_comments_438452.json:
```json
{
    "body": "Replying to [comment:26 gh-kliem]:\n> Why do we do it as a string here?\n> \n> ```\n> pkg['remote_version'] = 'none'\n> ```\n\nThis matches what `m4/sage_spkg_collect.m4` reports as the version of a package without `package-version.txt`",
    "created_at": "2020-12-29T00:06:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438452",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:26 gh-kliem]:
> Why do we do it as a string here?
> 
> ```
> pkg['remote_version'] = 'none'
> ```

This matches what `m4/sage_spkg_collect.m4` reports as the version of a package without `package-version.txt`



---

archive/issue_comments_438453.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-29T00:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438453",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_438454.json:
```json
{
    "body": "Changing priority from minor to critical.",
    "created_at": "2020-12-29T00:13:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438454",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from minor to critical.



---

archive/issue_comments_438455.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-12-29T08:45:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438455",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_438456.json:
```json
{
    "body": "LGTM.",
    "created_at": "2020-12-29T08:45:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438456",
    "user": "https://github.com/kliem"
}
```

LGTM.



---

archive/issue_comments_438457.json:
```json
{
    "body": "Thanks!",
    "created_at": "2020-12-29T18:21:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438457",
    "user": "https://github.com/mkoeppe"
}
```

Thanks!



---

archive/issue_events_080803.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-01-03T12:15:46Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30940#event-80803"
}
```



---

archive/issue_comments_438458.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-01-03T12:15:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30940",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30940#issuecomment-438458",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
