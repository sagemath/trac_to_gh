# Issue 30855: Refactor environment config variables to path

archive/issues_030618.json:
```json
{
    "assignees": [],
    "body": "Currently, `sage.env` contains a huge list of variables that can be set via env vars or `sage_conf`. These are simple string variables. However, in most cases these variables actually have a different type, e.g. they point to files or are booleans. This ticket proposes to convert these stringl variables into the proper class (e.g. `Path` or `bool`).\n\nSince now all paths in `sage.env` are `pathlib.Path`s, some other files had to be changed since they still assumed to be str. I tried to make the changes as minimal as possible, leaving a deeper refactoring to follow-up tickets.\n\nCC:  @mkoeppe\n\nBranch/Commit: **[public/refactoring/envVars](https://github.com/sagemath/sagetrac-mirror/tree/public/refactoring/envVars) @ [7a32e55](https://github.com/sagemath/sagetrac-mirror/commit/7a32e5567dfe452d5b08409b5d71c9a859d5363b)**\n\nReviewer: **Matthias Koeppe**\n\nComponent: **interfaces: optional**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/30855_\n\n",
    "closed_at": "2021-08-26T02:08:43Z",
    "created_at": "2020-11-03T10:40:26Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20interfaces%3A%20optional",
        "https://github.com/sagemath/sage/labels/enhancement",
        "https://github.com/sagemath/sage/labels/invalid"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Refactor environment config variables to path",
    "type": "issue",
    "updated_at": "2021-08-26T02:08:43Z",
    "url": "https://github.com/sagemath/sage/issues/30855",
    "user": "https://github.com/tobiasdiez"
}
```
Currently, `sage.env` contains a huge list of variables that can be set via env vars or `sage_conf`. These are simple string variables. However, in most cases these variables actually have a different type, e.g. they point to files or are booleans. This ticket proposes to convert these stringl variables into the proper class (e.g. `Path` or `bool`).

Since now all paths in `sage.env` are `pathlib.Path`s, some other files had to be changed since they still assumed to be str. I tried to make the changes as minimal as possible, leaving a deeper refactoring to follow-up tickets.

CC:  @mkoeppe

Branch/Commit: **[public/refactoring/envVars](https://github.com/sagemath/sagetrac-mirror/tree/public/refactoring/envVars) @ [7a32e55](https://github.com/sagemath/sagetrac-mirror/commit/7a32e5567dfe452d5b08409b5d71c9a859d5363b)**

Reviewer: **Matthias Koeppe**

Component: **interfaces: optional**

_Issue created by migration from https://trac.sagemath.org/ticket/30855_





---

archive/issue_events_425597.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-11-03T10:40:26Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425597"
}
```



---

archive/issue_events_425598.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-11-03T10:40:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "label": "https://github.com/sagemath/sage/labels/refactoring",
    "label_color": "696969",
    "label_name": "refactoring",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425598"
}
```



---

archive/issue_events_425599.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-11-03T10:40:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425599"
}
```



---

archive/issue_events_425600.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-11-03T10:40:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425600"
}
```



---

archive/issue_events_425601.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2020-11-03T10:42:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425601"
}
```



---

archive/issue_comments_494163.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nNote that in `sage.features` we have a rather similar approach to configuration. Can't redo this again in `sage.env`",
    "created_at": "2020-11-03T15:49:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494163",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:2" align="right">comment:2</div>

Note that in `sage.features` we have a rather similar approach to configuration. Can't redo this again in `sage.env`



---

archive/issue_comments_494164.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThanks for the pointer to `sage.features`.\nIt seems that `sage.features.databases` is the closest to the refactoring done in this ticket. However, even there `sage.env.CREMONA_MINI_DATA_DIR` is used. I don't see any disadvantages of replacing this string variable with a method returning a `Path` object. In particular, there is no code duplication (although the code in `features.databases` can then easily be streamlined using the pathlib library).\n\nOr are you proposing to replace/encapsulate all variables in `sage.env` in separate features?",
    "created_at": "2020-11-03T16:35:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494164",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:3" align="right">comment:3</div>

Thanks for the pointer to `sage.features`.
It seems that `sage.features.databases` is the closest to the refactoring done in this ticket. However, even there `sage.env.CREMONA_MINI_DATA_DIR` is used. I don't see any disadvantages of replacing this string variable with a method returning a `Path` object. In particular, there is no code duplication (although the code in `features.databases` can then easily be streamlined using the pathlib library).

Or are you proposing to replace/encapsulate all variables in `sage.env` in separate features?



---

archive/issue_comments_494165.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@tobiasdiez](#comment:3):\n> Thanks for the pointer to `sage.features`.\n> It seems that `sage.features.databases` is the closest to the refactoring done in this ticket. However, even there `sage.env.CREMONA_MINI_DATA_DIR` is used. \n\nYes, `sage.features.databases` provides an abstraction on top of `sage.env`.\n\nI would not consider it an improvement to put another, intermediate abstraction inside `sage.env`.",
    "created_at": "2020-11-03T16:55:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494165",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@tobiasdiez](#comment:3):
> Thanks for the pointer to `sage.features`.
> It seems that `sage.features.databases` is the closest to the refactoring done in this ticket. However, even there `sage.env.CREMONA_MINI_DATA_DIR` is used. 

Yes, `sage.features.databases` provides an abstraction on top of `sage.env`.

I would not consider it an improvement to put another, intermediate abstraction inside `sage.env`.



---

archive/issue_comments_494166.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@tobiasdiez](#comment:3):\n> are you proposing to replace/encapsulate all variables in `sage.env` in separate features?\n\nWell, encapsulating these variables is the direction in which the code added to `sage.features` has been going.",
    "created_at": "2020-11-03T16:58:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494166",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@tobiasdiez](#comment:3):
> are you proposing to replace/encapsulate all variables in `sage.env` in separate features?

Well, encapsulating these variables is the direction in which the code added to `sage.features` has been going.



---

archive/issue_comments_494167.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@mkoeppe](#comment:4):\n> I would not consider it an improvement to put another, intermediate abstraction inside `sage.env`. \n> \n\nI think you misunderstood my intention a bit. I didn't add another layer of abstraction, I just changed the interface to the same information. Instead of yielding a string path, it returns now a proper `Path` object. I can also readd the variable `ELLCURVE_DATA_DIR` having type `Path` if you prefer that instead of the getter-method. I just thought that since there is a disk access involved, it might speedup initiation a bit to encapsulate everything in a method. That can easily changed, of course.\n\n\n> Well, encapsulating these variables is the direction in which the code added to `sage.features` has been going. \n> \n\nok, but adding such an abstraction for the ellCurve data directory can be done later (and wasn't my intention).",
    "created_at": "2020-11-03T17:58:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494167",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@mkoeppe](#comment:4):
> I would not consider it an improvement to put another, intermediate abstraction inside `sage.env`. 
> 

I think you misunderstood my intention a bit. I didn't add another layer of abstraction, I just changed the interface to the same information. Instead of yielding a string path, it returns now a proper `Path` object. I can also readd the variable `ELLCURVE_DATA_DIR` having type `Path` if you prefer that instead of the getter-method. I just thought that since there is a disk access involved, it might speedup initiation a bit to encapsulate everything in a method. That can easily changed, of course.


> Well, encapsulating these variables is the direction in which the code added to `sage.features` has been going. 
> 

ok, but adding such an abstraction for the ellCurve data directory can be done later (and wasn't my intention).



---

archive/issue_comments_494168.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nThe patch is adding file system inspection to `sage.env` - this makes things less uniform.  The other database features are doing this in `sage.features` via `StaticFile`.",
    "created_at": "2020-11-03T18:21:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494168",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:7" align="right">comment:7</div>

The patch is adding file system inspection to `sage.env` - this makes things less uniform.  The other database features are doing this in `sage.features` via `StaticFile`.



---

archive/issue_comments_494169.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nI agree, it's less uniform because of the special handling of paths.\n\nTo make things clear, can we agree that the following is the desired behavior for paths like the ellCurve data directory?\n1. If user sets the path via an env variable, and the path exists, take it.\n2. If not, but `sage.conf` sets a path that exists, take it.\n3. Else, fall back to hard-coded folder relative to `SAGE_SHARE`.\n\nI see the following two approaches:\nOption a) is to have all this logic in `sage.env` (maybe with a light wrapper in `sage.features`) and Option b) is to expose the steps 1 and 2 as methods `get_env_variable` and `get_sage_conf_variable` in `sage.env` and put the file check logic in `sage.features`. I have a light preference for Option a) as this would require the least amount of changes but Option b) also sounds fine with me. Which option do you prefer?",
    "created_at": "2020-11-03T19:22:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494169",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:8" align="right">comment:8</div>

I agree, it's less uniform because of the special handling of paths.

To make things clear, can we agree that the following is the desired behavior for paths like the ellCurve data directory?
1. If user sets the path via an env variable, and the path exists, take it.
2. If not, but `sage.conf` sets a path that exists, take it.
3. Else, fall back to hard-coded folder relative to `SAGE_SHARE`.

I see the following two approaches:
Option a) is to have all this logic in `sage.env` (maybe with a light wrapper in `sage.features`) and Option b) is to expose the steps 1 and 2 as methods `get_env_variable` and `get_sage_conf_variable` in `sage.env` and put the file check logic in `sage.features`. I have a light preference for Option a) as this would require the least amount of changes but Option b) also sounds fine with me. Which option do you prefer?



---

archive/issue_comments_494170.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@tobiasdiez](#comment:8):\n> To make things clear, can we agree that the following is the desired behavior for paths like the ellCurve data directory?\n> 1. If user sets the path via an env variable, and the path exists, take it.\n> 2. If not, but `sage.conf` sets a path that exists, take it.\n> 3. Else, fall back to hard-coded folder relative to `SAGE_SHARE`.\n\nThat's different and more complex than the current behavior. Do you need this? Then please clarify the ticket description - it's not just refactoring.",
    "created_at": "2020-11-03T19:29:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494170",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@tobiasdiez](#comment:8):
> To make things clear, can we agree that the following is the desired behavior for paths like the ellCurve data directory?
> 1. If user sets the path via an env variable, and the path exists, take it.
> 2. If not, but `sage.conf` sets a path that exists, take it.
> 3. Else, fall back to hard-coded folder relative to `SAGE_SHARE`.

That's different and more complex than the current behavior. Do you need this? Then please clarify the ticket description - it's not just refactoring.



---

archive/issue_comments_494171.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nI don't really need this, but thought it might be helpful / desired. If you don't think it's needed, then I can easily remove this extra logic again.",
    "created_at": "2020-11-03T19:34:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494171",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:10" align="right">comment:10</div>

I don't really need this, but thought it might be helpful / desired. If you don't think it's needed, then I can easily remove this extra logic again.



---

archive/issue_comments_494172.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nOn a second thought, I actually need something like this in #30371. Not so much for paths but for package names. In fact the package name check implemented in #30706 has pretty much the same spirit as this the refactoring done in this ticket.",
    "created_at": "2020-11-03T20:12:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494172",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:11" align="right">comment:11</div>

On a second thought, I actually need something like this in #30371. Not so much for paths but for package names. In fact the package name check implemented in #30706 has pretty much the same spirit as this the refactoring done in this ticket.



---

archive/issue_comments_494173.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nIf you need a new behavior for configuration of \"package names\" (not sure what you mean by that), please open a ticket for it. In general, I recommend to keep tickets that implement new features or change behavior separate from tickets that refactor existing code.",
    "created_at": "2020-11-03T23:14:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494173",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:12" align="right">comment:12</div>

If you need a new behavior for configuration of "package names" (not sure what you mean by that), please open a ticket for it. In general, I recommend to keep tickets that implement new features or change behavior separate from tickets that refactor existing code.



---

archive/issue_comments_494174.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nWhat I meant was that in #30706 the added method `get_cblas_pc_module_name` has the same structure as `get_ellcurve_data_dir`: it checks the env variables and the `sage.conf` information for the first existing option (using `pkgconfig`).\n\nAnyway, is the filepath handling described above in [#30855 comment:8](https://github.com/sagemath/sage/issues/30855#comment:8) desired or not? I don't really the need this additional logic, but it was easy to implement so I went for it while refactoring. I can easily revert it, just please let me know.",
    "created_at": "2020-11-04T08:30:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494174",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:13" align="right">comment:13</div>

What I meant was that in #30706 the added method `get_cblas_pc_module_name` has the same structure as `get_ellcurve_data_dir`: it checks the env variables and the `sage.conf` information for the first existing option (using `pkgconfig`).

Anyway, is the filepath handling described above in [#30855 comment:8](https://github.com/sagemath/sage/issues/30855#comment:8) desired or not? I don't really the need this additional logic, but it was easy to implement so I went for it while refactoring. I can easily revert it, just please let me know.



---

archive/issue_events_425602.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-11-04T21:53:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425602"
}
```



---

archive/issue_events_425603.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-11-04T21:53:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "label": "https://github.com/sagemath/sage/labels/p%3A%204%20%E2%80%93%20minor",
    "label_color": "ffe799",
    "label_name": "p: 4 \u2013 minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425603"
}
```



---

archive/issue_comments_494175.json:
```json
{
    "body": "<div id=\"comment:15\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5be342e4ee1a820c10fda38026a97f6b83770784\">5be342e</a></td><td><code>Merge branch 'develop' of git://github.com/sagemath/sage into public/refactoring/envVars</code></td></tr></table>\n",
    "created_at": "2021-01-25T11:48:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494175",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:15"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5be342e4ee1a820c10fda38026a97f6b83770784">5be342e</a></td><td><code>Merge branch 'develop' of git://github.com/sagemath/sage into public/refactoring/envVars</code></td></tr></table>




---

archive/issue_comments_494176.json:
```json
{
    "body": "Changed commit from **[eef3168](https://github.com/sagemath/sagetrac-mirror/commit/eef3168e137e6bd9b2715ec0ea3c51ed56a7588f)** to **[5be342e](https://github.com/sagemath/sagetrac-mirror/commit/5be342e4ee1a820c10fda38026a97f6b83770784)**",
    "created_at": "2021-01-25T11:48:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494176",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[eef3168](https://github.com/sagemath/sagetrac-mirror/commit/eef3168e137e6bd9b2715ec0ea3c51ed56a7588f)** to **[5be342e](https://github.com/sagemath/sagetrac-mirror/commit/5be342e4ee1a820c10fda38026a97f6b83770784)**



---

archive/issue_events_425604.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2021-01-25T12:53:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "label": "https://github.com/sagemath/sage/labels/p%3A%204%20%E2%80%93%20minor",
    "label_color": "ffe799",
    "label_name": "p: 4 \u2013 minor",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425604"
}
```



---

archive/issue_events_425605.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2021-01-25T12:53:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425605"
}
```



---

archive/issue_events_425606.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2021-01-25T12:53:12Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "milestone_number": null,
    "milestone_title": "sage-9.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425606"
}
```



---

archive/issue_events_425607.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2021-01-25T12:53:12Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425607"
}
```



---

archive/issue_events_425608.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2021-01-25T12:53:12Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "title_is": "Refactor environment config variables to path",
    "title_was": "Refactor environment config variables",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425608"
}
```



---

archive/issue_comments_494177.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,9 @@\n Currently, `sage.env` contains a huge list of variables that can be set via env vars or `sage_conf`. These are simple string variables. However, in most cases these variables actually have a different type, e.g. they point to files or are booleans. This ticket proposes to wrap these variables with simple getter methods that convert the string into the proper class (e.g. `Path` or `bool`) and do a bit of after-processing (e.g. check that the path exist).\n \n-This idea is illustrated at the example of the `ellCurve` data directory. Refactoring the other config variables will be done in follow-up tickets.\n+This makes it possible to make the variable resolution more robust. In particular the new behavior for paths checks also if the specified path is pointing to a valid and existing path:\n+\n+- If user sets the path via an env variable, and the path exists, take it.\n+- If not, but sage.conf sets a path that exists, take it.\n+- Else, fall back to hard-coded folder.\n+\n+Since now all paths in `sage.env` are `pathlib.Path`s, some other files had to be changed since they still assumed to be str. I tried to make the changes as minimal as possible, leaving a deeper refactoring to follow-up tickets.\n``````\n",
    "created_at": "2021-01-25T12:53:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494177",
    "user": "https://github.com/tobiasdiez"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,9 @@
 Currently, `sage.env` contains a huge list of variables that can be set via env vars or `sage_conf`. These are simple string variables. However, in most cases these variables actually have a different type, e.g. they point to files or are booleans. This ticket proposes to wrap these variables with simple getter methods that convert the string into the proper class (e.g. `Path` or `bool`) and do a bit of after-processing (e.g. check that the path exist).
 
-This idea is illustrated at the example of the `ellCurve` data directory. Refactoring the other config variables will be done in follow-up tickets.
+This makes it possible to make the variable resolution more robust. In particular the new behavior for paths checks also if the specified path is pointing to a valid and existing path:
+
+- If user sets the path via an env variable, and the path exists, take it.
+- If not, but sage.conf sets a path that exists, take it.
+- Else, fall back to hard-coded folder.
+
+Since now all paths in `sage.env` are `pathlib.Path`s, some other files had to be changed since they still assumed to be str. I tried to make the changes as minimal as possible, leaving a deeper refactoring to follow-up tickets.
``````




---

archive/issue_comments_494178.json:
```json
{
    "body": "Changed commit from **[5be342e](https://github.com/sagemath/sagetrac-mirror/commit/5be342e4ee1a820c10fda38026a97f6b83770784)** to **[265bdd7](https://github.com/sagemath/sagetrac-mirror/commit/265bdd76c85a361cc88118cf7a54a4d7d5cf1f69)**",
    "created_at": "2021-01-25T12:53:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494178",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[5be342e](https://github.com/sagemath/sagetrac-mirror/commit/5be342e4ee1a820c10fda38026a97f6b83770784)** to **[265bdd7](https://github.com/sagemath/sagetrac-mirror/commit/265bdd76c85a361cc88118cf7a54a4d7d5cf1f69)**



---

archive/issue_comments_494179.json:
```json
{
    "body": "<div id=\"comment:17\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/265bdd76c85a361cc88118cf7a54a4d7d5cf1f69\">265bdd7</a></td><td><code>Use paths everywhere</code></td></tr></table>\n",
    "created_at": "2021-01-25T12:53:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494179",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:17"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/265bdd76c85a361cc88118cf7a54a4d7d5cf1f69">265bdd7</a></td><td><code>Use paths everywhere</code></td></tr></table>




---

archive/issue_comments_494180.json:
```json
{
    "body": "<div id=\"comment:18\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/df1cdaf73dec7d4ae8ae1be80163927eb480796e\">df1cdaf</a></td><td><code>Fix elliptic curve database path</code></td></tr></table>\n",
    "created_at": "2021-01-25T13:46:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494180",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:18"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/df1cdaf73dec7d4ae8ae1be80163927eb480796e">df1cdaf</a></td><td><code>Fix elliptic curve database path</code></td></tr></table>




---

archive/issue_comments_494181.json:
```json
{
    "body": "Changed commit from **[265bdd7](https://github.com/sagemath/sagetrac-mirror/commit/265bdd76c85a361cc88118cf7a54a4d7d5cf1f69)** to **[df1cdaf](https://github.com/sagemath/sagetrac-mirror/commit/df1cdaf73dec7d4ae8ae1be80163927eb480796e)**",
    "created_at": "2021-01-25T13:46:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494181",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[265bdd7](https://github.com/sagemath/sagetrac-mirror/commit/265bdd76c85a361cc88118cf7a54a4d7d5cf1f69)** to **[df1cdaf](https://github.com/sagemath/sagetrac-mirror/commit/df1cdaf73dec7d4ae8ae1be80163927eb480796e)**



---

archive/issue_comments_494182.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@tobiasdiez](#comment:13):\n> is the filepath handling described above in [#30855 comment:8](https://github.com/sagemath/sage/issues/30855#comment:8) desired or not? \n\nNo use case motivating this change his been described. So let's please not continue just because the ticket is open.",
    "created_at": "2021-01-25T18:10:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494182",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@tobiasdiez](#comment:13):
> is the filepath handling described above in [#30855 comment:8](https://github.com/sagemath/sage/issues/30855#comment:8) desired or not? 

No use case motivating this change his been described. So let's please not continue just because the ticket is open.



---

archive/issue_events_425609.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-25T18:10:36Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425609"
}
```



---

archive/issue_events_425610.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-25T18:10:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425610"
}
```



---

archive/issue_comments_494183.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nAs I said above, I don't have a strong opinion about what is the correct behavior. I just thought it would be nice if the variables in `sage.env` point to existing paths. Otherwise one has to check every time that the path exists, and the fallbacks are never used in this case.\n\nHowever, if this is not desired, then I can remove this again. It's only removing the exist check here:\n\n```\n+    def converter(value: Optional[str]) -> Optional[Path]:\n+        if value is None:\n+            return None\n+\n+        path = Path(value)\n+        if path.exists():\n+            return path\n+        else:\n+            return None\n```",
    "created_at": "2021-01-25T18:37:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494183",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:20" align="right">comment:20</div>

As I said above, I don't have a strong opinion about what is the correct behavior. I just thought it would be nice if the variables in `sage.env` point to existing paths. Otherwise one has to check every time that the path exists, and the fallbacks are never used in this case.

However, if this is not desired, then I can remove this again. It's only removing the exist check here:

```
+    def converter(value: Optional[str]) -> Optional[Path]:
+        if value is None:
+            return None
+
+        path = Path(value)
+        if path.exists():
+            return path
+        else:
+            return None
```



---

archive/issue_comments_494184.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@tobiasdiez](#comment:20):\n> As I said above, I don't have a strong opinion about what is the correct behavior. I just thought it would be nice if the variables in `sage.env` point to existing paths. \n\nI disagree. Things like this should really be done in `sage.features`.",
    "created_at": "2021-01-25T18:42:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494184",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@tobiasdiez](#comment:20):
> As I said above, I don't have a strong opinion about what is the correct behavior. I just thought it would be nice if the variables in `sage.env` point to existing paths. 

I disagree. Things like this should really be done in `sage.features`.



---

archive/issue_comments_494185.json:
```json
{
    "body": "<div id=\"comment:22\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e7fa1579b6d164c002c402451518a73f0f086fdc\">e7fa157</a></td><td><code>Remove path existence check</code></td></tr></table>\n",
    "created_at": "2021-01-25T20:04:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494185",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:22"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e7fa1579b6d164c002c402451518a73f0f086fdc">e7fa157</a></td><td><code>Remove path existence check</code></td></tr></table>




---

archive/issue_comments_494186.json:
```json
{
    "body": "Changed commit from **[df1cdaf](https://github.com/sagemath/sagetrac-mirror/commit/df1cdaf73dec7d4ae8ae1be80163927eb480796e)** to **[e7fa157](https://github.com/sagemath/sagetrac-mirror/commit/e7fa1579b6d164c002c402451518a73f0f086fdc)**",
    "created_at": "2021-01-25T20:04:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494186",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[df1cdaf](https://github.com/sagemath/sagetrac-mirror/commit/df1cdaf73dec7d4ae8ae1be80163927eb480796e)** to **[e7fa157](https://github.com/sagemath/sagetrac-mirror/commit/e7fa1579b6d164c002c402451518a73f0f086fdc)**



---

archive/issue_comments_494187.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nI have a hard time seeing how `SAGE_LOCAL` is a feature, but I've now removed the existence check. So this is really only a refactoring from string-paths to pathlib-paths.",
    "created_at": "2021-01-25T20:05:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494187",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:23" align="right">comment:23</div>

I have a hard time seeing how `SAGE_LOCAL` is a feature, but I've now removed the existence check. So this is really only a refactoring from string-paths to pathlib-paths.



---

archive/issue_events_425611.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2021-01-25T20:07:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425611"
}
```



---

archive/issue_events_425612.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2021-01-25T20:07:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425612"
}
```



---

archive/issue_comments_494188.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,9 +1,3 @@\n-Currently, `sage.env` contains a huge list of variables that can be set via env vars or `sage_conf`. These are simple string variables. However, in most cases these variables actually have a different type, e.g. they point to files or are booleans. This ticket proposes to wrap these variables with simple getter methods that convert the string into the proper class (e.g. `Path` or `bool`) and do a bit of after-processing (e.g. check that the path exist).\n-\n-This makes it possible to make the variable resolution more robust. In particular the new behavior for paths checks also if the specified path is pointing to a valid and existing path:\n-\n-- If user sets the path via an env variable, and the path exists, take it.\n-- If not, but sage.conf sets a path that exists, take it.\n-- Else, fall back to hard-coded folder.\n+Currently, `sage.env` contains a huge list of variables that can be set via env vars or `sage_conf`. These are simple string variables. However, in most cases these variables actually have a different type, e.g. they point to files or are booleans. This ticket proposes to convert these stringl variables into the proper class (e.g. `Path` or `bool`).\n \n Since now all paths in `sage.env` are `pathlib.Path`s, some other files had to be changed since they still assumed to be str. I tried to make the changes as minimal as possible, leaving a deeper refactoring to follow-up tickets.\n``````\n",
    "created_at": "2021-01-25T20:07:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494188",
    "user": "https://github.com/tobiasdiez"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,9 +1,3 @@
-Currently, `sage.env` contains a huge list of variables that can be set via env vars or `sage_conf`. These are simple string variables. However, in most cases these variables actually have a different type, e.g. they point to files or are booleans. This ticket proposes to wrap these variables with simple getter methods that convert the string into the proper class (e.g. `Path` or `bool`) and do a bit of after-processing (e.g. check that the path exist).
-
-This makes it possible to make the variable resolution more robust. In particular the new behavior for paths checks also if the specified path is pointing to a valid and existing path:
-
-- If user sets the path via an env variable, and the path exists, take it.
-- If not, but sage.conf sets a path that exists, take it.
-- Else, fall back to hard-coded folder.
+Currently, `sage.env` contains a huge list of variables that can be set via env vars or `sage_conf`. These are simple string variables. However, in most cases these variables actually have a different type, e.g. they point to files or are booleans. This ticket proposes to convert these stringl variables into the proper class (e.g. `Path` or `bool`).
 
 Since now all paths in `sage.env` are `pathlib.Path`s, some other files had to be changed since they still assumed to be str. I tried to make the changes as minimal as possible, leaving a deeper refactoring to follow-up tickets.
``````




---

archive/issue_comments_494189.json:
```json
{
    "body": "Changed commit from **[e7fa157](https://github.com/sagemath/sagetrac-mirror/commit/e7fa1579b6d164c002c402451518a73f0f086fdc)** to **[7a32e55](https://github.com/sagemath/sagetrac-mirror/commit/7a32e5567dfe452d5b08409b5d71c9a859d5363b)**",
    "created_at": "2021-01-25T20:10:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494189",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[e7fa157](https://github.com/sagemath/sagetrac-mirror/commit/e7fa1579b6d164c002c402451518a73f0f086fdc)** to **[7a32e55](https://github.com/sagemath/sagetrac-mirror/commit/7a32e5567dfe452d5b08409b5d71c9a859d5363b)**



---

archive/issue_comments_494190.json:
```json
{
    "body": "<div id=\"comment:25\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7a32e5567dfe452d5b08409b5d71c9a859d5363b\">7a32e55</a></td><td><code>Fix doctests as well</code></td></tr></table>\n",
    "created_at": "2021-01-25T20:10:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494190",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:25"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7a32e5567dfe452d5b08409b5d71c9a859d5363b">7a32e55</a></td><td><code>Fix doctests as well</code></td></tr></table>




---

archive/issue_comments_494191.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\n`SAGE_LOCAL` is not a great example - pretty much any use of `SAGE_LOCAL` in `src/sage` needs to be removed anyway.",
    "created_at": "2021-01-25T20:12:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494191",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:26" align="right">comment:26</div>

`SAGE_LOCAL` is not a great example - pretty much any use of `SAGE_LOCAL` in `src/sage` needs to be removed anyway.



---

archive/issue_comments_494192.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nFor example this one here:\n\n```\n--- a/src/sage/interfaces/lie.py\n+++ b/src/sage/interfaces/lie.py\n@@ -331,7 +331,7 @@ class LiE(ExtraTabCompletion, Expect):\n                         prompt = '> ',\n \n                         # This is the command that starts up your program\n-                        command = \"bash \"+ SAGE_LOCAL + \"/bin/lie\",\n+                        command = f\"bash { SAGE_LOCAL / 'bin' / 'lie' }\",\n \n                         server=server,\n                         script_subdirectory = script_subdirectory,\n```\nThis would better be rewritten using an `Executable` feature.",
    "created_at": "2021-01-25T20:18:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494192",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:27" align="right">comment:27</div>

For example this one here:

```
--- a/src/sage/interfaces/lie.py
+++ b/src/sage/interfaces/lie.py
@@ -331,7 +331,7 @@ class LiE(ExtraTabCompletion, Expect):
                         prompt = '> ',
 
                         # This is the command that starts up your program
-                        command = "bash "+ SAGE_LOCAL + "/bin/lie",
+                        command = f"bash { SAGE_LOCAL / 'bin' / 'lie' }",
 
                         server=server,
                         script_subdirectory = script_subdirectory,
```
This would better be rewritten using an `Executable` feature.



---

archive/issue_comments_494193.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nAlso, as changes like this one indicate:\n\n```\n--- a/src/sage/doctest/sources.py\n+++ b/src/sage/doctest/sources.py\n@@ -87,8 +87,8 @@ def get_basename(path):\n     root = os.path.dirname(path)\n     # If the file is in the sage library, we can use our knowledge of\n     # the directory structure\n-    dev = SAGE_SRC\n-    sp = SAGE_LIB\n+    dev = str(SAGE_SRC)\n+    sp = str(SAGE_LIB)\n     if path.startswith(dev):\n         # there will be a branch name\n         i = path.find(os.path.sep, len(dev))\n```\nThe change of the type of the variables is not backwards-compatible (although in some contexts you can use path like a string). So there is a danger of breaking user code.",
    "created_at": "2021-01-25T20:25:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494193",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:28" align="right">comment:28</div>

Also, as changes like this one indicate:

```
--- a/src/sage/doctest/sources.py
+++ b/src/sage/doctest/sources.py
@@ -87,8 +87,8 @@ def get_basename(path):
     root = os.path.dirname(path)
     # If the file is in the sage library, we can use our knowledge of
     # the directory structure
-    dev = SAGE_SRC
-    sp = SAGE_LIB
+    dev = str(SAGE_SRC)
+    sp = str(SAGE_LIB)
     if path.startswith(dev):
         # there will be a branch name
         i = path.find(os.path.sep, len(dev))
```
The change of the type of the variables is not backwards-compatible (although in some contexts you can use path like a string). So there is a danger of breaking user code.



---

archive/issue_comments_494194.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nI agree, that some of the code can be further refactored and e.g. moved to the feature module. However, this only changes the location of code such as `SAGE_LOCAL + \"/bin/lie\"` and thus it is still advantageous to have `SAGE_LOCAL` as path.\n\nWhat do you propose to do about the backward-compatibility? What are sage's conventions concerning breaking changes (especially concerning relatively internal things like sage.env)?",
    "created_at": "2021-01-25T21:01:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494194",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:29" align="right">comment:29</div>

I agree, that some of the code can be further refactored and e.g. moved to the feature module. However, this only changes the location of code such as `SAGE_LOCAL + "/bin/lie"` and thus it is still advantageous to have `SAGE_LOCAL` as path.

What do you propose to do about the backward-compatibility? What are sage's conventions concerning breaking changes (especially concerning relatively internal things like sage.env)?



---

archive/issue_comments_494195.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nIt's really very simple:\nWe have a low-level interface (`sage.env`), we have a high-level interface (`sage.features`). It is not a clear improvement to make the existing low-level interface slightly higher-level. Instead, improve code that uses the low-level interface by using the high-level interface instead.",
    "created_at": "2021-01-25T23:06:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494195",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:30" align="right">comment:30</div>

It's really very simple:
We have a low-level interface (`sage.env`), we have a high-level interface (`sage.features`). It is not a clear improvement to make the existing low-level interface slightly higher-level. Instead, improve code that uses the low-level interface by using the high-level interface instead.



---

archive/issue_comments_494196.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nThere are over 400 usages of these path variables in sage.env (conservative estimate based on searching for `join(SAGE_`). All of these calls profit from the strengthen of the interface to use pathlib. Even if refactoring to sage.features would remove half of them, that's still a huge number of string -> path conversions that have to be repeatedly done in many places. So why not fix this at the origin?",
    "created_at": "2021-01-25T23:41:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494196",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:31" align="right">comment:31</div>

There are over 400 usages of these path variables in sage.env (conservative estimate based on searching for `join(SAGE_`). All of these calls profit from the strengthen of the interface to use pathlib. Even if refactoring to sage.features would remove half of them, that's still a huge number of string -> path conversions that have to be repeatedly done in many places. So why not fix this at the origin?



---

archive/issue_comments_494197.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nReplying to [@tobiasdiez](#comment:29):\n> What are sage's conventions concerning breaking changes \n\nWe use the deprecation mechanism if we have to make incompatible changes.\n\nHard to do use deprecation here - which is another reason why this old interface (`sage.env`) is best left alone.",
    "created_at": "2021-01-26T01:24:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494197",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:32" align="right">comment:32</div>

Replying to [@tobiasdiez](#comment:29):
> What are sage's conventions concerning breaking changes 

We use the deprecation mechanism if we have to make incompatible changes.

Hard to do use deprecation here - which is another reason why this old interface (`sage.env`) is best left alone.



---

archive/issue_comments_494198.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nReplying to [@mkoeppe](#comment:26):\n> `SAGE_LOCAL` is not a great example - pretty much any use of `SAGE_LOCAL` in `src/sage` needs to be removed anyway.\n\nFor reference - #30818",
    "created_at": "2021-01-26T18:44:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494198",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:33" align="right">comment:33</div>

Replying to [@mkoeppe](#comment:26):
> `SAGE_LOCAL` is not a great example - pretty much any use of `SAGE_LOCAL` in `src/sage` needs to be removed anyway.

For reference - #30818



---

archive/issue_comments_494199.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nWhy are you so much against the idea of improving `sage.env`? For me it is sage's interface for configuration (via environment variables or sageconf). So it is natural that many place in sage will access this information. And I don't understand why you don't want to have an universal check for basic consistency (paths specified exist, boolean flags are yes/no etc). Right now these things are checked in various places, leading to code duplication and additional work for maintenance.\n\nFor deprecation, that's possible using a wrapper around `Path` and `str` that prints warning messages if the string-methods are used (similar to https://stackoverflow.com/questions/922550/how-to-mark-a-global-as-deprecated-in-python)",
    "created_at": "2021-01-30T10:38:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494199",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:34" align="right">comment:34</div>

Why are you so much against the idea of improving `sage.env`? For me it is sage's interface for configuration (via environment variables or sageconf). So it is natural that many place in sage will access this information. And I don't understand why you don't want to have an universal check for basic consistency (paths specified exist, boolean flags are yes/no etc). Right now these things are checked in various places, leading to code duplication and additional work for maintenance.

For deprecation, that's possible using a wrapper around `Path` and `str` that prints warning messages if the string-methods are used (similar to https://stackoverflow.com/questions/922550/how-to-mark-a-global-as-deprecated-in-python)



---

archive/issue_comments_494200.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nReplying to [@tobiasdiez](#comment:34):\n> Why are you so much against the idea of improving `sage.env`? For me it is sage's interface for configuration (via environment variables or sageconf). \n\nSee comment 4. \n`sage.env` is a low-level interface - a thin wrapper around os.environ, combining environment variables and `sage_conf` and simple fallbacks. It maps string keys to strings. \n\nAdding complexity there is not an improvement.\n\n`sage.features` was designed to provide a high-level interface to the system environment of sagelib (#20382).\n\nIt already does what it seems you are trying to introduce in `sage.env`: It is typed and it implements filesystem lookups.",
    "created_at": "2021-01-30T16:40:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494200",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:35" align="right">comment:35</div>

Replying to [@tobiasdiez](#comment:34):
> Why are you so much against the idea of improving `sage.env`? For me it is sage's interface for configuration (via environment variables or sageconf). 

See comment 4. 
`sage.env` is a low-level interface - a thin wrapper around os.environ, combining environment variables and `sage_conf` and simple fallbacks. It maps string keys to strings. 

Adding complexity there is not an improvement.

`sage.features` was designed to provide a high-level interface to the system environment of sagelib (#20382).

It already does what it seems you are trying to introduce in `sage.env`: It is typed and it implements filesystem lookups.



---

archive/issue_comments_494201.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nReplying to [@tobiasdiez](#comment:31):\n> There are over 400 usages of these path variables in sage.env (conservative estimate based on searching for `join(SAGE_`). \n\n`git grep 'join(SAGE' src/sage | grep -v 'sage:' ` (ignoring lines that are in doctests!) gives 97 hits, which will need review. That's really just a small remainder of refactoring work that has already been done in the past few years.\n\nFor example, all places using `SAGE_EXTCODE` would be changed by #31306.",
    "created_at": "2021-01-30T18:17:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494201",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:36" align="right">comment:36</div>

Replying to [@tobiasdiez](#comment:31):
> There are over 400 usages of these path variables in sage.env (conservative estimate based on searching for `join(SAGE_`). 

`git grep 'join(SAGE' src/sage | grep -v 'sage:' ` (ignoring lines that are in doctests!) gives 97 hits, which will need review. That's really just a small remainder of refactoring work that has already been done in the past few years.

For example, all places using `SAGE_EXTCODE` would be changed by #31306.



---

archive/issue_comments_494202.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nAnd how are the features supposed to locate files in `SAGE_LOCAL`, `SAGE_VENV`, `SAGE_ETC`, `SAGE_LIB`, `SAGE_SHARE` etc? And why is it not helpful for this if these variables are Paths?",
    "created_at": "2021-01-30T18:28:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494202",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:37" align="right">comment:37</div>

And how are the features supposed to locate files in `SAGE_LOCAL`, `SAGE_VENV`, `SAGE_ETC`, `SAGE_LIB`, `SAGE_SHARE` etc? And why is it not helpful for this if these variables are Paths?



---

archive/issue_comments_494203.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nReplying to [@tobiasdiez](#comment:37):\n> And how are the features supposed to locate files in `SAGE_LOCAL`, `SAGE_VENV`, `SAGE_ETC`, `SAGE_LIB`, `SAGE_SHARE` etc? \n\n`sage.features.Executable` uses `PATH`. See #31296 for a proposed improvement.\n\n`sage.features.StaticFile` uses a customizable search path, which defaults to `SAGE_SHARE` - this probably needs a better design, as we are moving away from assumptions related to the installation scheme of the Sage distribution.\n\n> And why is it not helpful for this if these variables are Paths?\n\nThat's not how this works. A proposed change needs to be sufficiently motivated - what problem is the ticket trying to solve?  In particular, convincing motivation is necessary when breaking changes to the interface are proposed or the complexity of the code is increased by the change.\n\n`pathlib` is nice, but I don't think there is any sort of consensus in the Python community that it is \"better\" than `os.path`. It's just a matter of preferences.",
    "created_at": "2021-01-30T19:08:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494203",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:38" align="right">comment:38</div>

Replying to [@tobiasdiez](#comment:37):
> And how are the features supposed to locate files in `SAGE_LOCAL`, `SAGE_VENV`, `SAGE_ETC`, `SAGE_LIB`, `SAGE_SHARE` etc? 

`sage.features.Executable` uses `PATH`. See #31296 for a proposed improvement.

`sage.features.StaticFile` uses a customizable search path, which defaults to `SAGE_SHARE` - this probably needs a better design, as we are moving away from assumptions related to the installation scheme of the Sage distribution.

> And why is it not helpful for this if these variables are Paths?

That's not how this works. A proposed change needs to be sufficiently motivated - what problem is the ticket trying to solve?  In particular, convincing motivation is necessary when breaking changes to the interface are proposed or the complexity of the code is increased by the change.

`pathlib` is nice, but I don't think there is any sort of consensus in the Python community that it is "better" than `os.path`. It's just a matter of preferences.



---

archive/issue_events_425613.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2021-01-30T20:01:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "label": "https://github.com/sagemath/sage/labels/refactoring",
    "label_color": "696969",
    "label_name": "refactoring",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425613"
}
```



---

archive/issue_events_425614.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2021-01-30T20:01:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20interfaces%3A%20optional",
    "label_color": "0000ff",
    "label_name": "c: interfaces: optional",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425614"
}
```



---

archive/issue_comments_494204.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nReplying to [@mkoeppe](#comment:38):\n> what problem is the ticket trying to solve?\n\nThe idea was to provide basic existence and consistency checks that would apply to all path-based env variables. Since this is apparently not desired, let's close this ticket to not spent more time discussing this.",
    "created_at": "2021-01-30T20:01:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494204",
    "user": "https://github.com/tobiasdiez"
}
```

<div id="comment:39" align="right">comment:39</div>

Replying to [@mkoeppe](#comment:38):
> what problem is the ticket trying to solve?

The idea was to provide basic existence and consistency checks that would apply to all path-based env variables. Since this is apparently not desired, let's close this ticket to not spent more time discussing this.



---

archive/issue_events_425615.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2021-01-30T20:01:12Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "milestone_number": null,
    "milestone_title": "sage-9.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425615"
}
```



---

archive/issue_events_425616.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2021-01-30T20:01:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425616"
}
```



---

archive/issue_events_425617.json:
```json
{
    "actor": "https://github.com/tobiasdiez",
    "created_at": "2021-01-30T20:01:12Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "label": "https://github.com/sagemath/sage/labels/invalid",
    "label_color": "a6a6a6",
    "label_name": "invalid",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425617"
}
```



---

archive/issue_comments_494205.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nIn any case, the discussion was fruitful as it led to creating tickets #31291, #31292, #31293, #31296, #31306. Any work on these tickets would be very welcome!",
    "created_at": "2021-01-30T20:21:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494205",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:40" align="right">comment:40</div>

In any case, the discussion was fruitful as it led to creating tickets #31291, #31292, #31293, #31296, #31306. Any work on these tickets would be very welcome!



---

archive/issue_comments_494206.json:
```json
{
    "body": "Reviewer: **Matthias Koeppe**",
    "created_at": "2021-01-30T20:21:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494206",
    "user": "https://github.com/mkoeppe"
}
```

Reviewer: **Matthias Koeppe**



---

archive/issue_events_425618.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-30T20:21:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425618"
}
```



---

archive/issue_events_425619.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-01-30T20:21:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425619"
}
```



---

archive/issue_comments_494207.json:
```json
{
    "body": "Changed author from **Tobias Diez** to none",
    "created_at": "2021-01-30T20:21:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/30855#issuecomment-494207",
    "user": "https://github.com/mkoeppe"
}
```

Changed author from **Tobias Diez** to none



---

archive/issue_events_425620.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-26T02:08:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425620"
}
```



---

archive/issue_events_425621.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-26T02:08:43Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/30855",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/30855#event-425621"
}
```
