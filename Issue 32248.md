# Issue 32248: Extend substitute_function syntax

Issue created by migration from https://trac.sagemath.org/ticket/32485

Original creator: @spaghettisalat

Original creation time: 2021-09-07 17:22:32

CC:  mjo charpent

This ticket extends the syntax of `substitute_function` so that it is consistent with the syntax for the ordinary `substitute` method. This allows for substituting multiple functions,


```
sage: f,g,h = function('f g h')
sage: x,y = var('x y')
sage: (f(x) + g(y)).substitute_function({f: h, g: h})
h(x) + h(y)
```


exchanging two functions directly without having to do a three-way swap,


```
sage: (f(x) + g(y)).substitute_function({f: g, g: f})
f(y) + g(x)
```


and substituting a concrete expression for symbolic functions with a more direct syntax than before,


```
sage: expr = (diff(f(x),x))
sage: expr.substitute_function(f(x) == y*x^2)
2*x*y
```


(previously, one needed to introduce a new function to do this


```
sage: f2(x) = y*x^2
sage: expr.substitute_function(f,f2)
2*x*y
```

)

There are still two issues with the implementation at the moment, for which I'd like to get feedback:

1. Should we deprecate the old syntax `substitute_function(f,g)`? This would be more consistent with `substitute`, but would probably lead to a lot of warnings for users.
2. Finding functions by name and checking whether some object is a function is a bit tricky in sagemath. Currently, the functions doing that are imported from `sage.calculus.calculus`, but it might make sense to factor them out there and put them in a more suitable place.


---

Comment by @spaghettisalat created at 2021-09-07 17:22:39

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-09-07 18:41:06

Replying to [ticket:32485 gh-spaghettisalat]:
> 2. Finding functions by name and checking whether some object is a function is a bit tricky in sagemath. Currently, the functions doing that are imported from `sage.calculus.calculus`, but it might make sense to factor them out there and put them in a more suitable place.

Indeed. There are some related tickets that could use some input/help: #32227, #32479


---

Comment by mkoeppe created at 2021-09-07 18:53:34

The class `SubstituteFunction` is part of the public API and so if you change the signature of `__init__`, it needs to accept the old input as well.


---

Comment by git created at 2021-09-08 19:19:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @spaghettisalat created at 2021-09-08 19:21:08

Replying to [comment:3 mkoeppe]:
> The class `SubstituteFunction` is part of the public API and so if you change the signature of `__init__`, it needs to accept the old input as well.

Fixed, we now also allow the old syntax for `SubstituteFunction`.


---

Comment by mkoeppe created at 2021-09-09 03:03:23

Code like this:

```
+        try:
+            new = self.substitutions[operator]
+            return new(*[self(_) for _ in ex.operands()])
+        except KeyError:
             return super(SubstituteFunction, self).composition(ex, operator)
```

I would suggest to rewrite using `try...except...else` so that only the line `new = self.substitutions[operator]` is in the protected block


---

Comment by mkoeppe created at 2021-09-09 03:04:59


```
+        if len(args) == 2:
+            self.substitutions = {args[0]: args[1]}
+        else:
+            self.substitutions = args[0]
```

it should probably raise a `TypeError` if `len(args)` is neither 1 nor 2


---

Comment by mkoeppe created at 2021-09-09 03:05:56


```
+        Check that the old syntax still works::
             sage: s = SubstituteFunction(foo(x), foo, bar)
```

I think this needs a blank line in between


---

Comment by git created at 2021-09-10 17:51:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @spaghettisalat created at 2021-09-10 17:52:21

I have addressed all comments.


---

Comment by mkoeppe created at 2021-09-10 18:12:00

LGTM. When the patchbot indicator is green, you can set to positive review


---

Comment by mkoeppe created at 2021-09-10 23:14:32

The failure on one of the patchbot looks unrelated. Also the pyflakes warning is unrelated. Good to go.


---

Comment by mkoeppe created at 2021-09-10 23:14:32

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-09-19 09:58:20

Resolution: fixed
