# Issue 32248: Extend substitute_function syntax

archive/issues_032248.json:
```json
{
    "body": "CC:  @orlitzky @EmmanuelCharpentier\n\nThis ticket extends the syntax of `substitute_function` so that it is consistent with the syntax for the ordinary `substitute` method. This allows for substituting multiple functions,\n\n\n```\nsage: f,g,h = function('f g h')\nsage: x,y = var('x y')\nsage: (f(x) + g(y)).substitute_function({f: h, g: h})\nh(x) + h(y)\n```\n\n\nexchanging two functions directly without having to do a three-way swap,\n\n\n```\nsage: (f(x) + g(y)).substitute_function({f: g, g: f})\nf(y) + g(x)\n```\n\n\nand substituting a concrete expression for symbolic functions with a more direct syntax than before,\n\n\n```\nsage: expr = (diff(f(x),x))\nsage: expr.substitute_function(f(x) == y*x^2)\n2*x*y\n```\n\n\n(previously, one needed to introduce a new function to do this\n\n\n```\nsage: f2(x) = y*x^2\nsage: expr.substitute_function(f,f2)\n2*x*y\n```\n\n)\n\nThere are still two issues with the implementation at the moment, for which I'd like to get feedback:\n\n1. Should we deprecate the old syntax `substitute_function(f,g)`? This would be more consistent with `substitute`, but would probably lead to a lot of warnings for users.\n2. Finding functions by name and checking whether some object is a function is a bit tricky in sagemath. Currently, the functions doing that are imported from `sage.calculus.calculus`, but it might make sense to factor them out there and put them in a more suitable place.\n\nIssue created by migration from https://trac.sagemath.org/ticket/32485\n\n",
    "created_at": "2021-09-07T17:22:32Z",
    "labels": [
        "component: symbolics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "Extend substitute_function syntax",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32248",
    "user": "https://github.com/spaghettisalat"
}
```
CC:  @orlitzky @EmmanuelCharpentier

This ticket extends the syntax of `substitute_function` so that it is consistent with the syntax for the ordinary `substitute` method. This allows for substituting multiple functions,


```
sage: f,g,h = function('f g h')
sage: x,y = var('x y')
sage: (f(x) + g(y)).substitute_function({f: h, g: h})
h(x) + h(y)
```


exchanging two functions directly without having to do a three-way swap,


```
sage: (f(x) + g(y)).substitute_function({f: g, g: f})
f(y) + g(x)
```


and substituting a concrete expression for symbolic functions with a more direct syntax than before,


```
sage: expr = (diff(f(x),x))
sage: expr.substitute_function(f(x) == y*x^2)
2*x*y
```


(previously, one needed to introduce a new function to do this


```
sage: f2(x) = y*x^2
sage: expr.substitute_function(f,f2)
2*x*y
```

)

There are still two issues with the implementation at the moment, for which I'd like to get feedback:

1. Should we deprecate the old syntax `substitute_function(f,g)`? This would be more consistent with `substitute`, but would probably lead to a lot of warnings for users.
2. Finding functions by name and checking whether some object is a function is a bit tricky in sagemath. Currently, the functions doing that are imported from `sage.calculus.calculus`, but it might make sense to factor them out there and put them in a more suitable place.

Issue created by migration from https://trac.sagemath.org/ticket/32485





---

archive/issue_comments_459933.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-09-07T17:22:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32248#issuecomment-459933",
    "user": "https://github.com/spaghettisalat"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_459934.json:
```json
{
    "body": "Replying to [ticket:32485 gh-spaghettisalat]:\n> 2. Finding functions by name and checking whether some object is a function is a bit tricky in sagemath. Currently, the functions doing that are imported from `sage.calculus.calculus`, but it might make sense to factor them out there and put them in a more suitable place.\n\nIndeed. There are some related tickets that could use some input/help: #32227, #32479",
    "created_at": "2021-09-07T18:41:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32248#issuecomment-459934",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [ticket:32485 gh-spaghettisalat]:
> 2. Finding functions by name and checking whether some object is a function is a bit tricky in sagemath. Currently, the functions doing that are imported from `sage.calculus.calculus`, but it might make sense to factor them out there and put them in a more suitable place.

Indeed. There are some related tickets that could use some input/help: #32227, #32479



---

archive/issue_comments_459935.json:
```json
{
    "body": "The class `SubstituteFunction` is part of the public API and so if you change the signature of `__init__`, it needs to accept the old input as well.",
    "created_at": "2021-09-07T18:53:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32248#issuecomment-459935",
    "user": "https://github.com/mkoeppe"
}
```

The class `SubstituteFunction` is part of the public API and so if you change the signature of `__init__`, it needs to accept the old input as well.



---

archive/issue_comments_459936.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-09-08T19:19:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32248#issuecomment-459936",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_459937.json:
```json
{
    "body": "Replying to [comment:3 mkoeppe]:\n> The class `SubstituteFunction` is part of the public API and so if you change the signature of `__init__`, it needs to accept the old input as well.\n\nFixed, we now also allow the old syntax for `SubstituteFunction`.",
    "created_at": "2021-09-08T19:21:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32248#issuecomment-459937",
    "user": "https://github.com/spaghettisalat"
}
```

Replying to [comment:3 mkoeppe]:
> The class `SubstituteFunction` is part of the public API and so if you change the signature of `__init__`, it needs to accept the old input as well.

Fixed, we now also allow the old syntax for `SubstituteFunction`.



---

archive/issue_comments_459938.json:
```json
{
    "body": "Code like this:\n\n```\n+        try:\n+            new = self.substitutions[operator]\n+            return new(*[self(_) for _ in ex.operands()])\n+        except KeyError:\n             return super(SubstituteFunction, self).composition(ex, operator)\n```\n\nI would suggest to rewrite using `try...except...else` so that only the line `new = self.substitutions[operator]` is in the protected block",
    "created_at": "2021-09-09T03:03:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32248#issuecomment-459938",
    "user": "https://github.com/mkoeppe"
}
```

Code like this:

```
+        try:
+            new = self.substitutions[operator]
+            return new(*[self(_) for _ in ex.operands()])
+        except KeyError:
             return super(SubstituteFunction, self).composition(ex, operator)
```

I would suggest to rewrite using `try...except...else` so that only the line `new = self.substitutions[operator]` is in the protected block



---

archive/issue_comments_459939.json:
```json
{
    "body": "\n```\n+        if len(args) == 2:\n+            self.substitutions = {args[0]: args[1]}\n+        else:\n+            self.substitutions = args[0]\n```\n\nit should probably raise a `TypeError` if `len(args)` is neither 1 nor 2",
    "created_at": "2021-09-09T03:04:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32248#issuecomment-459939",
    "user": "https://github.com/mkoeppe"
}
```


```
+        if len(args) == 2:
+            self.substitutions = {args[0]: args[1]}
+        else:
+            self.substitutions = args[0]
```

it should probably raise a `TypeError` if `len(args)` is neither 1 nor 2



---

archive/issue_comments_459940.json:
```json
{
    "body": "\n```\n+        Check that the old syntax still works::\n             sage: s = SubstituteFunction(foo(x), foo, bar)\n```\n\nI think this needs a blank line in between",
    "created_at": "2021-09-09T03:05:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32248#issuecomment-459940",
    "user": "https://github.com/mkoeppe"
}
```


```
+        Check that the old syntax still works::
             sage: s = SubstituteFunction(foo(x), foo, bar)
```

I think this needs a blank line in between



---

archive/issue_comments_459941.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-09-10T17:51:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32248#issuecomment-459941",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_459942.json:
```json
{
    "body": "I have addressed all comments.",
    "created_at": "2021-09-10T17:52:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32248#issuecomment-459942",
    "user": "https://github.com/spaghettisalat"
}
```

I have addressed all comments.



---

archive/issue_comments_459943.json:
```json
{
    "body": "LGTM. When the patchbot indicator is green, you can set to positive review",
    "created_at": "2021-09-10T18:12:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32248#issuecomment-459943",
    "user": "https://github.com/mkoeppe"
}
```

LGTM. When the patchbot indicator is green, you can set to positive review



---

archive/issue_comments_459944.json:
```json
{
    "body": "The failure on one of the patchbot looks unrelated. Also the pyflakes warning is unrelated. Good to go.",
    "created_at": "2021-09-10T23:14:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32248#issuecomment-459944",
    "user": "https://github.com/mkoeppe"
}
```

The failure on one of the patchbot looks unrelated. Also the pyflakes warning is unrelated. Good to go.



---

archive/issue_comments_459945.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-10T23:14:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32248#issuecomment-459945",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_029268.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2021-09-19T09:58:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32248",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32248#event-29268"
}
```



---

archive/issue_comments_459946.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-09-19T09:58:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32248",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32248#issuecomment-459946",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
