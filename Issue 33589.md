# Issue 33589: pytest: Fix scope in which doctests are run

archive/issues_033589.json:
```json
{
    "body": "CC:  @tobiasdiez\n\n(from #33546)\n\nWhen running doctests via `sage --pytest` (added in #33546), there are many failed tests due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.\nTo see examples of these failures, run pytest on\n\n```\nsrc/sage/manifolds/differentiable/examples/sphere.py\nsrc/sage/manifolds/utilities.py\nsrc/sage/manifolds/chart.py\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/33826\n\n",
    "created_at": "2022-05-09T17:36:08Z",
    "labels": [
        "component: doctest framework",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "pytest: Fix scope in which doctests are run",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33589",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @tobiasdiez

(from #33546)

When running doctests via `sage --pytest` (added in #33546), there are many failed tests due to some issues with assumptions and/or symbolic  variables and/or deprecation warnings.
To see examples of these failures, run pytest on

```
src/sage/manifolds/differentiable/examples/sphere.py
src/sage/manifolds/utilities.py
src/sage/manifolds/chart.py
```


Issue created by migration from https://trac.sagemath.org/ticket/33826





---

archive/issue_comments_477507.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-05-14T09:58:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477507",
    "user": "https://github.com/tobiasdiez"
}
```

New commits:



---

archive/issue_comments_477508.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2022-05-15T09:20:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477508",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_477509.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-05-16T10:11:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477509",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_events_088813.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33589#event-88813"
}
```



---

archive/issue_comments_477510.json:
```json
{
    "body": "the issue with deprecation warnings is due to `pytest` capturing warnings, see https://docs.pytest.org/en/stable/how-to/capture-warnings.html\n\nTrying to disable this via\n\n```diff\n--- a/src/tox.ini\n+++ b/src/tox.ini\n@@ -232,7 +232,7 @@ exclude =\n [pytest]\n python_files = *_test.py\n norecursedirs = local prefix venv build pkgs .git src/doc src/bin\n-addopts = --import-mode importlib\n+addopts = --import-mode importlib -p no:warnings\n doctest_optionflags = NORMALIZE_WHITESPACE ELLIPSIS\n \n [coverage:run]\n\n```\n\ngives a bit more info:\n\n```\n...\n/home/dimpase/work/software/sage/src/sage/manifolds/chart.py:492: DocTestFailure\n__________________________ [doctest] sage.manifolds.chart.Chart.add_restrictions __________________________\n748         means ``(x > y) and ((x != 0) or (y != 0)) and (z^2 < x)``.\n749         If the list ``restrictions`` contains only one item, this\n750         item can be passed as such, i.e. writing ``x > y`` instead\n751         of the single element list ``[x > y]``.\n752 \n753         EXAMPLES::\n754 \n755             sage: M = Manifold(2, 'M', field='complex', structure='topological')\n756             sage: X.<x,y> = M.chart()\n757             sage: X.add_restrictions(abs(x) > 1)\nExpected:\n    doctest:warning...\n    DeprecationWarning: Chart.add_restrictions is deprecated; provide the\n    restrictions at the time of creating the chart\n    See https://trac.sagemath.org/32102 for details.\nGot nothing\n\n/home/dimpase/work/software/sage/src/sage/manifolds/chart.py:757: DocTestFailure\n------------------------------------------ Captured stderr call -------------------------------------------\n<doctest sage.manifolds.chart.Chart.add_restrictions[2]>:1: DeprecationWarning: Chart.add_restrictions is deprecated; provide the restrictions at the time of creating the chart\nSee https://trac.sagemath.org/32102 for details.\n  X.add_restrictions(abs(x) > Integer(1))\n...\n```\n\n\nNote `Captured stderr call` - this does not arise with the unchanged `tox.ini`.\n\nPerhaps the problem is in the way warning level is set in `deprecation()`, I don't know.",
    "created_at": "2022-12-07T11:29:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477510",
    "user": "https://github.com/dimpase"
}
```

the issue with deprecation warnings is due to `pytest` capturing warnings, see https://docs.pytest.org/en/stable/how-to/capture-warnings.html

Trying to disable this via

```diff
--- a/src/tox.ini
+++ b/src/tox.ini
@@ -232,7 +232,7 @@ exclude =
 [pytest]
 python_files = *_test.py
 norecursedirs = local prefix venv build pkgs .git src/doc src/bin
-addopts = --import-mode importlib
+addopts = --import-mode importlib -p no:warnings
 doctest_optionflags = NORMALIZE_WHITESPACE ELLIPSIS
 
 [coverage:run]

```

gives a bit more info:

```
...
/home/dimpase/work/software/sage/src/sage/manifolds/chart.py:492: DocTestFailure
__________________________ [doctest] sage.manifolds.chart.Chart.add_restrictions __________________________
748         means ``(x > y) and ((x != 0) or (y != 0)) and (z^2 < x)``.
749         If the list ``restrictions`` contains only one item, this
750         item can be passed as such, i.e. writing ``x > y`` instead
751         of the single element list ``[x > y]``.
752 
753         EXAMPLES::
754 
755             sage: M = Manifold(2, 'M', field='complex', structure='topological')
756             sage: X.<x,y> = M.chart()
757             sage: X.add_restrictions(abs(x) > 1)
Expected:
    doctest:warning...
    DeprecationWarning: Chart.add_restrictions is deprecated; provide the
    restrictions at the time of creating the chart
    See https://trac.sagemath.org/32102 for details.
Got nothing

/home/dimpase/work/software/sage/src/sage/manifolds/chart.py:757: DocTestFailure
------------------------------------------ Captured stderr call -------------------------------------------
<doctest sage.manifolds.chart.Chart.add_restrictions[2]>:1: DeprecationWarning: Chart.add_restrictions is deprecated; provide the restrictions at the time of creating the chart
See https://trac.sagemath.org/32102 for details.
  X.add_restrictions(abs(x) > Integer(1))
...
```


Note `Captured stderr call` - this does not arise with the unchanged `tox.ini`.

Perhaps the problem is in the way warning level is set in `deprecation()`, I don't know.



---

archive/issue_comments_477511.json:
```json
{
    "body": "With vanilla python pytest still needs a bit of monkey-patching of the warning system, namely, `warnings.showwarning`.\nNote that Sage does it too, but in a trickier way.\n\n```python\n# c.py\nimport warnings\ndowarn = warnings.showwarning\ndef showwarn(message, category, filename, lineno, file=None, line=None):\n    import sys\n    dowarn(message, category, filename, lineno, sys.stdout, line)\n\nwarnings.showwarning = showwarn # use stdout instead of stderr\n\n\nclass tst:\n    \"\"\"\n    >>> len(tst.__subclasses__()) >= 0\n    True\n    >>> import warnings\n    >>> warnings.warn(\"foo\")\n    <doctest ...: UserWarning: foo\n      warnings.warn(\"foo\")\n    \"\"\"\n    pass\n```\n\n\nat least the above works:\n\n```\n$ pytest --doctest-modules -p no:warnings c.py\n========================================== test session starts ===========================================\nplatform linux -- Python 3.9.2, pytest-7.1.3, pluggy-0.13.0\nrootdir: /tmp\ncollected 1 item                                                                                         \n\nc.py .                                                                                             [100%]\n\n=========================================== 1 passed in 0.03s ============================================\n```\n\n\nIt's still not clear how to fix Sage's pytesting: I tried a similar hack with\nshowwarning in `src/sage/doctest/forker.py`, with the one in comment:7, to no avail...",
    "created_at": "2022-12-07T14:23:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477511",
    "user": "https://github.com/dimpase"
}
```

With vanilla python pytest still needs a bit of monkey-patching of the warning system, namely, `warnings.showwarning`.
Note that Sage does it too, but in a trickier way.

```python
# c.py
import warnings
dowarn = warnings.showwarning
def showwarn(message, category, filename, lineno, file=None, line=None):
    import sys
    dowarn(message, category, filename, lineno, sys.stdout, line)

warnings.showwarning = showwarn # use stdout instead of stderr


class tst:
    """
    >>> len(tst.__subclasses__()) >= 0
    True
    >>> import warnings
    >>> warnings.warn("foo")
    <doctest ...: UserWarning: foo
      warnings.warn("foo")
    """
    pass
```


at least the above works:

```
$ pytest --doctest-modules -p no:warnings c.py
========================================== test session starts ===========================================
platform linux -- Python 3.9.2, pytest-7.1.3, pluggy-0.13.0
rootdir: /tmp
collected 1 item                                                                                         

c.py .                                                                                             [100%]

=========================================== 1 passed in 0.03s ============================================
```


It's still not clear how to fix Sage's pytesting: I tried a similar hack with
showwarning in `src/sage/doctest/forker.py`, with the one in comment:7, to no avail...



---

archive/issue_comments_477512.json:
```json
{
    "body": "I've opened https://github.com/pytest-dev/pytest/discussions/10565 to check whether there is a better way than monkey-patching `warnings.showwarning`.",
    "created_at": "2022-12-07T16:18:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477512",
    "user": "https://github.com/dimpase"
}
```

I've opened https://github.com/pytest-dev/pytest/discussions/10565 to check whether there is a better way than monkey-patching `warnings.showwarning`.



---

archive/issue_comments_477513.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-12-07T22:48:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477513",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_477514.json:
```json
{
    "body": "Rebased over latest 9.8.beta4. The last addition, `92bbf1d`, allows pytest to process docstrings with deprecations. Thus, only `src/sage/manifolds/utilities.py` still fails with pytest, the other 2 files are fine.",
    "created_at": "2022-12-07T22:52:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477514",
    "user": "https://github.com/dimpase"
}
```

Rebased over latest 9.8.beta4. The last addition, `92bbf1d`, allows pytest to process docstrings with deprecations. Thus, only `src/sage/manifolds/utilities.py` still fails with pytest, the other 2 files are fine.



---

archive/issue_comments_477515.json:
```json
{
    "body": "https://github.com/sagemath/sagetrac-mirror/actions/runs/3643485912/jobs/6151758539\nsays \"collected 0 items / 1 skipped\"",
    "created_at": "2022-12-07T23:46:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477515",
    "user": "https://github.com/mkoeppe"
}
```

https://github.com/sagemath/sagetrac-mirror/actions/runs/3643485912/jobs/6151758539
says "collected 0 items / 1 skipped"



---

archive/issue_comments_477516.json:
```json
{
    "body": "Replying to [comment:16 Matthias K\u00f6ppe]:\n> https://github.com/sagemath/sagetrac-mirror/actions/runs/3643485912/jobs/6151758539\n> says \"collected 0 items / 1 skipped\"\n\nnot caused by the latest commit: without it, or with it, the same problem:\n\n```\n=========================================== test session starts ===========================================\nplatform linux -- Python 3.9.13, pytest-7.2.0, pluggy-1.0.0\nrootdir: /home/scratch/scratch2/dimpase/sage/sagetrac-mirror, configfile: tox.ini\nplugins: xdist-3.1.0\ncollected 0 items / 1 error                                                                               \n\n================================================= ERRORS ==================================================\n______________________________________ ERROR collecting test session ______________________________________\n/usr/lib64/python3.9/importlib/__init__.py:127: in import_module\n    return _bootstrap._gcd_import(name[level:], package, level)\n<frozen importlib._bootstrap>:1030: in _gcd_import\n    ???\n<frozen importlib._bootstrap>:1007: in _find_and_load\n    ???\n<frozen importlib._bootstrap>:972: in _find_and_load_unlocked\n    ???\n<frozen importlib._bootstrap>:228: in _call_with_frames_removed\n    ???\n<frozen importlib._bootstrap>:1030: in _gcd_import\n    ???\n<frozen importlib._bootstrap>:1007: in _find_and_load\n    ???\n<frozen importlib._bootstrap>:986: in _find_and_load_unlocked\n    ???\n<frozen importlib._bootstrap>:680: in _load_unlocked\n    ???\n<frozen importlib._bootstrap_external>:850: in exec_module\n    ???\n<frozen importlib._bootstrap>:228: in _call_with_frames_removed\n    ???\nechelon/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/matplotlib/tests/__init__.py:6: in <module>\n    raise IOError(\nE   OSError: The baseline image directory does not exist. This is most likely because the test data is not installed. You may need to install matplotlib from source to get the test data.\n========================================= short test summary info =========================================\nERROR  - OSError: The baseline image directory does not exist. This is most likely because the test data is not...\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n============================================ 1 error in 5.96s =============================================\n```\n",
    "created_at": "2022-12-08T00:03:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477516",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:16 Matthias Köppe]:
> https://github.com/sagemath/sagetrac-mirror/actions/runs/3643485912/jobs/6151758539
> says "collected 0 items / 1 skipped"

not caused by the latest commit: without it, or with it, the same problem:

```
=========================================== test session starts ===========================================
platform linux -- Python 3.9.13, pytest-7.2.0, pluggy-1.0.0
rootdir: /home/scratch/scratch2/dimpase/sage/sagetrac-mirror, configfile: tox.ini
plugins: xdist-3.1.0
collected 0 items / 1 error                                                                               

================================================= ERRORS ==================================================
______________________________________ ERROR collecting test session ______________________________________
/usr/lib64/python3.9/importlib/__init__.py:127: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
<frozen importlib._bootstrap>:1030: in _gcd_import
    ???
<frozen importlib._bootstrap>:1007: in _find_and_load
    ???
<frozen importlib._bootstrap>:972: in _find_and_load_unlocked
    ???
<frozen importlib._bootstrap>:228: in _call_with_frames_removed
    ???
<frozen importlib._bootstrap>:1030: in _gcd_import
    ???
<frozen importlib._bootstrap>:1007: in _find_and_load
    ???
<frozen importlib._bootstrap>:986: in _find_and_load_unlocked
    ???
<frozen importlib._bootstrap>:680: in _load_unlocked
    ???
<frozen importlib._bootstrap_external>:850: in exec_module
    ???
<frozen importlib._bootstrap>:228: in _call_with_frames_removed
    ???
echelon/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/matplotlib/tests/__init__.py:6: in <module>
    raise IOError(
E   OSError: The baseline image directory does not exist. This is most likely because the test data is not installed. You may need to install matplotlib from source to get the test data.
========================================= short test summary info =========================================
ERROR  - OSError: The baseline image directory does not exist. This is most likely because the test data is not...
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
============================================ 1 error in 5.96s =============================================
```




---

archive/issue_comments_477517.json:
```json
{
    "body": "Google finds a numeber of complaints about this error with matplotlib, and the answer appears to be to follow https://matplotlib.org/stable/devel/development_setup.html\nto install matplotlib.\n\nindeed, we apparently don't install `baseline image directory`, or install it improperly for pytest...",
    "created_at": "2022-12-08T00:27:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477517",
    "user": "https://github.com/dimpase"
}
```

Google finds a numeber of complaints about this error with matplotlib, and the answer appears to be to follow https://matplotlib.org/stable/devel/development_setup.html
to install matplotlib.

indeed, we apparently don't install `baseline image directory`, or install it improperly for pytest...



---

archive/issue_comments_477518.json:
```json
{
    "body": "Why do we even try to run tests of matplotlib? Can they be suppressed?",
    "created_at": "2022-12-08T00:40:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477518",
    "user": "https://github.com/dimpase"
}
```

Why do we even try to run tests of matplotlib? Can they be suppressed?



---

archive/issue_comments_477519.json:
```json
{
    "body": "Replying to [comment:19 Dima Pasechnik]:\n> Why do we even try to run tests of matplotlib?\n\nIt's definitely not intended, it's supposed to run tests out of `src/` only. Not sure what's happening there",
    "created_at": "2022-12-08T00:47:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477519",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:19 Dima Pasechnik]:
> Why do we even try to run tests of matplotlib?

It's definitely not intended, it's supposed to run tests out of `src/` only. Not sure what's happening there



---

archive/issue_comments_477520.json:
```json
{
    "body": "Replying to [comment:20 Matthias K\u00f6ppe]:\n> Replying to [comment:19 Dima Pasechnik]:\n> > Why do we even try to run tests of matplotlib?\n> \n> It's definitely not intended, it's supposed to run tests out of `src/` only. Not sure what's happening there\n\nwell, it's late here, and\n\nhttps://docs.pytest.org/en/7.2.x/reference/customize.html#initialization-determining-rootdir-and-configfile\n\nis quite a long read...",
    "created_at": "2022-12-08T01:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477520",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:20 Matthias Köppe]:
> Replying to [comment:19 Dima Pasechnik]:
> > Why do we even try to run tests of matplotlib?
> 
> It's definitely not intended, it's supposed to run tests out of `src/` only. Not sure what's happening there

well, it's late here, and

https://docs.pytest.org/en/7.2.x/reference/customize.html#initialization-determining-rootdir-and-configfile

is quite a long read...



---

archive/issue_comments_477521.json:
```json
{
    "body": "Replying to [comment:20 Matthias K\u00f6ppe]:\n> Replying to [comment:19 Dima Pasechnik]:\n> > Why do we even try to run tests of matplotlib?\n> \n> It's definitely not intended, it's supposed to run tests out of `src/` only. Not sure what's happening there\n\nsome kind of trouble while discovering namespace packages to test. \n\n```\n$ ../sage -python -m coverage run -m pytest -c tox.ini --pyargs sage.misc\n========================================== test session starts ===========================================\nplatform linux -- Python 3.9.2, pytest-7.1.3, pluggy-1.0.0\nrootdir: /home/dimpase/work/software/sage/src, configfile: tox.ini\nplugins: xdist-3.1.0\ncollected 0 items                                                                                        \n\n========================================= no tests ran in 0.01s ==========================================\nERROR: module or package not found: sage.misc (missing __init__.py?)\n```\n\n\nbut\n\n\n```\n$ ../sage -python -m coverage run -m pytest -c tox.ini --pyargs sage.tests\n========================================== test session starts ===========================================\nplatform linux -- Python 3.9.2, pytest-7.1.3, pluggy-1.0.0\nrootdir: /home/dimpase/work/software/sage/src, configfile: tox.ini\nplugins: xdist-3.1.0\ncollected 32 items / 1 skipped                                                                           \n\nsage/tests/books/computational-mathematics-with-sagemath/calculus_doctest.py F                     [  3%]\nsage/tests/books/computational-mathematics-with-sagemath/combinat_doctest.py F                     [  6%]\nsage/tests/books/computational-mathematics-with-sagemath/domaines_doctest.py .                     [  9%]\nsage/tests/books/computational-mathematics-with-sagemath/float_doctest.py .                        [ 12%]\nsage/tests/books/computational-mathematics-with-sagemath/graphique_doctest.py F                    [ 15%]\n...\n```\n\n\nthere is quite a bit on this in pytest github:\nhttps://github.com/pytest-dev/pytest/pull/1597\nclosing\nhttps://github.com/pytest-dev/pytest/issues/1567",
    "created_at": "2022-12-08T09:38:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477521",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:20 Matthias Köppe]:
> Replying to [comment:19 Dima Pasechnik]:
> > Why do we even try to run tests of matplotlib?
> 
> It's definitely not intended, it's supposed to run tests out of `src/` only. Not sure what's happening there

some kind of trouble while discovering namespace packages to test. 

```
$ ../sage -python -m coverage run -m pytest -c tox.ini --pyargs sage.misc
========================================== test session starts ===========================================
platform linux -- Python 3.9.2, pytest-7.1.3, pluggy-1.0.0
rootdir: /home/dimpase/work/software/sage/src, configfile: tox.ini
plugins: xdist-3.1.0
collected 0 items                                                                                        

========================================= no tests ran in 0.01s ==========================================
ERROR: module or package not found: sage.misc (missing __init__.py?)
```


but


```
$ ../sage -python -m coverage run -m pytest -c tox.ini --pyargs sage.tests
========================================== test session starts ===========================================
platform linux -- Python 3.9.2, pytest-7.1.3, pluggy-1.0.0
rootdir: /home/dimpase/work/software/sage/src, configfile: tox.ini
plugins: xdist-3.1.0
collected 32 items / 1 skipped                                                                           

sage/tests/books/computational-mathematics-with-sagemath/calculus_doctest.py F                     [  3%]
sage/tests/books/computational-mathematics-with-sagemath/combinat_doctest.py F                     [  6%]
sage/tests/books/computational-mathematics-with-sagemath/domaines_doctest.py .                     [  9%]
sage/tests/books/computational-mathematics-with-sagemath/float_doctest.py .                        [ 12%]
sage/tests/books/computational-mathematics-with-sagemath/graphique_doctest.py F                    [ 15%]
...
```


there is quite a bit on this in pytest github:
https://github.com/pytest-dev/pytest/pull/1597
closing
https://github.com/pytest-dev/pytest/issues/1567



---

archive/issue_comments_477522.json:
```json
{
    "body": "Also note that `sage --python -m pytest` manipulates `sys.path` (adding the currect directory to it), and this results in an extra trouble: e.g.\n`./sage --pytest src/sage/misc/*.py` works- collects a lot of tests, about 30% of failing tests, and a warning with a backtrace:\n\n```\npytest.PytestCollectionWarning: cannot collect test class 'TestParent3.Element' because it has a __init__ constructor (from: sage/misc/test_nested_class.py)\ndoctest:warning\n...\n```\n\nbut `./sage --python -m pytest src/sage/misc/*.py` only collects 4 tests, and errors with weird\n\n```\n================================================= ERRORS =================================================\n_____________________________________ ERROR at setup of test_pickle ______________________________________\nfile /home/dimpase/work/software/sage/src/sage/misc/explain_pickle.py, line 2531\n  def test_pickle(p, verbose_eval=False, pedantic=False, args=()):\nE       fixture 'p' not found\n>       available fixtures: add_imports, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, doctest_namespace, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, testrun_uid, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, worker_id\n>       use 'pytest --fixtures [testpath]' for help on them.\n\n/home/dimpase/work/software/sage/src/sage/misc/explain_pickle.py:2531\n__________________________________ ERROR at setup of test_add_commutes ___________________________________\nfile /home/dimpase/work/software/sage/src/sage/misc/random_testing.py, line 162\n  @random_testing\n  def test_add_commutes(trials, verbose=False):\nE       fixture 'trials' not found\n>       available fixtures: add_imports, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, doctest_namespace, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, testrun_uid, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, worker_id\n>       use 'pytest --fixtures [testpath]' for help on them.\n\n/home/dimpase/work/software/sage/src/sage/misc/random_testing.py:162\n...\n```\n",
    "created_at": "2022-12-08T10:24:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477522",
    "user": "https://github.com/dimpase"
}
```

Also note that `sage --python -m pytest` manipulates `sys.path` (adding the currect directory to it), and this results in an extra trouble: e.g.
`./sage --pytest src/sage/misc/*.py` works- collects a lot of tests, about 30% of failing tests, and a warning with a backtrace:

```
pytest.PytestCollectionWarning: cannot collect test class 'TestParent3.Element' because it has a __init__ constructor (from: sage/misc/test_nested_class.py)
doctest:warning
...
```

but `./sage --python -m pytest src/sage/misc/*.py` only collects 4 tests, and errors with weird

```
================================================= ERRORS =================================================
_____________________________________ ERROR at setup of test_pickle ______________________________________
file /home/dimpase/work/software/sage/src/sage/misc/explain_pickle.py, line 2531
  def test_pickle(p, verbose_eval=False, pedantic=False, args=()):
E       fixture 'p' not found
>       available fixtures: add_imports, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, doctest_namespace, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, testrun_uid, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, worker_id
>       use 'pytest --fixtures [testpath]' for help on them.

/home/dimpase/work/software/sage/src/sage/misc/explain_pickle.py:2531
__________________________________ ERROR at setup of test_add_commutes ___________________________________
file /home/dimpase/work/software/sage/src/sage/misc/random_testing.py, line 162
  @random_testing
  def test_add_commutes(trials, verbose=False):
E       fixture 'trials' not found
>       available fixtures: add_imports, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, doctest_namespace, monkeypatch, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, testrun_uid, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, worker_id
>       use 'pytest --fixtures [testpath]' for help on them.

/home/dimpase/work/software/sage/src/sage/misc/random_testing.py:162
...
```




---

archive/issue_comments_477523.json:
```json
{
    "body": "And bad news from https://github.com/pytest-dev/pytest/issues/1567#issuecomment-1342418664 :\n\n```\nPytest is unaware of pep420, nobody fixed that so far\n```\n",
    "created_at": "2022-12-08T10:26:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477523",
    "user": "https://github.com/dimpase"
}
```

And bad news from https://github.com/pytest-dev/pytest/issues/1567#issuecomment-1342418664 :

```
Pytest is unaware of pep420, nobody fixed that so far
```




---

archive/issue_comments_477524.json:
```json
{
    "body": "Indeed, this is very bad.",
    "created_at": "2022-12-08T17:24:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477524",
    "user": "https://github.com/mkoeppe"
}
```

Indeed, this is very bad.



---

archive/issue_comments_477525.json:
```json
{
    "body": "The problem with PEP 420 implicit namespace packages for pytest and similar source discovery is that there is no clear way to find the root of a source tree.\n\nIn Sage, there is a solution for that -- we have marker files `all.py` and `all__*.py` that distinguish namespace packages from non-package directories. These are recognized in https://github.com/sagemath/sage/blob/develop/src/sage/misc/package_dir.py#L132\n(As Tobias pointed out in previous discussions, using such marker files was rejected during the PEP 420 design discussion; but our source tree already had these files, so we repurposed them for discovery.)\n\nSo a sage-specific solution could be to monkey-patch https://github.com/pytest-dev/pytest/blob/main/src/_pytest/_py/path.py so that it understands the Sage source layout. \n\nFor upstream pytest, perhaps an intermediate goal could be to have a documented hook that makes this monkey-patching easier.",
    "created_at": "2022-12-08T17:37:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477525",
    "user": "https://github.com/mkoeppe"
}
```

The problem with PEP 420 implicit namespace packages for pytest and similar source discovery is that there is no clear way to find the root of a source tree.

In Sage, there is a solution for that -- we have marker files `all.py` and `all__*.py` that distinguish namespace packages from non-package directories. These are recognized in https://github.com/sagemath/sage/blob/develop/src/sage/misc/package_dir.py#L132
(As Tobias pointed out in previous discussions, using such marker files was rejected during the PEP 420 design discussion; but our source tree already had these files, so we repurposed them for discovery.)

So a sage-specific solution could be to monkey-patch https://github.com/pytest-dev/pytest/blob/main/src/_pytest/_py/path.py so that it understands the Sage source layout. 

For upstream pytest, perhaps an intermediate goal could be to have a documented hook that makes this monkey-patching easier.



---

archive/issue_comments_477526.json:
```json
{
    "body": "Replying to [comment:26 Matthias K\u00f6ppe]:\n> The problem with PEP 420 implicit namespace packages for pytest and similar source discovery is that there is no clear way to find the root of a source tree.\n> \n> In Sage, there is a solution for that -- we have marker files `all.py` and `all__*.py` that distinguish namespace packages from non-package directories. These are recognized in https://github.com/sagemath/sage/blob/develop/src/sage/misc/package_dir.py#L132\n> (As Tobias pointed out in previous discussions, using such marker files was rejected during the PEP 420 design discussion; but our source tree already had these files, so we repurposed them for discovery.)\n> \n> So a sage-specific solution could be to monkey-patch https://github.com/pytest-dev/pytest/blob/main/src/_pytest/_py/path.py so that it understands the Sage source layout. \n\nplease see the reply to https://github.com/pytest-dev/pytest/issues/10569#issuecomment-1344122839, basically, upstream says monkey-patching this will break, soon.\n\nOn https://github.com/pytest-dev/pytest/issues/10569 let us further discuss with the upstream how we can go forward here.",
    "created_at": "2022-12-09T14:20:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477526",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:26 Matthias Köppe]:
> The problem with PEP 420 implicit namespace packages for pytest and similar source discovery is that there is no clear way to find the root of a source tree.
> 
> In Sage, there is a solution for that -- we have marker files `all.py` and `all__*.py` that distinguish namespace packages from non-package directories. These are recognized in https://github.com/sagemath/sage/blob/develop/src/sage/misc/package_dir.py#L132
> (As Tobias pointed out in previous discussions, using such marker files was rejected during the PEP 420 design discussion; but our source tree already had these files, so we repurposed them for discovery.)
> 
> So a sage-specific solution could be to monkey-patch https://github.com/pytest-dev/pytest/blob/main/src/_pytest/_py/path.py so that it understands the Sage source layout. 

please see the reply to https://github.com/pytest-dev/pytest/issues/10569#issuecomment-1344122839, basically, upstream says monkey-patching this will break, soon.

On https://github.com/pytest-dev/pytest/issues/10569 let us further discuss with the upstream how we can go forward here.



---

archive/issue_comments_477527.json:
```json
{
    "body": "By the way, it's not just our doctests that are not run by pytest any more because of the PEP 420 issue. Also the pytest files `*_test.py` in `src/sage/numerical/backends` and `src/sage/manifolds/differentiable` are no longer being run.",
    "created_at": "2022-12-09T17:31:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477527",
    "user": "https://github.com/mkoeppe"
}
```

By the way, it's not just our doctests that are not run by pytest any more because of the PEP 420 issue. Also the pytest files `*_test.py` in `src/sage/numerical/backends` and `src/sage/manifolds/differentiable` are no longer being run.



---

archive/issue_comments_477528.json:
```json
{
    "body": "Replying to [comment:26 Matthias K\u00f6ppe]:\n> So a sage-specific solution could be to monkey-patch https://github.com/pytest-dev/pytest/blob/main/src/_pytest/_py/path.py so that it understands the Sage source layout. \n\nA more relevant place seems to be https://github.com/pytest-dev/pytest/blob/9fbd67dd4b1baa6889dbb2073c17b85da39f80d9/src/_pytest/python.py#L747 (Package.collect)",
    "created_at": "2022-12-09T17:52:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477528",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:26 Matthias Köppe]:
> So a sage-specific solution could be to monkey-patch https://github.com/pytest-dev/pytest/blob/main/src/_pytest/_py/path.py so that it understands the Sage source layout. 

A more relevant place seems to be https://github.com/pytest-dev/pytest/blob/9fbd67dd4b1baa6889dbb2073c17b85da39f80d9/src/_pytest/python.py#L747 (Package.collect)



---

archive/issue_comments_477529.json:
```json
{
    "body": "Anyway, should we move to `sage --pytest` from `sage --python -m pytest` - as the latter is playing fast and loose with `sys.path` ?",
    "created_at": "2022-12-09T21:22:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477529",
    "user": "https://github.com/dimpase"
}
```

Anyway, should we move to `sage --pytest` from `sage --python -m pytest` - as the latter is playing fast and loose with `sys.path` ?



---

archive/issue_comments_477530.json:
```json
{
    "body": "Yes, I think so",
    "created_at": "2022-12-09T21:24:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33589",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33589#issuecomment-477530",
    "user": "https://github.com/mkoeppe"
}
```

Yes, I think so
