# Issue 28592: suitesparse does not build on Cygwin

Issue created by migration from https://trac.sagemath.org/ticket/28829

Original creator: embray

Original creation time: 2019-12-02 11:57:51

CC:  dimpase fbissey

Keywords: cygwin windows cvxopt suitesparse


```
[suitesparse-5.6.0] gcc -L/home/embray/src/sagemath/sage-python3/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage-python3/local/lib  -L/home/embray/src/sagemath/sage-python3/local/lib -L/home/embray/src/sagemath/sage-python3/local/lib -L/home/embray/src/sagemath/sage-python3/local/lib -shared -Wl,-soname -Wl,libamd.so.2 -Wl,--no-undefined amd_i_aat.o amd_i_1.o amd_i_2.o amd_i_dump.o amd_i_postorder.o amd_i_defaults.o amd_i_post_tree.o amd_i_order.o amd_i_control.o amd_i_info.o amd_i_valid.o amd_i_preprocess.o amd_l_aat.o amd_l_1.o amd_l_2.o amd_l_dump.o amd_l_postorder.o amd_l_defaults.o amd_l_post_tree.o amd_l_order.o amd_l_control.o amd_l_info.o amd_l_valid.o amd_l_preprocess.o -o /home/embray/src/sagemath/sage-python3/local/lib/libamd.so.2.4.6 -lm -lsuitesparseconfig
[suitesparse-5.6.0] /usr/lib/gcc/x86_64-pc-cygwin/7.4.0/../../../../x86_64-pc-cygwin/bin/ld: cannot find -lsuitesparseconfig
[suitesparse-5.6.0] collect2: error: ld returned 1 exit status
```


The description in #22380 indicates that it was included at one point as _part_ of cvxopt, but I never had any problems related to this before.  


---

Comment by dimpase created at 2019-12-02 12:20:44

Do you have `local/lib/libsuitesparseconfig.so*` present?

I also wonder how many times one can safely repeat `-L/home/embray/src/sagemath/sage-python3/local/lib` in parameters...


---

Comment by embray created at 2019-12-02 16:35:41

Shew...this build system is a mess...


---

Comment by dimpase created at 2019-12-02 16:43:34

from my dim memories about cygwin, sometimes DLLs end up in local/bin rather than in local/bin, etc...


---

Comment by embray created at 2019-12-02 18:04:35

This is the most minimal patch I could come up with for now.  It required changes in quite a few files for them to install files properly on Cygwin.  I didn't touch the libraries that use CMake (and they might already work better), or any other make targets that don't need to work for Sage's purposes.

A better solution would involve a total reworking of the build system.

Rather than patching, I did consider just updating our `spkg-install` with some Cygwin-specific commands to move things around after the initial faulty installation.  That conceivably could have worked, but might be an even bigger and uglier mess.  I'll propose my changes, or something like it, to upstream later.

Still need to test that the rest of the Sage build passes.
----
New commits:


---

Comment by embray created at 2019-12-02 18:04:35

Changing status from new to needs_review.


---

Comment by embray created at 2019-12-03 10:09:45

Replying to [comment:3 dimpase]:
> from my dim memories about cygwin, sometimes DLLs end up in local/bin rather than in local/bin, etc...


I think you meant "local/lib rather than in local/bin"? :)  And yes, that was part of the problem.  It actually didn't even properly detect building on Cygwin, and the implementation of doing so (which in fairness was noted in the comments as "untested") was indeed completely broken.  It also didn't properly produce import libs for the DLLs, and a number of other odd issues.

Beyond just the Cygwin issues though the whole thing is a bit of a mess :D


---

Comment by git created at 2019-12-06 14:21:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-12-06 14:22:22

Rebased to incorporate fbissey's updates to #28832.


---

Comment by fbissey created at 2019-12-09 20:46:51

We shouldn't need `SuiteSparse_GPURuntime` or `xerbla`. One needs a config flag to be run and the other need to be explicitly build as far as I can see. The rest looks OK to me. 

Of course extra useless (for sage) patching doesn't hurt. Keeping as close as you would like upstream to take it is definitely OK.

Let's see how it goes.


---

Comment by fbissey created at 2019-12-09 20:46:51

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-12-10 10:28:25

Exactly--some of this patching was done mechanically since their sources have many copies of almost identical Makefiles (annoyingly some of them with minor, unnecessary variations).  I still intend to submit this patch (at a minimum) upstream, and maybe offer to develop a more thorough refactoring another time (especially if one of his wealthy sponsors would be willing to fund the work :)


---

Comment by dimpase created at 2019-12-10 11:40:35

maybe it's more meaningful to use cmake with https://github.com/jlblancoc/suitesparse-metis-for-windows (despite the name, it's cross-platform, and endorsed by the suitesparse author).


---

Comment by vbraun created at 2019-12-11 21:46:33

Resolution: fixed
