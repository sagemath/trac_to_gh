# Issue 28592: suitesparse does not build on Cygwin

archive/issues_028592.json:
```json
{
    "body": "CC:  dimpase fbissey\n\nKeywords: cygwin windows cvxopt suitesparse\n\n\n```\n[suitesparse-5.6.0] gcc -L/home/embray/src/sagemath/sage-python3/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage-python3/local/lib  -L/home/embray/src/sagemath/sage-python3/local/lib -L/home/embray/src/sagemath/sage-python3/local/lib -L/home/embray/src/sagemath/sage-python3/local/lib -shared -Wl,-soname -Wl,libamd.so.2 -Wl,--no-undefined amd_i_aat.o amd_i_1.o amd_i_2.o amd_i_dump.o amd_i_postorder.o amd_i_defaults.o amd_i_post_tree.o amd_i_order.o amd_i_control.o amd_i_info.o amd_i_valid.o amd_i_preprocess.o amd_l_aat.o amd_l_1.o amd_l_2.o amd_l_dump.o amd_l_postorder.o amd_l_defaults.o amd_l_post_tree.o amd_l_order.o amd_l_control.o amd_l_info.o amd_l_valid.o amd_l_preprocess.o -o /home/embray/src/sagemath/sage-python3/local/lib/libamd.so.2.4.6 -lm -lsuitesparseconfig\n[suitesparse-5.6.0] /usr/lib/gcc/x86_64-pc-cygwin/7.4.0/../../../../x86_64-pc-cygwin/bin/ld: cannot find -lsuitesparseconfig\n[suitesparse-5.6.0] collect2: error: ld returned 1 exit status\n```\n\n\nThe description in #22380 indicates that it was included at one point as *part* of cvxopt, but I never had any problems related to this before.  \n\nIssue created by migration from https://trac.sagemath.org/ticket/28829\n\n",
    "created_at": "2019-12-02T11:57:51Z",
    "labels": [
        "packages: standard",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "suitesparse does not build on Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28592",
    "user": "embray"
}
```
CC:  dimpase fbissey

Keywords: cygwin windows cvxopt suitesparse


```
[suitesparse-5.6.0] gcc -L/home/embray/src/sagemath/sage-python3/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage-python3/local/lib  -L/home/embray/src/sagemath/sage-python3/local/lib -L/home/embray/src/sagemath/sage-python3/local/lib -L/home/embray/src/sagemath/sage-python3/local/lib -shared -Wl,-soname -Wl,libamd.so.2 -Wl,--no-undefined amd_i_aat.o amd_i_1.o amd_i_2.o amd_i_dump.o amd_i_postorder.o amd_i_defaults.o amd_i_post_tree.o amd_i_order.o amd_i_control.o amd_i_info.o amd_i_valid.o amd_i_preprocess.o amd_l_aat.o amd_l_1.o amd_l_2.o amd_l_dump.o amd_l_postorder.o amd_l_defaults.o amd_l_post_tree.o amd_l_order.o amd_l_control.o amd_l_info.o amd_l_valid.o amd_l_preprocess.o -o /home/embray/src/sagemath/sage-python3/local/lib/libamd.so.2.4.6 -lm -lsuitesparseconfig
[suitesparse-5.6.0] /usr/lib/gcc/x86_64-pc-cygwin/7.4.0/../../../../x86_64-pc-cygwin/bin/ld: cannot find -lsuitesparseconfig
[suitesparse-5.6.0] collect2: error: ld returned 1 exit status
```


The description in #22380 indicates that it was included at one point as *part* of cvxopt, but I never had any problems related to this before.  

Issue created by migration from https://trac.sagemath.org/ticket/28829





---

archive/issue_comments_403561.json:
```json
{
    "body": "Do you have `local/lib/libsuitesparseconfig.so*` present?\n\nI also wonder how many times one can safely repeat `-L/home/embray/src/sagemath/sage-python3/local/lib` in parameters...",
    "created_at": "2019-12-02T12:20:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28592#issuecomment-403561",
    "user": "dimpase"
}
```

Do you have `local/lib/libsuitesparseconfig.so*` present?

I also wonder how many times one can safely repeat `-L/home/embray/src/sagemath/sage-python3/local/lib` in parameters...



---

archive/issue_comments_403562.json:
```json
{
    "body": "Shew...this build system is a mess...",
    "created_at": "2019-12-02T16:35:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28592#issuecomment-403562",
    "user": "embray"
}
```

Shew...this build system is a mess...



---

archive/issue_comments_403563.json:
```json
{
    "body": "from my dim memories about cygwin, sometimes DLLs end up in local/bin rather than in local/bin, etc...",
    "created_at": "2019-12-02T16:43:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28592#issuecomment-403563",
    "user": "dimpase"
}
```

from my dim memories about cygwin, sometimes DLLs end up in local/bin rather than in local/bin, etc...



---

archive/issue_comments_403564.json:
```json
{
    "body": "This is the most minimal patch I could come up with for now.  It required changes in quite a few files for them to install files properly on Cygwin.  I didn't touch the libraries that use CMake (and they might already work better), or any other make targets that don't need to work for Sage's purposes.\n\nA better solution would involve a total reworking of the build system.\n\nRather than patching, I did consider just updating our `spkg-install` with some Cygwin-specific commands to move things around after the initial faulty installation.  That conceivably could have worked, but might be an even bigger and uglier mess.  I'll propose my changes, or something like it, to upstream later.\n\nStill need to test that the rest of the Sage build passes.\n----\nNew commits:",
    "created_at": "2019-12-02T18:04:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28592#issuecomment-403564",
    "user": "embray"
}
```

This is the most minimal patch I could come up with for now.  It required changes in quite a few files for them to install files properly on Cygwin.  I didn't touch the libraries that use CMake (and they might already work better), or any other make targets that don't need to work for Sage's purposes.

A better solution would involve a total reworking of the build system.

Rather than patching, I did consider just updating our `spkg-install` with some Cygwin-specific commands to move things around after the initial faulty installation.  That conceivably could have worked, but might be an even bigger and uglier mess.  I'll propose my changes, or something like it, to upstream later.

Still need to test that the rest of the Sage build passes.
----
New commits:



---

archive/issue_comments_403565.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-12-02T18:04:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28592#issuecomment-403565",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_403566.json:
```json
{
    "body": "Replying to [comment:3 dimpase]:\n> from my dim memories about cygwin, sometimes DLLs end up in local/bin rather than in local/bin, etc...\n\n\nI think you meant \"local/lib rather than in local/bin\"? :)  And yes, that was part of the problem.  It actually didn't even properly detect building on Cygwin, and the implementation of doing so (which in fairness was noted in the comments as \"untested\") was indeed completely broken.  It also didn't properly produce import libs for the DLLs, and a number of other odd issues.\n\nBeyond just the Cygwin issues though the whole thing is a bit of a mess :D",
    "created_at": "2019-12-03T10:09:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28592#issuecomment-403566",
    "user": "embray"
}
```

Replying to [comment:3 dimpase]:
> from my dim memories about cygwin, sometimes DLLs end up in local/bin rather than in local/bin, etc...


I think you meant "local/lib rather than in local/bin"? :)  And yes, that was part of the problem.  It actually didn't even properly detect building on Cygwin, and the implementation of doing so (which in fairness was noted in the comments as "untested") was indeed completely broken.  It also didn't properly produce import libs for the DLLs, and a number of other odd issues.

Beyond just the Cygwin issues though the whole thing is a bit of a mess :D



---

archive/issue_comments_403567.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-12-06T14:21:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28592#issuecomment-403567",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_403568.json:
```json
{
    "body": "Rebased to incorporate fbissey's updates to #28832.",
    "created_at": "2019-12-06T14:22:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28592#issuecomment-403568",
    "user": "embray"
}
```

Rebased to incorporate fbissey's updates to #28832.



---

archive/issue_comments_403569.json:
```json
{
    "body": "We shouldn't need `SuiteSparse_GPURuntime` or `xerbla`. One needs a config flag to be run and the other need to be explicitly build as far as I can see. The rest looks OK to me. \n\nOf course extra useless (for sage) patching doesn't hurt. Keeping as close as you would like upstream to take it is definitely OK.\n\nLet's see how it goes.",
    "created_at": "2019-12-09T20:46:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28592#issuecomment-403569",
    "user": "fbissey"
}
```

We shouldn't need `SuiteSparse_GPURuntime` or `xerbla`. One needs a config flag to be run and the other need to be explicitly build as far as I can see. The rest looks OK to me. 

Of course extra useless (for sage) patching doesn't hurt. Keeping as close as you would like upstream to take it is definitely OK.

Let's see how it goes.



---

archive/issue_comments_403570.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-12-09T20:46:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28592#issuecomment-403570",
    "user": "fbissey"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_403571.json:
```json
{
    "body": "Exactly--some of this patching was done mechanically since their sources have many copies of almost identical Makefiles (annoyingly some of them with minor, unnecessary variations).  I still intend to submit this patch (at a minimum) upstream, and maybe offer to develop a more thorough refactoring another time (especially if one of his wealthy sponsors would be willing to fund the work :)",
    "created_at": "2019-12-10T10:28:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28592#issuecomment-403571",
    "user": "embray"
}
```

Exactly--some of this patching was done mechanically since their sources have many copies of almost identical Makefiles (annoyingly some of them with minor, unnecessary variations).  I still intend to submit this patch (at a minimum) upstream, and maybe offer to develop a more thorough refactoring another time (especially if one of his wealthy sponsors would be willing to fund the work :)



---

archive/issue_comments_403572.json:
```json
{
    "body": "maybe it's more meaningful to use cmake with https://github.com/jlblancoc/suitesparse-metis-for-windows (despite the name, it's cross-platform, and endorsed by the suitesparse author).",
    "created_at": "2019-12-10T11:40:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28592#issuecomment-403572",
    "user": "dimpase"
}
```

maybe it's more meaningful to use cmake with https://github.com/jlblancoc/suitesparse-metis-for-windows (despite the name, it's cross-platform, and endorsed by the suitesparse author).



---

archive/issue_comments_403573.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-12-11T21:46:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28592",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28592#issuecomment-403573",
    "user": "vbraun"
}
```

Resolution: fixed
