# Issue 29713: Build sagelib using the installed sage_setup

archive/issues_029713.json:
```json
{
    "body": "CC:  @kiwifb @jhpalmieri @dimpase @kliem @isuruf @vbraun\n\nAfter #29411 and #29847, we set up a separate directory `build/pkgs/sagelib/src` with symlinks into `SAGE_ROOT/src` so that sagelib's `setup.py` does not have access to the whole tree `SAGE_ROOT/src`. In particular, we arrange for the installed `sage_setup` (#29847), rather than the one from the source tree, to be used.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29950\n\n",
    "created_at": "2020-06-24T02:12:57Z",
    "labels": [
        "refactoring",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Build sagelib using the installed sage_setup",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29713",
    "user": "@mkoeppe"
}
```
CC:  @kiwifb @jhpalmieri @dimpase @kliem @isuruf @vbraun

After #29411 and #29847, we set up a separate directory `build/pkgs/sagelib/src` with symlinks into `SAGE_ROOT/src` so that sagelib's `setup.py` does not have access to the whole tree `SAGE_ROOT/src`. In particular, we arrange for the installed `sage_setup` (#29847), rather than the one from the source tree, to be used.

Issue created by migration from https://trac.sagemath.org/ticket/29950





---

archive/issue_comments_422055.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-06-24T02:32:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422055",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_422056.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-25T06:32:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422056",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_422057.json:
```json
{
    "body": "sdist is broken: Files named `**` end up in the tar file.",
    "created_at": "2020-06-28T16:25:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422057",
    "user": "@mkoeppe"
}
```

sdist is broken: Files named `**` end up in the tar file.



---

archive/issue_comments_422058.json:
```json
{
    "body": "https://github.com/sagemath/cypari2/issues/93",
    "created_at": "2020-06-28T18:18:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422058",
    "user": "@mkoeppe"
}
```

https://github.com/sagemath/cypari2/issues/93



---

archive/issue_comments_422059.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2020-06-28T18:26:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422059",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_422060.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-06-28T19:04:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422060",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_422061.json:
```json
{
    "body": "\n```\n    from .maxima import maxima, Maxima\n  File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src/.tox/python/lib/python3.7/site-packages/sage/interfaces/maxima.py\", line 1236, in <module>\n    script_subdirectory=None)\n  File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src/.tox/python/lib/python3.7/site-packages/sage/interfaces/maxima.py\", line 528, in __init__\n    raise RuntimeError('You must get the file local/bin/sage-maxima.lisp')\nRuntimeError: You must get the file local/bin/sage-maxima.lisp\n```\n",
    "created_at": "2020-06-28T19:07:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422061",
    "user": "@mkoeppe"
}
```


```
    from .maxima import maxima, Maxima
  File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src/.tox/python/lib/python3.7/site-packages/sage/interfaces/maxima.py", line 1236, in <module>
    script_subdirectory=None)
  File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src/.tox/python/lib/python3.7/site-packages/sage/interfaces/maxima.py", line 528, in __init__
    raise RuntimeError('You must get the file local/bin/sage-maxima.lisp')
RuntimeError: You must get the file local/bin/sage-maxima.lisp
```




---

archive/issue_comments_422062.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2020-06-28T19:19:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422062",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_422063.json:
```json
{
    "body": "\n```\n./sage -sh -c '(cd build/pkgs/sagelib/src && tox -r -v -v)'\n...\nRuntimeError: libSingular not found--a working Singular install in $SAGE_LOCAL is required for Sage to work\nERROR: InvocationError for command /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src/.tox/python/bin/python -c 'import sys; \"\" in sys.path and sys.path.remove(\"\"); import sage.all' (exited with code 1)\n```\n\n\nThis is because of:\n\n```\n$ build/pkgs/sagelib/src/.tox/python/bin/python\nPython 3.7.7 (v3.7.7:d7c567b08f, Mar 10 2020, 02:56:16) \n[Clang 6.0 (clang-600.0.57)] on darwin\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import sage.env\n>>> sage.env.SINGULAR_SO\n>>> sage.env.GAP_SO\n>>> sage.env.SAGE_LOCAL\n'/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src/.tox/python'\n>>> \n```\n",
    "created_at": "2020-06-28T20:36:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422063",
    "user": "@mkoeppe"
}
```


```
./sage -sh -c '(cd build/pkgs/sagelib/src && tox -r -v -v)'
...
RuntimeError: libSingular not found--a working Singular install in $SAGE_LOCAL is required for Sage to work
ERROR: InvocationError for command /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src/.tox/python/bin/python -c 'import sys; "" in sys.path and sys.path.remove(""); import sage.all' (exited with code 1)
```


This is because of:

```
$ build/pkgs/sagelib/src/.tox/python/bin/python
Python 3.7.7 (v3.7.7:d7c567b08f, Mar 10 2020, 02:56:16) 
[Clang 6.0 (clang-600.0.57)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> import sage.env
>>> sage.env.SINGULAR_SO
>>> sage.env.GAP_SO
>>> sage.env.SAGE_LOCAL
'/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src/.tox/python'
>>> 
```




---

archive/issue_comments_422064.json:
```json
{
    "body": "Passing the correct `SAGE_LOCAL` suffices to fix this, of course. But the singular library location should be configured separately (#29024).",
    "created_at": "2020-06-28T20:48:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422064",
    "user": "@mkoeppe"
}
```

Passing the correct `SAGE_LOCAL` suffices to fix this, of course. But the singular library location should be configured separately (#29024).



---

archive/issue_comments_422065.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-28T20:48:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422065",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_422066.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-28T22:52:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422066",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_422067.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-06-28T23:08:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422067",
    "user": "@mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_422068.json:
```json
{
    "body": "The `sage` script relies on `PATH` to be set correctly when invoking auxiliary scripts such as `sage-eval`.  Hence the following does not work correctly:\n\n```\n$ ./sage -sh -c 'build/pkgs/sagelib/src/.tox/python/bin/sage -c \"print(sys.path)\"'\n['/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/bin', '/Library/Frameworks/Python.framework/Versions/3.7/lib/python37.zip', '/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7', '/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/lib-dynload', '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages']\n```\n",
    "created_at": "2020-06-28T23:54:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422068",
    "user": "@mkoeppe"
}
```

The `sage` script relies on `PATH` to be set correctly when invoking auxiliary scripts such as `sage-eval`.  Hence the following does not work correctly:

```
$ ./sage -sh -c 'build/pkgs/sagelib/src/.tox/python/bin/sage -c "print(sys.path)"'
['/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/bin', '/Library/Frameworks/Python.framework/Versions/3.7/lib/python37.zip', '/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7', '/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/lib-dynload', '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages']
```




---

archive/issue_comments_422069.json:
```json
{
    "body": "This will be fixed by #30013 (`src/bin/sage-env`: Make sure `SAGE_SCRIPTS_DIR` is at the beginning of the `PATH`).",
    "created_at": "2020-06-29T00:10:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422069",
    "user": "@mkoeppe"
}
```

This will be fixed by #30013 (`src/bin/sage-env`: Make sure `SAGE_SCRIPTS_DIR` is at the beginning of the `PATH`).



---

archive/issue_comments_422070.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-06-29T00:11:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422070",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_422071.json:
```json
{
    "body": "All dependencies of this ticket are green. Ready for review.",
    "created_at": "2020-07-02T20:14:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422071",
    "user": "@mkoeppe"
}
```

All dependencies of this ticket are green. Ready for review.



---

archive/issue_comments_422072.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-04T16:30:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422072",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_422073.json:
```json
{
    "body": "Merged in latest versions #29701, #21559 (on top of 9.2.beta3). Needs review",
    "created_at": "2020-07-04T16:31:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422073",
    "user": "@mkoeppe"
}
```

Merged in latest versions #29701, #21559 (on top of 9.2.beta3). Needs review



---

archive/issue_comments_422074.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-08T23:26:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422074",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_422075.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-03T00:53:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422075",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_422076.json:
```json
{
    "body": "lgtm",
    "created_at": "2020-08-05T08:22:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422076",
    "user": "@dimpase"
}
```

lgtm



---

archive/issue_comments_422077.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-05T08:22:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422077",
    "user": "@dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_422078.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-08-08T20:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422078",
    "user": "@mkoeppe"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_422079.json:
```json
{
    "body": "Failing doctest needs work as noted in #29701.",
    "created_at": "2020-08-08T20:50:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422079",
    "user": "@mkoeppe"
}
```

Failing doctest needs work as noted in #29701.



---

archive/issue_comments_422080.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-08T22:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422080",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_422081.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-08-08T23:08:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422081",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_422082.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-08-08T23:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422082",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_422083.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-10T16:45:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422083",
    "user": "@dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_422084.json:
```json
{
    "body": "ok",
    "created_at": "2020-08-10T16:45:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422084",
    "user": "@dimpase"
}
```

ok



---

archive/issue_comments_422085.json:
```json
{
    "body": "Thanks!",
    "created_at": "2020-08-10T16:51:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422085",
    "user": "@mkoeppe"
}
```

Thanks!



---

archive/issue_comments_422086.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-08-12T19:53:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29713",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29713#issuecomment-422086",
    "user": "@vbraun"
}
```

Resolution: fixed
