# Issue 29713: Build sagelib using the installed sage_setup

Issue created by migration from https://trac.sagemath.org/ticket/29950

Original creator: mkoeppe

Original creation time: 2020-06-24 02:12:57

CC:  fbissey jhpalmieri dimpase @kliem isuruf vbraun

After #29411 and #29847, we set up a separate directory `build/pkgs/sagelib/src` with symlinks into `SAGE_ROOT/src` so that sagelib's `setup.py` does not have access to the whole tree `SAGE_ROOT/src`. In particular, we arrange for the installed `sage_setup` (#29847), rather than the one from the source tree, to be used.


---

Comment by git created at 2020-06-24 02:32:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-06-25 06:32:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-28 16:25:48

sdist is broken: Files named `**` end up in the tar file.


---

Comment by mkoeppe created at 2020-06-28 18:18:26

https://github.com/sagemath/cypari2/issues/93


---

Comment by git created at 2020-06-28 18:26:50

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2020-06-28 19:04:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-06-28 19:07:03


```
    from .maxima import maxima, Maxima
  File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src/.tox/python/lib/python3.7/site-packages/sage/interfaces/maxima.py", line 1236, in <module>
    script_subdirectory=None)
  File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src/.tox/python/lib/python3.7/site-packages/sage/interfaces/maxima.py", line 528, in __init__
    raise RuntimeError('You must get the file local/bin/sage-maxima.lisp')
RuntimeError: You must get the file local/bin/sage-maxima.lisp
```



---

Comment by git created at 2020-06-28 19:19:31

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2020-06-28 20:36:14


```
./sage -sh -c '(cd build/pkgs/sagelib/src && tox -r -v -v)'
...
RuntimeError: libSingular not found--a working Singular install in $SAGE_LOCAL is required for Sage to work
ERROR: InvocationError for command /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src/.tox/python/bin/python -c 'import sys; "" in sys.path and sys.path.remove(""); import sage.all' (exited with code 1)
```


This is because of:

```
$ build/pkgs/sagelib/src/.tox/python/bin/python
Python 3.7.7 (v3.7.7:d7c567b08f, Mar 10 2020, 02:56:16) 
[Clang 6.0 (clang-600.0.57)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> import sage.env
>>> sage.env.SINGULAR_SO
>>> sage.env.GAP_SO
>>> sage.env.SAGE_LOCAL
'/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sagelib/src/.tox/python'
>>> 
```



---

Comment by mkoeppe created at 2020-06-28 20:48:08

Passing the correct `SAGE_LOCAL` suffices to fix this, of course. But the singular library location should be configured separately (#29024).


---

Comment by git created at 2020-06-28 20:48:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-28 22:52:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-28 23:08:44

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-06-28 23:54:57

The `sage` script relies on `PATH` to be set correctly when invoking auxiliary scripts such as `sage-eval`.  Hence the following does not work correctly:

```
$ ./sage -sh -c 'build/pkgs/sagelib/src/.tox/python/bin/sage -c "print(sys.path)"'
['/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/src/bin', '/Library/Frameworks/Python.framework/Versions/3.7/lib/python37.zip', '/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7', '/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/lib-dynload', '/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.7/site-packages']
```



---

Comment by mkoeppe created at 2020-06-29 00:10:35

This will be fixed by #30013 (`src/bin/sage-env`: Make sure `SAGE_SCRIPTS_DIR` is at the beginning of the `PATH`).


---

Comment by git created at 2020-06-29 00:11:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-02 20:14:58

All dependencies of this ticket are green. Ready for review.


---

Comment by git created at 2020-07-04 16:30:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-04 16:31:17

Merged in latest versions #29701, #21559 (on top of 9.2.beta3). Needs review


---

Comment by git created at 2020-07-08 23:26:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-03 00:53:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-08-05 08:22:44

lgtm


---

Comment by dimpase created at 2020-08-05 08:22:44

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-08-08 20:50:05

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2020-08-08 20:50:05

Failing doctest needs work as noted in #29701.


---

Comment by git created at 2020-08-08 22:50:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-08 23:08:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-08 23:11:32

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2020-08-10 16:45:25

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-08-10 16:45:25

ok


---

Comment by mkoeppe created at 2020-08-10 16:51:20

Thanks!


---

Comment by vbraun created at 2020-08-12 19:53:18

Resolution: fixed
