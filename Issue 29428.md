# Issue 29428: spkg-configure.m4 for cvxopt

archive/issues_029428.json:
```json
{
    "body": "Keywords: cvxopt; spkg-configure; system packages; Python library\n\nThis ticket adds an spkg-configure.m4 for cvxopt, in order to use it from a system package if possible (see #27330).\n\nThis one is a bit special, because cvxopt is a Python module.\n\nThe proposed attachment uses `python3`: I don\u00b4t like that, but at this point `$ac_path_PYTHON3` is not yet defined. (Note: on FreeBSD we have no python3 by default, and I have to patch it with the real versioned program name, but I guess that `python3` is more portable)\n\nTo build Sage with it, `build/make/install` must be modified: it sets `PYTHONPATH` to `$SAGE_LOCAL`, and the system-wide Python modules are not found. It must be replaced by something like\n\n\n```\n\"$SAGE_LOCAL:$SAGE_LOCAL/$PYTHON_SITELIBDIR:$PYTHON_SITELIBDIR\"\n```\n\n\nwith `$PYTHON_SITELIBDIR` being the site-packages directory used. So the Sage-built packages are always found in the first place, and those from the system are found when needed.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29665\n\n",
    "created_at": "2020-05-08T14:40:42Z",
    "labels": [
        "build: configure",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-pending",
    "title": "spkg-configure.m4 for cvxopt",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29428",
    "user": "@thierry-FreeBSD"
}
```
Keywords: cvxopt; spkg-configure; system packages; Python library

This ticket adds an spkg-configure.m4 for cvxopt, in order to use it from a system package if possible (see #27330).

This one is a bit special, because cvxopt is a Python module.

The proposed attachment uses `python3`: I donÂ´t like that, but at this point `$ac_path_PYTHON3` is not yet defined. (Note: on FreeBSD we have no python3 by default, and I have to patch it with the real versioned program name, but I guess that `python3` is more portable)

To build Sage with it, `build/make/install` must be modified: it sets `PYTHONPATH` to `$SAGE_LOCAL`, and the system-wide Python modules are not found. It must be replaced by something like


```
"$SAGE_LOCAL:$SAGE_LOCAL/$PYTHON_SITELIBDIR:$PYTHON_SITELIBDIR"
```


with `$PYTHON_SITELIBDIR` being the site-packages directory used. So the Sage-built packages are always found in the first place, and those from the system are found when needed.

Issue created by migration from https://trac.sagemath.org/ticket/29665





---

archive/issue_comments_417514.json:
```json
{
    "body": "spkg-configure.m4 to be copied under build/pkgs/cvxopt",
    "created_at": "2020-05-08T14:42:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417514",
    "user": "@thierry-FreeBSD"
}
```

spkg-configure.m4 to be copied under build/pkgs/cvxopt



---

archive/issue_comments_417515.json:
```json
{
    "body": "Attachment [spkg-configure.m4](tarball://root/attachments/some-uuid/ticket29665/spkg-configure.m4) by mkoeppe created at 2020-05-08 14:56:07\n\nI don't see a branch",
    "created_at": "2020-05-08T14:56:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417515",
    "user": "mkoeppe"
}
```

Attachment [spkg-configure.m4](tarball://root/attachments/some-uuid/ticket29665/spkg-configure.m4) by mkoeppe created at 2020-05-08 14:56:07

I don't see a branch



---

archive/issue_comments_417516.json:
```json
{
    "body": "See comments in #29023",
    "created_at": "2020-05-08T15:36:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417516",
    "user": "mkoeppe"
}
```

See comments in #29023



---

archive/issue_comments_417517.json:
```json
{
    "body": "\"wontfix\" because of #29023\n----\nNew commits:",
    "created_at": "2020-08-11T17:37:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417517",
    "user": "mkoeppe"
}
```

"wontfix" because of #29023
----
New commits:



---

archive/issue_comments_417518.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-08-11T17:37:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417518",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_417519.json:
```json
{
    "body": "There is per se nothing wrong with having spkg-configure.m4 for Python packages.",
    "created_at": "2020-08-13T09:07:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417519",
    "user": "dimpase"
}
```

There is per se nothing wrong with having spkg-configure.m4 for Python packages.



---

archive/issue_comments_417520.json:
```json
{
    "body": "Not per se, only per the big picture.",
    "created_at": "2020-08-13T14:51:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417520",
    "user": "mkoeppe"
}
```

Not per se, only per the big picture.



---

archive/issue_comments_417521.json:
```json
{
    "body": "Regardless of what we eventually wind up with... does this work? Does it hurt anything? The solution in #29023 could be years away. If we can avoid building e.g. numpy, scipy, matplotlib, and cvxopt with relatively trivial spkg-configures until then, why not do it?",
    "created_at": "2021-09-18T18:04:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417521",
    "user": "mjo"
}
```

Regardless of what we eventually wind up with... does this work? Does it hurt anything? The solution in #29023 could be years away. If we can avoid building e.g. numpy, scipy, matplotlib, and cvxopt with relatively trivial spkg-configures until then, why not do it?



---

archive/issue_comments_417522.json:
```json
{
    "body": "No, it does not work.",
    "created_at": "2021-09-18T18:08:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417522",
    "user": "mkoeppe"
}
```

No, it does not work.



---

archive/issue_comments_417523.json:
```json
{
    "body": "Replying to [comment:8 mkoeppe]:\n> No, it does not work. \n\nWhat goes wrong? I just did a quick test (without this branch):\n\n1. make cvxopt-clean\n2. install system cvxopt\n3. touch any file in sagelib names `*cvxopt*`\n4. sage -b\n5. run some tests on said cvxopt files\n\nBehavior is unchanged as far as I can tell.",
    "created_at": "2021-09-19T00:12:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417523",
    "user": "mjo"
}
```

Replying to [comment:8 mkoeppe]:
> No, it does not work. 

What goes wrong? I just did a quick test (without this branch):

1. make cvxopt-clean
2. install system cvxopt
3. touch any file in sagelib names `*cvxopt*`
4. sage -b
5. run some tests on said cvxopt files

Behavior is unchanged as far as I can tell.



---

archive/issue_comments_417524.json:
```json
{
    "body": "Sound like you forgot to test with `--optional=sage,cvxopt`. \n\nSage runs in a venv that does not provide access to system site packages.",
    "created_at": "2021-09-19T00:17:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417524",
    "user": "mkoeppe"
}
```

Sound like you forgot to test with `--optional=sage,cvxopt`. 

Sage runs in a venv that does not provide access to system site packages.



---

archive/issue_comments_417525.json:
```json
{
    "body": "Replying to [comment:10 mkoeppe]:\n> Sound like you forgot to test with `--optional=sage,cvxopt`. \n> \n> Sage runs in a venv that does not provide access to system site packages.\n\nLucky guess! I forgot we made it possible to disable cvxopt even though it's type=standard. On the surface, setting  `include-system-site-packages = true` in `local/pyvenv.cfg` looks like it solves that, and is one of the first steps mentioned on #29023. What necessitates the next step B.2. in #29023? In other words, what's the next thing that's going to go wrong for me?",
    "created_at": "2021-09-19T00:57:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417525",
    "user": "mjo"
}
```

Replying to [comment:10 mkoeppe]:
> Sound like you forgot to test with `--optional=sage,cvxopt`. 
> 
> Sage runs in a venv that does not provide access to system site packages.

Lucky guess! I forgot we made it possible to disable cvxopt even though it's type=standard. On the surface, setting  `include-system-site-packages = true` in `local/pyvenv.cfg` looks like it solves that, and is one of the first steps mentioned on #29023. What necessitates the next step B.2. in #29023? In other words, what's the next thing that's going to go wrong for me?



---

archive/issue_comments_417526.json:
```json
{
    "body": "Let's take the discussion of #29023 to #29023. I think it would be fine if you want to go ahead with step B.1 (via a new option `./configure --enable-system-site-packages`) in a ticket, for users to experiment.",
    "created_at": "2021-09-19T01:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417526",
    "user": "mkoeppe"
}
```

Let's take the discussion of #29023 to #29023. I think it would be fine if you want to go ahead with step B.1 (via a new option `./configure --enable-system-site-packages`) in a ticket, for users to experiment.



---

archive/issue_comments_417527.json:
```json
{
    "body": "Matthias, does something like this fit with your master plan?\n----\nLast 10 new commits:",
    "created_at": "2021-10-11T13:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417527",
    "user": "mjo"
}
```

Matthias, does something like this fit with your master plan?
----
Last 10 new commits:



---

archive/issue_comments_417528.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-10-11T13:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417528",
    "user": "mjo"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_417529.json:
```json
{
    "body": "I wouldn't object to doing something like this, as it is clearly marked experimental.\n\nHowever, be prepared for a long-term burden of maintenance regarding the declared version ranges. Lots of things can go wrong because the individual packages often have complicated version constraints.\n\nAlso the version constraints shouldn't be hardcoded in the spkg-configure.m4 file; instead, they should really be taken from `install-requires.txt`.\nLikewise, don't use distutils, it's on its way out. Use a higher-level library that can check the requirements\n\nAlso, note `scandir` is gone after #32626",
    "created_at": "2021-10-11T17:13:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417529",
    "user": "mkoeppe"
}
```

I wouldn't object to doing something like this, as it is clearly marked experimental.

However, be prepared for a long-term burden of maintenance regarding the declared version ranges. Lots of things can go wrong because the individual packages often have complicated version constraints.

Also the version constraints shouldn't be hardcoded in the spkg-configure.m4 file; instead, they should really be taken from `install-requires.txt`.
Likewise, don't use distutils, it's on its way out. Use a higher-level library that can check the requirements

Also, note `scandir` is gone after #32626



---

archive/issue_comments_417530.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2021-10-12T14:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417530",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_417531.json:
```json
{
    "body": "Replying to [comment:14 mkoeppe]:\n> \n> However, be prepared for a long-term burden of maintenance regarding the declared version ranges. Lots of things can go wrong because the individual packages often have complicated version constraints.\n\nHow so? The version information is maintained separately in `install-requires.txt`. And on Gentoo, most of these packages are already present and maintained by somebody else.\n\n> Also the version constraints shouldn't be hardcoded in the spkg-configure.m4 file; instead, they should really be taken from `install-requires.txt`.\n\nDone.\n\n> Likewise, don't use distutils, it's on its way out. Use a higher-level library that can check the requirements\n\nI'm using setuptools now, because I figure it (with its vendored \"packaging\") is more likely to be present than the \"packaging\" package itself.\n\n> Also, note `scandir` is gone after #32626\n\nThanks, I dropped that one, and added a few more.",
    "created_at": "2021-10-12T14:13:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417531",
    "user": "mjo"
}
```

Replying to [comment:14 mkoeppe]:
> 
> However, be prepared for a long-term burden of maintenance regarding the declared version ranges. Lots of things can go wrong because the individual packages often have complicated version constraints.

How so? The version information is maintained separately in `install-requires.txt`. And on Gentoo, most of these packages are already present and maintained by somebody else.

> Also the version constraints shouldn't be hardcoded in the spkg-configure.m4 file; instead, they should really be taken from `install-requires.txt`.

Done.

> Likewise, don't use distutils, it's on its way out. Use a higher-level library that can check the requirements

I'm using setuptools now, because I figure it (with its vendored "packaging") is more likely to be present than the "packaging" package itself.

> Also, note `scandir` is gone after #32626

Thanks, I dropped that one, and added a few more.



---

archive/issue_comments_417532.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-10-12T14:13:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417532",
    "user": "mjo"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_417533.json:
```json
{
    "body": "Replying to [comment:17 mjo]:\n> Replying to [comment:14 mkoeppe]:\n> > \n> > However, be prepared for a long-term burden of maintenance regarding the declared version ranges. Lots of things can go wrong because the individual packages often have complicated version constraints.\n> \n> How so? The version information is maintained separately in `install-requires.txt`. And on Gentoo, most of these packages are already present and maintained by somebody else.\n\nThe metadata in these packages (distributions published on PyPI) declares install-requires as well. pip's resolver inspects all of these version constraints.",
    "created_at": "2021-10-12T16:22:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417533",
    "user": "mkoeppe"
}
```

Replying to [comment:17 mjo]:
> Replying to [comment:14 mkoeppe]:
> > 
> > However, be prepared for a long-term burden of maintenance regarding the declared version ranges. Lots of things can go wrong because the individual packages often have complicated version constraints.
> 
> How so? The version information is maintained separately in `install-requires.txt`. And on Gentoo, most of these packages are already present and maintained by somebody else.

The metadata in these packages (distributions published on PyPI) declares install-requires as well. pip's resolver inspects all of these version constraints.



---

archive/issue_comments_417534.json:
```json
{
    "body": "Could you update the ticket description please?",
    "created_at": "2021-10-12T16:26:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417534",
    "user": "mkoeppe"
}
```

Could you update the ticket description please?



---

archive/issue_comments_417535.json:
```json
{
    "body": "With #32442, which sets up `SAGE_VENV = SAGE_LOCAL/var/lib/sage/venv-PYTHONVERSION` by default, one could consider to use a suffix `+site` in the case that `--enable-system-site-packages` was used.",
    "created_at": "2021-10-12T16:47:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417535",
    "user": "mkoeppe"
}
```

With #32442, which sets up `SAGE_VENV = SAGE_LOCAL/var/lib/sage/venv-PYTHONVERSION` by default, one could consider to use a suffix `+site` in the case that `--enable-system-site-packages` was used.



---

archive/issue_comments_417536.json:
```json
{
    "body": "Also, when `--enable-system-site-packages` has been given but system python3 is not used, this should be an error.",
    "created_at": "2021-10-12T17:15:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417536",
    "user": "mkoeppe"
}
```

Also, when `--enable-system-site-packages` has been given but system python3 is not used, this should be an error.



---

archive/issue_comments_417537.json:
```json
{
    "body": "Replying to [comment:22 mkoeppe]:\n> Also, when `--enable-system-site-packages` has been given but system python3 is not used, this should be an error.\n\nI think this is working as intended, but I still have to check it with python3 installed from an SPKG. The intention is that `--enable-system-site-packages` will only attempt to use packages from the system; not force it. If we're using python from the SPKG, the macro should always fail (this is in its documentation), and thus we'll use SPKGs for all of the python stuff.\n\nI don't think we need to bail out with an error unless that process can somehow do the wrong thing?",
    "created_at": "2021-10-13T12:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417537",
    "user": "mjo"
}
```

Replying to [comment:22 mkoeppe]:
> Also, when `--enable-system-site-packages` has been given but system python3 is not used, this should be an error.

I think this is working as intended, but I still have to check it with python3 installed from an SPKG. The intention is that `--enable-system-site-packages` will only attempt to use packages from the system; not force it. If we're using python from the SPKG, the macro should always fail (this is in its documentation), and thus we'll use SPKGs for all of the python stuff.

I don't think we need to bail out with an error unless that process can somehow do the wrong thing?



---

archive/issue_comments_417538.json:
```json
{
    "body": "User expectations -- users may be interested in this option because they want to actually use system Python packages (which we don't have as SPKG), not just save time on installation. So it's best to tell them upfront that it won't work, instead of making them go through an hours-long build and failure and mailing list Q&A.",
    "created_at": "2021-10-13T16:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417538",
    "user": "mkoeppe"
}
```

User expectations -- users may be interested in this option because they want to actually use system Python packages (which we don't have as SPKG), not just save time on installation. So it's best to tell them upfront that it won't work, instead of making them go through an hours-long build and failure and mailing list Q&A.



---

archive/issue_comments_417539.json:
```json
{
    "body": "Replying to [comment:25 mkoeppe]:\n> User expectations -- users may be interested in this option because they want to actually use system Python packages (which we don't have as SPKG), not just save time on installation. So it's best to tell them upfront that it won't work, instead of making them go through an hours-long build and failure and mailing list Q&A.\n\nWe could make that possible with another option, like `--enable-user-site-packages`, that would undo the intentional breakage in sage-env:\n\n\n```python\n# Set PYTHONUSERBASE to avoid picking up non-Sage versions of\n# Matplotlib, numpy, etc. See http://trac.sagemath.org/ticket/19612.\n#\n# For more history (it used to be PYTHONNOUSERSITE=yes which killed\n# the ability to do \"sage -pip install PACKAGE --user\"), see\n# http://trac.sagemath.org/ticket/14243 and\n# http://trac.sagemath.org/ticket/18955.\n\nif [ \"$PYTHONUSERBASE\" = \"\" ]; then\n    PYTHONUSERBASE=\"$DOT_SAGE/local\"\n    export PYTHONUSERBASE\nfi\n```\n\n\nThe \"system\" site packages do work either way... you're just getting a different \"system\" with the SPKG than you would with `/usr/bin/python3`. Regardless, I only build with `--with-system-python3=force`, so I won't belabor this distinction.\n\nI'll change `--enable-system-site-packages` to set `--with-system-python3=force`.",
    "created_at": "2021-10-13T17:26:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417539",
    "user": "mjo"
}
```

Replying to [comment:25 mkoeppe]:
> User expectations -- users may be interested in this option because they want to actually use system Python packages (which we don't have as SPKG), not just save time on installation. So it's best to tell them upfront that it won't work, instead of making them go through an hours-long build and failure and mailing list Q&A.

We could make that possible with another option, like `--enable-user-site-packages`, that would undo the intentional breakage in sage-env:


```python
# Set PYTHONUSERBASE to avoid picking up non-Sage versions of
# Matplotlib, numpy, etc. See http://trac.sagemath.org/ticket/19612.
#
# For more history (it used to be PYTHONNOUSERSITE=yes which killed
# the ability to do "sage -pip install PACKAGE --user"), see
# http://trac.sagemath.org/ticket/14243 and
# http://trac.sagemath.org/ticket/18955.

if [ "$PYTHONUSERBASE" = "" ]; then
    PYTHONUSERBASE="$DOT_SAGE/local"
    export PYTHONUSERBASE
fi
```


The "system" site packages do work either way... you're just getting a different "system" with the SPKG than you would with `/usr/bin/python3`. Regardless, I only build with `--with-system-python3=force`, so I won't belabor this distinction.

I'll change `--enable-system-site-packages` to set `--with-system-python3=force`.



---

archive/issue_comments_417540.json:
```json
{
    "body": "I was talking about system site packages.\n\nReplying to [comment:26 mjo]:\n> The \"system\" site packages do work either way... you're just getting a different \"system\" with the SPKG than you would with `/usr/bin/python3`. \n\nI know that, you know that, I know that you know that, etc., but users don't.\n\n> I'll change `--enable-system-site-packages` to set `--with-system-python3=force`.\n\nGreat, thanks.",
    "created_at": "2021-10-13T17:40:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417540",
    "user": "mkoeppe"
}
```

I was talking about system site packages.

Replying to [comment:26 mjo]:
> The "system" site packages do work either way... you're just getting a different "system" with the SPKG than you would with `/usr/bin/python3`. 

I know that, you know that, I know that you know that, etc., but users don't.

> I'll change `--enable-system-site-packages` to set `--with-system-python3=force`.

Great, thanks.



---

archive/issue_comments_417541.json:
```json
{
    "body": "Replying to [comment:26 mjo]:\n> another option, like `--enable-user-site-packages`, that would undo the intentional breakage in sage-env:\n> \n> {{{#!python\n> # Set PYTHONUSERBASE to avoid picking up non-Sage versions of\n\nActually in venvs, the user scheme is altogether disabled by Python - see https://packaging.python.org/tutorials/installing-packages/#installing-to-the-user-site",
    "created_at": "2021-10-13T17:41:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417541",
    "user": "mkoeppe"
}
```

Replying to [comment:26 mjo]:
> another option, like `--enable-user-site-packages`, that would undo the intentional breakage in sage-env:
> 
> {{{#!python
> # Set PYTHONUSERBASE to avoid picking up non-Sage versions of

Actually in venvs, the user scheme is altogether disabled by Python - see https://packaging.python.org/tutorials/installing-packages/#installing-to-the-user-site



---

archive/issue_comments_417542.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-14T12:15:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417542",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_417543.json:
```json
{
    "body": "Feels too easy for something involving autotools, but that last commit looks like it does the trick.",
    "created_at": "2021-10-14T12:16:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417543",
    "user": "mjo"
}
```

Feels too easy for something involving autotools, but that last commit looks like it does the trick.



---

archive/issue_comments_417544.json:
```json
{
    "body": "The next thing is that at the end of configure, it now recommends to install system python packages -- which is useless (unless the experimental new option is used) and potentially will confuse users.",
    "created_at": "2021-10-14T20:43:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417544",
    "user": "mkoeppe"
}
```

The next thing is that at the end of configure, it now recommends to install system python packages -- which is useless (unless the experimental new option is used) and potentially will confuse users.



---

archive/issue_comments_417545.json:
```json
{
    "body": "So perhaps instead of supplying `spkg-configure.m4` files, in `m4/sage_spkg_collect.m4` if a package does not have `spkg-configure.m4` but it has `install-requires.txt`, just run the test?",
    "created_at": "2021-10-14T20:57:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417545",
    "user": "mkoeppe"
}
```

So perhaps instead of supplying `spkg-configure.m4` files, in `m4/sage_spkg_collect.m4` if a package does not have `spkg-configure.m4` but it has `install-requires.txt`, just run the test?



---

archive/issue_comments_417546.json:
```json
{
    "body": "is it distinguishing system and user-installed python packages?",
    "created_at": "2021-10-14T20:59:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417546",
    "user": "dimpase"
}
```

is it distinguishing system and user-installed python packages?



---

archive/issue_comments_417547.json:
```json
{
    "body": "see comment:28",
    "created_at": "2021-10-14T21:06:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417547",
    "user": "mkoeppe"
}
```

see comment:28



---

archive/issue_comments_417548.json:
```json
{
    "body": "The new test in m4/sage_python_package_check.m4 should really be run with a venv, not the `PYTHON_FOR_VENV` directly -- or, as per Dima's comment, you would need to poison the user scheme in another way, so that the configure test does not take user packages into account.",
    "created_at": "2021-10-14T21:08:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417548",
    "user": "mkoeppe"
}
```

The new test in m4/sage_python_package_check.m4 should really be run with a venv, not the `PYTHON_FOR_VENV` directly -- or, as per Dima's comment, you would need to poison the user scheme in another way, so that the configure test does not take user packages into account.



---

archive/issue_comments_417549.json:
```json
{
    "body": "An easy way to do this is could be to run these tests as part of the `python3` spkg-configure.m4, which already creates a venv for testing",
    "created_at": "2021-10-14T22:45:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417549",
    "user": "mkoeppe"
}
```

An easy way to do this is could be to run these tests as part of the `python3` spkg-configure.m4, which already creates a venv for testing



---

archive/issue_comments_417550.json:
```json
{
    "body": "Replying to [comment:31 mkoeppe]:\n> The next thing is that at the end of configure, it now recommends to install system python packages -- which is useless (unless the experimental new option is used) and potentially will confuse users.\n\nThis, at least, is easy: we can delete `distros/` for the python packages all in one commit. Then whenever we intend to actually use that information, it can be `git revert`ed.",
    "created_at": "2021-10-14T22:54:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417550",
    "user": "mjo"
}
```

Replying to [comment:31 mkoeppe]:
> The next thing is that at the end of configure, it now recommends to install system python packages -- which is useless (unless the experimental new option is used) and potentially will confuse users.

This, at least, is easy: we can delete `distros/` for the python packages all in one commit. Then whenever we intend to actually use that information, it can be `git revert`ed.



---

archive/issue_comments_417551.json:
```json
{
    "body": "Replying to [comment:35 mkoeppe]:\n> The new test in m4/sage_python_package_check.m4 should really be run with a venv, not the `PYTHON_FOR_VENV` directly -- or, as per Dima's comment, you would need to poison the user scheme in another way, so that the configure test does not take user packages into account.\n\nShould we not poison `PYTHONUSERBASE` in the same way that sage-env does it? That way the test and what you get at runtime is at least consistent.",
    "created_at": "2021-10-14T22:56:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417551",
    "user": "mjo"
}
```

Replying to [comment:35 mkoeppe]:
> The new test in m4/sage_python_package_check.m4 should really be run with a venv, not the `PYTHON_FOR_VENV` directly -- or, as per Dima's comment, you would need to poison the user scheme in another way, so that the configure test does not take user packages into account.

Should we not poison `PYTHONUSERBASE` in the same way that sage-env does it? That way the test and what you get at runtime is at least consistent.



---

archive/issue_comments_417552.json:
```json
{
    "body": "No, see comment:28: `PYTHONUSERBASE` does not matter because for venvs, the user installation scheme is already disabled by Python.",
    "created_at": "2021-10-15T03:37:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417552",
    "user": "mkoeppe"
}
```

No, see comment:28: `PYTHONUSERBASE` does not matter because for venvs, the user installation scheme is already disabled by Python.



---

archive/issue_comments_417553.json:
```json
{
    "body": "Replying to [comment:39 mkoeppe]:\n> No, see comment:28: `PYTHONUSERBASE` does not matter because for venvs, the user installation scheme is already disabled by Python.\n\nOh, right. Do you see any reason why I shouldn't delete that code from sage-env, then?",
    "created_at": "2021-10-15T03:47:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417553",
    "user": "mjo"
}
```

Replying to [comment:39 mkoeppe]:
> No, see comment:28: `PYTHONUSERBASE` does not matter because for venvs, the user installation scheme is already disabled by Python.

Oh, right. Do you see any reason why I shouldn't delete that code from sage-env, then?



---

archive/issue_comments_417554.json:
```json
{
    "body": "Actually I have to correct myself: venvs that enable system site packages do not disable the user scheme. https://github.com/python/cpython/blob/main/Lib/site.py#L533",
    "created_at": "2021-10-15T03:48:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417554",
    "user": "mkoeppe"
}
```

Actually I have to correct myself: venvs that enable system site packages do not disable the user scheme. https://github.com/python/cpython/blob/main/Lib/site.py#L533



---

archive/issue_comments_417555.json:
```json
{
    "body": "So the correct test in configure is to set up the venv AND to set PYTHONUSERBASE in the same way as sage-env would do.",
    "created_at": "2021-10-15T03:49:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417555",
    "user": "mkoeppe"
}
```

So the correct test in configure is to set up the venv AND to set PYTHONUSERBASE in the same way as sage-env would do.



---

archive/issue_comments_417556.json:
```json
{
    "body": "Ok, I have to do my actual job for about an hour but then I'll take a stab at it.",
    "created_at": "2021-10-15T03:50:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417556",
    "user": "mjo"
}
```

Ok, I have to do my actual job for about an hour but then I'll take a stab at it.



---

archive/issue_comments_417557.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-15T05:21:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417557",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_417558.json:
```json
{
    "body": "I'll have to look into using a venv tomorrow. What's there now is an improvement, though.",
    "created_at": "2021-10-15T05:28:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417558",
    "user": "mjo"
}
```

I'll have to look into using a venv tomorrow. What's there now is an improvement, though.



---

archive/issue_comments_417559.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-15T17:21:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417559",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_417560.json:
```json
{
    "body": "Replying to [comment:44 git]:\n> ||[2dafaf0](https://git.sagemath.org/sage.git/commit/?id=2dafaf092ef1c547a1dde4713f643f7704e6cc02)||`Trac #29665: remove \"distros\" information for python packages.`||\n\nThat's not a good solution",
    "created_at": "2021-10-15T17:38:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417560",
    "user": "mkoeppe"
}
```

Replying to [comment:44 git]:
> ||[2dafaf0](https://git.sagemath.org/sage.git/commit/?id=2dafaf092ef1c547a1dde4713f643f7704e6cc02)||`Trac #29665: remove "distros" information for python packages.`||

That's not a good solution



---

archive/issue_comments_417561.json:
```json
{
    "body": "Replying to [comment:47 mkoeppe]:\n> Replying to [comment:44 git]:\n> > ||[2dafaf0](https://git.sagemath.org/sage.git/commit/?id=2dafaf092ef1c547a1dde4713f643f7704e6cc02)||`Trac #29665: remove \"distros\" information for python packages.`||\n> \n> That's not a good solution\n\nI'll take a few days to try to think of something better, but removing `distros/` is going to be hard to beat for simplicity and ease of implementation. The sole purpose of those files is to do the thing you don't want to happen. Removing them prevents it, and doesn't hurt anything else.\n\nKeeping the files that cause the wrong thing to happen and then trying to stop the wrong thing from happening somewhere else is only going to push our `./configure` further down the path to Mouse Trap. These system packages already work flawlessly for me. If there are no major problems, we could enable this by default as early as sage-9.6, bring back the `distros/`, and never have to worry about if the swimmer hits the plate just right to launch the cannonball into the bathtub to disable the system package suggestion.",
    "created_at": "2021-10-15T23:18:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417561",
    "user": "mjo"
}
```

Replying to [comment:47 mkoeppe]:
> Replying to [comment:44 git]:
> > ||[2dafaf0](https://git.sagemath.org/sage.git/commit/?id=2dafaf092ef1c547a1dde4713f643f7704e6cc02)||`Trac #29665: remove "distros" information for python packages.`||
> 
> That's not a good solution

I'll take a few days to try to think of something better, but removing `distros/` is going to be hard to beat for simplicity and ease of implementation. The sole purpose of those files is to do the thing you don't want to happen. Removing them prevents it, and doesn't hurt anything else.

Keeping the files that cause the wrong thing to happen and then trying to stop the wrong thing from happening somewhere else is only going to push our `./configure` further down the path to Mouse Trap. These system packages already work flawlessly for me. If there are no major problems, we could enable this by default as early as sage-9.6, bring back the `distros/`, and never have to worry about if the swimmer hits the plate just right to launch the cannonball into the bathtub to disable the system package suggestion.



---

archive/issue_comments_417562.json:
```json
{
    "body": "But then how do we test that this new experimental switch actually works on a distribution?\n\nThe `distros` information is not just for the user, but also for provisioning the test environment on GH Actions etc.",
    "created_at": "2021-10-15T23:39:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417562",
    "user": "mkoeppe"
}
```

But then how do we test that this new experimental switch actually works on a distribution?

The `distros` information is not just for the user, but also for provisioning the test environment on GH Actions etc.



---

archive/issue_comments_417563.json:
```json
{
    "body": "And in comment:32 I have already explained a simple implementation strategy",
    "created_at": "2021-10-15T23:40:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417563",
    "user": "mkoeppe"
}
```

And in comment:32 I have already explained a simple implementation strategy



---

archive/issue_comments_417564.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-10-16T12:27:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417564",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_417565.json:
```json
{
    "body": "Replying to [comment:50 mkoeppe]:\n> And in comment:32 I have already explained a simple implementation strategy\n\nNot every package with an `install-requires.txt` requires `--enable-system-site-packages`. Hiding the package checks in two different places is also not great for maintainability; but more importantly, not every package uses the same check. Some have DEPCHECKs, and in the future I'm sure we'll need feature tests to ensure that e.g. matplotlib has support for our documented export formats.\n\nIn principle I'd rather hack the test setup than the build system if we have to do it for a release or two. But maybe my latest commit solves it without any collateral damage (I hope).",
    "created_at": "2021-10-16T12:35:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417565",
    "user": "mjo"
}
```

Replying to [comment:50 mkoeppe]:
> And in comment:32 I have already explained a simple implementation strategy

Not every package with an `install-requires.txt` requires `--enable-system-site-packages`. Hiding the package checks in two different places is also not great for maintainability; but more importantly, not every package uses the same check. Some have DEPCHECKs, and in the future I'm sure we'll need feature tests to ensure that e.g. matplotlib has support for our documented export formats.

In principle I'd rather hack the test setup than the build system if we have to do it for a release or two. But maybe my latest commit solves it without any collateral damage (I hope).



---

archive/issue_comments_417566.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-10-16T12:39:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417566",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_417567.json:
```json
{
    "body": "To test this more thoroughly,\n- we need many more `distros/` files for various platforms\n- need a GH Actions workflow to automate this - see #32703 for a possible approach",
    "created_at": "2021-10-16T21:17:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417567",
    "user": "mkoeppe"
}
```

To test this more thoroughly,
- we need many more `distros/` files for various platforms
- need a GH Actions workflow to automate this - see #32703 for a possible approach



---

archive/issue_comments_417568.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-17T10:25:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417568",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_417569.json:
```json
{
    "body": "When the new experimental option is not used, the configure tests should probably say something like \"skipping test, only available with --enable-system-site-packages (experimental)\" before it concludes \"no suitable system package found\"",
    "created_at": "2021-10-18T01:34:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417569",
    "user": "mkoeppe"
}
```

When the new experimental option is not used, the configure tests should probably say something like "skipping test, only available with --enable-system-site-packages (experimental)" before it concludes "no suitable system package found"



---

archive/issue_comments_417570.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-18T04:04:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417570",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_417571.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-18T04:21:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417571",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_417572.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-18T05:45:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417572",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_417573.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-10-18T12:00:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417573",
    "user": "mjo"
}
```

New commits:



---

archive/issue_comments_417574.json:
```json
{
    "body": "Tested using #32703 at https://github.com/mkoeppe/sage/runs/3987632855:\nIt thinks that `setuptools` is available, but then it isn't\n----\nNew commits:",
    "created_at": "2021-10-24T20:21:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417574",
    "user": "mkoeppe"
}
```

Tested using #32703 at https://github.com/mkoeppe/sage/runs/3987632855:
It thinks that `setuptools` is available, but then it isn't
----
New commits:



---

archive/issue_comments_417575.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-10-24T20:21:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417575",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_417576.json:
```json
{
    "body": "Replying to [comment:66 mkoeppe]:\n> Tested using #32703 at https://github.com/mkoeppe/sage/runs/3987632855:\n> It thinks that `setuptools` is available, but then it isn't\n\nYou sure setuptools isn't there? The new autoconf macro uses it to check for all of the other packages. If the whole thing is not crashing and burning (and if I did not flip an exit code somewhere...) setuptools is probably there.\n\nMaybe something to do with `export PYTHONPATH=\"$(pwd)/src\"` in pip's `spkg-install.in`.",
    "created_at": "2021-10-24T21:16:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417576",
    "user": "mjo"
}
```

Replying to [comment:66 mkoeppe]:
> Tested using #32703 at https://github.com/mkoeppe/sage/runs/3987632855:
> It thinks that `setuptools` is available, but then it isn't

You sure setuptools isn't there? The new autoconf macro uses it to check for all of the other packages. If the whole thing is not crashing and burning (and if I did not flip an exit code somewhere...) setuptools is probably there.

Maybe something to do with `export PYTHONPATH="$(pwd)/src"` in pip's `spkg-install.in`.



---

archive/issue_comments_417577.json:
```json
{
    "body": "Replying to [comment:67 mjo]:\n> Replying to [comment:66 mkoeppe]:\n> > Tested using #32703 at https://github.com/mkoeppe/sage/runs/3987632855:\n> > It thinks that `setuptools` is available, but then it isn't\n> \n> You sure setuptools isn't there? The new autoconf macro uses it to check for all of the other packages. If the whole thing is not crashing and burning (and if I did not flip an exit code somewhere...) setuptools is probably there.\n\nWell, it is probably present in the test venv. But as you can see in the test, it's not present in the venv at build time.",
    "created_at": "2021-10-24T21:20:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417577",
    "user": "mkoeppe"
}
```

Replying to [comment:67 mjo]:
> Replying to [comment:66 mkoeppe]:
> > Tested using #32703 at https://github.com/mkoeppe/sage/runs/3987632855:
> > It thinks that `setuptools` is available, but then it isn't
> 
> You sure setuptools isn't there? The new autoconf macro uses it to check for all of the other packages. If the whole thing is not crashing and burning (and if I did not flip an exit code somewhere...) setuptools is probably there.

Well, it is probably present in the test venv. But as you can see in the test, it's not present in the venv at build time.



---

archive/issue_comments_417578.json:
```json
{
    "body": "Replying to [comment:67 mjo]:\n> Maybe something to do with `export PYTHONPATH=\"$(pwd)/src\"` in pip's `spkg-install.in`.\n\nI don't think so.",
    "created_at": "2021-10-24T21:21:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417578",
    "user": "mkoeppe"
}
```

Replying to [comment:67 mjo]:
> Maybe something to do with `export PYTHONPATH="$(pwd)/src"` in pip's `spkg-install.in`.

I don't think so.



---

archive/issue_comments_417579.json:
```json
{
    "body": "Is `python3` not the `$PYTHON_FOR_VENV` on this machine? The `sdh_*` scripts call `python3` directly, while the macro uses `$PYTHON_FOR_VENV`. That's the only thing I can think of.",
    "created_at": "2021-10-24T21:48:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417579",
    "user": "mjo"
}
```

Is `python3` not the `$PYTHON_FOR_VENV` on this machine? The `sdh_*` scripts call `python3` directly, while the macro uses `$PYTHON_FOR_VENV`. That's the only thing I can think of.



---

archive/issue_comments_417580.json:
```json
{
    "body": "Replying to [comment:70 mjo]:\n> The `sdh_*` scripts call `python3` directly\n... because they run with the venv activated. This is correct.",
    "created_at": "2021-10-24T22:20:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417580",
    "user": "mkoeppe"
}
```

Replying to [comment:70 mjo]:
> The `sdh_*` scripts call `python3` directly
... because they run with the venv activated. This is correct.



---

archive/issue_comments_417581.json:
```json
{
    "body": "\n```\n+    dnl Use --clear because ./configure typically clobbers its output files.\n+    AS_IF([\"${PYTHON_FOR_VENV}\" -m venv --system-site-packages dnl\n+                                        --clear                dnl\n+                                        --without-pip          dnl\n+                                        config.venv            dnl\n+                                        2>&AS_MESSAGE_LOG_FD], [\n```\n\nI think you should change this to use the `sage-venv` script, like `m4/sage_check_python_for_venv.m4` does.",
    "created_at": "2021-10-24T22:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417581",
    "user": "mkoeppe"
}
```


```
+    dnl Use --clear because ./configure typically clobbers its output files.
+    AS_IF(["${PYTHON_FOR_VENV}" -m venv --system-site-packages dnl
+                                        --clear                dnl
+                                        --without-pip          dnl
+                                        config.venv            dnl
+                                        2>&AS_MESSAGE_LOG_FD], [
```

I think you should change this to use the `sage-venv` script, like `m4/sage_check_python_for_venv.m4` does.



---

archive/issue_comments_417582.json:
```json
{
    "body": "(I don't know if this will change anything -- but it's best to use the script that we actually use to set up the production venv to set up the test venv.)",
    "created_at": "2021-10-24T22:25:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417582",
    "user": "mkoeppe"
}
```

(I don't know if this will change anything -- but it's best to use the script that we actually use to set up the production venv to set up the test venv.)



---

archive/issue_comments_417583.json:
```json
{
    "body": "Replying to [comment:73 mkoeppe]:\n> (I don't know if this will change anything -- but it's best to use the script that we actually use to set up the production venv to set up the test venv.)\n\nWhat does this script abstract, anyway? It's only called in two places so far (`build/make/Makefile.in` and `m4/sage_check_python_for_venv.m4`, and in both places we have access to the full path to the python interpreter and the flags that should be passed to `-m venv` (now called `$SAGE_VENV_FLAGS`).\n\nIf the only thing it does is handle `--symlinks`, then we could add `--symlinks` to `$SAGE_VENV_FLAGS` in `configure.ac` dependent upon the platform and avoid the separate script that just reimplements `-m venv`.",
    "created_at": "2021-10-24T22:46:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417583",
    "user": "mjo"
}
```

Replying to [comment:73 mkoeppe]:
> (I don't know if this will change anything -- but it's best to use the script that we actually use to set up the production venv to set up the test venv.)

What does this script abstract, anyway? It's only called in two places so far (`build/make/Makefile.in` and `m4/sage_check_python_for_venv.m4`, and in both places we have access to the full path to the python interpreter and the flags that should be passed to `-m venv` (now called `$SAGE_VENV_FLAGS`).

If the only thing it does is handle `--symlinks`, then we could add `--symlinks` to `$SAGE_VENV_FLAGS` in `configure.ac` dependent upon the platform and avoid the separate script that just reimplements `-m venv`.



---

archive/issue_comments_417584.json:
```json
{
    "body": "Clearly outside the scope of this ticket to make changes to the well-working `sage-venv` script.",
    "created_at": "2021-10-24T23:13:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417584",
    "user": "mkoeppe"
}
```

Clearly outside the scope of this ticket to make changes to the well-working `sage-venv` script.



---

archive/issue_comments_417585.json:
```json
{
    "body": "I dropped the toml commit because somebody else added an `spkg-configure.m4` in the meantime and I don't want to worry about reconciling them.\n----\nLast 10 new commits:",
    "created_at": "2021-10-25T00:42:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417585",
    "user": "mjo"
}
```

I dropped the toml commit because somebody else added an `spkg-configure.m4` in the meantime and I don't want to worry about reconciling them.
----
Last 10 new commits:



---

archive/issue_comments_417586.json:
```json
{
    "body": "You didn't like how I merged it in eeae67c?",
    "created_at": "2021-10-25T00:45:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417586",
    "user": "mkoeppe"
}
```

You didn't like how I merged it in eeae67c?



---

archive/issue_comments_417587.json:
```json
{
    "body": "Replying to [comment:77 mkoeppe]:\n> You didn't like how I merged it in eeae67c?\n\nThat part is probably fine but huge merge commits aren't very nice to review.\n\nThere are a bunch of other python packages with similar spkg-configures that I skipped initially. Once the `--enable-system-site-packages` mechanism works well enough to enable by default, I'll go back and replace them all at once with the trivial python spkg-configure that all of the other packages are using.",
    "created_at": "2021-10-25T00:54:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417587",
    "user": "mjo"
}
```

Replying to [comment:77 mkoeppe]:
> You didn't like how I merged it in eeae67c?

That part is probably fine but huge merge commits aren't very nice to review.

There are a bunch of other python packages with similar spkg-configures that I skipped initially. Once the `--enable-system-site-packages` mechanism works well enough to enable by default, I'll go back and replace them all at once with the trivial python spkg-configure that all of the other packages are using.



---

archive/issue_comments_417588.json:
```json
{
    "body": "Replying to [comment:71 mkoeppe]:\n> Replying to [comment:70 mjo]:\n> > The `sdh_*` scripts call `python3` directly\n> ... because they run with the venv activated. This is correct.\n\nSo both are supposedly running the symlink `/Users/runner/work/sage/sage/.tox/local-homebrew-macos-standard/local/bin/python3`, which should point to the real homebrew python3, by way of its being near the front of `PATH`. I'd love to know how it loses track of setuptools in the span of a few seconds, but I'm at a loss for ways to test it without a mac.",
    "created_at": "2021-10-25T02:09:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417588",
    "user": "mjo"
}
```

Replying to [comment:71 mkoeppe]:
> Replying to [comment:70 mjo]:
> > The `sdh_*` scripts call `python3` directly
> ... because they run with the venv activated. This is correct.

So both are supposedly running the symlink `/Users/runner/work/sage/sage/.tox/local-homebrew-macos-standard/local/bin/python3`, which should point to the real homebrew python3, by way of its being near the front of `PATH`. I'd love to know how it loses track of setuptools in the span of a few seconds, but I'm at a loss for ways to test it without a mac.



---

archive/issue_comments_417589.json:
```json
{
    "body": "It is unlikely that any of this is macOS-specific. It's just the only environment for which I have built #32703 so far. Help on that is welcome.",
    "created_at": "2021-10-25T02:28:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417589",
    "user": "mkoeppe"
}
```

It is unlikely that any of this is macOS-specific. It's just the only environment for which I have built #32703 so far. Help on that is welcome.



---

archive/issue_comments_417590.json:
```json
{
    "body": "I tried installing a separate copy of python-3.9.6 in `/home/mjo/tmp/python3` that doesn't have setuptools. After prepending `/home/mjo/tmp/python3/bin` to my `PATH`, I configured sage with `--with-python=/usr/bin/python3`, the \"good\" copy that has setuptools. Everything is detected and pip builds normally.",
    "created_at": "2021-10-25T02:39:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417590",
    "user": "mjo"
}
```

I tried installing a separate copy of python-3.9.6 in `/home/mjo/tmp/python3` that doesn't have setuptools. After prepending `/home/mjo/tmp/python3/bin` to my `PATH`, I configured sage with `--with-python=/usr/bin/python3`, the "good" copy that has setuptools. Everything is detected and pip builds normally.



---

archive/issue_comments_417591.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2021-11-03T13:23:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417591",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_417592.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2021-11-03T23:38:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417592",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_417593.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2021-11-04T22:55:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417593",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_417594.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-05T16:58:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417594",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_417595.json:
```json
{
    "body": "Something's gone wrong in the meantime. I'm now seeing cypari fail to cythonize.\n\ncypari has a custom patch that in turn requires a custom patched cython, so I wouldn't expect it to work with the system cython... but I've got the cython SPKG installed. Must be somehow the system cython is getting used.",
    "created_at": "2021-11-05T17:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417595",
    "user": "mjo"
}
```

Something's gone wrong in the meantime. I'm now seeing cypari fail to cythonize.

cypari has a custom patch that in turn requires a custom patched cython, so I wouldn't expect it to work with the system cython... but I've got the cython SPKG installed. Must be somehow the system cython is getting used.



---

archive/issue_comments_417596.json:
```json
{
    "body": "Replying to [comment:86 mjo]:\n> Must be somehow the system cython is getting used.\n\nI think this explains all of the problems observed so far:\n\n\n```\n$ sage -c \"print(sys.path)\"\n['/home/mjo/src/sage.git/src/bin',\n '/usr/lib/python39.zip',\n '/usr/lib/python3.9',\n '/usr/lib/python3.9/lib-dynload',\n '/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages', \n '/usr/lib/python3.9/site-packages']\n```\n\n\nI have been assuming that the venv would be searched before the system paths. When it isn't, installing an SPKG to override an unusable system package doesn't work.",
    "created_at": "2021-11-06T13:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417596",
    "user": "mjo"
}
```

Replying to [comment:86 mjo]:
> Must be somehow the system cython is getting used.

I think this explains all of the problems observed so far:


```
$ sage -c "print(sys.path)"
['/home/mjo/src/sage.git/src/bin',
 '/usr/lib/python39.zip',
 '/usr/lib/python3.9',
 '/usr/lib/python3.9/lib-dynload',
 '/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages', 
 '/usr/lib/python3.9/site-packages']
```


I have been assuming that the venv would be searched before the system paths. When it isn't, installing an SPKG to override an unusable system package doesn't work.



---

archive/issue_comments_417597.json:
```json
{
    "body": "Replying to [comment:87 mjo]:\n> I have been assuming that the venv would be searched before the system paths.\n\nIt is searched before the system `site-packages`; but not before the paths that provide the Python standard library.",
    "created_at": "2021-11-06T17:36:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417597",
    "user": "mkoeppe"
}
```

Replying to [comment:87 mjo]:
> I have been assuming that the venv would be searched before the system paths.

It is searched before the system `site-packages`; but not before the paths that provide the Python standard library.



---

archive/issue_comments_417598.json:
```json
{
    "body": "Replying to [comment:88 mkoeppe]:\n> Replying to [comment:87 mjo]:\n> > I have been assuming that the venv would be searched before the system paths.\n> \n> It is searched before the system `site-packages`; but not before the paths that provide the Python standard library.\n\nYeah, thanks, I realized that later. The problem with cython is due to pip refusing to install a wheel that's the same version as the existing one. You dealt with that recently by issuing a `pip uninstall` prior to `pip install`... but the uninstall does nothing if cython comes from the system. We're going to have the same issue with many patched python packages.",
    "created_at": "2021-11-06T17:47:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417598",
    "user": "mjo"
}
```

Replying to [comment:88 mkoeppe]:
> Replying to [comment:87 mjo]:
> > I have been assuming that the venv would be searched before the system paths.
> 
> It is searched before the system `site-packages`; but not before the paths that provide the Python standard library.

Yeah, thanks, I realized that later. The problem with cython is due to pip refusing to install a wheel that's the same version as the existing one. You dealt with that recently by issuing a `pip uninstall` prior to `pip install`... but the uninstall does nothing if cython comes from the system. We're going to have the same issue with many patched python packages.



---

archive/issue_comments_417599.json:
```json
{
    "body": "Replying to [comment:89 mjo]:\n> The problem with cython is due to pip refusing to install a wheel that's the same version as the existing one. You dealt with that recently by issuing a `pip uninstall` prior to `pip install`... but the uninstall does nothing if cython comes from the system. We're going to have the same issue with many patched python packages.\n\nAha, interesting. \nThat's the 2nd and 3rd bullet points in #29023 \"Questions to be resolved\".",
    "created_at": "2021-11-06T18:12:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417599",
    "user": "mkoeppe"
}
```

Replying to [comment:89 mjo]:
> The problem with cython is due to pip refusing to install a wheel that's the same version as the existing one. You dealt with that recently by issuing a `pip uninstall` prior to `pip install`... but the uninstall does nothing if cython comes from the system. We're going to have the same issue with many patched python packages.

Aha, interesting. 
That's the 2nd and 3rd bullet points in #29023 "Questions to be resolved".



---

archive/issue_comments_417600.json:
```json
{
    "body": "So in the case of `--enable-system-site-packages`, we may have to add `--ignore-installed` to the options when installing the wheel.",
    "created_at": "2021-11-06T18:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417600",
    "user": "mkoeppe"
}
```

So in the case of `--enable-system-site-packages`, we may have to add `--ignore-installed` to the options when installing the wheel.



---

archive/issue_comments_417601.json:
```json
{
    "body": "Replying to [comment:91 mkoeppe]:\n> So in the case of `--enable-system-site-packages`, we may have to add `--ignore-installed` to the options when installing the wheel.\n\nThat was already part of the fallback case in `sage-pip-install`, but the install conflict doesn't actually cause an error -- only a warning. I've already moved it from the fallback into the main `pip_install_flags` and will see what happens.",
    "created_at": "2021-11-06T18:19:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417601",
    "user": "mjo"
}
```

Replying to [comment:91 mkoeppe]:
> So in the case of `--enable-system-site-packages`, we may have to add `--ignore-installed` to the options when installing the wheel.

That was already part of the fallback case in `sage-pip-install`, but the install conflict doesn't actually cause an error -- only a warning. I've already moved it from the fallback into the main `pip_install_flags` and will see what happens.



---

archive/issue_comments_417602.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-07T12:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417602",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_417603.json:
```json
{
    "body": "Won't this reinstall dependencies of every package every time?",
    "created_at": "2021-11-07T17:47:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417603",
    "user": "mkoeppe"
}
```

Won't this reinstall dependencies of every package every time?



---

archive/issue_comments_417604.json:
```json
{
    "body": "Replying to [comment:94 mkoeppe]:\n> Won't this reinstall dependencies of every package every time?\n\nThat would have been a smart thing for me to check a few hours ago, but I saw a bunch of unrelated doctest failures and just clobbered my local checkout to confirm that #32836 occurs on the unmodified develop branch.\n\nI'll switch back to this ticket eventually and make sure that we're not installing dependencies that shouldn't be. It would be especially counterproductive if pip was installing local copies of dependencies when the intention is to use those from the system.",
    "created_at": "2021-11-07T18:34:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417604",
    "user": "mjo"
}
```

Replying to [comment:94 mkoeppe]:
> Won't this reinstall dependencies of every package every time?

That would have been a smart thing for me to check a few hours ago, but I saw a bunch of unrelated doctest failures and just clobbered my local checkout to confirm that #32836 occurs on the unmodified develop branch.

I'll switch back to this ticket eventually and make sure that we're not installing dependencies that shouldn't be. It would be especially counterproductive if pip was installing local copies of dependencies when the intention is to use those from the system.



---

archive/issue_comments_417605.json:
```json
{
    "body": "Replying to [comment:94 mkoeppe]:\n> Won't this reinstall dependencies of every package every time?\n\nSort of. It actually winds up doing the right thing in most cases, but pollutes the logs and probably wastes a few seconds.\n\nIf the dependency is installed as a system package, an error gets thrown and the whole thing is retried with `--no-deps`, which makes it work. For example with system setuptools: \n\n\n```\n[setuptools_scm-6.3.2] ERROR: Could not find a version that satisfies the requirement setuptools (from setuptools-scm) (from versions: none)\n[setuptools_scm-6.3.2] ERROR: No matching distribution found for setuptools\n[setuptools_scm-6.3.2] Warning: installing with ... failed. Retrying, adding \"--no-deps --ignore-requires-python\"\n[setuptools_scm-6.3.2] Using pip 21.2.4 from /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/pip (python 3.9)\n...\n[setuptools_scm-6.3.2] Successfully installed setuptools-scm-6.3.2\n[setuptools_scm-6.3.2] Warning: The installation needed to use \"--no-deps --ignore-requires-python\" to succeed. This means that a dependencies file in build/pkgs/ needs to be updated. Please report this to sage-devel@googlegroups.com, including the build log of this package.\n```\n\n\nHowever, when the dependency itself is installed as an SPKG, it looks like a portion of its installation routine is re-run. Here's cypari reinstalling cysignals/cython:\n\n\n```\n[cypari-2.1.2] Using pip 21.2.4 from /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/pip (python 3.9)\n[cypari-2.1.2] Looking in links: /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/var/lib/sage/wheels\n[cypari-2.1.2] Processing /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/var/tmp/sage/build/cypari-2.1.2/inst/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/var/lib/sage/wheels/cypari2-2.1.2-cp39-cp39-linux_x86_64.whl\n[cypari-2.1.2] Processing /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/var/lib/sage/wheels/cysignals-1.10.3-cp39-cp39-linux_x86_64.whl\n[cypari-2.1.2] Processing /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/var/lib/sage/wheels/Cython-0.29.24-cp39-cp39-linux_x86_64.whl\n[cypari-2.1.2] Installing collected packages: Cython, cysignals, cypari2\n[cypari-2.1.2]   changing mode of /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/bin/cygdb to 755\n[cypari-2.1.2]   changing mode of /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/bin/cython to 755\n[cypari-2.1.2]   changing mode of /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/bin/cythonize to 755\n[cypari-2.1.2] Successfully installed Cython-0.29.24 cypari2-2.1.2 cysignals-1.10.3\n```\n\n\nI'm not sure what all it's doing, or how undesirable it is in the general case. It doesn't take noticeably longer, and everything works out in the end.\n\nI suppose I'll add both `--no-deps` and `--ignore-installed`, but only when `--enable-system-site-packages` is on. If it ever becomes default, we'll just have to run a CI with `--disable-system-site-packages` to detect stale deps using that warning.",
    "created_at": "2021-11-09T03:25:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417605",
    "user": "mjo"
}
```

Replying to [comment:94 mkoeppe]:
> Won't this reinstall dependencies of every package every time?

Sort of. It actually winds up doing the right thing in most cases, but pollutes the logs and probably wastes a few seconds.

If the dependency is installed as a system package, an error gets thrown and the whole thing is retried with `--no-deps`, which makes it work. For example with system setuptools: 


```
[setuptools_scm-6.3.2] ERROR: Could not find a version that satisfies the requirement setuptools (from setuptools-scm) (from versions: none)
[setuptools_scm-6.3.2] ERROR: No matching distribution found for setuptools
[setuptools_scm-6.3.2] Warning: installing with ... failed. Retrying, adding "--no-deps --ignore-requires-python"
[setuptools_scm-6.3.2] Using pip 21.2.4 from /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/pip (python 3.9)
...
[setuptools_scm-6.3.2] Successfully installed setuptools-scm-6.3.2
[setuptools_scm-6.3.2] Warning: The installation needed to use "--no-deps --ignore-requires-python" to succeed. This means that a dependencies file in build/pkgs/ needs to be updated. Please report this to sage-devel@googlegroups.com, including the build log of this package.
```


However, when the dependency itself is installed as an SPKG, it looks like a portion of its installation routine is re-run. Here's cypari reinstalling cysignals/cython:


```
[cypari-2.1.2] Using pip 21.2.4 from /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/pip (python 3.9)
[cypari-2.1.2] Looking in links: /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/var/lib/sage/wheels
[cypari-2.1.2] Processing /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/var/tmp/sage/build/cypari-2.1.2/inst/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/var/lib/sage/wheels/cypari2-2.1.2-cp39-cp39-linux_x86_64.whl
[cypari-2.1.2] Processing /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/var/lib/sage/wheels/cysignals-1.10.3-cp39-cp39-linux_x86_64.whl
[cypari-2.1.2] Processing /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/var/lib/sage/wheels/Cython-0.29.24-cp39-cp39-linux_x86_64.whl
[cypari-2.1.2] Installing collected packages: Cython, cysignals, cypari2
[cypari-2.1.2]   changing mode of /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/bin/cygdb to 755
[cypari-2.1.2]   changing mode of /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/bin/cython to 755
[cypari-2.1.2]   changing mode of /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/bin/cythonize to 755
[cypari-2.1.2] Successfully installed Cython-0.29.24 cypari2-2.1.2 cysignals-1.10.3
```


I'm not sure what all it's doing, or how undesirable it is in the general case. It doesn't take noticeably longer, and everything works out in the end.

I suppose I'll add both `--no-deps` and `--ignore-installed`, but only when `--enable-system-site-packages` is on. If it ever becomes default, we'll just have to run a CI with `--disable-system-site-packages` to detect stale deps using that warning.



---

archive/issue_comments_417606.json:
```json
{
    "body": "Replying to [comment:96 mjo]:\n> I suppose I'll add both `--no-deps` and `--ignore-installed`, but only when `--enable-system-site-packages` is on. \nYes, this seems to be the way forward.",
    "created_at": "2021-11-09T04:18:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417606",
    "user": "mkoeppe"
}
```

Replying to [comment:96 mjo]:
> I suppose I'll add both `--no-deps` and `--ignore-installed`, but only when `--enable-system-site-packages` is on. 
Yes, this seems to be the way forward.



---

archive/issue_comments_417607.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-11-10T01:38:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417607",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_417608.json:
```json
{
    "body": "I've cherry-picked your changes from #32715, and added the ability to pass `--ignore-installed` to `sdh_pip_install`, too. Afterwards I pass the new variable `$SAGE_SDH_PIP_INSTALL_FLAGS` to every invocation of `sdh_pip_install` in an `spkg-install.in` file.\n\nI think this is a tiny bit cleaner than introducing a dependency upon `sage-build-env-config` within `sage-dist-helpers`, but the duplication is hard to overlook. If you prefer to have `sdh_pip_install` directly use `$SAGE_SDH_PIP_INSTALL_FLAGS`, I'm happy to do it that way too.",
    "created_at": "2021-11-10T01:45:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417608",
    "user": "mjo"
}
```

I've cherry-picked your changes from #32715, and added the ability to pass `--ignore-installed` to `sdh_pip_install`, too. Afterwards I pass the new variable `$SAGE_SDH_PIP_INSTALL_FLAGS` to every invocation of `sdh_pip_install` in an `spkg-install.in` file.

I think this is a tiny bit cleaner than introducing a dependency upon `sage-build-env-config` within `sage-dist-helpers`, but the duplication is hard to overlook. If you prefer to have `sdh_pip_install` directly use `$SAGE_SDH_PIP_INSTALL_FLAGS`, I'm happy to do it that way too.



---

archive/issue_comments_417609.json:
```json
{
    "body": "Replying to [comment:99 mjo]:\n> the duplication is hard to overlook\n\nYes, this is too much",
    "created_at": "2021-11-10T01:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417609",
    "user": "mkoeppe"
}
```

Replying to [comment:99 mjo]:
> the duplication is hard to overlook

Yes, this is too much



---

archive/issue_comments_417610.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-11-10T02:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417610",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_417611.json:
```json
{
    "body": "Ok, `sdh_pip_install` handles it now. I didn't even have to source `sage-build-env-config`, since in the context of `spkg-install.in` it will already have been sourced. And in any other context, an empty `$SAGE_SDH_PIP_INSTALL_OPTIONS` has no effect.",
    "created_at": "2021-11-10T02:28:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417611",
    "user": "mjo"
}
```

Ok, `sdh_pip_install` handles it now. I didn't even have to source `sage-build-env-config`, since in the context of `spkg-install.in` it will already have been sourced. And in any other context, an empty `$SAGE_SDH_PIP_INSTALL_OPTIONS` has no effect.



---

archive/issue_comments_417612.json:
```json
{
    "body": "I think this should go into `sdh_store_and_pip_install_wheel`, not `sdh_pip_install`",
    "created_at": "2021-11-10T02:37:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417612",
    "user": "mkoeppe"
}
```

I think this should go into `sdh_store_and_pip_install_wheel`, not `sdh_pip_install`



---

archive/issue_comments_417613.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2021-11-10T18:42:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417613",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_417614.json:
```json
{
    "body": "Adding more and more packages (whatever is available on Gentoo) and things still look OK.\n\nWhen you get a second, can you double-check if this should be \"dateutil\" or \"python-dateutil\"?\n\n\n```\n$ cat build/pkgs/dateutil/install-requires.txt \ndateutil >=2.8.1\n```\n\n\ncf. https://github.com/dateutil/dateutil/blob/master/setup.cfg",
    "created_at": "2021-11-10T18:47:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417614",
    "user": "mjo"
}
```

Adding more and more packages (whatever is available on Gentoo) and things still look OK.

When you get a second, can you double-check if this should be "dateutil" or "python-dateutil"?


```
$ cat build/pkgs/dateutil/install-requires.txt 
dateutil >=2.8.1
```


cf. https://github.com/dateutil/dateutil/blob/master/setup.cfg



---

archive/issue_comments_417615.json:
```json
{
    "body": "It should be **python-dateutil** (https://pypi.org/project/python-dateutil/), thanks for catching this.\n\nMany of these `install-requires.txt` file are only decoration at the moment; only the `install-requires.txt` files of those packages that are named in files like `src/setup.cfg.m4` are used.",
    "created_at": "2021-11-10T20:05:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417615",
    "user": "mkoeppe"
}
```

It should be **python-dateutil** (https://pypi.org/project/python-dateutil/), thanks for catching this.

Many of these `install-requires.txt` file are only decoration at the moment; only the `install-requires.txt` files of those packages that are named in files like `src/setup.cfg.m4` are used.



---

archive/issue_comments_417616.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2021-11-11T10:24:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417616",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_417617.json:
```json
{
    "body": "I haven't been able to test ptyprocess yet due to a version mismatch on Gentoo, and importllib_resources will need some subsequent work (it's built-in to python >= 3.9, but the existing check will save you a pointless pip install if you happen to be running an older python). And I've avoided anything with patches for now.\n\nOtherwise, I think it's good.",
    "created_at": "2021-11-11T11:04:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417617",
    "user": "mjo"
}
```

I haven't been able to test ptyprocess yet due to a version mismatch on Gentoo, and importllib_resources will need some subsequent work (it's built-in to python >= 3.9, but the existing check will save you a pointless pip install if you happen to be running an older python). And I've avoided anything with patches for now.

Otherwise, I think it's good.



---

archive/issue_comments_417618.json:
```json
{
    "body": "The test suite still passes with all of those packages installed on the system.\n\nI did discover one more problem that we'll need to be aware of in the future. A lot of python packages have \"automagic\" dependencies that get used if they're available at runtime, rather than detected/configured at build-time. With python-3.9, for example, having an old version of ipyparallel installed will cause ipykernel to throw a deprecation warning that fails a doctest in `repl/ipython_kernel/kernel.py`.\n\nWe could try to address all of those (as they're reported) in `spkg-configure.m4`. Something like,\n\n\n```\nAC_DEFUN([SAGE_PYTHON_RUN_IFELSE], [dnl\ncat >conftest.py <<SAGE__EOF\n$1\nSAGE__EOF\nAS_IF([\"${PYTHON_FOR_VENV}\" conftest.py 1>&AS_MESSAGE_LOG_FD 2>&AS_MESSAGE_LOG_FD],[$2],[$3])\n])\n```\n\n\ncan be used to detect serious problems that are amenable to such a test. But for cosmetic issues like deprecation warnings I think we're better off just hiding them from the test suite. Or letting them fail (what's the point of the test suite?). Regardless, we can only ever hope to address the problems that exist when sage is being built. If I build sage and *then* install the old ipyparallel, there's nothing sage can do to stop me. That's not really a new problem of course, but it will show up more often with python packages than with C packages due to the prevalence of automagic features in python.",
    "created_at": "2021-11-12T12:59:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417618",
    "user": "mjo"
}
```

The test suite still passes with all of those packages installed on the system.

I did discover one more problem that we'll need to be aware of in the future. A lot of python packages have "automagic" dependencies that get used if they're available at runtime, rather than detected/configured at build-time. With python-3.9, for example, having an old version of ipyparallel installed will cause ipykernel to throw a deprecation warning that fails a doctest in `repl/ipython_kernel/kernel.py`.

We could try to address all of those (as they're reported) in `spkg-configure.m4`. Something like,


```
AC_DEFUN([SAGE_PYTHON_RUN_IFELSE], [dnl
cat >conftest.py <<SAGE__EOF
$1
SAGE__EOF
AS_IF(["${PYTHON_FOR_VENV}" conftest.py 1>&AS_MESSAGE_LOG_FD 2>&AS_MESSAGE_LOG_FD],[$2],[$3])
])
```


can be used to detect serious problems that are amenable to such a test. But for cosmetic issues like deprecation warnings I think we're better off just hiding them from the test suite. Or letting them fail (what's the point of the test suite?). Regardless, we can only ever hope to address the problems that exist when sage is being built. If I build sage and *then* install the old ipyparallel, there's nothing sage can do to stop me. That's not really a new problem of course, but it will show up more often with python packages than with C packages due to the prevalence of automagic features in python.



---

archive/issue_comments_417619.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-11-12T12:59:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417619",
    "user": "mjo"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_417620.json:
```json
{
    "body": "Replying to [comment:109 mjo]:\n> A lot of python packages have \"automagic\" dependencies that get used if they're available at runtime, rather than detected/configured at build-time. \n\nYes, this is normal - with PEP 517/518, the build environment is separate from the runtime environment.",
    "created_at": "2021-11-12T18:05:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417620",
    "user": "mkoeppe"
}
```

Replying to [comment:109 mjo]:
> A lot of python packages have "automagic" dependencies that get used if they're available at runtime, rather than detected/configured at build-time. 

Yes, this is normal - with PEP 517/518, the build environment is separate from the runtime environment.



---

archive/issue_comments_417621.json:
```json
{
    "body": "Broken \"plugins\" break things, I don't think there's a need to do anything about it.",
    "created_at": "2021-11-12T18:08:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417621",
    "user": "mkoeppe"
}
```

Broken "plugins" break things, I don't think there's a need to do anything about it.



---

archive/issue_comments_417622.json:
```json
{
    "body": "Replying to [comment:108 mjo]:\n> I haven't been able to test ptyprocess yet due to a version mismatch on Gentoo\n\nFor `ptyprocess`, see #32147",
    "created_at": "2021-11-12T18:09:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417622",
    "user": "mkoeppe"
}
```

Replying to [comment:108 mjo]:
> I haven't been able to test ptyprocess yet due to a version mismatch on Gentoo

For `ptyprocess`, see #32147



---

archive/issue_comments_417623.json:
```json
{
    "body": "rebase please",
    "created_at": "2021-11-17T16:37:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417623",
    "user": "dimpase"
}
```

rebase please



---

archive/issue_comments_417624.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2021-11-17T21:26:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417624",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_417625.json:
```json
{
    "body": "Replying to [comment:113 dimpase]:\n> rebase please\n\nI'd love to know why these branches are going red... this one rebased cleanly just like #32037 did.",
    "created_at": "2021-11-17T21:28:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417625",
    "user": "mjo"
}
```

Replying to [comment:113 dimpase]:
> rebase please

I'd love to know why these branches are going red... this one rebased cleanly just like #32037 did.



---

archive/issue_comments_417626.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2021-12-22T19:23:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417626",
    "user": "mkoeppe"
}
```

Last 10 new commits:



---

archive/issue_comments_417627.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2021-12-22T19:24:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417627",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_417628.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-12-22T20:27:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417628",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_417629.json:
```json
{
    "body": "A few fixes in package names in `spkg-configure.m4`:\n\n```\ndiff --git a/build/pkgs/argon2_cffi/spkg-configure.m4 b/build/pkgs/argon2_cffi/spkg-configure.m4\nindex 9ae7f2ea0c..ff476db0b2 100644\n--- a/build/pkgs/argon2_cffi/spkg-configure.m4\n+++ b/build/pkgs/argon2_cffi/spkg-configure.m4\n@@ -1 +1 @@\n-SAGE_SPKG_CONFIGURE([argon2-cffi], [SAGE_PYTHON_PACKAGE_CHECK([argon2-cffi])])\n+SAGE_SPKG_CONFIGURE([argon2_cffi], [SAGE_PYTHON_PACKAGE_CHECK([argon2-cffi])])\ndiff --git a/build/pkgs/jupyter_client/spkg-configure.m4 b/build/pkgs/jupyter_client/spkg-configure.m4\nindex 3c9bb26bb0..1d2735de59 100644\n--- a/build/pkgs/jupyter_client/spkg-configure.m4\n+++ b/build/pkgs/jupyter_client/spkg-configure.m4\n@@ -1 +1 @@\n-SAGE_SPKG_CONFIGURE([bleach], [SAGE_PYTHON_PACKAGE_CHECK([bleach])])\n+SAGE_SPKG_CONFIGURE([jupyter_client], [SAGE_PYTHON_PACKAGE_CHECK([jupyter_client])])\ndiff --git a/build/pkgs/matplotlib_inline/spkg-configure.m4 b/build/pkgs/matplotlib_inline/spkg-configure.m4\nindex 3af724d674..f72fef4802 100644\n--- a/build/pkgs/matplotlib_inline/spkg-configure.m4\n+++ b/build/pkgs/matplotlib_inline/spkg-configure.m4\n@@ -1,3 +1,3 @@\n-SAGE_SPKG_CONFIGURE([matplotlib-inline], [\n+SAGE_SPKG_CONFIGURE([matplotlib_inline], [\n   SAGE_PYTHON_PACKAGE_CHECK([matplotlib-inline])\n ])\n```\n\n\nEdit: small fix.",
    "created_at": "2021-12-30T22:57:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417629",
    "user": "tornaria"
}
```

A few fixes in package names in `spkg-configure.m4`:

```
diff --git a/build/pkgs/argon2_cffi/spkg-configure.m4 b/build/pkgs/argon2_cffi/spkg-configure.m4
index 9ae7f2ea0c..ff476db0b2 100644
--- a/build/pkgs/argon2_cffi/spkg-configure.m4
+++ b/build/pkgs/argon2_cffi/spkg-configure.m4
@@ -1 +1 @@
-SAGE_SPKG_CONFIGURE([argon2-cffi], [SAGE_PYTHON_PACKAGE_CHECK([argon2-cffi])])
+SAGE_SPKG_CONFIGURE([argon2_cffi], [SAGE_PYTHON_PACKAGE_CHECK([argon2-cffi])])
diff --git a/build/pkgs/jupyter_client/spkg-configure.m4 b/build/pkgs/jupyter_client/spkg-configure.m4
index 3c9bb26bb0..1d2735de59 100644
--- a/build/pkgs/jupyter_client/spkg-configure.m4
+++ b/build/pkgs/jupyter_client/spkg-configure.m4
@@ -1 +1 @@
-SAGE_SPKG_CONFIGURE([bleach], [SAGE_PYTHON_PACKAGE_CHECK([bleach])])
+SAGE_SPKG_CONFIGURE([jupyter_client], [SAGE_PYTHON_PACKAGE_CHECK([jupyter_client])])
diff --git a/build/pkgs/matplotlib_inline/spkg-configure.m4 b/build/pkgs/matplotlib_inline/spkg-configure.m4
index 3af724d674..f72fef4802 100644
--- a/build/pkgs/matplotlib_inline/spkg-configure.m4
+++ b/build/pkgs/matplotlib_inline/spkg-configure.m4
@@ -1,3 +1,3 @@
-SAGE_SPKG_CONFIGURE([matplotlib-inline], [
+SAGE_SPKG_CONFIGURE([matplotlib_inline], [
   SAGE_PYTHON_PACKAGE_CHECK([matplotlib-inline])
 ])
```


Edit: small fix.



---

archive/issue_comments_417630.json:
```json
{
    "body": "A few more standard packages:\n\n```\ndiff --git a/build/pkgs/alabaster/spkg-configure.m4 b/build/pkgs/alabaster/spkg-configure.m4\nnew file mode 100644\nindex 0000000000..4eca6e05a5\n--- /dev/null\n+++ b/build/pkgs/alabaster/spkg-configure.m4\n@@ -0,0 +1 @@\n+SAGE_SPKG_CONFIGURE([alabaster], [SAGE_PYTHON_PACKAGE_CHECK([alabaster])])\ndiff --git a/build/pkgs/beniget/spkg-configure.m4 b/build/pkgs/beniget/spkg-configure.m4\nnew file mode 100644\nindex 0000000000..8ae6101333\n--- /dev/null\n+++ b/build/pkgs/beniget/spkg-configure.m4\n@@ -0,0 +1 @@\n+SAGE_SPKG_CONFIGURE([beniget], [SAGE_PYTHON_PACKAGE_CHECK([beniget])])\ndiff --git a/build/pkgs/gast/spkg-configure.m4 b/build/pkgs/gast/spkg-configure.m4\nnew file mode 100644\nindex 0000000000..26ec59feae\n--- /dev/null\n+++ b/build/pkgs/gast/spkg-configure.m4\n@@ -0,0 +1 @@\n+SAGE_SPKG_CONFIGURE([gast], [SAGE_PYTHON_PACKAGE_CHECK([gast])])\ndiff --git a/build/pkgs/gmpy2/spkg-configure.m4 b/build/pkgs/gmpy2/spkg-configure.m4\nnew file mode 100644\nindex 0000000000..2d0390f7db\n--- /dev/null\n+++ b/build/pkgs/gmpy2/spkg-configure.m4\n@@ -0,0 +1 @@\n+SAGE_SPKG_CONFIGURE([gmpy2], [SAGE_PYTHON_PACKAGE_CHECK([gmpy2])])\ndiff --git a/build/pkgs/importlib_metadata/spkg-configure.m4 b/build/pkgs/importlib_metadata/spkg-configure.m4\nnew file mode 100644\nindex 0000000000..d940b101b8\n--- /dev/null\n+++ b/build/pkgs/importlib_metadata/spkg-configure.m4\n@@ -0,0 +1 @@\n+SAGE_SPKG_CONFIGURE([importlib_metadata], [SAGE_PYTHON_PACKAGE_CHECK([importlib_metadata])])\ndiff --git a/build/pkgs/ply/spkg-configure.m4 b/build/pkgs/ply/spkg-configure.m4\nnew file mode 100644\nindex 0000000000..ffb0030d01\n--- /dev/null\n+++ b/build/pkgs/ply/spkg-configure.m4\n@@ -0,0 +1 @@\n+SAGE_SPKG_CONFIGURE([ply], [SAGE_PYTHON_PACKAGE_CHECK([ply])])\ndiff --git a/build/pkgs/pythran/spkg-configure.m4 b/build/pkgs/pythran/spkg-configure.m4\nnew file mode 100644\nindex 0000000000..592e95bcb3\n--- /dev/null\n+++ b/build/pkgs/pythran/spkg-configure.m4\n@@ -0,0 +1 @@\n+SAGE_SPKG_CONFIGURE([pythran], [SAGE_PYTHON_PACKAGE_CHECK([pythran])])\ndiff --git a/build/pkgs/typing_extensions/spkg-configure.m4 b/build/pkgs/typing_extensions/spkg-configure.m4\nnew file mode 100644\nindex 0000000000..d475fd8257\n--- /dev/null\n+++ b/build/pkgs/typing_extensions/spkg-configure.m4\n@@ -0,0 +1 @@\n+SAGE_SPKG_CONFIGURE([typing_extensions], [SAGE_PYTHON_PACKAGE_CHECK([typing_extensions])])\n```\n\n\nThere's also `cython` but it uses some patches so my system package, at the same version, doesn't work. The rest seems ok.",
    "created_at": "2021-12-30T23:22:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417630",
    "user": "tornaria"
}
```

A few more standard packages:

```
diff --git a/build/pkgs/alabaster/spkg-configure.m4 b/build/pkgs/alabaster/spkg-configure.m4
new file mode 100644
index 0000000000..4eca6e05a5
--- /dev/null
+++ b/build/pkgs/alabaster/spkg-configure.m4
@@ -0,0 +1 @@
+SAGE_SPKG_CONFIGURE([alabaster], [SAGE_PYTHON_PACKAGE_CHECK([alabaster])])
diff --git a/build/pkgs/beniget/spkg-configure.m4 b/build/pkgs/beniget/spkg-configure.m4
new file mode 100644
index 0000000000..8ae6101333
--- /dev/null
+++ b/build/pkgs/beniget/spkg-configure.m4
@@ -0,0 +1 @@
+SAGE_SPKG_CONFIGURE([beniget], [SAGE_PYTHON_PACKAGE_CHECK([beniget])])
diff --git a/build/pkgs/gast/spkg-configure.m4 b/build/pkgs/gast/spkg-configure.m4
new file mode 100644
index 0000000000..26ec59feae
--- /dev/null
+++ b/build/pkgs/gast/spkg-configure.m4
@@ -0,0 +1 @@
+SAGE_SPKG_CONFIGURE([gast], [SAGE_PYTHON_PACKAGE_CHECK([gast])])
diff --git a/build/pkgs/gmpy2/spkg-configure.m4 b/build/pkgs/gmpy2/spkg-configure.m4
new file mode 100644
index 0000000000..2d0390f7db
--- /dev/null
+++ b/build/pkgs/gmpy2/spkg-configure.m4
@@ -0,0 +1 @@
+SAGE_SPKG_CONFIGURE([gmpy2], [SAGE_PYTHON_PACKAGE_CHECK([gmpy2])])
diff --git a/build/pkgs/importlib_metadata/spkg-configure.m4 b/build/pkgs/importlib_metadata/spkg-configure.m4
new file mode 100644
index 0000000000..d940b101b8
--- /dev/null
+++ b/build/pkgs/importlib_metadata/spkg-configure.m4
@@ -0,0 +1 @@
+SAGE_SPKG_CONFIGURE([importlib_metadata], [SAGE_PYTHON_PACKAGE_CHECK([importlib_metadata])])
diff --git a/build/pkgs/ply/spkg-configure.m4 b/build/pkgs/ply/spkg-configure.m4
new file mode 100644
index 0000000000..ffb0030d01
--- /dev/null
+++ b/build/pkgs/ply/spkg-configure.m4
@@ -0,0 +1 @@
+SAGE_SPKG_CONFIGURE([ply], [SAGE_PYTHON_PACKAGE_CHECK([ply])])
diff --git a/build/pkgs/pythran/spkg-configure.m4 b/build/pkgs/pythran/spkg-configure.m4
new file mode 100644
index 0000000000..592e95bcb3
--- /dev/null
+++ b/build/pkgs/pythran/spkg-configure.m4
@@ -0,0 +1 @@
+SAGE_SPKG_CONFIGURE([pythran], [SAGE_PYTHON_PACKAGE_CHECK([pythran])])
diff --git a/build/pkgs/typing_extensions/spkg-configure.m4 b/build/pkgs/typing_extensions/spkg-configure.m4
new file mode 100644
index 0000000000..d475fd8257
--- /dev/null
+++ b/build/pkgs/typing_extensions/spkg-configure.m4
@@ -0,0 +1 @@
+SAGE_SPKG_CONFIGURE([typing_extensions], [SAGE_PYTHON_PACKAGE_CHECK([typing_extensions])])
```


There's also `cython` but it uses some patches so my system package, at the same version, doesn't work. The rest seems ok.



---

archive/issue_comments_417631.json:
```json
{
    "body": "I should mention that I'm using a patch created from branch `u/mjo/ticket/29665` rather than the whole thing to make it more manageable for me. I hope I'm not missing anything important.\n\nI'll let you know if anything goes wrong with doctesting. I'm now building using all possible system packages and python site packages available on void.",
    "created_at": "2021-12-30T23:29:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417631",
    "user": "tornaria"
}
```

I should mention that I'm using a patch created from branch `u/mjo/ticket/29665` rather than the whole thing to make it more manageable for me. I hope I'm not missing anything important.

I'll let you know if anything goes wrong with doctesting. I'm now building using all possible system packages and python site packages available on void.



---

archive/issue_comments_417632.json:
```json
{
    "body": "Everything passes with the following patch which is neecessary if `alabaster` is used from system.\n\n```\ndiff --git a/src/sage/misc/package.py b/src/sage/misc/package.py\nindex 84f3d50de7..c7ad206959 100644\n--- a/src/sage/misc/package.py\n+++ b/src/sage/misc/package.py\n@@ -386,9 +386,9 @@ def installed_packages(exclude_pip=True):\n     EXAMPLES::\n \n         sage: sorted(installed_packages().keys())  # optional - build\n-        [...'alabaster', ...'sage_conf', ...]\n-        sage: installed_packages()['alabaster']  # optional - build, random\n-        '0.7.12'\n+        [...'sage_conf', ...]\n+        sage: installed_packages()['sage_conf']  # optional - build, random\n+        '9.5'\n \n     .. SEEALSO::\n \n```\n",
    "created_at": "2021-12-31T02:15:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417632",
    "user": "tornaria"
}
```

Everything passes with the following patch which is neecessary if `alabaster` is used from system.

```
diff --git a/src/sage/misc/package.py b/src/sage/misc/package.py
index 84f3d50de7..c7ad206959 100644
--- a/src/sage/misc/package.py
+++ b/src/sage/misc/package.py
@@ -386,9 +386,9 @@ def installed_packages(exclude_pip=True):
     EXAMPLES::
 
         sage: sorted(installed_packages().keys())  # optional - build
-        [...'alabaster', ...'sage_conf', ...]
-        sage: installed_packages()['alabaster']  # optional - build, random
-        '0.7.12'
+        [...'sage_conf', ...]
+        sage: installed_packages()['sage_conf']  # optional - build, random
+        '9.5'
 
     .. SEEALSO::
 
```




---

archive/issue_comments_417633.json:
```json
{
    "body": "Thanks, I fixed the existing packages and added most of the new ones. I've left out `gmpy2` and `typing_extensions` because they aren't available in Gentoo yet (chicken and egg problem) so I'm unable to test them easily. I also added your alabaster doctest fix.\n\nI'm not sure if there were any new commits on Matthias's branch (it's impossible to tell when merge commits are involved), or if his dependencies are only intended to make this easier to test. In any case, I've switched it back to my branch which works fine in real life if not on github.",
    "created_at": "2021-12-31T02:24:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417633",
    "user": "mjo"
}
```

Thanks, I fixed the existing packages and added most of the new ones. I've left out `gmpy2` and `typing_extensions` because they aren't available in Gentoo yet (chicken and egg problem) so I'm unable to test them easily. I also added your alabaster doctest fix.

I'm not sure if there were any new commits on Matthias's branch (it's impossible to tell when merge commits are involved), or if his dependencies are only intended to make this easier to test. In any case, I've switched it back to my branch which works fine in real life if not on github.



---

archive/issue_comments_417634.json:
```json
{
    "body": "Replying to [comment:125 mjo]:\n> it's impossible to tell when merge commits are involved\n\ntry `git log --first-parent`",
    "created_at": "2021-12-31T02:44:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417634",
    "user": "mkoeppe"
}
```

Replying to [comment:125 mjo]:
> it's impossible to tell when merge commits are involved

try `git log --first-parent`



---

archive/issue_comments_417635.json:
```json
{
    "body": "Replying to [comment:126 mkoeppe]:\n> Replying to [comment:125 mjo]:\n> > it's impossible to tell when merge commits are involved\n> \n> try `git log --first-parent`\n\nThanks, I've been missing this my entire adult life. Can we teach trac to use it?",
    "created_at": "2021-12-31T03:58:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417635",
    "user": "mjo"
}
```

Replying to [comment:126 mkoeppe]:
> Replying to [comment:125 mjo]:
> > it's impossible to tell when merge commits are involved
> 
> try `git log --first-parent`

Thanks, I've been missing this my entire adult life. Can we teach trac to use it?



---

archive/issue_comments_417636.json:
```json
{
    "body": "Can `pytest` be not isolated also?",
    "created_at": "2021-12-31T10:34:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417636",
    "user": "@sheerluck"
}
```

Can `pytest` be not isolated also?



---

archive/issue_comments_417637.json:
```json
{
    "body": "Replying to [comment:128 gh-sheerluck]:\n> Can `pytest` be not isolated also?\nOh, yes, I forgot: since pytest gives problems (see #31924) I had to disable it:\n\n```\ndiff --git a/src/bin/sage-runtests b/src/bin/sage-runtests\nindex 589dc8cd37..6bb8bf99a4 100755\n--- a/src/bin/sage-runtests\n+++ b/src/bin/sage-runtests\n@@ -154,21 +154,4 @@ if __name__ == \"__main__\":\n     DC = DocTestController(args, args.filenames)\n     err = DC.run()\n \n-    try:\n-        exit_code_pytest = 0\n-        import pytest\n-        pytest_options = [\"--import-mode\", \"importlib\"]\n-        if args.verbose:\n-            pytest_options.append(\"-v\")\n-        exit_code_pytest = pytest.main(pytest_options + args.filenames)\n-        if exit_code_pytest == 5:\n-            # Exit code 5 means there were no test files, pass in this case\n-            exit_code_pytest = 0\n-\n-    except ModuleNotFoundError:\n-        print(\"Pytest is not installed, skip checking tests that rely on it.\")\n-\n-    if err == 0:\n-        sys.exit(exit_code_pytest)\n-    else:\n-        sys.exit(err)\n+    sys.exit(err)\n```\n\n\nI don't know any other way to workaround this problem until #31924 is fixed.",
    "created_at": "2021-12-31T15:02:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417637",
    "user": "tornaria"
}
```

Replying to [comment:128 gh-sheerluck]:
> Can `pytest` be not isolated also?
Oh, yes, I forgot: since pytest gives problems (see #31924) I had to disable it:

```
diff --git a/src/bin/sage-runtests b/src/bin/sage-runtests
index 589dc8cd37..6bb8bf99a4 100755
--- a/src/bin/sage-runtests
+++ b/src/bin/sage-runtests
@@ -154,21 +154,4 @@ if __name__ == "__main__":
     DC = DocTestController(args, args.filenames)
     err = DC.run()
 
-    try:
-        exit_code_pytest = 0
-        import pytest
-        pytest_options = ["--import-mode", "importlib"]
-        if args.verbose:
-            pytest_options.append("-v")
-        exit_code_pytest = pytest.main(pytest_options + args.filenames)
-        if exit_code_pytest == 5:
-            # Exit code 5 means there were no test files, pass in this case
-            exit_code_pytest = 0
-
-    except ModuleNotFoundError:
-        print("Pytest is not installed, skip checking tests that rely on it.")
-
-    if err == 0:
-        sys.exit(exit_code_pytest)
-    else:
-        sys.exit(err)
+    sys.exit(err)
```


I don't know any other way to workaround this problem until #31924 is fixed.



---

archive/issue_comments_417638.json:
```json
{
    "body": "For the record, in addition to what is in the current patch, I'm also using from system:\n- `gmpy2-2.1.1` (I had to patch `install-requires.txt` since it currently requires `2.1.0rc1`)\n- `sphinx-4.3.2` (I had to update it in void linux)\n- `typing_extensions-3.10.0.2`\n\nI also had to patch `ptyprocess/install-requires.txt` to allow `ptyprocess-0.7.0` since it currently requires `0.5.1` but this version seems to work ok.\n\nOf all the python packages added by this patch only three were not available for me on void linux: `cvxopt`, `importlib_resources` and `debugpy`, everything else was tested (note that `debugpy` is optional now)",
    "created_at": "2021-12-31T18:16:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417638",
    "user": "tornaria"
}
```

For the record, in addition to what is in the current patch, I'm also using from system:
- `gmpy2-2.1.1` (I had to patch `install-requires.txt` since it currently requires `2.1.0rc1`)
- `sphinx-4.3.2` (I had to update it in void linux)
- `typing_extensions-3.10.0.2`

I also had to patch `ptyprocess/install-requires.txt` to allow `ptyprocess-0.7.0` since it currently requires `0.5.1` but this version seems to work ok.

Of all the python packages added by this patch only three were not available for me on void linux: `cvxopt`, `importlib_resources` and `debugpy`, everything else was tested (note that `debugpy` is optional now)



---

archive/issue_comments_417639.json:
```json
{
    "body": "Replying to [comment:130 tornaria]:\n> I also had to patch `ptyprocess/install-requires.txt` to allow `ptyprocess-0.7.0` since it currently requires `0.5.1` but this version seems to work ok.\n\nSee #32147",
    "created_at": "2021-12-31T18:35:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417639",
    "user": "mkoeppe"
}
```

Replying to [comment:130 tornaria]:
> I also had to patch `ptyprocess/install-requires.txt` to allow `ptyprocess-0.7.0` since it currently requires `0.5.1` but this version seems to work ok.

See #32147



---

archive/issue_comments_417640.json:
```json
{
    "body": "Replying to [comment:130 tornaria]:\n> For the record, in addition to what is in the current patch, I'm also using from system:\n>  - `gmpy2-2.1.1` (I had to patch `install-requires.txt` since it currently requires `2.1.0rc1`)\n\nThis is now done in the updated #33070",
    "created_at": "2022-01-01T04:37:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417640",
    "user": "mkoeppe"
}
```

Replying to [comment:130 tornaria]:
> For the record, in addition to what is in the current patch, I'm also using from system:
>  - `gmpy2-2.1.1` (I had to patch `install-requires.txt` since it currently requires `2.1.0rc1`)

This is now done in the updated #33070



---

archive/issue_comments_417641.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2022-02-07T12:15:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29428",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29428#issuecomment-417641",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:
