# Issue 29428: spkg-configure.m4 for cvxopt

Issue created by migration from https://trac.sagemath.org/ticket/29665

Original creator: @thierry-FreeBSD

Original creation time: 2020-05-08 14:40:42

Keywords: cvxopt; spkg-configure; system packages; Python library

This ticket adds an spkg-configure.m4 for cvxopt, in order to use it from a system package if possible (see #27330).

This one is a bit special, because cvxopt is a Python module.

The proposed attachment uses `python3`: I donÂ´t like that, but at this point `$ac_path_PYTHON3` is not yet defined. (Note: on FreeBSD we have no python3 by default, and I have to patch it with the real versioned program name, but I guess that `python3` is more portable)

To build Sage with it, `build/make/install` must be modified: it sets `PYTHONPATH` to `$SAGE_LOCAL`, and the system-wide Python modules are not found. It must be replaced by something like


```
"$SAGE_LOCAL:$SAGE_LOCAL/$PYTHON_SITELIBDIR:$PYTHON_SITELIBDIR"
```


with `$PYTHON_SITELIBDIR` being the site-packages directory used. So the Sage-built packages are always found in the first place, and those from the system are found when needed.


---

Comment by @thierry-FreeBSD created at 2020-05-08 14:42:34

spkg-configure.m4 to be copied under build/pkgs/cvxopt


---

Attachment

I don't see a branch


---

Comment by mkoeppe created at 2020-05-08 15:36:50

See comments in #29023


---

Comment by mkoeppe created at 2020-08-11 17:37:05

"wontfix" because of #29023
----
New commits:


---

Comment by mkoeppe created at 2020-08-11 17:37:05

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-08-13 09:07:37

There is per se nothing wrong with having spkg-configure.m4 for Python packages.


---

Comment by mkoeppe created at 2020-08-13 14:51:54

Not per se, only per the big picture.


---

Comment by mjo created at 2021-09-18 18:04:55

Regardless of what we eventually wind up with... does this work? Does it hurt anything? The solution in #29023 could be years away. If we can avoid building e.g. numpy, scipy, matplotlib, and cvxopt with relatively trivial spkg-configures until then, why not do it?


---

Comment by mkoeppe created at 2021-09-18 18:08:46

No, it does not work.


---

Comment by mjo created at 2021-09-19 00:12:17

Replying to [comment:8 mkoeppe]:
> No, it does not work. 

What goes wrong? I just did a quick test (without this branch):

1. make cvxopt-clean
2. install system cvxopt
3. touch any file in sagelib names `*cvxopt*`
4. sage -b
5. run some tests on said cvxopt files

Behavior is unchanged as far as I can tell.


---

Comment by mkoeppe created at 2021-09-19 00:17:37

Sound like you forgot to test with `--optional=sage,cvxopt`. 

Sage runs in a venv that does not provide access to system site packages.


---

Comment by mjo created at 2021-09-19 00:57:05

Replying to [comment:10 mkoeppe]:
> Sound like you forgot to test with `--optional=sage,cvxopt`. 
> 
> Sage runs in a venv that does not provide access to system site packages.

Lucky guess! I forgot we made it possible to disable cvxopt even though it's type=standard. On the surface, setting  `include-system-site-packages = true` in `local/pyvenv.cfg` looks like it solves that, and is one of the first steps mentioned on #29023. What necessitates the next step B.2. in #29023? In other words, what's the next thing that's going to go wrong for me?


---

Comment by mkoeppe created at 2021-09-19 01:09:56

Let's take the discussion of #29023 to #29023. I think it would be fine if you want to go ahead with step B.1 (via a new option `./configure --enable-system-site-packages`) in a ticket, for users to experiment.


---

Comment by mjo created at 2021-10-11 13:22:26

Matthias, does something like this fit with your master plan?
----
Last 10 new commits:


---

Comment by mjo created at 2021-10-11 13:22:26

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-10-11 17:13:06

I wouldn't object to doing something like this, as it is clearly marked experimental.

However, be prepared for a long-term burden of maintenance regarding the declared version ranges. Lots of things can go wrong because the individual packages often have complicated version constraints.

Also the version constraints shouldn't be hardcoded in the spkg-configure.m4 file; instead, they should really be taken from `install-requires.txt`.
Likewise, don't use distutils, it's on its way out. Use a higher-level library that can check the requirements

Also, note `scandir` is gone after #32626


---

Comment by git created at 2021-10-12 14:07:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mjo created at 2021-10-12 14:13:10

Replying to [comment:14 mkoeppe]:
> 
> However, be prepared for a long-term burden of maintenance regarding the declared version ranges. Lots of things can go wrong because the individual packages often have complicated version constraints.

How so? The version information is maintained separately in `install-requires.txt`. And on Gentoo, most of these packages are already present and maintained by somebody else.

> Also the version constraints shouldn't be hardcoded in the spkg-configure.m4 file; instead, they should really be taken from `install-requires.txt`.

Done.

> Likewise, don't use distutils, it's on its way out. Use a higher-level library that can check the requirements

I'm using setuptools now, because I figure it (with its vendored "packaging") is more likely to be present than the "packaging" package itself.

> Also, note `scandir` is gone after #32626

Thanks, I dropped that one, and added a few more.


---

Comment by mjo created at 2021-10-12 14:13:57

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-10-12 16:22:46

Replying to [comment:17 mjo]:
> Replying to [comment:14 mkoeppe]:
> > 
> > However, be prepared for a long-term burden of maintenance regarding the declared version ranges. Lots of things can go wrong because the individual packages often have complicated version constraints.
> 
> How so? The version information is maintained separately in `install-requires.txt`. And on Gentoo, most of these packages are already present and maintained by somebody else.

The metadata in these packages (distributions published on PyPI) declares install-requires as well. pip's resolver inspects all of these version constraints.


---

Comment by mkoeppe created at 2021-10-12 16:26:29

Could you update the ticket description please?


---

Comment by mkoeppe created at 2021-10-12 16:47:54

With #32442, which sets up `SAGE_VENV = SAGE_LOCAL/var/lib/sage/venv-PYTHONVERSION` by default, one could consider to use a suffix `+site` in the case that `--enable-system-site-packages` was used.


---

Comment by mkoeppe created at 2021-10-12 17:15:44

Also, when `--enable-system-site-packages` has been given but system python3 is not used, this should be an error.


---

Comment by mjo created at 2021-10-13 12:49:07

Replying to [comment:22 mkoeppe]:
> Also, when `--enable-system-site-packages` has been given but system python3 is not used, this should be an error.

I think this is working as intended, but I still have to check it with python3 installed from an SPKG. The intention is that `--enable-system-site-packages` will only attempt to use packages from the system; not force it. If we're using python from the SPKG, the macro should always fail (this is in its documentation), and thus we'll use SPKGs for all of the python stuff.

I don't think we need to bail out with an error unless that process can somehow do the wrong thing?


---

Comment by mkoeppe created at 2021-10-13 16:16:10

User expectations -- users may be interested in this option because they want to actually use system Python packages (which we don't have as SPKG), not just save time on installation. So it's best to tell them upfront that it won't work, instead of making them go through an hours-long build and failure and mailing list Q&A.


---

Comment by mjo created at 2021-10-13 17:26:10

Replying to [comment:25 mkoeppe]:
> User expectations -- users may be interested in this option because they want to actually use system Python packages (which we don't have as SPKG), not just save time on installation. So it's best to tell them upfront that it won't work, instead of making them go through an hours-long build and failure and mailing list Q&A.

We could make that possible with another option, like `--enable-user-site-packages`, that would undo the intentional breakage in sage-env:


```python
# Set PYTHONUSERBASE to avoid picking up non-Sage versions of
# Matplotlib, numpy, etc. See http://trac.sagemath.org/ticket/19612.
#
# For more history (it used to be PYTHONNOUSERSITE=yes which killed
# the ability to do "sage -pip install PACKAGE --user"), see
# http://trac.sagemath.org/ticket/14243 and
# http://trac.sagemath.org/ticket/18955.

if [ "$PYTHONUSERBASE" = "" ]; then
    PYTHONUSERBASE="$DOT_SAGE/local"
    export PYTHONUSERBASE
fi
```


The "system" site packages do work either way... you're just getting a different "system" with the SPKG than you would with `/usr/bin/python3`. Regardless, I only build with `--with-system-python3=force`, so I won't belabor this distinction.

I'll change `--enable-system-site-packages` to set `--with-system-python3=force`.


---

Comment by mkoeppe created at 2021-10-13 17:40:06

I was talking about system site packages.

Replying to [comment:26 mjo]:
> The "system" site packages do work either way... you're just getting a different "system" with the SPKG than you would with `/usr/bin/python3`. 

I know that, you know that, I know that you know that, etc., but users don't.

> I'll change `--enable-system-site-packages` to set `--with-system-python3=force`.

Great, thanks.


---

Comment by mkoeppe created at 2021-10-13 17:41:48

Replying to [comment:26 mjo]:
> another option, like `--enable-user-site-packages`, that would undo the intentional breakage in sage-env:
> 
> {{{#!python
> # Set PYTHONUSERBASE to avoid picking up non-Sage versions of

Actually in venvs, the user scheme is altogether disabled by Python - see https://packaging.python.org/tutorials/installing-packages/#installing-to-the-user-site


---

Comment by git created at 2021-10-14 12:15:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2021-10-14 12:16:35

Feels too easy for something involving autotools, but that last commit looks like it does the trick.


---

Comment by mkoeppe created at 2021-10-14 20:43:58

The next thing is that at the end of configure, it now recommends to install system python packages -- which is useless (unless the experimental new option is used) and potentially will confuse users.


---

Comment by mkoeppe created at 2021-10-14 20:57:41

So perhaps instead of supplying `spkg-configure.m4` files, in `m4/sage_spkg_collect.m4` if a package does not have `spkg-configure.m4` but it has `install-requires.txt`, just run the test?


---

Comment by dimpase created at 2021-10-14 20:59:11

is it distinguishing system and user-installed python packages?


---

Comment by mkoeppe created at 2021-10-14 21:06:11

see comment:28


---

Comment by mkoeppe created at 2021-10-14 21:08:46

The new test in m4/sage_python_package_check.m4 should really be run with a venv, not the `PYTHON_FOR_VENV` directly -- or, as per Dima's comment, you would need to poison the user scheme in another way, so that the configure test does not take user packages into account.


---

Comment by mkoeppe created at 2021-10-14 22:45:37

An easy way to do this is could be to run these tests as part of the `python3` spkg-configure.m4, which already creates a venv for testing


---

Comment by mjo created at 2021-10-14 22:54:52

Replying to [comment:31 mkoeppe]:
> The next thing is that at the end of configure, it now recommends to install system python packages -- which is useless (unless the experimental new option is used) and potentially will confuse users.

This, at least, is easy: we can delete `distros/` for the python packages all in one commit. Then whenever we intend to actually use that information, it can be `git revert`ed.


---

Comment by mjo created at 2021-10-14 22:56:29

Replying to [comment:35 mkoeppe]:
> The new test in m4/sage_python_package_check.m4 should really be run with a venv, not the `PYTHON_FOR_VENV` directly -- or, as per Dima's comment, you would need to poison the user scheme in another way, so that the configure test does not take user packages into account.

Should we not poison `PYTHONUSERBASE` in the same way that sage-env does it? That way the test and what you get at runtime is at least consistent.


---

Comment by mkoeppe created at 2021-10-15 03:37:47

No, see comment:28: `PYTHONUSERBASE` does not matter because for venvs, the user installation scheme is already disabled by Python.


---

Comment by mjo created at 2021-10-15 03:47:48

Replying to [comment:39 mkoeppe]:
> No, see comment:28: `PYTHONUSERBASE` does not matter because for venvs, the user installation scheme is already disabled by Python.

Oh, right. Do you see any reason why I shouldn't delete that code from sage-env, then?


---

Comment by mkoeppe created at 2021-10-15 03:48:08

Actually I have to correct myself: venvs that enable system site packages do not disable the user scheme. https://github.com/python/cpython/blob/main/Lib/site.py#L533


---

Comment by mkoeppe created at 2021-10-15 03:49:27

So the correct test in configure is to set up the venv AND to set PYTHONUSERBASE in the same way as sage-env would do.


---

Comment by mjo created at 2021-10-15 03:50:55

Ok, I have to do my actual job for about an hour but then I'll take a stab at it.


---

Comment by git created at 2021-10-15 05:21:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2021-10-15 05:28:37

I'll have to look into using a venv tomorrow. What's there now is an improvement, though.


---

Comment by git created at 2021-10-15 17:21:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-15 17:38:10

Replying to [comment:44 git]:
> ||[2dafaf0](https://git.sagemath.org/sage.git/commit/?id=2dafaf092ef1c547a1dde4713f643f7704e6cc02)||`Trac #29665: remove "distros" information for python packages.`||

That's not a good solution


---

Comment by mjo created at 2021-10-15 23:18:09

Replying to [comment:47 mkoeppe]:
> Replying to [comment:44 git]:
> > ||[2dafaf0](https://git.sagemath.org/sage.git/commit/?id=2dafaf092ef1c547a1dde4713f643f7704e6cc02)||`Trac #29665: remove "distros" information for python packages.`||
> 
> That's not a good solution

I'll take a few days to try to think of something better, but removing `distros/` is going to be hard to beat for simplicity and ease of implementation. The sole purpose of those files is to do the thing you don't want to happen. Removing them prevents it, and doesn't hurt anything else.

Keeping the files that cause the wrong thing to happen and then trying to stop the wrong thing from happening somewhere else is only going to push our `./configure` further down the path to Mouse Trap. These system packages already work flawlessly for me. If there are no major problems, we could enable this by default as early as sage-9.6, bring back the `distros/`, and never have to worry about if the swimmer hits the plate just right to launch the cannonball into the bathtub to disable the system package suggestion.


---

Comment by mkoeppe created at 2021-10-15 23:39:22

But then how do we test that this new experimental switch actually works on a distribution?

The `distros` information is not just for the user, but also for provisioning the test environment on GH Actions etc.


---

Comment by mkoeppe created at 2021-10-15 23:40:56

And in comment:32 I have already explained a simple implementation strategy


---

Comment by git created at 2021-10-16 12:27:14

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2021-10-16 12:35:06

Replying to [comment:50 mkoeppe]:
> And in comment:32 I have already explained a simple implementation strategy

Not every package with an `install-requires.txt` requires `--enable-system-site-packages`. Hiding the package checks in two different places is also not great for maintainability; but more importantly, not every package uses the same check. Some have DEPCHECKs, and in the future I'm sure we'll need feature tests to ensure that e.g. matplotlib has support for our documented export formats.

In principle I'd rather hack the test setup than the build system if we have to do it for a release or two. But maybe my latest commit solves it without any collateral damage (I hope).


---

Comment by git created at 2021-10-16 12:39:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-10-16 21:17:35

To test this more thoroughly,
- we need many more `distros/` files for various platforms
- need a GH Actions workflow to automate this - see #32703 for a possible approach


---

Comment by git created at 2021-10-17 10:25:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-18 01:34:08

When the new experimental option is not used, the configure tests should probably say something like "skipping test, only available with --enable-system-site-packages (experimental)" before it concludes "no suitable system package found"


---

Comment by git created at 2021-10-18 04:04:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-18 04:21:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-18 05:45:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2021-10-18 12:00:33

New commits:


---

Comment by mkoeppe created at 2021-10-24 20:21:18

Tested using #32703 at https://github.com/mkoeppe/sage/runs/3987632855:
It thinks that `setuptools` is available, but then it isn't
----
New commits:


---

Comment by mkoeppe created at 2021-10-24 20:21:18

Changing status from needs_review to needs_work.


---

Comment by mjo created at 2021-10-24 21:16:39

Replying to [comment:66 mkoeppe]:
> Tested using #32703 at https://github.com/mkoeppe/sage/runs/3987632855:
> It thinks that `setuptools` is available, but then it isn't

You sure setuptools isn't there? The new autoconf macro uses it to check for all of the other packages. If the whole thing is not crashing and burning (and if I did not flip an exit code somewhere...) setuptools is probably there.

Maybe something to do with `export PYTHONPATH="$(pwd)/src"` in pip's `spkg-install.in`.


---

Comment by mkoeppe created at 2021-10-24 21:20:59

Replying to [comment:67 mjo]:
> Replying to [comment:66 mkoeppe]:
> > Tested using #32703 at https://github.com/mkoeppe/sage/runs/3987632855:
> > It thinks that `setuptools` is available, but then it isn't
> 
> You sure setuptools isn't there? The new autoconf macro uses it to check for all of the other packages. If the whole thing is not crashing and burning (and if I did not flip an exit code somewhere...) setuptools is probably there.

Well, it is probably present in the test venv. But as you can see in the test, it's not present in the venv at build time.


---

Comment by mkoeppe created at 2021-10-24 21:21:22

Replying to [comment:67 mjo]:
> Maybe something to do with `export PYTHONPATH="$(pwd)/src"` in pip's `spkg-install.in`.

I don't think so.


---

Comment by mjo created at 2021-10-24 21:48:11

Is `python3` not the `$PYTHON_FOR_VENV` on this machine? The `sdh_*` scripts call `python3` directly, while the macro uses `$PYTHON_FOR_VENV`. That's the only thing I can think of.


---

Comment by mkoeppe created at 2021-10-24 22:20:58

Replying to [comment:70 mjo]:
> The `sdh_*` scripts call `python3` directly
... because they run with the venv activated. This is correct.


---

Comment by mkoeppe created at 2021-10-24 22:24:03


```
+    dnl Use --clear because ./configure typically clobbers its output files.
+    AS_IF(["${PYTHON_FOR_VENV}" -m venv --system-site-packages dnl
+                                        --clear                dnl
+                                        --without-pip          dnl
+                                        config.venv            dnl
+                                        2>&AS_MESSAGE_LOG_FD], [
```

I think you should change this to use the `sage-venv` script, like `m4/sage_check_python_for_venv.m4` does.


---

Comment by mkoeppe created at 2021-10-24 22:25:20

(I don't know if this will change anything -- but it's best to use the script that we actually use to set up the production venv to set up the test venv.)


---

Comment by mjo created at 2021-10-24 22:46:38

Replying to [comment:73 mkoeppe]:
> (I don't know if this will change anything -- but it's best to use the script that we actually use to set up the production venv to set up the test venv.)

What does this script abstract, anyway? It's only called in two places so far (`build/make/Makefile.in` and `m4/sage_check_python_for_venv.m4`, and in both places we have access to the full path to the python interpreter and the flags that should be passed to `-m venv` (now called `$SAGE_VENV_FLAGS`).

If the only thing it does is handle `--symlinks`, then we could add `--symlinks` to `$SAGE_VENV_FLAGS` in `configure.ac` dependent upon the platform and avoid the separate script that just reimplements `-m venv`.


---

Comment by mkoeppe created at 2021-10-24 23:13:16

Clearly outside the scope of this ticket to make changes to the well-working `sage-venv` script.


---

Comment by mjo created at 2021-10-25 00:42:17

I dropped the toml commit because somebody else added an `spkg-configure.m4` in the meantime and I don't want to worry about reconciling them.
----
Last 10 new commits:


---

Comment by mkoeppe created at 2021-10-25 00:45:58

You didn't like how I merged it in eeae67c?


---

Comment by mjo created at 2021-10-25 00:54:04

Replying to [comment:77 mkoeppe]:
> You didn't like how I merged it in eeae67c?

That part is probably fine but huge merge commits aren't very nice to review.

There are a bunch of other python packages with similar spkg-configures that I skipped initially. Once the `--enable-system-site-packages` mechanism works well enough to enable by default, I'll go back and replace them all at once with the trivial python spkg-configure that all of the other packages are using.


---

Comment by mjo created at 2021-10-25 02:09:59

Replying to [comment:71 mkoeppe]:
> Replying to [comment:70 mjo]:
> > The `sdh_*` scripts call `python3` directly
> ... because they run with the venv activated. This is correct.

So both are supposedly running the symlink `/Users/runner/work/sage/sage/.tox/local-homebrew-macos-standard/local/bin/python3`, which should point to the real homebrew python3, by way of its being near the front of `PATH`. I'd love to know how it loses track of setuptools in the span of a few seconds, but I'm at a loss for ways to test it without a mac.


---

Comment by mkoeppe created at 2021-10-25 02:28:16

It is unlikely that any of this is macOS-specific. It's just the only environment for which I have built #32703 so far. Help on that is welcome.


---

Comment by mjo created at 2021-10-25 02:39:17

I tried installing a separate copy of python-3.9.6 in `/home/mjo/tmp/python3` that doesn't have setuptools. After prepending `/home/mjo/tmp/python3/bin` to my `PATH`, I configured sage with `--with-python=/usr/bin/python3`, the "good" copy that has setuptools. Everything is detected and pip builds normally.


---

Comment by git created at 2021-11-03 13:23:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2021-11-03 23:38:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2021-11-04 22:55:40

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-11-05 16:58:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2021-11-05 17:05:49

Something's gone wrong in the meantime. I'm now seeing cypari fail to cythonize.

cypari has a custom patch that in turn requires a custom patched cython, so I wouldn't expect it to work with the system cython... but I've got the cython SPKG installed. Must be somehow the system cython is getting used.


---

Comment by mjo created at 2021-11-06 13:14:56

Replying to [comment:86 mjo]:
> Must be somehow the system cython is getting used.

I think this explains all of the problems observed so far:


```
$ sage -c "print(sys.path)"
['/home/mjo/src/sage.git/src/bin',
 '/usr/lib/python39.zip',
 '/usr/lib/python3.9',
 '/usr/lib/python3.9/lib-dynload',
 '/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages', 
 '/usr/lib/python3.9/site-packages']
```


I have been assuming that the venv would be searched before the system paths. When it isn't, installing an SPKG to override an unusable system package doesn't work.


---

Comment by mkoeppe created at 2021-11-06 17:36:32

Replying to [comment:87 mjo]:
> I have been assuming that the venv would be searched before the system paths.

It is searched before the system `site-packages`; but not before the paths that provide the Python standard library.


---

Comment by mjo created at 2021-11-06 17:47:18

Replying to [comment:88 mkoeppe]:
> Replying to [comment:87 mjo]:
> > I have been assuming that the venv would be searched before the system paths.
> 
> It is searched before the system `site-packages`; but not before the paths that provide the Python standard library.

Yeah, thanks, I realized that later. The problem with cython is due to pip refusing to install a wheel that's the same version as the existing one. You dealt with that recently by issuing a `pip uninstall` prior to `pip install`... but the uninstall does nothing if cython comes from the system. We're going to have the same issue with many patched python packages.


---

Comment by mkoeppe created at 2021-11-06 18:12:58

Replying to [comment:89 mjo]:
> The problem with cython is due to pip refusing to install a wheel that's the same version as the existing one. You dealt with that recently by issuing a `pip uninstall` prior to `pip install`... but the uninstall does nothing if cython comes from the system. We're going to have the same issue with many patched python packages.

Aha, interesting. 
That's the 2nd and 3rd bullet points in #29023 "Questions to be resolved".


---

Comment by mkoeppe created at 2021-11-06 18:15:06

So in the case of `--enable-system-site-packages`, we may have to add `--ignore-installed` to the options when installing the wheel.


---

Comment by mjo created at 2021-11-06 18:19:46

Replying to [comment:91 mkoeppe]:
> So in the case of `--enable-system-site-packages`, we may have to add `--ignore-installed` to the options when installing the wheel.

That was already part of the fallback case in `sage-pip-install`, but the install conflict doesn't actually cause an error -- only a warning. I've already moved it from the fallback into the main `pip_install_flags` and will see what happens.


---

Comment by git created at 2021-11-07 12:13:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-07 17:47:48

Won't this reinstall dependencies of every package every time?


---

Comment by mjo created at 2021-11-07 18:34:27

Replying to [comment:94 mkoeppe]:
> Won't this reinstall dependencies of every package every time?

That would have been a smart thing for me to check a few hours ago, but I saw a bunch of unrelated doctest failures and just clobbered my local checkout to confirm that #32836 occurs on the unmodified develop branch.

I'll switch back to this ticket eventually and make sure that we're not installing dependencies that shouldn't be. It would be especially counterproductive if pip was installing local copies of dependencies when the intention is to use those from the system.


---

Comment by mjo created at 2021-11-09 03:25:03

Replying to [comment:94 mkoeppe]:
> Won't this reinstall dependencies of every package every time?

Sort of. It actually winds up doing the right thing in most cases, but pollutes the logs and probably wastes a few seconds.

If the dependency is installed as a system package, an error gets thrown and the whole thing is retried with `--no-deps`, which makes it work. For example with system setuptools: 


```
[setuptools_scm-6.3.2] ERROR: Could not find a version that satisfies the requirement setuptools (from setuptools-scm) (from versions: none)
[setuptools_scm-6.3.2] ERROR: No matching distribution found for setuptools
[setuptools_scm-6.3.2] Warning: installing with ... failed. Retrying, adding "--no-deps --ignore-requires-python"
[setuptools_scm-6.3.2] Using pip 21.2.4 from /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/pip (python 3.9)
...
[setuptools_scm-6.3.2] Successfully installed setuptools-scm-6.3.2
[setuptools_scm-6.3.2] Warning: The installation needed to use "--no-deps --ignore-requires-python" to succeed. This means that a dependencies file in build/pkgs/ needs to be updated. Please report this to sage-devel@googlegroups.com, including the build log of this package.
```


However, when the dependency itself is installed as an SPKG, it looks like a portion of its installation routine is re-run. Here's cypari reinstalling cysignals/cython:


```
[cypari-2.1.2] Using pip 21.2.4 from /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/pip (python 3.9)
[cypari-2.1.2] Looking in links: /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/var/lib/sage/wheels
[cypari-2.1.2] Processing /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/var/tmp/sage/build/cypari-2.1.2/inst/home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/var/lib/sage/wheels/cypari2-2.1.2-cp39-cp39-linux_x86_64.whl
[cypari-2.1.2] Processing /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/var/lib/sage/wheels/cysignals-1.10.3-cp39-cp39-linux_x86_64.whl
[cypari-2.1.2] Processing /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/var/lib/sage/wheels/Cython-0.29.24-cp39-cp39-linux_x86_64.whl
[cypari-2.1.2] Installing collected packages: Cython, cysignals, cypari2
[cypari-2.1.2]   changing mode of /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/bin/cygdb to 755
[cypari-2.1.2]   changing mode of /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/bin/cython to 755
[cypari-2.1.2]   changing mode of /home/mjo/src/sage.git/local/var/lib/sage/venv-python3.9/bin/cythonize to 755
[cypari-2.1.2] Successfully installed Cython-0.29.24 cypari2-2.1.2 cysignals-1.10.3
```


I'm not sure what all it's doing, or how undesirable it is in the general case. It doesn't take noticeably longer, and everything works out in the end.

I suppose I'll add both `--no-deps` and `--ignore-installed`, but only when `--enable-system-site-packages` is on. If it ever becomes default, we'll just have to run a CI with `--disable-system-site-packages` to detect stale deps using that warning.


---

Comment by mkoeppe created at 2021-11-09 04:18:40

Replying to [comment:96 mjo]:
> I suppose I'll add both `--no-deps` and `--ignore-installed`, but only when `--enable-system-site-packages` is on. 
Yes, this seems to be the way forward.


---

Comment by git created at 2021-11-10 01:38:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2021-11-10 01:45:25

I've cherry-picked your changes from #32715, and added the ability to pass `--ignore-installed` to `sdh_pip_install`, too. Afterwards I pass the new variable `$SAGE_SDH_PIP_INSTALL_FLAGS` to every invocation of `sdh_pip_install` in an `spkg-install.in` file.

I think this is a tiny bit cleaner than introducing a dependency upon `sage-build-env-config` within `sage-dist-helpers`, but the duplication is hard to overlook. If you prefer to have `sdh_pip_install` directly use `$SAGE_SDH_PIP_INSTALL_FLAGS`, I'm happy to do it that way too.


---

Comment by mkoeppe created at 2021-11-10 01:53:36

Replying to [comment:99 mjo]:
> the duplication is hard to overlook

Yes, this is too much


---

Comment by git created at 2021-11-10 02:26:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2021-11-10 02:28:51

Ok, `sdh_pip_install` handles it now. I didn't even have to source `sage-build-env-config`, since in the context of `spkg-install.in` it will already have been sourced. And in any other context, an empty `$SAGE_SDH_PIP_INSTALL_OPTIONS` has no effect.


---

Comment by mkoeppe created at 2021-11-10 02:37:58

I think this should go into `sdh_store_and_pip_install_wheel`, not `sdh_pip_install`


---

Comment by git created at 2021-11-10 18:42:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mjo created at 2021-11-10 18:47:34

Adding more and more packages (whatever is available on Gentoo) and things still look OK.

When you get a second, can you double-check if this should be "dateutil" or "python-dateutil"?


```
$ cat build/pkgs/dateutil/install-requires.txt 
dateutil >=2.8.1
```


cf. https://github.com/dateutil/dateutil/blob/master/setup.cfg


---

Comment by mkoeppe created at 2021-11-10 20:05:04

It should be *python-dateutil* (https://pypi.org/project/python-dateutil/), thanks for catching this.

Many of these `install-requires.txt` file are only decoration at the moment; only the `install-requires.txt` files of those packages that are named in files like `src/setup.cfg.m4` are used.


---

Comment by git created at 2021-11-11 10:24:25

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mjo created at 2021-11-11 11:04:59

I haven't been able to test ptyprocess yet due to a version mismatch on Gentoo, and importllib_resources will need some subsequent work (it's built-in to python >= 3.9, but the existing check will save you a pointless pip install if you happen to be running an older python). And I've avoided anything with patches for now.

Otherwise, I think it's good.


---

Comment by mjo created at 2021-11-12 12:59:53

The test suite still passes with all of those packages installed on the system.

I did discover one more problem that we'll need to be aware of in the future. A lot of python packages have "automagic" dependencies that get used if they're available at runtime, rather than detected/configured at build-time. With python-3.9, for example, having an old version of ipyparallel installed will cause ipykernel to throw a deprecation warning that fails a doctest in `repl/ipython_kernel/kernel.py`.

We could try to address all of those (as they're reported) in `spkg-configure.m4`. Something like,


```
AC_DEFUN([SAGE_PYTHON_RUN_IFELSE], [dnl
cat >conftest.py <<SAGE__EOF
$1
SAGE__EOF
AS_IF(["${PYTHON_FOR_VENV}" conftest.py 1>&AS_MESSAGE_LOG_FD 2>&AS_MESSAGE_LOG_FD],[$2],[$3])
])
```


can be used to detect serious problems that are amenable to such a test. But for cosmetic issues like deprecation warnings I think we're better off just hiding them from the test suite. Or letting them fail (what's the point of the test suite?). Regardless, we can only ever hope to address the problems that exist when sage is being built. If I build sage and _then_ install the old ipyparallel, there's nothing sage can do to stop me. That's not really a new problem of course, but it will show up more often with python packages than with C packages due to the prevalence of automagic features in python.


---

Comment by mjo created at 2021-11-12 12:59:53

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-11-12 18:05:25

Replying to [comment:109 mjo]:
> A lot of python packages have "automagic" dependencies that get used if they're available at runtime, rather than detected/configured at build-time. 

Yes, this is normal - with PEP 517/518, the build environment is separate from the runtime environment.


---

Comment by mkoeppe created at 2021-11-12 18:08:17

Broken "plugins" break things, I don't think there's a need to do anything about it.


---

Comment by mkoeppe created at 2021-11-12 18:09:35

Replying to [comment:108 mjo]:
> I haven't been able to test ptyprocess yet due to a version mismatch on Gentoo

For `ptyprocess`, see #32147


---

Comment by dimpase created at 2021-11-17 16:37:26

rebase please


---

Comment by git created at 2021-11-17 21:26:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mjo created at 2021-11-17 21:28:37

Replying to [comment:113 dimpase]:
> rebase please

I'd love to know why these branches are going red... this one rebased cleanly just like #32037 did.


---

Comment by mkoeppe created at 2021-12-22 19:23:17

Last 10 new commits:


---

Comment by git created at 2021-12-22 19:24:42

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-12-22 20:27:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tornaria created at 2021-12-30 22:57:59

A few fixes in package names in `spkg-configure.m4`:

```
diff --git a/build/pkgs/argon2_cffi/spkg-configure.m4 b/build/pkgs/argon2_cffi/spkg-configure.m4
index 9ae7f2ea0c..ff476db0b2 100644
--- a/build/pkgs/argon2_cffi/spkg-configure.m4
+++ b/build/pkgs/argon2_cffi/spkg-configure.m4
@@ -1 +1 @@
-SAGE_SPKG_CONFIGURE([argon2-cffi], [SAGE_PYTHON_PACKAGE_CHECK([argon2-cffi])])
+SAGE_SPKG_CONFIGURE([argon2_cffi], [SAGE_PYTHON_PACKAGE_CHECK([argon2-cffi])])
diff --git a/build/pkgs/jupyter_client/spkg-configure.m4 b/build/pkgs/jupyter_client/spkg-configure.m4
index 3c9bb26bb0..1d2735de59 100644
--- a/build/pkgs/jupyter_client/spkg-configure.m4
+++ b/build/pkgs/jupyter_client/spkg-configure.m4
@@ -1 +1 @@
-SAGE_SPKG_CONFIGURE([bleach], [SAGE_PYTHON_PACKAGE_CHECK([bleach])])
+SAGE_SPKG_CONFIGURE([jupyter_client], [SAGE_PYTHON_PACKAGE_CHECK([jupyter_client])])
diff --git a/build/pkgs/matplotlib_inline/spkg-configure.m4 b/build/pkgs/matplotlib_inline/spkg-configure.m4
index 3af724d674..f72fef4802 100644
--- a/build/pkgs/matplotlib_inline/spkg-configure.m4
+++ b/build/pkgs/matplotlib_inline/spkg-configure.m4
@@ -1,3 +1,3 @@
-SAGE_SPKG_CONFIGURE([matplotlib-inline], [
+SAGE_SPKG_CONFIGURE([matplotlib_inline], [
   SAGE_PYTHON_PACKAGE_CHECK([matplotlib-inline])
 ])
```


Edit: small fix.


---

Comment by tornaria created at 2021-12-30 23:22:56

A few more standard packages:

```
diff --git a/build/pkgs/alabaster/spkg-configure.m4 b/build/pkgs/alabaster/spkg-configure.m4
new file mode 100644
index 0000000000..4eca6e05a5
--- /dev/null
+++ b/build/pkgs/alabaster/spkg-configure.m4
@@ -0,0 +1 @@
+SAGE_SPKG_CONFIGURE([alabaster], [SAGE_PYTHON_PACKAGE_CHECK([alabaster])])
diff --git a/build/pkgs/beniget/spkg-configure.m4 b/build/pkgs/beniget/spkg-configure.m4
new file mode 100644
index 0000000000..8ae6101333
--- /dev/null
+++ b/build/pkgs/beniget/spkg-configure.m4
@@ -0,0 +1 @@
+SAGE_SPKG_CONFIGURE([beniget], [SAGE_PYTHON_PACKAGE_CHECK([beniget])])
diff --git a/build/pkgs/gast/spkg-configure.m4 b/build/pkgs/gast/spkg-configure.m4
new file mode 100644
index 0000000000..26ec59feae
--- /dev/null
+++ b/build/pkgs/gast/spkg-configure.m4
@@ -0,0 +1 @@
+SAGE_SPKG_CONFIGURE([gast], [SAGE_PYTHON_PACKAGE_CHECK([gast])])
diff --git a/build/pkgs/gmpy2/spkg-configure.m4 b/build/pkgs/gmpy2/spkg-configure.m4
new file mode 100644
index 0000000000..2d0390f7db
--- /dev/null
+++ b/build/pkgs/gmpy2/spkg-configure.m4
@@ -0,0 +1 @@
+SAGE_SPKG_CONFIGURE([gmpy2], [SAGE_PYTHON_PACKAGE_CHECK([gmpy2])])
diff --git a/build/pkgs/importlib_metadata/spkg-configure.m4 b/build/pkgs/importlib_metadata/spkg-configure.m4
new file mode 100644
index 0000000000..d940b101b8
--- /dev/null
+++ b/build/pkgs/importlib_metadata/spkg-configure.m4
@@ -0,0 +1 @@
+SAGE_SPKG_CONFIGURE([importlib_metadata], [SAGE_PYTHON_PACKAGE_CHECK([importlib_metadata])])
diff --git a/build/pkgs/ply/spkg-configure.m4 b/build/pkgs/ply/spkg-configure.m4
new file mode 100644
index 0000000000..ffb0030d01
--- /dev/null
+++ b/build/pkgs/ply/spkg-configure.m4
@@ -0,0 +1 @@
+SAGE_SPKG_CONFIGURE([ply], [SAGE_PYTHON_PACKAGE_CHECK([ply])])
diff --git a/build/pkgs/pythran/spkg-configure.m4 b/build/pkgs/pythran/spkg-configure.m4
new file mode 100644
index 0000000000..592e95bcb3
--- /dev/null
+++ b/build/pkgs/pythran/spkg-configure.m4
@@ -0,0 +1 @@
+SAGE_SPKG_CONFIGURE([pythran], [SAGE_PYTHON_PACKAGE_CHECK([pythran])])
diff --git a/build/pkgs/typing_extensions/spkg-configure.m4 b/build/pkgs/typing_extensions/spkg-configure.m4
new file mode 100644
index 0000000000..d475fd8257
--- /dev/null
+++ b/build/pkgs/typing_extensions/spkg-configure.m4
@@ -0,0 +1 @@
+SAGE_SPKG_CONFIGURE([typing_extensions], [SAGE_PYTHON_PACKAGE_CHECK([typing_extensions])])
```


There's also `cython` but it uses some patches so my system package, at the same version, doesn't work. The rest seems ok.


---

Comment by tornaria created at 2021-12-30 23:29:26

I should mention that I'm using a patch created from branch `u/mjo/ticket/29665` rather than the whole thing to make it more manageable for me. I hope I'm not missing anything important.

I'll let you know if anything goes wrong with doctesting. I'm now building using all possible system packages and python site packages available on void.


---

Comment by tornaria created at 2021-12-31 02:15:23

Everything passes with the following patch which is neecessary if `alabaster` is used from system.

```
diff --git a/src/sage/misc/package.py b/src/sage/misc/package.py
index 84f3d50de7..c7ad206959 100644
--- a/src/sage/misc/package.py
+++ b/src/sage/misc/package.py
@@ -386,9 +386,9 @@ def installed_packages(exclude_pip=True):
     EXAMPLES::
 
         sage: sorted(installed_packages().keys())  # optional - build
-        [...'alabaster', ...'sage_conf', ...]
-        sage: installed_packages()['alabaster']  # optional - build, random
-        '0.7.12'
+        [...'sage_conf', ...]
+        sage: installed_packages()['sage_conf']  # optional - build, random
+        '9.5'
 
     .. SEEALSO::
 
```



---

Comment by mjo created at 2021-12-31 02:24:31

Thanks, I fixed the existing packages and added most of the new ones. I've left out `gmpy2` and `typing_extensions` because they aren't available in Gentoo yet (chicken and egg problem) so I'm unable to test them easily. I also added your alabaster doctest fix.

I'm not sure if there were any new commits on Matthias's branch (it's impossible to tell when merge commits are involved), or if his dependencies are only intended to make this easier to test. In any case, I've switched it back to my branch which works fine in real life if not on github.


---

Comment by mkoeppe created at 2021-12-31 02:44:36

Replying to [comment:125 mjo]:
> it's impossible to tell when merge commits are involved

try `git log --first-parent`


---

Comment by mjo created at 2021-12-31 03:58:52

Replying to [comment:126 mkoeppe]:
> Replying to [comment:125 mjo]:
> > it's impossible to tell when merge commits are involved
> 
> try `git log --first-parent`

Thanks, I've been missing this my entire adult life. Can we teach trac to use it?


---

Comment by @sheerluck created at 2021-12-31 10:34:10

Can `pytest` be not isolated also?


---

Comment by tornaria created at 2021-12-31 15:02:50

Replying to [comment:128 gh-sheerluck]:
> Can `pytest` be not isolated also?
Oh, yes, I forgot: since pytest gives problems (see #31924) I had to disable it:

```
diff --git a/src/bin/sage-runtests b/src/bin/sage-runtests
index 589dc8cd37..6bb8bf99a4 100755
--- a/src/bin/sage-runtests
+++ b/src/bin/sage-runtests
@@ -154,21 +154,4 @@ if __name__ == "__main__":
     DC = DocTestController(args, args.filenames)
     err = DC.run()
 
-    try:
-        exit_code_pytest = 0
-        import pytest
-        pytest_options = ["--import-mode", "importlib"]
-        if args.verbose:
-            pytest_options.append("-v")
-        exit_code_pytest = pytest.main(pytest_options + args.filenames)
-        if exit_code_pytest == 5:
-            # Exit code 5 means there were no test files, pass in this case
-            exit_code_pytest = 0
-
-    except ModuleNotFoundError:
-        print("Pytest is not installed, skip checking tests that rely on it.")
-
-    if err == 0:
-        sys.exit(exit_code_pytest)
-    else:
-        sys.exit(err)
+    sys.exit(err)
```


I don't know any other way to workaround this problem until #31924 is fixed.


---

Comment by tornaria created at 2021-12-31 18:16:34

For the record, in addition to what is in the current patch, I'm also using from system:
 - `gmpy2-2.1.1` (I had to patch `install-requires.txt` since it currently requires `2.1.0rc1`)
 - `sphinx-4.3.2` (I had to update it in void linux)
 - `typing_extensions-3.10.0.2`

I also had to patch `ptyprocess/install-requires.txt` to allow `ptyprocess-0.7.0` since it currently requires `0.5.1` but this version seems to work ok.

Of all the python packages added by this patch only three were not available for me on void linux: `cvxopt`, `importlib_resources` and `debugpy`, everything else was tested (note that `debugpy` is optional now)


---

Comment by mkoeppe created at 2021-12-31 18:35:30

Replying to [comment:130 tornaria]:
> I also had to patch `ptyprocess/install-requires.txt` to allow `ptyprocess-0.7.0` since it currently requires `0.5.1` but this version seems to work ok.

See #32147


---

Comment by mkoeppe created at 2022-01-01 04:37:28

Replying to [comment:130 tornaria]:
> For the record, in addition to what is in the current patch, I'm also using from system:
>  - `gmpy2-2.1.1` (I had to patch `install-requires.txt` since it currently requires `2.1.0rc1`)

This is now done in the updated #33070


---

Comment by git created at 2022-02-07 12:15:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:
