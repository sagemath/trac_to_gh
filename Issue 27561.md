# Issue 27561: Add `backend` option to associahedron and flow polytope

Issue created by migration from https://trac.sagemath.org/ticket/27798

Original creator: @kliem

Original creation time: 2019-05-08 08:38:59

CC:  jipilab

The option `backend` was missing for `polytopes.associahedron` and `polytopes.flow_polytopes`.


---

Comment by @kliem created at 2019-05-08 08:40:25

New commits:


---

Comment by git created at 2019-05-08 08:44:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2019-05-08 08:44:49

The doc should include in the description of backend input of both functions: 

```
If ``None`` then ``backend='ppl'`` is used.
```



---

Comment by git created at 2019-05-08 08:47:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2019-05-08 08:48:59

Changing status from new to needs_review.


---

Comment by @kliem created at 2019-05-08 08:48:59

Changing keywords from "" to "polytopes, associahedron, flow polytopes, backend, normaliz".


---

Comment by @kliem created at 2019-05-08 11:04:35

Replying to [comment:3 slabbe]:
> The doc should include in the description of backend input of both functions: 
> {{{
> If ``None`` then ``backend='ppl'`` is used.
> }}}

Thanks for remarking that.
Is the current even a good way of doing it?
Maybe I should just have `'ppl'` instead of `None` (but this somehow looks more written in stone, does it)?
In this ticket I didn't want any changes to the default option.


---

Comment by @kliem created at 2019-05-08 11:51:21

Changing status from needs_review to needs_work.


---

Comment by @kliem created at 2019-05-08 11:51:21

Actually, I don't think the construction with associahedron works. The `._backend` string is correct, but the object does not have e.g. `normaliz` functionality.


---

Comment by git created at 2019-05-08 19:30:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2019-05-08 19:39:57

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2019-05-08 19:39:57

Seems to work now. Flow polytope anyway and also the associahedron. E.g. I can construct an associahedron with `backend='normaliz'` and access (and use) the underlying normaliz cone.


---

Comment by tscrim created at 2019-05-09 03:22:13

Three little comments from a quick look:

Your `INPUT:` block is over-indented.

It is better to have new-style classes:

```diff
-class Associahedron_class_base():
+class Associahedron_class_base(object):
```


```diff
-class Associahedra_base:
+class Associahedra_base(object):
```


I do not see why the `_poly_super` is needed. You could just look at the MRO or have the `Polyhedra_*` class be a class-level attribute (similar to `Element`). Are you also sure that this doesn't work:

```
associahedron = super(self, Associahedra_base)._element_constructor_(None, [inequalities, []])
```

as my understanding is that it goes to the next class up in the MRO after `Associahedra_base`, which should be the `Polyhedra_*` class.


---

Comment by @kliem created at 2019-05-09 11:59:44

> {{{
> associahedron = super(self, Associahedra_base)._element_constructor_(None, [inequalities, []])
> }}}
(with self and Associahedra_base interchanged) lead to

```
TypeError: super() argument 1 must be type, not classobj
```

However, this seems to be solved by inheriting from `object`.


Replying to [comment:10 tscrim]:
> Three little comments from a quick look:
> 
> Your `INPUT:` block is over-indented.
> 
> It is better to have new-style classes:
> {{{#!diff
> -class Associahedron_class_base():
> +class Associahedron_class_base(object):
> }}}
> {{{#!diff
> -class Associahedra_base:
> +class Associahedra_base(object):
> }}}
> 
> I do not see why the `_poly_super` is needed. You could just look at the MRO or have the `Polyhedra_*` class be a class-level attribute (similar to `Element`). Are you also sure that this doesn't work:
> {{{
> associahedron = super(self, Associahedra_base)._element_constructor_(None, [inequalities, []])
> }}}
> as my understanding is that it goes to the next class up in the MRO after `Associahedra_base`, which should be the `Polyhedra_*` class.


---

Comment by git created at 2019-05-09 13:38:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2019-05-10 05:11:51

You may want to have a look at #25183 while you are playing around with the associahedron.


---

Comment by git created at 2019-05-10 09:34:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-05-12 11:55:51

please fix the pyflakes warning:

```
+src/sage/combinat/root_system/associahedron.py:28:
 'sage.geometry.polyhedron.base.Polyhedron_base' imported but unused
```



---

Comment by git created at 2019-05-12 17:57:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2019-05-14 01:08:00

I don't really like this solution with `__new__`; it is a bit too much of a hack IMO and seems like a (relatively) very slow thing to check. You also would not receive any benefits from the category framework (as you do not seem to be using the `Parent.element_class`). Perhaps I am not quite understanding things. Could you explain a bit how you arrived at this?


---

Comment by @kliem created at 2019-05-14 04:50:29

JP asked me to also fix #25183. So I did.

When a polyhedral face of an associahedron is constructed, I need to somehow make sure that `__new__` does not return a child of `Associahedron_base` (when the argument `cartan_type` is missing). This is the solution I came up with.

I have no clue how to use `Parent.element_class`.

Replying to [comment:17 tscrim]:
> I don't really like this solution with `__new__`; it is a bit too much of a hack IMO and seems like a (relatively) very slow thing to check. You also would not receive any benefits from the category framework (as you do not seem to be using the `Parent.element_class`). Perhaps I am not quite understanding things. Could you explain a bit how you arrived at this?


---

Comment by jipilab created at 2019-05-14 14:38:38

Replying to [comment:18 gh-kliem]:
> JP asked me to also fix #25183. So I did.
> 

Have a look at it... If the bug is related or not.


---

Comment by jipilab created at 2019-05-14 14:41:16

Replying to [comment:19 jipilab]:
> Replying to [comment:18 gh-kliem]:
> > JP asked me to also fix #25183. So I did.
> > 
> 
> Have a look at it... If the bug is related or not.

... and the bug located at #25183 should be fixed on #25183 if it is not related to the present one ... The associahedron has the category framework behind it, this is why I thought it might be a related thing. If not, then not.


---

Comment by @kliem created at 2019-05-14 18:02:21

I misunderstood. From my understanding #25183 should be fixed with redefining `__new__` or with changing the construction of `as_polyhedron`.

Either way, I think initialization of associahedron should ask for `cartan_type`, as an argument. From my understanding an object should be valid upon construction.

Anyway, I could move my suggestions for #25183 to a new branch public/25183 as a suggestion for this (other) ticket. Then this (this) ticket would be cleaned up from this discussion.

Replying to [comment:20 jipilab]:
> Replying to [comment:19 jipilab]:
> > Replying to [comment:18 gh-kliem]:
> > > JP asked me to also fix #25183. So I did.
> > > 
> > 
> > Have a look at it... If the bug is related or not.
> 
> ... and the bug located at #25183 should be fixed on #25183 if it is not related to the present one ... The associahedron has the category framework behind it, this is why I thought it might be a related thing. If not, then not.


---

Comment by tscrim created at 2019-05-14 23:36:17

I think it is better to have that discussion on #25183 as it is a separate issue.


---

Comment by git created at 2019-05-16 12:57:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @kliem created at 2019-05-16 13:13:40

Ok, I moved the corresponding part to #25183.


---

Comment by @kliem created at 2019-07-05 07:09:23

Is there anything left to take care of?


---

Comment by jipilab created at 2019-07-23 14:50:26

> The doc should include in the description of backend input of both functions: 
> {{{
> If ``None`` then ``backend='ppl'`` is used.
> }}}

Add the period at the end of the sentence.

Why is the only allowed base ring `QQ`? Am I missing something?


---

Comment by @kliem created at 2019-07-23 15:48:39

Replying to [comment:27 jipilab]:
> 
> > The doc should include in the description of backend input of both functions: 
> > {{{
> > If ``None`` then ``backend='ppl'`` is used.
> > }}}
> 
> Add the period at the end of the sentence.
A semicolon would probably fit better.
I learnt that INPUT does not stop with period.
> 
> Why is the only allowed base ring `QQ`? Am I missing something?

As for the flow polytope, one can add an argument `base_ring` later.

As for the Associahedron, one would need one class for each combination of `base_ring` and `backend` (for each child of `Polyhedron_base`).
Is it worth it?
I don't see a great need for a different base ring.
(Contrary, constructing an associahedron with normaliz right away, saves a lot of time.)

Anyway, the goal of this ticket was to add a backend option.
So I never minded the base ring.


---

Comment by jipilab created at 2019-07-23 20:24:11

Replying to [comment:28 gh-kliem]:
> Replying to [comment:27 jipilab]:
> > 
> > > The doc should include in the description of backend input of both functions: 
> > > {{{
> > > If ``None`` then ``backend='ppl'`` is used.
> > > }}}
> > 
> > Add the period at the end of the sentence.
> A semicolon would probably fit better.
> I learnt that INPUT does not stop with period.

That's correct. In this case, it is a sentence with a noun, a verb and and complement. Thus it requires a period. Usually it is not a sentence.......................

> > Why is the only allowed base ring `QQ`? Am I missing something?
> 
> As for the flow polytope, one can add an argument `base_ring` later.
> 
> As for the Associahedron, one would need one class for each combination of `base_ring` and `backend` (for each child of `Polyhedron_base`).
> Is it worth it?
> I don't see a great need for a different base ring.
> (Contrary, constructing an associahedron with normaliz right away, saves a lot of time.)
> 
> Anyway, the goal of this ticket was to add a backend option.
> So I never minded the base ring.

Ok, fine.


---

Comment by git created at 2019-07-28 07:15:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2019-07-28 19:00:23

Replying to [comment:30 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[d9a7e6b](https://git.sagemath.org/sage.git/commit/?id=d9a7e6b76dfad44bb6951099ae068c5dd0c0de6d)||`periods to ends of sentences`||

Took care of the periods.


---

Comment by chapoton created at 2019-08-27 18:04:07

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2019-08-27 18:04:07

red branch, meaning that it needs to be rebased on the latest beta


---

Comment by git created at 2019-08-27 20:08:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2019-08-27 20:08:47

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2019-08-28 00:06:21

It seems like you have some extra stuff in `digraph` that has snuck in with the `all_paths_iterator`.


---

Comment by git created at 2019-08-28 05:45:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @kliem created at 2019-08-28 05:46:07

Replying to [comment:35 tscrim]:
> It seems like you have some extra stuff in `digraph` that has snuck in with the `all_paths_iterator`.

Done.


---

Comment by tscrim created at 2019-08-28 06:07:15

Okay, I am pretty sure you now break `Associahedra` when the backend is not specified. I also do not see why you need this in `Associahedron`:

```
    if backend is None:
        backend = 'ppl'
```

Just set `backend='ppl'` as the default argument instead of `None`.
You should also update the documentation there too:

```
    - ``backend`` -- string (``'ppl'``); the backend to use;
      see :meth:`sage.geometry.polyhedron.constructor.Polyhedron`
```


Also, in `flow_polytope`:

```
        - ``backend`` -- string or ``None`` (default); the backend to use;
          see :meth:`sage.geometry.polyhedron.constructor.Polyhedron`
```


(By convention in Sage, the `INPUT:` block points are not considered to be full sentences, so no period/full-stop.)


---

Comment by tscrim created at 2019-08-28 06:07:15

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-08-28 06:53:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2019-08-28 06:59:26

Replying to [comment:38 tscrim]:
> You should also update the documentation there too:
> {{{
>     - ``backend`` -- string (``'ppl'``); the backend to use;
>       see :meth:`sage.geometry.polyhedron.constructor.Polyhedron`
> }}}
> 
> Also, in `flow_polytope`:
> {{{
>         - ``backend`` -- string or ``None`` (default); the backend to use;
>           see :meth:`sage.geometry.polyhedron.constructor.Polyhedron`
> }}}
> 
> (By convention in Sage, the `INPUT:` block points are not considered to be full sentences, so no period/full-stop.)

We had the discussion before. I guess its fine now, as we got rid of the complete sentences.

Btw, in many (if not all) polytopes in the library the `INPUT:` block is a complete sentence with period/full-stop.


---

Comment by @kliem created at 2019-08-28 06:59:34

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2019-08-28 07:44:48

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2019-08-28 07:44:48

Thank you. Yea, well, there have been some fairly inconsistent things done with the documentation over the years. `:/` I am at least trying to move towards what the [standard in the dev guide](https://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings)


---

Comment by vbraun created at 2019-09-02 21:41:17

Resolution: fixed
