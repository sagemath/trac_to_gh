# Issue 19039: precision problem computing heights on elliptic curves

Issue created by migration from https://trac.sagemath.org/ticket/19276

Original creator: cremona

Original creation time: 2015-09-23 13:58:32

Keywords: height precision

Computing heights of points over number fields (this does not effect things over Q):  in the expression (from Silverman's paper) for the number of terms needed for the requested precision for local height at an archimedean place v, there is log(max(1,1/|D|_v)) where D is the discriminant and v the valuation.  Over Q D is integral so this term is always 0.  Over number fields, |D|_v can be extremely small for some v, indistinguishable from 0 to moderate precision.

Example (from an LMFDB curve):

```
sage: K.<a> = NumberField(x^2-x-104)
sage: E = EllipticCurve([1, a - 1, 1, -816765673272*a - 7931030674178, 1478955604013312315*a + 14361086227143654561])
sage: P = E(5393511/49*a + 52372721/49 , -33896210324/343*a - 329141996591/343 )
sage: P.height()
```


I have a fix and am testing now.


---

Comment by cremona created at 2015-09-23 15:57:12

Changing status from new to needs_review.


---

Comment by cremona created at 2015-09-23 15:57:12

New commits:


---

Comment by jdemeyer created at 2015-09-23 16:24:34

I think that the problem you're trying to solve (massive cancellation in real embeddings) is general enough that it should have a general solution. In other words, I think the "right" solution to this ticket does not involve any changes to the elliptic curve code, but to the number field code.

What do you think?


---

Comment by cremona created at 2015-09-23 21:06:52

Replying to [comment:3 jdemeyer]:
> I think that the problem you're trying to solve (massive cancellation in real embeddings) is general enough that it should have a general solution. In other words, I think the "right" solution to this ticket does not involve any changes to the elliptic curve code, but to the number field code.
> 
> What do you think?

I think that I need to compute heights now!  So I am going to use this code as it is anyway.

Besides that, Marco Caselli and I are implementing a vastly better way to compute local archimedean heights using AGM (which is non-trivial for complex embeddings).

But your general point certainly stands.


---

Comment by jdemeyer created at 2015-09-24 07:44:41

Replying to [comment:4 cremona]:
> I think that I need to compute heights now!  So I am going to use this code as it is anyway.
Well, I didn't say the code was bad. I just said that, instead of a fix benefiting this particular application (heights on elliptic curves), we could have a fix for all applications.


---

Comment by cremona created at 2015-09-24 12:48:47

Replying to [comment:5 jdemeyer]:
> Replying to [comment:4 cremona]:
> > I think that I need to compute heights now!  So I am going to use this code as it is anyway.
> Well, I didn't say the code was bad. I just said that, instead of a fix benefiting this particular application (heights on elliptic curves), we could have a fix for all applications.

I would rather get this fix in first and do the Right Thing on another ticket.


---

Comment by cremona created at 2015-09-24 16:40:48

I am not exactly sure what general fix would work for this sort of situation:

```
sage: K.<a> = NumberField(x^2-x-104)
sage: E = EllipticCurve([1, a - 1, 1, -816765673272*a - 7931030674178, 1478955604013312315*a + 14361086227143654561])
sage: D = E.discriminant()
sage: [v(D) for v in K.embeddings(RealField())]
[0.000000000000000, -9.70868378243995e40]
sage: [v(D) for v in K.embeddings(RealField(100))]
[0.00000000000000000000000000000, -9.7086837824399448843367001731e40]
sage: [v(D) for v in K.embeddings(RealField(200))]
[0.00000000000000000000000000000000000000000000000000000000000,
 -9.7086837824399448843367001730524854139792000000000000000000e40]
sage: [v(D) for v in K.embeddings(RealField(300))]
[-4.32015718504110363878523822853740762057165316169725154810335814374378729622544830930841973e-35,
 -9.70868378243994488433670017305248541397919999999999999999999999999999999999567984281495890e40]
```

if the users asks for the image of a field element in some embedding?  Where the field element is non-zero but the image appears to be zero?  What did you have in mind?


---

Comment by pbruin created at 2015-09-24 17:03:51

Perhaps we could invent a method `NumberFieldElement.logabs(emb)`, where `emb` is a real or complex embedding, such that `x.logabs(emb)` would return log |emb(_x_)|, increasing the precision of `emb` as needed (and raise an error if _x_ = 0)?  This looks like a rather natural method to have for number field elements, and could be useful in more contexts involving heights.


---

Comment by cremona created at 2015-09-24 17:56:59

That sounds like a good idea; it is essentially what I do here.
If you would like to implement that, we could either make that part of this patch, or make it a separate one -- preferably with this as a dependency.


---

Comment by pbruin created at 2015-09-24 21:01:31

Replying to [comment:9 cremona]:
> That sounds like a good idea; it is essentially what I do here.
> If you would like to implement that, we could either make that part of this patch, or make it a separate one -- preferably with this as a dependency.
Let's make it a separate ticket; I don't have time to implement it right now, and on a separate ticket it will be easier to concentrate on testing and finding other places where we can use the new function.


---

Comment by pbruin created at 2015-09-24 21:10:54

Replying to [comment:10 pbruin]:
> Let's make it a separate ticket
This is now #19288.


---

Comment by jdemeyer created at 2015-09-25 08:13:06

Instead of embedding into `RR`, embedding in `AA` and then coercing to `RR` just works:

```
sage: K.<a> = NumberField(x^2-x-104)
sage: E = EllipticCurve([1, a - 1, 1, -816765673272*a - 7931030674178, 1478955604013312315*a + 14361086227143654561])
sage: D = E.discriminant()
sage: phi = K.embeddings(AA)[0]
sage: RR(phi(D))
-4.32015718504111e-35
```


Using this looks like the right fix to me.


---

Comment by jdemeyer created at 2015-10-02 13:17:36

Fixed also in #19288.


---

Comment by chapoton created at 2015-11-17 08:32:56

ok, looks good to me. and bot is green


---

Comment by chapoton created at 2015-11-17 08:32:56

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-11-19 03:48:19

Resolution: fixed
