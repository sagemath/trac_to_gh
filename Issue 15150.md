# Issue 15150: Problem with path security check

Issue created by migration from https://trac.sagemath.org/ticket/15387

Original creator: nbruin

Original creation time: 2013-11-08 23:01:17

CC:  scmancuso

Consider the following scenario:

```
$ cd /tmp
$ mkdir U
$ chmod 770 U
$ cd U
$ touch test.py
$ umask 022
$ sage -t test.py #this fails as expected
$ umask 002
$ sage -t test.py #this fails on bsd but succeeds on boxen
```

Setting umask is supposed to be a work-around for allowing testing in group-writeable directories, but this doesn't work on OSX (or at least it doesn't on bsd.math.washington.edu). See also
[sage-support](https://groups.google.com/forum/?hl=en#!topic/sage-support/bmOxR3BgXBI).


---

Comment by jdemeyer created at 2013-11-11 10:45:30

Changing component from misc to porting.


---

Comment by nbruin created at 2013-11-11 22:32:34

I can confirm that the exact script executed on OSX outside /tmp does seem to work. Nonetheless, the original reporter of the problem (who is scmancuso?) seems to have a problem outside /tmp. I think he is running into exactly the same problem as with `/tmp`:
 - Having a directory writeable by `wheel` is basically safe: people with `wheel` permission are sort of `root` anyway.
 - In his situation, he considers `RESEARCH_GROUP` to be safe. He is probably a member of that group, but it's not his primary group.

The code only considers groups "safe" if the gid of the group equals the gid of the group-writeable current directory. I think this example shows that this is too restrictive and it is unnecessarily onerous to require the user in this situation to make the "sage" process "setgrp" to `RESEARCH_GROUP`

To illustrate the problem, let's assume that `everyone` (despite the name) is a "trusted" group to which I belong and for which I intentionally want to make the directory writeable:

```
$ mkdir U       #now the group of U is my primary gid.
$ chmod 770 U
$ umask 002
$ cd U
$ touch test.py
$ ../sage -t test.py
THIS WORKS
$ chgrp everyone . #this is a group I am a member of, but it's not my primary gid
$ ../sage -t test.py
RuntimeError: refusing to run doctests from the current directory '/scratch/nbruin/U' since untrusted users could put files in this directory, making it unsafe to run Sage code from
```

I think we simply don't have enough information to decide which groups are "safe" and which are not. In absence of a file that we can use as a model of the acceptable permissions, using "umask" is a possible substitute (although a bit of a misuse), but using the process GID as a substitute of the required GID of the current directory is simply not a good substitute. People don't have enough control over their primary GID and they can have good reasons to consider non-primary groups safe.


---

Comment by nbruin created at 2013-11-15 01:48:30

One solution is to simply remove the lines:

```
+        /* Only keep group bit if the current group ID is the same as
+         * the group of "parent" */
+        if (getgid() != parent_stat.st_gid)
+            arg_stat.st_mode &= 0707;
```

with the rationale that the process gid is meant for the _system_ to determine for which operations it should trust the _process_. It doesn't give information about which _other groups_ this _process_ should trust. That information is simply not available.

Any alternatives?


---

Comment by jdemeyer created at 2013-11-22 14:30:34

Replying to [comment:6 nbruin]:
> Any alternatives?
Use `getgroups()` to get *all* the groups that somebody is a member of.


---

Comment by nbruin created at 2013-11-22 20:49:18

Replying to [comment:7 jdemeyer]:
> Replying to [comment:6 nbruin]:
> > Any alternatives?
> Use `getgroups()` to get *all* the groups that somebody is a member of.

Yes, that would solve the problem, but it's not clear to me that that is truly more secure than just ignoring the process group altogether. Imagine:

```
$ id
uid=...(me) gid=...(wheel) groups=...(wheel),...(www_devel),...(unwashed_masses)
$ ls -dl .
drwxrwx--x wheel unwashed_masses [...] ./
$ umask 002
$ sage -t module.py
```

This user `me` has write permission anywhere where all members of `unwashed_masses` have write permission, but `me` has many more privileges as well. A longer `getgroups()` indicates a MORE privileged UID, so normally one would think one should be LESS liberal in executing code under that UID. Considering all the groups returned by `getgroups()` as trusted when `umask 002` is in effect would have exactly the opposite effect.

Trust relations in security are often asymmetric and unfortunately it doesn't seem POSIX provides a way to obtain the information in the direction we are interested in (I don't think that information is formalized in the system).

I am fine with doing the `getgroups()` check, because it is an improvement in terms of usability over what we have now and I think in most scenarios it will allow things that should be allowed.

It is a little less permissive than just not considering groups at all upon `umask 002`, so it may seem a little more secure, but I have trouble defining/justifying the security model it would be following, and programming the `getgroups()` thing is quite a bit more work. 

Therefore, my default would be just dropping the `getgid() != parent_stat.st_gid`.


---

Comment by vbraun created at 2014-11-11 23:09:41

I'm finding this annoying too:

```
$ ll -Zd .
drwxrwxr-x. vbraun vbraun unconfined_u:object_r:user_home_t:s0 .
$ sage
sys:1: RuntimeWarning: not adding directory '' to sys.path since it's writable by an untrusted group.
Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory
┌────────────────────────────────────────────────────────────────────┐
│ Sage Version 6.4.beta6, Release Date: 2014-10-14                   │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
```



---

Comment by jdemeyer created at 2014-11-20 09:03:18

I'm not sure that your patch is the right solution, but the problem is that there is no "right" solution here. We simply cannot determine which groups are "trusted".
----
New commits:


---

Comment by jdemeyer created at 2014-11-20 09:03:58

Replying to [comment:12 vbraun]:
> I'm finding this annoying too:
> {{{
> $ ll -Zd .
> drwxrwxr-x. vbraun vbraun unconfined_u:object_r:user_home_t:s0 .
> $ sage
> sys:1: RuntimeWarning: not adding directory '' to sys.path since it's writable by an untrusted group.
> Untrusted users could put files in this directory which might then be imported by your Python code. As a general precaution from similar exploits, you should not execute Python code from this directory}}}

What's your `id -a`?
