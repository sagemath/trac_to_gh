# Issue 12547: Upgrade to IPython 0.12

Issue created by migration from Trac.

Original creator: kini

Original creation time: 2012-03-21 20:03:03

Assignee: tbd

CC:  iandrus vbraun jason alexanderdreyer robertwb

We need to upgrade IPython to the shiny new thing. Well, not really - the shiny new thing was 0.11, and 0.12 is now stable. It's been mostly rewritten and is now a lot more modular, as I understand it. Definitely worth using in Sage.


---

Comment by jhpalmieri created at 2012-03-21 20:11:11

See #12167 for a related ticket: how we deal with IPython configuration files.


---

Comment by fbissey created at 2012-03-22 00:55:34

Would be nice but we need some porting, here is what typically happen if you try to use ipython-0.12 with sage (we had several reports in sage-on-gentoo before I pinned down the version used by sage):

```
$ sage
----------------------------------------------------------------------
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/usr/bin/sage-ipython", line 19, in <module>
    from IPython.CrashHandler import CrashHandler
ImportError: No module named CrashHandler
```



---

Comment by kini created at 2012-03-22 01:01:33

Yes, obviously :) I'm just making this ticket since it is absolutely must be an eventual goal for us and nobody else has made a ticket yet, even though IPython 0.12 has been out for about three months.


---

Comment by fbissey created at 2012-03-22 01:09:32

To be honest Fernando Perez and I talked about it on the mailing list at the time of ipython 0.11 and I said I would tell him what happens when we use ipython 0.11+ with sage because he is interested. For various reason I haven't been able to go back to it. But some sage-on-gentoo users eventually got a taste of it when it finally landed in the portage tree.

So first hurdle: do something about the crash handling.


---

Comment by mhansen created at 2012-03-23 22:35:01

I'm working on this now, and have made quite a bit of progress.  As an added bonus, making the Sage customizations to IPython is quite a bit cleaner.  I should hopefully be able to clean out the mess in sage/misc/preparser_ipython.py and sage/misc/interpreter.py .


---

Comment by mhansen created at 2012-03-29 07:47:30

This will fix #4413.


---

Comment by kini created at 2012-03-29 07:56:56

Great, I'm glad you're on the case! :)


---

Comment by vbraun created at 2012-04-02 18:56:49

What about zmq/pyzmq? It would really add to the functionality and I'm interested in the parallel/cluster support. But, strictly speaking, its not necessary to run ipython. Its also used in the new notebook so maybe its time for it to become a standard package?


---

Comment by kini created at 2012-04-11 05:41:03

CCing Jason as he expressed interest on sage-devel.


---

Comment by jason created at 2012-04-11 05:49:34

mhansen: we'd love to see your work-in-progress if it's available somewhere.  I just spent some time reading the IPython docs again and thinking about how we could use it to implement the notebook hub and worker processes.


---

Comment by mhansen created at 2012-04-11 06:16:21

I've posted patches which let Sage work with IPython 0.12 as well as cleaning up some old messy code.  These should be in a state where they're ready to review.

I haven't done anything with preparing an spkg yet.


---

Comment by jason created at 2012-04-11 06:27:03

I've updated the instructions in the description.  Please correct if I messed something up.


---

Comment by jason created at 2012-04-11 06:27:11

Changing status from new to needs_review.


---

Comment by jason created at 2012-04-11 06:27:23

Changing status from needs_review to needs_work.


---

Comment by jason created at 2012-04-11 06:28:51

Just curious: do your patches work with the current 0.12, or did you base them on the current git master (or does it not matter?).  On the IPython mailing list, they mentioned that 0.12 had some big bugs, so they were thinking about cutting a quick 0.12.1.  Also, they expect 0.13 in about a month.


---

Comment by jason created at 2012-04-11 06:38:05

I was thinking more about security today with the zmq messages.  I think it may be more secure to have a default ipcontroller transport of IPC in a directory inside of $DOT_SAGE, rather than tcp over the loopback interface.  That would be more secure in that random people on your computer wouldn't be able to try to register with the IPython hub.  I emailed the IPython mailing list about it: http://thread.gmane.org/gmane.comp.python.ipython.devel/7789

What do you think?


---

Comment by mhansen created at 2012-04-11 06:50:58

Replying to [comment:17 jason]:
> Just curious: do your patches work with the current 0.12, or did you base them on the current git master (or does it not matter?).  On the IPython mailing list, they mentioned that 0.12 had some big bugs, so they were thinking about cutting a quick 0.12.1.  Also, they expect 0.13 in about a month.

I've looked at the current git master as I was making these changes, and I think these changes should work fine with what's on there.  I'd be surprised if it made a difference.


---

Comment by mhansen created at 2012-04-11 07:23:40

I just tested things against git master and everything seems fine.


---

Comment by jason created at 2012-04-12 03:03:38

I'm trying to apply these to 5.0beta12.  I think I probably got the order wrong in the description, so it would be great if you could check that.  But regardless, none of the patches seem to apply to 5.0beta12 cleanly (each has rejects).


---

Comment by jason created at 2012-04-12 03:07:46

I just tried applying to beta6 and the -scripts patch still had problems.


---

Attachment

The -scripts patch should apply fine to the scripts repository.  I've rebased the other ones to work on the newer 5.0 beta's.


---

Comment by AlexanderDreyer created at 2012-04-12 11:26:08

After applying the patches to sage-5.0 beta12 I still have `ip = IPython.ipapi.get()` at the end of `sage/misc/edit_module.py`, which crashes Sage on startup.


---

Comment by jason created at 2012-04-12 11:43:41

I get a crash when I apply these (with a latest git IPython).  I've posted the crash report at http://sage.math.washington.edu/home/jason/Sage_crash_report.txt


---

Comment by jason created at 2012-04-12 13:53:33

Is the zmq communication in ipython going through tcp/localhost sockets, or through UDS sockets?  I really think we should use UDS sockets with the files in $DOTSAGE so that it is more secure (i.e., random other people on the computer can't connect to the kernel).


---

Comment by vbraun created at 2012-04-12 14:00:52

By default we should not use zeromq. For example, if you want to fork you should do so before creating a zmq context. The zmq context creates threads and open file descriptors.

Apart from that, you should either use IPC or TCP+magic cookie, much like the X window system. Implementation wise its probably easiest to allow any socket and alway check the magic cookie.


---

Comment by jason created at 2012-04-12 14:06:28

I don't think we have a choice of whether or not to use zmq with the new ipython.  ZMQ is an integral part of how it communicates results from the backend to the frontend.  They do have a system for signing messages and ignoring unsigned messages (is that the magic cookie thing?).  UDS sockets is IPC, so we're good there.  My problem with TCP+magic cookie is that it still allows someone else to attempt to connect to the various sockets, whereas using IPC, with the socket files in $DOTSAGE, filesystem permissions prevent others from even attempting to connect.


---

Comment by jason created at 2012-04-12 14:23:35

It may be that I'm misunderstanding how ipython is using zmq when you just execute 'ipython'.  It may be that it uses in-process communication (using zmq) instead of opening ports on localhost.  I've posted to the ipython-devel mailing list about this.


---

Comment by vbraun created at 2012-04-12 14:25:53

Given that you can build IPython without zeromq support it surely must be possible to run without?

I don't see the problem with tcp + magic cookie. Yes you can connect but your connection attempt will be ignored. And the difference in pyzmq to ipc + magic cookie is a single string.  So why bother with ipc without magic cookie?


---

Comment by jason created at 2012-04-12 14:48:57

Thomas on the ipython mailing list confirmed that the plain ipython command doesn't use zmq, so that was a big misunderstanding I had about the new ipython.  So never mind what I said about sockets.


---

Attachment


---

Comment by mhansen created at 2012-04-12 19:01:08

Okay, I fixed the problem with edit_module.

Sorry I wasn't clear about the default IPython not using zmq.  There is a experimental console shell that uses two processes which can be accessed with "ipython console", but we aren't using that at all.


---

Comment by jason created at 2012-04-12 19:11:56

Changing status from needs_work to needs_review.


---

Comment by jason created at 2012-04-12 19:20:33

For the record, the patches now apply to my 5.0beta12 and Sage starts up.


---

Comment by jason created at 2012-04-12 19:24:45

When doing %edit, I edit the sage library file, but the file isn't copied over to the library after editing, so the changes don't take effect.  This doesn't hold back this issue, though, since it didn't work before either.


---

Comment by vbraun created at 2012-04-14 20:59:25

Although zeromq is not, strictly speaking, necessary for IPython it might be of interest that I made zeromq and pyzmq spkgs at #12843


---

Comment by PierreCagne created at 2012-05-10 15:06:47

Not working on sage-5.0.rc0 (system Darwin 10.8.0).
I installed the spkg and applied the patches in the given order and places, but still have the following error lauching Sage :


```
Traceback (most recent call last):
  File "/Users/pece/sage-5.0.rc0/local/bin/sage-ipython", line 19, in <module>
    from IPython.CrashHandler import CrashHandler
ImportError: No module named CrashHandler
```


I even installed the patches from #12843 without any success.


---

Comment by jason created at 2012-05-11 02:33:15

I have OSX 10.6.8: `Darwin Kernel Version 10.8.0`.  I'm running the IPython git master and the patches, and it seems to work well.  Did you do `sage -b` to compile the patches?  Maybe the problem is in the IPython 0.12.1->0.13 changes.


---

Comment by jason created at 2012-05-11 02:38:21

Hmmm, it looks like the scripts/ patch wasn't applied (the problematic line is deleted in the patch).  Can you check again that trac_12719-scripts.patch is applied to the SAGE_ROOT/local/bin repository?


---

Comment by slabbe created at 2012-05-13 18:34:53

Replying to [comment:39 jason]:
> Maybe the problem is in the IPython 0.12.1->0.13 changes.

On sage-5.0.rc0, I managed to apply the three patches and sage starts correctly. So I guess it's not a matter of IPython 0.13 changes. Although, the sage prompt is not in color anymore (my file .sage/ipython/ipythonrc is set to dark background color).

Is the ipython notebook suppose to work? How should I test it?

Also, doing `sage -ipython notebook` creates this error :


```
$ sage -ipython notebook
Traceback (most recent call last):
...
ImportError: The IPython Notebook requires tornado >= 2.1.0
```



---

Comment by vbraun created at 2012-05-24 23:32:37

The first patch (`trac_12719.patch`) applies only with fuzz 2 on sage-5.0


---

Comment by vbraun created at 2012-05-25 04:27:40

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2012-05-25 04:27:40

Lots of doctests fail because the display hook is not correctly set up. I'll have a look into this if nobody beats me to it...


---

Comment by vbraun created at 2012-05-25 04:27:40

Changing keywords from "" to "sd40.5".


---

Comment by vbraun created at 2012-05-26 17:50:45

The new ipython configuration files are once more incompatible with the previous ones. My patch versions the directory now (that is, it is named .sage/ipython-VERSION) and deletes the SAGE_ROOT/ipythonrc stuff. I think all sage-specific configuration should go into `sage/misc/interface.py`


---

Comment by vbraun created at 2012-05-27 17:59:48

Here is some reasonable documentation about Prefilter vs. InputSplitter: http://mail.scipy.org/pipermail/ipython-dev/2011-March/007334.html


---

Comment by vbraun created at 2012-05-27 20:26:05

Updated patch


---

Attachment

The trac_12719_ipython_fixes.patch switches form Prefilter to InputSplitter. 

I'm giving a positive review to everything that Mike wrote.


---

Comment by vbraun created at 2012-05-27 20:34:16

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2012-05-27 22:05:06

With the new patch `sage/misc/interpreter.py` has 100% coverage.


---

Comment by was created at 2012-05-27 23:44:03

never mind.


---

Comment by was created at 2012-05-27 23:50:39

In Sage before this patch, the sage notebook, the Python command line, etc., we have:

```
for i in range(10):
    i
```

outputs the numbers up to 10.

With the new Ipython spkg, etc., we don't.  


```
sage: for i in range(10): i
sage: 
Exiting Sage (CPU time 0m0.07s, Wall time 2m3.22s).
blastoff:sage wstein$ sage -ipython
Python 2.7.2 (default, May 17 2012, 13:12:30) 
In [1]: for i in range(10): i
In [2]: 
```


I'm disappointed, especially because I thought this through and in sagews I recently wrote code so this works correctly in a single cell, even if there are several instances of this.  It's a matter of passing the 'single' option to exec, as is documented in the Python reference.  I wonder why they screwed this up in Ipython 0.12...?

Anyway, I'm not saying this is a show stopper at all - I want the new ipython in sage.  I'm just a little concerned that literally the first thing I tried shows that they made what I consider a bad design choice.  Hopefully it was just bad luck.


---

Comment by was created at 2012-05-28 00:04:52

Cool -- I tried out a bunch of other things including the new notebook (sage -ipython notebook) and didn't run into any serious issues.  So I'm happy with this from from a purely functional perspective.  Also, deleting tons of ugly code (done in the patches), looks great.


---

Comment by mhansen created at 2012-05-28 00:10:10

It should be easy to get to get the correct functionality for `for i in range(10): i`. The  `shell.run_ast_nodes` method just has to be called with `interactivity="all"` instead of `interactivity="last_expr"`.


---

Comment by mhansen created at 2012-05-28 04:38:10

Here's a review of Volker's ipython_fixes patch:


1. (minor) Remove \ on line 1071
2. Do one of the following:
   a. Fix/deprecate/remove sage-gdb-ipython since it depends on SAGE_CLEAN
   b. Just throw a deprecation warning with SAGE_CLEAN
3. Turn autoindent back on.
4. Why add debug=True and confirm_exit=False to default config.
5. Load the startup file: line 1151


---

Comment by vbraun created at 2012-05-28 05:45:59

Initial patch


---

Attachment

1, 3, 5: done

4: I removed the debug, but I (and most others, I asked) definitely want to keep `confirm_exit=False`. Yes I really want to quit, geez! 

2: I'm in favor of a) and removed it.

I've also renamed trac_13013_ROOT_configuration_files.patch (wrong ticket number) and added a patch to auto-dedent and eval in loops. Now the following works:

```
sage:         for i in range(3): i
0
1
2
```



---

Comment by mhansen created at 2012-05-28 06:09:40

Volker's changes look good to me.


---

Comment by mhansen created at 2012-05-28 06:09:40

Changing status from needs_review to positive_review.


---

Attachment


---

Comment by was created at 2012-05-28 20:27:26

Mike's addition of  trac_12719-crash.patch looks *great* to me as an addition.


---

Comment by jdemeyer created at 2012-05-29 00:48:22

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-05-29 00:48:22

Unfortunately, this doesn't apply to sage-5.1.beta1:

```
applying trac_12719.patch
patching file doc/en/reference/misc.rst
Hunk #1 succeeded at 30 with fuzz 2 (offset 2 lines).
patching file sage/misc/interpreter.py
Hunk #1 FAILED at 0
Hunk #3 FAILED at 271
Hunk #4 FAILED at 385
Hunk #5 FAILED at 449
4 out of 5 hunks FAILED -- saving rejects to file sage/misc/interpreter.py.rej
patch failed, unable to continue (try -v)
patch failed, rejects left in working dir
errors during apply, please fix and refresh trac_12719.patch
```



---

Comment by mhansen created at 2012-05-29 01:18:04

I've rebased this on top of #11817.


---

Comment by mhansen created at 2012-05-29 01:18:04

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-05-30 05:34:16

Now it applies but I get documentation errors:

```
dochtml.log:/padic/scratch/jdemeyer/merger/sage-5.1.beta3/local/lib/python2.7/site-packages/sage/misc/interpreter.py:docstring of sage.misc.interpreter:12: WARNING: Block quote ends without a blank line; unexpected unindent.
dochtml.log:/padic/scratch/jdemeyer/merger/sage-5.1.beta3/local/lib/python2.7/site-packages/sage/misc/interpreter.py:docstring of sage.misc.interpreter:8: WARNING: Block quote ends without a blank line; unexpected unindent.
dochtml.log:/padic/scratch/jdemeyer/merger/sage-5.1.beta3/local/lib/python2.7/site-packages/sage/misc/interpreter.py:docstring of sage.misc.interpreter:8: WARNING: Block quote ends without a blank line; unexpected unindent.
dochtml.log:/padic/scratch/jdemeyer/merger/sage-5.1.beta3/local/lib/python2.7/site-packages/sage/misc/interpreter.py:docstring of sage.misc.interpreter:11: WARNING: Definition list ends without a blank line; unexpected unindent.
dochtml.log:/padic/scratch/jdemeyer/merger/sage-5.1.beta3/local/lib/python2.7/site-packages/sage/misc/interpreter.py:docstring of sage.misc.interpreter:13: ERROR: Unexpected indentation.
```



---

Comment by jdemeyer created at 2012-05-30 05:34:16

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-05-30 05:36:22

Also, [attachment:trac_12719-scripts.patch] needs a commit message.


---

Comment by jason created at 2012-06-08 03:47:12

It seems that double question mark, like `trace??`, doesn't bring up the source code anymore, but just brings up the docstring.  It seems that trac_12719_ipython_fixes.patch broke this (double question marks work with just the first two patches, but not after that third patch).


---

Comment by jason created at 2012-06-20 13:48:51

Add two more patches to get the new IPython 0.13beta1 spkg above to work.


---

Comment by jason created at 2012-06-25 16:44:24

I rebased [attachment:trac_12719_ROOT_configuration_files.patch] to sage 5.1beta6


---

Comment by jason created at 2012-06-30 16:50:15

I upgraded the spkg to 0.13, which was just released today.


---

Comment by jason created at 2012-06-30 17:38:20

Replying to [comment:49 was]:
> In Sage before this patch, the sage notebook, the Python command line, etc., we have:
> {{{
> for i in range(10):
>     i
> }}}
> outputs the numbers up to 10.
> 
> With the new Ipython spkg, etc., we don't.  
> 
> {{{
> sage: for i in range(10): i
> sage: 
> Exiting Sage (CPU time 0m0.07s, Wall time 2m3.22s).
> blastoff:sage wstein$ sage -ipython
> Python 2.7.2 (default, May 17 2012, 13:12:30) 
> In [1]: for i in range(10): i
> In [2]: 
> }}}
> 
> I'm disappointed, especially because I thought this through and in sagews I recently wrote code so this works correctly in a single cell, even if there are several instances of this.  It's a matter of passing the 'single' option to exec, as is documented in the Python reference.  I wonder why they screwed this up in Ipython 0.12...?
> 
> Anyway, I'm not saying this is a show stopper at all - I want the new ipython in sage.  I'm just a little concerned that literally the first thing I tried shows that they made what I consider a bad design choice.  Hopefully it was just bad luck. 

Fernando Perez responded: 

BTW, regarding William's comment, that was not a mistake or omission: it was a very deliberate choice we made after lots of thought. Given that we manage numbered prompts and history, and that matplotlib produces so many plots as side effects, after much experimentation we found it worked much better to only execute with 'interactive' mode the last block.

Sage doesn't distinguish stdout from python sys.displayhook, so the opposite behavior may be more desirable, but we actually consider that a 'bad design choice' of sage, because it loses an important distinction and the cache management of output history.

So in summary: our choice is actually sensible and consistent given IPython's internal design :)


---

Comment by jason created at 2012-06-30 18:11:35

Fernando:  I looked in the IPython source, and it seems that IPython is a little more subtle than mentioned above.  By default, it only executes the last block as interactive (compile in 'single' mode) _if it is an expression_. In Sage, we (by default) execute the last block always in 'single' mode.  I think that is the difference here.

Given that (and if I understood correctly), could you explain again your reasoning for choosing to not compile in 'single' mode if it isn't an expression?

Note to self for future reference: `for i in range(10): i` invokes sys.displayhook 10 times to display i if compiled in 'single' mode.


---

Comment by jason created at 2012-06-30 18:12:06

Also, note to William: it is an easy option to set to have IPython *always* execute the last block in interactive mode.  It's just not the default.


---

Comment by jason created at 2012-06-30 18:24:57

Replying to [comment:76 jason]:
> Fernando:  I looked in the IPython source, and it seems that IPython is a little more subtle than mentioned above.  By default, it only executes the last block as interactive (compile in 'single' mode) _if it is an expression_. In Sage, we (by default) execute the last block always in 'single' mode.  I think that is the difference here.
> 
> Given that (and if I understood correctly), could you explain again your reasoning for choosing to not compile in 'single' mode if it isn't an expression?

And here is Fernando's response:

Precisely so that if the last block has a loop, it doesn't produce multiple `Out [NN]` cells.  We want to keep a one-to-one mapping between a cell and its output.  For example it's quite common to write code like:


```
for i in x:
  plot(x[i], label='blah_i')
```


If we compile that as 'single', we'd get all the Matplotlib line collection results piling up at the bottom, one for each plot call.

We played a *lot* with various options, and settled on this behavior after much experimentation.  After 2 years of using it, I remain convinced it's the right solution *for us*.  Not to say that Sage can't make a different choice that works better for you guys, of course!


---

Comment by jason created at 2012-06-30 18:26:06

To change this, we just need to set `ast_node_interactivity` to `"last"` in the InteractiveShell.


---

Comment by schilly created at 2012-07-14 20:20:25

Replying to [comment:2 fbissey]:
> Would be nice but we need some porting, here is what typically happen if you try to use ipython-0.12 with sage:
> {{{
> $ sage
> ----------------------------------------------------------------------
> | Sage Version 4.7.2, Release Date: 2011-10-29                       |
> | Type notebook() for the GUI, and license() for information.        |
> ----------------------------------------------------------------------
> Traceback (most recent call last):
>   File "/usr/bin/sage-ipython", line 19, in <module>
>     from IPython.CrashHandler import CrashHandler
> ImportError: No module named CrashHandler
> }}}


Hi fbissey, sorry for hijacking this a bit, but i had exactly the same problem over and over again. What I just found out (and I think it really helps) is to temporarily disable the paths containing ".local" in sys.path in the sage-ipython file. The reason is, that ipython seems to import the "site package" (disable it for pure python via "-S"), because that's where my ipython 0.13 is.

So, by adding this to sage-ipython you I have both at the same time:


```
~~~ after import sys
oldpath = sys.path
sys.path = filter(lambda s : '.local' not in s, sys.path)
import IPython
sys.path = oldpath
```



---

Attachment

Updated patch


---

Comment by jason created at 2012-07-17 14:30:46

I rebased the only rejected patch for 5.2beta1


---

Comment by was created at 2012-07-30 15:24:52

My 2 cents, after I forced myself to use this for the last few weeks on my laptop.  I have found the new ipython to be pretty annoying.  The cut and paste behavior and lack of autoindent at the command line is pretty painful.   The thing that made me finally give up and revert to the old 0.10 ipython was when I hit control-c at the wrong moment when starting Sage, and somehow the ipython history sqlite database got in a weird locked state.  Nothing I could think to do (including deleting $HOME/.sage/ipython) got this unstuck.  Maybe rebooting would have worked; I don't know.   I'm concerned about how stable and well-tested in the wild the new ipython is.     Proceed with caution.


---

Comment by vbraun created at 2012-07-30 15:45:57

Working cut&past and working autoindent are contradictory goals. The terminal just sees a stream of characters, you either inject indentation or not. AFAIR I turned off auto-indent, we could turn that back on. Breaks pasting of indented text, of course.

The ipython dir is now versioned, you should have deleted `$DOT_SAGE/ipython-0.12` / `$DOT_SAGE/ipython-0.13`


---

Comment by vbraun created at 2012-07-30 15:47:19

PS: Maybe you can upload your broken ipython dir somewhere, this would be a good testcase to catch the sqlite error...


---

Comment by kini created at 2012-07-30 15:55:29

IMO, leave auto-indent on, and use `%paste` or `%cpaste` when you want to paste. `%paste` tries to automatically get the contents of your clipboard. If that's not working for whatever reason, `%cpaste` creates a prompt where you can paste text verbatim, which IPython doesn't read until you end input with Ctrl+D or a line containing only the text "--".


---

Comment by vbraun created at 2012-07-30 16:05:52

Replying to [comment:86 kini]:
> IMO, leave auto-indent on, and use `%paste` or `%cpaste` when you want to paste.

For the record, thats not how I use the commandline. I paste code all the time, but I almost never enter multi-line statements manually. So I'd rather have autoindent off by default (and no need for `%cpaste`), and use `%autoindent` if I want it on. Though thats of course a matter of personal preferences, and I'm happy with whatever the majority prefers...


---

Comment by was created at 2012-07-30 16:33:43

Replying to [comment:87 vbraun]:
> Replying to [comment:86 kini]:
> > IMO, leave auto-indent on, and use `%paste` or `%cpaste` when you want to paste.
> 
> For the record, thats not how I use the commandline. I paste code all the time, but I almost never enter multi-line statements manually. So I'd rather have autoindent off by default (and no need for `%cpaste`), and use `%autoindent` if I want it on. Though thats of course a matter of personal preferences, and I'm happy with whatever the majority prefers...

At least it is configurable, right?   I think it is best not to change the default from what it is already in all previous versions of Sage, whether or not that is what the majority prefers (unless it is a huge majority).    I'm not fan of changing UI's on people unless it is absolutely necessary.


---

Comment by vbraun created at 2012-07-30 16:40:51

Well IPythons defaults changed, we didn't just change stuff for the fun of it. For starters, vanilla IPython now disallows any superfluous indentation, i.e. 

```
In [1]: 1
Out[1]: 1

In [2]:  1
IndentationError: unexpected indent (<ipython-input-2-0066badbf200>, line 1)
```



---

Comment by jhpalmieri created at 2012-07-30 21:24:38

Two more issues:

 - when Sage starts, any lines in my init.sage file are echoed to the screen after the first "sage:" prompt. They aren't executed until I hit the return key:

```
----------------------------------------------------------------------
----------------------------------------------------------------------
sage: # Here is the beginning of init.sage.
| Sage Version 5.2, Release Date: 2012-07-25                         |
| Type "notebook()" for the browser-based notebook interface.        |
| Type "help()" for help.                                            |
2+2

# Here is another comment

a = 5

# Here is the end of init.sage.
```

 At this point, hitting <RETURN> inserts a 4, a newline, and the "sage:" prompt, and `a` is defined to be 5.

 - when I evaluate or `plot` a graphics object, two plot windows are opened:

```
sage: P = plot(sin(x), (x, 0, 10))
sage: P  # opens up two windows showing the same plot. Note also the blank line.

sage: plot(P) # also opens up two windows.

sage: show(P)  # opens up only one window.
```



---

Comment by iandrus created at 2012-08-01 12:57:33

Regarding indentation, autoindent being on breaks sage inside Emacs (dumb terminal).  So I think it should be off, at least in a dumb terminal, until/unless I can figure out how to fix this in Emacs.  I haven't really looked into it at all, so it may be easy to fix inside Emacs by setting some environment variables or something.  See #10504.


---

Comment by jason created at 2012-08-01 13:53:02

+1 for autoindent being on by default.  That helps what is probably the vast majority of the cases---interactively typing into the command line.


---

Comment by broken_symlink created at 2012-08-12 23:50:37

I'm having a weird problem when I use IPython.parallel in sage. Here's what happens:

```
from IPython.parallel import Client
rc = Client('/home/seshu/.sage/ipython-new/profile_default/security/ipcontroller-client.json')
dview = rc[:]
dview.map_sync(lambda x: x**10, range(32))
[0:apply]: 
---------------------------------------------------------------------------
NameError                                 Traceback (most recent call last)<string> in <module>()
<ipython-input-4-ad199b8d76dc> in <lambda>(x)
NameError: global name 'Integer' is not defined
```


If I do anything that doesn't involve integers like dview.map_sync(lambda x: "hi", range(32)), it works fine. Sorry if this isn't the appropriate place to ask these questions. I wasn't sure where to ask since this is a bit bleeding edge. I would like to be able to use IPython.parallel from the sage notebook if possible.


---

Comment by broken_symlink created at 2012-08-13 16:54:43

The ipython engines need to import the sage modules. The fix is dview.execute("from sage.all import *"). Also I did sage -sh ipcluster start.


---

Comment by jason created at 2012-08-25 14:05:24

Just FYI, for the *next* version (so not an issue on this ticket), https://github.com/ipython/ipython/pull/2299 broke Sage, I think  by getting rid of PrefilterTransformer tricks.


---

Comment by jason created at 2012-08-25 14:07:42

So I think that the only issue with this ticket is turning back on auto-indentation and getting ?? to show the source code?  Any other issues?

I think the parallel issues above should be moved to another ticket.


---

Comment by jason created at 2012-08-25 14:15:51

Note: ?? shows the source code fine, it seems, in the notebook (at least there doesn't seem to be a regression; ?? shows source when doing tab completion, but not on evaluating, just like before the python upgrade).  It is a regression on the command line, though.


---

Comment by jhpalmieri created at 2012-08-25 14:54:26

There are the issues [comment:90 I mentioned above]. Can anyone else reproduce them?


---

Comment by broken_symlink created at 2012-08-26 03:35:54

The parallel issues only seem to effect the notebook. I've successfully gotten ipython.parallel and sage to run on a small 24 core amazon ec2 cluster, using ssh with the ipython 0.13.1 branch on github. According to the ipython guys, the ssh launcher in 0.13 is broken. I kinda have some idea of whats going with the parallel issues and the notebook as well, but i'm not sure how to fix it. I can write something for how to setup sage with ipython engines started over ssh if this package gets updated to 0.13.1.


---

Comment by jason created at 2012-08-26 03:58:00

Well, hopefully this gets merged before 0.13.1 comes out.


---

Comment by jason created at 2012-09-06 23:26:46

jhpalmieri, I can confirm both of the issues that you saw.  I'm seeing them too.


---

Comment by jason created at 2012-09-06 23:29:31

actually, it looks like autoindent was turned back on: http://trac.sagemath.org/sage_trac/ticket/12719#comment:52


---

Comment by jason created at 2012-09-06 23:40:48

Does anyone know where in the code init.sage is run?  I've searched the entire codebase for "init.sage" and I'm not finding anything that looks like it is responsible for running the file.


---

Comment by jason created at 2012-09-06 23:50:15

Ah, I found it.  It's the last line in sage/misc/interpreter.py, the one that says `self.shell.run_cell('%%load "%s"'%startup_file)`


---

Comment by jason created at 2012-09-07 00:25:20

Okay, it looks like the problem is that we punt to the ipython load, which *pastes* the content so you can edit it first: http://ipython.org/ipython-doc/dev/interactive/qtconsole.html#load


---

Comment by jason created at 2012-09-07 08:58:45

So our conclusion on https://github.com/ipython/ipython/pull/2299 was that Sage should make %load an alias for IPython's %run, and beef up IPython's %run to be able to handle remote files.  In fact, make IPython's %run use the same simple mechanism as IPython's %load would be great (though may not be possible---%run uses file-specific features in python and execfile, etc.)


---

Comment by jason created at 2012-09-08 19:59:07

Is there a reason we didn't use a profile config file for all of our customizations?

I've started a different approach to the customizations we use here: https://github.com/jasongrout/sage-ipython-profile

put these into the .sage/ipython-new directory and then start with `sage -ipython --profile=sage`


---

Attachment


---

Comment by jason created at 2012-09-13 18:57:12

Okay, I think my "take2" patch significantly cleans things up and makes things more modular and more "IPythonic".

In particular, this seems to work nicely: do `sage -ipython notebook` to launch the ipython notebook, then evaluate `%load_ext sage.misc.sage_extension`. All preparsing is turned on, etc.  It's great!

There should probably be a bit more documentation in the sage_extension file, and full doctests should be run.  But I think it's ready for other people to hammer on it too.

Here is one issue: something broke in `sage -startuptime`.  I'm not sure it's IPython's fault, though.

Oh, and I was working from IPython master, not IPython 0.13.  I hope that doesn't put a wrench in the works...


---

Comment by jason created at 2012-09-13 19:31:57

Preliminary tests seem to indicate that these patches and the new take work just fine with IPython 0.13 (at least when I revert my IPython git repository).  So it's still probably ready for more people to hammer on this.


---

Comment by jason created at 2012-09-13 20:26:15

My take2 patch seems to have solved the double plot window problem.  It also solved the init.sage/load problems, as well as the ?? problem.  So that was all of the issues listed...


---

Attachment

Since we now hook into the IPython display hook, we can delete our special display hook.


---

Comment by jason created at 2012-09-14 12:24:32

Changing status from needs_work to needs_review.


---

Comment by jason created at 2012-09-15 10:17:24

Fixed the startup issue with new patch to scripts repository


---

Attachment


---

Comment by jason created at 2012-09-25 12:48:10

Fix a transforming issue: see http://mail.scipy.org/pipermail/ipython-dev/2012-September/010329.html or the commit message.


---

Comment by jdemeyer created at 2012-10-05 15:07:50

This needs to be rebased to sage-5.4.rc0, in particular #13459.


---

Comment by jdemeyer created at 2012-10-05 15:07:50

Changing status from needs_review to needs_work.


---

Comment by jason created at 2012-10-10 03:18:16

Also, #13361 includes the change in the startuptime.py patch, so we can delete it.


---

Comment by jason created at 2012-10-10 03:32:55

rebased to 5.4rc1


---

Attachment

rebased to 5.4rc1


---

Attachment

Add one more patch so we don't change directories anymore.


---

Comment by jason created at 2012-10-10 04:02:08

Changing status from needs_work to needs_review.


---

Comment by jason created at 2012-10-10 04:14:51

Something that seems to work fine now is starting up sage in the devel/sage directory.  So it seems that the issue discussed in #13361 is fixed in this ipython upgrade.


---

Attachment


---

Comment by jason created at 2012-10-10 05:18:31

Okay, I think this may be ready for review again.

It's a big enough change that maybe it would be good to shoot for one of the first patches in the 5.5 release, so it gets plenty of testing???


---

Comment by jhpalmieri created at 2012-10-10 05:39:39

Replying to [comment:41 slabbe]:

> Also, doing `sage -ipython notebook` creates this error :
> 
> {{{
> $ sage -ipython notebook
> Traceback (most recent call last):
> ...
> ImportError: The IPython Notebook requires tornado >= 2.1.0
> }}}

I get this too. Should I just install tornado somehow, or should this be fixed as part of this ticket?

Edit: after installing tornado (with `sage --sh` and `easy_install tornado`), it said I had to install pyzmq. So I did that, and now the notebook runs. It looks very nice, and feels pretty snappy, maybe snappier than the Sage notebook.


---

Comment by jason created at 2012-10-10 05:54:58

Yes, tornado and zmq (pyzmq) are required for the ipython notebook.  That's not part of this ticket.

And yes, the ipython notebook is very nice.  After loading it up, try doing 

```
%load_ext sage.misc.sage_extension
```

to get some sage goodness, like the preparser, etc.!


---

Comment by jdemeyer created at 2012-10-10 06:46:39

Replying to [comment:122 jason]:
> Something that seems to work fine now is starting up sage in the devel/sage directory.
FYI: this was fixed by #13459.


---

Comment by jason created at 2012-10-10 13:22:20

Replying to [comment:127 jdemeyer]:
> Replying to [comment:122 jason]:
> > Something that seems to work fine now is starting up sage in the devel/sage directory.
> FYI: this was fixed by #13459.

But I reverted the "import sage" that #13459 does in [attachment:trac_12719-scripts.patch], and it still works fine for me (running sage in devel/sage and then `import sage` actually imports the site-packages sage).  Maybe IPython changed its handling of sys.path.  What I'm saying is that we should test that my reverting of part of #13459 (the part where we imported sage in sage-ipython) actually does what I think it does.


---

Comment by jhpalmieri created at 2012-10-10 20:59:11

I'm getting doctest failures because of how lists of matrices are printed. For example, with matrix2.pyx:

```
File ".../sage-5.4.rc1/devel/sage/sage/matrix/matrix2.pyx", line 11627:
    sage: (d, u, v)
Expected:
    (
    [     1      0]  [ 1  0]  [ 1 -w]
    [     0 -w + 9], [-w  1], [ 0  1]
    )
Got:
    ([     1      0]
    [     0 -w + 9], [ 1  0]
    [-w  1], [ 1 -w]
    [ 0  1])
```

That file has 7 failures altogether. Is this because you turned off Sage's displayhook?


---

Comment by jason created at 2012-10-10 21:18:15

Interesting.  I thought I used Sage's displayhook (I know I was at one time anyway), but I've also noticed the same problems on my install with printing tuples of matrices and it's been frustrating to me.  I'll take a look at it.


---

Comment by jhpalmieri created at 2012-10-10 21:29:23

[attachment:12719-displayhook.patch] looks relevant, in particular removing the lines

```
import sage.misc.displayhook  
sage.misc.displayhook.install() 
```

and removing the corresponding functions from sage/misc/displayhook.py. But I've never worked with this aspect of Sage before.


---

Comment by jhpalmieri created at 2012-10-10 22:21:46

When I use either `time` or `%time`, the rest of the line doesn't seem to be preparsed: try

```
sage: srange(1/10, 1/2, 1/10)
[1/10, 1/5, 3/10, 2/5]
```

vs.

```
sage: %time srange(1/10, 1/2, 1/10)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
...
ValueError: srange() step argument must not be zero
```

Or even

```
sage: %time 1/10
CPU times: user 0.00 s, sys: 0.00 s, total: 0.00 s
Wall time: 0.00 s
0  <-- note the answer!
```



---

Comment by jason created at 2012-10-10 23:48:58

The displayhook is activated when Sage is run (try running those matrix doctests from the command line).  The problem is that the doctesting framework does *not* use the interactive version of Sage; it seems to use straight python.  So the display hook is not set.

It seems that the display hook used to be set when just importing Sage as a library, maybe?  If so, I think that's the wrong approach.  Importing a library shouldn't obliterate the display hook.

So it sounds like we need to make the doctesting framework load the right Sage things, like the preparser, the display hook, etc.


---

Comment by jason created at 2012-10-10 23:50:33

I'll take a look at %time.  That indeed seems to be a problem where the preparser isn't being run.


---

Comment by jason created at 2012-10-11 02:08:49

For some reason, the preparser explicitly turned itself off for magic lines.  I'm not sure why but I'm posting a patch to fix that.


---

Attachment


---

Comment by jason created at 2012-10-11 03:00:56

John, you know the doctest framework a lot better than I do.  If you start up sage-ipython and load the sage extension, it will install the display hook, import Sage, etc.  John, do you know how to get the doctest runner to execute this as part of ipython: `get_ipython().extension_manager.load_extension('sage.misc.sage_extension')`


```
grout`@`tiny:~/sage% sage -ipython -ic "get_ipython().extension_manager.load_extension('sage.misc.sage_extension')"                    E:128
Python 2.7.3 (default, Oct  9 2012, 11:53:24) 
Type "copyright", "credits" or "license" for more information.

IPython 0.13 -- An enhanced Interactive Python.
?         -> Introduction and overview of IPython's features.
%quickref -> Quick reference.
help      -> Python's own help system.
object?   -> Details about 'object', use 'object??' for extra details.

In [1]: (identity_matrix(3), identity_matrix(5))
Out[1]: 
(
         [1 0 0 0 0]
         [0 1 0 0 0]
[1 0 0]  [0 0 1 0 0]
[0 1 0]  [0 0 0 1 0]
[0 0 1], [0 0 0 0 1]
)
```



---

Comment by jhpalmieri created at 2012-10-11 15:28:13

I guess one reason to turn off the preparser for magic lines is so that in a line like

```
%ed file1.py
```

the "1" doesn't get preparsed. I don't know how the old "time" command was written; did it just call "%time"? If so, maybe that was to allow lines starting with "time" to be preparsed.

For doctesting, I don't know if IPython is used at all during doctesting. If it's possible to turn on this extension using pure Python, we can add it at the top of each file as it's doctested, with a patch like this to local/bin/sage-doctest:

```diff
diff --git a/sage-doctest b/sage-doctest
--- a/sage-doctest
+++ b/sage-doctest
`@``@` -490,6 +490,7 `@``@` def extract_doc(file_name, library_code=
 
 """  % os.path.join(os.getcwd(), file_name)
     s += "from sage.all_cmdline import *; \n"
+    s += "ADD NEW CODE HERE\n"
     s += "import sage.plot.plot; sage.plot.plot.DOCTEST_MODE=True\n"  # turn off image popup
     s += r"""
 def warning_function(f):
```



---

Attachment

apply to scripts repository in local/bin/


---

Attachment


---

Comment by jason created at 2012-10-11 16:48:18

Updated instructions for new display hook patch that sets the display hook when doctesting.


---

Comment by jason created at 2012-10-11 20:28:18

For the %time command, I filed an issue with IPython a while ago: https://github.com/ipython/ipython/pull/2403

For now, it appears like we'll have to ship that patch ourselves.


---

Comment by jhpalmieri created at 2012-10-11 21:23:33

The matrix-printing seems to work now, but I'm seeing a few other doctest failures:

```
sage -t  --long -force_lib devel/sage/sage/interfaces/sage0.py
**********************************************************************
File "/scratch/palmieri/12719/sage-5.4.rc1/devel/sage-main/sage/interfaces/sage0.py", line 489:
    sage: sage0(4).gcd
Expected:
    <built-in method gcd of sage.rings.integer.Integer object at 0x...>
Got:
    <function gcd>
**********************************************************************
```

and several failures in sage_extension.py, which would take up too much room to include here.


---

Comment by jhpalmieri created at 2012-10-15 20:56:12

I think the errors in `sage_extension.py` are because file names in `%runfile foo` are being preparsed: for example, the first error message is pretty long, but it ends with

```
IOError: did not find file '/home/palmieri/.sage/temp/sage.math.washington.edu/Integer(21508)/dir_0/run_cell.py' to load or attach
```

Note that `Integer(21508)` in the file name; this should presumably just be `21508`. This preparsing doesn't happen if the number is mixed in with letters, but for files or directories with purely numeric names, it seems to pop up. So from the command line:

```
sage: %runfile hello2.py   # works
sage: %runfile 123/hello2.py   # fails
sage: %runfile /home/palmieri/123/hello2.py   # fails
```

The same thing happens with `%attach`, and I assume also with the other magic functions which take file names as arguments.


---

Comment by jhpalmieri created at 2012-10-15 21:31:07

I don't understand the `sage0.py` failure. Does the new IPython have a different default print representation for some objects? Before the  patches here:

```
sage: a = 4
sage: a.gcd
<built-in method gcd of sage.rings.integer.Integer object at 0x480e330>
sage: a.gcd?
Type:		builtin_function_or_method
Base Class:	<type 'builtin_function_or_method'>
String Form:	<built-in method gcd of sage.rings.integer.Integer object at 0x480e330>
Namespace:	Interactive
Definition:	a.gcd(self, n)
Docstring:
     ...
```

With the patches:

```
sage: a = 4
sage: a.gcd
<function gcd>
sage: a.gcd?
Type:       builtin_function_or_method
String Form:<built-in method gcd of sage.rings.integer.Integer object at 0x5b7c5a0>
Definition: a.gcd(self, n)
Docstring:
   ...
```

With the old version, the print rep for `a.gcd` is the same as what's labeled the "String Form" when you do `a.gcd?`. With the new version, the print rep has changed but the "String Form" has not. I'm also confused by this behavior (with the patches):

```
sage: a = 4
sage: G = a.gcd
sage: G.__repr__()
'<built-in method gcd of sage.rings.integer.Integer object at 0x4b685a0>'
sage: G
<function gcd>
sage: str(G)
'<built-in method gcd of sage.rings.integer.Integer object at 0x4b685a0>'
```

Why isn't `G` printed using its `__repr__` method?

I've tried out some other objects (e.g., matrices and elements of the Steenrod algebra) and my guess is that the print representations for methods defined in pyx files are getting changed to `<function ...>`, while those defined in py files haven't changed. Any ideas why? Looking at `ipython-0.10.2.p1/src/IPython/UserConfig/ipythonrc`, I see the configuration option `object_info_string_level 0`, which looks relevant, but we're not using this style of configuration, right?


---

Comment by broken_symlink created at 2012-10-15 22:29:50

Just a heads up that iPython 0.13.1 is set to be released on Friday. It fixes all the bugs I was having with ipython.parallel.


---

Attachment


---

Comment by jhpalmieri created at 2012-10-23 15:53:35

We need another patch, since the pager in IPython has moved. One instance of this was fixed in one of the patches, but we need to fix others.

Note the change to sagedoc.py; this needs to be tested.


---

Comment by jason created at 2012-10-23 18:02:23

It seems like you caught all of the instances of the IPython pager:


```
grout`@`tiny:~/sage/devel/sage/sage% ack genutils *
interfaces/gap3.py
493:            import IPython.genutils
494:            IPython.genutils.page(helptext)

misc/pager.py
27:        import IPython.genutils
28:        return IPython.genutils.page

misc/sagedoc.py
833:        from IPython.genutils import page
```



---

Comment by jason created at 2012-10-23 18:12:57

Positive review to the sagedoc.py change---search_src didn't work before, but it does work after the change.


---

Comment by jason created at 2012-10-23 18:13:49

I uploaded an IPython 0.13.1 spkg, updating to the latest stable.  (the old 0.13 spkg is still in my home directory too).


---

Attachment

[attachment:trac_12719-move_to_preparser.patch] doesn't apply cleanly to 5.4.rc2. Here's a rebased version.


---

Comment by jason created at 2012-10-23 19:08:18

jhpalmieri: I uploaded a new IPython 0.13.1 spkg that applies https://github.com/ipython/ipython/pull/2403.  This means we can delete the  [attachment:12719-preparse-magic.patch] patch, which will solve the %runfile problems, but keep the preparsing for %time, %timeit, and %prun.

I've updated the instructions.


---

Comment by jason created at 2012-10-23 19:10:13

Whew, with all these patches---I can't wait until we move to using git (or even mercurial properly) and we have branches for this sort of thing.


---

Comment by jason created at 2012-10-23 19:33:48

The cython function printing issue appears to boil down to those functions being treated as builtin functions, so this line applies: https://github.com/ipython/ipython/blob/master/IPython/lib/pretty.py#L669, rather than this line: https://github.com/ipython/ipython/blob/master/IPython/lib/pretty.py#L671

Suggestions for how to fix this?  How do we distinguish between built-in functions and Cython methods?


---

Comment by jason created at 2012-10-23 20:01:57

I've posted to the IPython list about the Cython method printing: http://mail.scipy.org/pipermail/ipython-dev/2012-October/010503.html


---

Comment by jason created at 2012-10-23 20:03:10

Are there any other outstanding issues other than the Cython method printing?


---

Comment by jhpalmieri created at 2012-10-23 20:08:03

Replying to [comment:152 jason]:
> jhpalmieri: I uploaded a new IPython 0.13.1 spkg that applies https://github.com/ipython/ipython/pull/2403.  This means we can delete the  [attachment:12719-preparse-magic.patch] patch, which will solve the %runfile problems, but keep the preparsing for %time, %timeit, and %prun.

Can you think of a way to doctest this? (I haven't tried anything at all, so it might be easy.)


---

Comment by jason created at 2012-10-23 20:21:17

If just putting in a magic `%timeit ...` doesn't work, then this should work *if* the doctesting framework is using IPython:


```
sage: get_ipython().run_line_magic('time', '594.factor()')
CPU times: user 0.00 s, sys: 0.00 s, total: 0.00 s
Wall time: 0.00 s
2 * 3^3 * 11
```



---

Comment by jhpalmieri created at 2012-10-23 20:45:25

Hey, let's add another patch to the pile!


---

Attachment


---

Comment by jhpalmieri created at 2012-10-24 21:05:31

Replying to [comment:154 jason]:
> The cython function printing issue appears to boil down to those functions being treated as builtin functions, so this line applies: https://github.com/ipython/ipython/blob/master/IPython/lib/pretty.py#L669, rather than this line: https://github.com/ipython/ipython/blob/master/IPython/lib/pretty.py#L671
> 
> Suggestions for how to fix this?  How do we distinguish between built-in functions and Cython methods?

I don't know. Even in previous versions of Sage:

```
sage: type(4.gcd)
<type 'builtin_function_or_method'>
```

I wonder if changing this would require patching Cython. If we knew where the methods for Cython methods were defined, maybe we could just define a method `_repr_pretty_`, as described in https://github.com/ipython/ipython/blob/master/IPython/lib/pretty.py#L27. Line 3737-3740 of `local/lib/python/site-packages/Cython/Compiler/Nodes.py` says

```
        is_builtin_function_or_method = "PyCFunction_Check(%s)" % func_node_temp
        is_overridden = "(PyCFunction_GET_FUNCTION(%s) != (PyCFunction)%s)" % (
            func_node_temp, self.py_func.entry.func_cname)
        code.putln("if (!%s || %s) {" % (is_builtin_function_or_method, is_overridden))
```

Is this relevant?

Alternatively, we could patch the file "pretty.py", modifying the definition of `_type_pprinters` somehow, although I'm not sure how.

Alternatively, we could temporarily accept the new print representation for Cython-defined methods, and create a new ticket for fixing this. It seems like a small issue to me, and maybe it shouldn't hold up the rest of this ticket.


---

Comment by jason created at 2012-10-24 21:14:46

Alternatively, we could post to the Cython list and ask them :).

Ccing robertwb (see the comment or two above about Cython function printing, as well as http://mail.scipy.org/pipermail/ipython-dev/2012-October/010503.html, which tries to lay out the issue more concisely).


---

Comment by jhpalmieri created at 2012-10-24 21:26:08

Asking the Cython developers is a great idea. Here's a real hack, but it seems to work: for built-in functions, if the print representation includes "sage.", we use that. (Now that I look at your post to the IPython list, it's just a version of the hack you described there.) This is a patch for IPython/lib/pretty.py:

```diff
--- pretty.py.orig	2012-10-20 17:30:54.000000000 -0700
+++ pretty.py	2012-10-24 14:19:40.000000000 -0700
`@``@` -616,11 +616,14 `@``@`
 
 def _function_pprint(obj, p, cycle):
     """Base pprint for all functions and builtin functions."""
-    if obj.__module__ in ('__builtin__', 'exceptions') or not obj.__module__:
-        name = obj.__name__
+    if obj.__repr__().find('sage.') != -1:
+        p.text(obj.__repr__())
     else:
-        name = obj.__module__ + '.' + obj.__name__
-    p.text('<function %s>' % name)
+        if obj.__module__ in ('__builtin__', 'exceptions') or not obj.__module__:
+            name = obj.__name__
+        else:
+            name = obj.__module__ + '.' + obj.__name__
+        p.text('<function %s>' % name)
 
 
 def _exception_pprint(obj, p, cycle):
```



---

Comment by jhpalmieri created at 2012-10-26 18:42:30

On the [Cython users](https://groups.google.com/d/topic/cython-users/lVEMHM5keNI/discussion) mailing list, in which I essentially quoted Jason's message to the IPython list, Bradley Froehle says

```
There's nothing to be done in Cython here.  As you point out, 
a.seed is a builtin (i.e. compiled) method and type(a.seed) returns
`builtin_function_or_method` correctly.
```

So I think our options are

- hack pretty.py
- wait for a real IPython fix
- change the doctests to match the current output for now, and open a new ticket to fix this later.

Preferences? Am I missing any good choices?


---

Comment by jhpalmieri created at 2012-11-02 20:50:51

Ping. Any opinions?


---

Comment by jason created at 2012-11-02 20:55:49

Is it hard to change the doctests (how many?).  If that's easy, I'd say to change the doctests, especially given that any patch we make will take a long time to make it back into Sage through IPython.  I'd veto "wait for a real IPython fix".

Is this the only thing holding us back now?


---

Comment by jhpalmieri created at 2012-11-02 23:47:20

I think there is only one failing doctest:

```
sage -t  --long -force_lib devel/sage/sage/interfaces/sage0.py
**********************************************************************
File "/Users/palmieri/Desktop/Sage_stuff/sage_builds/12719/sage-5.4.rc3/devel/sage-main/sage/interfaces/sage0.py", \
line 489:
    sage: sage0(4).gcd
Expected:
    <built-in method gcd of sage.rings.integer.Integer object at 0x...>
Got:
    <function gcd>
**********************************************************************
```

and it should be trivial to fix. I also don't know how serious the issue is. I mean, it would be nice if `4.gcd` printed more information, but it doesn't seem crucial in any way.


---

Attachment


---

Comment by jason created at 2012-11-03 09:33:27

I'd say let's change our doctest, and then work with upstream to get a patch in.  When the patch comes down (probably in a few months to a year?), we'll change our doctest again.


---

Comment by jhpalmieri created at 2012-11-03 15:10:33

I changed the doctest. All tests pass for me on sage.math. Since it was already positively reviewed once before, I think we can set it back to that. What do you think?


---

Comment by jason created at 2012-11-03 15:44:23

Yippee!!


---

Comment by jhpalmieri created at 2012-11-03 17:29:10

Changing status from needs_review to positive_review.


---

Comment by jason created at 2012-11-08 06:54:54

jdemeyer -- it would be great if this were merged into one of the 5.5 betas.


---

Comment by jdemeyer created at 2012-11-08 08:45:53

Of course, don't worry.


---

Comment by jdemeyer created at 2012-11-08 14:32:24

With #13211, I get

```
applying /release/merger/patches/trac_12719-5.1beta1.patch
patching file sage/interfaces/gap.py
Hunk #2 FAILED at 1065
1 out of 2 hunks FAILED -- saving rejects to file sage/interfaces/gap.py.rej
```


Note that #13211 isn't certain to be merged (there were some problems before and the fixes haven't been properly tested yet).


---

Comment by jason created at 2012-11-08 14:36:33

I don't think I've ever applied #13211, and I certainly don't have it applied now.  I didn't realize it was a dependency (I've just been pasting in the instructions in the description).  Can we just remove the dependency?  I'm not sure why we even have it.


---

Comment by jdemeyer created at 2012-11-08 15:28:23

My point is that it should be made a dependency and be rebased to #13211.


---

Comment by jason created at 2012-11-08 16:03:59

But if #13211's future isn't sure yet, should we add that as a dependency?  Granted that the rebase (for either ticket) is a simple 1-2 line fix, but it'd be a shame if this huge work didn't get in because #13211 for some reason didn't pass muster.

You're the release manager, so you make the calls.  Do you still want me to rebase to depend on that ticket?  Does that hurt our chances of getting into 5.5?


---

Comment by jdemeyer created at 2012-11-08 20:15:32

Replying to [comment:178 jason]:
> You're the release manager, so you make the calls.  Do you still want me to rebase to depend on that ticket?  Does that hurt our chances of getting into 5.5?
I will test #13211 and then I'll know better whether or not it will be merged. So let's wait for now.

The best chances for getting this merged is to respond quickly when I ask for it to be rebased.


---

Attachment


---

Comment by jhpalmieri created at 2012-11-08 20:36:13

Here's a patch rebased to #13211. Let's keep the old patch, too, just in case.


---

Comment by jdemeyer created at 2012-11-09 09:29:40

Changing status from positive_review to needs_work.


---

Attachment


---

Comment by jdemeyer created at 2012-11-09 09:33:07

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-11-09 09:33:07

[attachment:12719_run_cython.patch] needs review.


---

Comment by jhpalmieri created at 2012-11-09 17:58:26

I think this looks okay. I'm building and running doctests one more time to make sure.


---

Comment by jhpalmieri created at 2012-11-09 20:15:31

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2012-11-10 20:14:01

Changing status from positive_review to needs_work.


---

Attachment

[attachment:trac_12719-hgignore.patch] needs review.


---

Comment by jhpalmieri created at 2012-11-10 20:14:16

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-11-11 09:40:42

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-11-12 08:00:14

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-11-12 08:00:14

[attachment:trac_12719-scripts.patch] is missing a commit message.

[attachment:12719-5.4rc1.patch] is missing a user name in the patch file.

[attachment:trac_12719-cellmagics013.patch] has a commit message which is all on one line and too long. You should make sure that the lines in commit messages are not too long, but the first line should still be descriptive by itself, since that shows up in `hg log`.

positive review to [attachment:trac_12719-hgignore.patch]


---

Comment by jdemeyer created at 2012-11-13 08:17:47

In `SageInteractiveShell.system_raw`, does `libraries` refer to a global or is that variable simply unused?  Since `false` isn't guaranteed to return exit status 1 (on Solaris, it returns 255, POSIX specifies it must be non-zero), the doctest must be changed to something more portable. I also don't see this function discussed on #975.

So, I suggest the following patch:

```patch
diff --git a/sage/misc/interpreter.py b/sage/misc/interpreter.py
--- a/sage/misc/interpreter.py
+++ b/sage/misc/interpreter.py
`@``@` -161,26 +161,18 `@``@` class SageInteractiveShell(TerminalInter

     def system_raw(self, cmd):
         """
-        Adjust the libraries before calling system commands.  See Trac
-        #975 for a discussion of this function.
+        Run a system command.

         EXAMPLES::

             sage: from sage.misc.interpreter import get_test_shell
             sage: shell = get_test_shell()
             sage: shell.system_raw('false')
-            sage: shell.user_ns['_exit_code']
-            256
+            sage: status = shell.user_ns['_exit_code']
+            sage: os.WIFEXITED(status) and os.WEXITSTATUS(status) != 0
+            True
         """
-        sage_commands = os.listdir(os.environ['SAGE_ROOT']+"/local/bin/")
-        DARWIN_SYSTEM = os.uname()[0]=='Darwin'
-        if cmd in sage_commands:
-            return super(SageInteractiveShell, self).system_raw(cmd)
-        else:
-            libraries = 'LD_LIBRARY_PATH=$$SAGE_ORIG_LD_LIBRARY_PATH;'
-            if DARWIN_SYSTEM:
-                libraries += 'DYLD_LIBRARY_PATH=$$SAGE_ORIG_DYLD_LIBRARY_PATH;'
-            return super(SageInteractiveShell, self).system_raw(cmd)
+        return super(SageInteractiveShell, self).system_raw(cmd)

     def ask_exit(self):
         """
```



---

Comment by jason created at 2012-11-13 19:48:52

I've uploaded a patch to the system command.  The point is that we need to reset the original system libraries if we run a non-sage command.


---

Comment by jason created at 2012-11-13 19:57:35

Apply to sage repository


---

Attachment

rebased to 5.4rc1


---

Attachment


---

Comment by jason created at 2012-11-13 20:00:09

Changing status from needs_work to needs_review.


---

Comment by jason created at 2012-11-13 20:00:09

Okay, I think I've taken care of the outstanding issues with the patches.


---

Comment by jason created at 2012-11-13 20:20:42

I updated the system patch to also include a doctest checking to see if a system command is running with the Sage LD_LIBRARY_PATH.


---

Comment by jdemeyer created at 2012-11-13 20:42:32

You should also doctest `system_raw` working succesfully.

I think you can replace

```
os.file.isfile(FILE)
```

by

```
os.access(FILE, os.X_OK):
```

since you want to check for an _executable_ file.

Also, I assume that "cmd" uses shell syntax? Then you're doing it wrong. Correct shell syntax is

```
LD_LIBRARY_PATH="$SAGE_ORIG_LD_LIBRARY_PATH"; export LD_LIBRARY_PATH
```



---

Comment by jdemeyer created at 2012-11-13 20:42:42

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2012-11-13 21:03:41

I'm not an expert on bash syntax (I assume this is using bash), but perhaps some (or all?) of these would work:

```sh
LD_LIBRARY_PATH="$SAGE_ORIG_LD_LIBRARY_PATH"; export LD_LIBRARY_PATH; ...
export LD_LIBRARY_PATH="$SAGE_ORIG_LD_LIBRARY_PATH"; ...
env LD_LIBRARY_PATH="$SAGE_ORIG_LD_LIBRARY_PATH"  ...   # note no semicolon
LD_LIBRARY_PATH="$SAGE_ORIG_LD_LIBRARY_PATH"  ...       # ??
```



---

Comment by jdemeyer created at 2012-11-13 21:12:30

I don't know whether we can assume bash, I would go for Posix `/bin/sh` compatible.

For example

```
export LD_LIBRARY_PATH="$SAGE_ORIG_LD_LIBRARY_PATH";
```

is bash-specific and I'm not sure about

```
LD_LIBRARY_PATH="$SAGE_ORIG_LD_LIBRARY_PATH"  ...
```



---

Comment by jason created at 2012-11-13 21:24:00

Changing status from needs_work to needs_review.


---

Comment by jason created at 2012-11-13 21:24:00

I hope this redo is good!  Thanks for the tips.


---

Comment by jdemeyer created at 2012-11-13 21:26:26

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-11-13 21:26:26

You should replace $$ by $.


---

Comment by jdemeyer created at 2012-11-13 21:27:43

And please also doctest a non-Sage command working successfully. For example

```
system_raw("true")
```



---

Attachment

apply to sage repository


---

Comment by jason created at 2012-11-13 21:36:17

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2012-11-14 20:49:59

All of the patches apply cleanly (on top of 5.5.beta0 + #9191), and the new [attachment:12719-system.patch] looks okay to me. Jeroen, what do you think?

I have one mild complaint: if I do

```
sage: note[TAB]
```

it doesn't complete to "notebook" anymore, saying that "%notebook" is also a valid completion. Would it be possible, here or on a followup ticket, to rename the "%notebook" magic command to "%ipython_notebook" or something similar?


---

Comment by jdemeyer created at 2012-11-14 20:55:15

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-11-14 20:55:15

Looks fine. As for the TAB-completion: a different ticket please.


---

Comment by jdemeyer created at 2012-11-16 12:16:56

Upgrading from sage-4.5 fails with a trial version of sage-5.5.beta2 and this is the only ticket I can think of that could cause this problem. The error shows up in `Twisted` (part of `sagenb` now):

```
Installed /release/buildbot/sage/sage-1/sage_upgrade_4.5/build/sage-5.5.beta2/local/lib/python2.7/site-packages/Twisted-12.1.0-py2.7-linux-x86_64.egg
Processing dependencies for Twisted==12.1.0
Searching for zope.interface

Link to http://pypi.python.org/simple/zope.interface/ ***BLOCKED*** by --allow-hosts

Couldn't find index page for 'zope.interface' (maybe misspelled?)
Scanning index of all packages (this may take a while)

Link to http://pypi.python.org/simple/ ***BLOCKED*** by --allow-hosts

No local packages or download links found for zope.interface
error: Could not find suitable distribution for Requirement.parse('zope.interface')
Error installing Twisted-12.1.0.tar.bz2 !
```



---

Comment by jdemeyer created at 2012-11-16 12:59:19

Whether or not IPython causes the zope.interface problem, I won't have time anyway to test it...


---

Comment by jason created at 2012-11-16 14:43:17

This seems like it has to be a sagenb problem (that we aren't requiring zope.interface, and thus packaging zope.interface, in our sagenb prereqs).

Upgrading from sage 4.5?  I'm almost sure that it's the sagenb upgrade at #13121, not this ticket.


---

Comment by jason created at 2012-11-16 14:52:47

Okay, here's what makes sense: the old IPython required zope.interface, so it was always installed when we installed the new notebook, so we never noticed that we needed it for the sage notebook.  The new IPython no longer requires zope.interface, so when the notebook at #13121 checks for it, it isn't installed so sagenb tries to install it.

The correct fix is to make sagenb require and package zope.interface, like it should have before now, not to change this ticket.


---

Comment by jason created at 2012-11-16 16:09:00

I uploaded a new sagenb spkg at #13717


---

Comment by jdemeyer created at 2012-11-16 19:21:04

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-11-16 19:21:04

Another upgrade issue:

```
sage_root-5.5.beta2
Machine:
Darwin bsd.math.washington.edu 10.8.0 Darwin Kernel Version 10.8.0: Tue Jun  7 16:32:41 PDT 2011; root:xnu-1504.15.3~1/RELEASE_X86_64 x86_64
Deleting directories from past builds of previous/current versions of sage_root-5.5.beta2
Extracting package /Users/buildbot/build/sage/bsd-1/bsd_upgrade_4.6.2/build/sage-5.5.beta2/spkg/standard/sage_root-5.5.beta2.spkg ...
-rw-r--r--  1 buildbot  staff  323619 Nov 16 04:38 /Users/buildbot/build/sage/bsd-1/bsd_upgrade_4.6.2/build/sage-5.5.beta2/spkg/standard/sage_root-5.5.beta2.spkg
Finished extraction
****************************************************
Host system
uname -a:
Darwin bsd.math.washington.edu 10.8.0 Darwin Kernel Version 10.8.0: Tue Jun  7 16:32:41 PDT 2011; root:xnu-1504.15.3~1/RELEASE_X86_64 x86_64
****************************************************
****************************************************
CC Version
gcc -v
Using built-in specs.
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/Users/buildbot/build/sage/bsd-1/bsd_upgrade_4.6.2/build/sage-5.5.beta2/local/libexec/gcc/x86_64-apple-darwin10.8.0/4.6.3/lto-wrapper
Target: x86_64-apple-darwin10.8.0
Configured with: ../src/configure --prefix=/Users/buildbot/build/sage/bsd-1/bsd_upgrade_4.6.2/build/sage-5.5.beta2/local --with-local-prefix=/Users/buildbot/build/sage/bsd-1/bsd_upgrade_4.6.2/build/sage-5.5.beta2/local --with-gmp=/Users/buildbot/build/sage/bsd-1/bsd_upgrade_4.6.2/build/sage-5.5.beta2/local --with-mpfr=/Users/buildbot/build/sage/bsd-1/bsd_upgrade_4.6.2/build/sage-5.5.beta2/local --with-mpc=/Users/buildbot/build/sage/bsd-1/bsd_upgrade_4.6.2/build/sage-5.5.beta2/local --with-system-zlib --disable-multilib  
Thread model: posix
gcc version 4.6.3 (GCC) 
****************************************************
cp: ipython: No such file or directory
Root repo: Error copying files from Sage root repo to /Users/buildbot/build/sage/bsd-1/bsd_upgrade_4.6.2/build/sage-5.5.beta2
```


The file `spkg/root-spkg-install` should be fixed.


---

Comment by jdemeyer created at 2012-11-16 19:22:19

Jason: that makes sense.


---

Attachment

root repo


---

Comment by jhpalmieri created at 2012-11-16 19:29:21

I think this patch will fix the problem.


---

Comment by jhpalmieri created at 2012-11-16 19:29:21

Changing status from needs_work to needs_review.


---

Comment by jason created at 2012-11-29 04:35:57

Here's another problem highlighted by https://github.com/sagemath/sagecell/issues/378: 


```
"""string
"""; type(1)
```

does no preparsing on the second line because IPython doesn't do transformations for the second line (since it's inside quotes).  IPython admits that this is a hackish and fragile strategy, and they are working on the issue.  For example, they are implementing [AST transformers](https://github.com/ipython/ipython/pull/2301) and [stateful line transformers](https://github.com/ipython/ipython/pull/2447).  However, for now, we should run at least our preparser on every line of input, since we *do* keep track of state, so we need to be preparsing that second line.

I have a patch coming up shortly.


---

Attachment

apply to sage library


---

Comment by jhpalmieri created at 2012-11-29 19:14:39

Does this most recent patch need a doctest?


---

Comment by jhpalmieri created at 2012-11-30 05:48:01

By the way, this passes all doctests. I also upgraded Sage 5.2 successfully from a source distribution prepared using the patches here.


---

Attachment

Updated patch


---

Comment by vbraun created at 2013-01-13 14:45:26

I've rediffed trac_12719-scripts-vb.patch to account for pure whitespace changes in #13899 (merged in sage-5.6.beta3)


---

Comment by vbraun created at 2013-01-14 11:47:55

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-01-14 11:47:55

Works for me and as far as I can tell all remaining issues have been addressed.

Does not fix #11223, %bg is not implemented in ipython-0.13.1.


---

Comment by jdemeyer created at 2013-01-17 15:44:10

Rediffed patch


---

Attachment


---

Comment by jdemeyer created at 2013-01-20 21:22:50

This seems to cause some problems on OpenSolaris.

First a doctest time-out:

```
Trying:
    sage0.eval('2+2')###line 320:_sage_    sage: sage0.eval('2+2')
Expecting:
    '4'
[...hangs...]
```


Interrupting this and restarting Sage gives:

```
buildbot`@`hawk:~/build/sage/hawk-1/hawk_suncc/build/sage$ ./sage
----------------------------------------------------------------------
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
| Sage Version 5.7.beta0, Release Date: 2013-01-20                   |
| Type "notebook()" for the browser-based notebook interface.        |
| Type "help()" for help.                                            |
**********************************************************************

Oops, Sage crashed. We do our best to make it stable, but...

A crash report was automatically generated with the following information:
  - A verbatim copy of the crash traceback.
  - A copy of your input history during this session.
  - Data on your current Sage configuration.

It was left in the file named:
        '/export/home/buildbot/.sage/ipython-new/Sage_crash_report.txt'
If you can email this file to the developers, the information in it will help
them in understanding and correcting the problem.

You can mail it to: sage-support at sage-support`@`googlegroups.com
with the subject 'Sage Crash Report'.

If you want to do it now, the following command will work (under Unix):
mail -s 'Sage Crash Report' sage-support`@`googlegroups.com < /export/home/buildbot/.sage/ipython-new/Sage_crash_report.txt

To ensure accurate tracking of this issue, please file a report about it at:
http://trac.sagemath.org/sage_trac

Hit <Enter> to quit (your terminal may close)
```


Removing `$HOME/.sage` fixed that.


---

Comment by jdemeyer created at 2013-01-20 21:22:50

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2013-01-20 22:43:35

Can we have a beta0 with this ticket? Its a bit ridiculous to have to use a script to apply all these patches.

Also, `.sage/ipython-new`? What are we going to do the next time the configuration file format changes, `.sage/ipython-even-newer`?


---

Comment by jdemeyer created at 2013-01-21 10:25:16

Replying to [comment:222 vbraun]:
> Can we have a beta0 with this ticket?
See [http://sage.math.washington.edu/home/release/sage-5.7.beta1](http://sage.math.washington.edu/home/release/sage-5.7.beta1)


---

Comment by jason created at 2013-01-21 15:11:36

Volker, you're right that the config file directory is still a bit clunky.  On the one hand, I didn't want to put the version number in there so that it changes every time we upgrade IPython.  On the other hand, calling something 'new' doesn't scale.

What if we put the version number in there like this: `ipython-0.12-or-later`?  That's weird too, but it also means that people don't have to keep moving their configuration files if IPython upgrades, but the config format stays the same.


---

Comment by vbraun created at 2013-01-21 15:24:24

I think we are smart enough to figure out that `ipython-0.12` is the directory for configuration files that were introduced with iPython 0.12 and that you might run a later (but still compatible) version.


---

Comment by jason created at 2013-01-21 19:21:48

But IIRC, Matplotlib uses a per-version config directory inside of .sage, so having two conventions could be confusing.


---

Comment by jason created at 2013-01-21 19:22:28

What about the name `IPython-0.12+`?


---

Comment by vbraun created at 2013-01-21 19:42:15

I don't really care about the name as long as it has the version somewhere in there. Personally I find anything extra just confusing but feel free to pick what you like.


---

Comment by vbraun created at 2013-01-21 19:44:53

Jeroen: can you attach the /export/home/buildbot/.sage/ipython-new/Sage_crash_report.txt


---

Comment by vbraun created at 2013-01-21 22:54:28

I tested this on OpenIndiana (OpenSolaris clone) and I don't see the timeout that Jeroen has. I get occasional non-reproducible timeouts on OI though, it might be something generally wonky with their PTYs. Remind me again why something that nobody is using or has access to is a primary platform?


---

Comment by jhpalmieri created at 2013-01-21 23:43:16

I see a crash on David Kirkby's machine hawk. Crash log posted [here](http://sage.math.washington.edu/home/palmieri/misc/Sage_crash_report.txt).


---

Comment by vbraun created at 2013-01-22 12:43:54

Sane catching of history database errors has been fixed upstream at https://github.com/ipython/ipython/commit/d347c347bab915df69d499521b4876d3c9b168b9, but not in a released version.

See also: https://github.com/ipython/ipython/issues/2097


---

Comment by vbraun created at 2013-01-22 13:41:41

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2013-01-22 13:41:41

I've backported the changes to `history.py`, this should fix the startup failure.


---

Comment by jason created at 2013-01-22 16:49:51

Keeping track, I guess there's one more thing to do: change the config directory back to .sage/ipython-0.12 in [attachment:trac_12719-ipythondir013.patch]


---

Attachment

rebased to 5.4rc1


---

Comment by jason created at 2013-01-22 17:24:57

Okay, I changed the ipythondir013.patch to use the config directory ipython-0.12.  So that needs review too.


---

Comment by jason created at 2013-01-22 17:25:43

Updating work issues with the things that need review.


---

Comment by vbraun created at 2013-01-22 19:44:32

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-01-22 19:44:32

I'm fine with your patch for the directory name. Any expect interface on OpenIndiana occasionally crashes (maybe 1 in 20), but I've verified we are now not permanently stuck with a corrupted history file any more.


---

Comment by jhpalmieri created at 2013-01-22 20:51:53

On hawk, I see a doctest failure, but I'm not sure how it could be related to this ticket:

```
sage -t  --long -force_lib devel/sage/sage/tests/french_book/mpoly.py                     
**********************************************************************                    
File "/export/home/palmieri/testing/clean/sage-5.7.beta1/devel/sage-main/sage/tests/frenc\
h_book/mpoly.py", line 373:                                                               
    sage: J.variety(RDF)                                                                  
Expected:                                                                                 
    [{y: 396340.89..., x: 26.61226...}]                                                   
Got:                                                                                      
    [{y: 396340.890167, x: -46.7888621592}]                                               
**********************************************************************                    
1 items had failures:                                                                     
   1 of 151 in __main__.example_0                                                         
***Test Failed*** 1 failures.                       
```

I also see a time out:

```
sage -t  --long -force_lib devel/sage/sage/interfaces/sage0.py                            
*** *** Error: TIMED OUT! PROCESS KILLED! *** ***                                         
                                                                                          
         [1800.2 s] 
```

which perhaps is related to this ticket.


---

Comment by jdemeyer created at 2013-01-23 07:55:34

Replying to [comment:238 jhpalmieri]:
> sage -t  --long -force_lib devel/sage/sage/tests/french_book/mpoly.py                     
Not related to this ticket.

> {{{
> sage -t  --long -force_lib devel/sage/sage/interfaces/sage0.py                            
> *** *** Error: TIMED OUT! PROCESS KILLED! *** ***                                         
>                                                                                           
>          [1800.2 s] 
> }}}
This is indeed related to this ticket, see [comment:221].  But I haven't tried with the latest version of the spkg.


---

Comment by jdemeyer created at 2013-01-23 13:50:48

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-01-23 13:50:48

Patches [attachment:trac_12719_ROOT_configuration_files.patch] and [attachment:trac_12719-ipythondir013.patch] combined and rebased.  And moved the setting of `IPYTHONDIR` to `sage-env` where it belongs.


---

Attachment

Rebased to sage-5.7.beta0


---

Comment by jdemeyer created at 2013-01-23 13:51:46

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2013-01-23 15:18:37

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-01-23 15:18:37

Sounds good to me.


---

Comment by jason created at 2013-01-23 17:09:50

Volker and Jeroen: thanks for both of you working quickly on the last remaining issues!


---

Comment by jhpalmieri created at 2013-01-23 20:05:29

One patch doesn't apply cleanly to 5.6.rc1:

```
adding trac_12719-rebased-to-13211-vb.patch to series file
applying trac_12719-rebased-to-13211-vb.patch
patching file sage/interfaces/gap.py
Hunk #1 FAILED at 177
1 out of 2 hunks FAILED -- saving rejects to file sage/interfaces/gap.py.rej
```

I _think_ that the hang on hawk is gone with the latest versions, but I'm testing again to make sure.


---

Comment by vbraun created at 2013-01-23 20:14:53

Replying to [comment:246 jhpalmieri]:
> One patch doesn't apply cleanly to 5.6.rc1:

You might be missing a dependency since the patch is in sage-5.7.beta1...


---

Comment by jhpalmieri created at 2013-01-23 20:19:39

Changing status from positive_review to needs_work.


---

Comment by jhpalmieri created at 2013-01-23 20:19:39

I didn't think that 5.7.beta0 had been released. Am I supposed to use the unofficial version of it?

By the way, since the file `ipy_profile_sage.py` has been deleted, any mention of it should also be removed from `sage-make_devel_packages` and `sage-spkg-install`.


---

Comment by jason created at 2013-01-23 20:39:58

Can someone test something really quick with the official version of the ticket, if it's convenient?

Do:


```
1; 2
```


Does it print out both 1 and 2 in both the command line and the notebook?  Right now, aleph only prints out 2, and I've narrowed it down to how IPython handles the 'print out the last expression' (IPython prints out the last expression, while Sage prints out the last physical line).


---

Comment by vbraun created at 2013-01-23 21:43:43

John, see comment:223. Since Jeroen linked to it I'd say its official ;-)

Jason, works for me (this is with the sagenb update but it shouldn't matter):

```
[vbraun`@`volker-desktop sage-5.7.beta1]$ ./sage
----------------------------------------------------------------------
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
sage:  1; 2
1
2
```



---

Comment by vbraun created at 2013-01-23 22:25:49

Initial patch


---

Comment by vbraun created at 2013-01-23 22:29:14

Changing status from needs_work to positive_review.


---

Attachment

I've removed the last occurrences from `ipy_profile_sage.py`.


---

Comment by jason created at 2013-01-23 22:30:03

Volker: and in the sage notebook, it does the same thing?  I think it should, but I just want to make sure.


---

Comment by vbraun created at 2013-01-23 22:35:02

Replying to [comment:252 jason]:
> Volker: and in the sage notebook, it does the same thing?

Yes, same (correct) output in the notebook (with the sagenb-0.10.4 spkg).


---

Comment by jdemeyer created at 2013-01-24 08:02:12

Could somebody who knows this ticket please look at #12167 and #12926 to check whether they might be closed?


---

Comment by jason created at 2013-01-24 08:55:22

I think both of those can be closed.  The new config system is set up with IPYTHONDIR, which is in DOTSAGE.  sage --ipython should use that now.


---

Comment by novoselt created at 2013-01-25 02:27:22

Hello,

I just want to confirm that this is expected with this ticket:

```
----------------------------------------------------------------------
----------------------------------------------------------------------
sage: exit
'Use Ctrl-D (i.e. EOF), %Exit, or %Quit to exit without confirmation.'
sage: 
```

Was "just exit for exit" a feature of old IPython or Sage?


---

Attachment


---

Comment by jdemeyer created at 2013-01-25 09:03:27

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-01-25 09:03:51

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2013-01-25 09:03:51

[attachment:12719_ipython_test.patch] needs review


---

Comment by vbraun created at 2013-01-25 09:13:52

I don't know whats up with the overly attached Python interpreter but at least Ctrl-D works. Imho exit should just do that but that can be done (and doctested) on another ticket.

Jeroen's patch looks good to me.


---

Comment by vbraun created at 2013-01-25 09:14:02

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-01-25 13:03:27

The timeout on `hawk` of [comment:221] still exists, I'll have a look.


---

Comment by jdemeyer created at 2013-01-25 14:05:58

This is the cause of the crash on `hawk`, it still has to do with the history database: [http://boxen.math.washington.edu/home/buildbot/crashlogs/hawk_ipython_crash.log](http://boxen.math.washington.edu/home/buildbot/crashlogs/hawk_ipython_crash.log)


---

Comment by jdemeyer created at 2013-01-25 14:10:27

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-01-25 14:10:27

We should probably disable the command history for the `sage0()` interface, but I don't know how one can do that.


---

Comment by vbraun created at 2013-01-25 14:24:36

Can be done in IPython with 

```
ipython --HistoryManager.hist_file=:memory:
```



---

Comment by vbraun created at 2013-01-25 14:27:26

How about we run sage0 with `--nodotsage`?


---

Comment by jdemeyer created at 2013-01-25 14:30:19

Replying to [comment:266 vbraun]:
> How about we run sage0 with `--nodotsage`?
No, having access to the IPython crash log would be good.

I'm preparing a patch, hang on...


---

Attachment


---

Comment by jdemeyer created at 2013-01-25 14:42:24

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2013-01-25 14:46:36

I've reported the issue upstream: https://github.com/ipython/ipython/issues/2845


---

Comment by vbraun created at 2013-01-25 14:52:20

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-01-25 14:52:20

Sounds good to me. I've verified that this disables caching. I don't have a harddisk that is slow enough to trigger the locking issue ;-)


---

Comment by jdemeyer created at 2013-01-25 15:21:43

On `sage.math`, over NFS it's fairly easy to reproduce.


---

Comment by jdemeyer created at 2013-01-26 09:53:28

Resolution: fixed


---

Comment by jdemeyer created at 2013-01-28 11:03:49

John Cremona reports on `sage-release`:

```
jec`@`fermat%./sage
----------------------------------------------------------------------
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
---------------------------------------------------------------------------
NameError                                 Traceback (most recent call last)
/home/jec/sage-5.7.beta1/local/lib/python2.7/site-packages/IPython/utils/py3compat.pyc
in execfile(fname, *where)
    176             else:
    177                 filename = fname
--> 178             __builtin__.execfile(filename, *where)
| Sage Version 5.7.beta1, Release Date: 2013-01-26                   |
| Type "notebook()" for the browser-based notebook interface.        |
| Type "help()" for help.                                            |
/home/jec/.sage/init.sage in <module>()
----> 1 load /home/jec/sage/ecdb.py

NameError: name 'load' is not defined
```



---

Comment by jdemeyer created at 2013-01-28 11:04:12

Volker Braun reports:

```
/mnt/storage2TB/patchbot/Sage/sage-5.7.beta1/local/lib/python2.7/site-packages/sage/misc/sage_extension.pyc in print_branch(self=<sage.misc.sage_extension.SageCustomizations object>)
    423     def set_quit_hook(self):
    424         """
    425         Set the exit hook to cleanly exit Sage.  This does not work in all cases right now.
    426         """
    427         def quit(shell):
    428             import sage
    429             sage.all.quit_sage()
    430         self.shell.set_hook('shutdown_hook', quit)
    431 
    432     def print_branch(self):
    433         """
    434         Print the branch we are on currently
    435         """
    436         from sage.misc.misc import branch_current_hg_notice, branch_current_hg
    437         branch = branch_current_hg_notice(branch_current_hg())
--> 438         if branch and not self.shell.test_shell:
        branch = 'Loading Sage library. Current Mercurial branch is: 0'
        self.shell.test_shell = undefined
    439             print branch
    440 
    441     def init_environment(self):
    442         """
    443         Set up Sage command-line environment
    444         """
    445         try:
    446             self.shell.run_cell('from sage.all import Integer, RealNumber')
    447         except Exception:
    448             import traceback
    449             print "Error importing the Sage library"
    450             traceback.print_exc()
    451             print
    452             print "To debug this, you can run:"
    453             print 'sage -ipython -i -c "import sage.all"'

AttributeError: 'SageInteractiveShell' object has no attribute 'test_shell'
```



---

Comment by vbraun created at 2013-01-28 11:12:36

I've created #14024 to collect any patches that we need on top of Sage-5.7.beta1


---

Comment by jdemeyer created at 2013-01-31 10:54:09

Please have a look at #14042, another follow-up.


---

Comment by jdemeyer created at 2013-02-01 12:42:53

There is still this problem:

```
jec`@`fermat%./sage
----------------------------------------------------------------------
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
---------------------------------------------------------------------------
NameError                                 Traceback (most recent call last)
/home/jec/sage-5.7.beta1/local/lib/python2.7/site-packages/IPython/utils/py3compat.pyc
in execfile(fname, *where)
    176             else:
    177                 filename = fname
--> 178             __builtin__.execfile(filename, *where)
| Sage Version 5.7.beta1, Release Date: 2013-01-26                   |
| Type "notebook()" for the browser-based notebook interface.        |
| Type "help()" for help.                                            |
/home/jec/.sage/init.sage in <module>()
----> 1 load /home/jec/sage/ecdb.py

NameError: name 'load' is not defined
```



---

Comment by jason created at 2013-02-06 06:40:08

#14066 was opened to deal with all remaining issues.


---

Comment by jhpalmieri created at 2013-02-26 18:01:25

How are users supposed to configure Sage's IPython now? See [sage-support](https://groups.google.com/d/topic/sage-support/yZ9W-un7Hlg/discussion). Right now, it looks like IPython's config files (either `.sage/ipython-0.12/profile_default/ipython_config.py` or `.sage/ipython-0.12/profile_sage/ipython_config.py`) are not loaded when Sage initializes its terminal. A possible solution:

```diff
diff --git a/sage/misc/interpreter.py b/sage/misc/interpreter.py
--- a/sage/misc/interpreter.py
+++ b/sage/misc/interpreter.py
`@``@` -672,9 +672,11 `@``@`
 
     def __init__(self, **kwargs):
         # Overwrite the default Sage configuration with the user's.
+        from IPython.frontend.terminal.ipapp import load_default_config
         new_config = Config()
         new_config._merge(DEFAULT_SAGE_CONFIG)
         new_config._merge(kwargs.get('config', Config()))
+        new_config._merge(load_default_config())
         kwargs['config']=new_config
         super(SageTerminalApp, self).__init__(**kwargs)
 
```

Then `.sage/ipython-0.12/profile_default/ipython_config.py` will be read and merged with Sage's configuration. Is this the right solution? Should I open a ticket? Or am I missing something?


---

Comment by vbraun created at 2013-02-26 18:21:09

Looks good to me


---

Comment by jhpalmieri created at 2013-02-26 18:29:36

See #14188.


---

Comment by jdemeyer created at 2016-09-06 08:31:35

Replying to [comment:225 vbraun]:
> I think we are smart enough to figure out that `ipython-0.12` is the directory for configuration files that were introduced with iPython 0.12 and that you might run a later (but still compatible) version.

No, we are not:

```diff
commit 24ea89290988305d93f85988022cde7284268aeb
Author: R. Andrew Ohana <andrew.ohana`@`gmail.com>
Date:   Sun Feb 16 16:32:29 2014 -0800

    dynamically set IPYTHONDIR based on the current version of ipython

diff --git a/src/bin/sage-env b/src/bin/sage-env
index a9021b7..fee3c56 100644
--- a/src/bin/sage-env
+++ b/src/bin/sage-env
`@``@` -359,7 +359,12 `@``@` if [ "$SAGE_STARTUP_FILE" = "" ]; then
     export SAGE_STARTUP_FILE
 fi
 
-export IPYTHONDIR="$DOT_SAGE/ipython-0.12"
+if [ -x "$SAGE_LOCAL/bin/ipython" ]; then
+    export IPYTHONDIR="$DOT_SAGE/ipython-"`ipython --version`
+else
+    # IPython is not yet installed
+    export IPYTHONDIR="$DOT_SAGE/ipython-"`sed 's+\.p[0-9]*$++' "$SAGE_ROOT"/build/pkgs/ipython/package-version.txt`
+fi
 
 if [ -d "$SAGE_ROOT/local/lib/python" ]; then
     PYTHONPATH="$SAGE_ROOT/local/lib/python"
```


I will change this back to a hardcoded version in #21430.
