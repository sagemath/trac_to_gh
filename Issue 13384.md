# Issue 13384: Improve libGAP startup error handling

Issue created by migration from https://trac.sagemath.org/ticket/13588

Original creator: vbraun

Original creation time: 2012-10-08 21:03:45

Assignee: joyner

CC:  mmarco tfeulner iandrus simonking

Currently, libGAP doesn't give useful errors if something goes wrong during initialization.


---

Comment by vbraun created at 2012-10-09 10:47:44

Changing status from new to needs_review.


---

Comment by vbraun created at 2012-10-09 10:47:44

Miguel, you said that you had some mysterious error. Can you try this patch? It depends on the recently-updated patches on #6391, #13211.


---

Comment by mmarco created at 2012-10-09 11:13:36

I have been checking the different updates of libgap, and the error seemed to go away several versions ago. Anyways, i will keep testing it.


---

Comment by mmarco created at 2012-10-11 20:56:56

I don't know if it is an issue related with this patch or if it comes from libgap itself, but i have experienced some problems when i use tab completion in a session in the command line (i haven't checked it in the notebook).

An example:


```
sage: F=libgap.eval('FreeGroup(2)')
sage: (a,b)=F.GeneratorsOfGroup()
sage: H=F/libgap([a^2,b^2,a*b*a*b])
sage: H
<fp group on the generators [ f1, f2 ]>
sage: H.IsomorphismSimplifiedFpGroup()
[ f1, f2 ] -> [ f1, f2 ]
sage: H=F/libgap([a^2,b^2,a*b])    
sage: c=H.Gene
H.GeneralLinearGroup      H.GeneralisedEigenspaces  H.GeneralizedEigenvalues  H.GeneratorsOfIdeal
H.GeneralOrthogonalGroup  H.GeneralisedEigenvalues  H.GeneratorsOfField       
H.GeneralUnitaryGroup     H.GeneralizedEigenspaces  H.GeneratorsOfGroup       
sage: c=H.GeneratorsOfGroup()[0]
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)

/home/mmarco/sage-5.4/<ipython console> in <module>()

/home/mmarco/sage-5.4/local/lib/python2.7/site-packages/sage/libs/gap/element.so in sage.libs.gap.element.GapElement.__getattr__ (sage/libs/gap/element.c:3555)()

AttributeError: Name "GeneratorsOfGroup" is not defined in GAP.
sage: c=H.GeneratorsOfGroup()   
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)

/home/mmarco/sage-5.4/<ipython console> in <module>()

/home/mmarco/sage-5.4/local/lib/python2.7/site-packages/sage/libs/gap/element.so in sage.libs.gap.element.GapElement.__getattr__ (sage/libs/gap/element.c:3555)()

AttributeError: Name "GeneratorsOfGroup" is not defined in GAP.
sage: H
Exception RuntimeError: 'Entered a critical block twice' in 'sage.libs.gap.util.error_handler' ignored
<fp group on the generators [ f1, f2 ]>
sage: H.GeneratorsOfGroup()
[ f1, f2 ]
sage: c=H.GeneratorsOfGroup()[0]
sage: c
f1
sage: c=H.Generat
H.GeneratorsOfField  H.GeneratorsOfGroup  H.GeneratorsOfIdeal  
sage: c=H.GeneratorsOfGroup()
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)

/home/mmarco/sage-5.4/<ipython console> in <module>()

/home/mmarco/sage-5.4/local/lib/python2.7/site-packages/sage/libs/gap/element.so in sage.libs.gap.element.GapElement.__getattr__ (sage/libs/gap/element.c:3555)()

AttributeError: Name "GeneratorsOfGroup" is not defined in GAP.
sage: c=H.GeneratorsOfGroup()
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)

/home/mmarco/sage-5.4/<ipython console> in <module>()

/home/mmarco/sage-5.4/local/lib/python2.7/site-packages/sage/libs/gap/element.so in sage.libs.gap.element.GapElement.__getattr__ (sage/libs/gap/element.c:3555)()

AttributeError: Name "GeneratorsOfGroup" is not defined in GAP.
sage: H
Exception RuntimeError: 'Entered a critical block twice' in 'sage.libs.gap.util.error_handler' ignored
<fp group on the generators [ f1, f2 ]>
sage: c=H.GeneratorsOfGroup()
```



---

Comment by mmarco created at 2012-10-12 13:42:38

This same behaviour appears when i don't use this patch, so reported in the libgap ticket.


---

Comment by vbraun created at 2012-10-22 13:31:29

Updated patch fixes the issue with the command line completion


---

Comment by vbraun created at 2012-11-09 19:52:11

Updated spkg fixes long input lines (>32k characters):

```
sage: S = SymmetricGroup(10000)
sage: s = S.random_element()
sage: len(str(s._gap_()))
61673
sage: libgap(s)
(1,5243,8582,5012,6862,7477,1681,7423,8405,3101,...,5257,9362,2495,8500)( [...] )
```



---

Comment by vbraun created at 2012-11-13 02:55:54

I've added the same workaround for the gap command line option issue as just discussed in #13211


---

Comment by vbraun created at 2012-11-16 00:21:16

I've added `__nonzero__` for wrapped GAP booleans for easier use.


---

Comment by vbraun created at 2012-11-20 01:22:22

Updated patch


---

Attachment

The new patch allows to change the comparison method for libgap objects since not all GAP objects can be compared. This is important if you want use them as cache keys.

Also, the comparison was not properly wrapped in `sig_on/sig_off`


---

Comment by vbraun created at 2012-12-18 12:16:26

I forgot to package `aclocal.m4`, updated spkg adds that file.


---

Comment by vbraun created at 2012-12-26 13:04:19

Updated to libGap-4.5.7


---

Comment by vbraun created at 2012-12-26 13:12:21

patch from #6391


---

Attachment

patch from #6391


---

Comment by mmarco created at 2012-12-27 12:10:12

I still see the segfault when trying to execute "Exec" trough libgap. This seems to make it impossible to load gap packages that make use of external programs.


---

Comment by vbraun created at 2012-12-27 12:27:53

Thanks for reminding me, I completely forgot about the Exec thing.

In the meantime, can we get this reviewed and included into Sage before the next GAP version comes out?


---

Comment by vbraun created at 2012-12-27 12:47:55

I've replaced the spkg with a new version that fixes the GAP Exec command.


---

Attachment

Updated patch


---

Comment by mmarco created at 2012-12-27 13:17:15

Thanks. Still i can't load the kbmag package :(


---

Comment by vbraun created at 2012-12-27 14:43:27

I've updated the spkg, now loading kbmag works for me. I had to install it by hand since your spkg at #13673 is offline.


---

Comment by dimpase created at 2013-01-02 15:58:15

I get a slew of errors in ptestlong after following the instructions of the ticket with Sage 5.5; e.g.:

```
sage -t  --long -force_lib devel/sage/sage/libs/gap/libgap.pyx
**********************************************************************
File "/usr/local/src/sage/sage-5.5/devel/sage-main/sage/libs/gap/libgap.pyx", line 11:
    sage: a = libgap(10)
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage/sage-5.5/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/usr/local/src/sage/sage-5.5/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/usr/local/src/sage/sage-5.5/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_0[2]>", line 1, in <module>
        a = libgap(Integer(10))###line 11:
    sage: a = libgap(10)
      File "lazy_import.pyx", line 244, in sage.misc.lazy_import.LazyImport.__call__ (sage/misc/lazy_import.c:2012)
      File "lazy_import.pyx", line 148, in sage.misc.lazy_import.LazyImport._get_object (sage/misc/lazy_import.c:1291)
      File "libgap.pyx", line 574, in init sage.libs.gap.libgap (sage/libs/gap/libgap.c:4157)
        libgap = Gap()
      File "libgap.pyx", line 395, in sage.libs.gap.libgap.Gap.__init__ (sage/libs/gap/libgap.c:2716)
        initialize()
      File "util.pyx", line 193, in sage.libs.gap.util.initialize (sage/libs/gap/util.c:3312)
        from sage.interfaces.gap import get_gap_memory_pool_size
    ImportError: cannot import name get_gap_memory_pool_size
**********************************************************************
File "/usr/local/src/sage/sage-5.5/devel/sage-main/sage/libs/gap/libgap.pyx", line 12:
    sage: a
Exception raised:
    Traceback (most recent call last):
      File "/usr/local/src/sage/sage-5.5/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/usr/local/src/sage/sage-5.5/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/usr/local/src/sage/sage-5.5/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_0[3]>", line 1, in <module>
        a###line 12:
    sage: a
    NameError: name 'a' is not defined

```


are some patches missing or not up date?


---

Comment by vbraun created at 2013-01-02 16:41:35

Did you apply the patches from #13211? The `get_gap_memory_pool_size()` function was added in `trac_13211_fix_gap_doctests_vb.patch`.


---

Comment by dimpase created at 2013-01-02 16:52:09

Replying to [comment:27 vbraun]:
> Did you apply the patches from #13211? The `get_gap_memory_pool_size()` function was added in `trac_13211_fix_gap_doctests_vb.patch`.

indeed, I overlooked that #13211 isn't merged in 5.5. Sorry for noise.


---

Comment by dimpase created at 2013-01-02 17:41:37

Does sig_on() need a matching sig_off() in case sig_on() is issued in a try block, which throws an exception?

Comparison functions returning -1, 0, +1... So FORTRAN |V... :-)


---

Comment by vbraun created at 2013-01-02 17:57:23

`sig_on` and `sig_off` must be paired, though ideally they enclose only C/Cython code which cannot raise Python exceptions. A C signal will jump back to `sig_on` and raise there.

http://www.sagemath.org/doc/developer/coding_in_cython.html#using-sig-on-and-sig-off


---

Comment by dimpase created at 2013-01-03 03:15:13

patches from #13880 are needed for doctests to (eventually) pass here.


---

Comment by dimpase created at 2013-01-05 05:09:22

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-01-10 13:31:58

Is the test program `sage/libs/gap/test/main.c` used anywhere in the Sage library?  I don't mind having such a program, but I'd say it belongs in the libgap spkg and not in the Sage library.  It could be run when installing libGAP.


---

Comment by vbraun created at 2013-01-10 13:48:14

`sage/libs/gap/test/main.c` is not used anywhere. As the readme file explains, it is there if you need an example for how to link with libGAP without Sage. This can be useful for debugging. LibGAP has its own testsuite.


---

Comment by jdemeyer created at 2013-01-10 14:57:15

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-01-10 14:57:15

libgap tries to run various autotools, which should be avoided (as it can lead to build errors).  Probably this is simply timestamps were clobbered during the packaging.

```
libgap-4.5.7.log:WARNING: 'aclocal-1.12' is missing on your system.  You should only need it if
libgap-4.5.7.log:WARNING: 'automake-1.12' is missing on your system.  You should only need it if
libgap-4.5.7.log:WARNING: 'autoconf' is missing on your system.  You should only need it if
libgap-4.5.7.log:WARNING: 'autoheader' is missing on your system.  You should only need it if
```



---

Comment by vbraun created at 2013-01-10 19:08:06

Ok I've regenerated the files and checked that it builds without the WARNING on an older machine. Spkg at the same place.


---

Comment by vbraun created at 2013-01-10 19:08:06

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2013-01-11 09:28:43

While building the documentation with this patch included, twice something went wrong.
1. First time, I got an "unhandled SIGSEGV" in Sage while reading the sources of some elliptic curve file (sorry, forgot which one) for the PDF documentation.  I didn't store the exact logs since I thought it was a cosmic ray or something...
2. Next attempt, building from scratch again during the build of the HTML documentation:

```
reading sources... [ 86%] sage/schemes/elliptic_curves/cm
reading sources... [ 87%] sage/schemes/elliptic_curves/constructor
reading sources... [ 87%] sage/schemes/elliptic_curves/ec_database
reading sources... [ 87%] sage/schemes/elliptic_curves/ell_curve_isogeny
reading sources... [ 87%] sage/schemes/elliptic_curves/ell_field
reading sources... [ 87%] sage/schemes/elliptic_curves/ell_finite_field
reading sources... [ 87%] sage/schemes/elliptic_curves/ell_generic

Exception occurred:
  File "/release/merger/sage-5.7.alpha0/local/lib/python2.7/site-packages/Sphinx-1.1.2-py2.7.egg/sphinx/environment.py", line 831, in read_doc
    pickle.dump(doctree, f, pickle.HIGHEST_PROTOCOL)
MemoryError
The full traceback has been saved in /tmp/release/sphinx-err-QDcECu.log, if you want to report the issue to the developers.
```


Full traceback:

```
# Sphinx version: 1.1.2
# Python version: 2.7.3
# Docutils version: 0.7 release
# Jinja2 version: 2.5.5
Traceback (most recent call last):
  File "/release/merger/sage-5.7.alpha0/local/lib/python2.7/site-packages/Sphinx-1.1.2-py2.7.egg/sphinx/cmdline.py", line 189, in main
    app.build(force_all, filenames)
  File "/release/merger/sage-5.7.alpha0/local/lib/python2.7/site-packages/Sphinx-1.1.2-py2.7.egg/sphinx/application.py", line 204, in build
    self.builder.build_update()
  File "/release/merger/sage-5.7.alpha0/local/lib/python2.7/site-packages/Sphinx-1.1.2-py2.7.egg/sphinx/builders/__init__.py", line 196, in build_update
    'out of date' % len(to_build))
  File "/release/merger/sage-5.7.alpha0/local/lib/python2.7/site-packages/Sphinx-1.1.2-py2.7.egg/sphinx/builders/__init__.py", line 216, in build
    purple, length):
  File "/release/merger/sage-5.7.alpha0/local/lib/python2.7/site-packages/Sphinx-1.1.2-py2.7.egg/sphinx/builders/__init__.py", line 120, in status_iterator
    for item in iterable:
  File "/release/merger/sage-5.7.alpha0/local/lib/python2.7/site-packages/Sphinx-1.1.2-py2.7.egg/sphinx/environment.py", line 616, in update_generator
    self.read_doc(docname, app=app)
  File "/release/merger/sage-5.7.alpha0/local/lib/python2.7/site-packages/Sphinx-1.1.2-py2.7.egg/sphinx/environment.py", line 831, in read_doc
    pickle.dump(doctree, f, pickle.HIGHEST_PROTOCOL)
MemoryError
```


I cannot say for sure that this ticket is to blame, but the `MemoryError` certainly made me suspect GAP. And I also saw some "halving pool size" messages appear during the docbuilding.


---

Comment by dimpase created at 2013-01-11 09:51:47

Replying to [comment:40 jdemeyer]:
> While building the documentation with this patch included, twice something went wrong.
> 1. First time, I got an "unhandled SIGSEGV" in Sage while reading the sources of some elliptic curve file (sorry, forgot which one) for the PDF documentation.  I didn't store the exact logs since I thought it was a cosmic ray or something...
> 2. Next attempt, building from scratch again during the build of the HTML documentation:

if this happens on one host only, I'd blame the RAM there.


---

Comment by jdemeyer created at 2013-01-11 09:57:17

Replying to [comment:41 dimpase]:
> if this happens on one host only, I'd blame the RAM there.
If this happens _only_ with the libGAP patches, I'd blame libGAP.  Besides, why would faulty RAM lead to a `MemoryError` exception?


---

Comment by vbraun created at 2013-01-11 10:05:07

All GAP/libGAP processes should be terminated by the time we are building the manual, so I don't see how we could possibly impact that.

Is this a 32-bit machine? There you might run into warts caused by the limited address space, and the halving pool size would support that. Sphinx uses quite a lot of memory and might fail to load its pickles if there is no memory left **or** no contiguous address space block available.


---

Comment by jdemeyer created at 2013-01-11 10:22:27

Replying to [comment:43 vbraun]:
> All GAP/libGAP processes should be terminated by the time we are building the manual
Not really, as building the manual runs Sage code (as witnessed for example that Segmentation Faults run the Sage signal handler and display "Unhandled SIGSEGV...")


---

Comment by vbraun created at 2013-01-11 10:30:11

Replying to [comment:44 jdemeyer]:
> Not really, as building the manual runs Sage code (as witnessed for example that Segmentation Faults run the Sage signal handler and display "Unhandled SIGSEGV...")

Theoretically true, but a normal Sage session won't start GAP until it has to and libGAP is lazily imported as well. Even then, none of that has anything to do with the elliptic curve stuff. 

Right now the only thing in this ticket that seems to actually influence the docbuild is that the documentation becomes larger.


---

Comment by jdemeyer created at 2013-01-11 10:34:06

Replying to [comment:45 vbraun]:
> Theoretically true, but a normal Sage session won't start GAP until it has to and libGAP is lazily imported as well.
The fact that I'm seeing "halving pool size" messages during the docbuilding proves that GAP is started.


---

Comment by vbraun created at 2013-01-11 12:29:04

Replying to [comment:46 jdemeyer]:
> The fact that I'm seeing "halving pool size" messages during the docbuilding proves that GAP is started.

That indeed means that something is wonky. We are trying hard to pick a pool size that **should fit into memory** yet it doesn't. As I said before, this means that either there is very little memory to start with or the available address space is so fragmented that there is no contiguous piece left (32-bit only).


---

Comment by vbraun created at 2013-01-11 12:34:02

I guess sphinx has to resolve the lazy imports in order to get at the docstrings? That would pull in libGAP, which then subtracts ~250MB from the available address space. On a 32-bit machine that might push you over the cliff since sphinx is the most memory-demanding piece of the whole sage build process. Can you tell us which architecture we are talking about?


---

Comment by jdemeyer created at 2013-01-11 12:58:34

Sorry, I wasn't immediately aware of this, but this was with `ulimit -v 2500000` (2.5GB) set on a 64-bit system.


---

Comment by jdemeyer created at 2013-01-12 21:51:12

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-01-12 21:51:12

This needs a patch to `MANIFEST.in` to add the `Makefile` (but again: I doubt that this really belongs in the Sage library).


---

Attachment

Initial patch


---

Comment by vbraun created at 2013-01-13 21:09:13

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2013-01-13 21:09:13

I've added it to the manifest. I do think it is useful, when I started working on libgap that was one of the first things that I had to figure out.


---

Attachment


---

Comment by jdemeyer created at 2013-01-15 09:37:17

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-01-15 09:37:47

New `SAGE_ROOT` patch which adds libgap as dependency of the Sage library.


---

Comment by jdemeyer created at 2013-01-15 09:37:47

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2013-01-15 09:50:23

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-01-15 09:50:23

Looks good to me!


---

Comment by jdemeyer created at 2013-01-17 19:22:48

Patch needed for SPARC


---

Attachment

[attachment:libgap_sparc.patch] must be added to the spkg to work on SPARC.


---

Comment by jdemeyer created at 2013-01-17 19:23:15

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2013-01-17 19:47:16

Thanks. I've added it to the symbol rewriting code in the `make_spkg.sh` script.

```
#ifdef SPARC
#if SPARC
        asm("           .globl  SparcStackFuncBags              ");
        asm("   SparcStackFuncBags:                             ");
        asm("           ta      0x3     ! ST_FLUSH_WINDOWS      ");
        asm("           mov     %sp,%o0                         ");
        asm("           retl                                    ");
        asm("           nop                                     ");
#endif
#endif

/* sunos */
#ifdef SPARC
#if SPARC
        asm("           .globl  _SparcStackFuncBags             ");
        asm("   _SparcStackFuncBags:                            ");
        asm("           ta      0x3     ! ST_FLUSH_WINDOWS      ");
        asm("           mov     %sp,%o0                         ");
        asm("           retl                                    ");
        asm("           nop                                     ");
#endif
#endif
#else
#if defined(SPARC) && SPARC
void SparcStackFuncBags( void )
{
  asm (" ta 0x3 ");
  asm (" mov %sp,%o0" );
  return;
}
#endif
```

I presume the offending code has grown organically over the decades...


---

Comment by vbraun created at 2013-01-17 19:57:31

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2013-01-18 16:04:37

The similar operation needs to be done for

```
ItaniumRegisterStackTop
```



---

Comment by jdemeyer created at 2013-01-18 16:04:37

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-01-18 16:07:56

Also: please remove `src/src/gasman.c.orig`


---

Comment by vbraun created at 2013-01-18 16:57:30

Yay, more conditional compilation ;-)  I've added the conditional `itanium.s` source. I also changed the `make_spkg.sh` script to start from the tarball, so no superfluous files should be included. I tested the new spkg (same location) successfully on sage.math and iras.


---

Comment by vbraun created at 2013-01-18 16:57:52

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2013-01-18 17:10:10

Replying to [comment:60 vbraun]:
> I tested the new spkg
I assume that also includes running libgap doctests, because that's where the error shows up.


---

Comment by vbraun created at 2013-01-18 18:31:00

Well I checked that `itanium.s` is compiled and linked into libgap on iras.


---

Comment by vbraun created at 2013-01-19 12:44:07

I compiled sage on iras overnight and doctests pass, too ;-)


---

Comment by jdemeyer created at 2013-01-21 07:15:14

Something went wrong with your search/replace script, on `mark` (Solaris):

```
ld.so.1: python2.7: fatal: relocation error: file /home/buildbot/build/sage/mark-1/mark_full/build/sage-5.7.beta0/local/lib/libgap.so.0: symbol libGAP_libGAP_SparcStackFuncBags: referenced symbol not found
```



---

Comment by jdemeyer created at 2013-01-21 07:15:14

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2013-01-21 11:41:05

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2013-01-21 11:41:05

Fixed - the SparcStackFuncBags occurs in inline assembly and in C, so I now made sure to only rename it once.


---

Comment by jdemeyer created at 2013-01-22 07:30:19

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-01-22 07:30:19

I'm still not entirely happy with the memory allocation during docbuilding.  For reasons I cannot understand, the documentation used to build fine with

```
ulimit -v 2500000
```

but now it needs (I tested 100MB increments)

```
ulimit -v 3500000
```

which is an increase of 1GB.  Of course, the documentation is also getting bigger, but that explains only a small part of the increase.  Also, on the buildbot I'm seeing sometimes errors of the form

```
sphinx-build -b html -d /home/buildbot/build/sage/iras-1/iras_full/build/sage-5.7.beta0/devel/sage/doc/output/doctrees/de/tutorial    /home/buildbot/build/sage/iras-1/iras_full/build/sage-5.7.beta0/devel/sage/doc/de/tutorial /home/buildbot/build/sage/iras-1/iras_full/build/sage-5.7.beta0/devel/sage/doc/output/html/de/tutorial
Traceback (most recent call last):
  File "/home/buildbot/build/sage/iras-1/iras_full/build/sage-5.7.beta0/devel/sage/doc/common/builder.py", line 1093, in <module>
    getattr(get_builder(name), type)()
  File "/home/buildbot/build/sage/iras-1/iras_full/build/sage-5.7.beta0/devel/sage/doc/common/builder.py", line 232, in _wrapper
    getattr(get_builder(document), name)(*args, **kwds)
  File "/home/buildbot/build/sage/iras-1/iras_full/build/sage-5.7.beta0/devel/sage/doc/common/builder.py", line 88, in f
    subprocess.call(build_command, shell=True)
  File "/home/buildbot/build/sage/iras-1/iras_full/build/sage-5.7.beta0/local/lib/python/subprocess.py", line 493, in call
    return Popen(*popenargs, **kwargs).wait()
  File "/home/buildbot/build/sage/iras-1/iras_full/build/sage-5.7.beta0/local/lib/python/subprocess.py", line 679, in __init__
    errread, errwrite)
  File "/home/buildbot/build/sage/iras-1/iras_full/build/sage-5.7.beta0/local/lib/python/subprocess.py", line 1143, in _execute_child
    self.pid = os.fork()
OSError: [Errno 12] Cannot allocate memory
make: *** [doc-html-mathjax] Error 1
```

I suspect that GAP has something to do with this.

Could you somehow fix the memory allocation to allocate an absolutely minimal amount during docbuilding?  Maybe it would make sense to introduce an environment variable `SAGE_GAP_MEGABYTES` which could be user-set to the desired memory size and which would be set by the docbuilder to a small number (say, 1 MB).


---

Comment by vbraun created at 2013-01-22 18:13:36

I've added a setting to our Sphinx config (`doc/common/conf.py`) and builder config (`build_options.py`) to use only the minimum amount for GAP memory pool. The builder and sphinx itself both import everything to get at docstrings, so two libgap instances are being created when building the documentation. I verified that I can now build all documentation with `ulimit -v 2500000`).


---

Comment by vbraun created at 2013-01-22 18:13:36

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2013-01-23 17:15:19

The following is fairly reproducible (with #13717 applied):

```
sage -t  -force_lib devel/sagenb-main/sagenb/misc/support.py
**********************************************************************
File "/release/merger/sage-5.7.beta1/devel/sagenb-main/sagenb/misc/support.py", line 479:
    sage: sage.server.support.syseval(gap, "2+3")
Expected:
    '5'
Got:
    ** Gap crashed or quit executing '2+3;' **
    Restarting Gap and trying again
    '5'
**********************************************************************
```


Note that GAP is started with only 1MB of memory, as the top of this `strace` log shows:

```
execve("/release/merger/sage-5.7.beta1/local/gap/latest/bin/x86_64-unknown-linux-gnu-gcc-default64/gap", ["/release/merger/sage-5.7.beta1/local/gap/latest/bin/x86_64-unknown-linux-gnu-gcc-default64/gap", "-m", "24m", "-l", "/release/merger/sage-5.7.beta1/local/gap/latest", "-r", "-b", "-p", "-T", "-o", "1m", "-s", "1m", "/release/merger/sage-5.7.beta1/local/share/sage/ext/gap/sage.g"], [/* 84 vars */]) = 0
```


Full strace log: [http://boxen.math.washington.edu/home/jdemeyer/gap.28216](http://boxen.math.washington.edu/home/jdemeyer/gap.28216)


---

Attachment

Updated patch


---

Comment by vbraun created at 2013-01-23 20:09:01

I see, introspection runs Sphinx as well so there is a chance to get `conf.py` imported in Sage. Though curiously, it doesn't cause any doctest failure on my machine. I moved the part that limits GAP to a branch in `conf.py` that is only executed when we actually build the documentation, this should fix it.


---

Comment by jdemeyer created at 2013-01-26 09:54:00

Resolution: fixed
