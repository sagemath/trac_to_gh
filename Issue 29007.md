# Issue 29007: Apply a function to all components of a tensor field

Issue created by migration from https://trac.sagemath.org/ticket/29244

Original creator: egourgoulhon

Original creation time: 2020-02-24 11:06:31

CC:  tscrim

Keywords: manifolds, tensor, components, sd107

This ticket adds the method `map_components` to the class `TensorField`, which applies a function to the coordinate expressions of all components of a tensor field in a given vector frame.
This allows operations like factorization, expansion, simplification or substitution to be performed on the components.

Such a method has been requested in e.g. https://ask.sagemath.org/question/42107/basic-work-on-tensor-components/ and was discussed again during [Sage Days 107](https://wiki.sagemath.org/days107).


---

Comment by egourgoulhon created at 2020-02-24 11:08:39

New commits:


---

Comment by egourgoulhon created at 2020-02-24 11:09:59

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2020-02-24 12:10:42

For vectors and matrices, such method already exists and is called `apply_map`

```
sage: v = vector(range(4))
sage: v.apply_map(lambda x: x^2)
(0, 1, 4, 9)
sage: m = matrix(3,range(9))
sage: m.apply_map(lambda x: x^2)
[ 0  1  4]
[ 9 16 25]
[36 49 64]
```

Is the difference in terminology intended?


---

Comment by vdelecroix created at 2020-02-24 12:10:42

Changing status from needs_review to needs_info.


---

Comment by egourgoulhon created at 2020-02-24 12:44:42

Replying to [comment:3 vdelecroix]:
> For vectors and matrices, such method already exists and is called `apply_map`
>
> Is the difference in terminology intended?

No, not at all. Thanks for pointing out this. 
In the context of tensor fields, `apply_map` may sound a little bit too vague (for instance, it may evoke a pull back operation associated with a map between manifolds). Would  `apply_map_components` be more appropriate?


---

Comment by vdelecroix created at 2020-02-24 13:09:25

Replying to [comment:4 egourgoulhon]:
> Replying to [comment:3 vdelecroix]:
> > For vectors and matrices, such method already exists and is called `apply_map`
> >
> > Is the difference in terminology intended?
> 
> No, not at all. Thanks for pointing out this. 
> In the context of tensor fields, `apply_map` may sound a little bit too vague (for instance, it may evoke a pull back operation associated with a map between manifolds). Would  `apply_map_components` be more appropriate?

The vagueness also applies to vectors/matrices where map can also refer to a morphism between vector spaces. I am not a big fan of the terminology but to my mind, consistency is the best option for the Sage interface as a whole. This consistency didcatorship includes as an option changing `apply_map` to something better.


---

Comment by vdelecroix created at 2020-02-24 13:11:42

Replying to [comment:5 vdelecroix]:
> Replying to [comment:4 egourgoulhon]:
> > Replying to [comment:3 vdelecroix]:
> > > For vectors and matrices, such method already exists and is called `apply_map`
> > >
> > > Is the difference in terminology intended?
> > 
> > No, not at all. Thanks for pointing out this. 
> > In the context of tensor fields, `apply_map` may sound a little bit too vague (for instance, it may evoke a pull back operation associated with a map between manifolds). Would  `apply_map_components` be more appropriate?
> 
> The vagueness also applies to vectors/matrices where map can also refer to a morphism between vector spaces. I am not a big fan of the terminology but to my mind, consistency is the best option for the Sage interface as a whole. This consistency didcatorship includes as an option changing `apply_map` to something better.

`apply_map` is redundant. I would just have called it map because of the already existing Python function

```
sage: list(map(lambda x: x^2, range(4)))
[0, 1, 4, 9]
```



---

Comment by tscrim created at 2020-02-24 23:07:51

I am -1 on calling the method `map` as I would first think it should return a `map` either from or based on the object or a map form of the object (such as for a matrix).


---

Comment by egourgoulhon created at 2020-02-25 16:15:45

Thank you Vincent and Travis for the discussion. I am pretty sensitive to the consistency argument put forward in comment:5, so I would lean toward `apply_map`. Do we all agree?


---

Comment by vdelecroix created at 2020-02-25 16:29:10

Replying to [comment:8 egourgoulhon]:
> Thank you Vincent and Travis for the discussion. I am pretty sensitive to the consistency argument put forward in comment:5, so I would lean toward `apply_map`. Do we all agree?

Dear Eric, that is of course ok for me!


---

Comment by @mwageringel created at 2020-02-25 17:18:21

I just want to mention that matrices also have a method `map_coefficients` which is very similar, coming from modules with basis. It is supposed to work with an endofunction on the coefficient ring, however it seems to be broken for matrices:

```
sage: matrix.identity(2).map_coefficients(lambda x: x+1)
...
KeyError: 1
```

As `apply_map` does not require an endofunction, it has a more general notion, though.


---

Comment by @PatrickMassot created at 2020-02-25 17:37:46

I'm the one who asked for this function, so I'm very happy to see this patch. But I'm uneasy about the way it can be used to introduce inconsistencies between frames. Was it already easy to abuse SageManifolds like this before?

At least I would phrase that as a warning in the docstrings, instead of making it sound like a feature. I mean, it can be a feature where the function being mapped is non-destructive like factor, but substituting a parameter in some frame but not the other is clearly evil.


---

Comment by egourgoulhon created at 2020-02-25 21:05:26

Replying to [comment:11 gh-PatrickMassot]:
> I'm the one who asked for this function, so I'm very happy to see this patch. But I'm uneasy about the way it can be used to introduce inconsistencies between frames. Was it already easy to abuse SageManifolds like this before?
> 
> At least I would phrase that as a warning in the docstrings, instead of making it sound like a feature. I mean, it can be a feature where the function being mapped is non-destructive like factor, but substituting a parameter in some frame but not the other is clearly evil.

That's a good point. It should be easy to add a keyword argument such as `keep_other_components=False` or `non-destructive=False` to enforce the consistency between the sets of components in various frames. The components in frames different from the requested one will then be deleted. When requested, they can be recomputed via change-of-frame formulas. However, this can be time consuming and, in some cases, may generate a loss of information due to some lack of simplifications.


---

Comment by git created at 2020-02-26 21:55:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2020-02-26 22:02:09

In the above commit, the method has been renamed `apply_map` (cf. comment:9) and the consistency issue pointed out in comment:11 has been delt with by adding the keyword argument `keep_other_components`. Its default value (`False`) enforces the consistency among the components in various vector frames.


---

Comment by egourgoulhon created at 2020-02-26 22:02:22

Changing status from needs_info to needs_review.


---

Comment by egourgoulhon created at 2020-03-09 10:53:50

Anybody to perform the final review? If we want this in 9.1, this could be the good time...


---

Comment by tscrim created at 2020-03-09 12:19:58

I will give this the green light. I added Vincent as a reviewer considering the name change was based off his suggestion. If anyone else feels like they want to be a reviewer, please add your name.


---

Comment by tscrim created at 2020-03-09 12:19:58

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2020-03-09 13:25:08

Thank you Travis!


---

Comment by vbraun created at 2020-03-11 23:46:20

Resolution: fixed
