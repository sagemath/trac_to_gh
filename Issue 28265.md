# Issue 28265: MR36: Use Sphinx hash function

Issue created by migration from https://trac.sagemath.org/ticket/28502

Original creator: galois

Original creation time: 2019-09-15 16:16:35

CC:  slelievre nthiery embray roed vdelecroix

Julian RÃ¼th ([`@`saraedum](https://gitlab.com/saraedum)) opened a merge request at https://gitlab.com/sagemath/sage/merge_requests/36:
----

```markdown
otherwise lots of doc rebuilds (this is a huge problem with building
docker images.)
```








---

Comment by saraedum created at 2019-09-15 16:19:11

Changing component from PLEASE CHANGE to documentation.


---

Comment by saraedum created at 2019-09-15 16:19:11

Changing type from PLEASE CHANGE to defect.


---

Comment by saraedum created at 2019-09-15 16:19:11

CCing some people who care about docker images. This is responsible for a fraction of our automated docker builds failing. They fail the `test-dev` stage which checks that `make doc` does not take too long. Sometimes it just finshes in time, sometimes it takes too long.


---

Comment by saraedum created at 2019-09-15 16:20:22

Note that Sphinx's current hash function is

```
def get_stable_hash(obj):
    # type: (Any) -> unicode
    """
    Return a stable hash for a Python data structure.  We can't just use
    the md5 of str(obj) since for example dictionary items are enumerated
    in unpredictable order due to hash randomization in newer Pythons.
    """
    if isinstance(obj, dict):
        return get_stable_hash(list(obj.items()))
    elif isinstance(obj, (list, tuple)):
        obj = sorted(get_stable_hash(o) for o in obj)
    return md5(text_type(obj).encode('utf8')).hexdigest()
```


I assume it used to be just the last line at some point.


---

Comment by galois created at 2019-09-15 16:22:05

New commits added to merge request.  I updated the commit SHA-1.  New commits:


---

Comment by saraedum created at 2019-09-15 17:11:42

Unfortunately, this is not the only problem. Docs are still rebuilding during docker builds.


---

Comment by saraedum created at 2019-09-15 17:11:42

Changing status from needs_review to needs_work.


---

Comment by galois created at 2019-09-15 17:20:00

New commits added to merge request.  I updated the commit SHA-1.  New commits:


---

Comment by galois created at 2019-09-15 18:58:15

New commits added to merge request.  I updated the commit SHA-1.  This was a forced push.  New commits:


---

Comment by saraedum created at 2019-09-15 19:40:17

Changing keywords from "" to "docker, ci".


---

Comment by galois created at 2019-09-16 00:49:14

New commits added to merge request.  I updated the commit SHA-1.  New commits:


---

Comment by galois created at 2019-09-16 06:19:14

New commits added to merge request.  I updated the commit SHA-1.  Last 10 new commits:


---

Comment by saraedum created at 2019-09-16 06:23:18

The changes seem to do the trick now as long as the same architecture runs `build-from-latest` and `test-dev`. The third bullet point from the summary should probably go into a followup ticket then. It's not as urgent and seems to be an upstream issue.


---

Comment by galois created at 2019-09-16 09:15:18

New commits added to merge request.  I updated the commit SHA-1.  New commits:


---

Comment by galois created at 2019-09-16 10:31:18

New commits added to merge request.  I updated the commit SHA-1.  New commits:


---

Comment by saraedum created at 2019-09-16 12:32:00

Seems to work fine. There are no unnecessary rebuilds of documentation anymore.

The python 3 test-dev failed but that's an unrelated issue: #28507.


---

Comment by saraedum created at 2019-09-16 12:32:00

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2019-10-05 16:06:12

Now that the dependency is in, this needs review :)

And with this we should finally get working docker images automatically again.

Note that I added the `!!!` because something like that used to be there but was dropped during a Sphinx upgrade.


---

Comment by jhpalmieri created at 2019-10-29 18:17:01

This seems okay to me. It leads to some speed-up (60 seconds without this, 45 seconds with). You could achieve even more if you could convince Sage/Sphinx to not remerge the environment/index files if nothing has changed. On my machine, that might account for about 15 seconds (out of the 45 seconds total).


---

Comment by jhpalmieri created at 2019-11-04 21:15:37

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-11-06 12:44:58

I haven't had much time on Sage lately so I didn't see this until now.  This is great; thank you for debugging this.


---

Comment by vbraun created at 2019-11-07 23:30:12

Resolution: fixed
