# Issue 28265: MR36: Use Sphinx hash function

archive/issues_028265.json:
```json
{
    "body": "CC:  @slel @nthiery @embray @roed314 @videlec\n\nJulian R\u00fcth ([`@`saraedum](https://gitlab.com/saraedum)) opened a merge request at https://gitlab.com/sagemath/sage/merge_requests/36:\n----\n\n```markdown\notherwise lots of doc rebuilds (this is a huge problem with building\ndocker images.)\n```\n\n\n\n\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28502\n\n",
    "created_at": "2019-09-15T16:16:35Z",
    "labels": [
        "PLEASE CHANGE",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "MR36: Use Sphinx hash function",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28265",
    "user": "galois"
}
```
CC:  @slel @nthiery @embray @roed314 @videlec

Julian RÃ¼th ([`@`saraedum](https://gitlab.com/saraedum)) opened a merge request at https://gitlab.com/sagemath/sage/merge_requests/36:
----

```markdown
otherwise lots of doc rebuilds (this is a huge problem with building
docker images.)
```







Issue created by migration from https://trac.sagemath.org/ticket/28502





---

archive/issue_comments_399212.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to documentation.",
    "created_at": "2019-09-15T16:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399212",
    "user": "@saraedum"
}
```

Changing component from PLEASE CHANGE to documentation.



---

archive/issue_comments_399213.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2019-09-15T16:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399213",
    "user": "@saraedum"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_399214.json:
```json
{
    "body": "CCing some people who care about docker images. This is responsible for a fraction of our automated docker builds failing. They fail the `test-dev` stage which checks that `make doc` does not take too long. Sometimes it just finshes in time, sometimes it takes too long.",
    "created_at": "2019-09-15T16:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399214",
    "user": "@saraedum"
}
```

CCing some people who care about docker images. This is responsible for a fraction of our automated docker builds failing. They fail the `test-dev` stage which checks that `make doc` does not take too long. Sometimes it just finshes in time, sometimes it takes too long.



---

archive/issue_comments_399215.json:
```json
{
    "body": "Note that Sphinx's current hash function is\n\n```\ndef get_stable_hash(obj):\n    # type: (Any) -> unicode\n    \"\"\"\n    Return a stable hash for a Python data structure.  We can't just use\n    the md5 of str(obj) since for example dictionary items are enumerated\n    in unpredictable order due to hash randomization in newer Pythons.\n    \"\"\"\n    if isinstance(obj, dict):\n        return get_stable_hash(list(obj.items()))\n    elif isinstance(obj, (list, tuple)):\n        obj = sorted(get_stable_hash(o) for o in obj)\n    return md5(text_type(obj).encode('utf8')).hexdigest()\n```\n\n\nI assume it used to be just the last line at some point.",
    "created_at": "2019-09-15T16:20:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399215",
    "user": "@saraedum"
}
```

Note that Sphinx's current hash function is

```
def get_stable_hash(obj):
    # type: (Any) -> unicode
    """
    Return a stable hash for a Python data structure.  We can't just use
    the md5 of str(obj) since for example dictionary items are enumerated
    in unpredictable order due to hash randomization in newer Pythons.
    """
    if isinstance(obj, dict):
        return get_stable_hash(list(obj.items()))
    elif isinstance(obj, (list, tuple)):
        obj = sorted(get_stable_hash(o) for o in obj)
    return md5(text_type(obj).encode('utf8')).hexdigest()
```


I assume it used to be just the last line at some point.



---

archive/issue_comments_399216.json:
```json
{
    "body": "New commits added to merge request.  I updated the commit SHA-1.  New commits:",
    "created_at": "2019-09-15T16:22:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399216",
    "user": "galois"
}
```

New commits added to merge request.  I updated the commit SHA-1.  New commits:



---

archive/issue_comments_399217.json:
```json
{
    "body": "Unfortunately, this is not the only problem. Docs are still rebuilding during docker builds.",
    "created_at": "2019-09-15T17:11:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399217",
    "user": "@saraedum"
}
```

Unfortunately, this is not the only problem. Docs are still rebuilding during docker builds.



---

archive/issue_comments_399218.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-09-15T17:11:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399218",
    "user": "@saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_399219.json:
```json
{
    "body": "New commits added to merge request.  I updated the commit SHA-1.  New commits:",
    "created_at": "2019-09-15T17:20:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399219",
    "user": "galois"
}
```

New commits added to merge request.  I updated the commit SHA-1.  New commits:



---

archive/issue_comments_399220.json:
```json
{
    "body": "New commits added to merge request.  I updated the commit SHA-1.  This was a forced push.  New commits:",
    "created_at": "2019-09-15T18:58:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399220",
    "user": "galois"
}
```

New commits added to merge request.  I updated the commit SHA-1.  This was a forced push.  New commits:



---

archive/issue_comments_399221.json:
```json
{
    "body": "Changing keywords from \"\" to \"docker, ci\".",
    "created_at": "2019-09-15T19:40:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399221",
    "user": "@saraedum"
}
```

Changing keywords from "" to "docker, ci".



---

archive/issue_comments_399222.json:
```json
{
    "body": "New commits added to merge request.  I updated the commit SHA-1.  New commits:",
    "created_at": "2019-09-16T00:49:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399222",
    "user": "galois"
}
```

New commits added to merge request.  I updated the commit SHA-1.  New commits:



---

archive/issue_comments_399223.json:
```json
{
    "body": "New commits added to merge request.  I updated the commit SHA-1.  Last 10 new commits:",
    "created_at": "2019-09-16T06:19:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399223",
    "user": "galois"
}
```

New commits added to merge request.  I updated the commit SHA-1.  Last 10 new commits:



---

archive/issue_comments_399224.json:
```json
{
    "body": "The changes seem to do the trick now as long as the same architecture runs `build-from-latest` and `test-dev`. The third bullet point from the summary should probably go into a followup ticket then. It's not as urgent and seems to be an upstream issue.",
    "created_at": "2019-09-16T06:23:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399224",
    "user": "@saraedum"
}
```

The changes seem to do the trick now as long as the same architecture runs `build-from-latest` and `test-dev`. The third bullet point from the summary should probably go into a followup ticket then. It's not as urgent and seems to be an upstream issue.



---

archive/issue_comments_399225.json:
```json
{
    "body": "New commits added to merge request.  I updated the commit SHA-1.  New commits:",
    "created_at": "2019-09-16T09:15:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399225",
    "user": "galois"
}
```

New commits added to merge request.  I updated the commit SHA-1.  New commits:



---

archive/issue_comments_399226.json:
```json
{
    "body": "New commits added to merge request.  I updated the commit SHA-1.  New commits:",
    "created_at": "2019-09-16T10:31:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399226",
    "user": "galois"
}
```

New commits added to merge request.  I updated the commit SHA-1.  New commits:



---

archive/issue_comments_399227.json:
```json
{
    "body": "Seems to work fine. There are no unnecessary rebuilds of documentation anymore.\n\nThe python 3 test-dev failed but that's an unrelated issue: #28507.",
    "created_at": "2019-09-16T12:32:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399227",
    "user": "@saraedum"
}
```

Seems to work fine. There are no unnecessary rebuilds of documentation anymore.

The python 3 test-dev failed but that's an unrelated issue: #28507.



---

archive/issue_comments_399228.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-09-16T12:32:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399228",
    "user": "@saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_399229.json:
```json
{
    "body": "Now that the dependency is in, this needs review :)\n\nAnd with this we should finally get working docker images automatically again.\n\nNote that I added the `!!!` because something like that used to be there but was dropped during a Sphinx upgrade.",
    "created_at": "2019-10-05T16:06:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399229",
    "user": "@saraedum"
}
```

Now that the dependency is in, this needs review :)

And with this we should finally get working docker images automatically again.

Note that I added the `!!!` because something like that used to be there but was dropped during a Sphinx upgrade.



---

archive/issue_comments_399230.json:
```json
{
    "body": "This seems okay to me. It leads to some speed-up (60 seconds without this, 45 seconds with). You could achieve even more if you could convince Sage/Sphinx to not remerge the environment/index files if nothing has changed. On my machine, that might account for about 15 seconds (out of the 45 seconds total).",
    "created_at": "2019-10-29T18:17:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399230",
    "user": "@jhpalmieri"
}
```

This seems okay to me. It leads to some speed-up (60 seconds without this, 45 seconds with). You could achieve even more if you could convince Sage/Sphinx to not remerge the environment/index files if nothing has changed. On my machine, that might account for about 15 seconds (out of the 45 seconds total).



---

archive/issue_comments_399231.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-11-04T21:15:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399231",
    "user": "@jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_399232.json:
```json
{
    "body": "I haven't had much time on Sage lately so I didn't see this until now.  This is great; thank you for debugging this.",
    "created_at": "2019-11-06T12:44:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399232",
    "user": "@embray"
}
```

I haven't had much time on Sage lately so I didn't see this until now.  This is great; thank you for debugging this.



---

archive/issue_comments_399233.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-11-07T23:30:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28265",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28265#issuecomment-399233",
    "user": "@vbraun"
}
```

Resolution: fixed
