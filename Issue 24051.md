# Issue 24051: Failing tests in sage.rings.bernmm due to cysignals error on SAGE_DEBUG=yes

archive/issues_024051.json:
```json
{
    "body": "CC:  @jdemeyer\n\nWhen running these tests (and possible others; need to check) I'm getting a lot of error messages + tracebacks from Cysignals on a debug build:\n\n\n```\nsage -t src/sage/rings/bernmm.pyx\n**********************************************************************\nFile \"src/sage/rings/bernmm.pyx\", line 67, in sage.rings.bernmm.bernmm_bern_rat\nFailed example:\n    lst1 = [ bernoulli(2*k, algorithm='bernmm', num_threads=2) for k in [2932, 2957, 3443, 3962, 3973] ]\nExpected nothing\nGot:\n    <BLANKLINE>\n    *** ERROR *** sig_unblock() with sig_on_count = 1, block_sigint = 0\n    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cysignals/signals.so(+0x4eab)[0x7f48f55f7eab]\n    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/ext/memory.so(+0x24d5)[0x7f48b35f24d5]\n    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/ext/memory.so(+0x2122)[0x7f48b35f2122]\n    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/ext/memory.so(+0x247f)[0x7f48b35f247f]\n    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/ext/memory.so(+0x2320)[0x7f48b35f2320]\n    /home/embray/src/sagemath/sage/local/lib/libgmp.so.23(__gmpz_realloc+0x5a)[0x7f48f4a5fbdb]\n    /home/embray/src/sagemath/sage/local/lib/libgmp.so.23(__gmpz_mul_ui+0x94)[0x7f48f4a59bad]\n    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/bernmm.so(_ZN6bernmm6workerEPv+0x1bc)[0x7f4895cfa91a]\n    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/bernmm.so(_ZN6bernmm8bern_ratEP12__mpq_structli+0x4c6)[0x7f4895cfafbb]\n    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/bernmm.so(+0xbbdc)[0x7f4895ceebdc]\n    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/bernmm.so(+0xb96c)[0x7f4895cee96c]\n    /home/embray/src/sagemath/sage/local/lib/libpython2.7.so.1.0(PyCFunction_Call+0xbd)[0x7f48fabd911f]\n...\n```\n\n\nI trimmed the traceback after this point since it appears to just be Python's stack.\n\nIt seems to be something fishy to do with the use of `sig_realloc` inside GMP/MPIR, but I haven't investigated it too deeply beyond that.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24288\n\n",
    "created_at": "2017-11-27T17:39:53Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Failing tests in sage.rings.bernmm due to cysignals error on SAGE_DEBUG=yes",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24051",
    "user": "https://github.com/embray"
}
```
CC:  @jdemeyer

When running these tests (and possible others; need to check) I'm getting a lot of error messages + tracebacks from Cysignals on a debug build:


```
sage -t src/sage/rings/bernmm.pyx
**********************************************************************
File "src/sage/rings/bernmm.pyx", line 67, in sage.rings.bernmm.bernmm_bern_rat
Failed example:
    lst1 = [ bernoulli(2*k, algorithm='bernmm', num_threads=2) for k in [2932, 2957, 3443, 3962, 3973] ]
Expected nothing
Got:
    <BLANKLINE>
    *** ERROR *** sig_unblock() with sig_on_count = 1, block_sigint = 0
    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cysignals/signals.so(+0x4eab)[0x7f48f55f7eab]
    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/ext/memory.so(+0x24d5)[0x7f48b35f24d5]
    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/ext/memory.so(+0x2122)[0x7f48b35f2122]
    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/ext/memory.so(+0x247f)[0x7f48b35f247f]
    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/ext/memory.so(+0x2320)[0x7f48b35f2320]
    /home/embray/src/sagemath/sage/local/lib/libgmp.so.23(__gmpz_realloc+0x5a)[0x7f48f4a5fbdb]
    /home/embray/src/sagemath/sage/local/lib/libgmp.so.23(__gmpz_mul_ui+0x94)[0x7f48f4a59bad]
    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/bernmm.so(_ZN6bernmm6workerEPv+0x1bc)[0x7f4895cfa91a]
    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/bernmm.so(_ZN6bernmm8bern_ratEP12__mpq_structli+0x4c6)[0x7f4895cfafbb]
    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/bernmm.so(+0xbbdc)[0x7f4895ceebdc]
    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/bernmm.so(+0xb96c)[0x7f4895cee96c]
    /home/embray/src/sagemath/sage/local/lib/libpython2.7.so.1.0(PyCFunction_Call+0xbd)[0x7f48fabd911f]
...
```


I trimmed the traceback after this point since it appears to just be Python's stack.

It seems to be something fishy to do with the use of `sig_realloc` inside GMP/MPIR, but I haven't investigated it too deeply beyond that.

Issue created by migration from https://trac.sagemath.org/ticket/24288





---

archive/issue_comments_336779.json:
```json
{
    "body": "This is still a problem I'm seeing.  It goes away when building cysignals without debug, but that's just because the messages aren't being displayed.  The underlying problem is probably still there.",
    "created_at": "2018-04-12T08:53:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24051#issuecomment-336779",
    "user": "https://github.com/embray"
}
```

This is still a problem I'm seeing.  It goes away when building cysignals without debug, but that's just because the messages aren't being displayed.  The underlying problem is probably still there.



---

archive/issue_comments_336780.json:
```json
{
    "body": "C11 atomic operations might help with this.",
    "created_at": "2019-03-06T13:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24051#issuecomment-336780",
    "user": "https://github.com/jdemeyer"
}
```

C11 atomic operations might help with this.



---

archive/issue_events_022493.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2019-03-06T15:45:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24051",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24051#event-22493"
}
```



---

archive/issue_comments_336781.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2019-03-06T15:45:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24051#issuecomment-336781",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: duplicate



---

archive/issue_comments_336782.json:
```json
{
    "body": "This is fixed in the experimental branch https://github.com/sagemath/cysignals/pull/109",
    "created_at": "2019-03-06T15:45:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24051#issuecomment-336782",
    "user": "https://github.com/jdemeyer"
}
```

This is fixed in the experimental branch https://github.com/sagemath/cysignals/pull/109



---

archive/issue_comments_336783.json:
```json
{
    "body": "Interesting.  Is there a separate ticket in Sage for this?  Even though the issue is for cysignals to fix, it's still an issue in Sage as well until/unless Sage depends on a cysignals that has the fix.",
    "created_at": "2019-03-06T15:47:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24051#issuecomment-336783",
    "user": "https://github.com/embray"
}
```

Interesting.  Is there a separate ticket in Sage for this?  Even though the issue is for cysignals to fix, it's still an issue in Sage as well until/unless Sage depends on a cysignals that has the fix.



---

archive/issue_comments_336784.json:
```json
{
    "body": "Resolution changed from duplicate to ",
    "created_at": "2019-03-06T15:47:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24051#issuecomment-336784",
    "user": "https://github.com/embray"
}
```

Resolution changed from duplicate to 



---

archive/issue_comments_336785.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2019-03-06T15:47:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24051#issuecomment-336785",
    "user": "https://github.com/embray"
}
```

Changing status from closed to new.



---

archive/issue_events_022494.json:
```json
{
    "actor": "@embray",
    "created_at": "2019-03-06T15:47:08Z",
    "event": "reopened",
    "issue": "https://github.com/sagemath/sagetest/issues/24051",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24051#event-22494"
}
```



---

archive/issue_comments_336786.json:
```json
{
    "body": "Now fixed in cysignals master.",
    "created_at": "2019-03-07T22:15:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24051#issuecomment-336786",
    "user": "https://github.com/jdemeyer"
}
```

Now fixed in cysignals master.



---

archive/issue_comments_336787.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2019-03-10T21:36:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24051#issuecomment-336787",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: duplicate



---

archive/issue_events_022495.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2019-03-10T21:36:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/24051",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/24051#event-22495"
}
```



---

archive/issue_comments_336788.json:
```json
{
    "body": "Fixed by #27070",
    "created_at": "2019-03-10T21:36:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24051",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24051#issuecomment-336788",
    "user": "https://github.com/jdemeyer"
}
```

Fixed by #27070
