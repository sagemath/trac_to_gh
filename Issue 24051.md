# Issue 24051: Failing tests in sage.rings.bernmm due to cysignals error on SAGE_DEBUG=yes

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2017-11-27 17:39:53

CC:  jdemeyer

When running these tests (and possible others; need to check) I'm getting a lot of error messages + tracebacks from Cysignals on a debug build:


```
sage -t src/sage/rings/bernmm.pyx
**********************************************************************
File "src/sage/rings/bernmm.pyx", line 67, in sage.rings.bernmm.bernmm_bern_rat
Failed example:
    lst1 = [ bernoulli(2*k, algorithm='bernmm', num_threads=2) for k in [2932, 2957, 3443, 3962, 3973] ]
Expected nothing
Got:
    <BLANKLINE>
    *** ERROR *** sig_unblock() with sig_on_count = 1, block_sigint = 0
    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/cysignals/signals.so(+0x4eab)[0x7f48f55f7eab]
    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/ext/memory.so(+0x24d5)[0x7f48b35f24d5]
    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/ext/memory.so(+0x2122)[0x7f48b35f2122]
    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/ext/memory.so(+0x247f)[0x7f48b35f247f]
    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/ext/memory.so(+0x2320)[0x7f48b35f2320]
    /home/embray/src/sagemath/sage/local/lib/libgmp.so.23(__gmpz_realloc+0x5a)[0x7f48f4a5fbdb]
    /home/embray/src/sagemath/sage/local/lib/libgmp.so.23(__gmpz_mul_ui+0x94)[0x7f48f4a59bad]
    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/bernmm.so(_ZN6bernmm6workerEPv+0x1bc)[0x7f4895cfa91a]
    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/bernmm.so(_ZN6bernmm8bern_ratEP12__mpq_structli+0x4c6)[0x7f4895cfafbb]
    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/bernmm.so(+0xbbdc)[0x7f4895ceebdc]
    /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/rings/bernmm.so(+0xb96c)[0x7f4895cee96c]
    /home/embray/src/sagemath/sage/local/lib/libpython2.7.so.1.0(PyCFunction_Call+0xbd)[0x7f48fabd911f]
...
```


I trimmed the traceback after this point since it appears to just be Python's stack.

It seems to be something fishy to do with the use of `sig_realloc` inside GMP/MPIR, but I haven't investigated it too deeply beyond that.


---

Comment by embray created at 2018-04-12 08:53:01

This is still a problem I'm seeing.  It goes away when building cysignals without debug, but that's just because the messages aren't being displayed.  The underlying problem is probably still there.


---

Comment by jdemeyer created at 2019-03-06 13:53:36

C11 atomic operations might help with this.


---

Comment by jdemeyer created at 2019-03-06 15:45:30

Resolution: duplicate


---

Comment by jdemeyer created at 2019-03-06 15:45:30

This is fixed in the experimental branch https://github.com/sagemath/cysignals/pull/109


---

Comment by embray created at 2019-03-06 15:47:08

Interesting.  Is there a separate ticket in Sage for this?  Even though the issue is for cysignals to fix, it's still an issue in Sage as well until/unless Sage depends on a cysignals that has the fix.


---

Comment by embray created at 2019-03-06 15:47:08

Resolution changed from duplicate to 


---

Comment by embray created at 2019-03-06 15:47:08

Changing status from closed to new.


---

Comment by jdemeyer created at 2019-03-07 22:15:52

Now fixed in cysignals master.


---

Comment by jdemeyer created at 2019-03-10 21:36:27

Resolution: duplicate


---

Comment by jdemeyer created at 2019-03-10 21:36:27

Fixed by #27070
