# Issue 15249: Lazy Evaluation for Modular Forms

Issue created by migration from https://trac.sagemath.org/ticket/15486

Original creator: elarson3

Original creation time: 2013-12-05 07:23:48

The runtime of the Newforms function is unacceptable for large conductors.

This is because in the _ _init_ _ method of the ModularFormsAmbient_R class (in modular/modform/ambient_R.py), the object attribute _ _R_character is precomputed. However, this precomputation can be very expensive, and is unnecessary when calling many functions (e.g. Newforms). Thus, it should be done with lazy evaluation.

For a benchmark --- This reduces the runtime of Newforms(719, names='a') to 3--4 sec... from its previous value of over a day (interrupted before completion)!


---

Attachment


---

Comment by elarson3 created at 2013-12-05 07:28:07

Changing status from new to needs_review.


---

Comment by chapoton created at 2014-03-05 09:51:06

Here is a git branch
----
New commits:


---

Comment by pbruin created at 2014-04-07 01:12:41

Changing status from needs_review to positive_review.


---

Comment by pbruin created at 2014-04-07 01:12:41

I remember running into this slowness issue as well; most of the time was spent in PARI on something like a class group and unit group computation for the coefficient fields.  It's nice that this computation does not always have to be done.


---

Comment by vbraun created at 2014-04-07 18:06:46

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2014-04-07 18:06:46


```
sage -t --long src/sage/modular/modform/ambient_eps.py
**********************************************************************
File "src/sage/modular/modform/ambient_eps.py", line 187, in sage.modular.modform.ambient_eps.ModularFormsAmbient_eps.change_ring
Failed example:
    m.change_ring(QQ)
Expected:
    Traceback (most recent call last):
    ...
    ValueError: cannot coerce element of order 6 into self
Got:
    Modular Forms space of dimension 3, character [zeta6] and weight 2 over Rational Field
```



---

Comment by pbruin created at 2014-04-07 20:51:08

Hmm, I did create a local branch to doctest this ticket, but it seems I was so convinced that this couldn't break anything that I didn't even check the branch out from Trac.  The failing doctest shows that the current patch removes the check for whether there are enough roots of unity.

My comment above was not completely accurate; it was actually PARI's `nfinit()` that was taking forever.  This is called when constructing the Dirichlet group modulo _N_ with values in the group of roots of unity of a number field _K_.  It turns out that by being a bit more careful about which roots of unity one asks for, one can avoid `nfinit()` and just look for roots of cyclotomic polynomials of degree dividing the degree of _K_.

I made a new patch for this approach, which is now doctesting.  If successful, we can see if it would be a suitable alternative fix.


---

Comment by pbruin created at 2014-04-07 21:40:25

The new branch makes both the `DirichletGroup` constructor and the `zeta(n)` method of number fields more intelligent by avoiding the computation of the group of all roots of unity or its order.  Would this be a suitable alternative solution?  It is unfortunately completely disjoint from Eric's original solution, but I do not see how that approach can easily detect invalid base rings as in the above doctest failure.


---

Comment by pbruin created at 2014-04-21 09:22:28

Changing keywords from "" to "roots of unity dirichlet group".


---

Comment by pbruin created at 2014-04-21 09:22:28

Changing status from needs_work to needs_review.


---

Comment by pbruin created at 2014-05-09 11:12:29

The patchbot found one doctest failure, which is however completely unrelated to this ticket and is caused by the fact that the patchbot tests this ticket in a temporary directory.


---

Comment by git created at 2014-08-26 00:49:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-12-04 22:40:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-05-01 14:48:14

As far as I can tell, this looks good. Disclaimer: I am not a number theorist.
All tests pass, the patchbot is happy, the NewForms test takes 3s.
I was worrying about some eventual regressions in timings.
But I have not been able to find any.
Let me put this in positive review.


---

Comment by chapoton created at 2015-05-01 14:48:14

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-05-02 14:22:35

Resolution: fixed
