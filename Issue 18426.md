# Issue 18426: Speed up computation of twists of newforms

archive/issues_018426.json:
```json
{
    "body": "The current code for computing twists of newforms by Dirichlet characters is unnecessarily slow, because it computes a full decomposition of the target space into simple Hecke modules, and then throws all but one of the factors away. It is quicker just to directly pull out the appropriate factor using kernels of Hecke matrices. \n\nIssue created by migration from https://trac.sagemath.org/ticket/18663\n\n",
    "created_at": "2015-06-10T14:45:05Z",
    "labels": [
        "modular forms",
        "major",
        "enhancement"
    ],
    "title": "Speed up computation of twists of newforms",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18426",
    "user": "davidloeffler"
}
```
The current code for computing twists of newforms by Dirichlet characters is unnecessarily slow, because it computes a full decomposition of the target space into simple Hecke modules, and then throws all but one of the factors away. It is quicker just to directly pull out the appropriate factor using kernels of Hecke matrices. 

Issue created by migration from https://trac.sagemath.org/ticket/18663





---

archive/issue_comments_250298.json:
```json
{
    "body": "Here's a patch. I tested it doing\n` sage: Newforms(11)[0].twist(DirichletGroup(5).0) `\nand it went down from about 30 sec to about 3 sec on my machine. The doctest requires #18478 to pass. \n----\nNew commits:",
    "created_at": "2015-06-10T15:06:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18426#issuecomment-250298",
    "user": "davidloeffler"
}
```

Here's a patch. I tested it doing
` sage: Newforms(11)[0].twist(DirichletGroup(5).0) `
and it went down from about 30 sec to about 3 sec on my machine. The doctest requires #18478 to pass. 
----
New commits:



---

archive/issue_comments_250299.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-06-10T15:06:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18426#issuecomment-250299",
    "user": "davidloeffler"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_250300.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-06-10T18:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18426#issuecomment-250300",
    "user": "pbruin"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_250301.json:
```json
{
    "body": "I haven't looked at this in detail, but with both this ticket and #6018 applied, the example from comment:15:ticket:18086 only takes about a second.  However, some long doctests fail even with #18478 merged:\n\n```\nsage -t --long --warn-long 49.1 src/sage/modular/modform/element.py\n**********************************************************************\nFile \"src/sage/modular/modform/element.py\", line 1188, in sage.modular.modform.element.Newform.twist\nFailed example:\n    Delta.twist(chi, level=3)  # long time\nExpected:\n    Traceback (most recent call last):\n    ...\n    RuntimeError: twist of q - 24*q^2 + 252*q^3 - 1472*q^4 + 4830*q^5 + O(q^6) by Dirichlet character modulo 1 of conductor 1 is not a newform in Cuspidal subspace of dimension 3 of Modular Forms space of dimension 5 for Congruence Subgroup Gamma0(3) of weight 12 over Cyclotomic Field of order 1 and degree 1\nGot:\n    ...\n         raise RuntimeError('twist of %s by %s is not a newform in %s' % (self, chi, S))\n    UnboundLocalError: local variable 'S' referenced before assignment\n**********************************************************************\nFile \"src/sage/modular/modform/element.py\", line 1192, in sage.modular.modform.element.Newform.twist\nFailed example:\n    Delta.twist(chi, level=3, check=False)  # long time\nException raised:\n    ...\n         raise RuntimeError('twist of %s by %s is not a newform in %s' % (self, chi, S))\n    UnboundLocalError: local variable 'S' referenced before assignment\n**********************************************************************\n1 item had failures:\n   2 of  17 in sage.modular.modform.element.Newform.twist\n    [305 tests, 2 failures, 45.85 s]\n----------------------------------------------------------------------\nsage -t --long --warn-long 49.1 src/sage/modular/modform/element.py  # 2 doctests failed\n----------------------------------------------------------------------\n```\n",
    "created_at": "2015-06-10T18:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18426#issuecomment-250301",
    "user": "pbruin"
}
```

I haven't looked at this in detail, but with both this ticket and #6018 applied, the example from comment:15:ticket:18086 only takes about a second.  However, some long doctests fail even with #18478 merged:

```
sage -t --long --warn-long 49.1 src/sage/modular/modform/element.py
**********************************************************************
File "src/sage/modular/modform/element.py", line 1188, in sage.modular.modform.element.Newform.twist
Failed example:
    Delta.twist(chi, level=3)  # long time
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: twist of q - 24*q^2 + 252*q^3 - 1472*q^4 + 4830*q^5 + O(q^6) by Dirichlet character modulo 1 of conductor 1 is not a newform in Cuspidal subspace of dimension 3 of Modular Forms space of dimension 5 for Congruence Subgroup Gamma0(3) of weight 12 over Cyclotomic Field of order 1 and degree 1
Got:
    ...
         raise RuntimeError('twist of %s by %s is not a newform in %s' % (self, chi, S))
    UnboundLocalError: local variable 'S' referenced before assignment
**********************************************************************
File "src/sage/modular/modform/element.py", line 1192, in sage.modular.modform.element.Newform.twist
Failed example:
    Delta.twist(chi, level=3, check=False)  # long time
Exception raised:
    ...
         raise RuntimeError('twist of %s by %s is not a newform in %s' % (self, chi, S))
    UnboundLocalError: local variable 'S' referenced before assignment
**********************************************************************
1 item had failures:
   2 of  17 in sage.modular.modform.element.Newform.twist
    [305 tests, 2 failures, 45.85 s]
----------------------------------------------------------------------
sage -t --long --warn-long 49.1 src/sage/modular/modform/element.py  # 2 doctests failed
----------------------------------------------------------------------
```




---

archive/issue_comments_250302.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-06-11T07:54:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18426#issuecomment-250302",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_250303.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-06-11T07:55:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18426#issuecomment-250303",
    "user": "davidloeffler"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_250304.json:
```json
{
    "body": "Sorry, that was sloppy of me! Here's a fix.",
    "created_at": "2015-06-11T07:55:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18426#issuecomment-250304",
    "user": "davidloeffler"
}
```

Sorry, that was sloppy of me! Here's a fix.



---

archive/issue_comments_250305.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-06-18T14:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18426#issuecomment-250305",
    "user": "pbruin"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_250306.json:
```json
{
    "body": "One of the doctests still fails, this time because the effect of setting `check=False` is changed:\n\n```\nFile \"src/sage/modular/modform/element.py\", line 1192, in sage.modular.modform.element.Newform.twist\nFailed example:\n    Delta.twist(chi, level=3, check=False)  # long time\nException raised:\n    ...\n    RuntimeError: twist of q - 24*q^2 + 252*q^3 - 1472*q^4 + 4830*q^5 + O(q^6) by Dirichlet character modulo 1 of conductor 1 is not a newform in Cuspidal subspace of dimension 3 of Modular Forms space of dimension 5 for Congruence Subgroup Gamma0(3) of weight 12 over Cyclotomic Field of order 1 and degree 1\n```\n\nWe should either just remove this doctest, or find a new example to document that `check=False` can lead to wrong results.",
    "created_at": "2015-06-18T14:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18426#issuecomment-250306",
    "user": "pbruin"
}
```

One of the doctests still fails, this time because the effect of setting `check=False` is changed:

```
File "src/sage/modular/modform/element.py", line 1192, in sage.modular.modform.element.Newform.twist
Failed example:
    Delta.twist(chi, level=3, check=False)  # long time
Exception raised:
    ...
    RuntimeError: twist of q - 24*q^2 + 252*q^3 - 1472*q^4 + 4830*q^5 + O(q^6) by Dirichlet character modulo 1 of conductor 1 is not a newform in Cuspidal subspace of dimension 3 of Modular Forms space of dimension 5 for Congruence Subgroup Gamma0(3) of weight 12 over Cyclotomic Field of order 1 and degree 1
```

We should either just remove this doctest, or find a new example to document that `check=False` can lead to wrong results.



---

archive/issue_comments_250307.json:
```json
{
    "body": "Here's a new version. I've made a subtle change which ensures that the code cannot return bogus results (even if `check=False`); it now either returns a correct answer, or fails with a `ValueError` if the form is not new at the specified level. The change is that the code starts by taking the new subspace of the modular symbols (which is pretty cheap to compute) and only then starts filtering down to kernels of Hecke operators.\n\nI've also changed the error messages a bit so it returns a different error if the computed mod sym space is 0 than if it's too large (the latter could, theoretically, happen in valid examples if the level was gigantic, whereas the former can only occur if the input is bogus so it makes sense to return `ValueError`).\n----\nNew commits:",
    "created_at": "2015-06-19T10:41:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18426#issuecomment-250307",
    "user": "davidloeffler"
}
```

Here's a new version. I've made a subtle change which ensures that the code cannot return bogus results (even if `check=False`); it now either returns a correct answer, or fails with a `ValueError` if the form is not new at the specified level. The change is that the code starts by taking the new subspace of the modular symbols (which is pretty cheap to compute) and only then starts filtering down to kernels of Hecke operators.

I've also changed the error messages a bit so it returns a different error if the computed mod sym space is 0 than if it's too large (the latter could, theoretically, happen in valid examples if the level was gigantic, whereas the former can only occur if the input is bogus so it makes sense to return `ValueError`).
----
New commits:



---

archive/issue_comments_250308.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-06-19T10:41:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18426#issuecomment-250308",
    "user": "davidloeffler"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_250309.json:
```json
{
    "body": "This looks good to me now.",
    "created_at": "2015-06-19T20:59:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18426#issuecomment-250309",
    "user": "pbruin"
}
```

This looks good to me now.



---

archive/issue_comments_250310.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-06-19T20:59:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18426#issuecomment-250310",
    "user": "pbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_250311.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-06-20T18:23:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18426",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18426#issuecomment-250311",
    "user": "vbraun"
}
```

Resolution: fixed
