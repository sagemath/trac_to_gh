# Issue 25239: MeatAxe-related bug introduced in 8.3.beta

archive/issues_025239.json:
```json
{
    "body": "CC:  @videlec @tscrim\n\nKeywords: meataxe rescale_row\n\nVincent reports this for SageMath 8.3.beta3 with MeatAxe installed:\n\n```\nFile \"src/sage/coding/linear_code.py\", line 2039, in\nsage.coding.linear_code.AbstractLinearCode.__getitem__\nFailed example:\n     C = random_matrix(GF(25,'a'), 2, 7).row_space()\nException raised:\n     Traceback (most recent call last):\n       File\n\"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\",\nline 572, in _run\n         self.compile_and_execute(example, compiler, test.globs)\n       File\n\"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py\",\nline 982, in compile_and_execute\n         exec(compiled, globs)\n       File \"<doctest\nsage.coding.linear_code.AbstractLinearCode.__getitem__[4]>\", line 1, in\n<module>\n         C = random_matrix(GF(Integer(25),'a'), Integer(2),\nInteger(7)).row_space()\n       File \"sage/matrix/matrix2.pyx\", line 4592, in\nsage.matrix.matrix2.Matrix.row_space\n(build/cythonized/sage/matrix/matrix2.c:34495)\n         return self.row_module(base_ring=base_ring)\n       File \"sage/matrix/matrix2.pyx\", line 4565, in\nsage.matrix.matrix2.Matrix.row_module\n(build/cythonized/sage/matrix/matrix2.c:34373)\n         return M.span(self.rows(), already_echelonized=False)\n       File\n\"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/modules/free_module.py\",\nline 3850, in span\n         self.ambient_module(), gens=gens, check=check,\nalready_echelonized=already_echelonized)\n       File\n\"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/modules/free_module.py\",\nline 6961, in __init__\n         echelonize=not already_echelonized,\nalready_echelonized=already_echelonized)\n       File\n\"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/modules/free_module.py\",\nline 6763, in __init__\n         echelonized_basis=echelonized_basis,\nalready_echelonized=already_echelonized)\n       File\n\"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/modules/free_module.py\",\nline 5691, in __init__\n         basis = self._echelonized_basis(ambient, basis)\n       File\n\"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/modules/free_module.py\",\nline 6894, in _echelonized_basis\n         E = A.echelon_form()\n       File \"sage/matrix/matrix2.pyx\", line 6819, in\nsage.matrix.matrix2.Matrix.echelon_form\n(build/cythonized/sage/matrix/matrix2.c:53810)\n         v = E.echelonize(cutoff=cutoff, **kwds)\n       File \"sage/matrix/matrix2.pyx\", line 6719, in\nsage.matrix.matrix2.Matrix.echelonize\n(build/cythonized/sage/matrix/matrix2.c:53210)\n         self._echelon_in_place(algorithm)\n       File \"sage/matrix/matrix2.pyx\", line 6984, in\nsage.matrix.matrix2.Matrix._echelon_in_place\n(build/cythonized/sage/matrix/matrix2.c:54847)\n         A.rescale_row(r, a_inverse, c)\n       File \"sage/matrix/matrix0.pyx\", line 3005, in\nsage.matrix.matrix0.Matrix.rescale_row\n(build/cythonized/sage/matrix/matrix0.c:21880)\n         self.rescale_row_c(i, s, start_col)\n       File \"sage/matrix/matrix_gfpn_dense.pyx\", line 944, in\nsage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.rescale_row_c\n(build/cythonized/sage/matrix/matrix_gfpn_dense.c:9339)\n         raise ValueError(\"We can only rescale a full row of a non-empty\nmatrix\")\n     ValueError: We can only rescale a full row of a non-empty matrix\n**********************************************************************\n```\n\n\nThe above error does not occur in 8.2.rc4. Let's try to prevent it from being published in 8.3!\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/25476\n\n",
    "created_at": "2018-05-30T23:02:21Z",
    "labels": [
        "packages: optional",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "MeatAxe-related bug introduced in 8.3.beta",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25239",
    "user": "@simon-king-jena"
}
```
CC:  @videlec @tscrim

Keywords: meataxe rescale_row

Vincent reports this for SageMath 8.3.beta3 with MeatAxe installed:

```
File "src/sage/coding/linear_code.py", line 2039, in
sage.coding.linear_code.AbstractLinearCode.__getitem__
Failed example:
     C = random_matrix(GF(25,'a'), 2, 7).row_space()
Exception raised:
     Traceback (most recent call last):
       File
"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py",
line 572, in _run
         self.compile_and_execute(example, compiler, test.globs)
       File
"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py",
line 982, in compile_and_execute
         exec(compiled, globs)
       File "<doctest
sage.coding.linear_code.AbstractLinearCode.__getitem__[4]>", line 1, in
<module>
         C = random_matrix(GF(Integer(25),'a'), Integer(2),
Integer(7)).row_space()
       File "sage/matrix/matrix2.pyx", line 4592, in
sage.matrix.matrix2.Matrix.row_space
(build/cythonized/sage/matrix/matrix2.c:34495)
         return self.row_module(base_ring=base_ring)
       File "sage/matrix/matrix2.pyx", line 4565, in
sage.matrix.matrix2.Matrix.row_module
(build/cythonized/sage/matrix/matrix2.c:34373)
         return M.span(self.rows(), already_echelonized=False)
       File
"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/modules/free_module.py",
line 3850, in span
         self.ambient_module(), gens=gens, check=check,
already_echelonized=already_echelonized)
       File
"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/modules/free_module.py",
line 6961, in __init__
         echelonize=not already_echelonized,
already_echelonized=already_echelonized)
       File
"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/modules/free_module.py",
line 6763, in __init__
         echelonized_basis=echelonized_basis,
already_echelonized=already_echelonized)
       File
"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/modules/free_module.py",
line 5691, in __init__
         basis = self._echelonized_basis(ambient, basis)
       File
"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/modules/free_module.py",
line 6894, in _echelonized_basis
         E = A.echelon_form()
       File "sage/matrix/matrix2.pyx", line 6819, in
sage.matrix.matrix2.Matrix.echelon_form
(build/cythonized/sage/matrix/matrix2.c:53810)
         v = E.echelonize(cutoff=cutoff, **kwds)
       File "sage/matrix/matrix2.pyx", line 6719, in
sage.matrix.matrix2.Matrix.echelonize
(build/cythonized/sage/matrix/matrix2.c:53210)
         self._echelon_in_place(algorithm)
       File "sage/matrix/matrix2.pyx", line 6984, in
sage.matrix.matrix2.Matrix._echelon_in_place
(build/cythonized/sage/matrix/matrix2.c:54847)
         A.rescale_row(r, a_inverse, c)
       File "sage/matrix/matrix0.pyx", line 3005, in
sage.matrix.matrix0.Matrix.rescale_row
(build/cythonized/sage/matrix/matrix0.c:21880)
         self.rescale_row_c(i, s, start_col)
       File "sage/matrix/matrix_gfpn_dense.pyx", line 944, in
sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.rescale_row_c
(build/cythonized/sage/matrix/matrix_gfpn_dense.c:9339)
         raise ValueError("We can only rescale a full row of a non-empty
matrix")
     ValueError: We can only rescale a full row of a non-empty matrix
**********************************************************************
```


The above error does not occur in 8.2.rc4. Let's try to prevent it from being published in 8.3!


Issue created by migration from https://trac.sagemath.org/ticket/25476





---

archive/issue_comments_355522.json:
```json
{
    "body": "Practical problem: I can currently not build and test 8.3.beta3, since I won't interrupt a computation that I am currently running (it is running since three weeks and might disprove a conjecture on the structure of cohomology rings).",
    "created_at": "2018-05-30T23:03:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355522",
    "user": "@simon-king-jena"
}
```

Practical problem: I can currently not build and test 8.3.beta3, since I won't interrupt a computation that I am currently running (it is running since three weeks and might disprove a conjecture on the structure of cohomology rings).



---

archive/issue_comments_355523.json:
```json
{
    "body": "This also occurs in testing `matrix/matrix2.pyx`.",
    "created_at": "2018-05-31T04:58:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355523",
    "user": "@tscrim"
}
```

This also occurs in testing `matrix/matrix2.pyx`.



---

archive/issue_comments_355524.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2018-05-31T05:47:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355524",
    "user": "@tscrim"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_355525.json:
```json
{
    "body": "So this seems to be caused by #17272, but I do not understand why. It is the exact same code for the classical echelon algorithm. The only other difference is that has become a `cpdef` method instead of a `def` method, but changing that didn't seem to fix the problem. At least, where the error is happening, it means we would have just inverted a 0 if the row is all 0. So perhaps this is a bug in Cython?\n\nAlso, failing tests with optional packages is a blocker.",
    "created_at": "2018-05-31T05:47:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355525",
    "user": "@tscrim"
}
```

So this seems to be caused by #17272, but I do not understand why. It is the exact same code for the classical echelon algorithm. The only other difference is that has become a `cpdef` method instead of a `def` method, but changing that didn't seem to fix the problem. At least, where the error is happening, it means we would have just inverted a 0 if the row is all 0. So perhaps this is a bug in Cython?

Also, failing tests with optional packages is a blocker.



---

archive/issue_comments_355526.json:
```json
{
    "body": "PS - I think the machine I tested #17272 on did not have `meataxe` installed (unlike my usual devbox), but I thought it did...(cannot check it for the next ~2 months).",
    "created_at": "2018-05-31T05:49:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355526",
    "user": "@tscrim"
}
```

PS - I think the machine I tested #17272 on did not have `meataxe` installed (unlike my usual devbox), but I thought it did...(cannot check it for the next ~2 months).



---

archive/issue_comments_355527.json:
```json
{
    "body": "I really have no idea what is going on. It does work before #17272, but fails after. Changing both the `cpdef` -> `def` doesn't fix it. The algorithm is exactly the same and even reverting that part of the code does not fix it.",
    "created_at": "2018-05-31T06:01:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355527",
    "user": "@tscrim"
}
```

I really have no idea what is going on. It does work before #17272, but fails after. Changing both the `cpdef` -> `def` doesn't fix it. The algorithm is exactly the same and even reverting that part of the code does not fix it.



---

archive/issue_comments_355528.json:
```json
{
    "body": "While trying to build the latest beta, cddlib fails. Very bad. So, I still cannot test stuff.",
    "created_at": "2018-05-31T07:08:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355528",
    "user": "@simon-king-jena"
}
```

While trying to build the latest beta, cddlib fails. Very bad. So, I still cannot test stuff.



---

archive/issue_comments_355529.json:
```json
{
    "body": "Fortunately retrying `make cddlib` worked.",
    "created_at": "2018-05-31T07:09:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355529",
    "user": "@simon-king-jena"
}
```

Fortunately retrying `make cddlib` worked.



---

archive/issue_comments_355530.json:
```json
{
    "body": "Now I completed building the latest beta and can confirm the bug.",
    "created_at": "2018-05-31T09:32:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355530",
    "user": "@simon-king-jena"
}
```

Now I completed building the latest beta and can confirm the bug.



---

archive/issue_comments_355531.json:
```json
{
    "body": "PS: It is not the creation of the matrix but calling `.row_space()`.",
    "created_at": "2018-05-31T09:33:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355531",
    "user": "@simon-king-jena"
}
```

PS: It is not the creation of the matrix but calling `.row_space()`.



---

archive/issue_comments_355532.json:
```json
{
    "body": "OK, the problem is that the algorithm has been changed so that only a part of a row was rescaled. That's quite reasonable to do, and actually one of the changes of SharedMeatAxe compared to MeatAxe is that in the school book gau\u00dfian elimination implementation I made it so that the already annulated part of a row is not rescaled.\n\nOnly in the wrapper in Sage I did not expose that functionality. I guess that needs to change.",
    "created_at": "2018-05-31T09:37:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355532",
    "user": "@simon-king-jena"
}
```

OK, the problem is that the algorithm has been changed so that only a part of a row was rescaled. That's quite reasonable to do, and actually one of the changes of SharedMeatAxe compared to MeatAxe is that in the school book gaußian elimination implementation I made it so that the already annulated part of a row is not rescaled.

Only in the wrapper in Sage I did not expose that functionality. I guess that needs to change.



---

archive/issue_comments_355533.json:
```json
{
    "body": "That part of Gau\u00dfian elimination was not changed by #17272.\n\nAh, I found the problem: the method was renamed `_echelon_in_place_classical` -> `_echelon_in_place`. So the generic matrix code is no longer calling the specialized version.",
    "created_at": "2018-05-31T09:42:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355533",
    "user": "@tscrim"
}
```

That part of Gaußian elimination was not changed by #17272.

Ah, I found the problem: the method was renamed `_echelon_in_place_classical` -> `_echelon_in_place`. So the generic matrix code is no longer calling the specialized version.



---

archive/issue_comments_355534.json:
```json
{
    "body": "I will push a fix in 1 second.",
    "created_at": "2018-05-31T09:45:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355534",
    "user": "@tscrim"
}
```

I will push a fix in 1 second.



---

archive/issue_comments_355535.json:
```json
{
    "body": "Okay, so this fixes the problem. It has a bit of technical debt as it pushes a potentially bigger issue design issue down the road, but it works. I also do similar fixes for other matrices that may not be using their optimized code. A bigger design discussion on matrices is likely needed.\n----\nNew commits:",
    "created_at": "2018-05-31T10:16:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355535",
    "user": "@tscrim"
}
```

Okay, so this fixes the problem. It has a bit of technical debt as it pushes a potentially bigger issue design issue down the road, but it works. I also do similar fixes for other matrices that may not be using their optimized code. A bigger design discussion on matrices is likely needed.
----
New commits:



---

archive/issue_comments_355536.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-05-31T10:16:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355536",
    "user": "@tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_355537.json:
```json
{
    "body": "So, you think it won't be needed to allow !Matrix_gfpn_dense to perform a partial row rescaling? Would it nonetheless be a good idea to implement?",
    "created_at": "2018-05-31T14:07:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355537",
    "user": "@simon-king-jena"
}
```

So, you think it won't be needed to allow !Matrix_gfpn_dense to perform a partial row rescaling? Would it nonetheless be a good idea to implement?



---

archive/issue_comments_355538.json:
```json
{
    "body": "I definitely think it would be good to do partial row rescaling; it probably will give you a speed boost. Although that this actually indicated an error turned out to be a good thing indicating something I missed when reviewing #17272.",
    "created_at": "2018-05-31T14:17:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355538",
    "user": "@tscrim"
}
```

I definitely think it would be good to do partial row rescaling; it probably will give you a speed boost. Although that this actually indicated an error turned out to be a good thing indicating something I missed when reviewing #17272.



---

archive/issue_comments_355539.json:
```json
{
    "body": "Replying to [comment:15 tscrim]:\n> I definitely think it would be good to do partial row rescaling; it probably will give you a speed boost. Although that this actually indicated an error turned out to be a good thing indicating something I missed when reviewing #17272.\n\nThen I propose to provide an enhancement on top of your changes. I just checked: With your branch the tests in src/sage/matrix pass. And then I hope we can review each other's commits.",
    "created_at": "2018-05-31T14:20:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355539",
    "user": "@simon-king-jena"
}
```

Replying to [comment:15 tscrim]:
> I definitely think it would be good to do partial row rescaling; it probably will give you a speed boost. Although that this actually indicated an error turned out to be a good thing indicating something I missed when reviewing #17272.

Then I propose to provide an enhancement on top of your changes. I just checked: With your branch the tests in src/sage/matrix pass. And then I hope we can review each other's commits.



---

archive/issue_comments_355540.json:
```json
{
    "body": "Replying to [comment:16 SimonKing]:\n> Replying to [comment:15 tscrim]:\n> > I definitely think it would be good to do partial row rescaling; it probably will give you a speed boost. Although that this actually indicated an error turned out to be a good thing indicating something I missed when reviewing #17272.\n> \n> Then I propose to provide an enhancement on top of your changes. I just checked: With your branch the tests in src/sage/matrix pass. And then I hope we can review each other's commits.\n\nIn principle, I would fine with it. However, given this is a blocker issue, I think this would be better to do so on a follow-up (which I will happily review).",
    "created_at": "2018-05-31T14:29:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355540",
    "user": "@tscrim"
}
```

Replying to [comment:16 SimonKing]:
> Replying to [comment:15 tscrim]:
> > I definitely think it would be good to do partial row rescaling; it probably will give you a speed boost. Although that this actually indicated an error turned out to be a good thing indicating something I missed when reviewing #17272.
> 
> Then I propose to provide an enhancement on top of your changes. I just checked: With your branch the tests in src/sage/matrix pass. And then I hope we can review each other's commits.

In principle, I would fine with it. However, given this is a blocker issue, I think this would be better to do so on a follow-up (which I will happily review).



---

archive/issue_comments_355541.json:
```json
{
    "body": "So far I got a timeout in `sage -t src/sage/rings/padics/padic_lattice_element.py`.",
    "created_at": "2018-05-31T15:25:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355541",
    "user": "@simon-king-jena"
}
```

So far I got a timeout in `sage -t src/sage/rings/padics/padic_lattice_element.py`.



---

archive/issue_comments_355542.json:
```json
{
    "body": "Replying to [comment:18 SimonKing]:\n> So far I got a timeout in `sage -t src/sage/rings/padics/padic_lattice_element.py`.\n\nThat has been noticed by a few other people.",
    "created_at": "2018-05-31T15:30:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355542",
    "user": "@tscrim"
}
```

Replying to [comment:18 SimonKing]:
> So far I got a timeout in `sage -t src/sage/rings/padics/padic_lattice_element.py`.

That has been noticed by a few other people.



---

archive/issue_comments_355543.json:
```json
{
    "body": "`sage -t src/sage/rings/padics/padic_lattice_element.py` and `sage -t src/sage/rings/padics/padic_base_leaves.py` time out consistently, even when tested separately. \n\nI cannot imagine that it is related with the issue we are dealing with here - hence, I'll try if these two tests fail without the patch from here.",
    "created_at": "2018-05-31T18:13:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355543",
    "user": "@simon-king-jena"
}
```

`sage -t src/sage/rings/padics/padic_lattice_element.py` and `sage -t src/sage/rings/padics/padic_base_leaves.py` time out consistently, even when tested separately. 

I cannot imagine that it is related with the issue we are dealing with here - hence, I'll try if these two tests fail without the patch from here.



---

archive/issue_comments_355544.json:
```json
{
    "body": "Yep, I get the same timeouts. So, I believe the timeouts are not related with this ticket and thus shouldn't prevent a review.\n\nThe code looks good. But shouldn't there be a test that demonstrates that the bug is fixed? Or are the existing tests good enough?",
    "created_at": "2018-05-31T19:10:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355544",
    "user": "@simon-king-jena"
}
```

Yep, I get the same timeouts. So, I believe the timeouts are not related with this ticket and thus shouldn't prevent a review.

The code looks good. But shouldn't there be a test that demonstrates that the bug is fixed? Or are the existing tests good enough?



---

archive/issue_comments_355545.json:
```json
{
    "body": "Tests pass for me on OS X with this branch, on a system with MeatAxe installed. I haven't tried without MeatAxe present.",
    "created_at": "2018-05-31T19:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355545",
    "user": "@jhpalmieri"
}
```

Tests pass for me on OS X with this branch, on a system with MeatAxe installed. I haven't tried without MeatAxe present.



---

archive/issue_comments_355546.json:
```json
{
    "body": "I would say the existing tests are good enough since they were breaking before this change.",
    "created_at": "2018-06-01T05:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355546",
    "user": "@tscrim"
}
```

I would say the existing tests are good enough since they were breaking before this change.



---

archive/issue_comments_355547.json:
```json
{
    "body": "Replying to [comment:23 tscrim]:\n> I would say the existing tests are good enough since they were breaking before this change.\n\nIn this case I can give a positive review.",
    "created_at": "2018-06-01T06:35:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355547",
    "user": "@simon-king-jena"
}
```

Replying to [comment:23 tscrim]:
> I would say the existing tests are good enough since they were breaking before this change.

In this case I can give a positive review.



---

archive/issue_comments_355548.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-06-01T06:35:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355548",
    "user": "@simon-king-jena"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_355549.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-06-02T09:05:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355549",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_355550.json:
```json
{
    "body": "See patchbot",
    "created_at": "2018-06-02T09:05:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355550",
    "user": "@vbraun"
}
```

See patchbot



---

archive/issue_comments_355551.json:
```json
{
    "body": "Replying to [comment:25 vbraun]:\n> See patchbot\n\nThe patchbot complains that there is a non-ascii character. But I cannot identify it. So, what is it?\n\nThe patchbot complains about pyflakes. But the error is \"NameError: name 'isPythonFile' is not defined\". Doesn't that mean there is a bug in the plugin, not in the changeset?\n\nThe patchbot complains about startup time. I don't know how to interpret the numbers, so I don't know how much of a problem we have here.\n\nThe test error is reproducible as follows:\n\n```\nsage: K.<x> = GF(25)\nsage: M = MatrixSpace(K,9,3,implementation='generic')()\nsage: entries = [((0, 2), x), ((0, 4), 3*x + 2), ((0, 8), 2*x), ((1, 1), x + 3), ((1, 5), 3*x), ((1, 6), x + 4), ((2, 0), 2*x), ((2, 5), 4*x + 1)]\nsage: for (i,j),v in entries: M[j,i]=v\nsage: M\n[      0       0     2*x]\n[      0   x + 3       0]\n[      x       0       0]\n[      0       0       0]\n[3*x + 2       0       0]\n[      0     3*x 4*x + 1]\n[      0   x + 4       0]\n[      0       0       0]\n[    2*x       0       0]\nsage: type(M)\n<type 'sage.matrix.matrix_generic_dense.Matrix_generic_dense'>\nsage: M._echelon_in_place('classical')\n(0, 1, 2)\n```\n\nHence, `M._echelon_in_place_classical` behaves differently for Matrix_gfpn_dense and for generic implementation. That indeed needs to be fixed.",
    "created_at": "2018-06-02T09:56:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355551",
    "user": "@simon-king-jena"
}
```

Replying to [comment:25 vbraun]:
> See patchbot

The patchbot complains that there is a non-ascii character. But I cannot identify it. So, what is it?

The patchbot complains about pyflakes. But the error is "NameError: name 'isPythonFile' is not defined". Doesn't that mean there is a bug in the plugin, not in the changeset?

The patchbot complains about startup time. I don't know how to interpret the numbers, so I don't know how much of a problem we have here.

The test error is reproducible as follows:

```
sage: K.<x> = GF(25)
sage: M = MatrixSpace(K,9,3,implementation='generic')()
sage: entries = [((0, 2), x), ((0, 4), 3*x + 2), ((0, 8), 2*x), ((1, 1), x + 3), ((1, 5), 3*x), ((1, 6), x + 4), ((2, 0), 2*x), ((2, 5), 4*x + 1)]
sage: for (i,j),v in entries: M[j,i]=v
sage: M
[      0       0     2*x]
[      0   x + 3       0]
[      x       0       0]
[      0       0       0]
[3*x + 2       0       0]
[      0     3*x 4*x + 1]
[      0   x + 4       0]
[      0       0       0]
[    2*x       0       0]
sage: type(M)
<type 'sage.matrix.matrix_generic_dense.Matrix_generic_dense'>
sage: M._echelon_in_place('classical')
(0, 1, 2)
```

Hence, `M._echelon_in_place_classical` behaves differently for Matrix_gfpn_dense and for generic implementation. That indeed needs to be fixed.



---

archive/issue_comments_355552.json:
```json
{
    "body": "The generic implementation's documentation does not state what return value it gives. However, it apparently returns the pivots. So, I guess I shall modify the _echelon_in_place_classical method of Matrix_gfpn_dense.",
    "created_at": "2018-06-02T09:59:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355552",
    "user": "@simon-king-jena"
}
```

The generic implementation's documentation does not state what return value it gives. However, it apparently returns the pivots. So, I guess I shall modify the _echelon_in_place_classical method of Matrix_gfpn_dense.



---

archive/issue_comments_355553.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-02T15:00:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355553",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_355554.json:
```json
{
    "body": "Done! Should work now, regardless whether meataxe is installed or not. Hopefully someone can review the last commit.",
    "created_at": "2018-06-02T15:02:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355554",
    "user": "@simon-king-jena"
}
```

Done! Should work now, regardless whether meataxe is installed or not. Hopefully someone can review the last commit.



---

archive/issue_comments_355555.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-06-02T15:02:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355555",
    "user": "@simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_355556.json:
```json
{
    "body": "\n```\n----------------------------------------------------------------------\nsage -t src/sage/rings/padics/padic_base_leaves.py  # Timed out\nsage -t src/sage/rings/padics/padic_lattice_element.py  # Timed out\nsage -t src/sage/tests/cmdline.py  # 2 doctests failed\nsage -t src/sage/symbolic/integration/integral.py  # 1 doctest failed\nsage -t src/sage/combinat/tutorial.py  # 2 doctests failed\nsage -t src/sage/groups/perm_gps/permgroup_named.py  # 2 doctests failed\nsage -t src/sage/combinat/words/paths.py  # 1 doctest failed\nsage -t src/sage/symbolic/integration/external.py  # 3 doctests failed\nsage -t src/sage/combinat/designs/bibd.py  # 1 doctest failed\nsage -t src/sage/databases/oeis.py  # 34 doctests failed\nsage -t src/sage/coding/databases.py  # 2 doctests failed\nsage -t src/doc/en/developer/coding_basics.rst  # 1 doctest failed\nsage -t src/sage/combinat/integer_lists/invlex.pyx  # 1 doctest failed\nsage -t src/sage/repl/load.py  # 1 doctest failed\nsage -t src/sage/databases/findstat.py  # 8 doctests failed\nsage -t src/sage/combinat/designs/ext_rep.py  # 1 doctest failed\nsage -t src/sage/finance/stock.py  # 20 doctests failed\nsage -t src/sage/structure/sage_object.pyx  # 2 doctests failed\n----------------------------------------------------------------------\nTotal time for all tests: 4047.7 seconds\n    cpu time: 8523.9 seconds\n    cumulative wall time: 10809.1 seconds\nExternal software detected for doctesting: internet,latex\nTraceback (most recent call last):\n  File \"/home/king/Sage/git/sage/src/bin/sage-runtests\", line 127, in <module>\n    err = DC.run()\n  File \"/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 1176, in run\n    + ','.join(available_software.seen()))\n  File \"/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 583, in log\n    self.logger.write(s + end)\n  File \"/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 250, in write\n    f.write(x)\nValueError: I/O operation on closed file\nMakefile:132: recipe for target 'ptestall' failed\nmake: *** [ptestall] Error 1\n```\n\nOuch.",
    "created_at": "2018-06-02T18:37:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355556",
    "user": "@simon-king-jena"
}
```


```
----------------------------------------------------------------------
sage -t src/sage/rings/padics/padic_base_leaves.py  # Timed out
sage -t src/sage/rings/padics/padic_lattice_element.py  # Timed out
sage -t src/sage/tests/cmdline.py  # 2 doctests failed
sage -t src/sage/symbolic/integration/integral.py  # 1 doctest failed
sage -t src/sage/combinat/tutorial.py  # 2 doctests failed
sage -t src/sage/groups/perm_gps/permgroup_named.py  # 2 doctests failed
sage -t src/sage/combinat/words/paths.py  # 1 doctest failed
sage -t src/sage/symbolic/integration/external.py  # 3 doctests failed
sage -t src/sage/combinat/designs/bibd.py  # 1 doctest failed
sage -t src/sage/databases/oeis.py  # 34 doctests failed
sage -t src/sage/coding/databases.py  # 2 doctests failed
sage -t src/doc/en/developer/coding_basics.rst  # 1 doctest failed
sage -t src/sage/combinat/integer_lists/invlex.pyx  # 1 doctest failed
sage -t src/sage/repl/load.py  # 1 doctest failed
sage -t src/sage/databases/findstat.py  # 8 doctests failed
sage -t src/sage/combinat/designs/ext_rep.py  # 1 doctest failed
sage -t src/sage/finance/stock.py  # 20 doctests failed
sage -t src/sage/structure/sage_object.pyx  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 4047.7 seconds
    cpu time: 8523.9 seconds
    cumulative wall time: 10809.1 seconds
External software detected for doctesting: internet,latex
Traceback (most recent call last):
  File "/home/king/Sage/git/sage/src/bin/sage-runtests", line 127, in <module>
    err = DC.run()
  File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/control.py", line 1176, in run
    + ','.join(available_software.seen()))
  File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/control.py", line 583, in log
    self.logger.write(s + end)
  File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/control.py", line 250, in write
    f.write(x)
ValueError: I/O operation on closed file
Makefile:132: recipe for target 'ptestall' failed
make: *** [ptestall] Error 1
```

Ouch.



---

archive/issue_comments_355557.json:
```json
{
    "body": "But these failures seem all to be \"optional: internet\". Anyway, I got them with `make ptestall`.",
    "created_at": "2018-06-02T18:39:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355557",
    "user": "@simon-king-jena"
}
```

But these failures seem all to be "optional: internet". Anyway, I got them with `make ptestall`.



---

archive/issue_comments_355558.json:
```json
{
    "body": "PS: I'll try again with a clean develop branch.",
    "created_at": "2018-06-02T18:40:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355558",
    "user": "@simon-king-jena"
}
```

PS: I'll try again with a clean develop branch.



---

archive/issue_comments_355559.json:
```json
{
    "body": "Loads of errors, but at least the last few errors I saw are due to what was fixed in this ticket.\n\nFrustrating.",
    "created_at": "2018-06-02T19:29:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355559",
    "user": "@simon-king-jena"
}
```

Loads of errors, but at least the last few errors I saw are due to what was fixed in this ticket.

Frustrating.



---

archive/issue_comments_355560.json:
```json
{
    "body": "Replying to [comment:33 SimonKing]:\n> Loads of errors, but at least the last few errors I saw are due to what was fixed in this ticket.\n> \n> Frustrating.\n\nThe \"optional - internet\" tests are failing, too.",
    "created_at": "2018-06-02T19:35:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355560",
    "user": "@simon-king-jena"
}
```

Replying to [comment:33 SimonKing]:
> Loads of errors, but at least the last few errors I saw are due to what was fixed in this ticket.
> 
> Frustrating.

The "optional - internet" tests are failing, too.



---

archive/issue_comments_355561.json:
```json
{
    "body": "Replying to [comment:33 SimonKing]:\n> Frustrating.\n\nBy \"frustrating\" I mean the fact that a clean develop branch doesn't pass tests. So, how could one possibly do development without a proper base to start with.",
    "created_at": "2018-06-02T20:40:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355561",
    "user": "@simon-king-jena"
}
```

Replying to [comment:33 SimonKing]:
> Frustrating.

By "frustrating" I mean the fact that a clean develop branch doesn't pass tests. So, how could one possibly do development without a proper base to start with.



---

archive/issue_comments_355562.json:
```json
{
    "body": "The internet tests failing are in some sense recent: Sage is supposed to automatically test for an internet connection and then run those tests, but the function `has_internet` was incorrectly returning `False` until a recent fix (#25222). Now lots of tests are failing, but there are tickets for them (#25474, #25472, and some others). You could turn off your internet while running tests, or just specify testing those tests marked optional with the `meataxe` tag.",
    "created_at": "2018-06-02T21:34:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355562",
    "user": "@jhpalmieri"
}
```

The internet tests failing are in some sense recent: Sage is supposed to automatically test for an internet connection and then run those tests, but the function `has_internet` was incorrectly returning `False` until a recent fix (#25222). Now lots of tests are failing, but there are tickets for them (#25474, #25472, and some others). You could turn off your internet while running tests, or just specify testing those tests marked optional with the `meataxe` tag.



---

archive/issue_comments_355563.json:
```json
{
    "body": "You can also run the tests manually with `sage -b` (with `--optional=sage,meataxe`, but I think `internet` gets excluded from those tests and the default is sufficient).",
    "created_at": "2018-06-03T07:53:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355563",
    "user": "@tscrim"
}
```

You can also run the tests manually with `sage -b` (with `--optional=sage,meataxe`, but I think `internet` gets excluded from those tests and the default is sufficient).



---

archive/issue_comments_355564.json:
```json
{
    "body": "Replying to [comment:35 SimonKing]:\n> So, how could one possibly do development without a proper base to start with.\n\nDon't use `make ptestall` if you don't want all external tests to be run. Instead, use `make ptest`.",
    "created_at": "2018-06-04T08:19:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355564",
    "user": "@jdemeyer"
}
```

Replying to [comment:35 SimonKing]:
> So, how could one possibly do development without a proper base to start with.

Don't use `make ptestall` if you don't want all external tests to be run. Instead, use `make ptest`.



---

archive/issue_comments_355565.json:
```json
{
    "body": "Replying to [comment:29 SimonKing]:\n> Hopefully someone can review the last commit.\n\nTravis, can you do that? This is making it very hard to work on any matrix-related ticket (like #23719, #25079 and #25504)",
    "created_at": "2018-06-04T12:33:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355565",
    "user": "@jdemeyer"
}
```

Replying to [comment:29 SimonKing]:
> Hopefully someone can review the last commit.

Travis, can you do that? This is making it very hard to work on any matrix-related ticket (like #23719, #25079 and #25504)



---

archive/issue_comments_355566.json:
```json
{
    "body": "LGTM. Thank you.",
    "created_at": "2018-06-05T00:12:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355566",
    "user": "@tscrim"
}
```

LGTM. Thank you.



---

archive/issue_comments_355567.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-06-05T00:12:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355567",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_355568.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-06-07T22:15:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25239",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25239#issuecomment-355568",
    "user": "@vbraun"
}
```

Resolution: fixed
