# Issue 25239: MeatAxe-related bug introduced in 8.3.beta

Issue created by migration from Trac.

Original creator: SimonKing

Original creation time: 2018-05-30 23:02:21

CC:  vdelecroix tscrim

Keywords: meataxe rescale_row

Vincent reports this for SageMath 8.3.beta3 with MeatAxe installed:

```
File "src/sage/coding/linear_code.py", line 2039, in
sage.coding.linear_code.AbstractLinearCode.__getitem__
Failed example:
     C = random_matrix(GF(25,'a'), 2, 7).row_space()
Exception raised:
     Traceback (most recent call last):
       File
"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py",
line 572, in _run
         self.compile_and_execute(example, compiler, test.globs)
       File
"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/doctest/forker.py",
line 982, in compile_and_execute
         exec(compiled, globs)
       File "<doctest
sage.coding.linear_code.AbstractLinearCode.__getitem__[4]>", line 1, in
<module>
         C = random_matrix(GF(Integer(25),'a'), Integer(2),
Integer(7)).row_space()
       File "sage/matrix/matrix2.pyx", line 4592, in
sage.matrix.matrix2.Matrix.row_space
(build/cythonized/sage/matrix/matrix2.c:34495)
         return self.row_module(base_ring=base_ring)
       File "sage/matrix/matrix2.pyx", line 4565, in
sage.matrix.matrix2.Matrix.row_module
(build/cythonized/sage/matrix/matrix2.c:34373)
         return M.span(self.rows(), already_echelonized=False)
       File
"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/modules/free_module.py",
line 3850, in span
         self.ambient_module(), gens=gens, check=check,
already_echelonized=already_echelonized)
       File
"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/modules/free_module.py",
line 6961, in __init__
         echelonize=not already_echelonized,
already_echelonized=already_echelonized)
       File
"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/modules/free_module.py",
line 6763, in __init__
         echelonized_basis=echelonized_basis,
already_echelonized=already_echelonized)
       File
"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/modules/free_module.py",
line 5691, in __init__
         basis = self._echelonized_basis(ambient, basis)
       File
"/home/vdelecro/sage_patchbot/local/lib/python2.7/site-packages/sage/modules/free_module.py",
line 6894, in _echelonized_basis
         E = A.echelon_form()
       File "sage/matrix/matrix2.pyx", line 6819, in
sage.matrix.matrix2.Matrix.echelon_form
(build/cythonized/sage/matrix/matrix2.c:53810)
         v = E.echelonize(cutoff=cutoff, **kwds)
       File "sage/matrix/matrix2.pyx", line 6719, in
sage.matrix.matrix2.Matrix.echelonize
(build/cythonized/sage/matrix/matrix2.c:53210)
         self._echelon_in_place(algorithm)
       File "sage/matrix/matrix2.pyx", line 6984, in
sage.matrix.matrix2.Matrix._echelon_in_place
(build/cythonized/sage/matrix/matrix2.c:54847)
         A.rescale_row(r, a_inverse, c)
       File "sage/matrix/matrix0.pyx", line 3005, in
sage.matrix.matrix0.Matrix.rescale_row
(build/cythonized/sage/matrix/matrix0.c:21880)
         self.rescale_row_c(i, s, start_col)
       File "sage/matrix/matrix_gfpn_dense.pyx", line 944, in
sage.matrix.matrix_gfpn_dense.Matrix_gfpn_dense.rescale_row_c
(build/cythonized/sage/matrix/matrix_gfpn_dense.c:9339)
         raise ValueError("We can only rescale a full row of a non-empty
matrix")
     ValueError: We can only rescale a full row of a non-empty matrix
**********************************************************************
```


The above error does not occur in 8.2.rc4. Let's try to prevent it from being published in 8.3!



---

Comment by SimonKing created at 2018-05-30 23:03:45

Practical problem: I can currently not build and test 8.3.beta3, since I won't interrupt a computation that I am currently running (it is running since three weeks and might disprove a conjecture on the structure of cohomology rings).


---

Comment by tscrim created at 2018-05-31 04:58:30

This also occurs in testing `matrix/matrix2.pyx`.


---

Comment by tscrim created at 2018-05-31 05:47:17

Changing priority from critical to blocker.


---

Comment by tscrim created at 2018-05-31 05:47:17

So this seems to be caused by #17272, but I do not understand why. It is the exact same code for the classical echelon algorithm. The only other difference is that has become a `cpdef` method instead of a `def` method, but changing that didn't seem to fix the problem. At least, where the error is happening, it means we would have just inverted a 0 if the row is all 0. So perhaps this is a bug in Cython?

Also, failing tests with optional packages is a blocker.


---

Comment by tscrim created at 2018-05-31 05:49:10

PS - I think the machine I tested #17272 on did not have `meataxe` installed (unlike my usual devbox), but I thought it did...(cannot check it for the next ~2 months).


---

Comment by tscrim created at 2018-05-31 06:01:17

I really have no idea what is going on. It does work before #17272, but fails after. Changing both the `cpdef` -> `def` doesn't fix it. The algorithm is exactly the same and even reverting that part of the code does not fix it.


---

Comment by SimonKing created at 2018-05-31 07:08:05

While trying to build the latest beta, cddlib fails. Very bad. So, I still cannot test stuff.


---

Comment by SimonKing created at 2018-05-31 07:09:58

Fortunately retrying `make cddlib` worked.


---

Comment by SimonKing created at 2018-05-31 09:32:32

Now I completed building the latest beta and can confirm the bug.


---

Comment by SimonKing created at 2018-05-31 09:33:10

PS: It is not the creation of the matrix but calling `.row_space()`.


---

Comment by SimonKing created at 2018-05-31 09:37:17

OK, the problem is that the algorithm has been changed so that only a part of a row was rescaled. That's quite reasonable to do, and actually one of the changes of SharedMeatAxe compared to MeatAxe is that in the school book gaußian elimination implementation I made it so that the already annulated part of a row is not rescaled.

Only in the wrapper in Sage I did not expose that functionality. I guess that needs to change.


---

Comment by tscrim created at 2018-05-31 09:42:46

That part of Gaußian elimination was not changed by #17272.

Ah, I found the problem: the method was renamed `_echelon_in_place_classical` -> `_echelon_in_place`. So the generic matrix code is no longer calling the specialized version.


---

Comment by tscrim created at 2018-05-31 09:45:04

I will push a fix in 1 second.


---

Comment by tscrim created at 2018-05-31 10:16:25

Okay, so this fixes the problem. It has a bit of technical debt as it pushes a potentially bigger issue design issue down the road, but it works. I also do similar fixes for other matrices that may not be using their optimized code. A bigger design discussion on matrices is likely needed.
----
New commits:


---

Comment by tscrim created at 2018-05-31 10:16:25

Changing status from new to needs_review.


---

Comment by SimonKing created at 2018-05-31 14:07:39

So, you think it won't be needed to allow !Matrix_gfpn_dense to perform a partial row rescaling? Would it nonetheless be a good idea to implement?


---

Comment by tscrim created at 2018-05-31 14:17:36

I definitely think it would be good to do partial row rescaling; it probably will give you a speed boost. Although that this actually indicated an error turned out to be a good thing indicating something I missed when reviewing #17272.


---

Comment by SimonKing created at 2018-05-31 14:20:01

Replying to [comment:15 tscrim]:
> I definitely think it would be good to do partial row rescaling; it probably will give you a speed boost. Although that this actually indicated an error turned out to be a good thing indicating something I missed when reviewing #17272.

Then I propose to provide an enhancement on top of your changes. I just checked: With your branch the tests in src/sage/matrix pass. And then I hope we can review each other's commits.


---

Comment by tscrim created at 2018-05-31 14:29:52

Replying to [comment:16 SimonKing]:
> Replying to [comment:15 tscrim]:
> > I definitely think it would be good to do partial row rescaling; it probably will give you a speed boost. Although that this actually indicated an error turned out to be a good thing indicating something I missed when reviewing #17272.
> 
> Then I propose to provide an enhancement on top of your changes. I just checked: With your branch the tests in src/sage/matrix pass. And then I hope we can review each other's commits.

In principle, I would fine with it. However, given this is a blocker issue, I think this would be better to do so on a follow-up (which I will happily review).


---

Comment by SimonKing created at 2018-05-31 15:25:19

So far I got a timeout in `sage -t src/sage/rings/padics/padic_lattice_element.py`.


---

Comment by tscrim created at 2018-05-31 15:30:31

Replying to [comment:18 SimonKing]:
> So far I got a timeout in `sage -t src/sage/rings/padics/padic_lattice_element.py`.

That has been noticed by a few other people.


---

Comment by SimonKing created at 2018-05-31 18:13:47

`sage -t src/sage/rings/padics/padic_lattice_element.py` and `sage -t src/sage/rings/padics/padic_base_leaves.py` time out consistently, even when tested separately. 

I cannot imagine that it is related with the issue we are dealing with here - hence, I'll try if these two tests fail without the patch from here.


---

Comment by SimonKing created at 2018-05-31 19:10:35

Yep, I get the same timeouts. So, I believe the timeouts are not related with this ticket and thus shouldn't prevent a review.

The code looks good. But shouldn't there be a test that demonstrates that the bug is fixed? Or are the existing tests good enough?


---

Comment by jhpalmieri created at 2018-05-31 19:57:06

Tests pass for me on OS X with this branch, on a system with MeatAxe installed. I haven't tried without MeatAxe present.


---

Comment by tscrim created at 2018-06-01 05:57:17

I would say the existing tests are good enough since they were breaking before this change.


---

Comment by SimonKing created at 2018-06-01 06:35:20

Replying to [comment:23 tscrim]:
> I would say the existing tests are good enough since they were breaking before this change.

In this case I can give a positive review.


---

Comment by SimonKing created at 2018-06-01 06:35:20

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-06-02 09:05:07

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-06-02 09:05:07

See patchbot


---

Comment by SimonKing created at 2018-06-02 09:56:30

Replying to [comment:25 vbraun]:
> See patchbot

The patchbot complains that there is a non-ascii character. But I cannot identify it. So, what is it?

The patchbot complains about pyflakes. But the error is "NameError: name 'isPythonFile' is not defined". Doesn't that mean there is a bug in the plugin, not in the changeset?

The patchbot complains about startup time. I don't know how to interpret the numbers, so I don't know how much of a problem we have here.

The test error is reproducible as follows:

```
sage: K.<x> = GF(25)
sage: M = MatrixSpace(K,9,3,implementation='generic')()
sage: entries = [((0, 2), x), ((0, 4), 3*x + 2), ((0, 8), 2*x), ((1, 1), x + 3), ((1, 5), 3*x), ((1, 6), x + 4), ((2, 0), 2*x), ((2, 5), 4*x + 1)]
sage: for (i,j),v in entries: M[j,i]=v
sage: M
[      0       0     2*x]
[      0   x + 3       0]
[      x       0       0]
[      0       0       0]
[3*x + 2       0       0]
[      0     3*x 4*x + 1]
[      0   x + 4       0]
[      0       0       0]
[    2*x       0       0]
sage: type(M)
<type 'sage.matrix.matrix_generic_dense.Matrix_generic_dense'>
sage: M._echelon_in_place('classical')
(0, 1, 2)
```

Hence, `M._echelon_in_place_classical` behaves differently for Matrix_gfpn_dense and for generic implementation. That indeed needs to be fixed.


---

Comment by SimonKing created at 2018-06-02 09:59:43

The generic implementation's documentation does not state what return value it gives. However, it apparently returns the pivots. So, I guess I shall modify the _echelon_in_place_classical method of Matrix_gfpn_dense.


---

Comment by git created at 2018-06-02 15:00:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2018-06-02 15:02:01

Done! Should work now, regardless whether meataxe is installed or not. Hopefully someone can review the last commit.


---

Comment by SimonKing created at 2018-06-02 15:02:01

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2018-06-02 18:37:40


```
----------------------------------------------------------------------
sage -t src/sage/rings/padics/padic_base_leaves.py  # Timed out
sage -t src/sage/rings/padics/padic_lattice_element.py  # Timed out
sage -t src/sage/tests/cmdline.py  # 2 doctests failed
sage -t src/sage/symbolic/integration/integral.py  # 1 doctest failed
sage -t src/sage/combinat/tutorial.py  # 2 doctests failed
sage -t src/sage/groups/perm_gps/permgroup_named.py  # 2 doctests failed
sage -t src/sage/combinat/words/paths.py  # 1 doctest failed
sage -t src/sage/symbolic/integration/external.py  # 3 doctests failed
sage -t src/sage/combinat/designs/bibd.py  # 1 doctest failed
sage -t src/sage/databases/oeis.py  # 34 doctests failed
sage -t src/sage/coding/databases.py  # 2 doctests failed
sage -t src/doc/en/developer/coding_basics.rst  # 1 doctest failed
sage -t src/sage/combinat/integer_lists/invlex.pyx  # 1 doctest failed
sage -t src/sage/repl/load.py  # 1 doctest failed
sage -t src/sage/databases/findstat.py  # 8 doctests failed
sage -t src/sage/combinat/designs/ext_rep.py  # 1 doctest failed
sage -t src/sage/finance/stock.py  # 20 doctests failed
sage -t src/sage/structure/sage_object.pyx  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 4047.7 seconds
    cpu time: 8523.9 seconds
    cumulative wall time: 10809.1 seconds
External software detected for doctesting: internet,latex
Traceback (most recent call last):
  File "/home/king/Sage/git/sage/src/bin/sage-runtests", line 127, in <module>
    err = DC.run()
  File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/control.py", line 1176, in run
    + ','.join(available_software.seen()))
  File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/control.py", line 583, in log
    self.logger.write(s + end)
  File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/control.py", line 250, in write
    f.write(x)
ValueError: I/O operation on closed file
Makefile:132: recipe for target 'ptestall' failed
make: *** [ptestall] Error 1
```

Ouch.


---

Comment by SimonKing created at 2018-06-02 18:39:51

But these failures seem all to be "optional: internet". Anyway, I got them with `make ptestall`.


---

Comment by SimonKing created at 2018-06-02 18:40:41

PS: I'll try again with a clean develop branch.


---

Comment by SimonKing created at 2018-06-02 19:29:11

Loads of errors, but at least the last few errors I saw are due to what was fixed in this ticket.

Frustrating.


---

Comment by SimonKing created at 2018-06-02 19:35:48

Replying to [comment:33 SimonKing]:
> Loads of errors, but at least the last few errors I saw are due to what was fixed in this ticket.
> 
> Frustrating.

The "optional - internet" tests are failing, too.


---

Comment by SimonKing created at 2018-06-02 20:40:46

Replying to [comment:33 SimonKing]:
> Frustrating.

By "frustrating" I mean the fact that a clean develop branch doesn't pass tests. So, how could one possibly do development without a proper base to start with.


---

Comment by jhpalmieri created at 2018-06-02 21:34:52

The internet tests failing are in some sense recent: Sage is supposed to automatically test for an internet connection and then run those tests, but the function `has_internet` was incorrectly returning `False` until a recent fix (#25222). Now lots of tests are failing, but there are tickets for them (#25474, #25472, and some others). You could turn off your internet while running tests, or just specify testing those tests marked optional with the `meataxe` tag.


---

Comment by tscrim created at 2018-06-03 07:53:41

You can also run the tests manually with `sage -b` (with `--optional=sage,meataxe`, but I think `internet` gets excluded from those tests and the default is sufficient).


---

Comment by jdemeyer created at 2018-06-04 08:19:56

Replying to [comment:35 SimonKing]:
> So, how could one possibly do development without a proper base to start with.

Don't use `make ptestall` if you don't want all external tests to be run. Instead, use `make ptest`.


---

Comment by jdemeyer created at 2018-06-04 12:33:00

Replying to [comment:29 SimonKing]:
> Hopefully someone can review the last commit.

Travis, can you do that? This is making it very hard to work on any matrix-related ticket (like #23719, #25079 and #25504)


---

Comment by tscrim created at 2018-06-05 00:12:23

LGTM. Thank you.


---

Comment by tscrim created at 2018-06-05 00:12:23

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-06-07 22:15:20

Resolution: fixed
