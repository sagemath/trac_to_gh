# Issue 31033: Remove sage-location

Issue created by migration from https://trac.sagemath.org/ticket/31270

Original creator: mkoeppe

Original creation time: 2021-01-20 23:57:36

CC:  jhpalmieri culler dimpase fbissey arojas @mwageringel

#21783 removes the last productive bit of `sage-location`.

We get rid of the whole mechanism completely.

When we get rid of `sage-location`, we can finally close tickets #15146, #17479, #11755)

This is preparation of sorts for #31076, which proposes to add a different relocation mechanism.


---

Comment by git created at 2021-01-21 00:14:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-01-21 00:24:10

Changing status from new to needs_review.


---

Comment by git created at 2021-01-21 00:37:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-01-21 21:57:02

- I don't know how to test whether this will "fix script to work without SAGE_ROOT". Maybe the distro people have to look at that part.

- The script's main purpose is to see if Sage has been relocated and then to quit with an error message if so. Do we need to do this? Can we just document that it can't be moved and let it fail however if fails if someone ignores this? That is, can we delete this entirely?


---

Comment by mkoeppe created at 2021-01-21 22:03:15

Replying to [comment:7 jhpalmieri]:
> - I don't know how to test whether this will "fix script to work without SAGE_ROOT". Maybe the distro people have to look at that part.

Yes, I hope this ticket can reduce the amount of downstream patching


---

Comment by jhpalmieri created at 2021-01-21 22:04:34

Also: would the check

```
    if OLD_SAGE_ROOT != SAGE_ROOT:
```

be more robust as

```
    if not os.path.samefile(OLD_SAGE_ROOT, SAGE_ROOT):
```

or `SAGE_ROOT = os.pathlib.Path('...')` followed by `SAGE_ROOT.samefile(...)` or something similar? Maybe we have to handle `None` as a special case.

Edit: typo: should be `samefile`, not `samepath`.


---

Comment by mkoeppe created at 2021-01-21 22:07:24

Replying to [comment:7 jhpalmieri]:
> - The script's main purpose is to see if Sage has been relocated and then to quit with an error message if so. Do we need to do this? Can we just document that it can't be moved and let it fail however if fails if someone ignores this? That is, can we delete this entirely?

I think there's value in giving a clear error message - removing it could cause more traffic on sage-support


---

Comment by mkoeppe created at 2021-01-21 22:09:29

Replying to [comment:9 jhpalmieri]:
> Also: would the check
> {{{
>     if OLD_SAGE_ROOT != SAGE_ROOT:
> }}}
> be more robust as
> {{{
>     if not os.path.samepath(OLD_SAGE_ROOT, SAGE_ROOT):
> }}}
> or `SAGE_ROOT = os.pathlib.Path('...')` followed by `SAGE_ROOT.samefile(...)` or something similar? Maybe we have to handle `None` as a special case.

Yes, this sounds like a good idea.


---

Comment by mkoeppe created at 2021-01-21 22:14:15

But in fact to make this code really useful, it should be revised to work with `SAGE_LOCAL` instead of `SAGE_ROOT` (see discussion in #30913). So on the present ticket, I wouldn't want to make such improvements


---

Comment by jhpalmieri created at 2021-01-21 22:41:36

I'm not sure what you mean by that, but here is how I would change the file (without worrying about SAGE_ROOT vs. SAGE_LOCAL):

```diff
diff --git a/src/bin/sage-location b/src/bin/sage-location
index f656dd8f41..e83b06e409 100755
--- a/src/bin/sage-location
+++ b/src/bin/sage-location
@@ -97,15 +97,9 @@ if __name__ == '__main__':
     # OLD_SAGE_ROOT is None if this is a first-time install.
     OLD_SAGE_ROOT = read_location_file()
 
-    if OLD_SAGE_ROOT != SAGE_ROOT:
-        if OLD_SAGE_ROOT is None:
-            print("This looks like the first time you are running Sage.")
-        elif OLD_SAGE_ROOT != SAGE_ROOT:
-            print(RELOCATION_ERROR.format(OLD_SAGE_ROOT=OLD_SAGE_ROOT, SAGE_ROOT=SAGE_ROOT))
-            sys.exit(1)
-        else:
-            print("The Sage installation tree has moved")
-            print("from %s" % OLD_SAGE_ROOT)
-            print("  to %s" % SAGE_ROOT)
-            assert(False)
+    if OLD_SAGE_ROOT is None:
+        print("This looks like the first time you are running Sage.")
         sage_relocate()
+    elif not os.path.samefile(OLD_SAGE_ROOT, SAGE_ROOT):
+        print(RELOCATION_ERROR.format(OLD_SAGE_ROOT=OLD_SAGE_ROOT, SAGE_ROOT=SAGE_ROOT))
+        sys.exit(1)
```



---

Comment by mkoeppe created at 2021-01-21 22:44:53

This change would be fine with me. In fact, the message "This looks like the first time you are running Sage." can probably be removed. Please feel free to push to the ticket


---

Comment by jhpalmieri created at 2021-01-21 23:03:46

Done.
----
New commits:


---

Comment by mkoeppe created at 2021-01-21 23:17:52

Positive review for your changes.


---

Comment by jhpalmieri created at 2021-01-21 23:26:56

I'm happy with it, too, but as I said, I can't review the parts that claim to work when `SAGE_ROOT` is not defined.


---

Comment by fbissey created at 2021-01-22 00:27:19

Well, sage-on-gentoo and probably other distros don't bother installing `sage-location`.

But it looks safe to run on a distro installed sage since we exit straight away on `SAGE_ROOT` being undefined.


---

Comment by jhpalmieri created at 2021-01-22 22:19:22

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2021-01-22 22:19:22

I don't speak Italian (despite the last name), but I think we can merge this.


---

Comment by mkoeppe created at 2021-01-22 22:43:29

Thanks!


---

Comment by vbraun created at 2021-01-31 20:53:08

Resolution: fixed
