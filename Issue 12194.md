# Issue 12194: In mpfr, delete old libraries *after* build

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2012-01-27 08:15:13

Assignee: tbd

CC:  mjo

Keywords: mpfr spkg gcc

If we ever want to build our own `gcc`, we must not delete the mpfr libraries before building mpfr.  This is because `gcc` links against mpfr.


---

Comment by jdemeyer created at 2012-02-03 11:32:57

Changing status from new to needs_review.


---

Comment by mjo created at 2012-02-06 04:21:12

The `MAKE=make` line appeared in this changeset:


```
changeset:   4:4f973988b8df
user:        mabshoff`@`sage.math.washington.edu
date:        Mon Jan 14 17:08:19 2008 -0800
summary:     mpfr-2.3.0.p1: apply patch r5186 from mpfr repo that fixes a stack smashing issue, update SPKG.txt
```


but I don't see a good reason for it. Maybe there was a parallel build failure once upon a time.


---

Comment by mjo created at 2012-02-06 18:52:13

Changing status from needs_review to needs_work.


---

Comment by mjo created at 2012-02-06 18:52:13

We should only remove the old stuff after a successful build; otherwise, we can't try again. I made some small breaking change to one of the header files:


```
$ sage -f mpfr-2.4.2.p1.spkg | grep -i deleting
Deleting directories from past builds of previous/current versions of mpfr-2.4.2.p1
Deleting old libraries
Deleting old headers
Error: Failed to install package 'mpfr-2.4.2.p1'.
```



---

Comment by jdemeyer created at 2012-02-06 18:57:44

I see, there is no check that "$MAKE" actually worked!


---

Attachment

Diff for the mpfr spkg p0 -> p1, for review only


---

Comment by jdemeyer created at 2012-02-07 11:24:28

Changing status from needs_work to needs_review.


---

Comment by mjo created at 2012-02-07 15:47:10

It's still possible that `make install` could fail, leaving GCC without an MPFR. The only solution I see to that would be to move the libs to a temp directory before `make install` and remove them afterwards.

Is it even worth worrying about? You don't need GCC to `make install`. I'll give a positive review as-is; I just want to make sure it's a conscious decision to ignore that case.


---

Comment by jdemeyer created at 2012-02-07 15:59:46

Replying to [comment:7 mjo]:
> It's still possible that `make install` could fail, leaving GCC without an MPFR. The only solution I see to that would be to move the libs to a temp directory before `make install` and remove them afterwards.
> 
> Is it even worth worrying about?
I think it's not so likely that "make install" would fail, since it essentially only copies files.  It could fail with "No space left on device".


---

Comment by mjo created at 2012-02-07 16:07:54

Changing status from needs_review to positive_review.


---

Comment by mjo created at 2012-02-07 16:07:54

It can also fail if there's a bug (e.g. missing file) upstream, but someone should notice that early on. Probably more likely that we would introduce a bug in the workaround.


---

Comment by jdemeyer created at 2012-02-14 14:22:30

Resolution: fixed
