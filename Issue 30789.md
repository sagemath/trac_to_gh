# Issue 30789: sparse6 encoding for canonical graphs returns encoding of original graph

Issue created by migration from https://trac.sagemath.org/ticket/31026

Original creator: @jonasc

Original creation time: 2020-12-07 16:48:31

Keywords: sparse6 canonical

As the title says. Getting a `canonical_label` graph and then getting its `sparse6_string` actually returns the sparse6 encoding of the original graph.

See the following illustrative code:


```sage
sage: G = Graph([(0,1),(1,2),(2,3),(3,0),(0,2)])
sage: H = Graph([(0,1),(1,2),(2,3),(3,0),(1,3)]) # Last edge is different
sage: G == H
False
sage: G.is_isomorphic(H)
True
sage: G.sparse6_string()
':CcKV'
sage: H.sparse6_string()
':Cd`V'

# Trying to get the encoding of a canonical version of the graph does not work es expected
sage: G_ = G.canonical_label()
sage: H_ = H.canonical_label()
sage: G_ == H_ # The canonical versions are equal
True
sage: G_.sparse6_string() # The sparse6 encodings are NOT equal
':CcKV'
sage: H_.sparse6_string() # They are however equal to the ones of their respective original graphs
':Cd`V'

# This of course leads to the problem that loading a graph from the representation does not yield the original graph
# Works fine for the original graph
sage: Graph(G.sparse6_string(), loops=False, multiedges=False) == G
True
# Does not work for the canonical version
sage: Graph(G.sparse6_string(), loops=False, multiedges=False) == G
True
# The encoding of G_ is indeed the one of G
sage: Graph(G_.sparse6_string(), loops=False, multiedges=False) == G
True

# Explicitly creating a new graph works fine and returns the same encodings
sage: G__ = Graph(G.canonical_label().edges())
sage: H__ = Graph(H.canonical_label().edges())
sage: G__.sparse6_string()
':CoKI'
sage: H__.sparse6_string()
':CoKI'
```



---

Comment by dcoudert created at 2020-12-07 22:56:21

Changing status from new to needs_review.


---

Comment by dcoudert created at 2020-12-07 22:56:21

Good catch. We have a different behavior with `graph6_string`

```sage
sage: G = Graph([(0,1),(1,2),(2,3),(3,0),(0,2)])                                                                                    
sage: H = Graph([(0,1),(1,2),(2,3),(3,0),(1,3)])                                                                                    
sage: G == H                                                                                                                        
False
sage: G.is_isomorphic(H)                                                                                                            
True
sage: G.graph6_string()                                                                                                             
'C|'
sage: H.graph6_string()                                                                                                             
'Cn'
sage: G_ = G.canonical_label()                                                                                                      
sage: H_ = H.canonical_label()                                                                                                      
sage: G_ == H_                                                                                                                      
True
sage: G_.graph6_string()                                                                                                            
'C^'
sage: H_.graph6_string()                                                                                                            
'C^'
```


The reason is that `graph6_string` tries (actually, method `_bit_vector`) first to sort vertices and this is not done for `sparse6_string`.
Actually, before the switch to Python 3, vertices where most of the time sorted, but this is no longer possible (cannot sort objects of different types). 

With this patch, we get the behavior you expect

```sage
sage: G = Graph([(0,1),(1,2),(2,3),(3,0),(0,2)])                                                                                    
sage: H = Graph([(0,1),(1,2),(2,3),(3,0),(1,3)])                                                                                    
sage: G == H                                                                                                                        
False
sage: G.is_isomorphic(H)                                                                                                            
True
sage: G.sparse6_string()                                                                                                            
':CcKV'
sage: H.sparse6_string()                                                                                                            
':Cd`V'
sage: G_ = G.canonical_label()                                                                                                      
sage: H_ = H.canonical_label()                                                                                                      
sage: G_ == H_                                                                                                                      
True
sage: G_.sparse6_string()                                                                                                           
':CoKI'
sage: H_.sparse6_string()                                                                                                           
':CoKI'
```

----
New commits:


---

Comment by @jonasc created at 2020-12-08 16:42:54

Thanks for the quick reply and fix! I did, indeed, observe that `graph6_string` worked as expected but somehow did not include this information in my reportâ€¦


---

Comment by dcoudert created at 2020-12-08 17:13:47

If you are ok with this solution and that you are confident enough, you can set this ticket to positive review (add your full name in reviewer field). If you don't feel confident enough to do so, I will call for help to review the ticket.


---

Comment by tmonteil created at 2020-12-09 21:31:16

Changing status from needs_review to needs_work.


---

Comment by tmonteil created at 2020-12-09 21:31:16

I am not sure whether the fix is the right one, however using bare `except` is not recommended (imagine what happens if the user makes a keyboard interrupt).


---

Comment by git created at 2020-12-09 22:52:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2020-12-09 22:54:30

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2020-12-09 22:54:30

I don't have a better fix in mind, so I added `TypeError` in both `sparse6_string` and `graph6_string`.


---

Comment by tmonteil created at 2020-12-10 08:46:47

OK, assuming the fix in #27695 was correct, this one should be too.


---

Comment by tmonteil created at 2020-12-10 08:46:47

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-12-14 23:53:05

Resolution: fixed
