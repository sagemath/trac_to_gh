# Issue 30789: sparse6 encoding for canonical graphs returns encoding of original graph

archive/issues_030789.json:
```json
{
    "body": "Keywords: sparse6 canonical\n\nAs the title says. Getting a `canonical_label` graph and then getting its `sparse6_string` actually returns the sparse6 encoding of the original graph.\n\nSee the following illustrative code:\n\n\n```sage\nsage: G = Graph([(0,1),(1,2),(2,3),(3,0),(0,2)])\nsage: H = Graph([(0,1),(1,2),(2,3),(3,0),(1,3)]) # Last edge is different\nsage: G == H\nFalse\nsage: G.is_isomorphic(H)\nTrue\nsage: G.sparse6_string()\n':CcKV'\nsage: H.sparse6_string()\n':Cd`V'\n\n# Trying to get the encoding of a canonical version of the graph does not work es expected\nsage: G_ = G.canonical_label()\nsage: H_ = H.canonical_label()\nsage: G_ == H_ # The canonical versions are equal\nTrue\nsage: G_.sparse6_string() # The sparse6 encodings are NOT equal\n':CcKV'\nsage: H_.sparse6_string() # They are however equal to the ones of their respective original graphs\n':Cd`V'\n\n# This of course leads to the problem that loading a graph from the representation does not yield the original graph\n# Works fine for the original graph\nsage: Graph(G.sparse6_string(), loops=False, multiedges=False) == G\nTrue\n# Does not work for the canonical version\nsage: Graph(G.sparse6_string(), loops=False, multiedges=False) == G\nTrue\n# The encoding of G_ is indeed the one of G\nsage: Graph(G_.sparse6_string(), loops=False, multiedges=False) == G\nTrue\n\n# Explicitly creating a new graph works fine and returns the same encodings\nsage: G__ = Graph(G.canonical_label().edges())\nsage: H__ = Graph(H.canonical_label().edges())\nsage: G__.sparse6_string()\n':CoKI'\nsage: H__.sparse6_string()\n':CoKI'\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/31026\n\n",
    "created_at": "2020-12-07T16:48:31Z",
    "labels": [
        "graph theory",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "sparse6 encoding for canonical graphs returns encoding of original graph",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30789",
    "user": "@jonasc"
}
```
Keywords: sparse6 canonical

As the title says. Getting a `canonical_label` graph and then getting its `sparse6_string` actually returns the sparse6 encoding of the original graph.

See the following illustrative code:


```sage
sage: G = Graph([(0,1),(1,2),(2,3),(3,0),(0,2)])
sage: H = Graph([(0,1),(1,2),(2,3),(3,0),(1,3)]) # Last edge is different
sage: G == H
False
sage: G.is_isomorphic(H)
True
sage: G.sparse6_string()
':CcKV'
sage: H.sparse6_string()
':Cd`V'

# Trying to get the encoding of a canonical version of the graph does not work es expected
sage: G_ = G.canonical_label()
sage: H_ = H.canonical_label()
sage: G_ == H_ # The canonical versions are equal
True
sage: G_.sparse6_string() # The sparse6 encodings are NOT equal
':CcKV'
sage: H_.sparse6_string() # They are however equal to the ones of their respective original graphs
':Cd`V'

# This of course leads to the problem that loading a graph from the representation does not yield the original graph
# Works fine for the original graph
sage: Graph(G.sparse6_string(), loops=False, multiedges=False) == G
True
# Does not work for the canonical version
sage: Graph(G.sparse6_string(), loops=False, multiedges=False) == G
True
# The encoding of G_ is indeed the one of G
sage: Graph(G_.sparse6_string(), loops=False, multiedges=False) == G
True

# Explicitly creating a new graph works fine and returns the same encodings
sage: G__ = Graph(G.canonical_label().edges())
sage: H__ = Graph(H.canonical_label().edges())
sage: G__.sparse6_string()
':CoKI'
sage: H__.sparse6_string()
':CoKI'
```


Issue created by migration from https://trac.sagemath.org/ticket/31026





---

archive/issue_comments_440176.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-12-07T22:56:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30789#issuecomment-440176",
    "user": "dcoudert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_440177.json:
```json
{
    "body": "Good catch. We have a different behavior with `graph6_string`\n\n```sage\nsage: G = Graph([(0,1),(1,2),(2,3),(3,0),(0,2)])                                                                                    \nsage: H = Graph([(0,1),(1,2),(2,3),(3,0),(1,3)])                                                                                    \nsage: G == H                                                                                                                        \nFalse\nsage: G.is_isomorphic(H)                                                                                                            \nTrue\nsage: G.graph6_string()                                                                                                             \n'C|'\nsage: H.graph6_string()                                                                                                             \n'Cn'\nsage: G_ = G.canonical_label()                                                                                                      \nsage: H_ = H.canonical_label()                                                                                                      \nsage: G_ == H_                                                                                                                      \nTrue\nsage: G_.graph6_string()                                                                                                            \n'C^'\nsage: H_.graph6_string()                                                                                                            \n'C^'\n```\n\n\nThe reason is that `graph6_string` tries (actually, method `_bit_vector`) first to sort vertices and this is not done for `sparse6_string`.\nActually, before the switch to Python 3, vertices where most of the time sorted, but this is no longer possible (cannot sort objects of different types). \n\nWith this patch, we get the behavior you expect\n\n```sage\nsage: G = Graph([(0,1),(1,2),(2,3),(3,0),(0,2)])                                                                                    \nsage: H = Graph([(0,1),(1,2),(2,3),(3,0),(1,3)])                                                                                    \nsage: G == H                                                                                                                        \nFalse\nsage: G.is_isomorphic(H)                                                                                                            \nTrue\nsage: G.sparse6_string()                                                                                                            \n':CcKV'\nsage: H.sparse6_string()                                                                                                            \n':Cd`V'\nsage: G_ = G.canonical_label()                                                                                                      \nsage: H_ = H.canonical_label()                                                                                                      \nsage: G_ == H_                                                                                                                      \nTrue\nsage: G_.sparse6_string()                                                                                                           \n':CoKI'\nsage: H_.sparse6_string()                                                                                                           \n':CoKI'\n```\n\n----\nNew commits:",
    "created_at": "2020-12-07T22:56:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30789#issuecomment-440177",
    "user": "dcoudert"
}
```

Good catch. We have a different behavior with `graph6_string`

```sage
sage: G = Graph([(0,1),(1,2),(2,3),(3,0),(0,2)])                                                                                    
sage: H = Graph([(0,1),(1,2),(2,3),(3,0),(1,3)])                                                                                    
sage: G == H                                                                                                                        
False
sage: G.is_isomorphic(H)                                                                                                            
True
sage: G.graph6_string()                                                                                                             
'C|'
sage: H.graph6_string()                                                                                                             
'Cn'
sage: G_ = G.canonical_label()                                                                                                      
sage: H_ = H.canonical_label()                                                                                                      
sage: G_ == H_                                                                                                                      
True
sage: G_.graph6_string()                                                                                                            
'C^'
sage: H_.graph6_string()                                                                                                            
'C^'
```


The reason is that `graph6_string` tries (actually, method `_bit_vector`) first to sort vertices and this is not done for `sparse6_string`.
Actually, before the switch to Python 3, vertices where most of the time sorted, but this is no longer possible (cannot sort objects of different types). 

With this patch, we get the behavior you expect

```sage
sage: G = Graph([(0,1),(1,2),(2,3),(3,0),(0,2)])                                                                                    
sage: H = Graph([(0,1),(1,2),(2,3),(3,0),(1,3)])                                                                                    
sage: G == H                                                                                                                        
False
sage: G.is_isomorphic(H)                                                                                                            
True
sage: G.sparse6_string()                                                                                                            
':CcKV'
sage: H.sparse6_string()                                                                                                            
':Cd`V'
sage: G_ = G.canonical_label()                                                                                                      
sage: H_ = H.canonical_label()                                                                                                      
sage: G_ == H_                                                                                                                      
True
sage: G_.sparse6_string()                                                                                                           
':CoKI'
sage: H_.sparse6_string()                                                                                                           
':CoKI'
```

----
New commits:



---

archive/issue_comments_440178.json:
```json
{
    "body": "Thanks for the quick reply and fix! I did, indeed, observe that `graph6_string` worked as expected but somehow did not include this information in my report\u2026",
    "created_at": "2020-12-08T16:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30789#issuecomment-440178",
    "user": "@jonasc"
}
```

Thanks for the quick reply and fix! I did, indeed, observe that `graph6_string` worked as expected but somehow did not include this information in my report…



---

archive/issue_comments_440179.json:
```json
{
    "body": "If you are ok with this solution and that you are confident enough, you can set this ticket to positive review (add your full name in reviewer field). If you don't feel confident enough to do so, I will call for help to review the ticket.",
    "created_at": "2020-12-08T17:13:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30789#issuecomment-440179",
    "user": "dcoudert"
}
```

If you are ok with this solution and that you are confident enough, you can set this ticket to positive review (add your full name in reviewer field). If you don't feel confident enough to do so, I will call for help to review the ticket.



---

archive/issue_comments_440180.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-12-09T21:31:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30789#issuecomment-440180",
    "user": "tmonteil"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_440181.json:
```json
{
    "body": "I am not sure whether the fix is the right one, however using bare `except` is not recommended (imagine what happens if the user makes a keyboard interrupt).",
    "created_at": "2020-12-09T21:31:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30789#issuecomment-440181",
    "user": "tmonteil"
}
```

I am not sure whether the fix is the right one, however using bare `except` is not recommended (imagine what happens if the user makes a keyboard interrupt).



---

archive/issue_comments_440182.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-09T22:52:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30789#issuecomment-440182",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_440183.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-12-09T22:54:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30789#issuecomment-440183",
    "user": "dcoudert"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_440184.json:
```json
{
    "body": "I don't have a better fix in mind, so I added `TypeError` in both `sparse6_string` and `graph6_string`.",
    "created_at": "2020-12-09T22:54:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30789#issuecomment-440184",
    "user": "dcoudert"
}
```

I don't have a better fix in mind, so I added `TypeError` in both `sparse6_string` and `graph6_string`.



---

archive/issue_comments_440185.json:
```json
{
    "body": "OK, assuming the fix in #27695 was correct, this one should be too.",
    "created_at": "2020-12-10T08:46:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30789#issuecomment-440185",
    "user": "tmonteil"
}
```

OK, assuming the fix in #27695 was correct, this one should be too.



---

archive/issue_comments_440186.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-12-10T08:46:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30789#issuecomment-440186",
    "user": "tmonteil"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_440187.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-12-14T23:53:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30789",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30789#issuecomment-440187",
    "user": "vbraun"
}
```

Resolution: fixed
