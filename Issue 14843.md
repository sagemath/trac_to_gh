# Issue 14843: Build also wide version of ncurses

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2013-08-22 15:17:42

CC:  jpflori

Curses optionally supports wchar versions, the library will be called `libncursesw.so`. Python wants the wide version for its curses module, so we should build it as well.


---

Comment by vbraun created at 2013-08-22 15:24:41

It seems that Python will fall back to narrow curses if necessary. But if the distribution provides a wide curses then it will be preferred over the narrow one. On my Fedora 19 install, this leads to (with the old ncurses spkg):

```
building '_curses' extension
gcc -pthread -fPIC -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -I/home/vbraun/opt/sage-5.12.beta3/local/include -I. -IInclude -I./Include -I/usr/local/include -I/home/vbraun/opt/sage-5.12.beta3/spkg/build/python-2.7.5.p1/src/Include -I/home/vbraun/opt/sage-5.12.beta3/spkg/build/python-2.7.5.p1/src -c /home/vbraun/opt/sage-5.12.beta3/spkg/build/python-2.7.5.p1/src/Modules/_cursesmodule.c -o build/temp.linux-x86_64-2.7/home/vbraun/opt/sage-5.12.beta3/spkg/build/python-2.7.5.p1/src/Modules/_cursesmodule.o
gcc -pthread -shared -L/home/vbraun/opt/sage-5.12.beta3/local/lib -L/home/vbraun/opt/sage-5.12.beta3/local/lib build/temp.linux-x86_64-2.7/home/vbraun/opt/sage-5.12.beta3/spkg/build/python-2.7.5.p1/src/Modules/_cursesmodule.o -L/home/vbraun/opt/sage-5.12.beta3/local/lib -L/usr/local/lib -L. -lncursesw -lpython2.7 -o build/lib.linux-x86_64-2.7/_curses.so
*** WARNING: renaming "_curses" since importing it failed: /lib64/libncursesw.so.5: undefined symbol: _nc_putchar
```

and it will succeed with the new spkg.


---

Comment by vbraun created at 2013-10-10 10:50:09

Changing status from new to needs_review.


---

Comment by jpflori created at 2013-10-21 11:43:18

Just a few random remarks: why use [This is the Trac macro * * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros# -macro) rather than plain [ ] for testing?
Could you mention the ticket number in SPKG.txt?
I know it may seem overkill but it always nice to have all info available at once...


---

Comment by jpflori created at 2013-10-21 11:44:10

Otherwise looks fine.
I'll still have to work on top of that to solve the Solaris problems I reported at #15268 (disable ada and use lmonade fix for CPPFLAGS vs CFLAGS).


---

Comment by vbraun created at 2013-10-21 11:58:36

Replying to [comment:4 jpflori]:
> Could you mention the ticket number in SPKG.txt?

IMHO we should delete the duplicate changelog keeping as soon as we have a working git version. Its just a stupid waste of developer time.


---

Comment by vbraun created at 2013-10-21 12:06:30

Updated spkg at same place


---

Comment by jpflori created at 2013-10-22 22:55:48

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-10-23 14:51:44

`$SAGE_LOCAL/bin/.hgignore` needs to be updated:

```
$ hg status
? ncursesw5-config
```



---

Comment by jdemeyer created at 2013-10-23 14:51:44

Changing status from positive_review to needs_work.


---

Attachment

update hgignore


---

Comment by jpflori created at 2013-10-29 21:40:13

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2013-10-29 21:40:13

Apply [attachment:trac_15080.patch]


---

Comment by jdemeyer created at 2013-11-01 16:46:38

`.hgignore` is good.


---

Comment by jdemeyer created at 2013-11-01 16:46:38

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-11-04 07:22:58

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-11-04 07:22:58

This fails to build on Solaris SPARC due to invalid `CFLAGS`:

```
/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.13.beta3/local/bin/g++ -I../c++ -I../include -I../../c++ -DHAVE_CONFIG_H   -D__EXTENSIONS__ -D_XOPEN_SOURCE_EXTENDED -D_FILE_OFFSET_BITS=64  -DNDEBUG -I. -I../include -I../../c++/../include -I/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.13.beta3/local/include  -fPIC -c ../../c++/cursesf.cc -o ../obj_s/cursesf.o
/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.13.beta3/local/bin/g++ -I../c++ -I../include -I../../c++ -DHAVE_CONFIG_H   -D__EXTENSIONS__ -D_XOPEN_SOURCE_EXTENDED -D_FILE_OFFSET_BITS=64  -DNDEBUG -I. -I../include -I../../c++/../include -I/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.13.beta3/local/include  -fPIC -c ../../c++/cursesm.cc -o ../obj_s/cursesm.o
In file included from /home/buildbot/build/sage/mark-1/mark_full/build/sage-5.13.beta3/local/lib/gcc/sparc-sun-solaris2.10/4.7.3/include-fixed/iso/stdlib_iso.h:39:0,
                 from /usr/include/stdlib.h:18,
                 from ../../c++/internal.h:53,
                 from ../../c++/cursesf.cc:34:
/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.13.beta3/local/lib/gcc/sparc-sun-solaris2.10/4.7.3/include-fixed/sys/feature_tests.h:341:2: error: #error "Compiler or options invalid for pre-UNIX 03 X/Open applications 	and pre-2001 POSIX applications"
```



---

Comment by jpflori created at 2013-11-04 08:54:08

Hum, sure, I forgot about #15268 which deals with my ada issue and the xopen_source_extended one.
I'll provide an updated spkg there.


---

Comment by jpflori created at 2013-11-04 10:57:18

Spkg uploaded at #15268, based on the one here.


---

Comment by vbraun created at 2013-11-04 17:10:09

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2013-11-04 17:10:09

So let's close this ticket, further work at #15268.


---

Comment by jdemeyer created at 2013-11-06 12:55:43

Resolution: duplicate


---

Comment by jpflori created at 2013-11-06 22:14:26

Volker: On your Red Hat, with what got readline linked?
I'm currently looking into Python's install scripts and it seems fishy Python ended up wanting to uses ncursesw on top of ncurses unless readline was linked to it already.


---

Comment by jpflori created at 2013-11-06 22:15:21

Or not if readline was only linked to tinfo or even to nothing as seems to be the case on Red Hat...


---

Comment by jpflori created at 2013-11-06 22:19:45

Ok think I got it, more work for me.
As a consequence the ticket here should not really be necessary anymore but won't hurt...


---

Comment by vbraun created at 2013-11-06 23:06:49

For the record, readline is just linking to the standard ncurses on Fedora 19. It is only the Python curses module that links in ncursesw:

```
(sage-sh) vbraun`@`localhost:sage-5.12$ ldd local/lib/python2.7/lib-dynload/_curses.so
	linux-vdso.so.1 =>  (0x00007fff433a7000)
	libncursesw.so.5 => /home/vbraun/Code/sage/local/lib/libncursesw.so.5 (0x00007f5842950000)
	libpython2.7.so.1.0 => /home/vbraun/Code/sage/local/lib/libpython2.7.so.1.0 (0x00007f5842547000)
	libpthread.so.0 => /lib64/libpthread.so.0 (0x00007f58422fe000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f5841f3d000)
	libtinfow.so.5 => /home/vbraun/Code/sage/local/lib/libtinfow.so.5 (0x00007f5841d09000)
	libdl.so.2 => /lib64/libdl.so.2 (0x00007f5841b05000)
	libutil.so.1 => /lib64/libutil.so.1 (0x00007f5841902000)
	libm.so.6 => /lib64/libm.so.6 (0x00007f58415ff000)
	/lib64/ld-linux-x86-64.so.2 (0x0000003895000000)
(sage-sh) vbraun`@`localhost:sage-5.12$ ldd local/lib/libreadline.so
	linux-vdso.so.1 =>  (0x00007fff75dd2000)
	libtinfo.so.5 => /home/vbraun/opt/sage-5.12/local/lib/libtinfo.so.5 (0x00007faefecae000)
	libc.so.6 => /lib64/libc.so.6 (0x00007faefe8bf000)
	/lib64/ld-linux-x86-64.so.2 (0x0000003895000000)
(sage-sh) vbraun`@`localhost:sage-5.12$ ldd local/lib/libtinfo.so
	linux-vdso.so.1 =>  (0x00007fff1d969000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f9872a87000)
	/lib64/ld-linux-x86-64.so.2 (0x0000003895000000)
```



---

Comment by jpflori created at 2013-11-07 10:05:19

Can you ldd /lib64/libncursew... please?


---

Comment by jpflori created at 2013-11-07 10:14:59

For future ref, and so that i don't waste 5 minutes each time looking for it: http://bugs.python.org/issue7384.


---

Comment by vbraun created at 2013-11-07 22:30:16


```
$ cat /lib64/libncursesw.so
INPUT(libncursesw.so.5 -ltinfo)

$ ldd /lib64/libncursesw.so.5
	linux-vdso.so.1 =>  (0x00007fff817fe000)
	libc.so.6 => /lib64/libc.so.6 (0x0000003895800000)
	libdl.so.2 => /lib64/libdl.so.2 (0x0000003895c00000)
	libtinfo.so.5 => /lib64/libtinfo.so.5 (0x00000038adc00000)
	/lib64/ld-linux-x86-64.so.2 (0x0000003895000000)
```

