# Issue 12792: multiply matrix of matrices by a scalar: boom

Issue created by migration from https://trac.sagemath.org/ticket/12964

Original creator: jhpalmieri

Original creation time: 2012-05-17 17:42:39

Assignee: jason, was

From [stackoverflow](http://stackoverflow.com/questions/8691546/multiply-matrix-of-matrices-by-a-scalar-in-sage): Define `a` to be a matrix whose entries are matrices, and multiply `a` by a scalar:

```
a = matrix([[matrix([[ 1,  2], [ 3,  4]]),
             matrix([[ 5,  6], [ 7,  8]])],
            [matrix([[ 9, 10], [11, 12]]),
             matrix([[13, 14], [15, 16]])]])
3 * a
```

This results in the following error message:

```
TypeError: unsupported operand parent(s) for '*':
           'Full MatrixSpace of 2 by 2 dense matrices over Integer Ring' and
           'Full MatrixSpace of 2 by 2 dense matrices over Integer Ring'
```

which is clearly nonsense. Multiplying `a` by, for example, `3 * identity_matrix(2)` works, by the way.


---

Attachment


---

Comment by mhansen created at 2012-05-20 01:24:51

This happens because matrices don't really use `_mul_`.  The end result is less efficient than it could be (since you're doing matrix multiplications for each entry); however, I think this would be for another ticket.


---

Comment by mhansen created at 2012-05-20 01:25:06

Changing status from new to needs_review.


---

Comment by mhansen created at 2012-05-20 02:43:34

Another option would be to define `_mul_` on matrices to do `_matrix_times_matrix_`.


---

Attachment

apply just this patch


---

Comment by robertwb created at 2012-05-29 06:04:26

My first thought when reading this patch (before even reading your comments) was also to add a _mul_ method on matrices. _rmul_ should always be safe to call with identical ring elements, and this assumption is used in many other places.


---

Comment by jhpalmieri created at 2012-06-12 20:38:09

Robert: after your patch, regarding `__mul__` and `_mul_` for matrices in `element.pyx`: what are their roles? In what order do they get called?


---

Comment by mhansen created at 2012-06-12 20:53:03

The matrix code (changed in the first patch) assumed that you can always call `_mul_` on the entries of the matrix in order to do multiplication.  However, this is not the case if the entries of the matrix are in fact matrices themselves since they bypass the coercion system, implement `__mul__` directly (which calls `_matrix_times_matrix_`), and don't implement `_mul_`.  Robert's patch just implements `_mul_` to do "what it should" in case there are other places that assume that you can always use `_mul_` directly.

Positive review for Robert's patch.

Apply only 12964-fix-mul.patch .


---

Comment by mhansen created at 2012-06-12 20:53:03

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-06-23 21:44:40

Resolution: fixed


---

Comment by robertwb created at 2012-06-24 00:57:19

Thanks, Mike, for revewing this. 

Replying to [comment:5 jhpalmieri]:
> Robert: after your patch, regarding `__mul__` and `_mul_` for matrices in `element.pyx`: what are their roles? In what order do they get called?

To close the loop on this, `a.__mul__(b)` is called by Python when a * b is encountered. `a._mul_(b)` is called by the coercion model when `parent(a) is parent(b)` to actually do the arithmetic. Full details at http://www.sagemath.org/doc/reference/coercion.html
