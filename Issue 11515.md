# Issue 11515: Sanitize `sage-env`

Issue created by migration from https://trac.sagemath.org/ticket/11687

Original creator: leif

Original creation time: 2011-08-14 06:18:37

Assignee: leif

CC:  kini

Keywords: BUILD sage-spkg pkg-config .pc pkgconfig PKG_CONFIG_PATH SAGE_PATH Cygwin environment variables

There are currently a couple of issues with `sage-env`; approximately ordered by importance:

 * `BUILD` (used by `sage-spkg`) isn't exported, which wasn't really a problem until we started to (fully) source `sage-env` only once (#10469, cf. #11021 and #4949 for the impact on `sage-spkg`).
 * `PKG_CONFIG_PATH` is only changed if it is empty / undefined. We have to _prepend_ `$SAGE_ROOT/local/lib/pkgconfig` in case it is not. (Cf. #11681, #11686; #10202).
 * The definition of `UNAME` (currently on line 284) has to be moved up, preferably right after `PATH` etc. get set / modified (currently around line 135), and `$UNAME` should be used consistently.
 * The following (starting on line 348) has also to be moved up, since we return from `sage-env` earlier above (line 238) in case `"$1" = "-short"`:

```sh
if [ "$UNAME" = "CYGWIN" ]; then
    PATH="$PATH:$SAGE_LOCAL/lib" && export PATH
fi
```

   Moreover, I think the directory should be *pre*pendend to the path, but perhaps _after_ `$SAGE_ROOT/local/bin`.
 * `SAGE_PATH` (followed by a colon) is prepended to `PYTHONPATH` even if it is empty / undefined. Some programs interpret this as if the current working directory ("`.`") was prepended. 

   It also shouldn't be set to (or contain) "`.`", since this causes trouble with `easy_install` / distutils / `.pth` files. (Cf. #10192, #10176; the former has a patch to remove it [at least] in `spkg-install`, which isn't necessarily sufficient.).
 * We should save the original, unmodified `PATH` (to `SAGE_ORIG_PATH`), analoguous to `SAGE_ORIG_LD_LIBRARY_PATH` etc., and perhaps record this in `SAGE_ORIG_PATH_SET`. This should also be done close to the top, of course before modifying `PATH`. (#10202 also suggests / introduces this.)
 * There's partially useless code like

```sh
if [ "$LDFLAGS" = "" ]; then
    LDFLAGS=""          && export LDFLAGS
fi
```

 * If `CFLAGS` (as specified by the user) are non-empty, we could append `-fno-strict-aliasing`, since Cython code will break if `CFLAGS` are set but don't contain this, but this should better be done where Cython code is compiled, i.e. in `devel/sage/setup.py` and `sage.misc.cython`. 

   Note that even `export CFLAGS=""` causes distutils to drop the defaults, which do contain `-fno-strict-aliasing` (which could be solved by `unset`ting `CFLAGS` if they are empty). 

   The result of such broken compiled Cython code shows up as weird import errors when starting Sage, which a user will hardly relate to a probably empty environment variable.
 * _All_ variables that are expected to be either "`yes`", "`no`" or empty / unset should be checked for [in]valid settings, and perhaps normalized (i.e., for example set to "`no`" in case they're empty or not set). 

   We currently only do this for `SAGE64`:

```sh
if [ "$SAGE64" = "" ]; then
    SAGE64="no"
fi 

if [ "$SAGE64" != "yes" -a "$SAGE64" != "no" ]; then
    echo "The environment variable SAGE64 (=$SAGE64) must be either unset, yes or no."
    return 1
fi
```

 * `sage-env` has a bug w.r.t. "guessing" the value `SAGE_ROOT` should be set to, which leads to annoying or confusing warnings "`Attempted to overwrite SAGE_ROOT ...`", cf. comments at #11021.
 * The _default_ for `CFLAG64` (`-m64`) and similar should be set in `sage-env`, not each and every `spkg-install`.
 * We could also source `~/.sagerc` (or `$DOT_SAGE/[.]sagerc`), if one of it exists, at some point in `sage-env`, to allow setting up typical variables (like e.g. `SAGE64`, perhaps depending on `hostname`, and other Sage-specific variables) automatically in a flexible and generic way.

(Line numbers as of Sage 4.7.1.rc2.)

----

We should IMHO also save the original settings of `CC`, `CFLAGS`, `LD`, `LDFLAGS`, `MAKE` etc., since it is otherwise impossible for scripts (like the `spkg-install`s) to determine whether or which parts of the current settings were made by Sage, and which originate from the user (intentionally or not, e.g. from system-wide or default `.*rc` files).

A better approach would be to have and use `SAGE_CC` etc. instead, but this would require changes to all spkgs and other build-related files.

----

Some of the rather minor issues can be fixed on their own / follow-up tickets, but it would be odd to have a dozen "concurring" tickets all modifying `sage-env` at the same time.


---

Comment by leif created at 2011-08-14 08:42:32

We could also define (and export) `PKG_CONFIG_TOP_BUILD_DIR`, namely to `${SAGE_ROOT}/local`, and use

```
prefix=${pc_top_builddir}
```

or, a bit more flexible, define it to just `${SAGE_ROOT}` and use

```
prefix=${pc_top_builddir}/local
```

in all `pkg-config` (`*.pc`) files, which avoids wrapping `pkg-config` just to add `--define-variable=SAGE_ROOT="${SAGE_ROOT}"` to each invocation.

This is even safer than using

```
prefix=$${SAGE_ROOT}/local
```

though I haven't [yet] encountered problems with the latter. (The `$$` has the same meaning as in Makefiles, i.e. escapes the `$` such that the resulting environment variable will be interpreted -- or substituted -- later, by the shell.)


---

Comment by jhpalmieri created at 2011-08-14 15:08:32

Since there is already a lot of progress on #11021, can we finish that one off and have this ticket depend on that one?


---

Comment by leif created at 2011-08-14 15:54:58

Replying to [comment:4 jhpalmieri]:
> Since there is already a lot of progress on #11021, can we finish that one off and have this ticket depend on that one?

Currently sorting out what to fix where and in which order.

#11021 doesn't change much, and I intended to attach a couple of small patches to `sage-env` here for independent issues, so that they should all apply in almost random order, with just line numbers changing.

We can then leave out individual patches here in case other tickets already fix things.

----

I'll hopefully return to #11021 today and [try to] finish it, though I originally planned other things... ;-)


---

Comment by leif created at 2011-08-14 17:39:56

Replying to [comment:6 leif]:
> Replying to [comment:4 jhpalmieri]:
> > Since there is already a lot of progress on #11021, can we finish that one off and have this ticket depend on that one?
> 
> Currently sorting out what to fix where and in which order.

I think I'll also add `pkg-config`-related code _there_ (to `sage-spkg`, right before `sage-make_relative` is called).


---

Comment by leif created at 2011-08-31 18:19:59

Replying to [ticket:11687 leif]:
>  * `BUILD` (used by `sage-spkg`) isn't exported, which wasn't really a problem until we started to (fully) source `sage-env` only once (#10469, cf. #11021 and #4949 for the impact on `sage-spkg`).

#11765 adds a note on the necessity to always _export_ variables in `sage-env`.




>  * `PKG_CONFIG_PATH` is only changed if it is empty / undefined. We have to _prepend_ `$SAGE_ROOT/local/lib/pkgconfig` in case it is not. (Cf. #11681, #11686; #10202).

This is now fixed by a small patch at #11765, currently needing review.


---

Comment by jdemeyer created at 2012-03-22 10:41:44

Removed some points which is no longer relevant.


---

Comment by leif created at 2012-03-22 11:32:58

Replying to [comment:9 jdemeyer]:
> Removed some points which is no longer relevant.

I guess you meant "are". ;-)

Progress!  (Although I'd just add "Fixed by #.....", so one immediately sees where something got fixed and whether the corresponding ticket is already merged, e.g. if a problem reappears.)


---

Comment by jdemeyer created at 2013-02-08 14:21:40

Changing priority from critical to minor.


---

Comment by jdemeyer created at 2014-01-09 10:25:06

See #15652 for the `-fno-strict-aliasing` issue.


---

Comment by chapoton created at 2014-10-21 12:57:42

Here is a first proposal, gathering the UNAME setting in one single place.
----
New commits:


---

Comment by chapoton created at 2014-10-21 12:57:42

Changing status from new to needs_review.


---

Comment by git created at 2014-10-21 12:59:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-12-09 20:52:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-06-17 14:42:59

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-06-18 17:57:54

Resolution: fixed
