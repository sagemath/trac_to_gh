# Issue 13024: GL(n, GF(q)).random_element() is way too slow for what it does

archive/issues_013024.json:
```json
{
    "body": "Assignee: joyner\n\nCC:  malb dimpase\n\nKeywords: matrix group, finite field, random element\n\nGL(32, GF(2)).random_element() takes more than 10s, which is ridiculous.\n\nProposed solution : use simple rejection sampling (i.e. generate a random matrix, check if it invertible, if not try again). The result is uniformly distributed amongst invertible matrices.\n\nBefore patch:\n\n```\nsage: %time GL(64, GF(2)).random_element() \n5 loops, best of 3: 15.5 s per loop\n```\n\n\nAfter patch :\n\n```\nsage: %timeit GL(64, GF(2)).random_element()\n625 loops, best of 3: 929 \u00b5s per loop\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/13196\n\n",
    "created_at": "2012-07-03T15:31:17Z",
    "labels": [
        "group theory",
        "trivial",
        "enhancement"
    ],
    "title": "GL(n, GF(q)).random_element() is way too slow for what it does",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13024",
    "user": "Bouillaguet"
}
```
Assignee: joyner

CC:  malb dimpase

Keywords: matrix group, finite field, random element

GL(32, GF(2)).random_element() takes more than 10s, which is ridiculous.

Proposed solution : use simple rejection sampling (i.e. generate a random matrix, check if it invertible, if not try again). The result is uniformly distributed amongst invertible matrices.

Before patch:

```
sage: %time GL(64, GF(2)).random_element() 
5 loops, best of 3: 15.5 s per loop
```


After patch :

```
sage: %timeit GL(64, GF(2)).random_element()
625 loops, best of 3: 929 µs per loop
```


Issue created by migration from https://trac.sagemath.org/ticket/13196





---

archive/issue_comments_157531.json:
```json
{
    "body": "OK, cool, where is the patch? \n:)",
    "created_at": "2012-07-03T15:33:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157531",
    "user": "dimpase"
}
```

OK, cool, where is the patch? 
:)



---

archive/issue_comments_157532.json:
```json
{
    "body": "Replying to [comment:1 dimpase]:\n> OK, cool, where is the patch? \n> :)\n\nSorry, it took me a while as I made a mistake (patched sage/groups/matrix_gps/matrix_group.py first instead of sage/groups/matrix_gps/general_linear.py, which is very wrong. The doctest caught it though....)",
    "created_at": "2012-07-03T15:55:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157532",
    "user": "Bouillaguet"
}
```

Replying to [comment:1 dimpase]:
> OK, cool, where is the patch? 
> :)

Sorry, it took me a while as I made a mistake (patched sage/groups/matrix_gps/matrix_group.py first instead of sage/groups/matrix_gps/general_linear.py, which is very wrong. The doctest caught it though....)



---

archive/issue_comments_157533.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-07-03T15:56:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157533",
    "user": "Bouillaguet"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_157534.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-07-03T16:01:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157534",
    "user": "dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_157535.json:
```json
{
    "body": "Could you add in the docstring that the probaility to get an invertible element is about 1/3, and so we expect to get the\nanswer in about 3 iterations ?",
    "created_at": "2012-07-03T16:01:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157535",
    "user": "dimpase"
}
```

Could you add in the docstring that the probaility to get an invertible element is about 1/3, and so we expect to get the
answer in about 3 iterations ?



---

archive/issue_comments_157536.json:
```json
{
    "body": "Replying to [comment:4 dimpase]:\n> Could you add in the docstring that the probaility to get an invertible element is about 1/3, and so we expect to get the\n> answer in about 3 iterations ?\n\nThis is not true. The expected number of iterations is asymptotically `1 + 1/q + 2/q^2 + 3/q^3 + 5/q^4 + 7/q^5 + ....` \n\nFor `GF(2)` you have 3.5 expected iterations, but for GF(127) you have 1.008 iterations..... So that asymptotically, the number of iterations is O(1), and the complexity of the procedure is `O(n^3)`, regardless of the size of the field.\n\nIs that OK with you ?",
    "created_at": "2012-07-03T17:03:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157536",
    "user": "Bouillaguet"
}
```

Replying to [comment:4 dimpase]:
> Could you add in the docstring that the probaility to get an invertible element is about 1/3, and so we expect to get the
> answer in about 3 iterations ?

This is not true. The expected number of iterations is asymptotically `1 + 1/q + 2/q^2 + 3/q^3 + 5/q^4 + 7/q^5 + ....` 

For `GF(2)` you have 3.5 expected iterations, but for GF(127) you have 1.008 iterations..... So that asymptotically, the number of iterations is O(1), and the complexity of the procedure is `O(n^3)`, regardless of the size of the field.

Is that OK with you ?



---

archive/issue_comments_157537.json:
```json
{
    "body": "Replying to [comment:5 Bouillaguet]:\n> Replying to [comment:4 dimpase]:\n> > Could you add in the docstring that the probaility to get an invertible element is about 1/3, and so we expect to get the\n> > answer in about 3 iterations ?\n> \n> This is not true. The expected number of iterations is asymptotically `1 + 1/q + 2/q^2 + 3/q^3 + 5/q^4 + 7/q^5 + ....` \n> \n> For `GF(2)` you have 3.5 expected iterations, but for GF(127) you have 1.008 iterations..... So that asymptotically, the number of iterations is O(1), and the complexity of the procedure is `O(n^3)`, regardless of the size of the field.\n> \n> Is that OK with you ?\n\nsure. I meant to say \"at most 3 iterations\".",
    "created_at": "2012-07-03T17:05:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157537",
    "user": "dimpase"
}
```

Replying to [comment:5 Bouillaguet]:
> Replying to [comment:4 dimpase]:
> > Could you add in the docstring that the probaility to get an invertible element is about 1/3, and so we expect to get the
> > answer in about 3 iterations ?
> 
> This is not true. The expected number of iterations is asymptotically `1 + 1/q + 2/q^2 + 3/q^3 + 5/q^4 + 7/q^5 + ....` 
> 
> For `GF(2)` you have 3.5 expected iterations, but for GF(127) you have 1.008 iterations..... So that asymptotically, the number of iterations is O(1), and the complexity of the procedure is `O(n^3)`, regardless of the size of the field.
> 
> Is that OK with you ?

sure. I meant to say "at most 3 iterations".



---

archive/issue_comments_157538.json:
```json
{
    "body": "I corrected the docstring :)",
    "created_at": "2012-07-03T17:15:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157538",
    "user": "Bouillaguet"
}
```

I corrected the docstring :)



---

archive/issue_comments_157539.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2012-07-03T17:25:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157539",
    "user": "dimpase"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_157540.json:
```json
{
    "body": "Good, positive review.",
    "created_at": "2012-07-03T17:25:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157540",
    "user": "dimpase"
}
```

Good, positive review.



---

archive/issue_comments_157541.json:
```json
{
    "body": "Modified patch to correct my own stupidity and improve performance a bit\n\n\n```\nsage: %timeit GL(64, GF(2)).random_element()\n625 loops, best of 3: 752 \u00b5s per loop\n```\n\n\n`@`dimpase: staying positively reviewed?",
    "created_at": "2012-07-03T21:11:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157541",
    "user": "Bouillaguet"
}
```

Modified patch to correct my own stupidity and improve performance a bit


```
sage: %timeit GL(64, GF(2)).random_element()
625 loops, best of 3: 752 µs per loop
```


`@`dimpase: staying positively reviewed?



---

archive/issue_comments_157542.json:
```json
{
    "body": "patchbot says (and I checked that manually) that the patch (the latest, or previous version, does not matter) causes doctest failures in `sage/algebras/group_algebra_new.py` and in `sage/algebras/group_algebra.py`. You can find the log by clicking on the patchbot icon (the, currently, yellow) disc near the top.",
    "created_at": "2012-07-04T03:41:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157542",
    "user": "dimpase"
}
```

patchbot says (and I checked that manually) that the patch (the latest, or previous version, does not matter) causes doctest failures in `sage/algebras/group_algebra_new.py` and in `sage/algebras/group_algebra.py`. You can find the log by clicking on the patchbot icon (the, currently, yellow) disc near the top.



---

archive/issue_comments_157543.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-07-04T03:41:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157543",
    "user": "dimpase"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_157544.json:
```json
{
    "body": "Attachment [gln_gfq_random.patch](tarball://root/attachments/some-uuid/ticket13196/gln_gfq_random.patch) by Bouillaguet created at 2012-07-04 08:43:35",
    "created_at": "2012-07-04T08:43:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157544",
    "user": "Bouillaguet"
}
```

Attachment [gln_gfq_random.patch](tarball://root/attachments/some-uuid/ticket13196/gln_gfq_random.patch) by Bouillaguet created at 2012-07-04 08:43:35



---

archive/issue_comments_157545.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-07-04T08:46:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157545",
    "user": "Bouillaguet"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_157546.json:
```json
{
    "body": "Patch updated. The bug was that my function returned a matrix, instead of returning an element of the group (basically, it returned g.matrix() instead of returning g). Fix: coerce the result into the group again. It takes a bit of time, and there is likely a workaround, but this is better than nothing.",
    "created_at": "2012-07-04T08:46:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157546",
    "user": "Bouillaguet"
}
```

Patch updated. The bug was that my function returned a matrix, instead of returning an element of the group (basically, it returned g.matrix() instead of returning g). Fix: coerce the result into the group again. It takes a bit of time, and there is likely a workaround, but this is better than nothing.



---

archive/issue_comments_157547.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-07-04T08:53:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157547",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_157548.json:
```json
{
    "body": "Replying to [comment:11 Bouillaguet]:\n> Patch updated. The bug was that my function returned a matrix, instead of returning an element of the group (basically, it returned g.matrix() instead of returning g). Fix: coerce the result into the group again. It takes a bit of time, and there is likely a workaround, but this is better than nothing.\n\nOK!",
    "created_at": "2012-07-04T08:53:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157548",
    "user": "dimpase"
}
```

Replying to [comment:11 Bouillaguet]:
> Patch updated. The bug was that my function returned a matrix, instead of returning an element of the group (basically, it returned g.matrix() instead of returning g). Fix: coerce the result into the group again. It takes a bit of time, and there is likely a workaround, but this is better than nothing.

OK!



---

archive/issue_comments_157549.json:
```json
{
    "body": "Attachment [trac_13196.improvement.patch](tarball://root/attachments/some-uuid/ticket13196/trac_13196.improvement.patch) by jlopez created at 2012-07-04 10:55:08\n\nSlight improvement",
    "created_at": "2012-07-04T10:55:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157549",
    "user": "jlopez"
}
```

Attachment [trac_13196.improvement.patch](tarball://root/attachments/some-uuid/ticket13196/trac_13196.improvement.patch) by jlopez created at 2012-07-04 10:55:08

Slight improvement



---

archive/issue_comments_157550.json:
```json
{
    "body": "I know this is positively reviewed already, but may I suggest a small improvement? The `MatrixSpace.random_element()` method creates a zero matrix and then randomizes every entry by calling the `M.randomize()` method. We can avoid recreating the zero matrix in every iteration by calling directly the `randomize()` method. For large matrices this gives me a 5-10% speed improvement over your current patch. I don't think the improvement is worth opening a whole new ticket, so can we just apply this on top of the current patch?",
    "created_at": "2012-07-04T10:57:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157550",
    "user": "jlopez"
}
```

I know this is positively reviewed already, but may I suggest a small improvement? The `MatrixSpace.random_element()` method creates a zero matrix and then randomizes every entry by calling the `M.randomize()` method. We can avoid recreating the zero matrix in every iteration by calling directly the `randomize()` method. For large matrices this gives me a 5-10% speed improvement over your current patch. I don't think the improvement is worth opening a whole new ticket, so can we just apply this on top of the current patch?



---

archive/issue_comments_157551.json:
```json
{
    "body": "Replying to [comment:13 jlopez]:\n\n+1",
    "created_at": "2012-07-04T14:46:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157551",
    "user": "Bouillaguet"
}
```

Replying to [comment:13 jlopez]:

+1



---

archive/issue_comments_157552.json:
```json
{
    "body": "If you add a patch, it obviously must be reviewed again.",
    "created_at": "2012-07-04T15:11:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157552",
    "user": "jdemeyer"
}
```

If you add a patch, it obviously must be reviewed again.



---

archive/issue_comments_157553.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-07-04T15:11:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157553",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_157554.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-07-04T15:12:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157554",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_157555.json:
```json
{
    "body": "Changing priority from trivial to major.",
    "created_at": "2012-07-04T15:12:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157555",
    "user": "jdemeyer"
}
```

Changing priority from trivial to major.



---

archive/issue_comments_157556.json:
```json
{
    "body": "Changing component from group theory to performance.",
    "created_at": "2012-07-04T15:12:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157556",
    "user": "jdemeyer"
}
```

Changing component from group theory to performance.



---

archive/issue_comments_157557.json:
```json
{
    "body": "Also, specify which patch(es) should be applied and fill in the Reviewer.",
    "created_at": "2012-07-04T15:12:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157557",
    "user": "jdemeyer"
}
```

Also, specify which patch(es) should be applied and fill in the Reviewer.



---

archive/issue_comments_157558.json:
```json
{
    "body": "Modified the description and author/reviewer. Since Dima already reviewed Charles' patch, I guess only the improvement patch would need to be reviewed.\n\npatchbot: apply gln_gfq_random.patch trac_13196.improvement.patch",
    "created_at": "2012-07-04T15:19:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157558",
    "user": "jlopez"
}
```

Modified the description and author/reviewer. Since Dima already reviewed Charles' patch, I guess only the improvement patch would need to be reviewed.

patchbot: apply gln_gfq_random.patch trac_13196.improvement.patch



---

archive/issue_comments_157559.json:
```json
{
    "body": "Charles, perhaps you can review my patch yourself?",
    "created_at": "2012-07-04T15:21:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157559",
    "user": "jlopez"
}
```

Charles, perhaps you can review my patch yourself?



---

archive/issue_comments_157560.json:
```json
{
    "body": "`@`jlopze: sure, give me a couple minutes",
    "created_at": "2012-07-04T15:22:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157560",
    "user": "Bouillaguet"
}
```

`@`jlopze: sure, give me a couple minutes



---

archive/issue_comments_157561.json:
```json
{
    "body": "Good to go !",
    "created_at": "2012-07-04T15:43:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157561",
    "user": "Bouillaguet"
}
```

Good to go !



---

archive/issue_comments_157562.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-07-04T15:43:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157562",
    "user": "Bouillaguet"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_157563.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-07-07T22:31:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13024#issuecomment-157563",
    "user": "jdemeyer"
}
```

Resolution: fixed
