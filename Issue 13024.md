# Issue 13024: GL(n, GF(q)).random_element() is way too slow for what it does

Issue created by migration from Trac.

Original creator: Bouillaguet

Original creation time: 2012-07-03 15:31:17

Assignee: joyner

CC:  malb dimpase

Keywords: matrix group, finite field, random element

GL(32, GF(2)).random_element() takes more than 10s, which is ridiculous.

Proposed solution : use simple rejection sampling (i.e. generate a random matrix, check if it invertible, if not try again). The result is uniformly distributed amongst invertible matrices.

Before patch:

```
sage: %time GL(64, GF(2)).random_element() 
5 loops, best of 3: 15.5 s per loop
```


After patch :

```
sage: %timeit GL(64, GF(2)).random_element()
625 loops, best of 3: 929 µs per loop
```



---

Comment by dimpase created at 2012-07-03 15:33:16

OK, cool, where is the patch? 
:)


---

Comment by Bouillaguet created at 2012-07-03 15:55:56

Replying to [comment:1 dimpase]:
> OK, cool, where is the patch? 
> :)

Sorry, it took me a while as I made a mistake (patched sage/groups/matrix_gps/matrix_group.py first instead of sage/groups/matrix_gps/general_linear.py, which is very wrong. The doctest caught it though....)


---

Comment by Bouillaguet created at 2012-07-03 15:56:21

Changing status from new to needs_review.


---

Comment by dimpase created at 2012-07-03 16:01:49

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2012-07-03 16:01:49

Could you add in the docstring that the probaility to get an invertible element is about 1/3, and so we expect to get the
answer in about 3 iterations ?


---

Comment by Bouillaguet created at 2012-07-03 17:03:42

Replying to [comment:4 dimpase]:
> Could you add in the docstring that the probaility to get an invertible element is about 1/3, and so we expect to get the
> answer in about 3 iterations ?

This is not true. The expected number of iterations is asymptotically `1 + 1/q + 2/q^2 + 3/q^3 + 5/q^4 + 7/q^5 + ....` 

For `GF(2)` you have 3.5 expected iterations, but for GF(127) you have 1.008 iterations..... So that asymptotically, the number of iterations is O(1), and the complexity of the procedure is `O(n^3)`, regardless of the size of the field.

Is that OK with you ?


---

Comment by dimpase created at 2012-07-03 17:05:33

Replying to [comment:5 Bouillaguet]:
> Replying to [comment:4 dimpase]:
> > Could you add in the docstring that the probaility to get an invertible element is about 1/3, and so we expect to get the
> > answer in about 3 iterations ?
> 
> This is not true. The expected number of iterations is asymptotically `1 + 1/q + 2/q^2 + 3/q^3 + 5/q^4 + 7/q^5 + ....` 
> 
> For `GF(2)` you have 3.5 expected iterations, but for GF(127) you have 1.008 iterations..... So that asymptotically, the number of iterations is O(1), and the complexity of the procedure is `O(n^3)`, regardless of the size of the field.
> 
> Is that OK with you ?

sure. I meant to say "at most 3 iterations".


---

Comment by Bouillaguet created at 2012-07-03 17:15:52

I corrected the docstring :)


---

Comment by dimpase created at 2012-07-03 17:25:36

Changing status from needs_work to positive_review.


---

Comment by dimpase created at 2012-07-03 17:25:36

Good, positive review.


---

Comment by Bouillaguet created at 2012-07-03 21:11:25

Modified patch to correct my own stupidity and improve performance a bit


```
sage: %timeit GL(64, GF(2)).random_element()
625 loops, best of 3: 752 µs per loop
```


`@`dimpase: staying positively reviewed?


---

Comment by dimpase created at 2012-07-04 03:41:57

patchbot says (and I checked that manually) that the patch (the latest, or previous version, does not matter) causes doctest failures in `sage/algebras/group_algebra_new.py` and in `sage/algebras/group_algebra.py`. You can find the log by clicking on the patchbot icon (the, currently, yellow) disc near the top.


---

Comment by dimpase created at 2012-07-04 03:41:57

Changing status from positive_review to needs_work.


---

Attachment


---

Comment by Bouillaguet created at 2012-07-04 08:46:03

Changing status from needs_work to needs_review.


---

Comment by Bouillaguet created at 2012-07-04 08:46:03

Patch updated. The bug was that my function returned a matrix, instead of returning an element of the group (basically, it returned g.matrix() instead of returning g). Fix: coerce the result into the group again. It takes a bit of time, and there is likely a workaround, but this is better than nothing.


---

Comment by dimpase created at 2012-07-04 08:53:01

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2012-07-04 08:53:01

Replying to [comment:11 Bouillaguet]:
> Patch updated. The bug was that my function returned a matrix, instead of returning an element of the group (basically, it returned g.matrix() instead of returning g). Fix: coerce the result into the group again. It takes a bit of time, and there is likely a workaround, but this is better than nothing.

OK!


---

Attachment

Slight improvement


---

Comment by jlopez created at 2012-07-04 10:57:56

I know this is positively reviewed already, but may I suggest a small improvement? The `MatrixSpace.random_element()` method creates a zero matrix and then randomizes every entry by calling the `M.randomize()` method. We can avoid recreating the zero matrix in every iteration by calling directly the `randomize()` method. For large matrices this gives me a 5-10% speed improvement over your current patch. I don't think the improvement is worth opening a whole new ticket, so can we just apply this on top of the current patch?


---

Comment by Bouillaguet created at 2012-07-04 14:46:13

Replying to [comment:13 jlopez]:

+1


---

Comment by jdemeyer created at 2012-07-04 15:11:47

If you add a patch, it obviously must be reviewed again.


---

Comment by jdemeyer created at 2012-07-04 15:11:47

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-07-04 15:12:02

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2012-07-04 15:12:02

Changing priority from trivial to major.


---

Comment by jdemeyer created at 2012-07-04 15:12:02

Changing component from group theory to performance.


---

Comment by jdemeyer created at 2012-07-04 15:12:26

Also, specify which patch(es) should be applied and fill in the Reviewer.


---

Comment by jlopez created at 2012-07-04 15:19:49

Modified the description and author/reviewer. Since Dima already reviewed Charles' patch, I guess only the improvement patch would need to be reviewed.

patchbot: apply gln_gfq_random.patch trac_13196.improvement.patch


---

Comment by jlopez created at 2012-07-04 15:21:01

Charles, perhaps you can review my patch yourself?


---

Comment by Bouillaguet created at 2012-07-04 15:22:01

`@`jlopze: sure, give me a couple minutes


---

Comment by Bouillaguet created at 2012-07-04 15:43:37

Good to go !


---

Comment by Bouillaguet created at 2012-07-04 15:43:37

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-07-07 22:31:54

Resolution: fixed
