# Issue 19973: Move memory functions to cysignals

archive/issues_019973.json:
```json
{
    "body": "CC:  defeo malb\n\nMove all memory-allocation functions like `sage_malloc` to cysignals (renaming `sage_` -> `sig_`).\n\nIssue created by migration from https://trac.sagemath.org/ticket/20210\n\n",
    "created_at": "2016-03-15T08:49:33Z",
    "labels": [
        "packages: standard",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.1",
    "title": "Move memory functions to cysignals",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19973",
    "user": "jdemeyer"
}
```
CC:  defeo malb

Move all memory-allocation functions like `sage_malloc` to cysignals (renaming `sage_` -> `sig_`).

Issue created by migration from https://trac.sagemath.org/ticket/20210





---

archive/issue_comments_274926.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-03-15T12:55:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19973#issuecomment-274926",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_274927.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-03-15T12:55:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19973#issuecomment-274927",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_274928.json:
```json
{
    "body": "For easier reviewing, I separated the commits:\n\n> ||[03458ea](http://git.sagemath.org/sage.git/commit/?id=03458ea28f8d10c4103f6cdecbf018115c71e889)||`Upgrade cysignals package`||\nThis is literally just the upgrade of the package.\n\n> ||[dce67fc](http://git.sagemath.org/sage.git/commit/?id=dce67fca49e515ce610539263e1e7a6f26c7bc69)||`Move memory functions to cysignals`||\nThis contains all changes to the Sage library (mostly changing include paths), except for renaming `sage_malloc` -> `sig_malloc` and similar.\n\n> ||[4bb8337](http://git.sagemath.org/sage.git/commit/?id=4bb8337295ed82c93d1a9c9f7173a4c36f97151d)||`Rename sage_malloc -> sig_malloc and friends`||\nThis was made with a simple `sed` script, it deals only with renaming `sage_malloc` -> `sig_malloc` and similar.",
    "created_at": "2016-03-15T12:58:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19973#issuecomment-274928",
    "user": "jdemeyer"
}
```

For easier reviewing, I separated the commits:

> ||[03458ea](http://git.sagemath.org/sage.git/commit/?id=03458ea28f8d10c4103f6cdecbf018115c71e889)||`Upgrade cysignals package`||
This is literally just the upgrade of the package.

> ||[dce67fc](http://git.sagemath.org/sage.git/commit/?id=dce67fca49e515ce610539263e1e7a6f26c7bc69)||`Move memory functions to cysignals`||
This contains all changes to the Sage library (mostly changing include paths), except for renaming `sage_malloc` -> `sig_malloc` and similar.

> ||[4bb8337](http://git.sagemath.org/sage.git/commit/?id=4bb8337295ed82c93d1a9c9f7173a4c36f97151d)||`Rename sage_malloc -> sig_malloc and friends`||
This was made with a simple `sed` script, it deals only with renaming `sage_malloc` -> `sig_malloc` and similar.



---

archive/issue_comments_274929.json:
```json
{
    "body": "Why do we have to `include \"cysignals/memory.pxi\"` and cannot `cimport`? Patch looks good, but I didn't check all lines of 4bb8337.",
    "created_at": "2016-03-16T09:17:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19973#issuecomment-274929",
    "user": "malb"
}
```

Why do we have to `include "cysignals/memory.pxi"` and cannot `cimport`? Patch looks good, but I didn't check all lines of 4bb8337.



---

archive/issue_comments_274930.json:
```json
{
    "body": "Replying to [comment:5 malb]:\n> Why do we have to `include \"cysignals/memory.pxi\"` and cannot `cimport`?\n\nBecause `cysignals/memory.pxi` includes `cysignals/signals.pxi` so it's really by transitivity.",
    "created_at": "2016-03-16T09:25:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19973#issuecomment-274930",
    "user": "jdemeyer"
}
```

Replying to [comment:5 malb]:
> Why do we have to `include "cysignals/memory.pxi"` and cannot `cimport`?

Because `cysignals/memory.pxi` includes `cysignals/signals.pxi` so it's really by transitivity.



---

archive/issue_comments_274931.json:
```json
{
    "body": "I am currently in Orsay discussing with Erik Bray and Nicolas Thi\u00e9ry to see if we can use `cimport` instead of `include` for `cysignals/signals.pxi` but it doesn't look easy.",
    "created_at": "2016-03-16T09:27:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19973#issuecomment-274931",
    "user": "jdemeyer"
}
```

I am currently in Orsay discussing with Erik Bray and Nicolas ThiÃ©ry to see if we can use `cimport` instead of `include` for `cysignals/signals.pxi` but it doesn't look easy.



---

archive/issue_comments_274932.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-03-16T10:35:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19973#issuecomment-274932",
    "user": "malb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_274933.json:
```json
{
    "body": "Okay, looks good then. I didn't run tests, though.",
    "created_at": "2016-03-16T10:35:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19973#issuecomment-274933",
    "user": "malb"
}
```

Okay, looks good then. I didn't run tests, though.



---

archive/issue_comments_274934.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-03-20T23:41:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19973#issuecomment-274934",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_274935.json:
```json
{
    "body": "I've been working on ticket #14304 which now depends on this ticket.  Since it's been rebased, it now has doctests failing that aren't touched by the ticket.  So I ran all the doctests with just this ticket applied and the following one fails:\n\n```\nsage -t src/sage/tests/cmdline.py  # 3 doctests failed\n```\n\n\nHowever, the following are failing for #14304\n\n```\nsage -t src/sage/interacts/debugger.py  # 1 doctest failed\nsage -t src/sage/tests/cmdline.py  # 14 doctests failed\nsage -t src/sage/tests/french_book/nonlinear_doctest.py  # 1 doctest failed\nsage -t src/sage/doctest/forker.py  # 1 doctest failed\nsage -t src/sage/doctest/test.py  # 1 doctest failed\nsage -t src/sage/repl/attach.py  # 2 doctests failed\nsage -t src/sage/repl/interpreter.py  # 22 doctests failed\nsage -t src/sage/repl/inputhook.pyx  # 2 doctests failed\nsage -t src/sage/repl/ipython_extension.py  # 9 doctests failed\nsage -t src/sage/repl/ipython_tests.py  # 4 doctests failed\nsage -t src/sage/repl/interface_magic.py  # 3 doctests failed\nsage -t src/sage/repl/display/formatter.py  # 10 doctests failed\nsage -t src/sage/repl/rich_output/backend_ipython.py  # 3 doctests failed\nsage -t src/sage/repl/ipython_kernel/install.py  # 1 doctest failed\nsage -t src/sage/repl/ipython_kernel/kernel.py  # 4 doctests failed\nsage -t src/sage/quivers/algebra_elements.pxi  # 1 doctest failed\nsage -t src/sage/dev/trac_interface.py  # 1 doctest failed\nsage -t src/sage/typeset/ascii_art.py  # 2 doctests failed\nsage -t src/sage/misc/temporary_file.py  # 1 doctest failed\nsage -t src/sage/structure/misc.pyx  # 1 doctest failed\nsage -t src/sage/structure/sage_object.pyx  # 4 doctests failed\nsage -t src/sage/combinat/shard_order.py  # 1 doctest failed\nsage -t src/sage/combinat/root_system/root_lattice_realizations.py  # 1 doctest failed\nsage -t src/sage/combinat/rigged_configurations/rigged_configurations.py  # 1 doctest failed\nsage -t src/sage/combinat/rigged_configurations/rigged_configuration_element.py  # 1 doctest failed\nsage -t src/sage/combinat/rigged_configurations/rc_crystal.py  # 1 doctest failed\nsage -t src/sage/combinat/rigged_configurations/rc_infinity.py  # 1 doctest failed\nsage -t src/sage/interfaces/sage0.py  # 1 doctest failed\n```\n\n\nAny idea what's up?",
    "created_at": "2016-03-22T15:56:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19973#issuecomment-274935",
    "user": "aly.deines"
}
```

I've been working on ticket #14304 which now depends on this ticket.  Since it's been rebased, it now has doctests failing that aren't touched by the ticket.  So I ran all the doctests with just this ticket applied and the following one fails:

```
sage -t src/sage/tests/cmdline.py  # 3 doctests failed
```


However, the following are failing for #14304

```
sage -t src/sage/interacts/debugger.py  # 1 doctest failed
sage -t src/sage/tests/cmdline.py  # 14 doctests failed
sage -t src/sage/tests/french_book/nonlinear_doctest.py  # 1 doctest failed
sage -t src/sage/doctest/forker.py  # 1 doctest failed
sage -t src/sage/doctest/test.py  # 1 doctest failed
sage -t src/sage/repl/attach.py  # 2 doctests failed
sage -t src/sage/repl/interpreter.py  # 22 doctests failed
sage -t src/sage/repl/inputhook.pyx  # 2 doctests failed
sage -t src/sage/repl/ipython_extension.py  # 9 doctests failed
sage -t src/sage/repl/ipython_tests.py  # 4 doctests failed
sage -t src/sage/repl/interface_magic.py  # 3 doctests failed
sage -t src/sage/repl/display/formatter.py  # 10 doctests failed
sage -t src/sage/repl/rich_output/backend_ipython.py  # 3 doctests failed
sage -t src/sage/repl/ipython_kernel/install.py  # 1 doctest failed
sage -t src/sage/repl/ipython_kernel/kernel.py  # 4 doctests failed
sage -t src/sage/quivers/algebra_elements.pxi  # 1 doctest failed
sage -t src/sage/dev/trac_interface.py  # 1 doctest failed
sage -t src/sage/typeset/ascii_art.py  # 2 doctests failed
sage -t src/sage/misc/temporary_file.py  # 1 doctest failed
sage -t src/sage/structure/misc.pyx  # 1 doctest failed
sage -t src/sage/structure/sage_object.pyx  # 4 doctests failed
sage -t src/sage/combinat/shard_order.py  # 1 doctest failed
sage -t src/sage/combinat/root_system/root_lattice_realizations.py  # 1 doctest failed
sage -t src/sage/combinat/rigged_configurations/rigged_configurations.py  # 1 doctest failed
sage -t src/sage/combinat/rigged_configurations/rigged_configuration_element.py  # 1 doctest failed
sage -t src/sage/combinat/rigged_configurations/rc_crystal.py  # 1 doctest failed
sage -t src/sage/combinat/rigged_configurations/rc_infinity.py  # 1 doctest failed
sage -t src/sage/interfaces/sage0.py  # 1 doctest failed
```


Any idea what's up?



---

archive/issue_comments_274936.json:
```json
{
    "body": "What are the actual failures?",
    "created_at": "2016-03-22T15:59:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19973#issuecomment-274936",
    "user": "jdemeyer"
}
```

What are the actual failures?



---

archive/issue_comments_274937.json:
```json
{
    "body": "They are:\n\n\n```\naly@aly-laptop:~/Sage/sage$ ./sage -t src/sage/tests/cmdline.py \nRunning doctests with ID 2016-03-22-16-00-06-1cfb21fa.\nGit branch: ticket/20210\nUsing --optional=ccache,mpir,python2,sage\nDoctesting 1 file.\nsage -t --warn-long 18.2 src/sage/tests/cmdline.py\n**********************************************************************\nFile \"src/sage/tests/cmdline.py\", line 106, in sage.tests.cmdline.test_executable\nFailed example:\n    out.find(version()) >= 0\nExpected:\n    True\nGot:\n    False\n**********************************************************************\nFile \"src/sage/tests/cmdline.py\", line 114, in sage.tests.cmdline.test_executable\nFailed example:\n    out.find(version()) >= 0\nExpected:\n    True\nGot:\n    False\n**********************************************************************\nFile \"src/sage/tests/cmdline.py\", line 186, in sage.tests.cmdline.test_executable\nFailed example:\n    out.find(version()) >= 0\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n1 item had failures:\n   3 of 235 in sage.tests.cmdline.test_executable\n    [234 tests, 3 failures, 30.61 s]\n----------------------------------------------------------------------\nsage -t --warn-long 18.2 src/sage/tests/cmdline.py  # 3 doctests failed\n----------------------------------------------------------------------\nTotal time for all tests: 30.7 seconds\n    cpu time: 0.3 seconds\n    cumulative wall time: 30.6 seconds\n\n```\n",
    "created_at": "2016-03-22T16:01:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19973#issuecomment-274937",
    "user": "aly.deines"
}
```

They are:


```
aly@aly-laptop:~/Sage/sage$ ./sage -t src/sage/tests/cmdline.py 
Running doctests with ID 2016-03-22-16-00-06-1cfb21fa.
Git branch: ticket/20210
Using --optional=ccache,mpir,python2,sage
Doctesting 1 file.
sage -t --warn-long 18.2 src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 106, in sage.tests.cmdline.test_executable
Failed example:
    out.find(version()) >= 0
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/tests/cmdline.py", line 114, in sage.tests.cmdline.test_executable
Failed example:
    out.find(version()) >= 0
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/tests/cmdline.py", line 186, in sage.tests.cmdline.test_executable
Failed example:
    out.find(version()) >= 0
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   3 of 235 in sage.tests.cmdline.test_executable
    [234 tests, 3 failures, 30.61 s]
----------------------------------------------------------------------
sage -t --warn-long 18.2 src/sage/tests/cmdline.py  # 3 doctests failed
----------------------------------------------------------------------
Total time for all tests: 30.7 seconds
    cpu time: 0.3 seconds
    cumulative wall time: 30.6 seconds

```




---

archive/issue_comments_274938.json:
```json
{
    "body": "Well, that doesn't look related to this ticket... Are you sure you ran `make`?",
    "created_at": "2016-03-22T16:04:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19973#issuecomment-274938",
    "user": "jdemeyer"
}
```

Well, that doesn't look related to this ticket... Are you sure you ran `make`?



---

archive/issue_comments_274939.json:
```json
{
    "body": "Ugg.  I think you're right.  I'm running make now and will rerun the doctests.",
    "created_at": "2016-03-22T16:06:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19973#issuecomment-274939",
    "user": "aly.deines"
}
```

Ugg.  I think you're right.  I'm running make now and will rerun the doctests.



---

archive/issue_comments_274940.json:
```json
{
    "body": "Do you remember which commands you did run and why you ran them instead of something involving `make`? Did somebody tell you to run those commands or did you read it somewhere in the documentation? How could we make it more clear that people really should run `make` before testing or running Sage?",
    "created_at": "2016-03-22T16:49:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19973#issuecomment-274940",
    "user": "jdemeyer"
}
```

Do you remember which commands you did run and why you ran them instead of something involving `make`? Did somebody tell you to run those commands or did you read it somewhere in the documentation? How could we make it more clear that people really should run `make` before testing or running Sage?



---

archive/issue_comments_274941.json:
```json
{
    "body": "I've been running\n\n```\n./sage -b\n```\n\nfor most tickets.  I thought I only needed to run make when spkg changed, and just forgot to do so on this ticket out of habit of running the Sage build.  Should I more generally run make?",
    "created_at": "2016-03-22T16:52:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19973#issuecomment-274941",
    "user": "aly.deines"
}
```

I've been running

```
./sage -b
```

for most tickets.  I thought I only needed to run make when spkg changed, and just forgot to do so on this ticket out of habit of running the Sage build.  Should I more generally run make?



---

archive/issue_comments_274942.json:
```json
{
    "body": "Replying to [comment:16 aly.deines]:\n>  I thought I only needed to run make when spkg changed\n\nThat is still true.\n\nHowever: most of the time this spkg change is implicit when changing branches. When you move from a branch based on one Sage version to a branch based on a different Sage version, chances are high that some spkg has changed between those branches.\n\n> Should I more generally run make?\n\nAt least when changing branches, yes. Once you did this and you then make changes only to the Sage library, then `./sage -b` should be sufficient. But run `make` when in doubt.\n\nNote that you can also use `make build` instead of `make` to skip the documentation build which can take a while.",
    "created_at": "2016-03-22T17:00:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19973#issuecomment-274942",
    "user": "jdemeyer"
}
```

Replying to [comment:16 aly.deines]:
>  I thought I only needed to run make when spkg changed

That is still true.

However: most of the time this spkg change is implicit when changing branches. When you move from a branch based on one Sage version to a branch based on a different Sage version, chances are high that some spkg has changed between those branches.

> Should I more generally run make?

At least when changing branches, yes. Once you did this and you then make changes only to the Sage library, then `./sage -b` should be sufficient. But run `make` when in doubt.

Note that you can also use `make build` instead of `make` to skip the documentation build which can take a while.



---

archive/issue_comments_274943.json:
```json
{
    "body": "An easy way to run all doctests safely is to use `make ptest` or `make ptestlong`. That will do the build and run all doctests in one simple command.",
    "created_at": "2016-03-22T17:02:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19973#issuecomment-274943",
    "user": "jdemeyer"
}
```

An easy way to run all doctests safely is to use `make ptest` or `make ptestlong`. That will do the build and run all doctests in one simple command.



---

archive/issue_comments_274944.json:
```json
{
    "body": "Awesome!  Thanks!  I might update some of the developer's guide to make this a bit clearer.  :)",
    "created_at": "2016-03-22T17:07:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19973#issuecomment-274944",
    "user": "aly.deines"
}
```

Awesome!  Thanks!  I might update some of the developer's guide to make this a bit clearer.  :)



---

archive/issue_comments_274945.json:
```json
{
    "body": "Replying to [comment:19 aly.deines]:\n> Awesome!  Thanks!  I might update some of the developer's guide to make this a bit clearer.  :)\n\nThat would be really great! Still, the hard part is making people read it.",
    "created_at": "2016-03-22T17:09:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19973",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19973#issuecomment-274945",
    "user": "jdemeyer"
}
```

Replying to [comment:19 aly.deines]:
> Awesome!  Thanks!  I might update some of the developer's guide to make this a bit clearer.  :)

That would be really great! Still, the hard part is making people read it.
