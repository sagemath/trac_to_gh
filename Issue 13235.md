# Issue 13235: Move sage-make_relative to sage-location

Issue created by migration from https://trac.sagemath.org/ticket/13407

Original creator: jdemeyer

Original creation time: 2012-08-28 11:55:40

Assignee: GeorgSWeber

There is a rare race condition associated to `sage-make_relative`: when a file is open for writing, it cannot be executed (you get a "Text file busy" error). Since the `sage-make_relative` opens all files in `$SAGE_LOCAL/bin` for writing, it can happen that a parallel Sage build fails.

Example from `install.log` of a failed parallel build:

```
sage_fortran -fPIC  -c sposv.f -o sposv.o
sage_fortran -fPIC  -c sposvx.f -o sposvx.o
sage_fortran -fPIC  -c spotf2.f -o spotf2.o
Making Python scripts relocatable...
sage_fortran -fPIC  -c spotrf.f -o spotrf.o
sage_fortran -fPIC  -c spotri.f -o spotri.o
sage_fortran -fPIC  -c spotrs.f -o spotrs.o
sage_fortran -fPIC  -c sppcon.f -o sppcon.o
make[2]: execvp: sage_fortran: Text file busy
make[2]: *** [sppcon.o] Error 127
make[2]: *** Waiting for unfinished jobs....
make[2]: Leaving directory `/home/buildbot/build/sage/lena-1/lena_upgrade_4.7.1/build/sage-5.3.rc1/spkg/build/lapack-20071123.p2/src/SRC'
make[1]: *** [lapacklib] Error 2
make[1]: Leaving directory `/home/buildbot/build/sage/lena-1/lena_upgrade_4.7.1/build/sage-5.3.rc1/spkg/build/lapack-20071123.p2/src'
Error compiling lapack.
```


The most obvious solution is to fix `sage-make_relative` to first open the file only for reading and then reopen it for writing only if needed.

However, I think a better solution is to move `sage-make_relative` to `sage-location`: the latter script is intented precisely to fix relocation issues.  It would also be faster, as currently every file in `$SAGE_LOCAL/bin` is checked after every package is installed.


---

Attachment


---

Attachment


---

Comment by jdemeyer created at 2012-09-16 17:43:01

Changing status from new to needs_review.


---

Comment by dimpase created at 2012-11-12 15:34:51

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2012-11-12 15:34:51

all seems to make sense, and it does work.


---

Comment by jdemeyer created at 2012-11-14 08:30:19

Resolution: fixed
