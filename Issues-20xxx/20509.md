# Issue 20509: khovanov homology of links

archive/issues_020272.json:
```json
{
    "body": "CC:  @kcrisman @tscrim @amitjamadagni @jhpalmieri @fuglede\n\nKeywords: knots\n\nThis branch implements khovanov homology for links.\n\n```\nsage: K = Link([[[1, -2, 3, -1, 2, -3]],[-1, -1, -1]])\nsage: K.khovanov_homology()\n{-9: {-3: Z},\n-7: {-3: 0, -2: C2},\n-5: {-3: 0, -2: Z, -1: 0, 0: 0},\n-3: {-3: 0, -2: 0, -1: 0, 0: Z},\n-1: {0: Z}}\n```\n\nIt is computed by following the definition.\n\nIssue created by migration from https://trac.sagemath.org/ticket/20509\n\n",
    "closed_at": "2016-05-18T18:21:04Z",
    "created_at": "2016-04-27T18:44:05Z",
    "labels": [
        "component: algebraic topology"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "khovanov homology of links",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20509",
    "user": "https://github.com/miguelmarco"
}
```
CC:  @kcrisman @tscrim @amitjamadagni @jhpalmieri @fuglede

Keywords: knots

This branch implements khovanov homology for links.

```
sage: K = Link([[[1, -2, 3, -1, 2, -3]],[-1, -1, -1]])
sage: K.khovanov_homology()
{-9: {-3: Z},
-7: {-3: 0, -2: C2},
-5: {-3: 0, -2: Z, -1: 0, 0: 0},
-3: {-3: 0, -2: 0, -1: 0, 0: Z},
-1: {0: Z}}
```

It is computed by following the definition.

Issue created by migration from https://trac.sagemath.org/ticket/20509





---

archive/issue_comments_279016.json:
```json
{
    "body": "Changing keywords from \"\" to \"knots\".",
    "created_at": "2016-04-27T18:50:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20509#issuecomment-279016",
    "user": "https://github.com/miguelmarco"
}
```

Changing keywords from "" to "knots".



---

archive/issue_comments_279017.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to algebraic topology.",
    "created_at": "2016-04-27T18:50:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20509#issuecomment-279017",
    "user": "https://github.com/miguelmarco"
}
```

Changing component from PLEASE CHANGE to algebraic topology.



---

archive/issue_comments_279018.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-04-27T18:50:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20509#issuecomment-279018",
    "user": "https://github.com/miguelmarco"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_279019.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-04-27T18:50:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20509#issuecomment-279019",
    "user": "https://github.com/miguelmarco"
}
```

New commits:



---

archive/issue_comments_279020.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2016-04-27T18:50:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20509#issuecomment-279020",
    "user": "https://github.com/miguelmarco"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_279021.json:
```json
{
    "body": "Some comments:\n\n- I don't see the point of having attributes `_smoothing` and `_enhanced_states`, these should be separated out into ``@`cached_method`. Although it seems like `_enhanced_states` is all you really need.\n- Instead of `type(_) == tuple`, use `isinstance(_, tuple)`.\n- Instead of\n  {{{#!python\ndifs = [_ for _ in range(len(V1[0])) if V1[0][_] != V2[0][_] ]\n  }}}\n  you can do\n  {{{#!python\nV20 = V2[0]\ndifs = [index for index,value in enumerate(V1[0]) if value != V20[index] ]\n  }}}\n- The output of `khovanov_homology` is mutable, so it should not be cached.",
    "created_at": "2016-04-27T23:05:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20509#issuecomment-279021",
    "user": "https://github.com/tscrim"
}
```

Some comments:

- I don't see the point of having attributes `_smoothing` and `_enhanced_states`, these should be separated out into ``@`cached_method`. Although it seems like `_enhanced_states` is all you really need.
- Instead of `type(_) == tuple`, use `isinstance(_, tuple)`.
- Instead of
  {{{#!python
difs = [_ for _ in range(len(V1[0])) if V1[0][_] != V2[0][_] ]
  }}}
  you can do
  {{{#!python
V20 = V2[0]
difs = [index for index,value in enumerate(V1[0]) if value != V20[index] ]
  }}}
- The output of `khovanov_homology` is mutable, so it should not be cached.



---

archive/issue_comments_279022.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-28T08:56:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20509#issuecomment-279022",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_279023.json:
```json
{
    "body": "I made the suggested changes. I am not entirely happy with the format of the output, but i guess it is the price to pay for caching it.\n\nAlso, I would like to have a smarter way to take advantage of caching (for instance, if the whole homology has been computed, don't compute again the smaller pieces, and vice-versa: don't compute the pieces already computed when we compute the whole picture).\n\nIs there a way to get which input values have already been cached?",
    "created_at": "2016-04-28T09:00:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20509#issuecomment-279023",
    "user": "https://github.com/miguelmarco"
}
```

I made the suggested changes. I am not entirely happy with the format of the output, but i guess it is the price to pay for caching it.

Also, I would like to have a smarter way to take advantage of caching (for instance, if the whole homology has been computed, don't compute again the smaller pieces, and vice-versa: don't compute the pieces already computed when we compute the whole picture).

Is there a way to get which input values have already been cached?



---

archive/issue_comments_279024.json:
```json
{
    "body": "I was thinking the value of `bases` is what should be cached since `states` is just a transient variable.\n\nTo get around this recomputing issue, you could have another (private) cached method that computes it on a by-degree basis (perhaps also taking the `height` as input. Thus we can make the user-level accessible function is not cached (and can thus return a `dict` for better usability). Eh...I might have to think a little more on this. I agree that the format is bad. (Another option would be `Family`.)\n\nAlso, you can make this change:\n\n```diff\n-m[ii,jj] = (-1)**sum([V2[0][_] for _ in range(difs[0]+1, ncross)])\n+m[ii,jj] = (-1)**sum(V2[0][difs[0]+1:ncross])\n```",
    "created_at": "2016-04-28T14:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20509#issuecomment-279024",
    "user": "https://github.com/tscrim"
}
```

I was thinking the value of `bases` is what should be cached since `states` is just a transient variable.

To get around this recomputing issue, you could have another (private) cached method that computes it on a by-degree basis (perhaps also taking the `height` as input. Thus we can make the user-level accessible function is not cached (and can thus return a `dict` for better usability). Eh...I might have to think a little more on this. I agree that the format is bad. (Another option would be `Family`.)

Also, you can make this change:

```diff
-m[ii,jj] = (-1)**sum([V2[0][_] for _ in range(difs[0]+1, ncross)])
+m[ii,jj] = (-1)**sum(V2[0][difs[0]+1:ncross])
```



---

archive/issue_comments_279025.json:
```json
{
    "body": "Indeed, it is the value of \"bases\" what we reuse, but that is a dictionary, and hence mutable. Again, we could have it in a tuple format and convert it to dictionary each time we recover it.\n\nIn general, what to compute and cache each time is quite tricky here. Now we are computing all the bases of the chain complexes once and caching it. So if the user just asks for a given height, we compute a lot that we don't need. Anyways, my experience is that the biggest part of the computation is taken by computing the cohomology of the complexes, so it is not so bad.",
    "created_at": "2016-04-28T15:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20509#issuecomment-279025",
    "user": "https://github.com/miguelmarco"
}
```

Indeed, it is the value of "bases" what we reuse, but that is a dictionary, and hence mutable. Again, we could have it in a tuple format and convert it to dictionary each time we recover it.

In general, what to compute and cache each time is quite tricky here. Now we are computing all the bases of the chain complexes once and caching it. So if the user just asks for a given height, we compute a lot that we don't need. Anyways, my experience is that the biggest part of the computation is taken by computing the cohomology of the complexes, so it is not so bad.



---

archive/issue_comments_279026.json:
```json
{
    "body": "You could also create a separate class for Khovanov homology, at which point you would have complete control over its output format.",
    "created_at": "2016-04-28T15:11:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20509#issuecomment-279026",
    "user": "https://github.com/jhpalmieri"
}
```

You could also create a separate class for Khovanov homology, at which point you would have complete control over its output format.



---

archive/issue_comments_279027.json:
```json
{
    "body": "Replying to [comment:7 mmarco]:\n> Indeed, it is the value of \"bases\" what we reuse, but that is a dictionary, and hence mutable. Again, we could have it in a tuple format and convert it to dictionary each time we recover it.\n\n\nIn this case, I would say that is okay because user does not see it (but we should put a big warning to any developers to not mutate nor expose it).\n\n> In general, what to compute and cache each time is quite tricky here. Now we are computing all the bases of the chain complexes once and caching it. So if the user just asks for a given height, we compute a lot that we don't need. Anyways, my experience is that the biggest part of the computation is taken by computing the cohomology of the complexes, so it is not so bad.\n\n\nIt is probably worthwhile to see what `%prun` tells us.\n\nHowever, [comment:8 John's suggestion] of creating a dedicated class for Khovanov homology is probably best because this allows us to (potentially) give it a module structure, have full control over output, better localization of code/caching, and make it more functor-like.",
    "created_at": "2016-04-28T16:04:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20509#issuecomment-279027",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:7 mmarco]:
> Indeed, it is the value of "bases" what we reuse, but that is a dictionary, and hence mutable. Again, we could have it in a tuple format and convert it to dictionary each time we recover it.


In this case, I would say that is okay because user does not see it (but we should put a big warning to any developers to not mutate nor expose it).

> In general, what to compute and cache each time is quite tricky here. Now we are computing all the bases of the chain complexes once and caching it. So if the user just asks for a given height, we compute a lot that we don't need. Anyways, my experience is that the biggest part of the computation is taken by computing the cohomology of the complexes, so it is not so bad.


It is probably worthwhile to see what `%prun` tells us.

However, [comment:8 John's suggestion] of creating a dedicated class for Khovanov homology is probably best because this allows us to (potentially) give it a module structure, have full control over output, better localization of code/caching, and make it more functor-like.



---

archive/issue_comments_279028.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-05-01T13:02:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20509#issuecomment-279028",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_279029.json:
```json
{
    "body": "I moved the cached part to a private method, that stores only the different heights, and returns tuples. The (now non cached) public method calls this private method to return dictionaries.",
    "created_at": "2016-05-01T13:04:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20509#issuecomment-279029",
    "user": "https://github.com/miguelmarco"
}
```

I moved the cached part to a private method, that stores only the different heights, and returns tuples. The (now non cached) public method calls this private method to return dictionaries.



---

archive/issue_comments_279030.json:
```json
{
    "body": "I did some fixes, simplifications, and cleanup. I think this will work for now, unless you think we should spend a little time now to create a class for the Khovanov homology (mainly a question to John)? Otherwise, if you are okay with my changes, then you can set a positive review.\n\n---\nNew commits:",
    "created_at": "2016-05-05T19:24:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20509#issuecomment-279030",
    "user": "https://github.com/tscrim"
}
```

I did some fixes, simplifications, and cleanup. I think this will work for now, unless you think we should spend a little time now to create a class for the Khovanov homology (mainly a question to John)? Otherwise, if you are okay with my changes, then you can set a positive review.

---
New commits:



---

archive/issue_comments_279031.json:
```json
{
    "body": "I don't have strong feelings about a separate class for the homology. I was just suggesting it as an option to give control over the output while allowing caching for the results. So I think it can wait.",
    "created_at": "2016-05-05T19:31:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20509#issuecomment-279031",
    "user": "https://github.com/jhpalmieri"
}
```

I don't have strong feelings about a separate class for the homology. I was just suggesting it as an option to give control over the output while allowing caching for the results. So I think it can wait.



---

archive/issue_comments_279032.json:
```json
{
    "body": "Thanks for the cleanup. I am ok with the changes.",
    "created_at": "2016-05-06T06:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20509#issuecomment-279032",
    "user": "https://github.com/miguelmarco"
}
```

Thanks for the cleanup. I am ok with the changes.



---

archive/issue_comments_279033.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-05-06T06:14:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20509#issuecomment-279033",
    "user": "https://github.com/miguelmarco"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_055404.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-05-18T18:21:04Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20509",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20509#event-55404"
}
```



---

archive/issue_comments_279034.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-05-18T18:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20509#issuecomment-279034",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
