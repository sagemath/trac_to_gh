# Issue 20293: matrix constructor fails on numpy.matrix

archive/issues_020056.json:
```json
{
    "body": "This failure seems to be new in Sage.7.2.beta0 \n\n```\nsage: import numpy\nsage: n = numpy.matrix([[1,2],[3,4]],float)\nsage: matrix(n)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-7-649197712655> in <module>()\n----> 1 matrix(n)\n\n/waste/cn/sage-git/src/sage/matrix/constructor.pyx in sage.matrix.constructor.MatrixFactory.__call__ (/waste/cn/sage-git/src/build/cythonized/sage/matrix/constructor.c:6357)()\n    741                     entries = arg\n    742                 else:\n--> 743                     raise TypeError(\"invalid matrix constructor: type matrix? for help\")\n    744         else:  # len(args) >= 2\n    745             raise TypeError(\"invalid matrix constructor: type matrix? for help\")\n\nTypeError: invalid matrix constructor: type matrix? for help\n```\n\nUsing `numpy.array` instead of `numpy.matrix` still works (and is doctested).  \n\n\n**Keywords:** numpy, matrix\n\n**Branch/Commit:** [c5cad5d6321d8755ce456370c6054f5206e64020](https://github.com/sagemath/sagetrac-mirror/commit/c5cad5d6321d8755ce456370c6054f5206e64020)\n\n**Reviewer:** Vincent Delecroix\n\n**Author:** Christian Nassau, Jeroen Demeyer\n\nIssue created by migration from https://trac.sagemath.org/ticket/20293\n\n",
    "closed_at": "2016-04-13T17:05:16Z",
    "created_at": "2016-03-25T17:26:39Z",
    "labels": [
        "component: numerical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-7.2",
    "title": "matrix constructor fails on numpy.matrix",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/20293",
    "user": "https://github.com/cnassau"
}
```
This failure seems to be new in Sage.7.2.beta0 

```
sage: import numpy
sage: n = numpy.matrix([[1,2],[3,4]],float)
sage: matrix(n)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-7-649197712655> in <module>()
----> 1 matrix(n)

/waste/cn/sage-git/src/sage/matrix/constructor.pyx in sage.matrix.constructor.MatrixFactory.__call__ (/waste/cn/sage-git/src/build/cythonized/sage/matrix/constructor.c:6357)()
    741                     entries = arg
    742                 else:
--> 743                     raise TypeError("invalid matrix constructor: type matrix? for help")
    744         else:  # len(args) >= 2
    745             raise TypeError("invalid matrix constructor: type matrix? for help")

TypeError: invalid matrix constructor: type matrix? for help
```

Using `numpy.array` instead of `numpy.matrix` still works (and is doctested).  


**Keywords:** numpy, matrix

**Branch/Commit:** [c5cad5d6321d8755ce456370c6054f5206e64020](https://github.com/sagemath/sagetrac-mirror/commit/c5cad5d6321d8755ce456370c6054f5206e64020)

**Reviewer:** Vincent Delecroix

**Author:** Christian Nassau, Jeroen Demeyer

Issue created by migration from https://trac.sagemath.org/ticket/20293





---

archive/issue_comments_294789.json:
```json
{
    "body": "<a id='comment:1'></a>\nI think the reason might be that with Sage 7.2.beta0 the numpy.matrix is not recognized as a numpy type:\n\n```\nsage: import numpy\nsage: n = numpy.matrix([[1,2],[3,4]],float)\nsage: from sage.structure.coerce import is_numpy_type\nsage: is_numpy_type(type(n))\nFalse\n```\n\nThe code in `is_numpy_type` checks whether the `tp_name` field of its argument begins with \"numpy.\"; in this case the `tp_name` is just \"`matrix`\". Maybe we should check `type(n).__module__` instead, since the official doc \n   https://docs.python.org/2/c-api/typeobj.html#c.PyTypeObject.tp_name\nsays that \"dynamically allocated types\" should not contain the module name in the `tp_type`. \n\n```\nsage: n = numpy.matrix([[1,2],[3,4]],float)\nsage: type(n).__module__\n'numpy.matrixlib.defmatrix'\nsage: n = numpy.array([[1,2],[3,4]],float)\nsage: type(n).__module__\n'numpy'\n```\nI currently do not know how to code this check in cython, though.",
    "created_at": "2016-03-25T18:11:23Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294789",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:1'></a>
I think the reason might be that with Sage 7.2.beta0 the numpy.matrix is not recognized as a numpy type:

```
sage: import numpy
sage: n = numpy.matrix([[1,2],[3,4]],float)
sage: from sage.structure.coerce import is_numpy_type
sage: is_numpy_type(type(n))
False
```

The code in `is_numpy_type` checks whether the `tp_name` field of its argument begins with "numpy."; in this case the `tp_name` is just "`matrix`". Maybe we should check `type(n).__module__` instead, since the official doc 
   https://docs.python.org/2/c-api/typeobj.html#c.PyTypeObject.tp_name
says that "dynamically allocated types" should not contain the module name in the `tp_type`. 

```
sage: n = numpy.matrix([[1,2],[3,4]],float)
sage: type(n).__module__
'numpy.matrixlib.defmatrix'
sage: n = numpy.array([[1,2],[3,4]],float)
sage: type(n).__module__
'numpy'
```
I currently do not know how to code this check in cython, though.



---

archive/issue_events_182168.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2016-03-25T21:36:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20293#event-182168"
}
```



---

archive/issue_comments_294790.json:
```json
{
    "body": "**Commit:** [d58e8456583eb9adf25a06c555d9d0f9766ca2dd](https://github.com/sagemath/sagetrac-mirror/commit/d58e8456583eb9adf25a06c555d9d0f9766ca2dd)",
    "created_at": "2016-03-25T21:36:34Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294790",
    "user": "https://github.com/cnassau"
}
```

**Commit:** [d58e8456583eb9adf25a06c555d9d0f9766ca2dd](https://github.com/sagemath/sagetrac-mirror/commit/d58e8456583eb9adf25a06c555d9d0f9766ca2dd)



---

archive/issue_comments_294791.json:
```json
{
    "body": "**Branch:** [u/cnassau/numpy-matrix](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/numpy-matrix)",
    "created_at": "2016-03-25T21:36:34Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294791",
    "user": "https://github.com/cnassau"
}
```

**Branch:** [u/cnassau/numpy-matrix](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/numpy-matrix)



---

archive/issue_comments_294792.json:
```json
{
    "body": "**Author:** Christian Nassau",
    "created_at": "2016-03-25T21:37:54Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294792",
    "user": "https://github.com/cnassau"
}
```

**Author:** Christian Nassau



---

archive/issue_comments_294793.json:
```json
{
    "body": "<a id='comment:4'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c8a5e9687a9991faada7a5079332d2ba9d7ece72\">c8a5e96</a></td><td><code>Ticket 20293: fix numpy type recognition</code></td></tr></table>\n",
    "created_at": "2016-03-26T06:52:25Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294793",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:4'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c8a5e9687a9991faada7a5079332d2ba9d7ece72">c8a5e96</a></td><td><code>Ticket 20293: fix numpy type recognition</code></td></tr></table>




---

archive/issue_comments_294794.json:
```json
{
    "body": "**Changing branch** from \"[u/cnassau/numpy-matrix](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/numpy-matrix)\" to \"[u/cnassau/numpy-matrix-2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/numpy-matrix-2)\".",
    "created_at": "2016-03-26T06:52:25Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294794",
    "user": "https://github.com/cnassau"
}
```

**Changing branch** from "[u/cnassau/numpy-matrix](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/numpy-matrix)" to "[u/cnassau/numpy-matrix-2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/numpy-matrix-2)".



---

archive/issue_comments_294795.json:
```json
{
    "body": "**Changing commit** from \"[d58e8456583eb9adf25a06c555d9d0f9766ca2dd](https://github.com/sagemath/sagetrac-mirror/commit/d58e8456583eb9adf25a06c555d9d0f9766ca2dd)\" to \"[c8a5e9687a9991faada7a5079332d2ba9d7ece72](https://github.com/sagemath/sagetrac-mirror/commit/c8a5e9687a9991faada7a5079332d2ba9d7ece72)\".",
    "created_at": "2016-03-26T06:52:25Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294795",
    "user": "https://github.com/cnassau"
}
```

**Changing commit** from "[d58e8456583eb9adf25a06c555d9d0f9766ca2dd](https://github.com/sagemath/sagetrac-mirror/commit/d58e8456583eb9adf25a06c555d9d0f9766ca2dd)" to "[c8a5e9687a9991faada7a5079332d2ba9d7ece72](https://github.com/sagemath/sagetrac-mirror/commit/c8a5e9687a9991faada7a5079332d2ba9d7ece72)".



---

archive/issue_comments_294796.json:
```json
{
    "body": "<a id='comment:5'></a>\nThis is silly:\n\n```\nstrncmp(t.__module__, \"numpy\", 5) == 0\n```\nEither you use Python or you use C, but I don't understand why this strange mixture. Anyway, I really want this check to be very fast, so we might need to think if we can make this more efficient.",
    "created_at": "2016-03-27T07:36:45Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294796",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
This is silly:

```
strncmp(t.__module__, "numpy", 5) == 0
```
Either you use Python or you use C, but I don't understand why this strange mixture. Anyway, I really want this check to be very fast, so we might need to think if we can make this more efficient.



---

archive/issue_comments_294797.json:
```json
{
    "body": "**Changing commit** from \"[c8a5e9687a9991faada7a5079332d2ba9d7ece72](https://github.com/sagemath/sagetrac-mirror/commit/c8a5e9687a9991faada7a5079332d2ba9d7ece72)\" to \"[02fb33195dffad7da19a5481aaade6253b8e3029](https://github.com/sagemath/sagetrac-mirror/commit/02fb33195dffad7da19a5481aaade6253b8e3029)\".",
    "created_at": "2016-03-27T08:56:13Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294797",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[c8a5e9687a9991faada7a5079332d2ba9d7ece72](https://github.com/sagemath/sagetrac-mirror/commit/c8a5e9687a9991faada7a5079332d2ba9d7ece72)" to "[02fb33195dffad7da19a5481aaade6253b8e3029](https://github.com/sagemath/sagetrac-mirror/commit/02fb33195dffad7da19a5481aaade6253b8e3029)".



---

archive/issue_comments_294798.json:
```json
{
    "body": "<a id='comment:6'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/02fb33195dffad7da19a5481aaade6253b8e3029\">02fb331</a></td><td><code>Ticket 20293: cythonize checkfor t.__module__ in is_numpy_type</code></td></tr></table>\n",
    "created_at": "2016-03-27T08:56:13Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294798",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/02fb33195dffad7da19a5481aaade6253b8e3029">02fb331</a></td><td><code>Ticket 20293: cythonize checkfor t.__module__ in is_numpy_type</code></td></tr></table>




---

archive/issue_comments_294799.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [jdemeyer](#comment%3A5):\n> This is silly:\n> \n> ```\n> strncmp(t.__module__, \"numpy\", 5) == 0\n> ```\n> Either you use Python or you use C, but I don't understand why this strange mixture. Anyway, I really want this check to be very fast, so we might need to think if we can make this more efficient.\n\n\nHere you go, the check has now been cythonized (by a non-cython programmer who just hopes that the refcounts work out alright).",
    "created_at": "2016-03-27T09:03:19Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294799",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:7'></a>
Replying to [jdemeyer](#comment%3A5):
> This is silly:
> 
> ```
> strncmp(t.__module__, "numpy", 5) == 0
> ```
> Either you use Python or you use C, but I don't understand why this strange mixture. Anyway, I really want this check to be very fast, so we might need to think if we can make this more efficient.


Here you go, the check has now been cythonized (by a non-cython programmer who just hopes that the refcounts work out alright).



---

archive/issue_comments_294800.json:
```json
{
    "body": "**Changing commit** from \"[02fb33195dffad7da19a5481aaade6253b8e3029](https://github.com/sagemath/sagetrac-mirror/commit/02fb33195dffad7da19a5481aaade6253b8e3029)\" to \"[245444216aa1a83bced97ee64dceddaf65aff751](https://github.com/sagemath/sagetrac-mirror/commit/245444216aa1a83bced97ee64dceddaf65aff751)\".",
    "created_at": "2016-03-27T09:38:15Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294800",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[02fb33195dffad7da19a5481aaade6253b8e3029](https://github.com/sagemath/sagetrac-mirror/commit/02fb33195dffad7da19a5481aaade6253b8e3029)" to "[245444216aa1a83bced97ee64dceddaf65aff751](https://github.com/sagemath/sagetrac-mirror/commit/245444216aa1a83bced97ee64dceddaf65aff751)".



---

archive/issue_comments_294801.json:
```json
{
    "body": "<a id='comment:8'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/245444216aa1a83bced97ee64dceddaf65aff751\">2454442</a></td><td><code>Ticket 20293: remove old check for tp_name in is_numpy_type</code></td></tr></table>\n",
    "created_at": "2016-03-27T09:38:15Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294801",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/245444216aa1a83bced97ee64dceddaf65aff751">2454442</a></td><td><code>Ticket 20293: remove old check for tp_name in is_numpy_type</code></td></tr></table>




---

archive/issue_comments_294802.json:
```json
{
    "body": "<a id='comment:9'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/76231ad55395fcdf8d7a166109dc85f23ada6a26\">76231ad</a></td><td><code>Ticket 20293: handle types without `__module__` attribute gracefully in is_numpy_type</code></td></tr></table>\n",
    "created_at": "2016-03-27T10:10:59Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294802",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/76231ad55395fcdf8d7a166109dc85f23ada6a26">76231ad</a></td><td><code>Ticket 20293: handle types without `__module__` attribute gracefully in is_numpy_type</code></td></tr></table>




---

archive/issue_comments_294803.json:
```json
{
    "body": "**Changing commit** from \"[245444216aa1a83bced97ee64dceddaf65aff751](https://github.com/sagemath/sagetrac-mirror/commit/245444216aa1a83bced97ee64dceddaf65aff751)\" to \"[76231ad55395fcdf8d7a166109dc85f23ada6a26](https://github.com/sagemath/sagetrac-mirror/commit/76231ad55395fcdf8d7a166109dc85f23ada6a26)\".",
    "created_at": "2016-03-27T10:10:59Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294803",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[245444216aa1a83bced97ee64dceddaf65aff751](https://github.com/sagemath/sagetrac-mirror/commit/245444216aa1a83bced97ee64dceddaf65aff751)" to "[76231ad55395fcdf8d7a166109dc85f23ada6a26](https://github.com/sagemath/sagetrac-mirror/commit/76231ad55395fcdf8d7a166109dc85f23ada6a26)".



---

archive/issue_comments_294804.json:
```json
{
    "body": "<a id='comment:10'></a>\nTo keep it fast, one way would be to acces to the `tp_bases` field and check whether one of them actually is a numpy type. Though it seems that Cython does not know its existence!",
    "created_at": "2016-03-29T03:17:24Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294804",
    "user": "https://github.com/videlec"
}
```

<a id='comment:10'></a>
To keep it fast, one way would be to acces to the `tp_bases` field and check whether one of them actually is a numpy type. Though it seems that Cython does not know its existence!



---

archive/issue_comments_294805.json:
```json
{
    "body": "<a id='comment:11'></a>\nOne other solution would be to leave `is_numpy_type` as it is since it seems to work for scalar types and that seems to be its main use-case in the sage library. Then only the matrix constructor should be changed: it should `import numpy` and check for `isinstance(arg,numpy.ndarray)`.\n\nI'm not going to implement that, though, since I'm away on vacation, starting now.",
    "created_at": "2016-03-29T08:32:55Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294805",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:11'></a>
One other solution would be to leave `is_numpy_type` as it is since it seems to work for scalar types and that seems to be its main use-case in the sage library. Then only the matrix constructor should be changed: it should `import numpy` and check for `isinstance(arg,numpy.ndarray)`.

I'm not going to implement that, though, since I'm away on vacation, starting now.



---

archive/issue_events_182169.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2016-03-29T08:33:36Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20293#event-182169"
}
```



---

archive/issue_events_182170.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2016-03-29T08:33:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20293#event-182170"
}
```



---

archive/issue_comments_294806.json:
```json
{
    "body": "**Changing commit** from \"[76231ad55395fcdf8d7a166109dc85f23ada6a26](https://github.com/sagemath/sagetrac-mirror/commit/76231ad55395fcdf8d7a166109dc85f23ada6a26)\" to \"[2a286dbd5b51e5d3afe32fa09c1bb32ea3715922](https://github.com/sagemath/sagetrac-mirror/commit/2a286dbd5b51e5d3afe32fa09c1bb32ea3715922)\".",
    "created_at": "2016-04-12T10:51:32Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294806",
    "user": "https://github.com/cnassau"
}
```

**Changing commit** from "[76231ad55395fcdf8d7a166109dc85f23ada6a26](https://github.com/sagemath/sagetrac-mirror/commit/76231ad55395fcdf8d7a166109dc85f23ada6a26)" to "[2a286dbd5b51e5d3afe32fa09c1bb32ea3715922](https://github.com/sagemath/sagetrac-mirror/commit/2a286dbd5b51e5d3afe32fa09c1bb32ea3715922)".



---

archive/issue_comments_294807.json:
```json
{
    "body": "<a id='comment:13'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2a286dbd5b51e5d3afe32fa09c1bb32ea3715922\">2a286db</a></td><td><code>Ticket 20293: make matrix constructor work again with numpy.matrix arguments</code></td></tr></table>\n",
    "created_at": "2016-04-12T10:51:32Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294807",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:13'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2a286dbd5b51e5d3afe32fa09c1bb32ea3715922">2a286db</a></td><td><code>Ticket 20293: make matrix constructor work again with numpy.matrix arguments</code></td></tr></table>




---

archive/issue_comments_294808.json:
```json
{
    "body": "**Changing branch** from \"[u/cnassau/numpy-matrix-2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/numpy-matrix-2)\" to \"[u/cnassau/numpy-matrix-constructor](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/numpy-matrix-constructor)\".",
    "created_at": "2016-04-12T10:51:32Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294808",
    "user": "https://github.com/cnassau"
}
```

**Changing branch** from "[u/cnassau/numpy-matrix-2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/numpy-matrix-2)" to "[u/cnassau/numpy-matrix-constructor](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/numpy-matrix-constructor)".



---

archive/issue_comments_294809.json:
```json
{
    "body": "**Changing commit** from \"[2a286dbd5b51e5d3afe32fa09c1bb32ea3715922](https://github.com/sagemath/sagetrac-mirror/commit/2a286dbd5b51e5d3afe32fa09c1bb32ea3715922)\" to \"[5effdac04626b8b165f12af5a90f8d802cd02208](https://github.com/sagemath/sagetrac-mirror/commit/5effdac04626b8b165f12af5a90f8d802cd02208)\".",
    "created_at": "2016-04-12T10:57:34Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294809",
    "user": "https://github.com/cnassau"
}
```

**Changing commit** from "[2a286dbd5b51e5d3afe32fa09c1bb32ea3715922](https://github.com/sagemath/sagetrac-mirror/commit/2a286dbd5b51e5d3afe32fa09c1bb32ea3715922)" to "[5effdac04626b8b165f12af5a90f8d802cd02208](https://github.com/sagemath/sagetrac-mirror/commit/5effdac04626b8b165f12af5a90f8d802cd02208)".



---

archive/issue_comments_294810.json:
```json
{
    "body": "**Changing branch** from \"[u/cnassau/numpy-matrix-constructor](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/numpy-matrix-constructor)\" to \"[u/cnassau/numpy-matrix-constructor-2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/numpy-matrix-constructor-2)\".",
    "created_at": "2016-04-12T10:57:34Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294810",
    "user": "https://github.com/cnassau"
}
```

**Changing branch** from "[u/cnassau/numpy-matrix-constructor](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/numpy-matrix-constructor)" to "[u/cnassau/numpy-matrix-constructor-2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/numpy-matrix-constructor-2)".



---

archive/issue_comments_294811.json:
```json
{
    "body": "<a id='comment:14'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5effdac04626b8b165f12af5a90f8d802cd02208\">5effdac</a></td><td><code>Ticket 20293: make matrix constructor work again with numpy.matrix arguments</code></td></tr></table>\n",
    "created_at": "2016-04-12T10:57:34Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294811",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:14'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5effdac04626b8b165f12af5a90f8d802cd02208">5effdac</a></td><td><code>Ticket 20293: make matrix constructor work again with numpy.matrix arguments</code></td></tr></table>




---

archive/issue_comments_294812.json:
```json
{
    "body": "**Changing branch** from \"[u/cnassau/numpy-matrix-constructor-2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/numpy-matrix-constructor-2)\" to \"[u/cnassau/numpy-matrix-constructor-3](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/numpy-matrix-constructor-3)\".",
    "created_at": "2016-04-12T10:59:06Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294812",
    "user": "https://github.com/cnassau"
}
```

**Changing branch** from "[u/cnassau/numpy-matrix-constructor-2](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/numpy-matrix-constructor-2)" to "[u/cnassau/numpy-matrix-constructor-3](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/numpy-matrix-constructor-3)".



---

archive/issue_comments_294813.json:
```json
{
    "body": "<a id='comment:15'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/050d97dd40dd56bf6d78e71129c24de3ae1d6bd2\">050d97d</a></td><td><code>Ticket 20293: make matrix constructor work again with numpy.matrix arguments</code></td></tr></table>\n\nThe matrix constructor has been slightly changed:\n\n* it uses a new function \"might_be_numpy_array\" to test for numpy array/matrix objects before actually importing numpy. This way the function \"is_numpy_type\" (which is geared towards numpy scalar types) can remain as fast as it was. The new function currently checks for the presence of the \"newbyteorder\" method.\n\n* the conversion from numpy array/matrix to python lists now uses the numpy \"tolist\" method. The old code no longer worked for numpy.matrix objects (only numpy.array).",
    "created_at": "2016-04-12T10:59:06Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294813",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:15'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/050d97dd40dd56bf6d78e71129c24de3ae1d6bd2">050d97d</a></td><td><code>Ticket 20293: make matrix constructor work again with numpy.matrix arguments</code></td></tr></table>

The matrix constructor has been slightly changed:

* it uses a new function "might_be_numpy_array" to test for numpy array/matrix objects before actually importing numpy. This way the function "is_numpy_type" (which is geared towards numpy scalar types) can remain as fast as it was. The new function currently checks for the presence of the "newbyteorder" method.

* the conversion from numpy array/matrix to python lists now uses the numpy "tolist" method. The old code no longer worked for numpy.matrix objects (only numpy.array).



---

archive/issue_comments_294814.json:
```json
{
    "body": "**Changing commit** from \"[5effdac04626b8b165f12af5a90f8d802cd02208](https://github.com/sagemath/sagetrac-mirror/commit/5effdac04626b8b165f12af5a90f8d802cd02208)\" to \"[050d97dd40dd56bf6d78e71129c24de3ae1d6bd2](https://github.com/sagemath/sagetrac-mirror/commit/050d97dd40dd56bf6d78e71129c24de3ae1d6bd2)\".",
    "created_at": "2016-04-12T10:59:06Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294814",
    "user": "https://github.com/cnassau"
}
```

**Changing commit** from "[5effdac04626b8b165f12af5a90f8d802cd02208](https://github.com/sagemath/sagetrac-mirror/commit/5effdac04626b8b165f12af5a90f8d802cd02208)" to "[050d97dd40dd56bf6d78e71129c24de3ae1d6bd2](https://github.com/sagemath/sagetrac-mirror/commit/050d97dd40dd56bf6d78e71129c24de3ae1d6bd2)".



---

archive/issue_events_182171.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2016-04-12T11:06:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20293#event-182171"
}
```



---

archive/issue_events_182172.json:
```json
{
    "actor": "https://github.com/cnassau",
    "created_at": "2016-04-12T11:06:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20293#event-182172"
}
```



---

archive/issue_comments_294815.json:
```json
{
    "body": "<a id='comment:17'></a>\nI didn't realize that `matrix` was a subtype of `numpy.ndarray`. This actually gives a much simpler solution: just check the base type. I will look into this right now.",
    "created_at": "2016-04-12T11:22:27Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294815",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>
I didn't realize that `matrix` was a subtype of `numpy.ndarray`. This actually gives a much simpler solution: just check the base type. I will look into this right now.



---

archive/issue_events_182173.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-04-12T11:35:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20293#event-182173"
}
```



---

archive/issue_events_182174.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-04-12T11:35:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20293#event-182174"
}
```



---

archive/issue_comments_294816.json:
```json
{
    "body": "**Changing author** from \"Christian Nassau\" to \"Christian Nassau, Jeroen Demeyer\".",
    "created_at": "2016-04-12T11:35:55Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294816",
    "user": "https://github.com/jdemeyer"
}
```

**Changing author** from "Christian Nassau" to "Christian Nassau, Jeroen Demeyer".



---

archive/issue_comments_294817.json:
```json
{
    "body": "**Changing branch** from \"[u/cnassau/numpy-matrix-constructor-3](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/numpy-matrix-constructor-3)\" to \"[u/jdemeyer/numpy-matrix-constructor-3](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/numpy-matrix-constructor-3)\".",
    "created_at": "2016-04-12T11:36:15Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294817",
    "user": "https://github.com/jdemeyer"
}
```

**Changing branch** from "[u/cnassau/numpy-matrix-constructor-3](https://github.com/sagemath/sagetrac-mirror/tree/u/cnassau/numpy-matrix-constructor-3)" to "[u/jdemeyer/numpy-matrix-constructor-3](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/numpy-matrix-constructor-3)".



---

archive/issue_events_182175.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-04-12T11:36:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20293#event-182175"
}
```



---

archive/issue_events_182176.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-04-12T11:36:27Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20293#event-182176"
}
```



---

archive/issue_comments_294818.json:
```json
{
    "body": "<a id='comment:20'></a>\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e1ec418a0bdcb8a6a82d872e9deef6c660b9348f\">e1ec418</a></td><td><code>Support numpy.matrix in is_numpy_type()</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c5cad5d6321d8755ce456370c6054f5206e64020\">c5cad5d</a></td><td><code>Doctest conversion numpy.matrix -> Sage matrix</code></td></tr></table>\n",
    "created_at": "2016-04-12T11:36:27Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294818",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e1ec418a0bdcb8a6a82d872e9deef6c660b9348f">e1ec418</a></td><td><code>Support numpy.matrix in is_numpy_type()</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c5cad5d6321d8755ce456370c6054f5206e64020">c5cad5d</a></td><td><code>Doctest conversion numpy.matrix -> Sage matrix</code></td></tr></table>




---

archive/issue_comments_294819.json:
```json
{
    "body": "**Changing commit** from \"[050d97dd40dd56bf6d78e71129c24de3ae1d6bd2](https://github.com/sagemath/sagetrac-mirror/commit/050d97dd40dd56bf6d78e71129c24de3ae1d6bd2)\" to \"[c5cad5d6321d8755ce456370c6054f5206e64020](https://github.com/sagemath/sagetrac-mirror/commit/c5cad5d6321d8755ce456370c6054f5206e64020)\".",
    "created_at": "2016-04-12T11:36:27Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294819",
    "user": "https://github.com/jdemeyer"
}
```

**Changing commit** from "[050d97dd40dd56bf6d78e71129c24de3ae1d6bd2](https://github.com/sagemath/sagetrac-mirror/commit/050d97dd40dd56bf6d78e71129c24de3ae1d6bd2)" to "[c5cad5d6321d8755ce456370c6054f5206e64020](https://github.com/sagemath/sagetrac-mirror/commit/c5cad5d6321d8755ce456370c6054f5206e64020)".



---

archive/issue_comments_294820.json:
```json
{
    "body": "<a id='comment:21'></a>\nSimple solution! Though, Sage would recognize any extension type that inherits from ndarray as a numpy object, right?",
    "created_at": "2016-04-12T15:04:45Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294820",
    "user": "https://github.com/videlec"
}
```

<a id='comment:21'></a>
Simple solution! Though, Sage would recognize any extension type that inherits from ndarray as a numpy object, right?



---

archive/issue_comments_294821.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [vdelecroix](#comment%3A21):\n> Sage would recognize any extension type that inherits from ndarray as a numpy object, right?\n\n\nYes, and I think that's probably the right thing to do anyway.",
    "created_at": "2016-04-12T15:09:17Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294821",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>
Replying to [vdelecroix](#comment%3A21):
> Sage would recognize any extension type that inherits from ndarray as a numpy object, right?


Yes, and I think that's probably the right thing to do anyway.



---

archive/issue_comments_294822.json:
```json
{
    "body": "<a id='comment:23'></a>\nWhy not\n\n```\nreturn strncmp(T.tp_name, \"numpy.\", 6) == 0 or \\\n       strncmp(T.tp_base.tp_name, \"numpy.\", 6) == 0\n```",
    "created_at": "2016-04-12T15:14:58Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294822",
    "user": "https://github.com/videlec"
}
```

<a id='comment:23'></a>
Why not

```
return strncmp(T.tp_name, "numpy.", 6) == 0 or \
       strncmp(T.tp_base.tp_name, "numpy.", 6) == 0
```



---

archive/issue_comments_294823.json:
```json
{
    "body": "<a id='comment:24'></a>\nReadability?",
    "created_at": "2016-04-12T15:17:01Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294823",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>
Readability?



---

archive/issue_comments_294824.json:
```json
{
    "body": "<a id='comment:25'></a>\nI guess this is a personal matter...",
    "created_at": "2016-04-12T15:45:42Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294824",
    "user": "https://github.com/videlec"
}
```

<a id='comment:25'></a>
I guess this is a personal matter...



---

archive/issue_comments_294825.json:
```json
{
    "body": "**Reviewer:** Vincent Delecroix",
    "created_at": "2016-04-12T15:45:42Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294825",
    "user": "https://github.com/videlec"
}
```

**Reviewer:** Vincent Delecroix



---

archive/issue_events_182177.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2016-04-12T15:45:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20293#event-182177"
}
```



---

archive/issue_events_182178.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2016-04-12T15:45:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20293#event-182178"
}
```



---

archive/issue_comments_294826.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [jdemeyer](#comment%3A20):\n> **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e1ec418a0bdcb8a6a82d872e9deef6c660b9348f\">e1ec418</a></td><td><code>Support numpy.matrix in is_numpy_type()</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c5cad5d6321d8755ce456370c6054f5206e64020\">c5cad5d</a></td><td><code>Doctest conversion numpy.matrix -> Sage matrix</code></td></tr></table>\n\n\nThanks for getting this fixed!",
    "created_at": "2016-04-12T18:16:24Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294826",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:26'></a>
Replying to [jdemeyer](#comment%3A20):
> **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e1ec418a0bdcb8a6a82d872e9deef6c660b9348f">e1ec418</a></td><td><code>Support numpy.matrix in is_numpy_type()</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c5cad5d6321d8755ce456370c6054f5206e64020">c5cad5d</a></td><td><code>Doctest conversion numpy.matrix -> Sage matrix</code></td></tr></table>


Thanks for getting this fixed!



---

archive/issue_events_182179.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-04-13T17:05:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20293#event-182179"
}
```



---

archive/issue_events_182180.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "59fabc5e7dc1c31e4a5406f5e40c093a1586706c",
    "created_at": "2016-04-13T17:05:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20293#event-182180"
}
```



---

archive/issue_comments_294827.json:
```json
{
    "body": "**Changing branch** from \"[u/jdemeyer/numpy-matrix-constructor-3](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/numpy-matrix-constructor-3)\" to \"[c5cad5d6321d8755ce456370c6054f5206e64020](https://github.com/sagemath/sagetrac-mirror/commit/c5cad5d6321d8755ce456370c6054f5206e64020)\".",
    "created_at": "2016-04-13T17:05:16Z",
    "issue": "https://github.com/sagemath/sage/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20293#issuecomment-294827",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/jdemeyer/numpy-matrix-constructor-3](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/numpy-matrix-constructor-3)" to "[c5cad5d6321d8755ce456370c6054f5206e64020](https://github.com/sagemath/sagetrac-mirror/commit/c5cad5d6321d8755ce456370c6054f5206e64020)".
