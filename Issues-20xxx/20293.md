# Issue 20293: matrix constructor fails on numpy.matrix

archive/issues_020056.json:
```json
{
    "body": "This failure seems to be new in Sage.7.2.beta0 \n\n```\nsage: import numpy\nsage: n = numpy.matrix([[1,2],[3,4]],float)\nsage: matrix(n)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-7-649197712655> in <module>()\n----> 1 matrix(n)\n\n/waste/cn/sage-git/src/sage/matrix/constructor.pyx in sage.matrix.constructor.MatrixFactory.__call__ (/waste/cn/sage-git/src/build/cythonized/sage/matrix/constructor.c:6357)()\n    741                     entries = arg\n    742                 else:\n--> 743                     raise TypeError(\"invalid matrix constructor: type matrix? for help\")\n    744         else:  # len(args) >= 2\n    745             raise TypeError(\"invalid matrix constructor: type matrix? for help\")\n\nTypeError: invalid matrix constructor: type matrix? for help\n```\n\nUsing `numpy.array` instead of `numpy.matrix` still works (and is doctested).  \n\n\nKeywords: numpy, matrix\n\nBranch/Commit: c5cad5d6321d8755ce456370c6054f5206e64020\n\nReviewer: Vincent Delecroix\n\nAuthor: Christian Nassau, Jeroen Demeyer\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20293\n\n",
    "closed_at": "2016-04-13T17:05:16Z",
    "created_at": "2016-03-25T17:26:39Z",
    "labels": [
        "component: numerical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "matrix constructor fails on numpy.matrix",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20293",
    "user": "https://github.com/cnassau"
}
```
This failure seems to be new in Sage.7.2.beta0 

```
sage: import numpy
sage: n = numpy.matrix([[1,2],[3,4]],float)
sage: matrix(n)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-7-649197712655> in <module>()
----> 1 matrix(n)

/waste/cn/sage-git/src/sage/matrix/constructor.pyx in sage.matrix.constructor.MatrixFactory.__call__ (/waste/cn/sage-git/src/build/cythonized/sage/matrix/constructor.c:6357)()
    741                     entries = arg
    742                 else:
--> 743                     raise TypeError("invalid matrix constructor: type matrix? for help")
    744         else:  # len(args) >= 2
    745             raise TypeError("invalid matrix constructor: type matrix? for help")

TypeError: invalid matrix constructor: type matrix? for help
```

Using `numpy.array` instead of `numpy.matrix` still works (and is doctested).  


Keywords: numpy, matrix

Branch/Commit: c5cad5d6321d8755ce456370c6054f5206e64020

Reviewer: Vincent Delecroix

Author: Christian Nassau, Jeroen Demeyer

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/20293





---

archive/issue_comments_367780.json:
```json
{
    "body": "<a id='comment:1'></a>\nI think the reason might be that with Sage 7.2.beta0 the numpy.matrix is not recognized as a numpy type:\n\n```\nsage: import numpy\nsage: n = numpy.matrix([[1,2],[3,4]],float)\nsage: from sage.structure.coerce import is_numpy_type\nsage: is_numpy_type(type(n))\nFalse\n```\n\nThe code in `is_numpy_type` checks whether the `tp_name` field of its argument begins with \"numpy.\"; in this case the `tp_name` is just \"`matrix`\". Maybe we should check `type(n).__module__` instead, since the official doc \n   https://docs.python.org/2/c-api/typeobj.html#c.PyTypeObject.tp_name\nsays that \"dynamically allocated types\" should not contain the module name in the `tp_type`. \n\n```\nsage: n = numpy.matrix([[1,2],[3,4]],float)\nsage: type(n).__module__\n'numpy.matrixlib.defmatrix'\nsage: n = numpy.array([[1,2],[3,4]],float)\nsage: type(n).__module__\n'numpy'\n```\nI currently do not know how to code this check in cython, though.",
    "created_at": "2016-03-25T18:11:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367780",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:1'></a>
I think the reason might be that with Sage 7.2.beta0 the numpy.matrix is not recognized as a numpy type:

```
sage: import numpy
sage: n = numpy.matrix([[1,2],[3,4]],float)
sage: from sage.structure.coerce import is_numpy_type
sage: is_numpy_type(type(n))
False
```

The code in `is_numpy_type` checks whether the `tp_name` field of its argument begins with "numpy."; in this case the `tp_name` is just "`matrix`". Maybe we should check `type(n).__module__` instead, since the official doc 
   https://docs.python.org/2/c-api/typeobj.html#c.PyTypeObject.tp_name
says that "dynamically allocated types" should not contain the module name in the `tp_type`. 

```
sage: n = numpy.matrix([[1,2],[3,4]],float)
sage: type(n).__module__
'numpy.matrixlib.defmatrix'
sage: n = numpy.array([[1,2],[3,4]],float)
sage: type(n).__module__
'numpy'
```
I currently do not know how to code this check in cython, though.



---

archive/issue_comments_367781.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-03-25T21:36:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367781",
    "user": "https://github.com/cnassau"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_367782.json:
```json
{
    "body": "Changing commit from \"\" to \"d58e8456583eb9adf25a06c555d9d0f9766ca2dd\"",
    "created_at": "2016-03-25T21:36:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367782",
    "user": "https://github.com/cnassau"
}
```

Changing commit from "" to "d58e8456583eb9adf25a06c555d9d0f9766ca2dd"



---

archive/issue_comments_367783.json:
```json
{
    "body": "Changing branch from \"\" to \"u/cnassau/numpy-matrix\"",
    "created_at": "2016-03-25T21:36:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367783",
    "user": "https://github.com/cnassau"
}
```

Changing branch from "" to "u/cnassau/numpy-matrix"



---

archive/issue_comments_367784.json:
```json
{
    "body": "Changing author from \"\" to \"Christian Nassau\"",
    "created_at": "2016-03-25T21:37:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367784",
    "user": "https://github.com/cnassau"
}
```

Changing author from "" to "Christian Nassau"



---

archive/issue_comments_367785.json:
```json
{
    "body": "<a id='comment:4'></a>\nNew commits:\n|                                                                                                                                          |                                          |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------|\n|[c8a5e96](http://git.sagemath.org/sage.git/commit/?id=c8a5e9687a9991faada7a5079332d2ba9d7ece72)|`Ticket 20293: fix numpy type recognition`|",
    "created_at": "2016-03-26T06:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367785",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:4'></a>
New commits:
|                                                                                                                                          |                                          |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------|
|[c8a5e96](http://git.sagemath.org/sage.git/commit/?id=c8a5e9687a9991faada7a5079332d2ba9d7ece72)|`Ticket 20293: fix numpy type recognition`|



---

archive/issue_comments_367786.json:
```json
{
    "body": "Changing branch from \"u/cnassau/numpy-matrix\" to \"u/cnassau/numpy-matrix-2\"",
    "created_at": "2016-03-26T06:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367786",
    "user": "https://github.com/cnassau"
}
```

Changing branch from "u/cnassau/numpy-matrix" to "u/cnassau/numpy-matrix-2"



---

archive/issue_comments_367787.json:
```json
{
    "body": "Changing commit from \"d58e8456583eb9adf25a06c555d9d0f9766ca2dd\" to \"c8a5e9687a9991faada7a5079332d2ba9d7ece72\"",
    "created_at": "2016-03-26T06:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367787",
    "user": "https://github.com/cnassau"
}
```

Changing commit from "d58e8456583eb9adf25a06c555d9d0f9766ca2dd" to "c8a5e9687a9991faada7a5079332d2ba9d7ece72"



---

archive/issue_comments_367788.json:
```json
{
    "body": "<a id='comment:5'></a>\nThis is silly:\n\n```\nstrncmp(t.__module__, \"numpy\", 5) == 0\n```\nEither you use Python or you use C, but I don't understand why this strange mixture. Anyway, I really want this check to be very fast, so we might need to think if we can make this more efficient.",
    "created_at": "2016-03-27T07:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367788",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
This is silly:

```
strncmp(t.__module__, "numpy", 5) == 0
```
Either you use Python or you use C, but I don't understand why this strange mixture. Anyway, I really want this check to be very fast, so we might need to think if we can make this more efficient.



---

archive/issue_comments_367789.json:
```json
{
    "body": "Changing commit from \"c8a5e9687a9991faada7a5079332d2ba9d7ece72\" to \"02fb33195dffad7da19a5481aaade6253b8e3029\"",
    "created_at": "2016-03-27T08:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367789",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c8a5e9687a9991faada7a5079332d2ba9d7ece72" to "02fb33195dffad7da19a5481aaade6253b8e3029"



---

archive/issue_comments_367790.json:
```json
{
    "body": "<a id='comment:6'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                                                |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------|\n|[02fb331](http://git.sagemath.org/sage.git/commit/?id=02fb33195dffad7da19a5481aaade6253b8e3029)|`Ticket 20293: cythonize checkfor t.__module__ in is_numpy_type`|",
    "created_at": "2016-03-27T08:56:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367790",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                                                |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------|
|[02fb331](http://git.sagemath.org/sage.git/commit/?id=02fb33195dffad7da19a5481aaade6253b8e3029)|`Ticket 20293: cythonize checkfor t.__module__ in is_numpy_type`|



---

archive/issue_comments_367791.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [jdemeyer](#comment%3A5):\n> This is silly:\n> \n> ```\n> strncmp(t.__module__, \"numpy\", 5) == 0\n> ```\n> Either you use Python or you use C, but I don't understand why this strange mixture. Anyway, I really want this check to be very fast, so we might need to think if we can make this more efficient.\n\n\nHere you go, the check has now been cythonized (by a non-cython programmer who just hopes that the refcounts work out alright).",
    "created_at": "2016-03-27T09:03:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367791",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:7'></a>
Replying to [jdemeyer](#comment%3A5):
> This is silly:
> 
> ```
> strncmp(t.__module__, "numpy", 5) == 0
> ```
> Either you use Python or you use C, but I don't understand why this strange mixture. Anyway, I really want this check to be very fast, so we might need to think if we can make this more efficient.


Here you go, the check has now been cythonized (by a non-cython programmer who just hopes that the refcounts work out alright).



---

archive/issue_comments_367792.json:
```json
{
    "body": "Changing commit from \"02fb33195dffad7da19a5481aaade6253b8e3029\" to \"245444216aa1a83bced97ee64dceddaf65aff751\"",
    "created_at": "2016-03-27T09:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367792",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "02fb33195dffad7da19a5481aaade6253b8e3029" to "245444216aa1a83bced97ee64dceddaf65aff751"



---

archive/issue_comments_367793.json:
```json
{
    "body": "<a id='comment:8'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                                             |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------|\n|[2454442](http://git.sagemath.org/sage.git/commit/?id=245444216aa1a83bced97ee64dceddaf65aff751)|`Ticket 20293: remove old check for tp_name in is_numpy_type`|",
    "created_at": "2016-03-27T09:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367793",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                                             |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------|
|[2454442](http://git.sagemath.org/sage.git/commit/?id=245444216aa1a83bced97ee64dceddaf65aff751)|`Ticket 20293: remove old check for tp_name in is_numpy_type`|



---

archive/issue_comments_367794.json:
```json
{
    "body": "<a id='comment:9'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                                                                     |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------|\n|[76231ad](http://git.sagemath.org/sage.git/commit/?id=76231ad55395fcdf8d7a166109dc85f23ada6a26)|`Ticket 20293: handle types without __module__ attribute gracefully in is_numpy_type`|",
    "created_at": "2016-03-27T10:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367794",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                                                                     |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------|
|[76231ad](http://git.sagemath.org/sage.git/commit/?id=76231ad55395fcdf8d7a166109dc85f23ada6a26)|`Ticket 20293: handle types without __module__ attribute gracefully in is_numpy_type`|



---

archive/issue_comments_367795.json:
```json
{
    "body": "Changing commit from \"245444216aa1a83bced97ee64dceddaf65aff751\" to \"76231ad55395fcdf8d7a166109dc85f23ada6a26\"",
    "created_at": "2016-03-27T10:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367795",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "245444216aa1a83bced97ee64dceddaf65aff751" to "76231ad55395fcdf8d7a166109dc85f23ada6a26"



---

archive/issue_comments_367796.json:
```json
{
    "body": "<a id='comment:10'></a>\nTo keep it fast, one way would be to acces to the `tp_bases` field and check whether one of them actually is a numpy type. Though it seems that Cython does not know its existence!",
    "created_at": "2016-03-29T03:17:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367796",
    "user": "https://github.com/videlec"
}
```

<a id='comment:10'></a>
To keep it fast, one way would be to acces to the `tp_bases` field and check whether one of them actually is a numpy type. Though it seems that Cython does not know its existence!



---

archive/issue_comments_367797.json:
```json
{
    "body": "<a id='comment:11'></a>\nOne other solution would be to leave `is_numpy_type` as it is since it seems to work for scalar types and that seems to be its main use-case in the sage library. Then only the matrix constructor should be changed: it should `import numpy` and check for `isinstance(arg,numpy.ndarray)`.\n\nI'm not going to implement that, though, since I'm away on vacation, starting now.",
    "created_at": "2016-03-29T08:32:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367797",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:11'></a>
One other solution would be to leave `is_numpy_type` as it is since it seems to work for scalar types and that seems to be its main use-case in the sage library. Then only the matrix constructor should be changed: it should `import numpy` and check for `isinstance(arg,numpy.ndarray)`.

I'm not going to implement that, though, since I'm away on vacation, starting now.



---

archive/issue_comments_367798.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-03-29T08:33:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367798",
    "user": "https://github.com/cnassau"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_367799.json:
```json
{
    "body": "Changing commit from \"76231ad55395fcdf8d7a166109dc85f23ada6a26\" to \"2a286dbd5b51e5d3afe32fa09c1bb32ea3715922\"",
    "created_at": "2016-04-12T10:51:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367799",
    "user": "https://github.com/cnassau"
}
```

Changing commit from "76231ad55395fcdf8d7a166109dc85f23ada6a26" to "2a286dbd5b51e5d3afe32fa09c1bb32ea3715922"



---

archive/issue_comments_367800.json:
```json
{
    "body": "<a id='comment:13'></a>\nNew commits:\n|                                                                                                                                          |                                                                              |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------|\n|[2a286db](http://git.sagemath.org/sage.git/commit/?id=2a286dbd5b51e5d3afe32fa09c1bb32ea3715922)|`Ticket 20293: make matrix constructor work again with numpy.matrix arguments`|",
    "created_at": "2016-04-12T10:51:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367800",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:13'></a>
New commits:
|                                                                                                                                          |                                                                              |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------|
|[2a286db](http://git.sagemath.org/sage.git/commit/?id=2a286dbd5b51e5d3afe32fa09c1bb32ea3715922)|`Ticket 20293: make matrix constructor work again with numpy.matrix arguments`|



---

archive/issue_comments_367801.json:
```json
{
    "body": "Changing branch from \"u/cnassau/numpy-matrix-2\" to \"u/cnassau/numpy-matrix-constructor\"",
    "created_at": "2016-04-12T10:51:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367801",
    "user": "https://github.com/cnassau"
}
```

Changing branch from "u/cnassau/numpy-matrix-2" to "u/cnassau/numpy-matrix-constructor"



---

archive/issue_comments_367802.json:
```json
{
    "body": "Changing commit from \"2a286dbd5b51e5d3afe32fa09c1bb32ea3715922\" to \"5effdac04626b8b165f12af5a90f8d802cd02208\"",
    "created_at": "2016-04-12T10:57:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367802",
    "user": "https://github.com/cnassau"
}
```

Changing commit from "2a286dbd5b51e5d3afe32fa09c1bb32ea3715922" to "5effdac04626b8b165f12af5a90f8d802cd02208"



---

archive/issue_comments_367803.json:
```json
{
    "body": "Changing branch from \"u/cnassau/numpy-matrix-constructor\" to \"u/cnassau/numpy-matrix-constructor-2\"",
    "created_at": "2016-04-12T10:57:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367803",
    "user": "https://github.com/cnassau"
}
```

Changing branch from "u/cnassau/numpy-matrix-constructor" to "u/cnassau/numpy-matrix-constructor-2"



---

archive/issue_comments_367804.json:
```json
{
    "body": "<a id='comment:14'></a>\nNew commits:\n|                                                                                                                                          |                                                                              |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------|\n|[5effdac](http://git.sagemath.org/sage.git/commit/?id=5effdac04626b8b165f12af5a90f8d802cd02208)|`Ticket 20293: make matrix constructor work again with numpy.matrix arguments`|",
    "created_at": "2016-04-12T10:57:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367804",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:14'></a>
New commits:
|                                                                                                                                          |                                                                              |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------|
|[5effdac](http://git.sagemath.org/sage.git/commit/?id=5effdac04626b8b165f12af5a90f8d802cd02208)|`Ticket 20293: make matrix constructor work again with numpy.matrix arguments`|



---

archive/issue_comments_367805.json:
```json
{
    "body": "Changing branch from \"u/cnassau/numpy-matrix-constructor-2\" to \"u/cnassau/numpy-matrix-constructor-3\"",
    "created_at": "2016-04-12T10:59:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367805",
    "user": "https://github.com/cnassau"
}
```

Changing branch from "u/cnassau/numpy-matrix-constructor-2" to "u/cnassau/numpy-matrix-constructor-3"



---

archive/issue_comments_367806.json:
```json
{
    "body": "<a id='comment:15'></a>\nNew commits:\n|                                                                                                                                          |                                                                              |\n|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------|\n|[050d97d](http://git.sagemath.org/sage.git/commit/?id=050d97dd40dd56bf6d78e71129c24de3ae1d6bd2)|`Ticket 20293: make matrix constructor work again with numpy.matrix arguments`|\n\nThe matrix constructor has been slightly changed:\n\n* it uses a new function \"might_be_numpy_array\" to test for numpy array/matrix objects before actually importing numpy. This way the function \"is_numpy_type\" (which is geared towards numpy scalar types) can remain as fast as it was. The new function currently checks for the presence of the \"newbyteorder\" method.\n\n* the conversion from numpy array/matrix to python lists now uses the numpy \"tolist\" method. The old code no longer worked for numpy.matrix objects (only numpy.array).",
    "created_at": "2016-04-12T10:59:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367806",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:15'></a>
New commits:
|                                                                                                                                          |                                                                              |
|------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------|
|[050d97d](http://git.sagemath.org/sage.git/commit/?id=050d97dd40dd56bf6d78e71129c24de3ae1d6bd2)|`Ticket 20293: make matrix constructor work again with numpy.matrix arguments`|

The matrix constructor has been slightly changed:

* it uses a new function "might_be_numpy_array" to test for numpy array/matrix objects before actually importing numpy. This way the function "is_numpy_type" (which is geared towards numpy scalar types) can remain as fast as it was. The new function currently checks for the presence of the "newbyteorder" method.

* the conversion from numpy array/matrix to python lists now uses the numpy "tolist" method. The old code no longer worked for numpy.matrix objects (only numpy.array).



---

archive/issue_comments_367807.json:
```json
{
    "body": "Changing commit from \"5effdac04626b8b165f12af5a90f8d802cd02208\" to \"050d97dd40dd56bf6d78e71129c24de3ae1d6bd2\"",
    "created_at": "2016-04-12T10:59:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367807",
    "user": "https://github.com/cnassau"
}
```

Changing commit from "5effdac04626b8b165f12af5a90f8d802cd02208" to "050d97dd40dd56bf6d78e71129c24de3ae1d6bd2"



---

archive/issue_comments_367808.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-04-12T11:06:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367808",
    "user": "https://github.com/cnassau"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_367809.json:
```json
{
    "body": "<a id='comment:17'></a>\nI didn't realize that `matrix` was a subtype of `numpy.ndarray`. This actually gives a much simpler solution: just check the base type. I will look into this right now.",
    "created_at": "2016-04-12T11:22:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367809",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>
I didn't realize that `matrix` was a subtype of `numpy.ndarray`. This actually gives a much simpler solution: just check the base type. I will look into this right now.



---

archive/issue_comments_367810.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-04-12T11:35:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367810",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_367811.json:
```json
{
    "body": "Changing author from \"Christian Nassau\" to \"Christian Nassau, Jeroen Demeyer\"",
    "created_at": "2016-04-12T11:35:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367811",
    "user": "https://github.com/jdemeyer"
}
```

Changing author from "Christian Nassau" to "Christian Nassau, Jeroen Demeyer"



---

archive/issue_comments_367812.json:
```json
{
    "body": "Changing branch from \"u/cnassau/numpy-matrix-constructor-3\" to \"u/jdemeyer/numpy-matrix-constructor-3\"",
    "created_at": "2016-04-12T11:36:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367812",
    "user": "https://github.com/jdemeyer"
}
```

Changing branch from "u/cnassau/numpy-matrix-constructor-3" to "u/jdemeyer/numpy-matrix-constructor-3"



---

archive/issue_comments_367813.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-04-12T11:36:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367813",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_367814.json:
```json
{
    "body": "<a id='comment:20'></a>\nNew commits:\n|                                                                                                                                          |                                         |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------|\n|[e1ec418](http://git.sagemath.org/sage.git/commit/?id=e1ec418a0bdcb8a6a82d872e9deef6c660b9348f)|`Support numpy.matrix in is_numpy_type()`|\n|[c5cad5d](http://git.sagemath.org/sage.git/commit/?id=c5cad5d6321d8755ce456370c6054f5206e64020)|`Doctest conversion numpy.matrix -> Sage matrix`|",
    "created_at": "2016-04-12T11:36:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367814",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>
New commits:
|                                                                                                                                          |                                         |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------|
|[e1ec418](http://git.sagemath.org/sage.git/commit/?id=e1ec418a0bdcb8a6a82d872e9deef6c660b9348f)|`Support numpy.matrix in is_numpy_type()`|
|[c5cad5d](http://git.sagemath.org/sage.git/commit/?id=c5cad5d6321d8755ce456370c6054f5206e64020)|`Doctest conversion numpy.matrix -> Sage matrix`|



---

archive/issue_comments_367815.json:
```json
{
    "body": "Changing commit from \"050d97dd40dd56bf6d78e71129c24de3ae1d6bd2\" to \"c5cad5d6321d8755ce456370c6054f5206e64020\"",
    "created_at": "2016-04-12T11:36:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367815",
    "user": "https://github.com/jdemeyer"
}
```

Changing commit from "050d97dd40dd56bf6d78e71129c24de3ae1d6bd2" to "c5cad5d6321d8755ce456370c6054f5206e64020"



---

archive/issue_comments_367816.json:
```json
{
    "body": "<a id='comment:21'></a>\nSimple solution! Though, Sage would recognize any extension type that inherits from ndarray as a numpy object, right?",
    "created_at": "2016-04-12T15:04:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367816",
    "user": "https://github.com/videlec"
}
```

<a id='comment:21'></a>
Simple solution! Though, Sage would recognize any extension type that inherits from ndarray as a numpy object, right?



---

archive/issue_comments_367817.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [vdelecroix](#comment%3A21):\n> Sage would recognize any extension type that inherits from ndarray as a numpy object, right?\n\n\nYes, and I think that's probably the right thing to do anyway.",
    "created_at": "2016-04-12T15:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367817",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:22'></a>
Replying to [vdelecroix](#comment%3A21):
> Sage would recognize any extension type that inherits from ndarray as a numpy object, right?


Yes, and I think that's probably the right thing to do anyway.



---

archive/issue_comments_367818.json:
```json
{
    "body": "<a id='comment:23'></a>\nWhy not\n\n```\nreturn strncmp(T.tp_name, \"numpy.\", 6) == 0 or \\\n       strncmp(T.tp_base.tp_name, \"numpy.\", 6) == 0\n```",
    "created_at": "2016-04-12T15:14:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367818",
    "user": "https://github.com/videlec"
}
```

<a id='comment:23'></a>
Why not

```
return strncmp(T.tp_name, "numpy.", 6) == 0 or \
       strncmp(T.tp_base.tp_name, "numpy.", 6) == 0
```



---

archive/issue_comments_367819.json:
```json
{
    "body": "<a id='comment:24'></a>\nReadability?",
    "created_at": "2016-04-12T15:17:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367819",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>
Readability?



---

archive/issue_comments_367820.json:
```json
{
    "body": "<a id='comment:25'></a>\nI guess this is a personal matter...",
    "created_at": "2016-04-12T15:45:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367820",
    "user": "https://github.com/videlec"
}
```

<a id='comment:25'></a>
I guess this is a personal matter...



---

archive/issue_comments_367821.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Vincent Delecroix\"",
    "created_at": "2016-04-12T15:45:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367821",
    "user": "https://github.com/videlec"
}
```

Changing reviewer from "" to "Vincent Delecroix"



---

archive/issue_comments_367822.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-04-12T15:45:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367822",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_367823.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [jdemeyer](#comment%3A20):\n> New commits:\n> |                                                                                                                                          |                                         |\n> |------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------|\n> |[e1ec418](http://git.sagemath.org/sage.git/commit/?id=e1ec418a0bdcb8a6a82d872e9deef6c660b9348f)|`Support numpy.matrix in is_numpy_type()`|\n> |[c5cad5d](http://git.sagemath.org/sage.git/commit/?id=c5cad5d6321d8755ce456370c6054f5206e64020)|`Doctest conversion numpy.matrix -> Sage matrix`|\n\n\nThanks for getting this fixed!",
    "created_at": "2016-04-12T18:16:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367823",
    "user": "https://github.com/cnassau"
}
```

<a id='comment:26'></a>
Replying to [jdemeyer](#comment%3A20):
> New commits:
> |                                                                                                                                          |                                         |
> |------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------|
> |[e1ec418](http://git.sagemath.org/sage.git/commit/?id=e1ec418a0bdcb8a6a82d872e9deef6c660b9348f)|`Support numpy.matrix in is_numpy_type()`|
> |[c5cad5d](http://git.sagemath.org/sage.git/commit/?id=c5cad5d6321d8755ce456370c6054f5206e64020)|`Doctest conversion numpy.matrix -> Sage matrix`|


Thanks for getting this fixed!



---

archive/issue_events_055054.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-04-13T17:05:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20293#event-55054"
}
```



---

archive/issue_comments_367824.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-04-13T17:05:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367824",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_367825.json:
```json
{
    "body": "Changing branch from \"u/jdemeyer/numpy-matrix-constructor-3\" to \"c5cad5d6321d8755ce456370c6054f5206e64020\"",
    "created_at": "2016-04-13T17:05:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20293#issuecomment-367825",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jdemeyer/numpy-matrix-constructor-3" to "c5cad5d6321d8755ce456370c6054f5206e64020"
