# Issue 20312: parent of argument lost with Functions

archive/issues_020075.json:
```json
{
    "body": "Some Python objects as function arguments lose their parent, i.e. the code in the specific function can no longer access it because the object was coerced into SR. This can result in violation of the rule that function input and output should be of the same type.\n\n```\nsage: S.<y> = PolynomialRing(RR)\nsage: ex = sin(asin(y)); ex\ny\nsage: type(ex)\n<type 'sage.symbolic.expression.Expression'>\nsage: ex.is_symbol()\nTrue\n```\nThe specific function (here sin) code cannot remedy this because there the damage is already done. The problem is in `symbolic/function.pyx:BuiltinFunction.__call__` where the parent of function arguments is lost.\n\nSee also #18832 and maybe #17790.\n\n**CC:**  @jdemeyer\n\n**Branch/Commit:** [58f3d007fdef577beafc67b43ec6e9eaece846f3](https://github.com/sagemath/sagetrac-mirror/commit/58f3d007fdef577beafc67b43ec6e9eaece846f3)\n\n**Reviewer:** Volker Braun\n\n**Author:** Ralf Stephan\n\nIssue created by migration from https://trac.sagemath.org/ticket/20312\n\n",
    "closed_at": "2016-05-06T22:10:39Z",
    "created_at": "2016-03-28T07:52:37Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "parent of argument lost with Functions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20312",
    "user": "https://github.com/rwst"
}
```
Some Python objects as function arguments lose their parent, i.e. the code in the specific function can no longer access it because the object was coerced into SR. This can result in violation of the rule that function input and output should be of the same type.

```
sage: S.<y> = PolynomialRing(RR)
sage: ex = sin(asin(y)); ex
y
sage: type(ex)
<type 'sage.symbolic.expression.Expression'>
sage: ex.is_symbol()
True
```
The specific function (here sin) code cannot remedy this because there the damage is already done. The problem is in `symbolic/function.pyx:BuiltinFunction.__call__` where the parent of function arguments is lost.

See also #18832 and maybe #17790.

**CC:**  @jdemeyer

**Branch/Commit:** [58f3d007fdef577beafc67b43ec6e9eaece846f3](https://github.com/sagemath/sagetrac-mirror/commit/58f3d007fdef577beafc67b43ec6e9eaece846f3)

**Reviewer:** Volker Braun

**Author:** Ralf Stephan

Issue created by migration from https://trac.sagemath.org/ticket/20312





---

archive/issue_comments_353037.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -10,3 +10,5 @@\n True\n ```\n This also shows that the notion \"SR encapsulates all Sage objects\" is wrong because everything coerces into SR. SR only encapsulates certain \"numeric\" objects. Pynac can't be blamed as it only sees expressions. The problem is in `symbolic/function.pyx` where the parent of function arguments is lost.\n+\n+See also #18832\n``````\n",
    "created_at": "2016-03-28T12:45:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-353037",
    "user": "https://github.com/rwst"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -10,3 +10,5 @@
 True
 ```
 This also shows that the notion "SR encapsulates all Sage objects" is wrong because everything coerces into SR. SR only encapsulates certain "numeric" objects. Pynac can't be blamed as it only sees expressions. The problem is in `symbolic/function.pyx` where the parent of function arguments is lost.
+
+See also #18832
``````




---

archive/issue_comments_353038.json:
```json
{
    "body": "<a id='comment:2'></a>\n`@`Jeroen: I really would appreciate any input you can give me here. If it is not possible to decide which argument of the function determines the return type, a small database of functions with more than one argument could be used that contains that information.",
    "created_at": "2016-03-28T13:01:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-353038",
    "user": "https://github.com/rwst"
}
```

<a id='comment:2'></a>
`@`Jeroen: I really would appreciate any input you can give me here. If it is not possible to decide which argument of the function determines the return type, a small database of functions with more than one argument could be used that contains that information.



---

archive/issue_events_062292.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "rename": {
        "from": "parent of argument lost with GinacFunctions",
        "to": "parent of argument lost with Functions"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20312#event-62292"
}
```



---

archive/issue_comments_353039.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-Except for some classes, Python objects as function arguments are coerced into SR, but with `GinacFunction`s the parent gets lost, i.e. the result is not converted back. Ths violates the rule that function input and output should be of the same type.\n+Except for some classes, Python objects as function arguments are coerced into SR, but with `GinacFunction`s as well as with `BuiltinFunction`s the parent gets lost, i.e. the result is not converted back. Ths violates the rule that function input and output should be of the same type.\n \n ```\n sage: S.<y> = PolynomialRing(RR)\n@@ -9,6 +9,6 @@\n sage: ex.is_symbol()\n True\n ```\n-This also shows that the notion \"SR encapsulates all Sage objects\" is wrong because everything coerces into SR. SR only encapsulates certain \"numeric\" objects. Pynac can't be blamed as it only sees expressions. The problem is in `symbolic/function.pyx` where the parent of function arguments is lost.\n+This also shows that the notion \"SR encapsulates all Sage objects\" is wrong because everything coerces into SR. SR only encapsulates certain \"numeric\" objects. Pynac can't be blamed as it only sees the coerced expressions. The problem is in `symbolic/function.pyx:BuiltinFunction.__call__` where the parent of function arguments is lost.\n \n-See also #18832\n+See also #18832 and maybe #17790.\n``````\n",
    "created_at": "2016-03-29T13:37:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-353039",
    "user": "https://github.com/rwst"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-Except for some classes, Python objects as function arguments are coerced into SR, but with `GinacFunction`s the parent gets lost, i.e. the result is not converted back. Ths violates the rule that function input and output should be of the same type.
+Except for some classes, Python objects as function arguments are coerced into SR, but with `GinacFunction`s as well as with `BuiltinFunction`s the parent gets lost, i.e. the result is not converted back. Ths violates the rule that function input and output should be of the same type.
 
 ```
 sage: S.<y> = PolynomialRing(RR)
@@ -9,6 +9,6 @@
 sage: ex.is_symbol()
 True
 ```
-This also shows that the notion "SR encapsulates all Sage objects" is wrong because everything coerces into SR. SR only encapsulates certain "numeric" objects. Pynac can't be blamed as it only sees expressions. The problem is in `symbolic/function.pyx` where the parent of function arguments is lost.
+This also shows that the notion "SR encapsulates all Sage objects" is wrong because everything coerces into SR. SR only encapsulates certain "numeric" objects. Pynac can't be blamed as it only sees the coerced expressions. The problem is in `symbolic/function.pyx:BuiltinFunction.__call__` where the parent of function arguments is lost.
 
-See also #18832
+See also #18832 and maybe #17790.
``````




---

archive/issue_comments_353040.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-Except for some classes, Python objects as function arguments are coerced into SR, but with `GinacFunction`s as well as with `BuiltinFunction`s the parent gets lost, i.e. the result is not converted back. Ths violates the rule that function input and output should be of the same type.\n+Some Python objects as function arguments lose their parent, i.e. the code in the specific function can no longer access it because the object was coerced into SR. This can result in violation of the rule that function input and output should be of the same type.\n \n ```\n sage: S.<y> = PolynomialRing(RR)\n@@ -9,6 +9,6 @@\n sage: ex.is_symbol()\n True\n ```\n-This also shows that the notion \"SR encapsulates all Sage objects\" is wrong because everything coerces into SR. SR only encapsulates certain \"numeric\" objects. Pynac can't be blamed as it only sees the coerced expressions. The problem is in `symbolic/function.pyx:BuiltinFunction.__call__` where the parent of function arguments is lost.\n+The specific function (here sin) code cannot remedy this because there the damage is already done. The problem is in `symbolic/function.pyx:BuiltinFunction.__call__` where the parent of function arguments is lost.\n \n See also #18832 and maybe #17790.\n``````\n",
    "created_at": "2016-04-04T07:50:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-353040",
    "user": "https://github.com/rwst"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-Except for some classes, Python objects as function arguments are coerced into SR, but with `GinacFunction`s as well as with `BuiltinFunction`s the parent gets lost, i.e. the result is not converted back. Ths violates the rule that function input and output should be of the same type.
+Some Python objects as function arguments lose their parent, i.e. the code in the specific function can no longer access it because the object was coerced into SR. This can result in violation of the rule that function input and output should be of the same type.
 
 ```
 sage: S.<y> = PolynomialRing(RR)
@@ -9,6 +9,6 @@
 sage: ex.is_symbol()
 True
 ```
-This also shows that the notion "SR encapsulates all Sage objects" is wrong because everything coerces into SR. SR only encapsulates certain "numeric" objects. Pynac can't be blamed as it only sees the coerced expressions. The problem is in `symbolic/function.pyx:BuiltinFunction.__call__` where the parent of function arguments is lost.
+The specific function (here sin) code cannot remedy this because there the damage is already done. The problem is in `symbolic/function.pyx:BuiltinFunction.__call__` where the parent of function arguments is lost.
 
 See also #18832 and maybe #17790.
``````




---

archive/issue_comments_353041.json:
```json
{
    "body": "**Branch:** [u/rws/parent_of_argument_lost_with_functions](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/parent_of_argument_lost_with_functions)",
    "created_at": "2016-04-22T14:52:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-353041",
    "user": "https://github.com/rwst"
}
```

**Branch:** [u/rws/parent_of_argument_lost_with_functions](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/parent_of_argument_lost_with_functions)



---

archive/issue_comments_353042.json:
```json
{
    "body": "<a id='comment:6'></a>\nIt looks like the first version here can handle the binomial example of #20060 as well as the symbolic poly functions. It works by adding a field `_preserved_arg` to every `BuiltinFunction` that is set on function creation and says which of the function arguments is the one where we try to preserve the arg's parent. Then `Expression.polynomial()` is used to convert back in case of polynomial rings. Also, by not setting a default `preserved_arg` the functionality is limited to the cases where the developer has given this parameter in the function init call.\n\nThis does not work however with the title example because there the functions are nested. Since it seems we cannot decide where in a nested expression the specific element is whose parent we want to preserve I tend to exclude the nested case.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/eb5bf9367e1f781b6a5e649f4be6fe0fa4da2c39\">eb5bf93</a></td><td><code>20312: preserving function arg parent, first version</code></td></tr></table>\n",
    "created_at": "2016-04-22T14:53:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-353042",
    "user": "https://github.com/rwst"
}
```

<a id='comment:6'></a>
It looks like the first version here can handle the binomial example of #20060 as well as the symbolic poly functions. It works by adding a field `_preserved_arg` to every `BuiltinFunction` that is set on function creation and says which of the function arguments is the one where we try to preserve the arg's parent. Then `Expression.polynomial()` is used to convert back in case of polynomial rings. Also, by not setting a default `preserved_arg` the functionality is limited to the cases where the developer has given this parameter in the function init call.

This does not work however with the title example because there the functions are nested. Since it seems we cannot decide where in a nested expression the specific element is whose parent we want to preserve I tend to exclude the nested case.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/eb5bf9367e1f781b6a5e649f4be6fe0fa4da2c39">eb5bf93</a></td><td><code>20312: preserving function arg parent, first version</code></td></tr></table>




---

archive/issue_comments_353043.json:
```json
{
    "body": "**Author:** Ralf Stephan",
    "created_at": "2016-04-22T14:53:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-353043",
    "user": "https://github.com/rwst"
}
```

**Author:** Ralf Stephan



---

archive/issue_comments_353044.json:
```json
{
    "body": "**Commit:** [eb5bf9367e1f781b6a5e649f4be6fe0fa4da2c39](https://github.com/sagemath/sagetrac-mirror/commit/eb5bf9367e1f781b6a5e649f4be6fe0fa4da2c39)",
    "created_at": "2016-04-22T14:53:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-353044",
    "user": "https://github.com/rwst"
}
```

**Commit:** [eb5bf9367e1f781b6a5e649f4be6fe0fa4da2c39](https://github.com/sagemath/sagetrac-mirror/commit/eb5bf9367e1f781b6a5e649f4be6fe0fa4da2c39)



---

archive/issue_comments_353045.json:
```json
{
    "body": "<a id='comment:7'></a>\nTests pass.",
    "created_at": "2016-04-23T06:29:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-353045",
    "user": "https://github.com/rwst"
}
```

<a id='comment:7'></a>
Tests pass.



---

archive/issue_comments_353046.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2016-04-23T06:29:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-353046",
    "user": "https://github.com/rwst"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_353047.json:
```json
{
    "body": "**Changing commit** from \"[eb5bf9367e1f781b6a5e649f4be6fe0fa4da2c39](https://github.com/sagemath/sagetrac-mirror/commit/eb5bf9367e1f781b6a5e649f4be6fe0fa4da2c39)\" to \"[5c377cc79bb1a8f61c01b1473081382ec2af50f6](https://github.com/sagemath/sagetrac-mirror/commit/5c377cc79bb1a8f61c01b1473081382ec2af50f6)\".",
    "created_at": "2016-04-23T06:47:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-353047",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[eb5bf9367e1f781b6a5e649f4be6fe0fa4da2c39](https://github.com/sagemath/sagetrac-mirror/commit/eb5bf9367e1f781b6a5e649f4be6fe0fa4da2c39)" to "[5c377cc79bb1a8f61c01b1473081382ec2af50f6](https://github.com/sagemath/sagetrac-mirror/commit/5c377cc79bb1a8f61c01b1473081382ec2af50f6)".



---

archive/issue_comments_353048.json:
```json
{
    "body": "<a id='comment:8'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/5c377cc79bb1a8f61c01b1473081382ec2af50f6\">5c377cc</a></td><td><code>20312: fix for constant results</code></td></tr></table>\n",
    "created_at": "2016-04-23T06:47:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-353048",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/5c377cc79bb1a8f61c01b1473081382ec2af50f6">5c377cc</a></td><td><code>20312: fix for constant results</code></td></tr></table>




---

archive/issue_comments_353049.json:
```json
{
    "body": "**Changing commit** from \"[5c377cc79bb1a8f61c01b1473081382ec2af50f6](https://github.com/sagemath/sagetrac-mirror/commit/5c377cc79bb1a8f61c01b1473081382ec2af50f6)\" to \"[58f3d007fdef577beafc67b43ec6e9eaece846f3](https://github.com/sagemath/sagetrac-mirror/commit/58f3d007fdef577beafc67b43ec6e9eaece846f3)\".",
    "created_at": "2016-05-06T05:19:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-353049",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[5c377cc79bb1a8f61c01b1473081382ec2af50f6](https://github.com/sagemath/sagetrac-mirror/commit/5c377cc79bb1a8f61c01b1473081382ec2af50f6)" to "[58f3d007fdef577beafc67b43ec6e9eaece846f3](https://github.com/sagemath/sagetrac-mirror/commit/58f3d007fdef577beafc67b43ec6e9eaece846f3)".



---

archive/issue_comments_353050.json:
```json
{
    "body": "<a id='comment:9'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/58f3d007fdef577beafc67b43ec6e9eaece846f3\">58f3d00</a></td><td><code>Merge branch 'develop' into t/20312/parent_of_argument_lost_with_functions</code></td></tr></table>\n",
    "created_at": "2016-05-06T05:19:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-353050",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/58f3d007fdef577beafc67b43ec6e9eaece846f3">58f3d00</a></td><td><code>Merge branch 'develop' into t/20312/parent_of_argument_lost_with_functions</code></td></tr></table>




---

archive/issue_comments_353051.json:
```json
{
    "body": "**Reviewer:** Volker Braun",
    "created_at": "2016-05-06T22:06:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-353051",
    "user": "https://github.com/vbraun"
}
```

**Reviewer:** Volker Braun



---

archive/issue_comments_353052.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2016-05-06T22:06:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-353052",
    "user": "https://github.com/vbraun"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_353053.json:
```json
{
    "body": "**Changing branch** from \"[u/rws/parent_of_argument_lost_with_functions](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/parent_of_argument_lost_with_functions)\" to \"[58f3d007fdef577beafc67b43ec6e9eaece846f3](https://github.com/sagemath/sagetrac-mirror/commit/58f3d007fdef577beafc67b43ec6e9eaece846f3)\".",
    "created_at": "2016-05-06T22:10:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-353053",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/rws/parent_of_argument_lost_with_functions](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/parent_of_argument_lost_with_functions)" to "[58f3d007fdef577beafc67b43ec6e9eaece846f3](https://github.com/sagemath/sagetrac-mirror/commit/58f3d007fdef577beafc67b43ec6e9eaece846f3)".



---

archive/issue_events_062293.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-05-06T22:10:39Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20312#event-62293"
}
```
