# Issue 20312: parent of argument lost with Functions

archive/issues_020075.json:
```json
{
    "body": "Some Python objects as function arguments lose their parent, i.e. the code in the specific function can no longer access it because the object was coerced into SR. This can result in violation of the rule that function input and output should be of the same type.\n\n```\nsage: S.<y> = PolynomialRing(RR)\nsage: ex = sin(asin(y)); ex\ny\nsage: type(ex)\n<type 'sage.symbolic.expression.Expression'>\nsage: ex.is_symbol()\nTrue\n```\nThe specific function (here sin) code cannot remedy this because there the damage is already done. The problem is in `symbolic/function.pyx:BuiltinFunction.__call__` where the parent of function arguments is lost.\n\nSee also #18832 and maybe #17790.\n\nCC:  @jdemeyer\n\nBranch/Commit: 58f3d007fdef577beafc67b43ec6e9eaece846f3\n\nReviewer: Volker Braun\n\nAuthor: Ralf Stephan\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20312\n\n",
    "closed_at": "2016-05-06T22:10:39Z",
    "created_at": "2016-03-28T07:52:37Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "parent of argument lost with Functions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20312",
    "user": "https://github.com/rwst"
}
```
Some Python objects as function arguments lose their parent, i.e. the code in the specific function can no longer access it because the object was coerced into SR. This can result in violation of the rule that function input and output should be of the same type.

```
sage: S.<y> = PolynomialRing(RR)
sage: ex = sin(asin(y)); ex
y
sage: type(ex)
<type 'sage.symbolic.expression.Expression'>
sage: ex.is_symbol()
True
```
The specific function (here sin) code cannot remedy this because there the damage is already done. The problem is in `symbolic/function.pyx:BuiltinFunction.__call__` where the parent of function arguments is lost.

See also #18832 and maybe #17790.

CC:  @jdemeyer

Branch/Commit: 58f3d007fdef577beafc67b43ec6e9eaece846f3

Reviewer: Volker Braun

Author: Ralf Stephan

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/20312





---

archive/issue_comments_294331.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -11,6 +11,8 @@\n \\`\\`\\`\n This also shows that the notion \"SR encapsulates all Sage objects\" is wrong because everything coerces into SR. SR only encapsulates certain \"numeric\" objects. Pynac can't be blamed as it only sees expressions. The problem is in \\`symbolic/function.pyx\\` where the parent of function arguments is lost.\n \n+See also #18832\n+\n Comment: 1\n \n Summary: parent of argument lost with GinacFunctions\n```\n",
    "created_at": "2016-03-28T12:45:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-294331",
    "user": "https://github.com/rwst"
}
```

Description changed:
```diff
--- 
+++ 
@@ -11,6 +11,8 @@
 \`\`\`
 This also shows that the notion "SR encapsulates all Sage objects" is wrong because everything coerces into SR. SR only encapsulates certain "numeric" objects. Pynac can't be blamed as it only sees expressions. The problem is in \`symbolic/function.pyx\` where the parent of function arguments is lost.
 
+See also #18832
+
 Comment: 1
 
 Summary: parent of argument lost with GinacFunctions
```




---

archive/issue_comments_294332.json:
```json
{
    "body": "<a id='comment:2'></a>`@`Jeroen: I really would appreciate any input you can give me here. If it is not possible to decide which argument of the function determines the return type, a small database of functions with more than one argument could be used that contains that information.",
    "created_at": "2016-03-28T13:01:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-294332",
    "user": "https://github.com/rwst"
}
```

<a id='comment:2'></a>`@`Jeroen: I really would appreciate any input you can give me here. If it is not possible to decide which argument of the function determines the return type, a small database of functions with more than one argument could be used that contains that information.



---

archive/issue_comments_294333.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,17 @@\n+Except for some classes, Python objects as function arguments are coerced into SR, but with \\`GinacFunction\\`s as well as with \\`BuiltinFunction\\`s the parent gets lost, i.e. the result is not converted back. Ths violates the rule that function input and output should be of the same type.\n \n+\\`\\`\\`\n+sage: S.<y> = PolynomialRing(RR)\n+sage: ex = sin(asin(y)); ex\n+y\n+sage: type(ex)\n+<type 'sage.symbolic.expression.Expression'>\n+sage: ex.is_symbol()\n+True\n+\\`\\`\\`\n+This also shows that the notion \"SR encapsulates all Sage objects\" is wrong because everything coerces into SR. SR only encapsulates certain \"numeric\" objects. Pynac can't be blamed as it only sees the coerced expressions. The problem is in \\`symbolic/function.pyx:BuiltinFunction.__call__\\` where the parent of function arguments is lost.\n+\n+See also #18832 and maybe #17790.\n \n Comment: 1\n \n```\n",
    "created_at": "2016-03-29T13:37:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-294333",
    "user": "https://github.com/rwst"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,17 @@
+Except for some classes, Python objects as function arguments are coerced into SR, but with \`GinacFunction\`s as well as with \`BuiltinFunction\`s the parent gets lost, i.e. the result is not converted back. Ths violates the rule that function input and output should be of the same type.
 
+\`\`\`
+sage: S.<y> = PolynomialRing(RR)
+sage: ex = sin(asin(y)); ex
+y
+sage: type(ex)
+<type 'sage.symbolic.expression.Expression'>
+sage: ex.is_symbol()
+True
+\`\`\`
+This also shows that the notion "SR encapsulates all Sage objects" is wrong because everything coerces into SR. SR only encapsulates certain "numeric" objects. Pynac can't be blamed as it only sees the coerced expressions. The problem is in \`symbolic/function.pyx:BuiltinFunction.__call__\` where the parent of function arguments is lost.
+
+See also #18832 and maybe #17790.
 
 Comment: 1
 
```




---

archive/issue_comments_294334.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,17 @@\n+Some Python objects as function arguments lose their parent, i.e. the code in the specific function can no longer access it because the object was coerced into SR. This can result in violation of the rule that function input and output should be of the same type.\n \n+\\`\\`\\`\n+sage: S.<y> = PolynomialRing(RR)\n+sage: ex = sin(asin(y)); ex\n+y\n+sage: type(ex)\n+<type 'sage.symbolic.expression.Expression'>\n+sage: ex.is_symbol()\n+True\n+\\`\\`\\`\n+The specific function (here sin) code cannot remedy this because there the damage is already done. The problem is in \\`symbolic/function.pyx:BuiltinFunction.__call__\\` where the parent of function arguments is lost.\n+\n+See also #18832 and maybe #17790.\n \n Comment: 1\n \n```\n",
    "created_at": "2016-04-04T07:50:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-294334",
    "user": "https://github.com/rwst"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,17 @@
+Some Python objects as function arguments lose their parent, i.e. the code in the specific function can no longer access it because the object was coerced into SR. This can result in violation of the rule that function input and output should be of the same type.
 
+\`\`\`
+sage: S.<y> = PolynomialRing(RR)
+sage: ex = sin(asin(y)); ex
+y
+sage: type(ex)
+<type 'sage.symbolic.expression.Expression'>
+sage: ex.is_symbol()
+True
+\`\`\`
+The specific function (here sin) code cannot remedy this because there the damage is already done. The problem is in \`symbolic/function.pyx:BuiltinFunction.__call__\` where the parent of function arguments is lost.
+
+See also #18832 and maybe #17790.
 
 Comment: 1
 
```




---

archive/issue_comments_294335.json:
```json
{
    "body": "<a id='comment:6'></a>It looks like the first version here can handle the binomial example of #20060 as well as the symbolic poly functions. It works by adding a field `_preserved_arg` to every `BuiltinFunction` that is set on function creation and says which of the function arguments is the one where we try to preserve the arg's parent. Then `Expression.polynomial()` is used to convert back in case of polynomial rings. Also, by not setting a default `preserved_arg` the functionality is limited to the cases where the developer has given this parameter in the function init call.\n\nThis does not work however with the title example because there the functions are nested. Since it seems we cannot decide where in a nested expression the specific element is whose parent we want to preserve I tend to exclude the nested case.\n\n---\nNew commits:",
    "created_at": "2016-04-22T14:53:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-294335",
    "user": "https://github.com/rwst"
}
```

<a id='comment:6'></a>It looks like the first version here can handle the binomial example of #20060 as well as the symbolic poly functions. It works by adding a field `_preserved_arg` to every `BuiltinFunction` that is set on function creation and says which of the function arguments is the one where we try to preserve the arg's parent. Then `Expression.polynomial()` is used to convert back in case of polynomial rings. Also, by not setting a default `preserved_arg` the functionality is limited to the cases where the developer has given this parameter in the function init call.

This does not work however with the title example because there the functions are nested. Since it seems we cannot decide where in a nested expression the specific element is whose parent we want to preserve I tend to exclude the nested case.

---
New commits:



---

archive/issue_comments_294336.json:
```json
{
    "body": "<a id='comment:7'></a>Tests pass.",
    "created_at": "2016-04-23T06:29:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-294336",
    "user": "https://github.com/rwst"
}
```

<a id='comment:7'></a>Tests pass.



---

archive/issue_comments_294337.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-04-23T06:29:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-294337",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_294338.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-23T06:47:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-294338",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_294339.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-05-06T05:19:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-294339",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_294340.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-05-06T22:06:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-294340",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_294341.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-05-06T22:10:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20312#issuecomment-294341",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_055122.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-05-06T22:10:39Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20312",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20312#event-55122"
}
```
