# Issue 20686: Refactor getattr_from_other_class() for lookup of methods in categories

archive/issues_020449.json:
```json
{
    "body": "For parents and elements implemented in Cython, category lookup is emulated in `__getattr__` using `getattr_from_other_class`. In this ticket, this is refactored a bit:\n\n1. We should not pick up special attributes from `type`, there is no point in returning the type name of the category here (similarly for `__dict__`, `__mro__`, ...):\n\n```\nsage: ZZ(1).__name__\n'JoinCategory.element_class'\nsage: ZZ.__name__\n'JoinCategory.parent_class'\n```\nThis change causes a few failures which need to be fixed.\n\n2. The implementation of `getattr_from_other_class` is not very robust. For example, static methods are not supported. We fix this by using low-level Python functions to get the attribute and we manually call the descriptor `__get__` if needed.\n\n3. We shouldn't do anything special with double-underscore private attributes: in plain Python, this is implemented by the parser and not by `getattr()`. So `__getattr__` would already receive the mangled private name.\n\n4. Some of the changes broke `_sage_src_lines_`, so we also change that: currently, `_sage_src_lines_()` is used both to get the source lines of a class (e.g. dynamic classes) and an instance (e.g. cached functions). We change this to always mean the source lines of an instance, which makes things clearer.\n\n5. The lookup using `getattr_from_other_class` is about 9 times slower than a normal method lookup::\n\n```\nsage: def foo(self): return\nsage: Sets().element_class.foo = foo\nsage: def g(x):\n....:     for i in range(1000):\n....:          x.foo()\n\nsage: x = Semigroups().example().an_element()\nsage: y = 1\n\nsage: %timeit g(x)\n10000 loops, best of 3: 115 \u00b5s per loop\n\nsage: %timeit g(y)\n1000 loops, best of 3: 1.18 ms per loop\n```\nWe improve on this by roughly a factor 2 (but even then, it's still a lot slower than usual method lookup).\n\nNOTE: This needs a trivial Cython patch, see #21030 for the Cython upgrade.\n\nCC:  @jdemeyer @tscrim\n\nBranch/Commit: 74041f30d8de4c15055345f14340a4f443236ffa\n\nUpstream: Fixed upstream, in a later stable release.\n\nReviewer: Vincent Delecroix\n\nAuthor: Jeroen Demeyer\n\nDependencies: #21030, #21409\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20686\n\n",
    "closed_at": "2016-09-04T13:38:02Z",
    "created_at": "2016-05-26T13:36:13Z",
    "labels": [
        "component: categories"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "Refactor getattr_from_other_class() for lookup of methods in categories",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20686",
    "user": "https://github.com/nthiery"
}
```
For parents and elements implemented in Cython, category lookup is emulated in `__getattr__` using `getattr_from_other_class`. In this ticket, this is refactored a bit:

1. We should not pick up special attributes from `type`, there is no point in returning the type name of the category here (similarly for `__dict__`, `__mro__`, ...):

```
sage: ZZ(1).__name__
'JoinCategory.element_class'
sage: ZZ.__name__
'JoinCategory.parent_class'
```
This change causes a few failures which need to be fixed.

2. The implementation of `getattr_from_other_class` is not very robust. For example, static methods are not supported. We fix this by using low-level Python functions to get the attribute and we manually call the descriptor `__get__` if needed.

3. We shouldn't do anything special with double-underscore private attributes: in plain Python, this is implemented by the parser and not by `getattr()`. So `__getattr__` would already receive the mangled private name.

4. Some of the changes broke `_sage_src_lines_`, so we also change that: currently, `_sage_src_lines_()` is used both to get the source lines of a class (e.g. dynamic classes) and an instance (e.g. cached functions). We change this to always mean the source lines of an instance, which makes things clearer.

5. The lookup using `getattr_from_other_class` is about 9 times slower than a normal method lookup::

```
sage: def foo(self): return
sage: Sets().element_class.foo = foo
sage: def g(x):
....:     for i in range(1000):
....:          x.foo()

sage: x = Semigroups().example().an_element()
sage: y = 1

sage: %timeit g(x)
10000 loops, best of 3: 115 µs per loop

sage: %timeit g(y)
1000 loops, best of 3: 1.18 ms per loop
```
We improve on this by roughly a factor 2 (but even then, it's still a lot slower than usual method lookup).

NOTE: This needs a trivial Cython patch, see #21030 for the Cython upgrade.

CC:  @jdemeyer @tscrim

Branch/Commit: 74041f30d8de4c15055345f14340a4f443236ffa

Upstream: Fixed upstream, in a later stable release.

Reviewer: Vincent Delecroix

Author: Jeroen Demeyer

Dependencies: #21030, #21409

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/20686





---

archive/issue_comments_299887.json:
```json
{
    "body": "<a id='comment:2'></a>I might have some ideas... discuss in Meudon?",
    "created_at": "2016-05-26T14:56:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299887",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>I might have some ideas... discuss in Meudon?



---

archive/issue_comments_299888.json:
```json
{
    "body": "<a id='comment:3'></a>+1",
    "created_at": "2016-05-26T15:18:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299888",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:3'></a>+1



---

archive/issue_comments_299889.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -23,7 +23,12 @@\n So there should be room for optimization (or using a different\n approach for emulating this inheritance).\n \n-First step: profiling ...\n+Besides this, we should not pick up special attributes from `type`, there is no point in returning `type.__name__` here:\n+\n+```\n+sage: getattr_from_other_class(1, type, \"__name__\")\n+'type'\n+```\n \n Comment: 1\n \n```\n",
    "created_at": "2016-06-14T13:44:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299889",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -23,7 +23,12 @@
 So there should be room for optimization (or using a different
 approach for emulating this inheritance).
 
-First step: profiling ...
+Besides this, we should not pick up special attributes from `type`, there is no point in returning `type.__name__` here:
+
+```
+sage: getattr_from_other_class(1, type, "__name__")
+'type'
+```
 
 Comment: 1
 
```




---

archive/issue_comments_299890.json:
```json
{
    "body": "<a id='comment:6'></a>New commits:",
    "created_at": "2016-06-14T15:13:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299890",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>New commits:



---

archive/issue_comments_299891.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-06-14T15:58:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299891",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_299892.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,36 @@\n+For instances of Cython classes, the inheritance from categories is\n+emulated by a manual lookup in\n+`sage.structure.element.Element.__getattr__`. This lookup is about 10\n+times slower than a normal method lookup::\n \n+```\n+sage: def foo(self): return\n+sage: Sets().element_class.foo = foo\n+\n+sage: def g(x):\n+....:     for i in range(1000):\n+....:          x.foo()\n+\n+sage: x = Semigroups().example().an_element()\n+sage: %timeit g(x)\n+10000 loops, best of 3: 115 \u00b5s per loop\n+\n+sage: x = 1\n+sage: %timeit g(x)\n+1000 loops, best of 3: 1.18 ms per loop\n+```\n+\n+So there should be room for optimization (or using a different\n+approach for emulating this inheritance).\n+\n+Besides this, we should not pick up special attributes from `type`, there is no point in returning `type.__name__` here:\n+\n+```\n+sage: getattr_from_other_class(1, type, \"__name__\")\n+'type'\n+```\n+\n+This needs a trivial Cython patch: https://github.com/cython/cython/pull/522\n \n Comment: 1\n \n```\n",
    "created_at": "2016-06-14T16:07:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299892",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,36 @@
+For instances of Cython classes, the inheritance from categories is
+emulated by a manual lookup in
+`sage.structure.element.Element.__getattr__`. This lookup is about 10
+times slower than a normal method lookup::
 
+```
+sage: def foo(self): return
+sage: Sets().element_class.foo = foo
+
+sage: def g(x):
+....:     for i in range(1000):
+....:          x.foo()
+
+sage: x = Semigroups().example().an_element()
+sage: %timeit g(x)
+10000 loops, best of 3: 115 µs per loop
+
+sage: x = 1
+sage: %timeit g(x)
+1000 loops, best of 3: 1.18 ms per loop
+```
+
+So there should be room for optimization (or using a different
+approach for emulating this inheritance).
+
+Besides this, we should not pick up special attributes from `type`, there is no point in returning `type.__name__` here:
+
+```
+sage: getattr_from_other_class(1, type, "__name__")
+'type'
+```
+
+This needs a trivial Cython patch: https://github.com/cython/cython/pull/522
 
 Comment: 1
 
```




---

archive/issue_comments_299893.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,36 @@\n+For instances of Cython classes, the inheritance from categories is\n+emulated by a manual lookup in\n+`sage.structure.element.Element.__getattr__`. This lookup is about 10\n+times slower than a normal method lookup::\n \n+```\n+sage: def foo(self): return\n+sage: Sets().element_class.foo = foo\n+sage: def g(x):\n+....:     for i in range(1000):\n+....:          x.foo()\n+\n+sage: x = Semigroups().example().an_element()\n+sage: y = 1\n+\n+sage: %timeit g(x)\n+10000 loops, best of 3: 115 \u00b5s per loop\n+\n+sage: %timeit g(y)\n+1000 loops, best of 3: 1.18 ms per loop\n+```\n+\n+So there should be room for optimization (or using a different\n+approach for emulating this inheritance).\n+\n+Besides this, we should not pick up special attributes from `type`, there is no point in returning `type.__name__` here:\n+\n+```\n+sage: getattr_from_other_class(1, type, \"__name__\")\n+'type'\n+```\n+\n+This needs a trivial Cython patch: https://github.com/cython/cython/pull/522\n \n Comment: 1\n \n```\n",
    "created_at": "2016-06-14T16:29:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299893",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,36 @@
+For instances of Cython classes, the inheritance from categories is
+emulated by a manual lookup in
+`sage.structure.element.Element.__getattr__`. This lookup is about 10
+times slower than a normal method lookup::
 
+```
+sage: def foo(self): return
+sage: Sets().element_class.foo = foo
+sage: def g(x):
+....:     for i in range(1000):
+....:          x.foo()
+
+sage: x = Semigroups().example().an_element()
+sage: y = 1
+
+sage: %timeit g(x)
+10000 loops, best of 3: 115 µs per loop
+
+sage: %timeit g(y)
+1000 loops, best of 3: 1.18 ms per loop
+```
+
+So there should be room for optimization (or using a different
+approach for emulating this inheritance).
+
+Besides this, we should not pick up special attributes from `type`, there is no point in returning `type.__name__` here:
+
+```
+sage: getattr_from_other_class(1, type, "__name__")
+'type'
+```
+
+This needs a trivial Cython patch: https://github.com/cython/cython/pull/522
 
 Comment: 1
 
```




---

archive/issue_comments_299894.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-06-14T19:56:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299894",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_299895.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,36 @@\n+For instances of Cython classes, the inheritance from categories is\n+emulated by a manual lookup in\n+`sage.structure.element.Element.__getattr__`. This lookup is about 10\n+times slower than a normal method lookup::\n \n+```\n+sage: def foo(self): return\n+sage: Sets().element_class.foo = foo\n+sage: def g(x):\n+....:     for i in range(1000):\n+....:          x.foo()\n+\n+sage: x = Semigroups().example().an_element()\n+sage: y = 1\n+\n+sage: %timeit g(x)\n+10000 loops, best of 3: 115 \u00b5s per loop\n+\n+sage: %timeit g(y)\n+1000 loops, best of 3: 1.18 ms per loop\n+```\n+\n+So there should be room for optimization (or using a different\n+approach for emulating this inheritance).\n+\n+Besides this, we should not pick up special attributes from `type`, there is no point in returning `type.__name__` here (similarly for `__dict__`, `__mro__`, ...):\n+\n+```\n+sage: getattr_from_other_class(1, type, \"__name__\")\n+'type'\n+```\n+\n+This needs a trivial Cython patch: https://github.com/cython/cython/pull/522\n \n Comment: 1\n \n```\n",
    "created_at": "2016-06-14T20:53:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299895",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,36 @@
+For instances of Cython classes, the inheritance from categories is
+emulated by a manual lookup in
+`sage.structure.element.Element.__getattr__`. This lookup is about 10
+times slower than a normal method lookup::
 
+```
+sage: def foo(self): return
+sage: Sets().element_class.foo = foo
+sage: def g(x):
+....:     for i in range(1000):
+....:          x.foo()
+
+sage: x = Semigroups().example().an_element()
+sage: y = 1
+
+sage: %timeit g(x)
+10000 loops, best of 3: 115 µs per loop
+
+sage: %timeit g(y)
+1000 loops, best of 3: 1.18 ms per loop
+```
+
+So there should be room for optimization (or using a different
+approach for emulating this inheritance).
+
+Besides this, we should not pick up special attributes from `type`, there is no point in returning `type.__name__` here (similarly for `__dict__`, `__mro__`, ...):
+
+```
+sage: getattr_from_other_class(1, type, "__name__")
+'type'
+```
+
+This needs a trivial Cython patch: https://github.com/cython/cython/pull/522
 
 Comment: 1
 
```




---

archive/issue_comments_299896.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-06-14T20:54:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299896",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_299897.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,33 @@\n+For instances of Cython classes, the inheritance from categories is emulated by a manual lookup in `sage.structure.element.Element.__getattr__`. This lookup is about 10 times slower than a normal method lookup::\n \n+```\n+sage: def foo(self): return\n+sage: Sets().element_class.foo = foo\n+sage: def g(x):\n+....:     for i in range(1000):\n+....:          x.foo()\n+\n+sage: x = Semigroups().example().an_element()\n+sage: y = 1\n+\n+sage: %timeit g(x)\n+10000 loops, best of 3: 115 \u00b5s per loop\n+\n+sage: %timeit g(y)\n+1000 loops, best of 3: 1.18 ms per loop\n+```\n+\n+So there should be room for optimization (or using a different\n+approach for emulating this inheritance).\n+\n+Besides this, we should not pick up special attributes from `type`, there is no point in returning `type.__name__` here (similarly for `__dict__`, `__mro__`, ...):\n+\n+```\n+sage: getattr_from_other_class(1, type, \"__name__\")\n+'type'\n+```\n+\n+This needs a trivial Cython patch (accepted by upstream): https://github.com/cython/cython/pull/522\n \n Comment: 1\n \n```\n",
    "created_at": "2016-06-15T07:29:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299897",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,33 @@
+For instances of Cython classes, the inheritance from categories is emulated by a manual lookup in `sage.structure.element.Element.__getattr__`. This lookup is about 10 times slower than a normal method lookup::
 
+```
+sage: def foo(self): return
+sage: Sets().element_class.foo = foo
+sage: def g(x):
+....:     for i in range(1000):
+....:          x.foo()
+
+sage: x = Semigroups().example().an_element()
+sage: y = 1
+
+sage: %timeit g(x)
+10000 loops, best of 3: 115 µs per loop
+
+sage: %timeit g(y)
+1000 loops, best of 3: 1.18 ms per loop
+```
+
+So there should be room for optimization (or using a different
+approach for emulating this inheritance).
+
+Besides this, we should not pick up special attributes from `type`, there is no point in returning `type.__name__` here (similarly for `__dict__`, `__mro__`, ...):
+
+```
+sage: getattr_from_other_class(1, type, "__name__")
+'type'
+```
+
+This needs a trivial Cython patch (accepted by upstream): https://github.com/cython/cython/pull/522
 
 Comment: 1
 
```




---

archive/issue_comments_299898.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,34 @@\n+For instances of Cython classes, the inheritance from categories is emulated by a manual lookup in `sage.structure.element.Element.__getattr__`. This lookup is about 10 times slower than a normal method lookup::\n \n+```\n+sage: def foo(self): return\n+sage: Sets().element_class.foo = foo\n+sage: def g(x):\n+....:     for i in range(1000):\n+....:          x.foo()\n+\n+sage: x = Semigroups().example().an_element()\n+sage: y = 1\n+\n+sage: %timeit g(x)\n+10000 loops, best of 3: 115 \u00b5s per loop\n+\n+sage: %timeit g(y)\n+1000 loops, best of 3: 1.18 ms per loop\n+```\n+\n+So there should be room for optimization (or using a different\n+approach for emulating this inheritance).\n+\n+Besides this, we should not pick up special attributes from `type`, there is no point in returning `type.__name__` here (similarly for `__dict__`, `__mro__`, ...):\n+\n+```\n+sage: getattr_from_other_class(1, type, \"__name__\")\n+'type'\n+```\n+This change causes a few failures which need to be fixed.\n+\n+This needs a trivial Cython patch (accepted by upstream): https://github.com/cython/cython/pull/522\n \n Comment: 1\n \n```\n",
    "created_at": "2016-06-15T09:22:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299898",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,34 @@
+For instances of Cython classes, the inheritance from categories is emulated by a manual lookup in `sage.structure.element.Element.__getattr__`. This lookup is about 10 times slower than a normal method lookup::
 
+```
+sage: def foo(self): return
+sage: Sets().element_class.foo = foo
+sage: def g(x):
+....:     for i in range(1000):
+....:          x.foo()
+
+sage: x = Semigroups().example().an_element()
+sage: y = 1
+
+sage: %timeit g(x)
+10000 loops, best of 3: 115 µs per loop
+
+sage: %timeit g(y)
+1000 loops, best of 3: 1.18 ms per loop
+```
+
+So there should be room for optimization (or using a different
+approach for emulating this inheritance).
+
+Besides this, we should not pick up special attributes from `type`, there is no point in returning `type.__name__` here (similarly for `__dict__`, `__mro__`, ...):
+
+```
+sage: getattr_from_other_class(1, type, "__name__")
+'type'
+```
+This change causes a few failures which need to be fixed.
+
+This needs a trivial Cython patch (accepted by upstream): https://github.com/cython/cython/pull/522
 
 Comment: 1
 
```




---

archive/issue_comments_299899.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-06-15T10:26:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299899",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_299900.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-06-15T11:52:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299900",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_299901.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-06-15T11:52:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299901",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_299902.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,38 @@\n+For parents and elements implemented in Cython, category lookup is emulated in `__getattr__` using `getattr_from_other_class`. In this ticket, this is refactored a bit:\n \n+1. We should not pick up special attributes from `type`, there is no point in returning the type name of the category here (similarly for `__dict__`, `__mro__`, ...):\n+\n+```\n+sage: ZZ(1).__name__\n+'JoinCategory.element_class'\n+sage: ZZ.__name__\n+'JoinCategory.parent_class'\n+```\n+This change causes a few failures which need to be fixed.\n+\n+2. The implementation of `getattr_from_other_class` is not very robust. For example, static methods are not supported. We fix this by using low-level Python functions to get the attribute and we manually call the descriptor `__get__` if needed.\n+\n+3. The lookup using `getattr_from_other_class` is about 9 times slower than a normal method lookup::\n+\n+```\n+sage: def foo(self): return\n+sage: Sets().element_class.foo = foo\n+sage: def g(x):\n+....:     for i in range(1000):\n+....:          x.foo()\n+\n+sage: x = Semigroups().example().an_element()\n+sage: y = 1\n+\n+sage: %timeit g(x)\n+10000 loops, best of 3: 115 \u00b5s per loop\n+\n+sage: %timeit g(y)\n+1000 loops, best of 3: 1.18 ms per loop\n+```\n+We improve on this by roughly a factor 2 (but even then, it's still a lot slower than usual method lookup).\n+\n+NOTE: This needs a trivial Cython patch (accepted by upstream): https://github.com/cython/cython/pull/522\n \n Comment: 1\n \n```\n",
    "created_at": "2016-06-15T12:43:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299902",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,38 @@
+For parents and elements implemented in Cython, category lookup is emulated in `__getattr__` using `getattr_from_other_class`. In this ticket, this is refactored a bit:
 
+1. We should not pick up special attributes from `type`, there is no point in returning the type name of the category here (similarly for `__dict__`, `__mro__`, ...):
+
+```
+sage: ZZ(1).__name__
+'JoinCategory.element_class'
+sage: ZZ.__name__
+'JoinCategory.parent_class'
+```
+This change causes a few failures which need to be fixed.
+
+2. The implementation of `getattr_from_other_class` is not very robust. For example, static methods are not supported. We fix this by using low-level Python functions to get the attribute and we manually call the descriptor `__get__` if needed.
+
+3. The lookup using `getattr_from_other_class` is about 9 times slower than a normal method lookup::
+
+```
+sage: def foo(self): return
+sage: Sets().element_class.foo = foo
+sage: def g(x):
+....:     for i in range(1000):
+....:          x.foo()
+
+sage: x = Semigroups().example().an_element()
+sage: y = 1
+
+sage: %timeit g(x)
+10000 loops, best of 3: 115 µs per loop
+
+sage: %timeit g(y)
+1000 loops, best of 3: 1.18 ms per loop
+```
+We improve on this by roughly a factor 2 (but even then, it's still a lot slower than usual method lookup).
+
+NOTE: This needs a trivial Cython patch (accepted by upstream): https://github.com/cython/cython/pull/522
 
 Comment: 1
 
```




---

archive/issue_comments_299903.json:
```json
{
    "body": "<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-06-15T13:05:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299903",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_299904.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-06-15T18:41:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299904",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_299905.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-06-15T19:17:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299905",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_299906.json:
```json
{
    "body": "<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-06-15T21:35:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299906",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_299907.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-06-16T07:39:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299907",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_299908.json:
```json
{
    "body": "Changing keywords from \"\" to \"test\".",
    "created_at": "2016-06-17T14:32:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299908",
    "user": "https://github.com/embray"
}
```

Changing keywords from "" to "test".



---

archive/issue_comments_299909.json:
```json
{
    "body": "Changing keywords from \"test\" to \"\".",
    "created_at": "2016-06-17T14:32:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299909",
    "user": "https://github.com/embray"
}
```

Changing keywords from "test" to "".



---

archive/issue_comments_299910.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,40 @@\n+For parents and elements implemented in Cython, category lookup is emulated in `__getattr__` using `getattr_from_other_class`. In this ticket, this is refactored a bit:\n \n+1. We should not pick up special attributes from `type`, there is no point in returning the type name of the category here (similarly for `__dict__`, `__mro__`, ...):\n+\n+```\n+sage: ZZ(1).__name__\n+'JoinCategory.element_class'\n+sage: ZZ.__name__\n+'JoinCategory.parent_class'\n+```\n+This change causes a few failures which need to be fixed.\n+\n+2. The implementation of `getattr_from_other_class` is not very robust. For example, static methods are not supported. We fix this by using low-level Python functions to get the attribute and we manually call the descriptor `__get__` if needed.\n+\n+3. The lookup using `getattr_from_other_class` is about 9 times slower than a normal method lookup::\n+\n+```\n+sage: def foo(self): return\n+sage: Sets().element_class.foo = foo\n+sage: def g(x):\n+....:     for i in range(1000):\n+....:          x.foo()\n+\n+sage: x = Semigroups().example().an_element()\n+sage: y = 1\n+\n+sage: %timeit g(x)\n+10000 loops, best of 3: 115 \u00b5s per loop\n+\n+sage: %timeit g(y)\n+1000 loops, best of 3: 1.18 ms per loop\n+```\n+We improve on this by roughly a factor 2 (but even then, it's still a lot slower than usual method lookup).\n+\n+NOTE: This needs a trivial Cython patch (accepted by upstream): https://github.com/cython/cython/pull/522\n+\n+Test\n \n Comment: 1\n \n```\n",
    "created_at": "2016-06-17T14:32:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299910",
    "user": "https://github.com/embray"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,40 @@
+For parents and elements implemented in Cython, category lookup is emulated in `__getattr__` using `getattr_from_other_class`. In this ticket, this is refactored a bit:
 
+1. We should not pick up special attributes from `type`, there is no point in returning the type name of the category here (similarly for `__dict__`, `__mro__`, ...):
+
+```
+sage: ZZ(1).__name__
+'JoinCategory.element_class'
+sage: ZZ.__name__
+'JoinCategory.parent_class'
+```
+This change causes a few failures which need to be fixed.
+
+2. The implementation of `getattr_from_other_class` is not very robust. For example, static methods are not supported. We fix this by using low-level Python functions to get the attribute and we manually call the descriptor `__get__` if needed.
+
+3. The lookup using `getattr_from_other_class` is about 9 times slower than a normal method lookup::
+
+```
+sage: def foo(self): return
+sage: Sets().element_class.foo = foo
+sage: def g(x):
+....:     for i in range(1000):
+....:          x.foo()
+
+sage: x = Semigroups().example().an_element()
+sage: y = 1
+
+sage: %timeit g(x)
+10000 loops, best of 3: 115 µs per loop
+
+sage: %timeit g(y)
+1000 loops, best of 3: 1.18 ms per loop
+```
+We improve on this by roughly a factor 2 (but even then, it's still a lot slower than usual method lookup).
+
+NOTE: This needs a trivial Cython patch (accepted by upstream): https://github.com/cython/cython/pull/522
+
+Test
 
 Comment: 1
 
```




---

archive/issue_comments_299911.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,38 @@\n+For parents and elements implemented in Cython, category lookup is emulated in `__getattr__` using `getattr_from_other_class`. In this ticket, this is refactored a bit:\n \n+1. We should not pick up special attributes from `type`, there is no point in returning the type name of the category here (similarly for `__dict__`, `__mro__`, ...):\n+\n+```\n+sage: ZZ(1).__name__\n+'JoinCategory.element_class'\n+sage: ZZ.__name__\n+'JoinCategory.parent_class'\n+```\n+This change causes a few failures which need to be fixed.\n+\n+2. The implementation of `getattr_from_other_class` is not very robust. For example, static methods are not supported. We fix this by using low-level Python functions to get the attribute and we manually call the descriptor `__get__` if needed.\n+\n+3. The lookup using `getattr_from_other_class` is about 9 times slower than a normal method lookup::\n+\n+```\n+sage: def foo(self): return\n+sage: Sets().element_class.foo = foo\n+sage: def g(x):\n+....:     for i in range(1000):\n+....:          x.foo()\n+\n+sage: x = Semigroups().example().an_element()\n+sage: y = 1\n+\n+sage: %timeit g(x)\n+10000 loops, best of 3: 115 \u00b5s per loop\n+\n+sage: %timeit g(y)\n+1000 loops, best of 3: 1.18 ms per loop\n+```\n+We improve on this by roughly a factor 2 (but even then, it's still a lot slower than usual method lookup).\n+\n+NOTE: This needs a trivial Cython patch (accepted by upstream): https://github.com/cython/cython/pull/522\n \n Comment: 1\n \n```\n",
    "created_at": "2016-06-17T14:33:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299911",
    "user": "https://github.com/embray"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,38 @@
+For parents and elements implemented in Cython, category lookup is emulated in `__getattr__` using `getattr_from_other_class`. In this ticket, this is refactored a bit:
 
+1. We should not pick up special attributes from `type`, there is no point in returning the type name of the category here (similarly for `__dict__`, `__mro__`, ...):
+
+```
+sage: ZZ(1).__name__
+'JoinCategory.element_class'
+sage: ZZ.__name__
+'JoinCategory.parent_class'
+```
+This change causes a few failures which need to be fixed.
+
+2. The implementation of `getattr_from_other_class` is not very robust. For example, static methods are not supported. We fix this by using low-level Python functions to get the attribute and we manually call the descriptor `__get__` if needed.
+
+3. The lookup using `getattr_from_other_class` is about 9 times slower than a normal method lookup::
+
+```
+sage: def foo(self): return
+sage: Sets().element_class.foo = foo
+sage: def g(x):
+....:     for i in range(1000):
+....:          x.foo()
+
+sage: x = Semigroups().example().an_element()
+sage: y = 1
+
+sage: %timeit g(x)
+10000 loops, best of 3: 115 µs per loop
+
+sage: %timeit g(y)
+1000 loops, best of 3: 1.18 ms per loop
+```
+We improve on this by roughly a factor 2 (but even then, it's still a lot slower than usual method lookup).
+
+NOTE: This needs a trivial Cython patch (accepted by upstream): https://github.com/cython/cython/pull/522
 
 Comment: 1
 
```




---

archive/issue_comments_299912.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,40 @@\n+For parents and elements implemented in Cython, category lookup is emulated in `__getattr__` using `getattr_from_other_class`. In this ticket, this is refactored a bit:\n \n+1. We should not pick up special attributes from `type`, there is no point in returning the type name of the category here (similarly for `__dict__`, `__mro__`, ...):\n+\n+```\n+sage: ZZ(1).__name__\n+'JoinCategory.element_class'\n+sage: ZZ.__name__\n+'JoinCategory.parent_class'\n+```\n+This change causes a few failures which need to be fixed.\n+\n+2. The implementation of `getattr_from_other_class` is not very robust. For example, static methods are not supported. We fix this by using low-level Python functions to get the attribute and we manually call the descriptor `__get__` if needed.\n+\n+3. The lookup using `getattr_from_other_class` is about 9 times slower than a normal method lookup::\n+\n+```\n+sage: def foo(self): return\n+sage: Sets().element_class.foo = foo\n+sage: def g(x):\n+....:     for i in range(1000):\n+....:          x.foo()\n+\n+sage: x = Semigroups().example().an_element()\n+sage: y = 1\n+\n+sage: %timeit g(x)\n+10000 loops, best of 3: 115 \u00b5s per loop\n+\n+sage: %timeit g(y)\n+1000 loops, best of 3: 1.18 ms per loop\n+```\n+We improve on this by roughly a factor 2 (but even then, it's still a lot slower than usual method lookup).\n+\n+NOTE: This needs a trivial Cython patch (accepted by upstream): https://github.com/cython/cython/pull/522\n+\n+Test\n \n Comment: 1\n \n```\n",
    "created_at": "2016-06-17T14:45:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299912",
    "user": "https://github.com/embray"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,40 @@
+For parents and elements implemented in Cython, category lookup is emulated in `__getattr__` using `getattr_from_other_class`. In this ticket, this is refactored a bit:
 
+1. We should not pick up special attributes from `type`, there is no point in returning the type name of the category here (similarly for `__dict__`, `__mro__`, ...):
+
+```
+sage: ZZ(1).__name__
+'JoinCategory.element_class'
+sage: ZZ.__name__
+'JoinCategory.parent_class'
+```
+This change causes a few failures which need to be fixed.
+
+2. The implementation of `getattr_from_other_class` is not very robust. For example, static methods are not supported. We fix this by using low-level Python functions to get the attribute and we manually call the descriptor `__get__` if needed.
+
+3. The lookup using `getattr_from_other_class` is about 9 times slower than a normal method lookup::
+
+```
+sage: def foo(self): return
+sage: Sets().element_class.foo = foo
+sage: def g(x):
+....:     for i in range(1000):
+....:          x.foo()
+
+sage: x = Semigroups().example().an_element()
+sage: y = 1
+
+sage: %timeit g(x)
+10000 loops, best of 3: 115 µs per loop
+
+sage: %timeit g(y)
+1000 loops, best of 3: 1.18 ms per loop
+```
+We improve on this by roughly a factor 2 (but even then, it's still a lot slower than usual method lookup).
+
+NOTE: This needs a trivial Cython patch (accepted by upstream): https://github.com/cython/cython/pull/522
+
+Test
 
 Comment: 1
 
```




---

archive/issue_comments_299913.json:
```json
{
    "body": "<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-06-20T13:12:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299913",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_299914.json:
```json
{
    "body": "<a id='comment:34'></a>New commits:",
    "created_at": "2016-06-22T09:01:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299914",
    "user": "https://github.com/embray"
}
```

<a id='comment:34'></a>New commits:



---

archive/issue_comments_299915.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,38 @@\n+For parents and elements implemented in Cython, category lookup is emulated in `__getattr__` using `getattr_from_other_class`. In this ticket, this is refactored a bit:\n \n+1. We should not pick up special attributes from `type`, there is no point in returning the type name of the category here (similarly for `__dict__`, `__mro__`, ...):\n+\n+```\n+sage: ZZ(1).__name__\n+'JoinCategory.element_class'\n+sage: ZZ.__name__\n+'JoinCategory.parent_class'\n+```\n+This change causes a few failures which need to be fixed.\n+\n+2. The implementation of `getattr_from_other_class` is not very robust. For example, static methods are not supported. We fix this by using low-level Python functions to get the attribute and we manually call the descriptor `__get__` if needed.\n+\n+3. The lookup using `getattr_from_other_class` is about 9 times slower than a normal method lookup::\n+\n+```\n+sage: def foo(self): return\n+sage: Sets().element_class.foo = foo\n+sage: def g(x):\n+....:     for i in range(1000):\n+....:          x.foo()\n+\n+sage: x = Semigroups().example().an_element()\n+sage: y = 1\n+\n+sage: %timeit g(x)\n+10000 loops, best of 3: 115 \u00b5s per loop\n+\n+sage: %timeit g(y)\n+1000 loops, best of 3: 1.18 ms per loop\n+```\n+We improve on this by roughly a factor 2 (but even then, it's still a lot slower than usual method lookup).\n+\n+NOTE: This needs a trivial Cython patch (accepted by upstream): https://github.com/cython/cython/pull/522\n \n Comment: 1\n \n```\n",
    "created_at": "2016-06-22T09:01:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299915",
    "user": "https://github.com/embray"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,38 @@
+For parents and elements implemented in Cython, category lookup is emulated in `__getattr__` using `getattr_from_other_class`. In this ticket, this is refactored a bit:
 
+1. We should not pick up special attributes from `type`, there is no point in returning the type name of the category here (similarly for `__dict__`, `__mro__`, ...):
+
+```
+sage: ZZ(1).__name__
+'JoinCategory.element_class'
+sage: ZZ.__name__
+'JoinCategory.parent_class'
+```
+This change causes a few failures which need to be fixed.
+
+2. The implementation of `getattr_from_other_class` is not very robust. For example, static methods are not supported. We fix this by using low-level Python functions to get the attribute and we manually call the descriptor `__get__` if needed.
+
+3. The lookup using `getattr_from_other_class` is about 9 times slower than a normal method lookup::
+
+```
+sage: def foo(self): return
+sage: Sets().element_class.foo = foo
+sage: def g(x):
+....:     for i in range(1000):
+....:          x.foo()
+
+sage: x = Semigroups().example().an_element()
+sage: y = 1
+
+sage: %timeit g(x)
+10000 loops, best of 3: 115 µs per loop
+
+sage: %timeit g(y)
+1000 loops, best of 3: 1.18 ms per loop
+```
+We improve on this by roughly a factor 2 (but even then, it's still a lot slower than usual method lookup).
+
+NOTE: This needs a trivial Cython patch (accepted by upstream): https://github.com/cython/cython/pull/522
 
 Comment: 1
 
```




---

archive/issue_comments_299916.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-06-22T09:03:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299916",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_299917.json:
```json
{
    "body": "<a id='comment:36'></a>Thanks Erik!",
    "created_at": "2016-06-22T09:04:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299917",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:36'></a>Thanks Erik!



---

archive/issue_comments_299918.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,42 @@\n+For parents and elements implemented in Cython, category lookup is emulated in `__getattr__` using `getattr_from_other_class`. In this ticket, this is refactored a bit:\n \n+1. We should not pick up special attributes from `type`, there is no point in returning the type name of the category here (similarly for `__dict__`, `__mro__`, ...):\n+\n+```\n+sage: ZZ(1).__name__\n+'JoinCategory.element_class'\n+sage: ZZ.__name__\n+'JoinCategory.parent_class'\n+```\n+This change causes a few failures which need to be fixed.\n+\n+2. The implementation of `getattr_from_other_class` is not very robust. For example, static methods are not supported. We fix this by using low-level Python functions to get the attribute and we manually call the descriptor `__get__` if needed.\n+\n+3. We shouldn't do anything special with double-underscore private attributes: in plain Python, this is implemented by the parser and not by `getattr()`. So `__getattr__` would already receive the mangled private name.\n+\n+4. Some of the changes broke `_sage_src_lines_`, so we also change that: currently, `_sage_src_lines_()` is used both to get the source lines of a class (e.g. dynamic classes) and an instance (e.g. cached functions). We change this to always mean the source lines of an instance, which makes things clearer.\n+\n+5. The lookup using `getattr_from_other_class` is about 9 times slower than a normal method lookup::\n+\n+```\n+sage: def foo(self): return\n+sage: Sets().element_class.foo = foo\n+sage: def g(x):\n+....:     for i in range(1000):\n+....:          x.foo()\n+\n+sage: x = Semigroups().example().an_element()\n+sage: y = 1\n+\n+sage: %timeit g(x)\n+10000 loops, best of 3: 115 \u00b5s per loop\n+\n+sage: %timeit g(y)\n+1000 loops, best of 3: 1.18 ms per loop\n+```\n+We improve on this by roughly a factor 2 (but even then, it's still a lot slower than usual method lookup).\n+\n+NOTE: This needs a trivial Cython patch (accepted by upstream): https://github.com/cython/cython/pull/522\n \n Comment: 1\n \n```\n",
    "created_at": "2016-07-15T14:30:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299918",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,42 @@
+For parents and elements implemented in Cython, category lookup is emulated in `__getattr__` using `getattr_from_other_class`. In this ticket, this is refactored a bit:
 
+1. We should not pick up special attributes from `type`, there is no point in returning the type name of the category here (similarly for `__dict__`, `__mro__`, ...):
+
+```
+sage: ZZ(1).__name__
+'JoinCategory.element_class'
+sage: ZZ.__name__
+'JoinCategory.parent_class'
+```
+This change causes a few failures which need to be fixed.
+
+2. The implementation of `getattr_from_other_class` is not very robust. For example, static methods are not supported. We fix this by using low-level Python functions to get the attribute and we manually call the descriptor `__get__` if needed.
+
+3. We shouldn't do anything special with double-underscore private attributes: in plain Python, this is implemented by the parser and not by `getattr()`. So `__getattr__` would already receive the mangled private name.
+
+4. Some of the changes broke `_sage_src_lines_`, so we also change that: currently, `_sage_src_lines_()` is used both to get the source lines of a class (e.g. dynamic classes) and an instance (e.g. cached functions). We change this to always mean the source lines of an instance, which makes things clearer.
+
+5. The lookup using `getattr_from_other_class` is about 9 times slower than a normal method lookup::
+
+```
+sage: def foo(self): return
+sage: Sets().element_class.foo = foo
+sage: def g(x):
+....:     for i in range(1000):
+....:          x.foo()
+
+sage: x = Semigroups().example().an_element()
+sage: y = 1
+
+sage: %timeit g(x)
+10000 loops, best of 3: 115 µs per loop
+
+sage: %timeit g(y)
+1000 loops, best of 3: 1.18 ms per loop
+```
+We improve on this by roughly a factor 2 (but even then, it's still a lot slower than usual method lookup).
+
+NOTE: This needs a trivial Cython patch (accepted by upstream): https://github.com/cython/cython/pull/522
 
 Comment: 1
 
```




---

archive/issue_comments_299919.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-07-15T14:35:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299919",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_299920.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,42 @@\n+For parents and elements implemented in Cython, category lookup is emulated in `__getattr__` using `getattr_from_other_class`. In this ticket, this is refactored a bit:\n \n+1. We should not pick up special attributes from `type`, there is no point in returning the type name of the category here (similarly for `__dict__`, `__mro__`, ...):\n+\n+```\n+sage: ZZ(1).__name__\n+'JoinCategory.element_class'\n+sage: ZZ.__name__\n+'JoinCategory.parent_class'\n+```\n+This change causes a few failures which need to be fixed.\n+\n+2. The implementation of `getattr_from_other_class` is not very robust. For example, static methods are not supported. We fix this by using low-level Python functions to get the attribute and we manually call the descriptor `__get__` if needed.\n+\n+3. We shouldn't do anything special with double-underscore private attributes: in plain Python, this is implemented by the parser and not by `getattr()`. So `__getattr__` would already receive the mangled private name.\n+\n+4. Some of the changes broke `_sage_src_lines_`, so we also change that: currently, `_sage_src_lines_()` is used both to get the source lines of a class (e.g. dynamic classes) and an instance (e.g. cached functions). We change this to always mean the source lines of an instance, which makes things clearer.\n+\n+5. The lookup using `getattr_from_other_class` is about 9 times slower than a normal method lookup::\n+\n+```\n+sage: def foo(self): return\n+sage: Sets().element_class.foo = foo\n+sage: def g(x):\n+....:     for i in range(1000):\n+....:          x.foo()\n+\n+sage: x = Semigroups().example().an_element()\n+sage: y = 1\n+\n+sage: %timeit g(x)\n+10000 loops, best of 3: 115 \u00b5s per loop\n+\n+sage: %timeit g(y)\n+1000 loops, best of 3: 1.18 ms per loop\n+```\n+We improve on this by roughly a factor 2 (but even then, it's still a lot slower than usual method lookup).\n+\n+NOTE: This needs a trivial Cython patch, see #21030 for the Cython upgrade.\n \n Comment: 1\n \n```\n",
    "created_at": "2016-07-15T14:35:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299920",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,42 @@
+For parents and elements implemented in Cython, category lookup is emulated in `__getattr__` using `getattr_from_other_class`. In this ticket, this is refactored a bit:
 
+1. We should not pick up special attributes from `type`, there is no point in returning the type name of the category here (similarly for `__dict__`, `__mro__`, ...):
+
+```
+sage: ZZ(1).__name__
+'JoinCategory.element_class'
+sage: ZZ.__name__
+'JoinCategory.parent_class'
+```
+This change causes a few failures which need to be fixed.
+
+2. The implementation of `getattr_from_other_class` is not very robust. For example, static methods are not supported. We fix this by using low-level Python functions to get the attribute and we manually call the descriptor `__get__` if needed.
+
+3. We shouldn't do anything special with double-underscore private attributes: in plain Python, this is implemented by the parser and not by `getattr()`. So `__getattr__` would already receive the mangled private name.
+
+4. Some of the changes broke `_sage_src_lines_`, so we also change that: currently, `_sage_src_lines_()` is used both to get the source lines of a class (e.g. dynamic classes) and an instance (e.g. cached functions). We change this to always mean the source lines of an instance, which makes things clearer.
+
+5. The lookup using `getattr_from_other_class` is about 9 times slower than a normal method lookup::
+
+```
+sage: def foo(self): return
+sage: Sets().element_class.foo = foo
+sage: def g(x):
+....:     for i in range(1000):
+....:          x.foo()
+
+sage: x = Semigroups().example().an_element()
+sage: y = 1
+
+sage: %timeit g(x)
+10000 loops, best of 3: 115 µs per loop
+
+sage: %timeit g(y)
+1000 loops, best of 3: 1.18 ms per loop
+```
+We improve on this by roughly a factor 2 (but even then, it's still a lot slower than usual method lookup).
+
+NOTE: This needs a trivial Cython patch, see #21030 for the Cython upgrade.
 
 Comment: 1
 
```




---

archive/issue_comments_299921.json:
```json
{
    "body": "<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-15T14:40:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299921",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_299922.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-07-15T14:57:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299922",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_299923.json:
```json
{
    "body": "<a id='comment:41'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-15T16:08:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299923",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:41'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_299924.json:
```json
{
    "body": "<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-25T15:54:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299924",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:42'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_299925.json:
```json
{
    "body": "<a id='comment:43'></a>why is this test removed\n\n```diff\n-        We test that \"private\" attributes are not requested from the element class\n-        of the category (:trac:`10467`)::\n-\n-            sage: C = EuclideanDomains()\n-            sage: P.<x> = QQ[]\n-            sage: C.element_class.__foo = 'bar'\n-            sage: x.parent() in C\n-            True\n-            sage: x.__foo\n-            Traceback (most recent call last):\n-            ...\n-            AttributeError: 'sage.rings.polynomial.polynomial_rational_flint.Polynomial_rational_flint' object has no attribute '__foo'\n```",
    "created_at": "2016-07-25T22:14:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299925",
    "user": "https://github.com/videlec"
}
```

<a id='comment:43'></a>why is this test removed

```diff
-        We test that "private" attributes are not requested from the element class
-        of the category (:trac:`10467`)::
-
-            sage: C = EuclideanDomains()
-            sage: P.<x> = QQ[]
-            sage: C.element_class.__foo = 'bar'
-            sage: x.parent() in C
-            True
-            sage: x.__foo
-            Traceback (most recent call last):
-            ...
-            AttributeError: 'sage.rings.polynomial.polynomial_rational_flint.Polynomial_rational_flint' object has no attribute '__foo'
```



---

archive/issue_comments_299926.json:
```json
{
    "body": "<a id='comment:44'></a>similarly\n\n```diff\n-        We test that \"private\" attributes are not requested from the element class\n-        of the category (:trac:`10467`)::\n-\n-            sage: P = Parent(QQ, category=CommutativeRings())\n-            sage: P.category().parent_class.__foo = 'bar'\n-            sage: P.__foo\n-            Traceback (most recent call last):\n-            ...\n-            AttributeError: 'sage.structure.parent.Parent' object has no attribute '__foo'\n```",
    "created_at": "2016-07-25T22:14:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299926",
    "user": "https://github.com/videlec"
}
```

<a id='comment:44'></a>similarly

```diff
-        We test that "private" attributes are not requested from the element class
-        of the category (:trac:`10467`)::
-
-            sage: P = Parent(QQ, category=CommutativeRings())
-            sage: P.category().parent_class.__foo = 'bar'
-            sage: P.__foo
-            Traceback (most recent call last):
-            ...
-            AttributeError: 'sage.structure.parent.Parent' object has no attribute '__foo'
```



---

archive/issue_comments_299927.json:
```json
{
    "body": "<a id='comment:45'></a>Replying to [comment:43 vdelecroix]:\n> why is this test removed\n\n\nBecause #10467 was a mistake, see point 3 in the ticket description.",
    "created_at": "2016-07-26T07:27:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299927",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:45'></a>Replying to [comment:43 vdelecroix]:
> why is this test removed


Because #10467 was a mistake, see point 3 in the ticket description.



---

archive/issue_comments_299928.json:
```json
{
    "body": "<a id='comment:46'></a>More precisely: see #10467#comment:18",
    "created_at": "2016-07-26T07:27:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299928",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:46'></a>More precisely: see #10467#comment:18



---

archive/issue_comments_299929.json:
```json
{
    "body": "<a id='comment:47'></a>Aargh....... this whole \"category lookup\" mechanism is causing me so much frustration with #20767. It is a very fragile hack which just happens to work correctly in the current setting but when you change anything in the coercion model it breaks.\n\nI am starting to think we should reconsider the whole category approach.",
    "created_at": "2016-07-26T15:07:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299929",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:47'></a>Aargh....... this whole "category lookup" mechanism is causing me so much frustration with #20767. It is a very fragile hack which just happens to work correctly in the current setting but when you change anything in the coercion model it breaks.

I am starting to think we should reconsider the whole category approach.



---

archive/issue_comments_299930.json:
```json
{
    "body": "<a id='comment:48'></a>In case this could be useful, we could have a live chat about this tomorrow between 11pm and 2pm, or latter in the week.\n\nCheers,",
    "created_at": "2016-07-26T21:14:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299930",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:48'></a>In case this could be useful, we could have a live chat about this tomorrow between 11pm and 2pm, or latter in the week.

Cheers,



---

archive/issue_comments_299931.json:
```json
{
    "body": "<a id='comment:49'></a>Replying to [comment:48 nthiery]:\n> In case this could be useful, we could have a live chat about this tomorrow between 11pm and 2pm, or latter in the week.\n\n\nYou meant 11am-2pm? Given that Santiago is -6h from Paris, it will be hard for me before 2pm (=8am in Santiago).",
    "created_at": "2016-07-27T03:12:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299931",
    "user": "https://github.com/videlec"
}
```

<a id='comment:49'></a>Replying to [comment:48 nthiery]:
> In case this could be useful, we could have a live chat about this tomorrow between 11pm and 2pm, or latter in the week.


You meant 11am-2pm? Given that Santiago is -6h from Paris, it will be hard for me before 2pm (=8am in Santiago).



---

archive/issue_comments_299932.json:
```json
{
    "body": "<a id='comment:50'></a>I am available most days during Paris daytime...",
    "created_at": "2016-07-27T07:52:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299932",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:50'></a>I am available most days during Paris daytime...



---

archive/issue_comments_299933.json:
```json
{
    "body": "<a id='comment:51'></a>Anyway, I am also hitting Cython bugs/oddities, so there are other battles to fight.",
    "created_at": "2016-07-27T13:20:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299933",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:51'></a>Anyway, I am also hitting Cython bugs/oddities, so there are other battles to fight.



---

archive/issue_comments_299934.json:
```json
{
    "body": "<a id='comment:52'></a>In #20767, I \"solved\" the category problem (see [comment:47]) in the following way:\n\n- double-underscore methods (e.g. `__add__`) are never taken from the category.\n\n- anything deriving directly from `Element` fully supports single-underscore methods (e.g. `_add_`) from the category.\n\n- anything deriving from `ModuleElement`, `RingElement`,... has only partial support for single-underscore methods from the category.\n\n- nothing changes for non-arithmetic methods (e.g. `base_ring`).\n\nThe above rules do not break any existing usage of categories. I hope you can live with this...",
    "created_at": "2016-08-03T11:00:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299934",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:52'></a>In #20767, I "solved" the category problem (see [comment:47]) in the following way:

- double-underscore methods (e.g. `__add__`) are never taken from the category.

- anything deriving directly from `Element` fully supports single-underscore methods (e.g. `_add_`) from the category.

- anything deriving from `ModuleElement`, `RingElement`,... has only partial support for single-underscore methods from the category.

- nothing changes for non-arithmetic methods (e.g. `base_ring`).

The above rules do not break any existing usage of categories. I hope you can live with this...



---

archive/issue_comments_299935.json:
```json
{
    "body": "<a id='comment:53'></a>The following example of `getattr_from_other_class` line 249-253 in `sage/structure/misc.pyx` seems broken\n\n```\nsage: n = 1\nsage: ip = get_ipython()\nsage: ip.magic_psearch('n.N')\nTraceback (most recent call last):\n...\nAttributeError: 'SageTerminalInteractiveShell' object has no attribute 'magic_psearch'\n```",
    "created_at": "2016-08-26T14:45:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299935",
    "user": "https://github.com/videlec"
}
```

<a id='comment:53'></a>The following example of `getattr_from_other_class` line 249-253 in `sage/structure/misc.pyx` seems broken

```
sage: n = 1
sage: ip = get_ipython()
sage: ip.magic_psearch('n.N')
Traceback (most recent call last):
...
AttributeError: 'SageTerminalInteractiveShell' object has no attribute 'magic_psearch'
```



---

archive/issue_comments_299936.json:
```json
{
    "body": "<a id='comment:54'></a>Replying to [comment:53 vdelecroix]:\n> The following example of `getattr_from_other_class` line 249-253 in `sage/structure/misc.pyx` seems broken\n\n\nTrue, but surely not because of this ticket. Most likely, it has to do with the IPython 5 upgrade.",
    "created_at": "2016-08-26T15:27:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299936",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:54'></a>Replying to [comment:53 vdelecroix]:
> The following example of `getattr_from_other_class` line 249-253 in `sage/structure/misc.pyx` seems broken


True, but surely not because of this ticket. Most likely, it has to do with the IPython 5 upgrade.



---

archive/issue_comments_299937.json:
```json
{
    "body": "<a id='comment:55'></a>Is that what we want\n\n```\nif self._category is None:\n    # Usually, this will just raise AttributeError in\n    # getattr_from_other_class().\n    cls = type\nelse:\n    cls = self._category.parent_class\n```\nIn other words, are there use case where the category is not initialized but we still might need to go through `__getattr__`?",
    "created_at": "2016-08-26T16:00:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299937",
    "user": "https://github.com/videlec"
}
```

<a id='comment:55'></a>Is that what we want

```
if self._category is None:
    # Usually, this will just raise AttributeError in
    # getattr_from_other_class().
    cls = type
else:
    cls = self._category.parent_class
```
In other words, are there use case where the category is not initialized but we still might need to go through `__getattr__`?



---

archive/issue_comments_299938.json:
```json
{
    "body": "<a id='comment:56'></a>Why in `Element` there is a two stage `__getattr__ -> getattr_from_category -> getattr_from_other_class` whereas in `Parent` there is no intermediate `getattr_from_category`?",
    "created_at": "2016-08-26T16:04:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299938",
    "user": "https://github.com/videlec"
}
```

<a id='comment:56'></a>Why in `Element` there is a two stage `__getattr__ -> getattr_from_category -> getattr_from_other_class` whereas in `Parent` there is no intermediate `getattr_from_category`?



---

archive/issue_comments_299939.json:
```json
{
    "body": "<a id='comment:57'></a>Replying to [comment:56 vdelecroix]:\n> Why in `Element` there is a two stage `__getattr__ -> getattr_from_category -> getattr_from_other_class` whereas in `Parent` there is no intermediate `getattr_from_category`?\n\n\nMainly because I care more about `Element` than `Parent` (with #20767 in mind). The idea of `getattr_from_category` was to allow direct access to the category methods without normal methods. In the end, I am not using this in #20767 but I kept it because it looked potentially useful. And, since this a `cdef` method, there is essentially no performance penalty.",
    "created_at": "2016-08-27T08:45:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299939",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:57'></a>Replying to [comment:56 vdelecroix]:
> Why in `Element` there is a two stage `__getattr__ -> getattr_from_category -> getattr_from_other_class` whereas in `Parent` there is no intermediate `getattr_from_category`?


Mainly because I care more about `Element` than `Parent` (with #20767 in mind). The idea of `getattr_from_category` was to allow direct access to the category methods without normal methods. In the end, I am not using this in #20767 but I kept it because it looked potentially useful. And, since this a `cdef` method, there is essentially no performance penalty.



---

archive/issue_comments_299940.json:
```json
{
    "body": "<a id='comment:58'></a>Replying to [comment:55 vdelecroix]:\n> In other words, are there use case where the category is not initialized but we still might need to go through `__getattr__`?\n\n\nProbably not, but the old code also supported that (directly raising an `AttributeError`). But I just let `getattr_from_other_class` raise the error.",
    "created_at": "2016-08-27T08:47:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299940",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:58'></a>Replying to [comment:55 vdelecroix]:
> In other words, are there use case where the category is not initialized but we still might need to go through `__getattr__`?


Probably not, but the old code also supported that (directly raising an `AttributeError`). But I just let `getattr_from_other_class` raise the error.



---

archive/issue_comments_299941.json:
```json
{
    "body": "<a id='comment:59'></a>Replying to [comment:57 jdemeyer]:\n> Replying to [comment:56 vdelecroix]:\n> > Why in `Element` there is a two stage `__getattr__ -> getattr_from_category -> getattr_from_other_class` whereas in `Parent` there is no intermediate `getattr_from_category`?\n\n> \n> Mainly because I care more about `Element` than `Parent` (with #20767 in mind). The idea of `getattr_from_category` was to allow direct access to the category methods without normal methods. In the end, I am not using this in #20767 but I kept it because it looked potentially useful. And, since this a `cdef` method, there is essentially no performance penalty.\n\n\nIt just looks weird to have twice the same thing implemented differently. I am just complaining about readability.",
    "created_at": "2016-08-30T13:46:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299941",
    "user": "https://github.com/videlec"
}
```

<a id='comment:59'></a>Replying to [comment:57 jdemeyer]:
> Replying to [comment:56 vdelecroix]:
> > Why in `Element` there is a two stage `__getattr__ -> getattr_from_category -> getattr_from_other_class` whereas in `Parent` there is no intermediate `getattr_from_category`?

> 
> Mainly because I care more about `Element` than `Parent` (with #20767 in mind). The idea of `getattr_from_category` was to allow direct access to the category methods without normal methods. In the end, I am not using this in #20767 but I kept it because it looked potentially useful. And, since this a `cdef` method, there is essentially no performance penalty.


It just looks weird to have twice the same thing implemented differently. I am just complaining about readability.



---

archive/issue_comments_299942.json:
```json
{
    "body": "<a id='comment:60'></a>Replying to [comment:59 vdelecroix]:\n> It just looks weird to have twice the same thing implemented differently. I am just complaining about readability.\n\n\nOK, I will make the requested changes. I will also move the category lookup stuff from `Parent` to `CategoryObject` where it belongs.",
    "created_at": "2016-08-31T07:58:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299942",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:60'></a>Replying to [comment:59 vdelecroix]:
> It just looks weird to have twice the same thing implemented differently. I am just complaining about readability.


OK, I will make the requested changes. I will also move the category lookup stuff from `Parent` to `CategoryObject` where it belongs.



---

archive/issue_comments_299943.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-08-31T07:58:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299943",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_events_055661.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-08-31T07:58:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "milestone": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20686#event-55661"
}
```



---

archive/issue_comments_299944.json:
```json
{
    "body": "<a id='comment:62'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-31T08:52:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299944",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:62'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_299945.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-08-31T08:52:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299945",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_299946.json:
```json
{
    "body": "<a id='comment:64'></a>Do you know whether it is worth it to keep this `__cached_method` dictionary? I would be happy to see timings here. (though this is rather disjoint from the main preoccupation of this ticket)",
    "created_at": "2016-08-31T14:51:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299946",
    "user": "https://github.com/videlec"
}
```

<a id='comment:64'></a>Do you know whether it is worth it to keep this `__cached_method` dictionary? I would be happy to see timings here. (though this is rather disjoint from the main preoccupation of this ticket)



---

archive/issue_comments_299947.json:
```json
{
    "body": "<a id='comment:65'></a>In `CategoryObject.__getattr__`  it would better to do\n\n```\ntry:\n    return self.__cached_methods[name]\nexcept KeyError:\n    if self._category is None:\n        cls = type\n    else:\n        cls = self._category.parent_class\n    attr = getattr_from_other_class(self, cls, name)\n    self.__cached_methods[name] = attr\n    return attr\n```",
    "created_at": "2016-08-31T14:53:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299947",
    "user": "https://github.com/videlec"
}
```

<a id='comment:65'></a>In `CategoryObject.__getattr__`  it would better to do

```
try:
    return self.__cached_methods[name]
except KeyError:
    if self._category is None:
        cls = type
    else:
        cls = self._category.parent_class
    attr = getattr_from_other_class(self, cls, name)
    self.__cached_methods[name] = attr
    return attr
```



---

archive/issue_comments_299948.json:
```json
{
    "body": "<a id='comment:67'></a>Replying to [comment:64 vdelecroix]:\n> Do you know whether it is worth it to keep this `__cached_method` dictionary?\n\n\nI would guess so since a lookup in a dictionary should be faster than whatever `getattr_from_other_class` is doing.",
    "created_at": "2016-08-31T14:58:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299948",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:67'></a>Replying to [comment:64 vdelecroix]:
> Do you know whether it is worth it to keep this `__cached_method` dictionary?


I would guess so since a lookup in a dictionary should be faster than whatever `getattr_from_other_class` is doing.



---

archive/issue_comments_299949.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-08-31T14:59:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299949",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_299950.json:
```json
{
    "body": "<a id='comment:69'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-31T16:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299950",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:69'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_299951.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-08-31T16:36:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299951",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_299952.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-08-31T21:29:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299952",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_299953.json:
```json
{
    "body": "<a id='comment:71'></a>Got two failures with ptestlong\n\n```\nFile \"src/sage/combinat/root_system/integrable_representations.py\", line 189, in sage.combinat.root_system.integrable_representations.IntegrableRepresentation.__init__\nFailed example:\n    TestSuite(V).run()\nExpected nothing\nGot:\n   Failure in _test_additive_associativity:\n   Traceback (most recent call last):\n   ...\n   AttributeError: 'IntegrableRepresentation' object has no attribute '_an_element_'\n   ...\n```\nand similarly\n\n```\n**********************************************************************\nFile \"src/sage/homology/hochschild_complex.py\", line 98, in sage.homology.hochschild_complex.HochschildComplex.__init__\nFailed example:\n    TestSuite(H).run(skip=\"_test_category\")\nExpected nothing\nGot:\n    Failure in _test_additive_associativity:\n    Traceback (most recent call last):\n    ...\n    AttributeError: 'HochschildComplex' object has no attribute '_an_element_'\n    ...\n```",
    "created_at": "2016-08-31T21:29:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299953",
    "user": "https://github.com/videlec"
}
```

<a id='comment:71'></a>Got two failures with ptestlong

```
File "src/sage/combinat/root_system/integrable_representations.py", line 189, in sage.combinat.root_system.integrable_representations.IntegrableRepresentation.__init__
Failed example:
    TestSuite(V).run()
Expected nothing
Got:
   Failure in _test_additive_associativity:
   Traceback (most recent call last):
   ...
   AttributeError: 'IntegrableRepresentation' object has no attribute '_an_element_'
   ...
```
and similarly

```
**********************************************************************
File "src/sage/homology/hochschild_complex.py", line 98, in sage.homology.hochschild_complex.HochschildComplex.__init__
Failed example:
    TestSuite(H).run(skip="_test_category")
Expected nothing
Got:
    Failure in _test_additive_associativity:
    Traceback (most recent call last):
    ...
    AttributeError: 'HochschildComplex' object has no attribute '_an_element_'
    ...
```



---

archive/issue_comments_299954.json:
```json
{
    "body": "<a id='comment:72'></a>And also not related to `_an_element_`\n\n```\n**********************************************************************\nFile \"src/sage/combinat/root_system/integrable_representations.py\", line 189, in sage.combinat.root_system.integrable_representations.IntegrableRepresentation.\n__init__\nFailed example:\n    TestSuite(V).run()\nExpected nothing\nGot:\n    ...\n    Failure in _test_not_implemented_methods:\n    Traceback (most recent call last):\n    ...\n    AssertionError: Not implemented method: __contains__\n    ...\n```",
    "created_at": "2016-08-31T21:31:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299954",
    "user": "https://github.com/videlec"
}
```

<a id='comment:72'></a>And also not related to `_an_element_`

```
**********************************************************************
File "src/sage/combinat/root_system/integrable_representations.py", line 189, in sage.combinat.root_system.integrable_representations.IntegrableRepresentation.
__init__
Failed example:
    TestSuite(V).run()
Expected nothing
Got:
    ...
    Failure in _test_not_implemented_methods:
    Traceback (most recent call last):
    ...
    AssertionError: Not implemented method: __contains__
    ...
```



---

archive/issue_comments_299955.json:
```json
{
    "body": "<a id='comment:73'></a>The last patchbot report was green, so this must be a recently-introduced problem.",
    "created_at": "2016-09-01T07:22:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299955",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:73'></a>The last patchbot report was green, so this must be a recently-introduced problem.



---

archive/issue_comments_299956.json:
```json
{
    "body": "<a id='comment:74'></a>Interestingly, these failures are for classes inheriting from `CategoryObject` but not `Parent`.",
    "created_at": "2016-09-01T08:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299956",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:74'></a>Interestingly, these failures are for classes inheriting from `CategoryObject` but not `Parent`.



---

archive/issue_comments_299957.json:
```json
{
    "body": "<a id='comment:75'></a>Those failures are true bugs in `HochschildComplex` and `IntegrableRepresentation`: they pretend to be in some category but do not actually implement everything needed to be in that category. This ticket causes the category tests to be run (which is good) but then the tests fail.\n\n```\nsage: SGA = SymmetricGroupAlgebra(QQ, 3)\nsage: T = SGA.trivial_representation()\nsage: H = SGA.hochschild_complex(T)\nsage: H in CommutativeAdditiveGroups()\nTrue\nsage: H.zero()\n...\nTypeError: 'HochschildComplex' object is not callable\n```\n\nand\n\n```\nsage: Lambda = RootSystem(['A',3,1]).weight_lattice(extended=true).fundamental_weights()\nsage: V = IntegrableRepresentation(Lambda[1]+Lambda[2]+Lambda[3])\nsage: V in CommutativeAdditiveGroups()\nTrue\nsage: V.zero()\n...\nTypeError: 'IntegrableRepresentation' object is not callable\n```\n\nI think the right thing to do here is to mark those tests as `# known bug`.",
    "created_at": "2016-09-01T08:32:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299957",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:75'></a>Those failures are true bugs in `HochschildComplex` and `IntegrableRepresentation`: they pretend to be in some category but do not actually implement everything needed to be in that category. This ticket causes the category tests to be run (which is good) but then the tests fail.

```
sage: SGA = SymmetricGroupAlgebra(QQ, 3)
sage: T = SGA.trivial_representation()
sage: H = SGA.hochschild_complex(T)
sage: H in CommutativeAdditiveGroups()
True
sage: H.zero()
...
TypeError: 'HochschildComplex' object is not callable
```

and

```
sage: Lambda = RootSystem(['A',3,1]).weight_lattice(extended=true).fundamental_weights()
sage: V = IntegrableRepresentation(Lambda[1]+Lambda[2]+Lambda[3])
sage: V in CommutativeAdditiveGroups()
True
sage: V.zero()
...
TypeError: 'IntegrableRepresentation' object is not callable
```

I think the right thing to do here is to mark those tests as `# known bug`.



---

archive/issue_comments_299958.json:
```json
{
    "body": "<a id='comment:76'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-01T08:54:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299958",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:76'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_299959.json:
```json
{
    "body": "<a id='comment:77'></a>I created #21386 and #21387 for the broken testsuites.",
    "created_at": "2016-09-01T08:55:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299959",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:77'></a>I created #21386 and #21387 for the broken testsuites.



---

archive/issue_comments_299960.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-09-01T08:55:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299960",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_299961.json:
```json
{
    "body": "<a id='comment:78'></a>I hope to fix both today.",
    "created_at": "2016-09-01T13:52:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299961",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:78'></a>I hope to fix both today.



---

archive/issue_comments_299962.json:
```json
{
    "body": "<a id='comment:79'></a>good to go!",
    "created_at": "2016-09-01T14:22:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299962",
    "user": "https://github.com/videlec"
}
```

<a id='comment:79'></a>good to go!



---

archive/issue_comments_299963.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-09-01T14:22:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299963",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_299964.json:
```json
{
    "body": "<a id='comment:80'></a>This ticket seems to cause #21409",
    "created_at": "2016-09-03T15:11:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299964",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:80'></a>This ticket seems to cause #21409



---

archive/issue_comments_299965.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-09-04T13:38:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20686#issuecomment-299965",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_055662.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-09-04T13:38:02Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20686",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20686#event-55662"
}
```
