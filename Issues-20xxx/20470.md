# Issue 20470: Conversion of sparse to dense matrices over F2 is unspeakably slow

archive/issues_020233.json:
```json
{
    "body": "Converting a sparse matrix to a dense one should be an easy operation: create the zero matrix and then populate a few entries. But behold:\n\n```\nsage: time S = CremonaModularSymbols(400001, sign=+1)\nCPU times: user 15 s, sys: 36 ms, total: 15 s\nWall time: 15 s\nsage: time T2 = S.hecke_matrix(2) # This matrix has <= 3 nonzero entries per row\nCPU times: user 11.6 s, sys: 4.19 s, total: 15.8 s\nWall time: 15.8 s\nsage: time sT2 = T2.sage_matrix_over_ZZ()\nCPU times: user 1.56 s, sys: 1e+03 \u00b5s, total: 1.56 s\nWall time: 1.56 s\nsage: time sT2F2 = sT2.change_ring(GF(2))\nsage: time sT2F2 = sT2.change_ring(GF(2))\nCPU times: user 979 ms, sys: 8 ms, total: 987 ms\nWall time: 987 ms\nsage: sT2F2\n38098 x 38098 sparse matrix over Finite Field of size 2 (use the '.str()' method to see the entries)\nsage: M2 = MatrixSpace(GF(2), 38098, sparse=False)\nsage: time sT2F2a = M2(sT2F2) #unspeakably slow!\nCPU times: user 19min 43s, sys: 47.2 s, total: 20min 30s\nWall time: 20min 31s\n```\nPresumably this is an artifact of the constructor, as internal operations are much faster:\n\n```\nsage: time sT2F2a.rank()\nCPU times: user 14.4 s, sys: 63 ms, total: 14.5 s\nWall time: 14.5 s\n38098\n```\nBy contrast, staying in the sparse realm has a price which I think is at most only partly related (see https://groups.google.com/forum/#!topic/sage-devel/l1O82XMC0zo for another contributing factor):\n\n```\nsage: time sT2F2.rank()\nCPU times: user 24min 54s, sys: 544 ms, total: 24min 55s\nWall time: 24min 56s\n38098\n```\n\nKeywords: sparse matrices, dense matrices\n\nBranch/Commit: 2cacd0e2eac07fbbe2d8a30496cc8c5c11e0a4b4\n\nReviewer: Kiran Kedlaya\n\nAuthor: John Palmieri\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20470\n\n",
    "closed_at": "2016-04-22T07:13:02Z",
    "created_at": "2016-04-19T19:46:54Z",
    "labels": [
        "component: linear algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "Conversion of sparse to dense matrices over F2 is unspeakably slow",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20470",
    "user": "https://github.com/kedlaya"
}
```
Converting a sparse matrix to a dense one should be an easy operation: create the zero matrix and then populate a few entries. But behold:

```
sage: time S = CremonaModularSymbols(400001, sign=+1)
CPU times: user 15 s, sys: 36 ms, total: 15 s
Wall time: 15 s
sage: time T2 = S.hecke_matrix(2) # This matrix has <= 3 nonzero entries per row
CPU times: user 11.6 s, sys: 4.19 s, total: 15.8 s
Wall time: 15.8 s
sage: time sT2 = T2.sage_matrix_over_ZZ()
CPU times: user 1.56 s, sys: 1e+03 Âµs, total: 1.56 s
Wall time: 1.56 s
sage: time sT2F2 = sT2.change_ring(GF(2))
sage: time sT2F2 = sT2.change_ring(GF(2))
CPU times: user 979 ms, sys: 8 ms, total: 987 ms
Wall time: 987 ms
sage: sT2F2
38098 x 38098 sparse matrix over Finite Field of size 2 (use the '.str()' method to see the entries)
sage: M2 = MatrixSpace(GF(2), 38098, sparse=False)
sage: time sT2F2a = M2(sT2F2) #unspeakably slow!
CPU times: user 19min 43s, sys: 47.2 s, total: 20min 30s
Wall time: 20min 31s
```
Presumably this is an artifact of the constructor, as internal operations are much faster:

```
sage: time sT2F2a.rank()
CPU times: user 14.4 s, sys: 63 ms, total: 14.5 s
Wall time: 14.5 s
38098
```
By contrast, staying in the sparse realm has a price which I think is at most only partly related (see https://groups.google.com/forum/#!topic/sage-devel/l1O82XMC0zo for another contributing factor):

```
sage: time sT2F2.rank()
CPU times: user 24min 54s, sys: 544 ms, total: 24min 55s
Wall time: 24min 56s
38098
```

Keywords: sparse matrices, dense matrices

Branch/Commit: 2cacd0e2eac07fbbe2d8a30496cc8c5c11e0a4b4

Reviewer: Kiran Kedlaya

Author: John Palmieri

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/20470





---

archive/issue_comments_366707.json:
```json
{
    "body": "<a id='comment:1'></a>\nHow much time does\n\n```\ntime sT2F2a = sT2F2.dense_matrix()\n```\ntake? I tried with a smaller matrix, and it's much faster than plugging the matrix into the appropriate matrix space. (That doesn't mean that there isn't a problem, rather that someone could possibly speed up `M2( sparse_matrix )` by calling the `dense_matrix()` method, under suitable circumstances.)",
    "created_at": "2016-04-19T20:50:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20470",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20470#issuecomment-366707",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:1'></a>
How much time does

```
time sT2F2a = sT2F2.dense_matrix()
```
take? I tried with a smaller matrix, and it's much faster than plugging the matrix into the appropriate matrix space. (That doesn't mean that there isn't a problem, rather that someone could possibly speed up `M2( sparse_matrix )` by calling the `dense_matrix()` method, under suitable circumstances.)



---

archive/issue_comments_366708.json:
```json
{
    "body": "<a id='comment:2'></a>\nReplying to [jhpalmieri](#comment%3A1):\n> How much time does\n> \n> ```\n> time sT2F2a = sT2F2.dense_matrix()\n> ```\n> take? I tried with a smaller matrix, and it's much faster than plugging the matrix into the appropriate matrix space. (That doesn't mean that there isn't a problem, rather that someone could possibly speed up `M2( sparse_matrix )` by calling the `dense_matrix()` method, under suitable circumstances.)\n\n\nThat is indeed much faster:\n\n```\nsage: time sT2F2b = sT2F2.dense_matrix()\nCPU times: user 318 ms, sys: 47 ms, total: 365 ms\nWall time: 365 ms\nsage: sT2F2a == sT2F2b\nTrue\n```\n\nI guess that means this is easy to fix: the constructor for dense matrices (over any base), upon receiving a sparse matrix as input, should simply call the `dense_matrix()` method.",
    "created_at": "2016-04-19T20:56:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20470",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20470#issuecomment-366708",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:2'></a>
Replying to [jhpalmieri](#comment%3A1):
> How much time does
> 
> ```
> time sT2F2a = sT2F2.dense_matrix()
> ```
> take? I tried with a smaller matrix, and it's much faster than plugging the matrix into the appropriate matrix space. (That doesn't mean that there isn't a problem, rather that someone could possibly speed up `M2( sparse_matrix )` by calling the `dense_matrix()` method, under suitable circumstances.)


That is indeed much faster:

```
sage: time sT2F2b = sT2F2.dense_matrix()
CPU times: user 318 ms, sys: 47 ms, total: 365 ms
Wall time: 365 ms
sage: sT2F2a == sT2F2b
True
```

I guess that means this is easy to fix: the constructor for dense matrices (over any base), upon receiving a sparse matrix as input, should simply call the `dense_matrix()` method.



---

archive/issue_comments_366709.json:
```json
{
    "body": "<a id='comment:3'></a>\nI think the culprit is the `matrix` method for the `MatrixSpace` class: when you do `M2(...)`, it runs the `__call__` method, which does this:\n\n```\n        return self.matrix(entries, coerce, copy)\n```\nThen the `matrix` method does this, if the input `x` is a matrix with the right size:\n\n```\nx = x.list()  # this is the slow part\n...\nx = list_to_dict(x, m, n)\n```\nSo it should instead call `dense_matrix`.",
    "created_at": "2016-04-19T23:05:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20470",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20470#issuecomment-366709",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:3'></a>
I think the culprit is the `matrix` method for the `MatrixSpace` class: when you do `M2(...)`, it runs the `__call__` method, which does this:

```
        return self.matrix(entries, coerce, copy)
```
Then the `matrix` method does this, if the input `x` is a matrix with the right size:

```
x = x.list()  # this is the slow part
...
x = list_to_dict(x, m, n)
```
So it should instead call `dense_matrix`.



---

archive/issue_comments_366710.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jhpalmieri/dense-sparse\"",
    "created_at": "2016-04-19T23:05:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20470",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20470#issuecomment-366710",
    "user": "https://github.com/jhpalmieri"
}
```

Changing branch from "" to "u/jhpalmieri/dense-sparse"



---

archive/issue_comments_366711.json:
```json
{
    "body": "<a id='comment:5'></a>\nNew commits:\n|                                                                                                                                          |                                                                            |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|\n|[1cdcf1e](https://github.com/sagemath/sagetrac-mirror/commit/1cdcf1e9eac2ab4c5a8f5a2275a59110ca2db865)|`trac 20470: speed up MatrixSpace.__call__ when converting sparse to dense.`|",
    "created_at": "2016-04-19T23:06:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20470",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20470#issuecomment-366711",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:5'></a>
New commits:
|                                                                                                                                          |                                                                            |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------|
|[1cdcf1e](https://github.com/sagemath/sagetrac-mirror/commit/1cdcf1e9eac2ab4c5a8f5a2275a59110ca2db865)|`trac 20470: speed up MatrixSpace.__call__ when converting sparse to dense.`|



---

archive/issue_comments_366712.json:
```json
{
    "body": "Changing author from \"\" to \"John Palmieri\"",
    "created_at": "2016-04-19T23:06:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20470",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20470#issuecomment-366712",
    "user": "https://github.com/jhpalmieri"
}
```

Changing author from "" to "John Palmieri"



---

archive/issue_comments_366713.json:
```json
{
    "body": "Changing commit from \"\" to \"1cdcf1e9eac2ab4c5a8f5a2275a59110ca2db865\"",
    "created_at": "2016-04-19T23:06:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20470",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20470#issuecomment-366713",
    "user": "https://github.com/jhpalmieri"
}
```

Changing commit from "" to "1cdcf1e9eac2ab4c5a8f5a2275a59110ca2db865"



---

archive/issue_comments_366714.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-04-19T23:06:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20470",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20470#issuecomment-366714",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_366715.json:
```json
{
    "body": "<a id='comment:6'></a>\nPatchbot throws up a weird error but I can't tell whether it's meaningful.\n\nMore seriously, is there a good way to doctest this?",
    "created_at": "2016-04-20T00:19:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20470",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20470#issuecomment-366715",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:6'></a>
Patchbot throws up a weird error but I can't tell whether it's meaningful.

More seriously, is there a good way to doctest this?



---

archive/issue_comments_366716.json:
```json
{
    "body": "<a id='comment:7'></a>\nI think I've seen those patchbot errors on other tickets. I don't think they are related. Also, I thought about doctests, but since this is supposed to be a speed upgrade which does not change functionality, I couldn't come up with anything.",
    "created_at": "2016-04-20T02:53:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20470",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20470#issuecomment-366716",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:7'></a>
I think I've seen those patchbot errors on other tickets. I don't think they are related. Also, I thought about doctests, but since this is supposed to be a speed upgrade which does not change functionality, I couldn't come up with anything.



---

archive/issue_comments_366717.json:
```json
{
    "body": "<a id='comment:8'></a>\nYou could add a doctest that took a long time prior (e.g., a few seconds) but now is quite quick (less than half a second).",
    "created_at": "2016-04-20T04:29:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20470",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20470#issuecomment-366717",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:8'></a>
You could add a doctest that took a long time prior (e.g., a few seconds) but now is quite quick (less than half a second).



---

archive/issue_comments_366718.json:
```json
{
    "body": "Changing commit from \"1cdcf1e9eac2ab4c5a8f5a2275a59110ca2db865\" to \"2cacd0e2eac07fbbe2d8a30496cc8c5c11e0a4b4\"",
    "created_at": "2016-04-20T15:19:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20470",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20470#issuecomment-366718",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "1cdcf1e9eac2ab4c5a8f5a2275a59110ca2db865" to "2cacd0e2eac07fbbe2d8a30496cc8c5c11e0a4b4"



---

archive/issue_comments_366719.json:
```json
{
    "body": "<a id='comment:9'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                           |\n|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------|\n|[2cacd0e](https://github.com/sagemath/sagetrac-mirror/commit/2cacd0e2eac07fbbe2d8a30496cc8c5c11e0a4b4)|`trac 20470: add a doctest`|",
    "created_at": "2016-04-20T15:19:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20470",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20470#issuecomment-366719",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                           |
|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------|
|[2cacd0e](https://github.com/sagemath/sagetrac-mirror/commit/2cacd0e2eac07fbbe2d8a30496cc8c5c11e0a4b4)|`trac 20470: add a doctest`|



---

archive/issue_comments_366720.json:
```json
{
    "body": "<a id='comment:10'></a>\nOkay, good idea, here is a doctest.",
    "created_at": "2016-04-20T15:36:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20470",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20470#issuecomment-366720",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:10'></a>
Okay, good idea, here is a doctest.



---

archive/issue_comments_366721.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Kiran Kedlaya\"",
    "created_at": "2016-04-20T18:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20470",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20470#issuecomment-366721",
    "user": "https://github.com/kedlaya"
}
```

Changing reviewer from "" to "Kiran Kedlaya"



---

archive/issue_comments_366722.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-04-20T18:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20470",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20470#issuecomment-366722",
    "user": "https://github.com/kedlaya"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_366723.json:
```json
{
    "body": "<a id='comment:11'></a>\nI'm not sure what the deal is with patchbot, but on my machine this passes all doctests. Positive review.",
    "created_at": "2016-04-20T18:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20470",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20470#issuecomment-366723",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:11'></a>
I'm not sure what the deal is with patchbot, but on my machine this passes all doctests. Positive review.



---

archive/issue_comments_366724.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-04-22T07:13:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20470",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20470#issuecomment-366724",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_366725.json:
```json
{
    "body": "Changing branch from \"u/jhpalmieri/dense-sparse\" to \"2cacd0e2eac07fbbe2d8a30496cc8c5c11e0a4b4\"",
    "created_at": "2016-04-22T07:13:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20470",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20470#issuecomment-366725",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jhpalmieri/dense-sparse" to "2cacd0e2eac07fbbe2d8a30496cc8c5c11e0a4b4"



---

archive/issue_events_070746.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-04-22T07:13:02Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20470",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20470#event-70746"
}
```
