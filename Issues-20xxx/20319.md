# Issue 20319: patchbot failures in sagedev scripts doctests when running inside docker

archive/issues_020082.json:
```json
{
    "body": "When running the patchbot inside the sagemath/sagemath-develop docker container of\nhttps://github.com/sagemath/docker-images, we get the following error:\n\n```\nsage -t --long src/sage/dev/sagedev.py\n**********************************************************************\nFile \"src/sage/dev/sagedev.py\", line 902, in sage.dev.sagedev.SageDev.checkout_branch\nFailed example:\n    dev.git.echo.stash('apply')\nException raised:\n    Traceback (most recent call last):\n      File \"/opt/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 496, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/opt/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 858, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.dev.sagedev.SageDev.checkout_branch[18]>\", line 1, in <module>\n        dev.git.echo.stash('apply')\n      File \"/opt/sage/local/lib/python2.7/site-packages/sage/dev/git_interface.py\", line 1179, in meth\n        return self(git_cmd, *args, **kwds)\n      File \"/opt/sage/local/lib/python2.7/site-packages/sage/dev/git_interface.py\", line 218, in _execute\n        raise GitError(exit_code, cmd, stdout, stderr)\n    GitError: git returned with non-zero exit code (1) for \"git -c user.email=doc@test.test -c user.name=doctest stash apply\".\n    output to stderr: refs/stash@{0} is not a valid reference\n**********************************************************************\nFile \"src/sage/dev/sagedev.py\", line 920, in sage.dev.sagedev.SageDev.checkout_branch\nFailed example:\n    dev.checkout(branch=\"branch1\")\nExpected:\n    The following files in your working directory contain uncommitted changes:\n    <BLANKLINE>\n         tracked\n    <BLANKLINE>\n    Discard changes? [discard/Cancel/stash] discard\n    On local branch \"branch1\" without associated ticket.\n    <BLANKLINE>\n    #  Use \"sage --dev merge\" to include another ticket/branch.\n    #  Use \"sage --dev commit\" to save changes into a new commit.\nGot:\n    On local branch \"branch1\" without associated ticket.\n    <BLANKLINE>\n    # Use \"sage --dev merge\" to include another ticket/branch.\n    # Use \"sage --dev commit\" to save changes into a new commit.\n\n```\n\nTo reproduce (not double checked; we get that error when building the sagemath-patchot docker image; but that should be equivalent):\n\n- install docker\n- `docker run -ti sagemath-develop bash`\n- install and run the patchbot as usual\n\nNo idea at this point on why this fails in this context, but not otherwise.\n\n**CC:**  @embray @jdemeyer @fchapoton tmonteil\n\n**Keywords:** days77\n\n**Reviewer:** Erik Bray, Thierry Monteil\n\n**Author:** Fr\u00e9d\u00e9ric Chapoton\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20319\n\n",
    "closed_at": "2016-06-12T12:02:30Z",
    "created_at": "2016-03-29T21:07:21Z",
    "labels": [
        "component: doctest framework",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "patchbot failures in sagedev scripts doctests when running inside docker",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20319",
    "user": "https://github.com/nthiery"
}
```
When running the patchbot inside the sagemath/sagemath-develop docker container of
https://github.com/sagemath/docker-images, we get the following error:

```
sage -t --long src/sage/dev/sagedev.py
**********************************************************************
File "src/sage/dev/sagedev.py", line 902, in sage.dev.sagedev.SageDev.checkout_branch
Failed example:
    dev.git.echo.stash('apply')
Exception raised:
    Traceback (most recent call last):
      File "/opt/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/opt/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.dev.sagedev.SageDev.checkout_branch[18]>", line 1, in <module>
        dev.git.echo.stash('apply')
      File "/opt/sage/local/lib/python2.7/site-packages/sage/dev/git_interface.py", line 1179, in meth
        return self(git_cmd, *args, **kwds)
      File "/opt/sage/local/lib/python2.7/site-packages/sage/dev/git_interface.py", line 218, in _execute
        raise GitError(exit_code, cmd, stdout, stderr)
    GitError: git returned with non-zero exit code (1) for "git -c user.email=doc@test.test -c user.name=doctest stash apply".
    output to stderr: refs/stash@{0} is not a valid reference
**********************************************************************
File "src/sage/dev/sagedev.py", line 920, in sage.dev.sagedev.SageDev.checkout_branch
Failed example:
    dev.checkout(branch="branch1")
Expected:
    The following files in your working directory contain uncommitted changes:
    <BLANKLINE>
         tracked
    <BLANKLINE>
    Discard changes? [discard/Cancel/stash] discard
    On local branch "branch1" without associated ticket.
    <BLANKLINE>
    #  Use "sage --dev merge" to include another ticket/branch.
    #  Use "sage --dev commit" to save changes into a new commit.
Got:
    On local branch "branch1" without associated ticket.
    <BLANKLINE>
    # Use "sage --dev merge" to include another ticket/branch.
    # Use "sage --dev commit" to save changes into a new commit.

```

To reproduce (not double checked; we get that error when building the sagemath-patchot docker image; but that should be equivalent):

- install docker
- `docker run -ti sagemath-develop bash`
- install and run the patchbot as usual

No idea at this point on why this fails in this context, but not otherwise.

**CC:**  @embray @jdemeyer @fchapoton tmonteil

**Keywords:** days77

**Reviewer:** Erik Bray, Thierry Monteil

**Author:** Frédéric Chapoton

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/20319





---

archive/issue_events_062694.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "rename": {
        "from": "patchbot failure sagedev when running inside docker",
        "to": "patchbot failures in sagedev scripts doctests when running inside docker"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20319#event-62694"
}
```



---

archive/issue_comments_371648.json:
```json
{
    "body": "<a id='comment:3'></a>\nFor the record: are these the only failures that you get?",
    "created_at": "2016-03-30T07:51:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371648",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>
For the record: are these the only failures that you get?



---

archive/issue_comments_371649.json:
```json
{
    "body": "<a id='comment:4'></a>\nFor the log, see http://patchbot.sagemath.org/log/0/Ubuntu/15.10/x86_64/3.13.0-43-generic/62744a2b1a07/2016-03-28%2022:18:21\n\nending with\n\n```\n    [549 tests, 5.12 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/dev/sagedev.py  # 2 doctests failed\nsage -t --long src/sage/tests/cmdline.py  # 2 doctests failed\n----------------------------------------------------------------------\n```\nI think I have seen these failures before, but where ?",
    "created_at": "2016-03-30T07:53:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371649",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:4'></a>
For the log, see http://patchbot.sagemath.org/log/0/Ubuntu/15.10/x86_64/3.13.0-43-generic/62744a2b1a07/2016-03-28%2022:18:21

ending with

```
    [549 tests, 5.12 s]
----------------------------------------------------------------------
sage -t --long src/sage/dev/sagedev.py  # 2 doctests failed
sage -t --long src/sage/tests/cmdline.py  # 2 doctests failed
----------------------------------------------------------------------
```
I think I have seen these failures before, but where ?



---

archive/issue_comments_371650.json:
```json
{
    "body": "<a id='comment:5'></a>\n@nthiery, do these tests pass in the same docker but not using the bot ?\n\nWild guess, it could be due to multithreading ?\n\n```\nDoctesting entire Sage library.\nSorting sources by runtime so that slower doctests are run first....\nDoctesting 3390 files using 3 threads.\n```",
    "created_at": "2016-03-30T08:09:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371650",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:5'></a>
@nthiery, do these tests pass in the same docker but not using the bot ?

Wild guess, it could be due to multithreading ?

```
Doctesting entire Sage library.
Sorting sources by runtime so that slower doctests are run first....
Doctesting 3390 files using 3 threads.
```



---

archive/issue_comments_371651.json:
```json
{
    "body": "<a id='comment:6'></a>\nHi!\n\nThose are indeed the only tests failing.\n\nThe sagedev tests are not failing when run inside the bot but outside of the container.\n\nThe cmdline test is also failing outside of the bot, but that's now analyzed and should be an easy fix\n(https://github.com/sagemath/docker-images/issues/11).\n\nNo idea about the potential influence of multithreading.\n\nFor the sake of completeness, I just started a new sagemath/sagemath-develop docker image, installed the patchbot, and ran the sagedev tests with:\n\n```\n    sage -tp 3 src/sage/dev/\n```\n\nThey passed smoothly. The failing tests only appear when running:\n\n```\n    sage -patchbot --count=0\n```\n\nCheers,\n                              Nicolas",
    "created_at": "2016-03-30T12:13:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371651",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:6'></a>
Hi!

Those are indeed the only tests failing.

The sagedev tests are not failing when run inside the bot but outside of the container.

The cmdline test is also failing outside of the bot, but that's now analyzed and should be an easy fix
(https://github.com/sagemath/docker-images/issues/11).

No idea about the potential influence of multithreading.

For the sake of completeness, I just started a new sagemath/sagemath-develop docker image, installed the patchbot, and ran the sagedev tests with:

```
    sage -tp 3 src/sage/dev/
```

They passed smoothly. The failing tests only appear when running:

```
    sage -patchbot --count=0
```

Cheers,
                              Nicolas



---

archive/issue_comments_371652.json:
```json
{
    "body": "<a id='comment:7'></a>\nHere is a previous discussion on the very same problem in may 2015:\n\nhttps://groups.google.com/d/topic/sage-devel/NzS6MKnXbMQ/discussion",
    "created_at": "2016-04-01T19:45:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371652",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:7'></a>
Here is a previous discussion on the very same problem in may 2015:

https://groups.google.com/d/topic/sage-devel/NzS6MKnXbMQ/discussion



---

archive/issue_comments_371653.json:
```json
{
    "body": "<a id='comment:8'></a>\nCould some of you please launch your docker/VM patchbots on #14974 and report the results ?\n\nI have included in the branch there some more tests in the sagedev scripts, hoping that\nthis could shed some light on the problem.",
    "created_at": "2016-04-02T08:15:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371653",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:8'></a>
Could some of you please launch your docker/VM patchbots on #14974 and report the results ?

I have included in the branch there some more tests in the sagedev scripts, hoping that
this could shed some light on the problem.



---

archive/issue_comments_371654.json:
```json
{
    "body": "<a id='comment:9'></a>\nI'll see if I can work on this, just as soon as I reproduce it.",
    "created_at": "2016-04-02T21:02:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371654",
    "user": "https://github.com/embray"
}
```

<a id='comment:9'></a>
I'll see if I can work on this, just as soon as I reproduce it.



---

archive/issue_comments_371655.json:
```json
{
    "body": "<a id='comment:10'></a>\nHi, started the patchbot in one of my VM's, and got some doctest failures, see http://patchbot.sagemath.org/log/0/debian/8.3/i686/3.16.0-4-586/tmonteil-debian-jessie-32/2016-04-03%2001:14:53?short so i could not pass ticket 0.",
    "created_at": "2016-04-03T08:52:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371655",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:10'></a>
Hi, started the patchbot in one of my VM's, and got some doctest failures, see http://patchbot.sagemath.org/log/0/debian/8.3/i686/3.16.0-4-586/tmonteil-debian-jessie-32/2016-04-03%2001:14:53?short so i could not pass ticket 0.



---

archive/issue_comments_371656.json:
```json
{
    "body": "<a id='comment:11'></a>\nAfter a closer look:\n- some failures are due to some locale issue (i could probably fix that within the VM, let me check again)\n- some failure are due to the fact that i installed some optional packages, whose doctests are broken and nobody notice it (can be fixed as well).\n- there is still a failure for `sagedev.py` which always existed and prevented me to run the patchbot from within a VM (i still have no idea on how to fix it)",
    "created_at": "2016-04-03T09:10:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371656",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:11'></a>
After a closer look:
- some failures are due to some locale issue (i could probably fix that within the VM, let me check again)
- some failure are due to the fact that i installed some optional packages, whose doctests are broken and nobody notice it (can be fixed as well).
- there is still a failure for `sagedev.py` which always existed and prevented me to run the patchbot from within a VM (i still have no idea on how to fix it)



---

archive/issue_comments_371657.json:
```json
{
    "body": "<a id='comment:12'></a>\nhello Thierry,\n\ncould you please run\n\n```\nsage -patchbot --skip-base --ticket=14974\n```\nto help me debug this sagedev issue ?\n\nEDIT: maybe you need to add the \"author\" of this ticket to your trust list temporarily. Otherwise, you can run the patchbot inside an ipython session\nas explained at the bottom of https://wiki.sagemath.org/buildbot/details",
    "created_at": "2016-04-03T09:17:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371657",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:12'></a>
hello Thierry,

could you please run

```
sage -patchbot --skip-base --ticket=14974
```
to help me debug this sagedev issue ?

EDIT: maybe you need to add the "author" of this ticket to your trust list temporarily. Otherwise, you can run the patchbot inside an ipython session
as explained at the bottom of https://wiki.sagemath.org/buildbot/details



---

archive/issue_comments_371658.json:
```json
{
    "body": "<a id='comment:13'></a>\nIt seems i could fix the locale issue. I just launched the patchbot for ticket #14974 so that you can learn more.",
    "created_at": "2016-04-03T17:29:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371658",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:13'></a>
It seems i could fix the locale issue. I just launched the patchbot for ticket #14974 so that you can learn more.



---

archive/issue_comments_371659.json:
```json
{
    "body": "<a id='comment:14'></a>\nI did \n\n```\n./sage -patchbot --skip-base --ticket=14974\n```\n\nbut it still tested ticket 0, see http://patchbot.sagemath.org/ticket/0/",
    "created_at": "2016-04-03T21:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371659",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:14'></a>
I did 

```
./sage -patchbot --skip-base --ticket=14974
```

but it still tested ticket 0, see http://patchbot.sagemath.org/ticket/0/



---

archive/issue_comments_371660.json:
```json
{
    "body": "<a id='comment:15'></a>\nI'm having an orthogonal issue when I try to test this issue.\n\nWhen I run `sage -patchbot --count=0` in the docker container to runs the docbuild plugin for patchbot.  It starts building the docs and seems to get a long ways through it and when it gets to:\n\n```\n[tensor   ] building [html]: targets for 4 source files that are out of date\n[tensor   ] preparing documents... done\n[tensor   ] writing output... [ 25%] index\n[history_a] building [html]: targets for 1 source files that are out of date\n[history_a] preparing documents... done\n[history_a] writing output... [100%] index\n[tensor   ] writing output... [ 50%] sage/tensor/coordinate_patch\n[tensor   ] writing output... [ 75%] sage/tensor/differential_form_element\n[history_a] writing additional files... genindex search\n[history_a] linking _static directory.\n[history_a] copying extra files... done\n[history_a] dumping search index... done\n[history_a] dumping object inventory... done\n[history_a] build succeeded.\nBuild finished.  The built documents can be found in /opt/sage/local/share/doc/sage/html/en/reference/histor\n[tensor   ] writing output... [100%] sage/tensor/differential_forms\n[tensor   ] writing additional files... genindex py-modindex search\n[tensor   ] linking _static directory.\n[tensor   ] copying extra files... done\n[tensor   ] dumping search index... done\n[tensor   ] dumping object inventory... done\n[tensor   ] build succeeded.\nBuild finished.  The built documents can be found in /opt/sage/local/share/doc/sage/html/en/reference/tensor\n```\n\nit seems to just hang, with no output, for a very long time.  Is it waiting on something else that's running in parallel?  I can't seem to get past this. (I could disable the docbuild plugin, but it's still a problem)",
    "created_at": "2016-04-04T11:18:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371660",
    "user": "https://github.com/embray"
}
```

<a id='comment:15'></a>
I'm having an orthogonal issue when I try to test this issue.

When I run `sage -patchbot --count=0` in the docker container to runs the docbuild plugin for patchbot.  It starts building the docs and seems to get a long ways through it and when it gets to:

```
[tensor   ] building [html]: targets for 4 source files that are out of date
[tensor   ] preparing documents... done
[tensor   ] writing output... [ 25%] index
[history_a] building [html]: targets for 1 source files that are out of date
[history_a] preparing documents... done
[history_a] writing output... [100%] index
[tensor   ] writing output... [ 50%] sage/tensor/coordinate_patch
[tensor   ] writing output... [ 75%] sage/tensor/differential_form_element
[history_a] writing additional files... genindex search
[history_a] linking _static directory.
[history_a] copying extra files... done
[history_a] dumping search index... done
[history_a] dumping object inventory... done
[history_a] build succeeded.
Build finished.  The built documents can be found in /opt/sage/local/share/doc/sage/html/en/reference/histor
[tensor   ] writing output... [100%] sage/tensor/differential_forms
[tensor   ] writing additional files... genindex py-modindex search
[tensor   ] linking _static directory.
[tensor   ] copying extra files... done
[tensor   ] dumping search index... done
[tensor   ] dumping object inventory... done
[tensor   ] build succeeded.
Build finished.  The built documents can be found in /opt/sage/local/share/doc/sage/html/en/reference/tensor
```

it seems to just hang, with no output, for a very long time.  Is it waiting on something else that's running in parallel?  I can't seem to get past this. (I could disable the docbuild plugin, but it's still a problem)



---

archive/issue_comments_371661.json:
```json
{
    "body": "<a id='comment:16'></a>\nRelatedly, the output of ps at this point:\n\n```\nUSER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nsage         1  0.0  0.0  18224     4 ?        Ss   Apr03   0:00 /bin/bash\nsage     20301  0.0  0.0  65476     8 ?        S+   10:43   0:00 python /opt/sage/local/bin/patchbot/patchbot.py --count=0\nsage     20410  0.0  0.0   4376    28 ?        S+   10:43   0:00 tee /opt/sage/logs/patchbot/0-log.txt\nsage     28733  0.0  0.2  51264  2284 ?        S+   10:45   0:00 python /opt/sage/src/bin/sage-cleaner\nsage     30490  0.0  0.0   4476     0 ?        S+   10:46   0:00 sh -c make -j3 doc\nsage     30491  0.0  0.0   7392     4 ?        S+   10:46   0:00 make -j3 doc\nsage     30494  0.0  0.0   4476     0 ?        S+   10:46   0:00 /bin/sh -c build/bin/sage-logger \\ .\"cd build/make && ./install 'doc'\" logs/install.log\nsage     30495  0.0  0.0   9576     8 ?        S+   10:46   0:00 bash build/bin/sage-logger cd build/make && ./install 'doc' logs/install.log\nsage     30498  0.0  0.0   9576     4 ?        S+   10:46   0:00 bash build/bin/sage-logger cd build/make && ./install 'doc' logs/install.log\nsage     30499  0.0  0.0   9576     4 ?        S+   10:46   0:00 bash build/bin/sage-logger cd build/make && ./install 'doc' logs/install.log\nsage     30500  0.0  0.0   4376    28 ?        S+   10:46   0:00 tee -a logs/install.log\nsage     30501  0.0  0.0   9584     8 ?        S+   10:46   0:00 bash ./install doc\nsage     30546  0.0  0.0   8260     8 ?        S+   10:46   0:00 make doc\nsage     30596  0.0  0.0   9576     0 ?        S+   10:46   0:00 /bin/bash -c cd ../.. && sage-logger './sage --docbuild --no-pdf-links all html ' logs/dochtml.log\nsage     30597  0.0  0.0   9580     8 ?        S+   10:46   0:00 bash /opt/sage/build/bin/sage-logger ./sage --docbuild --no-pdf-links all html  logs/dochtml.log\nsage     30600  0.0  0.0   9580     4 ?        S+   10:46   0:00 bash /opt/sage/build/bin/sage-logger ./sage --docbuild --no-pdf-links all html  logs/dochtml.log\nsage     30601  0.0  0.0   9580     4 ?        S+   10:46   0:00 bash /opt/sage/build/bin/sage-logger ./sage --docbuild --no-pdf-links all html  logs/dochtml.log\nsage     30602  0.0  0.0   4376    32 ?        S+   10:46   0:00 tee -a logs/dochtml.log\nsage     30603  1.1  0.8 2670860 8200 ?        Sl+  10:46   0:25 python -m sage_setup.docbuild --no-pdf-links all html\nsage     30787  0.0  0.9 2670860 9292 ?        S+   11:02   0:00 python -m sage_setup.docbuild --no-pdf-links all html\nsage     30788  0.0  0.9 2670860 9292 ?        S+   11:02   0:00 python -m sage_setup.docbuild --no-pdf-links all html\nsage     30789  0.0  0.3  18220  3220 ?        Ss   11:19   0:00 /bin/bash\nsage     30805  0.0  0.2  15600  2208 ?        R+   11:22   0:00 ps -aux\n```\n\nAll the python and make processes are asleep.  It's not clear what they're waiting on.",
    "created_at": "2016-04-04T11:23:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371661",
    "user": "https://github.com/embray"
}
```

<a id='comment:16'></a>
Relatedly, the output of ps at this point:

```
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
sage         1  0.0  0.0  18224     4 ?        Ss   Apr03   0:00 /bin/bash
sage     20301  0.0  0.0  65476     8 ?        S+   10:43   0:00 python /opt/sage/local/bin/patchbot/patchbot.py --count=0
sage     20410  0.0  0.0   4376    28 ?        S+   10:43   0:00 tee /opt/sage/logs/patchbot/0-log.txt
sage     28733  0.0  0.2  51264  2284 ?        S+   10:45   0:00 python /opt/sage/src/bin/sage-cleaner
sage     30490  0.0  0.0   4476     0 ?        S+   10:46   0:00 sh -c make -j3 doc
sage     30491  0.0  0.0   7392     4 ?        S+   10:46   0:00 make -j3 doc
sage     30494  0.0  0.0   4476     0 ?        S+   10:46   0:00 /bin/sh -c build/bin/sage-logger \ ."cd build/make && ./install 'doc'" logs/install.log
sage     30495  0.0  0.0   9576     8 ?        S+   10:46   0:00 bash build/bin/sage-logger cd build/make && ./install 'doc' logs/install.log
sage     30498  0.0  0.0   9576     4 ?        S+   10:46   0:00 bash build/bin/sage-logger cd build/make && ./install 'doc' logs/install.log
sage     30499  0.0  0.0   9576     4 ?        S+   10:46   0:00 bash build/bin/sage-logger cd build/make && ./install 'doc' logs/install.log
sage     30500  0.0  0.0   4376    28 ?        S+   10:46   0:00 tee -a logs/install.log
sage     30501  0.0  0.0   9584     8 ?        S+   10:46   0:00 bash ./install doc
sage     30546  0.0  0.0   8260     8 ?        S+   10:46   0:00 make doc
sage     30596  0.0  0.0   9576     0 ?        S+   10:46   0:00 /bin/bash -c cd ../.. && sage-logger './sage --docbuild --no-pdf-links all html ' logs/dochtml.log
sage     30597  0.0  0.0   9580     8 ?        S+   10:46   0:00 bash /opt/sage/build/bin/sage-logger ./sage --docbuild --no-pdf-links all html  logs/dochtml.log
sage     30600  0.0  0.0   9580     4 ?        S+   10:46   0:00 bash /opt/sage/build/bin/sage-logger ./sage --docbuild --no-pdf-links all html  logs/dochtml.log
sage     30601  0.0  0.0   9580     4 ?        S+   10:46   0:00 bash /opt/sage/build/bin/sage-logger ./sage --docbuild --no-pdf-links all html  logs/dochtml.log
sage     30602  0.0  0.0   4376    32 ?        S+   10:46   0:00 tee -a logs/dochtml.log
sage     30603  1.1  0.8 2670860 8200 ?        Sl+  10:46   0:25 python -m sage_setup.docbuild --no-pdf-links all html
sage     30787  0.0  0.9 2670860 9292 ?        S+   11:02   0:00 python -m sage_setup.docbuild --no-pdf-links all html
sage     30788  0.0  0.9 2670860 9292 ?        S+   11:02   0:00 python -m sage_setup.docbuild --no-pdf-links all html
sage     30789  0.0  0.3  18220  3220 ?        Ss   11:19   0:00 /bin/bash
sage     30805  0.0  0.2  15600  2208 ?        R+   11:22   0:00 ps -aux
```

All the python and make processes are asleep.  It's not clear what they're waiting on.



---

archive/issue_comments_371662.json:
```json
{
    "body": "<a id='comment:17'></a>\nI am not available right now for work on the patchbot. It should be easy to\ndisactivate the utf8 banner, I will take care of that later, when I am back home.",
    "created_at": "2016-04-04T19:05:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371662",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:17'></a>
I am not available right now for work on the patchbot. It should be easy to
disactivate the utf8 banner, I will take care of that later, when I am back home.



---

archive/issue_comments_371663.json:
```json
{
    "body": "<a id='comment:18'></a>\nWell, after long struggling with getting a usable setup, I can at least confirm one thing, which is that the original issue has nothing to do with running the tests in parallel. Even after setting parallelism: 1 in the patchbot config this failure occurs.\n\nIn fact, even after hand-patching the patchbot to run the tests in only sage/dev/sagedev.py and nothing else, the test still fails, even though when I run it directly, instead of through the patchbot, it passes.",
    "created_at": "2016-04-04T22:11:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371663",
    "user": "https://github.com/embray"
}
```

<a id='comment:18'></a>
Well, after long struggling with getting a usable setup, I can at least confirm one thing, which is that the original issue has nothing to do with running the tests in parallel. Even after setting parallelism: 1 in the patchbot config this failure occurs.

In fact, even after hand-patching the patchbot to run the tests in only sage/dev/sagedev.py and nothing else, the test still fails, even though when I run it directly, instead of through the patchbot, it passes.



---

archive/issue_comments_371664.json:
```json
{
    "body": "<a id='comment:19'></a>\nWell this is interesting--somehow it's one or more of the `GIT_` environment variables set by the patchbot that's breaking it.  These include:\n\n```\n 'GIT_AUTHOR_DATE': '1970-01-01T00:00:00',\n 'GIT_AUTHOR_EMAIL': 'patchbot@localhost',\n 'GIT_AUTHOR_NAME': 'patchbot',\n 'GIT_COMMITTER_DATE': '1970-01-01T00:00:00',\n 'GIT_COMMITTER_EMAIL': 'patchbot@localhost',\n 'GIT_COMMITTER_NAME': 'patchbot',\n```\n\nIf I hack in something to delete those variables just before the patchbot runs the test it passes.",
    "created_at": "2016-04-04T22:33:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371664",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'></a>
Well this is interesting--somehow it's one or more of the `GIT_` environment variables set by the patchbot that's breaking it.  These include:

```
 'GIT_AUTHOR_DATE': '1970-01-01T00:00:00',
 'GIT_AUTHOR_EMAIL': 'patchbot@localhost',
 'GIT_AUTHOR_NAME': 'patchbot',
 'GIT_COMMITTER_DATE': '1970-01-01T00:00:00',
 'GIT_COMMITTER_EMAIL': 'patchbot@localhost',
 'GIT_COMMITTER_NAME': 'patchbot',
```

If I hack in something to delete those variables just before the patchbot runs the test it passes.



---

archive/issue_comments_371665.json:
```json
{
    "body": "<a id='comment:20'></a>\nFWIW: http://permalink.gmane.org/gmane.comp.version-control.git/290775\n\nStill complete mystery as to why this wasn't seen before on the patchbot until running it in the docker container?  AFAICT this issue in git is very old.",
    "created_at": "2016-04-05T11:32:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371665",
    "user": "https://github.com/embray"
}
```

<a id='comment:20'></a>
FWIW: http://permalink.gmane.org/gmane.comp.version-control.git/290775

Still complete mystery as to why this wasn't seen before on the patchbot until running it in the docker container?  AFAICT this issue in git is very old.



---

archive/issue_comments_371666.json:
```json
{
    "body": "<a id='comment:21'></a>\nHow should I change the `GIT` environnement variables, so that the failing doctest\ndisappear ?\n\n(so that we do no have to wait until git behaviour is corrected)",
    "created_at": "2016-04-06T19:31:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371666",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:21'></a>
How should I change the `GIT` environnement variables, so that the failing doctest
disappear ?

(so that we do no have to wait until git behaviour is corrected)



---

archive/issue_comments_371667.json:
```json
{
    "body": "<a id='comment:22'></a>\nJust the `GIT_COMMITTER_DATE` needs to be changed I think. If its value is increased by one second then it should work around the problem.",
    "created_at": "2016-04-07T08:44:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371667",
    "user": "https://github.com/embray"
}
```

<a id='comment:22'></a>
Just the `GIT_COMMITTER_DATE` needs to be changed I think. If its value is increased by one second then it should work around the problem.



---

archive/issue_comments_371668.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"days77\".",
    "created_at": "2016-04-07T09:49:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371668",
    "user": "https://github.com/slel"
}
```

**Changing keywords** from "" to "days77".



---

archive/issue_comments_371669.json:
```json
{
    "body": "<a id='comment:24'></a>\nI have changed that in patchbot 2.5.5, that needs review at #20313",
    "created_at": "2016-04-07T20:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371669",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:24'></a>
I have changed that in patchbot 2.5.5, that needs review at #20313



---

archive/issue_comments_371670.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2016-04-08T16:31:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371670",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_371671.json:
```json
{
    "body": "**Reviewer:** Erik Bray, Thierry Monteil",
    "created_at": "2016-04-08T16:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371671",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

**Reviewer:** Erik Bray, Thierry Monteil



---

archive/issue_comments_371672.json:
```json
{
    "body": "<a id='comment:26'></a>\nFixed by #20313 !",
    "created_at": "2016-04-08T16:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371672",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:26'></a>
Fixed by #20313 !



---

archive/issue_comments_371673.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2016-04-08T16:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371673",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_371674.json:
```json
{
    "body": "**Author:** Fr\u00e9d\u00e9ric Chapoton",
    "created_at": "2016-04-08T16:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371674",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

**Author:** Frédéric Chapoton



---

archive/issue_events_062695.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-04-08T16:58:42Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20319#event-62695"
}
```



---

archive/issue_events_062696.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-06-12T12:02:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20319#event-62696"
}
```



---

archive/issue_comments_371675.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2016-06-12T12:02:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20319",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20319#issuecomment-371675",
    "user": "https://github.com/vbraun"
}
```

**Resolution:** fixed
