# Issue 20755: Bug in solve due to a bug in symbolic_expression_from_maxima_string

archive/issues_020518.json:
```json
{
    "body": "A bug in `sage.calculus.calculus.symbolic_expression_from_maxima_string` implies bugs in `solve` and `roots` for symbolic expressions.\n\n### Symptoms\n\nThe method `solve` for symbolic expressions is buggy (the list of multiplicities has size 2 instead of 4), as well as `roots` as a (serious!) consequence:\n\n```python\nsage: w = x^4 - (1+3*i)*x^3 - (2-4*i)*x^2 + (6-2*i)*x - 4 - 4*i\nsage: w.solve(x,multiplicities=True)\n([x == -1/2*sqrt(2*I) + 3/2*I - 1/2, x == 1/2*sqrt(2*I) + 3/2*I - 1/2, x == (-I + 1), x == (I + 1)],\n [1, 1])\nsage: w.roots() # should be 4 roots\n[(-1/2*sqrt(2*I) + 3/2*I - 1/2, 1), (1/2*sqrt(2*I) + 3/2*I - 1/2, 1)]\n```\n\n### Diagnosis\n\n1. The behavior of `roots` is easily explained by the behavior of `solve`, since `roots` assume that the length of the list of solutions is the same as the length of the list of multiplicities. This should clearly be the case so the bug is not in `roots`.\n\n2. Given the parameter in the example, `solve` calls Maxima and parses the result. The multiplicities are obtained by invoking `P.get('multiplicities')`. This is the right invocation to Maxima, no bug there.\n\n3. To parse the solutions returned by Maxima, `solve` calls `sage.symbolic.relation.string_to_list_of_solutions`, which itself calls `sage.calculus.symbolic_expression_from_maxima_string`. The bug occurs in this last function: Indeed, while there is no apparent reason for this, invoking this function changes the variable `multiplicities` of Maxima. Here is an example:\n\n   ```python\n   sage: w = x^4 - (1+3*i)*x^3 - (2-4*i)*x^2 + (6-2*i)*x - 4 - 4*i\n   sage: m = (w == 0)._maxima_()\n   sage: P = m.parent()\n   sage: s = m.solve(x).str()\n   sage: s # the list of solutions returned by Maxima\n   '[_SAGE_VAR_x=-(sqrt(2*%i)-3*%i+1)/2,_SAGE_VAR_x=(sqrt(2*%i)+3*%i-1)/2,_SAGE_VAR_x=1-%i,_SAGE_VAR_x=%i+1]'\n   sage: P.get('multiplicities') # correct!\n   '[1,1,1,1]'\n   sage: l = sage.calculus.calculus.symbolic_expression_from_maxima_string(s)\n   sage: l\n   [x == -1/2*sqrt(2*I) + 3/2*I - 1/2,\n    x == 1/2*sqrt(2*I) + 3/2*I - 1/2,\n    x == (-I + 1),\n    x == (I + 1)]\n   sage: P.get('multiplicities') # WTF???\n   '[1,1]'\n```\n\n**Keywords:** maxima, solve\n\n**Branch/Commit:** [eb0ad68ae007807828945e13e58e9865c67adf77](https://github.com/sagemath/sagetrac-mirror/commit/eb0ad68ae007807828945e13e58e9865c67adf77)\n\n**Reviewer:** Vincent Delecroix\n\n**Author:** Bruno Grenet\n\n**Resolution:** fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20755\n\n",
    "closed_at": "2019-08-29T20:02:19Z",
    "created_at": "2016-06-01T17:22:16Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "Bug in solve due to a bug in symbolic_expression_from_maxima_string",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20755",
    "user": "https://github.com/bgrenet"
}
```
A bug in `sage.calculus.calculus.symbolic_expression_from_maxima_string` implies bugs in `solve` and `roots` for symbolic expressions.

### Symptoms

The method `solve` for symbolic expressions is buggy (the list of multiplicities has size 2 instead of 4), as well as `roots` as a (serious!) consequence:

```python
sage: w = x^4 - (1+3*i)*x^3 - (2-4*i)*x^2 + (6-2*i)*x - 4 - 4*i
sage: w.solve(x,multiplicities=True)
([x == -1/2*sqrt(2*I) + 3/2*I - 1/2, x == 1/2*sqrt(2*I) + 3/2*I - 1/2, x == (-I + 1), x == (I + 1)],
 [1, 1])
sage: w.roots() # should be 4 roots
[(-1/2*sqrt(2*I) + 3/2*I - 1/2, 1), (1/2*sqrt(2*I) + 3/2*I - 1/2, 1)]
```

### Diagnosis

1. The behavior of `roots` is easily explained by the behavior of `solve`, since `roots` assume that the length of the list of solutions is the same as the length of the list of multiplicities. This should clearly be the case so the bug is not in `roots`.

2. Given the parameter in the example, `solve` calls Maxima and parses the result. The multiplicities are obtained by invoking `P.get('multiplicities')`. This is the right invocation to Maxima, no bug there.

3. To parse the solutions returned by Maxima, `solve` calls `sage.symbolic.relation.string_to_list_of_solutions`, which itself calls `sage.calculus.symbolic_expression_from_maxima_string`. The bug occurs in this last function: Indeed, while there is no apparent reason for this, invoking this function changes the variable `multiplicities` of Maxima. Here is an example:

   ```python
   sage: w = x^4 - (1+3*i)*x^3 - (2-4*i)*x^2 + (6-2*i)*x - 4 - 4*i
   sage: m = (w == 0)._maxima_()
   sage: P = m.parent()
   sage: s = m.solve(x).str()
   sage: s # the list of solutions returned by Maxima
   '[_SAGE_VAR_x=-(sqrt(2*%i)-3*%i+1)/2,_SAGE_VAR_x=(sqrt(2*%i)+3*%i-1)/2,_SAGE_VAR_x=1-%i,_SAGE_VAR_x=%i+1]'
   sage: P.get('multiplicities') # correct!
   '[1,1,1,1]'
   sage: l = sage.calculus.calculus.symbolic_expression_from_maxima_string(s)
   sage: l
   [x == -1/2*sqrt(2*I) + 3/2*I - 1/2,
    x == 1/2*sqrt(2*I) + 3/2*I - 1/2,
    x == (-I + 1),
    x == (I + 1)]
   sage: P.get('multiplicities') # WTF???
   '[1,1]'
```

**Keywords:** maxima, solve

**Branch/Commit:** [eb0ad68ae007807828945e13e58e9865c67adf77](https://github.com/sagemath/sagetrac-mirror/commit/eb0ad68ae007807828945e13e58e9865c67adf77)

**Reviewer:** Vincent Delecroix

**Author:** Bruno Grenet

**Resolution:** fixed

Issue created by migration from https://trac.sagemath.org/ticket/20755





---

archive/issue_comments_381462.json:
```json
{
    "body": "<a id='comment:2'></a>\nWell, `multiplicities` is a system variable. See [http://maxima.sourceforge.net/docs/manual/maxima_20.html](http://maxima.sourceforge.net/docs/manual/maxima_20.html). Who knows when it gets updated? In particular, the reconstruction of symbolic expressions from strings might be calling into maxima again.\n\nThe quick fix is to get the correct value of `multiplicities` out as soon as we can, before conversion back.\n\nIn the longer run, it would be preferable to do the conversion while avoiding strings altogether. See `sr_sum` and `sr_limit` etc. for examples how one can use `sr_to_max` and `max_to_sr` to convert.",
    "created_at": "2016-06-01T18:00:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20755#issuecomment-381462",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:2'></a>
Well, `multiplicities` is a system variable. See [http://maxima.sourceforge.net/docs/manual/maxima_20.html](http://maxima.sourceforge.net/docs/manual/maxima_20.html). Who knows when it gets updated? In particular, the reconstruction of symbolic expressions from strings might be calling into maxima again.

The quick fix is to get the correct value of `multiplicities` out as soon as we can, before conversion back.

In the longer run, it would be preferable to do the conversion while avoiding strings altogether. See `sr_sum` and `sr_limit` etc. for examples how one can use `sr_to_max` and `max_to_sr` to convert.



---

archive/issue_events_063398.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2019-07-09T19:20:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20755",
    "milestone": "sage-8.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20755#event-63398"
}
```



---

archive/issue_comments_381463.json:
```json
{
    "body": "<a id='comment:3'></a>\nseems to work in 8.9.b1\n\none needs to check and add a doctest",
    "created_at": "2019-07-09T19:20:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20755#issuecomment-381463",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:3'></a>
seems to work in 8.9.b1

one needs to check and add a doctest



---

archive/issue_comments_381464.json:
```json
{
    "body": "**Commit:** [eb0ad68ae007807828945e13e58e9865c67adf77](https://github.com/sagemath/sagetrac-mirror/commit/eb0ad68ae007807828945e13e58e9865c67adf77)",
    "created_at": "2019-08-21T12:43:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20755#issuecomment-381464",
    "user": "https://github.com/bgrenet"
}
```

**Commit:** [eb0ad68ae007807828945e13e58e9865c67adf77](https://github.com/sagemath/sagetrac-mirror/commit/eb0ad68ae007807828945e13e58e9865c67adf77)



---

archive/issue_comments_381465.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2019-08-21T12:43:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20755#issuecomment-381465",
    "user": "https://github.com/bgrenet"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_381466.json:
```json
{
    "body": "<a id='comment:4'></a>\nThe bug seems indeed fixed. I've add a doctest.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/eb0ad68ae007807828945e13e58e9865c67adf77\">eb0ad68</a></td><td><code>20755: Add doctest</code></td></tr></table>\n",
    "created_at": "2019-08-21T12:43:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20755#issuecomment-381466",
    "user": "https://github.com/bgrenet"
}
```

<a id='comment:4'></a>
The bug seems indeed fixed. I've add a doctest.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/eb0ad68ae007807828945e13e58e9865c67adf77">eb0ad68</a></td><td><code>20755: Add doctest</code></td></tr></table>




---

archive/issue_comments_381467.json:
```json
{
    "body": "**Author:** Bruno Grenet",
    "created_at": "2019-08-21T12:43:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20755#issuecomment-381467",
    "user": "https://github.com/bgrenet"
}
```

**Author:** Bruno Grenet



---

archive/issue_comments_381468.json:
```json
{
    "body": "**Branch:** [u/bruno/20755_bug_in_solve](https://github.com/sagemath/sagetrac-mirror/tree/u/bruno/20755_bug_in_solve)",
    "created_at": "2019-08-21T12:43:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20755#issuecomment-381468",
    "user": "https://github.com/bgrenet"
}
```

**Branch:** [u/bruno/20755_bug_in_solve](https://github.com/sagemath/sagetrac-mirror/tree/u/bruno/20755_bug_in_solve)



---

archive/issue_comments_381469.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2019-08-21T19:36:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20755#issuecomment-381469",
    "user": "https://github.com/videlec"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_381470.json:
```json
{
    "body": "**Reviewer:** Vincent Delecroix",
    "created_at": "2019-08-21T19:36:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20755#issuecomment-381470",
    "user": "https://github.com/videlec"
}
```

**Reviewer:** Vincent Delecroix



---

archive/issue_comments_381471.json:
```json
{
    "body": "**Resolution:** fixed",
    "created_at": "2019-08-29T20:02:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20755#issuecomment-381471",
    "user": "https://github.com/vbraun"
}
```

**Resolution:** fixed



---

archive/issue_events_063399.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-08-29T20:02:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20755",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20755#event-63399"
}
```



---

archive/issue_comments_381472.json:
```json
{
    "body": "**Changing branch** from \"[u/bruno/20755_bug_in_solve](https://github.com/sagemath/sagetrac-mirror/tree/u/bruno/20755_bug_in_solve)\" to \"[eb0ad68ae007807828945e13e58e9865c67adf77](https://github.com/sagemath/sagetrac-mirror/commit/eb0ad68ae007807828945e13e58e9865c67adf77)\".",
    "created_at": "2019-08-29T20:02:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20755",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20755#issuecomment-381472",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/bruno/20755_bug_in_solve](https://github.com/sagemath/sagetrac-mirror/tree/u/bruno/20755_bug_in_solve)" to "[eb0ad68ae007807828945e13e58e9865c67adf77](https://github.com/sagemath/sagetrac-mirror/commit/eb0ad68ae007807828945e13e58e9865c67adf77)".
