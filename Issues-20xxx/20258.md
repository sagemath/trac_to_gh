# Issue 20258: giacpy does not build on 7.1

archive/issues_020021.json:
```json
{
    "body": "Tested on Debian jessie, both 32 and 64 bits, gives the following:\n\nHere is the relevant part of the log:\n\n```\nrunning install\nrunning build\nrunning build_ext\ncythoning giacpy.pyx to giacpy.cpp\nbuilding 'giacpy' extension\ncreating build\ncreating build/temp.linux-x86_64-2.7\ngcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -fPIC -I/opt/sagemath/sage-source/local/include -I/opt/sagemath/sage-source/local/include/python2.7 -I/opt/sagemath/sage-source/local/lib/python2.7/site-packages/numpy/core/include -I/opt/sagemath/sage-source/local/lib/python2.7/site-packages -I/opt/sagemath/sage-source/local/lib/python2.7/site-packages/sage/ext -I/opt/sagemath/sage-source/local/include/python2.7 -c giacpy.cpp -o build/temp.linux-x86_64-2.7/giacpy.o\nIn file included from /opt/sagemath/sage-source/local/include/giac/poly.h:25:0,\n                 from /opt/sagemath/sage-source/local/include/giac/giac.h:5,\n                 from giacpy.cpp:257:\n/opt/sagemath/sage-source/local/include/giac/index.h:33:0: warning: ignoring #pragma anon_unions  [-Wunknown-pragmas]\n #pragma anon_unions\n ^\ngiacpy.cpp:262:28: fatal error: struct_signals.h: No such file or directory\n #include \"struct_signals.h\"\n                            ^\ncompilation terminated.\n```\n\nI add Jeroen in cc since it might be related to changes in cython signals.\n\n\nThis trac will be solved by #19873.\n\n\nCC:  @frederichan-IMJPRG @jdemeyer\n\nKeywords: sdl\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20258\n\n",
    "closed_at": "2016-06-12T12:02:30Z",
    "created_at": "2016-03-23T11:46:19Z",
    "labels": [
        "component: packages: optional",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "giacpy does not build on 7.1",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20258",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```
Tested on Debian jessie, both 32 and 64 bits, gives the following:

Here is the relevant part of the log:

```
running install
running build
running build_ext
cythoning giacpy.pyx to giacpy.cpp
building 'giacpy' extension
creating build
creating build/temp.linux-x86_64-2.7
gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -fPIC -I/opt/sagemath/sage-source/local/include -I/opt/sagemath/sage-source/local/include/python2.7 -I/opt/sagemath/sage-source/local/lib/python2.7/site-packages/numpy/core/include -I/opt/sagemath/sage-source/local/lib/python2.7/site-packages -I/opt/sagemath/sage-source/local/lib/python2.7/site-packages/sage/ext -I/opt/sagemath/sage-source/local/include/python2.7 -c giacpy.cpp -o build/temp.linux-x86_64-2.7/giacpy.o
In file included from /opt/sagemath/sage-source/local/include/giac/poly.h:25:0,
                 from /opt/sagemath/sage-source/local/include/giac/giac.h:5,
                 from giacpy.cpp:257:
/opt/sagemath/sage-source/local/include/giac/index.h:33:0: warning: ignoring #pragma anon_unions  [-Wunknown-pragmas]
 #pragma anon_unions
 ^
giacpy.cpp:262:28: fatal error: struct_signals.h: No such file or directory
 #include "struct_signals.h"
                            ^
compilation terminated.
```

I add Jeroen in cc since it might be related to changes in cython signals.


This trac will be solved by #19873.


CC:  @frederichan-IMJPRG @jdemeyer

Keywords: sdl

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/20258





---

archive/issue_comments_275490.json:
```json
{
    "body": "<a id='comment:1'></a>I believe that this is no longer supported in Cython (at least I don't find it in the Cython documentation):\n\n```\nfrom Cython.Distutils import build_ext\nsetup(...\n    cmdclass={'build_ext': build_ext}\n)\n```\n\nI recommend you to use `cythonize()` instead, see http://docs.cython.org/src/userguide/source_files_and_compilation.html",
    "created_at": "2016-03-23T13:28:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20258#issuecomment-275490",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:1'></a>I believe that this is no longer supported in Cython (at least I don't find it in the Cython documentation):

```
from Cython.Distutils import build_ext
setup(...
    cmdclass={'build_ext': build_ext}
)
```

I recommend you to use `cythonize()` instead, see http://docs.cython.org/src/userguide/source_files_and_compilation.html



---

archive/issue_comments_275491.json:
```json
{
    "body": "<a id='comment:2'></a>Thank you for the report and the suggestion.\nI could reproduce the error with sage 7.1.beta6. So I have tried the following setup.py:\n\n```/usr/bin/env python\n\n\nfrom sage.env import SAGE_LOCAL,SAGE_SRC\nimport os\n\nfrom distutils.core import setup\nfrom distutils.extension import Extension\nfrom Cython.Build import cythonize\n\n\nconf = {'CXXFLAGS' : [], 'LDFLAGS' : []}\n\nlibraries=['giac']\nlibrary_dirs=[SAGE_LOCAL+'/lib']\n# in sage 6.7 cimport Integer needs ccobject.h but it was moved to SAGE_SRC/sage/ext\n# But in sage 6.8>= the function sage_include_directories was introduced to gives the includes.\ntry:\n    # Sage >= 6.8\n    from sage.env import sage_include_directories\nexcept ImportError:\n    # Sage < 6.8\n    def sage_include_directories():\n        return [\n            os.path.join(SAGE_LOCAL, \"include\"),\n            os.path.join(SAGE_LOCAL, \"include\", \"csage\"),\n            os.path.join(SAGE_SRC),\n            os.path.join(SAGE_SRC, \"sage\", \"ext\"),\n            ]\n    # (on sage 6.7 without csage gives undefined symbols _signals)\n    libraries.append('csage')\n###\n\ninclude_dirs=sage_include_directories()\n\next_modules=[]\n\next_modules+=cythonize([Extension(\n                   \"giacpy\",                 # name of extension\n                   [\"giacpy.pyx\"], #  our Cython source\n                   libraries=libraries,\n                   library_dirs=library_dirs,\n                   include_dirs=include_dirs,\n                   extra_compile_args=conf[\"CXXFLAGS\"],\n                   extra_link_args=conf[\"LDFLAGS\"],\n                   language=\"c++\")])\n#cmdclass={'build_ext': build_ext}\n    \n\n\nsetup(\n\n\n    name='giacpy',\n    version='0.5.2',\n    description='A Cython frontend to the c++ library giac. (Computer Algebra System)',\n    author='Frederic Han',\n    author_email=\"frederic.han@imj-prg.fr\",\n    url='http://webusers.imj-prg.fr/~frederic.han/xcas/giacpy/',\n    long_description=open('README.txt').read(),\n    license='GPLv2 or above',\n    ext_modules=ext_modules\n    )\n\n```\n\nI can build giacpy on sage 7.1.beta6, but now older version of sage can't because:\n\n```\n File \"/usr/local/sage-6.9-x86_64-Linux/local/lib/python2.7/site-packages/Cython-0.23.1-py2.7-linux-x86_64.egg/Cython/Compiler/Errors.py\", line 177, in error\n    raise InternalError(message)\nCython.Compiler.Errors.InternalError: Internal compiler error: 'sage/ext/interrupt.pxi' not found\n```",
    "created_at": "2016-03-23T21:44:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20258#issuecomment-275491",
    "user": "https://github.com/frederichan-IMJPRG"
}
```

<a id='comment:2'></a>Thank you for the report and the suggestion.
I could reproduce the error with sage 7.1.beta6. So I have tried the following setup.py:

```/usr/bin/env python


from sage.env import SAGE_LOCAL,SAGE_SRC
import os

from distutils.core import setup
from distutils.extension import Extension
from Cython.Build import cythonize


conf = {'CXXFLAGS' : [], 'LDFLAGS' : []}

libraries=['giac']
library_dirs=[SAGE_LOCAL+'/lib']
# in sage 6.7 cimport Integer needs ccobject.h but it was moved to SAGE_SRC/sage/ext
# But in sage 6.8>= the function sage_include_directories was introduced to gives the includes.
try:
    # Sage >= 6.8
    from sage.env import sage_include_directories
except ImportError:
    # Sage < 6.8
    def sage_include_directories():
        return [
            os.path.join(SAGE_LOCAL, "include"),
            os.path.join(SAGE_LOCAL, "include", "csage"),
            os.path.join(SAGE_SRC),
            os.path.join(SAGE_SRC, "sage", "ext"),
            ]
    # (on sage 6.7 without csage gives undefined symbols _signals)
    libraries.append('csage')
###

include_dirs=sage_include_directories()

ext_modules=[]

ext_modules+=cythonize([Extension(
                   "giacpy",                 # name of extension
                   ["giacpy.pyx"], #  our Cython source
                   libraries=libraries,
                   library_dirs=library_dirs,
                   include_dirs=include_dirs,
                   extra_compile_args=conf["CXXFLAGS"],
                   extra_link_args=conf["LDFLAGS"],
                   language="c++")])
#cmdclass={'build_ext': build_ext}
    


setup(


    name='giacpy',
    version='0.5.2',
    description='A Cython frontend to the c++ library giac. (Computer Algebra System)',
    author='Frederic Han',
    author_email="frederic.han@imj-prg.fr",
    url='http://webusers.imj-prg.fr/~frederic.han/xcas/giacpy/',
    long_description=open('README.txt').read(),
    license='GPLv2 or above',
    ext_modules=ext_modules
    )

```

I can build giacpy on sage 7.1.beta6, but now older version of sage can't because:

```
 File "/usr/local/sage-6.9-x86_64-Linux/local/lib/python2.7/site-packages/Cython-0.23.1-py2.7-linux-x86_64.egg/Cython/Compiler/Errors.py", line 177, in error
    raise InternalError(message)
Cython.Compiler.Errors.InternalError: Internal compiler error: 'sage/ext/interrupt.pxi' not found
```



---

archive/issue_comments_275492.json:
```json
{
    "body": "<a id='comment:3'></a>Is it really a problem that older versions do not work?\n\nAnyway, check if you're doing something different with Cython's `include_path`.",
    "created_at": "2016-03-24T08:26:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20258#issuecomment-275492",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>Is it really a problem that older versions do not work?

Anyway, check if you're doing something different with Cython's `include_path`.



---

archive/issue_comments_275493.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-04-04T11:41:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20258#issuecomment-275493",
    "user": "https://github.com/frederichan-IMJPRG"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_275494.json:
```json
{
    "body": "<a id='comment:5'></a>This is now solved by #19873.",
    "created_at": "2016-04-04T11:41:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20258#issuecomment-275494",
    "user": "https://github.com/frederichan-IMJPRG"
}
```

<a id='comment:5'></a>This is now solved by #19873.



---

archive/issue_comments_275495.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-04-05T17:15:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20258#issuecomment-275495",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_055005.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2016-04-05T17:15:39Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20258",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20258#event-55005"
}
```



---

archive/issue_comments_275496.json:
```json
{
    "body": "<a id='comment:7'></a>I am getting this error when i try to install giacpy:\n\n```\nsage-logger 'sage-spkg  giacpy-0.5.5' '/home/mmarco/sage/logs/pkgs/giacpy-0.5.5.log'\nFound local metadata for giacpy-0.5.5\nUsing cached file /home/mmarco/sage/upstream/giacpy-0.5.5.tar.gz\ngiacpy-0.5.5\n====================================================\nSetting up build directory for giacpy-0.5.5\nFinished set up\n****************************************************\nHost system:\nLinux neumann 4.1.15-gentoo-r1 #1 SMP PREEMPT Wed Jan 27 20:58:07 CET 2016 x86_64 Intel(R) Core(TM) i7 CPU 950 @ 3.07GHz GenuineIntel GNU/Linux\n****************************************************\nC compiler: gcc\nC compiler version:\nUsing built-in specs.\nCOLLECT_GCC=gcc\nCOLLECT_LTO_WRAPPER=/home/mmarco/sage/local/libexec/gcc/x86_64-unknown-linux-gnu/4.9.3/lto-wrapper\nTarget: x86_64-unknown-linux-gnu\nConfigured with: ../src/configure --prefix=/home/mmarco/sage/local --with-local-prefix=/home/mmarco/sage/local --with-gmp=/home/mmarco/sage/local --with-mpfr=/home/mmarco/sage/local --with-mpc=/home/mmarco/sage/local --with-system-zlib --disable-multilib --disable-nls --enable-languages=c,c++,fortran --disable-libitm  \nThread model: posix\ngcc version 4.9.3 (GCC) \n****************************************************\nDeleting /home/mmarco/sage/local/lib/python/site-packages/giacpy*\n\nError compiling Cython file:\n------------------------------------------------------------\n...\n     g=(g*M+gen(<long long>i))\n     a=a-(i<<size)\n\n   g=g*gen(<long long>(1<<size))+gen(<long long> a)\n   if aneg:\n     g=-g\n      ^\n------------------------------------------------------------\n\ngiacpy.pyx:5112:7: Invalid operand type for '-' (gen)\nCompiling giacpy.pyx because it changed.\n[1/1] Cythonizing giacpy.pyx\nTraceback (most recent call last):\n  File \"setup.py\", line 47, in <module>\n    language=\"c++\")], include_path=include_path\n  File \"/home/mmarco/sage/local/lib/python2.7/site-packages/Cython-0.24-py2.7-linux-x86_64.egg/Cython/Build/Dependencies.py\", line 912, in cythonize\n    cythonize_one(*args)\n  File \"/home/mmarco/sage/local/lib/python2.7/site-packages/Cython-0.24-py2.7-linux-x86_64.egg/Cython/Build/Dependencies.py\", line 1034, in cythonize_one\n    raise CompileError(None, pyx_file)\nCython.Compiler.Errors.CompileError: giacpy.pyx\n\nreal    0m3.364s\nuser    0m3.251s\nsys     0m0.131s\n\n```",
    "created_at": "2016-05-07T11:21:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20258#issuecomment-275496",
    "user": "https://github.com/miguelmarco"
}
```

<a id='comment:7'></a>I am getting this error when i try to install giacpy:

```
sage-logger 'sage-spkg  giacpy-0.5.5' '/home/mmarco/sage/logs/pkgs/giacpy-0.5.5.log'
Found local metadata for giacpy-0.5.5
Using cached file /home/mmarco/sage/upstream/giacpy-0.5.5.tar.gz
giacpy-0.5.5
====================================================
Setting up build directory for giacpy-0.5.5
Finished set up
****************************************************
Host system:
Linux neumann 4.1.15-gentoo-r1 #1 SMP PREEMPT Wed Jan 27 20:58:07 CET 2016 x86_64 Intel(R) Core(TM) i7 CPU 950 @ 3.07GHz GenuineIntel GNU/Linux
****************************************************
C compiler: gcc
C compiler version:
Using built-in specs.
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/home/mmarco/sage/local/libexec/gcc/x86_64-unknown-linux-gnu/4.9.3/lto-wrapper
Target: x86_64-unknown-linux-gnu
Configured with: ../src/configure --prefix=/home/mmarco/sage/local --with-local-prefix=/home/mmarco/sage/local --with-gmp=/home/mmarco/sage/local --with-mpfr=/home/mmarco/sage/local --with-mpc=/home/mmarco/sage/local --with-system-zlib --disable-multilib --disable-nls --enable-languages=c,c++,fortran --disable-libitm  
Thread model: posix
gcc version 4.9.3 (GCC) 
****************************************************
Deleting /home/mmarco/sage/local/lib/python/site-packages/giacpy*

Error compiling Cython file:
------------------------------------------------------------
...
     g=(g*M+gen(<long long>i))
     a=a-(i<<size)

   g=g*gen(<long long>(1<<size))+gen(<long long> a)
   if aneg:
     g=-g
      ^
------------------------------------------------------------

giacpy.pyx:5112:7: Invalid operand type for '-' (gen)
Compiling giacpy.pyx because it changed.
[1/1] Cythonizing giacpy.pyx
Traceback (most recent call last):
  File "setup.py", line 47, in <module>
    language="c++")], include_path=include_path
  File "/home/mmarco/sage/local/lib/python2.7/site-packages/Cython-0.24-py2.7-linux-x86_64.egg/Cython/Build/Dependencies.py", line 912, in cythonize
    cythonize_one(*args)
  File "/home/mmarco/sage/local/lib/python2.7/site-packages/Cython-0.24-py2.7-linux-x86_64.egg/Cython/Build/Dependencies.py", line 1034, in cythonize_one
    raise CompileError(None, pyx_file)
Cython.Compiler.Errors.CompileError: giacpy.pyx

real    0m3.364s
user    0m3.251s
sys     0m0.131s

```



---

archive/issue_comments_275497.json:
```json
{
    "body": "<a id='comment:8'></a>I think it is a different problem, I can reproduce it with sage 7.2.rc1 so I am opening #20569 for this",
    "created_at": "2016-05-07T16:23:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20258#issuecomment-275497",
    "user": "https://github.com/frederichan-IMJPRG"
}
```

<a id='comment:8'></a>I think it is a different problem, I can reproduce it with sage 7.2.rc1 so I am opening #20569 for this



---

archive/issue_comments_275498.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-06-12T12:02:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20258#issuecomment-275498",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_055006.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-06-12T12:02:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20258",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20258#event-55006"
}
```



---

archive/issue_comments_275499.json:
```json
{
    "body": "Changing keywords from \"\" to \"sdl\".",
    "created_at": "2019-08-27T19:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20258",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20258#issuecomment-275499",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Changing keywords from "" to "sdl".
