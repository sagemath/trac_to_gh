# Issue 20253: bug in strongly connected test for static digraphs

archive/issues_020016.json:
```json
{
    "body": "```\nsage: G = DiGraph([(0,1),(1,0)])\nsage: G2 = G.copy(immutable=True)\nsage: G2.is_strongly_connected()\nFalse\n```\n\nThe problem comes from bad initialization of some attributes in static sparse backend. We add two lines to fix this problem. We also deprecate four methods of `CGraph` to simplify its usage (namely `_in_degree`, `_out_degree`, `_num_verts`, `_num_arcs`).\n\nCC:  @dimpase\n\nKeywords: bug\n\nBranch/Commit: dd0a55d8dfd6d1f26b41012678a1c99f2595f25e\n\nReviewer: David Coudert\n\nAuthor: Vincent Delecroix\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20253\n\n",
    "closed_at": "2016-03-26T11:30:52Z",
    "created_at": "2016-03-23T01:05:31Z",
    "labels": [
        "component: graph theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "bug in strongly connected test for static digraphs",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20253",
    "user": "https://github.com/videlec"
}
```
```
sage: G = DiGraph([(0,1),(1,0)])
sage: G2 = G.copy(immutable=True)
sage: G2.is_strongly_connected()
False
```

The problem comes from bad initialization of some attributes in static sparse backend. We add two lines to fix this problem. We also deprecate four methods of `CGraph` to simplify its usage (namely `_in_degree`, `_out_degree`, `_num_verts`, `_num_arcs`).

CC:  @dimpase

Keywords: bug

Branch/Commit: dd0a55d8dfd6d1f26b41012678a1c99f2595f25e

Reviewer: David Coudert

Author: Vincent Delecroix

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/20253





---

archive/issue_comments_366979.json:
```json
{
    "body": "<a id='comment:1'></a>I guess that there are much more methods that actually do not work. The thing is that there are uninitialized variables used by some of the methods in `CGraph` that are not initialized by `StaticSparseCGraph`. In the current case it is `num_verts` (that is available as `self.g.n`) and `num_arcs` (that is available as `self.g.m`). Adding at the end of `__init__`.\n\n```diff\ndiff --git a/src/sage/graphs/base/static_sparse_backend.pyx b/src/sage/graphs/base/static_sparse_backend.pyx\nindex 06b19cf..2a98a96 100644\n--- a/src/sage/graphs/base/static_sparse_backend.pyx\n+++ b/src/sage/graphs/base/static_sparse_backend.pyx\n@@ -95,6 +95,9 @@ cdef class StaticSparseCGraph(CGraph):\n         bitset_init(self.active_vertices,  self.g.n+1)\n         bitset_set_first_n(self.active_vertices, self.g.n)\n \n+        self.num_verts = self.g.n\n+        self.num_arcs = self.g.m\n+\n     def __dealloc__(self):\n         r\"\"\"\n         Freeing the memory\n```\nBut it looks like more a \"work around\" than a \"real fix\".",
    "created_at": "2016-03-23T01:49:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-366979",
    "user": "https://github.com/videlec"
}
```

<a id='comment:1'></a>I guess that there are much more methods that actually do not work. The thing is that there are uninitialized variables used by some of the methods in `CGraph` that are not initialized by `StaticSparseCGraph`. In the current case it is `num_verts` (that is available as `self.g.n`) and `num_arcs` (that is available as `self.g.m`). Adding at the end of `__init__`.

```diff
diff --git a/src/sage/graphs/base/static_sparse_backend.pyx b/src/sage/graphs/base/static_sparse_backend.pyx
index 06b19cf..2a98a96 100644
--- a/src/sage/graphs/base/static_sparse_backend.pyx
+++ b/src/sage/graphs/base/static_sparse_backend.pyx
@@ -95,6 +95,9 @@ cdef class StaticSparseCGraph(CGraph):
         bitset_init(self.active_vertices,  self.g.n+1)
         bitset_set_first_n(self.active_vertices, self.g.n)
 
+        self.num_verts = self.g.n
+        self.num_arcs = self.g.m
+
     def __dealloc__(self):
         r"""
         Freeing the memory
```
But it looks like more a "work around" than a "real fix".



---

archive/issue_comments_366980.json:
```json
{
    "body": "<a id='comment:2'></a>At least adding these lines at the end of the init method, with possibly other initialization, we ensure that all backends provide the same information.\nI'm surprized none of us noticed that before.\nDavid.",
    "created_at": "2016-03-23T09:44:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-366980",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:2'></a>At least adding these lines at the end of the init method, with possibly other initialization, we ensure that all backends provide the same information.
I'm surprized none of us noticed that before.
David.



---

archive/issue_comments_366981.json:
```json
{
    "body": "<a id='comment:3'></a>There are other weird stuff\n\n```\nsage: G = Graph([(0,1)])\nsage: G2 = G.copy(immutable=True)\nsage: G2._backend.is_connected()\nTraceback (most recent call last):\n...\nAttributeError: 'sage.graphs.base.static_sparse_backend.StaticSpars'\nobject has no attribute 'num_edges'\n```\nThe thing is that it is not clear to me what attributes and methods should be implemented in a new backend.",
    "created_at": "2016-03-23T12:55:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-366981",
    "user": "https://github.com/videlec"
}
```

<a id='comment:3'></a>There are other weird stuff

```
sage: G = Graph([(0,1)])
sage: G2 = G.copy(immutable=True)
sage: G2._backend.is_connected()
Traceback (most recent call last):
...
AttributeError: 'sage.graphs.base.static_sparse_backend.StaticSpars'
object has no attribute 'num_edges'
```
The thing is that it is not clear to me what attributes and methods should be implemented in a new backend.



---

archive/issue_comments_366982.json:
```json
{
    "body": "<a id='comment:4'></a>Well, at least basic features like number of nodes and edges should be in all backends.",
    "created_at": "2016-03-23T13:13:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-366982",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:4'></a>Well, at least basic features like number of nodes and edges should be in all backends.



---

archive/issue_comments_366983.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,20 +1,8 @@\n-Using the strongly connected graph from [this page](https://graph-tool.skewed.de/performance) I got\n-\n ```\n-sage: import networkx\n-sage: g = networkx.read_graphml(\"pgp.xml\")\n-sage: networkx.is_strongly_connected(g)\n-True\n-sage: G = DiGraph(g)\n-sage: G.is_strongly_connected()\n-True\n-```\n-But the test goes wrong with the static sparse backend\n-\n-```\n-sage: G2 = DiGraph(g, immutable=True)\n+sage: G = DiGraph([(0,1),(1,0)])\n+sage: G2 = G.copy(immutable=True)\n sage: G2.is_strongly_connected()\n False\n-sage: G == G2\n-True\n ```\n+\n+The problem comes from bad initialization of some attributes in static sparse backend. We add two lines to fix this problem. We also deprecate four methods of `CGraph` to simplify its usage (namely `_in_degree`, `_out_degree`, `_num_verts`, `_num_arcs`).\n``````\n",
    "created_at": "2016-03-23T13:18:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-366983",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,20 +1,8 @@
-Using the strongly connected graph from [this page](https://graph-tool.skewed.de/performance) I got
-
 ```
-sage: import networkx
-sage: g = networkx.read_graphml("pgp.xml")
-sage: networkx.is_strongly_connected(g)
-True
-sage: G = DiGraph(g)
-sage: G.is_strongly_connected()
-True
-```
-But the test goes wrong with the static sparse backend
-
-```
-sage: G2 = DiGraph(g, immutable=True)
+sage: G = DiGraph([(0,1),(1,0)])
+sage: G2 = G.copy(immutable=True)
 sage: G2.is_strongly_connected()
 False
-sage: G == G2
-True
 ```
+
+The problem comes from bad initialization of some attributes in static sparse backend. We add two lines to fix this problem. We also deprecate four methods of `CGraph` to simplify its usage (namely `_in_degree`, `_out_degree`, `_num_verts`, `_num_arcs`).
``````




---

archive/issue_comments_366984.json:
```json
{
    "body": "Changing author from \"\" to \"Vincent Delecroix\"",
    "created_at": "2016-03-23T13:18:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-366984",
    "user": "https://github.com/videlec"
}
```

Changing author from "" to "Vincent Delecroix"



---

archive/issue_comments_366985.json:
```json
{
    "body": "Changing commit from \"\" to \"cc2217dc312fb7ef006fda6fc71decb409577c86\"",
    "created_at": "2016-03-23T13:22:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-366985",
    "user": "https://github.com/videlec"
}
```

Changing commit from "" to "cc2217dc312fb7ef006fda6fc71decb409577c86"



---

archive/issue_comments_366986.json:
```json
{
    "body": "<a id='comment:6'></a>New commits:",
    "created_at": "2016-03-23T13:22:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-366986",
    "user": "https://github.com/videlec"
}
```

<a id='comment:6'></a>New commits:



---

archive/issue_comments_366987.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-03-23T13:22:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-366987",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_366988.json:
```json
{
    "body": "Changing branch from \"\" to \"u/vdelecroix/20253\"",
    "created_at": "2016-03-23T13:22:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-366988",
    "user": "https://github.com/videlec"
}
```

Changing branch from "" to "u/vdelecroix/20253"



---

archive/issue_comments_366989.json:
```json
{
    "body": "<a id='comment:7'></a>the patch is working well and passes but has one doctest error (I tried `sage -tp src/sage/graphs/` \n\n```\nsage -t src/sage/graphs/base/c_graph.pyx\n    Error: Source line number found\n\n```\ncertainly due to:\n`doctest:858: DeprecationWarning: _out_degree is deprecated`\n\nDavid.",
    "created_at": "2016-03-23T13:40:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-366989",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:7'></a>the patch is working well and passes but has one doctest error (I tried `sage -tp src/sage/graphs/` 

```
sage -t src/sage/graphs/base/c_graph.pyx
    Error: Source line number found

```
certainly due to:
`doctest:858: DeprecationWarning: _out_degree is deprecated`

David.



---

archive/issue_comments_366990.json:
```json
{
    "body": "Changing commit from \"cc2217dc312fb7ef006fda6fc71decb409577c86\" to \"dd0a55d8dfd6d1f26b41012678a1c99f2595f25e\"",
    "created_at": "2016-03-23T13:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-366990",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "cc2217dc312fb7ef006fda6fc71decb409577c86" to "dd0a55d8dfd6d1f26b41012678a1c99f2595f25e"



---

archive/issue_comments_366991.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-23T13:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-366991",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_366992.json:
```json
{
    "body": "<a id='comment:9'></a>That was it! Thanks.",
    "created_at": "2016-03-23T13:57:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-366992",
    "user": "https://github.com/videlec"
}
```

<a id='comment:9'></a>That was it! Thanks.



---

archive/issue_comments_366993.json:
```json
{
    "body": "<a id='comment:10'></a>why are you using notation `\"Graph size mismatch: %s vs. %s\" % (g.num_arcs, randg.size()))` instead of `\"Graph size mismatch: {} vs. {}\".format(g.num_arcs, randg.size()))` ?",
    "created_at": "2016-03-23T14:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-366993",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:10'></a>why are you using notation `"Graph size mismatch: %s vs. %s" % (g.num_arcs, randg.size()))` instead of `"Graph size mismatch: {} vs. {}".format(g.num_arcs, randg.size()))` ?



---

archive/issue_comments_366994.json:
```json
{
    "body": "<a id='comment:11'></a>I did not change anything there. Just `g_num.verts() -> g.num_verts` and `g._num_arcs() -> g.num_arcs`. Though I can use format.",
    "created_at": "2016-03-23T14:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-366994",
    "user": "https://github.com/videlec"
}
```

<a id='comment:11'></a>I did not change anything there. Just `g_num.verts() -> g.num_verts` and `g._num_arcs() -> g.num_arcs`. Though I can use format.



---

archive/issue_comments_366995.json:
```json
{
    "body": "<a id='comment:12'></a>ok, let it as is.",
    "created_at": "2016-03-23T14:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-366995",
    "user": "https://github.com/dcoudert"
}
```

<a id='comment:12'></a>ok, let it as is.



---

archive/issue_comments_366996.json:
```json
{
    "body": "Changing reviewer from \"\" to \"David Coudert\"",
    "created_at": "2016-03-23T14:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-366996",
    "user": "https://github.com/dcoudert"
}
```

Changing reviewer from "" to "David Coudert"



---

archive/issue_comments_366997.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-03-23T14:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-366997",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_366998.json:
```json
{
    "body": "<a id='comment:13'></a>Thanks!",
    "created_at": "2016-03-23T14:39:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-366998",
    "user": "https://github.com/videlec"
}
```

<a id='comment:13'></a>Thanks!



---

archive/issue_comments_366999.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-03-26T11:30:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-366999",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_055000.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-03-26T11:30:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20253#event-55000"
}
```



---

archive/issue_comments_367000.json:
```json
{
    "body": "Changing branch from \"u/vdelecroix/20253\" to \"dd0a55d8dfd6d1f26b41012678a1c99f2595f25e\"",
    "created_at": "2016-03-26T11:30:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20253",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20253#issuecomment-367000",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/vdelecroix/20253" to "dd0a55d8dfd6d1f26b41012678a1c99f2595f25e"
