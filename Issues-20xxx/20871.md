# Issue 20871: Fix a few more issues with sage-uncompress-spkg

archive/issues_020634.json:
```json
{
    "body": "Fixes 2 issues:\n\n1. An outright bug following from #20721: If the files in a tarball are not all under a top-level directory (shouldn't be the case, but possible), the `-d` flag did not work as advertised.\n\n2. Always unset setuid and setgid flags.  There's no reason they should be set in a source tarball (I don't think?) and it will mitigate issues like #20870\n\nBranch/Commit: 0c2c9d4b06da052bdf9a7e2e749af82fc2f2bea4\n\nReviewer: Matthias Koeppe\n\nAuthor: Erik Bray\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20871\n\n",
    "closed_at": "2016-07-02T08:49:04Z",
    "created_at": "2016-06-24T09:50:22Z",
    "labels": [
        "component: build",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "Fix a few more issues with sage-uncompress-spkg",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20871",
    "user": "https://github.com/embray"
}
```
Fixes 2 issues:

1. An outright bug following from #20721: If the files in a tarball are not all under a top-level directory (shouldn't be the case, but possible), the `-d` flag did not work as advertised.

2. Always unset setuid and setgid flags.  There's no reason they should be set in a source tarball (I don't think?) and it will mitigate issues like #20870

Branch/Commit: 0c2c9d4b06da052bdf9a7e2e749af82fc2f2bea4

Reviewer: Matthias Koeppe

Author: Erik Bray

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/20871





---

archive/issue_comments_302952.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-06-24T09:50:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302952",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_302953.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2016-06-24T10:54:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302953",
    "user": "https://github.com/embray"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_302954.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-06-27T05:24:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302954",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_302955.json:
```json
{
    "body": "<a id='comment:4'></a>There is still an issue with zip files.\n\n`sage -i bliss` gives:\n\n```\n[bliss-0.73] Found local metadata for bliss-0.73\n[bliss-0.73] Using cached file /Users/mkoeppe/cvs/sage/upstream/bliss-0.73.zip\n[bliss-0.73] bliss-0.73\n[bliss-0.73] ====================================================\n[bliss-0.73] Setting up build directory for bliss-0.73\n[bliss-0.73] Traceback (most recent call last):\n[bliss-0.73]   File \"/Users/mkoeppe/cvs/sage/build/bin/sage-uncompress-spkg\", line 260, in <module>\n[bliss-0.73]     sys.exit(main())\n[bliss-0.73]   File \"/Users/mkoeppe/cvs/sage/build/bin/sage-uncompress-spkg\", line 212, in main\n[bliss-0.73]     archive = cls.open(filename)\n[bliss-0.73] TypeError: unbound method open() must be called with SageZipFile instance as first argument (got str instance instead)\n[bliss-0.73] Error: failed to extract /Users/mkoeppe/cvs/sage/upstream/bliss-0.73.zip\n```",
    "created_at": "2016-06-28T03:50:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302955",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>There is still an issue with zip files.

`sage -i bliss` gives:

```
[bliss-0.73] Found local metadata for bliss-0.73
[bliss-0.73] Using cached file /Users/mkoeppe/cvs/sage/upstream/bliss-0.73.zip
[bliss-0.73] bliss-0.73
[bliss-0.73] ====================================================
[bliss-0.73] Setting up build directory for bliss-0.73
[bliss-0.73] Traceback (most recent call last):
[bliss-0.73]   File "/Users/mkoeppe/cvs/sage/build/bin/sage-uncompress-spkg", line 260, in <module>
[bliss-0.73]     sys.exit(main())
[bliss-0.73]   File "/Users/mkoeppe/cvs/sage/build/bin/sage-uncompress-spkg", line 212, in main
[bliss-0.73]     archive = cls.open(filename)
[bliss-0.73] TypeError: unbound method open() must be called with SageZipFile instance as first argument (got str instance instead)
[bliss-0.73] Error: failed to extract /Users/mkoeppe/cvs/sage/upstream/bliss-0.73.zip
```



---

archive/issue_comments_302956.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-06-28T03:50:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302956",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_302957.json:
```json
{
    "body": "<a id='comment:5'></a>> There is still an issue with zip files.\n\n\nWas this reported before?\n\nMight as well fix it as part of this ticket too while I'm fixing bugs.\n\nIt looks like the `ZipFile` class is inconsistent with the `TarFile` class, where `open` is a classmethod.  I think I knew that but forgot this time.",
    "created_at": "2016-06-28T07:41:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302957",
    "user": "https://github.com/embray"
}
```

<a id='comment:5'></a>> There is still an issue with zip files.


Was this reported before?

Might as well fix it as part of this ticket too while I'm fixing bugs.

It looks like the `ZipFile` class is inconsistent with the `TarFile` class, where `open` is a classmethod.  I think I knew that but forgot this time.



---

archive/issue_comments_302958.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 embray]:\n> > There is still an issue with zip files.\n\n> \n> Was this reported before?\n\n\nI didn't see a report; but zip files did work in the past. Perhaps introduced in #20721? I didn't catch it at this time.\n\n> Might as well fix it as part of this ticket too while I'm fixing bugs.\n\n\nThanks.",
    "created_at": "2016-06-28T07:55:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302958",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>Replying to [comment:5 embray]:
> > There is still an issue with zip files.

> 
> Was this reported before?


I didn't see a report; but zip files did work in the past. Perhaps introduced in #20721? I didn't catch it at this time.

> Might as well fix it as part of this ticket too while I'm fixing bugs.


Thanks.



---

archive/issue_events_055913.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-06-28T14:26:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20871#event-55913"
}
```



---

archive/issue_comments_302959.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-06-28T14:26:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302959",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_302960.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2016-06-28T14:27:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302960",
    "user": "https://github.com/vbraun"
}
```

Changing status from closed to new.



---

archive/issue_events_055914.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-06-28T14:27:25Z",
    "event": "reopened",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20871#event-55914"
}
```



---

archive/issue_comments_302961.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2016-06-28T14:27:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302961",
    "user": "https://github.com/vbraun"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_302962.json:
```json
{
    "body": "<a id='comment:9'></a>New commits:",
    "created_at": "2016-06-28T14:27:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302962",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:9'></a>New commits:



---

archive/issue_comments_302963.json:
```json
{
    "body": "<a id='comment:10'></a>What just happened here?",
    "created_at": "2016-06-28T14:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302963",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>What just happened here?



---

archive/issue_comments_302964.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-06-28T15:25:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302964",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_302965.json:
```json
{
    "body": "<a id='comment:12'></a>I merged the positively-reviewed ticket, all tests passed, and then I closed the ticket.",
    "created_at": "2016-06-28T15:40:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302965",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:12'></a>I merged the positively-reviewed ticket, all tests passed, and then I closed the ticket.



---

archive/issue_comments_302966.json:
```json
{
    "body": "<a id='comment:13'></a>The status was `needs_work` though.  I just pushed another commit that should have been included.",
    "created_at": "2016-06-28T15:46:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302966",
    "user": "https://github.com/embray"
}
```

<a id='comment:13'></a>The status was `needs_work` though.  I just pushed another commit that should have been included.



---

archive/issue_comments_302967.json:
```json
{
    "body": "<a id='comment:14'></a>The status was positive review when I merged the ticket.",
    "created_at": "2016-06-28T15:53:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302967",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:14'></a>The status was positive review when I merged the ticket.



---

archive/issue_comments_302968.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-06-28T16:19:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302968",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_302969.json:
```json
{
    "body": "<a id='comment:16'></a>Branch works now, but may need merge/rebase.",
    "created_at": "2016-06-28T16:55:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302969",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>Branch works now, but may need merge/rebase.



---

archive/issue_comments_302970.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-06-28T16:55:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302970",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_302971.json:
```json
{
    "body": "<a id='comment:17'></a>Merge conflict",
    "created_at": "2016-06-29T10:23:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302971",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:17'></a>Merge conflict



---

archive/issue_comments_302972.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-06-29T10:23:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302972",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_302973.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-06-30T16:21:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302973",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_302974.json:
```json
{
    "body": "<a id='comment:19'></a>Rebased.",
    "created_at": "2016-06-30T16:22:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302974",
    "user": "https://github.com/embray"
}
```

<a id='comment:19'></a>Rebased.



---

archive/issue_comments_302975.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-06-30T16:22:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302975",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_302976.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-07-01T13:13:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302976",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_302977.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-07-02T08:49:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20871#issuecomment-302977",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_055915.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-07-02T08:49:04Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20871",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20871#event-55915"
}
```
