# Issue 20721: Unpack all upstream tarballs into 'src' directory

archive/issues_020484.json:
```json
{
    "body": "When building an spkg the upstream tarball is unpacked into the temporary build directory, and then with a 'hack' [here http://git.sagemath.org/sage.git/tree/build/bin/sage-spkg?h=develop&id=769ff190413123f3b0c21a16ea69c63e3f99c43a#n537] to try to figure out what directory the tarball is extracted to, and then rename it to `src`.  This doesn't always work for all packages, and in some packages they get extracted to something else, leading to inconsistencies in `spkg-installs`.  It would be nice if the upstream source can always be found in `src`.\n\nThis idea came about in the discussion in #20692 starting around here: http://trac.sagemath.org/ticket/20692#comment:18\n\nThis adds one more small step toward more consistency between spkgs.\n\nIt might also be worth clarifying in the documentation that (as of this patch) the upstream source should always wind up in `src/`.\n\nReviewer: Matthias Koeppe\n\nAuthor: Erik Bray\n\nBranch: 69d5c9b762c8d4a86c085baafa6a0bad1ebd80db\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20721\n\n",
    "closed_at": "2016-06-05T01:06:47Z",
    "created_at": "2016-05-30T17:13:01Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "Unpack all upstream tarballs into 'src' directory",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20721",
    "user": "https://github.com/embray"
}
```
When building an spkg the upstream tarball is unpacked into the temporary build directory, and then with a 'hack' [here http://git.sagemath.org/sage.git/tree/build/bin/sage-spkg?h=develop&id=769ff190413123f3b0c21a16ea69c63e3f99c43a#n537] to try to figure out what directory the tarball is extracted to, and then rename it to `src`.  This doesn't always work for all packages, and in some packages they get extracted to something else, leading to inconsistencies in `spkg-installs`.  It would be nice if the upstream source can always be found in `src`.

This idea came about in the discussion in #20692 starting around here: http://trac.sagemath.org/ticket/20692#comment:18

This adds one more small step toward more consistency between spkgs.

It might also be worth clarifying in the documentation that (as of this patch) the upstream source should always wind up in `src/`.

Reviewer: Matthias Koeppe

Author: Erik Bray

Branch: 69d5c9b762c8d4a86c085baafa6a0bad1ebd80db

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/20721





---

archive/issue_comments_300696.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-05-30T17:14:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20721#issuecomment-300696",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_300697.json:
```json
{
    "body": "<a id='comment:2'></a>I can confirm that it builds the \"latte_int\" package correctly with this change.",
    "created_at": "2016-05-31T09:23:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20721#issuecomment-300697",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>I can confirm that it builds the "latte_int" package correctly with this change.



---

archive/issue_comments_300698.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-05-31T09:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20721#issuecomment-300698",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_300699.json:
```json
{
    "body": "<a id='comment:3'></a>However, \n\n```\nSAGE_CHECK=yes sage -f latte_int\n```\nyields an error because of the changed directories.",
    "created_at": "2016-05-31T09:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20721#issuecomment-300699",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>However, 

```
SAGE_CHECK=yes sage -f latte_int
```
yields an error because of the changed directories.



---

archive/issue_comments_300700.json:
```json
{
    "body": "<a id='comment:4'></a>Oops, I'll fix that, and check the other updated packages as well.",
    "created_at": "2016-05-31T10:51:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20721#issuecomment-300700",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>Oops, I'll fix that, and check the other updated packages as well.



---

archive/issue_comments_300701.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-05-31T14:14:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20721#issuecomment-300701",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_300702.json:
```json
{
    "body": "<a id='comment:6'></a>Fixed the relevant spkg-checks.  \n\nIncidentally, one of the tests for latte_int failed until I installed 4ti2.  Not relevant to this ticket, but I thought it was worth noting--4ti2 is not listed as a dependency of latte_int.  Should it be?  (I have no idea what these packages are.)",
    "created_at": "2016-05-31T14:20:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20721#issuecomment-300702",
    "user": "https://github.com/embray"
}
```

<a id='comment:6'></a>Fixed the relevant spkg-checks.  

Incidentally, one of the tests for latte_int failed until I installed 4ti2.  Not relevant to this ticket, but I thought it was worth noting--4ti2 is not listed as a dependency of latte_int.  Should it be?  (I have no idea what these packages are.)



---

archive/issue_comments_300703.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:6 embray]:\n> Fixed the relevant spkg-checks.  \n\n\nThanks.\n\n> Incidentally, one of the tests for latte_int failed until I installed 4ti2.  Not relevant to this ticket, but I thought it was worth noting--4ti2 is not listed as a dependency of latte_int.  Should it be?  (I have no idea what these packages are.)\n\n\nYes, it should. In fact, both 4ti2 and latte_int should get 'dependencies' files. This is an spkg feature I wasn't aware of, thanks for mentioning it.",
    "created_at": "2016-05-31T14:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20721#issuecomment-300703",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>Replying to [comment:6 embray]:
> Fixed the relevant spkg-checks.  


Thanks.

> Incidentally, one of the tests for latte_int failed until I installed 4ti2.  Not relevant to this ticket, but I thought it was worth noting--4ti2 is not listed as a dependency of latte_int.  Should it be?  (I have no idea what these packages are.)


Yes, it should. In fact, both 4ti2 and latte_int should get 'dependencies' files. This is an spkg feature I wasn't aware of, thanks for mentioning it.



---

archive/issue_comments_300704.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-06-02T13:26:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20721#issuecomment-300704",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_300705.json:
```json
{
    "body": "<a id='comment:10'></a>Before merging this I should also add a note in http://doc.sagemath.org/html/en/developer/packaging.html stating explicitly that the upstream sources are now always unpacked into \"src/\"",
    "created_at": "2016-06-02T15:01:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20721#issuecomment-300705",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>Before merging this I should also add a note in http://doc.sagemath.org/html/en/developer/packaging.html stating explicitly that the upstream sources are now always unpacked into "src/"



---

archive/issue_events_055706.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-06-03T21:49:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20721",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20721#event-55706"
}
```



---

archive/issue_comments_300706.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-06-03T21:49:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20721#issuecomment-300706",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_300707.json:
```json
{
    "body": "<a id='comment:12'></a>Argparse is Python 2.7+ only, this ticket implicitly removed support for building sage with Python 2.6 and below. See also #19984, #20023",
    "created_at": "2016-06-03T21:56:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20721#issuecomment-300707",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:12'></a>Argparse is Python 2.7+ only, this ticket implicitly removed support for building sage with Python 2.6 and below. See also #19984, #20023



---

archive/issue_comments_300708.json:
```json
{
    "body": "<a id='comment:13'></a>Fails on OSX:\n\n```\n**********************************************************************\nFile \"src/sage/structure/sage_object.pyx\", line 1526, in sage.structure.sage_object.unpickle_all\nFailed example:\n    sage.structure.sage_object.unpickle_all()\nExpected:\n    Successfully unpickled ... objects.\n    Failed to unpickle 0 objects.\nGot:\n    tar: Failed to set default locale\n    Successfully unpickled 586 objects.\n    Failed to unpickle 0 objects.\n**********************************************************************\n1 item had failures:\n   2 of  11 in sage.structure.sage_object.unpickle_all\n    [204 tests, 2 failures, 12.10 s]\n```",
    "created_at": "2016-06-04T19:20:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20721#issuecomment-300708",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:13'></a>Fails on OSX:

```
**********************************************************************
File "src/sage/structure/sage_object.pyx", line 1526, in sage.structure.sage_object.unpickle_all
Failed example:
    sage.structure.sage_object.unpickle_all()
Expected:
    Successfully unpickled ... objects.
    Failed to unpickle 0 objects.
Got:
    tar: Failed to set default locale
    Successfully unpickled 586 objects.
    Failed to unpickle 0 objects.
**********************************************************************
1 item had failures:
   2 of  11 in sage.structure.sage_object.unpickle_all
    [204 tests, 2 failures, 12.10 s]
```



---

archive/issue_comments_300709.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2016-06-04T19:20:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20721#issuecomment-300709",
    "user": "https://github.com/vbraun"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_300710.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2016-06-04T19:20:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20721#issuecomment-300710",
    "user": "https://github.com/vbraun"
}
```

Changing status from closed to new.



---

archive/issue_events_055707.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-06-04T19:20:31Z",
    "event": "reopened",
    "issue": "https://github.com/sagemath/sagetest/issues/20721",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20721#event-55707"
}
```



---

archive/issue_comments_300711.json:
```json
{
    "body": "<a id='comment:14'></a>Never mind that was due to an environment variable change.",
    "created_at": "2016-06-05T01:06:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20721#issuecomment-300711",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:14'></a>Never mind that was due to an environment variable change.



---

archive/issue_comments_300712.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-06-05T01:06:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20721",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20721#issuecomment-300712",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_055708.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-06-05T01:06:47Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20721",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20721#event-55708"
}
```
