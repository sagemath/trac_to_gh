# Issue 20330: hyperbolic_geodesic midpoint bugfix

archive/issues_020093.json:
```json
{
    "body": "midpoint() fails to end for some geodesic with finite length \nexample:\n\n```\nsage: g=HyperbolicPlane().UHP().get_geodesic(2*I,2*I+1)\nsage: g.midpoint()'\n...\nRuntimeError: maximum recursion depth exceeded in __instancecheck__\n```\n\n\nKeywords: hyperbolic geometry, geodesic\n\nBranch/Commit: 2ba1c96e25d7e128adc832bc4c4e4c51e8835b98\n\nReviewer: Vincent Delecroix\n\nAuthor: Javier Honrubia Gonz\u00e1lez\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20330\n\n",
    "closed_at": "2016-05-26T07:15:22Z",
    "created_at": "2016-03-30T19:29:33Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "hyperbolic_geodesic midpoint bugfix",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20330",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```
midpoint() fails to end for some geodesic with finite length 
example:

```
sage: g=HyperbolicPlane().UHP().get_geodesic(2*I,2*I+1)
sage: g.midpoint()'
...
RuntimeError: maximum recursion depth exceeded in __instancecheck__
```


Keywords: hyperbolic geometry, geodesic

Branch/Commit: 2ba1c96e25d7e128adc832bc4c4e4c51e8835b98

Reviewer: Vincent Delecroix

Author: Javier Honrubia Gonz√°lez

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/20330





---

archive/issue_comments_368745.json:
```json
{
    "body": "Changing keywords from \"\" to \"hyperbolic geometry, geodesic\".",
    "created_at": "2016-03-30T19:30:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368745",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

Changing keywords from "" to "hyperbolic geometry, geodesic".



---

archive/issue_comments_368746.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2016-03-30T19:30:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368746",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_368747.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to geometry.",
    "created_at": "2016-03-30T19:30:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368747",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

Changing component from PLEASE CHANGE to geometry.



---

archive/issue_comments_368748.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,8 @@\n+midpoint() fails to end for some geodesic with finite length \n+example:\n \n+```\n+sage: g=HyperbolicPlane().UHP().get_geodesic(2*I,2*I+1)\n+sage: g.midpoint()'\n+```\n+\n``````\n",
    "created_at": "2016-03-30T19:32:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368748",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,8 @@
+midpoint() fails to end for some geodesic with finite length 
+example:
 
+```
+sage: g=HyperbolicPlane().UHP().get_geodesic(2*I,2*I+1)
+sage: g.midpoint()'
+```
+
``````




---

archive/issue_comments_368749.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,5 +4,7 @@\n ```\n sage: g=HyperbolicPlane().UHP().get_geodesic(2*I,2*I+1)\n sage: g.midpoint()'\n+...\n+RuntimeError: maximum recursion depth exceeded in __instancecheck__\n ```\n \n``````\n",
    "created_at": "2016-03-30T19:33:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368749",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,5 +4,7 @@
 ```
 sage: g=HyperbolicPlane().UHP().get_geodesic(2*I,2*I+1)
 sage: g.midpoint()'
+...
+RuntimeError: maximum recursion depth exceeded in __instancecheck__
 ```
 
``````




---

archive/issue_comments_368750.json:
```json
{
    "body": "<a id='comment:4'></a>The problem seems to be triggered when calculating the inverse of the _to_std_geod(start) matrix",
    "created_at": "2016-03-30T20:47:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368750",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

<a id='comment:4'></a>The problem seems to be triggered when calculating the inverse of the _to_std_geod(start) matrix



---

archive/issue_comments_368751.json:
```json
{
    "body": "<a id='comment:5'></a>It seems that the matrix is sufficiently complicated that it just runs up against the Python function call limit. If I run `simplify_full` on the matrix first, then it works (and I can even run in again to simplify it further). So this would be one way to hack around this.\n\nAlthough we might benefit from having a special case for inverting 2x2 matrices using the explicit form:\n\n```\n[A B]^-1 = __1__ [ D -B]\n[C D]      AD-BC [-C  A]\n```\nThis would give another way around this (it should be faster and in some ways, more robust) as this code only deals with 2x2 matrices.",
    "created_at": "2016-04-09T21:04:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368751",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>It seems that the matrix is sufficiently complicated that it just runs up against the Python function call limit. If I run `simplify_full` on the matrix first, then it works (and I can even run in again to simplify it further). So this would be one way to hack around this.

Although we might benefit from having a special case for inverting 2x2 matrices using the explicit form:

```
[A B]^-1 = __1__ [ D -B]
[C D]      AD-BC [-C  A]
```
This would give another way around this (it should be faster and in some ways, more robust) as this code only deals with 2x2 matrices.



---

archive/issue_comments_368752.json:
```json
{
    "body": "<a id='comment:6'></a>I had tried `simplify_full` (although I hadn't thought of applying it multiple times) but I am somehow disappointed with the solution even that it gets since the result is still too complicated (in the motivating example should have Re(z)=1/2 instead of the monster that it shows.\nI am trying to understand the code to see how to get a simpler expression, if possible without resorting to `simplify_full` the result.\nThe transformation  S it uses to carry the geodesic to the imaginary axis it is not even recognized as an isometry by the model, fails the test `self._model.isometry_in_model(S)` (although the double 'full_simplified' expression successes)\nObviously works flawlessly with \n\n```\nh=HyperbolicPlane().UHP().get_geodesic(2.0*I,2.0*I+1.0)\nh.midpoint()\n```",
    "created_at": "2016-04-27T15:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368752",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

<a id='comment:6'></a>I had tried `simplify_full` (although I hadn't thought of applying it multiple times) but I am somehow disappointed with the solution even that it gets since the result is still too complicated (in the motivating example should have Re(z)=1/2 instead of the monster that it shows.
I am trying to understand the code to see how to get a simpler expression, if possible without resorting to `simplify_full` the result.
The transformation  S it uses to carry the geodesic to the imaginary axis it is not even recognized as an isometry by the model, fails the test `self._model.isometry_in_model(S)` (although the double 'full_simplified' expression successes)
Obviously works flawlessly with 

```
h=HyperbolicPlane().UHP().get_geodesic(2.0*I,2.0*I+1.0)
h.midpoint()
```



---

archive/issue_comments_368753.json:
```json
{
    "body": "Changing branch from \"\" to \"u/jhonrubia6/hyperbolic_geodesic_midpoint_bugfix\"",
    "created_at": "2016-05-01T18:22:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368753",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

Changing branch from "" to "u/jhonrubia6/hyperbolic_geodesic_midpoint_bugfix"



---

archive/issue_comments_368754.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-05-01T18:41:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368754",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_368755.json:
```json
{
    "body": "<a id='comment:8'></a>The matrix of the isometry that sends the geodesic to the imaginary axis is a symbolic array, when this matrix is numeric the algorithm evaluates efficiently but when is purely symbolic it is necessary a double full_simplify() operation so that the posterior operation of inverting the matrix does not get a runtime error. After profiling the code, I do not see (surprisingly) any speed advantage in coding explicitly the inverse matrix, so I decided to left that unchanged.\n\n---\nNew commits:",
    "created_at": "2016-05-01T18:41:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368755",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

<a id='comment:8'></a>The matrix of the isometry that sends the geodesic to the imaginary axis is a symbolic array, when this matrix is numeric the algorithm evaluates efficiently but when is purely symbolic it is necessary a double full_simplify() operation so that the posterior operation of inverting the matrix does not get a runtime error. After profiling the code, I do not see (surprisingly) any speed advantage in coding explicitly the inverse matrix, so I decided to left that unchanged.

---
New commits:



---

archive/issue_comments_368756.json:
```json
{
    "body": "Changing commit from \"\" to \"89500eb900f245d091afcc4461f4d8f19f6db5b9\"",
    "created_at": "2016-05-01T18:41:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368756",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

Changing commit from "" to "89500eb900f245d091afcc4461f4d8f19f6db5b9"



---

archive/issue_comments_368757.json:
```json
{
    "body": "Changing author from \"\" to \"Javier Honrubia Gonz\u00e1lez\"",
    "created_at": "2016-05-01T18:42:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368757",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

Changing author from "" to "Javier Honrubia Gonz√°lez"



---

archive/issue_comments_368758.json:
```json
{
    "body": "<a id='comment:10'></a>Hello,\n\nWhy in all this code the type of number is not preserved\n\n```\nsage: g = HyperbolicPlane().UHP().get_geodesic(CC(0,2),CC(1,2))\nsage: type(g.endpoints()[0].coordinates())\n<type 'sage.rings.complex_number.ComplexNumber'>\nsage: type(g.midpoint().coordinates())\n<type 'sage.symbolic.expression.Expression'>\n```\nIf I am using floating point number it is likely that I want to do floating point computations.",
    "created_at": "2016-05-01T22:53:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368758",
    "user": "https://github.com/videlec"
}
```

<a id='comment:10'></a>Hello,

Why in all this code the type of number is not preserved

```
sage: g = HyperbolicPlane().UHP().get_geodesic(CC(0,2),CC(1,2))
sage: type(g.endpoints()[0].coordinates())
<type 'sage.rings.complex_number.ComplexNumber'>
sage: type(g.midpoint().coordinates())
<type 'sage.symbolic.expression.Expression'>
```
If I am using floating point number it is likely that I want to do floating point computations.



---

archive/issue_comments_368759.json:
```json
{
    "body": "<a id='comment:11'></a>Related question: in your code your assume that the coordinates are symbolic. Why can you make such assumption (since I am able to construct geodesic with any kind of coordinates)?",
    "created_at": "2016-05-01T22:54:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368759",
    "user": "https://github.com/videlec"
}
```

<a id='comment:11'></a>Related question: in your code your assume that the coordinates are symbolic. Why can you make such assumption (since I am able to construct geodesic with any kind of coordinates)?



---

archive/issue_comments_368760.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-05-02T06:34:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368760",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_368761.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:10 vdelecroix]:\n> Hello,\n> \n> Why in all this code the type of number is not preserved\n> \n> ```\n> sage: g = HyperbolicPlane().UHP().get_geodesic(CC(0,2),CC(1,2))\n> sage: type(g.endpoints()[0].coordinates())\n> <type 'sage.rings.complex_number.ComplexNumber'>\n> sage: type(g.midpoint().coordinates())\n> <type 'sage.symbolic.expression.Expression'>\n> ```\n> If I am using floating point number it is likely that I want to do floating point computations.\n\nSince I was trying to fix a bug, I did not question the way the module was implemented in the beginning (I assumed it was discussed, and reached a consensus).\nTaking a closer look, the effect you mention is caused by `_crossratio_matrix()` as in\n\n```\nsage: (p1, p2, p3) = [UHP.random_point().coordinates() for k in range(3)]\nsage: A = HyperbolicGeodesicUHP._crossratio_matrix(p1, p2, p3)\nsage: type(A)\n<type 'sage.matrix.matrix_symbolic_dense.Matrix_symbolic_dense'>\n```\neven\n\n```\nsage: B = HyperbolicGeodesicUHP._crossratio_matrix(CC(1,1), CC(3,2), CC(2,2))\nsage: type(B)\n<type 'sage.matrix.matrix_generic_dense.Matrix_generic_dense'>\n```\nOne thing we can try is to check the type of p1,p2,p3 and construct the matrix in CDF if we have `isinstance(p1,numbers.Complex)` using\n\n```\nreturn matrix(CDF,[[p1 - p2, (p1 - p2)*(-p0)],[p1 - p0, (p1 - p0)*(-p2)]])\n```\nWhat do you think of this approach? Any pitfalls ahead I am not aware of?",
    "created_at": "2016-05-02T06:34:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368761",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

<a id='comment:12'></a>Replying to [comment:10 vdelecroix]:
> Hello,
> 
> Why in all this code the type of number is not preserved
> 
> ```
> sage: g = HyperbolicPlane().UHP().get_geodesic(CC(0,2),CC(1,2))
> sage: type(g.endpoints()[0].coordinates())
> <type 'sage.rings.complex_number.ComplexNumber'>
> sage: type(g.midpoint().coordinates())
> <type 'sage.symbolic.expression.Expression'>
> ```
> If I am using floating point number it is likely that I want to do floating point computations.

Since I was trying to fix a bug, I did not question the way the module was implemented in the beginning (I assumed it was discussed, and reached a consensus).
Taking a closer look, the effect you mention is caused by `_crossratio_matrix()` as in

```
sage: (p1, p2, p3) = [UHP.random_point().coordinates() for k in range(3)]
sage: A = HyperbolicGeodesicUHP._crossratio_matrix(p1, p2, p3)
sage: type(A)
<type 'sage.matrix.matrix_symbolic_dense.Matrix_symbolic_dense'>
```
even

```
sage: B = HyperbolicGeodesicUHP._crossratio_matrix(CC(1,1), CC(3,2), CC(2,2))
sage: type(B)
<type 'sage.matrix.matrix_generic_dense.Matrix_generic_dense'>
```
One thing we can try is to check the type of p1,p2,p3 and construct the matrix in CDF if we have `isinstance(p1,numbers.Complex)` using

```
return matrix(CDF,[[p1 - p2, (p1 - p2)*(-p0)],[p1 - p0, (p1 - p0)*(-p2)]])
```
What do you think of this approach? Any pitfalls ahead I am not aware of?



---

archive/issue_comments_368762.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:11 vdelecroix]:\n> Related question: in your code your assume that the coordinates are symbolic. Why can you make such assumption (since I am able to construct geodesic with any kind of coordinates)?\n\nWell, it seems that all the code is working on symbolics as in\n\n```\nsage: UHP = HyperbolicPlane().UHP()\nsage: P = UHP.random_point().coordinates()\nsage: type(P)\n<type 'sage.symbolic.expression.Expression'>\n```",
    "created_at": "2016-05-02T06:37:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368762",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

<a id='comment:13'></a>Replying to [comment:11 vdelecroix]:
> Related question: in your code your assume that the coordinates are symbolic. Why can you make such assumption (since I am able to construct geodesic with any kind of coordinates)?

Well, it seems that all the code is working on symbolics as in

```
sage: UHP = HyperbolicPlane().UHP()
sage: P = UHP.random_point().coordinates()
sage: type(P)
<type 'sage.symbolic.expression.Expression'>
```



---

archive/issue_comments_368763.json:
```json
{
    "body": "<a id='comment:14'></a>On a related topic. If I check with number.Complex I get unwanted results as in\n\n```\nsage: import numbers\nsage: from sage.rings.complex_number import ComplexNumber\nsage: Q = UHP.get_point(CC(sqrt(2)*(1+I)))\nsage: Q.coordinates()\n1.41421356237309 + 1.41421356237309*I\nsage: isinstance(Q.coordinates(),numbers.Complex)\nFalse\nsage: isinstance(Q.coordinates(),ComplexNumber)\nTrue\n```",
    "created_at": "2016-05-02T06:54:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368763",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

<a id='comment:14'></a>On a related topic. If I check with number.Complex I get unwanted results as in

```
sage: import numbers
sage: from sage.rings.complex_number import ComplexNumber
sage: Q = UHP.get_point(CC(sqrt(2)*(1+I)))
sage: Q.coordinates()
1.41421356237309 + 1.41421356237309*I
sage: isinstance(Q.coordinates(),numbers.Complex)
False
sage: isinstance(Q.coordinates(),ComplexNumber)
True
```



---

archive/issue_comments_368764.json:
```json
{
    "body": "<a id='comment:15'></a>I correct myself the crossratio matrix is \n`<type 'sage.matrix.matrix_generic_dense.Matrix_generic_dense'>` \nit gets converted to symbolic when multiplied by \n`B = matrix([[1, 0], [0,I]])` \nso if we change it to \n`matrix([[1r,0r],[0r,CC(0,1)]])` \nwe mantain the type to \n`<type 'sage.matrix.matrix_generic_dense.Matrix_generic_dense'>`\nIt is what you are requesting or it you require to get a \n`<type 'sage.matrix.matrix_complex_double_dense.Matrix_complex_double_dense'>`\n\nIn that case, will we have to construct\n\n```\nreturn matrix(CDF,[[p1 - p2, (p1 - p2)*(-p0)],[p1 - p0, (p1 - p0)*(-p2)]])\n```\nas mentioned before when the points p1,p2,p3 are instances of [ComplexNumber](ComplexNumber) and leaving as it is in the rest of cases?",
    "created_at": "2016-05-02T07:40:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368764",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

<a id='comment:15'></a>I correct myself the crossratio matrix is 
`<type 'sage.matrix.matrix_generic_dense.Matrix_generic_dense'>` 
it gets converted to symbolic when multiplied by 
`B = matrix([[1, 0], [0,I]])` 
so if we change it to 
`matrix([[1r,0r],[0r,CC(0,1)]])` 
we mantain the type to 
`<type 'sage.matrix.matrix_generic_dense.Matrix_generic_dense'>`
It is what you are requesting or it you require to get a 
`<type 'sage.matrix.matrix_complex_double_dense.Matrix_complex_double_dense'>`

In that case, will we have to construct

```
return matrix(CDF,[[p1 - p2, (p1 - p2)*(-p0)],[p1 - p0, (p1 - p0)*(-p2)]])
```
as mentioned before when the points p1,p2,p3 are instances of [ComplexNumber](ComplexNumber) and leaving as it is in the rest of cases?



---

archive/issue_comments_368765.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:14 jhonrubia6]:\n> On a related topic. If I check with number.Complex I get unwanted results as in\n> \n> ```\n> sage: import numbers\n> sage: from sage.rings.complex_number import ComplexNumber\n> sage: Q = UHP.get_point(CC(sqrt(2)*(1+I)))\n> sage: Q.coordinates()\n> 1.41421356237309 + 1.41421356237309*I\n> sage: isinstance(Q.coordinates(),numbers.Complex)\n> False\n> sage: isinstance(Q.coordinates(),ComplexNumber)\n> True\n> ```\n\n\nWhich version of Sage are you using? On sage-7.2.beta6 complex numbers are perfectly recognized by Python `numbers.Complex`:\n\n```\nsage: import numbers\nsage: isinstance(CC(0,1), numbers.Complex)\nTrue\nsage: isinstance(CDF(0,1), numbers.Complex)\nTrue\n```",
    "created_at": "2016-05-02T15:10:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368765",
    "user": "https://github.com/videlec"
}
```

<a id='comment:16'></a>Replying to [comment:14 jhonrubia6]:
> On a related topic. If I check with number.Complex I get unwanted results as in
> 
> ```
> sage: import numbers
> sage: from sage.rings.complex_number import ComplexNumber
> sage: Q = UHP.get_point(CC(sqrt(2)*(1+I)))
> sage: Q.coordinates()
> 1.41421356237309 + 1.41421356237309*I
> sage: isinstance(Q.coordinates(),numbers.Complex)
> False
> sage: isinstance(Q.coordinates(),ComplexNumber)
> True
> ```


Which version of Sage are you using? On sage-7.2.beta6 complex numbers are perfectly recognized by Python `numbers.Complex`:

```
sage: import numbers
sage: isinstance(CC(0,1), numbers.Complex)
True
sage: isinstance(CDF(0,1), numbers.Complex)
True
```



---

archive/issue_comments_368766.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:15 jhonrubia6]:\n> I correct myself the crossratio matrix is \n> `<type 'sage.matrix.matrix_generic_dense.Matrix_generic_dense'>` \n> it gets converted to symbolic when multiplied by \n> `B = matrix([[1, 0], [0,I]])` \n> so if we change it to \n> `matrix([[1r,0r],[0r,CC(0,1)]])` \n> we mantain the type to \n> `<type 'sage.matrix.matrix_generic_dense.Matrix_generic_dense'>`\n> It is what you are requesting or it you require to get a \n> `<type 'sage.matrix.matrix_complex_double_dense.Matrix_complex_double_dense'>`\n> \n> In that case, will we have to construct\n> \n> ```\n> return matrix(CDF,[[p1 - p2, (p1 - p2)*(-p0)],[p1 - p0, (p1 - p0)*(-p2)]])\n> ```\n> as mentioned before when the points p1,p2,p3 are instances of [ComplexNumber](ComplexNumber) and leaving as it is in the rest of cases?\n\n\nIt would be bad to use `CC(0,1)` by default for the complex imaginary unit. The only viable solution is to use the base ring of the coordinates\n\n```\ndef get_I(a):\n    from sage.structure.element import Element\n    if isinstance(a, complex):\n        return complex(\"j\")\n    elif isinstance(a, Expression):\n        return SR(\"I\")\n    elif isinstance(a, Element):\n        return a.parent().gen()\n    else:\n        raise ValueError(\"not a complex number\")\n```\nIt seems to work in most cases\n\n```\nsage: get_I(SR(1))\nI\nsage: parent(_)\nSymbolic Ring\n\nsage: get_I(QQbar(1+I))\nI\nsage: parent(_)\nAlgebraic Field\n\nsage: get_I(CDF.an_element())\n1.0*I\nsage: parent(_)\nComplex Double Field\n\nsage: get_I(ComplexField(256).an_element())\n1.000000000000000000000000000000000000000000000000000000000000000000000000000*I\nsage: parent(_)\nComplex Field with 256 bits of precision\n```",
    "created_at": "2016-05-02T15:21:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368766",
    "user": "https://github.com/videlec"
}
```

<a id='comment:17'></a>Replying to [comment:15 jhonrubia6]:
> I correct myself the crossratio matrix is 
> `<type 'sage.matrix.matrix_generic_dense.Matrix_generic_dense'>` 
> it gets converted to symbolic when multiplied by 
> `B = matrix([[1, 0], [0,I]])` 
> so if we change it to 
> `matrix([[1r,0r],[0r,CC(0,1)]])` 
> we mantain the type to 
> `<type 'sage.matrix.matrix_generic_dense.Matrix_generic_dense'>`
> It is what you are requesting or it you require to get a 
> `<type 'sage.matrix.matrix_complex_double_dense.Matrix_complex_double_dense'>`
> 
> In that case, will we have to construct
> 
> ```
> return matrix(CDF,[[p1 - p2, (p1 - p2)*(-p0)],[p1 - p0, (p1 - p0)*(-p2)]])
> ```
> as mentioned before when the points p1,p2,p3 are instances of [ComplexNumber](ComplexNumber) and leaving as it is in the rest of cases?


It would be bad to use `CC(0,1)` by default for the complex imaginary unit. The only viable solution is to use the base ring of the coordinates

```
def get_I(a):
    from sage.structure.element import Element
    if isinstance(a, complex):
        return complex("j")
    elif isinstance(a, Expression):
        return SR("I")
    elif isinstance(a, Element):
        return a.parent().gen()
    else:
        raise ValueError("not a complex number")
```
It seems to work in most cases

```
sage: get_I(SR(1))
I
sage: parent(_)
Symbolic Ring

sage: get_I(QQbar(1+I))
I
sage: parent(_)
Algebraic Field

sage: get_I(CDF.an_element())
1.0*I
sage: parent(_)
Complex Double Field

sage: get_I(ComplexField(256).an_element())
1.000000000000000000000000000000000000000000000000000000000000000000000000000*I
sage: parent(_)
Complex Field with 256 bits of precision
```



---

archive/issue_comments_368767.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:16 vdelecroix]:\n> Replying to [comment:14 jhonrubia6]:\n> > On a related topic. If I check with number.Complex I get unwanted results as in\n> > \n> > ```\n> > sage: import numbers\n> > sage: from sage.rings.complex_number import ComplexNumber\n> > sage: Q = UHP.get_point(CC(sqrt(2)*(1+I)))\n> > sage: Q.coordinates()\n> > 1.41421356237309 + 1.41421356237309*I\n> > sage: isinstance(Q.coordinates(),numbers.Complex)\n> > False\n> > sage: isinstance(Q.coordinates(),ComplexNumber)\n> > True\n> > ```\n\n> \n> Which version of Sage are you using? On sage-7.2.beta6 complex numbers are perfectly recognized by Python `numbers.Complex`:\n> \n> ```\n> sage: import numbers\n> sage: isinstance(CC(0,1), numbers.Complex)\n> True\n> sage: isinstance(CDF(0,1), numbers.Complex)\n> True\n> ```\n\nI am not at my installation right now (I'll check later). I tried the previous code in cloud.sagemath.com\n\n```\nsage: import numbers\nsage: isinstance(CC(0,1), numbers.Complex)\nFalse\nsage: isinstance(CDF(0,1), numbers.Complex)\nFalse\n```\nBut then, maybe cloud.sagemath.com is not in the appropiate version. As I said I'll check later",
    "created_at": "2016-05-02T15:32:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368767",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

<a id='comment:18'></a>Replying to [comment:16 vdelecroix]:
> Replying to [comment:14 jhonrubia6]:
> > On a related topic. If I check with number.Complex I get unwanted results as in
> > 
> > ```
> > sage: import numbers
> > sage: from sage.rings.complex_number import ComplexNumber
> > sage: Q = UHP.get_point(CC(sqrt(2)*(1+I)))
> > sage: Q.coordinates()
> > 1.41421356237309 + 1.41421356237309*I
> > sage: isinstance(Q.coordinates(),numbers.Complex)
> > False
> > sage: isinstance(Q.coordinates(),ComplexNumber)
> > True
> > ```

> 
> Which version of Sage are you using? On sage-7.2.beta6 complex numbers are perfectly recognized by Python `numbers.Complex`:
> 
> ```
> sage: import numbers
> sage: isinstance(CC(0,1), numbers.Complex)
> True
> sage: isinstance(CDF(0,1), numbers.Complex)
> True
> ```

I am not at my installation right now (I'll check later). I tried the previous code in cloud.sagemath.com

```
sage: import numbers
sage: isinstance(CC(0,1), numbers.Complex)
False
sage: isinstance(CDF(0,1), numbers.Complex)
False
```
But then, maybe cloud.sagemath.com is not in the appropiate version. As I said I'll check later



---

archive/issue_comments_368768.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:17 vdelecroix]:\n> Replying to [comment:15 jhonrubia6]:\n> > I correct myself the crossratio matrix is \n> > `<type 'sage.matrix.matrix_generic_dense.Matrix_generic_dense'>` \n> > it gets converted to symbolic when multiplied by \n> > `B = matrix([[1, 0], [0,I]])` \n> > so if we change it to \n> > `matrix([[1r,0r],[0r,CC(0,1)]])` \n> > we mantain the type to \n> > `<type 'sage.matrix.matrix_generic_dense.Matrix_generic_dense'>`\n> > It is what you are requesting or it you require to get a \n> > `<type 'sage.matrix.matrix_complex_double_dense.Matrix_complex_double_dense'>`\n> > \n> > In that case, will we have to construct\n> > \n> > ```\n> > return matrix(CDF,[[p1 - p2, (p1 - p2)*(-p0)],[p1 - p0, (p1 - p0)*(-p2)]])\n> > ```\n> > as mentioned before when the points p1,p2,p3 are instances of [ComplexNumber](ComplexNumber) and leaving as it is in the rest of cases?\n\n> \n> It would be bad to use `CC(0,1)` by default for the complex imaginary unit. The only viable solution is to use the base ring of the coordinates\n> \n> ```\n> def get_I(a):\n>     from sage.structure.element import Element\n>     if isinstance(a, complex):\n>         return complex(\"j\")\n>     elif isinstance(a, Expression):\n>         return SR(\"I\")\n>     elif isinstance(a, Element):\n>         return a.parent().gen()\n>     else:\n>         raise ValueError(\"not a complex number\")\n> ```\n> It seems to work in most cases\n> \n> ```\n> sage: get_I(SR(1))\n> I\n> sage: parent(_)\n> Symbolic Ring\n> \n> sage: get_I(QQbar(1+I))\n> I\n> sage: parent(_)\n> Algebraic Field\n> \n> sage: get_I(CDF.an_element())\n> 1.0*I\n> sage: parent(_)\n> Complex Double Field\n> \n> sage: get_I(ComplexField(256).an_element())\n> 1.000000000000000000000000000000000000000000000000000000000000000000000000000*I\n> sage: parent(_)\n> Complex Field with 256 bits of precision\n> ```\nUnderstood. I appreciate your insight, I have not the experience in Sage programming to foresee these subleties. I'll introduce your code in the next patch",
    "created_at": "2016-05-02T15:34:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368768",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

<a id='comment:19'></a>Replying to [comment:17 vdelecroix]:
> Replying to [comment:15 jhonrubia6]:
> > I correct myself the crossratio matrix is 
> > `<type 'sage.matrix.matrix_generic_dense.Matrix_generic_dense'>` 
> > it gets converted to symbolic when multiplied by 
> > `B = matrix([[1, 0], [0,I]])` 
> > so if we change it to 
> > `matrix([[1r,0r],[0r,CC(0,1)]])` 
> > we mantain the type to 
> > `<type 'sage.matrix.matrix_generic_dense.Matrix_generic_dense'>`
> > It is what you are requesting or it you require to get a 
> > `<type 'sage.matrix.matrix_complex_double_dense.Matrix_complex_double_dense'>`
> > 
> > In that case, will we have to construct
> > 
> > ```
> > return matrix(CDF,[[p1 - p2, (p1 - p2)*(-p0)],[p1 - p0, (p1 - p0)*(-p2)]])
> > ```
> > as mentioned before when the points p1,p2,p3 are instances of [ComplexNumber](ComplexNumber) and leaving as it is in the rest of cases?

> 
> It would be bad to use `CC(0,1)` by default for the complex imaginary unit. The only viable solution is to use the base ring of the coordinates
> 
> ```
> def get_I(a):
>     from sage.structure.element import Element
>     if isinstance(a, complex):
>         return complex("j")
>     elif isinstance(a, Expression):
>         return SR("I")
>     elif isinstance(a, Element):
>         return a.parent().gen()
>     else:
>         raise ValueError("not a complex number")
> ```
> It seems to work in most cases
> 
> ```
> sage: get_I(SR(1))
> I
> sage: parent(_)
> Symbolic Ring
> 
> sage: get_I(QQbar(1+I))
> I
> sage: parent(_)
> Algebraic Field
> 
> sage: get_I(CDF.an_element())
> 1.0*I
> sage: parent(_)
> Complex Double Field
> 
> sage: get_I(ComplexField(256).an_element())
> 1.000000000000000000000000000000000000000000000000000000000000000000000000000*I
> sage: parent(_)
> Complex Field with 256 bits of precision
> ```
Understood. I appreciate your insight, I have not the experience in Sage programming to foresee these subleties. I'll introduce your code in the next patch



---

archive/issue_comments_368769.json:
```json
{
    "body": "Changing commit from \"89500eb900f245d091afcc4461f4d8f19f6db5b9\" to \"afdf46e9237f644889eb993a6236c31e91c6cf4d\"",
    "created_at": "2016-05-05T21:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368769",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "89500eb900f245d091afcc4461f4d8f19f6db5b9" to "afdf46e9237f644889eb993a6236c31e91c6cf4d"



---

archive/issue_comments_368770.json:
```json
{
    "body": "<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-05-05T21:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368770",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_368771.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Vincent Delecroix\"",
    "created_at": "2016-05-06T01:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368771",
    "user": "https://github.com/videlec"
}
```

Changing reviewer from "" to "Vincent Delecroix"



---

archive/issue_comments_368772.json:
```json
{
    "body": "<a id='comment:21'></a>1. The following syntax is wrong\n\n```\nTESTS::\n\nbla bla.\n\n    sage: one_test()\n```\n  It should be\n\n```\nTESTS:\n\nbla bla.::\n\n    sage: one_test()   \n```\n\n2. You should get rid of trailing whitespaces, that is line that only contains spaces.\n\n3. The `.is_numeric()` method only applies to symbolic expressions. There is something weird with your code `if S[0,0].is_numeric()` since you might also want to manipulate floating point objects.",
    "created_at": "2016-05-06T01:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368772",
    "user": "https://github.com/videlec"
}
```

<a id='comment:21'></a>1. The following syntax is wrong

```
TESTS::

bla bla.

    sage: one_test()
```
  It should be

```
TESTS:

bla bla.::

    sage: one_test()   
```

2. You should get rid of trailing whitespaces, that is line that only contains spaces.

3. The `.is_numeric()` method only applies to symbolic expressions. There is something weird with your code `if S[0,0].is_numeric()` since you might also want to manipulate floating point objects.



---

archive/issue_comments_368773.json:
```json
{
    "body": "Changing commit from \"afdf46e9237f644889eb993a6236c31e91c6cf4d\" to \"663a76cb67fb1598301ce842dccd8341ab07218b\"",
    "created_at": "2016-05-08T11:49:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368773",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "afdf46e9237f644889eb993a6236c31e91c6cf4d" to "663a76cb67fb1598301ce842dccd8341ab07218b"



---

archive/issue_comments_368774.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-05-08T11:49:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368774",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_368775.json:
```json
{
    "body": "<a id='comment:23'></a>I've also modified the doctoring in `_to_std_geod()` method since it randomly failed (depending on the random UHP points, for example:\n\n```\nsage: UHP = HyperbolicPlane().UHP()\nsage: p1=0.869685163129173 + 0.897487924526729*I\nsage: p2=5.71917016919078 + 7.09666543326670*I\nsage: g = UHP.get_geodesic(p1, p2)\nsage: p= g.midpoint().coordinates()\nsage: A = g._to_std_geod(p);A # Send midpoint to I.\nsage: A = UHP.get_isometry(A)\nsage: [s, e]= g.complete().endpoints();s;e;p\nsage: bool(abs(A(s).coordinates()) < 10**-9)\nTrue\nsage: bool(abs(A(g.midpoint()).coordinates() - I) < 10**-9)\nTrue\nsage: bool(A(e).coordinates() == infinity)\nFalse\nsage: bool(abs(A(e).coordinates())>10**9)\nTrue\n```",
    "created_at": "2016-05-08T16:32:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368775",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

<a id='comment:23'></a>I've also modified the doctoring in `_to_std_geod()` method since it randomly failed (depending on the random UHP points, for example:

```
sage: UHP = HyperbolicPlane().UHP()
sage: p1=0.869685163129173 + 0.897487924526729*I
sage: p2=5.71917016919078 + 7.09666543326670*I
sage: g = UHP.get_geodesic(p1, p2)
sage: p= g.midpoint().coordinates()
sage: A = g._to_std_geod(p);A # Send midpoint to I.
sage: A = UHP.get_isometry(A)
sage: [s, e]= g.complete().endpoints();s;e;p
sage: bool(abs(A(s).coordinates()) < 10**-9)
True
sage: bool(abs(A(g.midpoint()).coordinates() - I) < 10**-9)
True
sage: bool(A(e).coordinates() == infinity)
False
sage: bool(abs(A(e).coordinates())>10**9)
True
```



---

archive/issue_comments_368776.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-05-08T16:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368776",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_368777.json:
```json
{
    "body": "<a id='comment:25'></a>- the syntax is for refering to trac tickets is `:trac:`number``\n\n- I don't understand your code. Instead of copy/paste you would better do\n\n```\nif isinstance(S, Matrix_symbolic_dense):\n    S = S.simplify_full()\nS_1 = S.inverse()\n... etc ...\n```",
    "created_at": "2016-05-08T18:22:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368777",
    "user": "https://github.com/videlec"
}
```

<a id='comment:25'></a>- the syntax is for refering to trac tickets is `:trac:`number``

- I don't understand your code. Instead of copy/paste you would better do

```
if isinstance(S, Matrix_symbolic_dense):
    S = S.simplify_full()
S_1 = S.inverse()
... etc ...
```



---

archive/issue_comments_368778.json:
```json
{
    "body": "<a id='comment:26'></a>You might want to add some doctest similar to the following to check that floating points remain floating points in any method.\n\n```\nsage: g = UHP.get_geodesic(CC(0,1), CC(2,2))\nsage: UHP.dist(g.start(), g.end())\n1.45057451382258\nsage: parent(_)\nReal Field with 53 bits of precision\nsage: g.midpoint()\nPoint in UHP 0.666666666666666 + 1.69967317119759*I\nsage: parent(g.midpoint().coordinates())\nComplex Field with 53 bits of precision\nsage: gc = g.complete()\nGeodesic in UHP from -0.265564437074637 to 3.76556443707464\nsage: parent(gc.start().coordinates())\nReal Field with 53 bits of precision\nsage: parent(gc._to_std_geod(g.start().coordinates()))\nFull MatrixSpace of 2 by 2 dense matrices over Complex Field with 53 bits of precision\n```",
    "created_at": "2016-05-08T18:52:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368778",
    "user": "https://github.com/videlec"
}
```

<a id='comment:26'></a>You might want to add some doctest similar to the following to check that floating points remain floating points in any method.

```
sage: g = UHP.get_geodesic(CC(0,1), CC(2,2))
sage: UHP.dist(g.start(), g.end())
1.45057451382258
sage: parent(_)
Real Field with 53 bits of precision
sage: g.midpoint()
Point in UHP 0.666666666666666 + 1.69967317119759*I
sage: parent(g.midpoint().coordinates())
Complex Field with 53 bits of precision
sage: gc = g.complete()
Geodesic in UHP from -0.265564437074637 to 3.76556443707464
sage: parent(gc.start().coordinates())
Real Field with 53 bits of precision
sage: parent(gc._to_std_geod(g.start().coordinates()))
Full MatrixSpace of 2 by 2 dense matrices over Complex Field with 53 bits of precision
```



---

archive/issue_comments_368779.json:
```json
{
    "body": "<a id='comment:27'></a>Ok. I will try, but would it not be better to get its own trac ticket for that?",
    "created_at": "2016-05-08T19:23:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368779",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

<a id='comment:27'></a>Ok. I will try, but would it not be better to get its own trac ticket for that?



---

archive/issue_comments_368780.json:
```json
{
    "body": "Changing commit from \"663a76cb67fb1598301ce842dccd8341ab07218b\" to \"62159c386ed9ea95663b50606ae770f3e1afdbee\"",
    "created_at": "2016-05-08T20:58:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368780",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "663a76cb67fb1598301ce842dccd8341ab07218b" to "62159c386ed9ea95663b50606ae770f3e1afdbee"



---

archive/issue_comments_368781.json:
```json
{
    "body": "<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-05-08T20:58:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368781",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:28'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_368782.json:
```json
{
    "body": "<a id='comment:29'></a>Thanks for incorporing some (unrelated) changes for floating point testing.\n\nThere are still some issues with documentation\n\n- The code in the tests/examples must be indented\n\n```\nTESTS:\n\nThis is a test::\n\n    sage: 1+1\n    2\n```\n  or\n\n```\nTESTS::\n\n    sage: 1+1\n    2\n```\n  (the same holds for EXAMPLES)\n\n- before any test there should be two colons (you forgot some at one place)",
    "created_at": "2016-05-10T04:53:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368782",
    "user": "https://github.com/videlec"
}
```

<a id='comment:29'></a>Thanks for incorporing some (unrelated) changes for floating point testing.

There are still some issues with documentation

- The code in the tests/examples must be indented

```
TESTS:

This is a test::

    sage: 1+1
    2
```
  or

```
TESTS::

    sage: 1+1
    2
```
  (the same holds for EXAMPLES)

- before any test there should be two colons (you forgot some at one place)



---

archive/issue_comments_368783.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-05-10T04:53:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368783",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_368784.json:
```json
{
    "body": "<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-05-10T20:16:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368784",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:30'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_368785.json:
```json
{
    "body": "Changing commit from \"62159c386ed9ea95663b50606ae770f3e1afdbee\" to \"929c7c73d9968adb10414dedf879060eb235728f\"",
    "created_at": "2016-05-10T20:16:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368785",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "62159c386ed9ea95663b50606ae770f3e1afdbee" to "929c7c73d9968adb10414dedf879060eb235728f"



---

archive/issue_comments_368786.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-05-10T20:17:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368786",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_368787.json:
```json
{
    "body": "<a id='comment:31'></a>I tried to fix long lines too (as noted by flake8) , but there are some I do not find a way to reduce, so I left them.",
    "created_at": "2016-05-10T20:17:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368787",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

<a id='comment:31'></a>I tried to fix long lines too (as noted by flake8) , but there are some I do not find a way to reduce, so I left them.



---

archive/issue_comments_368788.json:
```json
{
    "body": "<a id='comment:32'></a>Still some documentation issues\n\n- `:meth:`midpoint()`` should be `:meth`midpoint``.\n\n- before any tests there must be two colons. There is at least one missing occurrence after `... floating points in :meth:`dist()`.`",
    "created_at": "2016-05-12T05:01:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368788",
    "user": "https://github.com/videlec"
}
```

<a id='comment:32'></a>Still some documentation issues

- `:meth:`midpoint()`` should be `:meth`midpoint``.

- before any tests there must be two colons. There is at least one missing occurrence after `... floating points in :meth:`dist()`.`



---

archive/issue_comments_368789.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-05-12T05:01:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368789",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_368790.json:
```json
{
    "body": "Changing commit from \"929c7c73d9968adb10414dedf879060eb235728f\" to \"dd193839547305ed790c523e905c3e3f63ce563a\"",
    "created_at": "2016-05-15T17:02:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368790",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "929c7c73d9968adb10414dedf879060eb235728f" to "dd193839547305ed790c523e905c3e3f63ce563a"



---

archive/issue_comments_368791.json:
```json
{
    "body": "<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-05-15T17:02:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368791",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_368792.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-05-15T17:04:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368792",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_368793.json:
```json
{
    "body": "<a id='comment:34'></a>I think I got them all this time. Used pep8 checkers and a rest online checker.",
    "created_at": "2016-05-15T17:04:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368793",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

<a id='comment:34'></a>I think I got them all this time. Used pep8 checkers and a rest online checker.



---

archive/issue_comments_368794.json:
```json
{
    "body": "<a id='comment:35'></a>Why did you do these kind of changes\n\n```diff\n-#***********************************************************************\n+# ***********************************************************************\n```",
    "created_at": "2016-05-16T23:39:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368794",
    "user": "https://github.com/videlec"
}
```

<a id='comment:35'></a>Why did you do these kind of changes

```diff
-#***********************************************************************
+# ***********************************************************************
```



---

archive/issue_comments_368795.json:
```json
{
    "body": "<a id='comment:36'></a>The line `#********` produced an error \n** E265 block comment should start with '# **'\nin the PEP8 check.\nThe pep8 recommendation says \n\"''Each line of a block comment starts with a # and a single space (unless it is indented text inside the comment).\nParagraphs inside a block comment are separated by a line containing a single # .''\"",
    "created_at": "2016-05-17T18:01:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368795",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

<a id='comment:36'></a>The line `#********` produced an error 
** E265 block comment should start with '# **'
in the PEP8 check.
The pep8 recommendation says 
"''Each line of a block comment starts with a # and a single space (unless it is indented text inside the comment).
Paragraphs inside a block comment are separated by a line containing a single # .''"



---

archive/issue_comments_368796.json:
```json
{
    "body": "<a id='comment:37'></a>As you noticed these are *recommendations*. Everywhere else in Sage, there is no space after the comment (especially in banners). It has to be consistent within Sage source code before being pep8 complient.",
    "created_at": "2016-05-17T18:31:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368796",
    "user": "https://github.com/videlec"
}
```

<a id='comment:37'></a>As you noticed these are *recommendations*. Everywhere else in Sage, there is no space after the comment (especially in banners). It has to be consistent within Sage source code before being pep8 complient.



---

archive/issue_comments_368797.json:
```json
{
    "body": "Changing commit from \"dd193839547305ed790c523e905c3e3f63ce563a\" to \"8fea9c2fd8182498e593fbd2e03e151ebefdbea0\"",
    "created_at": "2016-05-18T17:43:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368797",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "dd193839547305ed790c523e905c3e3f63ce563a" to "8fea9c2fd8182498e593fbd2e03e151ebefdbea0"



---

archive/issue_comments_368798.json:
```json
{
    "body": "<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-05-18T17:43:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368798",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_368799.json:
```json
{
    "body": "<a id='comment:39'></a>Ok. I reverted those changes. What do you think about adding pictures illustrating the geodesics?. If so, I think we have to rename `show` methods by `plot` for `sphinx_plot` to work.",
    "created_at": "2016-05-18T17:46:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368799",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

<a id='comment:39'></a>Ok. I reverted those changes. What do you think about adding pictures illustrating the geodesics?. If so, I think we have to rename `show` methods by `plot` for `sphinx_plot` to work.



---

archive/issue_comments_368800.json:
```json
{
    "body": "<a id='comment:40'></a>It would be nice be open a new ticket for that purpose.",
    "created_at": "2016-05-18T17:48:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368800",
    "user": "https://github.com/videlec"
}
```

<a id='comment:40'></a>It would be nice be open a new ticket for that purpose.



---

archive/issue_comments_368801.json:
```json
{
    "body": "<a id='comment:41'></a>Ok. I've opened #20530 for that.",
    "created_at": "2016-05-18T17:51:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368801",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

<a id='comment:41'></a>Ok. I've opened #20530 for that.



---

archive/issue_comments_368802.json:
```json
{
    "body": "<a id='comment:42'></a>The method `get_B` would be simpler and safer as follows\n\n```\nfrom sage.structure.element import Element\nfrom sage.symbolic.expression import Expression\n\nif isinstance(a, (int,float,complex)):  # Python number\n    a = CDF(a)\n\nif isinstance(a, Expression):           # symbolic\n    P = SR\n    zero = SR.zero()\n    one = SR.one()\n    I = SR(\"I\")\nelif isinstance(a, Element):            # Sage number\n    P = a.parent()\n    zero = P.zero()\n    one = P.one()\n    I = P.gen()\n    if I.is_one() or (I*I).is_one() or not (-I*I).is_one():\n        raise ValueError(\"invalid number\")\nelse:\n    raise ValueError(\"not a complex number\")\n\nreturn matrix(P, 2, [one, zero, zero, -I])\n```",
    "created_at": "2016-05-18T18:14:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368802",
    "user": "https://github.com/videlec"
}
```

<a id='comment:42'></a>The method `get_B` would be simpler and safer as follows

```
from sage.structure.element import Element
from sage.symbolic.expression import Expression

if isinstance(a, (int,float,complex)):  # Python number
    a = CDF(a)

if isinstance(a, Expression):           # symbolic
    P = SR
    zero = SR.zero()
    one = SR.one()
    I = SR("I")
elif isinstance(a, Element):            # Sage number
    P = a.parent()
    zero = P.zero()
    one = P.one()
    I = P.gen()
    if I.is_one() or (I*I).is_one() or not (-I*I).is_one():
        raise ValueError("invalid number")
else:
    raise ValueError("not a complex number")

return matrix(P, 2, [one, zero, zero, -I])
```



---

archive/issue_comments_368803.json:
```json
{
    "body": "Changing commit from \"8fea9c2fd8182498e593fbd2e03e151ebefdbea0\" to \"2ba1c96e25d7e128adc832bc4c4e4c51e8835b98\"",
    "created_at": "2016-05-18T18:31:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368803",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "8fea9c2fd8182498e593fbd2e03e151ebefdbea0" to "2ba1c96e25d7e128adc832bc4c4e4c51e8835b98"



---

archive/issue_comments_368804.json:
```json
{
    "body": "<a id='comment:43'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-05-18T18:31:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368804",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:43'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_368805.json:
```json
{
    "body": "<a id='comment:44'></a>Ok. It seems nicer coding. I think you have contributed more code than me to this ticket Maybe we should exchange roles, put you as author and me as reviewer? ;-)",
    "created_at": "2016-05-18T18:33:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368805",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

<a id='comment:44'></a>Ok. It seems nicer coding. I think you have contributed more code than me to this ticket Maybe we should exchange roles, put you as author and me as reviewer? ;-)



---

archive/issue_comments_368806.json:
```json
{
    "body": "<a id='comment:45'></a>Once you've established which parent P to work over, you need a way to find `I` in there. Just as getting 0, 1, -1 into P is to construct them in the simplest parent (ZZ in this case) and converting them into P via `P(0),P(1),P(-1)`, constructing `I` in P should be a similar procedure. There is one solution that works most of the time via cyclotomic fields: `P(CyclotomicField(4).0)`\nIn a way, if that fails for `P` then `P` is probably not a good parent for this kind of computations.\n\nThere are some numerical noise problems with `CC(CyclotomicField(4),0)` which mightbe worth fixing.\n\nCurrently, `GF(5)(CyclotomicField(4).0)` doesn't work.\n\nCode along these lines could be a lot more robust for new parents than the special-casing approach taken now. I'm not quite sure we have suitable infrastructure for it to use it now, but perhaps we should (the main issue is of course that the choice of I isn't unique, whereas the integers convert uniquely into any integral domain)",
    "created_at": "2016-05-18T19:20:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368806",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:45'></a>Once you've established which parent P to work over, you need a way to find `I` in there. Just as getting 0, 1, -1 into P is to construct them in the simplest parent (ZZ in this case) and converting them into P via `P(0),P(1),P(-1)`, constructing `I` in P should be a similar procedure. There is one solution that works most of the time via cyclotomic fields: `P(CyclotomicField(4).0)`
In a way, if that fails for `P` then `P` is probably not a good parent for this kind of computations.

There are some numerical noise problems with `CC(CyclotomicField(4),0)` which mightbe worth fixing.

Currently, `GF(5)(CyclotomicField(4).0)` doesn't work.

Code along these lines could be a lot more robust for new parents than the special-casing approach taken now. I'm not quite sure we have suitable infrastructure for it to use it now, but perhaps we should (the main issue is of course that the choice of I isn't unique, whereas the integers convert uniquely into any integral domain)



---

archive/issue_comments_368807.json:
```json
{
    "body": "<a id='comment:46'></a>Replying to [comment:45 nbruin]:\n> Once you've established which parent P to work over, you need a way to find `I` in there. Just as getting 0, 1, -1 into P is to construct them in the simplest parent (ZZ in this case) and converting them into P via `P(0),P(1),P(-1)`, constructing `I` in P should be a similar procedure. There is one solution that works most of the time via cyclotomic fields: `P(CyclotomicField(4).0)`\n> In a way, if that fails for `P` then `P` is probably not a good parent for this kind of computations.\n> \n> There are some numerical noise problems with `CC(CyclotomicField(4),0)` which mightbe worth fixing.\n> \n> Currently, `GF(5)(CyclotomicField(4).0)` doesn't work.\n> \n> Code along these lines could be a lot more robust for new parents than the special-casing approach taken now. I'm not quite sure we have suitable infrastructure for it to use it now, but perhaps we should (the main issue is of course that the choice of I isn't unique, whereas the integers convert uniquely into any integral domain)\n\nI am out of my field here, but if I understand you right, are you proposing to replace the elif block proposed by Vincent by something based on the CyclotomicField? Why is it more robust? aside of the problems you mention of `CC(CyclotomicField(4).0)` which may be should be accomplished on a different ticket",
    "created_at": "2016-05-18T19:48:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368807",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

<a id='comment:46'></a>Replying to [comment:45 nbruin]:
> Once you've established which parent P to work over, you need a way to find `I` in there. Just as getting 0, 1, -1 into P is to construct them in the simplest parent (ZZ in this case) and converting them into P via `P(0),P(1),P(-1)`, constructing `I` in P should be a similar procedure. There is one solution that works most of the time via cyclotomic fields: `P(CyclotomicField(4).0)`
> In a way, if that fails for `P` then `P` is probably not a good parent for this kind of computations.
> 
> There are some numerical noise problems with `CC(CyclotomicField(4),0)` which mightbe worth fixing.
> 
> Currently, `GF(5)(CyclotomicField(4).0)` doesn't work.
> 
> Code along these lines could be a lot more robust for new parents than the special-casing approach taken now. I'm not quite sure we have suitable infrastructure for it to use it now, but perhaps we should (the main issue is of course that the choice of I isn't unique, whereas the integers convert uniquely into any integral domain)

I am out of my field here, but if I understand you right, are you proposing to replace the elif block proposed by Vincent by something based on the CyclotomicField? Why is it more robust? aside of the problems you mention of `CC(CyclotomicField(4).0)` which may be should be accomplished on a different ticket



---

archive/issue_comments_368808.json:
```json
{
    "body": "<a id='comment:47'></a>One way to check the sign would be to check the embedding in `CC` as `CC(custom_I) == CC.gen()`.\n\nAnd an other way to find `I` would be `(-P.one()).sqrt()`... but currently there is no specification of this `sqrt` operation and sometimes you get a symbolic element where you do not want to.\n\n```\nsage: (-QQ.one()).sqrt().parent()\nSymbolic Ring\nsage: (-RR.one()).sqrt().parent()\nComplex Field with 53 bits of precision\nsage: (-AA.one()).sqrt().parent()\nAlgebraic Field\nsage: K = QuadraticField(-1)\nsage: (-K.one()).sqrt().parent()\nNumber Field in a with defining polynomial x^2 + 1\nsage: K = QuadraticField(2)\nsage: (-K.one()).sqrt().parent()\nSymbolic Ring\n```\n\nI guess it is reasonable to have a temporary function in `sage/rings/`\n\n```\ndef imaginary_unit(ring):\n    r\"\"\"\n    Return the imaginary unit in ``ring`` or in its algebraic closure if\n    `-1` has no square root.\n\n    If ``ring`` has a defined embedding in some complex field, then the\n    imaginary unit is normalized so that its image in this complex field\n    is its canonical imaginary unit.\n    \"\"\"\n    ...\n```\nWe could make it better later on and possibly remove if we find some other way. At the same time I would advocate that `.sqrt()` should return an element in the same ring or, if it is not possible, in its algebraic closure.",
    "created_at": "2016-05-18T20:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368808",
    "user": "https://github.com/videlec"
}
```

<a id='comment:47'></a>One way to check the sign would be to check the embedding in `CC` as `CC(custom_I) == CC.gen()`.

And an other way to find `I` would be `(-P.one()).sqrt()`... but currently there is no specification of this `sqrt` operation and sometimes you get a symbolic element where you do not want to.

```
sage: (-QQ.one()).sqrt().parent()
Symbolic Ring
sage: (-RR.one()).sqrt().parent()
Complex Field with 53 bits of precision
sage: (-AA.one()).sqrt().parent()
Algebraic Field
sage: K = QuadraticField(-1)
sage: (-K.one()).sqrt().parent()
Number Field in a with defining polynomial x^2 + 1
sage: K = QuadraticField(2)
sage: (-K.one()).sqrt().parent()
Symbolic Ring
```

I guess it is reasonable to have a temporary function in `sage/rings/`

```
def imaginary_unit(ring):
    r"""
    Return the imaginary unit in ``ring`` or in its algebraic closure if
    `-1` has no square root.

    If ``ring`` has a defined embedding in some complex field, then the
    imaginary unit is normalized so that its image in this complex field
    is its canonical imaginary unit.
    """
    ...
```
We could make it better later on and possibly remove if we find some other way. At the same time I would advocate that `.sqrt()` should return an element in the same ring or, if it is not possible, in its algebraic closure.



---

archive/issue_comments_368809.json:
```json
{
    "body": "<a id='comment:48'></a>Replying to [comment:46 jhonrubia6]:\n\n> I am out of my field here, but if I understand you right, are you proposing to replace the elif block proposed by Vincent by something based on the CyclotomicField? Why is it more robust? aside of the problems you mention of `CC(CyclotomicField(4).0)` which may be should be accomplished on a different ticket\n\n\nThere is no particular reason for P.gen(0) to be a fourth root of unity, even if P contains a fourth root of unity. Therefore, the proposed code can easily fail if it doesn't really have to. Hence, it would be nice to express intent a little more explicitly here. For `CyclotomicField(4)` it's clear its generator is a fourth root of unity, so that's a candidate for a \"universal\" place to find such an element. I'm not so sure it's the best place, but it's at least a place to hook into the general conversion infrastructure.",
    "created_at": "2016-05-18T22:39:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368809",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:48'></a>Replying to [comment:46 jhonrubia6]:

> I am out of my field here, but if I understand you right, are you proposing to replace the elif block proposed by Vincent by something based on the CyclotomicField? Why is it more robust? aside of the problems you mention of `CC(CyclotomicField(4).0)` which may be should be accomplished on a different ticket


There is no particular reason for P.gen(0) to be a fourth root of unity, even if P contains a fourth root of unity. Therefore, the proposed code can easily fail if it doesn't really have to. Hence, it would be nice to express intent a little more explicitly here. For `CyclotomicField(4)` it's clear its generator is a fourth root of unity, so that's a candidate for a "universal" place to find such an element. I'm not so sure it's the best place, but it's at least a place to hook into the general conversion infrastructure.



---

archive/issue_comments_368810.json:
```json
{
    "body": "<a id='comment:49'></a>The code\n\n```\nif isinstance(a, (int,float,complex)): # Python number\n            a = CDF(a)\n\n        if isinstance(a, Expression):          # symbolic\n            P = SR\n            zero = SR.zero()\n            one = SR.one()\n            I = SR(\"I\")\n        elif isinstance(a, Element):           # Sage number\n            P = a.parent()\n            zero = P(0)                        # Get 0 in Parent ring\n            one = P(1)                         # Get 1 in Parent ring\n            CF = CyclotomicField(4)            # CF.gen() is guaranteed to be I\n            I = P(CF.gen())                    # Get I in Parent ring\n            # In case there is some numerical 'noise'\n            # e.g. P=CC ; P(CyclotomicField) == 6.123233995736766e-17 + 1.0*I\n            I = 0.5*(I- I.conjugate())\n            if I.is_one() or (I*I).is_one() or not (-I*I).is_one():\n                raise ValueError(\"invalid number\")\n        else:\n            raise ValueError(\"not a complex number\")\n\n        return matrix(P, 2, [one, zero, zero, -I])\n```\nfails when `a = QQbar(1+I)` resulting in\n\n```\nException raised:\n    Traceback (most recent call last):\n...\n    TypeError: Illegal initializer for algebraic number\n```\nThe offending code being the `matrix(P, 2 [one, zero, zero, -I])` \n\n```\nsage: P = QQbar(1+I).parent()\nsage: zero = P(0); one = P(1)\nsage: matrix(P, 2, [one, zero, zero, -P(CyclotomicField(4).gen())])\nException raised:\n    Traceback (most recent call last):\n...\n    TypeError: Illegal initializer for algebraic number\nsage: matrix(P,2,[one,zero,zero,-P.gen()])\n[ 1  0]\n[ 0 -I]\nsage: type(P(CyclotomicField(4).gen()));P(CyclotomicField(4).gen())\n<class 'sage.rings.qqbar.AlgebraicNumber'>\nI\nsage: type(P.gen());P.gen()\n<class 'sage.rings.qqbar.AlgebraicNumber'>\nI\n```\nDo we have to open a ticket for that and leave this stopped or we leave the code as it is in the latest commit make it to the release and wait until the problems with CyclotomicField (numerical noise, and this particular matrix generation) get solved to open a new ticket on this module?\nIMHO , the commit as it is solves the bug of the ticket (not introducing any new one) while both of your ideas go into the direction of a improvement of the code.",
    "created_at": "2016-05-25T19:10:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368810",
    "user": "https://trac.sagemath.org/admin/accounts/users/jhonrubia6"
}
```

<a id='comment:49'></a>The code

```
if isinstance(a, (int,float,complex)): # Python number
            a = CDF(a)

        if isinstance(a, Expression):          # symbolic
            P = SR
            zero = SR.zero()
            one = SR.one()
            I = SR("I")
        elif isinstance(a, Element):           # Sage number
            P = a.parent()
            zero = P(0)                        # Get 0 in Parent ring
            one = P(1)                         # Get 1 in Parent ring
            CF = CyclotomicField(4)            # CF.gen() is guaranteed to be I
            I = P(CF.gen())                    # Get I in Parent ring
            # In case there is some numerical 'noise'
            # e.g. P=CC ; P(CyclotomicField) == 6.123233995736766e-17 + 1.0*I
            I = 0.5*(I- I.conjugate())
            if I.is_one() or (I*I).is_one() or not (-I*I).is_one():
                raise ValueError("invalid number")
        else:
            raise ValueError("not a complex number")

        return matrix(P, 2, [one, zero, zero, -I])
```
fails when `a = QQbar(1+I)` resulting in

```
Exception raised:
    Traceback (most recent call last):
...
    TypeError: Illegal initializer for algebraic number
```
The offending code being the `matrix(P, 2 [one, zero, zero, -I])` 

```
sage: P = QQbar(1+I).parent()
sage: zero = P(0); one = P(1)
sage: matrix(P, 2, [one, zero, zero, -P(CyclotomicField(4).gen())])
Exception raised:
    Traceback (most recent call last):
...
    TypeError: Illegal initializer for algebraic number
sage: matrix(P,2,[one,zero,zero,-P.gen()])
[ 1  0]
[ 0 -I]
sage: type(P(CyclotomicField(4).gen()));P(CyclotomicField(4).gen())
<class 'sage.rings.qqbar.AlgebraicNumber'>
I
sage: type(P.gen());P.gen()
<class 'sage.rings.qqbar.AlgebraicNumber'>
I
```
Do we have to open a ticket for that and leave this stopped or we leave the code as it is in the latest commit make it to the release and wait until the problems with CyclotomicField (numerical noise, and this particular matrix generation) get solved to open a new ticket on this module?
IMHO , the commit as it is solves the bug of the ticket (not introducing any new one) while both of your ideas go into the direction of a improvement of the code.



---

archive/issue_comments_368811.json:
```json
{
    "body": "<a id='comment:50'></a>You are right. We should think about improvements for later tickets! This one already does her part of the job.",
    "created_at": "2016-05-25T20:14:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368811",
    "user": "https://github.com/videlec"
}
```

<a id='comment:50'></a>You are right. We should think about improvements for later tickets! This one already does her part of the job.



---

archive/issue_events_055144.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2016-05-25T20:14:44Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "milestone": "sage-7.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20330#event-55144"
}
```



---

archive/issue_comments_368812.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-05-25T20:14:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368812",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_055145.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-05-26T07:15:22Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20330#event-55145"
}
```



---

archive/issue_comments_368813.json:
```json
{
    "body": "Changing branch from \"u/jhonrubia6/hyperbolic_geodesic_midpoint_bugfix\" to \"2ba1c96e25d7e128adc832bc4c4e4c51e8835b98\"",
    "created_at": "2016-05-26T07:15:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368813",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jhonrubia6/hyperbolic_geodesic_midpoint_bugfix" to "2ba1c96e25d7e128adc832bc4c4e4c51e8835b98"



---

archive/issue_comments_368814.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-05-26T07:15:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20330#issuecomment-368814",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
