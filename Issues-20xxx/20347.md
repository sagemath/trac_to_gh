# Issue 20347: AssertionError in word problem for Farey symbols

archive/issues_020110.json:
```json
{
    "body": "\n```\nsage: G = ArithmeticSubgroup_Permutation(S2=\"(1,2)(3,4)\",S3=\"(1,2,3)\")\nsage: S = G.farey_symbol()\nsage: g1,g2 = S.generators()\nsage: S.word_problem(g1^3 * g2^-2 * g1 * g2)\nTraceback (most recent call last):\n...\nAssertionError: [1, 1, 1, 2, 1, 2]\n[ -5  12]   [  5 -12]\n[-18  43]   [ 18 -43]\n```\nThe two matrices above should be equal but differs by `-1`\n\nCC:  @mmasdeu @loefflerd @JohnCremona xguitart @monien\n\nKeywords: bug\n\nBranch/Commit: f7620dffbd92e05ecbdc42bcddcc62c072d81ef2\n\nReviewer: Vincent Delecroix\n\nAuthor: Marc Masdeu\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20347\n\n",
    "closed_at": "2016-04-08T00:25:44Z",
    "created_at": "2016-04-01T22:45:40Z",
    "labels": [
        "component: group theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "AssertionError in word problem for Farey symbols",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20347",
    "user": "https://github.com/videlec"
}
```

```
sage: G = ArithmeticSubgroup_Permutation(S2="(1,2)(3,4)",S3="(1,2,3)")
sage: S = G.farey_symbol()
sage: g1,g2 = S.generators()
sage: S.word_problem(g1^3 * g2^-2 * g1 * g2)
Traceback (most recent call last):
...
AssertionError: [1, 1, 1, 2, 1, 2]
[ -5  12]   [  5 -12]
[-18  43]   [ 18 -43]
```
The two matrices above should be equal but differs by `-1`

CC:  @mmasdeu @loefflerd @JohnCremona xguitart @monien

Keywords: bug

Branch/Commit: f7620dffbd92e05ecbdc42bcddcc62c072d81ef2

Reviewer: Vincent Delecroix

Author: Marc Masdeu

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/20347





---

archive/issue_comments_369319.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-04-06T13:40:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20347#issuecomment-369319",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_369320.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2016-04-06T13:40:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20347#issuecomment-369320",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_369321.json:
```json
{
    "body": "Changing commit from \"\" to \"492c20d8ede348075e6f15df469b70bcce0929b6\"",
    "created_at": "2016-04-06T13:40:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20347#issuecomment-369321",
    "user": "https://github.com/mmasdeu"
}
```

Changing commit from "" to "492c20d8ede348075e6f15df469b70bcce0929b6"



---

archive/issue_comments_369322.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mmasdeu/20347-farey-bugfix\"",
    "created_at": "2016-04-06T13:40:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20347#issuecomment-369322",
    "user": "https://github.com/mmasdeu"
}
```

Changing branch from "" to "u/mmasdeu/20347-farey-bugfix"



---

archive/issue_comments_369323.json:
```json
{
    "body": "<a id='comment:2'></a>I fixed the bug reported in the ticket. I have tested that it works for Gamma0, Gamma_1, and Gamma for levels up to 20, as well as for the group reported above. Below is the code that I used:\n\n```\nfor N in range(1,20):\n    print 'N = %s'%N\n    for G in [Gamma0, Gamma1, Gamma]:\n        GN = G(N)\n        F = GN.farey_symbol()\n        gens = F.generators()\n        ngens = len(gens)\n        for i in range(200):\n            V = [ZZ.random_element(ngens) for _ in range(100)]\n            g = prod([gens[V[i]] for i in range(len(V))])\n            wd = F.word_problem(g, output = 'syllables')\n            g1 = prod([gens[i].matrix()**a for i,a in wd])\n            if  g.matrix() !=g1:\n                print GN, V, g,g1\n                assert 0\n```\n\nThe reason for the bug was again in some discrepancies in sign that I was ignoring. I try hard to avoid doing the naive trick of keeping track of the matrix that the computed word represents (although this is precisely what the check=True flag does, which is enabled by default) and fixing the sign at the end.",
    "created_at": "2016-04-06T13:45:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20347#issuecomment-369323",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:2'></a>I fixed the bug reported in the ticket. I have tested that it works for Gamma0, Gamma_1, and Gamma for levels up to 20, as well as for the group reported above. Below is the code that I used:

```
for N in range(1,20):
    print 'N = %s'%N
    for G in [Gamma0, Gamma1, Gamma]:
        GN = G(N)
        F = GN.farey_symbol()
        gens = F.generators()
        ngens = len(gens)
        for i in range(200):
            V = [ZZ.random_element(ngens) for _ in range(100)]
            g = prod([gens[V[i]] for i in range(len(V))])
            wd = F.word_problem(g, output = 'syllables')
            g1 = prod([gens[i].matrix()**a for i,a in wd])
            if  g.matrix() !=g1:
                print GN, V, g,g1
                assert 0
```

The reason for the bug was again in some discrepancies in sign that I was ignoring. I try hard to avoid doing the naive trick of keeping track of the matrix that the computed word represents (although this is precisely what the check=True flag does, which is enabled by default) and fixing the sign at the end.



---

archive/issue_comments_369324.json:
```json
{
    "body": "<a id='comment:3'></a>Thanks for looking at it!\n\nIn `_get_minus_one` it would be good to have a doctest for each branch of the `if/else`. And looking at the code we really need a `multiplicative_order` on `SL2Z` elements (see #20373).",
    "created_at": "2016-04-06T17:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20347#issuecomment-369324",
    "user": "https://github.com/videlec"
}
```

<a id='comment:3'></a>Thanks for looking at it!

In `_get_minus_one` it would be good to have a doctest for each branch of the `if/else`. And looking at the code we really need a `multiplicative_order` on `SL2Z` elements (see #20373).



---

archive/issue_comments_369325.json:
```json
{
    "body": "Changing commit from \"492c20d8ede348075e6f15df469b70bcce0929b6\" to \"d4e97c957bb818d1f7e65c91c52aa0484fa606d7\"",
    "created_at": "2016-04-06T22:15:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20347#issuecomment-369325",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "492c20d8ede348075e6f15df469b70bcce0929b6" to "d4e97c957bb818d1f7e65c91c52aa0484fa606d7"



---

archive/issue_comments_369326.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-06T22:15:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20347#issuecomment-369326",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_369327.json:
```json
{
    "body": "<a id='comment:5'></a>I have added more doctests. Also, after looking at #20373 I have improved the logic of the function.",
    "created_at": "2016-04-06T22:16:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20347#issuecomment-369327",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:5'></a>I have added more doctests. Also, after looking at #20373 I have improved the logic of the function.



---

archive/issue_comments_369328.json:
```json
{
    "body": "<a id='comment:6'></a>(just putting your name in Author to make the patchbot happier)",
    "created_at": "2016-04-06T22:34:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20347#issuecomment-369328",
    "user": "https://github.com/videlec"
}
```

<a id='comment:6'></a>(just putting your name in Author to make the patchbot happier)



---

archive/issue_comments_369329.json:
```json
{
    "body": "Changing author from \"\" to \"Marc Masdeu\"",
    "created_at": "2016-04-06T22:34:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20347#issuecomment-369329",
    "user": "https://github.com/videlec"
}
```

Changing author from "" to "Marc Masdeu"



---

archive/issue_comments_369330.json:
```json
{
    "body": "<a id='comment:7'></a>In `_get_dict_of_gens` there is no need to create a variable `ans`. Moreover, are you sure it is now worth it to keep it? The following code is very fast\n\n```\n    gens_dict = {g:i+1 for i,g in enumerate(self.generators())}\n```",
    "created_at": "2016-04-07T15:18:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20347#issuecomment-369330",
    "user": "https://github.com/videlec"
}
```

<a id='comment:7'></a>In `_get_dict_of_gens` there is no need to create a variable `ans`. Moreover, are you sure it is now worth it to keep it? The following code is very fast

```
    gens_dict = {g:i+1 for i,g in enumerate(self.generators())}
```



---

archive/issue_comments_369331.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-07T16:15:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20347#issuecomment-369331",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_369332.json:
```json
{
    "body": "Changing commit from \"d4e97c957bb818d1f7e65c91c52aa0484fa606d7\" to \"f7620dffbd92e05ecbdc42bcddcc62c072d81ef2\"",
    "created_at": "2016-04-07T16:15:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20347#issuecomment-369332",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "d4e97c957bb818d1f7e65c91c52aa0484fa606d7" to "f7620dffbd92e05ecbdc42bcddcc62c072d81ef2"



---

archive/issue_comments_369333.json:
```json
{
    "body": "<a id='comment:9'></a>I think that our time would be best used by performing tests to find bugs in the code. We can discuss about each line in the code if you that's what you want, but I will not modify it anymore unless there is a bug in it.",
    "created_at": "2016-04-07T16:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20347#issuecomment-369333",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:9'></a>I think that our time would be best used by performing tests to find bugs in the code. We can discuss about each line in the code if you that's what you want, but I will not modify it anymore unless there is a bug in it.



---

archive/issue_comments_369334.json:
```json
{
    "body": "<a id='comment:10'></a>Everything is fine as well on some random subgroups obtained with\n\n```\nsage.modular.arithgroup.tests.random_odd_arithgroup\nsage.modular.arithgroup.tests.random_even_arithgroup\n```",
    "created_at": "2016-04-07T17:19:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20347#issuecomment-369334",
    "user": "https://github.com/videlec"
}
```

<a id='comment:10'></a>Everything is fine as well on some random subgroups obtained with

```
sage.modular.arithgroup.tests.random_odd_arithgroup
sage.modular.arithgroup.tests.random_even_arithgroup
```



---

archive/issue_comments_369335.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-04-07T20:16:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20347#issuecomment-369335",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_369336.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Vincent Delecroix\"",
    "created_at": "2016-04-07T20:16:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20347#issuecomment-369336",
    "user": "https://github.com/videlec"
}
```

Changing reviewer from "" to "Vincent Delecroix"



---

archive/issue_comments_369337.json:
```json
{
    "body": "Changing branch from \"u/mmasdeu/20347-farey-bugfix\" to \"f7620dffbd92e05ecbdc42bcddcc62c072d81ef2\"",
    "created_at": "2016-04-08T00:25:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20347#issuecomment-369337",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mmasdeu/20347-farey-bugfix" to "f7620dffbd92e05ecbdc42bcddcc62c072d81ef2"



---

archive/issue_events_055173.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-04-08T00:25:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20347",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20347#event-55173"
}
```



---

archive/issue_comments_369338.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-04-08T00:25:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20347#issuecomment-369338",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
