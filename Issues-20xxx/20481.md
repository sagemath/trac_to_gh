# Issue 20481: Extract source tarballs using permissions from umask

archive/issues_020244.json:
```json
{
    "body": "This is the lowest-hanging fruit in addressing the issues I raised in [this comment](http://trac.sagemath.org/ticket/20218#comment:16).\n\nIt changes `sage-uncompress-spkg` to apply the umask to all files and directories extracted from tarballs.\n\nThis doesn't apply to zipfiles since they do not contain permission information, though in principle we could modify zipfiles to use the same policy. I don't think it matters much though.\n\nBranch/Commit: 4fe154afb48510d212407e5a6c6b560fb91076a5\n\nReviewer: Jeroen Demeyer\n\nAuthor: Erik Bray\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20481\n\n",
    "closed_at": "2016-05-22T21:09:44Z",
    "created_at": "2016-04-21T14:38:13Z",
    "labels": [
        "component: build",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "Extract source tarballs using permissions from umask",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20481",
    "user": "https://github.com/embray"
}
```
This is the lowest-hanging fruit in addressing the issues I raised in [this comment](http://trac.sagemath.org/ticket/20218#comment:16).

It changes `sage-uncompress-spkg` to apply the umask to all files and directories extracted from tarballs.

This doesn't apply to zipfiles since they do not contain permission information, though in principle we could modify zipfiles to use the same policy. I don't think it matters much though.

Branch/Commit: 4fe154afb48510d212407e5a6c6b560fb91076a5

Reviewer: Jeroen Demeyer

Author: Erik Bray

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/20481





---

archive/issue_comments_278610.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-04-21T14:38:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-278610",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_278611.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-04-21T15:09:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-278611",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_278612.json:
```json
{
    "body": "<a id='comment:2'></a>Instead of ignoring permissions for dirs, would it be possible to simply apply the user's umask on everything which gets extracted (files and directories). This would mean changing `tarinfo.mode` to `tarinfo.mode & CURRENT_UMASK`.",
    "created_at": "2016-04-21T15:09:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-278612",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>Instead of ignoring permissions for dirs, would it be possible to simply apply the user's umask on everything which gets extracted (files and directories). This would mean changing `tarinfo.mode` to `tarinfo.mode & CURRENT_UMASK`.



---

archive/issue_comments_278613.json:
```json
{
    "body": "<a id='comment:3'></a>That was my first thought actually. I'd be fine with that too--this was just infinitesimally simpler :)",
    "created_at": "2016-04-21T15:17:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-278613",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>That was my first thought actually. I'd be fine with that too--this was just infinitesimally simpler :)



---

archive/issue_comments_278614.json:
```json
{
    "body": "<a id='comment:4'></a>Perhaps one reason *not* to prefer that is that if the umask is set to something useless then then applying it would be no less \"safe\".  As it is this is only \"unsafe\" in the context of moving the extracted directory to someplace like /tmp.  But it seems more reliable not to rely on the user's umask.",
    "created_at": "2016-04-21T15:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-278614",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>Perhaps one reason *not* to prefer that is that if the umask is set to something useless then then applying it would be no less "safe".  As it is this is only "unsafe" in the context of moving the extracted directory to someplace like /tmp.  But it seems more reliable not to rely on the user's umask.



---

archive/issue_comments_278615.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 embray]:\n> Perhaps one reason *not* to prefer that is that if the umask is set to something useless then then applying it would be no less \"safe\".\n\n\nI would say that the `umask` *defines* what is safe. It is the thing which determines which permissions the user wants.",
    "created_at": "2016-04-21T15:26:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-278615",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>Replying to [comment:4 embray]:
> Perhaps one reason *not* to prefer that is that if the umask is set to something useless then then applying it would be no less "safe".


I would say that the `umask` *defines* what is safe. It is the thing which determines which permissions the user wants.



---

archive/issue_comments_278616.json:
```json
{
    "body": "<a id='comment:6'></a>0700 would break the cell server which uses a separate worker account and in general would not work for multiuser setup. Or am I missing the point? It also seems to me that using `umask` is just the right way for defaults in any case. Those who are not happy with `umask` can either adjust it or set some restrictive permission on a containing directory.",
    "created_at": "2016-04-21T17:16:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-278616",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:6'></a>0700 would break the cell server which uses a separate worker account and in general would not work for multiuser setup. Or am I missing the point? It also seems to me that using `umask` is just the right way for defaults in any case. Those who are not happy with `umask` can either adjust it or set some restrictive permission on a containing directory.



---

archive/issue_comments_278617.json:
```json
{
    "body": "<a id='comment:7'></a>I agree that building with too restrictive permissions could give problems. Some installation scripts probably just copy the directory over without changing the permissions. So `0700` is certainly too restrictive for that to work.",
    "created_at": "2016-04-21T20:38:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-278617",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>I agree that building with too restrictive permissions could give problems. Some installation scripts probably just copy the directory over without changing the permissions. So `0700` is certainly too restrictive for that to work.



---

archive/issue_comments_278618.json:
```json
{
    "body": "<a id='comment:8'></a>Okay then, umask it is.  I'll update this next week.",
    "created_at": "2016-04-22T13:39:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-278618",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>Okay then, umask it is.  I'll update this next week.



---

archive/issue_comments_278619.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-27T14:05:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-278619",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_278620.json:
```json
{
    "body": "<a id='comment:10'></a>As discussed, now the customized `TarFile` subclass merely applies the user's umask to all extracted files.",
    "created_at": "2016-04-27T14:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-278620",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>As discussed, now the customized `TarFile` subclass merely applies the user's umask to all extracted files.



---

archive/issue_comments_278621.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-04-27T14:12:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-278621",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_events_055370.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-05-13T15:00:19Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "milestone": "sage-7.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20481#event-55370"
}
```



---

archive/issue_comments_278622.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-05-13T15:00:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-278622",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_055371.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-05-22T21:09:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20481#event-55371"
}
```



---

archive/issue_comments_278623.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-05-22T21:09:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-278623",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
