# Issue 20481: Extract source tarballs using permissions from umask

archive/issues_020244.json:
```json
{
    "body": "This is the lowest-hanging fruit in addressing the issues I raised in [this comment](http://trac.sagemath.org/ticket/20218#comment:16).\n\nIt changes `sage-uncompress-spkg` to apply the umask to all files and directories extracted from tarballs.\n\nThis doesn't apply to zipfiles since they do not contain permission information, though in principle we could modify zipfiles to use the same policy. I don't think it matters much though.\n\nBranch/Commit: [4fe154afb48510d212407e5a6c6b560fb91076a5](https://github.com/sagemath/sagetrac-mirror/commit/4fe154afb48510d212407e5a6c6b560fb91076a5)\n\nReviewer: Jeroen Demeyer\n\nAuthor: Erik Bray\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20481\n\n",
    "closed_at": "2016-05-22T21:09:44Z",
    "created_at": "2016-04-21T14:38:13Z",
    "labels": [
        "component: build",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "Extract source tarballs using permissions from umask",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20481",
    "user": "https://github.com/embray"
}
```
This is the lowest-hanging fruit in addressing the issues I raised in [this comment](http://trac.sagemath.org/ticket/20218#comment:16).

It changes `sage-uncompress-spkg` to apply the umask to all files and directories extracted from tarballs.

This doesn't apply to zipfiles since they do not contain permission information, though in principle we could modify zipfiles to use the same policy. I don't think it matters much though.

Branch/Commit: [4fe154afb48510d212407e5a6c6b560fb91076a5](https://github.com/sagemath/sagetrac-mirror/commit/4fe154afb48510d212407e5a6c6b560fb91076a5)

Reviewer: Jeroen Demeyer

Author: Erik Bray

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/20481





---

archive/issue_comments_375028.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-04-21T14:38:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-375028",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_375029.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jeroen Demeyer\"",
    "created_at": "2016-04-21T15:09:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-375029",
    "user": "https://github.com/jdemeyer"
}
```

Changing reviewer from "" to "Jeroen Demeyer"



---

archive/issue_comments_375030.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-04-21T15:09:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-375030",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_375031.json:
```json
{
    "body": "<a id='comment:2'></a>\nInstead of ignoring permissions for dirs, would it be possible to simply apply the user's umask on everything which gets extracted (files and directories). This would mean changing `tarinfo.mode` to `tarinfo.mode & CURRENT_UMASK`.",
    "created_at": "2016-04-21T15:09:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-375031",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>
Instead of ignoring permissions for dirs, would it be possible to simply apply the user's umask on everything which gets extracted (files and directories). This would mean changing `tarinfo.mode` to `tarinfo.mode & CURRENT_UMASK`.



---

archive/issue_comments_375032.json:
```json
{
    "body": "<a id='comment:3'></a>\nThat was my first thought actually. I'd be fine with that too--this was just infinitesimally simpler :)",
    "created_at": "2016-04-21T15:17:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-375032",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
That was my first thought actually. I'd be fine with that too--this was just infinitesimally simpler :)



---

archive/issue_comments_375033.json:
```json
{
    "body": "<a id='comment:4'></a>\nPerhaps one reason *not* to prefer that is that if the umask is set to something useless then then applying it would be no less \"safe\".  As it is this is only \"unsafe\" in the context of moving the extracted directory to someplace like /tmp.  But it seems more reliable not to rely on the user's umask.",
    "created_at": "2016-04-21T15:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-375033",
    "user": "https://github.com/embray"
}
```

<a id='comment:4'></a>
Perhaps one reason *not* to prefer that is that if the umask is set to something useless then then applying it would be no less "safe".  As it is this is only "unsafe" in the context of moving the extracted directory to someplace like /tmp.  But it seems more reliable not to rely on the user's umask.



---

archive/issue_comments_375034.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [embray](#comment%3A4):\n> Perhaps one reason *not* to prefer that is that if the umask is set to something useless then then applying it would be no less \"safe\".\n\n\nI would say that the `umask` *defines* what is safe. It is the thing which determines which permissions the user wants.",
    "created_at": "2016-04-21T15:26:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-375034",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
Replying to [embray](#comment%3A4):
> Perhaps one reason *not* to prefer that is that if the umask is set to something useless then then applying it would be no less "safe".


I would say that the `umask` *defines* what is safe. It is the thing which determines which permissions the user wants.



---

archive/issue_comments_375035.json:
```json
{
    "body": "<a id='comment:6'></a>\n0700 would break the cell server which uses a separate worker account and in general would not work for multiuser setup. Or am I missing the point? It also seems to me that using `umask` is just the right way for defaults in any case. Those who are not happy with `umask` can either adjust it or set some restrictive permission on a containing directory.",
    "created_at": "2016-04-21T17:16:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-375035",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:6'></a>
0700 would break the cell server which uses a separate worker account and in general would not work for multiuser setup. Or am I missing the point? It also seems to me that using `umask` is just the right way for defaults in any case. Those who are not happy with `umask` can either adjust it or set some restrictive permission on a containing directory.



---

archive/issue_comments_375036.json:
```json
{
    "body": "<a id='comment:7'></a>\nI agree that building with too restrictive permissions could give problems. Some installation scripts probably just copy the directory over without changing the permissions. So `0700` is certainly too restrictive for that to work.",
    "created_at": "2016-04-21T20:38:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-375036",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'></a>
I agree that building with too restrictive permissions could give problems. Some installation scripts probably just copy the directory over without changing the permissions. So `0700` is certainly too restrictive for that to work.



---

archive/issue_comments_375037.json:
```json
{
    "body": "<a id='comment:8'></a>\nOkay then, umask it is.  I'll update this next week.",
    "created_at": "2016-04-22T13:39:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-375037",
    "user": "https://github.com/embray"
}
```

<a id='comment:8'></a>
Okay then, umask it is.  I'll update this next week.



---

archive/issue_comments_375038.json:
```json
{
    "body": "Changing commit from \"d2d0d740f933468ba4d6cbfaba1488f3423d5679\" to \"4fe154afb48510d212407e5a6c6b560fb91076a5\"",
    "created_at": "2016-04-27T14:05:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-375038",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "d2d0d740f933468ba4d6cbfaba1488f3423d5679" to "4fe154afb48510d212407e5a6c6b560fb91076a5"



---

archive/issue_comments_375039.json:
```json
{
    "body": "<a id='comment:9'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                                                                                                                                                      |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n|[4fe154a](https://github.com/sagemath/sagetrac-mirror/commit/4fe154afb48510d212407e5a6c6b560fb91076a5)|`Modified the custom TarFile to simply apply the user's umask to all files and directories, regardless what it may be--consistent with the default behavior of 'tar'.`|",
    "created_at": "2016-04-27T14:05:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-375039",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                                                                                                                                                      |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|[4fe154a](https://github.com/sagemath/sagetrac-mirror/commit/4fe154afb48510d212407e5a6c6b560fb91076a5)|`Modified the custom TarFile to simply apply the user's umask to all files and directories, regardless what it may be--consistent with the default behavior of 'tar'.`|



---

archive/issue_comments_375040.json:
```json
{
    "body": "<a id='comment:10'></a>\nAs discussed, now the customized `TarFile` subclass merely applies the user's umask to all extracted files.",
    "created_at": "2016-04-27T14:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-375040",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>
As discussed, now the customized `TarFile` subclass merely applies the user's umask to all extracted files.



---

archive/issue_comments_375041.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-04-27T14:12:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-375041",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_events_062961.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-05-13T15:00:19Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "milestone": "sage-7.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20481#event-62961"
}
```



---

archive/issue_comments_375042.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,5 +1,5 @@\n This is the lowest-hanging fruit in addressing the issues I raised in [this comment](http://trac.sagemath.org/ticket/20218#comment:16).\n \n-It changes `sage-uncompress-spkg` to apply mode 700 to all directories extracted from tarballs.  Original permissions are preserved for plain files.  Are there any odd packages this would cause an issue for?\n+It changes `sage-uncompress-spkg` to apply the umask to all files and directories extracted from tarballs.\n \n-This doesn't apply to zipfiles since they do not contain permission information, though in principle we could modify zipfiles to use the same policy wrt directories. I don't think it matters much though.\n+This doesn't apply to zipfiles since they do not contain permission information, though in principle we could modify zipfiles to use the same policy. I don't think it matters much though.\n``````\n",
    "created_at": "2016-05-13T15:00:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-375042",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,5 +1,5 @@
 This is the lowest-hanging fruit in addressing the issues I raised in [this comment](http://trac.sagemath.org/ticket/20218#comment:16).
 
-It changes `sage-uncompress-spkg` to apply mode 700 to all directories extracted from tarballs.  Original permissions are preserved for plain files.  Are there any odd packages this would cause an issue for?
+It changes `sage-uncompress-spkg` to apply the umask to all files and directories extracted from tarballs.
 
-This doesn't apply to zipfiles since they do not contain permission information, though in principle we could modify zipfiles to use the same policy wrt directories. I don't think it matters much though.
+This doesn't apply to zipfiles since they do not contain permission information, though in principle we could modify zipfiles to use the same policy. I don't think it matters much though.
``````




---

archive/issue_events_062962.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "rename": {
        "from": "Extract source tarballs using more restrictive permissions on directories",
        "to": "Extract source tarballs using permissions from umask"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20481#event-62962"
}
```



---

archive/issue_comments_375043.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-05-13T15:00:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-375043",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_062963.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-05-22T21:09:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20481#event-62963"
}
```



---

archive/issue_comments_375044.json:
```json
{
    "body": "Changing branch from \"u/embray/uncompress-permissions\" to \"4fe154afb48510d212407e5a6c6b560fb91076a5\"",
    "created_at": "2016-05-22T21:09:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-375044",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/embray/uncompress-permissions" to "4fe154afb48510d212407e5a6c6b560fb91076a5"



---

archive/issue_comments_375045.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-05-22T21:09:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20481",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20481#issuecomment-375045",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
