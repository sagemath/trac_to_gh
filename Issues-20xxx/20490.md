# Issue 20490: Hash error with multivariate Laurent polynomial rings

archive/issues_020253.json:
```json
{
    "body": "We do not have equality implying equality of hashes for multivariate Laurent polynomial rings:\n\n```\nsage: R.<a,b> = LaurentPolynomialRing(ZZ)\nsage: elt = (a + b) * (~a + ~b) - a*~b - ~a*b - 1\nsage: elt == R.one()\nTrue\nsage: hash(elt) == hash(R.one())\nFalse\n```\n\nAssignee: @tscrim\n\nKeywords: hash, multivariate Laurent polynomials\n\nBranch/Commit: 792d3a0dc1530178d12600cc02115937ae2dec56\n\nReviewer: David Roe\n\nAuthor: Travis Scrimshaw\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20490\n\n",
    "closed_at": "2016-04-25T08:38:19Z",
    "created_at": "2016-04-23T05:15:06Z",
    "labels": [
        "component: misc",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "Hash error with multivariate Laurent polynomial rings",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20490",
    "user": "https://github.com/tscrim"
}
```
We do not have equality implying equality of hashes for multivariate Laurent polynomial rings:

```
sage: R.<a,b> = LaurentPolynomialRing(ZZ)
sage: elt = (a + b) * (~a + ~b) - a*~b - ~a*b - 1
sage: elt == R.one()
True
sage: hash(elt) == hash(R.one())
False
```

Assignee: @tscrim

Keywords: hash, multivariate Laurent polynomials

Branch/Commit: 792d3a0dc1530178d12600cc02115937ae2dec56

Reviewer: David Roe

Author: Travis Scrimshaw

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/20490





---

archive/issue_comments_372104.json:
```json
{
    "body": "<a id='comment:1'></a>\nThe problem is that the hash function takes `elt._mon` into account: internally `elt` is represented as `ab/ab` while `R.one()` is represented as `1/1`.\n\n```\nsage: elt._fraction_pair()\n(a*b, a*b)\nsage: R.one()._fraction_pair()\n(1, 1)\n```\nThe problem is solved in this case by manually calling `_normalize()`:\n\n```\nsage: elt._normalize()\nsage: elt._fraction_pair()\n(1, 1)\nsage: hash(elt) == hash(R.one())\nTrue\n```\n\nWriting hash functions is hard....",
    "created_at": "2016-04-23T06:20:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20490#issuecomment-372104",
    "user": "https://github.com/roed314"
}
```

<a id='comment:1'></a>
The problem is that the hash function takes `elt._mon` into account: internally `elt` is represented as `ab/ab` while `R.one()` is represented as `1/1`.

```
sage: elt._fraction_pair()
(a*b, a*b)
sage: R.one()._fraction_pair()
(1, 1)
```
The problem is solved in this case by manually calling `_normalize()`:

```
sage: elt._normalize()
sage: elt._fraction_pair()
(1, 1)
sage: hash(elt) == hash(R.one())
True
```

Writing hash functions is hard....



---

archive/issue_comments_372105.json:
```json
{
    "body": "Changing branch from \"\" to \"public/rings/hash_laurent_polynomial_ring-20490\"",
    "created_at": "2016-04-23T15:52:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20490#issuecomment-372105",
    "user": "https://github.com/tscrim"
}
```

Changing branch from "" to "public/rings/hash_laurent_polynomial_ring-20490"



---

archive/issue_comments_372106.json:
```json
{
    "body": "Changing commit from \"\" to \"d52cd769c5c1dbe795914b5aa1a5f52367bafa7e\"",
    "created_at": "2016-04-23T15:52:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20490#issuecomment-372106",
    "user": "https://github.com/tscrim"
}
```

Changing commit from "" to "d52cd769c5c1dbe795914b5aa1a5f52367bafa7e"



---

archive/issue_comments_372107.json:
```json
{
    "body": "<a id='comment:2'></a>\nThanks. That indeed did solve the problem.\n\nWith branch:\n\n```\nsage: R.<a,b> = LaurentPolynomialRing(ZZ)\nsage: p = (a + b + ~b + 1)^10\nsage: %timeit hash(p)\n10000 loops, best of 3: 170 \u00b5s per loop\n```\n(without the cython changes is ~180 \u00b5s)\nvs old version:\n\n```\nsage: p = (a + b + ~b + 1)^10\nsage: %timeit hash(p)\n10000 loops, best of 3: 34.2 \u00b5s per loop\n```\nNote that `p` has 121 terms with an upper degree of 10 and a lower degree of -10. The fact that we only get ~6x slowdown here is acceptable to me. (There's likely more speed to be gained from doing more cythonization of the internal methods of the (Laurent) multivariate polynomials.)\n\n---\nNew commits:\n|                                                                                                                                          |                                                               |\n|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|\n|[792d3a0](http://git.sagemath.org/sage.git/commit/?id=792d3a0dc1530178d12600cc02115937ae2dec56)|`Fixing the hash function of multivariate Laurent polynomials.`|\n|[d52cd76](http://git.sagemath.org/sage.git/commit/?id=d52cd769c5c1dbe795914b5aa1a5f52367bafa7e)|`Making some methods of multivariate polynomials cpdef.`|",
    "created_at": "2016-04-23T15:52:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20490#issuecomment-372107",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:2'></a>
Thanks. That indeed did solve the problem.

With branch:

```
sage: R.<a,b> = LaurentPolynomialRing(ZZ)
sage: p = (a + b + ~b + 1)^10
sage: %timeit hash(p)
10000 loops, best of 3: 170 µs per loop
```
(without the cython changes is ~180 µs)
vs old version:

```
sage: p = (a + b + ~b + 1)^10
sage: %timeit hash(p)
10000 loops, best of 3: 34.2 µs per loop
```
Note that `p` has 121 terms with an upper degree of 10 and a lower degree of -10. The fact that we only get ~6x slowdown here is acceptable to me. (There's likely more speed to be gained from doing more cythonization of the internal methods of the (Laurent) multivariate polynomials.)

---
New commits:
|                                                                                                                                          |                                                               |
|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|
|[792d3a0](http://git.sagemath.org/sage.git/commit/?id=792d3a0dc1530178d12600cc02115937ae2dec56)|`Fixing the hash function of multivariate Laurent polynomials.`|
|[d52cd76](http://git.sagemath.org/sage.git/commit/?id=d52cd769c5c1dbe795914b5aa1a5f52367bafa7e)|`Making some methods of multivariate polynomials cpdef.`|



---

archive/issue_comments_372108.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-04-23T15:52:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20490#issuecomment-372108",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_372109.json:
```json
{
    "body": "Changing author from \"\" to \"Travis Scrimshaw\"",
    "created_at": "2016-04-23T15:52:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20490#issuecomment-372109",
    "user": "https://github.com/tscrim"
}
```

Changing author from "" to "Travis Scrimshaw"



---

archive/issue_comments_372110.json:
```json
{
    "body": "<a id='comment:3'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-04-23T21:50:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20490#issuecomment-372110",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_372111.json:
```json
{
    "body": "Changing commit from \"d52cd769c5c1dbe795914b5aa1a5f52367bafa7e\" to \"792d3a0dc1530178d12600cc02115937ae2dec56\"",
    "created_at": "2016-04-23T21:50:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20490#issuecomment-372111",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "d52cd769c5c1dbe795914b5aa1a5f52367bafa7e" to "792d3a0dc1530178d12600cc02115937ae2dec56"



---

archive/issue_comments_372112.json:
```json
{
    "body": "<a id='comment:4'></a>\nSo there were issues with my cythonization. The easiest thing to do was to revert back to 792d3a0.",
    "created_at": "2016-04-23T21:51:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20490#issuecomment-372112",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>
So there were issues with my cythonization. The easiest thing to do was to revert back to 792d3a0.



---

archive/issue_comments_372113.json:
```json
{
    "body": "Changing reviewer from \"\" to \"David Roe\"",
    "created_at": "2016-04-24T00:52:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20490#issuecomment-372113",
    "user": "https://github.com/roed314"
}
```

Changing reviewer from "" to "David Roe"



---

archive/issue_comments_372114.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-04-24T00:52:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20490#issuecomment-372114",
    "user": "https://github.com/roed314"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_372115.json:
```json
{
    "body": "<a id='comment:5'></a>\nYeah, this seems like a reasonable fix, though certainly more improvements could be made.",
    "created_at": "2016-04-24T00:52:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20490#issuecomment-372115",
    "user": "https://github.com/roed314"
}
```

<a id='comment:5'></a>
Yeah, this seems like a reasonable fix, though certainly more improvements could be made.



---

archive/issue_comments_372116.json:
```json
{
    "body": "Changing branch from \"public/rings/hash_laurent_polynomial_ring-20490\" to \"792d3a0dc1530178d12600cc02115937ae2dec56\"",
    "created_at": "2016-04-25T08:38:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20490#issuecomment-372116",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/rings/hash_laurent_polynomial_ring-20490" to "792d3a0dc1530178d12600cc02115937ae2dec56"



---

archive/issue_comments_372117.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-04-25T08:38:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20490",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20490#issuecomment-372117",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_055385.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-04-25T08:38:19Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20490",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20490#event-55385"
}
```
