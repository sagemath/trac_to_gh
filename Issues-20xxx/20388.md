# Issue 20388: Fix the Magma interface to work with remote installations

archive/issues_020151.json:
```json
{
    "body": "I have frequently encountered computer setups where one has access to a Sage installation locally, but Magma is only installed in a remote machine (say with address 'remote'). Typically one either:\n1) Logs into 'remote' via ssh and does some computation in Magma.\n2) uses the ssh command\n\n```\n    $> ssh -t remote 'magma'\n```\nto pretend having magma installed locally.\n\nActually Sage has functionality to use (2) in its interface with Magma, but it is currently broken and not advertised. It presumes that 'remote' also has sage installed (in fact it presumes that sage-native-execute is in the default PATH), for example.\n\nThis ticket fixes this, and makes a command like\n\n```\n    sage: magma = Magma(server = 'remote', command = 'magma-myversion')\n```\nwork, and provide the user with an interface to a particular version of Magma installed in 'remote'.\n\nKeywords: magma, remote\n\nBranch/Commit: f4996488101ac3ce85550fb14b2eec08185408a6\n\nReviewer: Nils Bruin, Vincent Delecroix\n\nAuthor: Marc Masdeu\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20388\n\n",
    "closed_at": "2016-04-16T10:25:59Z",
    "created_at": "2016-04-08T12:01:16Z",
    "labels": [
        "component: interfaces: optional",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "Fix the Magma interface to work with remote installations",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20388",
    "user": "https://github.com/mmasdeu"
}
```
I have frequently encountered computer setups where one has access to a Sage installation locally, but Magma is only installed in a remote machine (say with address 'remote'). Typically one either:
1) Logs into 'remote' via ssh and does some computation in Magma.
2) uses the ssh command

```
    $> ssh -t remote 'magma'
```
to pretend having magma installed locally.

Actually Sage has functionality to use (2) in its interface with Magma, but it is currently broken and not advertised. It presumes that 'remote' also has sage installed (in fact it presumes that sage-native-execute is in the default PATH), for example.

This ticket fixes this, and makes a command like

```
    sage: magma = Magma(server = 'remote', command = 'magma-myversion')
```
work, and provide the user with an interface to a particular version of Magma installed in 'remote'.

Keywords: magma, remote

Branch/Commit: f4996488101ac3ce85550fb14b2eec08185408a6

Reviewer: Nils Bruin, Vincent Delecroix

Author: Marc Masdeu

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/20388





---

archive/issue_comments_295718.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-04-08T12:02:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295718",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_295719.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2016-04-08T12:02:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295719",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_295720.json:
```json
{
    "body": "<a id='comment:2'></a>I was able to use it! Note that on the server I have access to I need two commands to launch magma\n\n```\n$ module load magma/2.11.13    # Slurm\n$ magma\n```\nAnd `Magma(server='plafrim', command='module load magma/2.11.13; magma')` worked perfectly. Do you think it is worth it to add in the doc?\n\n**Sided note:** Would be nice for users to set up their configurations once for all for these external interfaces (via environment variables?). For example, I have access to maple and magma but they live on two different servers.",
    "created_at": "2016-04-11T17:02:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295720",
    "user": "https://github.com/videlec"
}
```

<a id='comment:2'></a>I was able to use it! Note that on the server I have access to I need two commands to launch magma

```
$ module load magma/2.11.13    # Slurm
$ magma
```
And `Magma(server='plafrim', command='module load magma/2.11.13; magma')` worked perfectly. Do you think it is worth it to add in the doc?

**Sided note:** Would be nice for users to set up their configurations once for all for these external interfaces (via environment variables?). For example, I have access to maple and magma but they live on two different servers.



---

archive/issue_comments_295721.json:
```json
{
    "body": "<a id='comment:3'></a>That's great! I added the 'command' parameter because it could be potentially useful although I didn't need it. I am happy to see that my guess was correct.\n\nAbout setting defaults, have you tried to put\n\n```\nmagma = Magma(server='plafrim', command='module load magma/2.11.13; magma')\nmaple = (whatever is pertinent, I don't have access to maple)\n```\nin $HOME/.sage/init.sage?\n\nFinally, although I agree that the documentation should advertise more this feature, I don't know where to put it exactly.",
    "created_at": "2016-04-11T17:13:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295721",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:3'></a>That's great! I added the 'command' parameter because it could be potentially useful although I didn't need it. I am happy to see that my guess was correct.

About setting defaults, have you tried to put

```
magma = Magma(server='plafrim', command='module load magma/2.11.13; magma')
maple = (whatever is pertinent, I don't have access to maple)
```
in $HOME/.sage/init.sage?

Finally, although I agree that the documentation should advertise more this feature, I don't know where to put it exactly.



---

archive/issue_comments_295722.json:
```json
{
    "body": "<a id='comment:4'></a>Setting them in `init.sage` is indeed a solution to make `magma(something)` works out of the box.\n\nMy question about default configuration did not make much sense since I thought that `SageObject` would have methods `_magma_` and `_maple_`. If it was\n\n```\n    def _magma_(self, G=None):\n        if G is None:\n            import sage.interfaces.magma\n            G = sage.interfaces.magma.magma\n        return self._interface_(G)\n```\nthen it would not take into account any specific server configuration.",
    "created_at": "2016-04-11T17:29:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295722",
    "user": "https://github.com/videlec"
}
```

<a id='comment:4'></a>Setting them in `init.sage` is indeed a solution to make `magma(something)` works out of the box.

My question about default configuration did not make much sense since I thought that `SageObject` would have methods `_magma_` and `_maple_`. If it was

```
    def _magma_(self, G=None):
        if G is None:
            import sage.interfaces.magma
            G = sage.interfaces.magma.magma
        return self._interface_(G)
```
then it would not take into account any specific server configuration.



---

archive/issue_comments_295723.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-11T17:51:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295723",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_295724.json:
```json
{
    "body": "<a id='comment:6'></a>Thanks for testing it! I found two functions (one in arith.all, one in plane_conics/con_field.py) that imported magma. I have changed them to try to use the global magma if it exists (which should be the case if the user initialized it, anyway).",
    "created_at": "2016-04-11T17:53:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295724",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:6'></a>Thanks for testing it! I found two functions (one in arith.all, one in plane_conics/con_field.py) that imported magma. I have changed them to try to use the global magma if it exists (which should be the case if the user initialized it, anyway).



---

archive/issue_comments_295725.json:
```json
{
    "body": "<a id='comment:7'></a>A few things you might want to look at:\n- sage's pexpect interfaces have an option to use files for transfer if the input is large. That's going it be an issue, because in your scenario you wouldn't want to assume sage and (remote) magma have access to a shared file system. So you might have to turn this capability off.\n- You're now assuming that the remote magma user has permission to do an \"scp\" to the remote server. Indeed, the way we currently have written `ext/magma` requires file access (it's written as a module). However, one could put those files within reach of magma via other means. The \"scp\" variant possibly works quite often, so it may be a reasonable default thing to try, but we should probably not fail if it doesn't work.",
    "created_at": "2016-04-11T18:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295725",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:7'></a>A few things you might want to look at:
- sage's pexpect interfaces have an option to use files for transfer if the input is large. That's going it be an issue, because in your scenario you wouldn't want to assume sage and (remote) magma have access to a shared file system. So you might have to turn this capability off.
- You're now assuming that the remote magma user has permission to do an "scp" to the remote server. Indeed, the way we currently have written `ext/magma` requires file access (it's written as a module). However, one could put those files within reach of magma via other means. The "scp" variant possibly works quite often, so it may be a reasonable default thing to try, but we should probably not fail if it doesn't work.



---

archive/issue_comments_295726.json:
```json
{
    "body": "<a id='comment:8'></a>Relying on `globals` is not very safe\n\n```\nsage: magma = MyMagmaStructure()\nsage: bernoulli(3, algorithm='magma') # boom\n```\n\nI think that the magma interface (and all interface in general) should just have some default configurable parameters. That would be used with something like\n\n```\nsage: sage.interfaces.config('magma', server=X', command='Y')\n```",
    "created_at": "2016-04-11T18:12:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295726",
    "user": "https://github.com/videlec"
}
```

<a id='comment:8'></a>Relying on `globals` is not very safe

```
sage: magma = MyMagmaStructure()
sage: bernoulli(3, algorithm='magma') # boom
```

I think that the magma interface (and all interface in general) should just have some default configurable parameters. That would be used with something like

```
sage: sage.interfaces.config('magma', server=X', command='Y')
```



---

archive/issue_comments_295727.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 vdelecroix]:\n> I think that the magma interface (and all interface in general) should just have some default configurable parameters. That would be used with something like\n> \n> ```\n> sage: sage.interfaces.config('magma', server=X', command='Y')\n> ```\n\nI would hang those properties on `sage.interfaces.magma.magma`, which is the \"default\" instantiation of the magma interface.\n\nNote that `sage.interfaces.magma.magma` is instantiated upon load, so we're too late to set defaults for its instantiation. However, actually *starting up* only happens once the interface really gets used, so you could just adapt the relevant properties on the magma object before using the interface.\n\nA workaround you can already do if you want to use a magma with non-standard setting is \"monkey patch\" the global instance, i.e.,\n\n```\nsage: sage.interfaces.magma.magma = Magma(...<options you want>...)\n```\nwith the problem that if some other file (such as `sage.interfaces.all`) has done an `import from`, you're not reaching them. So perhaps it's a little more robust to adjust attributes on `sage.interfaces.magma.magma` rather than rebind it to a different instance (sigh ... and then they say you don't have to think about pointers when working in python)",
    "created_at": "2016-04-11T20:51:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295727",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:9'></a>Replying to [comment:8 vdelecroix]:
> I think that the magma interface (and all interface in general) should just have some default configurable parameters. That would be used with something like
> 
> ```
> sage: sage.interfaces.config('magma', server=X', command='Y')
> ```

I would hang those properties on `sage.interfaces.magma.magma`, which is the "default" instantiation of the magma interface.

Note that `sage.interfaces.magma.magma` is instantiated upon load, so we're too late to set defaults for its instantiation. However, actually *starting up* only happens once the interface really gets used, so you could just adapt the relevant properties on the magma object before using the interface.

A workaround you can already do if you want to use a magma with non-standard setting is "monkey patch" the global instance, i.e.,

```
sage: sage.interfaces.magma.magma = Magma(...<options you want>...)
```
with the problem that if some other file (such as `sage.interfaces.all`) has done an `import from`, you're not reaching them. So perhaps it's a little more robust to adjust attributes on `sage.interfaces.magma.magma` rather than rebind it to a different instance (sigh ... and then they say you don't have to think about pointers when working in python)



---

archive/issue_comments_295728.json:
```json
{
    "body": "<a id='comment:10'></a>I have addressed Nils' two concerns above. About the \"magma = Magma()\" and the configuration parameters, I don't have a quick solution yet. There's a bunch of places in the schemes/ folder that import magma depending on the algorithm chosen. One easy way to fix this is to provide a get_magma_session() and set_magma_session() functions so that something like this would work:\n\n```\nsage: set_magma_session(Magma(server = 'remote', command = 'magma_custom'))\nsage: function_using_magma(algorithm = 'magma')\n```\n\nThis would only involve changing the calls that look like:\n\n```\nfrom sage.interfaces.magma import magma\nmagma.eval('complicated stuff')\n```\nto\n\n```\nfrom sage.interfaces.magma import get_magma_session\nmagma = get_magma_session()\nmagma.eval('complicated stuff')\n```\n\nDo you think that this is a good enough solution? If so, I would quickly implement it...",
    "created_at": "2016-04-12T08:35:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295728",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:10'></a>I have addressed Nils' two concerns above. About the "magma = Magma()" and the configuration parameters, I don't have a quick solution yet. There's a bunch of places in the schemes/ folder that import magma depending on the algorithm chosen. One easy way to fix this is to provide a get_magma_session() and set_magma_session() functions so that something like this would work:

```
sage: set_magma_session(Magma(server = 'remote', command = 'magma_custom'))
sage: function_using_magma(algorithm = 'magma')
```

This would only involve changing the calls that look like:

```
from sage.interfaces.magma import magma
magma.eval('complicated stuff')
```
to

```
from sage.interfaces.magma import get_magma_session
magma = get_magma_session()
magma.eval('complicated stuff')
```

Do you think that this is a good enough solution? If so, I would quickly implement it...



---

archive/issue_comments_295729.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:10 mmasdeu]:\n> I have addressed Nils' two concerns above. About the \"magma = Magma()\" and the configuration parameters, I don't have a quick solution yet. There's a bunch of places in the schemes/ folder that import magma depending on the algorithm chosen. One easy way to fix this is to provide a get_magma_session() and set_magma_session() functions so that something like this would work:\n> \n> ```\n> sage: set_magma_session(Magma(server = 'remote', command = 'magma_custom'))\n> sage: function_using_magma(algorithm = 'magma')\n> ```\n> \n> This would only involve changing the calls that look like:\n> \n> ```\n> from sage.interfaces.magma import magma\n> magma.eval('complicated stuff')\n> ```\n> to\n> \n> ```\n> from sage.interfaces.magma import get_magma_session\n> magma = get_magma_session()\n> magma.eval('complicated stuff')\n> ```\n> \n> Do you think that this is a good enough solution? If so, I would quickly implement it...\n\n\nI do not like it so much. It would involve a lot of changes in the schemes/ folder (that people have maybe already copy/paste in their personal code). And, more importantly, it would be different from any other interface in Sage. What about environment variable?\n\n```\n$ SAGE_MAGMA_COMMAND = \"module load magma/2.11.13; magma\"\n$ SAGE_MAGMA_SERVER = \"plafrim\"\n$ export SAGE_MAGMA_COMMAND SAGE_MAGMA_SERVER\n$ sage\n...\n```\n\nOne just needs in the constructor of `Magma` something like\n\n```\nclass Magma(Interface):\n    def __init__(self, server=None, command=None, ...):\n        import os\n        if server is None:\n            server = os.getenv('SAGE_MAGMA_SERVER')\n        if command is None:\n            command = os.getenv('SAGE_MAGMA_COMMAND')\n```\n\nA solution based on `init.sage` would not work since it is loaded after anything else.",
    "created_at": "2016-04-12T11:50:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295729",
    "user": "https://github.com/videlec"
}
```

<a id='comment:11'></a>Replying to [comment:10 mmasdeu]:
> I have addressed Nils' two concerns above. About the "magma = Magma()" and the configuration parameters, I don't have a quick solution yet. There's a bunch of places in the schemes/ folder that import magma depending on the algorithm chosen. One easy way to fix this is to provide a get_magma_session() and set_magma_session() functions so that something like this would work:
> 
> ```
> sage: set_magma_session(Magma(server = 'remote', command = 'magma_custom'))
> sage: function_using_magma(algorithm = 'magma')
> ```
> 
> This would only involve changing the calls that look like:
> 
> ```
> from sage.interfaces.magma import magma
> magma.eval('complicated stuff')
> ```
> to
> 
> ```
> from sage.interfaces.magma import get_magma_session
> magma = get_magma_session()
> magma.eval('complicated stuff')
> ```
> 
> Do you think that this is a good enough solution? If so, I would quickly implement it...


I do not like it so much. It would involve a lot of changes in the schemes/ folder (that people have maybe already copy/paste in their personal code). And, more importantly, it would be different from any other interface in Sage. What about environment variable?

```
$ SAGE_MAGMA_COMMAND = "module load magma/2.11.13; magma"
$ SAGE_MAGMA_SERVER = "plafrim"
$ export SAGE_MAGMA_COMMAND SAGE_MAGMA_SERVER
$ sage
...
```

One just needs in the constructor of `Magma` something like

```
class Magma(Interface):
    def __init__(self, server=None, command=None, ...):
        import os
        if server is None:
            server = os.getenv('SAGE_MAGMA_SERVER')
        if command is None:
            command = os.getenv('SAGE_MAGMA_COMMAND')
```

A solution based on `init.sage` would not work since it is loaded after anything else.



---

archive/issue_comments_295730.json:
```json
{
    "body": "<a id='comment:12'></a>1) Some users may not be familiar with environment variables.\n2) I like to be able to write Sage scripts that work after you start sage. Using environment variables forces you to remember always to set them before you start your script, which can be annoying.\n3) The environment variable approach doesn't allow the user to compare the result of executing a function with two different Magma installations. Something like this would be desiderable.\n\n```\nsage: E = EllipticCurve('37a1')\nsage: set_magma_session(Magma(command = 'magma_2-18'))\nsage: E.analytic_rank(algorithm = 'magma')\n0\nsage: set_magma_session(Magma(command = 'magma_2-19'))\nsage: E.analytic_rank(algorithm = 'magma')\n0\n```\n4) I don't understand your first comment. If people has taken Sage code that uses Magma and now Sage adds more functionality, then they can either use the old functionality or adapt the code to the new (and better way), right?\n\nHere is what I propose: add the environment variables (which make sense the moment there is a magma = Magma() line in there...), but also change the functions using magma to use the get_magma_session() function. How reasonable is this?",
    "created_at": "2016-04-12T13:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295730",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:12'></a>1) Some users may not be familiar with environment variables.
2) I like to be able to write Sage scripts that work after you start sage. Using environment variables forces you to remember always to set them before you start your script, which can be annoying.
3) The environment variable approach doesn't allow the user to compare the result of executing a function with two different Magma installations. Something like this would be desiderable.

```
sage: E = EllipticCurve('37a1')
sage: set_magma_session(Magma(command = 'magma_2-18'))
sage: E.analytic_rank(algorithm = 'magma')
0
sage: set_magma_session(Magma(command = 'magma_2-19'))
sage: E.analytic_rank(algorithm = 'magma')
0
```
4) I don't understand your first comment. If people has taken Sage code that uses Magma and now Sage adds more functionality, then they can either use the old functionality or adapt the code to the new (and better way), right?

Here is what I propose: add the environment variables (which make sense the moment there is a magma = Magma() line in there...), but also change the functions using magma to use the get_magma_session() function. How reasonable is this?



---

archive/issue_comments_295731.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 mmasdeu]: \n> Here is what I propose: add the environment variables (which make sense the moment there is a magma = Magma() line in there...), but also change the functions using magma to use the get_magma_session() function. How reasonable is this?\n\n\nYou are right that it is desirable to have a way to modify it from Sage itself. However, I would not populate the global namespace with `get_magma_session` unless the global `magma` is deprecated (which can be done using lazy imports).\n\nMoreover, it is very confusing to have all of: `magma`, `Magma`, `magma_free`, `magma_console`, `magma_version` in the global namespace... (not talking about `Magmas`). A cleanup is desirable.",
    "created_at": "2016-04-12T14:50:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295731",
    "user": "https://github.com/videlec"
}
```

<a id='comment:13'></a>Replying to [comment:12 mmasdeu]: 
> Here is what I propose: add the environment variables (which make sense the moment there is a magma = Magma() line in there...), but also change the functions using magma to use the get_magma_session() function. How reasonable is this?


You are right that it is desirable to have a way to modify it from Sage itself. However, I would not populate the global namespace with `get_magma_session` unless the global `magma` is deprecated (which can be done using lazy imports).

Moreover, it is very confusing to have all of: `magma`, `Magma`, `magma_free`, `magma_console`, `magma_version` in the global namespace... (not talking about `Magmas`). A cleanup is desirable.



---

archive/issue_comments_295732.json:
```json
{
    "body": "<a id='comment:14'></a>I think the `set_magma_session` is a rather heavy interface. It seems to me the appropriate place would be a method on `sage.interfaces.expect.Expect` along the lines of\n\n```\ndef set_server_and_command(self,server,command):\n    if self._expect:\n        raise RuntimeError(\"interface has already started\")\n    self._server = server\n    self.__command = command\n```\nIf there are other settings to change as well, it may be necessary to override this routine on Magma (and do the usual super() call thing)\n\nThe main thing is that an instantiated expect interface doesn't run a process on its own. Starting it is a separate operation (and in fact, during the lifetime of an expect object it may start and stop underlying processes repeatedly)\n\nThe cleaner solution would be to make new `Magma` instances for different server/command settings, but as we've seen a lot of code assumes that there is a single, global, magma instance for default use throughout the lifetime of a sage session.",
    "created_at": "2016-04-12T15:49:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295732",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:14'></a>I think the `set_magma_session` is a rather heavy interface. It seems to me the appropriate place would be a method on `sage.interfaces.expect.Expect` along the lines of

```
def set_server_and_command(self,server,command):
    if self._expect:
        raise RuntimeError("interface has already started")
    self._server = server
    self.__command = command
```
If there are other settings to change as well, it may be necessary to override this routine on Magma (and do the usual super() call thing)

The main thing is that an instantiated expect interface doesn't run a process on its own. Starting it is a separate operation (and in fact, during the lifetime of an expect object it may start and stop underlying processes repeatedly)

The cleaner solution would be to make new `Magma` instances for different server/command settings, but as we've seen a lot of code assumes that there is a single, global, magma instance for default use throughout the lifetime of a sage session.



---

archive/issue_comments_295733.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:14 nbruin]:\n> I think the `set_magma_session` is a rather heavy interface. It seems to me the appropriate place would be a method on `sage.interfaces.expect.Expect` along the lines of\n> \n> ```\n> def set_server_and_command(self,server,command):\n>     if self._expect:\n>         raise RuntimeError(\"interface has already started\")\n>     self._server = server\n>     self.__command = command\n> ```\n\n\nI like better this approach. That way the server can even be configured in `init.sage`!\n\n> The cleaner solution would be to make new `Magma` instances for different server/command settings, but as we've seen a lot of code assumes that there is a single, global, magma instance for default use throughout the lifetime of a sage session. \n\n\nI would actually remove the `Magma` from the global namespace. That would not prevent anyone from testing different versions.",
    "created_at": "2016-04-12T23:49:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295733",
    "user": "https://github.com/videlec"
}
```

<a id='comment:15'></a>Replying to [comment:14 nbruin]:
> I think the `set_magma_session` is a rather heavy interface. It seems to me the appropriate place would be a method on `sage.interfaces.expect.Expect` along the lines of
> 
> ```
> def set_server_and_command(self,server,command):
>     if self._expect:
>         raise RuntimeError("interface has already started")
>     self._server = server
>     self.__command = command
> ```


I like better this approach. That way the server can even be configured in `init.sage`!

> The cleaner solution would be to make new `Magma` instances for different server/command settings, but as we've seen a lot of code assumes that there is a single, global, magma instance for default use throughout the lifetime of a sage session. 


I would actually remove the `Magma` from the global namespace. That would not prevent anyone from testing different versions.



---

archive/issue_comments_295734.json:
```json
{
    "body": "<a id='comment:16'></a>New commits:",
    "created_at": "2016-04-13T11:08:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295734",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:16'></a>New commits:



---

archive/issue_comments_295735.json:
```json
{
    "body": "<a id='comment:17'></a>Tested succesfully with `magma` and `matlab`! Great.\n\nThough, there is something wrong with `maple` (not sure where and how it might be related to the changes in this ticket)\n\n```\nsage: maple.set_server_and_command('calcul1')\nsage: maple('2+2')  # hang out infinitely\n```\nAnd even after a Ctrl-C I do not have back the sage prompt (only `^CInterrupting Maple...`). After a second Ctrl-C I get the prompt back with the following traceback\n\n```\n...\n.../interfaces/maple.pyc in set(self, var, value)\n    619         \"\"\"\n    620         cmd = '%s:=%s:' % (var, value)\n--> 621         out = self.eval(cmd)\n    622         if out.find(\"error\") != -1:\n    623             raise TypeError(\"Error executing code in Maple\\nCODE:\\n\\t%s\\nMaple ERROR:\\n\\t%s\" % (cmd, out))\n\n.../interfaces/expect.pyc in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)\n   1258                 elif split_lines:\n   1259                     return '\\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)\n-> 1260                                         for L in code.split('\\n') if L != ''])\n   1261                 else:\n   1262                     return self._eval_line(code, allow_use_file=allow_use_file, **kwds)\n\n.../interfaces/maple.pyc in _eval_line(self, line, allow_use_file, wait_for_prompt, restart_if_needed)\n    571         with gc_disabled():\n    572             z = Expect._eval_line(self, line, allow_use_file=allow_use_file,\n--> 573                     wait_for_prompt=wait_for_prompt).replace('\\\\\\n','').strip()\n    574             if z.lower().find(\"error\") != -1:\n    575                 raise RuntimeError(\"An error occurred running a Maple command:\\nINPUT:\\n%s\\nOUTPUT:\\n%s\" % (line, z))\n...\n```\n(and `maple` works perfectly well on `calcul1` through `ssh`).",
    "created_at": "2016-04-13T13:31:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295735",
    "user": "https://github.com/videlec"
}
```

<a id='comment:17'></a>Tested succesfully with `magma` and `matlab`! Great.

Though, there is something wrong with `maple` (not sure where and how it might be related to the changes in this ticket)

```
sage: maple.set_server_and_command('calcul1')
sage: maple('2+2')  # hang out infinitely
```
And even after a Ctrl-C I do not have back the sage prompt (only `^CInterrupting Maple...`). After a second Ctrl-C I get the prompt back with the following traceback

```
...
.../interfaces/maple.pyc in set(self, var, value)
    619         """
    620         cmd = '%s:=%s:' % (var, value)
--> 621         out = self.eval(cmd)
    622         if out.find("error") != -1:
    623             raise TypeError("Error executing code in Maple\nCODE:\n\t%s\nMaple ERROR:\n\t%s" % (cmd, out))

.../interfaces/expect.pyc in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)
   1258                 elif split_lines:
   1259                     return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
-> 1260                                         for L in code.split('\n') if L != ''])
   1261                 else:
   1262                     return self._eval_line(code, allow_use_file=allow_use_file, **kwds)

.../interfaces/maple.pyc in _eval_line(self, line, allow_use_file, wait_for_prompt, restart_if_needed)
    571         with gc_disabled():
    572             z = Expect._eval_line(self, line, allow_use_file=allow_use_file,
--> 573                     wait_for_prompt=wait_for_prompt).replace('\\\n','').strip()
    574             if z.lower().find("error") != -1:
    575                 raise RuntimeError("An error occurred running a Maple command:\nINPUT:\n%s\nOUTPUT:\n%s" % (line, z))
...
```
(and `maple` works perfectly well on `calcul1` through `ssh`).



---

archive/issue_comments_295736.json:
```json
{
    "body": "<a id='comment:18'></a>Might be too much, but we could even move the environment part inside pexpect\n\n```\nserver = os.getenv('SAGE_{}_SERVER'.format(self.name().upper()))\n```\nWhat do you think?\n\nTo fit with coding conventions could change\n\n```\n(self,server = None,command = None, server_tmpdir = None, ulimit = None)\n-->\n(self, server=None, command=None, server_tmpdir=None, ulimit=None)\n```\nAnd add cross doctests between `set_server_and_command`, `server` and `command`.",
    "created_at": "2016-04-13T13:33:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295736",
    "user": "https://github.com/videlec"
}
```

<a id='comment:18'></a>Might be too much, but we could even move the environment part inside pexpect

```
server = os.getenv('SAGE_{}_SERVER'.format(self.name().upper()))
```
What do you think?

To fit with coding conventions could change

```
(self,server = None,command = None, server_tmpdir = None, ulimit = None)
-->
(self, server=None, command=None, server_tmpdir=None, ulimit=None)
```
And add cross doctests between `set_server_and_command`, `server` and `command`.



---

archive/issue_comments_295737.json:
```json
{
    "body": "<a id='comment:19'></a>An annoying feature\n\n```\nsage: magma.set_<TAB>\nCreating list of all Magma intrinsics for use in tab completion.\n...\nScanning Magma types ...\n```",
    "created_at": "2016-04-13T13:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295737",
    "user": "https://github.com/videlec"
}
```

<a id='comment:19'></a>An annoying feature

```
sage: magma.set_<TAB>
Creating list of all Magma intrinsics for use in tab completion.
...
Scanning Magma types ...
```



---

archive/issue_comments_295738.json:
```json
{
    "body": "<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-13T20:08:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295738",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_295739.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:19 vdelecroix]:\n> An annoying feature\n> \n> ```\n> sage: magma.set_<TAB>\n> Creating list of all Magma intrinsics for use in tab completion.\n> ...\n> Scanning Magma types ...\n> ```\n\n\nThis only happens the first time you use a server/tmpdir (as long as tmpdir is not cleaned). It is part of the fun to be able to use the discovery feature of python with Magma! So this should be seen as a nice feature, and it was done in your computer the first time you used the magma session as well...",
    "created_at": "2016-04-13T20:10:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295739",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:21'></a>Replying to [comment:19 vdelecroix]:
> An annoying feature
> 
> ```
> sage: magma.set_<TAB>
> Creating list of all Magma intrinsics for use in tab completion.
> ...
> Scanning Magma types ...
> ```


This only happens the first time you use a server/tmpdir (as long as tmpdir is not cleaned). It is part of the fun to be able to use the discovery feature of python with Magma! So this should be seen as a nice feature, and it was done in your computer the first time you used the magma session as well...



---

archive/issue_comments_295740.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:17 vdelecroix]:\n\n> Though, there is something wrong with `maple` (not sure where and how it might be related to the changes in this ticket)\n\n\nI have no easy way to debug this. Maybe open a new ticket?",
    "created_at": "2016-04-13T20:12:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295740",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:22'></a>Replying to [comment:17 vdelecroix]:

> Though, there is something wrong with `maple` (not sure where and how it might be related to the changes in this ticket)


I have no easy way to debug this. Maybe open a new ticket?



---

archive/issue_comments_295741.json:
```json
{
    "body": "<a id='comment:23'></a>Done!\n\nReplying to [comment:18 vdelecroix]:\n> Might be too much, but we could even move the environment part inside pexpect\n> \n> ```\n> server = os.getenv('SAGE_{}_SERVER'.format(self.name().upper()))\n> ```\n> What do you think?\n> \n> To fit with coding conventions could change\n> \n> ```\n> (self,server = None,command = None, server_tmpdir = None, ulimit = None)\n> -->\n> (self, server=None, command=None, server_tmpdir=None, ulimit=None)\n> ```\n> And add cross doctests between `set_server_and_command`, `server` and `command`.",
    "created_at": "2016-04-13T20:13:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295741",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:23'></a>Done!

Replying to [comment:18 vdelecroix]:
> Might be too much, but we could even move the environment part inside pexpect
> 
> ```
> server = os.getenv('SAGE_{}_SERVER'.format(self.name().upper()))
> ```
> What do you think?
> 
> To fit with coding conventions could change
> 
> ```
> (self,server = None,command = None, server_tmpdir = None, ulimit = None)
> -->
> (self, server=None, command=None, server_tmpdir=None, ulimit=None)
> ```
> And add cross doctests between `set_server_and_command`, `server` and `command`.



---

archive/issue_comments_295742.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:22 mmasdeu]:\n> Replying to [comment:17 vdelecroix]:\n> \n> > Though, there is something wrong with `maple` (not sure where and how it might be related to the changes in this ticket)\n\n> \n> I have no easy way to debug this. Maybe open a new ticket?\n\n\nIt is now working (with and without your branch)... strange.",
    "created_at": "2016-04-13T20:29:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295742",
    "user": "https://github.com/videlec"
}
```

<a id='comment:24'></a>Replying to [comment:22 mmasdeu]:
> Replying to [comment:17 vdelecroix]:
> 
> > Though, there is something wrong with `maple` (not sure where and how it might be related to the changes in this ticket)

> 
> I have no easy way to debug this. Maybe open a new ticket?


It is now working (with and without your branch)... strange.



---

archive/issue_comments_295743.json:
```json
{
    "body": "<a id='comment:25'></a>We have a strange message before the Sage prompt if we do not specify the tmp repository\n\n```\n$ export SAGE_MAPLE_SERVER='calcul1'\n$ sage\nSageMath version ...\nNo remote temporary directory (option server_tmpdir) specified,\nusing /tmp/ on calcul1\nsage: \n```\nDo you think this is ok? Everything is fine with\n\n```\n$ export SAGE_MAPLE_SERVER='calcul1'\n$ export SAGE_MAPLE_TMPDIR='/tmp'\n$ sage\n```",
    "created_at": "2016-04-13T20:37:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295743",
    "user": "https://github.com/videlec"
}
```

<a id='comment:25'></a>We have a strange message before the Sage prompt if we do not specify the tmp repository

```
$ export SAGE_MAPLE_SERVER='calcul1'
$ sage
SageMath version ...
No remote temporary directory (option server_tmpdir) specified,
using /tmp/ on calcul1
sage: 
```
Do you think this is ok? Everything is fine with

```
$ export SAGE_MAPLE_SERVER='calcul1'
$ export SAGE_MAPLE_TMPDIR='/tmp'
$ sage
```



---

archive/issue_comments_295744.json:
```json
{
    "body": "<a id='comment:26'></a>Yes, if you don't specify the tmpdir, then this message gets printed (this was already there when I looked at the code). You can specify the tmpdir either in the environment (as you do) or from within the set_server_and_command method.",
    "created_at": "2016-04-13T20:39:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295744",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:26'></a>Yes, if you don't specify the tmpdir, then this message gets printed (this was already there when I looked at the code). You can specify the tmpdir either in the environment (as you do) or from within the set_server_and_command method.



---

archive/issue_comments_295745.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:21 mmasdeu]:\n> Replying to [comment:19 vdelecroix]:\n> > An annoying feature\n> > \n> > ```\n> > sage: magma.set_<TAB>\n> > Creating list of all Magma intrinsics for use in tab completion.\n> > ...\n> > Scanning Magma types ...\n> > ```\n\n> \n> This only happens the first time you use a server/tmpdir (as long as tmpdir is not cleaned). It is part of the fun to be able to use the discovery feature of python with Magma! So this should be seen as a nice feature, and it was done in your computer the first time you used the magma session as well...\n\n\nNot exactly, it is done the first time you use tab completion with magma. And the message says that it is saved **locally** in `.sage//magma_intrinsic_cache.sobj` (with two ugly slashes). Might be better to make it parameters dependent because two magma versions might have different namespaces, no? (anyway not for this ticket)",
    "created_at": "2016-04-13T20:40:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295745",
    "user": "https://github.com/videlec"
}
```

<a id='comment:27'></a>Replying to [comment:21 mmasdeu]:
> Replying to [comment:19 vdelecroix]:
> > An annoying feature
> > 
> > ```
> > sage: magma.set_<TAB>
> > Creating list of all Magma intrinsics for use in tab completion.
> > ...
> > Scanning Magma types ...
> > ```

> 
> This only happens the first time you use a server/tmpdir (as long as tmpdir is not cleaned). It is part of the fun to be able to use the discovery feature of python with Magma! So this should be seen as a nice feature, and it was done in your computer the first time you used the magma session as well...


Not exactly, it is done the first time you use tab completion with magma. And the message says that it is saved **locally** in `.sage//magma_intrinsic_cache.sobj` (with two ugly slashes). Might be better to make it parameters dependent because two magma versions might have different namespaces, no? (anyway not for this ticket)



---

archive/issue_comments_295746.json:
```json
{
    "body": "<a id='comment:28'></a>Sided remark: there is a `.format()` trick to deal with curly brackets. Double brackets are transformed into one\n\n```\nsage: 'SAGE_`{`}_{{}}_{}'.format('one').format('two').format('three')\n'SAGE_three_two_one'\nsage: '``'.format(1)\n'{1}'\n```",
    "created_at": "2016-04-13T20:45:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295746",
    "user": "https://github.com/videlec"
}
```

<a id='comment:28'></a>Sided remark: there is a `.format()` trick to deal with curly brackets. Double brackets are transformed into one

```
sage: 'SAGE_`{`}_{{}}_{}'.format('one').format('two').format('three')
'SAGE_three_two_one'
sage: '``'.format(1)
'{1}'
```



---

archive/issue_comments_295747.json:
```json
{
    "body": "<a id='comment:29'></a>As you moved the code of `magma_version` into the class, you should deprecate it (since it is in the global namespace).",
    "created_at": "2016-04-13T20:53:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295747",
    "user": "https://github.com/videlec"
}
```

<a id='comment:29'></a>As you moved the code of `magma_version` into the class, you should deprecate it (since it is in the global namespace).



---

archive/issue_comments_295748.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-04-13T20:59:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295748",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_295749.json:
```json
{
    "body": "<a id='comment:30'></a>In the `Magma` constructor there is the default option `command = 'magma'` which prevents using the environment variable `SAGE_MAGMA_COMMAND`.",
    "created_at": "2016-04-13T20:59:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295749",
    "user": "https://github.com/videlec"
}
```

<a id='comment:30'></a>In the `Magma` constructor there is the default option `command = 'magma'` which prevents using the environment variable `SAGE_MAGMA_COMMAND`.



---

archive/issue_comments_295750.json:
```json
{
    "body": "<a id='comment:31'></a>Setting the default to `None` is incompatible with\n\n```\n        if not user_config:\n            command += ' -n'\n```\nwhich results in\n\n```\nTypeError: unsupported operand type(s) for +=: 'NoneType' and 'str'\n```",
    "created_at": "2016-04-13T21:01:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295750",
    "user": "https://github.com/videlec"
}
```

<a id='comment:31'></a>Setting the default to `None` is incompatible with

```
        if not user_config:
            command += ' -n'
```
which results in

```
TypeError: unsupported operand type(s) for +=: 'NoneType' and 'str'
```



---

archive/issue_comments_295751.json:
```json
{
    "body": "<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-14T07:27:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295751",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_295752.json:
```json
{
    "body": "<a id='comment:33'></a>I fixed it by (also) reading the environment variable in magma.py. Each interface can do something similar if needed.",
    "created_at": "2016-04-14T07:28:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295752",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:33'></a>I fixed it by (also) reading the environment variable in magma.py. Each interface can do something similar if needed.



---

archive/issue_comments_295753.json:
```json
{
    "body": "<a id='comment:34'></a>Replying to [comment:27 vdelecroix]:\n> Not exactly, it is done the first time you use tab completion with magma. And the message says that it is saved **locally** in `.sage//magma_intrinsic_cache.sobj` (with two ugly slashes). Might be better to make it parameters dependent because two magma versions might have different namespaces, no? (anyway not for this ticket)\n\n\nNo, that is the best place to save it because that's one of the few (hopefully persistent) places where you might expect to have write access. Two magma versions tend to have only subtly different namespaces by default, so the enormous cost of trying to differentiate is probably not offset by having slightly more accurate tab completion.",
    "created_at": "2016-04-14T07:54:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295753",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:34'></a>Replying to [comment:27 vdelecroix]:
> Not exactly, it is done the first time you use tab completion with magma. And the message says that it is saved **locally** in `.sage//magma_intrinsic_cache.sobj` (with two ugly slashes). Might be better to make it parameters dependent because two magma versions might have different namespaces, no? (anyway not for this ticket)


No, that is the best place to save it because that's one of the few (hopefully persistent) places where you might expect to have write access. Two magma versions tend to have only subtly different namespaces by default, so the enormous cost of trying to differentiate is probably not offset by having slightly more accurate tab completion.



---

archive/issue_comments_295754.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-04-14T09:58:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295754",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_295755.json:
```json
{
    "body": "<a id='comment:36'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-14T10:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295755",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:36'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_295756.json:
```json
{
    "body": "<a id='comment:37'></a>Replying to [comment:34 nbruin]:\n> Replying to [comment:27 vdelecroix]:\n> > Not exactly, it is done the first time you use tab completion with magma. And the message says that it is saved **locally** in `.sage//magma_intrinsic_cache.sobj` (with two ugly slashes). Might be better to make it parameters dependent because two magma versions might have different namespaces, no? (anyway not for this ticket)\n\n> \n> No, that is the best place to save it because that's one of the few (hopefully persistent) places where you might expect to have write access. Two magma versions tend to have only subtly different namespaces by default, so the enormous cost of trying to differentiate is probably not offset by having slightly more accurate tab completion.\n\n\nI was not complaining about the location, just about potential version clashes. However, this seems to be completely broken (at least with magma 2.11.13 on my computer).",
    "created_at": "2016-04-14T12:49:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295756",
    "user": "https://github.com/videlec"
}
```

<a id='comment:37'></a>Replying to [comment:34 nbruin]:
> Replying to [comment:27 vdelecroix]:
> > Not exactly, it is done the first time you use tab completion with magma. And the message says that it is saved **locally** in `.sage//magma_intrinsic_cache.sobj` (with two ugly slashes). Might be better to make it parameters dependent because two magma versions might have different namespaces, no? (anyway not for this ticket)

> 
> No, that is the best place to save it because that's one of the few (hopefully persistent) places where you might expect to have write access. Two magma versions tend to have only subtly different namespaces by default, so the enormous cost of trying to differentiate is probably not offset by having slightly more accurate tab completion.


I was not complaining about the location, just about potential version clashes. However, this seems to be completely broken (at least with magma 2.11.13 on my computer).



---

archive/issue_comments_295757.json:
```json
{
    "body": "<a id='comment:38'></a>Marc, you did not address [comment:29], see [Deprecation in the developer guide](http://doc.sagemath.org/html/en/developer/coding_in_python.html#deprecation).",
    "created_at": "2016-04-14T14:04:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295757",
    "user": "https://github.com/videlec"
}
```

<a id='comment:38'></a>Marc, you did not address [comment:29], see [Deprecation in the developer guide](http://doc.sagemath.org/html/en/developer/coding_in_python.html#deprecation).



---

archive/issue_comments_295758.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-04-14T14:04:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295758",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_295759.json:
```json
{
    "body": "<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-14T20:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295759",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_295760.json:
```json
{
    "body": "<a id='comment:40'></a>I have deprecated the function magma_version. When calling it, you get now an explanatory message. I get a ton of other deprecation warnings which I think are not my fault, so I hope that they don't delay the review of this ticket!",
    "created_at": "2016-04-14T20:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295760",
    "user": "https://github.com/mmasdeu"
}
```

<a id='comment:40'></a>I have deprecated the function magma_version. When calling it, you get now an explanatory message. I get a ton of other deprecation warnings which I think are not my fault, so I hope that they don't delay the review of this ticket!



---

archive/issue_comments_295761.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-04-14T20:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295761",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_295762.json:
```json
{
    "body": "<a id='comment:41'></a>Replying to [comment:40 mmasdeu]:\n> I have deprecated the function magma_version. When calling it, you get now an explanatory message. I get a ton of other deprecation warnings which I think are not my fault, so I hope that they don't delay the review of this ticket!\n\n\nNope. There is another ticket which actually tracks the issue. This is a problem with the way Sage uses Ipython.",
    "created_at": "2016-04-14T20:48:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295762",
    "user": "https://github.com/videlec"
}
```

<a id='comment:41'></a>Replying to [comment:40 mmasdeu]:
> I have deprecated the function magma_version. When calling it, you get now an explanatory message. I get a ton of other deprecation warnings which I think are not my fault, so I hope that they don't delay the review of this ticket!


Nope. There is another ticket which actually tracks the issue. This is a problem with the way Sage uses Ipython.



---

archive/issue_comments_295763.json:
```json
{
    "body": "<a id='comment:42'></a>Technically, you deprecated the import in the global namespace but not the function in the module. In other words, this does not raise a warning as it should\n\n```\nsage: sage.interfaces.magma.magma_version()\n```\n(because in the long run, we should just get rid of `magma_version`). Would be better to simply deprecate `magma_version` and not modify `all.py` using\n\n```\ndef magma_version():\n    from sage.misc.superseded import deprecation\n    deprecation(20388, 'whatever')\n    return magma.version()\n```\n\nOther than that, everything looks good to me. Nils?",
    "created_at": "2016-04-14T20:48:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295763",
    "user": "https://github.com/videlec"
}
```

<a id='comment:42'></a>Technically, you deprecated the import in the global namespace but not the function in the module. In other words, this does not raise a warning as it should

```
sage: sage.interfaces.magma.magma_version()
```
(because in the long run, we should just get rid of `magma_version`). Would be better to simply deprecate `magma_version` and not modify `all.py` using

```
def magma_version():
    from sage.misc.superseded import deprecation
    deprecation(20388, 'whatever')
    return magma.version()
```

Other than that, everything looks good to me. Nils?



---

archive/issue_comments_295764.json:
```json
{
    "body": "<a id='comment:43'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-14T21:08:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295764",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:43'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_295765.json:
```json
{
    "body": "<a id='comment:44'></a>This good for me, only needs Nils agreement. Thanks for the fix. Possible follow-up: #13885",
    "created_at": "2016-04-14T21:11:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295765",
    "user": "https://github.com/videlec"
}
```

<a id='comment:44'></a>This good for me, only needs Nils agreement. Thanks for the fix. Possible follow-up: #13885



---

archive/issue_comments_295766.json:
```json
{
    "body": "<a id='comment:45'></a>I don't have an axe to grind on this. My general impression is that the proposal here should improve the status quo.",
    "created_at": "2016-04-15T05:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295766",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:45'></a>I don't have an axe to grind on this. My general impression is that the proposal here should improve the status quo.



---

archive/issue_comments_295767.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-04-15T12:54:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295767",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_295768.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-04-16T10:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20388#issuecomment-295768",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_055220.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-04-16T10:25:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20388",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20388#event-55220"
}
```
