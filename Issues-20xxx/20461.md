# Issue 20461: Fixes for copying a MIP and its variables

archive/issues_020224.json:
```json
{
    "body": "Even after merging #20414, both `copy` and (the identical) `deepcopy` have weird semantics in relation to the `MIPVariable`s in a problems -- because a MIP does not have an API to gain access to its variables; and trying to use the old `MIPVariable`s with the copy is questionable and definitely broken if one creates new components of this variable, see #15159, #19523. Same when there's no explicit `MIPVariable` and only the `_default_mipvariable` is used via the problem's `__getitem__` method:\n\n```\nsage: sage: p = MixedIntegerLinearProgram()\nsage: p[0]\nx_0\nsage: q = copy(p)\nsage: q[0]\nx_0\nsage: q[1]\nx_1\nsage: sage: p.number_of_variables()\n2\nsage: sage: q.number_of_variables()\n1\n```\n\nHere's a possible fix without having to change the whole design:\n\n* a new `MixedIntegerLinearProgram.copy` method that takes a `names` keyword argument, enabling this operation:\n\n```\nsage: p.<x,y> = MixedIntegerLinearProgram()\nsage: q.<newx,newy> = p.copy()\n```\nand the less magical syntax\n\n```\nsage: q, newx, newy = p.copy([x, y])\n```\n* `copy` and `__copy__` (and `__deepcopy__`) should make a copy of _default_variable (this requires writing a `__copy__` method for `MIPVariable`)\n* if `MixedIntegerLinearProgram.new_variable` has been called, it should set a flag and then if `__copy__` (or `__deepcopy__`) are called, it should display a warning (deprecation??) and refer the user to the new `copy` method.\n\nIn this ticket, we take care of the default MIP variable.\n#20657 will take care of the variables created with `new_variable`.\n\nCC:  @dimpase @videlec @jdemeyer @nbruin @fchapoton\n\nKeywords: lp\n\nReviewer: Dima Pasechnik\n\nAuthor: Matthias Koeppe\n\nBranch: dff27e5fca6197faf3747c100d493bc1b4908878\n\nCommit: dff27e5fca6197faf3747c100d493bc1b4908878\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20461\n\n",
    "closed_at": "2016-06-05T01:10:35Z",
    "created_at": "2016-04-19T04:05:06Z",
    "labels": [
        "component: numerical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "Fixes for copying a MIP and its variables",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20461",
    "user": "https://github.com/mkoeppe"
}
```
Even after merging #20414, both `copy` and (the identical) `deepcopy` have weird semantics in relation to the `MIPVariable`s in a problems -- because a MIP does not have an API to gain access to its variables; and trying to use the old `MIPVariable`s with the copy is questionable and definitely broken if one creates new components of this variable, see #15159, #19523. Same when there's no explicit `MIPVariable` and only the `_default_mipvariable` is used via the problem's `__getitem__` method:

```
sage: sage: p = MixedIntegerLinearProgram()
sage: p[0]
x_0
sage: q = copy(p)
sage: q[0]
x_0
sage: q[1]
x_1
sage: sage: p.number_of_variables()
2
sage: sage: q.number_of_variables()
1
```

Here's a possible fix without having to change the whole design:

* a new `MixedIntegerLinearProgram.copy` method that takes a `names` keyword argument, enabling this operation:

```
sage: p.<x,y> = MixedIntegerLinearProgram()
sage: q.<newx,newy> = p.copy()
```
and the less magical syntax

```
sage: q, newx, newy = p.copy([x, y])
```
* `copy` and `__copy__` (and `__deepcopy__`) should make a copy of _default_variable (this requires writing a `__copy__` method for `MIPVariable`)
* if `MixedIntegerLinearProgram.new_variable` has been called, it should set a flag and then if `__copy__` (or `__deepcopy__`) are called, it should display a warning (deprecation??) and refer the user to the new `copy` method.

In this ticket, we take care of the default MIP variable.
#20657 will take care of the variables created with `new_variable`.

CC:  @dimpase @videlec @jdemeyer @nbruin @fchapoton

Keywords: lp

Reviewer: Dima Pasechnik

Author: Matthias Koeppe

Branch: dff27e5fca6197faf3747c100d493bc1b4908878

Commit: dff27e5fca6197faf3747c100d493bc1b4908878

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/20461





---

archive/issue_comments_278302.json:
```json
{
    "body": "<a id='comment:2'></a>Any thoughts on this proposal?",
    "created_at": "2016-04-19T23:52:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20461#issuecomment-278302",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>Any thoughts on this proposal?



---

archive/issue_comments_278303.json:
```json
{
    "body": "<a id='comment:4'></a>```\nsage: p = MixedIntegerLinearProgram()\nsage: x = p.new_variable(nonnegative=True)\nsage: x[0]\nx_0\nsage: x[1]\nx_1\nsage: p[0] #I don't understand this\nx_2\nsage: p[1]\nx_3\n```\nBut if we actually use the \"generator\" interface things seem OK:\n\n```\nsage: [p.gen(i) for i in [0..3]]\n[x_0, x_1, x_2, x_3]\n```\nso I would suggest to just make sure that `p.gen(...)` works properly and indeed gives a variable of the appropriate MIP object. Then there IS an interface to get access to its variables (and really, it seems to be largely in place already) and then simply that can be used.\n\nIt looks like a variable on p is uniquely determined by its index (certainly its print name is), and `p.new_variable` seems just a funny way of obtaining such indices.\n\nThe rest of the variable data is all hanging off internal tables, and via the \"is_variable_*\" methods you can obtain the type of the variables.\n\nI think you first need to make sure that all of that is accessible (and copied appropriately, but I guess that's taken care of now) and then you can think about what to do with this \"new_variable\" business.",
    "created_at": "2016-05-12T22:37:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20461#issuecomment-278303",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:4'></a>```
sage: p = MixedIntegerLinearProgram()
sage: x = p.new_variable(nonnegative=True)
sage: x[0]
x_0
sage: x[1]
x_1
sage: p[0] #I don't understand this
x_2
sage: p[1]
x_3
```
But if we actually use the "generator" interface things seem OK:

```
sage: [p.gen(i) for i in [0..3]]
[x_0, x_1, x_2, x_3]
```
so I would suggest to just make sure that `p.gen(...)` works properly and indeed gives a variable of the appropriate MIP object. Then there IS an interface to get access to its variables (and really, it seems to be largely in place already) and then simply that can be used.

It looks like a variable on p is uniquely determined by its index (certainly its print name is), and `p.new_variable` seems just a funny way of obtaining such indices.

The rest of the variable data is all hanging off internal tables, and via the "is_variable_*" methods you can obtain the type of the variables.

I think you first need to make sure that all of that is accessible (and copied appropriately, but I guess that's taken care of now) and then you can think about what to do with this "new_variable" business.



---

archive/issue_comments_278304.json:
```json
{
    "body": "<a id='comment:5'></a>If one just uses `gen()`. then everything already works as expected.\n\nWhat is broken with `copy` is the funny stuff involving `MIPVariable`. This is what this ticket addresses.",
    "created_at": "2016-05-13T07:12:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20461#issuecomment-278304",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>If one just uses `gen()`. then everything already works as expected.

What is broken with `copy` is the funny stuff involving `MIPVariable`. This is what this ticket addresses.



---

archive/issue_comments_278305.json:
```json
{
    "body": "<a id='comment:6'></a>Actually I spoke too fast, it seems that `gen()` does not do anything useful. \n\n```\nsage: mip = MixedIntegerLinearProgram(solver='GLPK')\nsage: mip.gen(0)           ### Names a variable, but does not create it in the backend\nx_0\nsage: mip.number_of_variables()\n0\nsage: mip[0]                  ### This now creates a variable. It prints the same as the result of gen(0), but is different.\nx_0\nsage: mip.get_values(mip.gen(0))\n[...]\nTypeError: Not a MIPVariable: x_0\nsage: mip.is_real(mip.gen(0))\n[...]\nKeyError: x_0\nsage: mip.is_real(mip[0])\nTrue\n```",
    "created_at": "2016-05-13T07:23:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20461#issuecomment-278305",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>Actually I spoke too fast, it seems that `gen()` does not do anything useful. 

```
sage: mip = MixedIntegerLinearProgram(solver='GLPK')
sage: mip.gen(0)           ### Names a variable, but does not create it in the backend
x_0
sage: mip.number_of_variables()
0
sage: mip[0]                  ### This now creates a variable. It prints the same as the result of gen(0), but is different.
x_0
sage: mip.get_values(mip.gen(0))
[...]
TypeError: Not a MIPVariable: x_0
sage: mip.is_real(mip.gen(0))
[...]
KeyError: x_0
sage: mip.is_real(mip[0])
True
```



---

archive/issue_comments_278306.json:
```json
{
    "body": "<a id='comment:7'></a>Repairing `gen()` is now #20602.",
    "created_at": "2016-05-13T07:52:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20461#issuecomment-278306",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>Repairing `gen()` is now #20602.



---

archive/issue_events_055330.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2016-05-23T10:43:57Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "milestone": "sage-7.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20461#event-55330"
}
```



---

archive/issue_comments_278307.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-05-23T11:43:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20461#issuecomment-278307",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_278308.json:
```json
{
    "body": "<a id='comment:10'></a>New commits:",
    "created_at": "2016-05-23T11:43:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20461#issuecomment-278308",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>New commits:



---

archive/issue_comments_278309.json:
```json
{
    "body": "<a id='comment:12'></a>Needs review.",
    "created_at": "2016-05-31T09:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20461#issuecomment-278309",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>Needs review.



---

archive/issue_comments_278310.json:
```json
{
    "body": "<a id='comment:13'></a>Shouldn't `copy_for_mip` actually become `copy` ?\nOr there is a reason to keep `copy` as well?",
    "created_at": "2016-05-31T18:56:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20461#issuecomment-278310",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:13'></a>Shouldn't `copy_for_mip` actually become `copy` ?
Or there is a reason to keep `copy` as well?



---

archive/issue_comments_278311.json:
```json
{
    "body": "<a id='comment:14'></a>Currently there is no `copy`. \nIt seems an unusual operation to make a copy of a MIPVariable for the same problem.",
    "created_at": "2016-05-31T20:39:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20461#issuecomment-278311",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>Currently there is no `copy`. 
It seems an unusual operation to make a copy of a MIPVariable for the same problem.



---

archive/issue_comments_278312.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-05-31T21:21:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20461#issuecomment-278312",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_278313.json:
```json
{
    "body": "<a id='comment:16'></a>But anyway I made `__copy__` and `__deepcopy__` methods. (& rebased)",
    "created_at": "2016-05-31T21:21:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20461#issuecomment-278313",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>But anyway I made `__copy__` and `__deepcopy__` methods. (& rebased)



---

archive/issue_comments_278314.json:
```json
{
    "body": "<a id='comment:17'></a>ping?",
    "created_at": "2016-06-02T13:29:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20461#issuecomment-278314",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>ping?



---

archive/issue_comments_278315.json:
```json
{
    "body": "<a id='comment:18'></a>OK, looks good to me.",
    "created_at": "2016-06-02T14:21:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20461#issuecomment-278315",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:18'></a>OK, looks good to me.



---

archive/issue_comments_278316.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-06-02T14:21:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20461#issuecomment-278316",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_278317.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-06-02T21:00:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20461#issuecomment-278317",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_278318.json:
```json
{
    "body": "<a id='comment:19'></a>Reviewer name",
    "created_at": "2016-06-02T21:00:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20461#issuecomment-278318",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:19'></a>Reviewer name



---

archive/issue_comments_278319.json:
```json
{
    "body": "<a id='comment:20'></a>I will never learn the drill :-)",
    "created_at": "2016-06-02T21:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20461#issuecomment-278319",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:20'></a>I will never learn the drill :-)



---

archive/issue_comments_278320.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-06-02T22:35:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20461#issuecomment-278320",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_events_055331.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-06-05T01:10:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20461#event-55331"
}
```



---

archive/issue_comments_278321.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-06-05T01:10:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20461",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20461#issuecomment-278321",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
