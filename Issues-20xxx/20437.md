# Issue 20437: Misinstallation of Python in Cygwin

archive/issues_020200.json:
```json
{
    "body": "CC:  @tscrim gouezel jpflori\n\nI've encountered yet another problem in my quest to get sage building on Cygwin.  I'm surprised this hasn't come up before though which makes me wonder if I'm doing something wrong.\n\nThe DLL loader library, libpython2.7.dll.a, gets installed to `$(SAGE_LOCAL)/lib/python2.7/config/` which is not normally on the ld search path (similar on Python 3 I think).\n\nThis means that when building extension modules `-lpython2.7` is actually linking against my system Python (in this case the Python that came with cygwin--also Python 2.7.10).  This is of course wrong, but isn't a problem for the majority of modules, including sage itself (at least it wasn't a problem for compiling).  It was actually PIL(low) where this fell apart because it used some `PyUnicode_` functions that were not found in my system libpython because it was compiled with `--enable-unicode=ucs2`, whereas Sage builds Python with `--enable-unicode=ucs4`.\n\nWhen installing Python, Sage should be making a symlink to `$(SAGE_LOCAL)/lib/python2.7/config/libpython2.7.dll.a` in `$(SAGE_LOCAL)/lib`.\n\nI'm leaning toward calling this an upstream bug--I don't understand why this isn't done automatically by Python's Makefile.  The relevant portion begins [here](https://hg.python.org/cpython/file/v2.7.10/Makefile.pre.in#l916).  It seems that if a DLL is built it *does not* install a symlink to the loader library in lib/.  I've brought this up here: https://mail.python.org/pipermail/python-dev/2016-April/144315.html\n\nFor reference, Cygwin's own system package for Python installs this symlink manually...  It seems odd not to do it by default.\n\nIssue created by migration from https://trac.sagemath.org/ticket/20437\n\n",
    "closed_at": "2016-06-24T07:26:10Z",
    "created_at": "2016-04-13T13:57:46Z",
    "labels": [
        "component: porting: cygwin",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "Misinstallation of Python in Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20437",
    "user": "https://github.com/embray"
}
```
CC:  @tscrim gouezel jpflori

I've encountered yet another problem in my quest to get sage building on Cygwin.  I'm surprised this hasn't come up before though which makes me wonder if I'm doing something wrong.

The DLL loader library, libpython2.7.dll.a, gets installed to `$(SAGE_LOCAL)/lib/python2.7/config/` which is not normally on the ld search path (similar on Python 3 I think).

This means that when building extension modules `-lpython2.7` is actually linking against my system Python (in this case the Python that came with cygwin--also Python 2.7.10).  This is of course wrong, but isn't a problem for the majority of modules, including sage itself (at least it wasn't a problem for compiling).  It was actually PIL(low) where this fell apart because it used some `PyUnicode_` functions that were not found in my system libpython because it was compiled with `--enable-unicode=ucs2`, whereas Sage builds Python with `--enable-unicode=ucs4`.

When installing Python, Sage should be making a symlink to `$(SAGE_LOCAL)/lib/python2.7/config/libpython2.7.dll.a` in `$(SAGE_LOCAL)/lib`.

I'm leaning toward calling this an upstream bug--I don't understand why this isn't done automatically by Python's Makefile.  The relevant portion begins [here](https://hg.python.org/cpython/file/v2.7.10/Makefile.pre.in#l916).  It seems that if a DLL is built it *does not* install a symlink to the loader library in lib/.  I've brought this up here: https://mail.python.org/pipermail/python-dev/2016-April/144315.html

For reference, Cygwin's own system package for Python installs this symlink manually...  It seems odd not to do it by default.

Issue created by migration from https://trac.sagemath.org/ticket/20437





---

archive/issue_comments_278075.json:
```json
{
    "body": "After applying the following patch, I rebuilt python2, and was subsequently able to build pillow:\n\n```diff\ndiff --git a/build/pkgs/python2/spkg-install b/build/pkgs/python2/spkg-install\nindex db35674..b479ba3 100755\n--- a/build/pkgs/python2/spkg-install\n+++ b/build/pkgs/python2/spkg-install\n@@ -129,6 +129,9 @@ fi\n if [ \"$UNAME\" = \"Darwin\" ] && \\\n     [ `uname -r | cut '-d.' -f1` -gt 9 ]; then\n     rm -f \"$SAGE_LOCAL/lib/python2.7/config/libpython2.7.a\"\n+elif [ \"$UNAME\" = \"CYGWIN\" ]; then\n+    # See http://trac.sagemath.org/ticket/20437\n+    ln -sf \"python2.7/config/libpython2.7.dll.a\" \"$SAGE_LOCAL/lib/libpython2.7.dll.a\"\n fi\n\n # Make sure extension modules were built correctly.\n\n```\n\nShould probably do the same for Python 3.",
    "created_at": "2016-04-13T14:24:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20437#issuecomment-278075",
    "user": "https://github.com/embray"
}
```

After applying the following patch, I rebuilt python2, and was subsequently able to build pillow:

```diff
diff --git a/build/pkgs/python2/spkg-install b/build/pkgs/python2/spkg-install
index db35674..b479ba3 100755
--- a/build/pkgs/python2/spkg-install
+++ b/build/pkgs/python2/spkg-install
@@ -129,6 +129,9 @@ fi
 if [ "$UNAME" = "Darwin" ] && \
     [ `uname -r | cut '-d.' -f1` -gt 9 ]; then
     rm -f "$SAGE_LOCAL/lib/python2.7/config/libpython2.7.a"
+elif [ "$UNAME" = "CYGWIN" ]; then
+    # See http://trac.sagemath.org/ticket/20437
+    ln -sf "python2.7/config/libpython2.7.dll.a" "$SAGE_LOCAL/lib/libpython2.7.dll.a"
 fi

 # Make sure extension modules were built correctly.

```

Should probably do the same for Python 3.



---

archive/issue_comments_278076.json:
```json
{
    "body": "Added a patch for python2 and python2.  Basically the same as the above diff, but slightly enhanced to not use a hard-coded `pythonX.Y` version.\n\n---\nNew commits:",
    "created_at": "2016-04-14T15:46:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20437#issuecomment-278076",
    "user": "https://github.com/embray"
}
```

Added a patch for python2 and python2.  Basically the same as the above diff, but slightly enhanced to not use a hard-coded `pythonX.Y` version.

---
New commits:



---

archive/issue_comments_278077.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-04-14T15:46:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20437#issuecomment-278077",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_278078.json:
```json
{
    "body": "Hi Eric,\n\nonly sided notes (as I am not a Cygwin guy):\n\n- in the ticket, you should always fill the \"Authors\" field (with your full name). The reason is that patchbots completely ignore tickets where it is not set.\n\n- in a commit it is standard to have one short line description, a linebreak and then an optional description. That way the history is much more readable (e.g. with `git log --oneline`).",
    "created_at": "2016-04-14T17:40:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20437#issuecomment-278078",
    "user": "https://github.com/videlec"
}
```

Hi Eric,

only sided notes (as I am not a Cygwin guy):

- in the ticket, you should always fill the "Authors" field (with your full name). The reason is that patchbots completely ignore tickets where it is not set.

- in a commit it is standard to have one short line description, a linebreak and then an optional description. That way the history is much more readable (e.g. with `git log --oneline`).



---

archive/issue_comments_278079.json:
```json
{
    "body": "Sounds reasonable.",
    "created_at": "2016-04-15T12:00:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20437#issuecomment-278079",
    "user": "https://github.com/embray"
}
```

Sounds reasonable.



---

archive/issue_comments_278080.json:
```json
{
    "body": "Incidentally, is this documented somewhere?  I don't see anything about this use of the \"Authors\" field under http://doc.sagemath.org/html/en/developer/trac.html#section-trac-fields or here: https://wiki.sagemath.org/buildbot.  It would be nice if there were a single, easy to point to checklist for tickets--sort of a choose your own adventure story.",
    "created_at": "2016-04-15T12:04:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20437#issuecomment-278080",
    "user": "https://github.com/embray"
}
```

Incidentally, is this documented somewhere?  I don't see anything about this use of the "Authors" field under http://doc.sagemath.org/html/en/developer/trac.html#section-trac-fields or here: https://wiki.sagemath.org/buildbot.  It would be nice if there were a single, easy to point to checklist for tickets--sort of a choose your own adventure story.



---

archive/issue_comments_278081.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-04-15T12:08:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20437#issuecomment-278081",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_278082.json:
```json
{
    "body": "Build passed--any comments?",
    "created_at": "2016-04-22T12:23:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20437#issuecomment-278082",
    "user": "https://github.com/embray"
}
```

Build passed--any comments?



---

archive/issue_comments_278083.json:
```json
{
    "body": "One detail: you should quote `$SAGE_LOCAL/bin/python` as `\"$SAGE_LOCAL/bin/python\"` in case of funny characters in `$SAGE_LOCAL`.\n\nDid you report this upstream? The \"report upstream\" field says \"Not yet reported upstream; Will do shortly.\"",
    "created_at": "2016-04-22T12:33:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20437#issuecomment-278083",
    "user": "https://github.com/jdemeyer"
}
```

One detail: you should quote `$SAGE_LOCAL/bin/python` as `"$SAGE_LOCAL/bin/python"` in case of funny characters in `$SAGE_LOCAL`.

Did you report this upstream? The "report upstream" field says "Not yet reported upstream; Will do shortly."



---

archive/issue_comments_278084.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-04-22T12:33:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20437#issuecomment-278084",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_278085.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> One detail: you should quote `$SAGE_LOCAL/bin/python` as `\"$SAGE_LOCAL/bin/python\"` in case of funny characters in `$SAGE_LOCAL`.\n\n\nSure.\n\n> Did you report this upstream? The \"report upstream\" field says \"Not yet reported upstream; Will do shortly.\"\n\n\nI'll do that now.",
    "created_at": "2016-04-22T12:35:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20437#issuecomment-278085",
    "user": "https://github.com/embray"
}
```

Replying to [comment:9 jdemeyer]:
> One detail: you should quote `$SAGE_LOCAL/bin/python` as `"$SAGE_LOCAL/bin/python"` in case of funny characters in `$SAGE_LOCAL`.


Sure.

> Did you report this upstream? The "report upstream" field says "Not yet reported upstream; Will do shortly."


I'll do that now.



---

archive/issue_comments_278086.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-22T12:39:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20437#issuecomment-278086",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_278087.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-04-22T13:11:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20437#issuecomment-278087",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_278088.json:
```json
{
    "body": "Works for me. You can set if to positive review in a few days, if there is no answer from upstream.",
    "created_at": "2016-04-23T16:16:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20437#issuecomment-278088",
    "user": "https://trac.sagemath.org/admin/accounts/users/gouezel"
}
```

Works for me. You can set if to positive review in a few days, if there is no answer from upstream.



---

archive/issue_comments_278089.json:
```json
{
    "body": "No response from python-dev yet. I only asked on the mailing list though--might get more response if I opened a bug report instead.  I was just being polite and not assuming it was definitely a bug :)\n\nIt's only Monday though, and early yet in the Americas so I'll wait a little longer.",
    "created_at": "2016-04-25T10:28:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20437#issuecomment-278089",
    "user": "https://github.com/embray"
}
```

No response from python-dev yet. I only asked on the mailing list though--might get more response if I opened a bug report instead.  I was just being polite and not assuming it was definitely a bug :)

It's only Monday though, and early yet in the Americas so I'll wait a little longer.



---

archive/issue_comments_278090.json:
```json
{
    "body": "I opened a bug report about this in Python, and included a patch: http://bugs.python.org/issue27374 as this is more likely to at least be acknowledged than my original mailing list post.\n\nI wouldn't be surprised if this isn't acted on, or even if it is it won't be of any immediately help.  So it would be nice to go ahead and get this merged, given a positive review.",
    "created_at": "2016-06-23T15:23:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20437#issuecomment-278090",
    "user": "https://github.com/embray"
}
```

I opened a bug report about this in Python, and included a patch: http://bugs.python.org/issue27374 as this is more likely to at least be acknowledged than my original mailing list post.

I wouldn't be surprised if this isn't acted on, or even if it is it won't be of any immediately help.  So it would be nice to go ahead and get this merged, given a positive review.



---

archive/issue_comments_278091.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-06-23T15:27:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20437#issuecomment-278091",
    "user": "https://trac.sagemath.org/admin/accounts/users/gouezel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_278092.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-06-24T07:26:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20437",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20437#issuecomment-278092",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_055304.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-06-24T07:26:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20437",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20437#event-55304"
}
```
