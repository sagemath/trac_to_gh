# Issue 20646: gsl and linbox underlinked in sage-7.2

archive/issues_020409.json:
```json
{
    "assignees": [],
    "body": "When building sage-7.2 with `LDFLAGS=\"--as-needed\"` and the gold linker, the result is underlinked:\n\n```\nfrom sage.rings.complex_double import CDF\nImportError: /home/mjo/src/sage.git/local/lib/libgsl.so.19: undefined symbol: cblas_sdsdot\n```\n\nThis is because `libgsl.so` itself is underlinked as per upstream design. This doesn't work well when building a python loadable module which needs all its symbols (apart from those provided by python) to be resolved. \n\nThe gold linker in particular as a very strict interpretation of `--as-needed` and will not add library not needed directly by the object being linked. In this particular case sage.rings.complex_double needs gsl but doesn't use cblas and therefore cblas is not added to the list of needed libraries. libgsl.so itself need to import cblas.\n\nThe current branch provides a minimal non invasive fix to link libgsl.so to the current cblas. \n\nNote, that gsl already depends on `$(BLAS)` even so prior to this ticket it was not used.\n\nBranch/Commit: **[0486c05](https://github.com/sagemath/sagetrac-mirror/commit/0486c05e0d501e2428493c7db4314df26625f200)**\n\nReviewer: **Steven Trogdon, Michael Orlitzky**\n\nAuthor: **Fran\u00e7ois Bissey**\n\nComponent: **build**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/20646_\n\n",
    "closed_at": "2016-11-11T17:53:58Z",
    "created_at": "2016-05-21T13:33:15Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20build",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-7.5",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "gsl and linbox underlinked in sage-7.2",
    "type": "issue",
    "updated_at": "2016-11-11T17:53:58Z",
    "url": "https://github.com/sagemath/sage/issues/20646",
    "user": "https://github.com/orlitzky"
}
```
When building sage-7.2 with `LDFLAGS="--as-needed"` and the gold linker, the result is underlinked:

```
from sage.rings.complex_double import CDF
ImportError: /home/mjo/src/sage.git/local/lib/libgsl.so.19: undefined symbol: cblas_sdsdot
```

This is because `libgsl.so` itself is underlinked as per upstream design. This doesn't work well when building a python loadable module which needs all its symbols (apart from those provided by python) to be resolved. 

The gold linker in particular as a very strict interpretation of `--as-needed` and will not add library not needed directly by the object being linked. In this particular case sage.rings.complex_double needs gsl but doesn't use cblas and therefore cblas is not added to the list of needed libraries. libgsl.so itself need to import cblas.

The current branch provides a minimal non invasive fix to link libgsl.so to the current cblas. 

Note, that gsl already depends on `$(BLAS)` even so prior to this ticket it was not used.

Branch/Commit: **[0486c05](https://github.com/sagemath/sagetrac-mirror/commit/0486c05e0d501e2428493c7db4314df26625f200)**

Reviewer: **Steven Trogdon, Michael Orlitzky**

Author: **Fran√ßois Bissey**

Component: **build**

_Issue created by migration from https://trac.sagemath.org/ticket/20646_





---

archive/issue_events_290731.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2016-05-21T13:33:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "milestone_number": null,
    "milestone_title": "sage-7.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20646#event-290731"
}
```



---

archive/issue_events_290732.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2016-05-21T13:33:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "000080",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20646#event-290732"
}
```



---

archive/issue_events_290733.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2016-05-21T13:33:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20646#event-290733"
}
```



---

archive/issue_events_290734.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2016-05-21T13:33:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20646#event-290734"
}
```



---

archive/issue_comments_298566.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nSo should we add `-liml` in LinBox's `spkg-install`?\n\nOr patch LinBox in that way?",
    "created_at": "2016-08-08T14:38:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298566",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:1" align="right">comment:1</div>

So should we add `-liml` in LinBox's `spkg-install`?

Or patch LinBox in that way?



---

archive/issue_comments_298567.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nReplying to [@nexttime](#comment:1):\n> So should we add `-liml` in LinBox's `spkg-install`?\n> \n> Or patch LinBox in that way?\n\nFWIW, Sage-on-Gentoo (see:`https://github.com/cschwan/sage-on-gentoo/blob/master/sci-libs/linbox/linbox-1.3.2-r2.ebuild`) does this by appending `-liml` to the `LIBS` variable and not by patching.",
    "created_at": "2016-08-08T19:35:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298567",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:2" align="right">comment:2</div>

Replying to [@nexttime](#comment:1):
> So should we add `-liml` in LinBox's `spkg-install`?
> 
> Or patch LinBox in that way?

FWIW, Sage-on-Gentoo (see:`https://github.com/cschwan/sage-on-gentoo/blob/master/sci-libs/linbox/linbox-1.3.2-r2.ebuild`) does this by appending `-liml` to the `LIBS` variable and not by patching.



---

archive/issue_comments_298568.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nThird option:\n\nAdd\n\n```\n# distutils: libraries = iml\n```\nto `src/sage/libs/linbox/linbox.pxd`.",
    "created_at": "2016-08-08T19:45:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298568",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:3" align="right">comment:3</div>

Third option:

Add

```
# distutils: libraries = iml
```
to `src/sage/libs/linbox/linbox.pxd`.



---

archive/issue_comments_298569.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nReplying to [@nexttime](#comment:1):\n> So should we add `-liml` in LinBox's `spkg-install`?\n> \n\nThat's what I've been doing. But I noticed that the newer version of linbox (https://github.com/cschwan/sage-on-gentoo/tree/master/sci-libs/linbox) doesn't have the same \"append-libs\" hack, so if it's easier, an upgrade to linbox-1.4.1 probably fixes it as well.",
    "created_at": "2016-08-08T19:45:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298569",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:4" align="right">comment:4</div>

Replying to [@nexttime](#comment:1):
> So should we add `-liml` in LinBox's `spkg-install`?
> 

That's what I've been doing. But I noticed that the newer version of linbox (https://github.com/cschwan/sage-on-gentoo/tree/master/sci-libs/linbox) doesn't have the same "append-libs" hack, so if it's easier, an upgrade to linbox-1.4.1 probably fixes it as well.



---

archive/issue_comments_298570.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nOn the one hand, it looks like updating linbox will NOT be easier (see ticket #17635); on the other, it looks like a lot of the work has already been done.",
    "created_at": "2016-08-08T19:51:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298570",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:5" align="right">comment:5</div>

On the one hand, it looks like updating linbox will NOT be easier (see ticket #17635); on the other, it looks like a lot of the work has already been done.



---

archive/issue_comments_298571.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@orlitzky](#comment:5):\n> On the one hand, it looks like updating linbox will NOT be easier (see ticket #17635); on the other, it looks like a lot of the work has already been done.\n\nI was just going to say that.",
    "created_at": "2016-08-08T19:53:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298571",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@orlitzky](#comment:5):
> On the one hand, it looks like updating linbox will NOT be easier (see ticket #17635); on the other, it looks like a lot of the work has already been done.

I was just going to say that.



---

archive/issue_comments_298572.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\n#17635 is basically ready, modulo a rebasing and fixing minor platforms (32bit). I'd like to add that `libgsl` is underlinked upstream on purpose. In their opinion it is the responsibility of people downstream or writing their applications to provide a `cblas`.\n\nIt is our choice to provide extra linking. In that context I am not sure the gentoo patch as it is the way to go.\n\nThe people in the gentoo science overlay (including me) have not drunk the whole Kool-aid of their blas infrastructure when it comes to `gsl`. The reality is `gsl` should be split in `gslcblas` and `libgsl`. Then `libgsl` could just use `pkg-config` to find `cblas`. You still need to remove `libgslcblas.la` everywhere but you avoid adding a custom macro.",
    "created_at": "2016-08-08T21:04:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298572",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:7" align="right">comment:7</div>

#17635 is basically ready, modulo a rebasing and fixing minor platforms (32bit). I'd like to add that `libgsl` is underlinked upstream on purpose. In their opinion it is the responsibility of people downstream or writing their applications to provide a `cblas`.

It is our choice to provide extra linking. In that context I am not sure the gentoo patch as it is the way to go.

The people in the gentoo science overlay (including me) have not drunk the whole Kool-aid of their blas infrastructure when it comes to `gsl`. The reality is `gsl` should be split in `gslcblas` and `libgsl`. Then `libgsl` could just use `pkg-config` to find `cblas`. You still need to remove `libgslcblas.la` everywhere but you avoid adding a custom macro.



---

archive/issue_comments_298573.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nIs it still relevant now that the new `linbox` stack has been merged.",
    "created_at": "2016-10-22T22:45:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298573",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:8" align="right">comment:8</div>

Is it still relevant now that the new `linbox` stack has been merged.



---

archive/issue_comments_298574.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nI'm now unable to reproduce any of the issues associated with this ticket. Things implemented:\n* export export LDFLAGS=\"-Wl,--as-needed\"\n* rebuild (sage -f) `sagelib, gsl, linbox` (`gsl` was probably not necessary)\n\n`sage: from sage.rings.complex_double import CDF`\n\ndoes not fail and rebuilding `linbox` also rebuilds `iml` and `fflas_ffpack`. I don't know if using `atlas` will be a problem.",
    "created_at": "2016-10-24T15:34:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298574",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:9" align="right">comment:9</div>

I'm now unable to reproduce any of the issues associated with this ticket. Things implemented:
* export export LDFLAGS="-Wl,--as-needed"
* rebuild (sage -f) `sagelib, gsl, linbox` (`gsl` was probably not necessary)

`sage: from sage.rings.complex_double import CDF`

does not fail and rebuilding `linbox` also rebuilds `iml` and `fflas_ffpack`. I don't know if using `atlas` will be a problem.



---

archive/issue_comments_298575.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nThe linbox issue should be gone, but I don't know about gsl. I guess I'll have to recompile from scratch.",
    "created_at": "2016-10-24T15:46:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298575",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:10" align="right">comment:10</div>

The linbox issue should be gone, but I don't know about gsl. I guess I'll have to recompile from scratch.



---

archive/issue_comments_298576.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nWell `libgsl.so` is still underlinked as upstream intended, but anything linking to libgsl should also have been properly linked to a cblas library.",
    "created_at": "2016-10-24T20:07:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298576",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:11" align="right">comment:11</div>

Well `libgsl.so` is still underlinked as upstream intended, but anything linking to libgsl should also have been properly linked to a cblas library.



---

archive/issue_comments_298577.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@kiwifb](#comment:11):\n> Well `libgsl.so` is still underlinked as upstream intended, but anything linking to libgsl should also have been properly linked to a cblas library.\n\nYep, this is what I see. When there is linking with `libgsl.so` there also appears linking to `openblas`. Something like `-lgsl -lm -lopenblas`. And when `atlas` was used in say, `7.4.beta4` the linking would typically appear as `-lgsl ... -lm -latlas -lcblas`. I suspect everything is now OK.",
    "created_at": "2016-10-24T20:47:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298577",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@kiwifb](#comment:11):
> Well `libgsl.so` is still underlinked as upstream intended, but anything linking to libgsl should also have been properly linked to a cblas library.

Yep, this is what I see. When there is linking with `libgsl.so` there also appears linking to `openblas`. Something like `-lgsl -lm -lopenblas`. And when `atlas` was used in say, `7.4.beta4` the linking would typically appear as `-lgsl ... -lm -latlas -lcblas`. I suspect everything is now OK.



---

archive/issue_comments_298578.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nYup, it's fixed. Thanks for all your work on this stuff.",
    "created_at": "2016-10-25T12:19:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298578",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:13" align="right">comment:13</div>

Yup, it's fixed. Thanks for all your work on this stuff.



---

archive/issue_events_290735.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2016-10-25T12:19:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20646#event-290735"
}
```



---

archive/issue_events_290736.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2016-10-25T12:19:42Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "milestone_number": null,
    "milestone_title": "sage-7.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20646#event-290736"
}
```



---

archive/issue_events_290737.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2016-10-25T12:19:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20646#event-290737"
}
```



---

archive/issue_events_290738.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2016-10-25T12:19:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "label": "https://github.com/sagemath/sage/labels/invalid",
    "label_color": "a6a6a6",
    "label_name": "invalid",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20646#event-290738"
}
```



---

archive/issue_events_290739.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2016-10-25T12:20:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20646#event-290739"
}
```



---

archive/issue_events_290740.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2016-10-25T12:20:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20646#event-290740"
}
```



---

archive/issue_events_290741.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2016-10-30T19:27:35Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "milestone_number": null,
    "milestone_title": "sage-7.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20646#event-290741"
}
```



---

archive/issue_events_290742.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2016-10-30T19:27:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20646#event-290742"
}
```



---

archive/issue_events_290743.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2016-10-30T19:27:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20646#event-290743"
}
```



---

archive/issue_comments_298579.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nOops, I just tried to run the sage that I built 5 days ago:\n\n```\n   from sage.misc.all       import *         # takes a while\n  File \"/home/mjo/src/sage.git/local/lib/python2.7/site-packages/sage/misc/all.py\", line 89, in <module>\n    from .functional import (additive_order,\n  File \"/home/mjo/src/sage.git/local/lib/python2.7/site-packages/sage/misc/functional.py\", line 32, in <module>\n    from sage.rings.complex_double import CDF\nImportError: /home/mjo/src/sage.git/local/lib/libgsl.so.19: undefined symbol: cblas_sdsdot\n```",
    "created_at": "2016-10-30T19:27:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298579",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:15" align="right">comment:15</div>

Oops, I just tried to run the sage that I built 5 days ago:

```
   from sage.misc.all       import *         # takes a while
  File "/home/mjo/src/sage.git/local/lib/python2.7/site-packages/sage/misc/all.py", line 89, in <module>
    from .functional import (additive_order,
  File "/home/mjo/src/sage.git/local/lib/python2.7/site-packages/sage/misc/functional.py", line 32, in <module>
    from sage.rings.complex_double import CDF
ImportError: /home/mjo/src/sage.git/local/lib/libgsl.so.19: undefined symbol: cblas_sdsdot
```



---

archive/issue_comments_298580.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nThat's interesting. Can you post the output of \n\n```\nreadelf -d /home/mjo/src/sage.git/local/lib/python2.7/site-packages/sage/rings/complex_double.so\n```",
    "created_at": "2016-10-30T20:12:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298580",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:16" align="right">comment:16</div>

That's interesting. Can you post the output of 

```
readelf -d /home/mjo/src/sage.git/local/lib/python2.7/site-packages/sage/rings/complex_double.so
```



---

archive/issue_comments_298581.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@kiwifb](#comment:16):\n> That's interesting. Can you post the output of \n> \n> ```\n> readelf -d /home/mjo/src/sage.git/local/lib/python2.7/site-packages/sage/rings/complex_double.so\n> ```\n\n\\\\\n\nSure:\n\n```\nDynamic section at offset 0x48200 contains 34 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000003 (PLTGOT)             0x49660\n 0x0000000000000002 (PLTRELSZ)           3672 (bytes)\n 0x0000000000000017 (JMPREL)             0x7aa0\n 0x0000000000000014 (PLTREL)             RELA\n 0x0000000000000007 (RELA)               0x2d60\n 0x0000000000000008 (RELASZ)             19776 (bytes)\n 0x0000000000000009 (RELAENT)            24 (bytes)\n 0x000000006ffffff9 (RELACOUNT)          762\n 0x0000000000000006 (SYMTAB)             0x190\n 0x000000000000000b (SYMENT)             24 (bytes)\n 0x0000000000000005 (STRTAB)             0x15a0\n 0x000000000000000a (STRSZ)              5292 (bytes)\n 0x000000006ffffef5 (GNU_HASH)           0x2a50\n 0x0000000000000001 (NEEDED)             Shared library: [libgsl.so.19]\n 0x0000000000000001 (NEEDED)             Shared library: [libpari-gmp-2.8.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n 0x000000000000000c (INIT)               0x88f8\n 0x000000000000000d (FINI)               0x40af0\n 0x000000000000001a (FINI_ARRAY)         0x5b4c8\n 0x000000000000001c (FINI_ARRAYSZ)       8 (bytes)\n 0x0000000000000019 (INIT_ARRAY)         0x5b4d0\n 0x000000000000001b (INIT_ARRAYSZ)       8 (bytes)\n 0x000000000000001d (RUNPATH)            Library runpath: [/home/mjo/src/sage.git/local/lib]\n 0x000000000000001e (FLAGS)              BIND_NOW\n 0x000000006ffffffb (FLAGS_1)            Flags: NOW\n 0x000000006ffffff0 (VERSYM)             0x2b44\n 0x000000006ffffffc (VERDEF)             0x2cf0\n 0x000000006ffffffd (VERDEFNUM)          1\n 0x000000006ffffffe (VERNEED)            0x2d0c\n 0x000000006fffffff (VERNEEDNUM)         2\n 0x0000000000000000 (NULL)               0x0\n```",
    "created_at": "2016-10-30T20:33:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298581",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@kiwifb](#comment:16):
> That's interesting. Can you post the output of 
> 
> ```
> readelf -d /home/mjo/src/sage.git/local/lib/python2.7/site-packages/sage/rings/complex_double.so
> ```

\\

Sure:

```
Dynamic section at offset 0x48200 contains 34 entries:
  Tag        Type                         Name/Value
 0x0000000000000003 (PLTGOT)             0x49660
 0x0000000000000002 (PLTRELSZ)           3672 (bytes)
 0x0000000000000017 (JMPREL)             0x7aa0
 0x0000000000000014 (PLTREL)             RELA
 0x0000000000000007 (RELA)               0x2d60
 0x0000000000000008 (RELASZ)             19776 (bytes)
 0x0000000000000009 (RELAENT)            24 (bytes)
 0x000000006ffffff9 (RELACOUNT)          762
 0x0000000000000006 (SYMTAB)             0x190
 0x000000000000000b (SYMENT)             24 (bytes)
 0x0000000000000005 (STRTAB)             0x15a0
 0x000000000000000a (STRSZ)              5292 (bytes)
 0x000000006ffffef5 (GNU_HASH)           0x2a50
 0x0000000000000001 (NEEDED)             Shared library: [libgsl.so.19]
 0x0000000000000001 (NEEDED)             Shared library: [libpari-gmp-2.8.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000c (INIT)               0x88f8
 0x000000000000000d (FINI)               0x40af0
 0x000000000000001a (FINI_ARRAY)         0x5b4c8
 0x000000000000001c (FINI_ARRAYSZ)       8 (bytes)
 0x0000000000000019 (INIT_ARRAY)         0x5b4d0
 0x000000000000001b (INIT_ARRAYSZ)       8 (bytes)
 0x000000000000001d (RUNPATH)            Library runpath: [/home/mjo/src/sage.git/local/lib]
 0x000000000000001e (FLAGS)              BIND_NOW
 0x000000006ffffffb (FLAGS_1)            Flags: NOW
 0x000000006ffffff0 (VERSYM)             0x2b44
 0x000000006ffffffc (VERDEF)             0x2cf0
 0x000000006ffffffd (VERDEFNUM)          1
 0x000000006ffffffe (VERNEED)            0x2d0c
 0x000000006fffffff (VERNEEDNUM)         2
 0x0000000000000000 (NULL)               0x0
```



---

archive/issue_comments_298582.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nInteresting my install in sage-on-gentoo shows\n\n```\nreadelf -d /usr/lib64/python2.7/site-packages/sage/rings/complex_double.so\n\nDynamic section at offset 0x46c00 contains 29 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libgsl.so.19]\n 0x0000000000000001 (NEEDED)             Shared library: [libpari-gmp-2.8.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libopenblas_threads.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n```\nSo I have openblas here. It could be a library order problem. When `complex_double.so` is linked, is `-lopenblas` before `-lgsl`? Since this is a shared library it is legal to underlink. May be you should try a build with `-Wl,--no-undefined` to catch funny stuff.",
    "created_at": "2016-10-30T20:40:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298582",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:18" align="right">comment:18</div>

Interesting my install in sage-on-gentoo shows

```
readelf -d /usr/lib64/python2.7/site-packages/sage/rings/complex_double.so

Dynamic section at offset 0x46c00 contains 29 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libgsl.so.19]
 0x0000000000000001 (NEEDED)             Shared library: [libpari-gmp-2.8.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libopenblas_threads.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
```
So I have openblas here. It could be a library order problem. When `complex_double.so` is linked, is `-lopenblas` before `-lgsl`? Since this is a shared library it is legal to underlink. May be you should try a build with `-Wl,--no-undefined` to catch funny stuff.



---

archive/issue_comments_298583.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nHum my own log for vanilla 7.4 show that the order is correct at least here\n\n```\ngcc -pthread -shared -L/home/fbissey/sandbox/git-fork/sage-7.4/local/lib -Wl,-rpath,/home/fbissey/sandbox/git-fork/sage-7.4/local/lib -L/home/fbissey/sandbox/git-fork/sage-7.4/local/lib -Wl,-rpath,/home/fbissey/sandbox/git-fork/sage-7.4/local/lib build/temp.linux-x86_64-2.7/home/fbissey/sandbox/git-fork/sage-7.4/src/build/cythonized/sage/rings/complex_double.o -L/home/fbissey/sandbox/git-fork/sage-7.4/local/lib -L/home/fbissey/sandbox/git-fork/sage-7.4/local/lib -lgsl -lpari -lgmp -lm -lopenblas -lpython2.7 -o build/lib.linux-x86_64-2.7/sage/rings/complex_double.so -lpari -Ddummy\n```",
    "created_at": "2016-10-30T20:45:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298583",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:19" align="right">comment:19</div>

Hum my own log for vanilla 7.4 show that the order is correct at least here

```
gcc -pthread -shared -L/home/fbissey/sandbox/git-fork/sage-7.4/local/lib -Wl,-rpath,/home/fbissey/sandbox/git-fork/sage-7.4/local/lib -L/home/fbissey/sandbox/git-fork/sage-7.4/local/lib -Wl,-rpath,/home/fbissey/sandbox/git-fork/sage-7.4/local/lib build/temp.linux-x86_64-2.7/home/fbissey/sandbox/git-fork/sage-7.4/src/build/cythonized/sage/rings/complex_double.o -L/home/fbissey/sandbox/git-fork/sage-7.4/local/lib -L/home/fbissey/sandbox/git-fork/sage-7.4/local/lib -lgsl -lpari -lgmp -lm -lopenblas -lpython2.7 -o build/lib.linux-x86_64-2.7/sage/rings/complex_double.so -lpari -Ddummy
```



---

archive/issue_comments_298584.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nThis is what I've got in my sagelib log:\n\n```\ngcc -pthread -shared -L/home/mjo/src/sage.git/local/lib -Wl,-rpath,/home/mjo/src/sage.git/local/lib -Wl,-O1 -Wl,--as-needed -L/home/mjo/src/sage.git/local/lib -Wl,-rpath,/home/mjo/src/sage.git/local/lib -Wl,-O1 -Wl,--as-needed -march=native -O2 -pipe build/temp.linux-x86_64-2.7/home/mjo/src/sage.git/src/build/cythonized/sage/rings/complex_double.o -L/home/mjo/src/sage.git/local/lib -L/home/mjo/src/sage.git/local/lib -lgsl -lpari -lgmp -lm -lopenblas -lpython2.7 -o build/lib.linux-x86_64-2.7/sage/rings/complex_double.so -lpari -Ddummy\n```\n\nThe difference that stands out to me is `--as-needed`... won't it refuse to link OpenBLAS into the result if `complex_double.so` fails to use its symbols directly?",
    "created_at": "2016-10-30T22:46:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298584",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:20" align="right">comment:20</div>

This is what I've got in my sagelib log:

```
gcc -pthread -shared -L/home/mjo/src/sage.git/local/lib -Wl,-rpath,/home/mjo/src/sage.git/local/lib -Wl,-O1 -Wl,--as-needed -L/home/mjo/src/sage.git/local/lib -Wl,-rpath,/home/mjo/src/sage.git/local/lib -Wl,-O1 -Wl,--as-needed -march=native -O2 -pipe build/temp.linux-x86_64-2.7/home/mjo/src/sage.git/src/build/cythonized/sage/rings/complex_double.o -L/home/mjo/src/sage.git/local/lib -L/home/mjo/src/sage.git/local/lib -lgsl -lpari -lgmp -lm -lopenblas -lpython2.7 -o build/lib.linux-x86_64-2.7/sage/rings/complex_double.so -lpari -Ddummy
```

The difference that stands out to me is `--as-needed`... won't it refuse to link OpenBLAS into the result if `complex_double.so` fails to use its symbols directly?



---

archive/issue_comments_298585.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nI have\n\n```\ngcc -pthread -shared -L/64bitdev/storage/sage-git_develop/sage/local/lib -Wl,-rpath,/64bitdev/storage/sage-git_develop/sage/local/lib -L/64bitdev/storage/sage-git_develop/sage/local/lib -Wl,-rpath,/64bitdev/storage/sage-git_develop/sage/local/lib -Wl,--as-needed build/temp.linux-x86_64-2.7/64bitdev/storage/sage-git_develop/sage/src/build/cythonized/sage/rings/complex_double.o -L/64bitdev/storage/sage-git_develop/sage/local/lib -L/64bitdev/storage/sage-git_develop/sage/local/lib -lgsl -lpari -lgmp -lm -lopenblas -lpython2.7 -o build/lib.linux-x86_64-2.7/sage/rings/complex_double.so -lpari -Ddummy\n```\nbut shouldn't the linking be with `g++`?",
    "created_at": "2016-10-30T22:51:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298585",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:21" align="right">comment:21</div>

I have

```
gcc -pthread -shared -L/64bitdev/storage/sage-git_develop/sage/local/lib -Wl,-rpath,/64bitdev/storage/sage-git_develop/sage/local/lib -L/64bitdev/storage/sage-git_develop/sage/local/lib -Wl,-rpath,/64bitdev/storage/sage-git_develop/sage/local/lib -Wl,--as-needed build/temp.linux-x86_64-2.7/64bitdev/storage/sage-git_develop/sage/src/build/cythonized/sage/rings/complex_double.o -L/64bitdev/storage/sage-git_develop/sage/local/lib -L/64bitdev/storage/sage-git_develop/sage/local/lib -lgsl -lpari -lgmp -lm -lopenblas -lpython2.7 -o build/lib.linux-x86_64-2.7/sage/rings/complex_double.so -lpari -Ddummy
```
but shouldn't the linking be with `g++`?



---

archive/issue_comments_298586.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nI'm also using gold instead of the default BFD linker, if that turns out to matter. On gentoo the switch amounts to\n\n```\n$ sudo binutils-config --linker ld.gold\n```",
    "created_at": "2016-10-30T23:09:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298586",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:22" align="right">comment:22</div>

I'm also using gold instead of the default BFD linker, if that turns out to matter. On gentoo the switch amounts to

```
$ sudo binutils-config --linker ld.gold
```



---

archive/issue_comments_298587.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nRebuilt `sagelib` here using `LDFLAGS=-Wl,-O1 -Wl,--as-needed` instead of `LDFLAGS=-Wl,--as-needed`, just in case; still no issue. I am using gentoo default BFD linker.",
    "created_at": "2016-10-30T23:47:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298587",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:23" align="right">comment:23</div>

Rebuilt `sagelib` here using `LDFLAGS=-Wl,-O1 -Wl,--as-needed` instead of `LDFLAGS=-Wl,--as-needed`, just in case; still no issue. I am using gentoo default BFD linker.



---

archive/issue_comments_298588.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nReplying to [@orlitzky](#comment:22):\n> I'm also using gold instead of the default BFD linker, if that turns out to matter. On gentoo the switch amounts to\n> \n> ```\n> $ sudo binutils-config --linker ld.gold\n> ```\n\nIt usually does with matter regarding `--as-needed` in my experience.",
    "created_at": "2016-10-30T23:57:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298588",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:24" align="right">comment:24</div>

Replying to [@orlitzky](#comment:22):
> I'm also using gold instead of the default BFD linker, if that turns out to matter. On gentoo the switch amounts to
> 
> ```
> $ sudo binutils-config --linker ld.gold
> ```

It usually does with matter regarding `--as-needed` in my experience.



---

archive/issue_comments_298589.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nSomehow I had another comment that escaped posting :( The gold linker has a more strict interpretation of `--as-needed` and in this case `libgsl` would need to be linked to `cblas` itself.\n\nIt could be interesting to try adding `-Wl,--no-allow-shlib-undefined` as an additional `LDFLAGS`.",
    "created_at": "2016-11-01T08:44:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298589",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:25" align="right">comment:25</div>

Somehow I had another comment that escaped posting :( The gold linker has a more strict interpretation of `--as-needed` and in this case `libgsl` would need to be linked to `cblas` itself.

It could be interesting to try adding `-Wl,--no-allow-shlib-undefined` as an additional `LDFLAGS`.



---

archive/issue_comments_298590.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@kiwifb](#comment:25):\n> \n> It could be interesting to try adding `-Wl,--no-allow-shlib-undefined` as an additional `LDFLAGS`.\n\nI didn't notice anything different, with a clean build of 7.5.beta1, it dies when it tries to build the docs at the end of compilation:\n\n```\n$ LDFLAGS=\"-Wl,-O1 -Wl,--as-needed -Wl,--no-allow-shlib-undefined\" CFLAGS=\"${CFLAGS}\" make -j4\n...\n[conway_polynomials-0.4.p0] Finished installing conway_polynomials-0.4.p0.spkg\ncd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html ' logs/dochtml.log\n[dochtml] /home/mjo/src/sage.git/local/bin/python: /home/mjo/src/sage.git/local/lib/libgsl.so.19: undefined symbol: cblas_sdsdot; 'sage_setup.docbuild' is a package and cannot be directly executed\nMakefile:1063: recipe for target 'doc-html' failed\n```\n\nI don't see anything unusual in that same spot in the sagelib build log either, but I don't really know what I'm looking for. I think the additional linker flag should have made it fail?",
    "created_at": "2016-11-01T20:13:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298590",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@kiwifb](#comment:25):
> 
> It could be interesting to try adding `-Wl,--no-allow-shlib-undefined` as an additional `LDFLAGS`.

I didn't notice anything different, with a clean build of 7.5.beta1, it dies when it tries to build the docs at the end of compilation:

```
$ LDFLAGS="-Wl,-O1 -Wl,--as-needed -Wl,--no-allow-shlib-undefined" CFLAGS="${CFLAGS}" make -j4
...
[conway_polynomials-0.4.p0] Finished installing conway_polynomials-0.4.p0.spkg
cd ../.. && sage-logger -p './sage --docbuild --no-pdf-links all html ' logs/dochtml.log
[dochtml] /home/mjo/src/sage.git/local/bin/python: /home/mjo/src/sage.git/local/lib/libgsl.so.19: undefined symbol: cblas_sdsdot; 'sage_setup.docbuild' is a package and cannot be directly executed
Makefile:1063: recipe for target 'doc-html' failed
```

I don't see anything unusual in that same spot in the sagelib build log either, but I don't really know what I'm looking for. I think the additional linker flag should have made it fail?



---

archive/issue_comments_298591.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nFailure to link would have been my minimal expectation.\n\nSo the option we have:\n* link `libgsl.so` to the selected cblas (openblas or atlas) when it is built.\n* add a `-Wl,--no-as-needed` flag to all files linking to `libgsl.so` in the sage library.\n\nThe first one may be achieved by adding\n\n```\nLIBS=`pkg-config --libs-only-l cblas`\n```\nto the configure line of `gsl`'s spkg-install. I think.\n\nThe second one may be achievable by alteration of `gsl.pc` by manually adding the flag we want. Possibly by patching `gsl.pc.in` before building `gsl`.\n\nPick your poison.",
    "created_at": "2016-11-01T20:45:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298591",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:27" align="right">comment:27</div>

Failure to link would have been my minimal expectation.

So the option we have:
* link `libgsl.so` to the selected cblas (openblas or atlas) when it is built.
* add a `-Wl,--no-as-needed` flag to all files linking to `libgsl.so` in the sage library.

The first one may be achieved by adding

```
LIBS=`pkg-config --libs-only-l cblas`
```
to the configure line of `gsl`'s spkg-install. I think.

The second one may be achievable by alteration of `gsl.pc` by manually adding the flag we want. Possibly by patching `gsl.pc.in` before building `gsl`.

Pick your poison.



---

archive/issue_comments_298592.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nHum, `$(BLAS)` is currently in `gsl`'s dependency but is not in fact used.",
    "created_at": "2016-11-01T20:49:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298592",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:28" align="right">comment:28</div>

Hum, `$(BLAS)` is currently in `gsl`'s dependency but is not in fact used.



---

archive/issue_comments_298593.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\n\n```\n./configure --prefix=\"$SAGE_LOCAL\" --libdir=\"$SAGE_LOCAL/lib\" \\\n   LIBS=\"`pkg-config --libs-only-l cblas` -lm\"\n```\n`-lm` is needed for some reason. Possibly setting `LIBS` interferes with it being added, `libopenblas.so` is certainly properly linked to it.",
    "created_at": "2016-11-01T20:58:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298593",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:29" align="right">comment:29</div>


```
./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" \
   LIBS="`pkg-config --libs-only-l cblas` -lm"
```
`-lm` is needed for some reason. Possibly setting `LIBS` interferes with it being added, `libopenblas.so` is certainly properly linked to it.



---

archive/issue_comments_298594.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nReplying to [@kiwifb](#comment:29):\n> \n> ```\n> ./configure --prefix=\"$SAGE_LOCAL\" --libdir=\"$SAGE_LOCAL/lib\" \\\n>    LIBS=\"`pkg-config --libs-only-l cblas` -lm\"\n> ```\n> `-lm` is needed for some reason. Possibly setting `LIBS` interferes with it being added, `libopenblas.so` is certainly properly linked to it.\n\nDo you think the order of where `-lm` appears is important? I always see `-lgsl ... -lm -lopenblas ...` in the `sagelib` log. I'm not sure where the order is set.",
    "created_at": "2016-11-01T22:08:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298594",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:30" align="right">comment:30</div>

Replying to [@kiwifb](#comment:29):
> 
> ```
> ./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" \
>    LIBS="`pkg-config --libs-only-l cblas` -lm"
> ```
> `-lm` is needed for some reason. Possibly setting `LIBS` interferes with it being added, `libopenblas.so` is certainly properly linked to it.

Do you think the order of where `-lm` appears is important? I always see `-lgsl ... -lm -lopenblas ...` in the `sagelib` log. I'm not sure where the order is set.



---

archive/issue_comments_298595.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nI don't think the order is important in that case, because openblas doesn't need it according to ldd and readelf. It certainly would be important if libopenblas wasn't linked to libm. Then it would have to be after. And even so, with gold, if the stuff you link doesn't use libm directly, it won't appear in the final shared object and you will be in the same situation as with gsl needing cblas.",
    "created_at": "2016-11-01T22:12:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298595",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:31" align="right">comment:31</div>

I don't think the order is important in that case, because openblas doesn't need it according to ldd and readelf. It certainly would be important if libopenblas wasn't linked to libm. Then it would have to be after. And even so, with gold, if the stuff you link doesn't use libm directly, it won't appear in the final shared object and you will be in the same situation as with gsl needing cblas.



---

archive/issue_comments_298596.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nReplying to [@kiwifb](#comment:27):\n> Failure to link would have been my minimal expectation.\n> \n> So the option we have:\n> * link `libgsl.so` to the selected cblas (openblas or atlas) when it is built.\n> * add a `-Wl,--no-as-needed` flag to all files linking to `libgsl.so` in the sage library.\n> \n> The first one may be achieved by adding\n> \n> ```\n> LIBS=`pkg-config --libs-only-l cblas`\n> ```\n> to the configure line of `gsl`'s spkg-install. I think.\n> \n> The second one may be achievable by alteration of `gsl.pc` by manually adding the flag we want. Possibly by patching `gsl.pc.in` before building `gsl`.\n> \n> Pick your poison.\n\nIt seems to me that altering the `gsl.pc` file is like a SoG build with `USE=cblas-external`. And this approach will require a change in the configure of `gsl` resulting in increased package maintenance on the Sage end. But doing it would remove undefined `cblas` symbols in `libgsl`.",
    "created_at": "2016-11-02T21:51:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298596",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:32" align="right">comment:32</div>

Replying to [@kiwifb](#comment:27):
> Failure to link would have been my minimal expectation.
> 
> So the option we have:
> * link `libgsl.so` to the selected cblas (openblas or atlas) when it is built.
> * add a `-Wl,--no-as-needed` flag to all files linking to `libgsl.so` in the sage library.
> 
> The first one may be achieved by adding
> 
> ```
> LIBS=`pkg-config --libs-only-l cblas`
> ```
> to the configure line of `gsl`'s spkg-install. I think.
> 
> The second one may be achievable by alteration of `gsl.pc` by manually adding the flag we want. Possibly by patching `gsl.pc.in` before building `gsl`.
> 
> Pick your poison.

It seems to me that altering the `gsl.pc` file is like a SoG build with `USE=cblas-external`. And this approach will require a change in the configure of `gsl` resulting in increased package maintenance on the Sage end. But doing it would remove undefined `cblas` symbols in `libgsl`.



---

archive/issue_comments_298597.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nReplying to [@kiwifb](#comment:27):\n> Failure to link would have been my minimal expectation.\n> \n> So the option we have:\n> * link `libgsl.so` to the selected cblas (openblas or atlas) when it is built.\n\n\\\\\n\nWhen I first encountered this, I thought the fact that GSL wasn't linked to CBLAS was a bug, but then you pointed out that upstream leaves it that way on purpose. What's the benefit of doing so in Sage, where we know that everything is going to transitively link to the same CBLAS anyway?\n\nRequiring consumers to fill in your missing symbols still seems backwards to me, but I don't want to judge it wrong too quickly.",
    "created_at": "2016-11-03T00:11:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298597",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:33" align="right">comment:33</div>

Replying to [@kiwifb](#comment:27):
> Failure to link would have been my minimal expectation.
> 
> So the option we have:
> * link `libgsl.so` to the selected cblas (openblas or atlas) when it is built.

\\

When I first encountered this, I thought the fact that GSL wasn't linked to CBLAS was a bug, but then you pointed out that upstream leaves it that way on purpose. What's the benefit of doing so in Sage, where we know that everything is going to transitively link to the same CBLAS anyway?

Requiring consumers to fill in your missing symbols still seems backwards to me, but I don't want to judge it wrong too quickly.



---

archive/issue_comments_298598.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\n@ Steve adding -lopenblas won't work. It is not the only thing we do.\n\n@ mjo, underlinking is legal but no distro leave it way I think. The wheels come of for shared objects such as those used by python, bfd linker does ok but gold doesn't want to cater to that case I think. Not their goal. I'd rather link gsl in sage, the dependency is there already.\n\nSend from my iPhone from school camp\ud83d\ude00",
    "created_at": "2016-11-03T03:13:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298598",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:34" align="right">comment:34</div>

@ Steve adding -lopenblas won't work. It is not the only thing we do.

@ mjo, underlinking is legal but no distro leave it way I think. The wheels come of for shared objects such as those used by python, bfd linker does ok but gold doesn't want to cater to that case I think. Not their goal. I'd rather link gsl in sage, the dependency is there already.

Send from my iPhone from school campüòÄ



---

archive/issue_comments_298599.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nReplying to [@kiwifb](#comment:34):\n> \n> I'd rather link gsl in sage, the dependency is there already.\n\nIf there are no hidden pitfalls, then this is simple and unobtrusive and has my vote.",
    "created_at": "2016-11-03T17:55:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298599",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:35" align="right">comment:35</div>

Replying to [@kiwifb](#comment:34):
> 
> I'd rather link gsl in sage, the dependency is there already.

If there are no hidden pitfalls, then this is simple and unobtrusive and has my vote.



---

archive/issue_comments_298600.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nReplying to [@orlitzky](#comment:35):\n> Replying to [@kiwifb](#comment:34):\n> > \n> > I'd rather link gsl in sage, the dependency is there already.\n\n> \n> If there are no hidden pitfalls, then this is simple and unobtrusive and has my vote.\n> \n\nditto\n\nor in common parlance\n\n+1",
    "created_at": "2016-11-03T18:09:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298600",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:36" align="right">comment:36</div>

Replying to [@orlitzky](#comment:35):
> Replying to [@kiwifb](#comment:34):
> > 
> > I'd rather link gsl in sage, the dependency is there already.

> 
> If there are no hidden pitfalls, then this is simple and unobtrusive and has my vote.
> 

ditto

or in common parlance

+1



---

archive/issue_comments_298601.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nThe way I outlined is indeed simple and not intrusive. Downside, `libgslcblas.so` is probably unusable. Not sure we care that much, but there should be a warning somewhere.\n\n```\n readelf -d /home/fbissey/sandbox/git-fork/sage-7.4/local/lib/libgslcblas.so\n\nDynamic section at offset 0x3ddd0 contains 28 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libopenblas.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n 0x000000000000000e (SONAME)             Library soname: [libgslcblas.so.0]\n 0x000000000000001d (RUNPATH)            Library runpath: [/home/fbissey/sandbox/git-fork/sage-7.4/local/lib]\n```\nIn concrete terms I am not sure which cblas you are getting when linking with it.",
    "created_at": "2016-11-04T07:17:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298601",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:37" align="right">comment:37</div>

The way I outlined is indeed simple and not intrusive. Downside, `libgslcblas.so` is probably unusable. Not sure we care that much, but there should be a warning somewhere.

```
 readelf -d /home/fbissey/sandbox/git-fork/sage-7.4/local/lib/libgslcblas.so

Dynamic section at offset 0x3ddd0 contains 28 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libopenblas.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000e (SONAME)             Library soname: [libgslcblas.so.0]
 0x000000000000001d (RUNPATH)            Library runpath: [/home/fbissey/sandbox/git-fork/sage-7.4/local/lib]
```
In concrete terms I am not sure which cblas you are getting when linking with it.



---

archive/issue_comments_298602.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nReplying to [@kiwifb](#comment:37):\n> The way I outlined is indeed simple and not intrusive. Downside, `libgslcblas.so` is probably unusable. Not sure we care that much, but there should be a warning somewhere.\n> \n> ```\n>  readelf -d /home/fbissey/sandbox/git-fork/sage-7.4/local/lib/libgslcblas.so\n> \n> Dynamic section at offset 0x3ddd0 contains 28 entries:\n>   Tag        Type                         Name/Value\n>  0x0000000000000001 (NEEDED)             Shared library: [libopenblas.so.0]\n>  0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\n>  0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n>  0x000000000000000e (SONAME)             Library soname: [libgslcblas.so.0]\n>  0x000000000000001d (RUNPATH)            Library runpath: [/home/fbissey/sandbox/git-fork/sage-7.4/local/lib]\n> ```\n> In concrete terms I am not sure which cblas you are getting when linking with it.\n\nWith my default BFD linker and extra linker flags `-Wl,-O1 -Wl,--as-needed` I have no linking to `cblas`.\n\n```\nDynamic section at offset 0x3cde0 contains 27 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n 0x000000000000000e (SONAME)             Library soname: [libgslcblas.so.0]\n 0x000000000000001d (RUNPATH)            Library runpath: [/64bitdev/storage/sage-git_develop/sage/local/lib]\n```",
    "created_at": "2016-11-04T15:45:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298602",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:38" align="right">comment:38</div>

Replying to [@kiwifb](#comment:37):
> The way I outlined is indeed simple and not intrusive. Downside, `libgslcblas.so` is probably unusable. Not sure we care that much, but there should be a warning somewhere.
> 
> ```
>  readelf -d /home/fbissey/sandbox/git-fork/sage-7.4/local/lib/libgslcblas.so
> 
> Dynamic section at offset 0x3ddd0 contains 28 entries:
>   Tag        Type                         Name/Value
>  0x0000000000000001 (NEEDED)             Shared library: [libopenblas.so.0]
>  0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]
>  0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
>  0x000000000000000e (SONAME)             Library soname: [libgslcblas.so.0]
>  0x000000000000001d (RUNPATH)            Library runpath: [/home/fbissey/sandbox/git-fork/sage-7.4/local/lib]
> ```
> In concrete terms I am not sure which cblas you are getting when linking with it.

With my default BFD linker and extra linker flags `-Wl,-O1 -Wl,--as-needed` I have no linking to `cblas`.

```
Dynamic section at offset 0x3cde0 contains 27 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000e (SONAME)             Library soname: [libgslcblas.so.0]
 0x000000000000001d (RUNPATH)            Library runpath: [/64bitdev/storage/sage-git_develop/sage/local/lib]
```



---

archive/issue_comments_298603.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nProbably a bad manipulation on my part then. It will be present for people not using `--as-needed` though. I'll post a branch later. I may also revamp the description a bit.",
    "created_at": "2016-11-05T20:45:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298603",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:39" align="right">comment:39</div>

Probably a bad manipulation on my part then. It will be present for people not using `--as-needed` though. I'll post a branch later. I may also revamp the description a bit.



---

archive/issue_comments_298604.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nAt last someone can review this.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/0486c05e0d501e2428493c7db4314df26625f200\">0486c05</a></td><td><code>Make ligsl link to the current cblas library instead of leaving it underlinked.</code></td></tr></table>\n",
    "created_at": "2016-11-09T22:39:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298604",
    "user": "https://github.com/kiwifb"
}
```

<div id="comment:40" align="right">comment:40</div>

At last someone can review this.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/0486c05e0d501e2428493c7db4314df26625f200">0486c05</a></td><td><code>Make ligsl link to the current cblas library instead of leaving it underlinked.</code></td></tr></table>




---

archive/issue_comments_298605.json:
```json
{
    "body": "Branch: **[u/fbissey/gsl_cblas_link](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/gsl_cblas_link)**",
    "created_at": "2016-11-09T22:39:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298605",
    "user": "https://github.com/kiwifb"
}
```

Branch: **[u/fbissey/gsl_cblas_link](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/gsl_cblas_link)**



---

archive/issue_comments_298606.json:
```json
{
    "body": "Commit: **[0486c05](https://github.com/sagemath/sagetrac-mirror/commit/0486c05e0d501e2428493c7db4314df26625f200)**",
    "created_at": "2016-11-09T22:39:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298606",
    "user": "https://github.com/kiwifb"
}
```

Commit: **[0486c05](https://github.com/sagemath/sagetrac-mirror/commit/0486c05e0d501e2428493c7db4314df26625f200)**



---

archive/issue_events_290744.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2016-11-09T22:39:29Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20646#event-290744"
}
```



---

archive/issue_events_290745.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2016-11-09T22:39:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20646#event-290745"
}
```



---

archive/issue_events_290746.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2016-11-09T22:39:29Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "milestone_number": null,
    "milestone_title": "sage-7.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20646#event-290746"
}
```



---

archive/issue_events_290747.json:
```json
{
    "actor": "https://github.com/kiwifb",
    "created_at": "2016-11-09T22:39:29Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "milestone_number": null,
    "milestone_title": "sage-7.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20646#event-290747"
}
```



---

archive/issue_comments_298607.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,24 +1,14 @@\n-When building sage-7.2 with `LDFLAGS=\"--as-needed\"`, the result is underlinked:\n+When building sage-7.2 with `LDFLAGS=\"--as-needed\"` and the gold linker, the result is underlinked:\n \n ```\n from sage.rings.complex_double import CDF\n ImportError: /home/mjo/src/sage.git/local/lib/libgsl.so.19: undefined symbol: cblas_sdsdot\n ```\n \n-That first error can be avoided by adding `-lcblas` to the gsl LDFLAGS, but a more intelligent approach is probably provided by this patch:\n+This is because `libgsl.so` itself is underlinked as per upstream design. This doesn't work well when building a python loadable module which needs all its symbols (apart from those provided by python) to be resolved. \n \n-https://gitweb.gentoo.org/repo/gentoo.git/tree/sci-libs/gsl/files/gsl-2.1-cblas.patch\n+The gold linker in particular as a very strict interpretation of `--as-needed` and will not add library not needed directly by the object being linked. In this particular case sage.rings.complex_double needs gsl but doesn't use cblas and therefore cblas is not added to the list of needed libraries. libgsl.so itself need to import cblas.\n \n-After that's fixed...\n+The current branch provides a minimal non invasive fix to link libgsl.so to the current cblas. \n \n-```\n-File \"sage/libs/linbox/linbox.pxd\", line 7, in init sage.matrix.matrix_integer_dense (/home/mjo/src/sage.git/src/build/cythonized/sage/matrix/matrix_integer_dense.c:52635)\n-ImportError: /home/mjo/src/sage.git/local/lib/liblinboxsage.so.0: undefined symbol: certSolveRedMP\n-```\n-\n-That one can be fixed by appending `-liml` to the LDFLAGS for linbox. Appending it to LIBS should work, too.\n-\n-More info about `--as-needed`:\n-\n-https://wiki.gentoo.org/wiki/Project:Quality_Assurance/As-needed\n-\n+Note, that gsl already depends on `$(BLAS)` even so prior to this ticket it was not used.\n``````\n",
    "created_at": "2016-11-09T22:39:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298607",
    "user": "https://github.com/kiwifb"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,24 +1,14 @@
-When building sage-7.2 with `LDFLAGS="--as-needed"`, the result is underlinked:
+When building sage-7.2 with `LDFLAGS="--as-needed"` and the gold linker, the result is underlinked:
 
 ```
 from sage.rings.complex_double import CDF
 ImportError: /home/mjo/src/sage.git/local/lib/libgsl.so.19: undefined symbol: cblas_sdsdot
 ```
 
-That first error can be avoided by adding `-lcblas` to the gsl LDFLAGS, but a more intelligent approach is probably provided by this patch:
+This is because `libgsl.so` itself is underlinked as per upstream design. This doesn't work well when building a python loadable module which needs all its symbols (apart from those provided by python) to be resolved. 
 
-https://gitweb.gentoo.org/repo/gentoo.git/tree/sci-libs/gsl/files/gsl-2.1-cblas.patch
+The gold linker in particular as a very strict interpretation of `--as-needed` and will not add library not needed directly by the object being linked. In this particular case sage.rings.complex_double needs gsl but doesn't use cblas and therefore cblas is not added to the list of needed libraries. libgsl.so itself need to import cblas.
 
-After that's fixed...
+The current branch provides a minimal non invasive fix to link libgsl.so to the current cblas. 
 
-```
-File "sage/libs/linbox/linbox.pxd", line 7, in init sage.matrix.matrix_integer_dense (/home/mjo/src/sage.git/src/build/cythonized/sage/matrix/matrix_integer_dense.c:52635)
-ImportError: /home/mjo/src/sage.git/local/lib/liblinboxsage.so.0: undefined symbol: certSolveRedMP
-```
-
-That one can be fixed by appending `-liml` to the LDFLAGS for linbox. Appending it to LIBS should work, too.
-
-More info about `--as-needed`:
-
-https://wiki.gentoo.org/wiki/Project:Quality_Assurance/As-needed
-
+Note, that gsl already depends on `$(BLAS)` even so prior to this ticket it was not used.
``````




---

archive/issue_comments_298608.json:
```json
{
    "body": "Author: **Fran\u00e7ois Bissey**",
    "created_at": "2016-11-09T22:39:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298608",
    "user": "https://github.com/kiwifb"
}
```

Author: **Fran√ßois Bissey**



---

archive/issue_comments_298609.json:
```json
{
    "body": "Reviewer: **Steven Trogdon**",
    "created_at": "2016-11-09T23:54:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298609",
    "user": "https://github.com/strogdon"
}
```

Reviewer: **Steven Trogdon**



---

archive/issue_comments_298610.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nI think this fixes things\n\n```\nreadelf -d local/lib/libgsl.so\n\nDynamic section at offset 0x23ab08 contains 28 entries:\n  Tag        Type                         Name/Value\n 0x0000000000000001 (NEEDED)             Shared library: [libopenblas.so.0]\n 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]\n 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]\n 0x000000000000000e (SONAME)             Library soname: [libgsl.so.19]\n 0x000000000000001d (RUNPATH)            Library runpath: [/64bitdev/storage/sage-git_develop/sage/local/lib]\n```\nwith `--as-needed` added to `LDFLAGS`. But I was wrong before, so @orlitzky (Michael) should probably push the button since I don't use the offending `gold` linker.",
    "created_at": "2016-11-09T23:54:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298610",
    "user": "https://github.com/strogdon"
}
```

<div id="comment:41" align="right">comment:41</div>

I think this fixes things

```
readelf -d local/lib/libgsl.so

Dynamic section at offset 0x23ab08 contains 28 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libopenblas.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000e (SONAME)             Library soname: [libgsl.so.19]
 0x000000000000001d (RUNPATH)            Library runpath: [/64bitdev/storage/sage-git_develop/sage/local/lib]
```
with `--as-needed` added to `LDFLAGS`. But I was wrong before, so @orlitzky (Michael) should probably push the button since I don't use the offending `gold` linker.



---

archive/issue_comments_298611.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nLooks good, and I even remembered to run it this time. Thanks!",
    "created_at": "2016-11-10T12:30:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298611",
    "user": "https://github.com/orlitzky"
}
```

<div id="comment:42" align="right">comment:42</div>

Looks good, and I even remembered to run it this time. Thanks!



---

archive/issue_events_290748.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2016-11-10T12:30:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20646#event-290748"
}
```



---

archive/issue_events_290749.json:
```json
{
    "actor": "https://github.com/orlitzky",
    "created_at": "2016-11-10T12:30:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20646#event-290749"
}
```



---

archive/issue_comments_298612.json:
```json
{
    "body": "Changed reviewer from **Steven Trogdon** to **Steven Trogdon, Michael Orlitzky**",
    "created_at": "2016-11-10T12:30:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298612",
    "user": "https://github.com/orlitzky"
}
```

Changed reviewer from **Steven Trogdon** to **Steven Trogdon, Michael Orlitzky**



---

archive/issue_events_290750.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-11-11T17:53:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20646#event-290750"
}
```



---

archive/issue_events_290751.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "0ca7e8cac6d5e20f470053a2c3cb6a06c819b855",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2016-11-11T17:53:58Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20646#event-290751"
}
```



---

archive/issue_comments_298613.json:
```json
{
    "body": "Changed branch from **[u/fbissey/gsl_cblas_link](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/gsl_cblas_link)** to **[0486c05](https://github.com/sagemath/sagetrac-mirror/commit/0486c05e0d501e2428493c7db4314df26625f200)**",
    "created_at": "2016-11-11T17:53:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20646",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20646#issuecomment-298613",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/fbissey/gsl_cblas_link](https://github.com/sagemath/sagetrac-mirror/tree/u/fbissey/gsl_cblas_link)** to **[0486c05](https://github.com/sagemath/sagetrac-mirror/commit/0486c05e0d501e2428493c7db4314df26625f200)**
