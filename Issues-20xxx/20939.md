# Issue 20939: Fix crash and remove pexpect-Maxima usage in Y(m,n)

archive/issues_020702.json:
```json
{
    "body": "```\nsage: spherical_harmonic(3, 2, 1, 2*pi/3)\n...\nTypeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.\n```\nThe eval function of `SphericalHarmonic` uses pexpect-Maxima. Since this needs only a formula the call to Maxima could be replaced by a few lines of Python.\n\nhttp://dlmf.nist.gov/14.30.E1\n\nReplacing pexpect-Maxima is part of #17753.\n\nIssue created by migration from https://trac.sagemath.org/ticket/20939\n\n",
    "closed_at": "2017-01-18T20:39:50Z",
    "created_at": "2016-07-05T07:20:36Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.5",
    "title": "Fix crash and remove pexpect-Maxima usage in Y(m,n)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20939",
    "user": "https://github.com/rwst"
}
```
```
sage: spherical_harmonic(3, 2, 1, 2*pi/3)
...
TypeError: ECL says: THROW: The catch MACSYMA-QUIT is undefined.
```
The eval function of `SphericalHarmonic` uses pexpect-Maxima. Since this needs only a formula the call to Maxima could be replaced by a few lines of Python.

http://dlmf.nist.gov/14.30.E1

Replacing pexpect-Maxima is part of #17753.

Issue created by migration from https://trac.sagemath.org/ticket/20939





---

archive/issue_comments_285742.json:
```json
{
    "body": "This depends on the associated Legendre polynomials being implemented, e,g, #16813.",
    "created_at": "2016-08-04T06:12:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285742",
    "user": "https://github.com/rwst"
}
```

This depends on the associated Legendre polynomials being implemented, e,g, #16813.



---

archive/issue_comments_285743.json:
```json
{
    "body": "It won't be dependent on `P(l,m,x)` if the P special value formula is directly used in `_eval_`. The Y floating point evaluation is done via mpmath anyway.",
    "created_at": "2016-08-04T06:31:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285743",
    "user": "https://github.com/rwst"
}
```

It won't be dependent on `P(l,m,x)` if the P special value formula is directly used in `_eval_`. The Y floating point evaluation is done via mpmath anyway.



---

archive/issue_comments_285744.json:
```json
{
    "body": "Changing type from enhancement to defect.",
    "created_at": "2016-08-04T13:24:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285744",
    "user": "https://github.com/rwst"
}
```

Changing type from enhancement to defect.



---

archive/issue_events_056063.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2016-08-04T14:43:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "milestone": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20939#event-56063"
}
```



---

archive/issue_comments_285745.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-08-04T14:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285745",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_285746.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-08-04T14:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285746",
    "user": "https://github.com/rwst"
}
```

New commits:



---

archive/issue_comments_285747.json:
```json
{
    "body": "LGTM modulo\n\n```diff\n         Check that :trac:`20939` is fixed::\n \n             sage: spherical_harmonic(3,2,1,2*pi/3)\n             1/240*sqrt(30)*(-15*I*sqrt(7)*sqrt(3) -\n-            ...15*sqrt(7))*cos(1)*sin(1)^2/sqrt(pi)\n+            ... + 15*sqrt(7))*cos(1)*sin(1)^2/sqrt(pi)\n         \"\"\"\n         if n in ZZ and m in ZZ and n > -1:\n             if abs(m) > n:\n                 return ZZ(0)\n-            if (m == 0 and theta.is_zero()):\n+            if m == 0 and theta.is_zero():\n                 return sqrt((2*n+1)/4/pi)\n```",
    "created_at": "2016-08-04T17:42:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285747",
    "user": "https://github.com/tscrim"
}
```

LGTM modulo

```diff
         Check that :trac:`20939` is fixed::
 
             sage: spherical_harmonic(3,2,1,2*pi/3)
             1/240*sqrt(30)*(-15*I*sqrt(7)*sqrt(3) -
-            ...15*sqrt(7))*cos(1)*sin(1)^2/sqrt(pi)
+            ... + 15*sqrt(7))*cos(1)*sin(1)^2/sqrt(pi)
         """
         if n in ZZ and m in ZZ and n > -1:
             if abs(m) > n:
                 return ZZ(0)
-            if (m == 0 and theta.is_zero()):
+            if m == 0 and theta.is_zero():
                 return sqrt((2*n+1)/4/pi)
```



---

archive/issue_comments_285748.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-05T06:18:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285748",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_285749.json:
```json
{
    "body": "That doesn't work as given. First the plus is a minus, and then the space after the ellipsis will make it fail too.\n\nI'll assume the last commit is still what you wanted and set positive. Just revert if not. Thanks for the review.",
    "created_at": "2016-08-05T06:22:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285749",
    "user": "https://github.com/rwst"
}
```

That doesn't work as given. First the plus is a minus, and then the space after the ellipsis will make it fail too.

I'll assume the last commit is still what you wanted and set positive. Just revert if not. Thanks for the review.



---

archive/issue_comments_285750.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-08-05T06:22:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285750",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_285751.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2016-08-05T14:27:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285751",
    "user": "https://github.com/tscrim"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_285752.json:
```json
{
    "body": "So the `...` is actually unneeded; I was thinking there was more than 2 terms. Please check my changes.\n\n---\nNew commits:",
    "created_at": "2016-08-05T14:27:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285752",
    "user": "https://github.com/tscrim"
}
```

So the `...` is actually unneeded; I was thinking there was more than 2 terms. Please check my changes.

---
New commits:



---

archive/issue_comments_285753.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-08-05T14:55:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285753",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_285754.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-08-06T11:14:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285754",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_285755.json:
```json
{
    "body": "Documentation doesn't build, see patchbot",
    "created_at": "2016-08-06T11:14:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285755",
    "user": "https://github.com/vbraun"
}
```

Documentation doesn't build, see patchbot



---

archive/issue_comments_285756.json:
```json
{
    "body": "Interesting. I get this\n\n```\n[dochtml] [plot3d   ] /home/ralf/sage/src/doc/en/reference/plot3d/sage/plot/plot3d/plot3d.rst:1937: WARNING: Exception occurred in plotting plot3d-35\n[dochtml] [plot3d   ] from /home/ralf/sage/src/doc/en/reference/plot3d/sage/plot/plot3d/plot3d.rst:\n[dochtml] [plot3d   ] Traceback (most recent call last):\n[dochtml] [plot3d   ] File \"/home/ralf/sage/local/lib/python2.7/site-packages/matplotlib-1.5.1-py2.7-linux-x86_64.egg/matplotlib/sphinxext/plot_directive.py\", line 517, in run_code\n```\nI don't know how to get to the `plot3d-35` plot commands but:\n\n```\n[dochtml] [plot3d   ] result[0] = interp_rdf(args\n[dochtml] [plot3d   ] File \"sage/symbolic/function.pyx\", line 821, in sage.symbolic.function.GinacFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:9409)\n[dochtml] [plot3d   ] res = super(GinacFunction, self).__call__(*args, **kwds)\n[dochtml] [plot3d   ] File \"sage/symbolic/function.pyx\", line 972, in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:11034)\n[dochtml] [plot3d   ] res = super(BuiltinFunction, self).__call__(\n[dochtml] [plot3d   ] File \"sage/symbolic/function.pyx\", line 488, in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.cpp:6886)\n[dochtml] [plot3d   ] res = g_function_eval2(self._serial, (<Expression>args[0])._gobj,\n[dochtml] [plot3d   ] RuntimeError: arctan2_eval(): arctan2(0,0) encountered\n```\nThe only calls to `atan2(x,y)` are in `revolution_plot3d()` and if I remove all its doctests it still crashes on build at this point, so I no longer know where to look. Either the 3d plot number 35 or the uncompiled `plot3d.rst` would be necessary.\n\nApart from the bug at hand I think Pynac's `atan2_eval` should return unsigned infinity instead of throwing an exception. There is a reason `atan2(0,0)` is called however.",
    "created_at": "2016-08-09T13:33:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285756",
    "user": "https://github.com/rwst"
}
```

Interesting. I get this

```
[dochtml] [plot3d   ] /home/ralf/sage/src/doc/en/reference/plot3d/sage/plot/plot3d/plot3d.rst:1937: WARNING: Exception occurred in plotting plot3d-35
[dochtml] [plot3d   ] from /home/ralf/sage/src/doc/en/reference/plot3d/sage/plot/plot3d/plot3d.rst:
[dochtml] [plot3d   ] Traceback (most recent call last):
[dochtml] [plot3d   ] File "/home/ralf/sage/local/lib/python2.7/site-packages/matplotlib-1.5.1-py2.7-linux-x86_64.egg/matplotlib/sphinxext/plot_directive.py", line 517, in run_code
```
I don't know how to get to the `plot3d-35` plot commands but:

```
[dochtml] [plot3d   ] result[0] = interp_rdf(args
[dochtml] [plot3d   ] File "sage/symbolic/function.pyx", line 821, in sage.symbolic.function.GinacFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:9409)
[dochtml] [plot3d   ] res = super(GinacFunction, self).__call__(*args, **kwds)
[dochtml] [plot3d   ] File "sage/symbolic/function.pyx", line 972, in sage.symbolic.function.BuiltinFunction.__call__ (build/cythonized/sage/symbolic/function.cpp:11034)
[dochtml] [plot3d   ] res = super(BuiltinFunction, self).__call__(
[dochtml] [plot3d   ] File "sage/symbolic/function.pyx", line 488, in sage.symbolic.function.Function.__call__ (build/cythonized/sage/symbolic/function.cpp:6886)
[dochtml] [plot3d   ] res = g_function_eval2(self._serial, (<Expression>args[0])._gobj,
[dochtml] [plot3d   ] RuntimeError: arctan2_eval(): arctan2(0,0) encountered
```
The only calls to `atan2(x,y)` are in `revolution_plot3d()` and if I remove all its doctests it still crashes on build at this point, so I no longer know where to look. Either the 3d plot number 35 or the uncompiled `plot3d.rst` would be necessary.

Apart from the bug at hand I think Pynac's `atan2_eval` should return unsigned infinity instead of throwing an exception. There is a reason `atan2(0,0)` is called however.



---

archive/issue_comments_285757.json:
```json
{
    "body": "This is the trigger:\n\n```\nsage: phi, theta = var('phi, theta')\nsage: Y = spherical_harmonic(2, 1, theta, phi)\nsage: rea = spherical_plot3d(abs(real(Y)), (phi,0,2*pi), (theta,0,pi), color='bl\n....: ue', opacity=0.6)\nsage: ima = spherical_plot3d(abs(imag(Y)), (phi,0,2*pi), (theta,0,pi), color='re\n....: d', opacity=0.6)\nsage:  (rea + ima).show(aspect_ratio=1)\n---------------------------------------------------------------------------\nRuntimeError: arctan2_eval(): arctan2(0,0) encountered\n```",
    "created_at": "2016-09-30T07:44:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285757",
    "user": "https://github.com/rwst"
}
```

This is the trigger:

```
sage: phi, theta = var('phi, theta')
sage: Y = spherical_harmonic(2, 1, theta, phi)
sage: rea = spherical_plot3d(abs(real(Y)), (phi,0,2*pi), (theta,0,pi), color='bl
....: ue', opacity=0.6)
sage: ima = spherical_plot3d(abs(imag(Y)), (phi,0,2*pi), (theta,0,pi), color='re
....: d', opacity=0.6)
sage:  (rea + ima).show(aspect_ratio=1)
---------------------------------------------------------------------------
RuntimeError: arctan2_eval(): arctan2(0,0) encountered
```



---

archive/issue_comments_285758.json:
```json
{
    "body": "The new code makes `Y` expand immediately, and the `real/imag` calls then really blow it up.\n\n```\nsage: Y = 1/4*sqrt(6)*sqrt(5)*sqrt(sin(theta)^2)*cos(theta)*e^(I*phi)/sqrt(pi)\nsage: abs(real(Y))\nabs(1/4*sqrt(6)*sqrt(5)*sqrt(abs(sin(theta))^2)*cos(1/2*\\\narctan2(2*cos(real_part(theta))*cosh(imag_part(theta))*sin(real_part(theta))*sinh(imag_part(theta)),\ncosh(imag_part(theta))^2*sin(real_part(theta))^2-cos(real_part(theta))^2*sinh(imag_part(theta))^2))\n*cos(real_part(phi))*cos(real_part(theta))*cosh(imag_part(theta))*e^(-imag_part(phi))/sqrt(pi) - \n1/4*sqrt(6)*sqrt(5)*sqrt(abs(sin(theta))^2)*cos(real_part(theta))*cosh(imag_part(theta))*e^(-imag_part(phi))*sin(1/2*arctan2(2*cos(real_part(theta))*cosh(imag_part(theta))*sin(real_part(theta))*sinh(imag_part(theta)), cosh(imag_part(theta))^2*sin(real_part(theta))^2 - cos(real_part(theta))^2*sinh(imag_part(theta))^2))*sin(real_part(phi))/sqrt(pi) + 1/4*sqrt(6)*sqrt(5)*sqrt(abs(sin(theta))^2)*cos(real_part(phi))*e^(-imag_part(phi))*sin(1/2*arctan2(2*cos(real_part(theta))*cosh(imag_part(theta))*sin(real_part(theta))*sinh(imag_part(theta)), cosh(imag_part(theta))^2*sin(real_part(theta))^2 - cos(real_part(theta))^2*sinh(imag_part(theta))^2))*sin(real_part(theta))*sinh(imag_part(theta))/sqrt(pi) + 1/4*sqrt(6)*sqrt(5)*sqrt(abs(sin(theta))^2)*cos(1/2*arctan2(2*cos(real_part(theta))*cosh(imag_part(theta))*sin(real_part(theta))*sinh(imag_part(theta)), cosh(imag_part(theta))^2*sin(real_part(theta))^2 - cos(real_part(theta))^2*sinh(imag_part(theta))^2))*e^(-imag_part(phi))*sin(real_part(phi))*sin(real_part(theta))*sinh(imag_part(theta))/sqrt(pi))\n```",
    "created_at": "2016-09-30T14:32:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285758",
    "user": "https://github.com/rwst"
}
```

The new code makes `Y` expand immediately, and the `real/imag` calls then really blow it up.

```
sage: Y = 1/4*sqrt(6)*sqrt(5)*sqrt(sin(theta)^2)*cos(theta)*e^(I*phi)/sqrt(pi)
sage: abs(real(Y))
abs(1/4*sqrt(6)*sqrt(5)*sqrt(abs(sin(theta))^2)*cos(1/2*\
arctan2(2*cos(real_part(theta))*cosh(imag_part(theta))*sin(real_part(theta))*sinh(imag_part(theta)),
cosh(imag_part(theta))^2*sin(real_part(theta))^2-cos(real_part(theta))^2*sinh(imag_part(theta))^2))
*cos(real_part(phi))*cos(real_part(theta))*cosh(imag_part(theta))*e^(-imag_part(phi))/sqrt(pi) - 
1/4*sqrt(6)*sqrt(5)*sqrt(abs(sin(theta))^2)*cos(real_part(theta))*cosh(imag_part(theta))*e^(-imag_part(phi))*sin(1/2*arctan2(2*cos(real_part(theta))*cosh(imag_part(theta))*sin(real_part(theta))*sinh(imag_part(theta)), cosh(imag_part(theta))^2*sin(real_part(theta))^2 - cos(real_part(theta))^2*sinh(imag_part(theta))^2))*sin(real_part(phi))/sqrt(pi) + 1/4*sqrt(6)*sqrt(5)*sqrt(abs(sin(theta))^2)*cos(real_part(phi))*e^(-imag_part(phi))*sin(1/2*arctan2(2*cos(real_part(theta))*cosh(imag_part(theta))*sin(real_part(theta))*sinh(imag_part(theta)), cosh(imag_part(theta))^2*sin(real_part(theta))^2 - cos(real_part(theta))^2*sinh(imag_part(theta))^2))*sin(real_part(theta))*sinh(imag_part(theta))/sqrt(pi) + 1/4*sqrt(6)*sqrt(5)*sqrt(abs(sin(theta))^2)*cos(1/2*arctan2(2*cos(real_part(theta))*cosh(imag_part(theta))*sin(real_part(theta))*sinh(imag_part(theta)), cosh(imag_part(theta))^2*sin(real_part(theta))^2 - cos(real_part(theta))^2*sinh(imag_part(theta))^2))*e^(-imag_part(phi))*sin(real_part(phi))*sin(real_part(theta))*sinh(imag_part(theta))/sqrt(pi))
```



---

archive/issue_comments_285759.json:
```json
{
    "body": "```\nsage: x=abs(real(Y))\nsage: x.subs(theta==0)\n...\nRuntimeError: arctan2_eval(): arctan2(0,0) encountered\nsage: y=abs(imag(Y))\nsage: y.subs(theta==0)\n...\nRuntimeError: arctan2_eval(): arctan2(0,0) encountered\nsage: Y\n1/4*sqrt(6)*sqrt(5)*sqrt(sin(theta)^2)*cos(theta)*e^(I*phi)/sqrt(pi)\nsage: Y.subs(theta==0)\n0\n```\nSo it seems the `real/imag` expansions produce results in some cases that are not defined at zero, so are not correct.",
    "created_at": "2016-09-30T15:23:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285759",
    "user": "https://github.com/rwst"
}
```

```
sage: x=abs(real(Y))
sage: x.subs(theta==0)
...
RuntimeError: arctan2_eval(): arctan2(0,0) encountered
sage: y=abs(imag(Y))
sage: y.subs(theta==0)
...
RuntimeError: arctan2_eval(): arctan2(0,0) encountered
sage: Y
1/4*sqrt(6)*sqrt(5)*sqrt(sin(theta)^2)*cos(theta)*e^(I*phi)/sqrt(pi)
sage: Y.subs(theta==0)
0
```
So it seems the `real/imag` expansions produce results in some cases that are not defined at zero, so are not correct.



---

archive/issue_comments_285760.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-11-10T08:35:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285760",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_285761.json:
```json
{
    "body": "So to summarize the code here is good, we just depend on #21614.",
    "created_at": "2016-11-10T08:35:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285761",
    "user": "https://github.com/rwst"
}
```

So to summarize the code here is good, we just depend on #21614.



---

archive/issue_comments_285762.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-11-13T16:08:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285762",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_285763.json:
```json
{
    "body": "```\nFile \"src/sage/plot/plot3d/plot3d.py\", line 1195, in sage.plot.plot3d.plot3d.spherical_plot3d\nFailed example:\n    (rea + ima).show(aspect_ratio=1)  # long time (4s on sage.math, 2011)\nException raised:\n    Traceback (most recent call last):\n      File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 498, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 861, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.plot.plot3d.plot3d.spherical_plot3d[13]>\", line 1, in <module>\n        (rea + ima).show(aspect_ratio=Integer(1))  # long time (4s on sage.math, 2011)\n      File \"sage/plot/plot3d/base.pyx\", line 1379, in sage.plot.plot3d.base.Graphics3d.show (build/cythonized/sage/plot/plot3d/base.c:17925)\n        dm.display_immediately(self, **kwds)\n      File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py\", line 791, in display_immediately\n        plain_text, rich_output = self._rich_output_formatter(obj, rich_repr_kwds)\n      File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py\", line 623, in _rich_output_formatter\n        rich_output = self._call_rich_repr(obj, rich_repr_kwds)\n      File \"/home/chapoton/sage/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py\", line 581, in _call_rich_repr\n        return obj._rich_repr_(self, **rich_repr_kwds)\n      File \"sage/plot/plot3d/base.pyx\", line 130, in sage.plot.plot3d.base.Graphics3d._rich_repr_ (build/cythonized/sage/plot/plot3d/base.c:4422)\n        opts = self._process_viewing_options(kwds)\n      File \"sage/plot/plot3d/base.pyx\", line 1257, in sage.plot.plot3d.base.Graphics3d._process_viewing_options (build/cythonized/sage/plot/plot3d/base.c:17397)\n        self._determine_frame_aspect_ratio(opts['aspect_ratio'])\n      File \"sage/plot/plot3d/base.pyx\", line 472, in sage.plot.plot3d.base.Graphics3d._determine_frame_aspect_ratio (build/cythonized/sage/plot/plot3d/base.c:9247)\n        a_min, a_max = self._safe_bounding_box()\n      File \"sage/plot/plot3d/base.pyx\", line 490, in sage.plot.plot3d.base.Graphics3d._safe_bounding_box (build/cythonized/sage/plot/plot3d/base.c:9420)\n        a_min, a_max = self.bounding_box()\n      File \"sage/plot/plot3d/base.pyx\", line 1831, in sage.plot.plot3d.base.Graphics3dGroup.bounding_box (build/cythonized/sage/plot/plot3d/base.c:24445)\n        v = [obj.bounding_box() for obj in self.all]\n      File \"sage/plot/plot3d/parametric_surface.pyx\", line 379, in sage.plot.plot3d.parametric_surface.ParametricSurface.bounding_box (build/cythonized/sage/plot/plot3d/parametric_surface.c:5079)\n        self.triangulate()\n      File \"sage/plot/plot3d/parametric_surface.pyx\", line 427, in sage.plot.plot3d.parametric_surface.ParametricSurface.triangulate (build/cythonized/sage/plot/plot3d/parametric_surface.c:5826)\n        raise\n      File \"sage/plot/plot3d/parametric_surface.pyx\", line 422, in sage.plot.plot3d.parametric_surface.ParametricSurface.triangulate (build/cythonized/sage/plot/plot3d/parametric_surface.c:5746)\n        self.eval_grid(urange, vrange)\n      File \"sage/plot/plot3d/parametric_surface.pyx\", line 601, in sage.plot.plot3d.parametric_surface.ParametricSurface.eval_grid (build/cythonized/sage/plot/plot3d/parametric_surface.c:7437)\n        (<Wrapper_rdf>fx).call_c(uv, &self.vs[i*n+j].x)\n      File \"sage/ext/interpreters/wrapper_rdf.pyx\", line 90, in sage.ext.interpreters.wrapper_rdf.Wrapper_rdf.call_c (build/cythonized/sage/ext/interpreters/wrapper_rdf.c:2163)\n        result[0] = interp_rdf(args\n      File \"sage/symbolic/expression.pyx\", line 1410, in sage.symbolic.expression.Expression.__float__ (build/cythonized/sage/symbolic/expression.cpp:11032)\n        ret = float(self._eval_self(float))\n      File \"sage/symbolic/expression.pyx\", line 1197, in sage.symbolic.expression.Expression._eval_self (build/cythonized/sage/symbolic/expression.cpp:9741)\n        res = self._gobj.evalf(0, {'parent':R})\n      File \"sage/libs/pynac/pynac.pyx\", line 2160, in sage.libs.pynac.pynac.py_eval_constant (build/cythonized/sage/libs/pynac/pynac.cpp:25827)\n        constant = constants_table[serial]\n    KeyError: 3\n```",
    "created_at": "2016-11-13T16:08:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285763",
    "user": "https://github.com/vbraun"
}
```

```
File "src/sage/plot/plot3d/plot3d.py", line 1195, in sage.plot.plot3d.plot3d.spherical_plot3d
Failed example:
    (rea + ima).show(aspect_ratio=1)  # long time (4s on sage.math, 2011)
Exception raised:
    Traceback (most recent call last):
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.plot.plot3d.plot3d.spherical_plot3d[13]>", line 1, in <module>
        (rea + ima).show(aspect_ratio=Integer(1))  # long time (4s on sage.math, 2011)
      File "sage/plot/plot3d/base.pyx", line 1379, in sage.plot.plot3d.base.Graphics3d.show (build/cythonized/sage/plot/plot3d/base.c:17925)
        dm.display_immediately(self, **kwds)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 791, in display_immediately
        plain_text, rich_output = self._rich_output_formatter(obj, rich_repr_kwds)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 623, in _rich_output_formatter
        rich_output = self._call_rich_repr(obj, rich_repr_kwds)
      File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/repl/rich_output/display_manager.py", line 581, in _call_rich_repr
        return obj._rich_repr_(self, **rich_repr_kwds)
      File "sage/plot/plot3d/base.pyx", line 130, in sage.plot.plot3d.base.Graphics3d._rich_repr_ (build/cythonized/sage/plot/plot3d/base.c:4422)
        opts = self._process_viewing_options(kwds)
      File "sage/plot/plot3d/base.pyx", line 1257, in sage.plot.plot3d.base.Graphics3d._process_viewing_options (build/cythonized/sage/plot/plot3d/base.c:17397)
        self._determine_frame_aspect_ratio(opts['aspect_ratio'])
      File "sage/plot/plot3d/base.pyx", line 472, in sage.plot.plot3d.base.Graphics3d._determine_frame_aspect_ratio (build/cythonized/sage/plot/plot3d/base.c:9247)
        a_min, a_max = self._safe_bounding_box()
      File "sage/plot/plot3d/base.pyx", line 490, in sage.plot.plot3d.base.Graphics3d._safe_bounding_box (build/cythonized/sage/plot/plot3d/base.c:9420)
        a_min, a_max = self.bounding_box()
      File "sage/plot/plot3d/base.pyx", line 1831, in sage.plot.plot3d.base.Graphics3dGroup.bounding_box (build/cythonized/sage/plot/plot3d/base.c:24445)
        v = [obj.bounding_box() for obj in self.all]
      File "sage/plot/plot3d/parametric_surface.pyx", line 379, in sage.plot.plot3d.parametric_surface.ParametricSurface.bounding_box (build/cythonized/sage/plot/plot3d/parametric_surface.c:5079)
        self.triangulate()
      File "sage/plot/plot3d/parametric_surface.pyx", line 427, in sage.plot.plot3d.parametric_surface.ParametricSurface.triangulate (build/cythonized/sage/plot/plot3d/parametric_surface.c:5826)
        raise
      File "sage/plot/plot3d/parametric_surface.pyx", line 422, in sage.plot.plot3d.parametric_surface.ParametricSurface.triangulate (build/cythonized/sage/plot/plot3d/parametric_surface.c:5746)
        self.eval_grid(urange, vrange)
      File "sage/plot/plot3d/parametric_surface.pyx", line 601, in sage.plot.plot3d.parametric_surface.ParametricSurface.eval_grid (build/cythonized/sage/plot/plot3d/parametric_surface.c:7437)
        (<Wrapper_rdf>fx).call_c(uv, &self.vs[i*n+j].x)
      File "sage/ext/interpreters/wrapper_rdf.pyx", line 90, in sage.ext.interpreters.wrapper_rdf.Wrapper_rdf.call_c (build/cythonized/sage/ext/interpreters/wrapper_rdf.c:2163)
        result[0] = interp_rdf(args
      File "sage/symbolic/expression.pyx", line 1410, in sage.symbolic.expression.Expression.__float__ (build/cythonized/sage/symbolic/expression.cpp:11032)
        ret = float(self._eval_self(float))
      File "sage/symbolic/expression.pyx", line 1197, in sage.symbolic.expression.Expression._eval_self (build/cythonized/sage/symbolic/expression.cpp:9741)
        res = self._gobj.evalf(0, {'parent':R})
      File "sage/libs/pynac/pynac.pyx", line 2160, in sage.libs.pynac.pynac.py_eval_constant (build/cythonized/sage/libs/pynac/pynac.cpp:25827)
        constant = constants_table[serial]
    KeyError: 3
```



---

archive/issue_comments_285764.json:
```json
{
    "body": "I should say I saw it too. `plot3d-35` is still problematic with this here.",
    "created_at": "2016-11-13T20:11:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285764",
    "user": "https://github.com/kiwifb"
}
```

I should say I saw it too. `plot3d-35` is still problematic with this here.



---

archive/issue_comments_285765.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-11-14T07:28:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285765",
    "user": "https://github.com/rwst"
}
```

New commits:



---

archive/issue_comments_285766.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-11-14T07:28:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285766",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_285767.json:
```json
{
    "body": "Would it be possible to have a test to make sure this stays fixed?",
    "created_at": "2016-11-14T14:52:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285767",
    "user": "https://github.com/tscrim"
}
```

Would it be possible to have a test to make sure this stays fixed?



---

archive/issue_comments_285768.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-11-14T16:41:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285768",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_285769.json:
```json
{
    "body": "This commit contains a test for the specific `NaN` evaluation problem causing the second crash (the fix for the first crash is tested with #21614). The commit also fixes an inconsistency. As to a general test of the second problem I opened https://github.com/pynac/pynac/issues/211",
    "created_at": "2016-11-14T16:44:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285769",
    "user": "https://github.com/rwst"
}
```

This commit contains a test for the specific `NaN` evaluation problem causing the second crash (the fix for the first crash is tested with #21614). The commit also fixes an inconsistency. As to a general test of the second problem I opened https://github.com/pynac/pynac/issues/211



---

archive/issue_comments_285770.json:
```json
{
    "body": "Thanks. Now back to the buildbots.",
    "created_at": "2016-11-14T17:12:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285770",
    "user": "https://github.com/tscrim"
}
```

Thanks. Now back to the buildbots.



---

archive/issue_comments_285771.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-11-14T17:12:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285771",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_285772.json:
```json
{
    "body": "I don know what Volker will report if anything but now I have a segfault in `constant.py`\n\n```\nsage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 688 ##\n0\nsage: loads(dumps(NaN)) ## line 704 ##\n------------------------------------------------------------------------\n/usr/lib64/python2.7/site-packages/cysignals/signals.so(+0x4556)[0x7f4f180eb556]\n/usr/lib64/python2.7/site-packages/cysignals/signals.so(+0x4a6c)[0x7f4f180eba6c]\n/usr/lib64/python2.7/site-packages/cysignals/signals.so(+0x6d6f)[0x7f4f180edd6f]\n/lib64/libpthread.so.0(+0x10d70)[0x7f4f1ce53d70]\n/usr/lib64/python2.7/site-packages/sage/libs/pynac/pynac.so(+0x2940d)[0x7f4d3ece640d]\n/usr/lib64/libpynac.so.8(_ZN5GiNaC8constant9unarchiveERKNS_12archive_nodeERNS_9containerINSt7__cxx114listEEE+0x196)[0x7f4d3e955dcc]\n/usr/lib64/libpynac.so.8(_ZNK5GiNaC12archive_node9unarchiveERNS_9containerINSt7__cxx114listEEE+0xf4)[0x7f4d3e936836]\n/usr/lib64/libpynac.so.8(_ZNK5GiNaC7archive12unarchive_exERKNS_9containerINSt7__cxx114listEEEj+0x130)[0x7f4d3e936a42]\n/usr/lib64/python2.7/site-packages/sage/symbolic/expression.so(+0xec87f)[0x7f4d3e63787f]\n/usr/lib64/python2.7/site-packages/sage/symbolic/expression.so(+0xecc2a)[0x7f4d3e637c2a]\n/usr/lib64/libpython2.7.so.1.0(PyCFunction_Call+0xf1)[0x7f4f1d0ddbd9]\n/usr/lib64/libpython2.7.so.1.0(PyObject_Call+0x5c)[0x7f4f1d0a8123]\n```",
    "created_at": "2016-11-16T01:46:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285772",
    "user": "https://github.com/kiwifb"
}
```

I don know what Volker will report if anything but now I have a segfault in `constant.py`

```
sage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 688 ##
0
sage: loads(dumps(NaN)) ## line 704 ##
------------------------------------------------------------------------
/usr/lib64/python2.7/site-packages/cysignals/signals.so(+0x4556)[0x7f4f180eb556]
/usr/lib64/python2.7/site-packages/cysignals/signals.so(+0x4a6c)[0x7f4f180eba6c]
/usr/lib64/python2.7/site-packages/cysignals/signals.so(+0x6d6f)[0x7f4f180edd6f]
/lib64/libpthread.so.0(+0x10d70)[0x7f4f1ce53d70]
/usr/lib64/python2.7/site-packages/sage/libs/pynac/pynac.so(+0x2940d)[0x7f4d3ece640d]
/usr/lib64/libpynac.so.8(_ZN5GiNaC8constant9unarchiveERKNS_12archive_nodeERNS_9containerINSt7__cxx114listEEE+0x196)[0x7f4d3e955dcc]
/usr/lib64/libpynac.so.8(_ZNK5GiNaC12archive_node9unarchiveERNS_9containerINSt7__cxx114listEEE+0xf4)[0x7f4d3e936836]
/usr/lib64/libpynac.so.8(_ZNK5GiNaC7archive12unarchive_exERKNS_9containerINSt7__cxx114listEEEj+0x130)[0x7f4d3e936a42]
/usr/lib64/python2.7/site-packages/sage/symbolic/expression.so(+0xec87f)[0x7f4d3e63787f]
/usr/lib64/python2.7/site-packages/sage/symbolic/expression.so(+0xecc2a)[0x7f4d3e637c2a]
/usr/lib64/libpython2.7.so.1.0(PyCFunction_Call+0xf1)[0x7f4f1d0ddbd9]
/usr/lib64/libpython2.7.so.1.0(PyObject_Call+0x5c)[0x7f4f1d0a8123]
```



---

archive/issue_comments_285773.json:
```json
{
    "body": "Confirmed. I'm sorry. With Pynac changes I have a testing procedure in place here, but with Python I was relying on patchbot. This issue is also somewhat unusual as to the surprising problems presented.",
    "created_at": "2016-11-16T07:53:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285773",
    "user": "https://github.com/rwst"
}
```

Confirmed. I'm sorry. With Pynac changes I have a testing procedure in place here, but with Python I was relying on patchbot. This issue is also somewhat unusual as to the surprising problems presented.



---

archive/issue_comments_285774.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-11-16T07:53:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285774",
    "user": "https://github.com/rwst"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_285775.json:
```json
{
    "body": "Same here...",
    "created_at": "2016-11-16T07:54:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285775",
    "user": "https://github.com/vbraun"
}
```

Same here...



---

archive/issue_comments_285776.json:
```json
{
    "body": "Positive stuff for me, it made me realise that some bits of `cysignals` are not currently working properly on Gentoo - even so the tests pass :(",
    "created_at": "2016-11-16T07:57:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285776",
    "user": "https://github.com/kiwifb"
}
```

Positive stuff for me, it made me realise that some bits of `cysignals` are not currently working properly on Gentoo - even so the tests pass :(



---

archive/issue_comments_285777.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-11-24T16:34:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285777",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_285778.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-12-20T16:00:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285778",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_285779.json:
```json
{
    "body": "Let's try again.",
    "created_at": "2016-12-20T20:51:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285779",
    "user": "https://github.com/tscrim"
}
```

Let's try again.



---

archive/issue_comments_285780.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-12-20T20:51:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285780",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_056064.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-12-20T20:51:36Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "milestone": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20939#event-56064"
}
```



---

archive/issue_events_056065.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-12-20T20:51:36Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "milestone": "sage-7.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20939#event-56065"
}
```



---

archive/issue_events_056066.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-01-18T20:39:50Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20939#event-56066"
}
```



---

archive/issue_comments_285781.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-01-18T20:39:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-285781",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
