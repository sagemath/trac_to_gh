# Issue 20842: sage-uncompress-spkg takes ages

archive/issues_020605.json:
```json
{
    "body": "The recent changes to `sage-uncompress-spkg` have made it *a lot* slower than before. In particular uncompressing the GCC tarball takes 15 to 30 minutes. I haven't analysed in detail yet.\n\nCC:  @embray @kcrisman\n\nReviewer: John Palmieri, Karl-Dieter Crisman\n\nAuthor: Volker Braun\n\nBranch: u/vbraun/sage_uncompress_spkg_takes_ages\n\nCommit: 7f0356dc03a4394501da877fe0739bf34503a549\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20842\n\n",
    "closed_at": "2016-06-21T20:45:39Z",
    "created_at": "2016-06-18T06:59:32Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "sage-uncompress-spkg takes ages",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20842",
    "user": "https://github.com/jdemeyer"
}
```
The recent changes to `sage-uncompress-spkg` have made it *a lot* slower than before. In particular uncompressing the GCC tarball takes 15 to 30 minutes. I haven't analysed in detail yet.

CC:  @embray @kcrisman

Reviewer: John Palmieri, Karl-Dieter Crisman

Author: Volker Braun

Branch: u/vbraun/sage_uncompress_spkg_takes_ages

Commit: 7f0356dc03a4394501da877fe0739bf34503a549

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/20842





---

archive/issue_comments_302658.json:
```json
{
    "body": "<a id='comment:2'></a>It seems that the script is accidentally quadratic in the number of filenames, and gcc has almost 100k files...",
    "created_at": "2016-06-18T13:56:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20842#issuecomment-302658",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:2'></a>It seems that the script is accidentally quadratic in the number of filenames, and gcc has almost 100k files...



---

archive/issue_comments_302659.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-06-18T14:25:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20842#issuecomment-302659",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_302660.json:
```json
{
    "body": "<a id='comment:4'></a>New commits:",
    "created_at": "2016-06-18T14:25:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20842#issuecomment-302660",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:4'></a>New commits:



---

archive/issue_comments_302661.json:
```json
{
    "body": "<a id='comment:5'></a>This change certainly speeds things up for me: about 15 minutes to unpack `gcc` without it, about 1 minute with it.",
    "created_at": "2016-06-18T15:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20842#issuecomment-302661",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:5'></a>This change certainly speeds things up for me: about 15 minutes to unpack `gcc` without it, about 1 minute with it.



---

archive/issue_comments_302662.json:
```json
{
    "body": "<a id='comment:6'></a>It is still horrible regarding what its sole purpose is (namely to extract *all files* from a usually sequentially read and written archive, thereby eventually dropping a few files based on their names which shouldn't at all be present anyway, but may have accidentally been added by some MacOS user, without anybody noticing, probably not even scripts that are supposed to avoid such things).\n\nYay.",
    "created_at": "2016-06-18T16:12:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20842#issuecomment-302662",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:6'></a>It is still horrible regarding what its sole purpose is (namely to extract *all files* from a usually sequentially read and written archive, thereby eventually dropping a few files based on their names which shouldn't at all be present anyway, but may have accidentally been added by some MacOS user, without anybody noticing, probably not even scripts that are supposed to avoid such things).

Yay.



---

archive/issue_comments_302663.json:
```json
{
    "body": "<a id='comment:7'></a>P.S.:  Because of its origin, it's by the way pretty legal to have the \"same\" (based on its name) file occur multiple times within a single tape archive. ;-)",
    "created_at": "2016-06-18T16:21:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20842#issuecomment-302663",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:7'></a>P.S.:  Because of its origin, it's by the way pretty legal to have the "same" (based on its name) file occur multiple times within a single tape archive. ;-)



---

archive/issue_comments_302664.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:6 leif]:\n> It is still horrible regarding what its sole purpose is.\n\n\nOkay, so propose a fix, perhaps on another ticket.\n\nIn the meantime, Sage builds from scratch on my OS X machine in a reasonable amount of time and passes all doctests.",
    "created_at": "2016-06-18T23:16:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20842#issuecomment-302664",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:8'></a>Replying to [comment:6 leif]:
> It is still horrible regarding what its sole purpose is.


Okay, so propose a fix, perhaps on another ticket.

In the meantime, Sage builds from scratch on my OS X machine in a reasonable amount of time and passes all doctests.



---

archive/issue_comments_302665.json:
```json
{
    "body": "<a id='comment:9'></a>This allowed me to start (not finish, as apparently my install of command line tools was somehow fake?!#%) building gcc, so thumbs up here.\n\nPS I don't know the history of this file - it is really just to remove unintentional `.DS_STORE` files, some of which I know I inadvertently introduced at times?",
    "created_at": "2016-06-19T01:07:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20842#issuecomment-302665",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:9'></a>This allowed me to start (not finish, as apparently my install of command line tools was somehow fake?!#%) building gcc, so thumbs up here.

PS I don't know the history of this file - it is really just to remove unintentional `.DS_STORE` files, some of which I know I inadvertently introduced at times?



---

archive/issue_comments_302666.json:
```json
{
    "body": "<a id='comment:10'></a>IMHO the only thing wrong with the script is that there is no testing, it should be moved into the `sage_bootstrap` package and unit tested across Python versions. But thats not what this ticket is about.\n\nThe script consolidates our unpacking and fixes the usual warts that upstream tends to introduce into their tarballs. It also gives different archive types a uniform interface so that we can add more later. The interface uses filename strings instead of an archive-specific struct which helps in making the interface uniform. \n\nFinally, we don't need to handle every pathology that possibly can appear in every supported archive format, only the ones that do occur in the tarballs that we work with.",
    "created_at": "2016-06-19T09:03:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20842#issuecomment-302666",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:10'></a>IMHO the only thing wrong with the script is that there is no testing, it should be moved into the `sage_bootstrap` package and unit tested across Python versions. But thats not what this ticket is about.

The script consolidates our unpacking and fixes the usual warts that upstream tends to introduce into their tarballs. It also gives different archive types a uniform interface so that we can add more later. The interface uses filename strings instead of an archive-specific struct which helps in making the interface uniform. 

Finally, we don't need to handle every pathology that possibly can appear in every supported archive format, only the ones that do occur in the tarballs that we work with.



---

archive/issue_comments_302667.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:6 leif]:\n> It is still horrible regarding what its sole purpose is (namely to extract *all files* from a usually sequentially read and written archive, thereby eventually dropping a few files based on their names which shouldn't at all be present anyway, but may have accidentally been added by some MacOS user, without anybody noticing, probably not even scripts that are supposed to avoid such things).\n\n\nThis was indeed motivated specifically by #20717.  Of course those files shouldn't be there in the first place.  But if they are, they *definitely* shouldn't be extracted.",
    "created_at": "2016-06-20T12:58:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20842#issuecomment-302667",
    "user": "https://github.com/embray"
}
```

<a id='comment:11'></a>Replying to [comment:6 leif]:
> It is still horrible regarding what its sole purpose is (namely to extract *all files* from a usually sequentially read and written archive, thereby eventually dropping a few files based on their names which shouldn't at all be present anyway, but may have accidentally been added by some MacOS user, without anybody noticing, probably not even scripts that are supposed to avoid such things).


This was indeed motivated specifically by #20717.  Of course those files shouldn't be there in the first place.  But if they are, they *definitely* shouldn't be extracted.



---

archive/issue_comments_302668.json:
```json
{
    "body": "<a id='comment:12'></a>Any reason this shouldn't get a positive review? It would be good to get it merged into the next beta, so `gcc` (among other things) will build in a reasonable amount of time.",
    "created_at": "2016-06-20T19:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20842#issuecomment-302668",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:12'></a>Any reason this shouldn't get a positive review? It would be good to get it merged into the next beta, so `gcc` (among other things) will build in a reasonable amount of time.



---

archive/issue_comments_302669.json:
```json
{
    "body": "<a id='comment:13'></a>IMHO none, somebody just press the button...",
    "created_at": "2016-06-20T21:04:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20842#issuecomment-302669",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:13'></a>IMHO none, somebody just press the button...



---

archive/issue_comments_302670.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-06-21T01:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20842#issuecomment-302670",
    "user": "https://github.com/kcrisman"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_302671.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:12 jhpalmieri]:\n> Any reason this shouldn't get a positive review? It would be good to get it merged into the next beta, so `gcc` (among other things) will build in a reasonable amount of time.\n\n\nSure.  It is now (hopefully) sub-quadratic in the number of files in the tarball... B)",
    "created_at": "2016-06-21T12:46:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20842#issuecomment-302671",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:15'></a>Replying to [comment:12 jhpalmieri]:
> Any reason this shouldn't get a positive review? It would be good to get it merged into the next beta, so `gcc` (among other things) will build in a reasonable amount of time.


Sure.  It is now (hopefully) sub-quadratic in the number of files in the tarball... B)



---

archive/issue_comments_302672.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:11 embray]:\n> Replying to [comment:6 leif]:\n> > It is still horrible regarding what its sole purpose is (namely to extract *all files* from a usually sequentially read and written archive, thereby eventually dropping a few files based on their names which shouldn't at all be present anyway, but may have accidentally been added by some MacOS user, without anybody noticing, probably not even scripts that are supposed to avoid such things).\n\n> \n> This was indeed motivated specifically by #20717.  Of course those files shouldn't be there in the first place.  But if they are, they *definitely* shouldn't be extracted.\n\n\nThe script though *silently* drops them; no warning, no error message.\n\nFurthermore, there's absolutely no reason to sort the files by their names, then extracting them in their original order, not only but especially when there aren't any \"OS-specific\" files in the tarball (which is the common case -- as you said, there shouldn't be any in the first place).\n\nWhile already the Python library's function name is \"funny\" (extract**all**()), it's not necessary to pass an *unmodified* list of all tarball entries to it in the \"non-error\" case.",
    "created_at": "2016-06-21T13:09:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20842#issuecomment-302672",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:16'></a>Replying to [comment:11 embray]:
> Replying to [comment:6 leif]:
> > It is still horrible regarding what its sole purpose is (namely to extract *all files* from a usually sequentially read and written archive, thereby eventually dropping a few files based on their names which shouldn't at all be present anyway, but may have accidentally been added by some MacOS user, without anybody noticing, probably not even scripts that are supposed to avoid such things).

> 
> This was indeed motivated specifically by #20717.  Of course those files shouldn't be there in the first place.  But if they are, they *definitely* shouldn't be extracted.


The script though *silently* drops them; no warning, no error message.

Furthermore, there's absolutely no reason to sort the files by their names, then extracting them in their original order, not only but especially when there aren't any "OS-specific" files in the tarball (which is the common case -- as you said, there shouldn't be any in the first place).

While already the Python library's function name is "funny" (extract**all**()), it's not necessary to pass an *unmodified* list of all tarball entries to it in the "non-error" case.



---

archive/issue_comments_302673.json:
```json
{
    "body": "<a id='comment:17'></a>I would be fine with adding a warning message--it would be good to know when invalid files are in some tarball.  I have been advised that \"nobody\" reads the output from sage builds, but I do so...\n\nI don't understand the rest.  There's no sorting for example.  As for the common case there's no way to detect that's the case without checking for files that shouldn't be extracted so that's a moot point.",
    "created_at": "2016-06-21T14:20:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20842#issuecomment-302673",
    "user": "https://github.com/embray"
}
```

<a id='comment:17'></a>I would be fine with adding a warning message--it would be good to know when invalid files are in some tarball.  I have been advised that "nobody" reads the output from sage builds, but I do so...

I don't understand the rest.  There's no sorting for example.  As for the common case there's no way to detect that's the case without checking for files that shouldn't be extracted so that's a moot point.



---

archive/issue_comments_302674.json:
```json
{
    "body": "<a id='comment:18'></a>You can always open another ticket if you want to make more changes...",
    "created_at": "2016-06-21T20:45:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20842#issuecomment-302674",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:18'></a>You can always open another ticket if you want to make more changes...



---

archive/issue_comments_302675.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-06-21T20:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20842",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20842#issuecomment-302675",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_055878.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-06-21T20:45:39Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20842",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20842#event-55878"
}
```
