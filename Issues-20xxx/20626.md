# Issue 20626: Introspection of lazy_import'ed modules crashes Sage

archive/issues_020389.json:
```json
{
    "body": "**Steps to reproduce**: extract the attached archive containing a trivial module bar lazy imported from a module foo in the current directory, and run sage:\n\n```\nsage: import foo\nsage: foo.bar?\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n<ipython-input-2-04fe32111b22> in <module>()\n----> 1 get_ipython().magic(u'pinfo foo.bar')\n\n/opt/sage-git/local/lib/python2.7/site-packages/IPython/core/interactiveshell.pyc in magic(self, arg_s)\n   2161         magic_name, _, magic_arg_s = arg_s.partition(' ')\n   2162         magic_name = magic_name.lstrip(prefilter.ESC_MAGIC)\n-> 2163         return self.run_line_magic(magic_name, magic_arg_s)\n   2164 \n   2165     #-------------------------------------------------------------------------\n\n\n... last 3 frames repeated, from the frame below ...\n\n/opt/sage-git/local/lib/python2.7/site-packages/sage/misc/sageinspect.pyc in sage_getdoc_original(obj)\n   1765         typ = type(obj)\n   1766 \n-> 1767     s,argspec = _extract_embedded_signature(_sage_getdoc_unformatted(obj), typ.__name__)\n   1768     if s:\n   1769         pos = _extract_embedded_position(s)\n\nRuntimeError: maximum recursion depth exceeded in __instancecheck__\n```\n\n**Analysis**: sage.misc.sageinspect.sage_getdoc_original gets confused\nwhen detecting that `foo.bar` is of type `LazyImport` (and not module)\nand trying to recover its documentation from there.\n\n\n**Use case**: some Sage modules contain only documentation:\n\n- `sage.combinat.tutorial`\n- `sage.combinat.primer`\n- `sage.modules.tutorial_free_module`\n- `sage.categories.primer`\n- `sage.categories.tutorial`\n\nand more will come. It would be nice to lazy import them to reduce the\nmemory and startup footprint.\n\nThis requires a simple IPython patch: https://github.com/ipython/ipython/pull/10426\n\n**CC:**  @jdemeyer @videlec @kliem\n\n**Upstream:** Fixed upstream, in a later stable release.\n\n**Status:** new\n\nIssue created by migration from https://trac.sagemath.org/ticket/20626\n\n",
    "closed_at": "2017-04-06T20:16:13Z",
    "created_at": "2016-05-19T07:08:23Z",
    "labels": [
        "component: misc",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "Introspection of lazy_import'ed modules crashes Sage",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20626",
    "user": "https://github.com/nthiery"
}
```
**Steps to reproduce**: extract the attached archive containing a trivial module bar lazy imported from a module foo in the current directory, and run sage:

```
sage: import foo
sage: foo.bar?
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-2-04fe32111b22> in <module>()
----> 1 get_ipython().magic(u'pinfo foo.bar')

/opt/sage-git/local/lib/python2.7/site-packages/IPython/core/interactiveshell.pyc in magic(self, arg_s)
   2161         magic_name, _, magic_arg_s = arg_s.partition(' ')
   2162         magic_name = magic_name.lstrip(prefilter.ESC_MAGIC)
-> 2163         return self.run_line_magic(magic_name, magic_arg_s)
   2164 
   2165     #-------------------------------------------------------------------------


... last 3 frames repeated, from the frame below ...

/opt/sage-git/local/lib/python2.7/site-packages/sage/misc/sageinspect.pyc in sage_getdoc_original(obj)
   1765         typ = type(obj)
   1766 
-> 1767     s,argspec = _extract_embedded_signature(_sage_getdoc_unformatted(obj), typ.__name__)
   1768     if s:
   1769         pos = _extract_embedded_position(s)

RuntimeError: maximum recursion depth exceeded in __instancecheck__
```

**Analysis**: sage.misc.sageinspect.sage_getdoc_original gets confused
when detecting that `foo.bar` is of type `LazyImport` (and not module)
and trying to recover its documentation from there.


**Use case**: some Sage modules contain only documentation:

- `sage.combinat.tutorial`
- `sage.combinat.primer`
- `sage.modules.tutorial_free_module`
- `sage.categories.primer`
- `sage.categories.tutorial`

and more will come. It would be nice to lazy import them to reduce the
memory and startup footprint.

This requires a simple IPython patch: https://github.com/ipython/ipython/pull/10426

**CC:**  @jdemeyer @videlec @kliem

**Upstream:** Fixed upstream, in a later stable release.

**Status:** new

Issue created by migration from https://trac.sagemath.org/ticket/20626





---

archive/issue_comments_358737.json:
```json
{
    "body": "<a id='comment:2'></a>\nPossibly related: documentation of lazy imports includes various `lazy_import` stuff\n\n```\nsage: %pinfo piecewise\nType:            LazyImport\nString form:     piecewise\nFile:            ~/Sage/src/sage/misc/lazy_import.pyx\nDocstring:\n   Piecewise function    <---- this section is the only one that is correct\n\n   EXAMPLES:\n\n      sage: var('x, y')\n      (x, y)\n      sage: f = piecewise([((0,1), x^2*y), ([-1,0], -x*y^2)], var=x);  f\n      piecewise(x|-->x^2*y on (0, 1), x|-->-x*y^2 on [-1, 0]; x)\n      sage: f(1/2)\n      1/4*y\n      sage: f(-1/2)\n      1/2*y^2\n\nClass docstring:\n   EXAMPLES:\n\n      sage: from sage.misc.lazy_import import LazyImport\n      sage: my_integer = LazyImport('sage.rings.all', 'Integer')\n      sage: my_integer(4)\n      4\n      sage: my_integer('101', base=2)\n      5\n      sage: my_integer(3/2)\n      Traceback (most recent call last):\n      ...\n      TypeError: no conversion of this rational to integer\nInit docstring:\n   EXAMPLES:\n\n      sage: from sage.misc.lazy_import import LazyImport\n      sage: my_isprime = LazyImport('sage.all', 'is_prime')\n      sage: my_isprime(5)\n      True\n      sage: my_isprime(55)\n      False\nCall docstring:\n   Calling self calls the wrapped object.\n\n   EXAMPLES:\n\n      sage: from sage.misc.lazy_import import LazyImport\n      sage: my_isprime = LazyImport('sage.all', 'is_prime')\n      sage: my_isprime(12)\n      False\n      sage: my_isprime(13)\n      True\n```",
    "created_at": "2016-05-22T08:47:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358737",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:2'></a>
Possibly related: documentation of lazy imports includes various `lazy_import` stuff

```
sage: %pinfo piecewise
Type:            LazyImport
String form:     piecewise
File:            ~/Sage/src/sage/misc/lazy_import.pyx
Docstring:
   Piecewise function    <---- this section is the only one that is correct

   EXAMPLES:

      sage: var('x, y')
      (x, y)
      sage: f = piecewise([((0,1), x^2*y), ([-1,0], -x*y^2)], var=x);  f
      piecewise(x|-->x^2*y on (0, 1), x|-->-x*y^2 on [-1, 0]; x)
      sage: f(1/2)
      1/4*y
      sage: f(-1/2)
      1/2*y^2

Class docstring:
   EXAMPLES:

      sage: from sage.misc.lazy_import import LazyImport
      sage: my_integer = LazyImport('sage.rings.all', 'Integer')
      sage: my_integer(4)
      4
      sage: my_integer('101', base=2)
      5
      sage: my_integer(3/2)
      Traceback (most recent call last):
      ...
      TypeError: no conversion of this rational to integer
Init docstring:
   EXAMPLES:

      sage: from sage.misc.lazy_import import LazyImport
      sage: my_isprime = LazyImport('sage.all', 'is_prime')
      sage: my_isprime(5)
      True
      sage: my_isprime(55)
      False
Call docstring:
   Calling self calls the wrapped object.

   EXAMPLES:

      sage: from sage.misc.lazy_import import LazyImport
      sage: my_isprime = LazyImport('sage.all', 'is_prime')
      sage: my_isprime(12)
      False
      sage: my_isprime(13)
      True
```



---

archive/issue_events_063440.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-04-06T12:04:00Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "milestone": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20626#event-63440"
}
```



---

archive/issue_comments_358738.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,33 +1,29 @@\n-*Steps to reproduce*: extract the attached archive containing a\n-trivial module bar lazy imported from a module foo in the current\n-directory, and run sage:\n+*Steps to reproduce*: apply this patch:\n+\n+```diff\n+diff --git a/src/sage/combinat/__init__.py b/src/sage/combinat/__init__.py\n+index 24242dd..220794c 100644\n+--- a/src/sage/combinat/__init__.py\n++++ b/src/sage/combinat/__init__.py\n+@@ -43,5 +43,9 @@ Related topics\n+ - :ref:`sage.graphs`\n+ \n+ \"\"\"\n+-from . import quickref\n+-from . import tutorial\n++\n++from sage.misc.lazy_import import lazyimport\n++\n++with lazyimport:\n++    from . import quickref\n++    from . import tutorial\n+```\n+\n+And run Sage:\n \n ```\n-sage: import foo\n-sage: foo.bar?\n----------------------------------------------------------------------------\n-RuntimeError                              Traceback (most recent call last)\n-<ipython-input-2-04fe32111b22> in <module>()\n-----> 1 get_ipython().magic(u'pinfo foo.bar')\n-\n-/opt/sage-git/local/lib/python2.7/site-packages/IPython/core/interactiveshell.pyc in magic(self, arg_s)\n-   2161         magic_name, _, magic_arg_s = arg_s.partition(' ')\n-   2162         magic_name = magic_name.lstrip(prefilter.ESC_MAGIC)\n--> 2163         return self.run_line_magic(magic_name, magic_arg_s)\n-   2164 \n-   2165     #-------------------------------------------------------------------------\n-\n-\n-... last 3 frames repeated, from the frame below ...\n-\n-/opt/sage-git/local/lib/python2.7/site-packages/sage/misc/sageinspect.pyc in sage_getdoc_original(obj)\n-   1765         typ = type(obj)\n-   1766 \n--> 1767     s,argspec = _extract_embedded_signature(_sage_getdoc_unformatted(obj), typ.__name__)\n-   1768     if s:\n-   1769         pos = _extract_embedded_position(s)\n-\n-RuntimeError: maximum recursion depth exceeded in __instancecheck__\n+sage: sage.combinat.tutorial?\n+Segmentation fault\n ```\n \n *Analysis*: sage.misc.sageinspect.sage_getdoc_original gets confused\n``````\n",
    "created_at": "2017-04-06T12:04:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358738",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,33 +1,29 @@
-*Steps to reproduce*: extract the attached archive containing a
-trivial module bar lazy imported from a module foo in the current
-directory, and run sage:
+*Steps to reproduce*: apply this patch:
+
+```diff
+diff --git a/src/sage/combinat/__init__.py b/src/sage/combinat/__init__.py
+index 24242dd..220794c 100644
+--- a/src/sage/combinat/__init__.py
++++ b/src/sage/combinat/__init__.py
+@@ -43,5 +43,9 @@ Related topics
+ - :ref:`sage.graphs`
+ 
+ """
+-from . import quickref
+-from . import tutorial
++
++from sage.misc.lazy_import import lazyimport
++
++with lazyimport:
++    from . import quickref
++    from . import tutorial
+```
+
+And run Sage:
 
 ```
-sage: import foo
-sage: foo.bar?
----------------------------------------------------------------------------
-RuntimeError                              Traceback (most recent call last)
-<ipython-input-2-04fe32111b22> in <module>()
-----> 1 get_ipython().magic(u'pinfo foo.bar')
-
-/opt/sage-git/local/lib/python2.7/site-packages/IPython/core/interactiveshell.pyc in magic(self, arg_s)
-   2161         magic_name, _, magic_arg_s = arg_s.partition(' ')
-   2162         magic_name = magic_name.lstrip(prefilter.ESC_MAGIC)
--> 2163         return self.run_line_magic(magic_name, magic_arg_s)
-   2164 
-   2165     #-------------------------------------------------------------------------
-
-
-... last 3 frames repeated, from the frame below ...
-
-/opt/sage-git/local/lib/python2.7/site-packages/sage/misc/sageinspect.pyc in sage_getdoc_original(obj)
-   1765         typ = type(obj)
-   1766 
--> 1767     s,argspec = _extract_embedded_signature(_sage_getdoc_unformatted(obj), typ.__name__)
-   1768     if s:
-   1769         pos = _extract_embedded_position(s)
-
-RuntimeError: maximum recursion depth exceeded in __instancecheck__
+sage: sage.combinat.tutorial?
+Segmentation fault
 ```
 
 *Analysis*: sage.misc.sageinspect.sage_getdoc_original gets confused
``````




---

archive/issue_events_063441.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "rename": {
        "from": "lazy_import'ed modules broken on introspection",
        "to": "Introspection of lazy_import'ed modules crashes Sage"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20626#event-63441"
}
```



---

archive/issue_comments_358739.json:
```json
{
    "body": "**Dependencies:** #15648",
    "created_at": "2017-04-06T12:04:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358739",
    "user": "https://github.com/jdemeyer"
}
```

**Dependencies:** #15648



---

archive/issue_comments_358740.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -12,9 +12,9 @@\n -from . import quickref\n -from . import tutorial\n +\n-+from sage.misc.lazy_import import lazyimport\n++from sage.misc.lazy_import import _lazyimport_\n +\n-+with lazyimport:\n++with _lazyimport_:\n +    from . import quickref\n +    from . import tutorial\n ```\n``````\n",
    "created_at": "2017-04-06T12:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358740",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -12,9 +12,9 @@
 -from . import quickref
 -from . import tutorial
 +
-+from sage.misc.lazy_import import lazyimport
++from sage.misc.lazy_import import _lazyimport_
 +
-+with lazyimport:
++with _lazyimport_:
 +    from . import quickref
 +    from . import tutorial
 ```
``````




---

archive/issue_comments_358741.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-*Steps to reproduce*: apply this patch:\n+**Steps to reproduce**: apply this patch:\n \n ```diff\n diff --git a/src/sage/combinat/__init__.py b/src/sage/combinat/__init__.py\n@@ -26,12 +26,12 @@\n Segmentation fault\n ```\n \n-*Analysis*: sage.misc.sageinspect.sage_getdoc_original gets confused\n+**Analysis**: sage.misc.sageinspect.sage_getdoc_original gets confused\n when detecting that `foo.bar` is of type `LazyImport` (and not module)\n and trying to recover its documentation from there.\n \n \n-*Use case*: some Sage modules contain only documentation:\n+**Use case**: some Sage modules contain only documentation:\n \n - `sage.combinat.tutorial`\n - `sage.combinat.primer`\n``````\n",
    "created_at": "2017-04-06T12:37:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358741",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-*Steps to reproduce*: apply this patch:
+**Steps to reproduce**: apply this patch:
 
 ```diff
 diff --git a/src/sage/combinat/__init__.py b/src/sage/combinat/__init__.py
@@ -26,12 +26,12 @@
 Segmentation fault
 ```
 
-*Analysis*: sage.misc.sageinspect.sage_getdoc_original gets confused
+**Analysis**: sage.misc.sageinspect.sage_getdoc_original gets confused
 when detecting that `foo.bar` is of type `LazyImport` (and not module)
 and trying to recover its documentation from there.
 
 
-*Use case*: some Sage modules contain only documentation:
+**Use case**: some Sage modules contain only documentation:
 
 - `sage.combinat.tutorial`
 - `sage.combinat.primer`
``````




---

archive/issue_comments_358742.json:
```json
{
    "body": "**Author:** Jeroen Demeyer",
    "created_at": "2017-04-06T13:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358742",
    "user": "https://github.com/jdemeyer"
}
```

**Author:** Jeroen Demeyer



---

archive/issue_comments_358743.json:
```json
{
    "body": "**Changing upstream** from \"N/A\" to \"Reported upstream. No feedback yet.\".",
    "created_at": "2017-04-06T13:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358743",
    "user": "https://github.com/jdemeyer"
}
```

**Changing upstream** from "N/A" to "Reported upstream. No feedback yet.".



---

archive/issue_comments_358744.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -42,3 +42,4 @@\n and more will come. It would be nice to lazy import them to reduce the\n memory and startup footprint.\n \n+This requires a simple IPython patch: https://github.com/ipython/ipython/pull/10426\n``````\n",
    "created_at": "2017-04-06T13:24:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358744",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -42,3 +42,4 @@
 and more will come. It would be nice to lazy import them to reduce the
 memory and startup footprint.
 
+This requires a simple IPython patch: https://github.com/ipython/ipython/pull/10426
``````




---

archive/issue_comments_358745.json:
```json
{
    "body": "**Branch:** [u/jdemeyer/ticket/20626](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/20626)",
    "created_at": "2017-04-06T13:43:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358745",
    "user": "https://github.com/jdemeyer"
}
```

**Branch:** [u/jdemeyer/ticket/20626](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/20626)



---

archive/issue_comments_358746.json:
```json
{
    "body": "**Commit:** [f25a7d7416b54f4b7e9fac0fb9c9c50fb10bb0a5](https://github.com/sagemath/sagetrac-mirror/commit/f25a7d7416b54f4b7e9fac0fb9c9c50fb10bb0a5)",
    "created_at": "2017-04-06T13:45:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358746",
    "user": "https://github.com/jdemeyer"
}
```

**Commit:** [f25a7d7416b54f4b7e9fac0fb9c9c50fb10bb0a5](https://github.com/sagemath/sagetrac-mirror/commit/f25a7d7416b54f4b7e9fac0fb9c9c50fb10bb0a5)



---

archive/issue_comments_358747.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2017-04-06T13:45:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358747",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_358748.json:
```json
{
    "body": "<a id='comment:8'></a>\n**Last 10 new commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8aac18a6b165bc397ccaeaba0b596797e900b0f1\">8aac18a</a></td><td><code>Various improvements to lazy imports</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8ec9f5d89dc2f92c1208239089453a8ec2065b72\">8ec9f5d</a></td><td><code>Lazy import context based on __import__</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d50f9a6fd601c890baec160ac2b80f007cf258aa\">d50f9a6</a></td><td><code>Make \"with lazyimport\" context more thread-safe</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3d62c9e7810c3d7550a82bb8b93d03e1f228ea72\">3d62c9e</a></td><td><code>Update documentation</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9e1208b437e7855a6989a0ea42e42553f2772a84\">9e1208b</a></td><td><code>lazyimport -> _lazyimport_</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/796a45277a23c14ea86126f5e08349f2c25c34d2\">796a452</a></td><td><code>Search for object in __get__</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/a393dd19d22c0a42ce97799ef083cc7d7270934c\">a393dd1</a></td><td><code>Delete lazy import from namespace before doing real import</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/565ee68db4ddd7e5d026957c1b99a088634f7a29\">565ee68</a></td><td><code>Patch IPython to ignore all exceptions from getargspec()</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3840f1ed009a80084f94c58bd7f2553b166baf85\">3840f1e</a></td><td><code>Lazy import combinat documentation</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f25a7d7416b54f4b7e9fac0fb9c9c50fb10bb0a5\">f25a7d7</a></td><td><code>Return the actual __doc__, not sage_getdoc_original()</code></td></tr></table>\n",
    "created_at": "2017-04-06T13:45:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358748",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
**Last 10 new commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8aac18a6b165bc397ccaeaba0b596797e900b0f1">8aac18a</a></td><td><code>Various improvements to lazy imports</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8ec9f5d89dc2f92c1208239089453a8ec2065b72">8ec9f5d</a></td><td><code>Lazy import context based on __import__</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d50f9a6fd601c890baec160ac2b80f007cf258aa">d50f9a6</a></td><td><code>Make "with lazyimport" context more thread-safe</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3d62c9e7810c3d7550a82bb8b93d03e1f228ea72">3d62c9e</a></td><td><code>Update documentation</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9e1208b437e7855a6989a0ea42e42553f2772a84">9e1208b</a></td><td><code>lazyimport -> _lazyimport_</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/796a45277a23c14ea86126f5e08349f2c25c34d2">796a452</a></td><td><code>Search for object in __get__</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/a393dd19d22c0a42ce97799ef083cc7d7270934c">a393dd1</a></td><td><code>Delete lazy import from namespace before doing real import</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/565ee68db4ddd7e5d026957c1b99a088634f7a29">565ee68</a></td><td><code>Patch IPython to ignore all exceptions from getargspec()</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3840f1ed009a80084f94c58bd7f2553b166baf85">3840f1e</a></td><td><code>Lazy import combinat documentation</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f25a7d7416b54f4b7e9fac0fb9c9c50fb10bb0a5">f25a7d7</a></td><td><code>Return the actual __doc__, not sage_getdoc_original()</code></td></tr></table>




---

archive/issue_events_063442.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-04-06T20:16:13Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20626#event-63442"
}
```



---

archive/issue_events_063443.json:
```json
{
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "label": "wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20626#event-63443"
}
```



---

archive/issue_events_063444.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-04-06T20:16:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "milestone": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20626#event-63444"
}
```



---

archive/issue_events_063445.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2017-04-06T20:16:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20626#event-63445"
}
```



---

archive/issue_comments_358749.json:
```json
{
    "body": "**Changing status** from closed to new.",
    "created_at": "2017-04-06T20:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358749",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from closed to new.



---

archive/issue_comments_358750.json:
```json
{
    "body": "**Changing branch** from \"[u/jdemeyer/ticket/20626](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/20626)\" to \"\".",
    "created_at": "2017-04-06T20:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358750",
    "user": "https://github.com/jdemeyer"
}
```

**Changing branch** from "[u/jdemeyer/ticket/20626](https://github.com/sagemath/sagetrac-mirror/tree/u/jdemeyer/ticket/20626)" to "".



---

archive/issue_comments_358751.json:
```json
{
    "body": "**Changing author** from \"Jeroen Demeyer\" to \"\".",
    "created_at": "2017-04-06T20:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358751",
    "user": "https://github.com/jdemeyer"
}
```

**Changing author** from "Jeroen Demeyer" to "".



---

archive/issue_events_063446.json:
```json
{
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "label": "wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20626#event-63446"
}
```



---

archive/issue_comments_358752.json:
```json
{
    "body": "**Changing commit** from \"[f25a7d7416b54f4b7e9fac0fb9c9c50fb10bb0a5](https://github.com/sagemath/sagetrac-mirror/commit/f25a7d7416b54f4b7e9fac0fb9c9c50fb10bb0a5)\" to \"\".",
    "created_at": "2017-04-06T20:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358752",
    "user": "https://github.com/jdemeyer"
}
```

**Changing commit** from "[f25a7d7416b54f4b7e9fac0fb9c9c50fb10bb0a5](https://github.com/sagemath/sagetrac-mirror/commit/f25a7d7416b54f4b7e9fac0fb9c9c50fb10bb0a5)" to "".



---

archive/issue_comments_358753.json:
```json
{
    "body": "**Changing dependencies** from \"#15648\" to \"\".",
    "created_at": "2017-04-06T20:26:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358753",
    "user": "https://github.com/jdemeyer"
}
```

**Changing dependencies** from "#15648" to "".



---

archive/issue_comments_358754.json:
```json
{
    "body": "<a id='comment:12'></a>\nHi Jeroen,\nI am happy to see work happening on this front, but a bit confused by the recent activity. Could you clarify? Thanks!",
    "created_at": "2017-04-07T03:12:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358754",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:12'></a>
Hi Jeroen,
I am happy to see work happening on this front, but a bit confused by the recent activity. Could you clarify? Thanks!



---

archive/issue_comments_358755.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [nthiery](#comment%3A12):\n> Hi Jeroen,\n> I am happy to see work happening on this front, but a bit confused by the recent activity. Could you clarify?\n\n\nI got quite negative reactions (mostly from Nils Bruin but also from Erik Bray) on #22752, which is a dependency of this ticket and #15648.\n\nSo either\n\n1. Nils and/or Erik need to reimplement lazy imports \"their way\".\n\n2. Nils and/or Erik should realize that my code on #22752 wasn't so bad anyway.\n\n3. We try to fix #15648 and #20626 with the current implementation of lazy imports, without #22752.",
    "created_at": "2017-04-07T07:31:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358755",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
Replying to [nthiery](#comment%3A12):
> Hi Jeroen,
> I am happy to see work happening on this front, but a bit confused by the recent activity. Could you clarify?


I got quite negative reactions (mostly from Nils Bruin but also from Erik Bray) on #22752, which is a dependency of this ticket and #15648.

So either

1. Nils and/or Erik need to reimplement lazy imports "their way".

2. Nils and/or Erik should realize that my code on #22752 wasn't so bad anyway.

3. We try to fix #15648 and #20626 with the current implementation of lazy imports, without #22752.



---

archive/issue_comments_358756.json:
```json
{
    "body": "<a id='comment:14'></a>\nHi there,\nWhile searching for lazy import issues I stumbled back on this ticket. It seems things have evolved a bit since the last comment with #22752 being merged. Does it change the status of this ticket?\n\nCheers,",
    "created_at": "2018-07-22T15:03:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358756",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:14'></a>
Hi there,
While searching for lazy import issues I stumbled back on this ticket. It seems things have evolved a bit since the last comment with #22752 being merged. Does it change the status of this ticket?

Cheers,



---

archive/issue_events_063447.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-07-22T15:29:11Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20626#event-63447"
}
```



---

archive/issue_events_063448.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2018-07-22T15:29:11Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20626#event-63448"
}
```



---

archive/issue_comments_358757.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,29 +1,31 @@\n-**Steps to reproduce**: apply this patch:\n-\n-```diff\n-diff --git a/src/sage/combinat/__init__.py b/src/sage/combinat/__init__.py\n-index 24242dd..220794c 100644\n---- a/src/sage/combinat/__init__.py\n-+++ b/src/sage/combinat/__init__.py\n-@@ -43,5 +43,9 @@ Related topics\n- - :ref:`sage.graphs`\n- \n- \"\"\"\n--from . import quickref\n--from . import tutorial\n-+\n-+from sage.misc.lazy_import import _lazyimport_\n-+\n-+with _lazyimport_:\n-+    from . import quickref\n-+    from . import tutorial\n-```\n-\n-And run Sage:\n+**Steps to reproduce**: extract the attached archive containing a trivial module bar lazy imported from a module foo in the current directory, and run sage:\n \n ```\n-sage: sage.combinat.tutorial?\n-Segmentation fault\n+sage: import foo\n+sage: foo.bar?\n+---------------------------------------------------------------------------\n+RuntimeError                              Traceback (most recent call last)\n+<ipython-input-2-04fe32111b22> in <module>()\n+----> 1 get_ipython().magic(u'pinfo foo.bar')\n+\n+/opt/sage-git/local/lib/python2.7/site-packages/IPython/core/interactiveshell.pyc in magic(self, arg_s)\n+   2161         magic_name, _, magic_arg_s = arg_s.partition(' ')\n+   2162         magic_name = magic_name.lstrip(prefilter.ESC_MAGIC)\n+-> 2163         return self.run_line_magic(magic_name, magic_arg_s)\n+   2164 \n+   2165     #-------------------------------------------------------------------------\n+\n+\n+... last 3 frames repeated, from the frame below ...\n+\n+/opt/sage-git/local/lib/python2.7/site-packages/sage/misc/sageinspect.pyc in sage_getdoc_original(obj)\n+   1765         typ = type(obj)\n+   1766 \n+-> 1767     s,argspec = _extract_embedded_signature(_sage_getdoc_unformatted(obj), typ.__name__)\n+   1768     if s:\n+   1769         pos = _extract_embedded_position(s)\n+\n+RuntimeError: maximum recursion depth exceeded in __instancecheck__\n ```\n \n **Analysis**: sage.misc.sageinspect.sage_getdoc_original gets confused\n``````\n",
    "created_at": "2018-07-22T15:29:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358757",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,29 +1,31 @@
-**Steps to reproduce**: apply this patch:
-
-```diff
-diff --git a/src/sage/combinat/__init__.py b/src/sage/combinat/__init__.py
-index 24242dd..220794c 100644
---- a/src/sage/combinat/__init__.py
-+++ b/src/sage/combinat/__init__.py
-@@ -43,5 +43,9 @@ Related topics
- - :ref:`sage.graphs`
- 
- """
--from . import quickref
--from . import tutorial
-+
-+from sage.misc.lazy_import import _lazyimport_
-+
-+with _lazyimport_:
-+    from . import quickref
-+    from . import tutorial
-```
-
-And run Sage:
+**Steps to reproduce**: extract the attached archive containing a trivial module bar lazy imported from a module foo in the current directory, and run sage:
 
 ```
-sage: sage.combinat.tutorial?
-Segmentation fault
+sage: import foo
+sage: foo.bar?
+---------------------------------------------------------------------------
+RuntimeError                              Traceback (most recent call last)
+<ipython-input-2-04fe32111b22> in <module>()
+----> 1 get_ipython().magic(u'pinfo foo.bar')
+
+/opt/sage-git/local/lib/python2.7/site-packages/IPython/core/interactiveshell.pyc in magic(self, arg_s)
+   2161         magic_name, _, magic_arg_s = arg_s.partition(' ')
+   2162         magic_name = magic_name.lstrip(prefilter.ESC_MAGIC)
+-> 2163         return self.run_line_magic(magic_name, magic_arg_s)
+   2164 
+   2165     #-------------------------------------------------------------------------
+
+
+... last 3 frames repeated, from the frame below ...
+
+/opt/sage-git/local/lib/python2.7/site-packages/sage/misc/sageinspect.pyc in sage_getdoc_original(obj)
+   1765         typ = type(obj)
+   1766 
+-> 1767     s,argspec = _extract_embedded_signature(_sage_getdoc_unformatted(obj), typ.__name__)
+   1768     if s:
+   1769         pos = _extract_embedded_position(s)
+
+RuntimeError: maximum recursion depth exceeded in __instancecheck__
 ```
 
 **Analysis**: sage.misc.sageinspect.sage_getdoc_original gets confused
``````




---

archive/issue_comments_358758.json:
```json
{
    "body": "**Changing upstream** from \"Reported upstream. No feedback yet.\" to \"Fixed upstream, in a later stable release.\".",
    "created_at": "2018-07-22T15:29:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358758",
    "user": "https://github.com/jdemeyer"
}
```

**Changing upstream** from "Reported upstream. No feedback yet." to "Fixed upstream, in a later stable release.".



---

archive/issue_comments_358759.json:
```json
{
    "body": "<a id='comment:15'></a>\nI am reverting to the ticket description before #22752. Do you still have that \"attached archive containing a trivial module bar lazy imported\"?",
    "created_at": "2018-07-22T15:29:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358759",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>
I am reverting to the ticket description before #22752. Do you still have that "attached archive containing a trivial module bar lazy imported"?



---

archive/issue_comments_358760.json:
```json
{
    "body": "<a id='comment:16'></a>\nupdate milestone 8.3 -> 8.4",
    "created_at": "2018-08-03T19:20:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358760",
    "user": "https://github.com/videlec"
}
```

<a id='comment:16'></a>
update milestone 8.3 -> 8.4



---

archive/issue_events_063449.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-08-03T19:20:18Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "milestone": "sage-8.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20626#event-63449"
}
```



---

archive/issue_events_063450.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2018-08-03T19:20:18Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "milestone": "sage-8.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20626#event-63450"
}
```



---

archive/issue_comments_358761.json:
```json
{
    "body": "<a id='comment:17'></a>\nPrompted by Sam, I tried to recreate the archive with several variants of:\n\n```\nmkdir -p foo/bar\ntouch foo/bar/__init__.py\ncat > foo/__init.py__ <<EOF\nfrom sage.misc.lazy_import import LazyImport\nbar = LazyImport('foo', 'bar')\nEOF\n```\n\nHowever -- not quite surprisingly -- that fails:\n\n```\nsage                                                                                                                  \n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.0, Release Date: 2020-01-01                     \u2502\n\u2502 Using Python 3.7.3. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nsage: import foo\nsage: foo.bar\n------------------------------------------------------------------------\n/opt/sage-git/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x9a64)[0x7f49349d7a64]\n/opt/sage-git/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x9b19)[0x7f49349d7b19]\n/opt/sage-git/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xd57f)[0x7f49349db57f]\n/lib/x86_64-linux-gnu/libc.so.6(+0x46470)[0x7f49373fe470]\n/opt/sage-git/local/lib/libpython3.7m.so.1.0(+0xe2e44)[0x7f49376c8e44]\n/opt/sage-git/local/lib/libpython3.7m.so.1.0(PyUnicode_New+0x8b)[0x7f49376e98fb]\n/opt/sage-git/local/lib/libpython3.7m.so.1.0(_PyUnicodeWriter_PrepareInternal+0x1c1)[0x7f493770fad1]\n```\n\nI can't remember which idiom I had tried back then. Maybe that\nidiom does not exist anymore.\n\nIt would be useful though to have some idiom that enables to lazy\nimport a submodule into a module, making sure that one can indeed\ninspect its documentation.",
    "created_at": "2020-09-19T04:44:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20626",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20626#issuecomment-358761",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:17'></a>
Prompted by Sam, I tried to recreate the archive with several variants of:

```
mkdir -p foo/bar
touch foo/bar/__init__.py
cat > foo/__init.py__ <<EOF
from sage.misc.lazy_import import LazyImport
bar = LazyImport('foo', 'bar')
EOF
```

However -- not quite surprisingly -- that fails:

```
sage                                                                                                                  
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.0, Release Date: 2020-01-01                     │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: import foo
sage: foo.bar
------------------------------------------------------------------------
/opt/sage-git/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x9a64)[0x7f49349d7a64]
/opt/sage-git/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0x9b19)[0x7f49349d7b19]
/opt/sage-git/local/lib/python3.7/site-packages/cysignals/signals.cpython-37m-x86_64-linux-gnu.so(+0xd57f)[0x7f49349db57f]
/lib/x86_64-linux-gnu/libc.so.6(+0x46470)[0x7f49373fe470]
/opt/sage-git/local/lib/libpython3.7m.so.1.0(+0xe2e44)[0x7f49376c8e44]
/opt/sage-git/local/lib/libpython3.7m.so.1.0(PyUnicode_New+0x8b)[0x7f49376e98fb]
/opt/sage-git/local/lib/libpython3.7m.so.1.0(_PyUnicodeWriter_PrepareInternal+0x1c1)[0x7f493770fad1]
```

I can't remember which idiom I had tried back then. Maybe that
idiom does not exist anymore.

It would be useful though to have some idiom that enables to lazy
import a submodule into a module, making sure that one can indeed
inspect its documentation.
