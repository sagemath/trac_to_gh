# Issue 20932: Issues with p1list in modular symbols

archive/issues_020695.json:
```json
{
    "body": "Assignee: @kedlaya\n\nCC:  @rharron\n\nKeywords: modular symbols\n\nTwo related issues with modular symbols, originally reported by robharron on sage-nt: [https://groups.google.com/forum/#!msg/sage-nt/5HYpZKFB2qA/fRXgDkaICAAJ](https://groups.google.com/forum/#!msg/sage-nt/5HYpZKFB2qA/fRXgDkaICAAJ).\n\nIssue 1:\n\n```\nsage: chi = kronecker_character(3*34603)\nsage: M = ModularSymbols(chi, 2, sign=1, base_ring=GF(3))\n...\nFile \"/projects/sage/sage-6.10/local/lib/python2.7/site-packages/sage/modular/modsym/relation_matrix.py\", line 126, in modS_relations\n    assert j != -1\nAssertionError\n```\nThe underlying problem appears to be:\n\n```\nsage: import sage.modular.modsym.p1list as p1list\nsage: for (i,j) in p1list.P1List(103809):\nsage:    if i != 1 and i != 3: print (i,j)\n(0, 1) #should also return (34603, 1), (34603, 2), (34603, 3)\n```\n\nIssue 2:\n\n```\nsage: chi = kronecker_character(3*61379)\nsage: M = ModularSymbols(chi, 2, sign=1, base_ring=GF(3))\n...\n  File \"sage/rings/fast_arith.pyx\", line 381, in sage.rings.fast_arith.arith_llong.c_inverse_mod_longlong (/projects/sage/sage-6.10/src/build/cythonized/sage/rings/fast_arith.c:5546)\n    raise ArithmeticError(\"The inverse of %s modulo %s is not defined.\"%(a,m))\nArithmeticError: The inverse of -2142142713 modulo 184137 is not defined.\n```\nThe underlying issue appears to be:\n\n```\nsage: import sage.modular.modsym.p1list as p1list\nsage: N = 3*61379\nsage: p1 = p1list.P1List(N)\nsage: p1.normalize_with_scalar(21, -1) \n...\nArithmeticError: The inverse of -2142142713 modulo 184137 is not defined.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/20932\n\n",
    "closed_at": "2017-08-21T19:24:09Z",
    "created_at": "2016-07-03T16:47:19Z",
    "labels": [
        "component: modular forms",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "Issues with p1list in modular symbols",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20932",
    "user": "https://github.com/kedlaya"
}
```
Assignee: @kedlaya

CC:  @rharron

Keywords: modular symbols

Two related issues with modular symbols, originally reported by robharron on sage-nt: [https://groups.google.com/forum/#!msg/sage-nt/5HYpZKFB2qA/fRXgDkaICAAJ](https://groups.google.com/forum/#!msg/sage-nt/5HYpZKFB2qA/fRXgDkaICAAJ).

Issue 1:

```
sage: chi = kronecker_character(3*34603)
sage: M = ModularSymbols(chi, 2, sign=1, base_ring=GF(3))
...
File "/projects/sage/sage-6.10/local/lib/python2.7/site-packages/sage/modular/modsym/relation_matrix.py", line 126, in modS_relations
    assert j != -1
AssertionError
```
The underlying problem appears to be:

```
sage: import sage.modular.modsym.p1list as p1list
sage: for (i,j) in p1list.P1List(103809):
sage:    if i != 1 and i != 3: print (i,j)
(0, 1) #should also return (34603, 1), (34603, 2), (34603, 3)
```

Issue 2:

```
sage: chi = kronecker_character(3*61379)
sage: M = ModularSymbols(chi, 2, sign=1, base_ring=GF(3))
...
  File "sage/rings/fast_arith.pyx", line 381, in sage.rings.fast_arith.arith_llong.c_inverse_mod_longlong (/projects/sage/sage-6.10/src/build/cythonized/sage/rings/fast_arith.c:5546)
    raise ArithmeticError("The inverse of %s modulo %s is not defined."%(a,m))
ArithmeticError: The inverse of -2142142713 modulo 184137 is not defined.
```
The underlying issue appears to be:

```
sage: import sage.modular.modsym.p1list as p1list
sage: N = 3*61379
sage: p1 = p1list.P1List(N)
sage: p1.normalize_with_scalar(21, -1) 
...
ArithmeticError: The inverse of -2142142713 modulo 184137 is not defined.


Issue created by migration from https://trac.sagemath.org/ticket/20932





---

archive/issue_comments_285637.json:
```json
{
    "body": "In `p1list`, one finds different code depending on the size of the level. For levels in this range, the relevant subroutine is `p1list_llong`, which contains:\n\n```\n    cmax = N/2\n    if N%2:   # N odd, max divisor is <= N/3\n        if N%5:  # N not a multiple of 3 either, max is N/5\n            cmax = N/5\n        else:\n            cmax = N/3\n```\nbut `N%5` should be `N%3`.",
    "created_at": "2016-07-03T16:49:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285637",
    "user": "https://github.com/kedlaya"
}
```

In `p1list`, one finds different code depending on the size of the level. For levels in this range, the relevant subroutine is `p1list_llong`, which contains:

```
    cmax = N/2
    if N%2:   # N odd, max divisor is <= N/3
        if N%5:  # N not a multiple of 3 either, max is N/5
            cmax = N/5
        else:
            cmax = N/3
```
but `N%5` should be `N%3`.



---

archive/issue_comments_285638.json:
```json
{
    "body": "Re issue 2: the offending subroutine in `p1list` appears to be `c_p1_normalize_llong`, in which one finds:\n\n```\n    if compute_s:\n        ss[0] = <int> (arith_llong.c_inverse_mod_longlong(s*min_t, N) % ll_N)\n```\nAs written, this creates a 32-bit integer overflow. It should be:\n\n```\n    if compute_s:\n        ss[0] = <int> (arith_llong.c_inverse_mod_longlong((<llong> s)*(<llong> min_t), N) % ll_N)\n```",
    "created_at": "2016-07-04T15:28:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285638",
    "user": "https://github.com/kedlaya"
}
```

Re issue 2: the offending subroutine in `p1list` appears to be `c_p1_normalize_llong`, in which one finds:

```
    if compute_s:
        ss[0] = <int> (arith_llong.c_inverse_mod_longlong(s*min_t, N) % ll_N)
```
As written, this creates a 32-bit integer overflow. It should be:

```
    if compute_s:
        ss[0] = <int> (arith_llong.c_inverse_mod_longlong((<llong> s)*(<llong> min_t), N) % ll_N)
```



---

archive/issue_comments_285639.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-07-04T20:34:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285639",
    "user": "https://github.com/kedlaya"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_285640.json:
```json
{
    "body": "This patch addresses both issues in the description. Besides doctesting the isolating code fragments, I added optional doctests for the construction of the spaces of modular symbols; however, these take far too long to be required even as long doctests.\n\n---\nNew commits:",
    "created_at": "2016-07-04T20:34:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285640",
    "user": "https://github.com/kedlaya"
}
```

This patch addresses both issues in the description. Besides doctesting the isolating code fragments, I added optional doctests for the construction of the spaces of modular symbols; however, these take far too long to be required even as long doctests.

---
New commits:



---

archive/issue_comments_285641.json:
```json
{
    "body": "Apologies for the typo which git blame attributes to me in April 2009.",
    "created_at": "2016-07-10T21:05:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285641",
    "user": "https://github.com/JohnCremona"
}
```

Apologies for the typo which git blame attributes to me in April 2009.



---

archive/issue_comments_285642.json:
```json
{
    "body": "The following syntax is wrong\n\n```\n+    TESTS::\n+    \n+    This test reflects :trac:`20932`::\n+        sage: N = 3*61379\n```\nIt should be changed to\n\n```\n    TESTS:    <--- only one colon\n\n    This test reflects :trac`20932`::\n                                         <--- line break\n        sage: N = 3*61379\n```",
    "created_at": "2016-07-25T01:45:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285642",
    "user": "https://github.com/videlec"
}
```

The following syntax is wrong

```
+    TESTS::
+    
+    This test reflects :trac:`20932`::
+        sage: N = 3*61379
```
It should be changed to

```
    TESTS:    <--- only one colon

    This test reflects :trac`20932`::
                                         <--- line break
        sage: N = 3*61379
```



---

archive/issue_comments_285643.json:
```json
{
    "body": "In the doctest you mention `:trac:`20513`` which is another matter.",
    "created_at": "2016-07-25T01:47:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285643",
    "user": "https://github.com/videlec"
}
```

In the doctest you mention `:trac:`20513`` which is another matter.



---

archive/issue_comments_285644.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-07-25T01:47:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285644",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_285645.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-25T21:58:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285645",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_285646.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-07-25T21:59:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285646",
    "user": "https://github.com/kedlaya"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_285647.json:
```json
{
    "body": "The formatting should be fixed now.",
    "created_at": "2016-07-25T21:59:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285647",
    "user": "https://github.com/kedlaya"
}
```

The formatting should be fixed now.



---

archive/issue_comments_285648.json:
```json
{
    "body": "would it be possible to have faster (smaller) doctests ? 600s is too much and 1800s is *way* too much.. \n\nat worse, maybe keep only the 600s one..",
    "created_at": "2016-11-06T20:10:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285648",
    "user": "https://github.com/fchapoton"
}
```

would it be possible to have faster (smaller) doctests ? 600s is too much and 1800s is *way* too much.. 

at worse, maybe keep only the 600s one..



---

archive/issue_comments_285649.json:
```json
{
    "body": "Replying to [comment:10 chapoton]:\n> would it be possible to have faster (smaller) doctests ? 600s is too much and 1800s is *way* too much.. \n> \n> at worse, maybe keep only the 600s one..\n\n \nSadly no, this is precisely a bug that occurs only for large problem sizes (see comment 1), so any doctest that actually tests it will have to deal with large problems. Is it okay if all of the doctests that confirm the resolution of this issue are optional?",
    "created_at": "2016-11-06T20:54:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285649",
    "user": "https://github.com/kedlaya"
}
```

Replying to [comment:10 chapoton]:
> would it be possible to have faster (smaller) doctests ? 600s is too much and 1800s is *way* too much.. 
> 
> at worse, maybe keep only the 600s one..

 
Sadly no, this is precisely a bug that occurs only for large problem sizes (see comment 1), so any doctest that actually tests it will have to deal with large problems. Is it okay if all of the doctests that confirm the resolution of this issue are optional?



---

archive/issue_comments_285650.json:
```json
{
    "body": "If you want these 2 **long** tests to be never tested, they should be tagged `# not tested`, I think. In principle, `optional` should come with a parameter (like spkg name on which it depends), and will be tested whenever possible. As far as I know, there is no bare `optional`.",
    "created_at": "2016-11-07T20:59:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285650",
    "user": "https://github.com/fchapoton"
}
```

If you want these 2 **long** tests to be never tested, they should be tagged `# not tested`, I think. In principle, `optional` should come with a parameter (like spkg name on which it depends), and will be tested whenever possible. As far as I know, there is no bare `optional`.



---

archive/issue_comments_285651.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-14T19:56:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285651",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_285652.json:
```json
{
    "body": "I rebased and marked the doctests as \"not tested\".",
    "created_at": "2017-08-14T20:01:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285652",
    "user": "https://github.com/kedlaya"
}
```

I rebased and marked the doctests as "not tested".



---

archive/issue_comments_285653.json:
```json
{
    "body": "Set assignee to @kedlaya.",
    "created_at": "2017-08-14T20:01:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285653",
    "user": "https://github.com/kedlaya"
}
```

Set assignee to @kedlaya.



---

archive/issue_comments_285654.json:
```json
{
    "body": "There still remains 2 very long tests in src/sage/modular/modsym/modsym.py. I guess they should also be marked as \"not tested\".",
    "created_at": "2017-08-19T16:39:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285654",
    "user": "https://github.com/fchapoton"
}
```

There still remains 2 very long tests in src/sage/modular/modsym/modsym.py. I guess they should also be marked as "not tested".



---

archive/issue_comments_285655.json:
```json
{
    "body": "Look, there was a bug (my old typo); it has been fixed; there are doctests to show this which are marked \"not tested\" for good reasons.  That should be enough for this to pass.  If there are issues with different doctests i nthis file that should be made into a separate issue.  So I am giving this a positive review.",
    "created_at": "2017-08-19T16:51:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285655",
    "user": "https://github.com/JohnCremona"
}
```

Look, there was a bug (my old typo); it has been fixed; there are doctests to show this which are marked "not tested" for good reasons.  That should be enough for this to pass.  If there are issues with different doctests i nthis file that should be made into a separate issue.  So I am giving this a positive review.



---

archive/issue_comments_285656.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-08-19T16:51:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285656",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_285657.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2017-08-19T17:09:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285657",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_285658.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2017-08-19T17:09:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285658",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_285659.json:
```json
{
    "body": "Point taken, when I changed the two doctests in p1list.pyx I should have also touched modsym.py. This is now done, but someone other than me should set this back to positive review.",
    "created_at": "2017-08-19T17:10:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285659",
    "user": "https://github.com/kedlaya"
}
```

Point taken, when I changed the two doctests in p1list.pyx I should have also touched modsym.py. This is now done, but someone other than me should set this back to positive review.



---

archive/issue_comments_285660.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-08-19T17:23:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285660",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_285661.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-08-21T19:24:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20932#issuecomment-285661",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_056057.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-08-21T19:24:09Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20932",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20932#event-56057"
}
```
