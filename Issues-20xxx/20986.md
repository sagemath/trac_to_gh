# Issue 20986: Enhancements to sage-rebase scripts

archive/issues_020749.json:
```json
{
    "body": "The scripts sage-rebase(all).{sh,bat} are used when developing/building Sage on Windows.\n\nIn the long term I'd like to find a way to reduce the need for them, but even then they're still good to have.  It is useful to run these every now and then to ensure that all DLLs in the Sage distribution are configured to load into non-overlapping address ranges by default.  First and foremost this is a performance issue, but also not rebasing can cause failures with Cygwin's fork.\n\nTo summarize what this ticket changes:\n\n* In the wrapper batch scripts, it's no longer necessary to manually adjust `CYGWIN_ROOT` and `SAGE_ROOT`.  In fact, `SAGE_ROOT` is not needed by these scripts so much as `SAGE_LOCAL`, the path to which is automatically detected from the location of the script.  `CYGWIN_ROOT` is determined from the registry.  This *may* be incorrect if there are multiple Cygwin installations on the system, but this is unlikely in most cases.  Furthermore, with the changes I'm making for #15423 there will be less need to use the batch script in the first place (I have rarely had to use them in a long time now).\n* In the sage-rebase.sh and sage-rebaseall.sh scripts:\n  * Now the implementation is all just in `sage-rebase.sh`, which has grown an `--all` flag for performing rebaseall.  So `sage-rebaseall.sh` is just a wrapper around `sage-rebase.sh --all`.  This reduces a lot of code duplication.\n  * The script excludes anything under `/var/tmp` so that build artifacts don't take up space in the address space layout.\n  * The script *does* now include `.fas` modules for ECL, which were previously not included in the rebase.\n  * It is possible to pass the path to `$SAGE_LOCAL` to the scripts as an argument, so it's not necessary for `$SAGE_LOCAL` to be set before running them (useful sometimes during development).\n  * It is possible to pass arbitrary additional flags to the underlying `rebase`/`rebaseall` commands.\n\nThis is just a small collection of enhancements to these scripts.  Most importantly, this adds support for rebase `.fas` binaries that are part of ECL.  Not doing this potentially caused problems for Maxima (so I'm marking this as a defect).\n\nAssignee: @embray\n\nCC:  jpflori\n\nKeywords: cygwin windows\n\nBranch/Commit: [df53e2fe24baf5733739e9ccd6c3de44f992442d](https://github.com/sagemath/sagetrac-mirror/commit/df53e2fe24baf5733739e9ccd6c3de44f992442d)\n\nReviewer: Jean-Pierre Flori\n\nAuthor: Erik Bray\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20986\n\n",
    "closed_at": "2017-05-19T22:10:35Z",
    "created_at": "2016-07-08T13:23:13Z",
    "labels": [
        "component: porting: cygwin",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Enhancements to sage-rebase scripts",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20986",
    "user": "https://github.com/embray"
}
```
The scripts sage-rebase(all).{sh,bat} are used when developing/building Sage on Windows.

In the long term I'd like to find a way to reduce the need for them, but even then they're still good to have.  It is useful to run these every now and then to ensure that all DLLs in the Sage distribution are configured to load into non-overlapping address ranges by default.  First and foremost this is a performance issue, but also not rebasing can cause failures with Cygwin's fork.

To summarize what this ticket changes:

* In the wrapper batch scripts, it's no longer necessary to manually adjust `CYGWIN_ROOT` and `SAGE_ROOT`.  In fact, `SAGE_ROOT` is not needed by these scripts so much as `SAGE_LOCAL`, the path to which is automatically detected from the location of the script.  `CYGWIN_ROOT` is determined from the registry.  This *may* be incorrect if there are multiple Cygwin installations on the system, but this is unlikely in most cases.  Furthermore, with the changes I'm making for #15423 there will be less need to use the batch script in the first place (I have rarely had to use them in a long time now).
* In the sage-rebase.sh and sage-rebaseall.sh scripts:
  * Now the implementation is all just in `sage-rebase.sh`, which has grown an `--all` flag for performing rebaseall.  So `sage-rebaseall.sh` is just a wrapper around `sage-rebase.sh --all`.  This reduces a lot of code duplication.
  * The script excludes anything under `/var/tmp` so that build artifacts don't take up space in the address space layout.
  * The script *does* now include `.fas` modules for ECL, which were previously not included in the rebase.
  * It is possible to pass the path to `$SAGE_LOCAL` to the scripts as an argument, so it's not necessary for `$SAGE_LOCAL` to be set before running them (useful sometimes during development).
  * It is possible to pass arbitrary additional flags to the underlying `rebase`/`rebaseall` commands.

This is just a small collection of enhancements to these scripts.  Most importantly, this adds support for rebase `.fas` binaries that are part of ECL.  Not doing this potentially caused problems for Maxima (so I'm marking this as a defect).

Assignee: @embray

CC:  jpflori

Keywords: cygwin windows

Branch/Commit: [df53e2fe24baf5733739e9ccd6c3de44f992442d](https://github.com/sagemath/sagetrac-mirror/commit/df53e2fe24baf5733739e9ccd6c3de44f992442d)

Reviewer: Jean-Pierre Flori

Author: Erik Bray

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/20986





---

archive/issue_comments_386386.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-07-08T13:23:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20986#issuecomment-386386",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_386387.json:
```json
{
    "body": "<a id='comment:2'></a>\nIt's also \"good\" to be reminded every now and then how awful DOS batch scripts are and how lucky we are to have bash...",
    "created_at": "2016-07-08T13:23:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20986#issuecomment-386387",
    "user": "https://github.com/embray"
}
```

<a id='comment:2'></a>
It's also "good" to be reminded every now and then how awful DOS batch scripts are and how lucky we are to have bash...



---

archive/issue_comments_386388.json:
```json
{
    "body": "<a id='comment:3'></a>\nI've made several more updates to these scripts that should be incorporated into this ticket.",
    "created_at": "2017-01-13T14:21:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20986#issuecomment-386388",
    "user": "https://github.com/embray"
}
```

<a id='comment:3'></a>
I've made several more updates to these scripts that should be incorporated into this ticket.



---

archive/issue_comments_386389.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-01-13T14:21:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20986#issuecomment-386389",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_386390.json:
```json
{
    "body": "Set assignee to @embray.",
    "created_at": "2017-04-13T10:06:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20986#issuecomment-386390",
    "user": "https://github.com/embray"
}
```

Set assignee to @embray.



---

archive/issue_events_063825.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2017-04-13T10:06:40Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20986",
    "milestone": "sage-8.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20986#event-63825"
}
```



---

archive/issue_comments_386391.json:
```json
{
    "body": "<a id='comment:6'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                                                                     |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------|\n|[fcccd28](https://github.com/sagemath/sagetrac-mirror/commit/fcccd289a3986725bcda00c1390208786d782bc0)|`Include ECL .fas binaries (which are DLLs) when calling rebase(all)`|\n|[6d5ad32](https://github.com/sagemath/sagetrac-mirror/commit/6d5ad32aa94c6292bb759b07d0c0026a02545b9f)|`These scripts don't necessarily need to know where SAGE_ROOT is, just SAGE_LOCAL`|\n|[b5daf80](https://github.com/sagemath/sagetrac-mirror/commit/b5daf807f74fe7f5415441f2fa9c92c6229b3a05)|`Update these batch scripts so that it's not necessary to manually specify the paths of SAGE_LOCAL or CYGWIN_ROOT`|\n|[23a5a04](https://github.com/sagemath/sagetrac-mirror/commit/23a5a04d3f477738a2da86e3e5b21f529e483f10)|`Accept the path to SAGE_LOCAL as an argument (this is useful for running outside the Sage shell).`|\n|[e2f0b40](https://github.com/sagemath/sagetrac-mirror/commit/e2f0b401f9708fa80a91a908048576bad7cbe8b6)|`Enhance sage-rebase.sh to be able to pass additional arguments to rebase, and to wrap the call to rebaseall`|",
    "created_at": "2017-05-05T09:23:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20986#issuecomment-386391",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                                                                     |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------|
|[fcccd28](https://github.com/sagemath/sagetrac-mirror/commit/fcccd289a3986725bcda00c1390208786d782bc0)|`Include ECL .fas binaries (which are DLLs) when calling rebase(all)`|
|[6d5ad32](https://github.com/sagemath/sagetrac-mirror/commit/6d5ad32aa94c6292bb759b07d0c0026a02545b9f)|`These scripts don't necessarily need to know where SAGE_ROOT is, just SAGE_LOCAL`|
|[b5daf80](https://github.com/sagemath/sagetrac-mirror/commit/b5daf807f74fe7f5415441f2fa9c92c6229b3a05)|`Update these batch scripts so that it's not necessary to manually specify the paths of SAGE_LOCAL or CYGWIN_ROOT`|
|[23a5a04](https://github.com/sagemath/sagetrac-mirror/commit/23a5a04d3f477738a2da86e3e5b21f529e483f10)|`Accept the path to SAGE_LOCAL as an argument (this is useful for running outside the Sage shell).`|
|[e2f0b40](https://github.com/sagemath/sagetrac-mirror/commit/e2f0b401f9708fa80a91a908048576bad7cbe8b6)|`Enhance sage-rebase.sh to be able to pass additional arguments to rebase, and to wrap the call to rebaseall`|



---

archive/issue_comments_386392.json:
```json
{
    "body": "Changing commit from \"c4c0baea711bd77b4f04353e99d55d84b2bd0c15\" to \"e2f0b401f9708fa80a91a908048576bad7cbe8b6\"",
    "created_at": "2017-05-05T09:23:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20986#issuecomment-386392",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "c4c0baea711bd77b4f04353e99d55d84b2bd0c15" to "e2f0b401f9708fa80a91a908048576bad7cbe8b6"



---

archive/issue_comments_386393.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-05-05T09:32:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20986#issuecomment-386393",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_386394.json:
```json
{
    "body": "<a id='comment:7'></a>\nI think I've done all I need with these for now.",
    "created_at": "2017-05-05T09:32:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20986#issuecomment-386394",
    "user": "https://github.com/embray"
}
```

<a id='comment:7'></a>
I think I've done all I need with these for now.



---

archive/issue_comments_386395.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,4 +2,14 @@\n \n In the long term I'd like to find a way to reduce the need for them, but even then they're still good to have.  It is useful to run these every now and then to ensure that all DLLs in the Sage distribution are configured to load into non-overlapping address ranges by default.  First and foremost this is a performance issue, but also not rebasing can cause failures with Cygwin's fork.\n \n+To summarize what this ticket changes:\n+\n+* In the wrapper batch scripts, it's no longer necessary to manually adjust `CYGWIN_ROOT` and `SAGE_ROOT`.  In fact, `SAGE_ROOT` is not needed by these scripts so much as `SAGE_LOCAL`, the path to which is automatically detected from the location of the script.  `CYGWIN_ROOT` is determined from the registry.  This *may* be incorrect if there are multiple Cygwin installations on the system, but this is unlikely in most cases.  Furthermore, with the changes I'm making for #15423 there will be less need to use the batch script in the first place (I have rarely had to use them in a long time now).\n+* In the sage-rebase.sh and sage-rebaseall.sh scripts:\n+  * Now the implementation is all just in `sage-rebase.sh`, which has grown an `--all` flag for performing rebaseall.  So `sage-rebaseall.sh` is just a wrapper around `sage-rebase.sh --all`.  This reduces a lot of code duplication.\n+  * The script excludes anything under `/var/tmp` so that build artifacts don't take up space in the address space layout.\n+  * The script *does* now include `.fas` modules for ECL, which were previously not included in the rebase.\n+  * It is possible to pass the path to `$SAGE_LOCAL` to the scripts as an argument, so it's not necessary for `$SAGE_LOCAL` to be set before running them (useful sometimes during development).\n+  * It is possible to pass arbitrary additional flags to the underlying `rebase`/`rebaseall` commands.\n+\n This is just a small collection of enhancements to these scripts.  Most importantly, this adds support for rebase `.fas` binaries that are part of ECL.  Not doing this potentially caused problems for Maxima (so I'm marking this as a defect).\n``````\n",
    "created_at": "2017-05-05T09:32:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20986#issuecomment-386395",
    "user": "https://github.com/embray"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,4 +2,14 @@
 
 In the long term I'd like to find a way to reduce the need for them, but even then they're still good to have.  It is useful to run these every now and then to ensure that all DLLs in the Sage distribution are configured to load into non-overlapping address ranges by default.  First and foremost this is a performance issue, but also not rebasing can cause failures with Cygwin's fork.
 
+To summarize what this ticket changes:
+
+* In the wrapper batch scripts, it's no longer necessary to manually adjust `CYGWIN_ROOT` and `SAGE_ROOT`.  In fact, `SAGE_ROOT` is not needed by these scripts so much as `SAGE_LOCAL`, the path to which is automatically detected from the location of the script.  `CYGWIN_ROOT` is determined from the registry.  This *may* be incorrect if there are multiple Cygwin installations on the system, but this is unlikely in most cases.  Furthermore, with the changes I'm making for #15423 there will be less need to use the batch script in the first place (I have rarely had to use them in a long time now).
+* In the sage-rebase.sh and sage-rebaseall.sh scripts:
+  * Now the implementation is all just in `sage-rebase.sh`, which has grown an `--all` flag for performing rebaseall.  So `sage-rebaseall.sh` is just a wrapper around `sage-rebase.sh --all`.  This reduces a lot of code duplication.
+  * The script excludes anything under `/var/tmp` so that build artifacts don't take up space in the address space layout.
+  * The script *does* now include `.fas` modules for ECL, which were previously not included in the rebase.
+  * It is possible to pass the path to `$SAGE_LOCAL` to the scripts as an argument, so it's not necessary for `$SAGE_LOCAL` to be set before running them (useful sometimes during development).
+  * It is possible to pass arbitrary additional flags to the underlying `rebase`/`rebaseall` commands.
+
 This is just a small collection of enhancements to these scripts.  Most importantly, this adds support for rebase `.fas` binaries that are part of ECL.  Not doing this potentially caused problems for Maxima (so I'm marking this as a defect).
``````




---

archive/issue_comments_386396.json:
```json
{
    "body": "<a id='comment:8'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                         |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------|\n|[df53e2f](https://github.com/sagemath/sagetrac-mirror/commit/df53e2fe24baf5733739e9ccd6c3de44f992442d)|`This should be passing the --all flag to sage-rebase.sh`|",
    "created_at": "2017-05-05T09:37:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20986#issuecomment-386396",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                         |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------|
|[df53e2f](https://github.com/sagemath/sagetrac-mirror/commit/df53e2fe24baf5733739e9ccd6c3de44f992442d)|`This should be passing the --all flag to sage-rebase.sh`|



---

archive/issue_comments_386397.json:
```json
{
    "body": "Changing commit from \"e2f0b401f9708fa80a91a908048576bad7cbe8b6\" to \"df53e2fe24baf5733739e9ccd6c3de44f992442d\"",
    "created_at": "2017-05-05T09:37:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20986#issuecomment-386397",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "e2f0b401f9708fa80a91a908048576bad7cbe8b6" to "df53e2fe24baf5733739e9ccd6c3de44f992442d"



---

archive/issue_comments_386398.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jean-Pierre Flori\"",
    "created_at": "2017-05-17T09:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20986#issuecomment-386398",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing reviewer from "" to "Jean-Pierre Flori"



---

archive/issue_comments_386399.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-05-17T09:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20986#issuecomment-386399",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_386400.json:
```json
{
    "body": "<a id='comment:9'></a>\nLGTM.",
    "created_at": "2017-05-17T09:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20986#issuecomment-386400",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:9'></a>
LGTM.



---

archive/issue_comments_386401.json:
```json
{
    "body": "<a id='comment:10'></a>\nThanks!",
    "created_at": "2017-05-18T08:42:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20986#issuecomment-386401",
    "user": "https://github.com/embray"
}
```

<a id='comment:10'></a>
Thanks!



---

archive/issue_comments_386402.json:
```json
{
    "body": "Changing branch from \"u/embray/cygwin-rebase-fas\" to \"df53e2fe24baf5733739e9ccd6c3de44f992442d\"",
    "created_at": "2017-05-19T22:10:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20986#issuecomment-386402",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/embray/cygwin-rebase-fas" to "df53e2fe24baf5733739e9ccd6c3de44f992442d"



---

archive/issue_comments_386403.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-05-19T22:10:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20986",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20986#issuecomment-386403",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_063826.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-05-19T22:10:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20986",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20986#event-63826"
}
```
