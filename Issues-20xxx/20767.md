# Issue 20767: Move coercion to Element

archive/issues_020530.json:
```json
{
    "body": "This ticket has 2 main changes:\n\n1. Move all coercion logic from `RingElement`, `ModuleElement` and the like to `Element`.\n\nBecause of this, it matters a lot less whether a class inherits from `Element` or from `ModuleElement`/`RingElement`/`FieldElement`...\n\nOne difference remains: the more specialized classes have some default implementations for arithmetic. For example, `ModuleElement` implements unary negation as multiplication by -1. The base class `Element` has no such default implementations.\n\nThis patch also affects lookup in categories: with this patch, double-underscore methods like `__add__` are never taken from the category. The `Element` classes take precedence over the category, so the default implementations of arithmetic operations will override whatever is in the category (this is existing behaviour, not affected by this patch). For the base class `Element`, this is not an issue since there are no default implementations.\n\n2. Change the implementation of double-underscore methods like `__add__` to return `NotImplemented` (rather than raise an error) if one argument is not a Sage `Element` and coercion fails.\n\nThis will cause Python to try the reversed operation (`__radd__` or `__add__` in Cython). This way, Sage has improved support for operations with non-Sage types.\n\nCC:  @nthiery @videlec simonking\n\nBranch/Commit: 25c9d7d6effbc50e9aeb0d7e8a7e18d92da30aa2\n\nReviewer: Nicolas M. Thi\u00e9ry\n\nAuthor: Jeroen Demeyer\n\nDependencies: #21126, #20686, #21139, #21140, #21152, #21153, #21154, #21441\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20767\n\n",
    "closed_at": "2016-10-03T22:41:54Z",
    "created_at": "2016-06-03T09:30:32Z",
    "labels": [
        "component: coercion"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "Move coercion to Element",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20767",
    "user": "https://github.com/jdemeyer"
}
```
This ticket has 2 main changes:

1. Move all coercion logic from `RingElement`, `ModuleElement` and the like to `Element`.

Because of this, it matters a lot less whether a class inherits from `Element` or from `ModuleElement`/`RingElement`/`FieldElement`...

One difference remains: the more specialized classes have some default implementations for arithmetic. For example, `ModuleElement` implements unary negation as multiplication by -1. The base class `Element` has no such default implementations.

This patch also affects lookup in categories: with this patch, double-underscore methods like `__add__` are never taken from the category. The `Element` classes take precedence over the category, so the default implementations of arithmetic operations will override whatever is in the category (this is existing behaviour, not affected by this patch). For the base class `Element`, this is not an issue since there are no default implementations.

2. Change the implementation of double-underscore methods like `__add__` to return `NotImplemented` (rather than raise an error) if one argument is not a Sage `Element` and coercion fails.

This will cause Python to try the reversed operation (`__radd__` or `__add__` in Cython). This way, Sage has improved support for operations with non-Sage types.

CC:  @nthiery @videlec simonking

Branch/Commit: 25c9d7d6effbc50e9aeb0d7e8a7e18d92da30aa2

Reviewer: Nicolas M. Thi√©ry

Author: Jeroen Demeyer

Dependencies: #21126, #20686, #21139, #21140, #21152, #21153, #21154, #21441

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/20767





---

archive/issue_comments_301650.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-Move all coercion logic from `RingElement`, `ModuleElement` and the like down to `Element`.\n+Move all coercion logic from `RingElement`, `ModuleElement` and the like to `Element`.\n \n Dependencies: #269, #20740, #20753, #20761, #20757\n \n```\n",
    "created_at": "2016-06-03T14:07:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301650",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,4 @@
-Move all coercion logic from `RingElement`, `ModuleElement` and the like down to `Element`.
+Move all coercion logic from `RingElement`, `ModuleElement` and the like to `Element`.
 
 Dependencies: #269, #20740, #20753, #20761, #20757
 
```




---

archive/issue_comments_301651.json:
```json
{
    "body": "<a id='comment:6'></a>New commits:",
    "created_at": "2016-07-26T09:38:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301651",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>New commits:



---

archive/issue_comments_301652.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-07-26T13:37:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301652",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_301653.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-07-26T15:07:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301653",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_301654.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-07-27T15:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301654",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_301655.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-07-29T13:27:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301655",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_301656.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-07-29T13:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301656",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_301657.json:
```json
{
    "body": "<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-08-01T09:30:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301657",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:15'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_301658.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-08-01T15:51:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301658",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_301659.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-08-01T17:37:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301659",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_301660.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-08-01T21:23:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301660",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_301661.json:
```json
{
    "body": "<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-08-01T21:35:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301661",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_301662.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-08-02T14:39:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301662",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_301663.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-08-02T15:38:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301663",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_301664.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-08-02T21:41:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301664",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_301665.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-08-03T10:52:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301665",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_301666.json:
```json
{
    "body": "<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-08-03T13:57:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301666",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:27'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_301667.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-08-03T13:59:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301667",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_301668.json:
```json
{
    "body": "<a id='comment:29'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-08-03T14:02:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301668",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:29'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_301669.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,10 @@\n+Move all coercion logic from `RingElement`, `ModuleElement` and the like to `Element`.\n \n+The main consequence is that it matters a lot less whether a class inherits from `Element` or from `ModuleElement`/`RingElement`/`FieldElement`...\n+\n+One difference remains: the more specialized classes have some default implementations for arithmetic. For example, `ModuleElement` implements unary negation as multiplication by -1. The base class `Element` has no default implementations.\n+\n+This patch also affects lookup in categories: with this patch, double-underscore methods like `__add__` are never taken from the category. The `Element` classes take precedence over the category, so the default implementations of certain arithmetic operations will override whatever is in the category. For the base class `Element`, this is not an issue since there are no default implementations.\n \n Dependencies: #269, #20740, #20753, #20761, #20757\n \n```\n",
    "created_at": "2016-08-03T14:32:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301669",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,10 @@
+Move all coercion logic from `RingElement`, `ModuleElement` and the like to `Element`.
 
+The main consequence is that it matters a lot less whether a class inherits from `Element` or from `ModuleElement`/`RingElement`/`FieldElement`...
+
+One difference remains: the more specialized classes have some default implementations for arithmetic. For example, `ModuleElement` implements unary negation as multiplication by -1. The base class `Element` has no default implementations.
+
+This patch also affects lookup in categories: with this patch, double-underscore methods like `__add__` are never taken from the category. The `Element` classes take precedence over the category, so the default implementations of certain arithmetic operations will override whatever is in the category. For the base class `Element`, this is not an issue since there are no default implementations.
 
 Dependencies: #269, #20740, #20753, #20761, #20757
 
```




---

archive/issue_comments_301670.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,10 @@\n+Move all coercion logic from `RingElement`, `ModuleElement` and the like to `Element`.\n \n+The main consequence is that it matters a lot less whether a class inherits from `Element` or from `ModuleElement`/`RingElement`/`FieldElement`...\n+\n+One difference remains: the more specialized classes have some default implementations for arithmetic. For example, `ModuleElement` implements unary negation as multiplication by -1. The base class `Element` has no such default implementations.\n+\n+This patch also affects lookup in categories: with this patch, double-underscore methods like `__add__` are never taken from the category. The `Element` classes take precedence over the category, so the default implementations of arithmetic operations will override whatever is in the category (this is existing behaviour, not affected by this patch). For the base class `Element`, this is not an issue since there are no default implementations.\n \n Dependencies: #269, #20740, #20753, #20761, #20757\n \n```\n",
    "created_at": "2016-08-03T14:34:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301670",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,10 @@
+Move all coercion logic from `RingElement`, `ModuleElement` and the like to `Element`.
 
+The main consequence is that it matters a lot less whether a class inherits from `Element` or from `ModuleElement`/`RingElement`/`FieldElement`...
+
+One difference remains: the more specialized classes have some default implementations for arithmetic. For example, `ModuleElement` implements unary negation as multiplication by -1. The base class `Element` has no such default implementations.
+
+This patch also affects lookup in categories: with this patch, double-underscore methods like `__add__` are never taken from the category. The `Element` classes take precedence over the category, so the default implementations of arithmetic operations will override whatever is in the category (this is existing behaviour, not affected by this patch). For the base class `Element`, this is not an issue since there are no default implementations.
 
 Dependencies: #269, #20740, #20753, #20761, #20757
 
```




---

archive/issue_comments_301671.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,10 @@\n+Move all coercion logic from `RingElement`, `ModuleElement` and the like to `Element`.\n \n+The main consequence is that it matters a lot less whether a class inherits from `Element` or from `ModuleElement`/`RingElement`/`FieldElement`...\n+\n+One difference between `Element` and more specialized classes like `RingElement` remains: the more specialized classes have some default implementations for arithmetic. For example, `ModuleElement` implements unary negation as multiplication by -1. The base class `Element` has no such default implementations.\n+\n+This patch also affects lookup in categories: with this patch, double-underscore methods like `__add__` are never taken from the category. The `Element` classes take precedence over the category, so the default implementations of arithmetic operations will override whatever is in the category (this is existing behaviour, not affected by this patch). For the base class `Element`, this is not an issue since there are no default implementations.\n \n Dependencies: #269, #20740, #20753, #20761, #20757\n \n```\n",
    "created_at": "2016-08-04T06:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301671",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,10 @@
+Move all coercion logic from `RingElement`, `ModuleElement` and the like to `Element`.
 
+The main consequence is that it matters a lot less whether a class inherits from `Element` or from `ModuleElement`/`RingElement`/`FieldElement`...
+
+One difference between `Element` and more specialized classes like `RingElement` remains: the more specialized classes have some default implementations for arithmetic. For example, `ModuleElement` implements unary negation as multiplication by -1. The base class `Element` has no such default implementations.
+
+This patch also affects lookup in categories: with this patch, double-underscore methods like `__add__` are never taken from the category. The `Element` classes take precedence over the category, so the default implementations of arithmetic operations will override whatever is in the category (this is existing behaviour, not affected by this patch). For the base class `Element`, this is not an issue since there are no default implementations.
 
 Dependencies: #269, #20740, #20753, #20761, #20757
 
```




---

archive/issue_comments_301672.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,16 @@\n+This ticket has 2 main changes:\n \n+1. Move all coercion logic from `RingElement`, `ModuleElement` and the like to `Element`.\n+\n+Because of this, it matters a lot less whether a class inherits from `Element` or from `ModuleElement`/`RingElement`/`FieldElement`...\n+\n+One difference remains: the more specialized classes have some default implementations for arithmetic. For example, `ModuleElement` implements unary negation as multiplication by -1. The base class `Element` has no such default implementations.\n+\n+This patch also affects lookup in categories: with this patch, double-underscore methods like `__add__` are never taken from the category. The `Element` classes take precedence over the category, so the default implementations of arithmetic operations will override whatever is in the category (this is existing behaviour, not affected by this patch). For the base class `Element`, this is not an issue since there are no default implementations.\n+\n+2. Change the implementation of double-underscore methods like `__add__` to return `NotImplemented` if one argument is not a Sage `Element` and coercion fails.\n+\n+This will cause Python to try the reversed operation (`__radd__` or `__add__` in Cython). This way, Sage has improved support for operations with non-Sage types.\n \n Dependencies: #269, #20740, #20753, #20761, #20757\n \n```\n",
    "created_at": "2016-08-04T06:55:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301672",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,16 @@
+This ticket has 2 main changes:
 
+1. Move all coercion logic from `RingElement`, `ModuleElement` and the like to `Element`.
+
+Because of this, it matters a lot less whether a class inherits from `Element` or from `ModuleElement`/`RingElement`/`FieldElement`...
+
+One difference remains: the more specialized classes have some default implementations for arithmetic. For example, `ModuleElement` implements unary negation as multiplication by -1. The base class `Element` has no such default implementations.
+
+This patch also affects lookup in categories: with this patch, double-underscore methods like `__add__` are never taken from the category. The `Element` classes take precedence over the category, so the default implementations of arithmetic operations will override whatever is in the category (this is existing behaviour, not affected by this patch). For the base class `Element`, this is not an issue since there are no default implementations.
+
+2. Change the implementation of double-underscore methods like `__add__` to return `NotImplemented` if one argument is not a Sage `Element` and coercion fails.
+
+This will cause Python to try the reversed operation (`__radd__` or `__add__` in Cython). This way, Sage has improved support for operations with non-Sage types.
 
 Dependencies: #269, #20740, #20753, #20761, #20757
 
```




---

archive/issue_comments_301673.json:
```json
{
    "body": "<a id='comment:35'></a>It would be interesting (to me) to see whether the coerce action business of #18756 can be used here as well.",
    "created_at": "2016-08-05T19:52:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301673",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:35'></a>It would be interesting (to me) to see whether the coerce action business of #18756 can be used here as well.



---

archive/issue_comments_301674.json:
```json
{
    "body": "<a id='comment:36'></a>... and of #18758",
    "created_at": "2016-08-05T19:55:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301674",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:36'></a>... and of #18758



---

archive/issue_comments_301675.json:
```json
{
    "body": "<a id='comment:37'></a>Well, this ticket deals with the \"other side\" of the coercion framework: it changes how the coercion model is called, not how the coercion model implements arithmetic. It seems like the other tickets do the opposite. So the tickets look related but also quite independent.",
    "created_at": "2016-08-05T20:20:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301675",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:37'></a>Well, this ticket deals with the "other side" of the coercion framework: it changes how the coercion model is called, not how the coercion model implements arithmetic. It seems like the other tickets do the opposite. So the tickets look related but also quite independent.



---

archive/issue_comments_301676.json:
```json
{
    "body": "<a id='comment:38'></a>Hi\n\nJust as a reminder: There are situation where we need ring element operations in a parent resp. for an element which is not really considered a ring element.\n\nExample:\n- Take a graded ring.\n- Take two elements from different weight-components.\n- Note that the elements by themself are considered elements of vector spaces\n  (which is what we want because we probably want to do operations that only make sense for the vector space, etc).\n- However we still want to be able to \"add\" _and_ \"multiply\" such elements.\n  - Add would result in a ring element (unless the components are the same).\n  - Multiply would result in a vector in a higher weight-component.\n\nI had to deal with this when I implemented the graded rings of modular forms.\nSee src/sage/modular/modform_hecketriangle/element.py for more details.\nThere I solved it as follows:\nI derived the element from FormsRingElement (so it has the multiply methods) but the parent is still just a vector space. I also made sure that arithmetic operations with elements end up in the correct space.\n\nWill this still work with this ticket?\nCan you check the tests for this maybe?\n\nSide note: At the moment I don't really have time to actively develop, so I can't really promise much help.\n\n\nBest\nJonas",
    "created_at": "2016-08-06T11:25:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301676",
    "user": "https://github.com/jjermann"
}
```

<a id='comment:38'></a>Hi

Just as a reminder: There are situation where we need ring element operations in a parent resp. for an element which is not really considered a ring element.

Example:
- Take a graded ring.
- Take two elements from different weight-components.
- Note that the elements by themself are considered elements of vector spaces
  (which is what we want because we probably want to do operations that only make sense for the vector space, etc).
- However we still want to be able to "add" _and_ "multiply" such elements.
  - Add would result in a ring element (unless the components are the same).
  - Multiply would result in a vector in a higher weight-component.

I had to deal with this when I implemented the graded rings of modular forms.
See src/sage/modular/modform_hecketriangle/element.py for more details.
There I solved it as follows:
I derived the element from FormsRingElement (so it has the multiply methods) but the parent is still just a vector space. I also made sure that arithmetic operations with elements end up in the correct space.

Will this still work with this ticket?
Can you check the tests for this maybe?

Side note: At the moment I don't really have time to actively develop, so I can't really promise much help.


Best
Jonas



---

archive/issue_comments_301677.json:
```json
{
    "body": "<a id='comment:39'></a>This ticket should not cause many functional differences for existing code, except for the fact that double-underscore methods can no longer be implemented in categories and some other minor things, like using `parent.one()` instead of `1`.\n\nAll doctests in Sage pass with this ticket (see for example the patchbot), so the code that you refer to should still work too.",
    "created_at": "2016-08-06T12:15:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301677",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:39'></a>This ticket should not cause many functional differences for existing code, except for the fact that double-underscore methods can no longer be implemented in categories and some other minor things, like using `parent.one()` instead of `1`.

All doctests in Sage pass with this ticket (see for example the patchbot), so the code that you refer to should still work too.



---

archive/issue_events_055772.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-08-29T05:38:10Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "milestone": "sage-7.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20767#event-55772"
}
```



---

archive/issue_comments_301678.json:
```json
{
    "body": "<a id='comment:40'></a>Doctest failures with 7.4.beta2.",
    "created_at": "2016-08-29T05:38:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301678",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:40'></a>Doctest failures with 7.4.beta2.



---

archive/issue_comments_301679.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-08-29T05:38:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301679",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_301680.json:
```json
{
    "body": "<a id='comment:41'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-30T10:31:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301680",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:41'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_301681.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-08-30T10:32:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301681",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_301682.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,16 @@\n+This ticket has 2 main changes:\n \n+1. Move all coercion logic from `RingElement`, `ModuleElement` and the like to `Element`.\n+\n+Because of this, it matters a lot less whether a class inherits from `Element` or from `ModuleElement`/`RingElement`/`FieldElement`...\n+\n+One difference remains: the more specialized classes have some default implementations for arithmetic. For example, `ModuleElement` implements unary negation as multiplication by -1. The base class `Element` has no such default implementations.\n+\n+This patch also affects lookup in categories: with this patch, double-underscore methods like `__add__` are never taken from the category. The `Element` classes take precedence over the category, so the default implementations of arithmetic operations will override whatever is in the category (this is existing behaviour, not affected by this patch). For the base class `Element`, this is not an issue since there are no default implementations.\n+\n+2. Change the implementation of double-underscore methods like `__add__` to return `NotImplemented` (rather than raise an error) if one argument is not a Sage `Element` and coercion fails.\n+\n+This will cause Python to try the reversed operation (`__radd__` or `__add__` in Cython). This way, Sage has improved support for operations with non-Sage types.\n \n Dependencies: #269, #20740, #20753, #20761, #20757\n \n```\n",
    "created_at": "2016-09-06T07:51:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301682",
    "user": "https://github.com/nthiery"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,16 @@
+This ticket has 2 main changes:
 
+1. Move all coercion logic from `RingElement`, `ModuleElement` and the like to `Element`.
+
+Because of this, it matters a lot less whether a class inherits from `Element` or from `ModuleElement`/`RingElement`/`FieldElement`...
+
+One difference remains: the more specialized classes have some default implementations for arithmetic. For example, `ModuleElement` implements unary negation as multiplication by -1. The base class `Element` has no such default implementations.
+
+This patch also affects lookup in categories: with this patch, double-underscore methods like `__add__` are never taken from the category. The `Element` classes take precedence over the category, so the default implementations of arithmetic operations will override whatever is in the category (this is existing behaviour, not affected by this patch). For the base class `Element`, this is not an issue since there are no default implementations.
+
+2. Change the implementation of double-underscore methods like `__add__` to return `NotImplemented` (rather than raise an error) if one argument is not a Sage `Element` and coercion fails.
+
+This will cause Python to try the reversed operation (`__radd__` or `__add__` in Cython). This way, Sage has improved support for operations with non-Sage types.
 
 Dependencies: #269, #20740, #20753, #20761, #20757
 
```




---

archive/issue_comments_301683.json:
```json
{
    "body": "<a id='comment:46'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-07T12:00:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301683",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:46'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_301684.json:
```json
{
    "body": "<a id='comment:47'></a>Nicolas, I took care of your comments. If you are missing something, feel free to notify me or to make the change yourself.",
    "created_at": "2016-09-07T12:10:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301684",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:47'></a>Nicolas, I took care of your comments. If you are missing something, feel free to notify me or to make the change yourself.



---

archive/issue_comments_301685.json:
```json
{
    "body": "<a id='comment:49'></a>I read your new documentation; that's a very nice addition to the Sage documentation. I have done some changes here and there, and added a draft of explanation of the `cdef _add_` trick. Please proofread. The `_add_long` and `_mul_long` protocols need to be documented and tested in element.pyx; see the TODO there.\n\nOther than this, I believe this is good to go. Thanks a lot Jeroen!\n\n---\nNew commits:",
    "created_at": "2016-09-07T16:20:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301685",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:49'></a>I read your new documentation; that's a very nice addition to the Sage documentation. I have done some changes here and there, and added a draft of explanation of the `cdef _add_` trick. Please proofread. The `_add_long` and `_mul_long` protocols need to be documented and tested in element.pyx; see the TODO there.

Other than this, I believe this is good to go. Thanks a lot Jeroen!

---
New commits:



---

archive/issue_comments_301686.json:
```json
{
    "body": "<a id='comment:51'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-08T09:55:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301686",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:51'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_301687.json:
```json
{
    "body": "<a id='comment:52'></a>Done, needs review.",
    "created_at": "2016-09-08T09:55:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301687",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:52'></a>Done, needs review.



---

archive/issue_comments_301688.json:
```json
{
    "body": "<a id='comment:53'></a>Thanks; I checked your commits and am happy with them.\n\nTwo small questions:\n- The documentation currently seems to suggest that it's only possible to implement `_add_long` and `_mul_long` within a Cython class. Is that right? Of course, in a Python class it's probably rarely relevant to implement `_add_long`, but if this works there is no reason to hide it in the doc.\n\n- ``Concrete implementations (of `_add_`) in subclasses should be ``cpdef`` or ``def`` methods``: do we need to be specific? cdef would actually work too, right? Or is it because with cdef, a Python level call to `x._add_(y)` would fail?\n\nOnce you have made up your mind on the above, you can set a positive review on my behalf (assuming of course all tests keep passing).\n\nThanks!\n\nCheers,\n                       Nicolas",
    "created_at": "2016-09-08T14:12:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301688",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:53'></a>Thanks; I checked your commits and am happy with them.

Two small questions:
- The documentation currently seems to suggest that it's only possible to implement `_add_long` and `_mul_long` within a Cython class. Is that right? Of course, in a Python class it's probably rarely relevant to implement `_add_long`, but if this works there is no reason to hide it in the doc.

- ``Concrete implementations (of `_add_`) in subclasses should be ``cpdef`` or ``def`` methods``: do we need to be specific? cdef would actually work too, right? Or is it because with cdef, a Python level call to `x._add_(y)` would fail?

Once you have made up your mind on the above, you can set a positive review on my behalf (assuming of course all tests keep passing).

Thanks!

Cheers,
                       Nicolas



---

archive/issue_comments_301689.json:
```json
{
    "body": "<a id='comment:54'></a>Replying to [comment:53 nthiery]:\n> - The documentation currently seems to suggest that it's only possible to implement `_add_long` and `_mul_long` within a Cython class. Is that right?\n\n\nYes, it's a `cdef` method, so it's Cython-only. Since it is only an optimization, it makes little sense to allow it to be a Python method. If you care about performance, you should be using Cython anyway.\n\n> - ``Concrete implementations (of `_add_`) in subclasses should be ``cpdef`` or ``def`` methods``: do we need to be specific? cdef would actually work too, right?\n> Or is it because with cdef, a Python level call to `x._add_(y)` would fail?\n\n\nIt would work for `x + y` yes. But I think it is expected that `x._add_(y)` also works. Anyway, that is how things were historically.\n\nMaybe one could argue that `x._add_(y)` should not be required to work from Python. But let's not change that in this ticket.",
    "created_at": "2016-09-08T14:21:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301689",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:54'></a>Replying to [comment:53 nthiery]:
> - The documentation currently seems to suggest that it's only possible to implement `_add_long` and `_mul_long` within a Cython class. Is that right?


Yes, it's a `cdef` method, so it's Cython-only. Since it is only an optimization, it makes little sense to allow it to be a Python method. If you care about performance, you should be using Cython anyway.

> - ``Concrete implementations (of `_add_`) in subclasses should be ``cpdef`` or ``def`` methods``: do we need to be specific? cdef would actually work too, right?
> Or is it because with cdef, a Python level call to `x._add_(y)` would fail?


It would work for `x + y` yes. But I think it is expected that `x._add_(y)` also works. Anyway, that is how things were historically.

Maybe one could argue that `x._add_(y)` should not be required to work from Python. But let's not change that in this ticket.



---

archive/issue_comments_301690.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-09-08T14:21:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301690",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_301691.json:
```json
{
    "body": "<a id='comment:55'></a>This ticket is suffering also from #21441 (see patchbot)",
    "created_at": "2016-09-09T07:28:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301691",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:55'></a>This ticket is suffering also from #21441 (see patchbot)



---

archive/issue_comments_301692.json:
```json
{
    "body": "<a id='comment:56'></a>Replying to [comment:53 nthiery]:\n> - Concrete implementations (of `_add_`) in subclasses should be ``cpdef`` or ``def`` methods``: do we need to be specific? cdef would actually work too, right? Or is it because with cdef, a Python level call to `x._add_(y)` would fail?\n\n\nA more complete answer: yes, they really should be `cpdef` or `def` methods because you want to allow Python subclasses to override them. A `cdef` method is Cython-only and cannot be overridden by a Python method. Of course, `Element._add_` is `cdef` but it \"manually\" checks for a Python `_add_` method.",
    "created_at": "2016-09-09T07:42:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301692",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:56'></a>Replying to [comment:53 nthiery]:
> - Concrete implementations (of `_add_`) in subclasses should be ``cpdef`` or ``def`` methods``: do we need to be specific? cdef would actually work too, right? Or is it because with cdef, a Python level call to `x._add_(y)` would fail?


A more complete answer: yes, they really should be `cpdef` or `def` methods because you want to allow Python subclasses to override them. A `cdef` method is Cython-only and cannot be overridden by a Python method. Of course, `Element._add_` is `cdef` but it "manually" checks for a Python `_add_` method.



---

archive/issue_comments_301693.json:
```json
{
    "body": "<a id='comment:57'></a>Ah, yes, That's a good point indeed. Thanks!",
    "created_at": "2016-09-09T07:47:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301693",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:57'></a>Ah, yes, That's a good point indeed. Thanks!



---

archive/issue_events_055773.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-10-03T22:41:54Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20767#event-55773"
}
```



---

archive/issue_comments_301694.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-10-03T22:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20767#issuecomment-301694",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
