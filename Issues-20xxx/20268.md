# Issue 20268: memory leak in Polynomial.__call__

archive/issues_020031.json:
```json
{
    "body": "The following cause a memory leak\n\n```\nsage: R = PolynomialRing(ZZ, 'x', implementation='NTL')\nsage: x = R.gen()\nsage: p = x**2 - 1\nsage: while True: a = p(1)\n```\n\nSee the following reports\n\n- [thread on cython-users](https://groups.google.com/forum/#!topic/cython-users/g10b0911qq0)\n- [thread on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/W0c5zCbgt0Q)\n\nWe backport the fix provided in [this commit](https://github.com/cython/cython/commit/1adf6cc73e65e0eefe2f426e3ff5b03f97044128).\n\nCC:  @nbruin @jdemeyer @vbraun\n\nReviewer: Vincent Delecroix\n\nBranch: u/vdelecroix/20268\n\nCommit: 4f15c250d5efa6e6d4a6e1cba1830cdf72519c34\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20268\n\n",
    "closed_at": "2016-05-11T20:09:41Z",
    "created_at": "2016-03-23T20:25:12Z",
    "labels": [
        "component: performance",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "memory leak in Polynomial.__call__",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20268",
    "user": "https://github.com/videlec"
}
```
The following cause a memory leak

```
sage: R = PolynomialRing(ZZ, 'x', implementation='NTL')
sage: x = R.gen()
sage: p = x**2 - 1
sage: while True: a = p(1)
```

See the following reports

- [thread on cython-users](https://groups.google.com/forum/#!topic/cython-users/g10b0911qq0)
- [thread on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/W0c5zCbgt0Q)

We backport the fix provided in [this commit](https://github.com/cython/cython/commit/1adf6cc73e65e0eefe2f426e3ff5b03f97044128).

CC:  @nbruin @jdemeyer @vbraun

Reviewer: Vincent Delecroix

Branch: u/vdelecroix/20268

Commit: 4f15c250d5efa6e6d4a6e1cba1830cdf72519c34

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/20268





---

archive/issue_comments_293649.json:
```json
{
    "body": "<a id='comment:1'></a>New commits:",
    "created_at": "2016-03-24T12:36:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20268#issuecomment-293649",
    "user": "https://github.com/videlec"
}
```

<a id='comment:1'></a>New commits:



---

archive/issue_comments_293650.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,7 +1,18 @@\n+The following cause a memory leak\n+\n+\\`\\`\\`\n+sage: R = PolynomialRing(ZZ, 'x', implementation='NTL')\n+sage: x = R.gen()\n+sage: p = x**2 - 1\n+sage: while True: a = p(1)\n+\\`\\`\\`\n+\n See the following reports\n \n - [thread on cython-users](https://groups.google.com/forum/#!topic/cython-users/g10b0911qq0)\n - [thread on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/W0c5zCbgt0Q)\n+\n+We backport the fix provided in [this commit](https://github.com/cython/cython/commit/1adf6cc73e65e0eefe2f426e3ff5b03f97044128).\n \n Comment: 1\n \n```\n",
    "created_at": "2016-03-24T12:36:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20268#issuecomment-293650",
    "user": "https://github.com/videlec"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,7 +1,18 @@
+The following cause a memory leak
+
+\`\`\`
+sage: R = PolynomialRing(ZZ, 'x', implementation='NTL')
+sage: x = R.gen()
+sage: p = x**2 - 1
+sage: while True: a = p(1)
+\`\`\`
+
 See the following reports
 
 - [thread on cython-users](https://groups.google.com/forum/#!topic/cython-users/g10b0911qq0)
 - [thread on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/W0c5zCbgt0Q)
+
+We backport the fix provided in [this commit](https://github.com/cython/cython/commit/1adf6cc73e65e0eefe2f426e3ff5b03f97044128).
 
 Comment: 1
 
```




---

archive/issue_comments_293651.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-03-24T12:36:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20268#issuecomment-293651",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_293652.json:
```json
{
    "body": "<a id='comment:2'></a>I propose to deal with this in #20192 instead.\n\nIn any case, if you want the fix to be applied, you need to increase the Cython version number.",
    "created_at": "2016-03-24T12:40:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20268#issuecomment-293652",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>I propose to deal with this in #20192 instead.

In any case, if you want the fix to be applied, you need to increase the Cython version number.



---

archive/issue_comments_293653.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-03-24T12:40:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20268#issuecomment-293653",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_293654.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-24T12:50:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20268#issuecomment-293654",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_293655.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-03-24T12:59:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20268#issuecomment-293655",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_293656.json:
```json
{
    "body": "<a id='comment:5'></a>Since the stable cython release is about to be delivered, I guess it would be better to use #20192...",
    "created_at": "2016-03-24T12:59:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20268#issuecomment-293656",
    "user": "https://github.com/videlec"
}
```

<a id='comment:5'></a>Since the stable cython release is about to be delivered, I guess it would be better to use #20192...



---

archive/issue_comments_293657.json:
```json
{
    "body": "<a id='comment:6'></a>Robert Bradshaw says that Cython 0.24 will be delivered \"Likely in the next week\"",
    "created_at": "2016-03-27T07:37:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20268#issuecomment-293657",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>Robert Bradshaw says that Cython 0.24 will be delivered "Likely in the next week"



---

archive/issue_comments_293658.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-03-28T02:04:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20268#issuecomment-293658",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_293659.json:
```json
{
    "body": "<a id='comment:7'></a>I would like to add a doctest for that. Do you think that the following is strong enough\n\n```\nsage: p = polygen(ZZ)\nsage: import resource \nsage: mem0 = resource.getrusage(resource.RUSAGE_SELF).ru_maxrss \nsage: for _ in range(10000):\n....:     t = Polynomial.__call__(p, 1)\nsage: assert resource.getrusage(resource.RUSAGE_SELF).ru_maxrss < mem0 + 1000\n```\nIf not, do you have a better idea?",
    "created_at": "2016-03-28T02:04:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20268#issuecomment-293659",
    "user": "https://github.com/videlec"
}
```

<a id='comment:7'></a>I would like to add a doctest for that. Do you think that the following is strong enough

```
sage: p = polygen(ZZ)
sage: import resource 
sage: mem0 = resource.getrusage(resource.RUSAGE_SELF).ru_maxrss 
sage: for _ in range(10000):
....:     t = Polynomial.__call__(p, 1)
sage: assert resource.getrusage(resource.RUSAGE_SELF).ru_maxrss < mem0 + 1000
```
If not, do you have a better idea?



---

archive/issue_comments_293660.json:
```json
{
    "body": "<a id='comment:8'></a>Perhaps staying closer to python's own memory management routines and pick an example that produces stuff that is tracked by gc:\n\n```\nsage: import gc\nsage: p=polygen(ZZ)\nsage: gc.collect()\n0\nsage: N=len(gc.get_objects())\nsage: for _ in range(10000): t = Polynomial.__call__(p,p)\nsage: assert len(gc.get_objects())-N < 1000\n```",
    "created_at": "2016-03-31T00:21:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20268#issuecomment-293660",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:8'></a>Perhaps staying closer to python's own memory management routines and pick an example that produces stuff that is tracked by gc:

```
sage: import gc
sage: p=polygen(ZZ)
sage: gc.collect()
0
sage: N=len(gc.get_objects())
sage: for _ in range(10000): t = Polynomial.__call__(p,p)
sage: assert len(gc.get_objects())-N < 1000
```



---

archive/issue_comments_293661.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [comment:8 nbruin]:\n> Perhaps staying closer to python's own memory management routines and pick an example that produces stuff that is tracked by gc:\n> \n> \n> ```\n> sage: import gc\n> sage: p=polygen(ZZ)\n> sage: gc.collect()\n> 0\n> sage: N=len(gc.get_objects())\n> sage: for _ in range(10000): t = Polynomial.__call__(p,p)\n> sage: assert len(gc.get_objects())-N < 1000\n> ```\n\n\nIt will not work. The leak was not seen at Python level.",
    "created_at": "2016-03-31T02:34:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20268#issuecomment-293661",
    "user": "https://github.com/videlec"
}
```

<a id='comment:9'></a>Replying to [comment:8 nbruin]:
> Perhaps staying closer to python's own memory management routines and pick an example that produces stuff that is tracked by gc:
> 
> 
> ```
> sage: import gc
> sage: p=polygen(ZZ)
> sage: gc.collect()
> 0
> sage: N=len(gc.get_objects())
> sage: for _ in range(10000): t = Polynomial.__call__(p,p)
> sage: assert len(gc.get_objects())-N < 1000
> ```


It will not work. The leak was not seen at Python level.



---

archive/issue_comments_293662.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:9 vdelecroix]:\n> It will not work. The leak was not seen at Python level.\n\n\nDid you try the example? The leak causes dangling objects on the python heap. However, `gc.get_objects()` will only find tracked objects, and tuples with too simple ingredients aren't tracked. However, when you put sufficiently complicated objects in there (such as `p`) then it is tracked. So the test does work. So should the rusage of course, modulo unpredictable memory allocation strategies, or unusual circumstances that cause the rss to remain small in the presence of large memory usage.",
    "created_at": "2016-03-31T04:15:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20268#issuecomment-293662",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:10'></a>Replying to [comment:9 vdelecroix]:
> It will not work. The leak was not seen at Python level.


Did you try the example? The leak causes dangling objects on the python heap. However, `gc.get_objects()` will only find tracked objects, and tuples with too simple ingredients aren't tracked. However, when you put sufficiently complicated objects in there (such as `p`) then it is tracked. So the test does work. So should the rusage of course, modulo unpredictable memory allocation strategies, or unusual circumstances that cause the rss to remain small in the presence of large memory usage.



---

archive/issue_comments_293663.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-05-05T07:56:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20268#issuecomment-293663",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_events_055024.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-05-05T07:56:29Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20268",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20268#event-55024"
}
```



---

archive/issue_comments_293664.json:
```json
{
    "body": "<a id='comment:12'></a>I guess this is superseded by the Cython upgrade.",
    "created_at": "2016-05-05T07:56:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20268#issuecomment-293664",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>I guess this is superseded by the Cython upgrade.



---

archive/issue_comments_293665.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-05-11T20:09:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20268",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20268#issuecomment-293665",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_055025.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-05-11T20:09:41Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20268",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20268#event-55025"
}
```
