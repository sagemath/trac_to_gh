# Issue 20136: Upgrade meataxe and fix some build issues

archive/issues_019899.json:
```json
{
    "body": "1. The actual command lines when compiling are hidden, all I see is `compile foo.c`. Seeing the actual command line passed to `gcc` is very useful for debugging.\n\n2. user-defined `CFLAGS` are not passed.\n\n3. meataxe assumes that `char` is `signed char` but that is not guaranteed by the C standard. This causes breakage on powerpc64le. A work-around with GCC is `-fsigned-char` but it's better to fix the C sources.\n\n4. the test-suite has race conditions: testing with `MAKE=\"make -j48\"` fails while `MAKE=\"make -j1\"` works.\n\n**CC:**  simonking\n\n**Branch:** [u/SimonKing/various_meataxe_build_issues](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/various_meataxe_build_issues)\n\n**Commit:** [96fc74f2b7d5aa908d28376673e014828375e4c7](https://github.com/sagemath/sagetrac-mirror/commit/96fc74f2b7d5aa908d28376673e014828375e4c7)\n\n**Upstream:** None of the above - read trac for reasoning.\n\n**Reviewer:** Jeroen Demeyer\n\n**Author:** Simon King\n\n**Status:** needs_work\n\nIssue created by migration from https://trac.sagemath.org/ticket/20136\n\n",
    "created_at": "2016-02-29T11:39:41Z",
    "labels": [
        "component: packages: optional",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "Upgrade meataxe and fix some build issues",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20136",
    "user": "https://github.com/jdemeyer"
}
```
1. The actual command lines when compiling are hidden, all I see is `compile foo.c`. Seeing the actual command line passed to `gcc` is very useful for debugging.

2. user-defined `CFLAGS` are not passed.

3. meataxe assumes that `char` is `signed char` but that is not guaranteed by the C standard. This causes breakage on powerpc64le. A work-around with GCC is `-fsigned-char` but it's better to fix the C sources.

4. the test-suite has race conditions: testing with `MAKE="make -j48"` fails while `MAKE="make -j1"` works.

**CC:**  simonking

**Branch:** [u/SimonKing/various_meataxe_build_issues](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/various_meataxe_build_issues)

**Commit:** [96fc74f2b7d5aa908d28376673e014828375e4c7](https://github.com/sagemath/sagetrac-mirror/commit/96fc74f2b7d5aa908d28376673e014828375e4c7)

**Upstream:** None of the above - read trac for reasoning.

**Reviewer:** Jeroen Demeyer

**Author:** Simon King

**Status:** needs_work

Issue created by migration from https://trac.sagemath.org/ticket/20136





---

archive/issue_comments_367124.json:
```json
{
    "body": "Hi Jeroen,\n\nThank you for locating a couple of issues and opening the ticket! I am about to contact upstream\n\nReplying to [ticket:20136 jdemeyer]:\n> 3. meataxe assumes that `char` is `signed char` but that is not guaranteed by the C standard. This causes breakage on powerpc64le. A work-around with GCC is `-fsigned-char` but it's better to fix the sources.\n\n\nOK, but that would also require to either fix the sources (namely the Makefile), either by using `-fsigned-char` or by passing `CFLAGS`.\n \n> 4. the test-suite has race conditions: testing with `MAKE=\"make -j48\"` fails while `MAKE=\"make -j1\"` works.\n\n\nI have seen before that the test suite is flaky. Meataxe's test suite is about Meataxe executables that read and write data from files. Could file i/o be the reason for race conditions? Hm. Let's see what upstream has to say.",
    "created_at": "2016-02-29T13:10:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367124",
    "user": "https://github.com/simon-king-jena"
}
```

Hi Jeroen,

Thank you for locating a couple of issues and opening the ticket! I am about to contact upstream

Replying to [ticket:20136 jdemeyer]:
> 3. meataxe assumes that `char` is `signed char` but that is not guaranteed by the C standard. This causes breakage on powerpc64le. A work-around with GCC is `-fsigned-char` but it's better to fix the sources.


OK, but that would also require to either fix the sources (namely the Makefile), either by using `-fsigned-char` or by passing `CFLAGS`.
 
> 4. the test-suite has race conditions: testing with `MAKE="make -j48"` fails while `MAKE="make -j1"` works.


I have seen before that the test suite is flaky. Meataxe's test suite is about Meataxe executables that read and write data from files. Could file i/o be the reason for race conditions? Hm. Let's see what upstream has to say.



---

archive/issue_comments_367125.json:
```json
{
    "body": "<a id='comment:2'></a>\nReplying to [SimonKing](#comment%3A1):\n> > 3. meataxe assumes that `char` is `signed char` but that is not guaranteed by the C standard. This causes breakage on powerpc64le. A work-around with GCC is `-fsigned-char` but it's better to fix the sources.\n  \n> \n> OK, but that would also require to either fix the sources (namely the Makefile)\n\nI meant changing the C sources. This could mean changing `char` to `signed char` or fix the places where it is assumed that `char` is signed.\n\nAlso keep in mind that perhaps code *linking* to meataxe might break because of this (maybe not, I don't know). I don't think you can require such code to use `-fsigned-char`.\n\n> > 4. the test-suite has race conditions: testing with `MAKE=\"make -j48\"` fails while `MAKE=\"make -j1\"` works.\n  \n> \n> I have seen before that the test suite is flaky.\n\nAn easy workaround is to use `$MAKE -j1` then.",
    "created_at": "2016-02-29T13:17:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367125",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:2'></a>
Replying to [SimonKing](#comment%3A1):
> > 3. meataxe assumes that `char` is `signed char` but that is not guaranteed by the C standard. This causes breakage on powerpc64le. A work-around with GCC is `-fsigned-char` but it's better to fix the sources.
  
> 
> OK, but that would also require to either fix the sources (namely the Makefile)

I meant changing the C sources. This could mean changing `char` to `signed char` or fix the places where it is assumed that `char` is signed.

Also keep in mind that perhaps code *linking* to meataxe might break because of this (maybe not, I don't know). I don't think you can require such code to use `-fsigned-char`.

> > 4. the test-suite has race conditions: testing with `MAKE="make -j48"` fails while `MAKE="make -j1"` works.
  
> 
> I have seen before that the test suite is flaky.

An easy workaround is to use `$MAKE -j1` then.



---

archive/issue_comments_367126.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [jdemeyer](#comment%3A2):\n> I meant changing the C sources. This could mean changing `char` to `signed char` or fix the places where it is assumed that `char` is signed.\n> \n> Also keep in mind that perhaps code *linking* to meataxe might break because of this (maybe not, I don't know). I don't think you can require such code to use `-fsigned-char`.\n\n\nGood point.\n \n> > > 4. the test-suite has race conditions: testing with `MAKE=\"make -j48\"` fails while `MAKE=\"make -j1\"` works.\n  \n> > \n> > I have seen before that the test suite is flaky.\n\n> An easy workaround is to use `$MAKE -j1` then.\n\nIs there really no *proper* solution for such a race condition, assuming that it really is caused by delays in file i/o?",
    "created_at": "2016-02-29T13:25:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367126",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:3'></a>
Replying to [jdemeyer](#comment%3A2):
> I meant changing the C sources. This could mean changing `char` to `signed char` or fix the places where it is assumed that `char` is signed.
> 
> Also keep in mind that perhaps code *linking* to meataxe might break because of this (maybe not, I don't know). I don't think you can require such code to use `-fsigned-char`.


Good point.
 
> > > 4. the test-suite has race conditions: testing with `MAKE="make -j48"` fails while `MAKE="make -j1"` works.
  
> > 
> > I have seen before that the test suite is flaky.

> An easy workaround is to use `$MAKE -j1` then.

Is there really no *proper* solution for such a race condition, assuming that it really is caused by delays in file i/o?



---

archive/issue_comments_367127.json:
```json
{
    "body": "**Changing upstream** from \"N/A\" to \"Reported upstream. No feedback yet.\".",
    "created_at": "2016-02-29T13:25:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367127",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing upstream** from "N/A" to "Reported upstream. No feedback yet.".



---

archive/issue_comments_367128.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [SimonKing](#comment%3A3):\n> Is there really no *proper* solution for such a race condition, assuming that it really is caused by delays in file i/o?\n\n\nOf course there is, I was just giving the easiest possible solution. Everything depends on the exact nature of the race condition.\n\nJust guessing... maybe different tests write to the same file. Then the fix is easy: use a different file for each test.",
    "created_at": "2016-02-29T13:29:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367128",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:4'></a>
Replying to [SimonKing](#comment%3A3):
> Is there really no *proper* solution for such a race condition, assuming that it really is caused by delays in file i/o?


Of course there is, I was just giving the easiest possible solution. Everything depends on the exact nature of the race condition.

Just guessing... maybe different tests write to the same file. Then the fix is easy: use a different file for each test.



---

archive/issue_comments_367129.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -2,6 +2,6 @@\n \n 2. user-defined `CFLAGS` are not passed.\n \n-3. meataxe assumes that `char` is `signed char` but that is not guaranteed by the C standard. This causes breakage on powerpc64le. A work-around with GCC is `-fsigned-char` but it's better to fix the sources.\n+3. meataxe assumes that `char` is `signed char` but that is not guaranteed by the C standard. This causes breakage on powerpc64le. A work-around with GCC is `-fsigned-char` but it's better to fix the C sources.\n \n 4. the test-suite has race conditions: testing with `MAKE=\"make -j48\"` fails while `MAKE=\"make -j1\"` works.\n``````\n",
    "created_at": "2016-02-29T13:30:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367129",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -2,6 +2,6 @@
 
 2. user-defined `CFLAGS` are not passed.
 
-3. meataxe assumes that `char` is `signed char` but that is not guaranteed by the C standard. This causes breakage on powerpc64le. A work-around with GCC is `-fsigned-char` but it's better to fix the sources.
+3. meataxe assumes that `char` is `signed char` but that is not guaranteed by the C standard. This causes breakage on powerpc64le. A work-around with GCC is `-fsigned-char` but it's better to fix the C sources.
 
 4. the test-suite has race conditions: testing with `MAKE="make -j48"` fails while `MAKE="make -j1"` works.
``````




---

archive/issue_comments_367130.json:
```json
{
    "body": "<a id='comment:6'></a>\nThis really looks like `meataxe` is using the same filename (`x2`) for different tests, especially because the calculated checksum is the same each time:\n\n```\nFile x2: checksum error\n         expected:   41484.1750919850\n         calculated: 41484.2717504566\nMakefile:134: recipe for target 'tmp/t-0115.done' failed\nmake[2]: *** [tmp/t-0115.done] Error 1\nFile x2: checksum error\n         expected:   1251.4048248722\n         calculated: 41484.2717504566\nMakefile:134: recipe for target 'tmp/t-0116.done' failed\nmake[2]: *** [tmp/t-0116.done] Error 1\nFile x2: checksum error\n         expected:   384.1740937932\n         calculated: 41484.2717504566\nMakefile:134: recipe for target 'tmp/t-0111.done' failed\nmake[2]: *** [tmp/t-0111.done] Error 1\n```",
    "created_at": "2016-02-29T13:38:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367130",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'></a>
This really looks like `meataxe` is using the same filename (`x2`) for different tests, especially because the calculated checksum is the same each time:

```
File x2: checksum error
         expected:   41484.1750919850
         calculated: 41484.2717504566
Makefile:134: recipe for target 'tmp/t-0115.done' failed
make[2]: *** [tmp/t-0115.done] Error 1
File x2: checksum error
         expected:   1251.4048248722
         calculated: 41484.2717504566
Makefile:134: recipe for target 'tmp/t-0116.done' failed
make[2]: *** [tmp/t-0116.done] Error 1
File x2: checksum error
         expected:   384.1740937932
         calculated: 41484.2717504566
Makefile:134: recipe for target 'tmp/t-0111.done' failed
make[2]: *** [tmp/t-0111.done] Error 1
```



---

archive/issue_comments_367131.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [jdemeyer](#comment%3A4):\n> Replying to [SimonKing](#comment%3A3):\n> Just guessing... maybe different tests write to the same file. Then the fix is easy: use a different file for each test.\n\n\nCould several processes READING from the same file be a problem, too? Or is reading safe?",
    "created_at": "2016-02-29T13:39:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367131",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:7'></a>
Replying to [jdemeyer](#comment%3A4):
> Replying to [SimonKing](#comment%3A3):
> Just guessing... maybe different tests write to the same file. Then the fix is easy: use a different file for each test.


Could several processes READING from the same file be a problem, too? Or is reading safe?



---

archive/issue_comments_367132.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [jdemeyer](#comment%3A6):\n> This really looks like `meataxe` is using the same filename (`x2`) for different tests, especially because the calculated checksum is the same each time:\n\n\nOK, that would of course be a bad design.",
    "created_at": "2016-02-29T13:40:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367132",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
Replying to [jdemeyer](#comment%3A6):
> This really looks like `meataxe` is using the same filename (`x2`) for different tests, especially because the calculated checksum is the same each time:


OK, that would of course be a bad design.



---

archive/issue_comments_367133.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [SimonKing](#comment%3A7):\n> Could several processes READING from the same file be a problem, too?\n\nNo, that should be safe. This is in fact extremely common: if you execute several instances of `gcc` in parallel, each of them will probably read the same `.h` files.",
    "created_at": "2016-02-29T13:40:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367133",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
Replying to [SimonKing](#comment%3A7):
> Could several processes READING from the same file be a problem, too?

No, that should be safe. This is in fact extremely common: if you execute several instances of `gcc` in parallel, each of them will probably read the same `.h` files.



---

archive/issue_comments_367134.json:
```json
{
    "body": "**Changing upstream** from \"Reported upstream. No feedback yet.\" to \"Reported upstream. Developers acknowledge bug.\".",
    "created_at": "2016-03-08T10:55:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367134",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing upstream** from "Reported upstream. No feedback yet." to "Reported upstream. Developers acknowledge bug.".



---

archive/issue_comments_367135.json:
```json
{
    "body": "<a id='comment:10'></a>\nMeanwhile Michael Ringe has replied:\n\n- He deems my patches useful extensions and/or corrections.\n- He has difficulties to use my code in the current development version, since the code base has changed.\n- The current source code is [at github](https://github.com/momtx/meataxe/tree/2.4.x). He plans to include my patches there and create a new 2.4.x-version, but it is unclear when he will find the time to do so.\n- In the current development version, some but not all test problems are solved.\n\nConcerning the issues raised by Jeroen:\n\n- The problem with (unsigned) char should be solved in the development version; however, he didn't try building on AIX recently.\n- Full output of the compiler commands can be obtained by `make V=1`. So, we should change spkg-install accordingly.\n- The tests are not parallelisable (so, we should resort to `make -j1`), but should become in future.",
    "created_at": "2016-03-08T10:55:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367135",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:10'></a>
Meanwhile Michael Ringe has replied:

- He deems my patches useful extensions and/or corrections.
- He has difficulties to use my code in the current development version, since the code base has changed.
- The current source code is [at github](https://github.com/momtx/meataxe/tree/2.4.x). He plans to include my patches there and create a new 2.4.x-version, but it is unclear when he will find the time to do so.
- In the current development version, some but not all test problems are solved.

Concerning the issues raised by Jeroen:

- The problem with (unsigned) char should be solved in the development version; however, he didn't try building on AIX recently.
- Full output of the compiler commands can be obtained by `make V=1`. So, we should change spkg-install accordingly.
- The tests are not parallelisable (so, we should resort to `make -j1`), but should become in future.



---

archive/issue_comments_367136.json:
```json
{
    "body": "<a id='comment:11'></a>\nJeroen, I have developed my patches with a git repository on my laptop. Since the new meataxe upstream code is at github, shouldn't it be possible to do a merge more or less smoothly (using kdiff3 I mean)? How do I use github, i.e., how do I pull the recent upstream changes so that I can merge with my patches?\n\nOr: SHOULD I do the merge? Should an optional meataxe package be based on the latest official meataxe release (which is currently the case) or on a non-official development branch?",
    "created_at": "2016-03-08T10:58:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367136",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:11'></a>
Jeroen, I have developed my patches with a git repository on my laptop. Since the new meataxe upstream code is at github, shouldn't it be possible to do a merge more or less smoothly (using kdiff3 I mean)? How do I use github, i.e., how do I pull the recent upstream changes so that I can merge with my patches?

Or: SHOULD I do the merge? Should an optional meataxe package be based on the latest official meataxe release (which is currently the case) or on a non-official development branch?



---

archive/issue_comments_367137.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [SimonKing](#comment%3A11):\n> Should an optional meataxe package be based on the latest official meataxe release (which is currently the case) or on a non-official development branch?\n\n\nA stable release is preferred, but if there are good reasons to use a development version, you can use that (like we do for the standard package PARI for example). From what I understand, this would qualify as a good reason.\n\nBut above all: document things clearly. A blackbox tarball with no documentation where it came from is not acceptable. It should be possible for a third party to obtain exactly the sources that you used (from github say).",
    "created_at": "2016-03-08T13:08:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367137",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>
Replying to [SimonKing](#comment%3A11):
> Should an optional meataxe package be based on the latest official meataxe release (which is currently the case) or on a non-official development branch?


A stable release is preferred, but if there are good reasons to use a development version, you can use that (like we do for the standard package PARI for example). From what I understand, this would qualify as a good reason.

But above all: document things clearly. A blackbox tarball with no documentation where it came from is not acceptable. It should be possible for a third party to obtain exactly the sources that you used (from github say).



---

archive/issue_comments_367138.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [SimonKing](#comment%3A10):\n> - Full output of the compiler commands can be obtained by `make V=1`. So, we should change spkg-install accordingly.\n> - The tests are not parallelisable (so, we should resort to `make -j1`), but should become in future.\n\n\nGood. Remember to replace `make` by `$MAKE` in the above.",
    "created_at": "2016-03-08T13:09:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367138",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
Replying to [SimonKing](#comment%3A10):
> - Full output of the compiler commands can be obtained by `make V=1`. So, we should change spkg-install accordingly.
> - The tests are not parallelisable (so, we should resort to `make -j1`), but should become in future.


Good. Remember to replace `make` by `$MAKE` in the above.



---

archive/issue_comments_367139.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [jdemeyer](#comment%3A12):\n> But above all: document things clearly.\n\n\nHow? Do I simply state in SPKG.txt the address of the github repository and the commit I am using?\n\nAnd the tarball created from the repository should not contain .git/ and .gitignore, right?",
    "created_at": "2016-03-15T12:41:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367139",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:14'></a>
Replying to [jdemeyer](#comment%3A12):
> But above all: document things clearly.


How? Do I simply state in SPKG.txt the address of the github repository and the commit I am using?

And the tarball created from the repository should not contain .git/ and .gitignore, right?



---

archive/issue_comments_367140.json:
```json
{
    "body": "<a id='comment:15'></a>\nSigh. The upstream development version has changed considerably wrt the official release. Filenames have changed, which makes rebasing my patches uncomfortable.\n\nALL c-source files have changed. It seems that in most cases the change is in how comments are formatted and whether tabs are used. This makes rebasing my patches a mess, and for no good reason (I mean, it isn't so much about codes but about formatting!).\n\nThere are some source files that look like being dedicated to the \"large\" kernel (i.e., field sizes > 255), but in the Makefile is stated that the large kernel is not available --- which I find inconsistent.\n\nBut my main frustration comes from the fact that using the latest upstream development version would require an awful lot of additional work.",
    "created_at": "2016-03-15T16:22:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367140",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:15'></a>
Sigh. The upstream development version has changed considerably wrt the official release. Filenames have changed, which makes rebasing my patches uncomfortable.

ALL c-source files have changed. It seems that in most cases the change is in how comments are formatted and whether tabs are used. This makes rebasing my patches a mess, and for no good reason (I mean, it isn't so much about codes but about formatting!).

There are some source files that look like being dedicated to the "large" kernel (i.e., field sizes > 255), but in the Makefile is stated that the large kernel is not available --- which I find inconsistent.

But my main frustration comes from the fact that using the latest upstream development version would require an awful lot of additional work.



---

archive/issue_comments_367141.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [SimonKing](#comment%3A15):\n> It seems that in most cases the change is in how comments are formatted and whether tabs are used. This makes rebasing my patches a mess, and for no good reason (I mean, it isn't so much about codes but about formatting!).\n\n\nIf it's only a matter of spacing, `git merge` has options for dealing with that:\n\n```\n           ignore-space-change, ignore-all-space, ignore-space-at-eol\n               Treats lines with the indicated type of whitespace change as unchanged for the sake of a three-way merge. Whitespace changes mixed with\n               other changes to a line are not ignored. See also git-diff(1)-b, -w, and --ignore-space-at-eol.\n\n               \u00b7   If their version only introduces whitespace changes to a line, our version is used;\n\n               \u00b7   If our version introduces whitespace changes but their version includes a substantial change, their version is used;\n\n               \u00b7   Otherwise, the merge proceeds in the usual way.\n```",
    "created_at": "2016-03-15T16:46:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367141",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>
Replying to [SimonKing](#comment%3A15):
> It seems that in most cases the change is in how comments are formatted and whether tabs are used. This makes rebasing my patches a mess, and for no good reason (I mean, it isn't so much about codes but about formatting!).


If it's only a matter of spacing, `git merge` has options for dealing with that:

```
           ignore-space-change, ignore-all-space, ignore-space-at-eol
               Treats lines with the indicated type of whitespace change as unchanged for the sake of a three-way merge. Whitespace changes mixed with
               other changes to a line are not ignored. See also git-diff(1)-b, -w, and --ignore-space-at-eol.

               ·   If their version only introduces whitespace changes to a line, our version is used;

               ·   If our version introduces whitespace changes but their version includes a substantial change, their version is used;

               ·   Otherwise, the merge proceeds in the usual way.
```



---

archive/issue_comments_367142.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [SimonKing](#comment%3A14):\n> Replying to [jdemeyer](#comment%3A12):\n> > But above all: document things clearly.\n\n> \n> How? Do I simply state in SPKG.txt the address of the github repository and the commit I am using?\n\nIf you literally took a snapshot from that commit: yes\n\n> And the tarball created from the repository should not contain .git/ and .gitignore, right?\n\nNo, it should not contain that. Ideally, upstream has a defined procedure for making a source tarball (something like `make dist` or `make snapshot` or `python setup.py sdist`), that should be used.",
    "created_at": "2016-03-15T16:49:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367142",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>
Replying to [SimonKing](#comment%3A14):
> Replying to [jdemeyer](#comment%3A12):
> > But above all: document things clearly.

> 
> How? Do I simply state in SPKG.txt the address of the github repository and the commit I am using?

If you literally took a snapshot from that commit: yes

> And the tarball created from the repository should not contain .git/ and .gitignore, right?

No, it should not contain that. Ideally, upstream has a defined procedure for making a source tarball (something like `make dist` or `make snapshot` or `python setup.py sdist`), that should be used.



---

archive/issue_comments_367143.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [jdemeyer](#comment%3A16):\n> Replying to [SimonKing](#comment%3A15):\n> > It seems that in most cases the change is in how comments are formatted and whether tabs are used. This makes rebasing my patches a mess, and for no good reason (I mean, it isn't so much about codes but about formatting!).\n\n\nUnfortunately, it is more complicated. Here is an example obtained with `diff -b`:\n\n```diff\n1,8c1,7\n< /* ============================= C MeatAxe ==================================\n<    File:        $Id: matcmp.c,v 1.1.1.1 2007/09/02 11:06:17 mringe Exp $\n<    Comment:     Compare matrices.\n<    --------------------------------------------------------------------------\n<    (C) Copyright 1998 Michael Ringe, Lehrstuhl D fuer Mathematik,\n<    RWTH Aachen, Germany  <mringe@math.rwth-aachen.de>\n<    This program is free software; see the file COPYING for details.\n<    ========================================================================== */\n---\n> ////////////////////////////////////////////////////////////////////////////////////////////////////\n> // C MeatAxe - Compare matrices\n> //\n> // (C) Copyright 1998-2015 Michael Ringe, Lehrstuhl D fuer Mathematik, RWTH Aachen\n> //\n> // This program is free software; see the file COPYING for details.\n> ////////////////////////////////////////////////////////////////////////////////////////////////////\n10,11c9\n< \n< #include \"meataxe.h\"\n---\n> #include <meataxe.h>\n14c12,13\n< MTX_DEFINE_FILE_INFO\n---\n> ////////////////////////////////////////////////////////////////////////////////////////////////////\n> // Local data\n15a15\n> MTX_DEFINE_FILE_INFO\n16a17,18\n> /// @addtogroup mat\n> /// @{\n18,42c20,38\n< /**\n<  ** @addtogroup mat\n<  ** @{\n<  **/\n< \n< /**\n<  ** Compare two matrices\n<  ** If the matrices are equal, the return value is 0. Otherwise the return value is positive,\n<  ** if @em a is \"greater\" than @em b and negative, if @em a is \"less\" than @em b. The ordering\n<  ** matrices is defined as follows:\n<  **\n<  ** - If the matrices are over different fields, the matrix over the smaller field is smaller.\n<  ** - Otherwise, if the matrices have different number of columns, the matrix with the smaller\n<  **   number of columns is smaller.\n<  ** - Otherwise, if the matrices have different number of rows, the matrix with the smaller\n<  **   number of rows is smaller.\n<  ** - Otherwise, the relation is determined by the return value of FfCmpRow() on the first row\n<  **   that is not equal in both matrices.\n<  **\n<  ** In case an error occurs, the return value is -1. But note that a return value of -1 does\n<  ** not necessarily mean that an error has occured.\n<  ** @param a First matrix.\n<  ** @param b Second matrix.\n<  ** @return 0 if the matrices are equal, nonzero otherwise (see description).\n<  **/\n---\n> ////////////////////////////////////////////////////////////////////////////////////////////////////\n> /// Compare two matrices\n> /// If the matrices are equal, the return value is 0. Otherwise the return value is positive,\n> /// if @em a is \"greater\" than @em b and negative, if @em a is \"less\" than @em b. The ordering\n> /// matrices is defined as follows:\n> ///\n> /// - If the matrices are over different fields, the matrix over the smaller field is smaller.\n> /// - Otherwise, if the matrices have different number of columns, the matrix with the smaller\n> ///   number of columns is smaller.\n> /// - Otherwise, if the matrices have different number of rows, the matrix with the smaller\n> ///   number of rows is smaller.\n> /// - Otherwise, the relation is determined by the return value of FfCmpRow() on the first row\n> ///   that is not equal in both matrices.\n> ///\n> /// In case an error occurs, the return value is -1. But note that a return value of -1 does\n> /// not necessarily mean that an error has occured.\n> /// @param a First matrix.\n> /// @param b Second matrix.\n> /// @return 0 if the matrices are equal, nonzero otherwise (see description).\n50,51c46\n<     if (!MatIsValid(a) || !MatIsValid(b))\n<     {\n---\n>    if (!MatIsValid(a) || !MatIsValid(b)) {\n58c53\n<     if ((i = a->Field - b->Field) != 0)\n---\n>    if ((i = a->Field - b->Field) != 0) {\n60c55,56\n<     if ((i = a->Noc - b->Noc) != 0)\n---\n>    }\n>    if ((i = a->Noc - b->Noc) != 0) {\n62c58,59\n<     if ((i = a->Nor - b->Nor) != 0)\n---\n>    }\n>    if ((i = a->Nor - b->Nor) != 0) {\n63a61\n>    }\n70,71c68\n<     for (i = 0; i < a->Nor; ++i)\n<     {\n---\n>    for (i = 0; i < a->Nor; ++i) {\n75c72\n< \tif (diff != 0)\n---\n>       if (diff != 0) {\n77a75\n>    }\n84,86c82,83\n< /**\n<  ** @}\n<  **/\n---\n> \n> /// @}\n```\nThe file has 83 lines, but even though the code didn't change the tiniest bit, the diff file has 117 lines ---  which basically makes it so that all hunks for a patch will fail.",
    "created_at": "2016-03-15T18:48:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367143",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:18'></a>
Replying to [jdemeyer](#comment%3A16):
> Replying to [SimonKing](#comment%3A15):
> > It seems that in most cases the change is in how comments are formatted and whether tabs are used. This makes rebasing my patches a mess, and for no good reason (I mean, it isn't so much about codes but about formatting!).


Unfortunately, it is more complicated. Here is an example obtained with `diff -b`:

```diff
1,8c1,7
< /* ============================= C MeatAxe ==================================
<    File:        $Id: matcmp.c,v 1.1.1.1 2007/09/02 11:06:17 mringe Exp $
<    Comment:     Compare matrices.
<    --------------------------------------------------------------------------
<    (C) Copyright 1998 Michael Ringe, Lehrstuhl D fuer Mathematik,
<    RWTH Aachen, Germany  <mringe@math.rwth-aachen.de>
<    This program is free software; see the file COPYING for details.
<    ========================================================================== */
---
> ////////////////////////////////////////////////////////////////////////////////////////////////////
> // C MeatAxe - Compare matrices
> //
> // (C) Copyright 1998-2015 Michael Ringe, Lehrstuhl D fuer Mathematik, RWTH Aachen
> //
> // This program is free software; see the file COPYING for details.
> ////////////////////////////////////////////////////////////////////////////////////////////////////
10,11c9
< 
< #include "meataxe.h"
---
> #include <meataxe.h>
14c12,13
< MTX_DEFINE_FILE_INFO
---
> ////////////////////////////////////////////////////////////////////////////////////////////////////
> // Local data
15a15
> MTX_DEFINE_FILE_INFO
16a17,18
> /// @addtogroup mat
> /// @{
18,42c20,38
< /**
<  ** @addtogroup mat
<  ** @{
<  **/
< 
< /**
<  ** Compare two matrices
<  ** If the matrices are equal, the return value is 0. Otherwise the return value is positive,
<  ** if @em a is "greater" than @em b and negative, if @em a is "less" than @em b. The ordering
<  ** matrices is defined as follows:
<  **
<  ** - If the matrices are over different fields, the matrix over the smaller field is smaller.
<  ** - Otherwise, if the matrices have different number of columns, the matrix with the smaller
<  **   number of columns is smaller.
<  ** - Otherwise, if the matrices have different number of rows, the matrix with the smaller
<  **   number of rows is smaller.
<  ** - Otherwise, the relation is determined by the return value of FfCmpRow() on the first row
<  **   that is not equal in both matrices.
<  **
<  ** In case an error occurs, the return value is -1. But note that a return value of -1 does
<  ** not necessarily mean that an error has occured.
<  ** @param a First matrix.
<  ** @param b Second matrix.
<  ** @return 0 if the matrices are equal, nonzero otherwise (see description).
<  **/
---
> ////////////////////////////////////////////////////////////////////////////////////////////////////
> /// Compare two matrices
> /// If the matrices are equal, the return value is 0. Otherwise the return value is positive,
> /// if @em a is "greater" than @em b and negative, if @em a is "less" than @em b. The ordering
> /// matrices is defined as follows:
> ///
> /// - If the matrices are over different fields, the matrix over the smaller field is smaller.
> /// - Otherwise, if the matrices have different number of columns, the matrix with the smaller
> ///   number of columns is smaller.
> /// - Otherwise, if the matrices have different number of rows, the matrix with the smaller
> ///   number of rows is smaller.
> /// - Otherwise, the relation is determined by the return value of FfCmpRow() on the first row
> ///   that is not equal in both matrices.
> ///
> /// In case an error occurs, the return value is -1. But note that a return value of -1 does
> /// not necessarily mean that an error has occured.
> /// @param a First matrix.
> /// @param b Second matrix.
> /// @return 0 if the matrices are equal, nonzero otherwise (see description).
50,51c46
<     if (!MatIsValid(a) || !MatIsValid(b))
<     {
---
>    if (!MatIsValid(a) || !MatIsValid(b)) {
58c53
<     if ((i = a->Field - b->Field) != 0)
---
>    if ((i = a->Field - b->Field) != 0) {
60c55,56
<     if ((i = a->Noc - b->Noc) != 0)
---
>    }
>    if ((i = a->Noc - b->Noc) != 0) {
62c58,59
<     if ((i = a->Nor - b->Nor) != 0)
---
>    }
>    if ((i = a->Nor - b->Nor) != 0) {
63a61
>    }
70,71c68
<     for (i = 0; i < a->Nor; ++i)
<     {
---
>    for (i = 0; i < a->Nor; ++i) {
75c72
< 	if (diff != 0)
---
>       if (diff != 0) {
77a75
>    }
84,86c82,83
< /**
<  ** @}
<  **/
---
> 
> /// @}
```
The file has 83 lines, but even though the code didn't change the tiniest bit, the diff file has 117 lines ---  which basically makes it so that all hunks for a patch will fail.



---

archive/issue_comments_367144.json:
```json
{
    "body": "<a id='comment:19'></a>\nI understand your problem, I also see no easy solution...",
    "created_at": "2016-03-15T19:32:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367144",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:19'></a>
I understand your problem, I also see no easy solution...



---

archive/issue_comments_367145.json:
```json
{
    "body": "<a id='comment:20'></a>\nI am not so much of a git expert. The upstream repository's first commit is close to the sources my patches are based upon. Would it perhaps be feasible to apply my patches to them, and then try to rebase the full upstream branch? Can that be easier than the attempt to apply my patches directly to the latest upstream commit?",
    "created_at": "2016-03-15T19:36:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367145",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:20'></a>
I am not so much of a git expert. The upstream repository's first commit is close to the sources my patches are based upon. Would it perhaps be feasible to apply my patches to them, and then try to rebase the full upstream branch? Can that be easier than the attempt to apply my patches directly to the latest upstream commit?



---

archive/issue_comments_367146.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [SimonKing](#comment%3A20):\n> I am not so much of a git expert. The upstream repository's first commit is close to the sources my patches are based upon. Would it perhaps be feasible to apply my patches to them, and then try to rebase the full upstream branch?\n\n\nI would not literally \"rebase\" but instead `git merge` the latest upstream branch and then fix the conflicts.\n\n> Can that be easier than the attempt to apply my patches directly to the latest upstream commit?\n\n\nPerhaps yes. You can try and see what it gives.",
    "created_at": "2016-03-15T20:20:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367146",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>
Replying to [SimonKing](#comment%3A20):
> I am not so much of a git expert. The upstream repository's first commit is close to the sources my patches are based upon. Would it perhaps be feasible to apply my patches to them, and then try to rebase the full upstream branch?


I would not literally "rebase" but instead `git merge` the latest upstream branch and then fix the conflicts.

> Can that be easier than the attempt to apply my patches directly to the latest upstream commit?


Perhaps yes. You can try and see what it gives.



---

archive/issue_comments_367147.json:
```json
{
    "body": "<a id='comment:22'></a>\nIf you merge into patches into an older version in the git history, then do `git merge`, then it is more likely to succeed automatically. You should also try to employ the `patience` or `minimal` merge strategies as well, e.g.,:\n\n```\ngit merge -X ignore-space-change -X patience master\n```\n`patience` is known to at least produce better differences wrt things like braces.",
    "created_at": "2016-03-15T23:43:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367147",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:22'></a>
If you merge into patches into an older version in the git history, then do `git merge`, then it is more likely to succeed automatically. You should also try to employ the `patience` or `minimal` merge strategies as well, e.g.,:

```
git merge -X ignore-space-change -X patience master
```
`patience` is known to at least produce better differences wrt things like braces.



---

archive/issue_comments_367148.json:
```json
{
    "body": "<a id='comment:23'></a>\nI succeeded to create a new package version based on the current snapshot. At least it installs and does some computations --- I didn't do extensive tests yet.\n\nApparently I misunderstood one point: My understanding was that the current snapshot would write/read the multiplication tables to/from a directory that is either prescribed by an environment variable at built time or a global C parameter at run time. But I stand corrected: Michael Ringe told me that MeatAxe would still *create* the tables in the current directory, but would first try to *read* the tables from a prescribed directory.\n\nMoreover, the \"prescribed directory\" defaults to `MTX_ROOT/lib`, where `MTX_ROOT` is the path into which MeatAxe is installed. In the case of a Sage package, we would have `MTX_ROOT=SAGE_LOCAL`, so that the binaries are installed in `SAGE_LOCAL/bin` and `libmtx.a` in `SAGE_LOCAL/lib` and meataxe.h in `SAGE_LOCAL/include`. But this can be overridden at run time, if I understood correctly.\n\nI see the following options:\n- Create all multiplication tables (it's only a few, for all finite fields up to order 255) during installation of the optional package (i.e., in a temporary directory) and then copy the tables into `SAGE_LOCAL/lib`, where presumably MeatAxe would find them by default.\n- Rather than clobbering `SAGE_LOCAL/lib` with some dozens of files, choose a better location in the `SAGE_LOCAL`-folder, and copy the tables to that location. Override meataxe's default directory at run time.\n- Do not create the multiplication tables at installation time, but at run time. During installation of the package, write permission is granted for `SAGE_LOCAL`, but not at run time. Hence, tables separately for each user ought to be created in `DOT_SAGE`. This is what the current version of the meataxe spkg is doing.\n\nWhat option do you prefer? The last option requires to rebase another patch, but that's easy.\n\nAnd another issue: MeatAxe has a `make tar` target to create a source tarball. Unfortunately, `make tar` does not copy the test suite into the tarball. Hence, I should probably create an spkg-src script.\n\nWould spkg-src really do the exact steps that I did to get a new tarball? That would be as follows:\n1. `git clone` the upstream repository.\n2. `git checkout` a particular commit, which in later versions may be changed\n3. `make tar`\n4. Move the resulting tar file into a temporary directory, unpack it there, copy the test suite into it, and repack it.",
    "created_at": "2016-03-29T16:26:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367148",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:23'></a>
I succeeded to create a new package version based on the current snapshot. At least it installs and does some computations --- I didn't do extensive tests yet.

Apparently I misunderstood one point: My understanding was that the current snapshot would write/read the multiplication tables to/from a directory that is either prescribed by an environment variable at built time or a global C parameter at run time. But I stand corrected: Michael Ringe told me that MeatAxe would still *create* the tables in the current directory, but would first try to *read* the tables from a prescribed directory.

Moreover, the "prescribed directory" defaults to `MTX_ROOT/lib`, where `MTX_ROOT` is the path into which MeatAxe is installed. In the case of a Sage package, we would have `MTX_ROOT=SAGE_LOCAL`, so that the binaries are installed in `SAGE_LOCAL/bin` and `libmtx.a` in `SAGE_LOCAL/lib` and meataxe.h in `SAGE_LOCAL/include`. But this can be overridden at run time, if I understood correctly.

I see the following options:
- Create all multiplication tables (it's only a few, for all finite fields up to order 255) during installation of the optional package (i.e., in a temporary directory) and then copy the tables into `SAGE_LOCAL/lib`, where presumably MeatAxe would find them by default.
- Rather than clobbering `SAGE_LOCAL/lib` with some dozens of files, choose a better location in the `SAGE_LOCAL`-folder, and copy the tables to that location. Override meataxe's default directory at run time.
- Do not create the multiplication tables at installation time, but at run time. During installation of the package, write permission is granted for `SAGE_LOCAL`, but not at run time. Hence, tables separately for each user ought to be created in `DOT_SAGE`. This is what the current version of the meataxe spkg is doing.

What option do you prefer? The last option requires to rebase another patch, but that's easy.

And another issue: MeatAxe has a `make tar` target to create a source tarball. Unfortunately, `make tar` does not copy the test suite into the tarball. Hence, I should probably create an spkg-src script.

Would spkg-src really do the exact steps that I did to get a new tarball? That would be as follows:
1. `git clone` the upstream repository.
2. `git checkout` a particular commit, which in later versions may be changed
3. `make tar`
4. Move the resulting tar file into a temporary directory, unpack it there, copy the test suite into it, and repack it.



---

archive/issue_comments_367149.json:
```json
{
    "body": "<a id='comment:24'></a>\nFor the tables, I would prefer `DOT_SAGE`. Even if there are 255 tables, maybe that number will increase if larger fields are supported.",
    "created_at": "2016-03-30T08:40:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367149",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>
For the tables, I would prefer `DOT_SAGE`. Even if there are 255 tables, maybe that number will increase if larger fields are supported.



---

archive/issue_comments_367150.json:
```json
{
    "body": "<a id='comment:25'></a>\nReplying to [SimonKing](#comment%3A23):\n> Unfortunately, `make tar` does not copy the test suite into the tarball.\n\n\nDoes upstream consider that a bug or a feature? I would try to convince upstream to either fix `make tar` or to add a new target (say, `make dist`) to create the full distribution including the testsuite.",
    "created_at": "2016-03-30T08:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367150",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>
Replying to [SimonKing](#comment%3A23):
> Unfortunately, `make tar` does not copy the test suite into the tarball.


Does upstream consider that a bug or a feature? I would try to convince upstream to either fix `make tar` or to add a new target (say, `make dist`) to create the full distribution including the testsuite.



---

archive/issue_comments_367151.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [jdemeyer](#comment%3A24):\n> For the tables, I would prefer `DOT_SAGE`. Even if there are 255 tables, maybe that number will increase if larger fields are supported.\n\n\nThat's unlikely, as support for larger fields (available by setting ZZZ=1 at compile time) in previous versions was dropped.",
    "created_at": "2016-03-30T16:27:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367151",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:26'></a>
Replying to [jdemeyer](#comment%3A24):
> For the tables, I would prefer `DOT_SAGE`. Even if there are 255 tables, maybe that number will increase if larger fields are supported.


That's unlikely, as support for larger fields (available by setting ZZZ=1 at compile time) in previous versions was dropped.



---

archive/issue_comments_367152.json:
```json
{
    "body": "<a id='comment:27'></a>\nReplying to [jdemeyer](#comment%3A25):\n> Replying to [SimonKing](#comment%3A23):\n> > Unfortunately, `make tar` does not copy the test suite into the tarball.\n\n> \n> Does upstream consider that a bug or a feature?\n\n\nRinge somehow said that the tests are work in progress...\n\n> I would try to convince upstream to either fix `make tar` or to add a new target (say, `make dist`) to create the full distribution including the testsuite.\n\n\nHow could I do the latter? I could of course add a patch in build/pkg/meataxe/patches. But that patch would be applied to the already *existing* sources that include tests.",
    "created_at": "2016-03-30T16:30:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367152",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:27'></a>
Replying to [jdemeyer](#comment%3A25):
> Replying to [SimonKing](#comment%3A23):
> > Unfortunately, `make tar` does not copy the test suite into the tarball.

> 
> Does upstream consider that a bug or a feature?


Ringe somehow said that the tests are work in progress...

> I would try to convince upstream to either fix `make tar` or to add a new target (say, `make dist`) to create the full distribution including the testsuite.


How could I do the latter? I could of course add a patch in build/pkg/meataxe/patches. But that patch would be applied to the already *existing* sources that include tests.



---

archive/issue_comments_367153.json:
```json
{
    "body": "<a id='comment:28'></a>\nReplying to [SimonKing](#comment%3A27):\n> > I would try to convince upstream to either fix `make tar` or to add a new target (say, `make dist`) to create the full distribution including the testsuite.\n\n> \n> How could I do the latter? I could of course add a patch in build/pkg/meataxe/patches. But that patch would be applied to the already *existing* sources that include tests.\n\n\nMaybe by letting `spkg-src` act as follows:\n- `git clone` the upstream repository\n- `git checkout` the specific commit that we are working with\n- `patch ...` applying a patch to the makefile\n- `make dist`.\n\nDoes that sound right, even though it would mean that the source tar ball of the spkg is *not* identical with upstream?",
    "created_at": "2016-03-30T16:32:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367153",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:28'></a>
Replying to [SimonKing](#comment%3A27):
> > I would try to convince upstream to either fix `make tar` or to add a new target (say, `make dist`) to create the full distribution including the testsuite.

> 
> How could I do the latter? I could of course add a patch in build/pkg/meataxe/patches. But that patch would be applied to the already *existing* sources that include tests.


Maybe by letting `spkg-src` act as follows:
- `git clone` the upstream repository
- `git checkout` the specific commit that we are working with
- `patch ...` applying a patch to the makefile
- `make dist`.

Does that sound right, even though it would mean that the source tar ball of the spkg is *not* identical with upstream?



---

archive/issue_comments_367154.json:
```json
{
    "body": "<a id='comment:29'></a>\nReplying to [SimonKing](#comment%3A28):\n> Does that sound right, even though it would mean that the source tar ball of the spkg is *not* identical with upstream?\n\n\nSounds right, but of course it would be better if upstream would add this patch (that's what I meant in [comment:25] too).",
    "created_at": "2016-03-30T17:15:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367154",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>
Replying to [SimonKing](#comment%3A28):
> Does that sound right, even though it would mean that the source tar ball of the spkg is *not* identical with upstream?


Sounds right, but of course it would be better if upstream would add this patch (that's what I meant in [comment:25] too).



---

archive/issue_comments_367155.json:
```json
{
    "body": "<a id='comment:30'></a>\nI think I will use the following patch to create a tarball containing the tests, with a version number that isn't just `2.5.0-SNAPSHOT` but is based on the hash of the commit being used:\n\n```diff\ndiff --git a/Makefile b/Makefile\nindex 935964b..9f14045 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -43,7 +43,7 @@ SILENT0=@\n SILENT1=\n SILENT=${SILENT${V}}\n \n-MTXVERSION = 2.5.0-SNAPSHOT\n+MTXVERSION = 2.5.0-$(shell git log -1 --format=\"%h\")\n \n CFLAGS=$(CFLAGS1) -I\"${MTXROOT}/include\" -Itmp \\\n  -DZZZ=${ZZZ} -DMTXLIB=\"${MTXLIB}\" -DMTXBIN=\"${MTXBIN}\"\n@@ -221,7 +221,7 @@ tmp/test-%.done: tests/common.sh tests/%/run $(PROGRAMS:%=${MTXBIN}/%)\n \t@touch \"$@\"\n \n \n-.PHONY: tar clean install test\n+.PHONY: tar dist clean install test\n .PRECIOUS: tmp/%.o\n \n \n@@ -264,6 +264,8 @@ EXPORTED_FILES =\\\n   Makefile README.md COPYING\\\n   src/meataxe.doc src/changelog.doc\\\n \n+TESTS = tests\n+\n tar: all doc\n \trm -f meataxe-${MTXVERSION} meataxe-${MTXVERSION}.tar meataxe-${MTXVERSION}.tar.gz \\\n \t&& ln -s . meataxe-${MTXVERSION} \\\n@@ -271,3 +273,11 @@ tar: all doc\n \t&& rm meataxe-${MTXVERSION} \\\n \t&& gzip meataxe-${MTXVERSION}.tar \\\n \t&& echo \"Created meataxe-${MTXVERSION}.tar.gz\"\n+\n+dist: all doc\n+\trm -f meataxe-${MTXVERSION} meataxe-${MTXVERSION}.tar meataxe-${MTXVERSION}.tar.gz \\\n+\t&& ln -s . meataxe-${MTXVERSION} \\\n+\t&& tar cf meataxe-${MTXVERSION}.tar $(EXPORTED_FILES:%=meataxe-${MTXVERSION}/%) meataxe-${MTXVERSION}/${TESTS} \\\n+\t&& rm meataxe-${MTXVERSION} \\\n+\t&& gzip meataxe-${MTXVERSION}.tar \\\n+\t&& echo \"Created meataxe-${MTXVERSION}.tar.gz including tests\"\n-- \n2.5.0\n```",
    "created_at": "2016-04-01T08:47:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367155",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:30'></a>
I think I will use the following patch to create a tarball containing the tests, with a version number that isn't just `2.5.0-SNAPSHOT` but is based on the hash of the commit being used:

```diff
diff --git a/Makefile b/Makefile
index 935964b..9f14045 100644
--- a/Makefile
+++ b/Makefile
@@ -43,7 +43,7 @@ SILENT0=@
 SILENT1=
 SILENT=${SILENT${V}}
 
-MTXVERSION = 2.5.0-SNAPSHOT
+MTXVERSION = 2.5.0-$(shell git log -1 --format="%h")
 
 CFLAGS=$(CFLAGS1) -I"${MTXROOT}/include" -Itmp \
  -DZZZ=${ZZZ} -DMTXLIB="${MTXLIB}" -DMTXBIN="${MTXBIN}"
@@ -221,7 +221,7 @@ tmp/test-%.done: tests/common.sh tests/%/run $(PROGRAMS:%=${MTXBIN}/%)
 	@touch "$@"
 
 
-.PHONY: tar clean install test
+.PHONY: tar dist clean install test
 .PRECIOUS: tmp/%.o
 
 
@@ -264,6 +264,8 @@ EXPORTED_FILES =\
   Makefile README.md COPYING\
   src/meataxe.doc src/changelog.doc\
 
+TESTS = tests
+
 tar: all doc
 	rm -f meataxe-${MTXVERSION} meataxe-${MTXVERSION}.tar meataxe-${MTXVERSION}.tar.gz \
 	&& ln -s . meataxe-${MTXVERSION} \
@@ -271,3 +273,11 @@ tar: all doc
 	&& rm meataxe-${MTXVERSION} \
 	&& gzip meataxe-${MTXVERSION}.tar \
 	&& echo "Created meataxe-${MTXVERSION}.tar.gz"
+
+dist: all doc
+	rm -f meataxe-${MTXVERSION} meataxe-${MTXVERSION}.tar meataxe-${MTXVERSION}.tar.gz \
+	&& ln -s . meataxe-${MTXVERSION} \
+	&& tar cf meataxe-${MTXVERSION}.tar $(EXPORTED_FILES:%=meataxe-${MTXVERSION}/%) meataxe-${MTXVERSION}/${TESTS} \
+	&& rm meataxe-${MTXVERSION} \
+	&& gzip meataxe-${MTXVERSION}.tar \
+	&& echo "Created meataxe-${MTXVERSION}.tar.gz including tests"
-- 
2.5.0
```



---

archive/issue_comments_367156.json:
```json
{
    "body": "<a id='comment:31'></a>\nGosh, I just realise that it won't work. It assumes that there is a git repository. Hence, that makefile did work for me, since I tested it in a clone of the upstream repository. But it won't work in the spkg, since it doesn't comprise the repository. Back to the drawing board.",
    "created_at": "2016-04-01T08:50:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367156",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:31'></a>
Gosh, I just realise that it won't work. It assumes that there is a git repository. Hence, that makefile did work for me, since I tested it in a clone of the upstream repository. But it won't work in the spkg, since it doesn't comprise the repository. Back to the drawing board.



---

archive/issue_comments_367157.json:
```json
{
    "body": "<a id='comment:32'></a>\nThe following should be a better idea for `spkg-src`:\n- `git clone` upstream.\n- `git checkout` the appropriate commit --- which is what one needs to change for upgrading the sources.\n- Apply the following general patch, that I will suggest to upstream:\n\n  ```diff\ndiff --git a/Makefile b/Makefile\nindex 935964b..49c2b86 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -221,7 +221,7 @@ tmp/test-%.done: tests/common.sh tests/%/run $(PROGRAMS:%=${MTXBIN}/%)\n \t@touch \"$@\"\n \n \n-.PHONY: tar clean install test\n+.PHONY: tar dist clean install test\n .PRECIOUS: tmp/%.o\n \n \n@@ -264,6 +264,8 @@ EXPORTED_FILES =\\\n   Makefile README.md COPYING\\\n   src/meataxe.doc src/changelog.doc\\\n \n+TESTS = tests\n+\n tar: all doc\n \trm -f meataxe-${MTXVERSION} meataxe-${MTXVERSION}.tar meataxe-${MTXVERSION}.tar.gz \\\n \t&& ln -s . meataxe-${MTXVERSION} \\\n@@ -271,3 +273,11 @@ tar: all doc\n \t&& rm meataxe-${MTXVERSION} \\\n \t&& gzip meataxe-${MTXVERSION}.tar \\\n \t&& echo \"Created meataxe-${MTXVERSION}.tar.gz\"\n+\n+dist: all doc\n+\trm -f meataxe-${MTXVERSION} meataxe-${MTXVERSION}.tar meataxe-${MTXVERSION}.tar.gz \\\n+\t&& ln -s . meataxe-${MTXVERSION} \\\n+\t&& tar cf meataxe-${MTXVERSION}.tar $(EXPORTED_FILES:%=meataxe-${MTXVERSION}/%) meataxe-${MTXVERSION}/${TESTS} \\\n+\t&& rm meataxe-${MTXVERSION} \\\n+\t&& gzip meataxe-${MTXVERSION}.tar \\\n+\t&& echo \"Created meataxe-${MTXVERSION}.tar.gz including tests\"\n-- \n  ```\n- Use `sed` to replace the word `-SNAPSHOT` in the Makefile by the current commit hash. That will work, because the spkg-src script *is* in a git repository at that point.\n- When building the spkg, there will be no git repository. But now, the commit number is hardcoded in the Makefile. The hardcoded number, however, will change automatically when changing the choice of commit in spkg-src.\n\nQuestion:\n\nIs it acceptable to add a general spkg-src, that takes the chosen commit of the upstream repository as an argument? In that way, one could obtain meataxe-2.5.0.123456.tar.gz for commit 123456 simply by calling `spkg-src 123456`.",
    "created_at": "2016-04-01T16:38:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367157",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:32'></a>
The following should be a better idea for `spkg-src`:
- `git clone` upstream.
- `git checkout` the appropriate commit --- which is what one needs to change for upgrading the sources.
- Apply the following general patch, that I will suggest to upstream:

  ```diff
diff --git a/Makefile b/Makefile
index 935964b..49c2b86 100644
--- a/Makefile
+++ b/Makefile
@@ -221,7 +221,7 @@ tmp/test-%.done: tests/common.sh tests/%/run $(PROGRAMS:%=${MTXBIN}/%)
 	@touch "$@"
 
 
-.PHONY: tar clean install test
+.PHONY: tar dist clean install test
 .PRECIOUS: tmp/%.o
 
 
@@ -264,6 +264,8 @@ EXPORTED_FILES =\
   Makefile README.md COPYING\
   src/meataxe.doc src/changelog.doc\
 
+TESTS = tests
+
 tar: all doc
 	rm -f meataxe-${MTXVERSION} meataxe-${MTXVERSION}.tar meataxe-${MTXVERSION}.tar.gz \
 	&& ln -s . meataxe-${MTXVERSION} \
@@ -271,3 +273,11 @@ tar: all doc
 	&& rm meataxe-${MTXVERSION} \
 	&& gzip meataxe-${MTXVERSION}.tar \
 	&& echo "Created meataxe-${MTXVERSION}.tar.gz"
+
+dist: all doc
+	rm -f meataxe-${MTXVERSION} meataxe-${MTXVERSION}.tar meataxe-${MTXVERSION}.tar.gz \
+	&& ln -s . meataxe-${MTXVERSION} \
+	&& tar cf meataxe-${MTXVERSION}.tar $(EXPORTED_FILES:%=meataxe-${MTXVERSION}/%) meataxe-${MTXVERSION}/${TESTS} \
+	&& rm meataxe-${MTXVERSION} \
+	&& gzip meataxe-${MTXVERSION}.tar \
+	&& echo "Created meataxe-${MTXVERSION}.tar.gz including tests"
-- 
  ```
- Use `sed` to replace the word `-SNAPSHOT` in the Makefile by the current commit hash. That will work, because the spkg-src script *is* in a git repository at that point.
- When building the spkg, there will be no git repository. But now, the commit number is hardcoded in the Makefile. The hardcoded number, however, will change automatically when changing the choice of commit in spkg-src.

Question:

Is it acceptable to add a general spkg-src, that takes the chosen commit of the upstream repository as an argument? In that way, one could obtain meataxe-2.5.0.123456.tar.gz for commit 123456 simply by calling `spkg-src 123456`.



---

archive/issue_comments_367158.json:
```json
{
    "body": "<a id='comment:33'></a>\nReplying to [SimonKing](#comment%3A32):\n> Is it acceptable to add a general spkg-src, that takes the chosen commit of the upstream repository as an argument? In that way, one could obtain meataxe-2.5.0.123456.tar.gz for commit 123456 simply by calling `spkg-src 123456`.\n\n\nI would advise against that, since `spkg-src` is not only a script but also serves as some kind of documentation of how the tarball was obtained. With that in mind, it's best if `spkg-src` is completely self-contained.",
    "created_at": "2016-04-01T17:38:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367158",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:33'></a>
Replying to [SimonKing](#comment%3A32):
> Is it acceptable to add a general spkg-src, that takes the chosen commit of the upstream repository as an argument? In that way, one could obtain meataxe-2.5.0.123456.tar.gz for commit 123456 simply by calling `spkg-src 123456`.


I would advise against that, since `spkg-src` is not only a script but also serves as some kind of documentation of how the tarball was obtained. With that in mind, it's best if `spkg-src` is completely self-contained.



---

archive/issue_comments_367159.json:
```json
{
    "body": "<a id='comment:34'></a>\nReplying to [jdemeyer](#comment%3A33):\n> I would advise against that, since `spkg-src` is not only a script but also serves as some kind of documentation of how the tarball was obtained. With that in mind, it's best if `spkg-src` is completely self-contained.\n\n\nThen I suggest `spkg-src` be the following:\n\n```/usr/bin/env bash\n\nCOMMIT=7c0bcf9\n\ngit clone https://github.com/momtx/meataxe.git\ncd meataxe\ngit checkout -b package $COMMIT\ngit apply ../spkg-src\ngit commit -a -m \"Add make target *dist*\"\nsed -i 's/-SNAPSHOT/.'$COMMIT'/' Makefile\nmake dist\ncd ..\nmv meataxe/meataxe-2.5.0.$COMMIT.tar.gz .\nrm -rf meataxe\nexit 0\n\n########################################\n\ndiff --git a/Makefile b/Makefile\nindex 935964b..49c2b86 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -221,7 +221,7 @@ tmp/test-%.done: tests/common.sh tests/%/run $(PROGRAMS:%=${MTXBIN}/%)\n \t@touch \"$@\"\n \n \n-.PHONY: tar clean install test\n+.PHONY: tar dist clean install test\n .PRECIOUS: tmp/%.o\n \n \n@@ -264,6 +264,8 @@ EXPORTED_FILES =\\\n   Makefile README.md COPYING\\\n   src/meataxe.doc src/changelog.doc\\\n \n+TESTS = tests\n+\n tar: all doc\n \trm -f meataxe-${MTXVERSION} meataxe-${MTXVERSION}.tar meataxe-${MTXVERSION}.tar.gz \\\n \t&& ln -s . meataxe-${MTXVERSION} \\\n@@ -271,3 +273,11 @@ tar: all doc\n \t&& rm meataxe-${MTXVERSION} \\\n \t&& gzip meataxe-${MTXVERSION}.tar \\\n \t&& echo \"Created meataxe-${MTXVERSION}.tar.gz\"\n+\n+dist: all doc\n+\trm -f meataxe-${MTXVERSION} meataxe-${MTXVERSION}.tar meataxe-${MTXVERSION}.tar.gz \\\n+\t&& ln -s . meataxe-${MTXVERSION} \\\n+\t&& tar cf meataxe-${MTXVERSION}.tar $(EXPORTED_FILES:%=meataxe-${MTXVERSION}/%) meataxe-${MTXVERSION}/${TESTS} \\\n+\t&& rm meataxe-${MTXVERSION} \\\n+\t&& gzip meataxe-${MTXVERSION}.tar \\\n+\t&& echo \"Created meataxe-${MTXVERSION}.tar.gz including tests\"\n-- \n2.5.0\n```\nIt provides the concrete commit of the snapshot, adds a `make dist` target that includes the test suite into the tarball, makes it so that the version number provides the concrete commit, creates the tar ball, and removes the temporary meataxe repository.\n\nThe only assumption is that the script is executed in the same directory in which it is stored, since it serves as a diff file to be applied to the Makefile.",
    "created_at": "2016-04-02T12:48:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367159",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:34'></a>
Replying to [jdemeyer](#comment%3A33):
> I would advise against that, since `spkg-src` is not only a script but also serves as some kind of documentation of how the tarball was obtained. With that in mind, it's best if `spkg-src` is completely self-contained.


Then I suggest `spkg-src` be the following:

```/usr/bin/env bash

COMMIT=7c0bcf9

git clone https://github.com/momtx/meataxe.git
cd meataxe
git checkout -b package $COMMIT
git apply ../spkg-src
git commit -a -m "Add make target *dist*"
sed -i 's/-SNAPSHOT/.'$COMMIT'/' Makefile
make dist
cd ..
mv meataxe/meataxe-2.5.0.$COMMIT.tar.gz .
rm -rf meataxe
exit 0

########################################

diff --git a/Makefile b/Makefile
index 935964b..49c2b86 100644
--- a/Makefile
+++ b/Makefile
@@ -221,7 +221,7 @@ tmp/test-%.done: tests/common.sh tests/%/run $(PROGRAMS:%=${MTXBIN}/%)
 	@touch "$@"
 
 
-.PHONY: tar clean install test
+.PHONY: tar dist clean install test
 .PRECIOUS: tmp/%.o
 
 
@@ -264,6 +264,8 @@ EXPORTED_FILES =\
   Makefile README.md COPYING\
   src/meataxe.doc src/changelog.doc\
 
+TESTS = tests
+
 tar: all doc
 	rm -f meataxe-${MTXVERSION} meataxe-${MTXVERSION}.tar meataxe-${MTXVERSION}.tar.gz \
 	&& ln -s . meataxe-${MTXVERSION} \
@@ -271,3 +273,11 @@ tar: all doc
 	&& rm meataxe-${MTXVERSION} \
 	&& gzip meataxe-${MTXVERSION}.tar \
 	&& echo "Created meataxe-${MTXVERSION}.tar.gz"
+
+dist: all doc
+	rm -f meataxe-${MTXVERSION} meataxe-${MTXVERSION}.tar meataxe-${MTXVERSION}.tar.gz \
+	&& ln -s . meataxe-${MTXVERSION} \
+	&& tar cf meataxe-${MTXVERSION}.tar $(EXPORTED_FILES:%=meataxe-${MTXVERSION}/%) meataxe-${MTXVERSION}/${TESTS} \
+	&& rm meataxe-${MTXVERSION} \
+	&& gzip meataxe-${MTXVERSION}.tar \
+	&& echo "Created meataxe-${MTXVERSION}.tar.gz including tests"
-- 
2.5.0
```
It provides the concrete commit of the snapshot, adds a `make dist` target that includes the test suite into the tarball, makes it so that the version number provides the concrete commit, creates the tar ball, and removes the temporary meataxe repository.

The only assumption is that the script is executed in the same directory in which it is stored, since it serves as a diff file to be applied to the Makefile.



---

archive/issue_comments_367160.json:
```json
{
    "body": "<a id='comment:35'></a>\nSee `build/pkgs/ecl/spkg-src` for a good example on how to deal with patches at packaging time. It also contains some boilerplate to protect against mistakes.",
    "created_at": "2016-04-02T12:50:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367160",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:35'></a>
See `build/pkgs/ecl/spkg-src` for a good example on how to deal with patches at packaging time. It also contains some boilerplate to protect against mistakes.



---

archive/issue_comments_367161.json:
```json
{
    "body": "<a id='comment:36'></a>\nReplying to [jdemeyer](#comment%3A35):\n> See `build/pkgs/ecl/spkg-src` for a good example on how to deal with patches at packaging time. It also contains some boilerplate to protect against mistakes.\n\n\nSo, basically you suggest that *all* my patches should be applied when creating the source ball, whereas I thought that the source ball should be as close to upstream as possible --- hence, only a small patch should be applied when creating the source ball, and everything else should be patched when the package will be installed.\n\nDo I understand correctly that it is fine to apply all patches, including Strassen-Winograd multiplication, *before* installing the package?",
    "created_at": "2016-04-02T13:10:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367161",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:36'></a>
Replying to [jdemeyer](#comment%3A35):
> See `build/pkgs/ecl/spkg-src` for a good example on how to deal with patches at packaging time. It also contains some boilerplate to protect against mistakes.


So, basically you suggest that *all* my patches should be applied when creating the source ball, whereas I thought that the source ball should be as close to upstream as possible --- hence, only a small patch should be applied when creating the source ball, and everything else should be patched when the package will be installed.

Do I understand correctly that it is fine to apply all patches, including Strassen-Winograd multiplication, *before* installing the package?



---

archive/issue_comments_367162.json:
```json
{
    "body": "<a id='comment:37'></a>\nReplying to [SimonKing](#comment%3A36):\n> Replying to [jdemeyer](#comment%3A35):\n> > See `build/pkgs/ecl/spkg-src` for a good example on how to deal with patches at packaging time. It also contains some boilerplate to protect against mistakes.\n\n> \n> So, basically you suggest that *all* my patches should be applied when creating the source ball\n\n\nNo! I am suggesting to split up your patches in two directories: one to be applied at install-time as usual and one to apply at packaging-time. Please have a closer look at the `build/pkgs/ecl/patches/` directory.",
    "created_at": "2016-04-02T13:14:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367162",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:37'></a>
Replying to [SimonKing](#comment%3A36):
> Replying to [jdemeyer](#comment%3A35):
> > See `build/pkgs/ecl/spkg-src` for a good example on how to deal with patches at packaging time. It also contains some boilerplate to protect against mistakes.

> 
> So, basically you suggest that *all* my patches should be applied when creating the source ball


No! I am suggesting to split up your patches in two directories: one to be applied at install-time as usual and one to apply at packaging-time. Please have a closer look at the `build/pkgs/ecl/patches/` directory.



---

archive/issue_comments_367163.json:
```json
{
    "body": "<a id='comment:38'></a>\nReplying to [jdemeyer](#comment%3A37):\n> No! I am suggesting to split up your patches in two directories: one to be applied at install-time as usual and one to apply at packaging-time. Please have a closer look at the `build/pkgs/ecl/patches/` directory.\n\n\nExactly. All patches in `build/pkgs/ecl/patches/` (`gmp.patch`, `implib.patch`, `write_error.patch`) are applied by `spkg-src`, which contains the lines\n\n```\n# the patches are applied here, as it has to be done before\n# running autoconf.\ncd src\necho \"applying patches in ecl-$ECLVERSION/src\"\n# For some of the patches, Cygwin also has upstream fixes that are\n# closely related, keep track.  See Trac 11119, for example.\nfor patch in ../../patches/*.patch; do\n    patch --verbose -p2 <\"$patch\"\n    if [ $? -ne 0 ]; then\n        echo >&2 \"Error applying '$patch'\"\n        exit 1\n    fi\ndone\n```\nThat's why I was asking.\n\nUnless there was a change since sage-7.1.",
    "created_at": "2016-04-02T13:42:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367163",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:38'></a>
Replying to [jdemeyer](#comment%3A37):
> No! I am suggesting to split up your patches in two directories: one to be applied at install-time as usual and one to apply at packaging-time. Please have a closer look at the `build/pkgs/ecl/patches/` directory.


Exactly. All patches in `build/pkgs/ecl/patches/` (`gmp.patch`, `implib.patch`, `write_error.patch`) are applied by `spkg-src`, which contains the lines

```
# the patches are applied here, as it has to be done before
# running autoconf.
cd src
echo "applying patches in ecl-$ECLVERSION/src"
# For some of the patches, Cygwin also has upstream fixes that are
# closely related, keep track.  See Trac 11119, for example.
for patch in ../../patches/*.patch; do
    patch --verbose -p2 <"$patch"
    if [ $? -ne 0 ]; then
        echo >&2 "Error applying '$patch'"
        exit 1
    fi
done
```
That's why I was asking.

Unless there was a change since sage-7.1.



---

archive/issue_comments_367164.json:
```json
{
    "body": "<a id='comment:39'></a>\nIn the most recent version it says\n\n```\nfor patch in ../patches/src/*.patch; do\n```\n`patches/src` contains `gmp.patch` and `implib.patch`.",
    "created_at": "2016-04-02T16:31:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367164",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:39'></a>
In the most recent version it says

```
for patch in ../patches/src/*.patch; do
```
`patches/src` contains `gmp.patch` and `implib.patch`.



---

archive/issue_comments_367165.json:
```json
{
    "body": "<a id='comment:40'></a>\nReplying to [jhpalmieri](#comment%3A39):\n> In the most recent version it says\n> \n> ```\n> for patch in ../patches/src/*.patch; do\n> ```\n> `patches/src` contains `gmp.patch` and `implib.patch`.\n\n\nIn my previous suggestion, I did not provide a separate patch but did everything in `spkg-src`, since I thought `spkg-src` was supposed to be self-contained. But if ../patches/ is allowed to serve a double purpose and if `spkg-src` may be \"incomplete\": Be it!",
    "created_at": "2016-04-02T20:24:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367165",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:40'></a>
Replying to [jhpalmieri](#comment%3A39):
> In the most recent version it says
> 
> ```
> for patch in ../patches/src/*.patch; do
> ```
> `patches/src` contains `gmp.patch` and `implib.patch`.


In my previous suggestion, I did not provide a separate patch but did everything in `spkg-src`, since I thought `spkg-src` was supposed to be self-contained. But if ../patches/ is allowed to serve a double purpose and if `spkg-src` may be "incomplete": Be it!



---

archive/issue_comments_367166.json:
```json
{
    "body": "<a id='comment:41'></a>\nI have an unexpected problem:\n\nWhen I am in a normal shell, the line `git clone https://github.com/momtx/meataxe.git` works fine.\n\nWhen I am in a Sage shell, the same line `git clone https://github.com/momtx/meataxe.git` results in\n\n```\nKlone nach 'meataxe' ...\nfatal: Unable to find remote helper for 'https'\n```\n\nWhat the heck...?",
    "created_at": "2016-04-05T14:25:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367166",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:41'></a>
I have an unexpected problem:

When I am in a normal shell, the line `git clone https://github.com/momtx/meataxe.git` works fine.

When I am in a Sage shell, the same line `git clone https://github.com/momtx/meataxe.git` results in

```
Klone nach 'meataxe' ...
fatal: Unable to find remote helper for 'https'
```

What the heck...?



---

archive/issue_comments_367167.json:
```json
{
    "body": "<a id='comment:42'></a>\nApparently Sage has built its own version of git. Why? I don't think I told it to.\n\nAnd why Sage hasn't built git with http support? That's a bit awkward for Sage development.",
    "created_at": "2016-04-05T14:39:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367167",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:42'></a>
Apparently Sage has built its own version of git. Why? I don't think I told it to.

And why Sage hasn't built git with http support? That's a bit awkward for Sage development.



---

archive/issue_comments_367168.json:
```json
{
    "body": "<a id='comment:43'></a>\nI was told on sage-devel that it is fine to provide a `spkg-src` script for usage *outside* of a Sage shell. Apparently only `spkg-install` and `spkg-check` are required to be executed in a Sage shell.\n\nA related question: Is it ok when `spkg-install` also executes MeatAxe's test suite if `SAGE_CHECK` is set? Or is `spkg-check` mandatory for tests?",
    "created_at": "2016-04-07T09:42:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367168",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:43'></a>
I was told on sage-devel that it is fine to provide a `spkg-src` script for usage *outside* of a Sage shell. Apparently only `spkg-install` and `spkg-check` are required to be executed in a Sage shell.

A related question: Is it ok when `spkg-install` also executes MeatAxe's test suite if `SAGE_CHECK` is set? Or is `spkg-check` mandatory for tests?



---

archive/issue_comments_367169.json:
```json
{
    "body": "<a id='comment:44'></a>\nReplying to [jdemeyer](#comment%3A24):\n> For the tables, I would prefer `DOT_SAGE`. Even if there are 255 tables, maybe that number will increase if larger fields are supported.\n\n\nCurrent status of my local branch is:\n- I am using the latest upstream snapshot, which says \"Fixes for AIX and 64-bit platforms, GCC 4.9 compiler warnings\". So, hopefully the \"unsigned versus signed char\" issue is fixed.\n- To change to a different commit in the upstream repository, it should be sufficient to change what is written in `package-version.txt`, and `spkg-src` will create the upstream tar ball (provided that it is executed in the directory in which `package-version.txt` is found).\n- The error propagation introduced by my patches does not cover all potential cases. But it seems to me that it is sufficient for the intended applications.\n- MeatAxe's test suite passes *after* applying my patches with Strassen multiplication and error propagation.\n- The tests in sage.matrix pass after changing one line number that appears in an error message.\n- The issue with multiplication tables polluting the current directory has yet to be fixed. According to your comment, I should rebase my old patch (which is easy), so that we can tell MeatAxe to put its tables into `DOT_SAGE`.",
    "created_at": "2016-04-07T09:53:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367169",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:44'></a>
Replying to [jdemeyer](#comment%3A24):
> For the tables, I would prefer `DOT_SAGE`. Even if there are 255 tables, maybe that number will increase if larger fields are supported.


Current status of my local branch is:
- I am using the latest upstream snapshot, which says "Fixes for AIX and 64-bit platforms, GCC 4.9 compiler warnings". So, hopefully the "unsigned versus signed char" issue is fixed.
- To change to a different commit in the upstream repository, it should be sufficient to change what is written in `package-version.txt`, and `spkg-src` will create the upstream tar ball (provided that it is executed in the directory in which `package-version.txt` is found).
- The error propagation introduced by my patches does not cover all potential cases. But it seems to me that it is sufficient for the intended applications.
- MeatAxe's test suite passes *after* applying my patches with Strassen multiplication and error propagation.
- The tests in sage.matrix pass after changing one line number that appears in an error message.
- The issue with multiplication tables polluting the current directory has yet to be fixed. According to your comment, I should rebase my old patch (which is easy), so that we can tell MeatAxe to put its tables into `DOT_SAGE`.



---

archive/issue_comments_367170.json:
```json
{
    "body": "<a id='comment:45'></a>\nReplying to [SimonKing](#comment%3A43):\n> I was told on sage-devel that it is fine to provide a `spkg-src` script for usage *outside* of a Sage shell.\n\n\n> Apparently only `spkg-install` and `spkg-check` are required to be executed in a Sage shell.\n\n\nRight, it's not required to run `spkg-src` in a Sage shell, it's just a sensible thing to do. For example, you would want to do `cd \"$SAGE_ROOT/build/pkgs/meataxe\" but that wouldn't work outside a Sage shell.\n\n> A related question: Is it ok when `spkg-install` also executes MeatAxe's test suite if `SAGE_CHECK` is set?\n\n\nI think you already asked this: it's not a problem.",
    "created_at": "2016-04-07T12:30:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367170",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:45'></a>
Replying to [SimonKing](#comment%3A43):
> I was told on sage-devel that it is fine to provide a `spkg-src` script for usage *outside* of a Sage shell.


> Apparently only `spkg-install` and `spkg-check` are required to be executed in a Sage shell.


Right, it's not required to run `spkg-src` in a Sage shell, it's just a sensible thing to do. For example, you would want to do `cd "$SAGE_ROOT/build/pkgs/meataxe" but that wouldn't work outside a Sage shell.

> A related question: Is it ok when `spkg-install` also executes MeatAxe's test suite if `SAGE_CHECK` is set?


I think you already asked this: it's not a problem.



---

archive/issue_comments_367171.json:
```json
{
    "body": "<a id='comment:46'></a>\nReplying to [jdemeyer](#comment%3A45):\n> Replying to [SimonKing](#comment%3A43):\n> > Apparently only `spkg-install` and `spkg-check` are required to be executed in a Sage shell.\n\n> \n> Right, it's not required to run `spkg-src` in a Sage shell, it's just a sensible thing to do. For example, you would want to do `cd \"$SAGE_ROOT/build/pkgs/meataxe\" but that wouldn't work outside a Sage shell.\n\n\nRight. That's why originally I wanted it to run in a Sage shell. But alas, Sage thought it was a good idea to build its own git and thought it was an even better idea to not support http.\n\n> > A related question: Is it ok when `spkg-install` also executes MeatAxe's test suite if `SAGE_CHECK` is set?\n\n> \n> I think you already asked this: it's not a problem.\n\n\nRight, sorry for asking twice.",
    "created_at": "2016-04-07T14:00:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367171",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:46'></a>
Replying to [jdemeyer](#comment%3A45):
> Replying to [SimonKing](#comment%3A43):
> > Apparently only `spkg-install` and `spkg-check` are required to be executed in a Sage shell.

> 
> Right, it's not required to run `spkg-src` in a Sage shell, it's just a sensible thing to do. For example, you would want to do `cd "$SAGE_ROOT/build/pkgs/meataxe" but that wouldn't work outside a Sage shell.


Right. That's why originally I wanted it to run in a Sage shell. But alas, Sage thought it was a good idea to build its own git and thought it was an even better idea to not support http.

> > A related question: Is it ok when `spkg-install` also executes MeatAxe's test suite if `SAGE_CHECK` is set?

> 
> I think you already asked this: it's not a problem.


Right, sorry for asking twice.



---

archive/issue_comments_367172.json:
```json
{
    "body": "<a id='comment:47'></a>\nSigh. The patch that makes MeatAxe read and write its tables in a prescribed directory makes its test suite fail. Which has not been the case for the previous MeatAxe version. Namely, it can't find certain files created during the tests.",
    "created_at": "2016-04-07T15:06:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367172",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:47'></a>
Sigh. The patch that makes MeatAxe read and write its tables in a prescribed directory makes its test suite fail. Which has not been the case for the previous MeatAxe version. Namely, it can't find certain files created during the tests.



---

archive/issue_comments_367173.json:
```json
{
    "body": "**Branch:** [u/SimonKing/various_meataxe_build_issues](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/various_meataxe_build_issues)",
    "created_at": "2016-04-07T16:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367173",
    "user": "https://github.com/simon-king-jena"
}
```

**Branch:** [u/SimonKing/various_meataxe_build_issues](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/various_meataxe_build_issues)



---

archive/issue_comments_367174.json:
```json
{
    "body": "**Commit:** [b6e16978528851ffb380449d72f3a529f543a4c9](https://github.com/sagemath/sagetrac-mirror/commit/b6e16978528851ffb380449d72f3a529f543a4c9)",
    "created_at": "2016-04-07T16:09:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367174",
    "user": "https://github.com/simon-king-jena"
}
```

**Commit:** [b6e16978528851ffb380449d72f3a529f543a4c9](https://github.com/sagemath/sagetrac-mirror/commit/b6e16978528851ffb380449d72f3a529f543a4c9)



---

archive/issue_comments_367175.json:
```json
{
    "body": "<a id='comment:49'></a>\nIt should be fine now. As far as I see,\n- I have addressed what we have discussed on the ticket,\n- MeatAxe's test suite passes when installing it with the \"-c\" option,\n- the test suite does not leave garbage behind in SAGE_LOCAL/lib nor in the current directory (it does temporarily create garbage in SAGE_LOCAL/lib, but `spkg-install` removes it),\n- the MeatAxe wrapper in Sage sets a C variable `MtxLibDir` to `$DOT_SAGE/meataxe/`, and one of the patches makes MeatAxe use it for its multiplication tables. Thus, again there should be no garbage created,\n- the tests in sage.matrix pass and indeed no garbage can be found afterwards --- the multiplication tables neatly appear in `DOT_SAGE/meataxe`.\n\n\nNeeds review, I'd say!\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b6e16978528851ffb380449d72f3a529f543a4c9\">b6e1697</a></td><td><code>Fix various MeatAxe build issues</code></td></tr></table>\n",
    "created_at": "2016-04-07T16:09:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367175",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:49'></a>
It should be fine now. As far as I see,
- I have addressed what we have discussed on the ticket,
- MeatAxe's test suite passes when installing it with the "-c" option,
- the test suite does not leave garbage behind in SAGE_LOCAL/lib nor in the current directory (it does temporarily create garbage in SAGE_LOCAL/lib, but `spkg-install` removes it),
- the MeatAxe wrapper in Sage sets a C variable `MtxLibDir` to `$DOT_SAGE/meataxe/`, and one of the patches makes MeatAxe use it for its multiplication tables. Thus, again there should be no garbage created,
- the tests in sage.matrix pass and indeed no garbage can be found afterwards --- the multiplication tables neatly appear in `DOT_SAGE/meataxe`.


Needs review, I'd say!

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b6e16978528851ffb380449d72f3a529f543a4c9">b6e1697</a></td><td><code>Fix various MeatAxe build issues</code></td></tr></table>




---

archive/issue_comments_367176.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2016-04-07T16:09:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367176",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_367177.json:
```json
{
    "body": "**Changing upstream** from \"Reported upstream. Developers acknowledge bug.\" to \"None of the above - read trac for reasoning.\".",
    "created_at": "2016-04-07T16:10:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367177",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing upstream** from "Reported upstream. Developers acknowledge bug." to "None of the above - read trac for reasoning.".



---

archive/issue_comments_367178.json:
```json
{
    "body": "**Author:** Simon King",
    "created_at": "2016-04-07T16:47:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367178",
    "user": "https://github.com/jdemeyer"
}
```

**Author:** Simon King



---

archive/issue_comments_367179.json:
```json
{
    "body": "**Reviewer:** Jeroen Demeyer",
    "created_at": "2016-04-07T16:47:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367179",
    "user": "https://github.com/jdemeyer"
}
```

**Reviewer:** Jeroen Demeyer



---

archive/issue_comments_367180.json:
```json
{
    "body": "<a id='comment:51'></a>\nJust looking at `spkg-src` for now...\n\n1. I think it's better if it can be executed from `$SAGE_ROOT`, so I would add `cd build/pkgs/meataxe` in the beginning.\n\n2. You should move the tarball to `$SAGE_DISTFILES` (I know this isn't a Sage shell, but you could do something like `./sage --sh -c 'mv .... \"$SAGE_DISTFILES\"'`\n\n3. Remove the `# commented out code`.\n\n4. I don't see the point of `git commit -a -m \"Add make target *dist*\"` since the tarball shouldn't contain the git repo.",
    "created_at": "2016-04-07T16:47:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367180",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:51'></a>
Just looking at `spkg-src` for now...

1. I think it's better if it can be executed from `$SAGE_ROOT`, so I would add `cd build/pkgs/meataxe` in the beginning.

2. You should move the tarball to `$SAGE_DISTFILES` (I know this isn't a Sage shell, but you could do something like `./sage --sh -c 'mv .... "$SAGE_DISTFILES"'`

3. Remove the `# commented out code`.

4. I don't see the point of `git commit -a -m "Add make target *dist*"` since the tarball shouldn't contain the git repo.



---

archive/issue_events_062298.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-04-07T16:47:46Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "milestone": "sage-7.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20136#event-62298"
}
```



---

archive/issue_events_062299.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "rename": {
        "from": "Various meataxe build issues",
        "to": "Upgrade meataxe and fix some build issues"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20136#event-62299"
}
```



---

archive/issue_comments_367181.json:
```json
{
    "body": "<a id='comment:52'></a>\nDid you submit your patches upstream? If yes, how, and was there any reaction?",
    "created_at": "2016-04-07T16:48:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367181",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:52'></a>
Did you submit your patches upstream? If yes, how, and was there any reaction?



---

archive/issue_comments_367182.json:
```json
{
    "body": "<a id='comment:53'></a>\nReplying to [jdemeyer](#comment%3A52):\n> Did you submit your patches upstream? If yes, how, and was there any reaction?\n\n\nMy \"old\" patches have been submitted upstream, by mail to Prof. Ringe.\n\nA part of my old patches has been applied upstream: The \"tweaks\" for echelon form computation. Main tool is a function that does \"addmul\" for a *part* of a matrix row (in the original upstream implementation, \"addmul\" has always added complete rows, which is a waste of time during echelon computation, as one knows that the row starts with zeroes).\n\nHowever, upstream has changed my function: I gave an initial position of the row segment to be added, *and* its length. Upstream just gives the initial position of the row segment and assumed that *everything* after the initial position will be added. That's fine for echelon computation, but I need to be able to operate on row segments of a given length, simply since Strassen multiplication acts on matrix windows.\n\nHence, I kept upstream's modification of my \"partial addmul\" function for echelon computation, and I put my original \"partial addmul\" function into src/window.c (which is where I implemented Winograd-Strassen multiplication).\n\nApparently upstream sees no reason to prescribe a directory for multiplication at run time. They think it is enough to try to read it from \"$MTX_ROOT/lib/\", not even from a *subdirectory* of \"$MTX_ROOT/lib\" (where MTX_ROOT typically is /local/ or $SAGE_ROOT), and create the tables in the current directory if it cannot be found in \"$MTX_ROOT/lib\".\nHere I strongly disagree. /local/lib/ is a place for libraries, not for computational data. And the current directory should be kept clean.\n\nAlso I don't know if upstream really cares about error propagation, since it seems that the default way of dealing with errors is to print an error message and exit (I would qualify that as \"crash\").\n\nIn any case, I will send my rebased patches to Ringe soon.",
    "created_at": "2016-04-07T20:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367182",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:53'></a>
Replying to [jdemeyer](#comment%3A52):
> Did you submit your patches upstream? If yes, how, and was there any reaction?


My "old" patches have been submitted upstream, by mail to Prof. Ringe.

A part of my old patches has been applied upstream: The "tweaks" for echelon form computation. Main tool is a function that does "addmul" for a *part* of a matrix row (in the original upstream implementation, "addmul" has always added complete rows, which is a waste of time during echelon computation, as one knows that the row starts with zeroes).

However, upstream has changed my function: I gave an initial position of the row segment to be added, *and* its length. Upstream just gives the initial position of the row segment and assumed that *everything* after the initial position will be added. That's fine for echelon computation, but I need to be able to operate on row segments of a given length, simply since Strassen multiplication acts on matrix windows.

Hence, I kept upstream's modification of my "partial addmul" function for echelon computation, and I put my original "partial addmul" function into src/window.c (which is where I implemented Winograd-Strassen multiplication).

Apparently upstream sees no reason to prescribe a directory for multiplication at run time. They think it is enough to try to read it from "$MTX_ROOT/lib/", not even from a *subdirectory* of "$MTX_ROOT/lib" (where MTX_ROOT typically is /local/ or $SAGE_ROOT), and create the tables in the current directory if it cannot be found in "$MTX_ROOT/lib".
Here I strongly disagree. /local/lib/ is a place for libraries, not for computational data. And the current directory should be kept clean.

Also I don't know if upstream really cares about error propagation, since it seems that the default way of dealing with errors is to print an error message and exit (I would qualify that as "crash").

In any case, I will send my rebased patches to Ringe soon.



---

archive/issue_comments_367183.json:
```json
{
    "body": "<a id='comment:54'></a>\nReplying to [jdemeyer](#comment%3A51):\n> Just looking at `spkg-src` for now...\n> \n> 1. I think it's better if it can be executed from `$SAGE_ROOT`, so I would add `cd build/pkgs/meataxe` in the beginning.\n\n\nAs long as it is not to be executed in a sage shell...\n\n> 2. You should move the tarball to `$SAGE_DISTFILES` (I know this isn't a Sage shell, but you could do something like `./sage --sh -c 'mv .... \"$SAGE_DISTFILES\"'`\n\n\nInteresting usage of \"sage -sh\"! So, \"$SAGE_DISTFILES\" is \"$SAGE_ROOT/upstream/\"?\n\nI tried `./sage --sh -c COMMIT=$COMMIT 'mv build/pkgs/meataxe/meataxe/meataxe-2.5.0.$COMMIT.tar.gz \"$SAGE_DISTFILES\"'`, but\n1. it didn't work\n2. it didn't exit with an error although it didn't work.\n\nSo, what am I doing wrong?\n\n> 3. Remove the `# commented out code`.\n\n\nSorry, I guess it was \"WIP\"...\n\n> 4. I don't see the point of `git commit -a -m \"Add make target *dist*\"` since the tarball shouldn't contain the git repo.\n\n\nRight.",
    "created_at": "2016-04-07T20:31:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367183",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:54'></a>
Replying to [jdemeyer](#comment%3A51):
> Just looking at `spkg-src` for now...
> 
> 1. I think it's better if it can be executed from `$SAGE_ROOT`, so I would add `cd build/pkgs/meataxe` in the beginning.


As long as it is not to be executed in a sage shell...

> 2. You should move the tarball to `$SAGE_DISTFILES` (I know this isn't a Sage shell, but you could do something like `./sage --sh -c 'mv .... "$SAGE_DISTFILES"'`


Interesting usage of "sage -sh"! So, "$SAGE_DISTFILES" is "$SAGE_ROOT/upstream/"?

I tried `./sage --sh -c COMMIT=$COMMIT 'mv build/pkgs/meataxe/meataxe/meataxe-2.5.0.$COMMIT.tar.gz "$SAGE_DISTFILES"'`, but
1. it didn't work
2. it didn't exit with an error although it didn't work.

So, what am I doing wrong?

> 3. Remove the `# commented out code`.


Sorry, I guess it was "WIP"...

> 4. I don't see the point of `git commit -a -m "Add make target *dist*"` since the tarball shouldn't contain the git repo.


Right.



---

archive/issue_comments_367184.json:
```json
{
    "body": "<a id='comment:55'></a>\nReplying to [SimonKing](#comment%3A54):\n> So, what am I doing wrong?\n\n\nI don't think you can do `sh -c VAR=something \"command\"`, that's just invalid. What should work is\n\n```\nexport VAR=something\nsh -c \"command\"\n```\nThat's also more readable.",
    "created_at": "2016-04-07T20:36:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367184",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:55'></a>
Replying to [SimonKing](#comment%3A54):
> So, what am I doing wrong?


I don't think you can do `sh -c VAR=something "command"`, that's just invalid. What should work is

```
export VAR=something
sh -c "command"
```
That's also more readable.



---

archive/issue_comments_367185.json:
```json
{
    "body": "<a id='comment:56'></a>\nIt seems that `./sage --sh -c 'mv build/pkgs/meataxe/meataxe/meataxe-2.5.0.$COMMIT.tar.gz \"$SAGE_DISTFILES\"' COMMIT=$COMMIT` works. But if it is better readable, I'll export COMMIT.",
    "created_at": "2016-04-07T20:37:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367185",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:56'></a>
It seems that `./sage --sh -c 'mv build/pkgs/meataxe/meataxe/meataxe-2.5.0.$COMMIT.tar.gz "$SAGE_DISTFILES"' COMMIT=$COMMIT` works. But if it is better readable, I'll export COMMIT.



---

archive/issue_comments_367186.json:
```json
{
    "body": "<a id='comment:57'></a>\nJust add `export` on this line\n\n```\nCOMMIT=$(cat package-version.txt | cut -d'.' -f4)\n```",
    "created_at": "2016-04-07T20:40:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367186",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:57'></a>
Just add `export` on this line

```
COMMIT=$(cat package-version.txt | cut -d'.' -f4)
```



---

archive/issue_comments_367187.json:
```json
{
    "body": "<a id='comment:58'></a>\nI am a bit puzzled by Sage's behaviour. I forgot to do `./sage -fix-pkg-checksums` after creating the new tarball. Rather than aborting and complaining about a wrong checksum, Sage *deleted* the tarball that I just put into SAGE_ROOT/upstream!",
    "created_at": "2016-04-07T20:45:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367187",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:58'></a>
I am a bit puzzled by Sage's behaviour. I forgot to do `./sage -fix-pkg-checksums` after creating the new tarball. Rather than aborting and complaining about a wrong checksum, Sage *deleted* the tarball that I just put into SAGE_ROOT/upstream!



---

archive/issue_comments_367188.json:
```json
{
    "body": "<a id='comment:59'></a>\nReplying to [SimonKing](#comment%3A58):\n> Rather than aborting and complaining about a wrong checksum\n\n\nI think this is mainly meant to make automatic testing easier... but I agree it's not really user-friendly.",
    "created_at": "2016-04-07T20:47:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367188",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:59'></a>
Replying to [SimonKing](#comment%3A58):
> Rather than aborting and complaining about a wrong checksum


I think this is mainly meant to make automatic testing easier... but I agree it's not really user-friendly.



---

archive/issue_comments_367189.json:
```json
{
    "body": "**Changing commit** from \"[b6e16978528851ffb380449d72f3a529f543a4c9](https://github.com/sagemath/sagetrac-mirror/commit/b6e16978528851ffb380449d72f3a529f543a4c9)\" to \"[96fc74f2b7d5aa908d28376673e014828375e4c7](https://github.com/sagemath/sagetrac-mirror/commit/96fc74f2b7d5aa908d28376673e014828375e4c7)\".",
    "created_at": "2016-04-07T20:48:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367189",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

**Changing commit** from "[b6e16978528851ffb380449d72f3a529f543a4c9](https://github.com/sagemath/sagetrac-mirror/commit/b6e16978528851ffb380449d72f3a529f543a4c9)" to "[96fc74f2b7d5aa908d28376673e014828375e4c7](https://github.com/sagemath/sagetrac-mirror/commit/96fc74f2b7d5aa908d28376673e014828375e4c7)".



---

archive/issue_comments_367190.json:
```json
{
    "body": "<a id='comment:60'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/96fc74f2b7d5aa908d28376673e014828375e4c7\">96fc74f</a></td><td><code>Sanitise meataxe's spkg-src script</code></td></tr></table>\n",
    "created_at": "2016-04-07T20:48:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367190",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:60'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/96fc74f2b7d5aa908d28376673e014828375e4c7">96fc74f</a></td><td><code>Sanitise meataxe's spkg-src script</code></td></tr></table>




---

archive/issue_comments_367191.json:
```json
{
    "body": "<a id='comment:61'></a>\nBetter?",
    "created_at": "2016-04-07T20:49:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367191",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:61'></a>
Better?



---

archive/issue_comments_367192.json:
```json
{
    "body": "<a id='comment:62'></a>\nI've been trying to help install Sage with meataxe in a multiuser environment at UMN, and we ran into problems with meataxe looking for files in each user's `DOT_SAGE` folder. So I feel we should change the behavior to install/lookup the necessary files in some subdirectory of `SAGE_LOCAL`.",
    "created_at": "2016-04-15T15:54:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367192",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:62'></a>
I've been trying to help install Sage with meataxe in a multiuser environment at UMN, and we ran into problems with meataxe looking for files in each user's `DOT_SAGE` folder. So I feel we should change the behavior to install/lookup the necessary files in some subdirectory of `SAGE_LOCAL`.



---

archive/issue_comments_367193.json:
```json
{
    "body": "<a id='comment:63'></a>\nIt depends on whether meataxe will be writing to those files after installation, because at that point it won't necessarily have write access to `SAGE_LOCAL`. I don't know the answer to this, though. Can it look in both places?",
    "created_at": "2016-04-15T16:09:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367193",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:63'></a>
It depends on whether meataxe will be writing to those files after installation, because at that point it won't necessarily have write access to `SAGE_LOCAL`. I don't know the answer to this, though. Can it look in both places?



---

archive/issue_comments_367194.json:
```json
{
    "body": "<a id='comment:64'></a>\nIn order to use meataxe, you need to rebuild Sage because of the optional extension. So I would think you would need a certain amount of write access. Although if that is an issue, I think one way we can fix it all is during installation, there could be a flag which we set that determines where the data files are written to and read from. Otherwise I am not sure how to make this really usable in a multiuser environment.",
    "created_at": "2016-04-16T03:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367194",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:64'></a>
In order to use meataxe, you need to rebuild Sage because of the optional extension. So I would think you would need a certain amount of write access. Although if that is an issue, I think one way we can fix it all is during installation, there could be a flag which we set that determines where the data files are written to and read from. Otherwise I am not sure how to make this really usable in a multiuser environment.



---

archive/issue_comments_367195.json:
```json
{
    "body": "<a id='comment:65'></a>\nReplying to [tscrim](#comment%3A64):\n> In order to use meataxe, you need to rebuild Sage because of the optional extension. So I would think you would need a certain amount of write access.\n\n\nDuring *installation* of the package, of course it is granted that the person who is installing it has write access to SAGE_LOCAL. However, during *usage* of Sage, it is granted that the user has *read* access to SAGE_LOCAL and *write* access to DOT_SAGE, but not necessarily write access to SAGE_LOCAL.\n\n> Although if that is an issue, I think one way we can fix it all is during installation, there could be a flag which we set that determines where the data files are written to and read from. Otherwise I am not sure how to make this really usable in a multiuser environment.\n\n\nOf course it is usable in a multiuser environment, because it is not a problem if each user has her own copy of the multiplication tables.\n\n\nI think I have explained above the three possible approaches that one could take:\n\n- Current approach I take: Patch MeatAxe, so that it becomes possible to set a flag at run time telling MeatAxe to read tables from and write tables to a specified directory. Since it is during run time, it **must** be a directory where the user has write access, hence, DOT_SAGE but not SAGE_LOCAL.\n\n- Alternative approach: By a relatively recent upstream change, MeatAxe would finally read from, but still not *write* into, the directory `MTX_ROOT/lib`, where `MTX_ROOT` is the directory into which MeatAxe is installed; if a table cannot be found there, upstream would write into the current directory, which may be forbidden for the Sage user, resulting in an error (or without my patches, it wouldn't give an error but just crash). Of course we would have `MTX_ROOT=$SAGE_LOCAL`. Consequences:\n    1. It would become mandatory to write *all* multiplication tables during installation of the package, since otherwise write permission cannot be granted and since we don't want the current directory to be polluted.\n    2. We would never be able to use the \"big\" MeatAxe kernel for large field sizes, simply since it wouldn't be feasible to compute and write ten thousands of multiplication tables during installation. However, the big kernel isn't officially supported by upstream nowadays.\n    3. As I said, upstream would use `MTX_ROOT/lib`, i.e. `SAGE_LOCAL/lib`, for its tables --- but that's awful. To the very least, it should use a single sub-directory such as `MTX_ROOT/lib/meataxe_tables` for that purpose. Hence, we would need yet another patch to upstream.\n- Mixed approach: Patch MeatAxe as in the current approach, use a single location to which all users have read but not necessarily write permission, and create the tables during package installation.",
    "created_at": "2016-04-16T05:35:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367195",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:65'></a>
Replying to [tscrim](#comment%3A64):
> In order to use meataxe, you need to rebuild Sage because of the optional extension. So I would think you would need a certain amount of write access.


During *installation* of the package, of course it is granted that the person who is installing it has write access to SAGE_LOCAL. However, during *usage* of Sage, it is granted that the user has *read* access to SAGE_LOCAL and *write* access to DOT_SAGE, but not necessarily write access to SAGE_LOCAL.

> Although if that is an issue, I think one way we can fix it all is during installation, there could be a flag which we set that determines where the data files are written to and read from. Otherwise I am not sure how to make this really usable in a multiuser environment.


Of course it is usable in a multiuser environment, because it is not a problem if each user has her own copy of the multiplication tables.


I think I have explained above the three possible approaches that one could take:

- Current approach I take: Patch MeatAxe, so that it becomes possible to set a flag at run time telling MeatAxe to read tables from and write tables to a specified directory. Since it is during run time, it **must** be a directory where the user has write access, hence, DOT_SAGE but not SAGE_LOCAL.

- Alternative approach: By a relatively recent upstream change, MeatAxe would finally read from, but still not *write* into, the directory `MTX_ROOT/lib`, where `MTX_ROOT` is the directory into which MeatAxe is installed; if a table cannot be found there, upstream would write into the current directory, which may be forbidden for the Sage user, resulting in an error (or without my patches, it wouldn't give an error but just crash). Of course we would have `MTX_ROOT=$SAGE_LOCAL`. Consequences:
    1. It would become mandatory to write *all* multiplication tables during installation of the package, since otherwise write permission cannot be granted and since we don't want the current directory to be polluted.
    2. We would never be able to use the "big" MeatAxe kernel for large field sizes, simply since it wouldn't be feasible to compute and write ten thousands of multiplication tables during installation. However, the big kernel isn't officially supported by upstream nowadays.
    3. As I said, upstream would use `MTX_ROOT/lib`, i.e. `SAGE_LOCAL/lib`, for its tables --- but that's awful. To the very least, it should use a single sub-directory such as `MTX_ROOT/lib/meataxe_tables` for that purpose. Hence, we would need yet another patch to upstream.
- Mixed approach: Patch MeatAxe as in the current approach, use a single location to which all users have read but not necessarily write permission, and create the tables during package installation.



---

archive/issue_comments_367196.json:
```json
{
    "body": "<a id='comment:66'></a>\nI reported the following issue on sage-devel https://groups.google.com/forum/?fromgroups#!topic/sage-devel/aMuSDOjCbR0\nI am not sure whether this upgrade will fix it.",
    "created_at": "2016-09-21T12:47:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367196",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

<a id='comment:66'></a>
I reported the following issue on sage-devel https://groups.google.com/forum/?fromgroups#!topic/sage-devel/aMuSDOjCbR0
I am not sure whether this upgrade will fix it.



---

archive/issue_comments_367197.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2017-01-09T12:48:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367197",
    "user": "https://github.com/simon-king-jena"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_367198.json:
```json
{
    "body": "<a id='comment:67'></a>\nApparently the branch doesn't apply.",
    "created_at": "2017-01-09T12:48:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20136#issuecomment-367198",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:67'></a>
Apparently the branch doesn't apply.
