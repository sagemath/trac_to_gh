# Issue 20680: Some optimizations for addition in combinatorial free modules and dict_* methods

archive/issues_020443.json:
```json
{
    "assignees": [
        "https://github.com/sagetrac-sage-combinat"
    ],
    "body": "<div id=\"comment:0\"></div>\n\nWe improve the speed of methods like `dict_addition` in order to improve the speed of addition in `CombinatorialFreeModule`.\n\nCC:  @sagetrac-sage-combinat @nthiery\n\nComponent: **performance**\n\nKeywords: **combinatorial free module, addition, days79**\n\nAuthor: **Travis Scrimshaw, Nicolas M. Thi\u00e9ry**\n\nBranch/Commit: **[`95aacfa`](https://github.com/sagemath/sagetrac-mirror/commit/95aacfad48240dc6fa943ba3a67dd1006f2088d7)**\n\nReviewer: **Nicolas M. Thi\u00e9ry, Jeroen Demeyer**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/20680_\n\n",
    "closed_at": "2016-12-05T00:44:31Z",
    "created_at": "2016-05-25T15:35:23Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/performance",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-7.5",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Some optimizations for addition in combinatorial free modules and dict_* methods",
    "type": "issue",
    "updated_at": "2016-12-05T00:44:31Z",
    "url": "https://github.com/sagemath/sage/issues/20680",
    "user": "https://github.com/tscrim"
}
```
<div id="comment:0"></div>

We improve the speed of methods like `dict_addition` in order to improve the speed of addition in `CombinatorialFreeModule`.

CC:  @sagetrac-sage-combinat @nthiery

Component: **performance**

Keywords: **combinatorial free module, addition, days79**

Author: **Travis Scrimshaw, Nicolas M. Thiéry**

Branch/Commit: **[`95aacfa`](https://github.com/sagemath/sagetrac-mirror/commit/95aacfad48240dc6fa943ba3a67dd1006f2088d7)**

Reviewer: **Nicolas M. Thiéry, Jeroen Demeyer**

_Issue created by migration from https://trac.sagemath.org/ticket/20680_





---

archive/issue_events_288555.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-05-25T15:35:23Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "milestone_number": null,
    "milestone_title": "sage-7.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288555"
}
```



---

archive/issue_events_288556.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-05-25T15:35:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "label": "https://github.com/sagemath/sage/labels/performance",
    "label_color": "696969",
    "label_name": "performance",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288556"
}
```



---

archive/issue_events_288557.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-05-25T15:35:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288557"
}
```



---

archive/issue_events_288558.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-05-25T15:35:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288558"
}
```



---

archive/issue_events_288559.json:
```json
{
    "actor": "https://github.com/sagetrac-sage-combinat",
    "created_at": "2016-05-25T15:35:23Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "subject": "https://github.com/tscrim",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288559"
}
```



---

archive/issue_comments_298915.json:
```json
{
    "body": "Branch: **[public/combinat/improve_dict_addition-20680](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/improve_dict_addition-20680)**",
    "created_at": "2016-05-25T15:36:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298915",
    "user": "https://github.com/tscrim"
}
```

Branch: **[public/combinat/improve_dict_addition-20680](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/improve_dict_addition-20680)**



---

archive/issue_comments_298916.json:
```json
{
    "body": "Commit: **[`d5646a4`](https://github.com/sagemath/sagetrac-mirror/commit/d5646a4e1a2c6f0575ca90b02085417b676e34dd)**",
    "created_at": "2016-05-25T15:36:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298916",
    "user": "https://github.com/tscrim"
}
```

Commit: **[`d5646a4`](https://github.com/sagemath/sagetrac-mirror/commit/d5646a4e1a2c6f0575ca90b02085417b676e34dd)**



---

archive/issue_events_288560.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-05-25T15:36:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288560"
}
```



---

archive/issue_comments_298917.json:
```json
{
    "body": "<div id=\"comment:2\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/73738691dc6449692b56d4fb5957bf8d17e6e97d\"><code>7373869</code></a></td><td><code>Speedup and improvement to dictionary addition and related methods.</code></td></tr></table>\n",
    "created_at": "2016-05-25T15:37:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298917",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:2"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/73738691dc6449692b56d4fb5957bf8d17e6e97d"><code>7373869</code></a></td><td><code>Speedup and improvement to dictionary addition and related methods.</code></td></tr></table>




---

archive/issue_comments_298918.json:
```json
{
    "body": "Changed commit from **[`d5646a4`](https://github.com/sagemath/sagetrac-mirror/commit/d5646a4e1a2c6f0575ca90b02085417b676e34dd)** to **[`7373869`](https://github.com/sagemath/sagetrac-mirror/commit/73738691dc6449692b56d4fb5957bf8d17e6e97d)**",
    "created_at": "2016-05-25T15:37:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298918",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`d5646a4`](https://github.com/sagemath/sagetrac-mirror/commit/d5646a4e1a2c6f0575ca90b02085417b676e34dd)** to **[`7373869`](https://github.com/sagemath/sagetrac-mirror/commit/73738691dc6449692b56d4fb5957bf8d17e6e97d)**



---

archive/issue_comments_298919.json:
```json
{
    "body": "<div id=\"comment:3\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f0821047288ebd5d964a9888c7872b962e9fef37\"><code>f082104</code></a></td><td><code>Reviewer changes by Nicolas.</code></td></tr></table>\n",
    "created_at": "2016-05-25T16:00:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298919",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:3"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f0821047288ebd5d964a9888c7872b962e9fef37"><code>f082104</code></a></td><td><code>Reviewer changes by Nicolas.</code></td></tr></table>




---

archive/issue_comments_298920.json:
```json
{
    "body": "Changed commit from **[`7373869`](https://github.com/sagemath/sagetrac-mirror/commit/73738691dc6449692b56d4fb5957bf8d17e6e97d)** to **[`f082104`](https://github.com/sagemath/sagetrac-mirror/commit/f0821047288ebd5d964a9888c7872b962e9fef37)**",
    "created_at": "2016-05-25T16:00:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298920",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`7373869`](https://github.com/sagemath/sagetrac-mirror/commit/73738691dc6449692b56d4fb5957bf8d17e6e97d)** to **[`f082104`](https://github.com/sagemath/sagetrac-mirror/commit/f0821047288ebd5d964a9888c7872b962e9fef37)**



---

archive/issue_events_288561.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-05-26T06:06:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288561"
}
```



---

archive/issue_events_288562.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-05-26T06:06:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288562"
}
```



---

archive/issue_comments_298921.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nHmmm...slightly worrisome that there is an ordering change to elements in that failing `categories/finite_dimensional_algebras_with_basis.py` test, to which this ticket should not have caused AFAICS. Will investigate.",
    "created_at": "2016-05-26T06:06:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298921",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:4" align="right">comment:4</div>

Hmmm...slightly worrisome that there is an ordering change to elements in that failing `categories/finite_dimensional_algebras_with_basis.py` test, to which this ticket should not have caused AFAICS. Will investigate.



---

archive/issue_comments_298922.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nSo what the issue is is that the example finite monoid does not have an ordering of its elements. What I am thinking of doing is implementing a `_cmp_` by using the `_cmp_by_value` of `ElementWrapper`. This will make this doctest far less fragile in the future (it's somewhat surprising it is not machine dependent as is), but it then becomes less of a minimal implementation.",
    "created_at": "2016-05-26T06:13:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298922",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:5" align="right">comment:5</div>

So what the issue is is that the example finite monoid does not have an ordering of its elements. What I am thinking of doing is implementing a `_cmp_` by using the `_cmp_by_value` of `ElementWrapper`. This will make this doctest far less fragile in the future (it's somewhat surprising it is not machine dependent as is), but it then becomes less of a minimal implementation.



---

archive/issue_events_288563.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-05-26T06:13:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288563"
}
```



---

archive/issue_events_288564.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-05-26T06:13:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288564"
}
```



---

archive/issue_comments_298923.json:
```json
{
    "body": "Changed commit from **[`f082104`](https://github.com/sagemath/sagetrac-mirror/commit/f0821047288ebd5d964a9888c7872b962e9fef37)** to **[`d2a704c`](https://github.com/sagemath/sagetrac-mirror/commit/d2a704c007f069b4c232ad0557c08610fcc33e22)**",
    "created_at": "2016-05-26T09:30:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298923",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`f082104`](https://github.com/sagemath/sagetrac-mirror/commit/f0821047288ebd5d964a9888c7872b962e9fef37)** to **[`d2a704c`](https://github.com/sagemath/sagetrac-mirror/commit/d2a704c007f069b4c232ad0557c08610fcc33e22)**



---

archive/issue_comments_298924.json:
```json
{
    "body": "<div id=\"comment:6\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/d2a704c007f069b4c232ad0557c08610fcc33e22\"><code>d2a704c</code></a></td><td><code>20680: define a total order on Monoids().Finite().example() for more deterministic tests</code></td></tr></table>\n",
    "created_at": "2016-05-26T09:30:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298924",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:6"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/d2a704c007f069b4c232ad0557c08610fcc33e22"><code>d2a704c</code></a></td><td><code>20680: define a total order on Monoids().Finite().example() for more deterministic tests</code></td></tr></table>




---

archive/issue_comments_298925.json:
```json
{
    "body": "Changed commit from **[`d2a704c`](https://github.com/sagemath/sagetrac-mirror/commit/d2a704c007f069b4c232ad0557c08610fcc33e22)** to **[`4e912ff`](https://github.com/sagemath/sagetrac-mirror/commit/4e912ffa8f94a2b0053487434c8a8d0249b39177)**",
    "created_at": "2016-05-26T09:53:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298925",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`d2a704c`](https://github.com/sagemath/sagetrac-mirror/commit/d2a704c007f069b4c232ad0557c08610fcc33e22)** to **[`4e912ff`](https://github.com/sagemath/sagetrac-mirror/commit/4e912ffa8f94a2b0053487434c8a8d0249b39177)**



---

archive/issue_comments_298926.json:
```json
{
    "body": "<div id=\"comment:7\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4e912ffa8f94a2b0053487434c8a8d0249b39177\"><code>4e912ff</code></a></td><td><code>Merge branch 'develop' into t/20680/public/combinat/improve_dict_addition-20680</code></td></tr></table>\n",
    "created_at": "2016-05-26T09:53:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298926",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:7"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4e912ffa8f94a2b0053487434c8a8d0249b39177"><code>4e912ff</code></a></td><td><code>Merge branch 'develop' into t/20680/public/combinat/improve_dict_addition-20680</code></td></tr></table>




---

archive/issue_comments_298927.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nIs there anything combinatorics-specific to `dict_addition.pyx`? If not, it should not be in the `combinat` directory. Perhaps move to `data_structures`?",
    "created_at": "2016-05-26T12:46:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298927",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:8" align="right">comment:8</div>

Is there anything combinatorics-specific to `dict_addition.pyx`? If not, it should not be in the `combinat` directory. Perhaps move to `data_structures`?



---

archive/issue_comments_298928.json:
```json
{
    "body": "Work Issues: **Move from combinat**",
    "created_at": "2016-05-26T12:49:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298928",
    "user": "https://github.com/jdemeyer"
}
```

Work Issues: **Move from combinat**



---

archive/issue_comments_298929.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nHere are some benchmarks, first with plain Sage 5.3, then with\nTravis's optimizations, and then after the code refactorization of\ncommit ee10e70daec5704b4f2c8f63c2cf2e3c525e9311. Sorry that's a bit\nlong; the timings fluctuate quite some which makes it painful to do.\n\nRough interpretation: with Travis optimization the speed gain\nfluctuates between 1 and 3, and the refactorization does no harm, and\ncould even improve slightly the situation.\n\n# Protocol\n\nFor each n=0,1000,2000,4000, we time the addition of two dictionaries\nof length n. Three times for overlapping dictionaries, three times for\nhalf overlapping dictionaries, three times for non overlapping\ndictionaries.\n\n```\n    def Xn(n): return { i:i for i in range(n) }\n    def Yn(n): return { i:i for i in range(n,2*n) }\n    def Zn(n): return { i:i for i in range(2*n,3*n) }\n```\n\n# Sage 5.3\n\nSetup:\n\n```\n    sage: blasadd = sage.combinat.dict_addition.dict_addition\n```\nRunning the tests for a given n:\n\n```\n    X = Xn(n); Y = Yn(n); Z = Zn(n)\n    %timeit blasadd([X,X])\n    %timeit blasadd([X,X])\n    %timeit blasadd([X,X])\n    %timeit blasadd([X,Y])\n    %timeit blasadd([X,Y])\n    %timeit blasadd([X,Y])\n    %timeit blasadd([X,Z])\n    %timeit blasadd([X,Z])\n    %timeit blasadd([X,Z])\n```\n\nTimings:\n\n```\n    n = 0\n    1000000 loops, best of 3: 1.12 \u00b5s per loop\n    1000000 loops, best of 3: 662 ns per loop\n    1000000 loops, best of 3: 684 ns per loop\n\n    1000000 loops, best of 3: 646 ns per loop\n    1000000 loops, best of 3: 1.04 \u00b5s per loop\n    1000000 loops, best of 3: 941 ns per loop\n\n    1000000 loops, best of 3: 918 ns per loop\n    1000000 loops, best of 3: 705 ns per loop\n    1000000 loops, best of 3: 670 ns per loop\n\n    n = 1000\n    1000 loops, best of 3: 365 \u00b5s per loop\n    1000 loops, best of 3: 405 \u00b5s per loop\n    1000 loops, best of 3: 402 \u00b5s per loop\n\n    1000 loops, best of 3: 462 \u00b5s per loop\n    1000 loops, best of 3: 212 \u00b5s per loop\n    1000 loops, best of 3: 376 \u00b5s per loop\n\n    1000 loops, best of 3: 465 \u00b5s per loop\n    1000 loops, best of 3: 481 \u00b5s per loop\n    1000 loops, best of 3: 467 \u00b5s per loop\n\n    n=2000\n    1000 loops, best of 3: 835 \u00b5s per loop\n    1000 loops, best of 3: 369 \u00b5s per loop\n    1000 loops, best of 3: 785 \u00b5s per loop\n\n    1000 loops, best of 3: 504 \u00b5s per loop\n    1000 loops, best of 3: 968 \u00b5s per loop\n    1000 loops, best of 3: 561 \u00b5s per loop\n\n    1000 loops, best of 3: 618 \u00b5s per loop\n    1000 loops, best of 3: 675 \u00b5s per loop\n    1000 loops, best of 3: 1.02 ms per loop\n\n    n=4000\n    1000 loops, best of 3: 1.11 ms per loop\n    1000 loops, best of 3: 1.19 ms per loop\n    1000 loops, best of 3: 1.17 ms per loop\n\n    1000 loops, best of 3: 1.82 ms per loop\n    1000 loops, best of 3: 1.67 ms per loop\n    1000 loops, best of 3: 1.5 ms per loop\n\n    100 loops, best of 3: 2.02 ms per loop\n    100 loops, best of 3: 1.1 ms per loop\n    1000 loops, best of 3: 1.53 ms per loop\n```\n\n# Travis's optimization\n\nSetup:\n\n```\n    blasadd = sage.combinat.dict_addition.dict_add\n```\nRunning the tests for a given n:\n\n```\n    X = Xn(n); Y = Yn(n); Z = Zn(n)\n    %timeit blasadd(X,X)\n    %timeit blasadd(X,X)\n    %timeit blasadd(X,X)\n    %timeit blasadd(X,Y)\n    %timeit blasadd(X,Y)\n    %timeit blasadd(X,Y)\n    %timeit blasadd(X,Z)\n    %timeit blasadd(X,Z)\n    %timeit blasadd(X,Z)\n```\n\n\nTimings:\n\n```\n    n = 0:\n    1000000 loops, best of 3: 677 ns per loop\n    1000000 loops, best of 3: 574 ns per loop\n    1000000 loops, best of 3: 1.01 \u00b5s per loop\n\n    1000000 loops, best of 3: 985 ns per loop\n    1000000 loops, best of 3: 640 ns per loop\n    1000000 loops, best of 3: 635 ns per loop\n\n    1000000 loops, best of 3: 664 ns per loop\n    1000000 loops, best of 3: 489 ns per loop\n    1000000 loops, best of 3: 600 ns per loop\n\n    n = 1000: ~.3ms\n    1000 loops, best of 3: 357 \u00b5s per loop\n    1000 loops, best of 3: 353 \u00b5s per loop\n    1000 loops, best of 3: 373 \u00b5s per loop\n\n    1000 loops, best of 3: 282 \u00b5s per loop\n    1000 loops, best of 3: 283 \u00b5s per loop\n    1000 loops, best of 3: 259 \u00b5s per loop\n\n    1000 loops, best of 3: 302 \u00b5s per loop\n    1000 loops, best of 3: 315 \u00b5s per loop\n    1000 loops, best of 3: 313 \u00b5s per loop\n\n    n = 2000: .7ms\n    1000 loops, best of 3: 787 \u00b5s per loop\n    1000 loops, best of 3: 778 \u00b5s per loop\n    1000 loops, best of 3: 747 \u00b5s per loop\n\n    1000 loops, best of 3: 175 \u00b5s per loop\n    1000 loops, best of 3: 343 \u00b5s per loop\n    1000 loops, best of 3: 256 \u00b5s per loop\n\n    1000 loops, best of 3: 682 \u00b5s per loop\n    1000 loops, best of 3: 330 \u00b5s per loop\n    1000 loops, best of 3: 662 \u00b5s per loop\n\n    n = 4000: 1.2ms\n    1000 loops, best of 3: 1.15 ms per loop\n    1000 loops, best of 3: 1.46 ms per loop\n    1000 loops, best of 3: 1.2 ms per loop\n\n    1000 loops, best of 3: 1.11 ms per loop\n    1000 loops, best of 3: 1.09 ms per loop\n    1000 loops, best of 3: 800 \u00b5s per loop\n\n    1000 loops, best of 3: 985 \u00b5s per loop\n    1000 loops, best of 3: 915 \u00b5s per loop\n    1000 loops, best of 3: 1.08 ms per loop\n```\n\n# After blas-style refactorization\n\nSetup:\n\n```\n    blasadd = sage.data_structures.blas_dict.add\n```\nRunning the tests for a given n:\n\n```\n    X = Xn(n); Y = Yn(n); Z = Zn(n)\n    %timeit blasadd(X,X)\n    %timeit blasadd(X,X)\n    %timeit blasadd(X,X)\n    %timeit blasadd(X,Y)\n    %timeit blasadd(X,Y)\n    %timeit blasadd(X,Y)\n    %timeit blasadd(X,Z)\n    %timeit blasadd(X,Z)\n    %timeit blasadd(X,Z)\n```\n\nTimings::\n\n```\n    n=0: ~.2ms\n    1000000 loops, best of 3: 578 ns per loop\n    1000000 loops, best of 3: 603 ns per loop\n    1000000 loops, best of 3: 227 ns per loop\n\n    1000000 loops, best of 3: 226 ns per loop\n    1000000 loops, best of 3: 391 ns per loop\n    1000000 loops, best of 3: 572 ns per loop\n\n    1000000 loops, best of 3: 566 ns per loop\n    10000000 loops, best of 3: 515 ns per loop\n    1000000 loops, best of 3: 217 ns per loop\n\n    n=1000: ~.3ms\n    10000 loops, best of 3: 299 \u00b5s per loop\n    1000 loops, best of 3: 351 \u00b5s per loop\n    1000 loops, best of 3: 334 \u00b5s per loop\n\n    1000 loops, best of 3: 256 \u00b5s per loop\n    1000 loops, best of 3: 255 \u00b5s per loop\n    1000 loops, best of 3: 258 \u00b5s per loop\n\n    1000 loops, best of 3: 78.1 \u00b5s per loop\n    1000 loops, best of 3: 279 \u00b5s per loop\n    1000 loops, best of 3: 283 \u00b5s per loop\n\n    n = 2000: ~.6s\n    1000 loops, best of 3: 704 \u00b5s per loop\n    1000 loops, best of 3: 709 \u00b5s per loop\n    1000 loops, best of 3: 697 \u00b5s per loop\n\n    1000 loops, best of 3: 174 \u00b5s per loop\n    1000 loops, best of 3: 334 \u00b5s per loop\n    10000 loops, best of 3: 502 \u00b5s per loop\n\n    1000 loops, best of 3: 204 \u00b5s per loop\n    1000 loops, best of 3: 612 \u00b5s per loop\n    1000 loops, best of 3: 591 \u00b5s per loop\n\n    n = 4000: ~1 ms\n    1000 loops, best of 3: 1 ms per loop\n    1000 loops, best of 3: 960 \u00b5s per loop\n    1000 loops, best of 3: 903 \u00b5s per loop\n\n    1000 loops, best of 3: 658 \u00b5s per loop\n    1000 loops, best of 3: 1.04 ms per loop\n    1000 loops, best of 3: 723 \u00b5s per loop\n\n    1000 loops, best of 3: 1.15 ms per loop\n    1000 loops, best of 3: 1.16 ms per loop\n    1000 loops, best of 3: 984 \u00b5s per loop\n```",
    "created_at": "2016-11-21T14:07:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298929",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:10" align="right">comment:10</div>

Here are some benchmarks, first with plain Sage 5.3, then with
Travis's optimizations, and then after the code refactorization of
commit ee10e70daec5704b4f2c8f63c2cf2e3c525e9311. Sorry that's a bit
long; the timings fluctuate quite some which makes it painful to do.

Rough interpretation: with Travis optimization the speed gain
fluctuates between 1 and 3, and the refactorization does no harm, and
could even improve slightly the situation.

# Protocol

For each n=0,1000,2000,4000, we time the addition of two dictionaries
of length n. Three times for overlapping dictionaries, three times for
half overlapping dictionaries, three times for non overlapping
dictionaries.

```
    def Xn(n): return { i:i for i in range(n) }
    def Yn(n): return { i:i for i in range(n,2*n) }
    def Zn(n): return { i:i for i in range(2*n,3*n) }
```

# Sage 5.3

Setup:

```
    sage: blasadd = sage.combinat.dict_addition.dict_addition
```
Running the tests for a given n:

```
    X = Xn(n); Y = Yn(n); Z = Zn(n)
    %timeit blasadd([X,X])
    %timeit blasadd([X,X])
    %timeit blasadd([X,X])
    %timeit blasadd([X,Y])
    %timeit blasadd([X,Y])
    %timeit blasadd([X,Y])
    %timeit blasadd([X,Z])
    %timeit blasadd([X,Z])
    %timeit blasadd([X,Z])
```

Timings:

```
    n = 0
    1000000 loops, best of 3: 1.12 µs per loop
    1000000 loops, best of 3: 662 ns per loop
    1000000 loops, best of 3: 684 ns per loop

    1000000 loops, best of 3: 646 ns per loop
    1000000 loops, best of 3: 1.04 µs per loop
    1000000 loops, best of 3: 941 ns per loop

    1000000 loops, best of 3: 918 ns per loop
    1000000 loops, best of 3: 705 ns per loop
    1000000 loops, best of 3: 670 ns per loop

    n = 1000
    1000 loops, best of 3: 365 µs per loop
    1000 loops, best of 3: 405 µs per loop
    1000 loops, best of 3: 402 µs per loop

    1000 loops, best of 3: 462 µs per loop
    1000 loops, best of 3: 212 µs per loop
    1000 loops, best of 3: 376 µs per loop

    1000 loops, best of 3: 465 µs per loop
    1000 loops, best of 3: 481 µs per loop
    1000 loops, best of 3: 467 µs per loop

    n=2000
    1000 loops, best of 3: 835 µs per loop
    1000 loops, best of 3: 369 µs per loop
    1000 loops, best of 3: 785 µs per loop

    1000 loops, best of 3: 504 µs per loop
    1000 loops, best of 3: 968 µs per loop
    1000 loops, best of 3: 561 µs per loop

    1000 loops, best of 3: 618 µs per loop
    1000 loops, best of 3: 675 µs per loop
    1000 loops, best of 3: 1.02 ms per loop

    n=4000
    1000 loops, best of 3: 1.11 ms per loop
    1000 loops, best of 3: 1.19 ms per loop
    1000 loops, best of 3: 1.17 ms per loop

    1000 loops, best of 3: 1.82 ms per loop
    1000 loops, best of 3: 1.67 ms per loop
    1000 loops, best of 3: 1.5 ms per loop

    100 loops, best of 3: 2.02 ms per loop
    100 loops, best of 3: 1.1 ms per loop
    1000 loops, best of 3: 1.53 ms per loop
```

# Travis's optimization

Setup:

```
    blasadd = sage.combinat.dict_addition.dict_add
```
Running the tests for a given n:

```
    X = Xn(n); Y = Yn(n); Z = Zn(n)
    %timeit blasadd(X,X)
    %timeit blasadd(X,X)
    %timeit blasadd(X,X)
    %timeit blasadd(X,Y)
    %timeit blasadd(X,Y)
    %timeit blasadd(X,Y)
    %timeit blasadd(X,Z)
    %timeit blasadd(X,Z)
    %timeit blasadd(X,Z)
```


Timings:

```
    n = 0:
    1000000 loops, best of 3: 677 ns per loop
    1000000 loops, best of 3: 574 ns per loop
    1000000 loops, best of 3: 1.01 µs per loop

    1000000 loops, best of 3: 985 ns per loop
    1000000 loops, best of 3: 640 ns per loop
    1000000 loops, best of 3: 635 ns per loop

    1000000 loops, best of 3: 664 ns per loop
    1000000 loops, best of 3: 489 ns per loop
    1000000 loops, best of 3: 600 ns per loop

    n = 1000: ~.3ms
    1000 loops, best of 3: 357 µs per loop
    1000 loops, best of 3: 353 µs per loop
    1000 loops, best of 3: 373 µs per loop

    1000 loops, best of 3: 282 µs per loop
    1000 loops, best of 3: 283 µs per loop
    1000 loops, best of 3: 259 µs per loop

    1000 loops, best of 3: 302 µs per loop
    1000 loops, best of 3: 315 µs per loop
    1000 loops, best of 3: 313 µs per loop

    n = 2000: .7ms
    1000 loops, best of 3: 787 µs per loop
    1000 loops, best of 3: 778 µs per loop
    1000 loops, best of 3: 747 µs per loop

    1000 loops, best of 3: 175 µs per loop
    1000 loops, best of 3: 343 µs per loop
    1000 loops, best of 3: 256 µs per loop

    1000 loops, best of 3: 682 µs per loop
    1000 loops, best of 3: 330 µs per loop
    1000 loops, best of 3: 662 µs per loop

    n = 4000: 1.2ms
    1000 loops, best of 3: 1.15 ms per loop
    1000 loops, best of 3: 1.46 ms per loop
    1000 loops, best of 3: 1.2 ms per loop

    1000 loops, best of 3: 1.11 ms per loop
    1000 loops, best of 3: 1.09 ms per loop
    1000 loops, best of 3: 800 µs per loop

    1000 loops, best of 3: 985 µs per loop
    1000 loops, best of 3: 915 µs per loop
    1000 loops, best of 3: 1.08 ms per loop
```

# After blas-style refactorization

Setup:

```
    blasadd = sage.data_structures.blas_dict.add
```
Running the tests for a given n:

```
    X = Xn(n); Y = Yn(n); Z = Zn(n)
    %timeit blasadd(X,X)
    %timeit blasadd(X,X)
    %timeit blasadd(X,X)
    %timeit blasadd(X,Y)
    %timeit blasadd(X,Y)
    %timeit blasadd(X,Y)
    %timeit blasadd(X,Z)
    %timeit blasadd(X,Z)
    %timeit blasadd(X,Z)
```

Timings::

```
    n=0: ~.2ms
    1000000 loops, best of 3: 578 ns per loop
    1000000 loops, best of 3: 603 ns per loop
    1000000 loops, best of 3: 227 ns per loop

    1000000 loops, best of 3: 226 ns per loop
    1000000 loops, best of 3: 391 ns per loop
    1000000 loops, best of 3: 572 ns per loop

    1000000 loops, best of 3: 566 ns per loop
    10000000 loops, best of 3: 515 ns per loop
    1000000 loops, best of 3: 217 ns per loop

    n=1000: ~.3ms
    10000 loops, best of 3: 299 µs per loop
    1000 loops, best of 3: 351 µs per loop
    1000 loops, best of 3: 334 µs per loop

    1000 loops, best of 3: 256 µs per loop
    1000 loops, best of 3: 255 µs per loop
    1000 loops, best of 3: 258 µs per loop

    1000 loops, best of 3: 78.1 µs per loop
    1000 loops, best of 3: 279 µs per loop
    1000 loops, best of 3: 283 µs per loop

    n = 2000: ~.6s
    1000 loops, best of 3: 704 µs per loop
    1000 loops, best of 3: 709 µs per loop
    1000 loops, best of 3: 697 µs per loop

    1000 loops, best of 3: 174 µs per loop
    1000 loops, best of 3: 334 µs per loop
    10000 loops, best of 3: 502 µs per loop

    1000 loops, best of 3: 204 µs per loop
    1000 loops, best of 3: 612 µs per loop
    1000 loops, best of 3: 591 µs per loop

    n = 4000: ~1 ms
    1000 loops, best of 3: 1 ms per loop
    1000 loops, best of 3: 960 µs per loop
    1000 loops, best of 3: 903 µs per loop

    1000 loops, best of 3: 658 µs per loop
    1000 loops, best of 3: 1.04 ms per loop
    1000 loops, best of 3: 723 µs per loop

    1000 loops, best of 3: 1.15 ms per loop
    1000 loops, best of 3: 1.16 ms per loop
    1000 loops, best of 3: 984 µs per loop
```



---

archive/issue_comments_298930.json:
```json
{
    "body": "Changed commit from **[`4e912ff`](https://github.com/sagemath/sagetrac-mirror/commit/4e912ffa8f94a2b0053487434c8a8d0249b39177)** to **[`300b5e7`](https://github.com/sagemath/sagetrac-mirror/commit/300b5e7884d72cbaf72ae76e2011a48cd1b4a98a)**",
    "created_at": "2016-11-21T14:07:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298930",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`4e912ff`](https://github.com/sagemath/sagetrac-mirror/commit/4e912ffa8f94a2b0053487434c8a8d0249b39177)** to **[`300b5e7`](https://github.com/sagemath/sagetrac-mirror/commit/300b5e7884d72cbaf72ae76e2011a48cd1b4a98a)**



---

archive/issue_comments_298931.json:
```json
{
    "body": "<div id=\"comment:11\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ee10e70daec5704b4f2c8f63c2cf2e3c525e9311\"><code>ee10e70</code></a></td><td><code>20680: refactored the internal dict_* methods of (Combinatorial)FreeModule with a BLAS-style API</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/18dcef32070643b2b2933c0087822aa86e8909b8\"><code>18dcef3</code></a></td><td><code>Merge branch 'develop' into t/20680/public/combinat/improve_dict_addition-20680</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bff94d1acf7404af449a098c093ca298f192d1b4\"><code>bff94d1</code></a></td><td><code>20680: typo fix</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/300b5e7884d72cbaf72ae76e2011a48cd1b4a98a\"><code>300b5e7</code></a></td><td><code>20680: micro bug fix (wrong argument order)</code></td></tr></table>\n",
    "created_at": "2016-11-21T14:07:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298931",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:11"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ee10e70daec5704b4f2c8f63c2cf2e3c525e9311"><code>ee10e70</code></a></td><td><code>20680: refactored the internal dict_* methods of (Combinatorial)FreeModule with a BLAS-style API</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/18dcef32070643b2b2933c0087822aa86e8909b8"><code>18dcef3</code></a></td><td><code>Merge branch 'develop' into t/20680/public/combinat/improve_dict_addition-20680</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bff94d1acf7404af449a098c093ca298f192d1b4"><code>bff94d1</code></a></td><td><code>20680: typo fix</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/300b5e7884d72cbaf72ae76e2011a48cd1b4a98a"><code>300b5e7</code></a></td><td><code>20680: micro bug fix (wrong argument order)</code></td></tr></table>




---

archive/issue_comments_298932.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@jdemeyer](#comment%3A8):\n> Is there anything combinatorics-specific to `dict_addition.pyx`? If not, it should not be in the `combinat` directory. Perhaps move to `data_structures`?\n\nI agree. I'll chat with Travis here for whether we do it now or in a later ticket.",
    "created_at": "2016-11-21T14:10:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298932",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@jdemeyer](#comment%3A8):
> Is there anything combinatorics-specific to `dict_addition.pyx`? If not, it should not be in the `combinat` directory. Perhaps move to `data_structures`?

I agree. I'll chat with Travis here for whether we do it now or in a later ticket.



---

archive/issue_comments_298933.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nAfter discussion with Travis:\n- We will move it now\n- A bit of hesitation between `sage.modules` and `sage.data_structures`; Travis is more in favor of the latter.\n\nAny opinion?\n\nI'll fix some remaining doctest failures in the mean time.",
    "created_at": "2016-11-21T19:47:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298933",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:13" align="right">comment:13</div>

After discussion with Travis:
- We will move it now
- A bit of hesitation between `sage.modules` and `sage.data_structures`; Travis is more in favor of the latter.

Any opinion?

I'll fix some remaining doctest failures in the mean time.



---

archive/issue_comments_298934.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nI also mentioned earlier that `data_structures` seems like a better choice.",
    "created_at": "2016-11-22T07:36:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298934",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:14" align="right">comment:14</div>

I also mentioned earlier that `data_structures` seems like a better choice.



---

archive/issue_comments_298935.json:
```json
{
    "body": "<div id=\"comment:15\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7a8fd3afad7633faf625226111ac6187ef6feca9\"><code>7a8fd3a</code></a></td><td><code>20680: update other locations where dict_addition and friends were used.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c858683124fd4a24b328f2622bfbd1c5557443c1\"><code>c858683</code></a></td><td><code>20680: fix bug in the copy-optimization which caused input of axpy to be mutated.</code></td></tr></table>\n",
    "created_at": "2016-11-22T07:45:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298935",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:15"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7a8fd3afad7633faf625226111ac6187ef6feca9"><code>7a8fd3a</code></a></td><td><code>20680: update other locations where dict_addition and friends were used.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c858683124fd4a24b328f2622bfbd1c5557443c1"><code>c858683</code></a></td><td><code>20680: fix bug in the copy-optimization which caused input of axpy to be mutated.</code></td></tr></table>




---

archive/issue_comments_298936.json:
```json
{
    "body": "Changed commit from **[`300b5e7`](https://github.com/sagemath/sagetrac-mirror/commit/300b5e7884d72cbaf72ae76e2011a48cd1b4a98a)** to **[`c858683`](https://github.com/sagemath/sagetrac-mirror/commit/c858683124fd4a24b328f2622bfbd1c5557443c1)**",
    "created_at": "2016-11-22T07:45:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298936",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`300b5e7`](https://github.com/sagemath/sagetrac-mirror/commit/300b5e7884d72cbaf72ae76e2011a48cd1b4a98a)** to **[`c858683`](https://github.com/sagemath/sagetrac-mirror/commit/c858683124fd4a24b328f2622bfbd1c5557443c1)**



---

archive/issue_comments_298937.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@jdemeyer](#comment%3A14):\n> I also mentioned earlier that `data_structures` seems like a better choice.\n\nYour comment was about `data_structures` versus `combinat`, when we are hesitating between `modules` and `data_structures` :-)\n\nI'll do the move this afternoon.",
    "created_at": "2016-11-22T08:46:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298937",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@jdemeyer](#comment%3A14):
> I also mentioned earlier that `data_structures` seems like a better choice.

Your comment was about `data_structures` versus `combinat`, when we are hesitating between `modules` and `data_structures` :-)

I'll do the move this afternoon.



---

archive/issue_comments_298938.json:
```json
{
    "body": "Changed commit from **[`c858683`](https://github.com/sagemath/sagetrac-mirror/commit/c858683124fd4a24b328f2622bfbd1c5557443c1)** to **[`be78e1f`](https://github.com/sagemath/sagetrac-mirror/commit/be78e1feb7c584d56168da7cc31c990d61c818af)**",
    "created_at": "2016-11-23T13:56:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298938",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`c858683`](https://github.com/sagemath/sagetrac-mirror/commit/c858683124fd4a24b328f2622bfbd1c5557443c1)** to **[`be78e1f`](https://github.com/sagemath/sagetrac-mirror/commit/be78e1feb7c584d56168da7cc31c990d61c818af)**



---

archive/issue_comments_298939.json:
```json
{
    "body": "<div id=\"comment:17\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/be78e1feb7c584d56168da7cc31c990d61c818af\"><code>be78e1f</code></a></td><td><code>20680: refactored the logic of dict_addition.iaxpy for speed (hopefully) and compactness</code></td></tr></table>\n",
    "created_at": "2016-11-23T13:56:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298939",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:17"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/be78e1feb7c584d56168da7cc31c990d61c818af"><code>be78e1f</code></a></td><td><code>20680: refactored the logic of dict_addition.iaxpy for speed (hopefully) and compactness</code></td></tr></table>




---

archive/issue_comments_298940.json:
```json
{
    "body": "<div id=\"comment:18\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9d053f6db00c04d8328f2a1a2276f9a2d57fa38e\"><code>9d053f6</code></a></td><td><code>20680: move sage.combinat.dict_addition -> sage.data_structures.blas_dict: first step</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/cbad8d438cd3bf4a82dd5dc4447206719b8467bf\"><code>cbad8d4</code></a></td><td><code>20680: move sage.combinat.dict_addition -> sage.data_structures.blas_dict: second step</code></td></tr></table>\n",
    "created_at": "2016-11-23T14:06:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298940",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:18"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9d053f6db00c04d8328f2a1a2276f9a2d57fa38e"><code>9d053f6</code></a></td><td><code>20680: move sage.combinat.dict_addition -> sage.data_structures.blas_dict: first step</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/cbad8d438cd3bf4a82dd5dc4447206719b8467bf"><code>cbad8d4</code></a></td><td><code>20680: move sage.combinat.dict_addition -> sage.data_structures.blas_dict: second step</code></td></tr></table>




---

archive/issue_comments_298941.json:
```json
{
    "body": "Changed commit from **[`be78e1f`](https://github.com/sagemath/sagetrac-mirror/commit/be78e1feb7c584d56168da7cc31c990d61c818af)** to **[`cbad8d4`](https://github.com/sagemath/sagetrac-mirror/commit/cbad8d438cd3bf4a82dd5dc4447206719b8467bf)**",
    "created_at": "2016-11-23T14:06:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298941",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`be78e1f`](https://github.com/sagemath/sagetrac-mirror/commit/be78e1feb7c584d56168da7cc31c990d61c818af)** to **[`cbad8d4`](https://github.com/sagemath/sagetrac-mirror/commit/cbad8d438cd3bf4a82dd5dc4447206719b8467bf)**



---

archive/issue_comments_298942.json:
```json
{
    "body": "<div id=\"comment:19\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7749836d15037a61a2f028c33f23580892a81fe1\"><code>7749836</code></a></td><td><code>20680: updated the deprecation aliases w.r.t. the previous move and documented that deprecation</code></td></tr></table>\n",
    "created_at": "2016-11-23T14:16:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298942",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:19"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7749836d15037a61a2f028c33f23580892a81fe1"><code>7749836</code></a></td><td><code>20680: updated the deprecation aliases w.r.t. the previous move and documented that deprecation</code></td></tr></table>




---

archive/issue_comments_298943.json:
```json
{
    "body": "Changed commit from **[`cbad8d4`](https://github.com/sagemath/sagetrac-mirror/commit/cbad8d438cd3bf4a82dd5dc4447206719b8467bf)** to **[`7749836`](https://github.com/sagemath/sagetrac-mirror/commit/7749836d15037a61a2f028c33f23580892a81fe1)**",
    "created_at": "2016-11-23T14:16:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298943",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`cbad8d4`](https://github.com/sagemath/sagetrac-mirror/commit/cbad8d438cd3bf4a82dd5dc4447206719b8467bf)** to **[`7749836`](https://github.com/sagemath/sagetrac-mirror/commit/7749836d15037a61a2f028c33f23580892a81fe1)**



---

archive/issue_comments_298944.json:
```json
{
    "body": "Changed commit from **[`7749836`](https://github.com/sagemath/sagetrac-mirror/commit/7749836d15037a61a2f028c33f23580892a81fe1)** to **[`07b303e`](https://github.com/sagemath/sagetrac-mirror/commit/07b303efac51113e9cbcc3e2536be377bd3ad682)**",
    "created_at": "2016-11-23T14:24:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298944",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`7749836`](https://github.com/sagemath/sagetrac-mirror/commit/7749836d15037a61a2f028c33f23580892a81fe1)** to **[`07b303e`](https://github.com/sagemath/sagetrac-mirror/commit/07b303efac51113e9cbcc3e2536be377bd3ad682)**



---

archive/issue_comments_298945.json:
```json
{
    "body": "<div id=\"comment:20\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/07b303efac51113e9cbcc3e2536be377bd3ad682\"><code>07b303e</code></a></td><td><code>20680: UTF-8 fix + note about Python3 compatibility</code></td></tr></table>\n",
    "created_at": "2016-11-23T14:24:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298945",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:20"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/07b303efac51113e9cbcc3e2536be377bd3ad682"><code>07b303e</code></a></td><td><code>20680: UTF-8 fix + note about Python3 compatibility</code></td></tr></table>




---

archive/issue_events_288565.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2016-11-23T14:24:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288565"
}
```



---

archive/issue_events_288566.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2016-11-23T14:24:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288566"
}
```



---

archive/issue_comments_298946.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nObvious design question: why don't you implement this as a subclass of `dict` such that you could actually write `a * D` instead of `scal(a, D)`?\n\nI understand that it might be more work this way. It does seem the most natural thing to do and it would result in more readable and more efficient code.",
    "created_at": "2016-11-23T14:33:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298946",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:22" align="right">comment:22</div>

Obvious design question: why don't you implement this as a subclass of `dict` such that you could actually write `a * D` instead of `scal(a, D)`?

I understand that it might be more work this way. It does seem the most natural thing to do and it would result in more readable and more efficient code.



---

archive/issue_comments_298947.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nThis should be avoided\n\n```\n__cmp__ = ElementWrapper._cmp_by_value\n```\nas it will not be supported in Python 3.",
    "created_at": "2016-11-23T14:34:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298947",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:23" align="right">comment:23</div>

This should be avoided

```
__cmp__ = ElementWrapper._cmp_by_value
```
as it will not be supported in Python 3.



---

archive/issue_comments_298948.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nCython knows how to copy dicts efficiently, so you can replace `PyDict_Copy(D)` by `D.copy()` (assuming that `D` is declared as `dict`).",
    "created_at": "2016-11-23T14:38:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298948",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:24" align="right">comment:24</div>

Cython knows how to copy dicts efficiently, so you can replace `PyDict_Copy(D)` by `D.copy()` (assuming that `D` is declared as `dict`).



---

archive/issue_comments_298949.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nI think you should also specify exactly what mathematical assumptions you make on `K`. For example, you assume that `bool(x)` implies `bool(-x)` and you assume that `-1 * x = -x`.",
    "created_at": "2016-11-23T14:43:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298949",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:25" align="right">comment:25</div>

I think you should also specify exactly what mathematical assumptions you make on `K`. For example, you assume that `bool(x)` implies `bool(-x)` and you assume that `-1 * x = -x`.



---

archive/issue_comments_298950.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nThis is false:\n\n```\n.. TODO::\n\n    Upon migrating to Python 3, change .iteritems below to .items. We\n    don't want to do it now as this is a speed-critical location.\n```\nCython supports `.iteritems()` for objects typed as `dict`, so you can just keep `.iteritems()` regardless of Python version.",
    "created_at": "2016-11-23T14:48:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298950",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:26" align="right">comment:26</div>

This is false:

```
.. TODO::

    Upon migrating to Python 3, change .iteritems below to .items. We
    don't want to do it now as this is a speed-critical location.
```
Cython supports `.iteritems()` for objects typed as `dict`, so you can just keep `.iteritems()` regardless of Python version.



---

archive/issue_comments_298951.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nI think the `remove_zeros` flag of `iaxpy` is too confusing. You don't really define what happens if `removes_zeros=False` (which keys would appear with a zero value?). I guess that every key which appears in `X` or `Y` should appear in the result, but that is not currently the case.",
    "created_at": "2016-11-23T14:53:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298951",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:27" align="right">comment:27</div>

I think the `remove_zeros` flag of `iaxpy` is too confusing. You don't really define what happens if `removes_zeros=False` (which keys would appear with a zero value?). I guess that every key which appears in `X` or `Y` should appear in the result, but that is not currently the case.



---

archive/issue_events_288567.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-11-23T14:57:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288567"
}
```



---

archive/issue_events_288568.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2016-11-23T14:57:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288568"
}
```



---

archive/issue_comments_298952.json:
```json
{
    "body": "Changed commit from **[`07b303e`](https://github.com/sagemath/sagetrac-mirror/commit/07b303efac51113e9cbcc3e2536be377bd3ad682)** to **[`9570c65`](https://github.com/sagemath/sagetrac-mirror/commit/9570c65ca4bb27fe8ee3dbee82b6ee42c4acb108)**",
    "created_at": "2016-11-23T22:30:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298952",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`07b303e`](https://github.com/sagemath/sagetrac-mirror/commit/07b303efac51113e9cbcc3e2536be377bd3ad682)** to **[`9570c65`](https://github.com/sagemath/sagetrac-mirror/commit/9570c65ca4bb27fe8ee3dbee82b6ee42c4acb108)**



---

archive/issue_comments_298953.json:
```json
{
    "body": "<div id=\"comment:29\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9570c65ca4bb27fe8ee3dbee82b6ee42c4acb108\"><code>9570c65</code></a></td><td><code>Doing some changes asked for by Jeroen and some other little doc tweaks.</code></td></tr></table>\n",
    "created_at": "2016-11-23T22:30:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298953",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:29"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9570c65ca4bb27fe8ee3dbee82b6ee42c4acb108"><code>9570c65</code></a></td><td><code>Doing some changes asked for by Jeroen and some other little doc tweaks.</code></td></tr></table>




---

archive/issue_comments_298954.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\ncomment:22 - This would be quite difficult to do because we would have to handle `a * D` and `D * a`, which would take more time because they would both pass through `_mul_`. Furthermore, we couldn't do `a*D + E` in one single operation.\n\ncomment:23 - I think this was needed at the time due to the absence of coercion for comparisons for \n`ElementWrapper`.\n\ncomment:24 - Done.\n\ncomment:25 - I took a crack at it. Let me know if you still think it is unclear.",
    "created_at": "2016-11-23T22:34:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298954",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:30" align="right">comment:30</div>

comment:22 - This would be quite difficult to do because we would have to handle `a * D` and `D * a`, which would take more time because they would both pass through `_mul_`. Furthermore, we couldn't do `a*D + E` in one single operation.

comment:23 - I think this was needed at the time due to the absence of coercion for comparisons for 
`ElementWrapper`.

comment:24 - Done.

comment:25 - I took a crack at it. Let me know if you still think it is unclear.



---

archive/issue_comments_298955.json:
```json
{
    "body": "Changed work issues from **Move from combinat** to none",
    "created_at": "2016-11-23T22:34:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298955",
    "user": "https://github.com/tscrim"
}
```

Changed work issues from **Move from combinat** to none



---

archive/issue_events_288569.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-11-23T22:34:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288569"
}
```



---

archive/issue_events_288570.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-11-23T22:34:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288570"
}
```



---

archive/issue_events_288571.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-11-23T22:34:00Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "milestone_number": null,
    "milestone_title": "sage-7.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288571"
}
```



---

archive/issue_events_288572.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-11-23T22:34:00Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "milestone_number": null,
    "milestone_title": "sage-7.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288572"
}
```



---

archive/issue_comments_298956.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nReplying to [@tscrim](#comment%3A30):\n> comment:22 - This would be quite difficult to do because we would have to handle `a * D` and `D * a`, which would take more time because they would both pass through `_mul_`.\n\nMore precisely, `_mul_` would not be involved since `D` would not be an `Element`. But the coercion model would be involved. If the coercion model is too slow for these purposes, we *really* should fix that. It makes no sense to make code more complicated just to avoid the coercion model.\n\n> Furthermore, we couldn't do `a*D + E` in one single operation.\n\nTrue, but then you make a method to do that in a single operation.",
    "created_at": "2016-11-24T07:46:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298956",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:31" align="right">comment:31</div>

Replying to [@tscrim](#comment%3A30):
> comment:22 - This would be quite difficult to do because we would have to handle `a * D` and `D * a`, which would take more time because they would both pass through `_mul_`.

More precisely, `_mul_` would not be involved since `D` would not be an `Element`. But the coercion model would be involved. If the coercion model is too slow for these purposes, we *really* should fix that. It makes no sense to make code more complicated just to avoid the coercion model.

> Furthermore, we couldn't do `a*D + E` in one single operation.

True, but then you make a method to do that in a single operation.



---

archive/issue_comments_298957.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nRegarding [comment:27], I think the phrase \"values are zero after the addition has\nbeen performed\" is still not clear. Do you mean values such that `a * x` is non-zero and `y` is non-zero but `a * x + y` is zero? If so, what is the rationale for keeping those zeros but not the cases where `y` is zero and `a * x` is zero?",
    "created_at": "2016-11-24T07:50:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298957",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:32" align="right">comment:32</div>

Regarding [comment:27], I think the phrase "values are zero after the addition has
been performed" is still not clear. Do you mean values such that `a * x` is non-zero and `y` is non-zero but `a * x + y` is zero? If so, what is the rationale for keeping those zeros but not the cases where `y` is zero and `a * x` is zero?



---

archive/issue_comments_298958.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nReplying to [@tscrim](#comment%3A30):\n> comment:22 - This would be quite difficult to do because we would have to handle `a * D` and `D * a`, which would take more time because they would both pass through `_mul_`. Furthermore, we couldn't do `a*D + E` in one single operation.\n\nOK, new try: how about subclassing `dict` and making all operations methods of that class? That would avoid the inefficiency issues with the coercion model.",
    "created_at": "2016-11-24T08:01:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298958",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:33" align="right">comment:33</div>

Replying to [@tscrim](#comment%3A30):
> comment:22 - This would be quite difficult to do because we would have to handle `a * D` and `D * a`, which would take more time because they would both pass through `_mul_`. Furthermore, we couldn't do `a*D + E` in one single operation.

OK, new try: how about subclassing `dict` and making all operations methods of that class? That would avoid the inefficiency issues with the coercion model.



---

archive/issue_comments_298959.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\n(Edit: wrong ticket)",
    "created_at": "2016-11-24T08:01:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298959",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:34" align="right">comment:34</div>

(Edit: wrong ticket)



---

archive/issue_comments_298960.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nReplying to [@jdemeyer](#comment%3A31):\n> Replying to [@tscrim](#comment%3A30):\n> > comment:22 - This would be quite difficult to do because we would have to handle `a * D` and `D * a`, which would take more time because they would both pass through `_mul_`.\n> \n> \n> More precisely, `_mul_` would not be involved since `D` would not be an `Element`. But the coercion model would be involved. If the coercion model is too slow for these purposes, we *really* should fix that. It makes no sense to make code more complicated just to avoid the coercion model.\n\nSorry, that should have been `__mul__`, but you still need to take some cycles differentiating between `a * D` and `D * a` in Cython. At least, I could not get `__radd__` on a Cython class (different ticket), and I'm assuming that extends to `__rmul__`.\n\nReplying to [@jdemeyer](#comment%3A33):\n> OK, new try: how about subclassing dict and making all operations methods of that class? That would avoid the inefficiency issues with the coercion model. \n\nIf we make all operations to be methods of that class, then all I see is unneeded complexity added because we'd still be making (essentially) function calls everywhere, but we have to differentiate between `dict` and `BLASdict`.",
    "created_at": "2016-11-24T08:22:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298960",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:35" align="right">comment:35</div>

Replying to [@jdemeyer](#comment%3A31):
> Replying to [@tscrim](#comment%3A30):
> > comment:22 - This would be quite difficult to do because we would have to handle `a * D` and `D * a`, which would take more time because they would both pass through `_mul_`.
> 
> 
> More precisely, `_mul_` would not be involved since `D` would not be an `Element`. But the coercion model would be involved. If the coercion model is too slow for these purposes, we *really* should fix that. It makes no sense to make code more complicated just to avoid the coercion model.

Sorry, that should have been `__mul__`, but you still need to take some cycles differentiating between `a * D` and `D * a` in Cython. At least, I could not get `__radd__` on a Cython class (different ticket), and I'm assuming that extends to `__rmul__`.

Replying to [@jdemeyer](#comment%3A33):
> OK, new try: how about subclassing dict and making all operations methods of that class? That would avoid the inefficiency issues with the coercion model. 

If we make all operations to be methods of that class, then all I see is unneeded complexity added because we'd still be making (essentially) function calls everywhere, but we have to differentiate between `dict` and `BLASdict`.



---

archive/issue_comments_298961.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nReplying to [@jdemeyer](#comment%3A32):\n> Regarding [comment:27], I think the phrase \"values are zero after the addition has\n> been performed\" is still not clear. Do you mean values such that `a * x` is non-zero and `y` is non-zero but `a * x + y` is zero? If so, what is the rationale for keeping those zeros but not the cases where `y` is zero and `a * x` is zero?\n\nI think you're misparsing something. The word `value` is as in key-value pair of a dictionary (because everything we are doing is dictionaries). In some cases, someone might want a basis element that has a coefficient of 0. For instance, it takes longer to remove these coefficients, and if you're doing a lot of additions with full support, you may only want to remove the basis elements with a 0 coefficient after you're all done.",
    "created_at": "2016-11-24T08:25:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298961",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:36" align="right">comment:36</div>

Replying to [@jdemeyer](#comment%3A32):
> Regarding [comment:27], I think the phrase "values are zero after the addition has
> been performed" is still not clear. Do you mean values such that `a * x` is non-zero and `y` is non-zero but `a * x + y` is zero? If so, what is the rationale for keeping those zeros but not the cases where `y` is zero and `a * x` is zero?

I think you're misparsing something. The word `value` is as in key-value pair of a dictionary (because everything we are doing is dictionaries). In some cases, someone might want a basis element that has a coefficient of 0. For instance, it takes longer to remove these coefficients, and if you're doing a lot of additions with full support, you may only want to remove the basis elements with a 0 coefficient after you're all done.



---

archive/issue_comments_298962.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nActually, slightly radical proposal: How about removing this altogether as a separate spkg since it is independent of Sage?",
    "created_at": "2016-11-24T08:25:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298962",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:37" align="right">comment:37</div>

Actually, slightly radical proposal: How about removing this altogether as a separate spkg since it is independent of Sage?



---

archive/issue_comments_298963.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nReplying to [@tscrim](#comment%3A37):\n> Actually, slightly radical proposal: How about removing this altogether as a separate spkg since it is independent of Sage?\n\nEven if you do that, you could still develop it within Sage and then split it off.",
    "created_at": "2016-11-24T08:26:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298963",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:38" align="right">comment:38</div>

Replying to [@tscrim](#comment%3A37):
> Actually, slightly radical proposal: How about removing this altogether as a separate spkg since it is independent of Sage?

Even if you do that, you could still develop it within Sage and then split it off.



---

archive/issue_comments_298964.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nReplying to [@tscrim](#comment%3A36):\n> Replying to [@jdemeyer](#comment%3A32):\n> > Regarding [comment:27], I think the phrase \"values are zero after the addition has\n> > been performed\" is still not clear. Do you mean values such that `a * x` is non-zero and `y` is non-zero but `a * x + y` is zero? If so, what is the rationale for keeping those zeros but not the cases where `y` is zero and `a * x` is zero?\n> \n> \n> I think you're misparsing something.\n\nIf I am misparsing something, it probably means that the documentation wasn't clear. My question remains: if `remove_zeros=False`, exactly which keys will appear with a zero value?",
    "created_at": "2016-11-24T08:28:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298964",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:39" align="right">comment:39</div>

Replying to [@tscrim](#comment%3A36):
> Replying to [@jdemeyer](#comment%3A32):
> > Regarding [comment:27], I think the phrase "values are zero after the addition has
> > been performed" is still not clear. Do you mean values such that `a * x` is non-zero and `y` is non-zero but `a * x + y` is zero? If so, what is the rationale for keeping those zeros but not the cases where `y` is zero and `a * x` is zero?
> 
> 
> I think you're misparsing something.

If I am misparsing something, it probably means that the documentation wasn't clear. My question remains: if `remove_zeros=False`, exactly which keys will appear with a zero value?



---

archive/issue_comments_298965.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nReplying to [@tscrim](#comment%3A35):\n> At least, I could not get `__radd__` on a Cython class\n\nhttp://cython.readthedocs.io/en/latest/src/userguide/special_methods.html#arithmetic-methods",
    "created_at": "2016-11-24T08:32:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298965",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:40" align="right">comment:40</div>

Replying to [@tscrim](#comment%3A35):
> At least, I could not get `__radd__` on a Cython class

http://cython.readthedocs.io/en/latest/src/userguide/special_methods.html#arithmetic-methods



---

archive/issue_comments_298966.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nReplying to [@jdemeyer](#comment%3A39):\n> Replying to [@tscrim](#comment%3A36):\n> > Replying to [@jdemeyer](#comment%3A32):\n> > > Regarding [comment:27], I think the phrase \"values are zero after the addition has\n> > > been performed\" is still not clear. Do you mean values such that `a * x` is non-zero and `y` is non-zero but `a * x + y` is zero? If so, what is the rationale for keeping those zeros but not the cases where `y` is zero and `a * x` is zero?\n> > \n> > \n> > I think you're misparsing something.\n> \n> \n> If I am misparsing something, it probably means that the documentation wasn't clear. My question remains: if `remove_zeros=False`, exactly which keys will appear with a zero value?\n\nAll of them. The point is that if it is true, then remove them.\n\nEdit: That claim might be somewhat vague. If there is a key with a value of 0, then it stays.",
    "created_at": "2016-11-24T08:33:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298966",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:41" align="right">comment:41</div>

Replying to [@jdemeyer](#comment%3A39):
> Replying to [@tscrim](#comment%3A36):
> > Replying to [@jdemeyer](#comment%3A32):
> > > Regarding [comment:27], I think the phrase "values are zero after the addition has
> > > been performed" is still not clear. Do you mean values such that `a * x` is non-zero and `y` is non-zero but `a * x + y` is zero? If so, what is the rationale for keeping those zeros but not the cases where `y` is zero and `a * x` is zero?
> > 
> > 
> > I think you're misparsing something.
> 
> 
> If I am misparsing something, it probably means that the documentation wasn't clear. My question remains: if `remove_zeros=False`, exactly which keys will appear with a zero value?

All of them. The point is that if it is true, then remove them.

Edit: That claim might be somewhat vague. If there is a key with a value of 0, then it stays.



---

archive/issue_comments_298967.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nReplying to [@jdemeyer](#comment%3A40):\n> Replying to [@tscrim](#comment%3A35):\n> > At least, I could not get `__radd__` on a Cython class\n> \n> \n> http://cython.readthedocs.io/en/latest/src/userguide/special_methods.html#arithmetic-methods\n\nSo I was trying to add an element and a list. I implemented an add that looked like this:\n\n```sage\ndef __add__(self, other):\n    if isinstance(other, list):\n        return self + self.parent()(list[0])\n    return super(self, Foo).__add__(other)\n```\nWhat I saw happen when it was `list + Foo` was `__add__` was being called with `self` being `list`. If it got to `__radd__`, then it would have been after this call, but I was getting an error trying to make the `super` call that wasn't getting caught.",
    "created_at": "2016-11-24T08:40:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298967",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:42" align="right">comment:42</div>

Replying to [@jdemeyer](#comment%3A40):
> Replying to [@tscrim](#comment%3A35):
> > At least, I could not get `__radd__` on a Cython class
> 
> 
> http://cython.readthedocs.io/en/latest/src/userguide/special_methods.html#arithmetic-methods

So I was trying to add an element and a list. I implemented an add that looked like this:

```sage
def __add__(self, other):
    if isinstance(other, list):
        return self + self.parent()(list[0])
    return super(self, Foo).__add__(other)
```
What I saw happen when it was `list + Foo` was `__add__` was being called with `self` being `list`. If it got to `__radd__`, then it would have been after this call, but I was getting an error trying to make the `super` call that wasn't getting caught.



---

archive/issue_comments_298968.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nReplying to [@jdemeyer](#comment%3A38):\n> Replying to [@tscrim](#comment%3A37):\n> > Actually, slightly radical proposal: How about removing this altogether as a separate spkg since it is independent of Sage?\n> \n> \n> Even if you do that, you could still develop it within Sage and then split it off.\n\nNicolas wasn't in favor of doing this as it is just one file.",
    "created_at": "2016-11-24T08:41:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298968",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:43" align="right">comment:43</div>

Replying to [@jdemeyer](#comment%3A38):
> Replying to [@tscrim](#comment%3A37):
> > Actually, slightly radical proposal: How about removing this altogether as a separate spkg since it is independent of Sage?
> 
> 
> Even if you do that, you could still develop it within Sage and then split it off.

Nicolas wasn't in favor of doing this as it is just one file.



---

archive/issue_comments_298969.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nReplying to [@tscrim](#comment%3A42):\n> So I was trying to add an element and a list. I implemented an add that looked like this:\n> \n> ```sage\n> def __add__(self, other):\n>     if isinstance(other, list):\n>         return self + self.parent()(list[0])\n>     return super(self, Foo).__add__(other)\n> ```\n> What I saw happen when it was `list + Foo` was `__add__` was being called with `self` being `list`.\n\nRight, that is how `__add__` works in a `cdef class`. For this reason, I recommend against using the name `self` in this case. I prefer\n\n```\ndef __add__(left, right):\n```\nwhich shows the more symmetric nature of the arguments.\n\n> If it got to `__radd__`\n\nWhat do you mean? There is no `__radd__` for a `cdef class`.\n\n> I was getting an error trying to make the `super` call that wasn't getting caught.\n\nLogically, if `self` is not an instance of `Foo`, then `super(self, Foo)` would be an error.",
    "created_at": "2016-11-24T09:27:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298969",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:44" align="right">comment:44</div>

Replying to [@tscrim](#comment%3A42):
> So I was trying to add an element and a list. I implemented an add that looked like this:
> 
> ```sage
> def __add__(self, other):
>     if isinstance(other, list):
>         return self + self.parent()(list[0])
>     return super(self, Foo).__add__(other)
> ```
> What I saw happen when it was `list + Foo` was `__add__` was being called with `self` being `list`.

Right, that is how `__add__` works in a `cdef class`. For this reason, I recommend against using the name `self` in this case. I prefer

```
def __add__(left, right):
```
which shows the more symmetric nature of the arguments.

> If it got to `__radd__`

What do you mean? There is no `__radd__` for a `cdef class`.

> I was getting an error trying to make the `super` call that wasn't getting caught.

Logically, if `self` is not an instance of `Foo`, then `super(self, Foo)` would be an error.



---

archive/issue_comments_298970.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nReplying to [@tscrim](#comment%3A43):\n> Nicolas wasn't in favor of doing this as it is just one file.\n\nMakes sense.",
    "created_at": "2016-11-24T09:37:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298970",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:45" align="right">comment:45</div>

Replying to [@tscrim](#comment%3A43):
> Nicolas wasn't in favor of doing this as it is just one file.

Makes sense.



---

archive/issue_comments_298971.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nReplying to [@jdemeyer](#comment%3A44):\n> Replying to [@tscrim](#comment%3A42):\n> > So I was trying to add an element and a list. I implemented an add that looked like this:\n> > \n> > ```sage\n> > def __add__(self, other):\n> >     if isinstance(other, list):\n> >         return self + self.parent()(list[0])\n> >     return super(self, Foo).__add__(other)\n> > ```\n> > What I saw happen when it was `list + Foo` was `__add__` was being called with `self` being `list`.\n> \n> \n> Right, that is how `__add__` works in a `cdef class`. For this reason, I recommend against using the name `self` in this case. I prefer\n> ...\n\nAh, sorry, I didn't read the link you sent and misunderstood what you were trying to say. However, that is my point, we would have to check for this in `__mul__`, which takes a few extra cycles. If instead we use a function that has a fixed signature (or at least, semantically), then we don't loose those cycles.\n\nDoes [comment:41](#comment%3A41) help with the `remove_zeros`?",
    "created_at": "2016-11-24T11:03:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298971",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:46" align="right">comment:46</div>

Replying to [@jdemeyer](#comment%3A44):
> Replying to [@tscrim](#comment%3A42):
> > So I was trying to add an element and a list. I implemented an add that looked like this:
> > 
> > ```sage
> > def __add__(self, other):
> >     if isinstance(other, list):
> >         return self + self.parent()(list[0])
> >     return super(self, Foo).__add__(other)
> > ```
> > What I saw happen when it was `list + Foo` was `__add__` was being called with `self` being `list`.
> 
> 
> Right, that is how `__add__` works in a `cdef class`. For this reason, I recommend against using the name `self` in this case. I prefer
> ...

Ah, sorry, I didn't read the link you sent and misunderstood what you were trying to say. However, that is my point, we would have to check for this in `__mul__`, which takes a few extra cycles. If instead we use a function that has a fixed signature (or at least, semantically), then we don't loose those cycles.

Does [comment:41](#comment%3A41) help with the `remove_zeros`?



---

archive/issue_comments_298972.json:
```json
{
    "body": "Changed keywords from **combinatorial free module, addition** to **combinatorial free module, addition, days79**",
    "created_at": "2016-11-24T11:03:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298972",
    "user": "https://github.com/tscrim"
}
```

Changed keywords from **combinatorial free module, addition** to **combinatorial free module, addition, days79**



---

archive/issue_comments_298973.json:
```json
{
    "body": "Changed reviewer from **Nicolas M. Thi\u00e9ry** to **Nicolas M. Thi\u00e9ry, Jeroen Demeyer**",
    "created_at": "2016-11-24T11:03:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298973",
    "user": "https://github.com/tscrim"
}
```

Changed reviewer from **Nicolas M. Thiéry** to **Nicolas M. Thiéry, Jeroen Demeyer**



---

archive/issue_comments_298974.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\nIf remove_zeros=True (and the input have no zero values themselves),\nthen the output is guaranteed to have no zero values. Otherwise the\nsome zero value may be left in the output. Which ones is voluntarily\nleft undefined.\n\nThe point is that clearing zero values has a cost and there are cases\nwhere the user want to postpone the clearing until the end of a long\nseries of operations.\n\nJeroen: does the above clarify the remove_zeros option? If yes, I'll\nadd it to the documentation.",
    "created_at": "2016-11-24T13:07:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298974",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:47" align="right">comment:47</div>

If remove_zeros=True (and the input have no zero values themselves),
then the output is guaranteed to have no zero values. Otherwise the
some zero value may be left in the output. Which ones is voluntarily
left undefined.

The point is that clearing zero values has a cost and there are cases
where the user want to postpone the clearing until the end of a long
series of operations.

Jeroen: does the above clarify the remove_zeros option? If yes, I'll
add it to the documentation.



---

archive/issue_comments_298975.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\nHi Jeroen,\n\nThanks for the feedback!\n\nThe current design (compared to a class with methods) has two advantages for such a low level use case:\n\n- following a widely used pattern for basic linear algebra operations (used even in OO languages)\n- not requiring to coerce / cast inputs when they are provided as plain dictionaries;\n  the same holds for output\n\n(and you know that I am a fan of OO :-) )",
    "created_at": "2016-11-24T13:16:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298975",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:48" align="right">comment:48</div>

Hi Jeroen,

Thanks for the feedback!

The current design (compared to a class with methods) has two advantages for such a low level use case:

- following a widely used pattern for basic linear algebra operations (used even in OO languages)
- not requiring to coerce / cast inputs when they are provided as plain dictionaries;
  the same holds for output

(and you know that I am a fan of OO :-) )



---

archive/issue_comments_298976.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\nTravis: for some reason, 9570c65ca4bb27fe8ee3dbee82b6ee42c4acb108 includes unrelated changes in `finite_monoids`; could you revert those?",
    "created_at": "2016-11-24T13:17:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298976",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:49" align="right">comment:49</div>

Travis: for some reason, 9570c65ca4bb27fe8ee3dbee82b6ee42c4acb108 includes unrelated changes in `finite_monoids`; could you revert those?



---

archive/issue_comments_298977.json:
```json
{
    "body": "<div id=\"comment:50\" align=\"right\">comment:50</div>\n\nReplying to [@tscrim](#comment%3A46):\n> Ah, sorry, I didn't read the link you sent and misunderstood what you were trying to say. However, that is my point, we would have to check for this in `__mul__`, which takes a few extra cycles. If instead we use a function that has a fixed signature (or at least, semantically), then we don't loose those cycles.\n\nThis is an interesting (but wrong) argument. It shows that there are a lot of misconceptions about efficiency in !Python/Cython code.\n\nWhat is correct:\n\n(1) Arithmetic operators (like `+` implemented as `__add__`) are fast.\n\n(2) `isinstance()` in Cython is fast.\n\n(3) Python function calls are slow.\n\nIn turns out that (1) + (2) is actually faster than (3).",
    "created_at": "2016-11-24T13:40:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298977",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:50" align="right">comment:50</div>

Replying to [@tscrim](#comment%3A46):
> Ah, sorry, I didn't read the link you sent and misunderstood what you were trying to say. However, that is my point, we would have to check for this in `__mul__`, which takes a few extra cycles. If instead we use a function that has a fixed signature (or at least, semantically), then we don't loose those cycles.

This is an interesting (but wrong) argument. It shows that there are a lot of misconceptions about efficiency in !Python/Cython code.

What is correct:

(1) Arithmetic operators (like `+` implemented as `__add__`) are fast.

(2) `isinstance()` in Cython is fast.

(3) Python function calls are slow.

In turns out that (1) + (2) is actually faster than (3).



---

archive/issue_comments_298978.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nReplying to [@nthiery](#comment%3A47):\n> If remove_zeros=True (and the input have no zero values themselves),\n> then the output is guaranteed to have no zero values. Otherwise the\n> some zero value may be left in the output. Which ones is voluntarily\n> left undefined.\n> \n> The point is that clearing zero values has a cost and there are cases\n> where the user want to postpone the clearing until the end of a long\n> series of operations.\n\n> Jeroen: does the above clarify the remove_zeros option? If yes, I'll\n> add it to the documentation.\n\nAbsolutely (much better than Travis's explanation; sorry Travis).",
    "created_at": "2016-11-24T13:46:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298978",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:51" align="right">comment:51</div>

Replying to [@nthiery](#comment%3A47):
> If remove_zeros=True (and the input have no zero values themselves),
> then the output is guaranteed to have no zero values. Otherwise the
> some zero value may be left in the output. Which ones is voluntarily
> left undefined.
> 
> The point is that clearing zero values has a cost and there are cases
> where the user want to postpone the clearing until the end of a long
> series of operations.

> Jeroen: does the above clarify the remove_zeros option? If yes, I'll
> add it to the documentation.

Absolutely (much better than Travis's explanation; sorry Travis).



---

archive/issue_comments_298979.json:
```json
{
    "body": "<div id=\"comment:52\" align=\"right\">comment:52</div>\n\nRegarding efficiency, let met add this: the module `blas_dict` seems to be used only from Python (not Cython) code, so these efficiency considerations are probably irrelevant anyway.",
    "created_at": "2016-11-24T13:48:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298979",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:52" align="right">comment:52</div>

Regarding efficiency, let met add this: the module `blas_dict` seems to be used only from Python (not Cython) code, so these efficiency considerations are probably irrelevant anyway.



---

archive/issue_comments_298980.json:
```json
{
    "body": "<div id=\"comment:53\" align=\"right\">comment:53</div>\n\nReplying to [@jdemeyer](#comment%3A52):\n> Regarding efficiency, let met add this: the module `blas_dict` seems to be used only from Python (not Cython) code, so these efficiency considerations are probably irrelevant anyway.\n\nNicolas and I are planning to move `CombinatorialFreeModuleElement` to a Cython class, so I would think it would be C function calls in that case?",
    "created_at": "2016-11-24T13:55:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298980",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:53" align="right">comment:53</div>

Replying to [@jdemeyer](#comment%3A52):
> Regarding efficiency, let met add this: the module `blas_dict` seems to be used only from Python (not Cython) code, so these efficiency considerations are probably irrelevant anyway.

Nicolas and I are planning to move `CombinatorialFreeModuleElement` to a Cython class, so I would think it would be C function calls in that case?



---

archive/issue_comments_298981.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">comment:54</div>\n\nFirst of all, I am not going to insist on implementing this as a subclass. You know better than me how this code is actually used.\n\nStill, some comments:\n\nReplying to [@nthiery](#comment%3A48):\n> The current design (compared to a class with methods) has two advantages for such a low level use case:\n> \n> - following a widely used pattern for basic linear algebra operations (used even in OO languages)\n\nI believe the standard implementation languages of BLAS are Fortran and C and those are not OO languages.\n\n> - not requiring to coerce / cast inputs when they are provided as plain dictionaries;\n\nSure, this is indeed a potential disadvantage (but also the only one). Wouldn't it work to just keep the attributes `__monomials` or `_monomial_coefficients` an instance of that type?\n\n>   the same holds for output\n\nNot really for output since it would be a `dict` subclass. So anything expecting a `dict` would still work.",
    "created_at": "2016-11-24T13:58:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298981",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:54" align="right">comment:54</div>

First of all, I am not going to insist on implementing this as a subclass. You know better than me how this code is actually used.

Still, some comments:

Replying to [@nthiery](#comment%3A48):
> The current design (compared to a class with methods) has two advantages for such a low level use case:
> 
> - following a widely used pattern for basic linear algebra operations (used even in OO languages)

I believe the standard implementation languages of BLAS are Fortran and C and those are not OO languages.

> - not requiring to coerce / cast inputs when they are provided as plain dictionaries;

Sure, this is indeed a potential disadvantage (but also the only one). Wouldn't it work to just keep the attributes `__monomials` or `_monomial_coefficients` an instance of that type?

>   the same holds for output

Not really for output since it would be a `dict` subclass. So anything expecting a `dict` would still work.



---

archive/issue_comments_298982.json:
```json
{
    "body": "<div id=\"comment:55\" align=\"right\">comment:55</div>\n\nReplying to [@tscrim](#comment%3A53):\n> Nicolas and I are planning to move `CombinatorialFreeModuleElement` to a Cython class, so I would think it would be C function calls in that case?\n\nYes, provided that you `cimport` (not `import`) the functions. This requires you to add a `.pxd` file. I guess you should do that on this ticket.",
    "created_at": "2016-11-24T14:00:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298982",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:55" align="right">comment:55</div>

Replying to [@tscrim](#comment%3A53):
> Nicolas and I are planning to move `CombinatorialFreeModuleElement` to a Cython class, so I would think it would be C function calls in that case?

Yes, provided that you `cimport` (not `import`) the functions. This requires you to add a `.pxd` file. I guess you should do that on this ticket.



---

archive/issue_comments_298983.json:
```json
{
    "body": "Changed commit from **[`9570c65`](https://github.com/sagemath/sagetrac-mirror/commit/9570c65ca4bb27fe8ee3dbee82b6ee42c4acb108)** to **[`93c03b2`](https://github.com/sagemath/sagetrac-mirror/commit/93c03b27cef78d9708dd2203bce3c2abb6591b90)**",
    "created_at": "2016-11-24T14:08:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298983",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`9570c65`](https://github.com/sagemath/sagetrac-mirror/commit/9570c65ca4bb27fe8ee3dbee82b6ee42c4acb108)** to **[`93c03b2`](https://github.com/sagemath/sagetrac-mirror/commit/93c03b27cef78d9708dd2203bce3c2abb6591b90)**



---

archive/issue_comments_298984.json:
```json
{
    "body": "<div id=\"comment:56\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/93c03b27cef78d9708dd2203bce3c2abb6591b90\"><code>93c03b2</code></a></td><td><code>Added pxd file and updating documentation.</code></td></tr></table>\n",
    "created_at": "2016-11-24T14:08:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298984",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:56"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/93c03b27cef78d9708dd2203bce3c2abb6591b90"><code>93c03b2</code></a></td><td><code>Added pxd file and updating documentation.</code></td></tr></table>




---

archive/issue_comments_298985.json:
```json
{
    "body": "<div id=\"comment:57\" align=\"right\">comment:57</div>\n\nI forgot to add the `.pxd` file; thanks for the reminder. I also added Nicolas' explanation of `remove_zeros` to the documentation.",
    "created_at": "2016-11-24T14:13:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298985",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:57" align="right">comment:57</div>

I forgot to add the `.pxd` file; thanks for the reminder. I also added Nicolas' explanation of `remove_zeros` to the documentation.



---

archive/issue_comments_298986.json:
```json
{
    "body": "<div id=\"comment:58\" align=\"right\">comment:58</div>\n\nIf you care about efficiency, then `iaxpy` should have the prototype\n\n```\ncpdef int iaxpy(....) except -1\n```\nReturning an `int` is faster than returning the Python `None`.",
    "created_at": "2016-11-24T14:56:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298986",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:58" align="right">comment:58</div>

If you care about efficiency, then `iaxpy` should have the prototype

```
cpdef int iaxpy(....) except -1
```
Returning an `int` is faster than returning the Python `None`.



---

archive/issue_comments_298987.json:
```json
{
    "body": "<div id=\"comment:59\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3fce47e9d5910bcc523c8ae5718bb3789480513b\"><code>3fce47e</code></a></td><td><code>Changing return type of iaxpy and some small doc tweaks.</code></td></tr></table>\n",
    "created_at": "2016-11-24T15:36:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298987",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:59"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3fce47e9d5910bcc523c8ae5718bb3789480513b"><code>3fce47e</code></a></td><td><code>Changing return type of iaxpy and some small doc tweaks.</code></td></tr></table>




---

archive/issue_comments_298988.json:
```json
{
    "body": "Changed commit from **[`93c03b2`](https://github.com/sagemath/sagetrac-mirror/commit/93c03b27cef78d9708dd2203bce3c2abb6591b90)** to **[`3fce47e`](https://github.com/sagemath/sagetrac-mirror/commit/3fce47e9d5910bcc523c8ae5718bb3789480513b)**",
    "created_at": "2016-11-24T15:36:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298988",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`93c03b2`](https://github.com/sagemath/sagetrac-mirror/commit/93c03b27cef78d9708dd2203bce3c2abb6591b90)** to **[`3fce47e`](https://github.com/sagemath/sagetrac-mirror/commit/3fce47e9d5910bcc523c8ae5718bb3789480513b)**



---

archive/issue_comments_298989.json:
```json
{
    "body": "<div id=\"comment:60\" align=\"right\">comment:60</div>\n\nReplying to [@jdemeyer](#comment%3A58):\n> If you care about efficiency, then `iaxpy` should have the prototype\n> \n> ```\n> cpdef int iaxpy(....) except -1\n> ```\n> Returning an `int` is faster than returning the Python `None`.\n\nDone. This resulted in a 2 microsecond speedup for the `n=1000` benchmark for me.",
    "created_at": "2016-11-24T15:36:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298989",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:60" align="right">comment:60</div>

Replying to [@jdemeyer](#comment%3A58):
> If you care about efficiency, then `iaxpy` should have the prototype
> 
> ```
> cpdef int iaxpy(....) except -1
> ```
> Returning an `int` is faster than returning the Python `None`.

Done. This resulted in a 2 microsecond speedup for the `n=1000` benchmark for me.



---

archive/issue_comments_298990.json:
```json
{
    "body": "Changed commit from **[`3fce47e`](https://github.com/sagemath/sagetrac-mirror/commit/3fce47e9d5910bcc523c8ae5718bb3789480513b)** to **[`be360a3`](https://github.com/sagemath/sagetrac-mirror/commit/be360a31833f6feb13f78de7646cb713d7b3a122)**",
    "created_at": "2016-12-01T00:29:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298990",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`3fce47e`](https://github.com/sagemath/sagetrac-mirror/commit/3fce47e9d5910bcc523c8ae5718bb3789480513b)** to **[`be360a3`](https://github.com/sagemath/sagetrac-mirror/commit/be360a31833f6feb13f78de7646cb713d7b3a122)**



---

archive/issue_comments_298991.json:
```json
{
    "body": "<div id=\"comment:61\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/f0996eb53081e8784c035a10f8c6fa73deb1975b\"><code>f0996eb</code></a></td><td><code>Merge branch 'public/combinat/improve_dict_addition-20680' of trac.sagemath.org:sage into public/combinat/improve_dict_addition-20680</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/be360a31833f6feb13f78de7646cb713d7b3a122\"><code>be360a3</code></a></td><td><code>Fixing one of the doctest failures.</code></td></tr></table>\n",
    "created_at": "2016-12-01T00:29:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298991",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:61"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/f0996eb53081e8784c035a10f8c6fa73deb1975b"><code>f0996eb</code></a></td><td><code>Merge branch 'public/combinat/improve_dict_addition-20680' of trac.sagemath.org:sage into public/combinat/improve_dict_addition-20680</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/be360a31833f6feb13f78de7646cb713d7b3a122"><code>be360a3</code></a></td><td><code>Fixing one of the doctest failures.</code></td></tr></table>




---

archive/issue_comments_298992.json:
```json
{
    "body": "<div id=\"comment:62\" align=\"right\">comment:62</div>\n\nSo there are two doctest failures:\n\nThe failure in `categories/finite_dimensional_algebras_with_basis.py` is reordering, and I've fixed it.\n\nThe one in `misc/dev_tools.py` is essentially trivial, but it requires some thought as to what the correct change should be. I'm thinking we should find something else that has a unique object name (perhaps `'QQ'`?). However, I want your opinions.\n\nOnce that is fixed, perhaps we can get this into Sage?",
    "created_at": "2016-12-01T00:30:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298992",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:62" align="right">comment:62</div>

So there are two doctest failures:

The failure in `categories/finite_dimensional_algebras_with_basis.py` is reordering, and I've fixed it.

The one in `misc/dev_tools.py` is essentially trivial, but it requires some thought as to what the correct change should be. I'm thinking we should find something else that has a unique object name (perhaps `'QQ'`?). However, I want your opinions.

Once that is fixed, perhaps we can get this into Sage?



---

archive/issue_events_288573.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-12-01T00:30:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288573"
}
```



---

archive/issue_events_288574.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-12-01T00:30:26Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288574"
}
```



---

archive/issue_comments_298993.json:
```json
{
    "body": "<div id=\"comment:63\" align=\"right\">comment:63</div>\n\nHi Travis,\n\nThanks for checking this out. +1 on the first change. For the second, I agree that it's good enough to replace sum by something else with a unique name. The only thing is that this test is about exercising `import_statement` for objects that are defined as aliases. So we need to find some object like this (haven't found one yet).\n\nThen, yes, let's get this in Sage!",
    "created_at": "2016-12-01T08:57:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298993",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:63" align="right">comment:63</div>

Hi Travis,

Thanks for checking this out. +1 on the first change. For the second, I agree that it's good enough to replace sum by something else with a unique name. The only thing is that this test is about exercising `import_statement` for objects that are defined as aliases. So we need to find some object like this (haven't found one yet).

Then, yes, let's get this in Sage!



---

archive/issue_comments_298994.json:
```json
{
    "body": "<div id=\"comment:64\" align=\"right\">comment:64</div>\n\nReplying to [@nthiery](#comment%3A63):\n> For the second, I agree that it's good enough to replace sum by something else with a unique name. The only thing is that this test is about exercising `import_statement` for objects that are defined as aliases. So we need to find some object like this (haven't found one yet).\n\nI haven't been able to find one either. We can do something slightly artificial like importing something in the doctest as an alias and checking against that. Should we go that route?",
    "created_at": "2016-12-01T19:40:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298994",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:64" align="right">comment:64</div>

Replying to [@nthiery](#comment%3A63):
> For the second, I agree that it's good enough to replace sum by something else with a unique name. The only thing is that this test is about exercising `import_statement` for objects that are defined as aliases. So we need to find some object like this (haven't found one yet).

I haven't been able to find one either. We can do something slightly artificial like importing something in the doctest as an alias and checking against that. Should we go that route?



---

archive/issue_comments_298995.json:
```json
{
    "body": "<div id=\"comment:65\" align=\"right\">comment:65</div>\n\nOr maybe just remove the test: the feature already has test which seem equivalent, and if we can't find another example, it's not a critical feature anyway.",
    "created_at": "2016-12-01T22:25:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298995",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:65" align="right">comment:65</div>

Or maybe just remove the test: the feature already has test which seem equivalent, and if we can't find another example, it's not a critical feature anyway.



---

archive/issue_comments_298996.json:
```json
{
    "body": "<div id=\"comment:66\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9df803c12af084b106e0de4377e6a5221041b702\"><code>9df803c</code></a></td><td><code>Removing the other doctest failure.</code></td></tr></table>\n",
    "created_at": "2016-12-02T15:20:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298996",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:66"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9df803c12af084b106e0de4377e6a5221041b702"><code>9df803c</code></a></td><td><code>Removing the other doctest failure.</code></td></tr></table>




---

archive/issue_comments_298997.json:
```json
{
    "body": "Changed commit from **[`be360a3`](https://github.com/sagemath/sagetrac-mirror/commit/be360a31833f6feb13f78de7646cb713d7b3a122)** to **[`9df803c`](https://github.com/sagemath/sagetrac-mirror/commit/9df803c12af084b106e0de4377e6a5221041b702)**",
    "created_at": "2016-12-02T15:20:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298997",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`be360a3`](https://github.com/sagemath/sagetrac-mirror/commit/be360a31833f6feb13f78de7646cb713d7b3a122)** to **[`9df803c`](https://github.com/sagemath/sagetrac-mirror/commit/9df803c12af084b106e0de4377e6a5221041b702)**



---

archive/issue_comments_298998.json:
```json
{
    "body": "<div id=\"comment:67\" align=\"right\">comment:67</div>\n\nOkay, I've removed it. So if there are no other objections, then I believe we can set this to a positive review. Next up will be to cythonize `CFMElement`...",
    "created_at": "2016-12-02T15:22:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298998",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:67" align="right">comment:67</div>

Okay, I've removed it. So if there are no other objections, then I believe we can set this to a positive review. Next up will be to cythonize `CFMElement`...



---

archive/issue_events_288575.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-12-02T15:22:25Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288575"
}
```



---

archive/issue_events_288576.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-12-02T15:22:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288576"
}
```



---

archive/issue_comments_298999.json:
```json
{
    "body": "Changed author from **Travis Scrimshaw** to **Travis Scrimshaw, Nicolas M. Thi\u00e9ry**",
    "created_at": "2016-12-02T15:22:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-298999",
    "user": "https://github.com/tscrim"
}
```

Changed author from **Travis Scrimshaw** to **Travis Scrimshaw, Nicolas M. Thiéry**



---

archive/issue_comments_299000.json:
```json
{
    "body": "<div id=\"comment:68\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/95aacfad48240dc6fa943ba3a67dd1006f2088d7\"><code>95aacfa</code></a></td><td><code>20680: utf-8 fix</code></td></tr></table>\n",
    "created_at": "2016-12-03T11:22:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-299000",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:68"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/95aacfad48240dc6fa943ba3a67dd1006f2088d7"><code>95aacfa</code></a></td><td><code>20680: utf-8 fix</code></td></tr></table>




---

archive/issue_comments_299001.json:
```json
{
    "body": "Changed commit from **[`9df803c`](https://github.com/sagemath/sagetrac-mirror/commit/9df803c12af084b106e0de4377e6a5221041b702)** to **[`95aacfa`](https://github.com/sagemath/sagetrac-mirror/commit/95aacfad48240dc6fa943ba3a67dd1006f2088d7)**",
    "created_at": "2016-12-03T11:22:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-299001",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`9df803c`](https://github.com/sagemath/sagetrac-mirror/commit/9df803c12af084b106e0de4377e6a5221041b702)** to **[`95aacfa`](https://github.com/sagemath/sagetrac-mirror/commit/95aacfad48240dc6fa943ba3a67dd1006f2088d7)**



---

archive/issue_comments_299002.json:
```json
{
    "body": "<div id=\"comment:69\" align=\"right\">comment:69</div>\n\nHi,\n\nI checked the patchbot reports. I fixed the non-ascii issue. The startup-module report is normal. There are two python3 issue: one in a speed-critical section which we had discussed and decided to be a necessary evil. The other is a false positive (existing cmp in a line of code that was respaced).\n\nHence positive review!",
    "created_at": "2016-12-03T11:28:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-299002",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:69" align="right">comment:69</div>

Hi,

I checked the patchbot reports. I fixed the non-ascii issue. The startup-module report is normal. There are two python3 issue: one in a speed-critical section which we had discussed and decided to be a necessary evil. The other is a false positive (existing cmp in a line of code that was respaced).

Hence positive review!



---

archive/issue_events_288577.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2016-12-03T11:29:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288577"
}
```



---

archive/issue_events_288578.json:
```json
{
    "actor": "https://github.com/nthiery",
    "created_at": "2016-12-03T11:29:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288578"
}
```



---

archive/issue_comments_299003.json:
```json
{
    "body": "<div id=\"comment:71\" align=\"right\">comment:71</div>\n\nReplying to [@nthiery](#comment%3A69):\n> There are two python3 issue: one in a speed-critical section which we had discussed and decided to be a necessary evil.\n\nThat's a non-issue. Cython != Python and Cython does support `.iteritems()` for dicts.",
    "created_at": "2016-12-03T12:24:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-299003",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:71" align="right">comment:71</div>

Replying to [@nthiery](#comment%3A69):
> There are two python3 issue: one in a speed-critical section which we had discussed and decided to be a necessary evil.

That's a non-issue. Cython != Python and Cython does support `.iteritems()` for dicts.



---

archive/issue_events_288579.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-12-05T00:44:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288579"
}
```



---

archive/issue_events_288580.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "34d779db31f1e41396d0c85caeb9e7607a0eaebb",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2016-12-05T00:44:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/20680#event-288580"
}
```



---

archive/issue_comments_299004.json:
```json
{
    "body": "Changed branch from **[public/combinat/improve_dict_addition-20680](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/improve_dict_addition-20680)** to **[`95aacfa`](https://github.com/sagemath/sagetrac-mirror/commit/95aacfad48240dc6fa943ba3a67dd1006f2088d7)**",
    "created_at": "2016-12-05T00:44:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/20680",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/20680#issuecomment-299004",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/combinat/improve_dict_addition-20680](https://github.com/sagemath/sagetrac-mirror/tree/public/combinat/improve_dict_addition-20680)** to **[`95aacfa`](https://github.com/sagemath/sagetrac-mirror/commit/95aacfad48240dc6fa943ba3a67dd1006f2088d7)**
