# Issue 20185: Upgrade to SymPy-1.0

archive/issues_019948.json:
```json
{
    "body": "https://github.com/sympy/sympy/wiki/Release-Notes-for-1.0\n\nIt could be installed as usually \nhttps://github.com/sympy/sympy/releases/download/sympy-1.0/sympy-1.0.tar.gz\nor via `pip install -U sympy`.\n\nReviewer: Travis Scrimshaw, Ralf Stephan, Volker Braun\n\nAuthor: Ralf Stephan\n\nBranch: 3872f81c60ab0ae37d2ec64e240cce80a053edc8\n\nCommit: 3872f81c60ab0ae37d2ec64e240cce80a053edc8\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/20185\n\n",
    "closed_at": "2016-03-23T12:46:48Z",
    "created_at": "2016-03-10T14:25:21Z",
    "labels": [
        "component: packages: standard"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "Upgrade to SymPy-1.0",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20185",
    "user": "https://github.com/rwst"
}
```
https://github.com/sympy/sympy/wiki/Release-Notes-for-1.0

It could be installed as usually 
https://github.com/sympy/sympy/releases/download/sympy-1.0/sympy-1.0.tar.gz
or via `pip install -U sympy`.

Reviewer: Travis Scrimshaw, Ralf Stephan, Volker Braun

Author: Ralf Stephan

Branch: 3872f81c60ab0ae37d2ec64e240cce80a053edc8

Commit: 3872f81c60ab0ae37d2ec64e240cce80a053edc8

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/20185





---

archive/issue_comments_274275.json:
```json
{
    "body": "<a id='comment:3'></a>\n```\n$ ./sage -p mpmath\nSuccessfully installed mpmath-0.19\n$ ./sage -p sympy\nbuilding sympy\nPlease install the mpmath package with a version >= 0.19\nError building sympy\n```\nAny hints?\n\n---\nNew commits:",
    "created_at": "2016-03-10T16:32:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274275",
    "user": "https://github.com/rwst"
}
```

<a id='comment:3'></a>
```
$ ./sage -p mpmath
Successfully installed mpmath-0.19
$ ./sage -p sympy
building sympy
Please install the mpmath package with a version >= 0.19
Error building sympy
```
Any hints?

---
New commits:



---

archive/issue_comments_274276.json:
```json
{
    "body": "<a id='comment:4'></a>Replying to [comment:3 rws]:\n> {{{\n> $ ./sage -p mpmath\n> Successfully installed mpmath-0.19\n> $ ./sage -p sympy\n> building sympy\n> Please install the mpmath package with a version >= 0.19\n> Error building sympy\n> }}}\n> Any hints?\n> \n> ---\n> New commits:\n> |                                                                                                                                          |                                  |\n> |------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|\n> |[6971607](http://git.sagemath.org/sage.git/commit/?id=6971607ce1b72388e57a742ab8f5f0ffb4af1c0e)|`pkg version/chksum/patch removed`|\n\n\nI think I have. In the past (prior to this version) `sympy`'s `setup.py` was importing `sympy` itself. The danger then was to import the previously installed `sympy` rather the new `sympy`. So we add this\n\n```\nexport PYTHONPATH=\".\"\necho \"building sympy\"\npython -S setup.py build\n```\nThe `-S` is the cause of your trouble, look it up. So you should remove the `PYTHONPATH` stuff, the `-S` and remove the corresponding comments in `spkg-install`.",
    "created_at": "2016-03-11T06:18:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274276",
    "user": "https://github.com/kiwifb"
}
```

<a id='comment:4'></a>Replying to [comment:3 rws]:
> {{{
> $ ./sage -p mpmath
> Successfully installed mpmath-0.19
> $ ./sage -p sympy
> building sympy
> Please install the mpmath package with a version >= 0.19
> Error building sympy
> }}}
> Any hints?
> 
> ---
> New commits:
> |                                                                                                                                          |                                  |
> |------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------|
> |[6971607](http://git.sagemath.org/sage.git/commit/?id=6971607ce1b72388e57a742ab8f5f0ffb4af1c0e)|`pkg version/chksum/patch removed`|


I think I have. In the past (prior to this version) `sympy`'s `setup.py` was importing `sympy` itself. The danger then was to import the previously installed `sympy` rather the new `sympy`. So we add this

```
export PYTHONPATH="."
echo "building sympy"
python -S setup.py build
```
The `-S` is the cause of your trouble, look it up. So you should remove the `PYTHONPATH` stuff, the `-S` and remove the corresponding comments in `spkg-install`.



---

archive/issue_comments_274277.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-11T08:09:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274277",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274278.json:
```json
{
    "body": "<a id='comment:6'></a>Thanks, that was it. So there are changes that affect doctests:\n\n```\nsage -t --warn-long 27.4 src/sage/symbolic/integration/integral.py  # 1 doctest failed\nsage -t --warn-long 27.4 src/sage/symbolic/expression.pyx  # 3 doctests failed\nsage -t --warn-long 27.2 src/sage/tests/french_book/recequadiff.py  # 2 doctests failed\n```\nThat's only from a partial quick scan.",
    "created_at": "2016-03-11T08:10:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274278",
    "user": "https://github.com/rwst"
}
```

<a id='comment:6'></a>Thanks, that was it. So there are changes that affect doctests:

```
sage -t --warn-long 27.4 src/sage/symbolic/integration/integral.py  # 1 doctest failed
sage -t --warn-long 27.4 src/sage/symbolic/expression.pyx  # 3 doctests failed
sage -t --warn-long 27.2 src/sage/tests/french_book/recequadiff.py  # 2 doctests failed
```
That's only from a partial quick scan.



---

archive/issue_comments_274279.json:
```json
{
    "body": "<a id='comment:7'></a>> {{{\n> sage -t --warn-long 27.2 src/sage/tests/french_book/recequadiff.py  # 2 doctests failed\n> }}}\n\nThis can be minimized to\n\n```\nsage: import sympy\nsage: u = sympy.Function('u'); n = sympy.Symbol('n', integer=True)\nsage: sympy.sympify(3*u(n), evaluate=False)\nNotImplementedError: SymPy function 'u' doesn't exist\n```\nwhich disappears when `3*u(n)` is changed to `u(n)*3` or `u(n)`\n\nEDIT: I will just change the order in the muls for the doctest, and open a ticket. The case is rare and can be fixed after the upgrade.",
    "created_at": "2016-03-11T08:47:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274279",
    "user": "https://github.com/rwst"
}
```

<a id='comment:7'></a>> {{{
> sage -t --warn-long 27.2 src/sage/tests/french_book/recequadiff.py  # 2 doctests failed
> }}}

This can be minimized to

```
sage: import sympy
sage: u = sympy.Function('u'); n = sympy.Symbol('n', integer=True)
sage: sympy.sympify(3*u(n), evaluate=False)
NotImplementedError: SymPy function 'u' doesn't exist
```
which disappears when `3*u(n)` is changed to `u(n)*3` or `u(n)`

EDIT: I will just change the order in the muls for the doctest, and open a ticket. The case is rare and can be fixed after the upgrade.



---

archive/issue_comments_274280.json:
```json
{
    "body": "<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-11T09:11:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274280",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:8'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274281.json:
```json
{
    "body": "<a id='comment:9'></a>IMO comment:7 (#20194) is a serious regression and it should be fixed with the upgrade.",
    "created_at": "2016-03-11T09:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274281",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>IMO comment:7 (#20194) is a serious regression and it should be fixed with the upgrade.



---

archive/issue_comments_274282.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-11T16:03:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274282",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274283.json:
```json
{
    "body": "<a id='comment:11'></a>The doctest is fixed but something seems not right in the sympification of undefined Sage functions. The case in #20194 crashes Sympy's parser and I have reported in https://github.com/sympy/sympy/issues/10795",
    "created_at": "2016-03-11T16:15:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274283",
    "user": "https://github.com/rwst"
}
```

<a id='comment:11'></a>The doctest is fixed but something seems not right in the sympification of undefined Sage functions. The case in #20194 crashes Sympy's parser and I have reported in https://github.com/sympy/sympy/issues/10795



---

archive/issue_comments_274284.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-03-11T16:16:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274284",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_274285.json:
```json
{
    "body": "<a id='comment:13'></a>Do I understand you correctly that [0391252](http://git.sagemath.org/sage.git/commit/?id=03912520043631024635c3d6d09b86743b6c411e) means you do not have to change the test in the French book?",
    "created_at": "2016-03-11T23:03:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274285",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:13'></a>Do I understand you correctly that [0391252](http://git.sagemath.org/sage.git/commit/?id=03912520043631024635c3d6d09b86743b6c411e) means you do not have to change the test in the French book?



---

archive/issue_comments_274286.json:
```json
{
    "body": "<a id='comment:14'></a>Now that my Sage has finished rebuilding, the answer to my question is no, we still have a regression.",
    "created_at": "2016-03-11T23:53:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274286",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'></a>Now that my Sage has finished rebuilding, the answer to my question is no, we still have a regression.



---

archive/issue_comments_274287.json:
```json
{
    "body": "<a id='comment:15'></a>With this branch, we have:\n\n```\nsage: import sympy\nsage: u = sympy.Function('u'); n = sympy.Symbol('n', integer=True)\nsage: x = int(3)\nsage: x*u(n)\n3*u(n)\nsage: sympy.sympify(x*u(n))\n3*u(n)\nsage: sympy.sympify(x*u(n), evaluate=False)\n3*u(n)\n\nsage: x = 3._sympy_()\nsage: sympy.sympify(x*u(n), evaluate=False)\n3*u(n)\n```\nHowever, I think this is the problem:\n\n```\nsage: type(3*u(n))\n<type 'sage.symbolic.expression.Expression'>\nsage: type(u(n)*3)\n<class 'sympy.core.mul.Mul'>\n\nsage: x = int(3)\nsage: type(x*u(n))\n<class 'sympy.core.mul.Mul'>\nsage: type(u(n)*x)\n<class 'sympy.core.mul.Mul'>\n```\nSo it is probably something on our end.",
    "created_at": "2016-03-12T01:11:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274287",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:15'></a>With this branch, we have:

```
sage: import sympy
sage: u = sympy.Function('u'); n = sympy.Symbol('n', integer=True)
sage: x = int(3)
sage: x*u(n)
3*u(n)
sage: sympy.sympify(x*u(n))
3*u(n)
sage: sympy.sympify(x*u(n), evaluate=False)
3*u(n)

sage: x = 3._sympy_()
sage: sympy.sympify(x*u(n), evaluate=False)
3*u(n)
```
However, I think this is the problem:

```
sage: type(3*u(n))
<type 'sage.symbolic.expression.Expression'>
sage: type(u(n)*3)
<class 'sympy.core.mul.Mul'>

sage: x = int(3)
sage: type(x*u(n))
<class 'sympy.core.mul.Mul'>
sage: type(u(n)*x)
<class 'sympy.core.mul.Mul'>
```
So it is probably something on our end.



---

archive/issue_comments_274288.json:
```json
{
    "body": "<a id='comment:16'></a>Yes, that is the behavior change. Contrast that with the current 7.1.rc0:\n\n```\nsage: import sympy\nsage: u = sympy.Function('u'); n = sympy.Symbol('n', integer=True)\nsage: type(3*u(n))\n<class 'sympy.core.mul.Mul'>\nsage: type(u(n)*3)\n<class 'sympy.core.mul.Mul'>\n```",
    "created_at": "2016-03-12T01:13:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274288",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:16'></a>Yes, that is the behavior change. Contrast that with the current 7.1.rc0:

```
sage: import sympy
sage: u = sympy.Function('u'); n = sympy.Symbol('n', integer=True)
sage: type(3*u(n))
<class 'sympy.core.mul.Mul'>
sage: type(u(n)*3)
<class 'sympy.core.mul.Mul'>
```



---

archive/issue_comments_274289.json:
```json
{
    "body": "<a id='comment:17'></a>I also get the same behavior in comment:15 when I am at commit [f92f927](http://git.sagemath.org/sage.git/commit/?id=f92f927e44e1638efb08f01f2136010d236daaef).",
    "created_at": "2016-03-12T01:17:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274289",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:17'></a>I also get the same behavior in comment:15 when I am at commit [f92f927](http://git.sagemath.org/sage.git/commit/?id=f92f927e44e1638efb08f01f2136010d236daaef).



---

archive/issue_comments_274290.json:
```json
{
    "body": "<a id='comment:18'></a>This is SymPy-0.7.6.1:\n\n```\nsage: parent(u)\n<class 'sympy.core.function.UndefinedFunction'>\nsage: cm = sage.structure.element.get_coercion_model()\nsage: steps,res = cm.analyse(ZZ, parent(u))\nsage: steps\n['Will try _r_action and _l_action']\n```\nThis is 1.0:\n\n```\nsage: parent(u)\n<class 'sympy.core.function.UndefinedFunction'>\nsage: cm = sage.structure.element.get_coercion_model()\nsage: steps,res = cm.analyse(ZZ, parent(u))\nsage: steps\n['Right operand is not Sage element, will try _sage_.',\n 'Will try _r_action and _l_action']\n\nConversion map:\n  From: Integer Ring\n  To:   Symbolic Ring, None))\n```",
    "created_at": "2016-03-13T08:52:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274290",
    "user": "https://github.com/rwst"
}
```

<a id='comment:18'></a>This is SymPy-0.7.6.1:

```
sage: parent(u)
<class 'sympy.core.function.UndefinedFunction'>
sage: cm = sage.structure.element.get_coercion_model()
sage: steps,res = cm.analyse(ZZ, parent(u))
sage: steps
['Will try _r_action and _l_action']
```
This is 1.0:

```
sage: parent(u)
<class 'sympy.core.function.UndefinedFunction'>
sage: cm = sage.structure.element.get_coercion_model()
sage: steps,res = cm.analyse(ZZ, parent(u))
sage: steps
['Right operand is not Sage element, will try _sage_.',
 'Will try _r_action and _l_action']

Conversion map:
  From: Integer Ring
  To:   Symbolic Ring, None))
```



---

archive/issue_comments_274291.json:
```json
{
    "body": "<a id='comment:19'></a>So it seems the issue is coming from the fact that in 0.7.6.1, we have `type(parent(u)) is type` returning `False` before but with 1.0, it is `True`. Which, AFAICS, is only involved in `discover_action`, but the result is still a `None`.\n\n```\nsage: cm.discover_action(ZZ, parent(u(n)), operator.mul)   # Same in 0.7.6.1\n```\nAlthough to be fair, I think we should test against `u(n)` since parentheses get evaluated before `*`. In that case, I get the same result in both versions:\n\n```\nsage: parent(u)\n<class 'sympy.core.function.UndefinedFunction'>\nsage: parent(u(n))\nu\nsage: steps,res = cm.analyse(ZZ, parent(u(n))); steps\n['Will try _r_action and _l_action']\n```\n\nI'm thinking we will need someone who is much more familiar with the coercion framework than I am.",
    "created_at": "2016-03-13T11:33:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274291",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:19'></a>So it seems the issue is coming from the fact that in 0.7.6.1, we have `type(parent(u)) is type` returning `False` before but with 1.0, it is `True`. Which, AFAICS, is only involved in `discover_action`, but the result is still a `None`.

```
sage: cm.discover_action(ZZ, parent(u(n)), operator.mul)   # Same in 0.7.6.1
```
Although to be fair, I think we should test against `u(n)` since parentheses get evaluated before `*`. In that case, I get the same result in both versions:

```
sage: parent(u)
<class 'sympy.core.function.UndefinedFunction'>
sage: parent(u(n))
u
sage: steps,res = cm.analyse(ZZ, parent(u(n))); steps
['Will try _r_action and _l_action']
```

I'm thinking we will need someone who is much more familiar with the coercion framework than I am.



---

archive/issue_comments_274292.json:
```json
{
    "body": "<a id='comment:20'></a>And indeed, it was #14723 which prompted the addition of `_sage_` methods to many SymPy classes. So no way out of fixing coercion here.",
    "created_at": "2016-03-13T14:08:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274292",
    "user": "https://github.com/rwst"
}
```

<a id='comment:20'></a>And indeed, it was #14723 which prompted the addition of `_sage_` methods to many SymPy classes. So no way out of fixing coercion here.



---

archive/issue_comments_274293.json:
```json
{
    "body": "<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-13T16:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274293",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274294.json:
```json
{
    "body": "<a id='comment:22'></a>As you can see from #14723 the `UndefFunction._sage_` addition only affects future changes. This branch now has this removed from SymPy-1.0 to make it work with current Sage. Any changes to the coercion system because of future inclusion of `UndefFunction._sage_` can then be dealt with in a separate ticket which I'll open shortly. I didn't do a full test on this, so I'll have to have a final look at this tomorrow.",
    "created_at": "2016-03-13T16:44:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274294",
    "user": "https://github.com/rwst"
}
```

<a id='comment:22'></a>As you can see from #14723 the `UndefFunction._sage_` addition only affects future changes. This branch now has this removed from SymPy-1.0 to make it work with current Sage. Any changes to the coercion system because of future inclusion of `UndefFunction._sage_` can then be dealt with in a separate ticket which I'll open shortly. I didn't do a full test on this, so I'll have to have a final look at this tomorrow.



---

archive/issue_comments_274295.json:
```json
{
    "body": "<a id='comment:23'></a>Okay, I think I have a better understanding of things. So here's what I think is going on. The coercion system is working fine:\n\n```\nsage: import sympy\nsage: u = sympy.Function('u'); n = sympy.Symbol('n', integer=True)\nsage: import operator\nsage: cm = sage.structure.element.get_coercion_model()\n\nsage: cm.common_parent(3, u(n))\nSymbolic Ring\nsage: cm.common_parent(u(n), 3)\nSymbolic Ring\nsage: type(cm.bin_op(3, u(n), operator.mul))\n<type 'sage.symbolic.expression.Expression'>\nsage: type(cm.bin_op(u(n), 3, operator.mul))\n<type 'sage.symbolic.expression.Expression'>\n```\nThat is now returning something rather than erroring out. This is coming from\n\n```\nsage: (u(n))._sage_()\nu(n)\nsage: type(_)\n<type 'sage.symbolic.expression.Expression'>\n```\nWe go to the coercion framework because of `__mul__` from integers. Previously, because it was erroring out, the multiplication code then tried `__rmul__` from the SymPy function, which resulted in a SymPy object. Now, we get different behaviors because when the SymPy object is on the left, we call its `__mul__`, which results in a SymPy object.\n\nI'm also retracting the last part of comment:15, and the issue might be in SymPy and how it tries to parse our symbolic expressions:\n\n```\nsage: f = function('f')\nsage: x = var('x')\nsage: sympy.sympify(f(x), evaluate=False)\nf(x)\nsage: sympy.sympify(3*f(x), evaluate=False)\nAttributeError: 'Call' object has no attribute 'id'\n```\nHowever, we do seem to have our own troubles of constructing SymPy objects from symbolic expressions. All of these result in errors:\n\n```\nsage: f._sympy_()\nsage: f(x)._sympy_()\nsage: (f(x)+3)._sympy_()\n```\n\nI'm okay with your patch. Although we typically set the first patched version to `p0`.",
    "created_at": "2016-03-13T22:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274295",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:23'></a>Okay, I think I have a better understanding of things. So here's what I think is going on. The coercion system is working fine:

```
sage: import sympy
sage: u = sympy.Function('u'); n = sympy.Symbol('n', integer=True)
sage: import operator
sage: cm = sage.structure.element.get_coercion_model()

sage: cm.common_parent(3, u(n))
Symbolic Ring
sage: cm.common_parent(u(n), 3)
Symbolic Ring
sage: type(cm.bin_op(3, u(n), operator.mul))
<type 'sage.symbolic.expression.Expression'>
sage: type(cm.bin_op(u(n), 3, operator.mul))
<type 'sage.symbolic.expression.Expression'>
```
That is now returning something rather than erroring out. This is coming from

```
sage: (u(n))._sage_()
u(n)
sage: type(_)
<type 'sage.symbolic.expression.Expression'>
```
We go to the coercion framework because of `__mul__` from integers. Previously, because it was erroring out, the multiplication code then tried `__rmul__` from the SymPy function, which resulted in a SymPy object. Now, we get different behaviors because when the SymPy object is on the left, we call its `__mul__`, which results in a SymPy object.

I'm also retracting the last part of comment:15, and the issue might be in SymPy and how it tries to parse our symbolic expressions:

```
sage: f = function('f')
sage: x = var('x')
sage: sympy.sympify(f(x), evaluate=False)
f(x)
sage: sympy.sympify(3*f(x), evaluate=False)
AttributeError: 'Call' object has no attribute 'id'
```
However, we do seem to have our own troubles of constructing SymPy objects from symbolic expressions. All of these result in errors:

```
sage: f._sympy_()
sage: f(x)._sympy_()
sage: (f(x)+3)._sympy_()
```

I'm okay with your patch. Although we typically set the first patched version to `p0`.



---

archive/issue_comments_274296.json:
```json
{
    "body": "<a id='comment:24'></a>I changed the version to `p0`, but this is likely to only affect you (and really, doesn't do anything). I also fixed a failing doctest in `unicode_art.py` as it sends things to SymPy to create teh art. Otherwise all tests pass for me.\n\n---\nNew commits:",
    "created_at": "2016-03-13T23:16:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274296",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:24'></a>I changed the version to `p0`, but this is likely to only affect you (and really, doesn't do anything). I also fixed a failing doctest in `unicode_art.py` as it sends things to SymPy to create teh art. Otherwise all tests pass for me.

---
New commits:



---

archive/issue_comments_274297.json:
```json
{
    "body": "<a id='comment:25'></a>Your changes are fine. Consider them as reviewed.",
    "created_at": "2016-03-14T07:10:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274297",
    "user": "https://github.com/rwst"
}
```

<a id='comment:25'></a>Your changes are fine. Consider them as reviewed.



---

archive/issue_comments_274298.json:
```json
{
    "body": "<a id='comment:26'></a>> ...Any changes ~~to the coercion system~~ because of future inclusion of `UndefFunction._sage_` can then be dealt with in a separate ticket which I'll open shortly.\n\nSee #20204.",
    "created_at": "2016-03-14T07:51:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274298",
    "user": "https://github.com/rwst"
}
```

<a id='comment:26'></a>> ...Any changes ~~to the coercion system~~ because of future inclusion of `UndefFunction._sage_` can then be dealt with in a separate ticket which I'll open shortly.

See #20204.



---

archive/issue_comments_274299.json:
```json
{
    "body": "<a id='comment:27'></a>Thank you.",
    "created_at": "2016-03-14T20:41:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274299",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:27'></a>Thank you.



---

archive/issue_comments_274300.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-03-14T20:41:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274300",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_274301.json:
```json
{
    "body": "<a id='comment:28'></a>Thanks for the review.",
    "created_at": "2016-03-15T07:09:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274301",
    "user": "https://github.com/rwst"
}
```

<a id='comment:28'></a>Thanks for the review.



---

archive/issue_comments_274302.json:
```json
{
    "body": "<a id='comment:29'></a>PDF docs fail\n\n```\n! Emergency stop.\n<inserted text> \n                $\nl.22231 \\PYG{g+go}{    \u23ae   \u221ax}\n```",
    "created_at": "2016-03-20T20:14:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274302",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:29'></a>PDF docs fail

```
! Emergency stop.
<inserted text> 
                $
l.22231 \PYG{g+go}{    ⎮   √x}
```



---

archive/issue_comments_274303.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-03-20T20:14:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274303",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_274304.json:
```json
{
    "body": "<a id='comment:30'></a>Cannot confirm with `./sage --docbuild all pdf`. This is on OpenSuSE Leap with TeXLive 201384.",
    "created_at": "2016-03-21T07:28:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274304",
    "user": "https://github.com/rwst"
}
```

<a id='comment:30'></a>Cannot confirm with `./sage --docbuild all pdf`. This is on OpenSuSE Leap with TeXLive 201384.



---

archive/issue_comments_274305.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2016-03-21T07:28:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274305",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_events_054854.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2016-03-22T03:28:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "milestone": "sage-7.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20185#event-54854"
}
```



---

archive/issue_comments_274306.json:
```json
{
    "body": "<a id='comment:31'></a>I am unable to reproduce this either on my laptop either. Volker, can you post the logs if the buildbot fails again, along with its latex setup? Otherwise what we will have to do is change the test...",
    "created_at": "2016-03-22T03:28:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274306",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:31'></a>I am unable to reproduce this either on my laptop either. Volker, can you post the logs if the buildbot fails again, along with its latex setup? Otherwise what we will have to do is change the test...



---

archive/issue_comments_274307.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2016-03-22T03:28:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274307",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_comments_274308.json:
```json
{
    "body": "<a id='comment:32'></a>\n```\n$ rpm -q texlive\ntexlive-2014-19.20140525_r34255.fc23.x86_64\n```",
    "created_at": "2016-03-22T15:28:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274308",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:32'></a>
```
$ rpm -q texlive
texlive-2014-19.20140525_r34255.fc23.x86_64
```



---

archive/issue_comments_274309.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-03-22T15:28:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274309",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_274310.json:
```json
{
    "body": "<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-22T15:45:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274310",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_274311.json:
```json
{
    "body": "<a id='comment:34'></a>How could that have worked for you, `\\sqrt` in text mode should be illegal in all TeX versions.",
    "created_at": "2016-03-22T15:46:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274311",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:34'></a>How could that have worked for you, `\sqrt` in text mode should be illegal in all TeX versions.



---

archive/issue_comments_274312.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-03-22T15:46:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274312",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_274313.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-03-22T19:14:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274313",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_274314.json:
```json
{
    "body": "<a id='comment:35'></a>Hmm...strange. With your changes, everything works. Thank you for figuring out what the root of the problem is. :P",
    "created_at": "2016-03-22T19:14:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274314",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:35'></a>Hmm...strange. With your changes, everything works. Thank you for figuring out what the root of the problem is. :P



---

archive/issue_events_054855.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-03-23T12:46:48Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/20185#event-54855"
}
```



---

archive/issue_comments_274315.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-03-23T12:46:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20185",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20185#issuecomment-274315",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
