# Issue 20511: Not all empty schemes are created equal

archive/issues_020274.json:
```json
{
    "body": "In this example, both schemes are empty, so they should be equal as subschemes of P^2. However...\n\n```\nsage: P2.<x,y,z> = ProjectiveSpace(2, QQ)\nsage: P2.subscheme([x,y^2,z]) == P2.subscheme([x,y,z])\nFalse\n```\nWhile I'm at it, an `is_empty` method would be nice. It could be defined as follows:\n\n```\ndef self.is_empty():\n   return (len(self.irreducible_components() == 0)\n```\n\nKeywords: schemes, empty\n\nAuthor: Kiran Kedlaya\n\nBranch: u/kedlaya/not_all_empty_schemes_are_created_equal\n\nStatus: new\n\nDependencies: #21297\n\nCommit: 8b00ed9ce22c6ca4641a09cfc0bc8ece2bdb66f0\n\nIssue created by migration from https://trac.sagemath.org/ticket/20511\n\n",
    "created_at": "2016-04-27T20:54:37Z",
    "labels": [
        "component: algebraic geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "Not all empty schemes are created equal",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20511",
    "user": "https://github.com/kedlaya"
}
```
In this example, both schemes are empty, so they should be equal as subschemes of P^2. However...

```
sage: P2.<x,y,z> = ProjectiveSpace(2, QQ)
sage: P2.subscheme([x,y^2,z]) == P2.subscheme([x,y,z])
False
```
While I'm at it, an `is_empty` method would be nice. It could be defined as follows:

```
def self.is_empty():
   return (len(self.irreducible_components() == 0)
```

Keywords: schemes, empty

Author: Kiran Kedlaya

Branch: u/kedlaya/not_all_empty_schemes_are_created_equal

Status: new

Dependencies: #21297

Commit: 8b00ed9ce22c6ca4641a09cfc0bc8ece2bdb66f0

Issue created by migration from https://trac.sagemath.org/ticket/20511





---

archive/issue_comments_375633.json:
```json
{
    "body": "<a id='comment:1'></a>\nProjective scheme comparison should compare ideals saturated with respect to the irrelevant ideal:\n\n```\nsage: U=P2.subscheme([x,y,z])\nsage: V=P2.subscheme([x,y^2,z])\nsage: J=U.defining_ideal()\nsage: U.defining_ideal().saturation(J)[0] == V.defining_ideal().saturation(J)[0] \nTrue\n```\n\nSimilarly, the `is_empty` should do:\n\n```\nsage: one_ideal= J^0 #just get the ideal generated by 1\nsage: U.defining_ideal().saturation(J)[0] == one_ideal\n```\ndecomposing in irreducible components is a more expensive operation.",
    "created_at": "2016-04-27T22:15:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20511#issuecomment-375633",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:1'></a>
Projective scheme comparison should compare ideals saturated with respect to the irrelevant ideal:

```
sage: U=P2.subscheme([x,y,z])
sage: V=P2.subscheme([x,y^2,z])
sage: J=U.defining_ideal()
sage: U.defining_ideal().saturation(J)[0] == V.defining_ideal().saturation(J)[0] 
True
```

Similarly, the `is_empty` should do:

```
sage: one_ideal= J^0 #just get the ideal generated by 1
sage: U.defining_ideal().saturation(J)[0] == one_ideal
```
decomposing in irreducible components is a more expensive operation.



---

archive/issue_comments_375634.json:
```json
{
    "body": "<a id='comment:2'></a>\nReplying to [nbruin](#comment%3A1):\n> Projective scheme comparison should compare ideals saturated with respect to the irrelevant ideal:\n> \n> \n> ```\n> sage: U=P2.subscheme([x,y,z])\n> sage: V=P2.subscheme([x,y^2,z])\n> sage: J=U.defining_ideal()\n> sage: U.defining_ideal().saturation(J)[0] == V.defining_ideal().saturation(J)[0] \n> True\n> ```\n> \nAgreed. I guess we don't want to transform the generating set at creation, so we can recover the generators as specified, but maybe we want to cache the saturation?\n\n> Similarly, the `is_empty` should do:\n> \n> ```\n> sage: one_ideal= J^0 #just get the ideal generated by 1\n> sage: U.defining_ideal().saturation(J)[0] == one_ideal\n> ```\n> decomposing in irreducible components is a more expensive operation.\n\n\nAgreed again.",
    "created_at": "2016-04-27T23:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20511#issuecomment-375634",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:2'></a>
Replying to [nbruin](#comment%3A1):
> Projective scheme comparison should compare ideals saturated with respect to the irrelevant ideal:
> 
> 
> ```
> sage: U=P2.subscheme([x,y,z])
> sage: V=P2.subscheme([x,y^2,z])
> sage: J=U.defining_ideal()
> sage: U.defining_ideal().saturation(J)[0] == V.defining_ideal().saturation(J)[0] 
> True
> ```
> 
Agreed. I guess we don't want to transform the generating set at creation, so we can recover the generators as specified, but maybe we want to cache the saturation?

> Similarly, the `is_empty` should do:
> 
> ```
> sage: one_ideal= J^0 #just get the ideal generated by 1
> sage: U.defining_ideal().saturation(J)[0] == one_ideal
> ```
> decomposing in irreducible components is a more expensive operation.


Agreed again.



---

archive/issue_comments_375635.json:
```json
{
    "body": "<a id='comment:3'></a>\nAlso note that if we change equality we also have to change the hash, i.e., the hash should be the hash of the generators of the groebner basis of the saturation of the defining ideal. That'll probably shake out another few bugs out of the doctests.",
    "created_at": "2016-04-28T17:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20511#issuecomment-375635",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:3'></a>
Also note that if we change equality we also have to change the hash, i.e., the hash should be the hash of the generators of the groebner basis of the saturation of the defining ideal. That'll probably shake out another few bugs out of the doctests.



---

archive/issue_comments_375636.json:
```json
{
    "body": "Changing commit from \"\" to \"433a479a3d98d1fe0916d9ab3bcb06053004551e\"",
    "created_at": "2016-08-18T17:03:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20511#issuecomment-375636",
    "user": "https://github.com/kedlaya"
}
```

Changing commit from "" to "433a479a3d98d1fe0916d9ab3bcb06053004551e"



---

archive/issue_comments_375637.json:
```json
{
    "body": "Changing author from \"\" to \"Kiran Kedlaya\"",
    "created_at": "2016-08-18T17:03:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20511#issuecomment-375637",
    "user": "https://github.com/kedlaya"
}
```

Changing author from "" to "Kiran Kedlaya"



---

archive/issue_comments_375638.json:
```json
{
    "body": "Changing branch from \"\" to \"u/kedlaya/not_all_empty_schemes_are_created_equal\"",
    "created_at": "2016-08-18T17:03:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20511#issuecomment-375638",
    "user": "https://github.com/kedlaya"
}
```

Changing branch from "" to "u/kedlaya/not_all_empty_schemes_are_created_equal"



---

archive/issue_comments_375639.json:
```json
{
    "body": "<a id='comment:4'></a>\nSpeaking of shaking out bugs, here is a first attempt (minus the hash), which already runs into something further afield:\n\n```\nsage -t --warn-long 237.1 src/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.py\n**********************************************************************\nFile \"src/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.py\", line 809, in sage.schemes.hyperelliptic_curves.hyperelliptic_padic_field.HyperellipticCurve_padic_field.coleman_integral\nFailed example:\n    HK.coleman_integral(w,S,P)\nException raised:\n    Traceback (most recent call last):\n      File \"/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 495, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 858, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.schemes.hyperelliptic_curves.hyperelliptic_padic_field.HyperellipticCurve_padic_field.coleman_integral[70]>\", line 1, in <module>\n        HK.coleman_integral(w,S,P)\n      File \"/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/local/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.py\", line 837, in coleman_integral\n        basis_values = self.coleman_integrals_on_basis(P, Q, algorithm)\n      File \"/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/local/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.py\", line 621, in coleman_integrals_on_basis\n        M_frob, forms = self._frob_calc = monsky_washnitzer.matrix_of_frobenius_hyperelliptic(self)\n      File \"/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/local/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/monsky_washnitzer.py\", line 1799, in matrix_of_frobenius_hyperelliptic\n        S = SpecialHyperellipticQuotientRing(Q, extra_prec_ring, True)\n      File \"sage/misc/classcall_metaclass.pyx\", line 330, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/src/build/cythonized/sage/misc/classcall_m\netaclass.c:1251)\n        return cls.classcall(cls, *args, **kwds)\n      File \"sage/misc/cachefunc.pyx\", line 1057, in sage.misc.cachefunc.CachedFunction.__call__ (/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/src/build/cythonized/sage/misc/cachefunc.c:5558)\n        return self.cache[k]\n      File \"sage/misc/weak_dict.pyx\", line 874, in sage.misc.weak_dict.WeakValueDictionary.__getitem__ (/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/src/build/cythonized/sage/misc/weak_dict.c:3905)\n        cdef PyObject* wr = PyDict_GetItemWithError(self, k)\n      File \"sage/misc/weak_dict.pyx\", line 150, in sage.misc.weak_dict.PyDict_GetItemWithError (/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/src/build/cythonized/sage/misc/weak_dict.c:1259)\n        ep = mp.ma_lookup(mp, <PyObject*><void*>key, PyObject_Hash(key))\n      File \"/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/local/lib/python2.7/site-packages/sage/schemes/generic/algebraic_scheme.py\", line 2299, in __eq__\n        return(self.saturated_defining_ideal() == other.saturated_defining_ideal())\n      File \"/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/local/lib/python2.7/site-packages/sage/schemes/generic/algebraic_scheme.py\", line 2280, in saturated_defining_ideal\n        I3 = I1.saturation(I2)[0]\n      File \"/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py\", line 2083, in saturation\n        ideal, expo = sat(self, other)\n      File \"sage/libs/singular/function.pyx\", line 1319, in sage.libs.singular.function.SingularFunction.__call__ (/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/src/build/cythonized/sage/libs/singular/functio\nn.cpp:14767)\n        raise TypeError(\"Cannot call Singular function '%s' with ring parameter of type '%s'\"%(self._name,type(ring)))\n    TypeError: Cannot call Singular function 'sat' with ring parameter of type '<class 'sage.rings.polynomial.multi_polynomial_ring.MPolynomialRing_polydict_domain_with_category'>'\n**********************************************************************\n```\nSo it seems that there is something wrong with the definition of `saturation` in `sage/rings/polynomial/multi_polynomial_ideal.py`.\n\n---\nNew commits:\n|                                                                                                                                          |                                                 |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------|\n|[433a479](https://github.com/sagemath/sagetrac-mirror/commit/433a479a3d98d1fe0916d9ab3bcb06053004551e)|`Correct equality testing for projective schemes`|",
    "created_at": "2016-08-18T17:03:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20511#issuecomment-375639",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:4'></a>
Speaking of shaking out bugs, here is a first attempt (minus the hash), which already runs into something further afield:

```
sage -t --warn-long 237.1 src/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.py
**********************************************************************
File "src/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.py", line 809, in sage.schemes.hyperelliptic_curves.hyperelliptic_padic_field.HyperellipticCurve_padic_field.coleman_integral
Failed example:
    HK.coleman_integral(w,S,P)
Exception raised:
    Traceback (most recent call last):
      File "/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 495, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.hyperelliptic_curves.hyperelliptic_padic_field.HyperellipticCurve_padic_field.coleman_integral[70]>", line 1, in <module>
        HK.coleman_integral(w,S,P)
      File "/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/local/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.py", line 837, in coleman_integral
        basis_values = self.coleman_integrals_on_basis(P, Q, algorithm)
      File "/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/local/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.py", line 621, in coleman_integrals_on_basis
        M_frob, forms = self._frob_calc = monsky_washnitzer.matrix_of_frobenius_hyperelliptic(self)
      File "/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/local/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/monsky_washnitzer.py", line 1799, in matrix_of_frobenius_hyperelliptic
        S = SpecialHyperellipticQuotientRing(Q, extra_prec_ring, True)
      File "sage/misc/classcall_metaclass.pyx", line 330, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/src/build/cythonized/sage/misc/classcall_m
etaclass.c:1251)
        return cls.classcall(cls, *args, **kwds)
      File "sage/misc/cachefunc.pyx", line 1057, in sage.misc.cachefunc.CachedFunction.__call__ (/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/src/build/cythonized/sage/misc/cachefunc.c:5558)
        return self.cache[k]
      File "sage/misc/weak_dict.pyx", line 874, in sage.misc.weak_dict.WeakValueDictionary.__getitem__ (/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/src/build/cythonized/sage/misc/weak_dict.c:3905)
        cdef PyObject* wr = PyDict_GetItemWithError(self, k)
      File "sage/misc/weak_dict.pyx", line 150, in sage.misc.weak_dict.PyDict_GetItemWithError (/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/src/build/cythonized/sage/misc/weak_dict.c:1259)
        ep = mp.ma_lookup(mp, <PyObject*><void*>key, PyObject_Hash(key))
      File "/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/local/lib/python2.7/site-packages/sage/schemes/generic/algebraic_scheme.py", line 2299, in __eq__
        return(self.saturated_defining_ideal() == other.saturated_defining_ideal())
      File "/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/local/lib/python2.7/site-packages/sage/schemes/generic/algebraic_scheme.py", line 2280, in saturated_defining_ideal
        I3 = I1.saturation(I2)[0]
      File "/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.py", line 2083, in saturation
        ideal, expo = sat(self, other)
      File "sage/libs/singular/function.pyx", line 1319, in sage.libs.singular.function.SingularFunction.__call__ (/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/src/build/cythonized/sage/libs/singular/functio
n.cpp:14767)
        raise TypeError("Cannot call Singular function '%s' with ring parameter of type '%s'"%(self._name,type(ring)))
    TypeError: Cannot call Singular function 'sat' with ring parameter of type '<class 'sage.rings.polynomial.multi_polynomial_ring.MPolynomialRing_polydict_domain_with_category'>'
**********************************************************************
```
So it seems that there is something wrong with the definition of `saturation` in `sage/rings/polynomial/multi_polynomial_ideal.py`.

---
New commits:
|                                                                                                                                          |                                                 |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------|
|[433a479](https://github.com/sagemath/sagetrac-mirror/commit/433a479a3d98d1fe0916d9ab3bcb06053004551e)|`Correct equality testing for projective schemes`|



---

archive/issue_comments_375640.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#21297\"",
    "created_at": "2016-08-19T21:11:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20511#issuecomment-375640",
    "user": "https://github.com/kedlaya"
}
```

Changing dependencies from "" to "#21297"



---

archive/issue_comments_375641.json:
```json
{
    "body": "<a id='comment:5'></a>\nIt might be that dealing with hashing will help with this. But hashing ideals itself need to be fixed; see #21297 (which itself has dependencies on hashing for polynomials).",
    "created_at": "2016-08-19T21:11:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20511#issuecomment-375641",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:5'></a>
It might be that dealing with hashing will help with this. But hashing ideals itself need to be fixed; see #21297 (which itself has dependencies on hashing for polynomials).



---

archive/issue_comments_375642.json:
```json
{
    "body": "Changing commit from \"433a479a3d98d1fe0916d9ab3bcb06053004551e\" to \"8b00ed9ce22c6ca4641a09cfc0bc8ece2bdb66f0\"",
    "created_at": "2016-08-19T22:57:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20511#issuecomment-375642",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "433a479a3d98d1fe0916d9ab3bcb06053004551e" to "8b00ed9ce22c6ca4641a09cfc0bc8ece2bdb66f0"



---

archive/issue_comments_375643.json:
```json
{
    "body": "<a id='comment:6'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                            |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------|\n|[8b00ed9](https://github.com/sagemath/sagetrac-mirror/commit/8b00ed9ce22c6ca4641a09cfc0bc8ece2bdb66f0)|`Extra commit, not sure why`|",
    "created_at": "2016-08-19T22:57:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20511",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20511#issuecomment-375643",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                            |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------|
|[8b00ed9](https://github.com/sagemath/sagetrac-mirror/commit/8b00ed9ce22c6ca4641a09cfc0bc8ece2bdb66f0)|`Extra commit, not sure why`|
