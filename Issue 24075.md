# Issue 24075: py3: fixes to sage.misc.sageinspect

Issue created by migration from https://trac.sagemath.org/ticket/24312

Original creator: embray

Original creation time: 2017-12-01 14:53:50

CC:  nthiery

I felt it might be important to make sure these functions were working properly, as some of Sage's metaprogramming and related tests rely on reliable introspection.

A number of the tests in this module only made sense on Python 2 due to minor syntactic differences or similar minor differences between the languages; in some cases I provided Python 3 alternatives, in other cases the test is just run on Python 2.  In still other cases I changed the test slightly to work on both, where I felt that it didn't impact the validity of the test.


---

Comment by embray created at 2017-12-01 14:57:48

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-01-12 16:08:03

Why the changes to `src/sage/misc/nested_class_test.py`?


---

Comment by jdemeyer created at 2018-01-12 16:14:20

This was meant to support `unicode` in Python 2:

```
    elif isinstance(r, text_type):
        # On Python 2, we want str, not unicode
        return r.encode('utf-8', 'ignore')
```

Are you sure that this is no longer needed?


---

Comment by jdemeyer created at 2018-01-12 16:17:18

Did you intentionally duplicate this line

```
iter_lines = iter(lines)
```



---

Comment by embray created at 2018-01-12 16:19:15

Replying to [comment:2 jdemeyer]:
> Why the changes to `src/sage/misc/nested_class_test.py`?

I don't think I intended to include that in this branch.  I can either remove it, or it can come along for the ride since it's a minor change that has to happen anyways. Up to you.


---

Comment by jdemeyer created at 2018-01-12 16:20:09

What's up with this:

```
        sage: warnings.filterwarnings('ignore',
        ....:                         r'inspect.getargspec\(\) is deprecated',
        ....:                         DeprecationWarning)
```

If it's genuinely deprecated, we shouldn't use it... silencing the warning doesn't help with that.


---

Comment by jdemeyer created at 2018-01-12 16:21:25

Replying to [comment:5 embray]:
> since it's a minor change that has to happen anyways

Please explain why it "has to happen anyways". Do you intend to replace

```
class X
```

by

```
class X(object)
```

everywhere?


---

Comment by embray created at 2018-01-12 16:22:22

Replying to [comment:3 jdemeyer]:
> This was meant to support `unicode` in Python 2:
> {{{
>     elif isinstance(r, text_type):
>         # On Python 2, we want str, not unicode
>         return r.encode('utf-8', 'ignore')
> }}}
> Are you sure that this is no longer needed?

Ah, I see. This needs to be fixed regardless since on Python 3 it was converting `str` to `bytes`.  I don't think it's needed on Python 2 unless there's some explicit reason that this function can't _return_ a unicode string, and I don't see that there is.


---

Comment by jdemeyer created at 2018-01-12 16:22:29

This is redundant:

```
        sage: sgc("def dummy_python(self, *args, x=1): pass")  # py3
        sage: sgc("def dummy_cython(self, *args, x=1): pass")
```



---

Comment by jdemeyer created at 2018-01-12 16:24:41

Note to self: this obviously affects docbuilding. So one should check that it doesn't introduce any regressions in the documentation.


---

Comment by embray created at 2018-01-12 16:27:16

Replying to [comment:7 jdemeyer]:
> Replying to [comment:5 embray]:
> > since it's a minor change that has to happen anyways
> 
> Please explain why it "has to happen anyways". Do you intend to replace
> {{{
> class X
> }}}
> by
> {{{
> class X(object)
> }}}
> everywhere?

That's a tricky question, probably for discussion elsewhere (that is, if it requires further discussion I'll just remove the change from this ticket for now).  I don't think it needs to be changed _everywhere_ but for the purposes of _tests_ that are the same on Python 2 and Python 3 old-style classes often won't work (if nothing else their repr is different), and I would prefer to standardize on new-style classes.


---

Comment by jdemeyer created at 2018-01-12 16:31:36

Replying to [comment:11 embray]:
> I would prefer to standardize on new-style classes.

For the record: I agree. It's just that we should continue to support old-style classes on Python 2. So if a test is specifically meant to test old-style classes, it should be kept.

If you are in Orsay, please talk to Nicolas about this. He usually insists on using and supporting old-style classes.

> if it requires further discussion I'll just remove the change from this ticket for now

If that's easy to do: please do so.


---

Comment by embray created at 2018-01-15 09:36:56

I think there are cases that makes sense, but I recall in this case that there was absolutely nothing about the test that specifically required it to be an old-style class.


---

Comment by jdemeyer created at 2018-01-15 09:41:32

Replying to [comment:13 embray]:
> in this case that there was absolutely nothing about the test that specifically required it to be an old-style class.

The question is not "does this test _require_ an old-style class?". The question is "is this meant to _test_ old-style classes?"


---

Comment by embray created at 2018-01-15 09:46:56

Replying to [comment:13 embray]:
> I think there are cases that makes sense, but I recall in this case that there was absolutely nothing about the test that specifically required it to be an old-style class.

Speaking of which, it turns out that change _was_ relevant to this ticket, because one of the tests in sageinspect uses `TestNestedParent` from that module.  The only reason I can tell that its even in a separate module is that it's related to testing `sage_getsource`.

And no, it's not meant to test old-style classes.  That's what I was saying.  It would be easier to see this if we had actual test coverage analysis for Sage but this change is irrelevant to the test.


---

Comment by embray created at 2018-01-15 09:52:30

It also rather annoyingly contains an exact duplicate of most of the same doctest that's in sageinspect.  I would just as soon remove that.


---

Comment by git created at 2018-01-15 10:00:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2018-01-15 18:29:25

Replying to [comment:15 embray]:
> And no, it's not meant to test old-style classes.

I'm not convinced. The test is meant to test the pattern

```
class NewStyle(...):
    class Element:
        ...
```

which occurs a lot in Sage. It's not obvious to me why it doesn't matter if `Element` is a new-style or old-style class.


---

Comment by embray created at 2018-01-16 16:44:15

It's only meant to test _extracting the source code_ of nested classes.  If you trace the code for doing that you'll find that it's fairly general code for nested statements in general (nested functions and classes) and just about the only point at which the fact of it being a class comes in is in calls to `inspect.isclass()` which returns True for both old-style and new-style classes on Python 2.


---

Comment by jdemeyer created at 2018-01-16 17:17:29

OK, let me turn the question around: if it doesn't matter whether it's an old-style or new-style class, why do you insist on changing it to a new-style class? Why not leave it alone?


---

Comment by embray created at 2018-01-16 17:23:43

Replying to [comment:20 jdemeyer]:
> OK, let me turn the question around: if it doesn't matter whether it's an old-style or new-style class, why do you insist on changing it to a new-style class? Why not leave it alone?

In this case the _only_ reason was because there was some part of the test that checked the repr of the nested class, and new-style and old-style classes have different reprs :(

Alternatively I could add a fixup for this to the doctest parser as I've done in other cases.  This isn't the only example I've found like this.  It's usually just simpler to convert to a new-style class except in the miniscule number cases where that has an impact on what's being tested.


---

Comment by jdemeyer created at 2018-01-29 13:54:53

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-01-29 13:54:53

Merge conflict.


---

Comment by chapoton created at 2018-02-12 13:00:01

New commits:


---

Comment by chapoton created at 2018-02-12 13:00:01

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-02-12 13:32:40

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-02-12 13:32:40

There is still the issue of replacing old-style by new-classes classes.


---

Comment by nthiery created at 2018-02-13 22:23:21

Replying to [comment:12 jdemeyer]:
> If you are in Orsay, please talk to Nicolas about this. He usually insists on using and supporting old-style classes.

Just to clarify, let me elaborate on that. I am not specifically keen on old-style classes per se. In fact, if there would be an easy way to "configure" Python so that

```
    class A:
        ...
```

would always create a new style class, that would be very fine.

On the other hand, we have quite some of code in Sage *and* outside of Sage (in packages or users private code) that use the idiom:

```
    class A(...):
        class Element:
            ...
```


It would not be a practical to have to change this everywhere to

```
    class A(...):
        class Element(object):
            ...
```

when anyway that won't be needed anymore with Python 3.

Cheers,


---

Comment by jdemeyer created at 2018-02-14 06:21:29

Replying to [comment:26 nthiery]:
> In fact, if there would be an easy way to "configure" Python so that
> {{{
>     class A:
>         ...
> }}}
> would always create a new style class, that would be very fine.

I agree. I sometimes wonder why there is no `from __future__ import new_class` in Python 2.


---

Comment by embray created at 2018-02-14 16:11:08

I'll just point out, yet again, that for the purposes of this test it's completely irrelevant.

I'm going to rebase my original branch.  I really don't like bi-directional merges.  It's much harder to reason about.


---

Comment by embray created at 2018-02-14 16:14:58

New commits:


---

Comment by embray created at 2018-02-14 16:15:23

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-02-19 12:49:36

This does not build correctly.


---

Comment by chapoton created at 2018-02-19 12:49:36

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-02-19 12:54:50

Looks like there's a missing import now--possibly somehow resulting from my last rebase.


---

Comment by git created at 2018-02-19 14:18:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-02-19 14:18:36

Rebased; fixed missing import.


---

Comment by embray created at 2018-02-19 14:18:36

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-03-09 10:35:50

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-03-09 10:35:50

Replying to [comment:28 embray]:
> I'll just point out, yet again, that for the purposes of this test it's completely irrelevant.

That test is meant to test _actual usage_ of nested classes. If there is actual usage of nested classes with old-style classes, it should be tested.

Maybe a compromise would be to test it both with old-style and new-style classes and mark the former `# py2`.


---

Comment by embray created at 2018-03-09 10:56:10

Replying to [comment:35 jdemeyer]:
> Replying to [comment:28 embray]:
> > I'll just point out, yet again, that for the purposes of this test it's completely irrelevant.
> 
> That test is meant to test _actual usage_ of nested classes. If there is actual usage of nested classes with old-style classes, it should be tested.

But the functionality it's testing has nothing to do with whether or not it's an old-style class.  If it did I'd agree.  It's completely irrelevant though.


---

Comment by embray created at 2018-03-09 11:01:48

Replying to [comment:35 jdemeyer]:
> Maybe a compromise would be to test it both with old-style and new-style classes and mark the former `# py2`.

I'll go with your compromise, but it's still unnecessary.  You can see that the code that this affects is actually completely unconcerned with whether or not there's an `(object)` there (the regexp that checks for the first line of a class definition doesn't even care): https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/misc/sageinspect.py?id=7de19b8b561eec01557c878cdb5135bbad5fa81c#n2133


---

Comment by git created at 2018-03-09 11:13:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2018-03-09 11:13:39

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-03-09 11:23:56

[comment:4] still applies


---

Comment by embray created at 2018-03-09 11:28:40

Replying to [comment:40 jdemeyer]:
> [comment:4] still applies
Oops, thanks.

If that's the only issue that remains I'll fix it and set positive review.


---

Comment by jdemeyer created at 2018-03-09 11:29:31

[comment:6] and [comment:9] still apply too


---

Comment by jdemeyer created at 2018-03-09 11:30:29

And [comment:3]


---

Comment by git created at 2018-03-09 11:31:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2018-03-09 11:39:37

Replying to [comment:9 jdemeyer]:
> This is redundant:
> {{{
>         sage: sgc("def dummy_python(self, *args, x=1): pass")  # py3
>         sage: sgc("def dummy_cython(self, *args, x=1): pass")
> }}}

Effectively yes, but not logically.  This is performing the same test on Python 3 as on Python 2 and demonstrating that they have different outcomes.


---

Comment by jdemeyer created at 2018-03-09 11:40:08

For future reference: it would be good to separate commits like [this](https://git.sagemath.org/sage.git/commit/?id=6c09c501b19fce0b61246207d267e087f5c5b1bf) to their own ticket. They contain many trivial changes, making the diff harder to read. For now, just leave it: I'll look at the diff relative to that commit.


---

Comment by jdemeyer created at 2018-03-09 11:42:53

Replying to [comment:45 embray]:
> Replying to [comment:9 jdemeyer]:
> > This is redundant:
> > {{{
> >         sage: sgc("def dummy_python(self, *args, x=1): pass")  # py3
> >         sage: sgc("def dummy_cython(self, *args, x=1): pass")
> > }}}
> 
> Effectively yes, but not logically.  This is performing the same test on Python 3 as on Python 2 and demonstrating that they have different outcomes.

No, on Python 3 it performs the same test twice. And the outcome is obviously the same (apart from the "dummy_cython" string).


---

Comment by embray created at 2018-03-09 11:45:38

Replying to [comment:6 jdemeyer]:
> What's up with this:
> {{{
>         sage: warnings.filterwarnings('ignore',
>         ....:                         r'inspect.getargspec\(\) is deprecated',
>         ....:                         DeprecationWarning)
> }}}
> If it's genuinely deprecated, we shouldn't use it... silencing the warning doesn't help with that.

`inspect.getargspec` is not used in any of the code, only in some of the doctests  The reason to keep it is that the output of `sage_getargspec` is the same as the output of `inspect.getargspec` and this tests that that is the case.

The only alternative would be to change `sage_getargspec` to be equivalent to `inspect.getfullargspec` which has no equivalent on Python 2, and then have separate tests for Python 2 and 3.  I'd be okay with that, but it's a slightly larger change.


---

Comment by jdemeyer created at 2018-03-09 11:46:30

This change looks like it might break stuff:

```diff
@@ -2247,10 +2254,10 @@ def sage_getsourcelines(obj):
 
     # First, we deal with nested classes. Their name contains a dot, and we
     # have a special function for that purpose.
-    if (not hasattr(obj, '__class__')) or (isinstance(obj, type) and type(obj) is not type):
+    if not hasattr(obj, '__class__') or isinstance(obj, type):
```


I agree that the original code was strange (looking specifically for a metaclass different from `type`), but maybe there was a reason...


---

Comment by embray created at 2018-03-09 11:50:21

Replying to [comment:3 jdemeyer]:
> This was meant to support `unicode` in Python 2:
> {{{
>     elif isinstance(r, text_type):
>         # On Python 2, we want str, not unicode
>         return r.encode('utf-8', 'ignore')
> }}}
> Are you sure that this is no longer needed?

I see--this should probably updated so that the previous line is `isinstance(r, six.string_types)`.  The fact that this was encoding unicode docstrings to utf-8 is definitely wrong.  They should just be kept as unicode.


---

Comment by git created at 2018-03-09 11:55:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-03-09 12:01:43

Replying to [comment:47 jdemeyer]:
> Replying to [comment:45 embray]:
> > Replying to [comment:9 jdemeyer]:
> > > This is redundant:
> > > {{{
> > >         sage: sgc("def dummy_python(self, *args, x=1): pass")  # py3
> > >         sage: sgc("def dummy_cython(self, *args, x=1): pass")
> > > }}}
> > 
> > Effectively yes, but not logically.  This is performing the same test on Python 3 as on Python 2 and demonstrating that they have different outcomes.
> 
> No, on Python 3 it performs the same test twice. And the outcome is obviously the same (apart from the "dummy_cython" string).

Yes, I understand that. But if you inspect carefully you'll see that logically it's harder to follow the example if not for the slight duplication.  As I just wrote above, the pure Python case is different for Python 2 and Python 3, while the Cython case should work the same for both.  Writing it like this makes that clearer.


---

Comment by embray created at 2018-03-09 12:04:26

In other words, the two cases are _not_ redundant on Python 2, but they happen to be redundant on Python 3 since Cython syntax is Python 3 compatible.  But the two examples have different meanings.


---

Comment by embray created at 2018-03-09 12:13:19

Replying to [comment:49 jdemeyer]:
> This change looks like it might break stuff:
> {{{
> #!diff
> `@``@` -2247,10 +2254,10 `@``@` def sage_getsourcelines(obj):
>  
>      # First, we deal with nested classes. Their name contains a dot, and we
>      # have a special function for that purpose.
> -    if (not hasattr(obj, '__class__')) or (isinstance(obj, type) and type(obj) is not type):
> +    if not hasattr(obj, '__class__') or isinstance(obj, type):
> }}}
> 
> I agree that the original code was strange (looking specifically for a metaclass different from `type`), but maybe there was a reason...

Weird, but I see what you're saying.  This code originally had `hasattr(obj, '__metaclass__')` and you changed it to this.  Let me make sure there isn't some reason I felt I had to change that.


---

Comment by embray created at 2018-03-09 12:17:39

The other thing is that this doesn't necessarily guarantee there isn't a metaclass.  On Python 2, `__metaclass__` can be any callable that's used to instantiate the type object.  So a class with a `__metaclass__` can still be exactly of type `type`.  On Python 3 this remains true when passing `metaclass=`, but I think there's been some discussion about deprecating that usage.  I don't think this usage turns up anywhere in Sage though and I'm not sure why it mattered here.


---

Comment by embray created at 2018-03-09 12:26:46

Well, reverting that change definitely causes more tests to fail, so there was probably a reason.  But it might be that a different fix is needed...


---

Comment by git created at 2018-03-09 12:57:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-03-09 13:02:26

Replying to [comment:57 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[ba3fcc0](https://git.sagemath.org/sage.git/commit/?id=ba3fcc02d9df59f8ddb1158c33bcd6b59f535616)||`Originally this was actually over-restrictive: Checking for either an old-style class, or a new-style class with a custom metaclass.`||

As the commit message says, this line was originally trying to be _too_ precise.  It was trying to handle a case like:

    {{{
    #!python
    class SomeCategory(Category):
        class ParentMethods:
            pass
    }}}

then calling `sage_getsource(SomeCategory.parent_class)` where `parent_class` is a `DynamicMetaclass`.  In this case it would go through `SomeCategory.parent_class._sage_src_lines_()` which in turn would look up the source lines for the actual class `SomeCategory.ParentMethods`, which on Python 2 was an old-style class.

So this code was really just trying to catch exactly any case where we had either an old-style class, or a class with a custom metaclass.  But really there's no reason for that restriction.  All that actually matters is that it's a class (of any type) with a dotted name.


---

Comment by jdemeyer created at 2018-03-09 14:22:59


```
sage: from sage.misc.sageinspect import sage_getdoc
sage: sage_getdoc(sage.categories.category_types.AbelianCategory)
''
```



---

Comment by jdemeyer created at 2018-03-09 14:22:59

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-03-09 14:26:47

This is actually an existing bug. `AbelianCategory` has no doc, but a doc is returned anyway.


---

Comment by jdemeyer created at 2018-03-09 14:31:52

Let wait with this until #24936 is fixed.


---

Comment by chapoton created at 2018-03-28 12:31:49

can we start to move on again here ?


---

Comment by embray created at 2018-03-28 14:32:37

I don't think this actually needs any additional work...


---

Comment by jdemeyer created at 2018-03-28 18:26:46

As usual, I prefer to review this once all dependencies have been merged.


---

Comment by jdemeyer created at 2018-03-29 05:33:58

Needs rebase to 8.2.rc0


---

Comment by git created at 2018-03-29 15:36:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2018-03-29 15:36:59

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-03-29 15:36:59

Rebased


---

Comment by chapoton created at 2018-03-30 07:36:29

and bot is morally green


---

Comment by jdemeyer created at 2018-03-30 10:25:42

I'll test it.


---

Comment by jdemeyer created at 2018-03-30 17:11:16

Doc still builds fine with this branch.


---

Comment by jdemeyer created at 2018-04-02 15:11:09

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2018-04-02 15:11:09

I do not agree with everything in this branch, but let's move forward.


---

Comment by vbraun created at 2018-05-08 17:27:02

Resolution: fixed
