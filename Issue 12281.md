# Issue 12281: Refactor integer vectors using ClonableIntArray Cython data structure

Issue created by migration from Trac.

Original creator: nborie

Original creation time: 2012-02-06 15:59:44

Assignee: nborie

CC:  sage-combinat chapoton darij

Keywords: Integer, vectors, cython, clone, Cernay2012

Why that ? Because :

 * Integer Vectors have no element class
 * Integer Vectors elements must be immutable and hashable
 * Clean the old code with new specification
 * Add documentation
 * Deal with coeherence beetween extra arguments of the constructor
 * ...


---

Comment by tscrim created at 2013-02-22 04:37:29

Initial version.


---

Comment by tscrim created at 2013-02-22 04:37:29

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2013-06-04 06:56:23

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2013-06-04 06:56:23

Please update the patch as it does not apply on sage-5.10

```
patching file sage/combinat/integer_vector_weighted.py
Hunk #1 FAILED at 2
Hunk #3 FAILED at 64
Hunk #4 FAILED at 173
```



---

Comment by tscrim created at 2013-07-08 16:49:00

New version (which can be commuted past #14101 and #14772 at minor cost due to doc[string] changes). Also part of #12913.


---

Comment by tscrim created at 2013-07-08 16:49:00

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2013-07-14 08:58:48

Changing type from task to enhancement.


---

Attachment


---

Comment by tscrim created at 2013-12-20 02:53:14

Branch version at public/refactor_integer_vectors-12453 but trac is responding with a 'unicode' object not callable error.


---

Comment by tscrim created at 2013-12-21 15:41:42

New commits:


---

Comment by git created at 2014-01-25 18:58:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-02-08 17:57:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-03-13 05:43:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2014-04-04 16:59:13

Before this branch

```
sage: %time _=list(IntegerVectors(5,22))
CPU times: user 1.78 s, sys: 8 ms, total: 1.78 s
Wall time: 1.81 s
```


After the branch

```
sage: %time _=list(IntegerVectors(5,22))
CPU times: user 19.3 s, sys: 60 ms, total: 19.4 s
Wall time: 19.6 s
```


With a 5-lines code

```
from itertools import combinations
def integervectors(n,k):
    L = n+k-1
    for x in combinations(range(L),k-1):
        l = [x[i] - x[i-1]-1 for i in range(1,k-1)]
        l.insert(0,x[0])
        l.append(L-x[-1]-1)
        yield l

sage: %time _=list(integervectors(5,22))
CPU times: user 492 ms, sys: 16 ms, total: 508 ms
Wall time: 515 ms
```


I think this can be classified as a severe regression. Besides,  it is probably better to avoid this kind of stuff present in your branch:


```
for c in IntegerVectors(self.size - k, i-1):
    c = list(c)
```


If you only want the data, don't generate complex objects in the first place.

Nathann


---

Comment by ncohen created at 2014-04-04 16:59:19

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2014-04-04 21:18:06

While this algorithm works (modulo corner cases), it doesn't return them in lex order (which is something we'd want to do). Can you give a variant of it which does yield in lex order?


---

Comment by tscrim created at 2014-04-04 21:28:10

Nevermind, I think I have one.


---

Comment by ncohen created at 2014-04-04 21:36:08

?

On which instance doesn't it give a lexicographic  ordering ? `O_o`

Nathann


---

Comment by tscrim created at 2014-04-04 21:40:55

(1,2) gives: `[0, 1] [1, 0]`. In fact, try `(3,3)` and it's not something easily tweaked.


---

Comment by ncohen created at 2014-04-04 21:43:04

`O_o`

```
sage: list(integervectors(1,2))
[[0, 1], [1, 0]]
sage: list(integervectors(3,3))
[[0, 0, 3],
 [0, 1, 2],
 [0, 2, 1],
 [0, 3, 0],
 [1, 0, 2],
 [1, 1, 1],
 [1, 2, 0],
 [2, 0, 1],
 [2, 1, 0],
 [3, 0, 0]]
```


Isn't that the lexicographic ordering ? `O_o`

```
sage: list(integervectors(3,3)) == sorted(list(integervectors(3,3)))
True
```



---

Comment by tscrim created at 2014-04-04 21:45:10

I meant revlex.


---

Comment by ncohen created at 2014-04-04 22:05:47

> By your convention, I mean revlex.

Me and quite a lot of people (wikipedia, dictionaries, phone books, Python) seem to agree on what a lexicographic ordering is `:-P`

It looks like `IntegerVector` returns them in decreasing lexicographic order, so I guess that's what you call "revlex" (sorry I always mix colex and revlex).

What about computing the complement of x ? In Python  it wastes a lot of time, but the algorithm works.... `:-P`


```
def integervectors(n,k):
    L = n+k-1
    for x in combinations(range(L),L-(k-1)):
        x_complement = []
        j = 0
        for i in range(L):
            if x[j] == i:
                if j < L-(k-1)-1:
		    j += 1
		continue
            else:
                x_complement.append(i)
	x = x_complement
        l = [x[i] - x[i-1]-1 for i in range(1,k-1)]
        l.insert(0,x[0])
        l.append(L-x[-1]-1)
        yield l

sage: list(integervectors(5,5)) == [list(map(int,x)) for x in IntegerVectors(5,5)]
True
```



---

Comment by git created at 2014-04-04 22:47:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2014-04-04 22:51:36

I thought I had a method but it didn't work. Python's `itertool` forces it through lex ordering, so I just did a brute compute and reverse (which is far less than ideal). I'll look into your revised algorithm tonight.


---

Comment by git created at 2014-04-15 02:22:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-08-01 21:02:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2014-08-01 21:06:34

Hey Nathann,

I've implemented your algorithm and everything seems to work. Can you do the rest of the review for this?


---

Comment by tscrim created at 2014-08-01 21:06:34

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2014-08-01 21:29:19

Hello !

> I've implemented your algorithm and everything seems to work. Can you do the rest of the review for this?

No, sorry. Your branch contains 14 commits, almost all of which are entitled "Merge with develop". Besides, I see some code in your branch in which you just change the indentation, and so it seems that I should not re-review all that code, but given how your branch is made I have no way to know what needs an actual review.

Besides, I can spend time on the review of any "local" thing (like this enumeration algorithm) and I will do it gladly if you have anything specific in mind, but I hate parents, elements and almost anything that is immutable. I am the last person you want to review code like that.

I would start to make unpleasant reviews like: "It has been reported on Sage-devel that having a cached function return a UniqueRepresentation object resulted in a memory leak. Clearly those integer vectors will be used by cached function, so you are creating a new memory leak until this finally gets fixed".

https://groups.google.com/d/topic/sage-devel/q5uy_lI11jg/discussion

So I'm sorry but you probably want somebody else to review this ticket.

Nathann


---

Comment by chapoton created at 2015-05-22 20:11:45

needs rebase, des not apply


---

Comment by chapoton created at 2015-05-22 20:11:45

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-08-25 19:24:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-08-25 19:26:05

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2016-08-26 17:10:49

doc does not build:

+[dochtml] OSError: [combinat ] /home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/combinat/integer_vector.py:docstring of sage.combinat.integer_vector.IntegerVectors_nnondescents:9: WARNING: Inline literal start-string without end-string.

and one should no longer use `it.next()` bu instead use `next(it)`

++            sage: [it.next() for x in range(10)]
++            sage: [it.next() for x in range(10)]
++            sage: [it.next() for x in range(10)]


---

Comment by git created at 2016-08-26 18:02:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-08-26 18:03:15

This should fix the doc (although I can't test right now because Sage is recompiling) and fixed the `next`.


---

Comment by tscrim created at 2016-08-26 19:50:03

Followup, doc built cleanly for me.


---

Comment by chapoton created at 2016-08-27 11:04:14

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2016-08-27 11:04:14

triggers doctest failures in sandpiles


---

Comment by git created at 2016-08-27 17:11:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-08-27 17:12:21

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2016-08-27 17:12:21

Fixed.


---

Comment by tscrim created at 2016-09-01 04:50:38

Patchbot is green.


---

Comment by chapoton created at 2016-09-01 07:20:06

Before

```
sage: %timeit list(IntegerVectors(5,22))
1 loop, best of 3: 190 ms per loop
```

After

```
sage: %timeit list(IntegerVectors(5,22)) 
1 loop, best of 3: 3.86 s per loop
```

which looks really bad..


---

Comment by tscrim created at 2016-09-01 14:08:25

Basically all of the time is eaten up by `integer_vectors_nk_fast_iter`. I was hoping to line profile it, but that is broken since the IPython upgrade. I'm looking into this.


---

Comment by tscrim created at 2016-09-01 14:18:21

So it seems Nathann's algorithm is just slower than the original version, so I'm just reverting it. I would like to `%lprun` it... *sigh*


---

Comment by git created at 2016-09-01 14:55:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-09-01 15:04:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-09-01 15:05:08

Now I get about a 3x slowdown for the iterator over the parent, but considering that this is basically overhead from the parent/element stuff, we won't be able to get much else. Plus we are at such small time scales and if you're iterating over the parent, then this should not be the bottleneck.

However, calling the iterator itself is now about 10% faster than before. So I also update those parts of the codebase which want a honest list back and had them call the iterator directly.


---

Comment by git created at 2016-09-04 19:50:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-09-11 22:34:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-09-12 14:14:42

Patchbot is green.


---

Comment by git created at 2016-09-16 23:37:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-09-29 02:12:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-09-29 02:13:41

Rebased on 7.4.beta6.


---

Comment by git created at 2016-09-29 14:45:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-11-10 16:05:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-12-03 10:56:25

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2016-12-03 10:56:25

does not apply


---

Comment by git created at 2016-12-05 01:14:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-12-05 01:16:23

I would appreciate it if you could finish the review Frédéric.


---

Comment by tscrim created at 2016-12-05 01:16:23

Changing status from needs_work to needs_review.


---

Comment by git created at 2016-12-05 14:10:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-12-05 19:48:43

typo "yeilds Python"

I am not sure I am able to do a review. This is rather large a ticket..

Would you please provide some timings ? I am still a lot worried about that.

And explain again what is gained, maybe at the loss of some speed ?


---

Comment by chapoton created at 2016-12-05 21:48:21

before

```
sage: %timeit list(IntegerVectors(5,22))
1 loop, best of 3: 193 ms per loop
```

after

```
sage: %timeit list(IntegerVectors(5,22)) 
1 loop, best of 3: 622 ms per loop
```

so this is not so bad, but still a 3 times slowdown. What do we gain for this prize ?


---

Comment by git created at 2016-12-05 22:37:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-12-05 22:47:10

That is around what I am getting as well. The advantage is that this is now a proper parent class with elements and fits into the rest of Sage. If you want to have the speed but not the parent/element overhead, I provided an iterator for that:

```
sage: %timeit list(IntegerVectors(5,22))
1 loop, best of 3: 238 ms per loop
sage: from sage.combinat.integer_vector import integer_vectors_nk_fast_iter
sage: %timeit list(integer_vectors_nk_fast_iter(5,22))
10 loops, best of 3: 63.7 ms per loop
```

Old:

```
sage: %timeit list(IntegerVectors(5,22))
10 loops, best of 3: 76.4 ms per loop
```


Although if you use `int` and Cython, you can get a _very_ fast iterator. Although converting those back to `Integer`'s was actually slower than working directly with `Integer`'s.

I now see the problem with why that was taking so long. The class I'm using actually stores the input data as `int`'s, not `Integer`'s. So I think I need to change the base class for the elements.


---

Comment by git created at 2016-12-05 22:50:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-12-05 22:57:25

Okay, using `ClonableArray` makes things a little bit better:

```
%timeit list(IntegerVectors(5,22))
1 loop, best of 3: 209 ms per loop
```



---

Comment by git created at 2016-12-05 23:32:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-12-05 23:49:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-12-05 23:52:19

By not popping and pushing the list (the iterator wants a fixed length) and some reworking, I got it to:

```
sage: %timeit list(IntegerVectors(5,22))
1 loop, best of 3: 188 ms per loop
```

Although I did get some slowdown because `rem` was not an `Integer` for the entire loop. So I think this is probably as fast as I can get it.


---

Comment by git created at 2016-12-06 12:27:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-12-06 12:28:57

Looks better now indeed. I have made a reviewer's commit (cosmetic).

Once the bot is green, you can set a positive review.


---

Comment by tscrim created at 2016-12-06 14:54:08

Bot is essentially green, so positive review. Thank you.


---

Comment by tscrim created at 2016-12-06 14:54:17

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-12-07 23:33:07

FYI I'm only merging tickets whose dependencies are merged git branches.


---

Comment by vbraun created at 2016-12-10 12:38:22

Resolution: fixed
