# Issue 24451: implement falting height of an elliptic curve

archive/issues_024451.json:
```json
{
    "body": "CC:  cremona nbruin\n\nThe goal of this ticket is to be able to determine the falting height of an elliptic curve.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24688\n\n",
    "created_at": "2018-02-08T02:03:05Z",
    "labels": [
        "PLEASE CHANGE",
        "major",
        "PLEASE CHANGE"
    ],
    "title": "implement falting height of an elliptic curve",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24451",
    "user": "klui"
}
```
CC:  cremona nbruin

The goal of this ticket is to be able to determine the falting height of an elliptic curve.

Issue created by migration from https://trac.sagemath.org/ticket/24688





---

archive/issue_comments_342972.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2018-02-08T23:00:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342972",
    "user": "klui"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_342973.json:
```json
{
    "body": "Changing keywords from \"\" to \"elliptic curves, faltings height\".",
    "created_at": "2018-02-08T23:00:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342973",
    "user": "klui"
}
```

Changing keywords from "" to "elliptic curves, faltings height".



---

archive/issue_comments_342974.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2018-02-08T23:00:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342974",
    "user": "klui"
}
```

Changing priority from major to minor.



---

archive/issue_comments_342975.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to elliptic curves.",
    "created_at": "2018-02-08T23:00:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342975",
    "user": "klui"
}
```

Changing component from PLEASE CHANGE to elliptic curves.



---

archive/issue_comments_342976.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-04-24T19:18:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342976",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_342977.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-04-24T19:20:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342977",
    "user": "klui"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_342978.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-05-01T12:33:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342978",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_342979.json:
```json
{
    "body": "You should fill the `Authors` field with your full name.",
    "created_at": "2018-05-01T12:33:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342979",
    "user": "vdelecroix"
}
```

You should fill the `Authors` field with your full name.



---

archive/issue_comments_342980.json:
```json
{
    "body": "Thanks!",
    "created_at": "2018-05-02T17:42:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342980",
    "user": "klui"
}
```

Thanks!



---

archive/issue_comments_342981.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-20T22:35:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342981",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_342982.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-20T23:26:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342982",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_342983.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-06-21T06:13:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342983",
    "user": "chapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_342984.json:
```json
{
    "body": "Maybe you could do that over any number field, if possible ? using something like\n\n```\nA = self.base_ring()\nemb = A.embeddings(RR)[0]\nreturn -self.period_lattice(emb).complex_area().log() / 2\n```\n\nbut an expert opinion is required. John ?",
    "created_at": "2018-06-21T19:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342984",
    "user": "chapoton"
}
```

Maybe you could do that over any number field, if possible ? using something like

```
A = self.base_ring()
emb = A.embeddings(RR)[0]
return -self.period_lattice(emb).complex_area().log() / 2
```

but an expert opinion is required. John ?



---

archive/issue_comments_342985.json:
```json
{
    "body": "Is this really ready for review?\nI'm a little confused as to what this is meant to do, is it meant to match Magma's FaltingsHeight? For example in Magma V2.22-6\n\n\n```c\n> E := EllipticCurve(\"32a\");\n> E;\nElliptic Curve defined by y^2 = x^3 + 4*x over Rational Field\n> FaltingsHeight(E);\n-1.31053292591150951825227508330\n```\n\nquite different from the output this ticket gives, and the code in Magma is a lot more involved, picks a minimal model, uses the denominator of the j-invariant, discriminant etc.\n\nThe Magma documentation leaves a lot to be desired here I think.",
    "created_at": "2018-06-22T03:46:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342985",
    "user": "alexjbest"
}
```

Is this really ready for review?
I'm a little confused as to what this is meant to do, is it meant to match Magma's FaltingsHeight? For example in Magma V2.22-6


```c
> E := EllipticCurve("32a");
> E;
Elliptic Curve defined by y^2 = x^3 + 4*x over Rational Field
> FaltingsHeight(E);
-1.31053292591150951825227508330
```

quite different from the output this ticket gives, and the code in Magma is a lot more involved, picks a minimal model, uses the denominator of the j-invariant, discriminant etc.

The Magma documentation leaves a lot to be desired here I think.



---

archive/issue_comments_342986.json:
```json
{
    "body": "I forgot the web calculator exists so I only checked it against MagmaV2.18-5. And in that version, the height was dependent on the model which was rather confusing to me. I always worked with the minimal model anyways so that difference didn't matter to me.\n\nI'm happy to see that that has changed:\n\n\n```\nE := EllipticCurve(\"32a\");\nFaltingsHeight(E);\nFaltingsHeight(WeierstrassModel(E));\n```\n\nyields\n\n\n```\n-1.31053292591150951825227508330\n-1.31053292591150951825227508330\n```\n\nusing http://magma.maths.usyd.edu.au/calc/ .\n\nMy interest in Faltings height is using Steven's conjecture to identify the J_1(N)-optimal curve in a given isogeny class. So the goal of this ticket was the compute whatever height is used in Steven's conjecture. So I took what was defined in Remark 3.3 here: https://arxiv.org/pdf/math/0404333.pdf and re-normalized it so that it matched with Magma. Though now I'm not sure what Magma is computing anymore. It seems to different than what's documented here: https://magma.maths.usyd.edu.au/magma/handbook/text/1455\n\nIn any case, I should change it so that it uses the minimal model.",
    "created_at": "2018-06-22T04:44:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342986",
    "user": "klui"
}
```

I forgot the web calculator exists so I only checked it against MagmaV2.18-5. And in that version, the height was dependent on the model which was rather confusing to me. I always worked with the minimal model anyways so that difference didn't matter to me.

I'm happy to see that that has changed:


```
E := EllipticCurve("32a");
FaltingsHeight(E);
FaltingsHeight(WeierstrassModel(E));
```

yields


```
-1.31053292591150951825227508330
-1.31053292591150951825227508330
```

using http://magma.maths.usyd.edu.au/calc/ .

My interest in Faltings height is using Steven's conjecture to identify the J_1(N)-optimal curve in a given isogeny class. So the goal of this ticket was the compute whatever height is used in Steven's conjecture. So I took what was defined in Remark 3.3 here: https://arxiv.org/pdf/math/0404333.pdf and re-normalized it so that it matched with Magma. Though now I'm not sure what Magma is computing anymore. It seems to different than what's documented here: https://magma.maths.usyd.edu.au/magma/handbook/text/1455

In any case, I should change it so that it uses the minimal model.



---

archive/issue_comments_342987.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-22T04:52:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342987",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_342988.json:
```json
{
    "body": "No time for detailed comment now but it should not depend on model being minimal -- over number fields there is not always a global minimal model -- so there is a formula which is independent of model, though it is simpler (and possible over Q) to use a simpler formula valid only for minimal models.\n\nklui, I like your project.  If you want to do this with no computation at all use the files at https://github.com/JohnCremona/ecdata/tree/master/allbsd (see under \"TABLE FOUR\" at http://johncremona.github.io/ecdata/ for description of their content).",
    "created_at": "2018-06-22T08:10:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342988",
    "user": "cremona"
}
```

No time for detailed comment now but it should not depend on model being minimal -- over number fields there is not always a global minimal model -- so there is a formula which is independent of model, though it is simpler (and possible over Q) to use a simpler formula valid only for minimal models.

klui, I like your project.  If you want to do this with no computation at all use the files at https://github.com/JohnCremona/ecdata/tree/master/allbsd (see under "TABLE FOUR" at http://johncremona.github.io/ecdata/ for description of their content).



---

archive/issue_comments_342989.json:
```json
{
    "body": "Replying to [comment:15 cremona]:\n> No time for detailed comment now but it should not depend on model being minimal -- over number fields there is not always a global minimal model -- so there is a formula which is independent of model, though it is simpler (and possible over Q) to use a simpler formula valid only for minimal models.\n> \nThe only model-independent formula I know of requires computing the minimal discriminant anyways so it should be okay to just compute the minimal model, from a speed-perspective as well.\n> klui, I like your project.  If you want to do this with no computation at all use the files at https://github.com/JohnCremona/ecdata/tree/master/allbsd (see under \"TABLE FOUR\" at http://johncremona.github.io/ecdata/ for description of their content).\nI think I'm being slow but I don't see how knowing the BSD invariants help with computing the Faltings height.",
    "created_at": "2018-06-22T18:00:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342989",
    "user": "klui"
}
```

Replying to [comment:15 cremona]:
> No time for detailed comment now but it should not depend on model being minimal -- over number fields there is not always a global minimal model -- so there is a formula which is independent of model, though it is simpler (and possible over Q) to use a simpler formula valid only for minimal models.
> 
The only model-independent formula I know of requires computing the minimal discriminant anyways so it should be okay to just compute the minimal model, from a speed-perspective as well.
> klui, I like your project.  If you want to do this with no computation at all use the files at https://github.com/JohnCremona/ecdata/tree/master/allbsd (see under "TABLE FOUR" at http://johncremona.github.io/ecdata/ for description of their content).
I think I'm being slow but I don't see how knowing the BSD invariants help with computing the Faltings height.



---

archive/issue_comments_342990.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-01-14T16:47:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342990",
    "user": "pbruin"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_342991.json:
```json
{
    "body": "Instead of saying that this uses the same normalisation as Magma, I suggest putting a definition or formula in the documentation.  For the elliptic curve 32a1, the output agrees with the function `ellheight` in PARI but seems to be half of that returned by Magma.\n\nFor a future generalisation to number fields, the PARI function `ellheight` does the same thing as this function over **Q** and also works over number fields.",
    "created_at": "2020-01-14T16:47:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342991",
    "user": "pbruin"
}
```

Instead of saying that this uses the same normalisation as Magma, I suggest putting a definition or formula in the documentation.  For the elliptic curve 32a1, the output agrees with the function `ellheight` in PARI but seems to be half of that returned by Magma.

For a future generalisation to number fields, the PARI function `ellheight` does the same thing as this function over **Q** and also works over number fields.



---

archive/issue_comments_342992.json:
```json
{
    "body": "I am planning to revise and resubmit this patch, with an option to return either the (unstable) Faltings height as the code now does (-log(A)/2) or the stable height which adds log(denom(j)/abs(disc))/12 -- the result being the same for semistable curves (since denom(j)=abs(disc) for a minimal model of a semistable curve, as then gcd(c4,disc)=1), and independent of the model.",
    "created_at": "2021-03-16T15:29:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342992",
    "user": "cremona"
}
```

I am planning to revise and resubmit this patch, with an option to return either the (unstable) Faltings height as the code now does (-log(A)/2) or the stable height which adds log(denom(j)/abs(disc))/12 -- the result being the same for semistable curves (since denom(j)=abs(disc) for a minimal model of a semistable curve, as then gcd(c4,disc)=1), and independent of the model.



---

archive/issue_comments_342993.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-03-16T17:12:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342993",
    "user": "cremona"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_342994.json:
```json
{
    "body": "I merged the previous branch with 9.3.beta9, and enhanced the method by having `stable` as an optional parameter (default `False`) and adding a precision parameter.  I added extra tests to show how the stable and unstable heights are the same for semistable curves (but not otherwise) and how the stable height is independent of the model while the unstable one is not.\n\nI included definitions (but no citations).\n\nObviously we'll also want a version of this for number fields too, but I think this is enough for now.  Please re-review!\n----\nNew commits:",
    "created_at": "2021-03-16T17:12:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342994",
    "user": "cremona"
}
```

I merged the previous branch with 9.3.beta9, and enhanced the method by having `stable` as an optional parameter (default `False`) and adding a precision parameter.  I added extra tests to show how the stable and unstable heights are the same for semistable curves (but not otherwise) and how the stable height is independent of the model while the unstable one is not.

I included definitions (but no citations).

Obviously we'll also want a version of this for number fields too, but I think this is enough for now.  Please re-review!
----
New commits:



---

archive/issue_comments_342995.json:
```json
{
    "body": "the bot is green and this looks good, so let it be (not a mathematical review)",
    "created_at": "2021-03-19T11:01:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342995",
    "user": "chapoton"
}
```

the bot is green and this looks good, so let it be (not a mathematical review)



---

archive/issue_comments_342996.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-03-19T11:01:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342996",
    "user": "chapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_342997.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-03-20T20:54:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24451",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24451#issuecomment-342997",
    "user": "vbraun"
}
```

Resolution: fixed
