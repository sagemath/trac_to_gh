# Issue 20939: getting rid of some more cmp() in pyx files

archive/issues_020939.json:
```json
{
    "body": "CC:  @jdemeyer @tscrim\n\nas small steps towards py3\n\nIssue created by migration from https://trac.sagemath.org/ticket/21176\n\n",
    "created_at": "2016-08-05T15:25:34Z",
    "labels": [
        "python3",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "getting rid of some more cmp() in pyx files",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20939",
    "user": "@fchapoton"
}
```
CC:  @jdemeyer @tscrim

as small steps towards py3

Issue created by migration from https://trac.sagemath.org/ticket/21176





---

archive/issue_comments_289633.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-08-05T15:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-289633",
    "user": "@fchapoton"
}
```

New commits:



---

archive/issue_comments_289634.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-08-05T16:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-289634",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_289635.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-08-05T16:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-289635",
    "user": "@fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_289636.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2016-08-05T16:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-289636",
    "user": "@fchapoton"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_289637.json:
```json
{
    "body": "For the record, I think that getting rid of `__cmp__` is more important than getting rid of `cmp`. The reason is that we could always just write a `cmp()` function but we cannot easily deal with `__cmp__`.",
    "created_at": "2016-08-05T19:22:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-289637",
    "user": "@jdemeyer"
}
```

For the record, I think that getting rid of `__cmp__` is more important than getting rid of `cmp`. The reason is that we could always just write a `cmp()` function but we cannot easily deal with `__cmp__`.



---

archive/issue_comments_289638.json:
```json
{
    "body": "bot is green",
    "created_at": "2016-08-06T06:09:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-289638",
    "user": "@fchapoton"
}
```

bot is green



---

archive/issue_comments_289639.json:
```json
{
    "body": "About `src/sage/categories/morphism.pyx`:\n\nYou are changing code of the form\n\n```\nc = cmp(x.A, y.A)\nif c: return c\nc = cmp(x.B, y.B)\nif c: return c\nc = cmp(x.C, y.C)\nreturn c\n```\n\nto\n\n```\nt = (x.A, x.B, x.C)\nu = (y.A, y.B, y.C)\nreturn richcmp(t, u, op)\n```\n\n\nThe latter is less efficient because it does not \"lazily\" compute the `.B` and `.C` attributes.\n\nI think that more efficient code should be written. Here is an idea:\n\n```\n# Helper method in sage_object.pxd (based on #21128 to avoid conflicts)\ncpdef inline richcmp_not_equal(x, y, int op):\n    \"\"\"\n    Like ``richcmp(x, y, op)`` but where it is known that `x` is not equal to `y`.\n    \"\"\"\n    if op == Py_EQ:\n        return False\n    if op == Py_NE:\n        return True\n    return PyObject_RichCompare(x, y, op)\n    \n# Actual code in _richcmp_\nif x.A != y.A:\n    return richcmp_not_equal(x.A, y.A, op)\nif x.B != y.B:\n    return richcmp_not_equal(x.B, y.B, op)\nreturn PyObject_RichCompare(x.C, y.C, op)\n```\n",
    "created_at": "2016-08-06T09:28:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-289639",
    "user": "@jdemeyer"
}
```

About `src/sage/categories/morphism.pyx`:

You are changing code of the form

```
c = cmp(x.A, y.A)
if c: return c
c = cmp(x.B, y.B)
if c: return c
c = cmp(x.C, y.C)
return c
```

to

```
t = (x.A, x.B, x.C)
u = (y.A, y.B, y.C)
return richcmp(t, u, op)
```


The latter is less efficient because it does not "lazily" compute the `.B` and `.C` attributes.

I think that more efficient code should be written. Here is an idea:

```
# Helper method in sage_object.pxd (based on #21128 to avoid conflicts)
cpdef inline richcmp_not_equal(x, y, int op):
    """
    Like ``richcmp(x, y, op)`` but where it is known that `x` is not equal to `y`.
    """
    if op == Py_EQ:
        return False
    if op == Py_NE:
        return True
    return PyObject_RichCompare(x, y, op)
    
# Actual code in _richcmp_
if x.A != y.A:
    return richcmp_not_equal(x.A, y.A, op)
if x.B != y.B:
    return richcmp_not_equal(x.B, y.B, op)
return PyObject_RichCompare(x.C, y.C, op)
```




---

archive/issue_comments_289640.json:
```json
{
    "body": "In fact, I think this `_cmp_` in morphism is probably never used anywhere. The current code in the branch is broken (self.domain is missing parentheses), and yet all doctests pass !\n\nAbout the general issue you ask, what about having a method\n\n```\nrichcmp_lazy_for_list(self, other, list_of_functions, op)\n```\n\nwhere list of functions would be used as a \"lazy-key\" for comparison.\n\nIn the example appearing in morphism, we would use\n\n```\nrichcmp_lazy_for_list(self, other, [lambda x: x.domain(), lambda x: x.codomain(),\n  lambda x: tuple(x(gen) for gen in x.domain().gens())], op)\n```\n\n\nThis `richcmp_lazy_for_list` would evaluate step by step, using as few functions as possible.\n\nWe are really hit hard here by the rather dubious preference in python3 for sorting keys rather than sorting functions. I think we need some kind of lazy-key mechanism.",
    "created_at": "2016-08-07T11:51:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-289640",
    "user": "@fchapoton"
}
```

In fact, I think this `_cmp_` in morphism is probably never used anywhere. The current code in the branch is broken (self.domain is missing parentheses), and yet all doctests pass !

About the general issue you ask, what about having a method

```
richcmp_lazy_for_list(self, other, list_of_functions, op)
```

where list of functions would be used as a "lazy-key" for comparison.

In the example appearing in morphism, we would use

```
richcmp_lazy_for_list(self, other, [lambda x: x.domain(), lambda x: x.codomain(),
  lambda x: tuple(x(gen) for gen in x.domain().gens())], op)
```


This `richcmp_lazy_for_list` would evaluate step by step, using as few functions as possible.

We are really hit hard here by the rather dubious preference in python3 for sorting keys rather than sorting functions. I think we need some kind of lazy-key mechanism.



---

archive/issue_comments_289641.json:
```json
{
    "body": "My main goal was to improve performance. I don't know whether complicated constructions using lists of `lambda`s will meet that goal.",
    "created_at": "2016-08-07T16:53:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-289641",
    "user": "@jdemeyer"
}
```

My main goal was to improve performance. I don't know whether complicated constructions using lists of `lambda`s will meet that goal.



---

archive/issue_comments_289642.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-08-08T07:03:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-289642",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_289643.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-08-08T07:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-289643",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_289644.json:
```json
{
    "body": "I removed the changes in `src/sage/categories/morphism.pyx` and `src/sage/groups/perm_gps/partn_ref/data_structures_pyx.pxi`. For the latter, I don't think your branch was equivalent with the old code (at least it was not obvious to me).",
    "created_at": "2016-08-08T07:21:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-289644",
    "user": "@jdemeyer"
}
```

I removed the changes in `src/sage/categories/morphism.pyx` and `src/sage/groups/perm_gps/partn_ref/data_structures_pyx.pxi`. For the latter, I don't think your branch was equivalent with the old code (at least it was not obvious to me).



---

archive/issue_comments_289645.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2016-08-08T07:21:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-289645",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_289646.json:
```json
{
    "body": "Thanks. \n\nFor morphism, I understand and agree.\n\nThe other one was good I think.",
    "created_at": "2016-08-08T07:26:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-289646",
    "user": "@fchapoton"
}
```

Thanks. 

For morphism, I understand and agree.

The other one was good I think.



---

archive/issue_comments_289647.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-08-14T19:05:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20939",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20939#issuecomment-289647",
    "user": "@vbraun"
}
```

Resolution: fixed
