# Issue 20939: getting rid of some more cmp() in pyx files

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2016-08-05 15:25:34

CC:  jdemeyer tscrim

as small steps towards py3


---

Comment by chapoton created at 2016-08-05 15:26:32

New commits:


---

Comment by git created at 2016-08-05 16:12:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2016-08-05 16:15:11

Changing status from new to needs_review.


---

Comment by chapoton created at 2016-08-05 16:15:11

Changing type from PLEASE CHANGE to enhancement.


---

Comment by jdemeyer created at 2016-08-05 19:22:32

For the record, I think that getting rid of `__cmp__` is more important than getting rid of `cmp`. The reason is that we could always just write a `cmp()` function but we cannot easily deal with `__cmp__`.


---

Comment by chapoton created at 2016-08-06 06:09:37

bot is green


---

Comment by jdemeyer created at 2016-08-06 09:28:30

About `src/sage/categories/morphism.pyx`:

You are changing code of the form

```
c = cmp(x.A, y.A)
if c: return c
c = cmp(x.B, y.B)
if c: return c
c = cmp(x.C, y.C)
return c
```

to

```
t = (x.A, x.B, x.C)
u = (y.A, y.B, y.C)
return richcmp(t, u, op)
```


The latter is less efficient because it does not "lazily" compute the `.B` and `.C` attributes.

I think that more efficient code should be written. Here is an idea:

```
# Helper method in sage_object.pxd (based on #21128 to avoid conflicts)
cpdef inline richcmp_not_equal(x, y, int op):
    """
    Like ``richcmp(x, y, op)`` but where it is known that `x` is not equal to `y`.
    """
    if op == Py_EQ:
        return False
    if op == Py_NE:
        return True
    return PyObject_RichCompare(x, y, op)
    
# Actual code in _richcmp_
if x.A != y.A:
    return richcmp_not_equal(x.A, y.A, op)
if x.B != y.B:
    return richcmp_not_equal(x.B, y.B, op)
return PyObject_RichCompare(x.C, y.C, op)
```



---

Comment by chapoton created at 2016-08-07 11:51:51

In fact, I think this `_cmp_` in morphism is probably never used anywhere. The current code in the branch is broken (self.domain is missing parentheses), and yet all doctests pass !

About the general issue you ask, what about having a method

```
richcmp_lazy_for_list(self, other, list_of_functions, op)
```

where list of functions would be used as a "lazy-key" for comparison.

In the example appearing in morphism, we would use

```
richcmp_lazy_for_list(self, other, [lambda x: x.domain(), lambda x: x.codomain(),
  lambda x: tuple(x(gen) for gen in x.domain().gens())], op)
```


This `richcmp_lazy_for_list` would evaluate step by step, using as few functions as possible.

We are really hit hard here by the rather dubious preference in python3 for sorting keys rather than sorting functions. I think we need some kind of lazy-key mechanism.


---

Comment by jdemeyer created at 2016-08-07 16:53:40

My main goal was to improve performance. I don't know whether complicated constructions using lists of `lambda`s will meet that goal.


---

Comment by jdemeyer created at 2016-08-08 07:03:02

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-08-08 07:20:14

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2016-08-08 07:21:32

I removed the changes in `src/sage/categories/morphism.pyx` and `src/sage/groups/perm_gps/partn_ref/data_structures_pyx.pxi`. For the latter, I don't think your branch was equivalent with the old code (at least it was not obvious to me).


---

Comment by jdemeyer created at 2016-08-08 07:21:32

Changing status from needs_work to positive_review.


---

Comment by chapoton created at 2016-08-08 07:26:40

Thanks. 

For morphism, I understand and agree.

The other one was good I think.


---

Comment by vbraun created at 2016-08-14 19:05:42

Resolution: fixed
