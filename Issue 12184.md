# Issue 12184: many missing class number 2 orders in CM j-invariant function over quadratic fields

archive/issues_012184.json:
```json
{
    "body": "Assignee: @JohnCremona\n\nIn sage/schemes/elliptic_curves/cm.py there is a list of imaginary quadratic orders with class number 2, introduced in #11220, but it is incomplete!  Firstly, discriminant -72 is missing since the paper referred to omitted it in error; secondly, all 9 such orders whose maximal order has class number 1 were omitted by mistake.\n\nA patch will be provided shortly.\n\nIssue created by migration from https://trac.sagemath.org/ticket/12356\n\n",
    "created_at": "2012-01-25T12:27:30Z",
    "labels": [
        "component: elliptic curves",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "many missing class number 2 orders in CM j-invariant function over quadratic fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12184",
    "user": "https://github.com/JohnCremona"
}
```
Assignee: @JohnCremona

In sage/schemes/elliptic_curves/cm.py there is a list of imaginary quadratic orders with class number 2, introduced in #11220, but it is incomplete!  Firstly, discriminant -72 is missing since the paper referred to omitted it in error; secondly, all 9 such orders whose maximal order has class number 1 were omitted by mistake.

A patch will be provided shortly.

Issue created by migration from https://trac.sagemath.org/ticket/12356





---

archive/issue_comments_141701.json:
```json
{
    "body": "Applies to 4.8",
    "created_at": "2012-01-25T12:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141701",
    "user": "https://github.com/JohnCremona"
}
```

Applies to 4.8



---

archive/issue_comments_141702.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-01-25T12:38:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141702",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_141703.json:
```json
{
    "body": "Attachment [trac_12356-cm.patch](tarball://root/attachments/some-uuid/ticket12356/trac_12356-cm.patch) by @JohnCremona created at 2012-01-25 12:38:51",
    "created_at": "2012-01-25T12:38:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141703",
    "user": "https://github.com/JohnCremona"
}
```

Attachment [trac_12356-cm.patch](tarball://root/attachments/some-uuid/ticket12356/trac_12356-cm.patch) by @JohnCremona created at 2012-01-25 12:38:51



---

archive/issue_comments_141704.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2012-01-25T16:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141704",
    "user": "https://github.com/williamstein"
}
```

Changing priority from major to critical.



---

archive/issue_comments_141705.json:
```json
{
    "body": "I found the code too hard to use in its current structure.  I also think the whole approach of tables is brittle, when they are hand-typed in code, as evidenced by the mistakes so far.  We should have general code, and if we want tables for optimization purposes, compute them, store them in SQLite, and put them in an spkg.    I will post new code that does all this in a way that works for all degrees up to 100 (instead of just 2).",
    "created_at": "2012-01-25T16:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141705",
    "user": "https://github.com/williamstein"
}
```

I found the code too hard to use in its current structure.  I also think the whole approach of tables is brittle, when they are hand-typed in code, as evidenced by the mistakes so far.  We should have general code, and if we want tables for optimization purposes, compute them, store them in SQLite, and put them in an spkg.    I will post new code that does all this in a way that works for all degrees up to 100 (instead of just 2).



---

archive/issue_comments_141706.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-01-25T16:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141706",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_141707.json:
```json
{
    "body": "apply only this: developed on 5.0, but should apply to 4.8",
    "created_at": "2012-01-25T17:09:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141707",
    "user": "https://github.com/williamstein"
}
```

apply only this: developed on 5.0, but should apply to 4.8



---

archive/issue_comments_141708.json:
```json
{
    "body": "Attachment [trac_12356-extended.patch](tarball://root/attachments/some-uuid/ticket12356/trac_12356-extended.patch) by @williamstein created at 2012-01-25 17:14:45",
    "created_at": "2012-01-25T17:14:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141708",
    "user": "https://github.com/williamstein"
}
```

Attachment [trac_12356-extended.patch](tarball://root/attachments/some-uuid/ticket12356/trac_12356-extended.patch) by @williamstein created at 2012-01-25 17:14:45



---

archive/issue_comments_141709.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-01-25T17:14:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141709",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_141710.json:
```json
{
    "body": "I've posted a patch that does the general case (up to degree 100) in a way that is refactored in a more usable way.  This is in trac_12356-extended.patch, which does *not* depend on trac_12356.patch.  For refereeing there are basically two mathematical arguments that are used in the code:\n\n1. if a hilbert class polynomial F has a root in a field K of degree n, then the degree of F is at most n.\n\n2. `class_number(D) <= class_number(D*f^2)` for fundamental D and integer f.\n\nOf course, in 1, I think it would have to be a divisor of n, which could be used to optimize the code further.   I hope these two statements are correct.  I think I proved them to myself easily... but those are famous last words.",
    "created_at": "2012-01-25T17:17:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141710",
    "user": "https://github.com/williamstein"
}
```

I've posted a patch that does the general case (up to degree 100) in a way that is refactored in a more usable way.  This is in trac_12356-extended.patch, which does *not* depend on trac_12356.patch.  For refereeing there are basically two mathematical arguments that are used in the code:

1. if a hilbert class polynomial F has a root in a field K of degree n, then the degree of F is at most n.

2. `class_number(D) <= class_number(D*f^2)` for fundamental D and integer f.

Of course, in 1, I think it would have to be a divisor of n, which could be used to optimize the code further.   I hope these two statements are correct.  I think I proved them to myself easily... but those are famous last words.



---

archive/issue_comments_141711.json:
```json
{
    "body": "John Cremona found a mistake in my algorithm, which I've addressed via a new patch.\n\nI've written a new version based on some of Cremona's comments and with a big comment explaining what I'm doing.    Basically I just compute a pessimistic bound on the quotient (as you suggest) by applying a \"big theorem\" (probably from Hardy & Wright) bounding phi from below, and noting that phi_D(f) >= phi(f).   The new code seems to work fine (and even found a class number 8 counterexample to the code I posted) and is pretty fast, but of course has plenty of room for optimization and improvement by your student, who could also run it to make tables, etc. \n\nOf course, I very much hope John will extremely critically review this!\n\nI didn't mention it, but the *reason* I wrote this code was not to scoop your student or something -- it was so I could better referee your patch!",
    "created_at": "2012-01-26T16:25:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141711",
    "user": "https://github.com/williamstein"
}
```

John Cremona found a mistake in my algorithm, which I've addressed via a new patch.

I've written a new version based on some of Cremona's comments and with a big comment explaining what I'm doing.    Basically I just compute a pessimistic bound on the quotient (as you suggest) by applying a "big theorem" (probably from Hardy & Wright) bounding phi from below, and noting that phi_D(f) >= phi(f).   The new code seems to work fine (and even found a class number 8 counterexample to the code I posted) and is pretty fast, but of course has plenty of room for optimization and improvement by your student, who could also run it to make tables, etc. 

Of course, I very much hope John will extremely critically review this!

I didn't mention it, but the *reason* I wrote this code was not to scoop your student or something -- it was so I could better referee your patch!



---

archive/issue_comments_141712.json:
```json
{
    "body": "Attachment [trac_12356-extended-part2.patch](tarball://root/attachments/some-uuid/ticket12356/trac_12356-extended-part2.patch) by @williamstein created at 2012-01-27 06:46:52\n\nreplacing part 2 with a refreshed patch that has a better reference.",
    "created_at": "2012-01-27T06:46:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141712",
    "user": "https://github.com/williamstein"
}
```

Attachment [trac_12356-extended-part2.patch](tarball://root/attachments/some-uuid/ticket12356/trac_12356-extended-part2.patch) by @williamstein created at 2012-01-27 06:46:52

replacing part 2 with a refreshed patch that has a better reference.



---

archive/issue_comments_141713.json:
```json
{
    "body": "I have started to look at this.  The patch applies fine to 4.8 and tests pass, and seem correct to me.  I have quite a few suggestions for making the code run faster;  the question is whether to insist on any of them now, or put all that into a follow-up ticket, so as not to delay correcting the *wrong* output which unpatched 4.8 gives.",
    "created_at": "2012-02-01T13:43:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141713",
    "user": "https://github.com/JohnCremona"
}
```

I have started to look at this.  The patch applies fine to 4.8 and tests pass, and seem correct to me.  I have quite a few suggestions for making the code run faster;  the question is whether to insist on any of them now, or put all that into a follow-up ticket, so as not to delay correcting the *wrong* output which unpatched 4.8 gives.



---

archive/issue_comments_141714.json:
```json
{
    "body": "Attachment [trac_12356-cm-rebase-sage5.0.patch](tarball://root/attachments/some-uuid/ticket12356/trac_12356-cm-rebase-sage5.0.patch) by @williamstein created at 2012-02-06 17:21:21\n\nRebased everything as a single patch against sage-5.0.beta2 -- apply only this.",
    "created_at": "2012-02-06T17:21:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141714",
    "user": "https://github.com/williamstein"
}
```

Attachment [trac_12356-cm-rebase-sage5.0.patch](tarball://root/attachments/some-uuid/ticket12356/trac_12356-cm-rebase-sage5.0.patch) by @williamstein created at 2012-02-06 17:21:21

Rebased everything as a single patch against sage-5.0.beta2 -- apply only this.



---

archive/issue_comments_141715.json:
```json
{
    "body": "Ping John -- I'm wondering if you're planning to continue reviewing this.  I think I've fully dealt with the serious theoretical issue you pointed out.  It would be great if this goes into sage-5.0.",
    "created_at": "2012-02-06T17:22:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141715",
    "user": "https://github.com/williamstein"
}
```

Ping John -- I'm wondering if you're planning to continue reviewing this.  I think I've fully dealt with the serious theoretical issue you pointed out.  It would be great if this goes into sage-5.0.



---

archive/issue_comments_141716.json:
```json
{
    "body": "Replying to [comment:7 was]:\n> Ping John -- I'm wondering if you're planning to continue reviewing this.  I think I've fully dealt with the serious theoretical issue you pointed out.  It would be great if this goes into sage-5.0. \n\nAgreed.  Not forgotten.  I'll be talking about to Janis again tomorrow and we'll see if any of the suggestions for speedups we have in mind are simple & urgent enough to be done right away, or whether they can wait for a follow-up ticket.",
    "created_at": "2012-02-06T17:26:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141716",
    "user": "https://github.com/JohnCremona"
}
```

Replying to [comment:7 was]:
> Ping John -- I'm wondering if you're planning to continue reviewing this.  I think I've fully dealt with the serious theoretical issue you pointed out.  It would be great if this goes into sage-5.0. 

Agreed.  Not forgotten.  I'll be talking about to Janis again tomorrow and we'll see if any of the suggestions for speedups we have in mind are simple & urgent enough to be done right away, or whether they can wait for a follow-up ticket.



---

archive/issue_comments_141717.json:
```json
{
    "body": "After all these years I still manage to lose large chunks of texts right after typing them.  In this case I had been typing into this box, then clicked to upload a patch, after which the text had gone.  So here's what the reviewer patch does:\n\n1. trivial fixes to docstrings to keep Sphinx happy and tidy up\n\n2. small change to code.  There is a factor in the formula which is usually 1 but can be 2 or 3 and the factor is in the denominator so cannot be ignored without risking losing solutions.  I have inserted it, though I did not come up with any case in which this would actually cause an error.\n\nI also have several suggestions for making the new code more efficient, but it is fine for small h and the new code replaces *wrong* code for h=2 which did not work at all for h>2, so the efficiency question can be dealt with on a separate ticket.\n\nI give a positive review apart from the issue in #2 above, so if William agrees with my change we can together give an overall positive review; or ask a 3rd party.",
    "created_at": "2012-02-10T10:39:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141717",
    "user": "https://github.com/JohnCremona"
}
```

After all these years I still manage to lose large chunks of texts right after typing them.  In this case I had been typing into this box, then clicked to upload a patch, after which the text had gone.  So here's what the reviewer patch does:

1. trivial fixes to docstrings to keep Sphinx happy and tidy up

2. small change to code.  There is a factor in the formula which is usually 1 but can be 2 or 3 and the factor is in the denominator so cannot be ignored without risking losing solutions.  I have inserted it, though I did not come up with any case in which this would actually cause an error.

I also have several suggestions for making the new code more efficient, but it is fine for small h and the new code replaces *wrong* code for h=2 which did not work at all for h>2, so the efficiency question can be dealt with on a separate ticket.

I give a positive review apart from the issue in #2 above, so if William agrees with my change we can together give an overall positive review; or ask a 3rd party.



---

archive/issue_comments_141718.json:
```json
{
    "body": "I fixed this one line in your patch (which was wrong, and simply reposted it with the line fixed):\n\n```\n\t            # we have h(D*f^2) >= (1/c)*h(D)*phi_D(f) >= h(D)*euler_phi(f), where \n```\n\nchanged to\n\n```\n\t            # we have h(D*f^2) >= (1/c)*h(D)*phi_D(f) >= (1/c)* h(D)*euler_phi(f), where \n```\n\n\nWith this change, I'm happy with your patch, so I think you can set it to positive review.",
    "created_at": "2012-02-13T15:31:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141718",
    "user": "https://github.com/williamstein"
}
```

I fixed this one line in your patch (which was wrong, and simply reposted it with the line fixed):

```
	            # we have h(D*f^2) >= (1/c)*h(D)*phi_D(f) >= h(D)*euler_phi(f), where 
```

changed to

```
	            # we have h(D*f^2) >= (1/c)*h(D)*phi_D(f) >= (1/c)* h(D)*euler_phi(f), where 
```


With this change, I'm happy with your patch, so I think you can set it to positive review.



---

archive/issue_comments_141719.json:
```json
{
    "body": "Attachment [trac_12356-cm-review.patch](tarball://root/attachments/some-uuid/ticket12356/trac_12356-cm-review.patch) by @williamstein created at 2012-02-13 15:33:47\n\nchange a line and the commit message",
    "created_at": "2012-02-13T15:33:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141719",
    "user": "https://github.com/williamstein"
}
```

Attachment [trac_12356-cm-review.patch](tarball://root/attachments/some-uuid/ticket12356/trac_12356-cm-review.patch) by @williamstein created at 2012-02-13 15:33:47

change a line and the commit message



---

archive/issue_comments_141720.json:
```json
{
    "body": "I also changed the commit message to \"Trac #12356: fix Sphinx issues and one incorrect bound\" instead of \"trac 12356: fix Sphinx issues and one incorrect bound\", because unbeknowst to us somebody seems to have decided that the canonical label for commit messages is \"Trac #num: ...\".",
    "created_at": "2012-02-13T15:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141720",
    "user": "https://github.com/williamstein"
}
```

I also changed the commit message to "Trac #12356: fix Sphinx issues and one incorrect bound" instead of "trac 12356: fix Sphinx issues and one incorrect bound", because unbeknowst to us somebody seems to have decided that the canonical label for commit messages is "Trac #num: ...".



---

archive/issue_comments_141721.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-02-13T18:35:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141721",
    "user": "https://github.com/JohnCremona"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_141722.json:
```json
{
    "body": "Please state clearly which patches have to be applied...",
    "created_at": "2012-02-14T08:56:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141722",
    "user": "https://github.com/jdemeyer"
}
```

Please state clearly which patches have to be applied...



---

archive/issue_comments_141723.json:
```json
{
    "body": "Thanks.",
    "created_at": "2012-02-14T09:19:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141723",
    "user": "https://github.com/jdemeyer"
}
```

Thanks.



---

archive/issue_comments_141724.json:
```json
{
    "body": "Comment:  (1) running discriminants_with_bounded_class_number(hmax) creates a dict giving all the pairs (D,f) with class number h for h up to hmax. (2) running cm_orders(h) runs that with hmax=h and then throws away everything but the list for h itself; nothing is cached.  This is rather inefficient!  (3) I ran discriminants_with_bounded_class_number(100) -- 100 being teh largest value implemented -- and it took 19.5 hours; the output saves as a sobj file of size  630168 bytes.  \n\nTwo possible speedups would be (1) cache all calls to pari's qfbclassno() which is where most of the time is spent, and (2) cache the dict produced and only do any computations if called with a larger value.  And, now that this computation has been done once we could easily create a once-and-for-all Watkins-style table for non-maximal orders.",
    "created_at": "2012-02-17T10:10:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141724",
    "user": "https://github.com/JohnCremona"
}
```

Comment:  (1) running discriminants_with_bounded_class_number(hmax) creates a dict giving all the pairs (D,f) with class number h for h up to hmax. (2) running cm_orders(h) runs that with hmax=h and then throws away everything but the list for h itself; nothing is cached.  This is rather inefficient!  (3) I ran discriminants_with_bounded_class_number(100) -- 100 being teh largest value implemented -- and it took 19.5 hours; the output saves as a sobj file of size  630168 bytes.  

Two possible speedups would be (1) cache all calls to pari's qfbclassno() which is where most of the time is spent, and (2) cache the dict produced and only do any computations if called with a larger value.  And, now that this computation has been done once we could easily create a once-and-for-all Watkins-style table for non-maximal orders.



---

archive/issue_comments_141725.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-02-22T10:45:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12184#issuecomment-141725",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_012199.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2012-02-22T10:45:48Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12184",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12184#event-12199"
}
```
