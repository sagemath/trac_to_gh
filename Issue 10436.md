# Issue 10436: plot_slope_field broken

Issue created by migration from Trac.

Original creator: ManDay

Original creation time: 2010-12-17 09:54:55

Assignee: jason, was

CC:  kcrisman

Keywords: plot_slope_field

*plot_slope_field( lambda x,y: x+y,(x,-3,4),(y,-2,2) );*

results in



```
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "_sage_input_15.py", line 10, in <module>
    exec compile(u'open("___code___.py","w").write("# -*- coding: utf-8 -*-\\n" + _support_.preparse_worksheet_cell(base64.b64decode("cGxvdF9zbG9wZV9maWVsZCggbGFtYmRhIHgseTogeCt5LCh4LC0zLDQpLCh5LC0yLDIpICk7"),globals())+"\\n"); execfile(os.path.abspath("___code___.py"))
  File "", line 1, in <module>
    
  File "/tmp/tmp639i0K/___code___.py", line 3, in <module>
    exec compile(u'plot_slope_field( lambda x,y: x+y,(x,-_sage_const_3 ,_sage_const_4 ),(y,-_sage_const_2 ,_sage_const_2 ) );
  File "", line 1, in <module>
    
  File "/homes/sageserv/sage-4.5.1-Solaris_10_SPARC/local/lib/python2.6/site-packages/sage/plot/plot_field.py", line 220, in plot_slope_field
    norm = sqrt((f**2+1))
TypeError: unsupported operand type(s) for ** or pow(): 'function' and 'int'
```



---

Comment by jason created at 2010-12-17 17:43:54

Did that ever work?  I think the code assumes that a symbolic function is given:


```
sage: f(x,y)=x+y
sage: plot_slope_field(f,(x,-3,4),(y,-2,2) )
```



---

Comment by jason created at 2010-12-17 17:47:20

Changing type from defect to enhancement.


---

Comment by jason created at 2010-12-17 17:47:20

Changing to enhancement, since I don't think the code was ever designed to handle a python lambda function.  I suggest changing the code to see if we have a symbolic expression or a python function.  If a python function, then create a new lambda function which normalizes the vectors.


---

Comment by jason created at 2010-12-17 18:06:47

Changing status from new to needs_review.


---

Attachment

Attached patch adds this feature to plot_slope_field.  Someone just needs to review it!


---

Comment by ManDay created at 2010-12-17 18:42:54

Thank you. I figured this out by now but you had already replied. I just think this should be a consistent behaviour through all plotting functions (unless the nature of the function itsself demands otherwise - and then it should be made very explicit). I don't think that some function should be able to handle both, some only the prior and some only the latter.


---

Comment by jason created at 2010-12-17 19:10:58

Replying to [comment:4 ManDay]:
> Thank you. I figured this out by now but you had already replied. I just think this should be a consistent behaviour through all plotting functions (unless the nature of the function itsself demands otherwise - and then it should be made very explicit). I don't think that some function should be able to handle both, some only the prior and some only the latter.
> 

I agree!  Feel free to review the patch.


---

Comment by jason created at 2011-01-11 16:56:18

Add the beginner keyword, as this seems like a good beginner review.


---

Comment by jason created at 2011-01-11 16:56:18

Changing keywords from "plot_slope_field" to "plot_slope_field beginner".


---

Comment by aly.deines created at 2011-01-11 23:05:32

Running sage-4.6.1.rc0 on sage.math the patch did not apply:


adeines`@`sage:~/sage-4.6.1.rc0/devel/sage$ hg qpush
applying 10489_slope_field_lambda.patch
patching file sage/plot/plot_field.py
Hunk #1 FAILED at 218
1 out of 1 hunks FAILED -- saving rejects to file sage/plot/plot_field.py.rej
patch failed, unable to continue (try -v)
patch failed, rejects left in working dir
errors during apply, please fix and refresh 10489_slope_field_lambda.patch
adeines`@`sage:~/sage-4.6.1.rc0/devel/sage$ vi sage/plot/plot_field.py.rej 

--- plot_field.py
+++ plot_field.py
`@``@` -219,10 +219,21 `@``@`

         sage: x,y = var('x y')
         sage: plot_slope_field(sin(x+y)+cos(x+y), (x,-3,3), (y,-3,3))
+
+    Plot a slope field using a lambda function::
+
+        sage: plot_slope_field(lambda x,y: x+y, (-2,2), (-2,2))
+
     """
     slope_options = {'headaxislength': 0, 'headlength': 0, 'pivot': 'middle'}
     slope_options.update(kwds)

     from sage.functions.all import sqrt
-    norm = sqrt((f**2+1))
-    return plot_vector_field((1/norm, f/norm), xrange, yrange, **slope_options)
+    from inspect import isfunction
+    if isfunction(f):
+        norm_inverse=lambda x,y: 1/sqrt(f(x,y)**2+1)
+        f_normalized=lambda x,y: f(x,y)*norm_inverse(x,y)
+    else:
+        norm_inverse = 1/sqrt((f**2+1))
+        f_normalized=f*norm_inverse
+    return plot_vector_field((norm_inverse, f_normalized), xrange, yrange, **slope_options)


---

Comment by aly.deines created at 2011-01-11 23:05:32

Changing status from needs_review to needs_work.


---

Comment by ryan created at 2011-01-17 16:24:15

rebased against sage-4.6.1


---

Attachment

rebased patch against sage-4.6.1
Should apply cleanly now.

All tests passed on my machine.  However, plotting the doctest gave several warnings before finally plotting the function.  Should we maybe check for divide by zero cases or other such cases?
{{{Warning: divide by zero encountered in divide
Warning: invalid value encountered in multiply
Warning: invalid value encountered in multiply
Warning: divide by zero encountered in divide
Warning: invalid value encountered in multiply
Warning: invalid value encountered in multiply}}}


---

Comment by jason created at 2011-01-17 17:03:09

Replying to [comment:9 ryan]:
> rebased patch against sage-4.6.1
> Should apply cleanly now.
> 
> All tests passed on my machine.  However, plotting the doctest gave several warnings before finally plotting the function.  Should we maybe check for divide by zero cases or other such cases?


Yes, but that is a separate issue from this ticket, so we should open a new ticket for that.  In fact, I seem to remember that a ticket was opened several years ago for the divide by zero issue.


---

Comment by jason created at 2011-01-17 17:07:39

#5553 is a related issue to the divide by zero issue.


---

Comment by kcrisman created at 2011-05-24 02:54:57

The issue with the divide by zero warnings is #11208.


---

Comment by ncarter created at 2012-01-09 17:26:33

The most recent patch (12 mo ago) doesn't apply anymore.  I will now upload an updated version of the same patch, for review.


---

Attachment

Updating previous patch to newer Sage version


---

Comment by ncarter created at 2012-01-09 17:27:25

Changing status from needs_work to needs_review.


---

Comment by ncarter created at 2012-01-09 19:39:52

Changing keywords from "plot_slope_field beginner" to "plot_slope_field beginner sd35.5".


---

Comment by benjaminfjones created at 2012-01-10 00:14:07

Changing status from needs_review to positive_review.


---

Comment by benjaminfjones created at 2012-01-10 00:20:08

The patch `trac-10489-slope-field-lambda-4-7-3.patch` applies cleanly to Sage-4.8.alpha6, all doctests pass, the patch looks great.

Positive review.


---

Comment by kcrisman created at 2012-01-10 01:42:41

Assuming that the plots look great as well :)


---

Comment by benjaminfjones created at 2012-01-10 02:19:44

They look correct to me.


---

Comment by jdemeyer created at 2012-01-21 23:37:33

Resolution: fixed
