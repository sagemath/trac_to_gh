# Issue 10436: plot_slope_field broken

archive/issues_010436.json:
```json
{
    "body": "Assignee: jason, was\n\nCC:  kcrisman\n\nKeywords: plot_slope_field\n\n**plot_slope_field( lambda x,y: x+y,(x,-3,4),(y,-2,2) );**\n\nresults in\n\n\n\n```\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\n  File \"_sage_input_15.py\", line 10, in <module>\n    exec compile(u'open(\"___code___.py\",\"w\").write(\"# -*- coding: utf-8 -*-\\\\n\" + _support_.preparse_worksheet_cell(base64.b64decode(\"cGxvdF9zbG9wZV9maWVsZCggbGFtYmRhIHgseTogeCt5LCh4LC0zLDQpLCh5LC0yLDIpICk7\"),globals())+\"\\\\n\"); execfile(os.path.abspath(\"___code___.py\"))\n  File \"\", line 1, in <module>\n    \n  File \"/tmp/tmp639i0K/___code___.py\", line 3, in <module>\n    exec compile(u'plot_slope_field( lambda x,y: x+y,(x,-_sage_const_3 ,_sage_const_4 ),(y,-_sage_const_2 ,_sage_const_2 ) );\n  File \"\", line 1, in <module>\n    \n  File \"/homes/sageserv/sage-4.5.1-Solaris_10_SPARC/local/lib/python2.6/site-packages/sage/plot/plot_field.py\", line 220, in plot_slope_field\n    norm = sqrt((f**2+1))\nTypeError: unsupported operand type(s) for ** or pow(): 'function' and 'int'\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/10489\n\n",
    "created_at": "2010-12-17T09:54:55Z",
    "labels": [
        "graphics",
        "major",
        "bug"
    ],
    "title": "plot_slope_field broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10436",
    "user": "ManDay"
}
```
Assignee: jason, was

CC:  kcrisman

Keywords: plot_slope_field

**plot_slope_field( lambda x,y: x+y,(x,-3,4),(y,-2,2) );**

results in



```
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "_sage_input_15.py", line 10, in <module>
    exec compile(u'open("___code___.py","w").write("# -*- coding: utf-8 -*-\\n" + _support_.preparse_worksheet_cell(base64.b64decode("cGxvdF9zbG9wZV9maWVsZCggbGFtYmRhIHgseTogeCt5LCh4LC0zLDQpLCh5LC0yLDIpICk7"),globals())+"\\n"); execfile(os.path.abspath("___code___.py"))
  File "", line 1, in <module>
    
  File "/tmp/tmp639i0K/___code___.py", line 3, in <module>
    exec compile(u'plot_slope_field( lambda x,y: x+y,(x,-_sage_const_3 ,_sage_const_4 ),(y,-_sage_const_2 ,_sage_const_2 ) );
  File "", line 1, in <module>
    
  File "/homes/sageserv/sage-4.5.1-Solaris_10_SPARC/local/lib/python2.6/site-packages/sage/plot/plot_field.py", line 220, in plot_slope_field
    norm = sqrt((f**2+1))
TypeError: unsupported operand type(s) for ** or pow(): 'function' and 'int'
```


Issue created by migration from https://trac.sagemath.org/ticket/10489





---

archive/issue_comments_107607.json:
```json
{
    "body": "Did that ever work?  I think the code assumes that a symbolic function is given:\n\n\n```\nsage: f(x,y)=x+y\nsage: plot_slope_field(f,(x,-3,4),(y,-2,2) )\n```\n",
    "created_at": "2010-12-17T17:43:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107607",
    "user": "jason"
}
```

Did that ever work?  I think the code assumes that a symbolic function is given:


```
sage: f(x,y)=x+y
sage: plot_slope_field(f,(x,-3,4),(y,-2,2) )
```




---

archive/issue_comments_107608.json:
```json
{
    "body": "Changing type from defect to enhancement.",
    "created_at": "2010-12-17T17:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107608",
    "user": "jason"
}
```

Changing type from defect to enhancement.



---

archive/issue_comments_107609.json:
```json
{
    "body": "Changing to enhancement, since I don't think the code was ever designed to handle a python lambda function.  I suggest changing the code to see if we have a symbolic expression or a python function.  If a python function, then create a new lambda function which normalizes the vectors.",
    "created_at": "2010-12-17T17:47:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107609",
    "user": "jason"
}
```

Changing to enhancement, since I don't think the code was ever designed to handle a python lambda function.  I suggest changing the code to see if we have a symbolic expression or a python function.  If a python function, then create a new lambda function which normalizes the vectors.



---

archive/issue_comments_107610.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-12-17T18:06:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107610",
    "user": "jason"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_107611.json:
```json
{
    "body": "Attachment\n\nAttached patch adds this feature to plot_slope_field.  Someone just needs to review it!",
    "created_at": "2010-12-17T18:06:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107611",
    "user": "jason"
}
```

Attachment

Attached patch adds this feature to plot_slope_field.  Someone just needs to review it!



---

archive/issue_comments_107612.json:
```json
{
    "body": "Thank you. I figured this out by now but you had already replied. I just think this should be a consistent behaviour through all plotting functions (unless the nature of the function itsself demands otherwise - and then it should be made very explicit). I don't think that some function should be able to handle both, some only the prior and some only the latter.",
    "created_at": "2010-12-17T18:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107612",
    "user": "ManDay"
}
```

Thank you. I figured this out by now but you had already replied. I just think this should be a consistent behaviour through all plotting functions (unless the nature of the function itsself demands otherwise - and then it should be made very explicit). I don't think that some function should be able to handle both, some only the prior and some only the latter.



---

archive/issue_comments_107613.json:
```json
{
    "body": "Replying to [comment:4 ManDay]:\n> Thank you. I figured this out by now but you had already replied. I just think this should be a consistent behaviour through all plotting functions (unless the nature of the function itsself demands otherwise - and then it should be made very explicit). I don't think that some function should be able to handle both, some only the prior and some only the latter.\n> \n\nI agree!  Feel free to review the patch.",
    "created_at": "2010-12-17T19:10:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107613",
    "user": "jason"
}
```

Replying to [comment:4 ManDay]:
> Thank you. I figured this out by now but you had already replied. I just think this should be a consistent behaviour through all plotting functions (unless the nature of the function itsself demands otherwise - and then it should be made very explicit). I don't think that some function should be able to handle both, some only the prior and some only the latter.
> 

I agree!  Feel free to review the patch.



---

archive/issue_comments_107614.json:
```json
{
    "body": "Add the beginner keyword, as this seems like a good beginner review.",
    "created_at": "2011-01-11T16:56:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107614",
    "user": "jason"
}
```

Add the beginner keyword, as this seems like a good beginner review.



---

archive/issue_comments_107615.json:
```json
{
    "body": "Changing keywords from \"plot_slope_field\" to \"plot_slope_field beginner\".",
    "created_at": "2011-01-11T16:56:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107615",
    "user": "jason"
}
```

Changing keywords from "plot_slope_field" to "plot_slope_field beginner".



---

archive/issue_comments_107616.json:
```json
{
    "body": "Running sage-4.6.1.rc0 on sage.math the patch did not apply:\n\n\nadeines`@`sage:~/sage-4.6.1.rc0/devel/sage$ hg qpush\napplying 10489_slope_field_lambda.patch\npatching file sage/plot/plot_field.py\nHunk #1 FAILED at 218\n1 out of 1 hunks FAILED -- saving rejects to file sage/plot/plot_field.py.rej\npatch failed, unable to continue (try -v)\npatch failed, rejects left in working dir\nerrors during apply, please fix and refresh 10489_slope_field_lambda.patch\nadeines`@`sage:~/sage-4.6.1.rc0/devel/sage$ vi sage/plot/plot_field.py.rej \n\n--- plot_field.py\n+++ plot_field.py\n`@``@` -219,10 +219,21 `@``@`\n\n         sage: x,y = var('x y')\n         sage: plot_slope_field(sin(x+y)+cos(x+y), (x,-3,3), (y,-3,3))\n+\n+    Plot a slope field using a lambda function::\n+\n+        sage: plot_slope_field(lambda x,y: x+y, (-2,2), (-2,2))\n+\n     \"\"\"\n     slope_options = {'headaxislength': 0, 'headlength': 0, 'pivot': 'middle'}\n     slope_options.update(kwds)\n\n     from sage.functions.all import sqrt\n-    norm = sqrt((f**2+1))\n-    return plot_vector_field((1/norm, f/norm), xrange, yrange, **slope_options)\n+    from inspect import isfunction\n+    if isfunction(f):\n+        norm_inverse=lambda x,y: 1/sqrt(f(x,y)**2+1)\n+        f_normalized=lambda x,y: f(x,y)*norm_inverse(x,y)\n+    else:\n+        norm_inverse = 1/sqrt((f**2+1))\n+        f_normalized=f*norm_inverse\n+    return plot_vector_field((norm_inverse, f_normalized), xrange, yrange, **slope_options)",
    "created_at": "2011-01-11T23:05:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107616",
    "user": "aly.deines"
}
```

Running sage-4.6.1.rc0 on sage.math the patch did not apply:


adeines`@`sage:~/sage-4.6.1.rc0/devel/sage$ hg qpush
applying 10489_slope_field_lambda.patch
patching file sage/plot/plot_field.py
Hunk #1 FAILED at 218
1 out of 1 hunks FAILED -- saving rejects to file sage/plot/plot_field.py.rej
patch failed, unable to continue (try -v)
patch failed, rejects left in working dir
errors during apply, please fix and refresh 10489_slope_field_lambda.patch
adeines`@`sage:~/sage-4.6.1.rc0/devel/sage$ vi sage/plot/plot_field.py.rej 

--- plot_field.py
+++ plot_field.py
`@``@` -219,10 +219,21 `@``@`

         sage: x,y = var('x y')
         sage: plot_slope_field(sin(x+y)+cos(x+y), (x,-3,3), (y,-3,3))
+
+    Plot a slope field using a lambda function::
+
+        sage: plot_slope_field(lambda x,y: x+y, (-2,2), (-2,2))
+
     """
     slope_options = {'headaxislength': 0, 'headlength': 0, 'pivot': 'middle'}
     slope_options.update(kwds)

     from sage.functions.all import sqrt
-    norm = sqrt((f**2+1))
-    return plot_vector_field((1/norm, f/norm), xrange, yrange, **slope_options)
+    from inspect import isfunction
+    if isfunction(f):
+        norm_inverse=lambda x,y: 1/sqrt(f(x,y)**2+1)
+        f_normalized=lambda x,y: f(x,y)*norm_inverse(x,y)
+    else:
+        norm_inverse = 1/sqrt((f**2+1))
+        f_normalized=f*norm_inverse
+    return plot_vector_field((norm_inverse, f_normalized), xrange, yrange, **slope_options)



---

archive/issue_comments_107617.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-01-11T23:05:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107617",
    "user": "aly.deines"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_107618.json:
```json
{
    "body": "rebased against sage-4.6.1",
    "created_at": "2011-01-17T16:24:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107618",
    "user": "ryan"
}
```

rebased against sage-4.6.1



---

archive/issue_comments_107619.json:
```json
{
    "body": "Attachment\n\nrebased patch against sage-4.6.1\nShould apply cleanly now.\n\nAll tests passed on my machine.  However, plotting the doctest gave several warnings before finally plotting the function.  Should we maybe check for divide by zero cases or other such cases?\n\n```\nWarning: divide by zero encountered in divide\nWarning: invalid value encountered in multiply\nWarning: invalid value encountered in multiply\nWarning: divide by zero encountered in divide\nWarning: invalid value encountered in multiply\nWarning: invalid value encountered in multiply}}}",
    "created_at": "2011-01-17T16:30:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107619",
    "user": "ryan"
}
```

Attachment

rebased patch against sage-4.6.1
Should apply cleanly now.

All tests passed on my machine.  However, plotting the doctest gave several warnings before finally plotting the function.  Should we maybe check for divide by zero cases or other such cases?

```
Warning: divide by zero encountered in divide
Warning: invalid value encountered in multiply
Warning: invalid value encountered in multiply
Warning: divide by zero encountered in divide
Warning: invalid value encountered in multiply
Warning: invalid value encountered in multiply}}}



---

archive/issue_comments_107620.json:
```json
{
    "body": "Replying to [comment:9 ryan]:\n> rebased patch against sage-4.6.1\n> Should apply cleanly now.\n> \n> All tests passed on my machine.  However, plotting the doctest gave several warnings before finally plotting the function.  Should we maybe check for divide by zero cases or other such cases?\n\n\nYes, but that is a separate issue from this ticket, so we should open a new ticket for that.  In fact, I seem to remember that a ticket was opened several years ago for the divide by zero issue.",
    "created_at": "2011-01-17T17:03:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107620",
    "user": "jason"
}
```

Replying to [comment:9 ryan]:
> rebased patch against sage-4.6.1
> Should apply cleanly now.
> 
> All tests passed on my machine.  However, plotting the doctest gave several warnings before finally plotting the function.  Should we maybe check for divide by zero cases or other such cases?


Yes, but that is a separate issue from this ticket, so we should open a new ticket for that.  In fact, I seem to remember that a ticket was opened several years ago for the divide by zero issue.



---

archive/issue_comments_107621.json:
```json
{
    "body": "#5553 is a related issue to the divide by zero issue.",
    "created_at": "2011-01-17T17:07:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107621",
    "user": "jason"
}
```

#5553 is a related issue to the divide by zero issue.



---

archive/issue_comments_107622.json:
```json
{
    "body": "The issue with the divide by zero warnings is #11208.",
    "created_at": "2011-05-24T02:54:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107622",
    "user": "kcrisman"
}
```

The issue with the divide by zero warnings is #11208.



---

archive/issue_comments_107623.json:
```json
{
    "body": "The most recent patch (12 mo ago) doesn't apply anymore.  I will now upload an updated version of the same patch, for review.",
    "created_at": "2012-01-09T17:26:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107623",
    "user": "ncarter"
}
```

The most recent patch (12 mo ago) doesn't apply anymore.  I will now upload an updated version of the same patch, for review.



---

archive/issue_comments_107624.json:
```json
{
    "body": "Attachment\n\nUpdating previous patch to newer Sage version",
    "created_at": "2012-01-09T17:26:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107624",
    "user": "ncarter"
}
```

Attachment

Updating previous patch to newer Sage version



---

archive/issue_comments_107625.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-01-09T17:27:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107625",
    "user": "ncarter"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_107626.json:
```json
{
    "body": "Changing keywords from \"plot_slope_field beginner\" to \"plot_slope_field beginner sd35.5\".",
    "created_at": "2012-01-09T19:39:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107626",
    "user": "ncarter"
}
```

Changing keywords from "plot_slope_field beginner" to "plot_slope_field beginner sd35.5".



---

archive/issue_comments_107627.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-01-10T00:14:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107627",
    "user": "benjaminfjones"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_107628.json:
```json
{
    "body": "The patch `trac-10489-slope-field-lambda-4-7-3.patch` applies cleanly to Sage-4.8.alpha6, all doctests pass, the patch looks great.\n\nPositive review.",
    "created_at": "2012-01-10T00:20:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107628",
    "user": "benjaminfjones"
}
```

The patch `trac-10489-slope-field-lambda-4-7-3.patch` applies cleanly to Sage-4.8.alpha6, all doctests pass, the patch looks great.

Positive review.



---

archive/issue_comments_107629.json:
```json
{
    "body": "Assuming that the plots look great as well :)",
    "created_at": "2012-01-10T01:42:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107629",
    "user": "kcrisman"
}
```

Assuming that the plots look great as well :)



---

archive/issue_comments_107630.json:
```json
{
    "body": "They look correct to me.",
    "created_at": "2012-01-10T02:19:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107630",
    "user": "benjaminfjones"
}
```

They look correct to me.



---

archive/issue_comments_107631.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-01-21T23:37:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10436",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10436#issuecomment-107631",
    "user": "jdemeyer"
}
```

Resolution: fixed
