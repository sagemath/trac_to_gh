# Issue 14801: Improve startuptime by postponing the creation of argspecs of cached functions/methods

archive/issues_014801.json:
```json
{
    "body": "CC:  @nbruin @vbraun @robertwb\n\nKeywords: cached method, argspec, introspection, startup\n\nCurrently, if a cached method or function is created, an instance of `sage.misc.function_mangling.ArgumentFixer` is created as well. But this is only needed when the cached function/method is actually called.\n\nWith this patch, the `ArgumentFixer` is either created when it is needed to normalise arguments (i.e., when the function is called), or when a `CachedMethodCaller` is bound to an instance. The latter is because different `CachedMethodCaller`s bound to different instances share the `ArgumentFixer` with the `CachedMethod` that is bound to the class of the instances. Hence, it is reasonable to avoid creating the same `ArgumentFixer` repeatedly.\n\nWithout the patch, more than 500 `ArgumentFixer`s are created during startup of Sage. This is expensive, because one needs to determine the argspec of the cached functions/methods (this may even involve reading source code!!). With the patch, only 6 `ArgumentFixer`s are created.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15038\n\n",
    "created_at": "2013-08-12T14:22:23Z",
    "labels": [
        "performance",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.12",
    "title": "Improve startuptime by postponing the creation of argspecs of cached functions/methods",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14801",
    "user": "@simon-king-jena"
}
```
CC:  @nbruin @vbraun @robertwb

Keywords: cached method, argspec, introspection, startup

Currently, if a cached method or function is created, an instance of `sage.misc.function_mangling.ArgumentFixer` is created as well. But this is only needed when the cached function/method is actually called.

With this patch, the `ArgumentFixer` is either created when it is needed to normalise arguments (i.e., when the function is called), or when a `CachedMethodCaller` is bound to an instance. The latter is because different `CachedMethodCaller`s bound to different instances share the `ArgumentFixer` with the `CachedMethod` that is bound to the class of the instances. Hence, it is reasonable to avoid creating the same `ArgumentFixer` repeatedly.

Without the patch, more than 500 `ArgumentFixer`s are created during startup of Sage. This is expensive, because one needs to determine the argspec of the cached functions/methods (this may even involve reading source code!!). With the patch, only 6 `ArgumentFixer`s are created.

Issue created by migration from https://trac.sagemath.org/ticket/15038





---

archive/issue_comments_188787.json:
```json
{
    "body": "Attachment [trac15038-postpone_argspec_of_cached_functions.patch](tarball://root/attachments/some-uuid/ticket15038/trac15038-postpone_argspec_of_cached_functions.patch) by @simon-king-jena created at 2013-08-12 14:25:43\n\nIt seems to me that I observe a decrease of startup time of 4 or 5 percent with my patch, but I'd like to know whether the patchbots confirm this.",
    "created_at": "2013-08-12T14:25:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-188787",
    "user": "@simon-king-jena"
}
```

Attachment [trac15038-postpone_argspec_of_cached_functions.patch](tarball://root/attachments/some-uuid/ticket15038/trac15038-postpone_argspec_of_cached_functions.patch) by @simon-king-jena created at 2013-08-12 14:25:43

It seems to me that I observe a decrease of startup time of 4 or 5 percent with my patch, but I'd like to know whether the patchbots confirm this.



---

archive/issue_comments_188788.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-08-12T14:25:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-188788",
    "user": "@simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_188789.json:
```json
{
    "body": "Startup time is not everything, I think we should also test that there is no big regression in *calling* a cached method.\n\nWith the patch:\n\n```\nsage: @cached_function\n....: def f(a,b=1):\n....:     return 1\n....: \nsage: class C:\n....:     @cached_method\n....:     def a(self):\n....:         return 1\n....:     @cached_method\n....:     def b(self, a,b=1,*args,**kwds):\n....:         return 2\n....:     \nsage: c = C()\nsage: %timeit f(1)\n1000000 loops, best of 3: 916 ns per loop\nsage: %timeit f(1,2)\n1000000 loops, best of 3: 984 ns per loop\nsage: %timeit f(a=1,b=2)\n100000 loops, best of 3: 2.56 us per loop\nsage: %timeit c.b(1,x=4)\n100000 loops, best of 3: 2.8 us per loop\nsage: %timeit c.b(1,4)\n1000000 loops, best of 3: 886 ns per loop\n```\n\n\nWithout the patch:\n\n```\nsage: c = C()\nsage: %timeit f(1)\n1000000 loops, best of 3: 922 ns per loop\nsage: %timeit f(1,2)\n1000000 loops, best of 3: 975 ns per loop\nsage: %timeit f(a=1,b=2)\n100000 loops, best of 3: 2.42 us per loop\nsage: %timeit c.b(1,x=4)\n100000 loops, best of 3: 2.86 us per loop\nsage: %timeit c.b(1,4)\n1000000 loops, best of 3: 991 ns per loop\n```\n\n\nI think this is fine. So, if the startup time would really improve by a couple percent, it would be a good progress.",
    "created_at": "2013-08-12T19:11:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-188789",
    "user": "@simon-king-jena"
}
```

Startup time is not everything, I think we should also test that there is no big regression in *calling* a cached method.

With the patch:

```
sage: @cached_function
....: def f(a,b=1):
....:     return 1
....: 
sage: class C:
....:     @cached_method
....:     def a(self):
....:         return 1
....:     @cached_method
....:     def b(self, a,b=1,*args,**kwds):
....:         return 2
....:     
sage: c = C()
sage: %timeit f(1)
1000000 loops, best of 3: 916 ns per loop
sage: %timeit f(1,2)
1000000 loops, best of 3: 984 ns per loop
sage: %timeit f(a=1,b=2)
100000 loops, best of 3: 2.56 us per loop
sage: %timeit c.b(1,x=4)
100000 loops, best of 3: 2.8 us per loop
sage: %timeit c.b(1,4)
1000000 loops, best of 3: 886 ns per loop
```


Without the patch:

```
sage: c = C()
sage: %timeit f(1)
1000000 loops, best of 3: 922 ns per loop
sage: %timeit f(1,2)
1000000 loops, best of 3: 975 ns per loop
sage: %timeit f(a=1,b=2)
100000 loops, best of 3: 2.42 us per loop
sage: %timeit c.b(1,x=4)
100000 loops, best of 3: 2.86 us per loop
sage: %timeit c.b(1,4)
1000000 loops, best of 3: 991 ns per loop
```


I think this is fine. So, if the startup time would really improve by a couple percent, it would be a good progress.



---

archive/issue_comments_188790.json:
```json
{
    "body": "Unfortunately, the patchbot does not confirm what I saw when I've run `sage -startuptime` a couple of times with and without the patch. Anyway, I think the approach of this patch is still valid.",
    "created_at": "2013-08-14T08:38:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-188790",
    "user": "@simon-king-jena"
}
```

Unfortunately, the patchbot does not confirm what I saw when I've run `sage -startuptime` a couple of times with and without the patch. Anyway, I think the approach of this patch is still valid.



---

archive/issue_comments_188791.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-08-15T17:26:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-188791",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_188792.json:
```json
{
    "body": "Hey Simon,\n\nHere are my timings with patch (same setup):\n\n```\nsage: %timeit f(1)\n100000 loops, best of 3: 1.37 us per loop\nsage: %timeit f(1,2)\n100000 loops, best of 3: 1.5 us per loop\nsage: %timeit f(a=1,b=2)\n100000 loops, best of 3: 3.73 us per loop\nsage: %timeit c.b(1,x=4)\n100000 loops, best of 3: 4 us per loop\nsage: %timeit c.b(1,4)\n100000 loops, best of 3: 1.67 us per loop\n```\n\nand without:\n\n```\nsage: %timeit f(1)\n100000 loops, best of 3: 1.44 us per loop\nsage: %timeit f(1,2)\n100000 loops, best of 3: 1.55 us per loop\nsage: %timeit f(a=1,b=2)\n100000 loops, best of 3: 3.79 us per loop\nsage: %timeit c.b(1,x=4)\n100000 loops, best of 3: 4.02 us per loop\nsage: %timeit c.b(1,4)\n100000 loops, best of 3: 1.64 us per loop\n```\n\nSo I don't see any (statically) significant speed regression, nor do I expect a couple of simple C-level if statements to slow anything down. I also get a modest startup-time improvement of about 5%, so I'm happy with this patch.\n\nBest,\n\nTravis",
    "created_at": "2013-08-15T17:26:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-188792",
    "user": "@tscrim"
}
```

Hey Simon,

Here are my timings with patch (same setup):

```
sage: %timeit f(1)
100000 loops, best of 3: 1.37 us per loop
sage: %timeit f(1,2)
100000 loops, best of 3: 1.5 us per loop
sage: %timeit f(a=1,b=2)
100000 loops, best of 3: 3.73 us per loop
sage: %timeit c.b(1,x=4)
100000 loops, best of 3: 4 us per loop
sage: %timeit c.b(1,4)
100000 loops, best of 3: 1.67 us per loop
```

and without:

```
sage: %timeit f(1)
100000 loops, best of 3: 1.44 us per loop
sage: %timeit f(1,2)
100000 loops, best of 3: 1.55 us per loop
sage: %timeit f(a=1,b=2)
100000 loops, best of 3: 3.79 us per loop
sage: %timeit c.b(1,x=4)
100000 loops, best of 3: 4.02 us per loop
sage: %timeit c.b(1,4)
100000 loops, best of 3: 1.64 us per loop
```

So I don't see any (statically) significant speed regression, nor do I expect a couple of simple C-level if statements to slow anything down. I also get a modest startup-time improvement of about 5%, so I'm happy with this patch.

Best,

Travis



---

archive/issue_comments_188793.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-08-20T12:59:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-188793",
    "user": "@jdemeyer"
}
```

Resolution: fixed
