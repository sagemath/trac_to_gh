# Issue 22444: needless quadratic time code in number_field.py

Issue created by migration from https://trac.sagemath.org/ticket/22681

Original creator: culler

Original creation time: 2017-03-26 00:21:17

`sage/src/sage/rings/number_field` contains the following loop:


```
   7292             if both_maps and K.degree() == self.degree():
   7293                 g = K['x'](self.polynomial())
   7294                 v = g.roots()
   7295                 a = from_K(K.gen())
   7296                 for i in range(len(v)):
   7297                     r = g.roots()[i][0]
   7298                     to_K = self.hom([r])    # check=False here ??
   7299                     if to_K(a) == K.gen():
   7300                         break
```


Line 7297 should read `r = v[i][0]` .

This actually leads to a huge speed-up.


---

Comment by chapoton created at 2017-03-26 07:33:38

Changing status from new to needs_review.


---

Comment by chapoton created at 2017-03-26 07:33:38

New commits:


---

Comment by vdelecroix created at 2017-03-26 09:10:10

Salut Frédéric,

If you don't care about multiplicity you can use

```
for root in g.roots(multiplicity=False):
    ...
```

(which would be cleaner than calling `root[0]`)


---

Comment by git created at 2017-03-26 09:12:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-03-26 09:38:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-03-26 09:39:40

Salut. Merci pour la suggestion. C'est fait.


---

Comment by vdelecroix created at 2017-03-26 11:21:02


```
sage -t --long rings/number_field/number_field_rel.py
**********************************************************************
File "rings/number_field/number_field_rel.py", line 1771, in sage.rings.number_field.number_field_rel.NumberField_relative.roots_of_unity
Failed example:
    K.roots_of_unity()[:5]
Expected:
    [b*a + b, b^2*a, -b^3, a + 1, b*a]
Got:
    [b*a, -b^2*a - b^2, b^3, -a, b*a + b]
**********************************************************************
```



---

Comment by vdelecroix created at 2017-03-26 11:21:02

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-03-26 11:52:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-03-26 11:53:50

ok, j'ai changé le test, après avoir vérifié que c'etait simplement un ordre different.


---

Comment by vdelecroix created at 2017-03-27 07:08:30

The order is also different with this new version...

```
sage -t --long src/sage/rings/number_field/number_field_rel.py
**********************************************************************
File "src/sage/rings/number_field/number_field_rel.py", line 1771, in sage.rings.number_field.number_field_rel.NumberField_relative.roots_of_unity
Failed example:
    K.roots_of_unity()[:5]
Expected:
    [b*a, -b^2*a - b^2, b^3, -a, b*a + b]
Got:
    [-b^3*a - b^3, -b^2*a, b, a + 1, -b^3*a]
**********************************************************************
```

You can for example replace with

```
sage: r = K.roots_of_unity()
sage: len(r)
24
sage: a*b in r and b^2*(a-1) in r
True
```


(however it would be interesting to investigate why it is different each time now...)


---

Comment by git created at 2017-04-02 15:33:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-04-02 15:33:41

I made a better doctest


---

Comment by chapoton created at 2017-04-02 15:33:41

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2017-04-02 18:42:25

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2017-04-02 18:42:25

good!


---

Comment by vbraun created at 2017-04-05 19:37:58

Resolution: fixed
