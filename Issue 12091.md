# Issue 12091: Unset TERM when running sage non-interactively

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2012-01-04 16:48:56

Assignee: leif

Because of either a readline or a Python bug, sometimes control characters are output by Python.  For example, on my Gentoo Linux system:

```
jdemeyer`@`arcanis:~$ sage --python -c 'import readline' |cat -t
^[[?1034hjdemeyer`@`arcanis:~$
```


This breaks doctests at #12249 for `sage-run`.  The easiest solution is to unset the `TERM` environment variable when running `sage-run` or `sage-eval`.  This will effectively disable readline.


---

Comment by jdemeyer created at 2012-01-04 16:57:27

Changing status from new to needs_review.


---

Attachment


---

Comment by vbraun created at 2012-01-04 17:26:41

Looks good!


---

Comment by vbraun created at 2012-01-04 17:26:41

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-01-05 07:49:08

Resolution: fixed


---

Comment by leif created at 2012-01-06 19:53:42

_"My Gentoo Linux system"_ isn't very precise.

Note that (also Sage's) readline uses _some_ termcap library, i.e. some "arbitrary" equivalent installed / found on a user's system, which apparently leads to improper output of control sequences (intended to be handled by the terminal) in some (mis-)configurations; cf. also [this Python bug report](http://mail.python.org/pipermail//new-bugs-announce/2011-October/011990.html).

Unsetting `TERM` unfortunately doesn't _"effectively disable readline"_, but may trigger other bugs, like the one reported [comment:ticket:11970:25 here].  Using `TERM=unknown` (or `none`) or something like that instead would perhaps avoid both.


---

Comment by jdemeyer created at 2012-01-07 21:08:07

Replying to [comment:5 leif]:
> Unsetting `TERM` unfortunately doesn't _"effectively disable readline"_, but may trigger other bugs, like the one reported [comment:ticket:11970:25 here].  Using `TERM=unknown` (or `none`) or something like that instead would perhaps avoid both.

I don't think that is a good solution, because we need Sage to work with `TERM` unset.  Imagine for example somebody wants to run sage from a cron script, then `TERM` would not be set.  Also, `TERM` is not set when you run something like

```
ssh mysagebox "sage script.sage"
```



---

Comment by leif created at 2012-01-07 21:18:21

Replying to [comment:6 jdemeyer]:
> I don't think that is a good solution, because we need Sage to work with `TERM` unset.

Well, then _someone_<sup>TM</sup> has to track down the (rare?) segfault reported at #11970... ;P


---

Comment by wjp created at 2012-01-14 15:39:33

Out of curiosity, do you really get an unset TERM in cron jobs and non-interactive ssh sessions? On all of the systems I've tried, it's always 'dumb'.

For context, this is readline outputting the "meta mode on"/"smm" sequence to enable 8 bit mode. This is signalled by the "km" termcap flag, viewable using 'infocmp', where you can also directly see the "smm" sequence.


---

Comment by jdemeyer created at 2012-01-14 18:10:03

Replying to [comment:8 wjp]:
> Out of curiosity, do you really get an unset TERM in cron jobs and non-interactive ssh sessions? On all of the systems I've tried, it's always 'dumb'.

Are you sure there is an *environment variable* "TERM" in the cases you mention?  It seems to me that bash sets a non-exported variable TERM=dumb if there is no environment variable TERM.  You can see this with "declare -p TERM".  In a normal shell, I get for example

```
$ declare -p TERM
declare -x TERM="xterm"
```

(the -x means exported)

With a non-interactive ssh session:

```
$ ssh sage.math.washington.edu "declare -p TERM"
declare -- TERM="dumb"
```

(no -x, so not exported, i.e. not an environment variable)
