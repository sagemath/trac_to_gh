# Issue 28059: Random failure in src/sage/rings/qqbar.py

Issue created by migration from https://trac.sagemath.org/ticket/28296

Original creator: vbraun

Original creation time: 2019-07-30 22:13:48

Keywords: random_fail

I'm seeing this with a rather high frequency:

```
**********************************************************************
File "src/sage/rings/qqbar.py", line 520, in sage.rings.qqbar
Failed example:
    z2 = QQbar.polynomial_root(p4, ival)
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1105, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.qqbar[183]>", line 1, in <module>
        z2 = QQbar.polynomial_root(p4, ival)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/qqbar.py", line 1411, in polynomial_root
        return AlgebraicNumber(ANRoot(poly, interval, multiplicity))
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/qqbar.py", line 6209, in __init__
        self._interval = self.refine_interval(interval, 64)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/qqbar.py", line 6367, in refine_interval
        v = self._complex_refine_interval(interval, prec)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/qqbar.py", line 6594, in _complex_refine_interval
        return self._complex_isolate_interval(interval, prec)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/qqbar.py", line 6688, in _complex_isolate_interval
        rts = self._poly.complex_roots(prec, self._multiplicity)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/qqbar.py", line 6107, in complex_roots
        roots_mult = complex_roots(p, min_prec=prec)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/polynomial/complex_roots.py", line 258, in complex_roots
        rts = cfac.roots(multiplicities=False)
      File "sage/rings/polynomial/polynomial_element.pyx", line 7629, in sage.rings.polynomial.polynomial_element.Polynomial.roots (build/cythonized/sage/rings/polynomial/polynomial_element.c:59323)
        ext_rts = self.__pari__().polroots(precision=L.prec())
      File "cypari2/gen.pyx", line 4122, in cypari2.gen.Gen.polroots
    AlarmInterrupt
**********************************************************************
1 item had failures:
   1 of 186 in sage.rings.qqbar
    [1483 tests, 1 failure, 96.81 s]
----------------------------------------------------------------------
sage -t --long src/sage/rings/qqbar.py  # 1 doctest failed
----------------------------------------------------------------------
```

I don't understand how it can run into an AlarmInterrupt


---

Comment by vdelecroix created at 2019-07-30 22:32:43

This doctest is not supposed to take more than a second

```
    sage: alarm(1.0)
    sage: z2 = QQbar.polynomial_root(p4, ival)
    sage: cancel_alarm()
```

Should I increase to 5?


---

Comment by vbraun created at 2019-07-31 07:07:25

Did you try running it on a raspberry pi, for example? I understand why you would want to test for speed regressions, but this isn't a good way of doing it.  

The doctest framework has already an overall speed factor of the machine, collected from previous runs. It is used for the "slow doctest" warning. At the very least this shoud be taken into account. For failed tests it should also display the actual time taken, not just crash in an AlarmInterrupt.


---

Comment by vdelecroix created at 2019-07-31 08:14:32

Replying to [comment:2 vbraun]:
> Did you try running it on a raspberry pi, for example? I understand why you would want to test for speed regressions, but this isn't a good way of doing it.  
> 
> The doctest framework has already an overall speed factor of the machine, collected from previous runs. It is used for the "slow doctest" warning. At the very least this shoud be taken into account. For failed tests it should also display the actual time taken, not just crash in an AlarmInterrupt.

Of course I did not check on raspberry pi. How should I test for speed regression then? The only framework available are doctests. The only purpose of #17895 was to speed up execution. There is nothing changed from an input/output point of view.


---

Comment by vbraun created at 2019-07-31 09:24:26

Sure. The point that I'm trying to make is that, at least for now, you have to be *very* conservative with the upper time limit in a doctest.


---

Comment by vdelecroix created at 2019-07-31 09:27:35

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2019-07-31 09:27:35

New commits:


---

Comment by git created at 2019-07-31 09:28:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vbraun created at 2019-08-01 22:53:59

Changing status from needs_review to positive_review.


---

Comment by @timokau created at 2019-08-02 13:40:02

Replying to [comment:3 vdelecroix]:
> Replying to [comment:2 vbraun]:
> > Did you try running it on a raspberry pi, for example? I understand why you would want to test for speed regressions, but this isn't a good way of doing it.  
> > 
> > The doctest framework has already an overall speed factor of the machine, collected from previous runs. It is used for the "slow doctest" warning. At the very least this shoud be taken into account. For failed tests it should also display the actual time taken, not just crash in an AlarmInterrupt.
> 
> Of course I did not check on raspberry pi.

It's not just problematic when testing on a raspberry pi. For example our (nixos) buildservers rebuild and retest sage regularly. Sometimes the build servers may be under heavy load. Then a test can take an excessive amount of time, but it should not fail (which would fail the whole sage package).

Performance regressions are hard to measure, although worthwhile. But they should be tested entirely separately from the functionality tests.


---

Comment by @timokau created at 2019-08-02 13:41:50

So as a summary, I propose to remove the alarm completely. If I put my laptop in suspend in the middle of running the test suite and wake it up again an hour later, the test suite should still pass. If we want to keep performance tests in the main test suite, they should at least be behind an optional flag so they are disable-able.


---

Comment by vdelecroix created at 2019-08-02 13:45:52

Replying to [comment:9 gh-timokau]:
> So as a summary, I propose to remove the alarm completely. If I put my laptop in suspend in the middle of running the test suite and wake it up again an hour later, the test suite should still pass. If we want to keep performance tests in the main test suite, they should at least be behind an optional flag so they are disable-able.

Could you open a ticket? This is not the only test concerned. And this should be documented in the developer guide: `do not use alarm to test performance`.


---

Comment by vbraun created at 2019-08-02 14:20:30

Hiding it behind a # optional - benchmark (or so) sounds like a good solution. If you make a ticket I'll review it ;-)


---

Comment by vbraun created at 2019-08-03 23:51:45

Resolution: fixed
