# Issue 28059: Random failure in src/sage/rings/qqbar.py

archive/issues_028059.json:
```json
{
    "body": "Keywords: random_fail\n\nI'm seeing this with a rather high frequency:\n\n```\n**********************************************************************\nFile \"src/sage/rings/qqbar.py\", line 520, in sage.rings.qqbar\nFailed example:\n    z2 = QQbar.polynomial_root(p4, ival)\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1105, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.rings.qqbar[183]>\", line 1, in <module>\n        z2 = QQbar.polynomial_root(p4, ival)\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/qqbar.py\", line 1411, in polynomial_root\n        return AlgebraicNumber(ANRoot(poly, interval, multiplicity))\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/qqbar.py\", line 6209, in __init__\n        self._interval = self.refine_interval(interval, 64)\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/qqbar.py\", line 6367, in refine_interval\n        v = self._complex_refine_interval(interval, prec)\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/qqbar.py\", line 6594, in _complex_refine_interval\n        return self._complex_isolate_interval(interval, prec)\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/qqbar.py\", line 6688, in _complex_isolate_interval\n        rts = self._poly.complex_roots(prec, self._multiplicity)\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/qqbar.py\", line 6107, in complex_roots\n        roots_mult = complex_roots(p, min_prec=prec)\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/polynomial/complex_roots.py\", line 258, in complex_roots\n        rts = cfac.roots(multiplicities=False)\n      File \"sage/rings/polynomial/polynomial_element.pyx\", line 7629, in sage.rings.polynomial.polynomial_element.Polynomial.roots (build/cythonized/sage/rings/polynomial/polynomial_element.c:59323)\n        ext_rts = self.__pari__().polroots(precision=L.prec())\n      File \"cypari2/gen.pyx\", line 4122, in cypari2.gen.Gen.polroots\n    AlarmInterrupt\n**********************************************************************\n1 item had failures:\n   1 of 186 in sage.rings.qqbar\n    [1483 tests, 1 failure, 96.81 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/rings/qqbar.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n\nI don't understand how it can run into an AlarmInterrupt\n\nIssue created by migration from https://trac.sagemath.org/ticket/28296\n\n",
    "created_at": "2019-07-30T22:13:48Z",
    "labels": [
        "component: number theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "Random failure in src/sage/rings/qqbar.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28059",
    "user": "https://github.com/vbraun"
}
```
Keywords: random_fail

I'm seeing this with a rather high frequency:

```
**********************************************************************
File "src/sage/rings/qqbar.py", line 520, in sage.rings.qqbar
Failed example:
    z2 = QQbar.polynomial_root(p4, ival)
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1105, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.qqbar[183]>", line 1, in <module>
        z2 = QQbar.polynomial_root(p4, ival)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/qqbar.py", line 1411, in polynomial_root
        return AlgebraicNumber(ANRoot(poly, interval, multiplicity))
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/qqbar.py", line 6209, in __init__
        self._interval = self.refine_interval(interval, 64)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/qqbar.py", line 6367, in refine_interval
        v = self._complex_refine_interval(interval, prec)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/qqbar.py", line 6594, in _complex_refine_interval
        return self._complex_isolate_interval(interval, prec)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/qqbar.py", line 6688, in _complex_isolate_interval
        rts = self._poly.complex_roots(prec, self._multiplicity)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/qqbar.py", line 6107, in complex_roots
        roots_mult = complex_roots(p, min_prec=prec)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/polynomial/complex_roots.py", line 258, in complex_roots
        rts = cfac.roots(multiplicities=False)
      File "sage/rings/polynomial/polynomial_element.pyx", line 7629, in sage.rings.polynomial.polynomial_element.Polynomial.roots (build/cythonized/sage/rings/polynomial/polynomial_element.c:59323)
        ext_rts = self.__pari__().polroots(precision=L.prec())
      File "cypari2/gen.pyx", line 4122, in cypari2.gen.Gen.polroots
    AlarmInterrupt
**********************************************************************
1 item had failures:
   1 of 186 in sage.rings.qqbar
    [1483 tests, 1 failure, 96.81 s]
----------------------------------------------------------------------
sage -t --long src/sage/rings/qqbar.py  # 1 doctest failed
----------------------------------------------------------------------
```

I don't understand how it can run into an AlarmInterrupt

Issue created by migration from https://trac.sagemath.org/ticket/28296





---

archive/issue_comments_396118.json:
```json
{
    "body": "This doctest is not supposed to take more than a second\n\n```\n    sage: alarm(1.0)\n    sage: z2 = QQbar.polynomial_root(p4, ival)\n    sage: cancel_alarm()\n```\n\nShould I increase to 5?",
    "created_at": "2019-07-30T22:32:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-396118",
    "user": "https://github.com/videlec"
}
```

This doctest is not supposed to take more than a second

```
    sage: alarm(1.0)
    sage: z2 = QQbar.polynomial_root(p4, ival)
    sage: cancel_alarm()
```

Should I increase to 5?



---

archive/issue_comments_396119.json:
```json
{
    "body": "Did you try running it on a raspberry pi, for example? I understand why you would want to test for speed regressions, but this isn't a good way of doing it.  \n\nThe doctest framework has already an overall speed factor of the machine, collected from previous runs. It is used for the \"slow doctest\" warning. At the very least this shoud be taken into account. For failed tests it should also display the actual time taken, not just crash in an AlarmInterrupt.",
    "created_at": "2019-07-31T07:07:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-396119",
    "user": "https://github.com/vbraun"
}
```

Did you try running it on a raspberry pi, for example? I understand why you would want to test for speed regressions, but this isn't a good way of doing it.  

The doctest framework has already an overall speed factor of the machine, collected from previous runs. It is used for the "slow doctest" warning. At the very least this shoud be taken into account. For failed tests it should also display the actual time taken, not just crash in an AlarmInterrupt.



---

archive/issue_comments_396120.json:
```json
{
    "body": "Replying to [comment:2 vbraun]:\n> Did you try running it on a raspberry pi, for example? I understand why you would want to test for speed regressions, but this isn't a good way of doing it.  \n> \n> The doctest framework has already an overall speed factor of the machine, collected from previous runs. It is used for the \"slow doctest\" warning. At the very least this shoud be taken into account. For failed tests it should also display the actual time taken, not just crash in an AlarmInterrupt.\n\nOf course I did not check on raspberry pi. How should I test for speed regression then? The only framework available are doctests. The only purpose of #17895 was to speed up execution. There is nothing changed from an input/output point of view.",
    "created_at": "2019-07-31T08:14:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-396120",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:2 vbraun]:
> Did you try running it on a raspberry pi, for example? I understand why you would want to test for speed regressions, but this isn't a good way of doing it.  
> 
> The doctest framework has already an overall speed factor of the machine, collected from previous runs. It is used for the "slow doctest" warning. At the very least this shoud be taken into account. For failed tests it should also display the actual time taken, not just crash in an AlarmInterrupt.

Of course I did not check on raspberry pi. How should I test for speed regression then? The only framework available are doctests. The only purpose of #17895 was to speed up execution. There is nothing changed from an input/output point of view.



---

archive/issue_comments_396121.json:
```json
{
    "body": "Sure. The point that I'm trying to make is that, at least for now, you have to be *very* conservative with the upper time limit in a doctest.",
    "created_at": "2019-07-31T09:24:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-396121",
    "user": "https://github.com/vbraun"
}
```

Sure. The point that I'm trying to make is that, at least for now, you have to be *very* conservative with the upper time limit in a doctest.



---

archive/issue_comments_396122.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-07-31T09:27:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-396122",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_396123.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-07-31T09:27:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-396123",
    "user": "https://github.com/videlec"
}
```

New commits:



---

archive/issue_comments_396124.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-07-31T09:28:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-396124",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_396125.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-08-01T22:53:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-396125",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_396126.json:
```json
{
    "body": "Replying to [comment:3 vdelecroix]:\n> Replying to [comment:2 vbraun]:\n> > Did you try running it on a raspberry pi, for example? I understand why you would want to test for speed regressions, but this isn't a good way of doing it.  \n> > \n> > The doctest framework has already an overall speed factor of the machine, collected from previous runs. It is used for the \"slow doctest\" warning. At the very least this shoud be taken into account. For failed tests it should also display the actual time taken, not just crash in an AlarmInterrupt.\n> \n> Of course I did not check on raspberry pi.\n\nIt's not just problematic when testing on a raspberry pi. For example our (nixos) buildservers rebuild and retest sage regularly. Sometimes the build servers may be under heavy load. Then a test can take an excessive amount of time, but it should not fail (which would fail the whole sage package).\n\nPerformance regressions are hard to measure, although worthwhile. But they should be tested entirely separately from the functionality tests.",
    "created_at": "2019-08-02T13:40:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-396126",
    "user": "https://github.com/timokau"
}
```

Replying to [comment:3 vdelecroix]:
> Replying to [comment:2 vbraun]:
> > Did you try running it on a raspberry pi, for example? I understand why you would want to test for speed regressions, but this isn't a good way of doing it.  
> > 
> > The doctest framework has already an overall speed factor of the machine, collected from previous runs. It is used for the "slow doctest" warning. At the very least this shoud be taken into account. For failed tests it should also display the actual time taken, not just crash in an AlarmInterrupt.
> 
> Of course I did not check on raspberry pi.

It's not just problematic when testing on a raspberry pi. For example our (nixos) buildservers rebuild and retest sage regularly. Sometimes the build servers may be under heavy load. Then a test can take an excessive amount of time, but it should not fail (which would fail the whole sage package).

Performance regressions are hard to measure, although worthwhile. But they should be tested entirely separately from the functionality tests.



---

archive/issue_comments_396127.json:
```json
{
    "body": "So as a summary, I propose to remove the alarm completely. If I put my laptop in suspend in the middle of running the test suite and wake it up again an hour later, the test suite should still pass. If we want to keep performance tests in the main test suite, they should at least be behind an optional flag so they are disable-able.",
    "created_at": "2019-08-02T13:41:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-396127",
    "user": "https://github.com/timokau"
}
```

So as a summary, I propose to remove the alarm completely. If I put my laptop in suspend in the middle of running the test suite and wake it up again an hour later, the test suite should still pass. If we want to keep performance tests in the main test suite, they should at least be behind an optional flag so they are disable-able.



---

archive/issue_comments_396128.json:
```json
{
    "body": "Replying to [comment:9 gh-timokau]:\n> So as a summary, I propose to remove the alarm completely. If I put my laptop in suspend in the middle of running the test suite and wake it up again an hour later, the test suite should still pass. If we want to keep performance tests in the main test suite, they should at least be behind an optional flag so they are disable-able.\n\nCould you open a ticket? This is not the only test concerned. And this should be documented in the developer guide: `do not use alarm to test performance`.",
    "created_at": "2019-08-02T13:45:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-396128",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:9 gh-timokau]:
> So as a summary, I propose to remove the alarm completely. If I put my laptop in suspend in the middle of running the test suite and wake it up again an hour later, the test suite should still pass. If we want to keep performance tests in the main test suite, they should at least be behind an optional flag so they are disable-able.

Could you open a ticket? This is not the only test concerned. And this should be documented in the developer guide: `do not use alarm to test performance`.



---

archive/issue_comments_396129.json:
```json
{
    "body": "Hiding it behind a # optional - benchmark (or so) sounds like a good solution. If you make a ticket I'll review it ;-)",
    "created_at": "2019-08-02T14:20:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-396129",
    "user": "https://github.com/vbraun"
}
```

Hiding it behind a # optional - benchmark (or so) sounds like a good solution. If you make a ticket I'll review it ;-)



---

archive/issue_events_026006.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-08-03T23:51:45Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28059#event-26006"
}
```



---

archive/issue_comments_396130.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-08-03T23:51:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28059#issuecomment-396130",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
