# Issue 24937: conversion of I to fricas is wrong

Issue created by migration from https://trac.sagemath.org/ticket/25174

Original creator: mantepse

Original creation time: 2018-04-15 17:56:07

CC:  rws

Keywords: FriCAS

The imaginary unit (as a symbolic expression) in FriCAS is "%i", not "I":

```
sage: fricas(I)^2
 2
I
sage: fricas("%i")^2
- 1
```

However, I was unable to find out where to change that.


---

Comment by rws created at 2018-04-16 05:51:36

Fricas is accessed through an interface, see `sage/interfaces/fricas.py`. Converting a Sage object to an interface object is done by implementing a `_interface_` member function for the object. Note however that `I` is not a `Constant` object but a number field element (embedded in a symbolic expression, try `type(I.pyobject())`).


---

Comment by mantepse created at 2018-04-16 06:04:14

Should I do it similar to https://trac.sagemath.org/attachment/ticket/7557/trac_7557-maxima_complex_number_conversion.2.patch ?


---

Comment by rws created at 2018-04-16 07:46:41

I is not a complex number. This is just to show where to put it:

```
diff --git a/src/sage/rings/number_field/number_field_element.pyx b/src/sage/rings/number_field/number_field_element.pyx
index c9a6ef42bd..c4986630f1 100644
--- a/src/sage/rings/number_field/number_field_element.pyx
+++ b/src/sage/rings/number_field/number_field_element.pyx
@@ -730,6 +730,11 @@ cdef class NumberFieldElement(FieldElement):
         """
         return repr(self.__pari__(name=name))

+    def _interface_init_(self, I):
+        if repr(self) == 'I':
+            return "%i"
+        raise NotImplementedError
+
     def __getitem__(self, n):
         """
         Return the n-th coefficient of this number field element, written
```

It works but may not be the correct way to do it.


---

Comment by vdelecroix created at 2018-04-16 09:01:46

Indeed it is not

```
sage: K.<I> = NumberField(x^3 - 2)
```

And I assume that it should be `_fricas_init_` instead of `_interface_init_`.


---

Comment by vdelecroix created at 2018-04-16 12:58:29

Actually the conversion for maxima is implemented in `sage/rings/number_field/number_field_element_quadratic.pyx` as

```
    def _maxima_init_(self, I=None):
        """
        EXAMPLES::

            sage: K.<a> = QuadraticField(-1)
            sage: f = 1 + a
            sage: f._maxima_init_()
            '1+%i*1'
        """
        a = self.parent().gen()
        if a**2 == -1:
            x0, x1 = self
            return str(x0) + "+" + "%i*" + str(x1)
        else:
            NumberFieldElement_absolute._maxima_init_(self, I)
```

which is not bullet proof at all with respect to embedding

```
sage: K.<J> = QuadraticField(-1, embedding=CC(0,-1))
sage: J._maxima_init_()
'0+%i*1'
```



---

Comment by mantepse created at 2018-04-16 21:07:19

This is a first attempt, however, locally testing fails currently.
----
New commits:


---

Comment by git created at 2018-04-17 04:33:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2018-04-17 04:34:45

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2018-04-17 07:39:35

Since `_fricas_init_` is the *exact* same as `_maxima_init_` you should rather create a unique method for both of them (and add aliases).

As I mentioned in [comment:5] the test `a**2 == -1` is not enough. You should also consider the embedding. There is an attribute `standard_embedding` so that the test could become

```
if a**2 == -1 and a.standard_embedding:
    ...
```

You should also add a doctest for the case when the embedding is the non standard one.


---

Comment by vdelecroix created at 2018-04-17 07:39:35

Changing status from needs_review to needs_work.


---

Comment by mantepse created at 2018-04-17 08:01:27

Replying to [comment:11 vdelecroix]:
> Since `_fricas_init_` is the *exact* same as `_maxima_init_` you should rather create a unique method for both of them (and add aliases).

How do I implement the distinction `NumberFieldElement_absolute._fricas_init_(self, I)` vs. `NumberFieldElement_absolute._maxima_init_(self, I)`.  Some `super` magic?

> As I mentioned in [comment:5] the test `a**2 == -1` is not enough. You should also consider the embedding. There is an attribute `standard_embedding` so that the test could become
> {{{
> if a**2 == -1 and a.standard_embedding:
>     ...
> }}}

You mean `self.standard_embedding`. right?  Doing so, I get


```
sage: K.<J> = QuadraticField(-1, embedding=CC(0,-1))
sage: maxima(J)
...
TypeError: _maxima_init_() takes no arguments (1 given)
```


which is probably suboptimal.

> You should also add a doctest for the case when the embedding is the non standard one.

Could you please propose one?


---

Comment by vdelecroix created at 2018-04-17 08:07:30

Replying to [comment:12 mantepse]:
> Replying to [comment:11 vdelecroix]:
> > Since `_fricas_init_` is the *exact* same as `_maxima_init_` you should rather create a unique method for both of them (and add aliases).
> 
> How do I implement the distinction `NumberFieldElement_absolute._fricas_init_(self, I)` vs. `NumberFieldElement_absolute._maxima_init_(self, I)`.  Some `super` magic?

The super magic is called `alias`

```
class A:
    def f(self): return 3

    g = f
```


> > As I mentioned in [comment:5] the test `a**2 == -1` is not enough. You should also consider the embedding. There is an attribute `standard_embedding` so that the test could become
> > {{{
> > if a**2 == -1 and a.standard_embedding:
> >     ...
> > }}}
> 
> You mean `self.standard_embedding`. right?  Doing so, I get
> 
> {{{
> sage: K.<J> = QuadraticField(-1, embedding=CC(0,-1))
> sage: maxima(J)
> ...
> TypeError: _maxima_init_() takes no arguments (1 given)
> }}}
> 
> which is probably suboptimal.

Indeed, it should be a `ValueError` or `NotImplementedError`.

> > You should also add a doctest for the case when the embedding is the non standard one.
> 
> Could you please propose one?


```
sage: K.<J> = QuadraticField(-1, embedding=-QQbar.gen())
sage: maxima(J)
sage: fricas(J)
```



---

Comment by mantepse created at 2018-04-17 08:18:09

Replying to [comment:13 vdelecroix]:
> Replying to [comment:12 mantepse]:
> > Replying to [comment:11 vdelecroix]:
> > > Since `_fricas_init_` is the *exact* same as `_maxima_init_` you should rather create a unique method for both of them (and add aliases).
> > 
> > How do I implement the distinction `NumberFieldElement_absolute._fricas_init_(self, I)` vs. `NumberFieldElement_absolute._maxima_init_(self, I)`.  Some `super` magic?
> 
> The super magic is called `alias`
> {{{
> class A:
>     def f(self): return 3
> 
>     g = f
> }}}

I don't get it.  We have:


```
class A:
    def f(self): return superclass.f()
    def g(self): return superclass.g()
```


Is this really the same as 

```
class A:
    def f(self): return superclass.f()
    g = f
```

?


---

Comment by git created at 2018-04-17 19:14:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2018-04-17 19:15:07

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2018-04-18 07:06:41

The error message is not quite accurate. The discriminant is the first reason why the conversion might fail.

```
sage: K.<sqrt2> = QuadraticField(2, embedding=AA(2))
sage: maxima(sqrt2) # failing but not for a bad ebedding reason
```

Perhaps `"maxima/fricas conversions only implemented for quadratic field with discrimnant -1 and standard embedding"` (though a bit long).


---

Comment by git created at 2018-04-18 07:29:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2018-04-19 06:35:17

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-05-14 17:35:54

Resolution: fixed
