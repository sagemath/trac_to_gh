# Issue 22749: Refactor SBox code (move from crypto.mq to crypto)

Issue created by migration from https://trac.sagemath.org/ticket/22986

Original creator: asante

Original creation time: 2017-05-12 07:55:39




---

Comment by asante created at 2017-05-12 07:56:54

Set assignee to asante.


---

Comment by asante created at 2017-05-12 07:56:54

Changing keywords from "" to "sbox".


---

Comment by asante created at 2017-05-12 07:57:44

Changing keywords from "sbox" to "sbox, crypto".


---

Comment by asante created at 2017-05-12 07:57:44

Changing type from PLEASE CHANGE to enhancement.


---

Comment by asante created at 2017-05-12 07:57:44

Changing component from PLEASE CHANGE to cryptography.


---

Comment by asante created at 2017-05-12 09:16:26

Changing status from new to needs_review.


---

Comment by asante created at 2017-05-12 09:16:26

New commits:


---

Comment by malb created at 2017-05-29 12:26:41

Looks good, except for two caveats:
- This adds `SBox` to the global namespace. I'm not sure this will be widely appreciated so I'd ask on [sage-devel] if there are any objects. Apologies if I simply missed this having been done already.
- Why `import all` in `__init__.py`?


---

Comment by asante created at 2017-05-29 12:36:04

Regarding the `import all`: I was following this part of the docu [files-and-directory-structure](http://doc.sagemath.org/html/en/developer/coding_basics.html#files-and-directory-structure), in particular:

    If you want to create a new directory in the Sage library SAGE_ROOT/src/sage (say, measure_theory), that directory should contain a file __init__.py that contains the single line import all in addition to whatever files you want to add (say, borel_measure.py and banach_tarski.py), and also a file all.py listing imports from that directory that are important enough to be in the Sageâ€™s global namespace at startup. The file all.py might look like this:

But as the docu also says something about `lazy_import`, which is not used here, I'm confused, whats the correct way to do here.


---

Comment by malb created at 2017-05-30 12:07:23

Makes sense, thanks


---

Comment by dimpase created at 2017-05-31 19:07:48

IMHO, it should not get into the global namespace.

perhaps for all crypto things a `crypto` catalog should be itroduced, and this can go there then.

I also would suggest that it is lazy_import'ed, too.


---

Comment by git created at 2017-05-31 22:10:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-06-08 05:09:00

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2017-06-08 05:09:00

Needs a rebase on the latest `develop`.


---

Comment by git created at 2017-06-08 06:25:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by asante created at 2017-06-08 06:33:12

Merged `develop` branch


---

Comment by asante created at 2017-06-08 06:33:12

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-06-08 08:43:34

In general, we do not do imports in `__init__.py`; mostly they are blank files that are Python boilerplate (at least with how we use them). I believe this has no effect.

Although AFAIK, your changes do not make anything worse for the global namespace, but having the lazy imports are good for startup time. You can do multiple imports by, e.g.,

```
lazy_import('sage.crypto.classical', ['AffineCryptosystem', 'HillCryptosystem'])
```

Once that is changed (as I think it is cleaner code), then I am willing to set a positive review.


---

Comment by git created at 2017-06-08 09:13:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by asante created at 2017-06-08 09:16:02

tscrim: I changed the imports accordingly.
Regarding the `__init__.py`, this means there should also be no `import all`? IDK how this global namespace is generated and if this import is necessary for this. If you vote for removing the crypto stuff from the global namespace or this is not needed for this, I can also remove these imports.


---

Comment by jdemeyer created at 2017-06-08 11:33:29

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-06-08 11:33:29

Just commenting on this aspect: the `import all` in `__init__.py` should not be needed. I consider it a regression.


---

Comment by git created at 2017-06-08 11:36:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by asante created at 2017-06-08 11:38:35

Removed `import all` from all `__init__.py`'s


---

Comment by asante created at 2017-06-08 11:38:35

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-06-08 12:47:36

I would say removing things from the global namespace is a more serious issue that deserves its own ticket as you have to deal with deprecations and creating the catalog (or whatever approach we end up doing, but a catalog seems natural to me). So now that you've taken care of the `__init__`, positive review.


---

Comment by tscrim created at 2017-06-08 12:47:36

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-06-09 22:05:09

Tests fail


---

Comment by vbraun created at 2017-06-09 22:05:09

Changing status from positive_review to needs_work.


---

Comment by git created at 2017-06-11 23:01:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by asante created at 2017-06-11 23:04:20

Changing status from needs_work to needs_review.


---

Comment by asante created at 2017-06-11 23:04:20

The SBox related tests now work -- sorry for not checking them :/

There are still errors:


```
----------------------------------------------------------------------
sage -t --warn-long 58.4 src/sage/repl/interpreter.py  # 3 doctests failed
sage -t --warn-long 58.4 src/sage/repl/ipython_tests.py  # 4 doctests failed
sage -t --warn-long 58.4 src/sage/repl/interface_magic.py  # 3 doctests failed
----------------------------------------------------------------------
```

but I think these are not due to my changes to the SBox module..
Is this correct?


---

Comment by tscrim created at 2017-06-14 12:23:58

Changing status from needs_review to needs_work.


---

Comment by tscrim created at 2017-06-14 12:23:58

I've seen these pop up elsewhere. <edit>"These" being the doctest failures in comment:22.</edit>

Last two things. Stupid thing first:

```diff
@@ -1485,7 +1531,9 @@ class SBox(SageObject):
 
         EXAMPLES::
 
-            sage: S = mq.SBox([x**254 for x in sorted(GF(2**8))])
+            sage: from sage.crypto.sbox import SBox
+            sage: from sage.crypto.sbox import SBox
+            sage: S = SBox([x**254 for x in sorted(GF(2**8))])
             sage: S.is_involution()
             True
         """
```

Second thing is that you should deprecate `mq.SBox`, where you tell people to explicitly import `SBox`. Sorry I didn't catch this before!


---

Comment by dimpase created at 2017-06-14 12:43:38

surely you do not need 2 lines like this in the previous comment, 1 is enough.

```
+            sage: from sage.crypto.sbox import SBox
+            sage: from sage.crypto.sbox import SBox
```



---

Comment by git created at 2017-06-14 12:48:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by asante created at 2017-06-14 12:50:29

I removed the duplicate line in the doc string. `@`dimpase are you refering to the same line as Travis?

For the deprecation, I added `deprecated_function_alias` in `sage.crypto.mq.sbox`, which should be the correct way?


---

Comment by asante created at 2017-06-14 12:50:29

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-06-14 12:55:42

Replying to [comment:26 asante]:
> For the deprecation, I added `deprecated_function_alias` in `sage.crypto.mq.sbox`, which should be the correct way?

Not quite. There's actually a deprecation mechanism in `lazy_import`. See, e.g., `misc/arith.py` or `rings/all.py`.


---

Comment by git created at 2017-06-14 13:08:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by asante created at 2017-06-14 13:10:00

Replying to [comment:27 tscrim]:
> Not quite. There's actually a deprecation mechanism in `lazy_import`. See, e.g., `misc/arith.py` or `rings/all.py`.

Thanks for the pointer, I adjusted the deprecation.


---

Comment by tscrim created at 2017-06-14 16:59:14

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-06-14 16:59:14

I am pretty sure Dima's comment was an expansion of my comment. Everything else seems to be in order. Positive review.


---

Comment by vbraun created at 2017-06-15 16:45:35

Resolution: fixed
