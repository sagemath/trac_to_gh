# Issue 19067: Fix hash function of rationals

archive/issues_019067.json:
```json
{
    "body": "CC:  @nathanncohen\n\n\n```\nsage: 1 == hash(2/3) == hash(3/2) == hash(5/4) == hash(4/5) == hash(9/8) == hash(8/9)\nTrue\n```\n\nThe hash function of rationals is only a xor between numerator and denominator. As shown above this is too naive to avoid collisions!\n\nIssue created by migration from https://trac.sagemath.org/ticket/19304\n\n",
    "created_at": "2015-09-28T22:22:12Z",
    "labels": [
        "misc",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.10",
    "title": "Fix hash function of rationals",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19067",
    "user": "@videlec"
}
```
CC:  @nathanncohen


```
sage: 1 == hash(2/3) == hash(3/2) == hash(5/4) == hash(4/5) == hash(9/8) == hash(8/9)
True
```

The hash function of rationals is only a xor between numerator and denominator. As shown above this is too naive to avoid collisions!

Issue created by migration from https://trac.sagemath.org/ticket/19304





---

archive/issue_comments_261602.json:
```json
{
    "body": "Changing type from defect to enhancement.",
    "created_at": "2015-09-29T06:16:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19067#issuecomment-261602",
    "user": "@jdemeyer"
}
```

Changing type from defect to enhancement.



---

archive/issue_comments_261603.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-09-29T10:22:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19067#issuecomment-261603",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_261604.json:
```json
{
    "body": "Why is that in `matrix_cyclo_dense`\n\n```\n+            sage: hash(A)  # random\n                                 ^\n                                 |\n --------------------------------+\n```\n\nHow can it be random??",
    "created_at": "2015-09-29T11:27:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19067#issuecomment-261604",
    "user": "@videlec"
}
```

Why is that in `matrix_cyclo_dense`

```
+            sage: hash(A)  # random
                                 ^
                                 |
 --------------------------------+
```

How can it be random??



---

archive/issue_comments_261605.json:
```json
{
    "body": "probably a trick for 32bits/64bits.\n\n\"# random\" reads \"random\", but it has the same effect as \"# ignore_output_but_check_that_no_exception_is_raised\".\n\nNathann",
    "created_at": "2015-09-29T11:30:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19067#issuecomment-261605",
    "user": "@nathanncohen"
}
```

probably a trick for 32bits/64bits.

"# random" reads "random", but it has the same effect as "# ignore_output_but_check_that_no_exception_is_raised".

Nathann



---

archive/issue_comments_261606.json:
```json
{
    "body": "Replying to [comment:4 vdelecroix]:\n> How can it be random??\n\nLike Nathann said, it's different on 32-bit and 64-bit. Since the doctest is really about (im)mutability, the actual hash value doesn't matter, so I used `# random`.",
    "created_at": "2015-09-29T14:44:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19067#issuecomment-261606",
    "user": "@jdemeyer"
}
```

Replying to [comment:4 vdelecroix]:
> How can it be random??

Like Nathann said, it's different on 32-bit and 64-bit. Since the doctest is really about (im)mutability, the actual hash value doesn't matter, so I used `# random`.



---

archive/issue_comments_261607.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-09-29T14:48:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19067#issuecomment-261607",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_261608.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-09-29T14:55:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19067#issuecomment-261608",
    "user": "@jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_261609.json:
```json
{
    "body": "This now passes doctests on 32-bit and 64-bit.",
    "created_at": "2015-09-29T14:55:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19067#issuecomment-261609",
    "user": "@jdemeyer"
}
```

This now passes doctests on 32-bit and 64-bit.



---

archive/issue_comments_261610.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-09-30T01:52:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19067#issuecomment-261610",
    "user": "@videlec"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_261611.json:
```json
{
    "body": "There are fractions in Python3, shouldn't we try to be complient with it?\n\n```\n>>> import fractions\n>>> fractions.Fraction(2,3)\nFraction(2, 3)\n>>>  hash(fractions.Fraction(2,3))\n768614336404564651\n```\n\nThe code is actually pure python and takes care of exactly representable float... and Python seems to have a different politics than Sage to that respect.\n\n```\n    def __hash__(self):\n        \"\"\"hash(self)\n\n        Tricky because values that are exactly representable as a\n        float must have the same hash as that float.\n\n        \"\"\"\n        # XXX since this method is expensive, consider caching the result\n        if self._denominator == 1:\n            # Get integers right.\n            return hash(self._numerator)\n        # Expensive check, but definitely correct.\n        if self == float(self):\n            return hash(float(self))\n        else:\n            # Use tuple's hash to avoid a high collision rate on\n            # simple fractions.\n            return hash((self._numerator, self._denominator))\n```\n",
    "created_at": "2015-09-30T01:52:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19067#issuecomment-261611",
    "user": "@videlec"
}
```

There are fractions in Python3, shouldn't we try to be complient with it?

```
>>> import fractions
>>> fractions.Fraction(2,3)
Fraction(2, 3)
>>>  hash(fractions.Fraction(2,3))
768614336404564651
```

The code is actually pure python and takes care of exactly representable float... and Python seems to have a different politics than Sage to that respect.

```
    def __hash__(self):
        """hash(self)

        Tricky because values that are exactly representable as a
        float must have the same hash as that float.

        """
        # XXX since this method is expensive, consider caching the result
        if self._denominator == 1:
            # Get integers right.
            return hash(self._numerator)
        # Expensive check, but definitely correct.
        if self == float(self):
            return hash(float(self))
        else:
            # Use tuple's hash to avoid a high collision rate on
            # simple fractions.
            return hash((self._numerator, self._denominator))
```




---

archive/issue_comments_261612.json:
```json
{
    "body": "Replying to [comment:9 vdelecroix]:\n> There are fractions in Python3, shouldn't we try to be complient with it?\nAlso Python 2 by the way. Not sure if it's important that Sage is compatible with that. It's easy to do that, but also more expensive.",
    "created_at": "2015-09-30T06:46:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19067#issuecomment-261612",
    "user": "@jdemeyer"
}
```

Replying to [comment:9 vdelecroix]:
> There are fractions in Python3, shouldn't we try to be complient with it?
Also Python 2 by the way. Not sure if it's important that Sage is compatible with that. It's easy to do that, but also more expensive.



---

archive/issue_comments_261613.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-10-17T21:09:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19067#issuecomment-261613",
    "user": "@jdemeyer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_261614.json:
```json
{
    "body": "One failing doctest... got\n\n```\nsage: beta(1/2, 3*x)\nbeta(3*x, 1/2)\n```\n\non 64-bit too. Why is this related to this ticket?\n\nVincent",
    "created_at": "2015-10-20T00:44:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19067#issuecomment-261614",
    "user": "@videlec"
}
```

One failing doctest... got

```
sage: beta(1/2, 3*x)
beta(3*x, 1/2)
```

on 64-bit too. Why is this related to this ticket?

Vincent



---

archive/issue_comments_261615.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-04T14:38:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19067#issuecomment-261615",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_261616.json:
```json
{
    "body": "Replying to [comment:12 vdelecroix]:\n> One failing doctest... got\n> {{{\n> sage: beta(1/2, 3*x)\n> beta(3*x, 1/2)\n> }}}\n> on 64-bit too. Why is this related to this ticket?\n\nGinac reorders the arguments to `beta()` according to their hash. Symbolic expressions (like `3*x`) have a \"random\" hash: it is different in different runs of Sage. I'll change the doctest to something which does not involve random hashes.",
    "created_at": "2015-11-04T14:52:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19067#issuecomment-261616",
    "user": "@jdemeyer"
}
```

Replying to [comment:12 vdelecroix]:
> One failing doctest... got
> {{{
> sage: beta(1/2, 3*x)
> beta(3*x, 1/2)
> }}}
> on 64-bit too. Why is this related to this ticket?

Ginac reorders the arguments to `beta()` according to their hash. Symbolic expressions (like `3*x`) have a "random" hash: it is different in different runs of Sage. I'll change the doctest to something which does not involve random hashes.



---

archive/issue_comments_261617.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-11-04T15:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19067#issuecomment-261617",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_261618.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-11-10T01:58:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19067#issuecomment-261618",
    "user": "@videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_261619.json:
```json
{
    "body": "Thanks!",
    "created_at": "2015-11-10T02:14:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19067#issuecomment-261619",
    "user": "@jdemeyer"
}
```

Thanks!



---

archive/issue_comments_261620.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-11-10T14:00:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19067",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19067#issuecomment-261620",
    "user": "@vbraun"
}
```

Resolution: fixed
