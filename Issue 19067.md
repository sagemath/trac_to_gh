# Issue 19067: Fix hash function of rationals

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2015-09-28 22:22:12

CC:  ncohen


```
sage: 1 == hash(2/3) == hash(3/2) == hash(5/4) == hash(4/5) == hash(9/8) == hash(8/9)
True
```

The hash function of rationals is only a xor between numerator and denominator. As shown above this is too naive to avoid collisions!


---

Comment by jdemeyer created at 2015-09-29 06:16:43

Changing type from defect to enhancement.


---

Comment by git created at 2015-09-29 10:22:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-09-29 11:27:08

Why is that in `matrix_cyclo_dense`

```
+            sage: hash(A)  # random
                                 ^
                                 |
 --------------------------------+
```

How can it be random??


---

Comment by ncohen created at 2015-09-29 11:30:08

probably a trick for 32bits/64bits.

"# random" reads "random", but it has the same effect as "# ignore_output_but_check_that_no_exception_is_raised".

Nathann


---

Comment by jdemeyer created at 2015-09-29 14:44:03

Replying to [comment:4 vdelecroix]:
> How can it be random??

Like Nathann said, it's different on 32-bit and 64-bit. Since the doctest is really about (im)mutability, the actual hash value doesn't matter, so I used `# random`.


---

Comment by git created at 2015-09-29 14:48:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-09-29 14:55:22

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-09-29 14:55:22

This now passes doctests on 32-bit and 64-bit.


---

Comment by vdelecroix created at 2015-09-30 01:52:21

Changing status from needs_review to needs_info.


---

Comment by vdelecroix created at 2015-09-30 01:52:21

There are fractions in Python3, shouldn't we try to be complient with it?

```
>>> import fractions
>>> fractions.Fraction(2,3)
Fraction(2, 3)
>>>  hash(fractions.Fraction(2,3))
768614336404564651
```

The code is actually pure python and takes care of exactly representable float... and Python seems to have a different politics than Sage to that respect.

```
    def __hash__(self):
        """hash(self)

        Tricky because values that are exactly representable as a
        float must have the same hash as that float.

        """
        # XXX since this method is expensive, consider caching the result
        if self._denominator == 1:
            # Get integers right.
            return hash(self._numerator)
        # Expensive check, but definitely correct.
        if self == float(self):
            return hash(float(self))
        else:
            # Use tuple's hash to avoid a high collision rate on
            # simple fractions.
            return hash((self._numerator, self._denominator))
```



---

Comment by jdemeyer created at 2015-09-30 06:46:51

Replying to [comment:9 vdelecroix]:
> There are fractions in Python3, shouldn't we try to be complient with it?
Also Python 2 by the way. Not sure if it's important that Sage is compatible with that. It's easy to do that, but also more expensive.


---

Comment by jdemeyer created at 2015-10-17 21:09:52

Changing status from needs_info to needs_review.


---

Comment by vdelecroix created at 2015-10-20 00:44:09

One failing doctest... got

```
sage: beta(1/2, 3*x)
beta(3*x, 1/2)
```

on 64-bit too. Why is this related to this ticket?

Vincent


---

Comment by git created at 2015-11-04 14:38:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-11-04 14:52:29

Replying to [comment:12 vdelecroix]:
> One failing doctest... got
> {{{
> sage: beta(1/2, 3*x)
> beta(3*x, 1/2)
> }}}
> on 64-bit too. Why is this related to this ticket?

Ginac reorders the arguments to `beta()` according to their hash. Symbolic expressions (like `3*x`) have a "random" hash: it is different in different runs of Sage. I'll change the doctest to something which does not involve random hashes.


---

Comment by git created at 2015-11-04 15:00:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-11-10 01:58:51

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2015-11-10 02:14:14

Thanks!


---

Comment by vbraun created at 2015-11-10 14:00:31

Resolution: fixed
