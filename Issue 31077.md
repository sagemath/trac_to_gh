# Issue 31077: Failing sage_setup doctests when PYTHONPYCACHEPREFIX is set

Issue created by migration from https://trac.sagemath.org/ticket/31314

Original creator: mkoeppe

Original creation time: 2021-02-01 01:26:42

CC:  jhpalmieri @tobiasdiez

(from #31227)

https://docs.python.org/3/using/cmdline.html#envvar-PYTHONPYCACHEPREFIX


---

Comment by jhpalmieri created at 2021-02-01 02:18:34

See also https://docs.python.org/3/library/sys.html#sys.pycache_prefix: `sys.pycache_prefix` seems to be set for `/usr/bin/python3` on OS X.


---

Comment by mkoeppe created at 2021-02-01 02:30:45

I think this is basically just the sorting order that's changed


---

Comment by jhpalmieri created at 2021-02-01 02:35:08

What about the stale files?
----
New commits:


---

Comment by mkoeppe created at 2021-02-01 02:36:20

(untested)


---

Comment by mkoeppe created at 2021-02-01 02:38:31

`sage_setup.clean._find_stale_files` will need a closer look. Related: #28925


---

Comment by jhpalmieri created at 2021-02-01 18:24:34

In my situation, the basenames are `'__init__.cpython-38.pyc'` and `'__init__.py'`. Will the first of these sometimes instead be `'__init__.pyc'`? This is ugly but I think it works:

```diff
diff --git a/src/sage_setup/find.py b/src/sage_setup/find.py
index 413f062e07..4a87f142c3 100644
--- a/src/sage_setup/find.py
+++ b/src/sage_setup/find.py
@@ -274,8 +274,8 @@ def installed_files_by_module(site_packages, modules=('sage',)):
         sage: from sage.misc.sageinspect import loadable_module_extension
         sage: (f,) = files_by_module['sage.structure.sage_object']; f
         'sage/structure/sage_object...'
-        sage: from os.path import basename
-        sage: (f1, f2) = sorted(files_by_module['sage.structure'], key=basename)
+        sage: f1 = [f for f in files_by_module['sage.structure'] if f.endswith('.py')][0]
+        sage: f2 = [f for f in files_by_module['sage.structure'] if f.endswith('.pyc')][0]
         sage: f1
         'sage/structure/__init__.py'
         sage: f2
```



---

Comment by jhpalmieri created at 2021-02-01 18:31:09

Maybe it always includes `cpython`, so keep the sorting but interchange `f1` and `f2`.


---

Comment by mkoeppe created at 2021-02-01 23:10:28

Changing priority from minor to major.


---

Comment by mkoeppe created at 2021-02-02 20:19:49

Changing priority from major to critical.


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.
