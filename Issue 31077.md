# Issue 31077: Failing sage_setup doctests when PYTHONPYCACHEPREFIX is set

archive/issues_031077.json:
```json
{
    "body": "CC:  @jhpalmieri @tobiasdiez\n\n(from #31227)\n\nhttps://docs.python.org/3/using/cmdline.html#envvar-PYTHONPYCACHEPREFIX\n\nIssue created by migration from https://trac.sagemath.org/ticket/31314\n\n",
    "created_at": "2021-02-01T01:26:42Z",
    "labels": [
        "component: build",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Failing sage_setup doctests when PYTHONPYCACHEPREFIX is set",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31077",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @jhpalmieri @tobiasdiez

(from #31227)

https://docs.python.org/3/using/cmdline.html#envvar-PYTHONPYCACHEPREFIX

Issue created by migration from https://trac.sagemath.org/ticket/31314





---

archive/issue_comments_443376.json:
```json
{
    "body": "See also https://docs.python.org/3/library/sys.html#sys.pycache_prefix: `sys.pycache_prefix` seems to be set for `/usr/bin/python3` on OS X.",
    "created_at": "2021-02-01T02:18:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-443376",
    "user": "https://github.com/jhpalmieri"
}
```

See also https://docs.python.org/3/library/sys.html#sys.pycache_prefix: `sys.pycache_prefix` seems to be set for `/usr/bin/python3` on OS X.



---

archive/issue_comments_443377.json:
```json
{
    "body": "I think this is basically just the sorting order that's changed",
    "created_at": "2021-02-01T02:30:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-443377",
    "user": "https://github.com/mkoeppe"
}
```

I think this is basically just the sorting order that's changed



---

archive/issue_comments_443378.json:
```json
{
    "body": "What about the stale files?\n----\nNew commits:",
    "created_at": "2021-02-01T02:35:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-443378",
    "user": "https://github.com/jhpalmieri"
}
```

What about the stale files?
----
New commits:



---

archive/issue_comments_443379.json:
```json
{
    "body": "(untested)",
    "created_at": "2021-02-01T02:36:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-443379",
    "user": "https://github.com/mkoeppe"
}
```

(untested)



---

archive/issue_comments_443380.json:
```json
{
    "body": "`sage_setup.clean._find_stale_files` will need a closer look. Related: #28925",
    "created_at": "2021-02-01T02:38:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-443380",
    "user": "https://github.com/mkoeppe"
}
```

`sage_setup.clean._find_stale_files` will need a closer look. Related: #28925



---

archive/issue_comments_443381.json:
```json
{
    "body": "In my situation, the basenames are `'__init__.cpython-38.pyc'` and `'__init__.py'`. Will the first of these sometimes instead be `'__init__.pyc'`? This is ugly but I think it works:\n\n```diff\ndiff --git a/src/sage_setup/find.py b/src/sage_setup/find.py\nindex 413f062e07..4a87f142c3 100644\n--- a/src/sage_setup/find.py\n+++ b/src/sage_setup/find.py\n@@ -274,8 +274,8 @@ def installed_files_by_module(site_packages, modules=('sage',)):\n         sage: from sage.misc.sageinspect import loadable_module_extension\n         sage: (f,) = files_by_module['sage.structure.sage_object']; f\n         'sage/structure/sage_object...'\n-        sage: from os.path import basename\n-        sage: (f1, f2) = sorted(files_by_module['sage.structure'], key=basename)\n+        sage: f1 = [f for f in files_by_module['sage.structure'] if f.endswith('.py')][0]\n+        sage: f2 = [f for f in files_by_module['sage.structure'] if f.endswith('.pyc')][0]\n         sage: f1\n         'sage/structure/__init__.py'\n         sage: f2\n```\n",
    "created_at": "2021-02-01T18:24:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-443381",
    "user": "https://github.com/jhpalmieri"
}
```

In my situation, the basenames are `'__init__.cpython-38.pyc'` and `'__init__.py'`. Will the first of these sometimes instead be `'__init__.pyc'`? This is ugly but I think it works:

```diff
diff --git a/src/sage_setup/find.py b/src/sage_setup/find.py
index 413f062e07..4a87f142c3 100644
--- a/src/sage_setup/find.py
+++ b/src/sage_setup/find.py
@@ -274,8 +274,8 @@ def installed_files_by_module(site_packages, modules=('sage',)):
         sage: from sage.misc.sageinspect import loadable_module_extension
         sage: (f,) = files_by_module['sage.structure.sage_object']; f
         'sage/structure/sage_object...'
-        sage: from os.path import basename
-        sage: (f1, f2) = sorted(files_by_module['sage.structure'], key=basename)
+        sage: f1 = [f for f in files_by_module['sage.structure'] if f.endswith('.py')][0]
+        sage: f2 = [f for f in files_by_module['sage.structure'] if f.endswith('.pyc')][0]
         sage: f1
         'sage/structure/__init__.py'
         sage: f2
```




---

archive/issue_comments_443382.json:
```json
{
    "body": "Maybe it always includes `cpython`, so keep the sorting but interchange `f1` and `f2`.",
    "created_at": "2021-02-01T18:31:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-443382",
    "user": "https://github.com/jhpalmieri"
}
```

Maybe it always includes `cpython`, so keep the sorting but interchange `f1` and `f2`.



---

archive/issue_comments_443383.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-02-02T20:19:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-443383",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_443384.json:
```json
{
    "body": "Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-24T02:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31077",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31077#issuecomment-443384",
    "user": "https://github.com/mkoeppe"
}
```

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.
