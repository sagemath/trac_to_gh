# Issue 14168: Make ccache a standard spkg

Issue created by migration from https://trac.sagemath.org/ticket/14372

Original creator: robertwb

Original creation time: 2013-03-28 00:52:31

Assignee: tbd

CC:  roed kini jdemeyer ppurka ohanar vdelecroix

It's been optional long enough and will be especially handy when using git.


---

Comment by jdemeyer created at 2013-03-28 01:14:36

Why is this especially handy when using git?

I hope that ccache will not be enabled by default, because you don't want to force 4GB of additional data in the user's home directory. And if it's not enabled by default, why should the package be standard?

Note that I'm not against it being standard, it could be like GCC: shipped but not built by default.


---

Comment by roed created at 2013-03-28 02:19:46

One option I just discussed with Robert is to by default only turn on ccache for files in the Sage library.  This could drop the space requirement substantially.


---

Comment by leif created at 2013-03-28 02:27:32

Being optional for a while doesn't imply it should get standard;  there are many packages that are optional since quite a while, and you certainly won't want to include all of them.

IMHO we already have too many "standard" packages, some are only built on a few platforms, or under certain circumstances, some only useful to (or necessary for) a few people.


---

Comment by roed created at 2013-03-28 02:35:57

Replying to [comment:3 leif]:
> Being optional for a while doesn't imply it should get standard;  there are many packages that are optional since quite a while, and you certainly won't want to include all of them.
> 
> IMHO we already have too many "standard" packages, some are only built on a few platforms, or under certain circumstances, some only useful to (or necessary for) a few people.

I don't think Robert was claiming that ccache should become standard _because_ it has been optional for a while, but rather that it has been optional for long enough to satisfy that requirement for becoming a standard package.

We do have a bunch of standard packages, but I agree with Robert that ccache would be useful for almost every Sage developer (which is more than can be said of some of our current standard spkgs).


---

Comment by leif created at 2013-03-28 02:50:10

Well, it perfectly fits an _optional_ package -- it doesn't require any specific support by the Sage library, just like gdb, autotools, valgrind, also GCC, or whatever, which are mostly there for convenience, but not needed by most Sage users.

Shipping (and reinstalling) it with each and every Sage release doesn't make sense to me;  <flame> any serious developer would have it installed [system-wide] anyway if it's of use to him/her </flame>.

Don't make the horse an elephant, otherwise it'll really lose its ability to fly.


---

Comment by jdemeyer created at 2013-03-28 07:01:11

I essentially agree with leif here: it's a package which is essentially only useful for Sage _developers_, so why should we always use it?


---

Comment by kini created at 2013-03-28 07:04:10

If we switch to Portage Prefix as our build system, maybe we can have `sci-mathematics/sage-9999[dev]` (or whatever) depend on ccache and other versions of `sci-mathematics/sage` not need to. Developers would build a make target that unmasked `sci-mathematics/sage-9999` before building, say, whereas for users it would remain masked and stuff like the dev scripts and ccache would not be installed.

But of course that's not really relevant to this ticket.


---

Comment by kini created at 2013-03-28 07:22:07

CCing a couple people I thought might be interested.


---

Comment by ppurka created at 2013-03-28 12:47:57

I agree with the opinion that ccache shouldn't be a standard package. It is required only for developers, and maybe some developers will _not_ want this to be default because of the 4G of storage it demands by default.

For those who are interested, it can be installed quite easily by setting the environment variable SAGE_INSTALL_CCACHE='yes'. This variable can be added to the `<SHELL>rc` since it doesn't clash with anything else, so that in every new sage installation or (re-)compilation ccache is used.


---

Comment by kcrisman created at 2013-03-28 13:57:29

> I agree with the opinion that ccache shouldn't be a standard package. It is required only for developers, and maybe some developers will _not_ want this to be default because of the 4G of storage it demands by default.
It seems like this indeed falls in the same category as the packages Leif mentioned.  We include everything needed to build but no more on the devel side.  Maybe if we do move to a more "modular" packaging system we could in fact _remove_ standard spkgs...

That said, I don't know anything about ccache, and perhaps neither does the sage-combinat crew (?) so apparently not _all_ developers need it.  But by the same token, maybe there is some compelling reason, and it sounds like it doesn't _have_ to triple the size of a Sage installation.    What about Jeroen's idea to not build it by default - 185 KB is a fairly large addition, but it's not like we haven't bloated things before :)


---

Comment by vbraun created at 2013-03-28 15:10:59

-1 from me, too. If you are a serious developer then you hopefully use a distro that ships a working gcc+ccache by default.


---

Comment by ohanar created at 2013-03-28 15:34:16

Replying to [comment:11 vbraun]:
> -1 from me, too. If you are a serious developer then you hopefully use a distro that ships a working gcc+ccache by default. 
Not every serious developer uses linux (and Sage is incompatible with macports, etc on OSX).

That said, I don't have a strong opinion on the matter.


---

Comment by leif created at 2013-03-28 16:18:59

Replying to [comment:12 ohanar]:
> Replying to [comment:11 vbraun]:
> > -1 from me, too. If you are a serious developer then you hopefully use a distro that ships a working gcc+ccache by default. 
> Not every serious developer uses linux (and Sage is incompatible with macports, etc on OSX).

Is there a section in the Sage Developer's Guide on how to setup a good Sage development environment on $OS / recommended packages, short introduction on how to setup / use $TOOL?


---

Comment by kcrisman created at 2013-03-28 18:04:05

Replying to [comment:12 ohanar]:
> Replying to [comment:11 vbraun]:
> > -1 from me, too. If you are a serious developer then you hopefully use a distro that ships a working gcc+ccache by default. 
> Not every serious developer uses linux (and Sage is incompatible with macports, etc on OSX).

So... what is this ccache thing?  If it's automatic and makes `sage -b` faster, should I just use this optional spkg?  I guess I agree that one potential resolution to this ticket would be to tell people to use it.


---

Comment by jdemeyer created at 2013-03-28 18:16:52

Replying to [comment:14 kcrisman]:
> So... what is this ccache thing?
A compiler cache. It essentially caches the output of `gcc`.

> If it's automatic and makes `sage -b` faster
That's what it does indeed (in fact, it makes building all C/C++ code in Sage faster, not just `./sage -b`)

> should I just use this optional spkg?
If you don't mind losing 4GB of disk space, yes you should.


---

Comment by kini created at 2013-03-28 18:21:23

It's automatic and makes `sage -b` faster, but it requires a lot of disk space (a few gigabytes), and the effect of making `sage -b` faster is most visible if you used ccache during your initial build of sage from the source tarball, I think.


---

Comment by kcrisman created at 2013-03-28 18:29:19

Yeah, I would say that one mention in the midst of [the env vars list](http://www.sagemath.org/doc/installation/source.html#environment-variables) in the _installation_ (not developer) guide wouldn't be sufficient information to alert people to it.  You shouldn't expect a new (mathematically-oriented) developer to be aware of this, per se.


---

Comment by jdemeyer created at 2013-03-28 19:05:10

Replying to [comment:16 kini]:
> the effect of making sage-b faster is most visible if you used ccache during your initial build of sage from the source tarball, I think.
Sure, since it's a cache, it can only speed up compilation starting from the _second_ time you build the same file.


---

Comment by ppurka created at 2014-04-15 10:49:44

Now that we have moved to git, what is the opinion on this?


---

Comment by jdemeyer created at 2014-04-15 11:42:16

We do have the `SAGE_INSTALL_CCACHE` variable now and I personally think that is a perfect solution.


---

Comment by ppurka created at 2014-04-15 13:05:51

Changing status from new to needs_review.


---

Comment by ppurka created at 2014-04-15 13:05:59

Changing status from needs_review to positive_review.


---

Comment by leif created at 2014-04-15 13:44:26

So we have to open another ticket to prominently advertise it (in the Sage _Developer's_ Guide)? ;-)


---

Comment by kcrisman created at 2014-04-15 19:10:02

Changing status from positive_review to needs_info.


---

Comment by kcrisman created at 2014-04-15 19:10:02

> So we have to open another ticket to prominently advertise it (in the Sage _Developer's_ Guide)? ;-)
Or repurpose this one for that, which seems fine to me.  I do agree that 4 GB is nothing to sneeze at, and will reiterate comment:17.


---

Comment by leif created at 2014-04-15 19:17:02

Replying to [comment:26 kcrisman]:
> > So we have to open another ticket to prominently advertise it (in the Sage _Developer's_ Guide)? ;-)
> Or repurpose this one for that, which seems fine to me.  I do agree that 4 GB is nothing to sneeze at, and will reiterate comment:17.

I don't think the necessary additions to the Developer's Guide will get _that_ large.


---

Comment by kcrisman created at 2014-04-15 19:43:30

> > > So we have to open another ticket to prominently advertise it (in the Sage _Developer's_ Guide)? ;-)
> > Or repurpose this one for that, which seems fine to me.  I do agree that 4 GB is nothing to sneeze at, and will reiterate comment:17.
> 
> I don't think the necessary additions to the Developer's Guide will get _that_ large.
LOL


---

Comment by vdelecroix created at 2014-04-24 15:47:19

Hi,

(ccing me)

I am against shipping ccache in Sage (following comment:11). On the other hand, if some OS fails to have it then why not doing the same as gcc? I have no strong opinion about this as I think that everybody should use a Unix/GNU distribution (with gcc+ccache available).

Nevertheless, it would be fantastic to document the usage of ccache
 - for compiling *only* sage source code
 - for compiling sage source code and third-party softwares
and I see two places where this might be important
 - the Developer guide
 - the README

I started using ccache today (thanks to Robert Bradshaw). The only thing I did is

```
 $ export PATH=PATH_TO_CCACHE:$PATH
 $ sage -b
```

Is that the right way to use it? (it seems so as my cache is much bigger now).

Tell me if I can help for something on that ticket.

Best
Vincent


---

Comment by vdelecroix created at 2014-04-24 15:52:07

Follow up on comment:29: is there a way of caching results of Cythonization?


---

Comment by rws created at 2014-04-25 07:33:25

Replying to [comment:18 jdemeyer]:
> Replying to [comment:16 kini]:
> > the effect of making sage-b faster is most visible if you used ccache during your initial build of sage from the source tarball, I think.
> Sure, since it's a cache, it can only speed up compilation starting from the _second_ time you build the same file.
I'm pretty sure even the first compilation is faster, because some files are used multiple times within an install.


---

Comment by robertwb created at 2014-04-27 03:43:28

Replying to [comment:30 vdelecroix]:
> Follow up on comment:29: is there a way of caching results of Cythonization?

Yes, see #16148. I think every developer should use it (4GB of hard drive space really isn't that much these days) and I think every user should be considered at least a potential developer (at least the ones who compile from source).


---

Comment by kcrisman created at 2014-05-29 17:37:10

> > Follow up on comment:29: is there a way of caching results of Cythonization?
> 
> Yes, see #16148. I think every developer should use it (4GB of hard drive space really isn't that much these days) and I think every user should be considered at least a potential developer (at least the ones who compile from source). 
Though I don't think it should be in binaries anyway.  On a small USB key and some other situations 4 GB is quite a bit.

That said, I still don't know how to use this properly!  Taking a chance that just using the env var in my .profile was enough...


---

Comment by nbruin created at 2014-05-29 19:21:13

Replying to [comment:33 kcrisman]:
> Though I don't think it should be in binaries anyway.  On a small USB key and some other situations 4 GB is quite a bit.
The 4GB is the default cache size. It would sit in the user homedir, and only gets filled if something is actually compiled (which would fail in a binary distribution, I think). So, shipping ccache with a binary would be useless, but it wouldn't particularly use 4GB anywhere either.


---

Comment by leif created at 2014-05-29 19:43:52

Replying to [comment:34 nbruin]:
> Replying to [comment:33 kcrisman]:
> > Though I don't think it should be in binaries anyway.  On a small USB key and some other situations 4 GB is quite a bit.
> The 4GB is the default cache size. It would sit in the user homedir

Which in many cases would be the wrong place.


> and only gets filled if something is actually compiled (which would fail in a binary distribution, I think).

While it only gets filled upon compilation, `sage -b` is sufficient, as is the installation of an optional spkg in many if not most cases.  The only difference of bdists is that they don't come with _upstream_ source code (i.e., spkgs, or tarballs in `upstream/`.)


> So, shipping ccache with a binary would be useless, but it wouldn't particularly use 4GB anywhere either.

See above.


---

Comment by jdemeyer created at 2014-11-13 14:06:56

Changing component from packages: standard to documentation.


---

Comment by kcrisman created at 2014-11-20 15:36:00

Getting back to the original _point_ of this ticket... 

Is [the information here](http://www.sagemath.org/doc/installation/source.html#section-envvar) sufficient?  It's true that the _developer_ guide does not have any information on it, which seems odd.


---

Comment by paulmasson created at 2016-11-15 01:12:20

Replying to [comment:38 kcrisman]:
> Getting back to the original _point_ of this ticket... 
> 
> Is [the information here](http://www.sagemath.org/doc/installation/source.html#section-envvar) sufficient?  It's true that the _developer_ guide does not have any information on it, which seems odd.
I added some information on `ccache` to the developer guide a couple months ago in #21500 without seeing this discussion. If that's the only point of this ticket, then it can be closed as duplicate.


---

Comment by paulmasson created at 2016-11-15 01:12:44

Changing status from needs_info to needs_review.


---

Comment by mkoeppe created at 2016-11-15 01:53:33

I agree, it can be closed as a dup.


---

Comment by mkoeppe created at 2016-11-15 01:53:33

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-01-21 18:03:11

Resolution: invalid
