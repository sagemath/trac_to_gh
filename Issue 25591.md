# Issue 25591: Move OptionalExtension to features

Issue created by migration from https://trac.sagemath.org/ticket/25828

Original creator: @timokau

Original creation time: 2018-07-11 15:54:33

CC:  jdemeyer arojas fbissey dimpase embray isuruf

The last remaining (after #25825) piece of code that uses `is_package_installed` is `OptionalExtension`. Since it only provides the `package` kwarg for convenience, I thought it would make sense to just move to `condition` and add feature checks to use in `module_list.py`.

I tried that with one module for which a feature test is already available (bliss). The issue is that currently `Feature` depends on `cachefunc` and `UniqueRepresentation`, both of which are only available *after* the cythonizing step. That means we can't use them in `module_list.py`.

I can think of two ways to solve this:

- somehow make `Feature` work without those dependencies. They are not really essential at build-time: we can live without caching. However I'm not sure how to make those optional without losing caching at runtime. Maybe it is possible to add some kind of pure-python stub that is used while the cythonized version isn't available yet?

- cythonize in two steps: first the core modules, then the optional ones

I don't really know enough about the build system to decide which option is better and how best to implement them. Probably I missed some better option.


---

Comment by @timokau created at 2018-07-11 15:54:50

Jeroen, according to `git log` you seem most experienced with what is going on in `setup.py` (second just to William Stein in number of commits). Do you have a opinion?


---

Comment by jdemeyer created at 2018-07-11 18:46:18

I don't know. There is no obvious "best" solution.


---

Comment by @timokau created at 2018-07-11 19:50:53

I think #2 (two steps) would probably be the cleaner solution. Creating and then deleting a stub during installation would be pretty hacky.

I tried implementing that but having basically no experience with distutils I'm confused. `ext_modules` is imported from `module_list` but then never used. Instead some magic `self.distribution.ext_modules` that appears out of nowhere is used.

Do you think #1 is feasible?


---

Comment by jdemeyer created at 2018-07-11 19:57:27

Replying to [comment:4 gh-timokau]:
> `ext_modules` is imported from `module_list` but then never used.

Please read the very last line of `src/setup.py`


---

Comment by @timokau created at 2018-07-11 20:13:54

Oh right, thanks.

So `ext_modules` is a distutils concept and they expect one single list of modules? If that is the case some pretty ugly hacks would probably be needed to cythonize the extensions in two sets.


---

Comment by mkoeppe created at 2019-11-23 19:32:29

I'd suggest to use #28791 (Implement Feature without using sage.misc.cachefunc, sage.structure.unique_representation) - I have an implementation that does the caching by hand and implements a `TrivialUniqueRepresentation` in a few lines to remove the dependencies.


---

Comment by mkoeppe created at 2019-11-23 19:38:27

When implementing this ticket, one should watch out to preserve what was intended in #21288.


---

Comment by @timokau created at 2019-11-24 19:04:36

I don't currently have time to work on this, so if anyone wants to take over that would be great.


---

Comment by fbissey created at 2019-11-26 22:35:08

A move away to the current use of `is_package_installed` is welcome. My only issue with the current implementation example is that it is automagical. The extension is automatically built on detection. Packagers usually prefer enable and then check availability. The default position of sage has always been to build on presence but as a packager I want to be able to have some control mechanism where I can disable the feature even if the necessary bits are present.

This would be a major step in avoid sage's packaging system at build time. Testing time remains an issue as it calls `list_packages` but nothing short of an overall of the option system in doctest may be able to get rid of it.


---

Comment by mkoeppe created at 2019-11-26 23:03:17

Replying to [comment:11 fbissey]:
> My only issue with the current implementation example is that it is automagical. The extension is automatically built on detection. Packagers usually prefer enable and then check availability. The default position of sage has always been to build on presence but as a packager I want to be able to have some control mechanism where I can disable the feature even if the necessary bits are present.

Great point. We could add options to `setup.py build` such as `--require-feature=sage.features.bliss.BlissLibrary`. If this `setup.py build` is invoked with this option but the feature is not found, an error would be signaled.

----
New commits:


---

Comment by git created at 2019-11-27 00:59:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-11-27 01:03:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2019-11-27 01:05:08

As a prototype it looks promising but the option is quite complicated. Even when adding proper documentation of the available features. We may want to have some kind of dictionary matching simple option names to features. But that has to come later when we add more stuff.


---

Comment by mkoeppe created at 2019-11-27 01:08:13

I would need help from a `distutils` expert on how to make the option --require-features also usable with `build`, rather than just `build_cython`.


---

Comment by mkoeppe created at 2019-11-27 01:11:51

In the ticket description I have added an example `sage.features.databases.DatabaseCremona`, which is a `StaticFile` feature.

Supporting `CythonFeature` (such as the previously mentioned `sage.features.bliss.BlissLibrary`) needs more work because it pulls in other modules that are not available at build time:

```
running build_cython
Enabling Cython debugging support
************************************************************************
Traceback (most recent call last):
  File "setup.py", line 887, in <module>
    ext_modules = ext_modules)
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.7/distutils/core.py", line 148, in setup
    dist.run_commands()
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.7/distutils/dist.py", line 966, in run_commands
    self.run_command(cmd)
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.7/distutils/dist.py", line 984, in run_command
    cmd_obj.ensure_finalized()
  File "/Users/mkoeppe/s/sage/sage-rebasing/local/lib/python3.7/distutils/cmd.py", line 107, in ensure_finalized
    self.finalize_options()
  File "setup.py", line 296, in finalize_options
    feature.require()
  File "/Users/mkoeppe/s/sage/sage-rebasing/src/sage/features/__init__.py", line 189, in require
    presence = self.is_present()
  File "/Users/mkoeppe/s/sage/sage-rebasing/src/sage/features/__init__.py", line 161, in is_present
    res = self._is_present()
  File "/Users/mkoeppe/s/sage/sage-rebasing/src/sage/features/__init__.py", line 551, in _is_present
    with open(tmp_filename(ext=".pyx"), 'w') as pyx:
  File "/Users/mkoeppe/s/sage/sage-rebasing/src/sage/misc/temporary_file.py", line 149, in tmp_filename
    from sage.misc.misc import SAGE_TMP
  File "/Users/mkoeppe/s/sage/sage-rebasing/src/sage/misc/misc.py", line 51, in <module>
    import sage.misc.prandom as random
  File "/Users/mkoeppe/s/sage/sage-rebasing/src/sage/misc/prandom.py", line 58, in <module>
    from sage.misc.randstate import current_randstate
ModuleNotFoundError: No module named 'sage.misc.randstate'
```



---

Comment by mkoeppe created at 2019-11-27 01:12:45

Replying to [comment:16 fbissey]:
> As a prototype it looks promising but the option is quite complicated. Even when adding proper documentation of the available features. We may want to have some kind of dictionary matching simple option names to features. But that has to come later when we add more stuff.
Yes, I agree, of course we can make it more user-friendly later.


---

Comment by git created at 2019-11-28 19:31:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2019-11-28 19:43:08

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2019-11-28 19:44:03

Replying to [comment:19 mkoeppe]:
> Supporting `CythonFeature` (such as the previously mentioned `sage.features.bliss.BlissLibrary`) needs more work because it pulls in other modules that are not available at build time
Done


---

Comment by git created at 2019-12-25 16:36:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-13 02:24:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-01-13 02:29:26

Rebased on top of current beta.


---

Comment by dimpase created at 2020-01-13 13:54:15

I get an error while trying to build this branch, from scratch.
Something to do with `sage.misc.randstate` not ready at the moment `BlissLibrary().is_present()` is called:

```
...
cp /home/scratch2/dimpase/sage/sage/src/ext/gap/sage.g /home/scratch2/dimpase/sage/sage/local/share/sage/ext/gap/sage.g
cp /home/scratch2/dimpase/sage/sage/src/ext/gap/joyner/hurwitz_crv_rr_sp.gap /home/scratch2/dimpase/sage/sage/local/share/sage/ext/gap/joyner/hurwitz_crv_rr_sp.gap
cp /home/scratch2/dimpase/sage/sage/src/ext/gap/joyner/modular_crv_rr_sp.gap /home/scratch2/dimpase/sage/sage/local/share/sage/ext/gap/joyner/modular_crv_rr_sp.gap
if [ -z "$SAGE_INSTALL_FETCH_ONLY" ]; then \
        cd /home/scratch2/dimpase/sage/sage/src && source bin/sage-env && \
        sage-logger -p 'time make sage' '/home/scratch2/dimpase/sage/sage/logs/pkgs/sagelib-9.1.beta0.log'; \
fi
[sagelib-9.1.beta0] make[4]: Entering directory '/home/scratch2/dimpase/sage/sage/src'
[sagelib-9.1.beta0] cd . && export                                    \
[sagelib-9.1.beta0]     SAGE_ROOT=/doesnotexist                               \
[sagelib-9.1.beta0]     SAGE_SRC=/doesnotexist                                \
[sagelib-9.1.beta0]     SAGE_SRC_ROOT=/doesnotexist                           \
[sagelib-9.1.beta0]     SAGE_DOC_SRC=/doesnotexist                            \
[sagelib-9.1.beta0]     SAGE_BUILD_DIR=/doesnotexist                          \
[sagelib-9.1.beta0]     SAGE_PKGS=/home/scratch2/dimpase/sage/sage/build/pkgs                \
[sagelib-9.1.beta0] && sage-python -u setup.py --no-user-cfg build install
[sagelib-9.1.beta0] /home/scratch2/dimpase/sage/sage/src/bin/sage-env: line 130: cd: /doesnotexist: No such file or directory
[sagelib-9.1.beta0] Warning: overwriting SAGE_ROOT environment variable:
[sagelib-9.1.beta0] Old SAGE_ROOT=/doesnotexist
[sagelib-9.1.beta0] New SAGE_ROOT=
[sagelib-9.1.beta0] ************************************************************************
[sagelib-9.1.beta0] Traceback (most recent call last):
[sagelib-9.1.beta0]   File "setup.py", line 72, in <module>
[sagelib-9.1.beta0]     from module_list import ext_modules, library_order
[sagelib-9.1.beta0]   File "/home/scratch2/dimpase/sage/sage/src/module_list.py", line 406, in <module>
[sagelib-9.1.beta0]     condition = BlissLibrary().is_present()),
[sagelib-9.1.beta0]   File "/home/scratch2/dimpase/sage/sage/src/sage/features/__init__.py", line 161, in is_present
[sagelib-9.1.beta0]     res = self._is_present()
[sagelib-9.1.beta0]   File "/home/scratch2/dimpase/sage/sage/src/sage/features/__init__.py", line 551, in _is_present
[sagelib-9.1.beta0]     with open(tmp_filename(ext=".pyx"), 'w') as pyx:
[sagelib-9.1.beta0]   File "/home/scratch2/dimpase/sage/sage/src/sage/misc/temporary_file.py", line 149, in tmp_filename
[sagelib-9.1.beta0]     from sage.misc.misc import SAGE_TMP
[sagelib-9.1.beta0]   File "/home/scratch2/dimpase/sage/sage/src/sage/misc/misc.py", line 51, in <module>
[sagelib-9.1.beta0]     import sage.misc.prandom as random
[sagelib-9.1.beta0]   File "/home/scratch2/dimpase/sage/sage/src/sage/misc/prandom.py", line 58, in <module>
[sagelib-9.1.beta0]     from sage.misc.randstate import current_randstate
[sagelib-9.1.beta0] ModuleNotFoundError: No module named 'sage.misc.randstate'
[sagelib-9.1.beta0] ************************************************************************
[sagelib-9.1.beta0] Error building the Sage library
[sagelib-9.1.beta0] ************************************************************************
[sagelib-9.1.beta0] Please email sage-devel (http://groups.google.com/group/sage-devel)
[sagelib-9.1.beta0] explaining the problem and including the relevant part of the log file
[sagelib-9.1.beta0]   /home/scratch2/dimpase/sage/sage/logs/pkgs/sagelib-9.1.beta0.log
[sagelib-9.1.beta0] Describe your computer, operating system, etc.
[sagelib-9.1.beta0] ************************************************************************
[sagelib-9.1.beta0] Error in atexit._run_exitfuncs:
[sagelib-9.1.beta0] Traceback (most recent call last):
[sagelib-9.1.beta0]   File "<frozen importlib._bootstrap>", line 983, in _find_and_load
[sagelib-9.1.beta0]   File "<frozen importlib._bootstrap>", line 967, in _find_and_load_unlocked
[sagelib-9.1.beta0]   File "<frozen importlib._bootstrap>", line 677, in _load_unlocked
[sagelib-9.1.beta0]   File "<frozen importlib._bootstrap_external>", line 728, in exec_module
[sagelib-9.1.beta0]   File "<frozen importlib._bootstrap>", line 219, in _call_with_frames_removed
[sagelib-9.1.beta0]   File "/home/scratch2/dimpase/sage/sage/src/sage/misc/misc.py", line 51, in <module>
[sagelib-9.1.beta0]     import sage.misc.prandom as random
[sagelib-9.1.beta0]   File "/home/scratch2/dimpase/sage/sage/src/sage/misc/prandom.py", line 58, in <module>
[sagelib-9.1.beta0]     from sage.misc.randstate import current_randstate
[sagelib-9.1.beta0] ModuleNotFoundError: No module named 'sage.misc.randstate'
[sagelib-9.1.beta0] make[4]: *** [Makefile:33: sage] Error 1
[sagelib-9.1.beta0] make[4]: Leaving directory '/home/scratch2/dimpase/sage/sage/src'
[sagelib-9.1.beta0]
[sagelib-9.1.beta0] real        0m0.369s
[sagelib-9.1.beta0] user        0m0.313s
[sagelib-9.1.beta0] sys 0m0.056s
make[3]: *** [Makefile:1981: sagelib] Error 2
make[3]: Leaving directory '/home/scratch2/dimpase/sage/sage/build/make'
make[2]: *** [Makefile:1842: all-start] Error 2
make[2]: Leaving directory '/home/scratch2/dimpase/sage/sage/build/make'
```



---

Comment by dimpase created at 2020-01-13 13:54:44

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-01-13 14:16:40

Sorry, looks like I lost a number of commits in the rebase.


---

Comment by git created at 2020-01-13 15:17:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by dimpase created at 2020-01-14 09:32:36

is it ready now?


---

Comment by mkoeppe created at 2020-01-14 14:11:54

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2020-01-14 17:06:14

something does not work with the build (docs get built, but then sage won't start)
This is running `make ptest` (without bliss installed, I think)

```
...
[dochtml] [thematic_] ... done (4882 js index entries)
[dochtml] [thematic_] The HTML pages are in local/share/doc/sage/html/en/thematic_tutorials.
[dochtml] Build finished. The built documents can be found in /home/scratch2/dimpase/sage/sage/local/share/doc/sage/html/en/thematic_tutorials
[dochtml] Elapsed time: 486.8 seconds.
[dochtml] Done building the documentation!
make[3]: Leaving directory '/home/scratch2/dimpase/sage/sage/build/make'
make -j12 '/home/scratch2/dimpase/sage/sage/local/etc/sage-started.txt'
make[3]: Entering directory '/home/scratch2/dimpase/sage/sage/build/make'
make[3]: warning: -jN forced in submake: disabling jobserver mode.
if [ -z "$SAGE_INSTALL_FETCH_ONLY" ]; then \
        cd /home/scratch2/dimpase/sage/sage/src && source bin/sage-env && \
        sage-logger -p 'time make -j12 sage' '/home/scratch2/dimpase/sage/sage/logs/pkgs/sagelib-9.1.beta0.log'; \
fi
[sagelib-9.1.beta0] make[4]: Entering directory '/home/scratch2/dimpase/sage/sage/src'
[sagelib-9.1.beta0] make[4]: warning: -jN forced in submake: disabling jobserver mode.
[sagelib-9.1.beta0] cd . && export                                    \
[sagelib-9.1.beta0]     SAGE_ROOT=/doesnotexist                               \
[sagelib-9.1.beta0]     SAGE_SRC=/doesnotexist                                \
[sagelib-9.1.beta0]     SAGE_SRC_ROOT=/doesnotexist                           \
[sagelib-9.1.beta0]     SAGE_DOC_SRC=/doesnotexist                            \
[sagelib-9.1.beta0]     SAGE_BUILD_DIR=/doesnotexist                          \
[sagelib-9.1.beta0]     SAGE_PKGS=/home/scratch2/dimpase/sage/sage/build/pkgs                \
[sagelib-9.1.beta0] && sage-python -u setup.py --no-user-cfg build install
[sagelib-9.1.beta0] /home/scratch2/dimpase/sage/sage/src/bin/sage-env: line 130: cd: /doesnotexist: No such file or directory
[sagelib-9.1.beta0] Warning: overwriting SAGE_ROOT environment variable:
[sagelib-9.1.beta0] Old SAGE_ROOT=/doesnotexist
[sagelib-9.1.beta0] New SAGE_ROOT=
[sagelib-9.1.beta0] /tmp/tmp_sage_cython_featuref0w8sij7/target/featuretest.cpp:652:10: fatal error: bliss/graph.hh: No such file or directory
[sagelib-9.1.beta0]  #include "bliss/graph.hh"
[sagelib-9.1.beta0]           ^~~~~~~~~~~~~~~~
[sagelib-9.1.beta0] compilation terminated.
[sagelib-9.1.beta0] Discovering Python/Cython source code....
[sagelib-9.1.beta0] Discovered Python/Cython sources, time: 0.01 seconds.
[sagelib-9.1.beta0] running build
[sagelib-9.1.beta0] Generating auto-generated sources
[sagelib-9.1.beta0] Building interpreters for fast_callable
[sagelib-9.1.beta0] running build_cython
[sagelib-9.1.beta0] Enabling Cython debugging support
[sagelib-9.1.beta0] Updating Cython code....
[sagelib-9.1.beta0] Finished Cythonizing, time: 1.49 seconds.
[sagelib-9.1.beta0] running build_py
[sagelib-9.1.beta0] running build_ext
[sagelib-9.1.beta0] Executing 0 commands (using 1 thread)
[sagelib-9.1.beta0] Time to execute 0 commands: 0.11 seconds.
[sagelib-9.1.beta0] Total time spent compiling C/C++ extensions: 0.14 seconds.
[sagelib-9.1.beta0] running install
[sagelib-9.1.beta0] running install_lib
[sagelib-9.1.beta0] running install_egg_info
[sagelib-9.1.beta0] Removing /home/scratch2/dimpase/sage/sage/local/lib/python3.7/site-packages/sage-9.1.beta0-py3.7.egg-info
[sagelib-9.1.beta0] Writing /home/scratch2/dimpase/sage/sage/local/lib/python3.7/site-packages/sage-9.1.beta0-py3.7.egg-info
[sagelib-9.1.beta0] Cleaning up stale installed files....
[sagelib-9.1.beta0] - cleaning build/lib.linux-x86_64-3.7
[sagelib-9.1.beta0] - cleaning /home/scratch2/dimpase/sage/sage/local/lib/python3.7/site-packages
[sagelib-9.1.beta0] Finished cleaning, time: 0.15 seconds.
[sagelib-9.1.beta0] if [ "$UNAME" = "CYGWIN" ]; then                         \
[sagelib-9.1.beta0]     sage-rebase.sh "$SAGE_LOCAL" 2>/dev/null;            \
[sagelib-9.1.beta0] fi
[sagelib-9.1.beta0] make[4]: Leaving directory '/home/scratch2/dimpase/sage/sage/src'
[sagelib-9.1.beta0]
[sagelib-9.1.beta0] real        0m3.029s
[sagelib-9.1.beta0] user        0m2.510s
[sagelib-9.1.beta0] sys 0m0.419s
"/home/scratch2/dimpase/sage/sage/local/bin/sage-starts"

Testing that Sage starts...
[2020-01-14 15:30:54] SageMath version 9.1.beta0, Release Date: 2020-01-10
Yes, Sage starts.
make[3]: Leaving directory '/home/scratch2/dimpase/sage/sage/build/make'
make[2]: Leaving directory '/home/scratch2/dimpase/sage/sage/build/make'

real    46m41.281s
user    276m31.335s
sys     13m36.772s
Sage build/upgrade complete!
make[1]: Leaving directory '/home/scratch2/dimpase/sage/sage'
./sage -t -p --all --logfile=logs/ptest.log
Traceback (most recent call last):
  File "/home/scratch2/dimpase/sage/sage/src/bin/sage-runtests", line 177, in <module>
    from sage.doctest.control import DocTestController
  File "/home/scratch2/dimpase/sage/sage/local/lib/python3.7/site-packages/sage/doctest/control.py", line 33, in <module>
    from .sources import FileDocTestSource, DictAsObject
  File "/home/scratch2/dimpase/sage/sage/local/lib/python3.7/site-packages/sage/doctest/sources.py", line 33, in <module>
    from .parsing import SageDocTestParser
  File "/home/scratch2/dimpase/sage/sage/local/lib/python3.7/site-packages/sage/doctest/parsing.py", line 66, in <module>
    from sage.all import RealIntervalField
ImportError: cannot import name 'RealIntervalField' from 'sage.all' (unknown location)
make: *** [Makefile:172: ptest] Error 1
```

I guess 

```
[sagelib-9.1.beta0] /tmp/tmp_sage_cython_featuref0w8sij7/target/featuretest.cpp:652:10: fatal error: bliss/graph.hh: No such file or directory
```

points somewhere...


---

Comment by mkoeppe created at 2020-01-14 20:35:16

Thanks for testing! I'll investigate


---

Comment by mkoeppe created at 2020-01-16 03:17:10

Replying to [comment:39 dimpase]:
> something does not work with the build 
> {{{
> ImportError: cannot import name 'RealIntervalField' from 'sage.all' (unknown location)
> make: *** [Makefile:172: ptest] Error 1
> }}}

Yes, I also end up with a broken build. I'll look into it more.

> I guess 
> {{{
> [sagelib-9.1.beta0] /tmp/tmp_sage_cython_featuref0w8sij7/target/featuretest.cpp:652:10: fatal error: bliss/graph.hh: No such file or directory
> }}}
> points somewhere...

No, that is just the output of the feature test. I will try to make it look less scary.


```
$ ./sage -c 'from sage.features.bliss import BlissLibrary; print(BlissLibrary().is_present())'
/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/tmp_sage_cython_featurempyw50ji/target/featuretest.cpp:653:10: fatal error: 'bliss/graph.hh' file not found
#include "bliss/graph.hh"
         ^~~~~~~~~~~~~~~~
1 error generated.
FeatureTestResult('Bliss', False)
```



---

Comment by mkoeppe created at 2020-01-19 19:31:30

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-04-14 01:47:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-10-30 23:15:09

`OptionalExtension` is no longer used. Let's close this ticket.


---

Comment by mkoeppe created at 2020-10-30 23:15:09

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2020-10-31 20:19:33

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2020-11-08 18:12:27

Resolution: invalid
