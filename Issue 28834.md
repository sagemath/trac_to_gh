# Issue 28834: verify if cblas.pc and lapack.pc should be replaced by links to openblas.pc

Issue created by migration from https://trac.sagemath.org/ticket/29071

Original creator: dimpase

Original creation time: 2020-01-23 17:18:01

CC:  isuruf mkoeppe arojas

currently openblas's spkg-configure.pc unconditionally makes cblas.pc and lapack.pc copies of openblas.pc, which in some cases if incorrect, e.g. Arch Linux has libcblas linked to libopenblas
and containing stuff missing in libopenblas, resulting in errors.

this has been reported on sage-devel
https://groups.google.com/d/msg/sage-devel/pIOnFyFJMtM/_FbzM2OxCQAJ

So we should make these installations conditional.


---

Comment by dimpase created at 2020-01-23 19:25:25

> It depends on the fortran name mangling. For gfortran, one symbol would be dgeqrf_.

we can do an `AC_LINK_IFELSE()` test with a subroutine `dgeqef` call,
and try to link it against libopenblas. this would be independent of Fortran compiler.

http://www.netlib.org/lapack/explore-html/df/dc5/group__variants_g_ecomputational_ga3766ea903391b5cf9008132f7440ec7b.html


---

Comment by dimpase created at 2020-01-23 19:28:06

And for cblas we can do `AC_CHECK_LIB()` on `cblas_dgemm`, as Antonio proposed.


---

Comment by isuruf created at 2020-01-23 19:30:08

You can also use `AC_FC_FUNC` to get the mangled name.


---

Comment by dimpase created at 2020-01-23 19:31:56

Replying to [comment:3 isuruf]:
> You can also use `AC_FC_FUNC` to get the mangled name.
OK, that's better, thanks.


---

Comment by dimpase created at 2020-01-24 11:17:28

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-01-24 11:17:28

needs testing on Arch in particular.
----
New commits:


---

Comment by vdelecroix created at 2020-01-24 12:14:57

trying now on arch


---

Comment by git created at 2020-01-24 12:23:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-01-24 12:23:34

With the branch applied, I end up with the same permission issues as with `./configure --without-system-openblas`. That is to say

```
Copying package files from temporary location /opt/sage/local/var/tmp/sage/build/openblas-0.3.6.p0/inst to /opt/sage/local
cp: cannot create regular file '/opt/sage/local/./lib/pkgconfig/blas.pc': Permission denied
cp: cannot create regular file '/opt/sage/local/./lib/pkgconfig/cblas.pc': Permission denied
cp: cannot create regular file '/opt/sage/local/./lib/pkgconfig/lapack.pc': Permission denied
```



---

Comment by dimpase created at 2020-01-24 12:28:42

Is /opt/sage/local your $SAGE_LOCAL?
If so, could you try `rm -rf /opt/sage/local/pkgconfig/` ?


---

Comment by dimpase created at 2020-01-24 12:31:15

sorry, I meant `rm -rf /opt/sage/local/lib/pkgconfig/`


---

Comment by dimpase created at 2020-01-24 12:38:53

even more precisely, `rm -f /opt/sage/local/lib/pkgconfig/*blas.pc && rm -f /opt/sage/local/lib/pkgconfig/lapack.pc`


---

Comment by dimpase created at 2020-01-24 12:48:05

I presume you get permission problems while running `make`. This is due to #29003 - where the installation of these is done somewhat carelessly.


---

Comment by git created at 2020-01-24 13:37:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-01-24 13:41:03

When I do `make distclean` it does remove `local` entirely. At which step do you want me to try `rm XXX`?


---

Comment by dimpase created at 2020-01-24 13:42:34

the logic of this branch is still not 100% correct - if we end up installing OpenBLAS we should not install any *.pc files, i.e. should not run any `AC_CONFIG_LINKS`.


---

Comment by dimpase created at 2020-01-24 13:44:12

Replying to [comment:14 vdelecroix]:
> When I do `make distclean` it does remove `local` entirely. At which step do you want me to try `rm XXX`?

these `rm` from comment:11 should be run after `./configure` and before `make`, assuming I understand what's going on.


---

Comment by dimpase created at 2020-01-24 13:44:54

By the way, please pull the branch again - comment:13 is rather important for Arch.


---

Comment by vdelecroix created at 2020-01-24 13:58:20

After `./configure` there is no directory `local/lib/pkgconfig/`

```
$ ls -R local/
local/:
bin  etc  include  lib  lib64  share  var

local/bin:

local/etc:

local/include:

local/lib:

local/share:

local/var:
lib

local/var/lib:
sage

local/var/lib/sage:
installed

local/var/lib/sage/installed:
```



---

Comment by dimpase created at 2020-01-24 14:15:22

`local/lib/pkgconfig/` may or may not be present, it depends upon the state of the system.
(e.g. if you did `make distclean` before `./configure` you won't have
`local/` at all)

Now, what happens if you run `make`? Do you still get the same error?


---

Comment by dimpase created at 2020-01-24 15:38:49

It seems I got Arch running in an lxc container, so I guess I can polish it on my own.


---

Comment by git created at 2020-01-24 18:47:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-24 22:30:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-01-24 23:02:10

with this last commit appears to work on Arch (with openblas from the system), all the way to the point of a broken scipy build - probably #29051.


---

Comment by isuruf created at 2020-01-24 23:05:18

If I'm reading the code correctly `openblas.pc` is not copied to `blas.pc` right in the Arch Linux case right?


---

Comment by dimpase created at 2020-01-24 23:11:05

Replying to [comment:24 isuruf]:
> If I'm reading the code correctly `openblas.pc` is not copied to `blas.pc` right in the Arch Linux case right?

it is copied (i.e. blas.pc becomes a link to openblas.pc), but on Arch it makes no difference, as they are also like this on the system

```
[dimpase@arch]$ file /usr/lib/pkgconfig/blas.pc 
/usr/lib/pkgconfig/blas.pc: symbolic link to openblas.pc
```



---

Comment by isuruf created at 2020-01-24 23:12:22

Changing status from needs_review to positive_review.


---

Comment by isuruf created at 2020-01-24 23:12:22

Thanks. I misread the code


---

Comment by dimpase created at 2020-01-25 13:00:14

with this branch, reverting #29025 makes everything  work on Arch (also with OpenBLAS, gsl, R, etc from the system)


---

Comment by vdelecroix created at 2020-01-25 16:02:49

Does not work on my arch... At commit `2941411`, the build of `fflas-ffpack` failed with

```
../../../fflas-ffpack/fflas/fflas_fassign.inl: In function 'void FFLAS::fassign(const Field&, size_t, typename Field::ConstElement_ptr, size_t, typename Field::Element_ptr, size_t) [with Field = Givaro::Modular<f
loat>; size_t = long unsigned int; typename Field::ConstElement_ptr = const float*; typename Field::Element_ptr = float*]':
../../../fflas-ffpack/fflas/fflas_fassign.inl:75:9: error: 'openblas_set_num_threads' was not declared in this scope; did you mean 'omp_set_num_threads'?
   75 |         openblas_set_num_threads(__FFLASFFPACK_OPENBLAS_NUM_THREADS);
      |         ^~~~~~~~~~~~~~~~~~~~~~~~
      |         omp_set_num_threads
```



---

Comment by vdelecroix created at 2020-01-25 16:07:39

(trying now with `./configure --without-system-openblas`)


---

Comment by vdelecroix created at 2020-01-25 16:19:14

Replying to [comment:29 vdelecroix]:
> (trying now with `./configure --without-system-openblas`)

In the above situation, `make` fails at building openblas with the same as usual

```
cp: cannot create regular file '/opt/sage/local/./lib/pkgconfig/blas.pc': Permission denied
cp: cannot create regular file '/opt/sage/local/./lib/pkgconfig/cblas.pc': Permission denied
cp: cannot create regular file '/opt/sage/local/./lib/pkgconfig/lapack.pc': Permission denied
```



---

Comment by vbraun created at 2020-01-25 17:22:47

That breaks configure if there is no system-wide fortran:

```
checking for Fortran libraries of ... 
checking for dummy main to link with Fortran libraries... none
configure: error: in `/Users/buildbot-sage/slave/sage_git/build':
configure: error: cannot compile a simple Fortran program
See `config.log' for more details
checking for Fortran name-mangling scheme... If you would like to try to build Sage anyway (to help porting),
export the variable 'SAGE_PORT' to something non-empty.
make[1]: *** [build/make/Makefile] Error 1
make: *** [base-toolchain] Error 2
make: Target `start' not remade because of errors.
```



---

Comment by vbraun created at 2020-01-25 17:22:47

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2020-01-25 18:20:45

Replying to [comment:31 vbraun]:
> That breaks configure if there is no system-wide fortran:

good catch - so the gfortran is a dependency here.

But this also applies to many `spkg-configure.m4` tests that use a C++ compiler
to run tests.


---

Comment by dimpase created at 2020-01-25 18:28:19

by right, C, C++, and Fortran compilers are pre-reqs for many `spkg-configure.m4` tests,
as testing with one compiler and then build another compiler and use it is dodgy.


---

Comment by arojas created at 2020-01-26 09:49:03

Replying to [comment:27 dimpase]:
> with this branch, reverting #29025 makes everything  work on Arch (also with OpenBLAS, gsl, R, etc from the system)

I can confirm, thank you. Vincent, can you post the config log of the failed fflas-ffpack build?


---

Attachment

Replying to [comment:34 arojas]:
> Replying to [comment:27 dimpase]:
> > with this branch, reverting #29025 makes everything  work on Arch (also with OpenBLAS, gsl, R, etc from the system)
> 
> I can confirm, thank you. Vincent, can you post the config log of the failed fflas-ffpack build?

Here they are
- [config.log](https://trac.sagemath.org/raw-attachment/ticket/29071/vdelecroix-29071-config.log)
- [fflas_ffpack-2.4.3.log](https://trac.sagemath.org/raw-attachment/ticket/29071/vdelecroix-29071-fflas_ffpack-2.4.3.log)


---

Comment by arojas created at 2020-01-26 10:21:05

Replying to [comment:36 vdelecroix]:
> Replying to [comment:34 arojas]:
> > Replying to [comment:27 dimpase]:
> > > with this branch, reverting #29025 makes everything  work on Arch (also with OpenBLAS, gsl, R, etc from the system)
> > 
> > I can confirm, thank you. Vincent, can you post the config log of the failed fflas-ffpack build?
> 
> Here they are
> - [config.log](https://trac.sagemath.org/raw-attachment/ticket/29071/vdelecroix-29071-config.log)
> - [fflas_ffpack-2.4.3.log](https://trac.sagemath.org/raw-attachment/ticket/29071/vdelecroix-29071-fflas_ffpack-2.4.3.log)

I think your issue is caused by the same .pc stale symlinks that are making the build fail with sage's openblas. fflas-ffpack's spkg-install has `LINBOX_BLAS="$(pkg-config --libs cblas)"`, which should return `-lcblas` on Arch, but it is returning `-lopenblas` for you. The only reason I can think of is those symlinks. Can you delete them and try again?


---

Comment by vdelecroix created at 2020-01-26 10:26:08

Replying to [comment:37 arojas]:
> Replying to [comment:36 vdelecroix]:
> > Replying to [comment:34 arojas]:
> > > Replying to [comment:27 dimpase]:
> > > > with this branch, reverting #29025 makes everything  work on Arch (also with OpenBLAS, gsl, R, etc from the system)
> > > 
> > > I can confirm, thank you. Vincent, can you post the config log of the failed fflas-ffpack build?
> > 
> > Here they are
> > - [config.log](https://trac.sagemath.org/raw-attachment/ticket/29071/vdelecroix-29071-config.log)
> > - [fflas_ffpack-2.4.3.log](https://trac.sagemath.org/raw-attachment/ticket/29071/vdelecroix-29071-fflas_ffpack-2.4.3.log)
> 
> I think your issue is caused by the same .pc stale symlinks that are making the build fail with sage's openblas. fflas-ffpack's spkg-install has `LINBOX_BLAS="$(pkg-config --libs cblas)"`, which should return `-lcblas` on Arch, but it is returning `-lopenblas` for you. The only reason I can think of is those symlinks. Can you delete them and try again?

Indeed

```
(sage-sh)$ pkg-config --libs cblas
-lopenblas 
(sage-sh) vincent@mangouste:sage$ rm local/lib/pkgconfig/cblas.pc 
(sage-sh) vincent@mangouste:sage$ rm local/lib/pkgconfig/blas.pc 
(sage-sh) vincent@mangouste:sage$ pkg-config --libs cblas
-lcblas 
```

I just relaunched `make` after that...


---

Comment by git created at 2020-01-26 10:31:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-01-26 10:33:21

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2020-01-26 10:33:21

fixed the issue in comment:31


---

Comment by arojas created at 2020-01-26 10:45:34

The fact that LINBOX_BLAS is set to -lcblas on Arch makes fflas-ffpack not detect openblas (since -lcblas doesn't provide openblas_set_num_threads), so it is compiled without openblas optimizations.

To fix this, `LINBOX_BLAS="$(pkg-config --libs cblas)"` should be replaced with ` LINBOX_BLAS="$(pkg-config --libs blas cblas)"` in fflas-ffpack's spkg-install, which would return `-lopenblas -lcblas` on Arch and wouldn't make any difference on systems where openblas provides cblas

Dima, do you want to include this change here or should I open a new ticket?


---

Comment by dimpase created at 2020-01-26 10:59:49

Replying to [comment:41 arojas]:
> The fact that LINBOX_BLAS is set to -lcblas on Arch makes fflas-ffpack not detect openblas (since -lcblas doesn't provide openblas_set_num_threads), so it is compiled without openblas optimizations.
> 
> To fix this, `LINBOX_BLAS="$(pkg-config --libs cblas)"` should be replaced with ` LINBOX_BLAS="$(pkg-config --libs blas cblas)"` in fflas-ffpack's spkg-install, which would return `-lopenblas -lcblas` on Arch and wouldn't make any difference on systems where openblas provides cblas
> 
> Dima, do you want to include this change here or should I open a new ticket?

let's do a new ticket, as this is a rather different issue.


---

Comment by vdelecroix created at 2020-01-26 11:51:00

Replying to [comment:41 arojas]:
> The fact that LINBOX_BLAS is set to -lcblas on Arch makes fflas-ffpack not detect openblas (since -lcblas doesn't provide openblas_set_num_threads), so it is compiled without openblas optimizations.
> 
> To fix this, `LINBOX_BLAS="$(pkg-config --libs cblas)"` should be replaced with ` LINBOX_BLAS="$(pkg-config --libs blas cblas)"` in fflas-ffpack's spkg-install, which would return `-lopenblas -lcblas` on Arch and wouldn't make any difference on systems where openblas provides cblas

On my machine I got

```
(sage-sh)$ pkg-config --libs blas cblas
-lopenblas 
```



---

Comment by vdelecroix created at 2020-01-26 11:54:03

Replying to [comment:43 vdelecroix]:
> Replying to [comment:41 arojas]:
> > The fact that LINBOX_BLAS is set to -lcblas on Arch makes fflas-ffpack not detect openblas (since -lcblas doesn't provide openblas_set_num_threads), so it is compiled without openblas optimizations.
> > 
> > To fix this, `LINBOX_BLAS="$(pkg-config --libs cblas)"` should be replaced with ` LINBOX_BLAS="$(pkg-config --libs blas cblas)"` in fflas-ffpack's spkg-install, which would return `-lopenblas -lcblas` on Arch and wouldn't make any difference on systems where openblas provides cblas
> 
> On my machine I got
> {{{
> (sage-sh)$ pkg-config --libs blas cblas
> -lopenblas 
> }}}

The above is coherent with the symlinks provided in Sage

```
(sage-sh)$ ls -l local/lib/pkgconfig/ | grep blas
lrwxrwxrwx 1 vincent vincent  30 26 janv. 12:25 blas.pc -> /usr/lib/pkgconfig/openblas.pc
lrwxrwxrwx 1 vincent vincent  30 26 janv. 12:25 cblas.pc -> /usr/lib/pkgconfig/openblas.pc
lrwxrwxrwx 1 vincent vincent  30 26 janv. 11:54 lapack.pc -> /usr/lib/pkgconfig/openblas.pc
```

But not with what I have in `/usr/lib/pkgconfig/`

```
$ ls -l /usr/lib/pkgconfig/ | grep blas
lrwxrwxrwx 1 root root   11 20 août  12:35 blas.pc -> openblas.pc
-rw-r--r-- 1 root root  256 24 nov.  11:43 cblas.pc
-rw-r--r-- 1 root root  497 20 août  12:35 openblas.pc
```



---

Comment by arojas created at 2020-01-26 11:59:24

Replying to [comment:44 vdelecroix]:
> Replying to [comment:43 vdelecroix]:
> > Replying to [comment:41 arojas]:
> > > The fact that LINBOX_BLAS is set to -lcblas on Arch makes fflas-ffpack not detect openblas (since -lcblas doesn't provide openblas_set_num_threads), so it is compiled without openblas optimizations.
> > > 
> > > To fix this, `LINBOX_BLAS="$(pkg-config --libs cblas)"` should be replaced with ` LINBOX_BLAS="$(pkg-config --libs blas cblas)"` in fflas-ffpack's spkg-install, which would return `-lopenblas -lcblas` on Arch and wouldn't make any difference on systems where openblas provides cblas
> > 
> > On my machine I got
> > {{{
> > (sage-sh)$ pkg-config --libs blas cblas
> > -lopenblas 
> > }}}
> 
> The above is coherent with the symlinks provided in Sage
> {{{
> (sage-sh)$ ls -l local/lib/pkgconfig/ | grep blas
> lrwxrwxrwx 1 vincent vincent  30 26 janv. 12:25 blas.pc -> /usr/lib/pkgconfig/openblas.pc
> lrwxrwxrwx 1 vincent vincent  30 26 janv. 12:25 cblas.pc -> /usr/lib/pkgconfig/openblas.pc
> lrwxrwxrwx 1 vincent vincent  30 26 janv. 11:54 lapack.pc -> /usr/lib/pkgconfig/openblas.pc
> }}}
> But not with what I have in `/usr/lib/pkgconfig/`
> {{{
> $ ls -l /usr/lib/pkgconfig/ | grep blas
> lrwxrwxrwx 1 root root   11 20 août  12:35 blas.pc -> openblas.pc
> -rw-r--r-- 1 root root  256 24 nov.  11:43 cblas.pc
> -rw-r--r-- 1 root root  497 20 août  12:35 openblas.pc
> }}}

Those links are no longer created on Arch, that's the point of this ticket


---

Comment by vdelecroix created at 2020-01-26 12:00:56

Replying to [comment:44 vdelecroix]:
> Replying to [comment:43 vdelecroix]:
> > Replying to [comment:41 arojas]:
> > > The fact that LINBOX_BLAS is set to -lcblas on Arch makes fflas-ffpack not detect openblas (since -lcblas doesn't provide openblas_set_num_threads), so it is compiled without openblas optimizations.
> > > 
> > > To fix this, `LINBOX_BLAS="$(pkg-config --libs cblas)"` should be replaced with ` LINBOX_BLAS="$(pkg-config --libs blas cblas)"` in fflas-ffpack's spkg-install, which would return `-lopenblas -lcblas` on Arch and wouldn't make any difference on systems where openblas provides cblas
> > 
> > On my machine I got
> > {{{
> > (sage-sh)$ pkg-config --libs blas cblas
> > -lopenblas 
> > }}}
> 
> The above is coherent with the symlinks provided in Sage
> {{{
> (sage-sh)$ ls -l local/lib/pkgconfig/ | grep blas
> lrwxrwxrwx 1 vincent vincent  30 26 janv. 12:25 blas.pc -> /usr/lib/pkgconfig/openblas.pc
> lrwxrwxrwx 1 vincent vincent  30 26 janv. 12:25 cblas.pc -> /usr/lib/pkgconfig/openblas.pc
> lrwxrwxrwx 1 vincent vincent  30 26 janv. 11:54 lapack.pc -> /usr/lib/pkgconfig/openblas.pc
> }}}
> But not with what I have in `/usr/lib/pkgconfig/`
> {{{
> $ ls -l /usr/lib/pkgconfig/ | grep blas
> lrwxrwxrwx 1 root root   11 20 août  12:35 blas.pc -> openblas.pc
> -rw-r--r-- 1 root root  256 24 nov.  11:43 cblas.pc
> -rw-r--r-- 1 root root  497 20 août  12:35 openblas.pc
> }}}

Removing the symlinks and setting them according to what is in `/usr/lib` seems to fix the issue

```
$ rm /opt/sage/local/lib/pkgconfig/blas.pc /opt/sage/local/lib/pkgconfig/cblas.pc
$ ln -s /usr/lib/pkgconfig/blas.pc /opt/sage/local/lib/pkgconfig/
$ ln -s /usr/lib/pkgconfig/cblas.pc /opt/sage/local/lib/pkgconfig/
```



---

Comment by vdelecroix created at 2020-01-26 12:05:33

After a `make distclean` and standing at commit `508ac7c` I see the same problem

```
$ ls -l /opt/sage/local/lib/pkgconfig/ | grep blas
lrwxrwxrwx 1 vincent vincent  30 26 janv. 14:02 blas.pc -> /usr/lib/pkgconfig/openblas.pc
lrwxrwxrwx 1 vincent vincent  30 26 janv. 14:02 cblas.pc -> /usr/lib/pkgconfig/openblas.pc
lrwxrwxrwx 1 vincent vincent  30 26 janv. 14:02 lapack.pc -> /usr/lib/pkgconfig/openblas.pc
```



---

Comment by dimpase created at 2020-01-26 12:11:50

have you run `./bootstrap && ./configure` ?
If yes, please post config.log (as attachement)


---

Comment by dimpase created at 2020-01-26 12:14:41

Wait, why do you do these:

```
$ ln -s /usr/lib/pkgconfig/blas.pc /opt/sage/local/lib/pkgconfig/
$ ln -s /usr/lib/pkgconfig/cblas.pc /opt/sage/local/lib/pkgconfig/
```


?

This could only break stuff, if you do it after `make distclean`.


---

Comment by vdelecroix created at 2020-01-26 12:18:36

After `make distclean`, `./bootstrap`, `./configure` the build still fails at `fflas-ffpack` with the same

```
error: 'openblas_set_num_threads' was not declared in this scope; did you mean 'omp_set_num_threads'?
```

Also the blas symlinks are still pointing to openblas

```
$ ls -l local/lib/pkgconfig/ | grep blas
lrwxrwxrwx 1 vincent vincent  30 26 janv. 14:12 blas.pc -> /usr/lib/pkgconfig/openblas.pc
lrwxrwxrwx 1 vincent vincent  30 26 janv. 14:12 cblas.pc -> /usr/lib/pkgconfig/openblas.pc
lrwxrwxrwx 1 vincent vincent  30 26 janv. 14:12 lapack.pc -> /usr/lib/pkgconfig/openblas.pc
```



---

Attachment


---

Comment by dimpase created at 2020-01-26 12:19:40

Please also make sure there is nothing in `src/lib/pkgconfig` before running `./configure`. After running ./configure on Arch it should look like

```
$ ls src/lib/pkgconfig/
blas.pc  gsl.pc
```


You could have these stale stuff from older versions of this ticket or even before.


---

Comment by vdelecroix created at 2020-01-26 12:20:25

Here is [config.log](https://trac.sagemath.org/raw-attachment/ticket/29071/vdelecroix-29071-config.log)


---

Comment by vdelecroix created at 2020-01-26 12:21:13

Indeed

```
$ ls -l src/lib/pkgconfig/
total 4
lrwxrwxrwx 1 vincent vincent  30 26 janv. 14:12 blas.pc -> /usr/lib/pkgconfig/openblas.pc
lrwxrwxrwx 1 vincent vincent  30 26 janv. 11:51 cblas.pc -> /usr/lib/pkgconfig/openblas.pc
-rw-r--r-- 1 vincent vincent 200 26 janv. 14:12 gsl.pc
lrwxrwxrwx 1 vincent vincent  30 26 janv. 11:51 lapack.pc -> /usr/lib/pkgconfig/openblas.pc
```



---

Comment by vdelecroix created at 2020-01-26 12:21:31

Why isn't `src/lib/pkgconfig` properly cleaned?


---

Comment by dimpase created at 2020-01-26 12:23:52

I agree that `src/lib/pkgconfig` should be properly cleaned, you are right. Perhaps by `make distclean`?


---

Comment by vdelecroix created at 2020-01-26 12:28:05

Replying to [comment:55 dimpase]:
> I agree that `src/lib/pkgconfig` should be properly cleaned, you are right. Perhaps by `make distclean`?

That `make distclean` removes `src/lib/pkgconfig` entirely would make sense to me.


---

Comment by vdelecroix created at 2020-01-26 12:38:26

After removing `src/lib/pkgconfig` the build `fflas-ffpack` succeeded! Thank you.


---

Comment by dimpase created at 2020-01-26 12:42:10

Replying to [comment:56 vdelecroix]:
> Replying to [comment:55 dimpase]:
> > I agree that `src/lib/pkgconfig` should be properly cleaned, you are right. Perhaps by `make distclean`?
> 
> That `make distclean` removes `src/lib/pkgconfig` entirely would make sense to me.

I've opened a blocker #29082 to deal with cleaning of these files, sorry for this mess.


---

Comment by vdelecroix created at 2020-01-26 12:43:49

Replying to [comment:58 dimpase]:
> Replying to [comment:56 vdelecroix]:
> > Replying to [comment:55 dimpase]:
> > > I agree that `src/lib/pkgconfig` should be properly cleaned, you are right. Perhaps by `make distclean`?
> > 
> > That `make distclean` removes `src/lib/pkgconfig` entirely would make sense to me.
> 
> I've opened a blocker #29082 to deal with cleaning of these files, sorry for this mess.

You did more good than bad :-) It is quite nice to have Sage using the libraries from the system!


---

Comment by dimpase created at 2020-01-26 12:45:30

Please also don't forget that you'll need (an equivalent of) #29051 to make the build succeed (without it scipy will fail).


---

Comment by mkoeppe created at 2020-01-28 00:52:27

I have merged in #29051 and current beta.
----
New commits:


---

Comment by mkoeppe created at 2020-01-28 01:28:02

I don't like the idea of requiring a Fortran compiler to even run `./configure` successfully. 

After all, sage-the-distribution has a mechanism to install `gfortran` itself. We shouldn't break that.

As you can see at https://github.com/mkoeppe/sage/runs/411989461, with this ticket all "minimal" installs fail with `configure: error: in `/sage':
configure: error: cannot compile a simple Fortran program`.


---

Comment by git created at 2020-01-28 05:49:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-28 05:50:58

Replying to [comment:63 mkoeppe]:
> I don't like the idea of requiring a Fortran compiler to even run `./configure` successfully. 

Fixed in d2b5e13.


---

Comment by mkoeppe created at 2020-01-28 06:59:11

Tests see https://github.com/mkoeppe/sage/runs/412256169


---

Comment by dimpase created at 2020-01-28 08:37:23

Replying to [comment:63 mkoeppe]:
> I don't like the idea of requiring a Fortran compiler to even run `./configure` successfully. 
> 
> After all, sage-the-distribution has a mechanism to install `gfortran` itself. We shouldn't break that.
> 
> As you can see at https://github.com/mkoeppe/sage/runs/411989461, with this ticket all "minimal" installs fail with `configure: error: in `/sage':
> configure: error: cannot compile a simple Fortran program`.
> 
oops, I see, I only tested with `./configure --without-system-gfortran` - which worked just fine :-)


---

Comment by dimpase created at 2020-01-28 08:41:11


```
+       if test "$SAGE_HAVE_FC_FREEFORM" = yes ; then dnl Have a suitable Fortran compiler
```


could we please stick to `AS_IF` ?


---

Comment by dimpase created at 2020-01-28 11:18:04

Replying to [comment:65 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[d2b5e13](https://git.sagemath.org/sage.git/commit/?id=d2b5e139875c8769d1b0dca0cc05512df3cdfcbe)||`configure.ac, build/pkgs/{openblas,gfortran}: Do not fail if there is no FC`||

this has broken recognition of gfortran on Debian 10.

probably cause arguments were shuffled around...


---

Comment by dimpase created at 2020-01-28 11:18:20

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2020-01-28 11:46:06

I also don't get

```
+      # We already checked (in the initial portion of configure.ac)
+      # whether the Fortran compiler accepts free-format source code (as
```

IMHO there is nothing either in configure.ac or build/pkgs/gcc/spkg-configure.m4 that
does any Fortran checks.


---

Comment by dimpase created at 2020-01-28 11:52:27

Replying to [comment:69 dimpase]:
> {{{
> +       if test "$SAGE_HAVE_FC_FREEFORM" = yes ; then dnl Have a suitable Fortran compiler
> }}}
> 
> could we please stick to `AS_IF` ?

actually, I don't see the  point of this `if` at all. If we get there then it's already true, as it's inside the check for `gfortran` as a pre-req, in the scope of `SAGE_SPKG_DEPCHECK([gfortran], ...)`.
`


---

Comment by dimpase created at 2020-01-28 12:22:49

The trouble is in `AC_FC_FUNC()`, which throws a fit if there is no Fortran compiler around, instead of just suffering in silence.


---

Comment by git created at 2020-01-28 12:29:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-01-28 12:30:45

Replying to [comment:72 dimpase]:
> I also don't get
> {{{
> +      # We already checked (in the initial portion of configure.ac)
> +      # whether the Fortran compiler accepts free-format source code (as
> }}}
> IMHO there is nothing either in configure.ac or build/pkgs/gcc/spkg-configure.m4 that
> does any Fortran checks.

Sorry, I forgot to include one commit on this branch.
Fixed.


---

Comment by mkoeppe created at 2020-01-28 12:32:56

Replying to [comment:74 dimpase]:
> The trouble is in `AC_FC_FUNC()`, which throws a fit if there is no Fortran compiler around, instead of just suffering in silence. 
Yes, exactly, and more specifically: Because of AC_REQUIRE and AC_DEFUN_ONCE one cannot easily make all things conditional that one would liike.


---

Comment by mkoeppe created at 2020-01-28 12:34:56

Replying to [comment:73 dimpase]:
> Replying to [comment:69 dimpase]:
> > {{{
> > +       if test "$SAGE_HAVE_FC_FREEFORM" = yes ; then dnl Have a suitable Fortran compiler
> > }}}
> > 
> > could we please stick to `AS_IF` ?

No, they are unfortunately not equivalent because of autoconf's AC_PREREQ/AC_DEFUN_ONCE magic.


---

Comment by dimpase created at 2020-01-28 12:37:27

New commits:


---

Comment by dimpase created at 2020-01-28 12:37:27

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2020-01-28 12:40:23

Replying to [comment:63 mkoeppe]:
> I don't like the idea of requiring a Fortran compiler to even run `./configure` successfully. 

Fixed by `wrap AC_FC_FUNC so that it does not throw an error without Fortran`: [56541ae](https://git.sagemath.org/sage.git/commit?id=56541ae443c5cffaf5d943694c37f3b4afb5bca2)


---

Comment by dimpase created at 2020-01-28 12:44:23

IMHO it's an autoconf bug/feature that `AC_FC_FUNC` errors out without Fortran, while e.g. `AC_FC_FREEFORM` does not.


---

Comment by mkoeppe created at 2020-01-28 13:18:51

Replying to [comment:81 dimpase]:
> IMHO it's an autoconf bug/feature that `AC_FC_FUNC` errors out without Fortran, while e.g. `AC_FC_FREEFORM` does not.
Yes, I agree.


---

Comment by mkoeppe created at 2020-01-28 13:26:02

Replying to [comment:80 dimpase]:
> Replying to [comment:63 mkoeppe]:
> > I don't like the idea of requiring a Fortran compiler to even run `./configure` successfully. 
> 
> Fixed by `wrap AC_FC_FUNC so that it does not throw an error without Fortran`: [56541ae](https://git.sagemath.org/sage.git/commit?id=56541ae443c5cffaf5d943694c37f3b4afb5bca2)

Great, a much easier fix than what I put together in ​8cf2a3b/​c98c6b2.  
Testing at https://github.com/mkoeppe/sage/actions/runs/32186055


---

Comment by mkoeppe created at 2020-01-28 16:09:03

Tests finished at https://github.com/mkoeppe/sage/actions/runs/32186055


---

Comment by mkoeppe created at 2020-01-28 16:22:13

Looking good, and certainly fixes what was original reported on this ticket (fflas_ffpack on archlinux). The build error of fflas_ffpack on `debian-jessie-standard` (https://github.com/mkoeppe/sage/runs/412891766) is unrelated. It is good on all other configurations.


---

Comment by mkoeppe created at 2020-01-28 16:22:13

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-01-31 23:49:32

Resolution: fixed
