# Issue 19043: MPIR gives incorrect result on i386

Issue created by migration from Trac.

Original creator: cheuberg

Original creation time: 2015-09-24 15:57:57

CC:  fredrik.johansson wbhart leif

Keywords: mpir

In [#18546](http://trac.sagemath.org/ticket/18546#comment:21), a bug in mpir only affecting i386 was described.


```
 #include "mpir.h"

int main()
{

    mpz_t one, x, w;
    mpz_init(one);
    mpz_init(x);
    mpz_init(w);
    mpz_set_str(one, "62165404551223330269422781018352605012557018849668464680057997111644937126566671941632", 10);
    mpz_set_str(x, "39623752663112484341451587580", 10);

    mpz_tdiv_q(w, one, x);
    gmp_printf("%Zd\n", one, x, w);

}
```

outputs 1568892406419848332919986945754866320479099155002496784035 instead of the correct 1568892403497558507879962225846103176600476845510570267609.


---

Comment by cheuberg created at 2015-09-24 15:59:47

I'll try to implement the patch proposed in #18546, but compilation on my 32 bit platform is slow ...


---

Comment by cheuberg created at 2015-09-24 17:51:33

Changing status from new to needs_review.


---

Comment by cheuberg created at 2015-09-24 17:51:33

Here is a patch that adds a test to mpir's test suite and then patches all `gmp-mparam.h` files for the `x86` architecture as proposed in [#18546](http://trac.sagemath.org/ticket/18546#comment:23).

I hope that one day, the problem will be solved in mpir and we can remove these patches.

For testing, you might want to first check out commit f1b4dff and run `sage -i -f -c mpir` (or `sage -p -c mpir` in more recent versions) to see the test failing on x86. Then checking out this branch fully, the problem should disappear.
----
New commits:


---

Comment by git created at 2015-09-25 07:23:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-09-29 15:12:19

Instead of patching all those tuning files, why not just

```diff
diff -ru mpir-2.7.0/gmp-impl.h mpir-2.7.0-fixed/gmp-impl.h
--- mpir-2.7.0/gmp-impl.h       2015-06-10 23:02:35.000000000 +0200
+++ mpir-2.7.0-fixed/gmp-impl.h 2015-09-29 17:04:17.746919331 +0200
`@``@` -2040,11 +2040,11 `@``@`
 #endif
 
 #ifndef SB_DIVAPPR_Q_SMALL_THRESHOLD
-#define SB_DIVAPPR_Q_SMALL_THRESHOLD 11
+#define SB_DIVAPPR_Q_SMALL_THRESHOLD 0
 #endif
 
 #ifndef SB_DIV_QR_SMALL_THRESHOLD
-#define SB_DIV_QR_SMALL_THRESHOLD 11
+#define SB_DIV_QR_SMALL_THRESHOLD 0
 #endif
 
 #ifndef DC_DIVAPPR_Q_THRESHOLD
```



---

Comment by cheuberg created at 2015-09-29 16:13:26

Replying to [comment:5 jdemeyer]:
> Instead of patching all those tuning files, why not just
> {{{
> #!diff
> diff -ru mpir-2.7.0/gmp-impl.h mpir-2.7.0-fixed/gmp-impl.h
> --- mpir-2.7.0/gmp-impl.h       2015-06-10 23:02:35.000000000 +0200
> +++ mpir-2.7.0-fixed/gmp-impl.h 2015-09-29 17:04:17.746919331 +0200
> `@``@` -2040,11 +2040,11 `@``@`
>  #endif
>  
>  #ifndef SB_DIVAPPR_Q_SMALL_THRESHOLD
> -#define SB_DIVAPPR_Q_SMALL_THRESHOLD 11
> +#define SB_DIVAPPR_Q_SMALL_THRESHOLD 0
>  #endif
>  
>  #ifndef SB_DIV_QR_SMALL_THRESHOLD
> -#define SB_DIV_QR_SMALL_THRESHOLD 11
> +#define SB_DIV_QR_SMALL_THRESHOLD 0
>  #endif
>  
>  #ifndef DC_DIVAPPR_Q_THRESHOLD
> }}}
Are we sure that we want to change the parameter on _all_ architectures?


---

Comment by leif created at 2015-09-29 16:24:52

You could easily guard the default threshold to be chosen with in addition `__i386__` (or some GMP/MPIR equivalent).


---

Comment by cheuberg created at 2015-09-29 16:41:12

Replying to [comment:7 leif]:
> You could easily guard the default threshold to be chosen with in addition `__i386__` (or some GMP/MPIR equivalent).

Could you help me finding the GMP/MPIR equivalent? Thanks.


---

Comment by leif created at 2015-09-29 16:49:36

Not ad hoc, otherwise I would have been more precise... ;-)

FWIW, `__i386__` is slightly _compiler_-dependent, so would suffice for our purpose (i.e., GCC).


---

Comment by leif created at 2015-09-29 17:30:41

Replying to [comment:9 leif]:
> Not ad hoc, otherwise I would have been more precise... ;-)
> 
> FWIW, `__i386__` is slightly _compiler_-dependent, so would suffice for our purpose (i.e., GCC).

Since most of the architecture-specific stuff is managed via different files and symlinks to them created by `configure`, there's no straight-forward "MPIR equivalent".

We could use `defined(__i386__) || defined(__i386)` (the latter is used by at least M$), and probably to be triple-safe also check whether `GMP_LIMB_BITS` is really 32 (I vaguely remember _some_<sup>TM</sup> ill compiler used to define _both_ `__i386__` _and_ `__x86_64__` on x86_64, but I'm not sure).

I don't think it really matters as long as our fix works for the architectures supported by Sage, as we're not going to submit the patch upstream.


---

Comment by jdemeyer created at 2015-09-30 06:10:05

Replying to [comment:6 cheuberg]:
> Are we sure that we want to change the parameter on _all_ architectures?
Are you sure that you *don't* want to change the parameter on _all_ architectures? Why do you think that this bug affects _only_ i386?


---

Comment by cheuberg created at 2015-09-30 06:20:23

I don't know anything about it, I just followed the recommendation for a "temporary workaround" by William Hart made in #18546.

The particular problem caught by chance in #18546 was present only on i386.


---

Comment by jdemeyer created at 2015-09-30 06:36:40

Replying to [comment:12 cheuberg]:
> I don't know anything about it, I just followed the recommendation for a "temporary workaround" by William Hart made in #18546.
Exactly, and I saw no indication at all in William Hart's comments that this bug happens only on i386. His post talks about "32 bit machines" in general.

I like simple solutions, so I would just apply the workaround in all cases. If you want to, you could only apply it on 32 bit systems.


---

Comment by leif created at 2015-09-30 08:16:12

Replying to [comment:13 jdemeyer]:
> Replying to [comment:12 cheuberg]:
> > I don't know anything about it, I just followed the recommendation for a "temporary workaround" by William Hart made in #18546.
> Exactly, and I saw no indication at all in William Hart's comments that this bug happens only on i386. His post talks about "32 bit machines" in general.

Can you reproduce it on moufang, say?




> I like simple solutions, so I would just apply the workaround in all cases.

Then you might also want to change the ticket's title... B)


---

Comment by leif created at 2015-09-30 13:02:12

The example in the description itself has a bug. ;-)

Either use

```C
gmp_printf("%Zd / %Zd = %Zd\n", one, x, w);
```

or remove `one` and `x`.


---

Comment by jdemeyer created at 2015-09-30 20:12:23

Upstream answered about [comment:5]:
> Changing the default value to 0 for those two values is probably a reasonable thing to do. Please do that.


---

Comment by jdemeyer created at 2015-09-30 20:12:23

Changing status from needs_review to needs_work.


---

Comment by leif created at 2015-09-30 21:28:32

Replying to [comment:17 jdemeyer]:
> Upstream answered about [comment:5]:
> > Changing the default value to 0 for those two values is probably a reasonable thing to do. Please do that. 

Meaning what?  `#undef` and re`#define` unconditionally instead?  (Only) if `GMP_LIMB_BITS==32`?


---

Comment by jdemeyer created at 2015-10-01 06:09:42

Replying to [comment:18 leif]:
> Replying to [comment:17 jdemeyer]:
> > Upstream answered about [comment:5]:
> > > Changing the default value to 0 for those two values is probably a reasonable thing to do. Please do that. 

It's about the _default_ value, so no `#undef` needed. Just apply [comment:5].


---

Comment by git created at 2015-10-02 16:59:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2015-10-02 17:01:15

Replying to [comment:19 jdemeyer]:
> Replying to [comment:18 leif]:
> > Replying to [comment:17 jdemeyer]:
> > > Upstream answered about [comment:5]:
> > > > Changing the default value to 0 for those two values is probably a reasonable thing to do. Please do that. 
> 
> It's about the _default_ value, so no `#undef` needed. Just apply [comment:5].

Done. Thank you for your enquiries and comments.


---

Comment by cheuberg created at 2015-10-02 17:01:15

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-10-15 08:35:46

I am going to test this + arb on a 32-bit machine.


---

Comment by jdemeyer created at 2015-10-15 13:24:30

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2015-10-15 13:24:30

Changing priority from major to critical.


---

Comment by vbraun created at 2015-10-16 08:22:23

Resolution: fixed
