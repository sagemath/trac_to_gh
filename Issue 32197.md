# Issue 32197: Do not require AVX when building with SAGE_FAT_BINARY

archive/issues_032197.json:
```json
{
    "body": "CC:  @culler @dimpase @embray @kiwifb @kliem @orlitzky @mkoeppe @slel @kwankyu\n\nSetting `CFLAGS to -mno-avx -mno-avx2 -mno-bmi2` should help the produced binaries work on older processors.\n\n\nMove from https://github.com/sagemath/binary-pkg/issues/31\n\nIssue created by migration from https://trac.sagemath.org/ticket/32434\n\n",
    "created_at": "2021-08-29T09:27:57Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Do not require AVX when building with SAGE_FAT_BINARY",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32197",
    "user": "@vbraun"
}
```
CC:  @culler @dimpase @embray @kiwifb @kliem @orlitzky @mkoeppe @slel @kwankyu

Setting `CFLAGS to -mno-avx -mno-avx2 -mno-bmi2` should help the produced binaries work on older processors.


Move from https://github.com/sagemath/binary-pkg/issues/31

Issue created by migration from https://trac.sagemath.org/ticket/32434





---

archive/issue_comments_460015.json:
```json
{
    "body": "Thanks for opening this ticket. What files need changing?\n\nRan `git grep SAGE_FAT_BINARY`\nand `git grep fat-binary`; still clueless.\n\nProbably a subset of these files:\n\n\n```\n$ git grep SAGE_FAT_BINARY | cut -f 1 -d : | sort | uniq\nbuild/bin/sage-build-env-config.in\nbuild/pkgs/argon2_cffi/spkg-install.in\nbuild/pkgs/atlas/configuration.py\nbuild/pkgs/atlas/patches/atlas-config\nbuild/pkgs/curl/spkg-install.in\nbuild/pkgs/ecm/SPKG.rst\nbuild/pkgs/ecm/spkg-install.in\nbuild/pkgs/fflas_ffpack/spkg-install.in\nbuild/pkgs/gcc/spkg-configure.m4\nbuild/pkgs/gf2x/spkg-install.in\nbuild/pkgs/givaro/spkg-install.in\nbuild/pkgs/gmp/spkg-install.in\nbuild/pkgs/libffi/spkg-install.in\nbuild/pkgs/linbox/spkg-install.in\nbuild/pkgs/m4ri/spkg-install.in\nbuild/pkgs/mpir/spkg-install.in\nbuild/pkgs/ntl/spkg-install.in\nbuild/pkgs/numpy/spkg-install.in\nbuild/pkgs/openblas/spkg-install.in\nbuild/pkgs/primecount/spkg-install.in\nbuild/pkgs/r/spkg-install.in\nconfigure.ac\ndocker/Dockerfile\nsrc/doc/en/installation/source.rst\nsrc/sage_setup/command/sage_build_ext.py\n```\n",
    "created_at": "2021-08-31T09:12:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32197#issuecomment-460015",
    "user": "@slel"
}
```

Thanks for opening this ticket. What files need changing?

Ran `git grep SAGE_FAT_BINARY`
and `git grep fat-binary`; still clueless.

Probably a subset of these files:


```
$ git grep SAGE_FAT_BINARY | cut -f 1 -d : | sort | uniq
build/bin/sage-build-env-config.in
build/pkgs/argon2_cffi/spkg-install.in
build/pkgs/atlas/configuration.py
build/pkgs/atlas/patches/atlas-config
build/pkgs/curl/spkg-install.in
build/pkgs/ecm/SPKG.rst
build/pkgs/ecm/spkg-install.in
build/pkgs/fflas_ffpack/spkg-install.in
build/pkgs/gcc/spkg-configure.m4
build/pkgs/gf2x/spkg-install.in
build/pkgs/givaro/spkg-install.in
build/pkgs/gmp/spkg-install.in
build/pkgs/libffi/spkg-install.in
build/pkgs/linbox/spkg-install.in
build/pkgs/m4ri/spkg-install.in
build/pkgs/mpir/spkg-install.in
build/pkgs/ntl/spkg-install.in
build/pkgs/numpy/spkg-install.in
build/pkgs/openblas/spkg-install.in
build/pkgs/primecount/spkg-install.in
build/pkgs/r/spkg-install.in
configure.ac
docker/Dockerfile
src/doc/en/installation/source.rst
src/sage_setup/command/sage_build_ext.py
```




---

archive/issue_comments_460016.json:
```json
{
    "body": "Warning: we shouldn't add anything to `CFLAGS` without first checking that the user's compiler supports it. \n\nIMO a better long-term solution is to ensure that all of our SPKGs respect the user's `CFLAGS`, `CXXFLAGS`, et cetera, and don't add unnecessary flags to them on-the-fly. All Gentoo packages do that, so you can likely steal patches/workarounds from our package repository or from the sage-on-gentoo overlay.",
    "created_at": "2021-08-31T12:21:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32197#issuecomment-460016",
    "user": "@orlitzky"
}
```

Warning: we shouldn't add anything to `CFLAGS` without first checking that the user's compiler supports it. 

IMO a better long-term solution is to ensure that all of our SPKGs respect the user's `CFLAGS`, `CXXFLAGS`, et cetera, and don't add unnecessary flags to them on-the-fly. All Gentoo packages do that, so you can likely steal patches/workarounds from our package repository or from the sage-on-gentoo overlay.



---

archive/issue_comments_460017.json:
```json
{
    "body": "Would this change in `src/sage_setup/command/sage_build_ext.py`\nhelp in any way?\n\n\n```diff\n def check_flags(self):\n     \"\"\"\n     Sanity check the compiler flags used to build the extensions\n     \"\"\"\n     forbidden = None\n     if os.environ.get(\"SAGE_FAT_BINARY\") == \"yes\":\n         # When building with SAGE_FAT_BINARY=yes, we should not\n         # enable CPU features which do not exist on every CPU.\n         # Such flags usually come from other libraries adding the\n         # flags to the pkgconfig configuration.  So if you hit these\n         # errors, the problem is most likely with some external\n         # library and not with Sage.\n         import re\n-        forbidden = re.compile(r\"-march=|-mpcu=|-msse3|-msse4|-mpopcnt|-mavx\")\n+        forbidden = re.compile(r\"-march=|-mpcu=|-msse3|-msse4|-mpopcnt\"\n+                               r\"|-mavx|-mavx2|-mbmi2\")\n\n     if forbidden is not None:\n         errors = 0\n         for ext in self.extensions:\n             flags = ext.extra_compile_args\n             for flag in flags:\n                 if forbidden.match(flag):\n                     log.error(\"%s uses forbidden flag '%s'\", ext.name, flag)\n                     errors += 1\n         if errors:\n             raise RuntimeError(\"forbidden flags used\")\n```\n",
    "created_at": "2021-08-31T13:35:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32197#issuecomment-460017",
    "user": "@slel"
}
```

Would this change in `src/sage_setup/command/sage_build_ext.py`
help in any way?


```diff
 def check_flags(self):
     """
     Sanity check the compiler flags used to build the extensions
     """
     forbidden = None
     if os.environ.get("SAGE_FAT_BINARY") == "yes":
         # When building with SAGE_FAT_BINARY=yes, we should not
         # enable CPU features which do not exist on every CPU.
         # Such flags usually come from other libraries adding the
         # flags to the pkgconfig configuration.  So if you hit these
         # errors, the problem is most likely with some external
         # library and not with Sage.
         import re
-        forbidden = re.compile(r"-march=|-mpcu=|-msse3|-msse4|-mpopcnt|-mavx")
+        forbidden = re.compile(r"-march=|-mpcu=|-msse3|-msse4|-mpopcnt"
+                               r"|-mavx|-mavx2|-mbmi2")

     if forbidden is not None:
         errors = 0
         for ext in self.extensions:
             flags = ext.extra_compile_args
             for flag in flags:
                 if forbidden.match(flag):
                     log.error("%s uses forbidden flag '%s'", ext.name, flag)
                     errors += 1
         if errors:
             raise RuntimeError("forbidden flags used")
```




---

archive/issue_comments_460018.json:
```json
{
    "body": "Replying to [comment:3 slelievre]:\n> Would this change in `src/sage_setup/command/sage_build_ext.py`\n> help in any way?\n> \n\nI think it strips those flags when building the sage library (which is the right thing to do in any case), but probably doesn't solve the issue in the original bug report because it's most likely coming from some SPKG and not the sage library itself.\n\nOpenBLAS is a prime suspect, since 0.3.13 will use certain machine-specific instructions when no `TARGET` is specified: https://github.com/xianyi/OpenBLAS/issues/3056\n\nOn sage-support, Nathan said that the mac app has to set `TARGET=CORE2` to support macs from 2013. I think to fix the same problem, we need to decide how old of a computer should be able to run the sage binaries, and set a `TARGET` appropriately when `SAGE_FAT_BINARY` is used. (Of course, this is all based on the guess that OpenBLAS is to blame. Can anyone reproduce the problem?) If no one else has an opinion, `TARGET=CORE2` sounds fine to me. Building from source is always an option.",
    "created_at": "2021-09-01T03:55:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32197#issuecomment-460018",
    "user": "@orlitzky"
}
```

Replying to [comment:3 slelievre]:
> Would this change in `src/sage_setup/command/sage_build_ext.py`
> help in any way?
> 

I think it strips those flags when building the sage library (which is the right thing to do in any case), but probably doesn't solve the issue in the original bug report because it's most likely coming from some SPKG and not the sage library itself.

OpenBLAS is a prime suspect, since 0.3.13 will use certain machine-specific instructions when no `TARGET` is specified: https://github.com/xianyi/OpenBLAS/issues/3056

On sage-support, Nathan said that the mac app has to set `TARGET=CORE2` to support macs from 2013. I think to fix the same problem, we need to decide how old of a computer should be able to run the sage binaries, and set a `TARGET` appropriately when `SAGE_FAT_BINARY` is used. (Of course, this is all based on the guess that OpenBLAS is to blame. Can anyone reproduce the problem?) If no one else has an opinion, `TARGET=CORE2` sounds fine to me. Building from source is always an option.



---

archive/issue_comments_460019.json:
```json
{
    "body": "bump to 9.6",
    "created_at": "2022-01-29T08:58:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32197#issuecomment-460019",
    "user": "@fchapoton"
}
```

bump to 9.6



---

archive/issue_comments_460020.json:
```json
{
    "body": "I would just like this ticket to get prioritized more highly.  **It does impact users and is probably easy to fix.**  That's all.",
    "created_at": "2022-05-17T20:28:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32197#issuecomment-460020",
    "user": "@williamstein"
}
```

I would just like this ticket to get prioritized more highly.  **It does impact users and is probably easy to fix.**  That's all.



---

archive/issue_comments_460021.json:
```json
{
    "body": "Won't happen without people who need SAGE_FAT_BINARY doing the work and setting up tests.",
    "created_at": "2022-05-17T20:40:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32197#issuecomment-460021",
    "user": "@mkoeppe"
}
```

Won't happen without people who need SAGE_FAT_BINARY doing the work and setting up tests.



---

archive/issue_comments_460022.json:
```json
{
    "body": "It occurs to me that suggestions like use \"CFLAGS to -mno-avx -mno-avx2 -mno-bmi2\" aren't really in the spirit of \"SAGE_FAT_BINARY\". They are in the spirit of \"make a binary that is very slow but works on a maximum amount of hardware\".  Maybe we can't have it both ways, but simply disabling AVX, etc. is probably going to result in a much slower Sage binary.",
    "created_at": "2022-05-17T20:46:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32197#issuecomment-460022",
    "user": "@williamstein"
}
```

It occurs to me that suggestions like use "CFLAGS to -mno-avx -mno-avx2 -mno-bmi2" aren't really in the spirit of "SAGE_FAT_BINARY". They are in the spirit of "make a binary that is very slow but works on a maximum amount of hardware".  Maybe we can't have it both ways, but simply disabling AVX, etc. is probably going to result in a much slower Sage binary.



---

archive/issue_comments_460023.json:
```json
{
    "body": "See #32363 \"Rename configure option --enable-fat-binary to --enable-portable-binary\"",
    "created_at": "2022-05-17T20:48:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32197#issuecomment-460023",
    "user": "@mkoeppe"
}
```

See #32363 "Rename configure option --enable-fat-binary to --enable-portable-binary"



---

archive/issue_comments_460024.json:
```json
{
    "body": "openblas has `dynamic_arch`, numpy has `--cpu-baseline`. I'm not aware of a more general mechanism to do magic runtime specialization to arch variants.",
    "created_at": "2022-05-17T20:52:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32197#issuecomment-460024",
    "user": "@mkoeppe"
}
```

openblas has `dynamic_arch`, numpy has `--cpu-baseline`. I'm not aware of a more general mechanism to do magic runtime specialization to arch variants.



---

archive/issue_comments_460025.json:
```json
{
    "body": "Short of compiler/linker support for such a thing, I'd think the best that a binary vendor could do is to make several builds with separate `--prefix` (SAGE_LOCAL) and then dispatch at runtime. Comes at a cost of longer build times and a few gigabytes of space.",
    "created_at": "2022-05-17T20:55:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32197#issuecomment-460025",
    "user": "@mkoeppe"
}
```

Short of compiler/linker support for such a thing, I'd think the best that a binary vendor could do is to make several builds with separate `--prefix` (SAGE_LOCAL) and then dispatch at runtime. Comes at a cost of longer build times and a few gigabytes of space.



---

archive/issue_comments_460026.json:
```json
{
    "body": "Said vendor could also throw in a \"debug\" build while at it.",
    "created_at": "2022-05-17T21:03:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32197#issuecomment-460026",
    "user": "@mkoeppe"
}
```

Said vendor could also throw in a "debug" build while at it.



---

archive/issue_comments_460027.json:
```json
{
    "body": "Replying to [comment:4 mjo]:\n> Replying to [comment:3 slelievre]:\n> > Would this change in `src/sage_setup/command/sage_build_ext.py`\n> > help in any way?\n> > \n> \n> I think it strips those flags when building the sage library (which is the right thing to do in any case), but probably doesn't solve the issue in the original bug report because it's most likely coming from some SPKG and not the sage library itself.\n\nI can't say anything about that, but I confirm that Samuel's suggestion fixes an at least related issue that I had on the device I described in [this sage-devel post](https://groups.google.com/g/sage-devel/c/6cEaXzbzHqA/m/cKE2KlfOAwAJ) (output of `lshw`):\n\n\n```\n     *-cpu\n          Beschreibung: CPU\n          Produkt: Intel(R) Atom(TM) CPU N455   @ 1.66GHz\n          Hersteller: Intel Corp.\n          Physische ID: 1d\n          Bus-Informationen: cpu@0\n          Version: 6.12.10\n          Seriennummer: 0001-06CA-0000-0000-0000-0000\n          Steckplatz: CPU\n          Gr\u00f6\u00dfe: 1662MHz\n          Kapazit\u00e4t: 1666MHz\n          Breite: 64 bits\n          Takt: 667MHz\n          F\u00e4higkeiten: x86-64 fpu fpu_exception wp vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe nx constant_tsc arch_perfmon pebs bts cpuid aperfmperf pni dtes64 monitor ds_cpl est tm2 ssse3 cx16 xtpr pdcm movbe lahf_lm dtherm cpufreq\n          Konfiguration: cores=1 enabledcores=1 id=0 threads=2\n```\n\n\nHere my observation:\n\n1. I still could build one of the first beta of 9.6 (beta3 IIRC) on this computer without giving any options to `configure`.\n2. The build of 9.7.beta0 breaks with *SIGILL*  in `sagemath_doc_html-none` and on startup even after setting `--enable-fat-binary`.\n3. The build of 9.7.beta0 runs without any problems after doing the changes suggested by Samuel.\n\nSo, my opinion is that we should do this fix since it is surely an improvement. If it really would not help for the original issue then that could be a follow up ticket (or the other way around).",
    "created_at": "2022-05-30T09:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32197#issuecomment-460027",
    "user": "@soehms"
}
```

Replying to [comment:4 mjo]:
> Replying to [comment:3 slelievre]:
> > Would this change in `src/sage_setup/command/sage_build_ext.py`
> > help in any way?
> > 
> 
> I think it strips those flags when building the sage library (which is the right thing to do in any case), but probably doesn't solve the issue in the original bug report because it's most likely coming from some SPKG and not the sage library itself.

I can't say anything about that, but I confirm that Samuel's suggestion fixes an at least related issue that I had on the device I described in [this sage-devel post](https://groups.google.com/g/sage-devel/c/6cEaXzbzHqA/m/cKE2KlfOAwAJ) (output of `lshw`):


```
     *-cpu
          Beschreibung: CPU
          Produkt: Intel(R) Atom(TM) CPU N455   @ 1.66GHz
          Hersteller: Intel Corp.
          Physische ID: 1d
          Bus-Informationen: cpu@0
          Version: 6.12.10
          Seriennummer: 0001-06CA-0000-0000-0000-0000
          Steckplatz: CPU
          Größe: 1662MHz
          Kapazität: 1666MHz
          Breite: 64 bits
          Takt: 667MHz
          Fähigkeiten: x86-64 fpu fpu_exception wp vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe nx constant_tsc arch_perfmon pebs bts cpuid aperfmperf pni dtes64 monitor ds_cpl est tm2 ssse3 cx16 xtpr pdcm movbe lahf_lm dtherm cpufreq
          Konfiguration: cores=1 enabledcores=1 id=0 threads=2
```


Here my observation:

1. I still could build one of the first beta of 9.6 (beta3 IIRC) on this computer without giving any options to `configure`.
2. The build of 9.7.beta0 breaks with *SIGILL*  in `sagemath_doc_html-none` and on startup even after setting `--enable-fat-binary`.
3. The build of 9.7.beta0 runs without any problems after doing the changes suggested by Samuel.

So, my opinion is that we should do this fix since it is surely an improvement. If it really would not help for the original issue then that could be a follow up ticket (or the other way around).



---

archive/issue_comments_460028.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-06-08T17:02:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32197#issuecomment-460028",
    "user": "@soehms"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_460029.json:
```json
{
    "body": "According to my previous comment I push a branch containing Samuel's suggestion.\n----\nNew commits:",
    "created_at": "2022-06-08T17:02:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32197#issuecomment-460029",
    "user": "@soehms"
}
```

According to my previous comment I push a branch containing Samuel's suggestion.
----
New commits:



---

archive/issue_comments_460030.json:
```json
{
    "body": "Another affected CPU: see #33671#comment:243",
    "created_at": "2022-08-18T00:46:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32197#issuecomment-460030",
    "user": "@mkoeppe"
}
```

Another affected CPU: see #33671#comment:243



---

archive/issue_comments_460031.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-08-18T00:57:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32197#issuecomment-460031",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_460032.json:
```json
{
    "body": "Note that the module that is modified here, `sage_setup.command.sage_build_ext`, is not used when `configure --enable-editable` is in use (the default since #32406)\n\nAlso, even with `configure --disable-editable`, it's not clear to me that it would enough to disable these flags in Sage library or whether it needs to be done on the level of the whole distribution. (For example by setting CFLAGS etc. at configure time as the ticket description says.)",
    "created_at": "2022-08-18T00:57:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32197#issuecomment-460032",
    "user": "@mkoeppe"
}
```

Note that the module that is modified here, `sage_setup.command.sage_build_ext`, is not used when `configure --enable-editable` is in use (the default since #32406)

Also, even with `configure --disable-editable`, it's not clear to me that it would enough to disable these flags in Sage library or whether it needs to be done on the level of the whole distribution. (For example by setting CFLAGS etc. at configure time as the ticket description says.)



---

archive/issue_comments_460033.json:
```json
{
    "body": "FWIW: I made another try on the device I described in [comment14](https://trac.sagemath.org/ticket/32434#comment:14) after installing LinuxMint 21 (vanessa) which is build on Ubuntu 22.04 (jammy). I did that on a fresh git clone of Sage 9.8.beta3 merged with the branch of the ticket. On a first step, I wanted to test with `--enable-fat-binary` but without `--disable-editable`. Accidentally, I typed `--enable-sage-fat-binary` instead of `--enable-fat-binary`. I guess that's the same as giving no option. Unexpectedly, it ends up with a pretty well working Sage.\n\nFurthermore I tried two binary installations of stable 9.7. Using the docker image `sagemath/sagemath:9.7` everything works fine, too, while if I use conda I'm getting an illegal instruction error on startup of Sage, as it was according to comment 14 with 9.7.beta0 after building from source under LinuxMint 19.3.\n\nApart from the latter fact it seems that the issue has been fixed for my device. I have no idea what could have caused that: The upgrade of the OS or changes in Sage?",
    "created_at": "2022-11-16T07:03:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32197",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32197#issuecomment-460033",
    "user": "@soehms"
}
```

FWIW: I made another try on the device I described in [comment14](https://trac.sagemath.org/ticket/32434#comment:14) after installing LinuxMint 21 (vanessa) which is build on Ubuntu 22.04 (jammy). I did that on a fresh git clone of Sage 9.8.beta3 merged with the branch of the ticket. On a first step, I wanted to test with `--enable-fat-binary` but without `--disable-editable`. Accidentally, I typed `--enable-sage-fat-binary` instead of `--enable-fat-binary`. I guess that's the same as giving no option. Unexpectedly, it ends up with a pretty well working Sage.

Furthermore I tried two binary installations of stable 9.7. Using the docker image `sagemath/sagemath:9.7` everything works fine, too, while if I use conda I'm getting an illegal instruction error on startup of Sage, as it was according to comment 14 with 9.7.beta0 after building from source under LinuxMint 19.3.

Apart from the latter fact it seems that the issue has been fixed for my device. I have no idea what could have caused that: The upgrade of the OS or changes in Sage?
