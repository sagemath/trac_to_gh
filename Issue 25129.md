# Issue 25129: Expose the function intervalproducts from Harvey's hypellfrob

Issue created by migration from Trac.

Original creator: alexjbest

Original creation time: 2018-05-15 13:46:53

CC:  edgarcosta jdemeyer

Keywords: sd87

The function intervalproducts in hypellfrob will be useful for other similar applications.
This ticket wraps that function for the rest of sage, it is necessary to have some basic functionality for ntl's mat_ZZ_p for this.


---

Comment by alexjbest created at 2018-06-01 23:03:15

Changing status from new to needs_review.


---

Comment by alexjbest created at 2018-06-01 23:03:15

New commits:


---

Comment by alexjbest created at 2018-06-13 09:29:11

New version of the code which does not add a lot of extra wrappers, still WIP (style is horrible) but the code works so review of that would help.
----
New commits:


---

Comment by alexjbest created at 2018-06-13 09:29:11

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-06-13 09:38:31

Do you really need this hack?

```
ZZ_p_c (*get "operator()") (long i, long j)
```

Cython should understand `operator()` just fine.


---

Comment by alexjbest created at 2018-06-13 09:40:03

Replying to [comment:4 jdemeyer]:
> Do you really need this hack?
> {{{
> ZZ_p_c (*get "operator()") (long i, long j)
> }}}
> Cython should understand `operator()` just fine.

I should say I am a cython noob, so the answer to all such questions is going to be no! Thanks for telling me, I just copy what is there already for the most part to get something working.
I'll try and get rid of it.


---

Comment by jdemeyer created at 2018-06-13 09:44:18

Replying to [comment:5 alexjbest]:
> I just copy what is there already

The NTL interface is probably the worst Cython code in Sage, so that's not a good recommendation.


---

Comment by jdemeyer created at 2018-06-13 09:45:53

Even this is dubious:

```
cdef cppclass mat_ZZ_p_c "mat_ZZ_p"
```

I would just keep the `mat_ZZ_p` name, no need to append `_c` (and if you do change the name, it might be to make it clear that it comes from NTL, so `NTL_mat_ZZ_p` would make more sense).


---

Comment by alexjbest created at 2018-06-13 09:50:16

Replying to [comment:6 jdemeyer]:
> Replying to [comment:5 alexjbest]:
> > I just copy what is there already
> 
> The NTL interface is probably the worst Cython code in Sage, so that's not a good recommendation.
Sure I've definitely got that impression, looking at the linbox stuff in comparison say.
But as I need ntl functionality I have to either dedicate serious time to understanding cython and fixing everything, or just add new code that is hopefully no worse than the existing, and somewhat consistent with the existing at that.
I do appreciate the comments though.


---

Comment by jdemeyer created at 2018-06-13 09:55:04

Avoid the iteration syntax `0 <= k < numintervals`, Cython understands `range()`.

The existing NTL code also has a tendency to over-use pointers. For example, in `interval_products` I see no reason for

```
cdef mat_ZZ_p_c * out = new mat_ZZ_p_c()
```

You might as well use

```
cdef mat_ZZ_p_c out
```

and replace `out[0]` by `out` in the rest of the code (and remove `del out`). The same for `mm0` and `mm1`: `new_ntl_matrix_modn_dense` doesn't need to allocate a new matrix, it might as well fill in an existing matrix.


---

Comment by git created at 2018-06-13 09:55:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by alexjbest created at 2018-06-13 09:55:25

Replying to [comment:4 jdemeyer]:
> Do you really need this hack?
> {{{
> ZZ_p_c (*get "operator()") (long i, long j)
> }}}
> Cython should understand `operator()` just fine.
Without it, it didn't seem to _just work_ as I expected i.e. calling `out(i,j)` C++ style, I have replaced it with the (less horrific)

```
        ZZ_p_c get(long i, long j)
```

though.
----
New commits:


---

Comment by jdemeyer created at 2018-06-13 09:57:08

Replying to [comment:8 alexjbest]:
> But as I need ntl functionality I have to either dedicate serious time to understanding cython

I would argue that the time you spend learning Cython is much better spend than trying to understand the Sage <-> NTL wrappers. I'm not kidding when I said that it's probably the worst Cython code in all of Sage.


---

Comment by jdemeyer created at 2018-06-13 09:57:48

Replying to [comment:11 alexjbest]:
> Without it, it didn't seem to _just work_ as I expected i.e. calling `out(i,j)` C++ style

It _should_ work though. Which error did you get?


---

Comment by jdemeyer created at 2018-06-13 10:03:40

Replying to [comment:9 jdemeyer]:
> `new_ntl_matrix_modn_dense` doesn't need to allocate a new matrix, it might as well fill in an existing matrix.

More precisely, you don't need `new_ntl_matrix_modn_dense` at all: just move the line `A.SetDims(m._nrows, m._ncols)` to `set_ntl_matrix_modn_dense` and call that with an existing matrix like

```
cdef mat_ZZ_p_c mm

set_ntl_matrix_modn_dense(mm, ...)
```



---

Comment by alexjbest created at 2018-06-13 10:20:12

Replying to [comment:13 jdemeyer]:
> Replying to [comment:11 alexjbest]:
> > Without it, it didn't seem to _just work_ as I expected i.e. calling `out(i,j)` C++ style
> 
> It _should_ work though. Which error did you get?
You are right, my mistake, I had the wrong syntax in types.pxd, I suppose I prefer `get` in this context anyway I guess as its 0 indexed rather than 1 indexed but operator does work.


---

Comment by git created at 2018-06-13 10:30:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-06-13 10:59:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2018-08-03 19:20:18

update milestone 8.3 -> 8.4


---

Comment by alexjbest created at 2018-09-01 19:23:44

Replying to [comment:14 jdemeyer]:
> Replying to [comment:9 jdemeyer]:
> > `new_ntl_matrix_modn_dense` doesn't need to allocate a new matrix, it might as well fill in an existing matrix.
> 
> More precisely, you don't need `new_ntl_matrix_modn_dense` at all: just move the line `A.SetDims(m._nrows, m._ncols)` to `set_ntl_matrix_modn_dense` and call that with an existing matrix like
> {{{
> cdef mat_ZZ_p_c mm
> 
> set_ntl_matrix_modn_dense(mm, ...)
> }}}


I believe I made all the changes you suggested and the patchbot seems happy, so I'm setting this back to needs review, would appreciate any further thoughts you have.


---

Comment by alexjbest created at 2018-09-01 19:23:44

Changing status from needs_work to needs_review.


---

Comment by alexjbest created at 2018-11-18 06:28:19

`@`jdemeyer any update on this? still seems to merge fine, patchbot still passing!


---

Comment by git created at 2018-11-18 23:27:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by alexjbest created at 2018-12-17 02:38:50

This is now the only thing holding up #20264 so if anyone has any time to look at this again that would be much appreciated!


---

Comment by jdemeyer created at 2019-02-13 21:40:01

Please follow the Sage coding standards: try to limit lines to less than 80 characters and use 4 spaces for indentation.


---

Comment by jdemeyer created at 2019-02-13 21:43:29

There is a potential overflow in `hypellfrob_interval_products_wrapper`: you use `int` where NTL uses `long`.


---

Comment by jdemeyer created at 2019-02-13 21:44:55

Check you divisions: add `from __future__ import division` and use `//` where you want floor division.


---

Comment by jdemeyer created at 2019-02-13 21:46:32

More generally about `hypellfrob_interval_products_wrapper`: do you really need a wrapper calling a wrapper? Can't you drop one level of indirection by doing it in Cython?


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by git created at 2019-04-06 21:18:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2019-06-06 18:57:29

I have made a fresh, rebased and squashed branch.
----
New commits:


---

Comment by chapoton created at 2019-06-07 06:17:11

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2019-06-07 06:17:11

This seems to be currently broken.


---

Comment by chapoton created at 2019-06-07 18:53:09

Broken, apparently in 8.7.rc0, maybe due to #27070 ?


---

Comment by git created at 2019-06-13 00:31:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-06-14 07:37:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-06-14 07:38:30

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2019-06-14 07:38:30

I have changed some little details. If you agree with them, you can set to positive review.


---

Comment by git created at 2019-06-14 07:40:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by edgarcosta created at 2019-06-14 14:41:46

Changing status from needs_review to positive_review.


---

Comment by edgarcosta created at 2019-06-14 14:41:46

All the changes look good to me.


---

Comment by vbraun created at 2019-06-27 20:13:48

Resolution: fixed


---

Comment by embray created at 2019-07-03 11:34:48

Not in Sage 8.8.  Let's please to try keep tickets' milestones related to the release in which we actually intend to include them, and in particular the release in which they were _actually_ included, especially when closing tickets.
