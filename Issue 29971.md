# Issue 29971: List Assignment for Bundle Connections

archive/issues_029971.json:
```json
{
    "body": "CC:  egourgoulhon tscrim\n\nBundle connections were implementet quite superficially (by me). In this ticket, I want to improve the assigment behavior of bundle connections.\n\nFirst of all, the methods `set_connection_form` and `add_connection_form` now return the corresponding connection 1-form ready for further assignment.\n\nThe main improvement in this ticket is to allow list assignments:\n\n\n```\nsage: M = Manifold(2, 'M', start_index=1)\nsage: X.<x,y> = M.chart()\nsage: E = M.vector_bundle(2, 'E')\nsage: nab = E.bundle_connection('nabla')\nsage: e = E.local_frame('e')\nsage: nab[e, :] = 0  # set all entries to zero\nsage: nab[e, 0, 0].display()\nconnection (1,1) of bundle connection nabla w.r.t. Local frame (E|_M, (e_1,e_2)) = 0\n```\n\n\nFor details see the documentation, which I have also improved.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30208\n\n",
    "created_at": "2020-07-23T19:27:05Z",
    "labels": [
        "manifolds",
        "major",
        "enhancement"
    ],
    "title": "List Assignment for Bundle Connections",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29971",
    "user": "@mjungmath"
}
```
CC:  egourgoulhon tscrim

Bundle connections were implementet quite superficially (by me). In this ticket, I want to improve the assigment behavior of bundle connections.

First of all, the methods `set_connection_form` and `add_connection_form` now return the corresponding connection 1-form ready for further assignment.

The main improvement in this ticket is to allow list assignments:


```
sage: M = Manifold(2, 'M', start_index=1)
sage: X.<x,y> = M.chart()
sage: E = M.vector_bundle(2, 'E')
sage: nab = E.bundle_connection('nabla')
sage: e = E.local_frame('e')
sage: nab[e, :] = 0  # set all entries to zero
sage: nab[e, 0, 0].display()
connection (1,1) of bundle connection nabla w.r.t. Local frame (E|_M, (e_1,e_2)) = 0
```


For details see the documentation, which I have also improved.

Issue created by migration from https://trac.sagemath.org/ticket/30208





---

archive/issue_comments_425763.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-07-23T20:29:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425763",
    "user": "@mjungmath"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_425764.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2020-07-23T20:29:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425764",
    "user": "@mjungmath"
}
```

Last 10 new commits:



---

archive/issue_comments_425765.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-26T15:23:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425765",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_425766.json:
```json
{
    "body": "Misindent:\n\n```diff\n-            sage: M = Manifold(2, 'M')\n+             sage: M = Manifold(2, 'M')\n             sage: X.<x,y> = M.chart()\n             sage: E = M.vector_bundle(2, 'E')\n```\n\nAlso in `add_connection_form` and `set_connection_form`, you need to deprecate the `form` input (or keep it with a default of `None`).",
    "created_at": "2020-07-27T04:00:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425766",
    "user": "tscrim"
}
```

Misindent:

```diff
-            sage: M = Manifold(2, 'M')
+             sage: M = Manifold(2, 'M')
             sage: X.<x,y> = M.chart()
             sage: E = M.vector_bundle(2, 'E')
```

Also in `add_connection_form` and `set_connection_form`, you need to deprecate the `form` input (or keep it with a default of `None`).



---

archive/issue_comments_425767.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-27T08:50:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425767",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_425768.json:
```json
{
    "body": "Is this suitable?\n\n**Addendum:** Do you think this attempt is better than the one before?",
    "created_at": "2020-07-27T08:51:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425768",
    "user": "@mjungmath"
}
```

Is this suitable?

**Addendum:** Do you think this attempt is better than the one before?



---

archive/issue_comments_425769.json:
```json
{
    "body": "You should make it a standard deprecation using `from sage.misc.superseded import deprecation`. Also, there will need to be separate deprecations for each of the two methods.\n\nMy (not so well informed) opinion is that both approaches seem natural. So I don't really can't make a comparison about which is better.",
    "created_at": "2020-07-27T11:17:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425769",
    "user": "tscrim"
}
```

You should make it a standard deprecation using `from sage.misc.superseded import deprecation`. Also, there will need to be separate deprecations for each of the two methods.

My (not so well informed) opinion is that both approaches seem natural. So I don't really can't make a comparison about which is better.



---

archive/issue_comments_425770.json:
```json
{
    "body": "Replying to [comment:8 tscrim]:\n> You should make it a standard deprecation using `from sage.misc.superseded import deprecation`. Also, there will need to be separate deprecations for each of the two methods.\n\nI will change this. Thank you.\n\n> My (not so well informed) opinion is that both approaches seem natural. So I don't really can't make a comparison about which is better.\n\nI thought this approach is more natural in terms of the \"immutability\" discussion we had months ago. The connection forms are now somehow fixed and clearly bound to the connection. Furthermore, it is much closer to the implementation of `AffineConnection`.\n\nEric, what do you say?",
    "created_at": "2020-07-27T11:31:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425770",
    "user": "@mjungmath"
}
```

Replying to [comment:8 tscrim]:
> You should make it a standard deprecation using `from sage.misc.superseded import deprecation`. Also, there will need to be separate deprecations for each of the two methods.

I will change this. Thank you.

> My (not so well informed) opinion is that both approaches seem natural. So I don't really can't make a comparison about which is better.

I thought this approach is more natural in terms of the "immutability" discussion we had months ago. The connection forms are now somehow fixed and clearly bound to the connection. Furthermore, it is much closer to the implementation of `AffineConnection`.

Eric, what do you say?



---

archive/issue_comments_425771.json:
```json
{
    "body": "Replying to [comment:9 gh-mjungmath]:\n> Replying to [comment:8 tscrim]:\n> > My (not so well informed) opinion is that both approaches seem natural. So I don't really can't make a comparison about which is better.\n> \n> I thought this approach is more natural in terms of the \"immutability\" discussion we had months ago. The connection forms are now somehow fixed and clearly bound to the connection.\n\nA few months ago seems like a lifetime now. Although I think it was more than a few months, but I don't quite remember the outcome of that conversation...",
    "created_at": "2020-07-27T11:36:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425771",
    "user": "tscrim"
}
```

Replying to [comment:9 gh-mjungmath]:
> Replying to [comment:8 tscrim]:
> > My (not so well informed) opinion is that both approaches seem natural. So I don't really can't make a comparison about which is better.
> 
> I thought this approach is more natural in terms of the "immutability" discussion we had months ago. The connection forms are now somehow fixed and clearly bound to the connection.

A few months ago seems like a lifetime now. Although I think it was more than a few months, but I don't quite remember the outcome of that conversation...



---

archive/issue_comments_425772.json:
```json
{
    "body": "Replying to [comment:10 tscrim]:\n> A few months ago seems like a lifetime now. Although I think it was more than a few months, but I don't quite remember the outcome of that conversation...\n\nAnd still, time flies...I think the outcome was #28562.",
    "created_at": "2020-07-27T11:42:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425772",
    "user": "@mjungmath"
}
```

Replying to [comment:10 tscrim]:
> A few months ago seems like a lifetime now. Although I think it was more than a few months, but I don't quite remember the outcome of that conversation...

And still, time flies...I think the outcome was #28562.



---

archive/issue_comments_425773.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-27T21:50:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425773",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_425774.json:
```json
{
    "body": "LGTM.",
    "created_at": "2020-07-28T01:40:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425774",
    "user": "tscrim"
}
```

LGTM.



---

archive/issue_comments_425775.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-28T01:40:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425775",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_425776.json:
```json
{
    "body": "Thank you for the positive review. Besides, I am still curious what Eric has to say about these changes.",
    "created_at": "2020-07-28T10:25:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425776",
    "user": "@mjungmath"
}
```

Thank you for the positive review. Besides, I am still curious what Eric has to say about these changes.



---

archive/issue_comments_425777.json:
```json
{
    "body": "Sorry, I have found some severe flaws.",
    "created_at": "2020-07-28T12:54:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425777",
    "user": "@mjungmath"
}
```

Sorry, I have found some severe flaws.



---

archive/issue_comments_425778.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-07-28T12:54:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425778",
    "user": "@mjungmath"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_425779.json:
```json
{
    "body": "I have sensed something really odd, and I have no idea where this might come from:\n\n\n```\nsage: M = Manifold(3, 'M', start_index=1)\nsage: X.<x,y,z> = M.chart()\nsage: E = M.vector_bundle(2, 'E')\nsage: e = E.local_frame('e') # standard frame for E\nsage: nab = E.bundle_connection('nabla', latex_name=r'\\nabla')\nsage: nab[e, :] = 0\nsage: nab[e, 1, 2][:] = [x*z, y*z, z^2]\nsage: nab[e, 2, 1][:] = [x, x^2, x^3]\nsage: nab[e, 1, 1][:] = [x+z, y-z, x*y*z]\nsage: vframe = X.frame()\nsage: e[1][[e, 2]]\n0\nsage: om = nab[2, 2]\nsage: om(vframe[1])\nScalar field connection (2,2) of bundle connection nabla w.r.t. Local frame (E|_M, (e_1,e_2))(d/dx) on the 3-dimensional differentiable manifold M\nsage: e[1][[e, 2]]\nScalar field connection (2,2) of bundle connection nabla w.r.t. Local frame (E|_M, (e_1,e_2))(d/dx) on the 3-dimensional differentiable manifold M\nsage: e[1][[e, 2]] is om(vframe[1])\nTrue\n```\n\n\nWhat the...?\n\n**Addendum:** I think the problem comes from the *unique* zero scalar field. Somehow it gets altered via `__call__` of `TensorField`. It has therefore nothing to do with this ticket. I have opened another ticket #30239.",
    "created_at": "2020-07-28T13:03:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425779",
    "user": "@mjungmath"
}
```

I have sensed something really odd, and I have no idea where this might come from:


```
sage: M = Manifold(3, 'M', start_index=1)
sage: X.<x,y,z> = M.chart()
sage: E = M.vector_bundle(2, 'E')
sage: e = E.local_frame('e') # standard frame for E
sage: nab = E.bundle_connection('nabla', latex_name=r'\nabla')
sage: nab[e, :] = 0
sage: nab[e, 1, 2][:] = [x*z, y*z, z^2]
sage: nab[e, 2, 1][:] = [x, x^2, x^3]
sage: nab[e, 1, 1][:] = [x+z, y-z, x*y*z]
sage: vframe = X.frame()
sage: e[1][[e, 2]]
0
sage: om = nab[2, 2]
sage: om(vframe[1])
Scalar field connection (2,2) of bundle connection nabla w.r.t. Local frame (E|_M, (e_1,e_2))(d/dx) on the 3-dimensional differentiable manifold M
sage: e[1][[e, 2]]
Scalar field connection (2,2) of bundle connection nabla w.r.t. Local frame (E|_M, (e_1,e_2))(d/dx) on the 3-dimensional differentiable manifold M
sage: e[1][[e, 2]] is om(vframe[1])
True
```


What the...?

**Addendum:** I think the problem comes from the *unique* zero scalar field. Somehow it gets altered via `__call__` of `TensorField`. It has therefore nothing to do with this ticket. I have opened another ticket #30239.



---

archive/issue_comments_425780.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-28T13:49:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425780",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_425781.json:
```json
{
    "body": "I have uploaded the fix of a minor mistake.",
    "created_at": "2020-07-28T13:50:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425781",
    "user": "@mjungmath"
}
```

I have uploaded the fix of a minor mistake.



---

archive/issue_comments_425782.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-07-28T13:50:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425782",
    "user": "@mjungmath"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_425783.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-28T14:50:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425783",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_425784.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-28T14:53:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425784",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_425785.json:
```json
{
    "body": "While this was already there, so I am not going to stop a positive review, but I really dislike doctests like this:\n\n```\n            sage: nab._new_forms(e)  # random\n            dict of forms\n```\n\nIt is only `# random` because of the print order, but you can easily make it print in a fixed order by\n\n```\nsage: d = nab._new_forms(e)\nsage: [d[k] for k in sorted(d)]\n```\n\nBy marking it as `# random`, it can take any output, so it can mask bugs.\n\nIf you don't want to change this, you can just ignore and set a positive review. If you do change, you can just set it to a positive review after you run the doctest on the file.",
    "created_at": "2020-07-29T01:09:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425785",
    "user": "tscrim"
}
```

While this was already there, so I am not going to stop a positive review, but I really dislike doctests like this:

```
            sage: nab._new_forms(e)  # random
            dict of forms
```

It is only `# random` because of the print order, but you can easily make it print in a fixed order by

```
sage: d = nab._new_forms(e)
sage: [d[k] for k in sorted(d)]
```

By marking it as `# random`, it can take any output, so it can mask bugs.

If you don't want to change this, you can just ignore and set a positive review. If you do change, you can just set it to a positive review after you run the doctest on the file.



---

archive/issue_comments_425786.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-29T08:13:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425786",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_425787.json:
```json
{
    "body": "Very good point. Thank you Travis. I've changed it.",
    "created_at": "2020-07-29T08:17:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425787",
    "user": "@mjungmath"
}
```

Very good point. Thank you Travis. I've changed it.



---

archive/issue_comments_425788.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-29T08:17:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425788",
    "user": "@mjungmath"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_425789.json:
```json
{
    "body": "I'm just thinking about whether the list assignment via copying is the right way to do. The Python documentation says:\n\n> *Assignment statements in Python do not copy objects, they create bindings between a target and an object.*\n\nI suggest, we remove the `__setitem__` method again, and encourage the use of `set_connection_form(i, j).copy_from(omega)` instead. If that meets with your approval, I will open a ticket for that and apply the same changes for mixed differential forms.\n\n**Addendum:** Seems it's fine. Even some classes in the Python library admits that behavior. I just improved the documentation regarding that in one of the subsequent tickets.",
    "created_at": "2020-08-04T15:49:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425789",
    "user": "@mjungmath"
}
```

I'm just thinking about whether the list assignment via copying is the right way to do. The Python documentation says:

> *Assignment statements in Python do not copy objects, they create bindings between a target and an object.*

I suggest, we remove the `__setitem__` method again, and encourage the use of `set_connection_form(i, j).copy_from(omega)` instead. If that meets with your approval, I will open a ticket for that and apply the same changes for mixed differential forms.

**Addendum:** Seems it's fine. Even some classes in the Python library admits that behavior. I just improved the documentation regarding that in one of the subsequent tickets.



---

archive/issue_comments_425790.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-08-07T19:07:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29971",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29971#issuecomment-425790",
    "user": "vbraun"
}
```

Resolution: fixed
