# Issue 29971: List Assignment for Bundle Connections

Issue created by migration from https://trac.sagemath.org/ticket/30208

Original creator: @mjungmath

Original creation time: 2020-07-23 19:27:05

CC:  egourgoulhon tscrim

Bundle connections were implementet quite superficially (by me). In this ticket, I want to improve the assigment behavior of bundle connections.

First of all, the methods `set_connection_form` and `add_connection_form` now return the corresponding connection 1-form ready for further assignment.

The main improvement in this ticket is to allow list assignments:


```
sage: M = Manifold(2, 'M', start_index=1)
sage: X.<x,y> = M.chart()
sage: E = M.vector_bundle(2, 'E')
sage: nab = E.bundle_connection('nabla')
sage: e = E.local_frame('e')
sage: nab[e, :] = 0  # set all entries to zero
sage: nab[e, 0, 0].display()
connection (1,1) of bundle connection nabla w.r.t. Local frame (E|_M, (e_1,e_2)) = 0
```


For details see the documentation, which I have also improved.


---

Comment by @mjungmath created at 2020-07-23 20:29:16

Changing status from new to needs_review.


---

Comment by @mjungmath created at 2020-07-23 20:29:16

Last 10 new commits:


---

Comment by git created at 2020-07-26 15:23:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2020-07-27 04:00:16

Misindent:

```diff
-            sage: M = Manifold(2, 'M')
+             sage: M = Manifold(2, 'M')
             sage: X.<x,y> = M.chart()
             sage: E = M.vector_bundle(2, 'E')
```

Also in `add_connection_form` and `set_connection_form`, you need to deprecate the `form` input (or keep it with a default of `None`).


---

Comment by git created at 2020-07-27 08:50:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2020-07-27 08:51:06

Is this suitable?

**Addendum:** Do you think this attempt is better than the one before?


---

Comment by tscrim created at 2020-07-27 11:17:23

You should make it a standard deprecation using `from sage.misc.superseded import deprecation`. Also, there will need to be separate deprecations for each of the two methods.

My (not so well informed) opinion is that both approaches seem natural. So I don't really can't make a comparison about which is better.


---

Comment by @mjungmath created at 2020-07-27 11:31:04

Replying to [comment:8 tscrim]:
> You should make it a standard deprecation using `from sage.misc.superseded import deprecation`. Also, there will need to be separate deprecations for each of the two methods.

I will change this. Thank you.

> My (not so well informed) opinion is that both approaches seem natural. So I don't really can't make a comparison about which is better.

I thought this approach is more natural in terms of the "immutability" discussion we had months ago. The connection forms are now somehow fixed and clearly bound to the connection. Furthermore, it is much closer to the implementation of `AffineConnection`.

Eric, what do you say?


---

Comment by tscrim created at 2020-07-27 11:36:02

Replying to [comment:9 gh-mjungmath]:
> Replying to [comment:8 tscrim]:
> > My (not so well informed) opinion is that both approaches seem natural. So I don't really can't make a comparison about which is better.
> 
> I thought this approach is more natural in terms of the "immutability" discussion we had months ago. The connection forms are now somehow fixed and clearly bound to the connection.

A few months ago seems like a lifetime now. Although I think it was more than a few months, but I don't quite remember the outcome of that conversation...


---

Comment by @mjungmath created at 2020-07-27 11:42:19

Replying to [comment:10 tscrim]:
> A few months ago seems like a lifetime now. Although I think it was more than a few months, but I don't quite remember the outcome of that conversation...

And still, time flies...I think the outcome was #28562.


---

Comment by git created at 2020-07-27 21:50:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2020-07-28 01:40:28

LGTM.


---

Comment by tscrim created at 2020-07-28 01:40:28

Changing status from needs_review to positive_review.


---

Comment by @mjungmath created at 2020-07-28 10:25:46

Thank you for the positive review. Besides, I am still curious what Eric has to say about these changes.


---

Comment by @mjungmath created at 2020-07-28 12:54:25

Sorry, I have found some severe flaws.


---

Comment by @mjungmath created at 2020-07-28 12:54:25

Changing status from positive_review to needs_work.


---

Comment by @mjungmath created at 2020-07-28 13:03:11

I have sensed something really odd, and I have no idea where this might come from:


```
sage: M = Manifold(3, 'M', start_index=1)
sage: X.<x,y,z> = M.chart()
sage: E = M.vector_bundle(2, 'E')
sage: e = E.local_frame('e') # standard frame for E
sage: nab = E.bundle_connection('nabla', latex_name=r'\nabla')
sage: nab[e, :] = 0
sage: nab[e, 1, 2][:] = [x*z, y*z, z^2]
sage: nab[e, 2, 1][:] = [x, x^2, x^3]
sage: nab[e, 1, 1][:] = [x+z, y-z, x*y*z]
sage: vframe = X.frame()
sage: e[1][[e, 2]]
0
sage: om = nab[2, 2]
sage: om(vframe[1])
Scalar field connection (2,2) of bundle connection nabla w.r.t. Local frame (E|_M, (e_1,e_2))(d/dx) on the 3-dimensional differentiable manifold M
sage: e[1][[e, 2]]
Scalar field connection (2,2) of bundle connection nabla w.r.t. Local frame (E|_M, (e_1,e_2))(d/dx) on the 3-dimensional differentiable manifold M
sage: e[1][[e, 2]] is om(vframe[1])
True
```


What the...?

**Addendum:** I think the problem comes from the _unique_ zero scalar field. Somehow it gets altered via `__call__` of `TensorField`. It has therefore nothing to do with this ticket. I have opened another ticket #30239.


---

Comment by git created at 2020-07-28 13:49:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2020-07-28 13:50:33

I have uploaded the fix of a minor mistake.


---

Comment by @mjungmath created at 2020-07-28 13:50:33

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-07-28 14:50:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-28 14:53:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2020-07-29 01:09:25

While this was already there, so I am not going to stop a positive review, but I really dislike doctests like this:

```
            sage: nab._new_forms(e)  # random
            dict of forms
```

It is only `# random` because of the print order, but you can easily make it print in a fixed order by

```
sage: d = nab._new_forms(e)
sage: [d[k] for k in sorted(d)]
```

By marking it as `# random`, it can take any output, so it can mask bugs.

If you don't want to change this, you can just ignore and set a positive review. If you do change, you can just set it to a positive review after you run the doctest on the file.


---

Comment by git created at 2020-07-29 08:13:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2020-07-29 08:17:10

Very good point. Thank you Travis. I've changed it.


---

Comment by @mjungmath created at 2020-07-29 08:17:10

Changing status from needs_review to positive_review.


---

Comment by @mjungmath created at 2020-08-04 15:49:22

I'm just thinking about whether the list assignment via copying is the right way to do. The Python documentation says:

> _Assignment statements in Python do not copy objects, they create bindings between a target and an object._

I suggest, we remove the `__setitem__` method again, and encourage the use of `set_connection_form(i, j).copy_from(omega)` instead. If that meets with your approval, I will open a ticket for that and apply the same changes for mixed differential forms.

**Addendum:** Seems it's fine. Even some classes in the Python library admits that behavior. I just improved the documentation regarding that in one of the subsequent tickets.


---

Comment by vbraun created at 2020-08-07 19:07:28

Resolution: fixed
