# Issue 20113: Work with gcc's new cxx11 abi

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2016-04-03 08:40:28

CC:  fbissey jdemeyer

gcc-5 introduces a new cxx11 abi, and linking C++ libraries with different abi versions will cause missing `std::__cxx11` symbols like

```
undefined reference to `std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >::push_back(char)`@`GLIBCXX_3.4.21'
```

This is an issue whenever we build our own gcc; Right now that means gcc-4.9.3 which only supports the old abi. So linking with any system C++ library will fail, and there are various optional libraries that packages test for and link when available. Also, gcc-5 system installations may default to the old abi (e.g. Fedora), so we can't just do a version check.

Originated in this thread: https://groups.google.com/d/msg/sage-devel/2lRw3RO1ZlQ/H8fc7fCYEAAJ

Its clear that we must update our gcc to 5 if we ever want to be able to link to new-abi libraries. Then we could also match the abi by putting `-D_GLIBCXX_USE_CXX11_ABI=[0|1]` into the `CFLAGS`

The only alternative would be to never link against a system C++ library, e.g. disable the optional libqd support in libfplll (and probably more).


---

Comment by vbraun created at 2016-04-03 08:40:58

Log of a failed libfplll build at https://17155618904249771801.googlegroups.com/attach/10e6024a7e6598/libfplll-20160107.log?part=0.1&view=1&vt=ANaJVrHprWivYyvSOk4W8B4Yf852eqVzskXCXTsJA2BlAHQ5kyklN98dC_CPaJzaJhopWx4Hv9MIVs8fhILoJ9AxKFwlHxwbt_uTSOqZglNm3kkMhjWPYJU


---

Comment by fbissey created at 2016-04-03 09:05:27

suspected that was it. It has been known for some time that the c++11 abi between gcc version 4.8, 4.9 and 5.1+ are not compatible. Which will be a problem for anyone upgrading a previously built sage after a gcc upgrade for 4.9 to 5.x.
I didn't know fedora was defaulting to the old abi or that there was a switch.


---

Comment by vbraun created at 2016-04-03 23:10:43

This is not just an upgrade problem, everybody with a sufficiently new distro will fail to link Sage stuff to system C++ libraries.

To be precise, Fedora 22 shipped gcc-5 with the old abi as default, and Fedora 23 (current) uses gcc-5 with the new abi as default.


---

Comment by leif created at 2016-07-01 17:11:43

Replying to [comment:3 vbraun]:
> This is not just an upgrade problem, everybody with a sufficiently new distro will fail to link Sage stuff to system C++ libraries.

_Linux_ distro that is (at least not MacOS X where we really need to build GCC).

With sufficiently new distros, GCC should be recent enough that we could disable `SAGE_INSTALL_GCC`, which means `g++` and `gfortran` have to be already installed of course.

(Although we currently have trouble with GCC 6.1... >8( )

Or am I missing something?


---

Comment by leif created at 2016-07-03 13:45:46

Replying to [ticket:20350 vbraun]:
> gcc-5 introduces a new cxx11 abi, and linking C++ libraries with different abi versions will cause missing `std::__cxx11` symbols like
> {{{
> undefined reference to `std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >::push_back(char)`@`GLIBCXX_3.4.21'
> }}}

GCC's newer libstdc++ comes (by default at least) with a _dual_ ABI, so there's no problem when older programs or libraries use the newer one (e.g. if we upgrade our GCC to 5.x or later and the system GCC is < 5.x).

\\

> This is an issue whenever we build our own gcc; Right now that means gcc-4.9.3 which only supports the old abi. So linking with any system C++ library will fail, and there are various optional libraries that packages test for and link when available.

The real problem arises from incompatibilites of (C++) libraries that expose functions whose signatures contain types like `std::string`, because the symbol names differ depending on whether the library was compiled using the old or the new ABI (same of course when compiling code _using_ such libraries).  This leads to linker errors _if a library and modules using it_ are compiled with different ABIs (but only if the modules _actually use_ such functions).

\\

> Also, gcc-5 system installations may default to the old abi (e.g. Fedora), so we can't just do a version check. [...]

Well, that's easy to figure out, and we can configure Sage's GCC (>= 5.x) accordingly: ;-)

```sh
GCC_CONFIGURE_CXX_ABI="--with-default-libstdcxx-abi="$(
($CXX -x c++ -S -o - - | awk '/.globl/{print $2!~/__cxx11/?"gcc4-compatible":"c++11"}') <<EOF
#include <string>
void foo(std::string s){}
EOF
)
```


\\

> Its clear that we must update our gcc to 5 if we ever want to be able to link to new-abi libraries. Then we could also match the abi by putting `-D_GLIBCXX_USE_CXX11_ABI=[0|1]` into the `CFLAGS`.

`CXXFLAGS` (if respected by a package) that is, but see above.


---

Comment by leif created at 2016-07-03 13:55:27

Replying to [comment:5 leif]:
> Replying to [ticket:20350 vbraun]:
> > Then we could also match the abi by putting `-D_GLIBCXX_USE_CXX11_ABI=[0|1]` into the `CFLAGS`.
> 
> `CXXFLAGS` (if respected by a package) that is, but see above.

In fact `CPPFLAGS`, since it changes the behavior of included system C++ headers.


---

Comment by mkoeppe created at 2021-08-26 02:52:04

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-08-26 02:52:04

outdated, should close


---

Comment by fbissey created at 2021-08-26 02:53:36

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2021-08-26 02:53:36

So old. But I remember that mess up.


---

Comment by mkoeppe created at 2021-09-02 18:48:47

Resolution: invalid
