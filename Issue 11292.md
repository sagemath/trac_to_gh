# Issue 11292: Maximal orders in QuaternionAlgebra of prime discriminant has a bug

archive/issues_011292.json:
```json
{
    "body": "Assignee: @craigcitro\n\nCC:  @tornaria\n\nKeywords: maximal order, quaternion algebra\n\nIn Sage 4.7 (and older) the following code enters an infinite loop:\n\n```python\nA.<i,j,k>=QuaternionAlgebra(17)\nO=A.maximal_order()\n```\n\nThe maximal_order() function is essentially a formula, except for when the prime (here 17) is 1 mod 8. In that case there is a mistake in how the formula ought to be.\n\nIt looks like the invariants as returned when starting from a Brandt module are in opposite order as when a QuaternionAlgebra is created by hand, and the code makes assumptions on that ordering.\n\nIssue created by migration from https://trac.sagemath.org/ticket/11464\n\n",
    "created_at": "2011-06-11T09:12:18Z",
    "labels": [
        "component: modular forms",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "Maximal orders in QuaternionAlgebra of prime discriminant has a bug",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11292",
    "user": "https://github.com/mmasdeu"
}
```
Assignee: @craigcitro

CC:  @tornaria

Keywords: maximal order, quaternion algebra

In Sage 4.7 (and older) the following code enters an infinite loop:

```python
A.<i,j,k>=QuaternionAlgebra(17)
O=A.maximal_order()
```

The maximal_order() function is essentially a formula, except for when the prime (here 17) is 1 mod 8. In that case there is a mistake in how the formula ought to be.

It looks like the invariants as returned when starting from a Brandt module are in opposite order as when a QuaternionAlgebra is created by hand, and the code makes assumptions on that ordering.

Issue created by migration from https://trac.sagemath.org/ticket/11464





---

archive/issue_comments_124336.json:
```json
{
    "body": "Attachment [trac_11464_fixed_maximal_order.patch](tarball://root/attachments/some-uuid/ticket11464/trac_11464_fixed_maximal_order.patch) by @mmasdeu created at 2011-06-11 09:16:03",
    "created_at": "2011-06-11T09:16:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11292#issuecomment-124336",
    "user": "https://github.com/mmasdeu"
}
```

Attachment [trac_11464_fixed_maximal_order.patch](tarball://root/attachments/some-uuid/ticket11464/trac_11464_fixed_maximal_order.patch) by @mmasdeu created at 2011-06-11 09:16:03



---

archive/issue_comments_124337.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-02-29T17:37:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11292#issuecomment-124337",
    "user": "https://github.com/mmasdeu"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_124338.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-03-13T09:25:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11292#issuecomment-124338",
    "user": "https://github.com/loefflerd"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_124339.json:
```json
{
    "body": "It is absurd that code in the general-purpose sage/algebras/quatalg module calls code in sage/modular/quatalg/brandt -- we should move `sage.modular.quatalg.brandt.maximal_order` -- but that is orthogonal to this ticket. Patch looks fine and fixes the bug.",
    "created_at": "2012-03-13T09:25:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11292#issuecomment-124339",
    "user": "https://github.com/loefflerd"
}
```

It is absurd that code in the general-purpose sage/algebras/quatalg module calls code in sage/modular/quatalg/brandt -- we should move `sage.modular.quatalg.brandt.maximal_order` -- but that is orthogonal to this ticket. Patch looks fine and fixes the bug.



---

archive/issue_comments_124340.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-03-21T22:04:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11292#issuecomment-124340",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_124341.json:
```json
{
    "body": "It looks like the new code can still produce incorrect results if p is 1 mod 8, e.g.:\n\n```\nsage: A.<i,j,k> = QuaternionAlgebra(17)\nsage: print A.invariants()\n(-3, -17)\nsage: R = A.maximal_order()\nsage: b = R.basis()\nsage: print b\n(1/2 + 1/2*j, 1/2*i + 1/2*k, -1/3*j - 1/3*k, k)\nsage: b[0]*b[1]\n9/2*i\nsage: (b[0]*b[1]).reduced_norm() \n243/4\n```\n\nso the \"order\" is not actually multiplicatively closed.\n\nThe problem is that Pizer's formulas expect the invariants of the algebra to have a certain form, e.g.,\n\n```\nsage: A.<i,j,k> = QuaternionAlgebra(-17,-3)\nsage: print A.maximal_order().basis()\n(1/2 + 1/2*j, 1/2*i + 1/2*k, -1/3*j - 1/3*k, k)\n```\n\nseems to be correct. This could be fixed by simply swapping (i,j) in the formula depending on the invariants, but the invariants can deviate from the required form in more than one way, again possibly resulting in failure of the formula:\n\n\n```\nsage: A,<i,j,k> = QuaternionAlgebra(-17*9,-3)\nsage: R = A.maximal_order()\nsage: print A.maximal_order().basis()\n(1/2 + 1/2*j, 1/2*i + 1/2*k, -1/3*j - 1/3*k, k)\nsage: print (-1/3*j - 1/3*k).reduced_norm()\n154/3\n```\n\n\nI'm not sure what the best way is to fix this: Just throw a NotImplementedError if the invariants are not of the required form or try to compute an isomorphism?\n\n(PS: I've almost finished implementing a more general algorithm of Voight that would also work for non-prime discriminants, so perhaps not too much effort should be expended on this)",
    "created_at": "2012-04-14T10:24:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11292#issuecomment-124341",
    "user": "https://github.com/dansme"
}
```

It looks like the new code can still produce incorrect results if p is 1 mod 8, e.g.:

```
sage: A.<i,j,k> = QuaternionAlgebra(17)
sage: print A.invariants()
(-3, -17)
sage: R = A.maximal_order()
sage: b = R.basis()
sage: print b
(1/2 + 1/2*j, 1/2*i + 1/2*k, -1/3*j - 1/3*k, k)
sage: b[0]*b[1]
9/2*i
sage: (b[0]*b[1]).reduced_norm() 
243/4
```

so the "order" is not actually multiplicatively closed.

The problem is that Pizer's formulas expect the invariants of the algebra to have a certain form, e.g.,

```
sage: A.<i,j,k> = QuaternionAlgebra(-17,-3)
sage: print A.maximal_order().basis()
(1/2 + 1/2*j, 1/2*i + 1/2*k, -1/3*j - 1/3*k, k)
```

seems to be correct. This could be fixed by simply swapping (i,j) in the formula depending on the invariants, but the invariants can deviate from the required form in more than one way, again possibly resulting in failure of the formula:


```
sage: A,<i,j,k> = QuaternionAlgebra(-17*9,-3)
sage: R = A.maximal_order()
sage: print A.maximal_order().basis()
(1/2 + 1/2*j, 1/2*i + 1/2*k, -1/3*j - 1/3*k, k)
sage: print (-1/3*j - 1/3*k).reduced_norm()
154/3
```


I'm not sure what the best way is to fix this: Just throw a NotImplementedError if the invariants are not of the required form or try to compute an isomorphism?

(PS: I've almost finished implementing a more general algorithm of Voight that would also work for non-prime discriminants, so perhaps not too much effort should be expended on this)
