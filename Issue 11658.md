# Issue 11658: Problems with Mercurial and utf-8 data in files

Issue created by migration from https://trac.sagemath.org/ticket/11830

Original creator: jdemeyer

Original creation time: 2011-09-22 14:25:22

Using sage-4.7.2.alpha2 and the hg shipped with Sage, I cannot push the patch [http://trac.sagemath.org/sage_trac/attachment/ticket/11820/trac_11820_undo_4777.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/11820/trac_11820_undo_4777.patch) because the username contains utf-8 non-ASCII characters:


```
$ hg qpush
applying trac_11820_undo_4777.patch
transaction abort!
rollback completed
cleaning up working directory...done
abort: decoding near 'AndrÃ© Apitzsc': 'ascii' codec can't decode byte 0xc3 in position 4: ordinal not in range(128)!
```


A solution is to set `HGENCODING=utf8` in `sage-env`.


---

Attachment

Patch to the SCRIPTS repository (local/bin)


---

Comment by jdemeyer created at 2011-09-22 14:28:43

Changing status from new to needs_review.


---

Comment by leif created at 2011-09-22 15:47:41

Oh yes, this seems to catch all situations where we could run into this.

(We would have had to change the Sage library's `hg_*` commands as well if we only changed e.g. `sage-sage`.)

Will test this later.




P.S:: The commit message lacks a ticket number... ;-)


---

Comment by jdemeyer created at 2011-09-22 19:29:32

Replying to [comment:2 leif]:
> P.S:: The commit message lacks a ticket number... ;-)

True, but a while ago it was decided that ticket numbers were no longer required on commit messages.  Ticket numbers are added automatically by my merger script.  This simplifies the work of the release manager, who no longer has to complain about missing ticket numbers.  It also ensures a common formatting for the ticket number: the commit message always starts with "Trac #${TICKET_NUMBER}: " which might be useful for scripts.


---

Comment by leif created at 2011-09-22 23:08:02

Replying to [comment:3 jdemeyer]:
> Replying to [comment:2 leif]:
> > P.S:: The commit message lacks a ticket number... ;-)
> 
> True, but a while ago it was decided that ticket numbers were no longer required on commit messages.

Perhaps my bad, I'm not aware of such an agreement, but I strongly object.




> Ticket numbers are added automatically by my merger script.

As I already said elsewhere, this ignores the fact that there's sometimes a tiny period of time between when a patch gets attached to a ticket and when it gets merged into a release (and this release published).




> This simplifies the work of the release manager, who no longer has to complain about missing ticket numbers.

Well, he/she doesn't have to; reviewers IMHO should. Same for _filenames_ of patches _not_ containing the ticket number.

(Btw., also the patchbot could complain about things like these, including missing or misspelled author and reviewer names on a ticket.)




> It also ensures a common formatting for the ticket number: the commit message always starts with "Trac #${TICKET_NUMBER}: " which might be useful for scripts.

That's just a matter of how smart the scripts are, including the merge scripts themselves.

Besides that I don't like that long form; I also noticed that a couple of commit messages get this prepended despite already containing the ticket number, or even starting with it (which they IMHO always should, since a commit message might reference other tickets as well).

If you want a _unique_ form (which I'd consider unnecessary because scripts can easily recognize different, preferably nevertheless standardized variants), at least ticket numbers shouldn't get duplicated in the commit messages.


---

Comment by jdemeyer created at 2011-09-23 06:52:56

Replying to [comment:4 leif]:
> As I already said elsewhere, this ignores the fact that there's sometimes a tiny period of time between when a patch gets attached to a ticket and when it gets merged into a release (and this release published).
And why is this a problem?

Replying to [comment:4 leif]:
> I'm not aware of such an agreement, but I strongly object.
It was suggested by other people and I implemented it, see [https://groups.google.com/forum/#!msg/sage-devel/9anAEvYpmp4/3PJ67hvJA_YJ](https://groups.google.com/forum/#!msg/sage-devel/9anAEvYpmp4/3PJ67hvJA_YJ)

I certainly see more advantages than disadvantages to this so I would like to keep this convention.  I you want to discuss it further, it should probably be done on `sage-devel`.


---

Comment by leif created at 2011-09-24 12:12:49

Changing status from needs_review to positive_review.


---

Comment by leif created at 2011-09-24 12:20:26

Just to work around some deficiency of my current script...


---

Comment by leif created at 2011-09-27 17:39:18

Resolution: fixed
