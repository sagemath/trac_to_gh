# Issue 23986: py3: several string conversion fixes

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2017-11-16 11:44:24

CC:  chapoton jdemeyer

This fixes several (hardly exhaustive) string conversions around Sage such that functions and methods that returned `str` on Python 2 also return `str` on Python 3 (and the same for functions and methods that take `str` as arguments) using the new string utilities from #24222.

This also incorporates/replaces the fixes from #23812.


---

Comment by embray created at 2017-11-16 11:45:34

With this, plus a few other small fixes (including fixes from other existing tickets merged in) I was able to get the Sage REPL up and `1 + 1` working.


---

Comment by git created at 2017-11-20 09:19:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-11-20 09:21:05

Changing status from new to needs_review.


---

Comment by embray created at 2017-11-20 09:21:05

Rebased on current version of #24222.


---

Comment by jdemeyer created at 2017-11-20 19:08:59

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-11-20 19:08:59

Something is wrong: there are still the files `src/sage/misc/string.*`


---

Comment by jdemeyer created at 2017-11-20 19:14:49

This is again a ticket with many small independent changes where a "partial positive review" like what I proposed on #24025 would make sense. I didn't like how we handled that, so how should we proceed here?


---

Comment by embray created at 2017-11-21 16:58:54

Replying to [comment:4 jdemeyer]:
> Something is wrong: there are still the files `src/sage/misc/string.*`

Oops--part of the problem here is I'm moving between two different working trees, one for Python 2 and one for Python 3, so it can get confusing.  I'll clean this up.


---

Comment by embray created at 2017-11-21 16:59:50

Replying to [comment:5 jdemeyer]:
> This is again a ticket with many small independent changes where a "partial positive review" like what I proposed on #24025 would make sense. I didn't like how we handled that, so how should we proceed here?

I'd be fine if you proposed your changes and tossed it back to me as "needs review", rather than going immediately to "positive review".


---

Comment by jdemeyer created at 2017-11-22 14:29:26

It seems strange to me to use `locale.getpreferredencoding()` for strings which do not depend on the locale. I would propose:

1. Use `locale.getpreferredencoding()` for strings which actually depend on the locale.

2. Use `sys.getfilesystemencoding()` for strings which actually depend on the file system encoding.

3. Use UTF-8 otherwise.


---

Comment by git created at 2017-12-21 11:14:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-12-21 11:20:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-12-27 19:20:20

Is this needs_review again?


---

Comment by embray created at 2018-01-02 14:37:25

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-01-02 14:37:25

Yeah, IIRC this was just a bunch of miscellaneous string conversions from some other tickets, but redone using the `sage.cpython.string` utilities.


---

Comment by chapoton created at 2018-01-03 12:43:51

3 failing doctests in integer.pyx


---

Comment by jdemeyer created at 2018-01-05 08:58:44

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-01-05 12:23:54

Interesting--when I added `str_to_bytes` I predicted we might later want to allow Python 2 `unicode` objects to be supported somehow, but put it off because I didn't think there was much code in Sage that already was expected to handle `unicode` (except in a few places like unicode art, etc.).  But the tests that are failing here clearly show that there are some places it's expected to work.

So I see at least three options:

1. Modify `str_to_bytes` to treat `unicode` appropriate on Python 2
2. Add some new function like `unicode_to_str` that's analogous to `str_to_bytes` (I'm not crazy about this)
3. Just special case `unicode` on Python 2 where we do want to support it.

I lean towards 1. but I'm open to ideas.


---

Comment by jdemeyer created at 2018-01-05 12:31:55

Replying to [comment:16 embray]:
> I lean towards 1.

I agree. We should just support `bytes` and `unicode` (in the Cython sense!) as input to `str_to_bytes` regardless of Python version. One complication is that the Python 3 code path of `str_to_bytes` uses some functions specific to Python 3, so we cannot just run that code on Python 2.


---

Comment by embray created at 2018-01-05 12:37:48

Right, I'll give it a look though.  It will just have to have a slightly different implementation for Python 2.  Welcome back btw!


---

Comment by jdemeyer created at 2018-01-05 12:43:12

I created a new ticket for this: #24475


---

Comment by jdemeyer created at 2018-01-05 12:46:21

Replying to [comment:18 embray]:
> Right, I'll give it a look though.  It will just have to have a slightly different implementation for Python 2.

I would rather avoid that. Instead of `PyUnicode_EncodeLocale`, you can just pass `NULL` as `encoding` to `PyUnicode_AsEncodedString`. That leaves `PyUnicode_AsUTF8` which is really only used to translate the `encoding` and `errors` arguments. We could require that this is always of type `str` (so, not `unicode` on Python 2).


---

Comment by jdemeyer created at 2018-01-05 12:46:46

Replying to [comment:18 embray]:
> I'll give it a look though.

I can also do that. Just let me know, to avoid double work.


---

Comment by git created at 2018-01-10 14:21:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2018-01-15 19:58:15

is this in "needs_review" state ?


---

Comment by git created at 2018-01-17 15:34:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-01-17 15:34:29

Changing status from needs_work to needs_review.


---

Comment by git created at 2018-01-19 15:41:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-01-22 13:55:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2018-01-23 17:06:37

Looks good to me, globally, even if do not feel I understand everything in detail.

Jeroen, do you think we can move forward with this important ticket ?


---

Comment by jdemeyer created at 2018-01-23 19:43:05

I always find it a bit unpleasant to review tickets with non-merged dependencies. So I would rather wait until the next beta.

Two immediate issues that I see:

1. In `src/sage/libs/mpmath/utils.pyx` you add an import that you don't use.

2. In several files, you `import` stuff from `sage.cpython.string` where you could use `cimport`.


---

Comment by chapoton created at 2018-01-28 07:59:44

New commits:


---

Comment by git created at 2018-01-28 08:03:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2018-01-29 13:53:09

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-01-30 12:22:46

This does not work:


```
-from sage.cpython.string import FS_ENCODING, str_to_bytes
+from sage.cpython.string cimport FS_ENCODING, str_to_bytes
```


`FS_ENCODING` is can't be cimported.


---

Comment by embray created at 2018-01-30 12:22:46

Changing status from positive_review to needs_work.


---

Comment by git created at 2018-01-30 14:11:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-01-30 14:12:10

import corrected


---

Comment by chapoton created at 2018-01-30 14:12:10

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-01-30 14:38:18

I rebased and squashed some of these changes.
----
New commits:


---

Comment by embray created at 2018-01-30 14:38:18

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-01-31 21:40:54


```
[sagelib-8.2.beta4] Error compiling Cython file:
[sagelib-8.2.beta4] ------------------------------------------------------------
[sagelib-8.2.beta4] ...
[sagelib-8.2.beta4] from sage.rings.finite_rings.finite_field_prime_modn import FiniteField_prime_modn
[sagelib-8.2.beta4] from sage.rings.finite_rings.finite_field_givaro import FiniteField_givaro
[sagelib-8.2.beta4] from sage.rings.finite_rings.finite_field_ntl_gf2e import FiniteField_ntl_gf2e
[sagelib-8.2.beta4] from sage.libs.pari.all import pari
[sagelib-8.2.beta4] from sage.libs.gmp.all cimport *
[sagelib-8.2.beta4] from sage.cpython.string cimport FS_ENCODING, str_to_bytes
[sagelib-8.2.beta4] ^
[sagelib-8.2.beta4] ------------------------------------------------------------
[sagelib-8.2.beta4] 
[sagelib-8.2.beta4] sage/libs/singular/singular.pyx:40:0: 'sage/cpython/string/FS_ENCODING.pxd' not found
[sagelib-8.2.beta4] 
[sagelib-8.2.beta4] Error compiling Cython file:
[sagelib-8.2.beta4] ------------------------------------------------------------
[sagelib-8.2.beta4] ...
[sagelib-8.2.beta4]     lib = SINGULAR_SO
[sagelib-8.2.beta4] 
[sagelib-8.2.beta4]     if not os.path.exists(lib):
[sagelib-8.2.beta4]         raise ImportError("cannot locate Singular library ({})".format(lib))
[sagelib-8.2.beta4] 
[sagelib-8.2.beta4]     lib = str_to_bytes(lib, FS_ENCODING, "surrogateescape")
[sagelib-8.2.beta4]                            ^
[sagelib-8.2.beta4] ------------------------------------------------------------
[sagelib-8.2.beta4] 
[sagelib-8.2.beta4] sage/libs/singular/singular.pyx:778:28: 'FS_ENCODING' is not a constant, variable or function identifier
[sagelib-8.2.beta4] Traceback (most recent call last):
[sagelib-8.2.beta4]   File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/Cython/Build/Dependencies.py", line 1179, in cythonize_one_helper
[sagelib-8.2.beta4]     return cythonize_one(*m)
[sagelib-8.2.beta4]   File "/home/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/Cython/Build/Dependencies.py", line 1161, in cythonize_one
[sagelib-8.2.beta4]     raise CompileError(None, pyx_file)
[sagelib-8.2.beta4] CompileError: sage/libs/singular/singular.pyx
```



---

Comment by vbraun created at 2018-01-31 21:40:54

Changing status from positive_review to needs_work.


---

Comment by chapoton created at 2018-02-01 07:12:27

Volker, did you use the latest branch ?


---

Comment by embray created at 2018-02-01 12:25:45

Changing status from needs_work to positive_review.


---

Comment by embray created at 2018-02-01 12:25:45

He didn't.  Setting this back to positive review since this otherwise fixes Jeroen's issue.


---

Comment by vbraun created at 2018-02-02 12:06:05

Resolution: fixed
