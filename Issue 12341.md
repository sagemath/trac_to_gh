# Issue 12341: Slow CDF fast_callable powers

Issue created by migration from Trac.

Original creator: robertwb

Original creation time: 2012-02-15 10:40:12

Assignee: jason, jkantor

CC:  jason

Before


```
sage: var('x,y')
(x, y)
sage: f = (sum(x^k for k in [-10..10]) * sum(y^k for k in [-10..10])).expand()
sage: ff = fast_callable(f, CDF, (x,y))
sage: %timeit ff(1+2j, 3+4j)
125 loops, best of 3: 4.53 ms per loop
sage: len(ff.python_calls())
756
sage: ff.python_calls()[:10]
[(^10), (^10), (^10), (^9), (^9), (^10), (^10), (^8), (^9), (^9)]
```


which is still better than 


```
sage: %timeit f(x=1+2j, y=3+4j)
25 loops, best of 3: 12 ms per loop
```


but nowhere close to 


```
sage: var('x,y')
(x, y)
sage: f = (sum(x^k for k in [-10..10]) * sum(y^k for k in [-10..10])).expand()
sage: ff = fast_callable(f, CDF, (x,y))
sage: %timeit ff(1+2j, 3+4j)
625 loops, best of 3: 127 Âµs per loop
sage: len(ff.python_calls())
0
sage: 4.53 / .127
35.6692913385827
```



---

Comment by robertwb created at 2012-02-15 10:45:05

Changing type from PLEASE CHANGE to enhancement.


---

Comment by robertwb created at 2012-02-15 10:45:05

Changing status from new to needs_review.


---

Comment by robertwb created at 2012-10-24 07:04:37

Apply only 12513-cdf-pow-5.4.patch


---

Comment by jason created at 2012-10-24 07:33:52

`default` is misspelled in the patch in one of the case statements (it's spelled as `defualt`).


---

Comment by robertwb created at 2012-10-24 17:23:43

Oops. Crazily enough, it interprets that as a label (so no compile error) and falls through to the base case (which also give the correct result, albeit slower).


---

Attachment

apply only this patch


---

Comment by robertwb created at 2012-10-24 17:39:12

Added some explicit tests of this codepath.


---

Comment by jason created at 2012-10-24 17:44:49

Ah, I was wondering how it could compile.  I guess you could have added a goto just to round it out :).

How does it know that the defualt: starts the base case?  Are you sure it falls through to that?  According to http://msdn.microsoft.com/en-us/library/66k51h7a(v=vs.80).aspx (Microsoft, I know...), for example, it seems that the default code would *not* be executed, "If the default statement is omitted, and no case match is found, none of the statements in the switch body are executed."


---

Comment by robertwb created at 2012-10-24 21:51:13

The "defualt" statement was not executed, so it falls all the way down to the last line `return cpow(z, exp)`.


---

Comment by jason created at 2012-10-24 23:35:34

Oh, right.  I thought you meant the base case for the switch statement.


---

Comment by tkluck created at 2012-10-28 13:00:19

This looks excellent. I haven't tried the patch yet, but I noticed that you hard-code the integer range:

```
# supported for exponents that fit in an int 
self.ipow_range = (int(-2**31), int(2**31-1)) 
```

I'm not sure how platform independent that is. I think there's a preprocessor macro like `MAX_INT` or something. That's probably worth looking into.


---

Comment by robertwb created at 2012-10-29 18:56:00

Thanks for taking a look. Yes, INT_MAX is defined in stdint.c, but this is Python. (Note that sys.maxint is the wrong thing to use here, as that's the max value of a long.) The C standard mandates at least 16 bits, but I don't know of any (modern) processors that have less than 32-bit ints (including mobile processors like ARM).

Really, it's just the same bounds that are being used elsewhere in this file.


---

Comment by tkluck created at 2012-10-29 19:27:35

Changing status from needs_review to positive_review.


---

Comment by tkluck created at 2012-10-29 19:27:35

If there's no way in Cython to get the integer range, then I guess we should just leave it like this. I've tested the patch and it works as advertised. The doctests work, too. I'll give this a positive review.


---

Comment by jdemeyer created at 2012-11-01 09:43:55

Using the C99 constant `I` isn't as portable as it should be, it doesn't work on Solaris and OpenSolaris.  I'll try a few things...


---

Comment by jdemeyer created at 2012-11-01 09:54:29

Changing status from positive_review to needs_work.


---

Attachment


---

Comment by jdemeyer created at 2012-11-01 10:16:18

Changing status from needs_work to needs_review.


---

Comment by robertwb created at 2012-11-01 23:05:43

"isn't as portable as it should be" yeah, it's a pretty basic part of the standard. It's sad when standard compliant code != portable code.

I assume you've tested this on solaris? If so, looks good to me. (Probably wouldn't hurt to have a solaris patchbot running...)


---

Comment by jdemeyer created at 2012-11-01 23:09:22

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-11-06 22:21:48

Resolution: fixed
