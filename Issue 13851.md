# Issue 13851: Fix sage-cleaner

archive/issues_013851.json:
```json
{
    "body": "Assignee: @nexttime\n\nCC:  @ppurka @nbruin\n\n`sage-cleaner` got completely broken due to incompatible filenames between `sage-cleaner` and the Sage library.\n\nIssue created by migration from https://trac.sagemath.org/ticket/14055\n\n",
    "created_at": "2013-02-04T16:43:49Z",
    "labels": [
        "scripts",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.10",
    "title": "Fix sage-cleaner",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13851",
    "user": "@jdemeyer"
}
```
Assignee: @nexttime

CC:  @ppurka @nbruin

`sage-cleaner` got completely broken due to incompatible filenames between `sage-cleaner` and the Sage library.

Issue created by migration from https://trac.sagemath.org/ticket/14055





---

archive/issue_comments_172205.json:
```json
{
    "body": "I am working on a patch.",
    "created_at": "2013-02-04T16:44:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172205",
    "user": "@jdemeyer"
}
```

I am working on a patch.



---

archive/issue_comments_172206.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-02-04T21:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172206",
    "user": "@jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_172207.json:
```json
{
    "body": "In the line\n\n```\npidfile = os.path.join(DOT_SAGE, 'tmp', 'cleaner-%s.pid'%HOSTNAME)\n```\n\nwould it make sense to use `'temp'` instead of `'tmp'`, so all of the sage-cleaner information is in the same directory?\n\n(Is there any good reason for having both directories `tmp` and `temp`? At some point, we should clean this up.)",
    "created_at": "2013-03-20T15:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172207",
    "user": "@jhpalmieri"
}
```

In the line

```
pidfile = os.path.join(DOT_SAGE, 'tmp', 'cleaner-%s.pid'%HOSTNAME)
```

would it make sense to use `'temp'` instead of `'tmp'`, so all of the sage-cleaner information is in the same directory?

(Is there any good reason for having both directories `tmp` and `temp`? At some point, we should clean this up.)



---

archive/issue_comments_172208.json:
```json
{
    "body": "THERE ARE STILL SOME INSTANCES OF UPPERCASE SAGE.\n\nI don't like the mixture of tmp, temp, TMP and TEMP or whatever.\n\n\n\n\n`temp` and `tmp` shouldn't be hardcoded.\n\n\"Deleting `.../spawned_processes`\" gets printed even if `.../spawned_processes` is not a directory (`not e`), and also `rmtree()` is attempted, ignoring any `OSError`.\n\n\n\n\nI don't like `\"%s\" % i` where `i` is (or should be) an `int`. \n\n\n\n\nCommand line option handling is certainly suboptimal.  (`argv[1]` could be a `float` as well, there's no usage, and additional parameters simply get ignored.)\n\nLikewise, if `DOT_SAGE` isn't set, an ugly `KeyError` is raised, instead of printing a meaningful message.",
    "created_at": "2013-03-20T15:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172208",
    "user": "@nexttime"
}
```

THERE ARE STILL SOME INSTANCES OF UPPERCASE SAGE.

I don't like the mixture of tmp, temp, TMP and TEMP or whatever.




`temp` and `tmp` shouldn't be hardcoded.

"Deleting `.../spawned_processes`" gets printed even if `.../spawned_processes` is not a directory (`not e`), and also `rmtree()` is attempted, ignoring any `OSError`.




I don't like `"%s" % i` where `i` is (or should be) an `int`. 




Command line option handling is certainly suboptimal.  (`argv[1]` could be a `float` as well, there's no usage, and additional parameters simply get ignored.)

Likewise, if `DOT_SAGE` isn't set, an ugly `KeyError` is raised, instead of printing a meaningful message.



---

archive/issue_comments_172209.json:
```json
{
    "body": "Changing keywords from \"\" to \"orphans\".",
    "created_at": "2013-03-20T15:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172209",
    "user": "@nexttime"
}
```

Changing keywords from "" to "orphans".



---

archive/issue_comments_172210.json:
```json
{
    "body": "Ooops.",
    "created_at": "2013-03-20T15:47:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172210",
    "user": "@nexttime"
}
```

Ooops.



---

archive/issue_comments_172211.json:
```json
{
    "body": "Leif: the subject of this ticket is not \"Fix all possible issues in sage-cleaner\", the goal is to just make it work.",
    "created_at": "2013-03-20T16:56:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172211",
    "user": "@jdemeyer"
}
```

Leif: the subject of this ticket is not "Fix all possible issues in sage-cleaner", the goal is to just make it work.



---

archive/issue_comments_172212.json:
```json
{
    "body": "Replying to [comment:4 jhpalmieri]:\n> Is there any good reason for having both directories `tmp` and `temp`?\nAbsolutely not, but at least the directory used in `sage-cleaner` should match the directory used in the Sage library.",
    "created_at": "2013-03-20T16:57:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172212",
    "user": "@jdemeyer"
}
```

Replying to [comment:4 jhpalmieri]:
> Is there any good reason for having both directories `tmp` and `temp`?
Absolutely not, but at least the directory used in `sage-cleaner` should match the directory used in the Sage library.



---

archive/issue_comments_172213.json:
```json
{
    "body": "I am having a problem with this patch, but I don't know why. I am repeatedly running `sage -tp 2 devel/sage/sage/homology/s*`. Without the patch applied, everything is fine. With the patch, after the first successful run, I get this (I also removed the `&>/dev/null` after the call to `sage-cleaner` in `spkg/bin/sage`):\n\n```\n$ sage -tp 2 devel/sage/sage/homology/s*\nSAGE_TMP_ROOT = /Users/palmieri/.sage/temp/jpalmieri538\nStarting sage-cleaner\nChecking PIDs []\nsage-cleaner is finished\nRunning doctests with ID 2013-03-20-11-16-30-613ad8e5.\nSorting sources by runtime so that slower doctests are run first....\nDoctesting 3 files using 2 threads.\nsage -t devel/sage/sage/homology/simplicial_complex_morphism.py\n    [187 tests, 0.3 s]\nsage -t devel/sage/sage/homology/simplicial_complex_homset.py\n    [49 tests, 0.1 s]\nsage -t devel/sage/sage/homology/simplicial_complex.py\n    Time out after testing finished\n**********************************************************************\nTests run before process timed out:\n\n...\n\n**********************************************************************\n----------------------------------------------------------------------\nsage -t devel/sage/sage/homology/simplicial_complex.py  # Time out after testing finished\n----------------------------------------------------------------------\nTotal time for all tests: 26.9 seconds\n    cpu time: 0.4 seconds\n    cumulative wall time: 0.5 seconds\n```\n\nWithout the patch, the file `simplicial_complex.py` passes tests in under 7 seconds; cpu time and cumulative wall time are each around 6 or 7 seconds. With the patch, the time out is pretty consistent for each run after the first. I'm seeing this on two different OS X 10.8 machines.\n\nAlso, if I delete the directory `DOT_SAGE/tmp`, then the pidfile won't get written at all during doctesting or when running sage. What script is responsible for creating that directory? If this directory is missing, I don't get the time-out any more, so the problem is really with sage-cleaner.\n\nOn the bright side, it seems to be cleaning out the appropriate files, directories, and processes.",
    "created_at": "2013-03-20T18:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172213",
    "user": "@jhpalmieri"
}
```

I am having a problem with this patch, but I don't know why. I am repeatedly running `sage -tp 2 devel/sage/sage/homology/s*`. Without the patch applied, everything is fine. With the patch, after the first successful run, I get this (I also removed the `&>/dev/null` after the call to `sage-cleaner` in `spkg/bin/sage`):

```
$ sage -tp 2 devel/sage/sage/homology/s*
SAGE_TMP_ROOT = /Users/palmieri/.sage/temp/jpalmieri538
Starting sage-cleaner
Checking PIDs []
sage-cleaner is finished
Running doctests with ID 2013-03-20-11-16-30-613ad8e5.
Sorting sources by runtime so that slower doctests are run first....
Doctesting 3 files using 2 threads.
sage -t devel/sage/sage/homology/simplicial_complex_morphism.py
    [187 tests, 0.3 s]
sage -t devel/sage/sage/homology/simplicial_complex_homset.py
    [49 tests, 0.1 s]
sage -t devel/sage/sage/homology/simplicial_complex.py
    Time out after testing finished
**********************************************************************
Tests run before process timed out:

...

**********************************************************************
----------------------------------------------------------------------
sage -t devel/sage/sage/homology/simplicial_complex.py  # Time out after testing finished
----------------------------------------------------------------------
Total time for all tests: 26.9 seconds
    cpu time: 0.4 seconds
    cumulative wall time: 0.5 seconds
```

Without the patch, the file `simplicial_complex.py` passes tests in under 7 seconds; cpu time and cumulative wall time are each around 6 or 7 seconds. With the patch, the time out is pretty consistent for each run after the first. I'm seeing this on two different OS X 10.8 machines.

Also, if I delete the directory `DOT_SAGE/tmp`, then the pidfile won't get written at all during doctesting or when running sage. What script is responsible for creating that directory? If this directory is missing, I don't get the time-out any more, so the problem is really with sage-cleaner.

On the bright side, it seems to be cleaning out the appropriate files, directories, and processes.



---

archive/issue_comments_172214.json:
```json
{
    "body": "Maybe the problem is that `time.sleep(wait + 3)` used to be called before the first call to `cleanup()`, and now it's not. So now `cleanup()` can be called before any doctesting processes have started, so it returns zero, so sage-cleaner thinks there is nothing to be cleaned up and exits right away. I'm not sure why that results in a timeout in the doctesting, but anyway, this change fixes the problem for me:\n\n```diff\ndiff --git a/sage-cleaner b/sage-cleaner\n--- a/sage-cleaner\n+++ b/sage-cleaner\n@@ -115,6 +115,7 @@\n         else:\n             wait = 10\n     \n+        time.sleep(wait)\n         # Initial cleanup, ignore time\n         running_sages = cleanup()\n         cleanup_time = 0.0\n```\n\nI don't know if the initial sleep should be for `wait` or a smaller number. Does it matter?",
    "created_at": "2013-03-20T20:08:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172214",
    "user": "@jhpalmieri"
}
```

Maybe the problem is that `time.sleep(wait + 3)` used to be called before the first call to `cleanup()`, and now it's not. So now `cleanup()` can be called before any doctesting processes have started, so it returns zero, so sage-cleaner thinks there is nothing to be cleaned up and exits right away. I'm not sure why that results in a timeout in the doctesting, but anyway, this change fixes the problem for me:

```diff
diff --git a/sage-cleaner b/sage-cleaner
--- a/sage-cleaner
+++ b/sage-cleaner
@@ -115,6 +115,7 @@
         else:
             wait = 10
     
+        time.sleep(wait)
         # Initial cleanup, ignore time
         running_sages = cleanup()
         cleanup_time = 0.0
```

I don't know if the initial sleep should be for `wait` or a smaller number. Does it matter?



---

archive/issue_comments_172215.json:
```json
{
    "body": "Replying to [comment:8 jdemeyer]:\n> Replying to [comment:4 jhpalmieri]:\n> > Is there any good reason for having both directories `tmp` and `temp`?\n> Absolutely not, but at least the directory used in `sage-cleaner` should match the directory used in the Sage library.\n\nWhere is `DOTSAGE/tmp` used? Certainly the `temp` version is used in the definition of `SAGE_TMP`, so that is ubiquitous. For the file `cleaner-HOSTNAME.pid`, is that referenced anywhere in the Sage library? It looks like we could put that file in `temp` instead of `tmp` safely. Indeed, I can't find any other references to `DOTSAGE/tmp`...",
    "created_at": "2013-03-20T20:37:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172215",
    "user": "@jhpalmieri"
}
```

Replying to [comment:8 jdemeyer]:
> Replying to [comment:4 jhpalmieri]:
> > Is there any good reason for having both directories `tmp` and `temp`?
> Absolutely not, but at least the directory used in `sage-cleaner` should match the directory used in the Sage library.

Where is `DOTSAGE/tmp` used? Certainly the `temp` version is used in the definition of `SAGE_TMP`, so that is ubiquitous. For the file `cleaner-HOSTNAME.pid`, is that referenced anywhere in the Sage library? It looks like we could put that file in `temp` instead of `tmp` safely. Indeed, I can't find any other references to `DOTSAGE/tmp`...



---

archive/issue_comments_172216.json:
```json
{
    "body": "I've applied this patch to SAGE_ROOT/local/bin, ran \"make ptestlong\" and still got two ecl processes eating RAM when tests were finished without errors.",
    "created_at": "2013-03-20T21:27:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172216",
    "user": "@novoselt"
}
```

I've applied this patch to SAGE_ROOT/local/bin, ran "make ptestlong" and still got two ecl processes eating RAM when tests were finished without errors.



---

archive/issue_comments_172217.json:
```json
{
    "body": "jhpalmieri: I can totally reproduce problems with `devel/sage/sage/homology/simplicial_complex.py`, but they are different from yours and unrelated to `sage-cleaner`: #14323.",
    "created_at": "2013-03-20T21:54:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172217",
    "user": "@jdemeyer"
}
```

jhpalmieri: I can totally reproduce problems with `devel/sage/sage/homology/simplicial_complex.py`, but they are different from yours and unrelated to `sage-cleaner`: #14323.



---

archive/issue_comments_172218.json:
```json
{
    "body": "If you look at the output from the doctest command, I find it suspicious that the message \"sage-cleaner is finished\" appears before any doctests are run.",
    "created_at": "2013-03-20T22:04:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172218",
    "user": "@jhpalmieri"
}
```

If you look at the output from the doctest command, I find it suspicious that the message "sage-cleaner is finished" appears before any doctests are run.



---

archive/issue_comments_172219.json:
```json
{
    "body": "Replying to [comment:14 jhpalmieri]:\n> I find it suspicious that the message \"sage-cleaner is finished\" appears before any doctests are run.\nSure, but I don't see how that could lead to doctest failures. It could be that your problem is also an instance of #14323, let's first fix that.",
    "created_at": "2013-03-20T22:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172219",
    "user": "@jdemeyer"
}
```

Replying to [comment:14 jhpalmieri]:
> I find it suspicious that the message "sage-cleaner is finished" appears before any doctests are run.
Sure, but I don't see how that could lead to doctest failures. It could be that your problem is also an instance of #14323, let's first fix that.



---

archive/issue_comments_172220.json:
```json
{
    "body": "Replying to [comment:10 jhpalmieri]:\n> Maybe the problem is that `time.sleep(wait + 3)` used to be called before the first call to `cleanup()`, and now it's not. So now `cleanup()` can be called before any doctesting processes have started, so it returns zero, so sage-cleaner thinks there is nothing to be cleaned up and exits right away.\n> [...]\n> I don't know if the initial sleep should be for `wait` or a smaller number. Does it matter?\n\nI wouldn't rely on some wall time.\n\nUnfortunately the cleaner cannot `wait()` for its parent, but it could poll whether it is still running (or -- much better I think -- wait for another signal), and do nothing until its parent has \"vanished\" (terminated, and no other process with the same PID is meanwhile running -- that's also a potential, although probably unlikely, problem with left-over Sage cleaner and `spawned_processes` PID files; in the latter case, even unrelated processes of the same user could get killed.)\n\nIf there's already another Sage cleaner instance running, it could of course exit immediately (modulo the problem mentioned before).",
    "created_at": "2013-03-20T22:13:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172220",
    "user": "@nexttime"
}
```

Replying to [comment:10 jhpalmieri]:
> Maybe the problem is that `time.sleep(wait + 3)` used to be called before the first call to `cleanup()`, and now it's not. So now `cleanup()` can be called before any doctesting processes have started, so it returns zero, so sage-cleaner thinks there is nothing to be cleaned up and exits right away.
> [...]
> I don't know if the initial sleep should be for `wait` or a smaller number. Does it matter?

I wouldn't rely on some wall time.

Unfortunately the cleaner cannot `wait()` for its parent, but it could poll whether it is still running (or -- much better I think -- wait for another signal), and do nothing until its parent has "vanished" (terminated, and no other process with the same PID is meanwhile running -- that's also a potential, although probably unlikely, problem with left-over Sage cleaner and `spawned_processes` PID files; in the latter case, even unrelated processes of the same user could get killed.)

If there's already another Sage cleaner instance running, it could of course exit immediately (modulo the problem mentioned before).



---

archive/issue_comments_172221.json:
```json
{
    "body": "I also get the same problem with `devel/sage/sage/homology/examples.py`, but that file uses libGAP, too. If I doctest both of these, I only get a failure in `examples.py`, while the other passes doctests. Adding my patch from [comment:10 my comment above] makes the failures go away. I'm still not sure if these problems are related to #14323 or not. If they are, then at least I can reliably produce the failures, and maybe that will help to track them down.",
    "created_at": "2013-03-20T22:20:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172221",
    "user": "@jhpalmieri"
}
```

I also get the same problem with `devel/sage/sage/homology/examples.py`, but that file uses libGAP, too. If I doctest both of these, I only get a failure in `examples.py`, while the other passes doctests. Adding my patch from [comment:10 my comment above] makes the failures go away. I'm still not sure if these problems are related to #14323 or not. If they are, then at least I can reliably produce the failures, and maybe that will help to track them down.



---

archive/issue_comments_172222.json:
```json
{
    "body": "In case it helps, I can duplicate this problem on bsd.math.washington.edu.",
    "created_at": "2013-03-21T01:25:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172222",
    "user": "@jhpalmieri"
}
```

In case it helps, I can duplicate this problem on bsd.math.washington.edu.



---

archive/issue_comments_172223.json:
```json
{
    "body": "John: please check whether the new spkg at #14323 fixes your problem.",
    "created_at": "2013-03-21T10:49:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172223",
    "user": "@jdemeyer"
}
```

John: please check whether the new spkg at #14323 fixes your problem.



---

archive/issue_comments_172224.json:
```json
{
    "body": "Replying to [comment:18 jhpalmieri]:\n> In case it helps, I can duplicate this problem on bsd.math.washington.edu.\nI can indeed reproduce the problem and #14323 doesn't help.",
    "created_at": "2013-03-21T11:37:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172224",
    "user": "@jdemeyer"
}
```

Replying to [comment:18 jhpalmieri]:
> In case it helps, I can duplicate this problem on bsd.math.washington.edu.
I can indeed reproduce the problem and #14323 doesn't help.



---

archive/issue_comments_172225.json:
```json
{
    "body": "On boxen, with the spkg from #14323, I see that the issue from that ticket seems to be fixed, but then I can reproduce the issue here.",
    "created_at": "2013-03-21T18:02:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172225",
    "user": "@jhpalmieri"
}
```

On boxen, with the spkg from #14323, I see that the issue from that ticket seems to be fixed, but then I can reproduce the issue here.



---

archive/issue_comments_172226.json:
```json
{
    "body": "I found the problem with `expect.py`: the doctest process starts the `sage-cleaner`, somehow leading to trouble.",
    "created_at": "2013-03-22T08:27:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172226",
    "user": "@jdemeyer"
}
```

I found the problem with `expect.py`: the doctest process starts the `sage-cleaner`, somehow leading to trouble.



---

archive/issue_comments_172227.json:
```json
{
    "body": "Attachment [14055_cleaner_sagelib.patch](tarball://root/attachments/some-uuid/ticket14055/14055_cleaner_sagelib.patch) by @jdemeyer created at 2013-03-22 09:29:33",
    "created_at": "2013-03-22T09:29:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172227",
    "user": "@jdemeyer"
}
```

Attachment [14055_cleaner_sagelib.patch](tarball://root/attachments/some-uuid/ticket14055/14055_cleaner_sagelib.patch) by @jdemeyer created at 2013-03-22 09:29:33



---

archive/issue_comments_172228.json:
```json
{
    "body": "Attachment [14055_cleaner.patch](tarball://root/attachments/some-uuid/ticket14055/14055_cleaner.patch) by @jdemeyer created at 2013-03-22 09:31:14\n\nNeeds review.",
    "created_at": "2013-03-22T09:31:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172228",
    "user": "@jdemeyer"
}
```

Attachment [14055_cleaner.patch](tarball://root/attachments/some-uuid/ticket14055/14055_cleaner.patch) by @jdemeyer created at 2013-03-22 09:31:14

Needs review.



---

archive/issue_comments_172229.json:
```json
{
    "body": "Changing keywords from \"orphans\" to \"\".",
    "created_at": "2013-03-22T09:31:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172229",
    "user": "@jdemeyer"
}
```

Changing keywords from "orphans" to "".



---

archive/issue_comments_172230.json:
```json
{
    "body": "Once or twice, after running Sage, quitting, and starting it again, or doing doctests and then running Sage, I've seen this (again, I have allowed sage-cleaner to print its output to the screen):\n\n```\n----------------------------------------------------------------------\n----------------------------------------------------------------------\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\nSAGE_TMP_ROOT = /Users/palmieri/.sage/temp/Macintosh_001b639d44a1.local\nsage-cleaner is already running with PID 78006, exiting\nChecking PIDs []\ncleanup() #13 took 0.00s\nsage-cleaner is finished\nsage: \n```\n\nSure enough, in this case sage-cleaner isn't running while Sage is. Is this a problem? (It does start up if asked to by `interfaces/cleaner.py`.)\n| Sage Version 5.9.beta1, Release Date: 2013-03-22                   |\n| Type \"notebook()\" for the browser-based notebook interface.        |\n| Type \"help()\" for help.                                            |\nI can, not very reliably, reproduce this by starting Sage, letting the count go above 10, quit Sage, wait a second or two, and then restart it.\n\nOtherwise, I think I'm happy with this.",
    "created_at": "2013-03-22T21:46:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172230",
    "user": "@jhpalmieri"
}
```

Once or twice, after running Sage, quitting, and starting it again, or doing doctests and then running Sage, I've seen this (again, I have allowed sage-cleaner to print its output to the screen):

```
----------------------------------------------------------------------
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
SAGE_TMP_ROOT = /Users/palmieri/.sage/temp/Macintosh_001b639d44a1.local
sage-cleaner is already running with PID 78006, exiting
Checking PIDs []
cleanup() #13 took 0.00s
sage-cleaner is finished
sage: 
```

Sure enough, in this case sage-cleaner isn't running while Sage is. Is this a problem? (It does start up if asked to by `interfaces/cleaner.py`.)
| Sage Version 5.9.beta1, Release Date: 2013-03-22                   |
| Type "notebook()" for the browser-based notebook interface.        |
| Type "help()" for help.                                            |
I can, not very reliably, reproduce this by starting Sage, letting the count go above 10, quit Sage, wait a second or two, and then restart it.

Otherwise, I think I'm happy with this.



---

archive/issue_comments_172231.json:
```json
{
    "body": "See #14342 for a sort of follow-up (an attempt to stop using `DOT_SAGE/tmp` altogether).",
    "created_at": "2013-03-22T23:34:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172231",
    "user": "@jhpalmieri"
}
```

See #14342 for a sort of follow-up (an attempt to stop using `DOT_SAGE/tmp` altogether).



---

archive/issue_comments_172232.json:
```json
{
    "body": "Replying to [comment:12 novoselt]:\n> I've applied this patch to SAGE_ROOT/local/bin, ran \"make ptestlong\" and still got two ecl processes eating RAM when tests were finished without errors.\n\nDid you meanwhile also try the new versions?  (There's now a patch to the Sage library as well.)",
    "created_at": "2013-03-24T16:40:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172232",
    "user": "@nexttime"
}
```

Replying to [comment:12 novoselt]:
> I've applied this patch to SAGE_ROOT/local/bin, ran "make ptestlong" and still got two ecl processes eating RAM when tests were finished without errors.

Did you meanwhile also try the new versions?  (There's now a patch to the Sage library as well.)



---

archive/issue_comments_172233.json:
```json
{
    "body": "Same story: compile 5.9.beta1, apply both patches here, run \"make ptestlong\" and there are two ecl processes. I also got failures\n\n```\nsage -t --long devel/sage/sage/homology/simplicial_complex.py  # 5 doctests failed\nsage -t --long devel/sage/sage/libs/gap/libgap.pyx  # 5 doctests failed\nsage -t --long devel/sage/sage/libs/gap/element.pyx  # 3 doctests failed\n```\n",
    "created_at": "2013-03-28T16:59:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172233",
    "user": "@novoselt"
}
```

Same story: compile 5.9.beta1, apply both patches here, run "make ptestlong" and there are two ecl processes. I also got failures

```
sage -t --long devel/sage/sage/homology/simplicial_complex.py  # 5 doctests failed
sage -t --long devel/sage/sage/libs/gap/libgap.pyx  # 5 doctests failed
sage -t --long devel/sage/sage/libs/gap/element.pyx  # 3 doctests failed
```




---

archive/issue_comments_172234.json:
```json
{
    "body": "Replying to [comment:27 novoselt]:\n> Same story: compile 5.9.beta1, apply both patches here, run \"make ptestlong\" and there are two ecl processes. I also got failures\n> {{{\n> sage -t --long devel/sage/sage/homology/simplicial_complex.py  # 5 doctests failed\n> sage -t --long devel/sage/sage/libs/gap/libgap.pyx  # 5 doctests failed\n> sage -t --long devel/sage/sage/libs/gap/element.pyx  # 3 doctests failed\n> }}}\nPlease show which tests are failing.",
    "created_at": "2013-03-28T17:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172234",
    "user": "@jdemeyer"
}
```

Replying to [comment:27 novoselt]:
> Same story: compile 5.9.beta1, apply both patches here, run "make ptestlong" and there are two ecl processes. I also got failures
> {{{
> sage -t --long devel/sage/sage/homology/simplicial_complex.py  # 5 doctests failed
> sage -t --long devel/sage/sage/libs/gap/libgap.pyx  # 5 doctests failed
> sage -t --long devel/sage/sage/libs/gap/element.pyx  # 3 doctests failed
> }}}
Please show which tests are failing.



---

archive/issue_comments_172235.json:
```json
{
    "body": "\n```\nnovoselt@sage:~/sage-5.9.beta1$ ./sage -t --long devel/sage/sage/homology/simplicial_complex.py  # 5 doctests failed\nRunning doctests with ID 2013-03-28-13-53-51-e8efe0bf.\nDoctesting 1 file.\nsage -t --long devel/sage/sage/homology/simplicial_complex.py\n**********************************************************************\nFile \"devel/sage/sage/homology/simplicial_complex.py\", line 3134, in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group\nFailed example:\n    S.automorphism_group().is_isomorphic(SymmetricGroup(4))\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.homology.simplicial_complex.SimplicialComplex.automorphism_group[1]>\", line 1, in <module>\n        S.automorphism_group().is_isomorphic(SymmetricGroup(Integer(4)))\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/homology/simplicial_complex.py\", line 3155, in automorphism_group\n        [f.tuple() for f in self.facets()]])\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py\", line 16543, in automorphism_group\n        output.append(PermutationGroup([perm_group_elt(aa) for aa in a]))\n      File \"refinement_graphs.pyx\", line 941, in sage.groups.perm_gps.partn_ref.refinement_graphs.perm_group_elt (sage/groups/perm_gps/partn_ref/refinement_graphs.c:32796)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup.py\", line 653, in __call__\n        return self._element_class()(x, self, check=check)\n      File \"permgroup_element.pyx\", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)\n      File \"sage_object.pyx\", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)\n      File \"sage_object.pyx\", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 199, in __call__\n        return cls(self, x, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1285, in __init__\n        raise TypeError, x\n    TypeError: list.remove(x): x not in list\n**********************************************************************\nFile \"devel/sage/sage/homology/simplicial_complex.py\", line 3138, in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group\nFailed example:\n    P.automorphism_group().is_isomorphic(AlternatingGroup(5))\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.homology.simplicial_complex.SimplicialComplex.automorphism_group[3]>\", line 1, in <module>\n        P.automorphism_group().is_isomorphic(AlternatingGroup(Integer(5)))\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/homology/simplicial_complex.py\", line 3155, in automorphism_group\n        [f.tuple() for f in self.facets()]])\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py\", line 16543, in automorphism_group\n        output.append(PermutationGroup([perm_group_elt(aa) for aa in a]))\n      File \"refinement_graphs.pyx\", line 941, in sage.groups.perm_gps.partn_ref.refinement_graphs.perm_group_elt (sage/groups/perm_gps/partn_ref/refinement_graphs.c:32796)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup.py\", line 653, in __call__\n        return self._element_class()(x, self, check=check)\n      File \"permgroup_element.pyx\", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)\n      File \"sage_object.pyx\", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)\n      File \"sage_object.pyx\", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 199, in __call__\n        return cls(self, x, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1280, in __init__\n        self._name = parent._create(value, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 389, in _create\n        self.set(name, value)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1322, in set\n        out = self._eval_line(cmd, allow_use_file=True)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 730, in _eval_line\n        self._start()\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1175, in _start\n        Expect._start(self, \"Failed to start GAP.\")\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 443, in _start\n        self._expect.expect(self._prompt)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py\", line 916, in expect\n        return self.expect_list(compiled_pattern_list, timeout, searchwindowsize)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py\", line 967, in expect_list\n        c = self.read_nonblocking (self.maxread, timeout)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py\", line 548, in read_nonblocking\n        r, w, e = select.select([self.child_fd], [], [], timeout)\n    error: (4, 'Interrupted system call')\n**********************************************************************\nFile \"devel/sage/sage/homology/simplicial_complex.py\", line 3142, in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group\nFailed example:\n    Z.automorphism_group().is_isomorphic(CyclicPermutationGroup(2))\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.homology.simplicial_complex.SimplicialComplex.automorphism_group[5]>\", line 1, in <module>\n        Z.automorphism_group().is_isomorphic(CyclicPermutationGroup(Integer(2)))\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/homology/simplicial_complex.py\", line 3155, in automorphism_group\n        [f.tuple() for f in self.facets()]])\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py\", line 16543, in automorphism_group\n        output.append(PermutationGroup([perm_group_elt(aa) for aa in a]))\n      File \"refinement_graphs.pyx\", line 941, in sage.groups.perm_gps.partn_ref.refinement_graphs.perm_group_elt (sage/groups/perm_gps/partn_ref/refinement_graphs.c:32796)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup.py\", line 653, in __call__\n        return self._element_class()(x, self, check=check)\n      File \"permgroup_element.pyx\", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)\n      File \"sage_object.pyx\", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)\n      File \"sage_object.pyx\", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 199, in __call__\n        return cls(self, x, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1280, in __init__\n        self._name = parent._create(value, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 389, in _create\n        self.set(name, value)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1322, in set\n        out = self._eval_line(cmd, allow_use_file=True)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 736, in _eval_line\n        expect_eof= (self._quit_string() in line))\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 597, in _execute_line\n        x = E.expect_list(self._compiled_full_pattern)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 516, in __getattr__\n        return ParentWithBase.__getattribute__(self, attrname)\n      File \"parent.pyx\", line 675, in sage.structure.parent.Parent.__getattr__ (sage/structure/parent.c:6215)\n    AttributeError: 'Gap' object has no attribute '_compiled_full_pattern'\n**********************************************************************\nFile \"devel/sage/sage/homology/simplicial_complex.py\", line 3144, in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group\nFailed example:\n    group, dict = Z.automorphism_group(translation=True)\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.homology.simplicial_complex.SimplicialComplex.automorphism_group[6]>\", line 1, in <module>\n        group, dict = Z.automorphism_group(translation=True)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/homology/simplicial_complex.py\", line 3155, in automorphism_group\n        [f.tuple() for f in self.facets()]])\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py\", line 16543, in automorphism_group\n        output.append(PermutationGroup([perm_group_elt(aa) for aa in a]))\n      File \"refinement_graphs.pyx\", line 941, in sage.groups.perm_gps.partn_ref.refinement_graphs.perm_group_elt (sage/groups/perm_gps/partn_ref/refinement_graphs.c:32796)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup.py\", line 653, in __call__\n        return self._element_class()(x, self, check=check)\n      File \"permgroup_element.pyx\", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)\n      File \"sage_object.pyx\", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)\n      File \"sage_object.pyx\", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 199, in __call__\n        return cls(self, x, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1280, in __init__\n        self._name = parent._create(value, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 389, in _create\n        self.set(name, value)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1322, in set\n        out = self._eval_line(cmd, allow_use_file=True)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 736, in _eval_line\n        expect_eof= (self._quit_string() in line))\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 597, in _execute_line\n        x = E.expect_list(self._compiled_full_pattern)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 516, in __getattr__\n        return ParentWithBase.__getattribute__(self, attrname)\n      File \"parent.pyx\", line 675, in sage.structure.parent.Parent.__getattr__ (sage/structure/parent.c:6215)\n    AttributeError: 'Gap' object has no attribute '_compiled_full_pattern'\n**********************************************************************\nFile \"devel/sage/sage/homology/simplicial_complex.py\", line 3145, in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group\nFailed example:\n    Set([dict[s] for s in Z.vertices()])\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.homology.simplicial_complex.SimplicialComplex.automorphism_group[7]>\", line 1, in <module>\n        Set([dict[s] for s in Z.vertices()])\n    TypeError: 'type' object has no attribute '__getitem__'\n**********************************************************************\n1 item had failures:\n   5 of   9 in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group\n    [409 tests, 5 failures, 10.0 s]\n----------------------------------------------------------------------\nsage -t --long devel/sage/sage/homology/simplicial_complex.py  # 5 doctests failed\n----------------------------------------------------------------------\nTotal time for all tests: 10.3 seconds\n    cpu time: 7.9 seconds\n    cumulative wall time: 10.0 seconds\n```\n\n\n\n```\nnovoselt@sage:~/sage-5.9.beta1$ ./sage -t --long devel/sage/sage/libs/gap/libgap.pyx  # 5 doctests failed\nRunning doctests with ID 2013-03-28-13-55-04-e18989af.\nDoctesting 1 file.\nsage -t --long devel/sage/sage/libs/gap/libgap.pyx\n**********************************************************************\nFile \"devel/sage/sage/libs/gap/libgap.pyx\", line 23, in sage.libs.gap.libgap\nFailed example:\n    b = gap('10')\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.libs.gap.libgap[5]>\", line 1, in <module>\n        b = gap('10')\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 199, in __call__\n        return cls(self, x, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1285, in __init__\n        raise TypeError, x\n    TypeError: list.remove(x): x not in list\n**********************************************************************\nFile \"devel/sage/sage/libs/gap/libgap.pyx\", line 24, in sage.libs.gap.libgap\nFailed example:\n    timeit('b*b')   # random output\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.libs.gap.libgap[6]>\", line 1, in <module>\n        timeit('b*b')   # random output\n      File \"sage_timeit_class.pyx\", line 114, in sage.misc.sage_timeit_class.SageTimeit.__call__ (sage/misc/sage_timeit_class.c:931)\n      File \"sage_timeit_class.pyx\", line 78, in sage.misc.sage_timeit_class.SageTimeit.eval (sage/misc/sage_timeit_class.c:731)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/misc/sage_timeit.py\", line 236, in sage_timeit\n        if timer.timeit(number) >= 0.2:\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python/timeit.py\", line 195, in timeit\n        timing = self.inner(it, self.timer)\n      File \"<magic-timeit>\", line 6, in inner\n    NameError: global name 'b' is not defined\n**********************************************************************\nFile \"devel/sage/sage/libs/gap/libgap.pyx\", line 52, in sage.libs.gap.libgap\nFailed example:\n    generators = libgap.AlternatingGroup(4).GeneratorsOfGroup().sage()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.libs.gap.libgap[13]>\", line 1, in <module>\n        generators = libgap.AlternatingGroup(Integer(4)).GeneratorsOfGroup().sage()\n      File \"element.pyx\", line 1617, in sage.libs.gap.element.GapElement_List.sage (sage/libs/gap/element.c:9500)\n      File \"element.pyx\", line 1673, in sage.libs.gap.element.GapElement_Permutation.sage (sage/libs/gap/element.c:9699)\n      File \"permgroup_element.pyx\", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)\n      File \"sage_object.pyx\", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)\n      File \"sage_object.pyx\", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 199, in __call__\n        return cls(self, x, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1280, in __init__\n        self._name = parent._create(value, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 389, in _create\n        self.set(name, value)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1322, in set\n        out = self._eval_line(cmd, allow_use_file=True)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 730, in _eval_line\n        self._start()\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1175, in _start\n        Expect._start(self, \"Failed to start GAP.\")\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 443, in _start\n        self._expect.expect(self._prompt)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py\", line 916, in expect\n        return self.expect_list(compiled_pattern_list, timeout, searchwindowsize)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py\", line 967, in expect_list\n        c = self.read_nonblocking (self.maxread, timeout)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py\", line 548, in read_nonblocking\n        r, w, e = select.select([self.child_fd], [], [], timeout)\n    error: (4, 'Interrupted system call')\n**********************************************************************\nFile \"devel/sage/sage/libs/gap/libgap.pyx\", line 53, in sage.libs.gap.libgap\nFailed example:\n    generators   # a Sage list of Sage permutations!\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.libs.gap.libgap[14]>\", line 1, in <module>\n        generators   # a Sage list of Sage permutations!\n    NameError: name 'generators' is not defined\n**********************************************************************\nFile \"devel/sage/sage/libs/gap/libgap.pyx\", line 55, in sage.libs.gap.libgap\nFailed example:\n    PermutationGroup(generators).cardinality()   # computed in Sage\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.libs.gap.libgap[15]>\", line 1, in <module>\n        PermutationGroup(generators).cardinality()   # computed in Sage\n    NameError: name 'generators' is not defined\n**********************************************************************\n1 item had failures:\n   5 of  36 in sage.libs.gap.libgap\n    [63 tests, 5 failures, 5.3 s]\n----------------------------------------------------------------------\nsage -t --long devel/sage/sage/libs/gap/libgap.pyx  # 5 doctests failed\n----------------------------------------------------------------------\nTotal time for all tests: 5.4 seconds\n    cpu time: 5.1 seconds\n    cumulative wall time: 5.3 seconds\n```\n\n\n\n```\nnovoselt@sage:~/sage-5.9.beta1$ ./sage -t --long devel/sage/sage/libs/gap/element.pyx  # 3 doctests failed\nRunning doctests with ID 2013-03-28-13-55-47-94cfc7ed.\nDoctesting 1 file.\nsage -t --long devel/sage/sage/libs/gap/element.pyx\n**********************************************************************\nFile \"devel/sage/sage/libs/gap/element.pyx\", line 1400, in sage.libs.gap.element.GapElement_Function._sage_doc_\nFailed example:\n    'constructs  the  cyclic  group' in f._sage_doc_()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.libs.gap.element.GapElement_Function._sage_doc_[1]>\", line 1, in <module>\n        'constructs  the  cyclic  group' in f._sage_doc_()\n      File \"element.pyx\", line 1407, in sage.libs.gap.element.GapElement_Function._sage_doc_ (sage/libs/gap/element.c:8928)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1287, in help\n        tmp_to_use = self._local_tmpfile()\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 581, in _local_tmpfile\n        self.__local_tmpfile = os.path.join(SAGE_TMP_INTERFACE, 'tmp' + str(self.pid()))\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 298, in pid\n        self._start()\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1180, in _start\n        expect.failed_to_start.remove(self.name())\n    ValueError: list.remove(x): x not in list\n**********************************************************************\nFile \"devel/sage/sage/libs/gap/element.pyx\", line 1666, in sage.libs.gap.element.GapElement_Permutation.sage\nFailed example:\n    perm_gap.sage()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.libs.gap.element.GapElement_Permutation.sage[1]>\", line 1, in <module>\n        perm_gap.sage()\n      File \"element.pyx\", line 1673, in sage.libs.gap.element.GapElement_Permutation.sage (sage/libs/gap/element.c:9699)\n      File \"permgroup_element.pyx\", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)\n      File \"sage_object.pyx\", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)\n      File \"sage_object.pyx\", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 199, in __call__\n        return cls(self, x, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1280, in __init__\n        self._name = parent._create(value, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 389, in _create\n        self.set(name, value)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1322, in set\n        out = self._eval_line(cmd, allow_use_file=True)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 730, in _eval_line\n        self._start()\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1175, in _start\n        Expect._start(self, \"Failed to start GAP.\")\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 443, in _start\n        self._expect.expect(self._prompt)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py\", line 916, in expect\n        return self.expect_list(compiled_pattern_list, timeout, searchwindowsize)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py\", line 967, in expect_list\n        c = self.read_nonblocking (self.maxread, timeout)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py\", line 548, in read_nonblocking\n        r, w, e = select.select([self.child_fd], [], [], timeout)\n    error: (4, 'Interrupted system call')\n**********************************************************************\nFile \"devel/sage/sage/libs/gap/element.pyx\", line 1668, in sage.libs.gap.element.GapElement_Permutation.sage\nFailed example:\n    type(_)\nExpected:\n    <type 'sage.groups.perm_gps.permgroup_element.PermutationGroupElement'>\nGot:\n    <type 'sage.libs.gap.element.GapElement_Permutation'>\n**********************************************************************\n2 items had failures:\n   1 of   3 in sage.libs.gap.element.GapElement_Function._sage_doc_\n   2 of   4 in sage.libs.gap.element.GapElement_Permutation.sage\n    [256 tests, 3 failures, 5.5 s]\n----------------------------------------------------------------------\nsage -t --long devel/sage/sage/libs/gap/element.pyx  # 3 doctests failed\n----------------------------------------------------------------------\nTotal time for all tests: 5.6 seconds\n    cpu time: 5.3 seconds\n    cumulative wall time: 5.5 seconds\n```\n",
    "created_at": "2013-03-28T19:56:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172235",
    "user": "@novoselt"
}
```


```
novoselt@sage:~/sage-5.9.beta1$ ./sage -t --long devel/sage/sage/homology/simplicial_complex.py  # 5 doctests failed
Running doctests with ID 2013-03-28-13-53-51-e8efe0bf.
Doctesting 1 file.
sage -t --long devel/sage/sage/homology/simplicial_complex.py
**********************************************************************
File "devel/sage/sage/homology/simplicial_complex.py", line 3134, in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group
Failed example:
    S.automorphism_group().is_isomorphic(SymmetricGroup(4))
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.homology.simplicial_complex.SimplicialComplex.automorphism_group[1]>", line 1, in <module>
        S.automorphism_group().is_isomorphic(SymmetricGroup(Integer(4)))
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/homology/simplicial_complex.py", line 3155, in automorphism_group
        [f.tuple() for f in self.facets()]])
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 16543, in automorphism_group
        output.append(PermutationGroup([perm_group_elt(aa) for aa in a]))
      File "refinement_graphs.pyx", line 941, in sage.groups.perm_gps.partn_ref.refinement_graphs.perm_group_elt (sage/groups/perm_gps/partn_ref/refinement_graphs.c:32796)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup.py", line 653, in __call__
        return self._element_class()(x, self, check=check)
      File "permgroup_element.pyx", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)
      File "sage_object.pyx", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)
      File "sage_object.pyx", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 199, in __call__
        return cls(self, x, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1285, in __init__
        raise TypeError, x
    TypeError: list.remove(x): x not in list
**********************************************************************
File "devel/sage/sage/homology/simplicial_complex.py", line 3138, in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group
Failed example:
    P.automorphism_group().is_isomorphic(AlternatingGroup(5))
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.homology.simplicial_complex.SimplicialComplex.automorphism_group[3]>", line 1, in <module>
        P.automorphism_group().is_isomorphic(AlternatingGroup(Integer(5)))
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/homology/simplicial_complex.py", line 3155, in automorphism_group
        [f.tuple() for f in self.facets()]])
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 16543, in automorphism_group
        output.append(PermutationGroup([perm_group_elt(aa) for aa in a]))
      File "refinement_graphs.pyx", line 941, in sage.groups.perm_gps.partn_ref.refinement_graphs.perm_group_elt (sage/groups/perm_gps/partn_ref/refinement_graphs.c:32796)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup.py", line 653, in __call__
        return self._element_class()(x, self, check=check)
      File "permgroup_element.pyx", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)
      File "sage_object.pyx", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)
      File "sage_object.pyx", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 199, in __call__
        return cls(self, x, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1280, in __init__
        self._name = parent._create(value, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 389, in _create
        self.set(name, value)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1322, in set
        out = self._eval_line(cmd, allow_use_file=True)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 730, in _eval_line
        self._start()
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1175, in _start
        Expect._start(self, "Failed to start GAP.")
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 443, in _start
        self._expect.expect(self._prompt)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py", line 916, in expect
        return self.expect_list(compiled_pattern_list, timeout, searchwindowsize)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py", line 967, in expect_list
        c = self.read_nonblocking (self.maxread, timeout)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py", line 548, in read_nonblocking
        r, w, e = select.select([self.child_fd], [], [], timeout)
    error: (4, 'Interrupted system call')
**********************************************************************
File "devel/sage/sage/homology/simplicial_complex.py", line 3142, in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group
Failed example:
    Z.automorphism_group().is_isomorphic(CyclicPermutationGroup(2))
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.homology.simplicial_complex.SimplicialComplex.automorphism_group[5]>", line 1, in <module>
        Z.automorphism_group().is_isomorphic(CyclicPermutationGroup(Integer(2)))
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/homology/simplicial_complex.py", line 3155, in automorphism_group
        [f.tuple() for f in self.facets()]])
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 16543, in automorphism_group
        output.append(PermutationGroup([perm_group_elt(aa) for aa in a]))
      File "refinement_graphs.pyx", line 941, in sage.groups.perm_gps.partn_ref.refinement_graphs.perm_group_elt (sage/groups/perm_gps/partn_ref/refinement_graphs.c:32796)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup.py", line 653, in __call__
        return self._element_class()(x, self, check=check)
      File "permgroup_element.pyx", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)
      File "sage_object.pyx", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)
      File "sage_object.pyx", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 199, in __call__
        return cls(self, x, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1280, in __init__
        self._name = parent._create(value, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 389, in _create
        self.set(name, value)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1322, in set
        out = self._eval_line(cmd, allow_use_file=True)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 736, in _eval_line
        expect_eof= (self._quit_string() in line))
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 597, in _execute_line
        x = E.expect_list(self._compiled_full_pattern)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 516, in __getattr__
        return ParentWithBase.__getattribute__(self, attrname)
      File "parent.pyx", line 675, in sage.structure.parent.Parent.__getattr__ (sage/structure/parent.c:6215)
    AttributeError: 'Gap' object has no attribute '_compiled_full_pattern'
**********************************************************************
File "devel/sage/sage/homology/simplicial_complex.py", line 3144, in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group
Failed example:
    group, dict = Z.automorphism_group(translation=True)
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.homology.simplicial_complex.SimplicialComplex.automorphism_group[6]>", line 1, in <module>
        group, dict = Z.automorphism_group(translation=True)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/homology/simplicial_complex.py", line 3155, in automorphism_group
        [f.tuple() for f in self.facets()]])
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 16543, in automorphism_group
        output.append(PermutationGroup([perm_group_elt(aa) for aa in a]))
      File "refinement_graphs.pyx", line 941, in sage.groups.perm_gps.partn_ref.refinement_graphs.perm_group_elt (sage/groups/perm_gps/partn_ref/refinement_graphs.c:32796)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup.py", line 653, in __call__
        return self._element_class()(x, self, check=check)
      File "permgroup_element.pyx", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)
      File "sage_object.pyx", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)
      File "sage_object.pyx", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 199, in __call__
        return cls(self, x, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1280, in __init__
        self._name = parent._create(value, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 389, in _create
        self.set(name, value)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1322, in set
        out = self._eval_line(cmd, allow_use_file=True)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 736, in _eval_line
        expect_eof= (self._quit_string() in line))
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 597, in _execute_line
        x = E.expect_list(self._compiled_full_pattern)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 516, in __getattr__
        return ParentWithBase.__getattribute__(self, attrname)
      File "parent.pyx", line 675, in sage.structure.parent.Parent.__getattr__ (sage/structure/parent.c:6215)
    AttributeError: 'Gap' object has no attribute '_compiled_full_pattern'
**********************************************************************
File "devel/sage/sage/homology/simplicial_complex.py", line 3145, in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group
Failed example:
    Set([dict[s] for s in Z.vertices()])
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.homology.simplicial_complex.SimplicialComplex.automorphism_group[7]>", line 1, in <module>
        Set([dict[s] for s in Z.vertices()])
    TypeError: 'type' object has no attribute '__getitem__'
**********************************************************************
1 item had failures:
   5 of   9 in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group
    [409 tests, 5 failures, 10.0 s]
----------------------------------------------------------------------
sage -t --long devel/sage/sage/homology/simplicial_complex.py  # 5 doctests failed
----------------------------------------------------------------------
Total time for all tests: 10.3 seconds
    cpu time: 7.9 seconds
    cumulative wall time: 10.0 seconds
```



```
novoselt@sage:~/sage-5.9.beta1$ ./sage -t --long devel/sage/sage/libs/gap/libgap.pyx  # 5 doctests failed
Running doctests with ID 2013-03-28-13-55-04-e18989af.
Doctesting 1 file.
sage -t --long devel/sage/sage/libs/gap/libgap.pyx
**********************************************************************
File "devel/sage/sage/libs/gap/libgap.pyx", line 23, in sage.libs.gap.libgap
Failed example:
    b = gap('10')
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.libs.gap.libgap[5]>", line 1, in <module>
        b = gap('10')
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 199, in __call__
        return cls(self, x, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1285, in __init__
        raise TypeError, x
    TypeError: list.remove(x): x not in list
**********************************************************************
File "devel/sage/sage/libs/gap/libgap.pyx", line 24, in sage.libs.gap.libgap
Failed example:
    timeit('b*b')   # random output
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.libs.gap.libgap[6]>", line 1, in <module>
        timeit('b*b')   # random output
      File "sage_timeit_class.pyx", line 114, in sage.misc.sage_timeit_class.SageTimeit.__call__ (sage/misc/sage_timeit_class.c:931)
      File "sage_timeit_class.pyx", line 78, in sage.misc.sage_timeit_class.SageTimeit.eval (sage/misc/sage_timeit_class.c:731)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/misc/sage_timeit.py", line 236, in sage_timeit
        if timer.timeit(number) >= 0.2:
      File "/home/novoselt/sage-5.9.beta1/local/lib/python/timeit.py", line 195, in timeit
        timing = self.inner(it, self.timer)
      File "<magic-timeit>", line 6, in inner
    NameError: global name 'b' is not defined
**********************************************************************
File "devel/sage/sage/libs/gap/libgap.pyx", line 52, in sage.libs.gap.libgap
Failed example:
    generators = libgap.AlternatingGroup(4).GeneratorsOfGroup().sage()
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.libs.gap.libgap[13]>", line 1, in <module>
        generators = libgap.AlternatingGroup(Integer(4)).GeneratorsOfGroup().sage()
      File "element.pyx", line 1617, in sage.libs.gap.element.GapElement_List.sage (sage/libs/gap/element.c:9500)
      File "element.pyx", line 1673, in sage.libs.gap.element.GapElement_Permutation.sage (sage/libs/gap/element.c:9699)
      File "permgroup_element.pyx", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)
      File "sage_object.pyx", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)
      File "sage_object.pyx", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 199, in __call__
        return cls(self, x, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1280, in __init__
        self._name = parent._create(value, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 389, in _create
        self.set(name, value)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1322, in set
        out = self._eval_line(cmd, allow_use_file=True)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 730, in _eval_line
        self._start()
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1175, in _start
        Expect._start(self, "Failed to start GAP.")
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 443, in _start
        self._expect.expect(self._prompt)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py", line 916, in expect
        return self.expect_list(compiled_pattern_list, timeout, searchwindowsize)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py", line 967, in expect_list
        c = self.read_nonblocking (self.maxread, timeout)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py", line 548, in read_nonblocking
        r, w, e = select.select([self.child_fd], [], [], timeout)
    error: (4, 'Interrupted system call')
**********************************************************************
File "devel/sage/sage/libs/gap/libgap.pyx", line 53, in sage.libs.gap.libgap
Failed example:
    generators   # a Sage list of Sage permutations!
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.libs.gap.libgap[14]>", line 1, in <module>
        generators   # a Sage list of Sage permutations!
    NameError: name 'generators' is not defined
**********************************************************************
File "devel/sage/sage/libs/gap/libgap.pyx", line 55, in sage.libs.gap.libgap
Failed example:
    PermutationGroup(generators).cardinality()   # computed in Sage
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.libs.gap.libgap[15]>", line 1, in <module>
        PermutationGroup(generators).cardinality()   # computed in Sage
    NameError: name 'generators' is not defined
**********************************************************************
1 item had failures:
   5 of  36 in sage.libs.gap.libgap
    [63 tests, 5 failures, 5.3 s]
----------------------------------------------------------------------
sage -t --long devel/sage/sage/libs/gap/libgap.pyx  # 5 doctests failed
----------------------------------------------------------------------
Total time for all tests: 5.4 seconds
    cpu time: 5.1 seconds
    cumulative wall time: 5.3 seconds
```



```
novoselt@sage:~/sage-5.9.beta1$ ./sage -t --long devel/sage/sage/libs/gap/element.pyx  # 3 doctests failed
Running doctests with ID 2013-03-28-13-55-47-94cfc7ed.
Doctesting 1 file.
sage -t --long devel/sage/sage/libs/gap/element.pyx
**********************************************************************
File "devel/sage/sage/libs/gap/element.pyx", line 1400, in sage.libs.gap.element.GapElement_Function._sage_doc_
Failed example:
    'constructs  the  cyclic  group' in f._sage_doc_()
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.libs.gap.element.GapElement_Function._sage_doc_[1]>", line 1, in <module>
        'constructs  the  cyclic  group' in f._sage_doc_()
      File "element.pyx", line 1407, in sage.libs.gap.element.GapElement_Function._sage_doc_ (sage/libs/gap/element.c:8928)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1287, in help
        tmp_to_use = self._local_tmpfile()
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 581, in _local_tmpfile
        self.__local_tmpfile = os.path.join(SAGE_TMP_INTERFACE, 'tmp' + str(self.pid()))
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 298, in pid
        self._start()
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1180, in _start
        expect.failed_to_start.remove(self.name())
    ValueError: list.remove(x): x not in list
**********************************************************************
File "devel/sage/sage/libs/gap/element.pyx", line 1666, in sage.libs.gap.element.GapElement_Permutation.sage
Failed example:
    perm_gap.sage()
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.libs.gap.element.GapElement_Permutation.sage[1]>", line 1, in <module>
        perm_gap.sage()
      File "element.pyx", line 1673, in sage.libs.gap.element.GapElement_Permutation.sage (sage/libs/gap/element.c:9699)
      File "permgroup_element.pyx", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)
      File "sage_object.pyx", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)
      File "sage_object.pyx", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 199, in __call__
        return cls(self, x, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1280, in __init__
        self._name = parent._create(value, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 389, in _create
        self.set(name, value)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1322, in set
        out = self._eval_line(cmd, allow_use_file=True)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 730, in _eval_line
        self._start()
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1175, in _start
        Expect._start(self, "Failed to start GAP.")
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 443, in _start
        self._expect.expect(self._prompt)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py", line 916, in expect
        return self.expect_list(compiled_pattern_list, timeout, searchwindowsize)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py", line 967, in expect_list
        c = self.read_nonblocking (self.maxread, timeout)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py", line 548, in read_nonblocking
        r, w, e = select.select([self.child_fd], [], [], timeout)
    error: (4, 'Interrupted system call')
**********************************************************************
File "devel/sage/sage/libs/gap/element.pyx", line 1668, in sage.libs.gap.element.GapElement_Permutation.sage
Failed example:
    type(_)
Expected:
    <type 'sage.groups.perm_gps.permgroup_element.PermutationGroupElement'>
Got:
    <type 'sage.libs.gap.element.GapElement_Permutation'>
**********************************************************************
2 items had failures:
   1 of   3 in sage.libs.gap.element.GapElement_Function._sage_doc_
   2 of   4 in sage.libs.gap.element.GapElement_Permutation.sage
    [256 tests, 3 failures, 5.5 s]
----------------------------------------------------------------------
sage -t --long devel/sage/sage/libs/gap/element.pyx  # 3 doctests failed
----------------------------------------------------------------------
Total time for all tests: 5.6 seconds
    cpu time: 5.3 seconds
    cumulative wall time: 5.5 seconds
```




---

archive/issue_comments_172236.json:
```json
{
    "body": "Please apply #14323 (if you haven't) and try again.",
    "created_at": "2013-03-28T20:06:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172236",
    "user": "@jdemeyer"
}
```

Please apply #14323 (if you haven't) and try again.



---

archive/issue_comments_172237.json:
```json
{
    "body": "#14323 fixes the doctest failures, but not ecl processes...",
    "created_at": "2013-03-28T20:41:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172237",
    "user": "@novoselt"
}
```

#14323 fixes the doctest failures, but not ecl processes...



---

archive/issue_comments_172238.json:
```json
{
    "body": "Replying to [comment:31 novoselt]:\n> #14323 fixes the doctest failures, but not ecl processes...\n\nI'm now among the lucky few who get these greedy, immortal ECL processes:\n\nWith Sage 5.9.beta2 (which includes #14323), GCC 4.8.0, on Ubuntu 10.04.4 x86_64, during `make` **testlong** (as opposed to `make ptestlong` -- others previously reported only the latter caused problems).\n\nTwo ECL processes show up while testing `sage/interfaces/lisp.py` (as I had guessed), quickly start eating up memory, and keep running even after the file has been tested without any errors.",
    "created_at": "2013-03-30T23:40:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172238",
    "user": "@nexttime"
}
```

Replying to [comment:31 novoselt]:
> #14323 fixes the doctest failures, but not ecl processes...

I'm now among the lucky few who get these greedy, immortal ECL processes:

With Sage 5.9.beta2 (which includes #14323), GCC 4.8.0, on Ubuntu 10.04.4 x86_64, during `make` **testlong** (as opposed to `make ptestlong` -- others previously reported only the latter caused problems).

Two ECL processes show up while testing `sage/interfaces/lisp.py` (as I had guessed), quickly start eating up memory, and keep running even after the file has been tested without any errors.



---

archive/issue_comments_172239.json:
```json
{
    "body": "What needs to be done here. [comment:24 I asked a question earlier], but otherwise, are there issues with this?",
    "created_at": "2013-04-04T14:53:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172239",
    "user": "@jhpalmieri"
}
```

What needs to be done here. [comment:24 I asked a question earlier], but otherwise, are there issues with this?



---

archive/issue_comments_172240.json:
```json
{
    "body": "That [comment:24 question] is really a race condition between exiting one Sage cleaner and starting another. I'll think about it.",
    "created_at": "2013-04-04T15:21:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172240",
    "user": "@jdemeyer"
}
```

That [comment:24 question] is really a race condition between exiting one Sage cleaner and starting another. I'll think about it.



---

archive/issue_comments_172241.json:
```json
{
    "body": "Replying to [comment:32 leif]:\n> Replying to [comment:31 novoselt]:\n> > #14323 fixes the doctest failures, but not ecl processes...\n> \n> I'm now among the lucky few who get these greedy, immortal ECL processes:\n> \n> With Sage 5.9.beta2 (which includes #14323), GCC 4.8.0, on Ubuntu 10.04.4 x86_64, during `make` **testlong** (as opposed to `make ptestlong` -- others previously reported only the latter caused problems).\n> \n> Two ECL processes show up while testing `sage/interfaces/lisp.py` (as I had guessed), quickly start eating up memory, and keep running even after the file has been tested without any errors.\n\nSame on Ubuntu 10.04.4 x86, GCC 4.7.2, and `ptestlong`.  I also got an orphaned Maxima process (running at 100%) in the first run.  (Sage 5.9.beta2, no patches from here applied.)",
    "created_at": "2013-04-04T20:34:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172241",
    "user": "@nexttime"
}
```

Replying to [comment:32 leif]:
> Replying to [comment:31 novoselt]:
> > #14323 fixes the doctest failures, but not ecl processes...
> 
> I'm now among the lucky few who get these greedy, immortal ECL processes:
> 
> With Sage 5.9.beta2 (which includes #14323), GCC 4.8.0, on Ubuntu 10.04.4 x86_64, during `make` **testlong** (as opposed to `make ptestlong` -- others previously reported only the latter caused problems).
> 
> Two ECL processes show up while testing `sage/interfaces/lisp.py` (as I had guessed), quickly start eating up memory, and keep running even after the file has been tested without any errors.

Same on Ubuntu 10.04.4 x86, GCC 4.7.2, and `ptestlong`.  I also got an orphaned Maxima process (running at 100%) in the first run.  (Sage 5.9.beta2, no patches from here applied.)



---

archive/issue_comments_172242.json:
```json
{
    "body": "So I've continued experimenting with Sage 5.8 vs. 5.9.beta2 (same system, same compiler and flags), and it turns out that the rogue ECL processes are solely caused by the new doctesting framework, so we should probably open another ticket for that issue.  (I did the tests with the Sage cleaner \"disabled\" in both releases, too, with the same results: 5.8, with the old doctesting framework: No problems at all.  5.9.beta2: ECL orphans every time I run doctests from the Makefile, no problems when run from the command line, i.e., without using `make`.)\n\nMinimal receipt to reproduce the orphans here:\n\n```make\ntestlisp:\n        ./sage -t devel/sage/sage/interfaces/lisp.py\n```\n\nRunning `make testlisp`.\n\nThe (un)setting of `MAKE`, using `make -j1`, `./sage -t` vs. `./sage -tp` etc. doesn't matter, nor does using `$(PIPE)` (or `spkg/bin/pipestatus`), or `tee`ing the output with a \"normal\" pipe;  it just works when running `./sage -t ...` from the command line, while I get the busy orphans as soon as I run the exact same command(s) from the Makefile.\n\n(Note that also ECL didn't change between 5.8 and 5.9.beta2.)\n\nSo fixing the Sage cleaner alone *may* alleviate the problem, but won't really solve it.",
    "created_at": "2013-04-06T18:06:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172242",
    "user": "@nexttime"
}
```

So I've continued experimenting with Sage 5.8 vs. 5.9.beta2 (same system, same compiler and flags), and it turns out that the rogue ECL processes are solely caused by the new doctesting framework, so we should probably open another ticket for that issue.  (I did the tests with the Sage cleaner "disabled" in both releases, too, with the same results: 5.8, with the old doctesting framework: No problems at all.  5.9.beta2: ECL orphans every time I run doctests from the Makefile, no problems when run from the command line, i.e., without using `make`.)

Minimal receipt to reproduce the orphans here:

```make
testlisp:
        ./sage -t devel/sage/sage/interfaces/lisp.py
```

Running `make testlisp`.

The (un)setting of `MAKE`, using `make -j1`, `./sage -t` vs. `./sage -tp` etc. doesn't matter, nor does using `$(PIPE)` (or `spkg/bin/pipestatus`), or `tee`ing the output with a "normal" pipe;  it just works when running `./sage -t ...` from the command line, while I get the busy orphans as soon as I run the exact same command(s) from the Makefile.

(Note that also ECL didn't change between 5.8 and 5.9.beta2.)

So fixing the Sage cleaner alone *may* alleviate the problem, but won't really solve it.



---

archive/issue_comments_172243.json:
```json
{
    "body": "Replying to [comment:36 leif]:\n> [...]\n> Minimal receipt to reproduce the orphans here:\n> {{{\n> #!make\n> testlisp:\n>         ./sage -t devel/sage/sage/interfaces/lisp.py\n> }}}\n> Running `make testlisp`.\n> \n> The (un)setting of `MAKE`, using `make -j1`, `./sage -t` vs. `./sage -tp` etc. doesn't matter, nor does using `$(PIPE)` (or `spkg/bin/pipestatus`), or `tee`ing the output with a \"normal\" pipe;  it just works when running `./sage -t ...` from the command line, while I get the busy orphans as soon as I run the exact same command(s) from the Makefile.\n\nDid a little more testing ...\n\nWith (Ubuntu 10.04.4's) GNU Make 3.81, I do get the orphans, while I don't get them with (vanilla) GNU Make 3.82.  (I haven't found any particularly interesting change in 3.82's NEWS.)\n\nStill, at least John Cremona reported getting the orphans on Ubuntu 12.04 as well, and I strongly doubt Precise still ships GNU Make 3.81 (released 2006, while 3.82 was released in 2010, although Ubuntu might [still] patch its version, haven't checked that).  And we currently don't require the latest version of GNU Make either.",
    "created_at": "2013-04-06T22:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172243",
    "user": "@nexttime"
}
```

Replying to [comment:36 leif]:
> [...]
> Minimal receipt to reproduce the orphans here:
> {{{
> #!make
> testlisp:
>         ./sage -t devel/sage/sage/interfaces/lisp.py
> }}}
> Running `make testlisp`.
> 
> The (un)setting of `MAKE`, using `make -j1`, `./sage -t` vs. `./sage -tp` etc. doesn't matter, nor does using `$(PIPE)` (or `spkg/bin/pipestatus`), or `tee`ing the output with a "normal" pipe;  it just works when running `./sage -t ...` from the command line, while I get the busy orphans as soon as I run the exact same command(s) from the Makefile.

Did a little more testing ...

With (Ubuntu 10.04.4's) GNU Make 3.81, I do get the orphans, while I don't get them with (vanilla) GNU Make 3.82.  (I haven't found any particularly interesting change in 3.82's NEWS.)

Still, at least John Cremona reported getting the orphans on Ubuntu 12.04 as well, and I strongly doubt Precise still ships GNU Make 3.81 (released 2006, while 3.82 was released in 2010, although Ubuntu might [still] patch its version, haven't checked that).  And we currently don't require the latest version of GNU Make either.



---

archive/issue_comments_172244.json:
```json
{
    "body": "Replying to [comment:37 leif]:\n> With (Ubuntu 10.04.4's) GNU Make 3.81, I do get the orphans, while I don't get them with (vanilla) GNU Make 3.82.  (I haven't found any particularly interesting change in 3.82's NEWS.)\n> \n> Still, at least John Cremona reported getting the orphans on Ubuntu 12.04 as well, and I strongly doubt Precise still ships GNU Make 3.81 (released 2006, while 3.82 was released in 2010, although Ubuntu might [still] patch its version, haven't checked that).  And we currently don't require the latest version of GNU Make either.\n\nOh, indeed at least Ubuntu 12.04.1 LTS still has (some?) GNU Make 3.81 ... m)",
    "created_at": "2013-04-06T22:49:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172244",
    "user": "@nexttime"
}
```

Replying to [comment:37 leif]:
> With (Ubuntu 10.04.4's) GNU Make 3.81, I do get the orphans, while I don't get them with (vanilla) GNU Make 3.82.  (I haven't found any particularly interesting change in 3.82's NEWS.)
> 
> Still, at least John Cremona reported getting the orphans on Ubuntu 12.04 as well, and I strongly doubt Precise still ships GNU Make 3.81 (released 2006, while 3.82 was released in 2010, although Ubuntu might [still] patch its version, haven't checked that).  And we currently don't require the latest version of GNU Make either.

Oh, indeed at least Ubuntu 12.04.1 LTS still has (some?) GNU Make 3.81 ... m)



---

archive/issue_comments_172245.json:
```json
{
    "body": "The ECL problem is fixed and needs review at #14426.",
    "created_at": "2013-04-08T12:04:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172245",
    "user": "@jdemeyer"
}
```

The ECL problem is fixed and needs review at #14426.



---

archive/issue_comments_172246.json:
```json
{
    "body": "Here is my view on this ticket:\n\n- `sage-cleaner` used to be completely broken.\n- this ticket mostly fixes it.\n- the only flaw I see is a [comment:24 race condition], but that looks pretty rare. Fixing it can wait.\n- there are undoubtedly other ways in which `sage-cleaner` could be fixed up, but they can wait.\n\nSo I'm willing to give this a positive review. Any dissenting views?",
    "created_at": "2013-04-08T18:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172246",
    "user": "@jhpalmieri"
}
```

Here is my view on this ticket:

- `sage-cleaner` used to be completely broken.
- this ticket mostly fixes it.
- the only flaw I see is a [comment:24 race condition], but that looks pretty rare. Fixing it can wait.
- there are undoubtedly other ways in which `sage-cleaner` could be fixed up, but they can wait.

So I'm willing to give this a positive review. Any dissenting views?



---

archive/issue_comments_172247.json:
```json
{
    "body": "Replying to [comment:40 jhpalmieri]:\n> Here is my view on this ticket:\n> \n> - `sage-cleaner` used to be completely broken.\n\nI actually didn't have problems with it recently (more precisely, for meanwhile a few years), until 5.9.x.\n\n> - this ticket mostly fixes it.\n> - the only flaw I see is a [comment:24 race condition], but that looks pretty rare. Fixing it can wait.\n\nAgreed, although I haven't closely looked at that yet.  (It's pretty clear that there is a race condition, but I'm not sure how likely it is in practice.)\n\n> - there are undoubtedly other ways in which `sage-cleaner` could be fixed up, but they can wait.\n> \n> So I'm willing to give this a positive review. Any dissenting views?\n\nHmmm, *in principle<sup>TM</sup>* the Sage cleaner (with the patches from here) should have killed the ECL processes, but Andrey reported it did not, so (regardless of #12426) something seems to be still broken.",
    "created_at": "2013-04-08T19:08:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172247",
    "user": "@nexttime"
}
```

Replying to [comment:40 jhpalmieri]:
> Here is my view on this ticket:
> 
> - `sage-cleaner` used to be completely broken.

I actually didn't have problems with it recently (more precisely, for meanwhile a few years), until 5.9.x.

> - this ticket mostly fixes it.
> - the only flaw I see is a [comment:24 race condition], but that looks pretty rare. Fixing it can wait.

Agreed, although I haven't closely looked at that yet.  (It's pretty clear that there is a race condition, but I'm not sure how likely it is in practice.)

> - there are undoubtedly other ways in which `sage-cleaner` could be fixed up, but they can wait.
> 
> So I'm willing to give this a positive review. Any dissenting views?

Hmmm, *in principle<sup>TM</sup>* the Sage cleaner (with the patches from here) should have killed the ECL processes, but Andrey reported it did not, so (regardless of #12426) something seems to be still broken.



---

archive/issue_comments_172248.json:
```json
{
    "body": "Replying to [comment:41 leif]:\n> Hmmm, *in principle<sup>TM</sup>* the Sage cleaner (with the patches from here) should have killed the ECL processes, but Andrey reported it did not, so (regardless of #12426) something seems to be still broken. \n\nOoops, of course regardless of #12426, but I meant #14426.",
    "created_at": "2013-04-08T19:12:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172248",
    "user": "@nexttime"
}
```

Replying to [comment:41 leif]:
> Hmmm, *in principle<sup>TM</sup>* the Sage cleaner (with the patches from here) should have killed the ECL processes, but Andrey reported it did not, so (regardless of #12426) something seems to be still broken. 

Ooops, of course regardless of #12426, but I meant #14426.



---

archive/issue_comments_172249.json:
```json
{
    "body": "Replying to [comment:41 leif]:\n> Replying to [comment:40 jhpalmieri]:\n> > Here is my view on this ticket:\n> > \n> > - `sage-cleaner` used to be completely broken.\n> \n> I actually didn't have problems with it recently (more precisely, for meanwhile a few years), until 5.9.x.\n\nI haven't seen problems with processes, but the subdirectories of `DOT_SAGE/temp/` have been polluted with many directories dating back to 5.8 at least, because sage-cleaner was looking in the wrong directory.\n\n> Hmmm, *in principle<sup>TM</sup>* the Sage cleaner (with the patches from here) should have killed the ECL processes, but Andrey reported it did not, so (regardless of #12426) something seems to be still broken. \n\nIn your testing, could you tell whether the correct PID (for the runaway process) was written to the correct file? How did the runaway process escape the cleaner?",
    "created_at": "2013-04-08T20:00:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172249",
    "user": "@jhpalmieri"
}
```

Replying to [comment:41 leif]:
> Replying to [comment:40 jhpalmieri]:
> > Here is my view on this ticket:
> > 
> > - `sage-cleaner` used to be completely broken.
> 
> I actually didn't have problems with it recently (more precisely, for meanwhile a few years), until 5.9.x.

I haven't seen problems with processes, but the subdirectories of `DOT_SAGE/temp/` have been polluted with many directories dating back to 5.8 at least, because sage-cleaner was looking in the wrong directory.

> Hmmm, *in principle<sup>TM</sup>* the Sage cleaner (with the patches from here) should have killed the ECL processes, but Andrey reported it did not, so (regardless of #12426) something seems to be still broken. 

In your testing, could you tell whether the correct PID (for the runaway process) was written to the correct file? How did the runaway process escape the cleaner?



---

archive/issue_comments_172250.json:
```json
{
    "body": "Replying to [comment:43 jhpalmieri]:\n> Replying to [comment:41 leif]:\n> In your testing, could you tell whether the correct PID (for the runaway process) was written to the correct file? How did the runaway process escape the cleaner?\n\nThat's a question to Andrey (just in case that wasn't clear).",
    "created_at": "2013-04-08T20:10:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172250",
    "user": "@nexttime"
}
```

Replying to [comment:43 jhpalmieri]:
> Replying to [comment:41 leif]:
> In your testing, could you tell whether the correct PID (for the runaway process) was written to the correct file? How did the runaway process escape the cleaner?

That's a question to Andrey (just in case that wasn't clear).



---

archive/issue_comments_172251.json:
```json
{
    "body": "Replying to [comment:44 leif]:\n> Replying to [comment:43 jhpalmieri]:\n> > Replying to [comment:41 leif]:\n> > In your testing, could you tell whether the correct PID (for the runaway process) was written to the correct file? How did the runaway process escape the cleaner?\n> \n> That's a question to Andrey (just in case that wasn't clear).\n\nIt was not ;-) I have no idea how to check it, but if you provide me with instructions on what files to look at, I'll be happy to do it. ECL processes appear consistently for me until #14426, so reproduction is trivial.",
    "created_at": "2013-04-08T20:17:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172251",
    "user": "@novoselt"
}
```

Replying to [comment:44 leif]:
> Replying to [comment:43 jhpalmieri]:
> > Replying to [comment:41 leif]:
> > In your testing, could you tell whether the correct PID (for the runaway process) was written to the correct file? How did the runaway process escape the cleaner?
> 
> That's a question to Andrey (just in case that wasn't clear).

It was not ;-) I have no idea how to check it, but if you provide me with instructions on what files to look at, I'll be happy to do it. ECL processes appear consistently for me until #14426, so reproduction is trivial.



---

archive/issue_comments_172252.json:
```json
{
    "body": "Replying to [comment:45 novoselt]:\n> Replying to [comment:44 leif]:\n> > Replying to [comment:43 jhpalmieri]:\n> > > Replying to [comment:41 leif]:\n> > > In your testing, could you tell whether the correct PID (for the runaway process) was written to the correct file? How did the runaway process escape the cleaner?\n> > \n> > That's a question to Andrey (just in case that wasn't clear).\n> \n> It was not ;-) I have no idea how to check it, but if you provide me with instructions on what files to look at, I'll be happy to do it. ECL processes appear consistently for me until #14426, so reproduction is trivial.\n\nThe ECL processes' PIDs should be in the `spawned_processes` text file, with the patches from here now located in the directory `sage.misc.SAGE_TMP` (usually some `$DOT_SAGE/temp/<hostname>-<pid>/...` or `$DOT_SAGE/temp/<hostname>/<pid>/`?).",
    "created_at": "2013-04-08T20:38:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172252",
    "user": "@nexttime"
}
```

Replying to [comment:45 novoselt]:
> Replying to [comment:44 leif]:
> > Replying to [comment:43 jhpalmieri]:
> > > Replying to [comment:41 leif]:
> > > In your testing, could you tell whether the correct PID (for the runaway process) was written to the correct file? How did the runaway process escape the cleaner?
> > 
> > That's a question to Andrey (just in case that wasn't clear).
> 
> It was not ;-) I have no idea how to check it, but if you provide me with instructions on what files to look at, I'll be happy to do it. ECL processes appear consistently for me until #14426, so reproduction is trivial.

The ECL processes' PIDs should be in the `spawned_processes` text file, with the patches from here now located in the directory `sage.misc.SAGE_TMP` (usually some `$DOT_SAGE/temp/<hostname>-<pid>/...` or `$DOT_SAGE/temp/<hostname>/<pid>/`?).



---

archive/issue_comments_172253.json:
```json
{
    "body": "(Edited last comment.)",
    "created_at": "2013-04-08T20:40:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172253",
    "user": "@nexttime"
}
```

(Edited last comment.)



---

archive/issue_comments_172254.json:
```json
{
    "body": "Leif, I actually intended the question for you, because of the testing [comment:36 you] [comment:37 mentioned] [comment:38 above], but I'm happy for answers from anyone.",
    "created_at": "2013-04-08T20:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172254",
    "user": "@jhpalmieri"
}
```

Leif, I actually intended the question for you, because of the testing [comment:36 you] [comment:37 mentioned] [comment:38 above], but I'm happy for answers from anyone.



---

archive/issue_comments_172255.json:
```json
{
    "body": "Third attempt:\n\n`spawned_processes` should be located in `$DOT_SAGE/temp/<hostname>/<pid of [parent] Sage process>/`.\n\nThe whole naming is (still) a mess, `sage.misc.misc.SAGE_TMP` is totally unrelated to the environment variable `SAGE_TMP`.",
    "created_at": "2013-04-08T20:55:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172255",
    "user": "@nexttime"
}
```

Third attempt:

`spawned_processes` should be located in `$DOT_SAGE/temp/<hostname>/<pid of [parent] Sage process>/`.

The whole naming is (still) a mess, `sage.misc.misc.SAGE_TMP` is totally unrelated to the environment variable `SAGE_TMP`.



---

archive/issue_comments_172256.json:
```json
{
    "body": "Replying to [comment:48 jhpalmieri]:\n> Leif, I actually intended the question for you, because of the testing [comment:36 you] [comment:37 mentioned] [comment:38 above], but I'm happy for answers from anyone.\n\nWell, I thought it was not because it didn't apply; as mentioned, I completely \"disabled\" the Sage cleaner to track down the ECL issue, as the new doctesting framework was causing it.  (The Sage cleaner might just have hidden it in previous releases.)",
    "created_at": "2013-04-08T21:01:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172256",
    "user": "@nexttime"
}
```

Replying to [comment:48 jhpalmieri]:
> Leif, I actually intended the question for you, because of the testing [comment:36 you] [comment:37 mentioned] [comment:38 above], but I'm happy for answers from anyone.

Well, I thought it was not because it didn't apply; as mentioned, I completely "disabled" the Sage cleaner to track down the ECL issue, as the new doctesting framework was causing it.  (The Sage cleaner might just have hidden it in previous releases.)



---

archive/issue_comments_172257.json:
```json
{
    "body": "Oh, I didn't realize that you had disabled the creation of the spawned-processes file.\n\nBy the way, where is the environment variable `SAGE_TMP` used? I think we should only use `sage.misc.misc.SAGE_TMP` these days.",
    "created_at": "2013-04-08T21:11:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172257",
    "user": "@jhpalmieri"
}
```

Oh, I didn't realize that you had disabled the creation of the spawned-processes file.

By the way, where is the environment variable `SAGE_TMP` used? I think we should only use `sage.misc.misc.SAGE_TMP` these days.



---

archive/issue_comments_172258.json:
```json
{
    "body": "Replying to [comment:51 jhpalmieri]:\n> Oh, I didn't realize that you had disabled the creation of the spawned-processes file.\n\nNope, I just replaced `local/bin/sage-cleaner` (to just `exit 0`).\n\n\n\n\n> By the way, where is the environment variable `SAGE_TMP` used? I think we should only use `sage.misc.misc.SAGE_TMP` these days.\n\nGood question -- no idea.  I *thought* it was more or less just overriding `TMPDIR` (and used as such), but I now see it is no longer(?) documented at all anyway.",
    "created_at": "2013-04-08T21:22:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172258",
    "user": "@nexttime"
}
```

Replying to [comment:51 jhpalmieri]:
> Oh, I didn't realize that you had disabled the creation of the spawned-processes file.

Nope, I just replaced `local/bin/sage-cleaner` (to just `exit 0`).




> By the way, where is the environment variable `SAGE_TMP` used? I think we should only use `sage.misc.misc.SAGE_TMP` these days.

Good question -- no idea.  I *thought* it was more or less just overriding `TMPDIR` (and used as such), but I now see it is no longer(?) documented at all anyway.



---

archive/issue_comments_172259.json:
```json
{
    "body": "Replying to [comment:52 leif]:\n> > By the way, where is the environment variable `SAGE_TMP` used? I think we should only use `sage.misc.misc.SAGE_TMP` these days.\n> \n> Good question -- no idea.  I *thought* it was more or less just overriding `TMPDIR` (and used as such), but I now see it is no longer(?) documented at all anyway.\n\n(... and I thought `SAGE_TESTDIR` would default to it as well.)",
    "created_at": "2013-04-08T21:26:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172259",
    "user": "@nexttime"
}
```

Replying to [comment:52 leif]:
> > By the way, where is the environment variable `SAGE_TMP` used? I think we should only use `sage.misc.misc.SAGE_TMP` these days.
> 
> Good question -- no idea.  I *thought* it was more or less just overriding `TMPDIR` (and used as such), but I now see it is no longer(?) documented at all anyway.

(... and I thought `SAGE_TESTDIR` would default to it as well.)



---

archive/issue_comments_172260.json:
```json
{
    "body": "Is `sage.misc.misc.SAGE_TMP` used for anything but the cleaner files?  (IMHO the name doesn't suggest it isn't, and a \"generic\" temporary directory certainly shouldn't by default be located below `$HOME`, i.e., `~/.sage/`.)\n\nThe whole cleaner stuff should IMHO be moved to some \"var\" directory, and the names used (including the Python / shell variable names) should reflect the use.",
    "created_at": "2013-04-08T21:42:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172260",
    "user": "@nexttime"
}
```

Is `sage.misc.misc.SAGE_TMP` used for anything but the cleaner files?  (IMHO the name doesn't suggest it isn't, and a "generic" temporary directory certainly shouldn't by default be located below `$HOME`, i.e., `~/.sage/`.)

The whole cleaner stuff should IMHO be moved to some "var" directory, and the names used (including the Python / shell variable names) should reflect the use.



---

archive/issue_comments_172261.json:
```json
{
    "body": "This is probably not very useful, but:\n- I ran `make ptestlong` in sage-5.9.beta4 without any patches, got ecl processes in the end of tests and `.sage/temp/<host>` contained only two folders for a running notebook server (Can it ever be a problem if I am running multiple sages/servers under my account? I didn't notice any issues so far, so I assumed it is OK.)\n- Then I ran `make ptest` for some reason. I got ecls, no test errors, but there is now 441 folder left under `.sage/temp/<host>`. I tried grepping through them with PIDs of ecl processes, but it was useless as there were too many hits - looks like these folders were accumulated during testing and PIDs were reused multiple times.",
    "created_at": "2013-04-09T05:00:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172261",
    "user": "@novoselt"
}
```

This is probably not very useful, but:
- I ran `make ptestlong` in sage-5.9.beta4 without any patches, got ecl processes in the end of tests and `.sage/temp/<host>` contained only two folders for a running notebook server (Can it ever be a problem if I am running multiple sages/servers under my account? I didn't notice any issues so far, so I assumed it is OK.)
- Then I ran `make ptest` for some reason. I got ecls, no test errors, but there is now 441 folder left under `.sage/temp/<host>`. I tried grepping through them with PIDs of ecl processes, but it was useless as there were too many hits - looks like these folders were accumulated during testing and PIDs were reused multiple times.



---

archive/issue_comments_172262.json:
```json
{
    "body": "This ticket has nothing to do with runaway ecl, which is fixed in #14426.",
    "created_at": "2013-04-09T12:57:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172262",
    "user": "@vbraun"
}
```

This ticket has nothing to do with runaway ecl, which is fixed in #14426.



---

archive/issue_comments_172263.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-04-09T13:40:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172263",
    "user": "@vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_172264.json:
```json
{
    "body": "I made #14431 for further work on the sage cleaner. But this is better than nothing.",
    "created_at": "2013-04-09T13:40:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172264",
    "user": "@vbraun"
}
```

I made #14431 for further work on the sage cleaner. But this is better than nothing.



---

archive/issue_comments_172265.json:
```json
{
    "body": "I just noticed that the `SAGE_TMP` variables are still not in sync if the hostname contains a hyphen (as mine does), and this prevents the sage cleaner from starting on my machine. Please review the trivial 14055_cleaner_hostname.patch.",
    "created_at": "2013-04-09T14:02:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172265",
    "user": "@vbraun"
}
```

I just noticed that the `SAGE_TMP` variables are still not in sync if the hostname contains a hyphen (as mine does), and this prevents the sage cleaner from starting on my machine. Please review the trivial 14055_cleaner_hostname.patch.



---

archive/issue_comments_172266.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-04-09T14:02:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172266",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_172267.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-04-09T14:02:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172267",
    "user": "@vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_172268.json:
```json
{
    "body": "Volker, I don't understand your patch. In sage.misc.misc, `HOSTNAME` is imported from sage.env, where its definition is\n\n```\n        'HOSTNAME'         : socket.gethostname().replace('-','_').replace('/','_').replace('\\\\','_')\n```\n\nWhat does `sage.env.HOSTNAME` return on your machine? What about `sage.misc.misc.SAGE_TMP`?",
    "created_at": "2013-04-09T18:51:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172268",
    "user": "@jhpalmieri"
}
```

Volker, I don't understand your patch. In sage.misc.misc, `HOSTNAME` is imported from sage.env, where its definition is

```
        'HOSTNAME'         : socket.gethostname().replace('-','_').replace('/','_').replace('\\','_')
```

What does `sage.env.HOSTNAME` return on your machine? What about `sage.misc.misc.SAGE_TMP`?



---

archive/issue_comments_172269.json:
```json
{
    "body": "Interesting, I have on a virgin sage-5.9.beta4 install:\n\n```\nsage: sage.env.HOSTNAME\n'volker-desktop.stp.dias.ie'\nsage: sage.misc.misc.HOSTNAME\n'volker-desktop.stp.dias.ie'\nsage: sage.misc.misc.SAGE_TMP\nl'/home/vbraun/.sage/temp/volker-desktop.stp.dias.ie/17284'\n```\n\nFun ;-)",
    "created_at": "2013-04-09T19:44:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172269",
    "user": "@vbraun"
}
```

Interesting, I have on a virgin sage-5.9.beta4 install:

```
sage: sage.env.HOSTNAME
'volker-desktop.stp.dias.ie'
sage: sage.misc.misc.HOSTNAME
'volker-desktop.stp.dias.ie'
sage: sage.misc.misc.SAGE_TMP
l'/home/vbraun/.sage/temp/volker-desktop.stp.dias.ie/17284'
```

Fun ;-)



---

archive/issue_comments_172270.json:
```json
{
    "body": "Also, underscore, slash, and backslash are not valid in hostnames. And dashes (especially without spaces) are totally harmless in file names. Why?? ;-)",
    "created_at": "2013-04-09T19:45:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172270",
    "user": "@vbraun"
}
```

Also, underscore, slash, and backslash are not valid in hostnames. And dashes (especially without spaces) are totally harmless in file names. Why?? ;-)



---

archive/issue_comments_172271.json:
```json
{
    "body": "Oh there is this gem in `sage.env`:\n\n```\n# set any variables that are already in os.environ\nfor var in SAGE_ENV:\n    try:\n        exec(var + ' = os.environ[var]')\n    except KeyError:\n        pass\n```\n\nSo `HOSTNAME` is again the actual hostname, and you can't grep for it.",
    "created_at": "2013-04-09T19:52:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172271",
    "user": "@vbraun"
}
```

Oh there is this gem in `sage.env`:

```
# set any variables that are already in os.environ
for var in SAGE_ENV:
    try:
        exec(var + ' = os.environ[var]')
    except KeyError:
        pass
```

So `HOSTNAME` is again the actual hostname, and you can't grep for it.



---

archive/issue_comments_172272.json:
```json
{
    "body": "On a few systems that I tried, `os.environ['HOSTNAME']` returns a KeyError, even though `echo $HOSTNAME` returns something valid from the command line.\n\nAnyway, I'm guessing that we replace hyphens to get potentially valid Python module names. This may be an artifact of the old doctesting code. Should we patch env.py?\n\n```diff\ndiff --git a/sage/env.py b/sage/env.py\n--- a/sage/env.py\n+++ b/sage/env.py\n@@ -30,7 +30,7 @@\n SAGE_ENV = {\n         # system info\n         'UNAME'            : os.uname()[0],\n-        'HOSTNAME'         : socket.gethostname().replace('-','_').replace('/','_').replace('\\\\','_'),\n+        'HOSTNAME'         : socket.gethostname()\n         'LOCAL_IDENTIFIER' : '$HOSTNAME.%s'%os.getpid(),\n \n         # bunch of sage directories and files\n```\n\nOr is that going to break things?",
    "created_at": "2013-04-09T20:33:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172272",
    "user": "@jhpalmieri"
}
```

On a few systems that I tried, `os.environ['HOSTNAME']` returns a KeyError, even though `echo $HOSTNAME` returns something valid from the command line.

Anyway, I'm guessing that we replace hyphens to get potentially valid Python module names. This may be an artifact of the old doctesting code. Should we patch env.py?

```diff
diff --git a/sage/env.py b/sage/env.py
--- a/sage/env.py
+++ b/sage/env.py
@@ -30,7 +30,7 @@
 SAGE_ENV = {
         # system info
         'UNAME'            : os.uname()[0],
-        'HOSTNAME'         : socket.gethostname().replace('-','_').replace('/','_').replace('\\','_'),
+        'HOSTNAME'         : socket.gethostname()
         'LOCAL_IDENTIFIER' : '$HOSTNAME.%s'%os.getpid(),
 
         # bunch of sage directories and files
```

Or is that going to break things?



---

archive/issue_comments_172273.json:
```json
{
    "body": "I agree with John's suggestion. I used the opportunity to get rid of all the `eval()`s and potential infinite loop in `sage.env` ;-)",
    "created_at": "2013-04-09T20:41:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172273",
    "user": "@vbraun"
}
```

I agree with John's suggestion. I used the opportunity to get rid of all the `eval()`s and potential infinite loop in `sage.env` ;-)



---

archive/issue_comments_172274.json:
```json
{
    "body": "This change might be safer than my last proposal:\n\n```diff\ndiff --git a/sage/env.py b/sage/env.py\n--- a/sage/env.py\n+++ b/sage/env.py\n@@ -58,7 +58,10 @@\n # set any variables that are already in os.environ\n for var in SAGE_ENV:\n     try:\n-        exec(var + ' = os.environ[var]')\n+        if var == 'HOSTNAME':\n+            exec(var + ' = os.environ[var].replace(\"-\",\"_\").replace(\"/\",\"_\").replace(\"\\\\\",\"_\")')\n+        else:\n+            exec(var + ' = os.environ[var]')\n     except KeyError:\n         pass\n \n```\n\nI'll look at your patch, too.",
    "created_at": "2013-04-09T20:44:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172274",
    "user": "@jhpalmieri"
}
```

This change might be safer than my last proposal:

```diff
diff --git a/sage/env.py b/sage/env.py
--- a/sage/env.py
+++ b/sage/env.py
@@ -58,7 +58,10 @@
 # set any variables that are already in os.environ
 for var in SAGE_ENV:
     try:
-        exec(var + ' = os.environ[var]')
+        if var == 'HOSTNAME':
+            exec(var + ' = os.environ[var].replace("-","_").replace("/","_").replace("\\","_")')
+        else:
+            exec(var + ' = os.environ[var]')
     except KeyError:
         pass
 
```

I'll look at your patch, too.



---

archive/issue_comments_172275.json:
```json
{
    "body": "Line 113:\n\n```\n_add_variable_or_fallback('DOT_SAGE', \"/home/.sage\")\n```\n\ndoesn't look right: if `DOT_SAGE` has a space in it, it will remain unchanged in this situation. Perhaps `os.environ.pop('DOT_SAGE',None)` first?",
    "created_at": "2013-04-09T20:56:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172275",
    "user": "@jhpalmieri"
}
```

Line 113:

```
_add_variable_or_fallback('DOT_SAGE', "/home/.sage")
```

doesn't look right: if `DOT_SAGE` has a space in it, it will remain unchanged in this situation. Perhaps `os.environ.pop('DOT_SAGE',None)` first?



---

archive/issue_comments_172276.json:
```json
{
    "body": "Attachment [14055_simplify_env.patch](tarball://root/attachments/some-uuid/ticket14055/14055_simplify_env.patch) by @vbraun created at 2013-04-09 21:30:58\n\nUpdated patch",
    "created_at": "2013-04-09T21:30:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172276",
    "user": "@vbraun"
}
```

Attachment [14055_simplify_env.patch](tarball://root/attachments/some-uuid/ticket14055/14055_simplify_env.patch) by @vbraun created at 2013-04-09 21:30:58

Updated patch



---

archive/issue_comments_172277.json:
```json
{
    "body": "Thanks, fixed.\n\nI don't think we should muck with `$HOSTNAME`, if it exists. You can break Sage pretty badly by setting any of the supported environment variables to a weird value, so why should be special-case the hostname?",
    "created_at": "2013-04-09T21:34:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172277",
    "user": "@vbraun"
}
```

Thanks, fixed.

I don't think we should muck with `$HOSTNAME`, if it exists. You can break Sage pretty badly by setting any of the supported environment variables to a weird value, so why should be special-case the hostname?



---

archive/issue_comments_172278.json:
```json
{
    "body": "Right now we already special case the hostname, so the path of least resistance is to continue to do that. Your changes might be better, but they require more thought. I'll try to test them out, although I would appreciate other sets of eyes looking at them, too.",
    "created_at": "2013-04-09T22:25:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172278",
    "user": "@jhpalmieri"
}
```

Right now we already special case the hostname, so the path of least resistance is to continue to do that. Your changes might be better, but they require more thought. I'll try to test them out, although I would appreciate other sets of eyes looking at them, too.



---

archive/issue_comments_172279.json:
```json
{
    "body": "Volker's patch seems to work for me.\n\nA slight problem with changing how Sage processes the hostname: for me, at least, the directory `DOT_SAGE/temp/HOSTNAME` is filled with old directories which were never properly cleaned up. On my machines, `'HOSTNAME'` is not a valid key in `os.environ`, so the hyphens have been replaced by underscores. If we change sage-cleaner (etc.) to not do the replacement, we will start to use a new HOSTNAME directory, so the old one won't get cleaned up.\n\nOn one hand, this is minor, and perhaps people should clean up their own `DOT_SAGE/temp` directories. On the other hand, the directory is polluted because of a bug in Sage, so maybe we should clean it up for them. So is it worth applying a patch like [comment:67 my suggestion above] for Sage 5.9, and then in Sage 5.10, applying Volker's changes?\n\nI'm curious: why is `'HOSTNAME'` sometimes in `os.environ` and sometimes not?",
    "created_at": "2013-04-10T05:46:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172279",
    "user": "@jhpalmieri"
}
```

Volker's patch seems to work for me.

A slight problem with changing how Sage processes the hostname: for me, at least, the directory `DOT_SAGE/temp/HOSTNAME` is filled with old directories which were never properly cleaned up. On my machines, `'HOSTNAME'` is not a valid key in `os.environ`, so the hyphens have been replaced by underscores. If we change sage-cleaner (etc.) to not do the replacement, we will start to use a new HOSTNAME directory, so the old one won't get cleaned up.

On one hand, this is minor, and perhaps people should clean up their own `DOT_SAGE/temp` directories. On the other hand, the directory is polluted because of a bug in Sage, so maybe we should clean it up for them. So is it worth applying a patch like [comment:67 my suggestion above] for Sage 5.9, and then in Sage 5.10, applying Volker's changes?

I'm curious: why is `'HOSTNAME'` sometimes in `os.environ` and sometimes not?



---

archive/issue_comments_172280.json:
```json
{
    "body": "Bash set HOSTNAME, so most people have it.\n\nHow about we make the sage-cleaner fuzzy match the hostname, ignoring hyphen/underscores. I'll add a patch soon.",
    "created_at": "2013-04-10T08:57:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172280",
    "user": "@vbraun"
}
```

Bash set HOSTNAME, so most people have it.

How about we make the sage-cleaner fuzzy match the hostname, ignoring hyphen/underscores. I'll add a patch soon.



---

archive/issue_comments_172281.json:
```json
{
    "body": "Replying to [comment:72 vbraun]:\n> Bash set HOSTNAME, so most people have it.\nIt must be specific to bash because I don't see it in zsh here. Surprisingly it gets `HOST`, but not when I grep for it in `env`.\n\n```\n~\u00bb echo $HOST\nub2\n~\u00bb echo $SHELL\n/bin/zsh\n~\u00bb env | grep -i host\n~ [1] \u00bb echo $HOSTNAME\n\n~\u00bb \n```\n",
    "created_at": "2013-04-10T09:02:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172281",
    "user": "@ppurka"
}
```

Replying to [comment:72 vbraun]:
> Bash set HOSTNAME, so most people have it.
It must be specific to bash because I don't see it in zsh here. Surprisingly it gets `HOST`, but not when I grep for it in `env`.

```
~ echo $HOST
ub2
~ echo $SHELL
/bin/zsh
~ env | grep -i host
~ [1]  echo $HOSTNAME

~ 
```




---

archive/issue_comments_172282.json:
```json
{
    "body": "I've added a bit to `sage-cleaner` that will delete outdated temp directories.",
    "created_at": "2013-04-10T09:32:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172282",
    "user": "@vbraun"
}
```

I've added a bit to `sage-cleaner` that will delete outdated temp directories.



---

archive/issue_comments_172283.json:
```json
{
    "body": "Replying to [comment:72 vbraun]:\n> Bash set HOSTNAME, so most people have it.\n\nI wonder if this is specific to Bash 4. I have version 3.2 (on OS X 10.8.3 and on boxen) and HOSTNAME is not set. `echo $HOSTNAME` returns the correct thing, but HOSTNAME is not listed by `export` or `env`.",
    "created_at": "2013-04-10T16:49:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172283",
    "user": "@jhpalmieri"
}
```

Replying to [comment:72 vbraun]:
> Bash set HOSTNAME, so most people have it.

I wonder if this is specific to Bash 4. I have version 3.2 (on OS X 10.8.3 and on boxen) and HOSTNAME is not set. `echo $HOSTNAME` returns the correct thing, but HOSTNAME is not listed by `export` or `env`.



---

archive/issue_comments_172284.json:
```json
{
    "body": "What about defining `HOSTNAME` in the `sage-cleaner` script by using `from sage.env import HOSTNAME`?",
    "created_at": "2013-04-10T16:56:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172284",
    "user": "@jhpalmieri"
}
```

What about defining `HOSTNAME` in the `sage-cleaner` script by using `from sage.env import HOSTNAME`?



---

archive/issue_comments_172285.json:
```json
{
    "body": "On second thought, cleaning out the old temp/HOSTNAME directories might be a bad idea. If someone is running an old version of Sage (say, as a notebook server), and while it's running, they try out a new version, it would be bad to delete files and directories possibly in use by the old one.",
    "created_at": "2013-04-10T17:06:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172285",
    "user": "@jhpalmieri"
}
```

On second thought, cleaning out the old temp/HOSTNAME directories might be a bad idea. If someone is running an old version of Sage (say, as a notebook server), and while it's running, they try out a new version, it would be bad to delete files and directories possibly in use by the old one.



---

archive/issue_comments_172286.json:
```json
{
    "body": "There are only temporary files in there, so deleting them is not that much of an issue. Much worse is that pids get reused, the temp directory contains an old `spawned_processes`, and then on shutdown random old pids are SIGKILLed. \n\nBash sets HOSTNAME, but does not export it. The bash profile often exports HOSTNAME among other environment variables. Any further discussion on how and when bash sets HOSTNAME please on a separate ticket.",
    "created_at": "2013-04-10T17:26:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172286",
    "user": "@vbraun"
}
```

There are only temporary files in there, so deleting them is not that much of an issue. Much worse is that pids get reused, the temp directory contains an old `spawned_processes`, and then on shutdown random old pids are SIGKILLed. 

Bash sets HOSTNAME, but does not export it. The bash profile often exports HOSTNAME among other environment variables. Any further discussion on how and when bash sets HOSTNAME please on a separate ticket.



---

archive/issue_comments_172287.json:
```json
{
    "body": "Replying to [comment:76 jhpalmieri]:\n> What about defining `HOSTNAME` in the `sage-cleaner` script by using `from sage.env import HOSTNAME`?\n\nThat feature request is already on #14431.",
    "created_at": "2013-04-10T17:28:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172287",
    "user": "@vbraun"
}
```

Replying to [comment:76 jhpalmieri]:
> What about defining `HOSTNAME` in the `sage-cleaner` script by using `from sage.env import HOSTNAME`?

That feature request is already on #14431.



---

archive/issue_comments_172288.json:
```json
{
    "body": "These patches seem to be working for me on several different platforms. Anyone else have an opinion?",
    "created_at": "2013-04-12T19:24:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172288",
    "user": "@jhpalmieri"
}
```

These patches seem to be working for me on several different platforms. Anyone else have an opinion?



---

archive/issue_comments_172289.json:
```json
{
    "body": "I take that back. On mark, I get sporadic failures with\n\n```\n./sage -tp devel/sage/doc/en/constructions/\n```\n\n(with 2 threads). I get one or both of\n\n```\nsage -t devel/sage/doc/en/constructions/linear_algebra.rst  # Killed due to bus error\nsage -t devel/sage/doc/en/constructions/polynomials.rst  # Killed due to bus error\n```\n\npretty frequently, especially if I wait a while before running the tests, to make sure there are no running instances of sage-cleaner.",
    "created_at": "2013-04-12T19:51:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172289",
    "user": "@jhpalmieri"
}
```

I take that back. On mark, I get sporadic failures with

```
./sage -tp devel/sage/doc/en/constructions/
```

(with 2 threads). I get one or both of

```
sage -t devel/sage/doc/en/constructions/linear_algebra.rst  # Killed due to bus error
sage -t devel/sage/doc/en/constructions/polynomials.rst  # Killed due to bus error
```

pretty frequently, especially if I wait a while before running the tests, to make sure there are no running instances of sage-cleaner.



---

archive/issue_comments_172290.json:
```json
{
    "body": "I've also seen similar problems on taurus. With taurus, and sometimes with mark, one part of the doctest failure for linear_algebra.rst says\n\n```\nage: var('a,b,c') ## line 416 ##\n(a, b, c)\nsage: eqn = [a+b*c==1, b-a*c==0, a+b==5] ## line 418 ##\nsage: s = solve(eqn, a,b,c); s ## line 419 ##\n\n;;; Unhandled lisp initialization error\n;;; Message:\nUNBOUND-VARIABLE\n;;; Arguments:\n\nInternal or unrecoverable error in:\n\nLisp initialization error.\n\n  [2: No such file or directory]\n```\n\nIs the sage-cleaner removing some directory too early?",
    "created_at": "2013-04-12T20:56:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172290",
    "user": "@jhpalmieri"
}
```

I've also seen similar problems on taurus. With taurus, and sometimes with mark, one part of the doctest failure for linear_algebra.rst says

```
age: var('a,b,c') ## line 416 ##
(a, b, c)
sage: eqn = [a+b*c==1, b-a*c==0, a+b==5] ## line 418 ##
sage: s = solve(eqn, a,b,c); s ## line 419 ##

;;; Unhandled lisp initialization error
;;; Message:
UNBOUND-VARIABLE
;;; Arguments:

Internal or unrecoverable error in:

Lisp initialization error.

  [2: No such file or directory]
```

Is the sage-cleaner removing some directory too early?



---

archive/issue_comments_172291.json:
```json
{
    "body": "I don't see how the cleaner would cause the bus error (usually thats memory alignment or segfault).\n\nThe \"Lisp initialization error\" is #14426",
    "created_at": "2013-04-12T21:29:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172291",
    "user": "@vbraun"
}
```

I don't see how the cleaner would cause the bus error (usually thats memory alignment or segfault).

The "Lisp initialization error" is #14426



---

archive/issue_comments_172292.json:
```json
{
    "body": "On taurus, I have two copies of Sage: one vanilla 5.9.beta4, and one with the patches from here and (now) from #14426 applied: I built the ecl spkg from #14426, reinstalled maxima, ran `./sage -ba`\n\nWith the vanilla 5.9.beta4, `./sage -tp devel/sage/doc/en/constructions/` passed doctests 10 times in a row.\n\nOn the patched 5.9.beta4, the same command had failures 5 of the 10 times. I was seeing similar behavior before applying the patches from #14426.",
    "created_at": "2013-04-12T22:28:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172292",
    "user": "@jhpalmieri"
}
```

On taurus, I have two copies of Sage: one vanilla 5.9.beta4, and one with the patches from here and (now) from #14426 applied: I built the ecl spkg from #14426, reinstalled maxima, ran `./sage -ba`

With the vanilla 5.9.beta4, `./sage -tp devel/sage/doc/en/constructions/` passed doctests 10 times in a row.

On the patched 5.9.beta4, the same command had failures 5 of the 10 times. I was seeing similar behavior before applying the patches from #14426.



---

archive/issue_comments_172293.json:
```json
{
    "body": "I ran `strace -ff -o /tmp/log/trace -s 128 sage -tp doc/en/constructions/linear_algebra.rst` on my desktop and there isn't much going on in the file system:\n\n```\n$ grep ^unlink *\ntrace.13793:unlink(\"/tmp/ffiHfdBLe\")                = 0\ntrace.13793:unlink(\"/tmp/QMFB1f\")                   = 0\ntrace.13793:unlink(\"/tmp/tmp7WBqmx\")                = 0\ntrace.13793:unlink(\"/dev/shm/sem.opP4VE\")           = 0\ntrace.13793:unlink(\"/dev/shm/sem.mp13793-0\")        = 0\ntrace.13793:unlink(\"/dev/shm/sem.yHmC64\")           = 0\ntrace.13793:unlink(\"/dev/shm/sem.mp13793-1\")        = 0\ntrace.13793:unlink(\"/dev/shm/sem.8cqchv\")           = 0\ntrace.13793:unlink(\"/dev/shm/sem.mp13793-2\")        = 0\ntrace.13793:unlink(\"/tmp/tmpfadSPrV\")               = 0\ntrace.13834:unlink(\"/home/vbraun/opt/sage-5.9.beta5/local/lib/sage-force-relocate.txt\") = -1 ENOENT (No such file or directory)\ntrace.13844:unlink(\"/home/vbraun/.sage/temp/volker-desktop.stp.dias.ie/13859/spawned_processes\") = 0\n\n$ grep ^rmdir *\ntrace.13793:rmdir(\"/home/vbraun/.sage/temp/volker-desktop.stp.dias.ie/13793\") = 0\ntrace.13844:rmdir(\"/home/vbraun/.sage/temp/volker-desktop.stp.dias.ie/13859\") = 0\n\n$ grep ^rename *\ntrace.13793:rename(\"/tmp/tmp7WBqmx\", \"/home/vbraun/.sage/cache/_home_vbraun_opt_sage-5.9.beta5_devel_sage-main-lazy_import_cache.pickle\") = -1 EXDEV (Invalid cross-device link)\ntrace.13793:rename(\"/home/vbraun/.sage/tmpQCpKCj\", \"/home/vbraun/.sage/timings2.json\") = 0\n```\n\nThe only obvious race is #13826, though I don't think that could cause the lisp failure. All communication with Maxima goes through a pty.",
    "created_at": "2013-04-13T15:44:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172293",
    "user": "@vbraun"
}
```

I ran `strace -ff -o /tmp/log/trace -s 128 sage -tp doc/en/constructions/linear_algebra.rst` on my desktop and there isn't much going on in the file system:

```
$ grep ^unlink *
trace.13793:unlink("/tmp/ffiHfdBLe")                = 0
trace.13793:unlink("/tmp/QMFB1f")                   = 0
trace.13793:unlink("/tmp/tmp7WBqmx")                = 0
trace.13793:unlink("/dev/shm/sem.opP4VE")           = 0
trace.13793:unlink("/dev/shm/sem.mp13793-0")        = 0
trace.13793:unlink("/dev/shm/sem.yHmC64")           = 0
trace.13793:unlink("/dev/shm/sem.mp13793-1")        = 0
trace.13793:unlink("/dev/shm/sem.8cqchv")           = 0
trace.13793:unlink("/dev/shm/sem.mp13793-2")        = 0
trace.13793:unlink("/tmp/tmpfadSPrV")               = 0
trace.13834:unlink("/home/vbraun/opt/sage-5.9.beta5/local/lib/sage-force-relocate.txt") = -1 ENOENT (No such file or directory)
trace.13844:unlink("/home/vbraun/.sage/temp/volker-desktop.stp.dias.ie/13859/spawned_processes") = 0

$ grep ^rmdir *
trace.13793:rmdir("/home/vbraun/.sage/temp/volker-desktop.stp.dias.ie/13793") = 0
trace.13844:rmdir("/home/vbraun/.sage/temp/volker-desktop.stp.dias.ie/13859") = 0

$ grep ^rename *
trace.13793:rename("/tmp/tmp7WBqmx", "/home/vbraun/.sage/cache/_home_vbraun_opt_sage-5.9.beta5_devel_sage-main-lazy_import_cache.pickle") = -1 EXDEV (Invalid cross-device link)
trace.13793:rename("/home/vbraun/.sage/tmpQCpKCj", "/home/vbraun/.sage/timings2.json") = 0
```

The only obvious race is #13826, though I don't think that could cause the lisp failure. All communication with Maxima goes through a pty.



---

archive/issue_comments_172294.json:
```json
{
    "body": "Can we get this reviewed? Especially if you run the patchbot then you rather quickly generate directories for all pids and soon random processes are being killed.",
    "created_at": "2013-04-25T15:10:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172294",
    "user": "@vbraun"
}
```

Can we get this reviewed? Especially if you run the patchbot then you rather quickly generate directories for all pids and soon random processes are being killed.



---

archive/issue_comments_172295.json:
```json
{
    "body": "Replying to [comment:86 vbraun]:\n> Can we get this reviewed? Especially if you run the patchbot then you rather quickly generate directories for all pids and soon random processes are being killed.\n\nGo ahead... ;-)\n\nIt's not even a 5.9 blocker right now... (milestone 5.10!)",
    "created_at": "2013-04-25T15:30:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172295",
    "user": "@nexttime"
}
```

Replying to [comment:86 vbraun]:
> Can we get this reviewed? Especially if you run the patchbot then you rather quickly generate directories for all pids and soon random processes are being killed.

Go ahead... ;-)

It's not even a 5.9 blocker right now... (milestone 5.10!)



---

archive/issue_comments_172296.json:
```json
{
    "body": "Well I'm obviously giving positive review to everything that I didn't write on this ticket. We should run it on the buildbot to see if it exposes any other bugs.",
    "created_at": "2013-04-25T16:28:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172296",
    "user": "@vbraun"
}
```

Well I'm obviously giving positive review to everything that I didn't write on this ticket. We should run it on the buildbot to see if it exposes any other bugs.



---

archive/issue_comments_172297.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-04-25T17:40:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172297",
    "user": "@jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_172298.json:
```json
{
    "body": "Well, the code looks okay, and it is an improvement over what was there before. I don't understand the failures [comment:84 I mentioned earlier], but let's give it a positive review so it gets merged and gets some wider testing.",
    "created_at": "2013-04-25T17:40:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172298",
    "user": "@jhpalmieri"
}
```

Well, the code looks okay, and it is an improvement over what was there before. I don't understand the failures [comment:84 I mentioned earlier], but let's give it a positive review so it gets merged and gets some wider testing.



---

archive/issue_comments_172299.json:
```json
{
    "body": "Could you remove TAB characters from [attachment:14055_cleaner_hostname.patch]",
    "created_at": "2013-04-29T07:32:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172299",
    "user": "@jdemeyer"
}
```

Could you remove TAB characters from [attachment:14055_cleaner_hostname.patch]



---

archive/issue_comments_172300.json:
```json
{
    "body": "Updated patch",
    "created_at": "2013-04-30T09:44:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172300",
    "user": "@jdemeyer"
}
```

Updated patch



---

archive/issue_comments_172301.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-04-30T09:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172301",
    "user": "@jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_172302.json:
```json
{
    "body": "Attachment [14055_cleaner_hostname.patch](tarball://root/attachments/some-uuid/ticket14055/14055_cleaner_hostname.patch) by @jdemeyer created at 2013-04-30 09:45:27\n\nFixed trailing whitespace (including a TAB!)",
    "created_at": "2013-04-30T09:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172302",
    "user": "@jdemeyer"
}
```

Attachment [14055_cleaner_hostname.patch](tarball://root/attachments/some-uuid/ticket14055/14055_cleaner_hostname.patch) by @jdemeyer created at 2013-04-30 09:45:27

Fixed trailing whitespace (including a TAB!)



---

archive/issue_comments_172303.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2013-04-30T11:23:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172303",
    "user": "@jdemeyer"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_172304.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2013-04-30T11:23:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172304",
    "user": "@jdemeyer"
}
```

Changing status from closed to new.



---

archive/issue_comments_172305.json:
```json
{
    "body": "I am still seeing the `linear_algebra.rst` doctest failures. I don't understand how this ticket could cause it, though.",
    "created_at": "2013-04-30T11:23:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172305",
    "user": "@jdemeyer"
}
```

I am still seeing the `linear_algebra.rst` doctest failures. I don't understand how this ticket could cause it, though.



---

archive/issue_comments_172306.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2013-05-02T14:00:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172306",
    "user": "@vbraun"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_172307.json:
```json
{
    "body": "I've been running repeated doctests and the only thing that I see on taurus is occasional (about 5% of doctests runs) failure with the maxima pty interface. The trouble always starts with the assertion failure where input != echo:\n\n```\nFile \"devel/sage/doc/en/constructions/plotting.rst\", line 52, in doc.en.constructions.plotting\nFailed example:\n    L = [(i/100.0, maxima.eval('jacobi_sn (%s/100.0,2.0)'%i))for i in range(-300,300)]\nException raised:\n    Traceback (most recent call last):\n      File \"/home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 466, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 825, in execute\n        exec compiled in globs\n      File \"<doctest doc.en.constructions.plotting[0]>\", line 1, in <module>\n        L = [(i/RealNumber('100.0'), maxima.eval('jacobi_sn (%s/100.0,2.0)'%i))for i in range(-Integer(300),Integer(300))]\n      File \"/home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1208, in eval\n        for L in code.split('\\n') if L != ''])\n      File \"/home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/interfaces/maxima.py\", line 754, in _eval_line\n        assert line_echo.strip() == line.strip()\n    AssertionError\n```\n\nAnd that has nothing to do with this ticket...",
    "created_at": "2013-05-02T14:00:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172307",
    "user": "@vbraun"
}
```

I've been running repeated doctests and the only thing that I see on taurus is occasional (about 5% of doctests runs) failure with the maxima pty interface. The trouble always starts with the assertion failure where input != echo:

```
File "devel/sage/doc/en/constructions/plotting.rst", line 52, in doc.en.constructions.plotting
Failed example:
    L = [(i/100.0, maxima.eval('jacobi_sn (%s/100.0,2.0)'%i))for i in range(-300,300)]
Exception raised:
    Traceback (most recent call last):
      File "/home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 466, in _run
        self.execute(example, compiled, test.globs)
      File "/home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 825, in execute
        exec compiled in globs
      File "<doctest doc.en.constructions.plotting[0]>", line 1, in <module>
        L = [(i/RealNumber('100.0'), maxima.eval('jacobi_sn (%s/100.0,2.0)'%i))for i in range(-Integer(300),Integer(300))]
      File "/home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1208, in eval
        for L in code.split('\n') if L != ''])
      File "/home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/interfaces/maxima.py", line 754, in _eval_line
        assert line_echo.strip() == line.strip()
    AssertionError
```

And that has nothing to do with this ticket...



---

archive/issue_comments_172308.json:
```json
{
    "body": "For the record, this is the comparison that fails:\n\n```\n        assert line_echo.strip() == line.strip(), 'mismatch:\\n' + line_echo + line\n    AssertionError: mismatch:\n    jacobi_sn (-228/100 .0,2.0);\n    jacobi_sn (-228/100.0,2.0);\n```\n",
    "created_at": "2013-05-02T14:22:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172308",
    "user": "@vbraun"
}
```

For the record, this is the comparison that fails:

```
        assert line_echo.strip() == line.strip(), 'mismatch:\n' + line_echo + line
    AssertionError: mismatch:
    jacobi_sn (-228/100 .0,2.0);
    jacobi_sn (-228/100.0,2.0);
```




---

archive/issue_comments_172309.json:
```json
{
    "body": "Attachment [trac_14055_maxima_debug.patch](tarball://root/attachments/some-uuid/ticket14055/trac_14055_maxima_debug.patch) by @vbraun created at 2013-05-02 14:32:46\n\nInitial patch",
    "created_at": "2013-05-02T14:32:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172309",
    "user": "@vbraun"
}
```

Attachment [trac_14055_maxima_debug.patch](tarball://root/attachments/some-uuid/ticket14055/trac_14055_maxima_debug.patch) by @vbraun created at 2013-05-02 14:32:46

Initial patch



---

archive/issue_comments_172310.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2013-05-02T14:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172310",
    "user": "@vbraun"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_172311.json:
```json
{
    "body": "I don't know why there are random spaces sprinkled in, but it certainly doesn't have anything to do with this ticket. I haven't found any other failures on taurus.",
    "created_at": "2013-05-02T14:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172311",
    "user": "@vbraun"
}
```

I don't know why there are random spaces sprinkled in, but it certainly doesn't have anything to do with this ticket. I haven't found any other failures on taurus.



---

archive/issue_comments_172312.json:
```json
{
    "body": "Volker, I don't see how your patch would affect the error reported in [comment:82].",
    "created_at": "2013-05-02T15:05:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172312",
    "user": "@jdemeyer"
}
```

Volker, I don't see how your patch would affect the error reported in [comment:82].



---

archive/issue_comments_172313.json:
```json
{
    "body": "What I'm saying is, I could not reproduce (on taurus) the error reported in comment:82. It might be a miscompile or a transient hardware error as far as I can tell.",
    "created_at": "2013-05-02T15:23:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172313",
    "user": "@vbraun"
}
```

What I'm saying is, I could not reproduce (on taurus) the error reported in comment:82. It might be a miscompile or a transient hardware error as far as I can tell.



---

archive/issue_comments_172314.json:
```json
{
    "body": "See also https://groups.google.com/d/msg/sage-release/07skjCnmRCI/Oyxm1EIquMEJ",
    "created_at": "2013-05-02T15:24:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172314",
    "user": "@vbraun"
}
```

See also https://groups.google.com/d/msg/sage-release/07skjCnmRCI/Oyxm1EIquMEJ



---

archive/issue_comments_172315.json:
```json
{
    "body": "Running with `nice -19` and background load seems to trigger it, I now get some maxima segfaults somewhat reliably. They look like a race in the multi-threaded ecl to me, for example the following failure:\n\n```\nsage: s = solve(eqn, a,b,c); s ## line 419 ##\n\n;;; Unhandled lisp initialization error\n;;; Message:\nunbound-variable\n;;; Arguments:\n\nInternal or unrecoverable error in:\n\nLisp initialization error.\n\n  [2: No such file or directory]\n\n;;; ECL C Backtrace\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(si_dump_c_backtrace+0x28) [0x7f01f330e1d8]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_internal_error+0x3f) [0x7f01f32f91af]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x1242f4) [0x7f01f32f92f4]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(cl_funcall+0x70) [0x7f01f32dc3f0]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(cl_error+0xdb) [0x7f01f32fa13b]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x125482) [0x7f01f32fa482]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(FEwrong_type_argument+0x1e) [0x7f01f32fa4ae]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(stream_dispatch_table+0x17) [0x7f01f32ece17]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_write_char+0x1b) [0x7f01f32ed6ab]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x13766b) [0x7f01f330c66b]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(_ecl_write_symbol+0x156) [0x7f01f330cbc6]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(si_write_ugly_object+0x26) [0x7f01f330bcc6]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x1242db) [0x7f01f32f92db]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(cl_funcall+0x70) [0x7f01f32dc3f0]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(cl_error+0xdb) [0x7f01f32fa13b]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x1252d8) [0x7f01f32fa2d8]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_interpret+0x19cd) [0x7f01f32de67d]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x10e34f) [0x7f01f32e334f]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(si_eval_with_env+0x2eb) [0x7f01f32e4f0b]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(si_signal_simple_error+0x26d) [0x7f01f32a9e4d]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(FEwrong_type_nth_arg+0x109) [0x7f01f32f9cf9]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(_ecl_sethash+0) [0x7f01f3326170]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x14df28) [0x7f01f3322f28]\n;;; /lib64/libpthread.so.0() [0x324440f500]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x1503e0) [0x7f01f33253e0]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x15172c) [0x7f01f332672c]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_extend_hashtable+0x185) [0x7f01f3326335]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x151716) [0x7f01f3326716]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x11c4dc) [0x7f01f32f14dc]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_init_module+0x4e8) [0x7f01f32f7298]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(init_lib_LSP+0x4c9) [0x7f01f3218089]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_init_module+0x399) [0x7f01f32f7149]\n```\n",
    "created_at": "2013-05-02T16:08:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172315",
    "user": "@vbraun"
}
```

Running with `nice -19` and background load seems to trigger it, I now get some maxima segfaults somewhat reliably. They look like a race in the multi-threaded ecl to me, for example the following failure:

```
sage: s = solve(eqn, a,b,c); s ## line 419 ##

;;; Unhandled lisp initialization error
;;; Message:
unbound-variable
;;; Arguments:

Internal or unrecoverable error in:

Lisp initialization error.

  [2: No such file or directory]

;;; ECL C Backtrace
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(si_dump_c_backtrace+0x28) [0x7f01f330e1d8]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_internal_error+0x3f) [0x7f01f32f91af]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x1242f4) [0x7f01f32f92f4]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(cl_funcall+0x70) [0x7f01f32dc3f0]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(cl_error+0xdb) [0x7f01f32fa13b]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x125482) [0x7f01f32fa482]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(FEwrong_type_argument+0x1e) [0x7f01f32fa4ae]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(stream_dispatch_table+0x17) [0x7f01f32ece17]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_write_char+0x1b) [0x7f01f32ed6ab]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x13766b) [0x7f01f330c66b]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(_ecl_write_symbol+0x156) [0x7f01f330cbc6]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(si_write_ugly_object+0x26) [0x7f01f330bcc6]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x1242db) [0x7f01f32f92db]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(cl_funcall+0x70) [0x7f01f32dc3f0]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(cl_error+0xdb) [0x7f01f32fa13b]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x1252d8) [0x7f01f32fa2d8]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_interpret+0x19cd) [0x7f01f32de67d]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x10e34f) [0x7f01f32e334f]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(si_eval_with_env+0x2eb) [0x7f01f32e4f0b]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(si_signal_simple_error+0x26d) [0x7f01f32a9e4d]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(FEwrong_type_nth_arg+0x109) [0x7f01f32f9cf9]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(_ecl_sethash+0) [0x7f01f3326170]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x14df28) [0x7f01f3322f28]
;;; /lib64/libpthread.so.0() [0x324440f500]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x1503e0) [0x7f01f33253e0]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x15172c) [0x7f01f332672c]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_extend_hashtable+0x185) [0x7f01f3326335]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x151716) [0x7f01f3326716]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x11c4dc) [0x7f01f32f14dc]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_init_module+0x4e8) [0x7f01f32f7298]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(init_lib_LSP+0x4c9) [0x7f01f3218089]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_init_module+0x399) [0x7f01f32f7149]
```




---

archive/issue_comments_172316.json:
```json
{
    "body": "strace of failed ecl startup (from taurus)",
    "created_at": "2013-05-04T12:07:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172316",
    "user": "@vbraun"
}
```

strace of failed ecl startup (from taurus)



---

archive/issue_comments_172317.json:
```json
{
    "body": "Attachment [log.10693](tarball://root/attachments/some-uuid/ticket14055/log.10693) by @vbraun created at 2013-05-04 12:30:02\n\nI've attached an strace from a failed ECL startup on taurus. It seems that during dlopen of ECL an unrelated thread (id 16046) happens to finish which causes a SIGCHLD. If the ECL signal handler is not turned off during init then that would explain things going south. Nils, since you wrote it maybe you have an opinion on that?",
    "created_at": "2013-05-04T12:30:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172317",
    "user": "@vbraun"
}
```

Attachment [log.10693](tarball://root/attachments/some-uuid/ticket14055/log.10693) by @vbraun created at 2013-05-04 12:30:02

I've attached an strace from a failed ECL startup on taurus. It seems that during dlopen of ECL an unrelated thread (id 16046) happens to finish which causes a SIGCHLD. If the ECL signal handler is not turned off during init then that would explain things going south. Nils, since you wrote it maybe you have an opinion on that?



---

archive/issue_comments_172318.json:
```json
{
    "body": "The last time I looked at it, ECL as a library with multithread support is rather fundamentally incompatible with the way we use it. As far as I know, if thread support is enabled then ECL expects one (dedicated?) thread to handle asynchronous signals and I think that thread may even be split off when there's otherwise only one thread running. I don't see how to consolidate that with our own signal management. The solution up to know has been to only use ECL in single threaded mode, which may mean building it without thread support. I know ECL has been moving towards multithreadedness. However, as an \"embeddable\" lisp there's a good argument they should also keep a strictly single-threaded version as an option and I hope they're continuing with that (perhaps sending a message that we really appreciate single threadedness might help).\n\nOur signal switching code has been a little behind the times for a while already. Some improvements were suggested here:\n\nhttp://comments.gmane.org/gmane.lisp.ecl.general/8211\n\nThat code might be outdated already as well.\n\nWhat is the hypothesis here, by the way? That an event triggered by sage-cleaner produces a signal meant for our own signal handler that happens to end up in with the ecl signal handler? If that's the problem I see no way around it. Then we just need to write our own signal handler to always be in control, keeping flags on whether some signals might have to be dispatched to ECL and do so for signals we deem appropriate for that. That's major surgery (I've actually been surprised we were able to avoid that for so long and I hope we can continue)\n\nI guess normally, ECL expects SIGCHLD to be ignored. We apparently set a different mask? Changing to ECL's signal mask would include ignoring a SIGCHLD if it happens to be in control when the signal arrives. Can we afford to? Do we already try to do that? In that case is the problem that the signal arrives in a small window where we've switched handlers but not masks? Then we should be a little more careful about the switch, i.e., perhaps disable signals during the switch completely.",
    "created_at": "2013-05-04T18:44:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172318",
    "user": "@nbruin"
}
```

The last time I looked at it, ECL as a library with multithread support is rather fundamentally incompatible with the way we use it. As far as I know, if thread support is enabled then ECL expects one (dedicated?) thread to handle asynchronous signals and I think that thread may even be split off when there's otherwise only one thread running. I don't see how to consolidate that with our own signal management. The solution up to know has been to only use ECL in single threaded mode, which may mean building it without thread support. I know ECL has been moving towards multithreadedness. However, as an "embeddable" lisp there's a good argument they should also keep a strictly single-threaded version as an option and I hope they're continuing with that (perhaps sending a message that we really appreciate single threadedness might help).

Our signal switching code has been a little behind the times for a while already. Some improvements were suggested here:

http://comments.gmane.org/gmane.lisp.ecl.general/8211

That code might be outdated already as well.

What is the hypothesis here, by the way? That an event triggered by sage-cleaner produces a signal meant for our own signal handler that happens to end up in with the ecl signal handler? If that's the problem I see no way around it. Then we just need to write our own signal handler to always be in control, keeping flags on whether some signals might have to be dispatched to ECL and do so for signals we deem appropriate for that. That's major surgery (I've actually been surprised we were able to avoid that for so long and I hope we can continue)

I guess normally, ECL expects SIGCHLD to be ignored. We apparently set a different mask? Changing to ECL's signal mask would include ignoring a SIGCHLD if it happens to be in control when the signal arrives. Can we afford to? Do we already try to do that? In that case is the problem that the signal arrives in a small window where we've switched handlers but not masks? Then we should be a little more careful about the switch, i.e., perhaps disable signals during the switch completely.



---

archive/issue_comments_172319.json:
```json
{
    "body": "For the record, we build ECL with `--disable-threads` so it shouldn't have any multithread support. It does link with pthreads, though perhaps boehmgc needs that. \n\nI don't think the sage-cleaner has anything to do with the problem. It just slightly changes timings so that we happen to trigger a rather unlikely race on taurus/skynet. It certainly should not send any signals except for term/kill.\n\nThe new doctest framework seems to be the only thing that uses SIGCHLD in the Sage library.",
    "created_at": "2013-05-04T20:08:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172319",
    "user": "@vbraun"
}
```

For the record, we build ECL with `--disable-threads` so it shouldn't have any multithread support. It does link with pthreads, though perhaps boehmgc needs that. 

I don't think the sage-cleaner has anything to do with the problem. It just slightly changes timings so that we happen to trigger a rather unlikely race on taurus/skynet. It certainly should not send any signals except for term/kill.

The new doctest framework seems to be the only thing that uses SIGCHLD in the Sage library.



---

archive/issue_comments_172320.json:
```json
{
    "body": "Replying to [comment:102 vbraun]:\n> For the record, we build ECL with `--disable-threads` so it shouldn't have any multithread support. It does link with pthreads, though perhaps boehmgc needs that. \n\nOK, good.\n\n> I don't think the sage-cleaner has anything to do with the problem.\n\nSo perhaps this should go on a different ticket then?\n\n> The new doctest framework seems to be the only thing that uses SIGCHLD in the Sage library.\n\nI took a quick look at [unixint.d](http://sourceforge.net/p/ecls/ecl/ci/master/tree/src/c/unixint.d) and it seems ECL does install a handler for SIGCHLD. Perhaps you're just unlucky that the SIGCHLD gets delivered at a very inopportune moment when ECL hasn't quite finished setting up its handlers? Or are we just sloppy in how we change handlers? The handler they use is defined in [unixsys.d](http://sourceforge.net/p/ecls/ecl/ci/master/tree/src/c/unixsys.d) as `si::wait-for-all-processes`.",
    "created_at": "2013-05-04T20:31:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172320",
    "user": "@nbruin"
}
```

Replying to [comment:102 vbraun]:
> For the record, we build ECL with `--disable-threads` so it shouldn't have any multithread support. It does link with pthreads, though perhaps boehmgc needs that. 

OK, good.

> I don't think the sage-cleaner has anything to do with the problem.

So perhaps this should go on a different ticket then?

> The new doctest framework seems to be the only thing that uses SIGCHLD in the Sage library.

I took a quick look at [unixint.d](http://sourceforge.net/p/ecls/ecl/ci/master/tree/src/c/unixint.d) and it seems ECL does install a handler for SIGCHLD. Perhaps you're just unlucky that the SIGCHLD gets delivered at a very inopportune moment when ECL hasn't quite finished setting up its handlers? Or are we just sloppy in how we change handlers? The handler they use is defined in [unixsys.d](http://sourceforge.net/p/ecls/ecl/ci/master/tree/src/c/unixsys.d) as `si::wait-for-all-processes`.



---

archive/issue_comments_172321.json:
```json
{
    "body": "Switching off ECL_OPT_TRAP_SIGCHLD seems to fix it (knock on wood). 50x testing linear_algebra.rst on taurus works with the new spkg (you need to recompile maxima after ecl).",
    "created_at": "2013-05-04T21:42:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172321",
    "user": "@vbraun"
}
```

Switching off ECL_OPT_TRAP_SIGCHLD seems to fix it (knock on wood). 50x testing linear_algebra.rst on taurus works with the new spkg (you need to recompile maxima after ecl).



---

archive/issue_comments_172322.json:
```json
{
    "body": "diff for review only: ecl-12.12.1.p2 -> ecl-12.12.1.p3",
    "created_at": "2013-05-04T21:45:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172322",
    "user": "@vbraun"
}
```

diff for review only: ecl-12.12.1.p2 -> ecl-12.12.1.p3



---

archive/issue_comments_172323.json:
```json
{
    "body": "Attachment [ecl-p3.diff](tarball://root/attachments/some-uuid/ticket14055/ecl-p3.diff) by @jdemeyer created at 2013-05-05 20:01:47\n\nVolker, if this works, it's a very nice piece of debugging. Testing right away...",
    "created_at": "2013-05-05T20:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172323",
    "user": "@jdemeyer"
}
```

Attachment [ecl-p3.diff](tarball://root/attachments/some-uuid/ticket14055/ecl-p3.diff) by @jdemeyer created at 2013-05-05 20:01:47

Volker, if this works, it's a very nice piece of debugging. Testing right away...



---

archive/issue_comments_172324.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-05-06T15:16:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172324",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_172325.json:
```json
{
    "body": "I ran 500 iterations for `linear_algebra.rst` and didn't get any failures. The \"random space in output\" presumably has also been caused by the SIGCHLD handler.",
    "created_at": "2013-05-06T16:43:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172325",
    "user": "@vbraun"
}
```

I ran 500 iterations for `linear_algebra.rst` and didn't get any failures. The "random space in output" presumably has also been caused by the SIGCHLD handler.



---

archive/issue_comments_172326.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-05-08T07:43:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13851#issuecomment-172326",
    "user": "@jdemeyer"
}
```

Resolution: fixed
