# Issue 28770: faster permutation conversions between GAP and Sage

Issue created by migration from https://trac.sagemath.org/ticket/29007

Original creator: vdelecroix

Original creation time: 2020-01-14 06:50:44

CC:  chapoton tscrim sbrandhorst

`PermutationGroupElement` conversions in C to and from GAP.


---

Comment by vdelecroix created at 2020-01-14 06:51:08

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2020-01-14 06:51:08

New commits:


---

Comment by tscrim created at 2020-01-14 07:42:13

Is there a reason why one would call `_set_libgap` outside of the element constructor? I really don't see why that should not be `cdef`. Then you could remove the second type check and the `raise TypeError` case.

Also, `cdef UInt2 * p2` looks weird to me, like it should be multiplication. Instead, I would follow "correct" C format `cdef UInt2* p2` since it is a `UInt2` pointer or the less optimal (but also common) `cdef UInt2 *p2`.


---

Comment by git created at 2020-01-15 12:23:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-01-15 12:28:36

Replying to [comment:2 tscrim]:
> Is there a reason why one would call `_set_libgap` outside of the element constructor? I really don't see why that should not be `cdef`. Then you could remove the second type check and the `raise TypeError` case.

See #28652#comment:30

> Also, `cdef UInt2 * p2` looks weird to me, like it should be multiplication. Instead, I would follow "correct" C format `cdef UInt2* p2` since it is a `UInt2` pointer or the less optimal (but also common) `cdef UInt2 *p2`.

Done. I found `int* p` is very bad when multiple declarations comes in such as `int* p, q`.


---

Comment by tscrim created at 2020-01-15 16:23:41

Replying to [comment:4 vdelecroix]:
> Replying to [comment:2 tscrim]:
> > Is there a reason why one would call `_set_libgap` outside of the element constructor? I really don't see why that should not be `cdef`. Then you could remove the second type check and the `raise TypeError` case.
> 
> See #28652#comment:30

I still do not see the point, but this is an improvement so I am not going to argue about it.

> > Also, `cdef UInt2 * p2` looks weird to me, like it should be multiplication. Instead, I would follow "correct" C format `cdef UInt2* p2` since it is a `UInt2` pointer or the less optimal (but also common) `cdef UInt2 *p2`.
> 
> Done.

There are others that need to be changed.

> I found `int* p` is very bad when multiple declarations comes in such as `int* p, q`.

In this case, how I was told you should interpret `int*` is as the type "an int pointer." So it once you see it a bit and get used to it, I don't look bad IMO.


---

Comment by vdelecroix created at 2020-01-15 16:34:30

Replying to [comment:5 tscrim]:
> Replying to [comment:4 vdelecroix]:
> > Replying to [comment:2 tscrim]:
> > I found `int* p` is very bad when multiple declarations comes in such as `int* p, q`.
> 
> In this case, how I was told you should interpret `int*` is as the type "an int pointer." So it once you see it a bit and get used to it, I don't look bad IMO.

Which is a wrong interpretation as `int* p, q` does not declare `q` as a pointer.


---

Comment by git created at 2020-01-15 16:36:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2020-01-15 17:15:24

Replying to [comment:6 vdelecroix]:
> Replying to [comment:5 tscrim]:
> > Replying to [comment:4 vdelecroix]:
> > > Replying to [comment:2 tscrim]:
> > > I found `int* p` is very bad when multiple declarations comes in such as `int* p, q`.
> > 
> > In this case, how I was told you should interpret `int*` is as the type "an int pointer." So it once you see it a bit and get used to it, I don't look bad IMO.
> 
> Which is a wrong interpretation as `int* p, q` does not declare `q` as a pointer.

Hmm...so then what I saw then was wrong (well, suppose to be limited to a single variable declaration). I also did a bit more digging, and where the `*` goes depends on more on whether they are trained as a C or C++ programmer. Now that makes me think the `*` should go with the variable. Anyways, we can just leave it as is if you don't want to make the change. Either way you decide to do it, you can set a positive review.


---

Comment by chapoton created at 2020-01-15 18:56:49

My patchbot petitbonum reports (twice) an error (segmentation fault) in

```
sage -t --long src/sage/groups/perm_gps/cubegroup.py
```

that seems to really come from this ticket, as the patchbot itself works fine on pristine sage 9.1.b0.


---

Comment by vdelecroix created at 2020-01-15 22:07:26

Indeed. I can reproduce that!


---

Comment by git created at 2020-01-15 22:40:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-01-15 22:41:12

The problem that I was using some GAP internal functions without it being initialized properly. It should be fine now (at least tests pass on my computer).


---

Comment by tscrim created at 2020-01-16 03:20:49

Typo `_libap_` -> `_libgap_`.


---

Comment by git created at 2020-01-16 09:46:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-01-16 09:46:54

oups. fixed.


---

Comment by chapoton created at 2020-01-16 12:39:41

green bot, and looks good to me. Travis, do you approve ?


---

Comment by tscrim created at 2020-01-16 15:07:05

Indeed. LGTM.


---

Comment by tscrim created at 2020-01-16 15:07:05

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2020-01-16 16:26:06

merci!


---

Comment by vbraun created at 2020-01-22 20:40:50

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-01-22 20:40:50

On Py2:

```
**********************************************************************
File "src/sage/libs/gap/element.pyx", line 671, in sage.libs.gap.element.GapElement._type_number
Failed example:
    x._type_number()
Expected:
    (0L, 'T_INT (integer)')
Got:
    (0, 'T_INT (integer)')
**********************************************************************
1 item had failures:
   1 of   3 in sage.libs.gap.element.GapElement._type_number
    [503 tests, 1 failure, 1.90 s]
**********************************************************************
```



---

Comment by chapoton created at 2020-01-22 20:59:00

ok, this kind of annoying thing will be fixed later (similar to the problem fixed in #29049) but for the moment just use `...`

EDIT: not sure if the sentence above makes any sense, but too tired to think right


---

Comment by git created at 2020-01-23 08:01:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-01-23 08:01:38

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2020-01-23 12:30:02

But then the doctest doesn't pass on Py3, right? I think Frédéric was put `0...,` instead of `0,` or `0L,`.


---

Comment by vdelecroix created at 2020-01-23 13:35:24

It does pass on the patchbot.


---

Comment by tscrim created at 2020-01-23 14:31:48

Ah, probably because of the other thing Frédéric mentioned. Well, this will work for now.


---

Comment by tscrim created at 2020-01-23 14:31:48

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-01-25 17:27:17

Resolution: fixed
