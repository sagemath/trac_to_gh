# Issue 22774: ECL sometimes doesn't handle signals in a timely manner

Issue created by migration from https://trac.sagemath.org/ticket/23011

Original creator: embray

Original creation time: 2017-05-16 15:44:34

Keywords: ecl cygwin

The following test sometimes blocks / fails due to timeout:


```python
from sage.libs.ecl import *
from cysignals.tests import interrupt_after_delay
ecl_eval("(setf i 0)")
inf_loop = ecl_eval("(defun infinite() (loop (incf i)))")
interrupt_after_delay(1000)
print("starting loop")
inf_loop()
```


This will _sometimes_ block indefinitely, at least on Cygwin--I have not tested on other platforms yet.

The issue isn't with `interrupt_after_delay` itself, since replacing `inf_loop` with a long `sleep()` doesn't exhibit the problem.

The problem appears to be fixed upstream in the development version of ECL.  I traced the fix to [this commit](https://gitlab.com/embeddable-common-lisp/ecl/commit/0c9e67345c364b3d41acca899d80a5c0c35152a6) which is pretty bizarre, as it doesn't have anything to do with signal handling.  Yet I'm certain this is the one.  What I suspect is that something in the `(loop)` macro had slow behavior due to the bug this commit fixed, and that that slow behavior was taking place while signal handling is disabled (`ecl_disable_interrupts()`).

After applying the fix it doesn't appear to block signals anymore, or if it does it's only for a very small amount of time, so the failure should be much more rare.


---

Comment by embray created at 2017-05-16 15:52:28

I've added the fix from upstream as a patch to Sage's ECL.

The patch should also apply cleanly to ECL 6.1.3 (#22191) and the issue is still present in that version.
----
New commits:


---

Comment by embray created at 2017-05-16 15:52:28

Changing status from new to needs_review.


---

Comment by tscrim created at 2017-05-16 21:35:21

Does this depend on #22191? Do we want to try and get #22191 progressing again?


---

Comment by jdemeyer created at 2017-05-18 07:42:16

Does Cygwin have something like `strace`? It would be interesting to see the output of that.

On Linux:

```
write(1, "starting loop\n", 14)         = 14
rt_sigaction(SIGINT, {0x7fb763cb1f50, ~[KILL STOP RTMIN RT_1], SA_RESTORER|SA_SIGINFO, 0x7fb8242a6860}, {0x7fb8179bcac0, [HUP INT ALRM], SA_RESTORER, 0x7fb8242a6860}, 8
rt_sigaction(SIGBUS, {0x7fb763cb1fc0, ~[KILL STOP RTMIN RT_1], SA_RESTORER|SA_SIGINFO, 0x7fb8242a6860}, {0x7fb8179bc8c0, [HUP INT ALRM], SA_RESTORER|SA_NODEFER, 0x7fb82
rt_sigaction(SIGSEGV, {0x7fb763cb1fc0, ~[KILL STOP RTMIN RT_1], SA_RESTORER|SA_SIGINFO, 0x7fb8242a6860}, {0x7fb8179bc8c0, [HUP INT ALRM], SA_RESTORER|SA_NODEFER, 0x7fb8
rt_sigprocmask(SIG_BLOCK, NULL, [], 8)  = 0
brk(0x7e76000)                          = 0x7e76000
brk(0x7eb6000)                          = 0x7eb6000
rt_sigprocmask(SIG_BLOCK, NULL, [], 8)  = 0
rt_sigprocmask(SIG_BLOCK, NULL, [], 8)  = 0
rt_sigprocmask(SIG_BLOCK, NULL, [], 8)  = 0
rt_sigprocmask(SIG_BLOCK, NULL, [], 8)  = 0
rt_sigprocmask(SIG_BLOCK, NULL, [], 8)  = 0
rt_sigprocmask(SIG_BLOCK, NULL, [], 8)  = 0
rt_sigprocmask(SIG_BLOCK, NULL, [], 8)  = 0
rt_sigprocmask(SIG_BLOCK, NULL, [], 8)  = 0
rt_sigprocmask(SIG_BLOCK, NULL, [], 8)  = 0
rt_sigprocmask(SIG_BLOCK, NULL, [], 8)  = 0
rt_sigprocmask(SIG_BLOCK, NULL, [], 8)  = 0
rt_sigprocmask(SIG_BLOCK, NULL, [], 8)  = 0
rt_sigprocmask(SIG_BLOCK, NULL, [], 8)  = 0
rt_sigprocmask(SIG_BLOCK, NULL, [], 8)  = 0
rt_sigprocmask(SIG_BLOCK, NULL, [], 8)  = 0
--- SIGINT {si_signo=SIGINT, si_code=SI_USER, si_pid=12670, si_uid=1038} ---
rt_sigprocmask(SIG_SETMASK, [], NULL, 8) = 0
rt_sigaction(SIGINT, {0x7fb8179bcac0, [HUP INT ALRM], SA_RESTORER, 0x7fb8242a6860}, NULL, 8) = 0
rt_sigaction(SIGBUS, {0x7fb8179bc8c0, [HUP INT ALRM], SA_RESTORER|SA_NODEFER, 0x7fb8242a6860}, NULL, 8) = 0
rt_sigaction(SIGSEGV, {0x7fb8179bc8c0, [HUP INT ALRM], SA_RESTORER|SA_NODEFER, 0x7fb8242a6860}, NULL, 8) = 0
futex(0x1ec4400, FUTEX_WAKE_PRIVATE, 1) = 1
futex(0x1ec4400, FUTEX_WAKE_PRIVATE, 1) = 1
ioctl(1, TIOCGWINSZ, {ws_row=44, ws_col=168, ws_xpixel=0, ws_ypixel=0}) = 0
futex(0x1ec4400, FUTEX_WAIT_BITSET_PRIVATE|FUTEX_CLOCK_REALTIME, 0, NULL, ffffffff) = 0
futex(0x1ec4400, FUTEX_WAKE_PRIVATE, 1) = 1
futex(0x1ec4400, FUTEX_WAKE_PRIVATE, 1) = 1
futex(0x1ec4400, FUTEX_WAKE_PRIVATE, 1) = 1
stat("/usr/local/src/sage-git/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py", {st_mode=S_IFREG|0644, st_size=132017, ...}) = 0
```



---

Comment by embray created at 2017-05-18 08:47:20

Replying to [comment:3 tscrim]:
> Does this depend on #22191? Do we want to try and get #22191 progressing again?

As I wrote in the comment just above this, it should be independent of that :)


---

Comment by embray created at 2017-05-18 08:53:10

Yes, there's an strace.  Sometimes it's helpful.  Actually when I first started working on this issue I was focusing on the `interrupt_after_delay` implementation, which I thought might have a race condition, but that wasn't it.  I haven't looked at what ECL is doing in that loop, but maybe I'll take a look now just for comparison's sake.  Is this problem not reproducible in Linux?


---

Comment by jdemeyer created at 2017-05-18 09:36:19

Replying to [comment:6 embray]:
> Is this problem not reproducible in Linux?

You mention that it's a doctest. So if the problem would occur on Linux, surely somebody would have mentioned it and I cannot remember ever seeing this problem.

It could be that there is a genuine race condition on all systems, but that it only manifests itself on Cygwin due to different timing of things.

Looking at the trace, the many lines with `rt_sigprocmask(SIG_BLOCK, NULL, [], 8)  = 0` do look strange. Just by itself, it's nothing problematic though.


---

Comment by embray created at 2017-05-18 12:17:24

Replying to [comment:7 jdemeyer]:
> Replying to [comment:6 embray]:
> > Is this problem not reproducible in Linux?
> 
> You mention that it's a doctest. So if the problem would occur on Linux, surely somebody would have mentioned it and I cannot remember ever seeing this problem.

It happens semi-randomly though.

> It could be that there is a genuine race condition on all systems, but that it only manifests itself on Cygwin due to different timing of things.

Right, it wouldn't be the first time.  I think this is most likely too.

> Looking at the trace, the many lines with `rt_sigprocmask(SIG_BLOCK, NULL, [], 8)  = 0` do look strange. Just by itself, it's nothing problematic though.

With the patch applied I don't see this at all--when it gets to the loop, strace output goes silent.  I'm about to try rebuilding again without the patch.


---

Comment by embray created at 2017-05-18 16:18:00

Yeah, this is still a bit of a mystery.  All I can see is that the loop calls `longjmp` once per loop, and this _can_ interfere with signal handling, but not for very long so that's not likely a problem.  And the `longjmp` doesn't go away with this patch either, nor do I see why it would make a difference.


---

Comment by vbraun created at 2017-06-10 10:57:57

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-06-10 10:57:57

Since its an upstream patch anyways we should probably merge it even if we don't 100% understand where the timing issue comes from...


---

Comment by vbraun created at 2017-06-12 18:01:22

Resolution: fixed


---

Comment by embray created at 2017-06-14 08:55:49

Thanks, and I agree.  I just wish I understood better; it's quite mysterious.


---

Comment by dimpase created at 2017-09-01 10:45:37

Erik, I reckon you have a branch for using a development version of ECL. If so, would you mind sharing it, I think I need to try it on #22679.


---

Comment by embray created at 2017-09-01 10:49:08

Replying to [comment:13 dimpase]:
> Erik, I reckon you have a branch for using a development version of ECL. If so, would you mind sharing it, I think I need to try it on #22679.

I don't think I have anything exactly like that.  Right now, when I want to test dev versions of packages, I just copy the `build/pkgs/<pkgname>` directory somewhere, and then check out the git repo into that under `src/`, then run `./spkg-install` manually (in a `sage -sh`).


---

Comment by dimpase created at 2017-09-02 08:16:23

Replying to [comment:14 embray]:
> Replying to [comment:13 dimpase]:
> > Erik, I reckon you have a branch for using a development version of ECL. If so, would you mind sharing it, I think I need to try it on #22679.
> 
> I don't think I have anything exactly like that.  Right now, when I want to test dev versions of packages, I just copy the `build/pkgs/<pkgname>` directory somewhere, and then check out the git repo into that under `src/`, then run `./spkg-install` manually (in a `sage -sh`).

Doing this with the latest snapshot I then get an error building ecl extension:

```
src/build/cythonized/sage/libs/ecl.c:3701:57: error: use of undeclared identifier 'ECL_OPT_TRAP_SIGCHLD'; did you mean 'ECL_OPT_TRAP_SIGILL'?
```

and indeed `ECL_OPT_TRAP_SIGCHLD` is gone, so one needs to rework the interface.
Probably it was a recent change and you didn't hit it then...
