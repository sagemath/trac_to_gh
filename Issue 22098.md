# Issue 22098: py3 : compilation problem involving PyInt_AS_LONG

archive/issues_022098.json:
```json
{
    "body": "CC:  @jdemeyer\n\nonce the last calls to cmp() in pyx files will be removed, the next failure will be this one:\n\n```\n[sagelib-7.6.beta3] sage/geometry/triangulation/triangulations.cc: In function 'triangulations* init_triangulations(int, int, int, bool, PyObject*, PyObject*)':\n[sagelib-7.6.beta3] sage/geometry/triangulation/triangulations.cc:121:41: error: 'PyInt_AS_LONG' was not declared in this scope\n```\n\nI include a branch to allow others to reproduce:\n\n```\nexport SAGE_PYTHON3=yes\nmake build\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/22335\n\n",
    "created_at": "2017-02-09T12:36:39Z",
    "labels": [
        "PLEASE CHANGE",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.6",
    "title": "py3 : compilation problem involving PyInt_AS_LONG",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22098",
    "user": "@fchapoton"
}
```
CC:  @jdemeyer

once the last calls to cmp() in pyx files will be removed, the next failure will be this one:

```
[sagelib-7.6.beta3] sage/geometry/triangulation/triangulations.cc: In function 'triangulations* init_triangulations(int, int, int, bool, PyObject*, PyObject*)':
[sagelib-7.6.beta3] sage/geometry/triangulation/triangulations.cc:121:41: error: 'PyInt_AS_LONG' was not declared in this scope
```

I include a branch to allow others to reproduce:

```
export SAGE_PYTHON3=yes
make build
```


Issue created by migration from https://trac.sagemath.org/ticket/22335





---

archive/issue_comments_306965.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to python3.",
    "created_at": "2017-02-09T12:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306965",
    "user": "@fchapoton"
}
```

Changing component from PLEASE CHANGE to python3.



---

archive/issue_comments_306966.json:
```json
{
    "body": "One problem is that `PyInt_AS_LONG` is often used in performance-critical code.\n\nSo whatever you do **be aware of performance regressions** in this ticket. Although it could very well be that such regressions are inevitable.",
    "created_at": "2017-02-09T20:12:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306966",
    "user": "@jdemeyer"
}
```

One problem is that `PyInt_AS_LONG` is often used in performance-critical code.

So whatever you do **be aware of performance regressions** in this ticket. Although it could very well be that such regressions are inevitable.



---

archive/issue_comments_306967.json:
```json
{
    "body": "It's actually not as bad as I thought since Cython does support `PyInt_AS_LONG`.",
    "created_at": "2017-02-09T20:26:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306967",
    "user": "@jdemeyer"
}
```

It's actually not as bad as I thought since Cython does support `PyInt_AS_LONG`.



---

archive/issue_comments_306968.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2017-02-09T20:26:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306968",
    "user": "@jdemeyer"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_306969.json:
```json
{
    "body": "As the author I'd say replacing it with PyLong_AsLong should fix it.",
    "created_at": "2017-02-09T21:07:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306969",
    "user": "@vbraun"
}
```

As the author I'd say replacing it with PyLong_AsLong should fix it.



---

archive/issue_comments_306970.json:
```json
{
    "body": "I think I do not understand the conclusion..\n\nWell, as this is way above my head, could please one of you handle that ?",
    "created_at": "2017-02-09T21:10:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306970",
    "user": "@fchapoton"
}
```

I think I do not understand the conclusion..

Well, as this is way above my head, could please one of you handle that ?



---

archive/issue_comments_306971.json:
```json
{
    "body": "Alternatively, we could `#include` those C++ files in the Cython sources instead of compiling them separately. Then `PyInt_AS_LONG` would be handled by Cython.",
    "created_at": "2017-02-10T07:41:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306971",
    "user": "@jdemeyer"
}
```

Alternatively, we could `#include` those C++ files in the Cython sources instead of compiling them separately. Then `PyInt_AS_LONG` would be handled by Cython.



---

archive/issue_comments_306972.json:
```json
{
    "body": "I tried by replacing with PyLong_AsLong. It seems to work (in python3).\n\nNext problem (similar ?):\n\n```\n[sagelib-7.6.beta3] /home/chapoton/sage3/src/sage/libs/pynac/wrap.h: In function 'PyObject* _to_PyString_latex(const T*)':\n[sagelib-7.6.beta3] /home/chapoton/sage3/src/sage/libs/pynac/wrap.h:118:50: error: there are no arguments to 'PyString_FromString' that depend on a template parameter, so a declaration of 'PyString_FromString' must be available [-fpermissive]\n[sagelib-7.6.beta3]    return PyString_FromString(instore.str().data());\n[sagelib-7.6.beta3]\n[sagelib-7.6.beta3] /home/chapoton/sage3/src/build/cythonized/sage/libs/pynac/pynac.cpp:5478:47: error: 'PyString_AsString' was not declared in this scope\n```\n\n\nEDIT: see #22341",
    "created_at": "2017-02-10T08:59:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306972",
    "user": "@fchapoton"
}
```

I tried by replacing with PyLong_AsLong. It seems to work (in python3).

Next problem (similar ?):

```
[sagelib-7.6.beta3] /home/chapoton/sage3/src/sage/libs/pynac/wrap.h: In function 'PyObject* _to_PyString_latex(const T*)':
[sagelib-7.6.beta3] /home/chapoton/sage3/src/sage/libs/pynac/wrap.h:118:50: error: there are no arguments to 'PyString_FromString' that depend on a template parameter, so a declaration of 'PyString_FromString' must be available [-fpermissive]
[sagelib-7.6.beta3]    return PyString_FromString(instore.str().data());
[sagelib-7.6.beta3]
[sagelib-7.6.beta3] /home/chapoton/sage3/src/build/cythonized/sage/libs/pynac/pynac.cpp:5478:47: error: 'PyString_AsString' was not declared in this scope
```


EDIT: see #22341



---

archive/issue_comments_306973.json:
```json
{
    "body": "I removed the test branch (kept as public/pyint_as_long_in_cc)\n\nand added a branch making the needed changes in triangulations.\n----\nNew commits:",
    "created_at": "2017-02-10T16:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306973",
    "user": "@fchapoton"
}
```

I removed the test branch (kept as public/pyint_as_long_in_cc)

and added a branch making the needed changes in triangulations.
----
New commits:



---

archive/issue_comments_306974.json:
```json
{
    "body": "there is another instance in src/sage/modular/arithgroup/farey.cpp\n\nbut maybe we can see later if we need to change it also.",
    "created_at": "2017-02-10T16:58:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306974",
    "user": "@fchapoton"
}
```

there is another instance in src/sage/modular/arithgroup/farey.cpp

but maybe we can see later if we need to change it also.



---

archive/issue_comments_306975.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2017-02-11T22:30:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306975",
    "user": "@fchapoton"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_306976.json:
```json
{
    "body": "some failing doctest",
    "created_at": "2017-02-11T22:30:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306976",
    "user": "@fchapoton"
}
```

some failing doctest



---

archive/issue_comments_306977.json:
```json
{
    "body": "typical failing doctest:\n\n```\nFile \"src/sage/geometry/triangulation/base.pyx\", line 903, in sage.geometry.triangulation.base.ConnectedTriangulationsIterator\nFailed example:\n    next(ci)\nExpected:\n    (2, 3, 4, 5)\nGot:\n    (2L, 3L, 4L, 5L)\n```\n\nProbably in python3, the result will stil be (2, 3, 4, 5).\n\nVolker or Jeroen, any suggestion on how to have doctests working both in py2 and py3 ?\n\nCasting these integers to Integer ? I would prefer not.\n\nOr just use apply \"str\" to display the results without the trailing L ?",
    "created_at": "2017-02-13T15:36:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306977",
    "user": "@fchapoton"
}
```

typical failing doctest:

```
File "src/sage/geometry/triangulation/base.pyx", line 903, in sage.geometry.triangulation.base.ConnectedTriangulationsIterator
Failed example:
    next(ci)
Expected:
    (2, 3, 4, 5)
Got:
    (2L, 3L, 4L, 5L)
```

Probably in python3, the result will stil be (2, 3, 4, 5).

Volker or Jeroen, any suggestion on how to have doctests working both in py2 and py3 ?

Casting these integers to Integer ? I would prefer not.

Or just use apply "str" to display the results without the trailing L ?



---

archive/issue_comments_306978.json:
```json
{
    "body": "Well, I don't think that replacing `PyInt...` by `PyLong...` is a correct solution anyway.\n\nI'd like to know what Volker thinks about [comment:7]",
    "created_at": "2017-02-13T15:40:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306978",
    "user": "@jdemeyer"
}
```

Well, I don't think that replacing `PyInt...` by `PyLong...` is a correct solution anyway.

I'd like to know what Volker thinks about [comment:7]



---

archive/issue_comments_306979.json:
```json
{
    "body": "Well I'm not really a fan of including c++ files, thats ought to be the compiler's job. All that Cython does is \n\n```\n#if PY_MAJOR_VERSION >= 3\n  #define PyInt_FromLong               PyLong_FromLong\n  #define PyInt_AsLong                 PyLong_AsLong\n  #define PyInt_AS_LONG                PyLong_AS_LONG\n#endif\n```\n\nI'd just put that in the offending C++ files..",
    "created_at": "2017-02-13T19:21:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306979",
    "user": "@vbraun"
}
```

Well I'm not really a fan of including c++ files, thats ought to be the compiler's job. All that Cython does is 

```
#if PY_MAJOR_VERSION >= 3
  #define PyInt_FromLong               PyLong_FromLong
  #define PyInt_AsLong                 PyLong_AsLong
  #define PyInt_AS_LONG                PyLong_AS_LONG
#endif
```

I'd just put that in the offending C++ files..



---

archive/issue_comments_306980.json:
```json
{
    "body": "ok, I have tried to add the suggested lines.\nI put them in the .h files, near the top.\nPlease tell me if this is ok.\nI am going to launch my bot on it now.\n----\nNew commits:",
    "created_at": "2017-02-13T20:35:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306980",
    "user": "@fchapoton"
}
```

ok, I have tried to add the suggested lines.
I put them in the .h files, near the top.
Please tell me if this is ok.
I am going to launch my bot on it now.
----
New commits:



---

archive/issue_comments_306981.json:
```json
{
    "body": "bot seems to be green, please review",
    "created_at": "2017-02-14T08:12:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306981",
    "user": "@fchapoton"
}
```

bot seems to be green, please review



---

archive/issue_comments_306982.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2017-02-14T10:10:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306982",
    "user": "@fchapoton"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_306983.json:
```json
{
    "body": "ping ?",
    "created_at": "2017-02-17T18:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306983",
    "user": "@fchapoton"
}
```

ping ?



---

archive/issue_comments_306984.json:
```json
{
    "body": "Positive review but author name is missing...",
    "created_at": "2017-02-17T18:59:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306984",
    "user": "@jdemeyer"
}
```

Positive review but author name is missing...



---

archive/issue_comments_306985.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-02-17T18:59:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306985",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_306986.json:
```json
{
    "body": "thanks",
    "created_at": "2017-02-17T19:32:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306986",
    "user": "@fchapoton"
}
```

thanks



---

archive/issue_comments_306987.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-02-23T12:00:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22098",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22098#issuecomment-306987",
    "user": "@vbraun"
}
```

Resolution: fixed
