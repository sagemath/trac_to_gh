# Issue 22098: py3 : compilation problem involving PyInt_AS_LONG

Issue created by migration from https://trac.sagemath.org/ticket/22335

Original creator: chapoton

Original creation time: 2017-02-09 12:36:39

CC:  jdemeyer

once the last calls to cmp() in pyx files will be removed, the next failure will be this one:

```
[sagelib-7.6.beta3] sage/geometry/triangulation/triangulations.cc: In function 'triangulations* init_triangulations(int, int, int, bool, PyObject*, PyObject*)':
[sagelib-7.6.beta3] sage/geometry/triangulation/triangulations.cc:121:41: error: 'PyInt_AS_LONG' was not declared in this scope
```

I include a branch to allow others to reproduce:

```
export SAGE_PYTHON3=yes
make build
```



---

Comment by chapoton created at 2017-02-09 12:36:56

Changing component from PLEASE CHANGE to python3.


---

Comment by jdemeyer created at 2017-02-09 20:12:06

One problem is that `PyInt_AS_LONG` is often used in performance-critical code.

So whatever you do *be aware of performance regressions* in this ticket. Although it could very well be that such regressions are inevitable.


---

Comment by jdemeyer created at 2017-02-09 20:26:33

It's actually not as bad as I thought since Cython does support `PyInt_AS_LONG`.


---

Comment by jdemeyer created at 2017-02-09 20:26:33

Changing type from PLEASE CHANGE to enhancement.


---

Comment by vbraun created at 2017-02-09 21:07:17

As the author I'd say replacing it with PyLong_AsLong should fix it.


---

Comment by chapoton created at 2017-02-09 21:10:55

I think I do not understand the conclusion..

Well, as this is way above my head, could please one of you handle that ?


---

Comment by jdemeyer created at 2017-02-10 07:41:01

Alternatively, we could `#include` those C++ files in the Cython sources instead of compiling them separately. Then `PyInt_AS_LONG` would be handled by Cython.


---

Comment by chapoton created at 2017-02-10 08:59:45

I tried by replacing with PyLong_AsLong. It seems to work (in python3).

Next problem (similar ?):

```
[sagelib-7.6.beta3] /home/chapoton/sage3/src/sage/libs/pynac/wrap.h: In function 'PyObject* _to_PyString_latex(const T*)':
[sagelib-7.6.beta3] /home/chapoton/sage3/src/sage/libs/pynac/wrap.h:118:50: error: there are no arguments to 'PyString_FromString' that depend on a template parameter, so a declaration of 'PyString_FromString' must be available [-fpermissive]
[sagelib-7.6.beta3]    return PyString_FromString(instore.str().data());
[sagelib-7.6.beta3]
[sagelib-7.6.beta3] /home/chapoton/sage3/src/build/cythonized/sage/libs/pynac/pynac.cpp:5478:47: error: 'PyString_AsString' was not declared in this scope
```


EDIT: see #22341


---

Comment by chapoton created at 2017-02-10 16:56:28

I removed the test branch (kept as public/pyint_as_long_in_cc)

and added a branch making the needed changes in triangulations.
----
New commits:


---

Comment by chapoton created at 2017-02-10 16:58:44

there is another instance in src/sage/modular/arithgroup/farey.cpp

but maybe we can see later if we need to change it also.


---

Comment by chapoton created at 2017-02-11 22:30:54

Changing status from new to needs_info.


---

Comment by chapoton created at 2017-02-11 22:30:54

some failing doctest


---

Comment by chapoton created at 2017-02-13 15:36:59

typical failing doctest:

```
File "src/sage/geometry/triangulation/base.pyx", line 903, in sage.geometry.triangulation.base.ConnectedTriangulationsIterator
Failed example:
    next(ci)
Expected:
    (2, 3, 4, 5)
Got:
    (2L, 3L, 4L, 5L)
```

Probably in python3, the result will stil be (2, 3, 4, 5).

Volker or Jeroen, any suggestion on how to have doctests working both in py2 and py3 ?

Casting these integers to Integer ? I would prefer not.

Or just use apply "str" to display the results without the trailing L ?


---

Comment by jdemeyer created at 2017-02-13 15:40:14

Well, I don't think that replacing `PyInt...` by `PyLong...` is a correct solution anyway.

I'd like to know what Volker thinks about [comment:7]


---

Comment by vbraun created at 2017-02-13 19:21:57

Well I'm not really a fan of including c++ files, thats ought to be the compiler's job. All that Cython does is 

```
#if PY_MAJOR_VERSION >= 3
  #define PyInt_FromLong               PyLong_FromLong
  #define PyInt_AsLong                 PyLong_AsLong
  #define PyInt_AS_LONG                PyLong_AS_LONG
#endif
```

I'd just put that in the offending C++ files..


---

Comment by chapoton created at 2017-02-13 20:35:25

ok, I have tried to add the suggested lines.
I put them in the .h files, near the top.
Please tell me if this is ok.
I am going to launch my bot on it now.
----
New commits:


---

Comment by chapoton created at 2017-02-14 08:12:16

bot seems to be green, please review


---

Comment by chapoton created at 2017-02-14 10:10:35

Changing status from needs_info to needs_review.


---

Comment by chapoton created at 2017-02-17 18:21:02

ping ?


---

Comment by jdemeyer created at 2017-02-17 18:59:06

Positive review but author name is missing...


---

Comment by jdemeyer created at 2017-02-17 18:59:06

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2017-02-17 19:32:17

thanks


---

Comment by vbraun created at 2017-02-23 12:00:36

Resolution: fixed
