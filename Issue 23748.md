# Issue 23748: rst2ipynb causes doctest failures if pandoc is not installed

Issue created by migration from https://trac.sagemath.org/ticket/23985

Original creator: mderickx

Original creation time: 2017-10-07 18:11:22

CC:  nthiery

The following is not very surprising as pandoc is listed as a requirement on https://pypi.python.org/pypi/rst2ipynb/0.2.0 .

```
bt-nac-b021:sagedev mderickx$ ./sage -t --long src/sage/tests/cmdline.py 
Forcing sage-location, probably because a new package was installed.
Cleaning up, do not interrupt this.
Done cleaning.
Running doctests with ID 2017-10-07-20-05-33-76cbb199.
Git branch: 23971
Using --optional=ccache,gmpy2,mpir,normaliz,openssl,pandoc_attributes,pandocfilters,pynormaliz,python2,rst2ipynb,sage
Doctesting 1 file.
sage -t --long --warn-long 44.4 src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 655, in sage.tests.cmdline.test_executable
Failed example:
    print(out)                           # optional - rst2ipynb
Expected:
    {
     "nbformat_minor": ...,
     "nbformat": ...,
     "cells": [
      {
       "source": [
        "$$\n",
        "\\def\\CC{\\bf C}\n",
        "\\def\\QQ{\\bf Q}\n",
        "\\def\\RR{\\bf R}\n",
        "\\def\\ZZ{\\bf Z}\n",
        "\\def\\NN{\\bf N}\n",
        "$$"
       ],
       "cell_type": "markdown",
       "metadata": {}
      },
      {
       "execution_count": null,
       "cell_type": "code",
       "source": [
        "2^10"
       ],
       "outputs": [
        {
         "execution_count": 1,
         "output_type": "execute_result",
         "data": {
          "text/plain": [
           "1024"
          ]
         },
         "metadata": {}
        }
       ],
       "metadata": {}
      },
      {
       "execution_count": null,
       "cell_type": "code",
       "source": [
        "2 + 2"
       ],
       "outputs": [
        {
         "execution_count": 1,
         "output_type": "execute_result",
         "data": {
          "text/plain": [
           "4"
          ]
         },
         "metadata": {}
        }
       ],
       "metadata": {}
      }
     ],
     "metadata": {
      "kernelspec": {
       "display_name": "sagemath",
       "name": "sagemath"
      }
     }
    }
Got:
    <BLANKLINE>
**********************************************************************
File "src/sage/tests/cmdline.py", line 721, in sage.tests.cmdline.test_executable
Failed example:
    err                   # optional - rst2ipynb
Expected:
    ''
Got:
    'ERROR: rst2ipnb requires pandoc; please install it on your system.\n'
**********************************************************************
File "src/sage/tests/cmdline.py", line 723, in sage.tests.cmdline.test_executable
Failed example:
    ret                   # optional - rst2ipynb
Expected:
    0
Got:
    1
**********************************************************************
File "src/sage/tests/cmdline.py", line 734, in sage.tests.cmdline.test_executable
Failed example:
    test_executable(L)              # optional - rst2ipynb
Expected:
    ('', '', 0)
Got:
    ('', 'ERROR: rst2ipnb requires pandoc; please install it on your system.\n', 1)
**********************************************************************
File "src/sage/tests/cmdline.py", line 736, in sage.tests.cmdline.test_executable
Failed example:
    print(open(output, 'r').read()) # optional - rst2ipynb
Expected:
    {
     "nbformat_minor": ...,
     "nbformat": ...,
     "cells": [
      {
       "source": [
        "$$\n",
        "\\def\\CC{\\bf C}\n",
        "\\def\\QQ{\\bf Q}\n",
    ...
     "metadata": {
      "kernelspec": {
       "display_name": "sagemath",
       "name": "sagemath"
      }
     }
    }
Got:
    <BLANKLINE>
**********************************************************************
1 item had failures:
   5 of 251 in sage.tests.cmdline.test_executable
    [250 tests, 5 failures, 64.90 s]
----------------------------------------------------------------------
sage -t --long --warn-long 44.4 src/sage/tests/cmdline.py  # 5 doctests failed
----------------------------------------------------------------------
Total time for all tests: 65.0 seconds
    cpu time: 1.4 seconds
    cumulative wall time: 64.9 seconds

```



---

Comment by mderickx created at 2017-10-07 18:21:28

Hi Jeroen,

Would you think testing for pandoc during the installation of rst2ipynb and printing a clear error message redirecting the end user to https://pandoc.org/installing.html would be a good way to solve this? From the website it seems that this is a mature project that is easy to install on every platform we support and more. And building it ourselves from source would require a haskell compiler, and I rather not add this to sage if not needed, even not as optional package.


---

Comment by jdemeyer created at 2017-10-09 08:47:45

There are also Python packages related to pandoc. Maybe the error would better be raised there. I'll check...


---

Comment by jdemeyer created at 2017-10-09 12:41:45

New commits:


---

Comment by jdemeyer created at 2017-10-09 12:41:45

Changing status from new to needs_review.


---

Comment by mderickx created at 2017-10-09 15:39:35

Changing status from needs_review to positive_review.


---

Comment by mderickx created at 2017-10-09 15:39:35

I like the fix you made, and the install now fails as it should. However because of the standard pip + sage failed install bloat, this means that the actual error is somewhere hidden in a bunch of noise so long that on my machine I actually have to scroll up to see the useful part of the error message. I would not have seen it if I was not reviewing this ticket and knew what to look for. So giving positive review since this fixes the blocker part of this ticket, but I am creating a follow up ticket to make the error messages more user friendly.


```
[rst2ipynb-0.2.2.p0] Installing collected packages: rst2ipynb
[rst2ipynb-0.2.2.p0]   Running setup.py install for rst2ipynb: started
[rst2ipynb-0.2.2.p0]     Running command /Applications/sagedev/local/bin/python2 -u -c "import setuptools, tokenize;__file__='/private/var/folders/36/zx43_ll10r1dt47nqpbgmrs80000gn/T/pip-DMBGQ3-build/setup.py';f=getattr(tokenize, 'open', open)(__file__);code=f.read().replace('\r\n', '\n');f.close();exec(compile(code, __file__, 'exec'))" --no-user-cfg install --record /var/folders/36/zx43_ll10r1dt47nqpbgmrs80000gn/T/pip-zR3Z5F-record/install-record.txt --single-version-externally-managed --compile
[rst2ipynb-0.2.2.p0]     running install
[rst2ipynb-0.2.2.p0]     error: rst2ipynb requires the Haskell program 'pandoc'. You need to install it on your system.
[rst2ipynb-0.2.2.p0]     Running setup.py install for rst2ipynb: finished with status 'error'
[rst2ipynb-0.2.2.p0] Cleaning up...
[rst2ipynb-0.2.2.p0]   Removing source in /private/var/folders/36/zx43_ll10r1dt47nqpbgmrs80000gn/T/pip-DMBGQ3-build
[rst2ipynb-0.2.2.p0] Command "/Applications/sagedev/local/bin/python2 -u -c "import setuptools, tokenize;__file__='/private/var/folders/36/zx43_ll10r1dt47nqpbgmrs80000gn/T/pip-DMBGQ3-build/setup.py';f=getattr(tokenize, 'open', open)(__file__);code=f.read().replace('\r\n', '\n');f.close();exec(compile(code, __file__, 'exec'))" --no-user-cfg install --record /var/folders/36/zx43_ll10r1dt47nqpbgmrs80000gn/T/pip-zR3Z5F-record/install-record.txt --single-version-externally-managed --compile" failed with error code 1 in /private/var/folders/36/zx43_ll10r1dt47nqpbgmrs80000gn/T/pip-DMBGQ3-build/
[rst2ipynb-0.2.2.p0] Exception information:
[rst2ipynb-0.2.2.p0] Traceback (most recent call last):
[rst2ipynb-0.2.2.p0]   File "/Applications/sagedev/local/lib/python2.7/site-packages/pip/basecommand.py", line 215, in main
[rst2ipynb-0.2.2.p0]     status = self.run(options, args)
[rst2ipynb-0.2.2.p0]   File "/Applications/sagedev/local/lib/python2.7/site-packages/pip/commands/install.py", line 342, in run
[rst2ipynb-0.2.2.p0]     prefix=options.prefix_path,
[rst2ipynb-0.2.2.p0]   File "/Applications/sagedev/local/lib/python2.7/site-packages/pip/req/req_set.py", line 784, in install
[rst2ipynb-0.2.2.p0]     **kwargs
[rst2ipynb-0.2.2.p0]   File "/Applications/sagedev/local/lib/python2.7/site-packages/pip/req/req_install.py", line 878, in install
[rst2ipynb-0.2.2.p0]     spinner=spinner,
[rst2ipynb-0.2.2.p0]   File "/Applications/sagedev/local/lib/python2.7/site-packages/pip/utils/__init__.py", line 707, in call_subprocess
[rst2ipynb-0.2.2.p0]     % (command_desc, proc.returncode, cwd))
[rst2ipynb-0.2.2.p0] InstallationError: Command "/Applications/sagedev/local/bin/python2 -u -c "import setuptools, tokenize;__file__='/private/var/folders/36/zx43_ll10r1dt47nqpbgmrs80000gn/T/pip-DMBGQ3-build/setup.py';f=getattr(tokenize, 'open', open)(__file__);code=f.read().replace('\r\n', '\n');f.close();exec(compile(code, __file__, 'exec'))" --no-user-cfg install --record /var/folders/36/zx43_ll10r1dt47nqpbgmrs80000gn/T/pip-zR3Z5F-record/install-record.txt --single-version-externally-managed --compile" failed with error code 1 in /private/var/folders/36/zx43_ll10r1dt47nqpbgmrs80000gn/T/pip-DMBGQ3-build/
[rst2ipynb-0.2.2.p0] Error: installing with pip2 failed
[rst2ipynb-0.2.2.p0] 
[rst2ipynb-0.2.2.p0] real	0m3.995s
[rst2ipynb-0.2.2.p0] user	0m3.273s
[rst2ipynb-0.2.2.p0] sys	0m0.619s
[rst2ipynb-0.2.2.p0] ************************************************************************
[rst2ipynb-0.2.2.p0] Error installing package rst2ipynb-0.2.2.p0
[rst2ipynb-0.2.2.p0] ************************************************************************
[rst2ipynb-0.2.2.p0] Please email sage-devel (http://groups.google.com/group/sage-devel)
[rst2ipynb-0.2.2.p0] explaining the problem and including the log file
[rst2ipynb-0.2.2.p0]   /Applications/sagedev/logs/pkgs/rst2ipynb-0.2.2.p0.log
[rst2ipynb-0.2.2.p0] Describe your computer, operating system, etc.
[rst2ipynb-0.2.2.p0] If you want to try to fix the problem yourself, *don't* just cd to
[rst2ipynb-0.2.2.p0] /Applications/sagedev/local/var/tmp/sage/build/rst2ipynb-0.2.2.p0 and type 'make' or whatever is appropriate.
[rst2ipynb-0.2.2.p0] Instead, the following commands setup all environment variables
[rst2ipynb-0.2.2.p0] correctly and load a subshell for you to debug the error:
[rst2ipynb-0.2.2.p0]   (cd '/Applications/sagedev/local/var/tmp/sage/build/rst2ipynb-0.2.2.p0' && '/Applications/sagedev/sage' --sh)
[rst2ipynb-0.2.2.p0] When you are done debugging, you can type "exit" to leave the subshell.
[rst2ipynb-0.2.2.p0] ************************************************************************
make[1]: *** [/Applications/sagedev/local/var/lib/sage/installed/rst2ipynb-0.2.2.p0] Error 1

real	0m4.407s
user	0m3.504s
sys	0m0.751s
***************************************************************
Error building Sage.

The following package(s) may have failed to build (not necessarily
during this run of 'make rst2ipynb'):

* package: rst2ipynb-0.2.2.p0
  log file: /Applications/sagedev/logs/pkgs/rst2ipynb-0.2.2.p0.log
  build directory: /Applications/sagedev/local/var/tmp/sage/build/rst2ipynb-0.2.2.p0

The build directory may contain configuration files and other potentially
helpful information. WARNING: if you now run 'make' again, the build
directory will, by default, be deleted. Set the environment variable
SAGE_KEEP_BUILT_SPKGS to 'yes' to prevent this.

make: *** [rst2ipynb] Error 1
```



---

Comment by mderickx created at 2017-10-09 16:10:00

Created #23999


---

Comment by vbraun created at 2017-10-09 20:02:48

Reviewer name


---

Comment by vbraun created at 2017-10-09 20:02:48

Changing status from positive_review to needs_work.


---

Comment by mderickx created at 2017-10-09 21:12:38

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2017-10-16 22:44:59

Resolution: fixed


---

Comment by nthiery created at 2017-10-17 21:31:30

Does it help at this stage if I do a new release of rst2ipynb?


---

Comment by jdemeyer created at 2017-10-18 08:44:00

For Sage, a new version does not help since we already include the patch.

I'll let you decide how important the patch is for non-Sage users who are doing `pip install rst2ipynb` without having `pandoc` installed. I would say: when in doubt, do make a release. It shouldn't take more than 10 minutes to actually do that.


---

Comment by nthiery created at 2017-10-18 15:43:34

rst2ipynb 0.3.3 is out, including another pull request improving parsing of python continuation prompts. So worth a release.
