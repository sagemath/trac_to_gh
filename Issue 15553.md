# Issue 15553: GCD of sparse univariate polynomials over ZZ

Issue created by migration from Trac.

Original creator: bruno

Original creation time: 2014-02-06 12:23:40

CC:  vdelecroix

Keywords: GCD sparse

The GCD of two sparse polynomials over `ZZ` is not computed. If the polynomials are in dense representation or if they are in sparse representation but defined over `QQ`, there is no problem. 


```
sage: R1.<x>=PolynomialRing(ZZ,'x',sparse=true)
sage: R2.<x>=PolynomialRing(ZZ,'x',sparse=false)
sage: R3.<x>=PolynomialRing(QQ,'x',sparse=true)
sage: p=x^2-3*x+2
sage: q=x^2-1
sage: gcd(R2(p),R2(q))
x - 1
sage: gcd(R3(p),R3(q))
x - 1
sage: gcd(R1(p),R1(q))
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-6-0d7380207fef> in <module>()
----> 1 gcd(R1(p),R1(q))

/home/bgrenet/bin/sage-6.0-x86_64-Linux/local/lib/python2.7/site-packages/sage/rings/arith.pyc in gcd(a, b, **kwargs)
   1605                 return ZZ(a).gcd(ZZ(b))
   1606             except TypeError:
-> 1607                 raise TypeError("unable to find gcd")
   1608         return GCD(b, **kwargs)
   1609 

TypeError: unable to find gcd
```



---

Comment by bruno created at 2014-02-06 15:26:41

For `PolynomialRing(ZZ,'x',sparse=false)`, one of FLINT or NTL is used (FLINT by default). 

For `PolynomialRing(QQ,'x',sparse=true)`, the `gcd` computation is based on `quo_rem`. This is not possible over the integer since `quo_rem` works for polynomials over a field. 

There are several possible solutions: 
1. Coerce the polynomials to `PolynomialRing(QQ,'x',sparse=true)`; compute their GCD `g`, the LCM `l` of the denominators of the coefficients of `g`, and return `l*g`.
1. Coerce the polynomials to `PolynomialRing(ZZ,'x',sparse=false)`; compute their GCD and return the result in sparse representation with a second coercion.
1. Implement a //pseudo-division// algorithm (//cf.// Cohen GTM 138 Algorithm 3.1.2) and a GCD algorithm based on the sub-resultant (//cf.// Cohen GTM 138 Algorithm 3.3.1).

Solution 3 seems cleaner but does not give especially efficient results since the algorithms described in Cohen GTM 138 have complexity polynomial in the degree of the input polynomial. Actually, computing the GCD of two sparse polynomial is NP-hard ![1] so no better solution than converting to the dense representation is likely to exist. To my mind, Solution 2 is then the best one. 

Yet, I am new to Sage so comments are welcome!

![1] D. Plaisted, Sparse complex polynomials and polynomial reducibility. J. Comput. Syst. Sci. 14 (2), 210–221, 1977.


---

Comment by tscrim created at 2014-02-07 15:34:33

I'd implement all 3 with an optional `algorithm` argument since each has different strengths/weaknesses. For example, 2 is good as long as the polynomials are relatively dense, but for something like `x^100000 - 2`, I wouldn't want to convert that to a dense polynomial because of the memory usage (and take the time to construct it). From that, I think 3 should be the default. Possible names:

1. `"fraction_field"`
2. `"dense"`
3. `"pseudo-division"`

Nevertheless, I think we should have some `gcd` since this would be a surprise for the more casual user.


---

Comment by git created at 2014-06-25 22:45:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bruno created at 2014-06-25 22:54:55

I've implemented the `gcd` method in the class `Polynomial` using the pseudo-division algorithm, as well as a method `gcd` in `Polynomial_generic_sparse` which allows to choose the algorithm between `"pseudo-division"`, `"dense"` or `"fraction_field"`. 

Needs review!

One remaining limitation is the absence of `quo_rem` method in `Polynomial_generic_sparse`. I created a specific ticket #16544 for this.


---

Comment by bruno created at 2014-06-25 22:55:48

Changing status from new to needs_review.


---

Comment by bruno created at 2014-06-25 22:55:48

Changing keywords from "GCD sparse" to "sparse polynomial, gcd".


---

Comment by git created at 2014-07-11 17:33:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bruno created at 2014-07-11 17:36:27

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-12-13 14:20:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bruno created at 2014-12-13 14:36:28

Changing status from needs_work to needs_review.


---

Comment by bruno created at 2014-12-13 14:36:28

The ticket is ready for review. Note that as default, I have the "dense" algorithm for polynomials over ZZ and "pseudo-division" for the other ones. The idea is that arithmetic on ZZ[X] is very efficient. 

Of course, `gcd(x<sup>100000-1,x</sup>1000-1)` is much faster (by a factor approx. 400) with "pseudo-division" algorithm because of memory allocation for the "dense" algorithm, and thanks to a very good behavior of the "pseudo-division" algorithm on this example. Yet, if you consider `gcd(x<sup>100000-1,x</sup>2-1)` (which should be easy btw), the "dense" algorithm is faster and I even stopped the "pseudo-division" algorithm after a quite long time. 

_Note:_ It may be possible to reduce the huge allocation time since with NTL implementation, this is much faster: https://groups.google.com/forum/#!topic/sage-devel/6qhW90dgd1k.


---

Comment by tscrim created at 2014-12-13 17:34:30

Do you have a heuristic for determining when one algorithm is faster than another (when the base ring is `ZZ`)? It doesn't have to be a particularly good one, but considering the time differences you're getting, it seems like we should have some automatic choice of algorithm.


---

Comment by git created at 2014-12-15 17:35:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bruno created at 2014-12-15 17:40:13

Replying to [comment:15 tscrim]:
> Do you have a heuristic for determining when one algorithm is faster than another (when the base ring is `ZZ`)? It doesn't have to be a particularly good one, but considering the time differences you're getting, it seems like we should have some automatic choice of algorithm.

I don't have one. Based on the comments on https://groups.google.com/forum/#!topic/sage-devel/6qhW90dgd1k, I add the possibility¹ for the "dense" algorithm to use NTL instead of FLINT. After some tests, I chose a heuristic for using NTL rather than FLINT (basically, FLINT is faster for low-degree polynomials and _not-too-sparse_ ones). Then the "dense" algorithm is almost always faster than "pseudo-division" but for some very specific examples (I haven't been able to build other ones): `gcd(x<sup>N-1,x</sup>M-1)` with both `N` and `M` pretty large. An the ratio is not hundreds anymore, but approx. 10. 

¹ Actually, no choice for the user but only an automatic switch.


---

Comment by chapoton created at 2015-08-07 06:45:49

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2015-08-07 06:45:49

needs work, does not build, see patchbot report:

```
File "sage/structure/element.pyx", line 3433, in sage.structure.element.NamedBinopMethod.__init__ (build/cythonized/sage/structure/element.c:26905)
AttributeError: 'sage.structure.element.NamedBinopMethod' object has no attribute '__name__'
```



---

Comment by git created at 2015-08-07 14:52:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by bruno created at 2015-08-07 15:08:59

This is rebased, and now works (as far as I can tell).


---

Comment by bruno created at 2015-08-07 15:08:59

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2015-08-07 17:52:16

Doc does not build

```
OSError: [polynomia] docstring of sage.rings.polynomial.polynomial_element.Polynomial.pseudo_quo_rem:38: WARNING: Duplicate explicit target name: "gtm138".
```



---

Comment by chapoton created at 2015-08-07 17:52:16

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-08-25 14:11:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-08-25 14:51:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bruno created at 2015-08-25 15:07:48

In the two latest commits, I propose the following changes:

 1. Instead of having a fallback algorithm in the method `Polynomial.gcd` which tests whether the base ring in a unique factorization domain, this algorithm is moved to the category `UniqueFactorizationDomains`.
 1. I simplified the method `Polynomial_generic_sparse.gcd`: There remain only two possibilities (out of three), namely the one previously called `pseudo-division` (renamed `generic`, since it uses the generic code) and the `dense` version, which may in some cases be faster, for instance over `ZZ`. I removed the `fraction_field` option which does not make much sense I think.

At the same time, I also take [comment:21 Frédéric's comment] into account.


---

Comment by bruno created at 2015-08-25 15:07:48

Changing status from needs_work to needs_review.


---

Comment by bruno created at 2015-08-25 15:07:48

Changing keywords from "sparse polynomial, gcd" to "polynomial, gcd".


---

Comment by git created at 2015-10-04 03:16:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2015-10-04 03:17:28

Changing status from needs_review to positive_review.


---

Comment by saraedum created at 2015-10-04 03:17:28

Made some minor docstring changes. Everything else looks fine.


---

Comment by bruno created at 2015-10-05 06:58:40

Thanks for improving the docstring, and for the review! I add your name as a reviewer.


---

Comment by vbraun created at 2015-10-14 21:03:48

Resolution: fixed
