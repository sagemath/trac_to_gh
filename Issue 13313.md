# Issue 13313: Voronoi diagrams

Issue created by migration from Trac.

Original creator: moritz

Original creation time: 2012-09-21 15:23:36

Assignee: mhampton

CC:  vbraun jipilab tmonteil pelegm

Keywords: voronoi delaunay

a feature request:  Voronoi diagrams, see [https://groups.google.com/d/topic/sage-devel/JgqyInSu8S8/discussion](https://groups.google.com/d/topic/sage-devel/JgqyInSu8S8/discussion)

A list of things that could be included in an implementation of Voronoi diagrams could be:

 * the graph structure of the Voronoi diagram and it's dual, the Delaunay triangulation
 * generalizations
   * Voronoi diagrams with weights (possibly empty regions!)
   * Voronoi diagrams with respect to other metrics (regions not necessary convex Polyhedra anymore)
   * farthest points Voronoi diagrams
 * a closest pair method for the list of points/ nearest neighbor
 * a plotting routine in 2d and 3d

Perhaps in the file sage/geometry/triangulation/point_configuration.py


---

Comment by moritz created at 2012-09-21 15:55:14

a first try


---

Attachment

I added a patch just to see if I understood correctly how patching and the mercurial export etc works..


---

Comment by vbraun created at 2012-09-22 09:28:00

The patch is correct ;-)

You should format the examples in the docstring as in http://www.sagemath.org/doc/developer/conventions.html#docstring-markup-with-rest-and-sphinx, then they become tests that you can run with `sage -t sage/geometry/voroni_diagram.py`.

If you want to lay the path for more functionality you should create a class that holds the initial data (the points) and caches the polyhedral cells. Then other methods, for example a `plot()` method, can be easily added without having to pass lists of polyhedra around.

Also you don't have to hard-code floating-point doubles as the ring, you could allow exact rationals at the same time. This requires you to figure out what a good ring for the input points is, of course. You could just put them into a `PointConfiguration` and use

```
sage: pc = PointConfiguration([(1,2), (1,2/3)])
sage: pc.base_ring()
Rational Field
sage: pc = PointConfiguration([(1,2), (1,0.3)])
sage: pc.base_ring()
Real Field with 53 bits of precision
```



---

Comment by moritz created at 2012-09-24 10:42:23

Thanks for the hints, I will get cracking on this. 

Replying to [comment:2 vbraun]:
> The patch is correct ;-)
> 
> You should format the examples in the docstring as in http://www.sagemath.org/doc/developer/conventions.html#docstring-markup-with-rest-and-sphinx, then they become tests that you can run with `sage -t sage/geometry/voroni_diagram.py`.
> 
> If you want to lay the path for more functionality you should create a class that holds the initial data (the points) and caches the polyhedral cells. Then other methods, for example a `plot()` method, can be easily added without having to pass lists of polyhedra around.
> 
> Also you don't have to hard-code floating-point doubles as the ring, you could allow exact rationals at the same time. This requires you to figure out what a good ring for the input points is, of course. You could just put them into a `PointConfiguration` and use
> {{{
> sage: pc = PointConfiguration([(1,2), (1,2/3)])
> sage: pc.base_ring()
> Rational Field
> sage: pc = PointConfiguration([(1,2), (1,0.3)])
> sage: pc.base_ring()
> Real Field with 53 bits of precision
> }}}


---

Attachment

first working version


---

Comment by moritz created at 2012-10-16 12:24:17

Changing status from new to needs_review.


---

Comment by moritz created at 2012-10-16 12:25:44

I added a first version, which provides the basic functionality


---

Comment by mmarco created at 2012-11-13 13:34:39

Thanks for the work, i think it is a nice addition.

A couple of comments though.

-I don't understand why your patch adds the file voronoi_diagram.py.out. Is that made on purpose or is it a mistake?

-Unless i am missing something, i think that allowing exact fields (like rationals, or maybe even algebraic reals) should work just the same way. There is really no need to hard code RDF, it would be better to use the same field as the given entry. This should be a really trivial change: just define a self._field as self._points.base_ring(), and then replace RDF by self._field in the rest of your code.


---

Comment by moritz created at 2012-11-22 18:14:07

reviewed


---

Attachment

thanks for looking at the file.

 * the file voronoi_diagram.py.out was indeed a mistake, the new patch does not include that file.

 * I introduced a self._base_ring variable to handle QQ and RDF depending on input, as you suggested. (Now if the base_ring of the PointConfiguration is a subring of the rationals, it uses QQ, otherwise RDF)


---

Comment by mmarco created at 2012-11-29 11:16:57

Would it be a lot of trouble to introduce also the posibility of using algebraic extensions of QQ as base ring? Arithmetic in those cases may be slow, but i can imagine some situations where it would be important to know the vertices of the diagram in an exact form.


---

Comment by moritz created at 2012-11-29 12:37:45

Replying to [comment:9 mmarco]:
> Would it be a lot of trouble to introduce also the possibility of using algebraic extensions of QQ as base ring? Arithmetic in those cases may be slow, but i can imagine some situations where it would be important to know the vertices of the diagram in an exact form.

I don't see how one could easily adapt the algorithm for algebraic extensions of QQ for the following reason: 
 The Polyhedron-method only works with QQ and RDF. 

If you really want support for extensions of QQ, either the algorithm of finding the Voronoi-diagram has to be changed, or one has adapt the Polyhedron method. Both are nontrivial tasks, which might make a good upgrade later on.


---

Comment by kcrisman created at 2013-01-05 01:40:48

See also
 * https://sage.math.clemson.edu:34567/home/pub/388/ which seems to have an implementation of Voronoi diagrams
 * http://pypi.python.org/pypi/voropy/0.0.1
 * http://docs.scipy.org/doc/scipy/reference/generated/scipy.spatial.Delaunay.html
 * We include [qhull](http://www.qhull.org/) somewhere, which is also part of an optional package in R
 * Some information at various posts at [this blog](http://blancosilva.wordpress.com/2010/12/15/image-processing-with-numpy-scipy-and-matplotlibs-in-sage/), though I don't know how detailed they are
And so forth.  And Delaunay triangulations exist in matplotlib too, I think... would it be faster to use that, especially since [they fixed](https://github.com/matplotlib/matplotlib/pull/936) the problem we had in #13167?


---

Comment by ncohen created at 2013-08-07 13:59:48

Hellooooooooooooo !!

Just thought I would add a link toward d3.js here. It's a javascript library that can be used to plot a lot of things, and there's an example of a Voronoi Diagram on its website :

http://bl.ocks.org/mbostock/4060366

I wrote a patch (#14953) that uses this library to draw graphs `:-)`

Nathann


---

Comment by jipilab created at 2015-06-09 08:54:53

Hi Moritz,

What is the status of the patch? Was it migrated to the git format at all?

JP


---

Comment by moritz created at 2015-06-14 15:12:57

Dear JP,

 I haven't touched the file for a long time, I don't think it ever has been migrated.


---

Comment by chapoton created at 2015-08-04 07:34:53

needs a git branch


---

Comment by chapoton created at 2015-08-04 07:34:53

Changing status from needs_review to needs_work.


---

Comment by moritz created at 2016-12-12 12:57:46

Changing status from needs_work to needs_review.


---

Comment by moritz created at 2016-12-12 12:57:46

I adressed the comments made by mmarco: The class now handles all the input (QQ, RDF and AA) that polyhedron can take as input.

As for the comments by kcrisman and ncohen: There are certainly much faster methods to calculate the voronoi diagram and the delaunay triangulation; I just wanted to put forward a first working version, that is conceptually clear and can be improved later. 

Two things that could easily be added are plotting in the 3d case and adding a function to the point-configuration class giving back the voronoi-diagram.
----
New commits:


---

Comment by git created at 2016-12-12 20:35:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by moritz created at 2016-12-12 20:37:31

rebased in order to merge cleanly with develop


---

Comment by chapoton created at 2016-12-13 10:54:54

one failing doctest, probably you should sort the result


---

Comment by git created at 2016-12-13 17:09:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by moritz created at 2016-12-13 17:11:21

thanks for looking at it, chapoton; I tried to settle the issue, will do more testing (and add more doctests) later
----
New commits:


---

Comment by git created at 2017-01-03 12:47:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by moritz created at 2017-01-03 12:52:14

I would really be happy if someone could review this basic version of implementing Voronoi-diagrams. Once this is done I would like to 
 - make the calculation of the voronoi diagram faster
 - implement 3d-plotting (this will be somewhat easy)
 - make sure that one can take elements from Number Fields other than AA as input
 - allow weights


---

Comment by chapoton created at 2017-01-03 15:02:46

I made a cleanup of the code and doc, look at the diff to learn what you should have done.
----
New commits:


---

Comment by git created at 2017-01-03 15:18:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-01-03 17:14:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by moritz created at 2017-01-03 17:16:34

Thank you very much, Frédéric, for cleaning up the code! I read carefully the changes and learned a lot!


---

Comment by git created at 2017-01-03 17:31:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pelegm created at 2017-02-03 09:07:21

Just a question: why would the colours be necessarily random? It would probably be best to leave that optional.  I would be happy to use the `plot` method with a list/map of colours for the vertices (that is, for the cells dominated by the vertices).  This is, in fact, the main use of such diagrams in percolation theory (in which it is customary to colour the cells blue and red).


---

Comment by chapoton created at 2017-02-10 20:48:42

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2017-02-10 20:48:42

one failing doctest, see patchbot report


---

Comment by git created at 2017-02-21 12:18:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by moritz created at 2017-02-21 12:27:30

Changing status from needs_work to needs_review.


---

Comment by moritz created at 2017-02-21 12:27:30

I fixed the failing doctest (which was due to a change here: #22132)

Also I addressed the comment by pelegm and now provide an extra "cell_colors" option for plotting. However, plotting can (and should) be improved somewhat, but this should be a seperate ticket. Since the routine provides the polyhedra that are the cells, one can easily adapt the favorite style for plotting (possible with wireframe etc.)

I somehow messed up the git history, a bit, but the patch should now work..


---

Comment by jipilab created at 2017-02-21 14:39:44

All tests pass on 7.6.b4.

Running:

sage -t --warn-long src/sage/geometry/voronoi_diagram.py

The test on line 49:

DV = voronoi_diagram([[AA(c) for c in v] for v in polytopes.dodecahedron().vertices_list()]); DV

was flagged as long on my machine; it took around 4-5 sec. in average, but if you tell me that it is not flagged on a newer machine, then I guess it is okay.

I would put the "TODOs" in the description of the ticket inside the file in the doc, so that it is not only to be found here. (Similar as EXAMPLES and TESTS).

In the examples for plot, the backslash produces a series of spaces to align the newlines when typing .plot? . I would remove that unless it is desired...

Otherwise, it looks good to me.


---

Comment by jipilab created at 2017-02-21 14:40:51

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-02-22 12:06:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by moritz created at 2017-02-22 12:20:16

Thanks for taking a look at it, JP!

I have 
 - made the long doctest faster
 - removed the slashes
 - added a list of TODOs


---

Comment by moritz created at 2017-02-22 12:20:16

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-02-22 12:22:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2017-03-01 11:40:48

Changing keywords from "voronoi delaunay" to "voronoi, delaunay, days84".


---

Comment by jipilab created at 2017-03-05 11:26:50

Hi Moritz,

Could you change the description of the ticket also to include the TODO?

There is a second ":" missing after the examples of the class. Otherwise, it looks okay.


---

Comment by git created at 2017-03-05 14:06:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by moritz created at 2017-03-05 14:09:39

TODOs are included and the docstring is improved


---

Comment by jipilab created at 2017-03-06 00:57:41

All tests pass on 7.6.beta6.

The doc does not build: There is a double colon on line 16.

Otherwise, it looks good to me. Once you fixed it, you can put a positive review on my behalf.


---

Comment by jipilab created at 2017-03-06 09:00:29

Dear Moritz,

The doc folder geometry is renamed in #22496. I guess it would make sense to make a dependancy on this ticket to avoid to have to add it and then have to move it.

What do you think?


---

Comment by vdelecroix created at 2017-03-06 09:03:39

Sage classes must be caml case `voronoi_diagram -> VoronoiDiagram`.


---

Comment by git created at 2017-03-06 09:44:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-03-06 09:47:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by moritz created at 2017-03-06 09:48:34

Thanks for the comments, JP and Vincent! I adressed them; should be better now.


---

Comment by git created at 2017-03-06 10:13:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2017-03-06 10:45:05

So more comments:

 - The reference should be put in the file `SAGE_ROOT/src/doc/en/reference/references/index.rst`
 - In .plot() there are 2 lines after the `INPUT`
 - When there is an optional parameter, the syntax should be something like

  ` - p -- (default: 2) a positive prime integer`

In order to scan through the python conventions, you can use a pep8 plugin to scan your file for such things


---

Comment by jipilab created at 2017-03-06 10:45:05

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-03-06 11:27:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by moritz created at 2017-03-06 11:28:56

Changing status from needs_work to needs_review.


---

Comment by moritz created at 2017-03-06 11:28:56

Thank you JP! I used pep8 to improve some more little things..


---

Comment by jipilab created at 2017-03-06 15:15:04

Salut Moritz,

Some last comments (hopefully):

 - Spacing after commas in the examples will make reading easier
 - Input of plot: there is an "8" at the end of a line

Then let's see if the doc builds and it could be merged after #22496.


---

Comment by git created at 2017-03-06 15:30:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-03-07 01:16:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by moritz created at 2017-03-07 01:17:30

I remove the dependency, because it doesn't build  without errors.


---

Comment by jipilab created at 2017-03-07 07:54:26

Hi Moritz,

Well, all right, then the ticket #22496 will depend on this one. That's why I was asking if it was okay to put the dependency on this one.

Anyhow, that's not important.


---

Comment by jipilab created at 2017-03-07 19:13:33

There is no doc errors anymore. Looks good!


---

Comment by jipilab created at 2017-03-07 19:13:33

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-03-08 19:29:38

Merge conflict, wait for next beta


---

Comment by vbraun created at 2017-03-08 19:29:38

Changing status from positive_review to needs_work.


---

Comment by jipilab created at 2017-03-14 09:29:08

There is going to be a conflict with #22496. I guess rebasing will just do the thing. Let's wait some time that the "rc" versions pass...


---

Comment by jipilab created at 2017-03-27 09:14:01

Dear Moritz,

I guess you can now rebase and once the bot gives the green light, I'll give positive review again.


---

Comment by git created at 2017-03-28 08:24:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by moritz created at 2017-03-28 08:27:26

Ok, just rebasing didn't qute work, I did another merge (and squashed). In any case I hope the bot doesn't complain now. 

I added it to the misc section in the discrete geometry reference. 

Let's see what the bot thinks.


---

Comment by moritz created at 2017-03-29 11:14:09

Changing status from needs_work to needs_review.


---

Comment by jipilab created at 2017-03-30 08:09:24

Changing status from needs_review to needs_work.


---

Comment by jipilab created at 2017-03-30 08:09:24

Hi Moritz,

There is a doctest failure:


```

File "voronoi_diagram.py", line 197, in sage.geometry.voronoi_diagram.VoronoiDiagram.regions
Failed example:
    V = VoronoiDiagram([[1, 3, .3], [2, -2, 1], [-1, 2, -.1]]); V.regions()
Expected:
    {P(1.00000000000000, 3.00000000000000, 0.300000000000000): A 3-dimensional polyhedron in RDF^3 defined as the convex hull of 1 vertex, 2 rays, 1 line,
    P(2.00000000000000, -2.00000000000000, 1.00000000000000): A 3-dimensional polyhedron in RDF^3 defined as the convex hull of 1 vertex, 2 rays, 1 line,
    P(-1.00000000000000, 2.00000000000000, -0.100000000000000): A 3-dimensional polyhedron in RDF^3 defined as the convex hull of 1 vertex, 2 rays, 1 line}
Got:
    {P(1.00000000000000, 3.00000000000000, 0.300000000000000): A 3-dimensional polyhedron in RDF^3 defined as the convex hull of 1 vertex, 2 rays, 1 line,
     P(-1.00000000000000, 2.00000000000000, -0.100000000000000): A 3-dimensional polyhedron in RDF^3 defined as the convex hull of 1 vertex, 2 rays, 1 line,
     P(2.00000000000000, -2.00000000000000, 1.00000000000000): A 3-dimensional polyhedron in RDF^3 defined as the convex hull of 1 vertex, 2 rays, 1 line}
**********************************************************************

```


I guess the output should fix the order. Or change the doctest.


---

Comment by git created at 2017-03-30 08:44:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-03-30 15:18:50

It is better if you use:

```
            sage: V.regions() == {P[0]: Polyhedron(base_ring=RDF, lines=[(-RDF(0.375), RDF(0.13888888890000001), RDF(1.5277777779999999))],
            ....:                                                 rays=[(RDF(9), -RDF(1), -RDF(20)), (RDF(4.5), RDF(1), -RDF(25))],
            ....:                                                 vertices=[(-RDF(1.1074999999999999), RDF(1.149444444), RDF(9.0138888890000004))]),
            ....:                 P[1]: Polyhedron(base_ring=RDF, lines=[(-RDF(0.375), RDF(0.13888888890000001), RDF(1.5277777779999999))],
            ....:                                                 rays=[(RDF(9), -RDF(1), -RDF(20)), (-RDF(2.25), -RDF(1), RDF(2.5))],
            ....:                                                 vertices=[(-RDF(1.1074999999999999), RDF(1.149444444), RDF(9.0138888890000004))]),
            ....:                 P[2]: Polyhedron(base_ring=RDF, lines=[(-RDF(0.375), RDF(0.13888888890000001), RDF(1.5277777779999999))],
            ....:                                                 rays=[(RDF(4.5), RDF(1), -RDF(25)), (-RDF(2.25), -RDF(1), RDF(2.5))],
            ....:                                                 vertices=[(-RDF(1.1074999999999999), RDF(1.149444444), RDF(9.0138888890000004))])}
```



---

Comment by git created at 2017-03-30 17:45:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by moritz created at 2017-03-30 17:50:49

Changing status from needs_work to needs_review.


---

Comment by moritz created at 2017-03-30 17:50:49

Thanks for the tip, Travis! I changed it accordingly. 

I hope all is well now.


---

Comment by moritz created at 2017-03-31 15:48:54

Changing status from needs_review to needs_work.


---

Comment by moritz created at 2017-03-31 15:49:47

Dear JP, I will set it on positive review on your behalf, as soon as the bot does not complain about the white space changes


---

Comment by moritz created at 2017-03-31 15:49:47

Changing status from needs_work to needs_review.


---

Comment by moritz created at 2017-04-02 06:27:08

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-04-05 19:37:48

Resolution: fixed
