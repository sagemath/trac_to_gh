# Issue 11439: Equal ideals have different hashes

archive/issues_011439.json:
```json
{
    "body": "Assignee: @loefflerd\n\nIn the code below, `I` and `I2` are equal ideals with equal HNF but they have different hashes:\n\n\n```\nsage: K.<a> = NumberField(x^2 - x - 1)\nsage: I = K.ideal(2 * a - 1)\nsage: I2 = I.factor()[0][0]\nsage: I == I2\nTrue\nsage: print I.__hash__(), I2.__hash__()                       \n-7493989779944505313 -6341068275337658337\nsage: print I.pari_hnf(), I2.pari_hnf()\n[5, 2; 0, 1] [5, 2; 0, 1]\nsage: print I.pari_hnf() == I2.pari_hnf()\nTrue\nsage: print I.pari_hnf().__hash__(), I2.pari_hnf().__hash__()\n-7493989779944505313 -6341068275337658337\n```\n\n\nThe `6600000000000003` below looks suspicious:\n\n```\nsage: I.pari_hnf().debug()\n[&=0000000001ded308] MAT(lg=3):2600000000000003 0000000001ded2f0 0000000001ded2c0\n  mat(1,1) = [&=0000000001ded2d8] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000005\n  mat(1,2) = [&=0000000001ded2a8] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000002\n  mat(2,1) = gen_0\n  mat(2,2) = [&=0000000001ded290] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000001\nsage: I2.pari_hnf().debug()\n[&=0000000001941938] MAT(lg=3):2600000000000003 0000000001941920 00000000019418f0\n  mat(1,1) = [&=0000000001941908] INT(lg=3):0200000000000003 (+,lgefint=3):6600000000000003 0000000000000005\n  mat(1,2) = [&=00000000019418d8] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000002\n  mat(2,1) = gen_0\n  mat(2,2) = [&=00000000019418c0] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000001\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/11611\n\n",
    "created_at": "2011-07-19T13:02:02Z",
    "labels": [
        "component: number fields",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.7.2",
    "title": "Equal ideals have different hashes",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11439",
    "user": "https://github.com/jdemeyer"
}
```
Assignee: @loefflerd

In the code below, `I` and `I2` are equal ideals with equal HNF but they have different hashes:


```
sage: K.<a> = NumberField(x^2 - x - 1)
sage: I = K.ideal(2 * a - 1)
sage: I2 = I.factor()[0][0]
sage: I == I2
True
sage: print I.__hash__(), I2.__hash__()                       
-7493989779944505313 -6341068275337658337
sage: print I.pari_hnf(), I2.pari_hnf()
[5, 2; 0, 1] [5, 2; 0, 1]
sage: print I.pari_hnf() == I2.pari_hnf()
True
sage: print I.pari_hnf().__hash__(), I2.pari_hnf().__hash__()
-7493989779944505313 -6341068275337658337
```


The `6600000000000003` below looks suspicious:

```
sage: I.pari_hnf().debug()
[&=0000000001ded308] MAT(lg=3):2600000000000003 0000000001ded2f0 0000000001ded2c0
  mat(1,1) = [&=0000000001ded2d8] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000005
  mat(1,2) = [&=0000000001ded2a8] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000002
  mat(2,1) = gen_0
  mat(2,2) = [&=0000000001ded290] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000001
sage: I2.pari_hnf().debug()
[&=0000000001941938] MAT(lg=3):2600000000000003 0000000001941920 00000000019418f0
  mat(1,1) = [&=0000000001941908] INT(lg=3):0200000000000003 (+,lgefint=3):6600000000000003 0000000000000005
  mat(1,2) = [&=00000000019418d8] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000002
  mat(2,1) = gen_0
  mat(2,2) = [&=00000000019418c0] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000001
```


Issue created by migration from https://trac.sagemath.org/ticket/11611





---

archive/issue_comments_127460.json:
```json
{
    "body": "Changing keywords from \"\" to \"pari ideal hnf\".",
    "created_at": "2011-07-19T13:02:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11439#issuecomment-127460",
    "user": "https://github.com/jdemeyer"
}
```

Changing keywords from "" to "pari ideal hnf".



---

archive/issue_comments_127461.json:
```json
{
    "body": "I have **not** been able to reproduce this error through the string interface:\n\n```\nsage: K.<a> = NumberField(x^2 - x - 1)\nsage: I = K.ideal(2 * a - 1)\nsage: pari(\"K=%s; idealhnf(K, idealfactor(K, %s)[1,1])\"%(pari(K),pari(I))).debug()\n[&=0000000004998178] MAT(lg=3):2600000000000003 0000000004998160 0000000004998130\n  mat(1,1) = [&=0000000004998148] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000005\n  mat(1,2) = [&=0000000004998118] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000002\n  mat(2,1) = gen_0\n  mat(2,2) = [&=0000000004998100] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000001\n```\n",
    "created_at": "2011-08-02T20:12:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11439#issuecomment-127461",
    "user": "https://github.com/jdemeyer"
}
```

I have **not** been able to reproduce this error through the string interface:

```
sage: K.<a> = NumberField(x^2 - x - 1)
sage: I = K.ideal(2 * a - 1)
sage: pari("K=%s; idealhnf(K, idealfactor(K, %s)[1,1])"%(pari(K),pari(I))).debug()
[&=0000000004998178] MAT(lg=3):2600000000000003 0000000004998160 0000000004998130
  mat(1,1) = [&=0000000004998148] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000005
  mat(1,2) = [&=0000000004998118] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000002
  mat(2,1) = gen_0
  mat(2,2) = [&=0000000004998100] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000001
```




---

archive/issue_comments_127462.json:
```json
{
    "body": "Changing assignee from @loefflerd to @jdemeyer.",
    "created_at": "2011-08-02T20:12:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11439#issuecomment-127462",
    "user": "https://github.com/jdemeyer"
}
```

Changing assignee from @loefflerd to @jdemeyer.



---

archive/issue_comments_127463.json:
```json
{
    "body": "The problem lies with the conversion between PARI and Sage:\n\n```\nsage: K.<a> = NumberField(x^2 - x - 1)\nsage: pari_ideal = pari(\"[5, [2, 1]~, 2, 1, [2, 1]~]\")\nsage: pari(K.ideal(pari_ideal)).debug()\n[&=00000000049f97b8] MAT(lg=3):2600000000000003 00000000049f97a0 00000000049f9770\n  mat(1,1) = [&=00000000049f9788] INT(lg=3):0200000000000003 (+,lgefint=3):6600000000000003 0000000000000005\n  mat(1,2) = [&=00000000049f9758] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000002\n  mat(2,1) = gen_0\n  mat(2,2) = [&=00000000049f9740] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000001\n```\n",
    "created_at": "2011-08-02T20:16:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11439#issuecomment-127463",
    "user": "https://github.com/jdemeyer"
}
```

The problem lies with the conversion between PARI and Sage:

```
sage: K.<a> = NumberField(x^2 - x - 1)
sage: pari_ideal = pari("[5, [2, 1]~, 2, 1, [2, 1]~]")
sage: pari(K.ideal(pari_ideal)).debug()
[&=00000000049f97b8] MAT(lg=3):2600000000000003 00000000049f97a0 00000000049f9770
  mat(1,1) = [&=00000000049f9788] INT(lg=3):0200000000000003 (+,lgefint=3):6600000000000003 0000000000000005
  mat(1,2) = [&=00000000049f9758] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000002
  mat(2,1) = gen_0
  mat(2,2) = [&=00000000049f9740] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000001
```




---

archive/issue_comments_127464.json:
```json
{
    "body": "Changing keywords from \"pari ideal hnf\" to \"pari integer ideal hnf\".",
    "created_at": "2011-08-03T11:55:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11439#issuecomment-127464",
    "user": "https://github.com/jdemeyer"
}
```

Changing keywords from "pari ideal hnf" to "pari integer ideal hnf".



---

archive/issue_comments_127465.json:
```json
{
    "body": "The issue is already visible on the level of PARI `INT`s, see the new ticket description.",
    "created_at": "2011-08-03T11:55:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11439#issuecomment-127465",
    "user": "https://github.com/jdemeyer"
}
```

The issue is already visible on the level of PARI `INT`s, see the new ticket description.



---

archive/issue_comments_127466.json:
```json
{
    "body": "Changing keywords from \"pari integer ideal hnf\" to \"pari cgetg integer ideal hnf\".",
    "created_at": "2011-08-03T12:07:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11439#issuecomment-127466",
    "user": "https://github.com/jdemeyer"
}
```

Changing keywords from "pari integer ideal hnf" to "pari cgetg integer ideal hnf".



---

archive/issue_comments_127467.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2011-08-03T12:42:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11439#issuecomment-127467",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to critical.



---

archive/issue_comments_127468.json:
```json
{
    "body": "Attachment [11611.patch](tarball://root/attachments/some-uuid/ticket11611/11611.patch) by @jdemeyer created at 2011-08-03 13:26:32",
    "created_at": "2011-08-03T13:26:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11439#issuecomment-127468",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [11611.patch](tarball://root/attachments/some-uuid/ticket11611/11611.patch) by @jdemeyer created at 2011-08-03 13:26:32



---

archive/issue_comments_127469.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-08-03T13:28:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11439#issuecomment-127469",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_127470.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-08-03T14:55:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11439#issuecomment-127470",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_127471.json:
```json
{
    "body": "I read the patch, which is mostly about rewriting Cython code against the PARI library in a way that looks much cleaner and makes sense.  I don't quite understand precisely what it is about the code here that fixes the bug though. \n\nAll tests pass, and the new code looks and reads well.",
    "created_at": "2011-08-03T14:55:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11439#issuecomment-127471",
    "user": "https://github.com/williamstein"
}
```

I read the patch, which is mostly about rewriting Cython code against the PARI library in a way that looks much cleaner and makes sense.  I don't quite understand precisely what it is about the code here that fixes the bug though. 

All tests pass, and the new code looks and reads well.



---

archive/issue_comments_127472.json:
```json
{
    "body": "As William, I read the ticket description and the patch and I don't understand what is really the cause of the issue and why the patch fixes it.\n\nI'd encourage Jeroen to add a comment explaining this bit and, if possible, to split the patch in two parts: a \"fix the issue\" part and a \"cleanup\" part (in the order that is most convenient).\n\n----\n\nI'm also wondering if the hash of a pari integer should match the hash of the corresponding sage or python integers. That is carefully considered in the sage integers/rationals, etc. The principle is that two values that are equivalent (for the purposes of equality comparision) should have the same hash to avoid nastiness in using the values as dictionary keys. The same would be true for some other pari types.",
    "created_at": "2011-08-03T17:33:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11439#issuecomment-127472",
    "user": "https://github.com/tornaria"
}
```

As William, I read the ticket description and the patch and I don't understand what is really the cause of the issue and why the patch fixes it.

I'd encourage Jeroen to add a comment explaining this bit and, if possible, to split the patch in two parts: a "fix the issue" part and a "cleanup" part (in the order that is most convenient).

----

I'm also wondering if the hash of a pari integer should match the hash of the corresponding sage or python integers. That is carefully considered in the sage integers/rationals, etc. The principle is that two values that are equivalent (for the purposes of equality comparision) should have the same hash to avoid nastiness in using the values as dictionary keys. The same would be true for some other pari types.



---

archive/issue_comments_127473.json:
```json
{
    "body": "The code which is purely about the bug fix is in lines 9005--9007 of the new `sage/libs/pari/gen.pyx`.  The problem is that `z[1]` was never properly initialized and might contain some random garbage which was on the PARI stack before.\n\nI also rewrote some code which was similar in spirit to the buggy code, even though I could not obviously produce bugs from that code.  Then I also did some general cleanup, like getting rid of `__set_lvalue__()`.",
    "created_at": "2011-08-03T20:26:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11439#issuecomment-127473",
    "user": "https://github.com/jdemeyer"
}
```

The code which is purely about the bug fix is in lines 9005--9007 of the new `sage/libs/pari/gen.pyx`.  The problem is that `z[1]` was never properly initialized and might contain some random garbage which was on the PARI stack before.

I also rewrote some code which was similar in spirit to the buggy code, even though I could not obviously produce bugs from that code.  Then I also did some general cleanup, like getting rid of `__set_lvalue__()`.



---

archive/issue_comments_127474.json:
```json
{
    "body": "Replying to [comment:9 tornaria]:\n> I'm also wondering if the hash of a pari integer should match the hash of the corresponding sage or python integers. That is carefully considered in the sage integers/rationals, etc. The principle is that two values that are equivalent (for the purposes of equality comparision) should have the same hash to avoid nastiness in using the values as dictionary keys. The same would be true for some other pari types.\n\nThis looks quite hard.  You would really have to rewrite the PARI hash function for this to match the Sage hash functions or the other way around.  Also, consider that PARI objects are rarely directly visible in Sage.  They usually live in private members of classes, so are unlikely to end up as dictionary keys.  And even if they do, it would be even rarer to mix PARI and Sage types.",
    "created_at": "2011-08-03T20:30:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11439#issuecomment-127474",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:9 tornaria]:
> I'm also wondering if the hash of a pari integer should match the hash of the corresponding sage or python integers. That is carefully considered in the sage integers/rationals, etc. The principle is that two values that are equivalent (for the purposes of equality comparision) should have the same hash to avoid nastiness in using the values as dictionary keys. The same would be true for some other pari types.

This looks quite hard.  You would really have to rewrite the PARI hash function for this to match the Sage hash functions or the other way around.  Also, consider that PARI objects are rarely directly visible in Sage.  They usually live in private members of classes, so are unlikely to end up as dictionary keys.  And even if they do, it would be even rarer to mix PARI and Sage types.



---

archive/issue_comments_127475.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-08-08T19:02:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11439#issuecomment-127475",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_127476.json:
```json
{
    "body": "See #11854 for a follow-up (it turns out this ticket does not fully fix the problem).",
    "created_at": "2011-10-10T13:11:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11439",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11439#issuecomment-127476",
    "user": "https://github.com/jdemeyer"
}
```

See #11854 for a follow-up (it turns out this ticket does not fully fix the problem).
