# Issue 11439: Equal ideals have different hashes

Issue created by migration from https://trac.sagemath.org/ticket/11611

Original creator: jdemeyer

Original creation time: 2011-07-19 13:02:02

Assignee: davidloeffler

In the code below, `I` and `I2` are equal ideals with equal HNF but they have different hashes:


```
sage: K.<a> = NumberField(x^2 - x - 1)
sage: I = K.ideal(2 * a - 1)
sage: I2 = I.factor()[0][0]
sage: I == I2
True
sage: print I.__hash__(), I2.__hash__()                       
-7493989779944505313 -6341068275337658337
sage: print I.pari_hnf(), I2.pari_hnf()
[5, 2; 0, 1] [5, 2; 0, 1]
sage: print I.pari_hnf() == I2.pari_hnf()
True
sage: print I.pari_hnf().__hash__(), I2.pari_hnf().__hash__()
-7493989779944505313 -6341068275337658337
```


The `6600000000000003` below looks suspicious:

```
sage: I.pari_hnf().debug()
[&=0000000001ded308] MAT(lg=3):2600000000000003 0000000001ded2f0 0000000001ded2c0
  mat(1,1) = [&=0000000001ded2d8] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000005
  mat(1,2) = [&=0000000001ded2a8] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000002
  mat(2,1) = gen_0
  mat(2,2) = [&=0000000001ded290] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000001
sage: I2.pari_hnf().debug()
[&=0000000001941938] MAT(lg=3):2600000000000003 0000000001941920 00000000019418f0
  mat(1,1) = [&=0000000001941908] INT(lg=3):0200000000000003 (+,lgefint=3):6600000000000003 0000000000000005
  mat(1,2) = [&=00000000019418d8] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000002
  mat(2,1) = gen_0
  mat(2,2) = [&=00000000019418c0] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000001
```



---

Comment by jdemeyer created at 2011-07-19 13:02:54

Changing keywords from "" to "pari ideal hnf".


---

Comment by jdemeyer created at 2011-08-02 20:12:09

I have *not* been able to reproduce this error through the string interface:

```
sage: K.<a> = NumberField(x^2 - x - 1)
sage: I = K.ideal(2 * a - 1)
sage: pari("K=%s; idealhnf(K, idealfactor(K, %s)[1,1])"%(pari(K),pari(I))).debug()
[&=0000000004998178] MAT(lg=3):2600000000000003 0000000004998160 0000000004998130
  mat(1,1) = [&=0000000004998148] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000005
  mat(1,2) = [&=0000000004998118] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000002
  mat(2,1) = gen_0
  mat(2,2) = [&=0000000004998100] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000001
```



---

Comment by jdemeyer created at 2011-08-02 20:12:09

Changing assignee from davidloeffler to jdemeyer.


---

Comment by jdemeyer created at 2011-08-02 20:16:55

The problem lies with the conversion between PARI and Sage:

```
sage: K.<a> = NumberField(x^2 - x - 1)
sage: pari_ideal = pari("[5, [2, 1]~, 2, 1, [2, 1]~]")
sage: pari(K.ideal(pari_ideal)).debug()
[&=00000000049f97b8] MAT(lg=3):2600000000000003 00000000049f97a0 00000000049f9770
  mat(1,1) = [&=00000000049f9788] INT(lg=3):0200000000000003 (+,lgefint=3):6600000000000003 0000000000000005
  mat(1,2) = [&=00000000049f9758] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000002
  mat(2,1) = gen_0
  mat(2,2) = [&=00000000049f9740] INT(lg=3):0200000000000003 (+,lgefint=3):4000000000000003 0000000000000001
```



---

Comment by jdemeyer created at 2011-08-03 11:55:13

Changing keywords from "pari ideal hnf" to "pari integer ideal hnf".


---

Comment by jdemeyer created at 2011-08-03 11:55:13

The issue is already visible on the level of PARI `INT`s, see the new ticket description.


---

Comment by jdemeyer created at 2011-08-03 12:07:46

Changing keywords from "pari integer ideal hnf" to "pari cgetg integer ideal hnf".


---

Comment by jdemeyer created at 2011-08-03 12:42:07

Changing priority from major to critical.


---

Attachment


---

Comment by jdemeyer created at 2011-08-03 13:28:04

Changing status from new to needs_review.


---

Comment by was created at 2011-08-03 14:55:23

Changing status from needs_review to positive_review.


---

Comment by was created at 2011-08-03 14:55:23

I read the patch, which is mostly about rewriting Cython code against the PARI library in a way that looks much cleaner and makes sense.  I don't quite understand precisely what it is about the code here that fixes the bug though. 

All tests pass, and the new code looks and reads well.


---

Comment by tornaria created at 2011-08-03 17:33:44

As William, I read the ticket description and the patch and I don't understand what is really the cause of the issue and why the patch fixes it.

I'd encourage Jeroen to add a comment explaining this bit and, if possible, to split the patch in two parts: a "fix the issue" part and a "cleanup" part (in the order that is most convenient).

----

I'm also wondering if the hash of a pari integer should match the hash of the corresponding sage or python integers. That is carefully considered in the sage integers/rationals, etc. The principle is that two values that are equivalent (for the purposes of equality comparision) should have the same hash to avoid nastiness in using the values as dictionary keys. The same would be true for some other pari types.


---

Comment by jdemeyer created at 2011-08-03 20:26:48

The code which is purely about the bug fix is in lines 9005--9007 of the new `sage/libs/pari/gen.pyx`.  The problem is that `z[1]` was never properly initialized and might contain some random garbage which was on the PARI stack before.

I also rewrote some code which was similar in spirit to the buggy code, even though I could not obviously produce bugs from that code.  Then I also did some general cleanup, like getting rid of `__set_lvalue__()`.


---

Comment by jdemeyer created at 2011-08-03 20:30:26

Replying to [comment:9 tornaria]:
> I'm also wondering if the hash of a pari integer should match the hash of the corresponding sage or python integers. That is carefully considered in the sage integers/rationals, etc. The principle is that two values that are equivalent (for the purposes of equality comparision) should have the same hash to avoid nastiness in using the values as dictionary keys. The same would be true for some other pari types.

This looks quite hard.  You would really have to rewrite the PARI hash function for this to match the Sage hash functions or the other way around.  Also, consider that PARI objects are rarely directly visible in Sage.  They usually live in private members of classes, so are unlikely to end up as dictionary keys.  And even if they do, it would be even rarer to mix PARI and Sage types.


---

Comment by jdemeyer created at 2011-08-08 19:02:45

Resolution: fixed


---

Comment by jdemeyer created at 2011-10-10 13:11:05

See #11854 for a follow-up (it turns out this ticket does not fully fix the problem).
