# Issue 26214: Prepare for sphinx 1.8

archive/issues_026214.json:
```json
{
    "body": "CC:  @timokau @kiwifb @antonio-rojas @embray @slel @jhpalmieri @dimpase @tobihan\n\nWith sphinx 1.8.1 we see quite a few\n\n\n```\nApplicationError: Source directory and destination directory cannot be identical\n```\n\n\ncoming out of Sphinx as they have chahnged the argument checking of the `Sphinx` constructor it seems.\n\nIt would be nice to be more friendly to downstream by making Sage work better with Sphinx 1.8 already.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26451\n\n",
    "created_at": "2018-10-10T07:53:52Z",
    "labels": [
        "component: documentation",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Prepare for sphinx 1.8",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26214",
    "user": "https://github.com/saraedum"
}
```
CC:  @timokau @kiwifb @antonio-rojas @embray @slel @jhpalmieri @dimpase @tobihan

With sphinx 1.8.1 we see quite a few


```
ApplicationError: Source directory and destination directory cannot be identical
```


coming out of Sphinx as they have chahnged the argument checking of the `Sphinx` constructor it seems.

It would be nice to be more friendly to downstream by making Sage work better with Sphinx 1.8 already.

Issue created by migration from https://trac.sagemath.org/ticket/26451





---

archive/issue_comments_369036.json:
```json
{
    "body": "Note that there is nothing I can doctest here.",
    "created_at": "2018-10-10T07:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369036",
    "user": "https://github.com/saraedum"
}
```

Note that there is nothing I can doctest here.



---

archive/issue_comments_369037.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-10-10T07:57:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369037",
    "user": "https://github.com/saraedum"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_369038.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-10-10T07:57:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369038",
    "user": "https://github.com/saraedum"
}
```

New commits:



---

archive/issue_comments_369039.json:
```json
{
    "body": "Changing keywords from \"\" to \"sphinx, conda\".",
    "created_at": "2018-10-10T07:58:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369039",
    "user": "https://github.com/saraedum"
}
```

Changing keywords from "" to "sphinx, conda".



---

archive/issue_comments_369040.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-10-10T08:14:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369040",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_369041.json:
```json
{
    "body": "I'd rather upgrade Sphinx while we're at it. That's a good thing to do and I would need to do that anyway to test this ticket.",
    "created_at": "2018-10-10T08:14:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369041",
    "user": "https://github.com/jdemeyer"
}
```

I'd rather upgrade Sphinx while we're at it. That's a good thing to do and I would need to do that anyway to test this ticket.



---

archive/issue_comments_369042.json:
```json
{
    "body": "I was fearing that you would propose that ;)\n\nI am not planning on working on upgrading Sphinx in Sage (as I've got too many other things to worry about.) I don't know what has chahnged in 1.8.1 and whether we would want to upgrade at all.\n\nMore generally, I don't know what we're aiming for here. I feel we don't have enough people to keep Sage-the-distribution close to upstream most of the time so that's probably not what we should be aiming for?\n\nThat said, feel free to upgrade Sphinx :) But if anybody likes these small changes and we want to move the Sphinx upgrade into a separate ticket, I would prefer that.",
    "created_at": "2018-10-10T08:27:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369042",
    "user": "https://github.com/saraedum"
}
```

I was fearing that you would propose that ;)

I am not planning on working on upgrading Sphinx in Sage (as I've got too many other things to worry about.) I don't know what has chahnged in 1.8.1 and whether we would want to upgrade at all.

More generally, I don't know what we're aiming for here. I feel we don't have enough people to keep Sage-the-distribution close to upstream most of the time so that's probably not what we should be aiming for?

That said, feel free to upgrade Sphinx :) But if anybody likes these small changes and we want to move the Sphinx upgrade into a separate ticket, I would prefer that.



---

archive/issue_comments_369043.json:
```json
{
    "body": "Upgrading sphinx requires further changes to make docs build. I have a minimal patch at https://git.archlinux.org/svntogit/community.git/tree/trunk/sagemath-doc-sphinx-1.8.patch?h=packages/sagemath-doc\nto make it build, although with it one still gets lots of deprecation warnings due to changes in logging functions.",
    "created_at": "2018-10-10T08:30:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369043",
    "user": "https://github.com/antonio-rojas"
}
```

Upgrading sphinx requires further changes to make docs build. I have a minimal patch at https://git.archlinux.org/svntogit/community.git/tree/trunk/sagemath-doc-sphinx-1.8.patch?h=packages/sagemath-doc
to make it build, although with it one still gets lots of deprecation warnings due to changes in logging functions.



---

archive/issue_comments_369044.json:
```json
{
    "body": "Antonio, does Sphinx 1.8.1 work with just those changes (even if there are deprecation warnings)? If so, we might as well upgrade.",
    "created_at": "2018-10-10T08:34:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369044",
    "user": "https://github.com/jdemeyer"
}
```

Antonio, does Sphinx 1.8.1 work with just those changes (even if there are deprecation warnings)? If so, we might as well upgrade.



---

archive/issue_comments_369045.json:
```json
{
    "body": "Replying to [comment:11 jdemeyer]:\n> Antonio, does Sphinx 1.8.1 work with just those changes (even if there are deprecation warnings)? If so, we might as well upgrade.\n\nYes, with Julian's patch and mine introspection works and docs build correctly.",
    "created_at": "2018-10-10T08:35:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369045",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:11 jdemeyer]:
> Antonio, does Sphinx 1.8.1 work with just those changes (even if there are deprecation warnings)? If so, we might as well upgrade.

Yes, with Julian's patch and mine introspection works and docs build correctly.



---

archive/issue_comments_369046.json:
```json
{
    "body": "Changing component from documentation to packages: standard.",
    "created_at": "2018-10-10T08:36:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369046",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from documentation to packages: standard.



---

archive/issue_comments_369047.json:
```json
{
    "body": "jdemeyer, did you forget to push your branch? (you added yourself as an Author but did not push any changes it seems.)",
    "created_at": "2018-10-10T10:12:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369047",
    "user": "https://github.com/saraedum"
}
```

jdemeyer, did you forget to push your branch? (you added yourself as an Author but did not push any changes it seems.)



---

archive/issue_comments_369048.json:
```json
{
    "body": "Please give me time...",
    "created_at": "2018-10-10T10:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369048",
    "user": "https://github.com/jdemeyer"
}
```

Please give me time...



---

archive/issue_comments_369049.json:
```json
{
    "body": "Note that there is a licensing issue in sphinxify.py, see #26453.",
    "created_at": "2018-10-10T10:20:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369049",
    "user": "https://github.com/saraedum"
}
```

Note that there is a licensing issue in sphinxify.py, see #26453.



---

archive/issue_comments_369050.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-10T10:41:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369050",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_369051.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-10-10T10:42:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369051",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_369052.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-10-12T17:53:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369052",
    "user": "https://github.com/jhpalmieri"
}
```

New commits:



---

archive/issue_comments_369053.json:
```json
{
    "body": "By the way, see also #26449 for issues with Sphinx and the Python 3 build of Sage.",
    "created_at": "2018-10-12T18:32:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369053",
    "user": "https://github.com/jhpalmieri"
}
```

By the way, see also #26449 for issues with Sphinx and the Python 3 build of Sage.



---

archive/issue_comments_369054.json:
```json
{
    "body": "I just did the upgrade on nix and I also needed to apply the same patch to sagenb's `sphinxify.py` (https://github.com/sagemath/sagenb/pull/461).",
    "created_at": "2018-10-22T21:13:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369054",
    "user": "https://github.com/timokau"
}
```

I just did the upgrade on nix and I also needed to apply the same patch to sagenb's `sphinxify.py` (https://github.com/sagemath/sagenb/pull/461).



---

archive/issue_comments_369055.json:
```json
{
    "body": "Replying to [comment:22 gh-timokau]:\n> I just did the upgrade on nix and I also needed to apply the same patch to sagenb's `sphinxify.py` (https://github.com/sagemath/sagenb/pull/461).\n\nOnce upon a time `sphinxify` was a part of sagenb and it was used in sage itself. So time ago we put an end to that. May be it is time to go in reverse and have (the now deprecated) sagenb use sage's sphinxify.",
    "created_at": "2018-10-22T21:19:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369055",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:22 gh-timokau]:
> I just did the upgrade on nix and I also needed to apply the same patch to sagenb's `sphinxify.py` (https://github.com/sagemath/sagenb/pull/461).

Once upon a time `sphinxify` was a part of sagenb and it was used in sage itself. So time ago we put an end to that. May be it is time to go in reverse and have (the now deprecated) sagenb use sage's sphinxify.



---

archive/issue_comments_369056.json:
```json
{
    "body": "The documentation does not build for me on OS X: I get\n\n```\n[reference]     valuations: 1 todos, 14 index, 1409 citations, 13 modules\n[reference] ... done (472 todos, 2068 index, 1409 citations, 2019 modules)\n[reference] preparing documents... skipping loading of indexes... done\n[reference] Merging js index files...\n[reference]     algebras: 3466 js index entries\n[reference]     arithgroup: 966 js index entries\n\n   ...\n\n[reference]     structure: 1995 js index entries\n[reference]     tensor_free_modules: 1035 js index entries\n[reference]     valuations: 817 js index entries\n[reference] ... done (44888 js index entries)\n[reference] WARNING: cannot copy static file IOError(20, 'Not a directory')\n[reference] copying static files... copying extra files... done\n[reference] The HTML pages are in local/share/doc/sage/html/en/reference.\nError building the documentation.\nTraceback (most recent call last):\n  File \"/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/runpy.py\", line 174, in _run_module_as_main\n    \"__main__\", fname, loader, pkg_name)\n  File \"/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/runpy.py\", line 72, in _run_code\n    exec code in run_globals\n  File \"/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py\", line 2, in <module>\n    main()\n  File \"/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py\", line 1715, in main\n    builder()\n  File \"/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py\", line 338, in _wrapper\n    getattr(get_builder(document), name)(*args, **kwds)\n  File \"/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py\", line 536, in _wrapper\n    getattr(DocBuilder(self.name, lang), format)(*args, **kwds)\n  File \"/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py\", line 130, in f\n    runsphinx()\n  File \"/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/sphinxbuild.py\", line 319, in runsphinx\n    sys.stderr.raise_errors()\n  File \"/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/sphinxbuild.py\", line 254, in raise_errors\n    raise OSError(self._error)\nOSError: WARNING: cannot copy static file IOError(20, 'Not a directory')\n```\n\nIndeed, `local/share/doc/sage/html/en/reference/_static` is a file, not a directory: it is the file `graphviz.css` from Sphinx. If I delete it, create a directory `_static`, and run `make` again, then only `graphviz.css` is copied to the directory, so the reference manual is missing all of its css files. The other parts of the documentation look good.",
    "created_at": "2018-10-23T19:00:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369056",
    "user": "https://github.com/jhpalmieri"
}
```

The documentation does not build for me on OS X: I get

```
[reference]     valuations: 1 todos, 14 index, 1409 citations, 13 modules
[reference] ... done (472 todos, 2068 index, 1409 citations, 2019 modules)
[reference] preparing documents... skipping loading of indexes... done
[reference] Merging js index files...
[reference]     algebras: 3466 js index entries
[reference]     arithgroup: 966 js index entries

   ...

[reference]     structure: 1995 js index entries
[reference]     tensor_free_modules: 1035 js index entries
[reference]     valuations: 817 js index entries
[reference] ... done (44888 js index entries)
[reference] WARNING: cannot copy static file IOError(20, 'Not a directory')
[reference] copying static files... copying extra files... done
[reference] The HTML pages are in local/share/doc/sage/html/en/reference.
Error building the documentation.
Traceback (most recent call last):
  File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/runpy.py", line 174, in _run_module_as_main
    "__main__", fname, loader, pkg_name)
  File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/runpy.py", line 72, in _run_code
    exec code in run_globals
  File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
    main()
  File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 1715, in main
    builder()
  File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 338, in _wrapper
    getattr(get_builder(document), name)(*args, **kwds)
  File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 536, in _wrapper
    getattr(DocBuilder(self.name, lang), format)(*args, **kwds)
  File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 130, in f
    runsphinx()
  File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/sphinxbuild.py", line 319, in runsphinx
    sys.stderr.raise_errors()
  File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/sphinxbuild.py", line 254, in raise_errors
    raise OSError(self._error)
OSError: WARNING: cannot copy static file IOError(20, 'Not a directory')
```

Indeed, `local/share/doc/sage/html/en/reference/_static` is a file, not a directory: it is the file `graphviz.css` from Sphinx. If I delete it, create a directory `_static`, and run `make` again, then only `graphviz.css` is copied to the directory, so the reference manual is missing all of its css files. The other parts of the documentation look good.



---

archive/issue_comments_369057.json:
```json
{
    "body": "There is some odd behavior with `graphviz.css`. First, it gets copied to `local/share/doc/sage/inventory/en/reference/_static` (a file, not a directory): Sphinx shouldn't copy any css files in the inventory build. Then it also gets copied to a similar location in the html build. I commented out `'sphinx.ext.graphviz'` in the list of extensions in `src/doc/common/conf.py` and started over, but the same thing happened. So something strange is going on with graphviz and our custom builder for the reference manual. In contrast, `./sage --docbuild tutorial html` works fine.",
    "created_at": "2018-10-23T21:04:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369057",
    "user": "https://github.com/jhpalmieri"
}
```

There is some odd behavior with `graphviz.css`. First, it gets copied to `local/share/doc/sage/inventory/en/reference/_static` (a file, not a directory): Sphinx shouldn't copy any css files in the inventory build. Then it also gets copied to a similar location in the html build. I commented out `'sphinx.ext.graphviz'` in the list of extensions in `src/doc/common/conf.py` and started over, but the same thing happened. So something strange is going on with graphviz and our custom builder for the reference manual. In contrast, `./sage --docbuild tutorial html` works fine.



---

archive/issue_comments_369058.json:
```json
{
    "body": "See https://github.com/sphinx-doc/sphinx/pull/5549",
    "created_at": "2018-10-24T05:54:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369058",
    "user": "https://github.com/jdemeyer"
}
```

See https://github.com/sphinx-doc/sphinx/pull/5549



---

archive/issue_comments_369059.json:
```json
{
    "body": "Replying to [comment:27 jdemeyer]:\n> See https://github.com/sphinx-doc/sphinx/pull/5549\n\nThat's very helpful, thank you, but it leads to my next problem: with that fix applied, `graphviz.css` is still copied to `local/share/doc/sage/inventory/en/reference/_static/`, and there is no reason to copy css files to the inventory build. As a consequence, I see this error:\n\n```\nBuilding reference manual, second pass.\n\n[arithgrou] WARNING: failed to reach any of the inventories with the following issues:\n[arithgrou] WARNING: intersphinx inventory '/Users/jpalmier/Desktop/Sage/git/sage/local/share/doc/sage/inventory/en/reference/_static/objects.inv' not fetchable due to <type 'exceptions.IOError'>: [Errno 2] No such file or directory: '/Users/jpalmier/Desktop/Sage/git/sage/local/share/doc/sage/inventory/en/reference/_static/objects.inv'\n```\n\nI think intersphinx looks in every subdirectory of `inventory/en/reference/`, including `_static`, which should not be there.",
    "created_at": "2018-10-24T18:34:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369059",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:27 jdemeyer]:
> See https://github.com/sphinx-doc/sphinx/pull/5549

That's very helpful, thank you, but it leads to my next problem: with that fix applied, `graphviz.css` is still copied to `local/share/doc/sage/inventory/en/reference/_static/`, and there is no reason to copy css files to the inventory build. As a consequence, I see this error:

```
Building reference manual, second pass.

[arithgrou] WARNING: failed to reach any of the inventories with the following issues:
[arithgrou] WARNING: intersphinx inventory '/Users/jpalmier/Desktop/Sage/git/sage/local/share/doc/sage/inventory/en/reference/_static/objects.inv' not fetchable due to <type 'exceptions.IOError'>: [Errno 2] No such file or directory: '/Users/jpalmier/Desktop/Sage/git/sage/local/share/doc/sage/inventory/en/reference/_static/objects.inv'
```

I think intersphinx looks in every subdirectory of `inventory/en/reference/`, including `_static`, which should not be there.



---

archive/issue_comments_369060.json:
```json
{
    "body": "And once I clean that up, I still see a *file* `_static` in the html reference build.",
    "created_at": "2018-10-24T20:22:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369060",
    "user": "https://github.com/jhpalmieri"
}
```

And once I clean that up, I still see a *file* `_static` in the html reference build.



---

archive/issue_comments_369061.json:
```json
{
    "body": "I wonder if the problem is that it tries to copy `graphviz.css` to, for example, `html/en/reference/algebras/_static`, which is a symlink pointing to the as yet non-existent `html/en/reference/_static`.",
    "created_at": "2018-10-24T23:25:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369061",
    "user": "https://github.com/jhpalmieri"
}
```

I wonder if the problem is that it tries to copy `graphviz.css` to, for example, `html/en/reference/algebras/_static`, which is a symlink pointing to the as yet non-existent `html/en/reference/_static`.



---

archive/issue_comments_369062.json:
```json
{
    "body": "Here is a new branch. I'm not happy about the changes to `src/sage_setup/docbuild/__init__.py`, but I couldn't get the reference manual to build otherwise. Maybe there is another Sphinx bug, or maybe it's something about our multidoc extension. I would be happy if someone found a cleaner fix.\n\n(This requires Jeroen's Sphinx fix from https://github.com/sphinx-doc/sphinx/pull/5549, by the way. I did not add that as a patch to Sphinx, although maybe we will need to if Sphinx doesn't fix it themselves.)\n----\nNew commits:",
    "created_at": "2018-10-25T19:23:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369062",
    "user": "https://github.com/jhpalmieri"
}
```

Here is a new branch. I'm not happy about the changes to `src/sage_setup/docbuild/__init__.py`, but I couldn't get the reference manual to build otherwise. Maybe there is another Sphinx bug, or maybe it's something about our multidoc extension. I would be happy if someone found a cleaner fix.

(This requires Jeroen's Sphinx fix from https://github.com/sphinx-doc/sphinx/pull/5549, by the way. I did not add that as a patch to Sphinx, although maybe we will need to if Sphinx doesn't fix it themselves.)
----
New commits:



---

archive/issue_comments_369063.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-10-26T21:49:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369063",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_369064.json:
```json
{
    "body": "With this (plus Jeroen's Sphinx fix, plus #26558 if your version of TeXLive is recent), the html and pdf docs build for me.",
    "created_at": "2018-10-26T21:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369064",
    "user": "https://github.com/jhpalmieri"
}
```

With this (plus Jeroen's Sphinx fix, plus #26558 if your version of TeXLive is recent), the html and pdf docs build for me.



---

archive/issue_comments_369065.json:
```json
{
    "body": "The following tickets mentioned in the discussion above are now fixed and closed,\n\n- #26449 Sphinx and the Python 3 build of Sage\n- #26453 Relicense sphinxify.py\n- #26558 doc-pdf fails due to conflict with new babel.sty\n\nThe following pull request to Sphinx was merged on 2018-10-28,\n\n- [Sphinx issue 5549: Correctly deal with non-existing static dir in graphviz extension](https://github.com/sphinx-doc/sphinx/pull/5549)\n\nand finally\n\n- Sphinx 1.8.2 was uploaded to PyPI on 2018-11-11.\n\nIs this comment from the ticket description still a problem with Sphinx 1.8.2?\n\n> With Sphinx 1.8.1 we see quite a few\n> {{{\n> ApplicationError: Source directory and destination directory cannot be identical\n> }}}\n> coming out of Sphinx in conda as they have changed the argument checking of the `Sphinx()` constructor it seems.",
    "created_at": "2018-11-18T22:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369065",
    "user": "https://github.com/slel"
}
```

The following tickets mentioned in the discussion above are now fixed and closed,

- #26449 Sphinx and the Python 3 build of Sage
- #26453 Relicense sphinxify.py
- #26558 doc-pdf fails due to conflict with new babel.sty

The following pull request to Sphinx was merged on 2018-10-28,

- [Sphinx issue 5549: Correctly deal with non-existing static dir in graphviz extension](https://github.com/sphinx-doc/sphinx/pull/5549)

and finally

- Sphinx 1.8.2 was uploaded to PyPI on 2018-11-11.

Is this comment from the ticket description still a problem with Sphinx 1.8.2?

> With Sphinx 1.8.1 we see quite a few
> {{{
> ApplicationError: Source directory and destination directory cannot be identical
> }}}
> coming out of Sphinx in conda as they have changed the argument checking of the `Sphinx()` constructor it seems.



---

archive/issue_comments_369066.json:
```json
{
    "body": "Sphinx 1.8.3 was released on 2018-12-25.\n\nTarball: https://files.pythonhosted.org/packages/4d/ed/4595274b5c9ce53a768cc0804ef65fd6282c956b93919a969e98d53894e4/Sphinx-1.8.3.tar.gz",
    "created_at": "2019-01-13T18:52:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369066",
    "user": "https://github.com/slel"
}
```

Sphinx 1.8.3 was released on 2018-12-25.

Tarball: https://files.pythonhosted.org/packages/4d/ed/4595274b5c9ce53a768cc0804ef65fd6282c956b93919a969e98d53894e4/Sphinx-1.8.3.tar.gz



---

archive/issue_comments_369067.json:
```json
{
    "body": "Unfortunately the patch no longer works with 1.8.3. I'm getting this error on the second pass:\n\n```\n[manifolds] building [html]: targets for 60 source files that are out of date\n[manifolds] updating environment: 60 added, 0 changed, 0 removed\n[manifolds]   app.builder.info(bold('loading cross citations... '), nonl=1)\n[manifolds]   app.builder.info(\"done (%s citations).\"%len(cache))\n[manifolds]   app.builder.info(bold('linking _static directory.'))\n[manifolds] The HTML pages are in doc/html/en/reference/manifolds.\n[manifolds] Exception occurred:\n[manifolds]   File \"/usr/lib/python2.7/os.py\", line 157, in makedirs\n[manifolds]     mkdir(name, mode)\n[manifolds] OSError: [Errno 17] File exists: '/build/sagemath-doc/src/sage-8.6/src/doc/html/en/reference/manifolds/_static'\n[manifolds] The full traceback has been saved in /tmp/sphinx-err-EkdWJl.log, if you want to report the issue to the developers.\n[manifolds] Please also report this if it was a user error, so that a better error message can be provided next time.\n[manifolds] A bug report can be filed in the tracker at <https://github.com/sphinx-doc/sphinx/issues>. Thanks!\nError building the documentation.\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/runpy.py\", line 174, in _run_module_as_main\n    \"__main__\", fname, loader, pkg_name)\n  File \"/usr/lib/python2.7/runpy.py\", line 72, in _run_code\n    exec code in run_globals\n  File \"/build/sagemath-doc/src/sage-8.6/src/sage_setup/docbuild/__main__.py\", line 2, in <module>\n    main()\n  File \"/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/__init__.py\", line 1744, in main\n    builder()\n  File \"/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/__init__.py\", line 356, in _wrapper\n    getattr(get_builder(document), name)(*args, **kwds)\n  File \"/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/__init__.py\", line 547, in _wrapper\n    build_many(build_ref_doc, L)\n  File \"/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/__init__.py\", line 290, in build_many\n    results.append(target(arg))\n  File \"/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/__init__.py\", line 74, in build_ref_doc\n    getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)\n  File \"/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/__init__.py\", line 772, in _wrapper\n    getattr(DocBuilder, build_type)(self, *args, **kwds)\n  File \"/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/__init__.py\", line 130, in f\n    runsphinx()\n  File \"/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/sphinxbuild.py\", line 319, in runsphinx\n    sys.stderr.raise_errors()\n  File \"/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/sphinxbuild.py\", line 254, in raise_errors\n    raise OSError(self._error)\nOSError: Exception occurred:\n\n    Note: incremental documentation builds sometimes cause spurious\n    error messages. To be certain that these are real errors, run\n    \"make doc-clean\" first and try again.\n```\n",
    "created_at": "2019-01-17T07:01:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369067",
    "user": "https://github.com/antonio-rojas"
}
```

Unfortunately the patch no longer works with 1.8.3. I'm getting this error on the second pass:

```
[manifolds] building [html]: targets for 60 source files that are out of date
[manifolds] updating environment: 60 added, 0 changed, 0 removed
[manifolds]   app.builder.info(bold('loading cross citations... '), nonl=1)
[manifolds]   app.builder.info("done (%s citations)."%len(cache))
[manifolds]   app.builder.info(bold('linking _static directory.'))
[manifolds] The HTML pages are in doc/html/en/reference/manifolds.
[manifolds] Exception occurred:
[manifolds]   File "/usr/lib/python2.7/os.py", line 157, in makedirs
[manifolds]     mkdir(name, mode)
[manifolds] OSError: [Errno 17] File exists: '/build/sagemath-doc/src/sage-8.6/src/doc/html/en/reference/manifolds/_static'
[manifolds] The full traceback has been saved in /tmp/sphinx-err-EkdWJl.log, if you want to report the issue to the developers.
[manifolds] Please also report this if it was a user error, so that a better error message can be provided next time.
[manifolds] A bug report can be filed in the tracker at <https://github.com/sphinx-doc/sphinx/issues>. Thanks!
Error building the documentation.
Traceback (most recent call last):
  File "/usr/lib/python2.7/runpy.py", line 174, in _run_module_as_main
    "__main__", fname, loader, pkg_name)
  File "/usr/lib/python2.7/runpy.py", line 72, in _run_code
    exec code in run_globals
  File "/build/sagemath-doc/src/sage-8.6/src/sage_setup/docbuild/__main__.py", line 2, in <module>
    main()
  File "/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/__init__.py", line 1744, in main
    builder()
  File "/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/__init__.py", line 356, in _wrapper
    getattr(get_builder(document), name)(*args, **kwds)
  File "/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/__init__.py", line 547, in _wrapper
    build_many(build_ref_doc, L)
  File "/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/__init__.py", line 290, in build_many
    results.append(target(arg))
  File "/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/__init__.py", line 74, in build_ref_doc
    getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)
  File "/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/__init__.py", line 772, in _wrapper
    getattr(DocBuilder, build_type)(self, *args, **kwds)
  File "/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/__init__.py", line 130, in f
    runsphinx()
  File "/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/sphinxbuild.py", line 319, in runsphinx
    sys.stderr.raise_errors()
  File "/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/sphinxbuild.py", line 254, in raise_errors
    raise OSError(self._error)
OSError: Exception occurred:

    Note: incremental documentation builds sometimes cause spurious
    error messages. To be certain that these are real errors, run
    "make doc-clean" first and try again.
```




---

archive/issue_comments_369068.json:
```json
{
    "body": "The problem is that /build/sagemath-doc/src/sage-8.6/src/doc/html/en/reference/manifolds/_static is a symlink to a non-existant ../_static, which makes sphinx raise an error after [this commit](https://github.com/sphinx-doc/sphinx/commit/a7d950ad580eb1feab5094b59857c2eebb8a8976)",
    "created_at": "2019-01-17T19:09:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369068",
    "user": "https://github.com/antonio-rojas"
}
```

The problem is that /build/sagemath-doc/src/sage-8.6/src/doc/html/en/reference/manifolds/_static is a symlink to a non-existant ../_static, which makes sphinx raise an error after [this commit](https://github.com/sphinx-doc/sphinx/commit/a7d950ad580eb1feab5094b59857c2eebb8a8976)



---

archive/issue_comments_369069.json:
```json
{
    "body": "I don't understand what Sphinx is doing. I don't know if I will have time to work on this soon, but a starting point is to get rid of [my proposed _static commit](https://git.sagemath.org/sage.git/commit/?h=65ab61522cacad7558350f3cb1f0b16d0001235e&id=4a91a6005a550f99bd927b447d36cf7adc4e0f2c). The other commits (or variations on them \u2013 in particular `environment.patch` needs to be modified) are I think needed.\n\nHere is my first question: why does the inventory builder create `_static` directories? Those directories should not be there in the first place. They only contain `graphviz.css`, which makes me think it's a bug in Sphinx's graphviz extension. A Sage-specific patch for Sphinx that might help:\n\n```diff\ndiff --git a/sphinx/ext/graphviz.py~ b/sphinx/ext/graphviz.py\nindex c9b1541..6fffcd6 100644\n--- a/sphinx/ext/graphviz.py\n+++ b/sphinx/ext/graphviz.py\n@@ -410,7 +410,7 @@ def man_visit_graphviz(self, node):\n \n def on_build_finished(app, exc):\n     # type: (Sphinx, Exception) -> None\n-    if exc is None:\n+    if exc is None and not app.config.multidoc_first_pass:\n         src = path.join(sphinx.package_dir, 'templates', 'graphviz', 'graphviz.css')\n         dst = path.join(app.outdir, '_static')\n         copy_asset(src, dst)\n```\n",
    "created_at": "2019-01-18T00:01:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369069",
    "user": "https://github.com/jhpalmieri"
}
```

I don't understand what Sphinx is doing. I don't know if I will have time to work on this soon, but a starting point is to get rid of [my proposed _static commit](https://git.sagemath.org/sage.git/commit/?h=65ab61522cacad7558350f3cb1f0b16d0001235e&id=4a91a6005a550f99bd927b447d36cf7adc4e0f2c). The other commits (or variations on them â€“ in particular `environment.patch` needs to be modified) are I think needed.

Here is my first question: why does the inventory builder create `_static` directories? Those directories should not be there in the first place. They only contain `graphviz.css`, which makes me think it's a bug in Sphinx's graphviz extension. A Sage-specific patch for Sphinx that might help:

```diff
diff --git a/sphinx/ext/graphviz.py~ b/sphinx/ext/graphviz.py
index c9b1541..6fffcd6 100644
--- a/sphinx/ext/graphviz.py
+++ b/sphinx/ext/graphviz.py
@@ -410,7 +410,7 @@ def man_visit_graphviz(self, node):
 
 def on_build_finished(app, exc):
     # type: (Sphinx, Exception) -> None
-    if exc is None:
+    if exc is None and not app.config.multidoc_first_pass:
         src = path.join(sphinx.package_dir, 'templates', 'graphviz', 'graphviz.css')
         dst = path.join(app.outdir, '_static')
         copy_asset(src, dst)
```




---

archive/issue_comments_369070.json:
```json
{
    "body": "That patch doesn't quite work: there is still a `_static` directory in `local/share/doc/sage/inventory/en/reference/`, although it prevents them from being created in all of the subdirectories. Something stupid like `not 'inventory' in app.outdir` works, although there should be better ways to check that we're doing an inventory build. That still doesn't work, of course, but it's a place to start.",
    "created_at": "2019-01-18T00:26:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369070",
    "user": "https://github.com/jhpalmieri"
}
```

That patch doesn't quite work: there is still a `_static` directory in `local/share/doc/sage/inventory/en/reference/`, although it prevents them from being created in all of the subdirectories. Something stupid like `not 'inventory' in app.outdir` works, although there should be better ways to check that we're doing an inventory build. That still doesn't work, of course, but it's a place to start.



---

archive/issue_comments_369071.json:
```json
{
    "body": "If I use some sort of stupid patch on graphviz.py, then Sphinx crashes when it reaches the second pass, because of the reason you point out: `html/en/reference/_static` does not exist, but there are symlinks pointing to it. If I then manually create this directory (which we could add to the code), the docbuild still fails:\n\n```\nWARNING: search index couldn't be loaded, but not all documents will be built: the index will be incomplete.\n```\n\nThere is a method in sphinx.builders.html called `load_indexer`, and for reasons I don't understand, it is not finding all of the relevant files: its input is two lists, the files it thinks it should include, and the files covered by the index, and if they are not the same, it raises this warning. I added some print statements to see how these two sets differed, and I couldn't see any pattern. When I disable that warning, it gets much farther, but I'm guessing that something will be broken with either the documentation or the index.",
    "created_at": "2019-01-18T06:14:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369071",
    "user": "https://github.com/jhpalmieri"
}
```

If I use some sort of stupid patch on graphviz.py, then Sphinx crashes when it reaches the second pass, because of the reason you point out: `html/en/reference/_static` does not exist, but there are symlinks pointing to it. If I then manually create this directory (which we could add to the code), the docbuild still fails:

```
WARNING: search index couldn't be loaded, but not all documents will be built: the index will be incomplete.
```

There is a method in sphinx.builders.html called `load_indexer`, and for reasons I don't understand, it is not finding all of the relevant files: its input is two lists, the files it thinks it should include, and the files covered by the index, and if they are not the same, it raises this warning. I added some print statements to see how these two sets differed, and I couldn't see any pattern. When I disable that warning, it gets much farther, but I'm guessing that something will be broken with either the documentation or the index.



---

archive/issue_comments_369072.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-18T06:41:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369072",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_369073.json:
```json
{
    "body": "Okay, here is my current \"progress\". If I use the branch I just posted, along with this change to Sphinx (which is a terrible idea):\n\n```diff\ndiff --git a/sphinx/builders/html.py b/sphinx/builders/html.py\nindex 5060d1f..6747b6c 100644\n--- a/sphinx/builders/html.py\n+++ b/sphinx/builders/html.py\n@@ -1010,7 +1010,7 @@ class StandaloneHTMLBuilder(Builder):\n             with f:\n                 self.indexer.load(f, self.indexer_format)\n         except (IOError, OSError, ValueError):\n-            if keep:\n+            if keep and False:\n                 logger.warning(__('search index couldn\\'t be loaded, but not all '\n                                   'documents will be built: the index will be '\n                                   'incomplete.'))\n```\n\nthen the documentation builds. Remaining questions: is the documentation complete? Is the index complete? What is the right way to fix the problem that this stupid patch fixes? Are the other changes okay?",
    "created_at": "2019-01-18T06:44:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369073",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, here is my current "progress". If I use the branch I just posted, along with this change to Sphinx (which is a terrible idea):

```diff
diff --git a/sphinx/builders/html.py b/sphinx/builders/html.py
index 5060d1f..6747b6c 100644
--- a/sphinx/builders/html.py
+++ b/sphinx/builders/html.py
@@ -1010,7 +1010,7 @@ class StandaloneHTMLBuilder(Builder):
             with f:
                 self.indexer.load(f, self.indexer_format)
         except (IOError, OSError, ValueError):
-            if keep:
+            if keep and False:
                 logger.warning(__('search index couldn\'t be loaded, but not all '
                                   'documents will be built: the index will be '
                                   'incomplete.'))
```

then the documentation builds. Remaining questions: is the documentation complete? Is the index complete? What is the right way to fix the problem that this stupid patch fixes? Are the other changes okay?



---

archive/issue_comments_369074.json:
```json
{
    "body": "This really should be rebased to #26949 since that makes non-trivial changes to the docbuilder.",
    "created_at": "2019-01-18T09:19:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369074",
    "user": "https://github.com/jdemeyer"
}
```

This really should be rebased to #26949 since that makes non-trivial changes to the docbuilder.



---

archive/issue_comments_369075.json:
```json
{
    "body": "Note that the line from #26949\n\n```\nfrom sphinx.ext.autodoc.inspector import format_annotation, formatargspec\n```\n\nand later use of `formatargspec` leads to deprecation warnings with new versions of Sphinx.",
    "created_at": "2019-01-18T23:53:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369075",
    "user": "https://github.com/jhpalmieri"
}
```

Note that the line from #26949

```
from sphinx.ext.autodoc.inspector import format_annotation, formatargspec
```

and later use of `formatargspec` leads to deprecation warnings with new versions of Sphinx.



---

archive/issue_comments_369076.json:
```json
{
    "body": "On the other hand, documentation seems to build with the branch here + #26949. Now to figure out which changes are actually needed once rebased to #26949.",
    "created_at": "2019-01-19T00:17:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369076",
    "user": "https://github.com/jhpalmieri"
}
```

On the other hand, documentation seems to build with the branch here + #26949. Now to figure out which changes are actually needed once rebased to #26949.



---

archive/issue_comments_369077.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-21T07:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369077",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_369078.json:
```json
{
    "body": "Okay, let's try this.",
    "created_at": "2019-01-21T07:04:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369078",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, let's try this.



---

archive/issue_comments_369079.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2019-01-21T07:04:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369079",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_369080.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-01-21T07:05:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369080",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_369081.json:
```json
{
    "body": "I'd rather wait until the dependency is actually merged to review this.",
    "created_at": "2019-01-21T07:15:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369081",
    "user": "https://github.com/jdemeyer"
}
```

I'd rather wait until the dependency is actually merged to review this.



---

archive/issue_comments_369082.json:
```json
{
    "body": "What's the upstream story of that patch? Was it proposed somewhere? What is its purpose?",
    "created_at": "2019-01-22T20:23:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369082",
    "user": "https://github.com/timokau"
}
```

What's the upstream story of that patch? Was it proposed somewhere? What is its purpose?



---

archive/issue_comments_369083.json:
```json
{
    "body": "For its purpose, see comments 25-30, 39, and maybe some others. (Search this page for \"graphviz\".) Basically, Sphinx needlessly copies the file `graphviz.css` to `inventory/en/refererence/MODULE/_static/` directories, and then that confuses the intersphinx build. I haven't reported it upstream because I don't know how Sage-specific it is. We have our own inventory builder, our own \"multidocs\" extension, etc., and it is not clear how much those are responsible for the problem.\n\nI would also not be surprised if there were better ways to handle the problem with `graphviz.css`. I believe that my suggestion works, so now is the time to confirm that and then to improve on it. (Or wait until #26949 is merged and then do that.)",
    "created_at": "2019-01-22T20:51:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369083",
    "user": "https://github.com/jhpalmieri"
}
```

For its purpose, see comments 25-30, 39, and maybe some others. (Search this page for "graphviz".) Basically, Sphinx needlessly copies the file `graphviz.css` to `inventory/en/refererence/MODULE/_static/` directories, and then that confuses the intersphinx build. I haven't reported it upstream because I don't know how Sage-specific it is. We have our own inventory builder, our own "multidocs" extension, etc., and it is not clear how much those are responsible for the problem.

I would also not be surprised if there were better ways to handle the problem with `graphviz.css`. I believe that my suggestion works, so now is the time to confirm that and then to improve on it. (Or wait until #26949 is merged and then do that.)



---

archive/issue_comments_369084.json:
```json
{
    "body": "Rebased to 8.7.beta1\n----\nNew commits:",
    "created_at": "2019-01-29T08:59:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369084",
    "user": "https://github.com/jdemeyer"
}
```

Rebased to 8.7.beta1
----
New commits:



---

archive/issue_comments_369085.json:
```json
{
    "body": "I also restored some of the older commits, to make clear who did what.",
    "created_at": "2019-01-29T09:03:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369085",
    "user": "https://github.com/jdemeyer"
}
```

I also restored some of the older commits, to make clear who did what.



---

archive/issue_comments_369086.json:
```json
{
    "body": "Based on the diff, I'm willing to give this ticket the benefit of the doubt. I cannot say that I understand everything but there is nothing obviously bad.\n\nI haven't actually built the documentation yet, I'll do that next.",
    "created_at": "2019-01-29T09:07:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369086",
    "user": "https://github.com/jdemeyer"
}
```

Based on the diff, I'm willing to give this ticket the benefit of the doubt. I cannot say that I understand everything but there is nothing obviously bad.

I haven't actually built the documentation yet, I'll do that next.



---

archive/issue_comments_369087.json:
```json
{
    "body": "As a packager I share Timo's concerns about the sphinx patch. Are there plans to upstream it?",
    "created_at": "2019-01-29T09:10:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369087",
    "user": "https://github.com/antonio-rojas"
}
```

As a packager I share Timo's concerns about the sphinx patch. Are there plans to upstream it?



---

archive/issue_comments_369088.json:
```json
{
    "body": "Replying to [comment:57 arojas]:\n> As a packager I share Timo's concerns about the sphinx patch.\n\nIs there is any particular reason that you're concerned about that specific patch and not the other patches that Sage has for Sphinx?",
    "created_at": "2019-01-29T13:32:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369088",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:57 arojas]:
> As a packager I share Timo's concerns about the sphinx patch.

Is there is any particular reason that you're concerned about that specific patch and not the other patches that Sage has for Sphinx?



---

archive/issue_comments_369089.json:
```json
{
    "body": "Replying to [comment:58 jdemeyer]:\n> Replying to [comment:57 arojas]:\n> > As a packager I share Timo's concerns about the sphinx patch.\n> \n> Is there is any particular reason that you're concerned about that specific patch and not the other patches that Sage has for Sphinx?\n\nYes, those other patches either address minor issues or are not relevant to Arch, so not having them is not a problem. This one is necessary for docs to build at all.",
    "created_at": "2019-01-29T13:36:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369089",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:58 jdemeyer]:
> Replying to [comment:57 arojas]:
> > As a packager I share Timo's concerns about the sphinx patch.
> 
> Is there is any particular reason that you're concerned about that specific patch and not the other patches that Sage has for Sphinx?

Yes, those other patches either address minor issues or are not relevant to Arch, so not having them is not a problem. This one is necessary for docs to build at all.



---

archive/issue_comments_369090.json:
```json
{
    "body": "There is a minor regression in the produced documentation: a `<BLANKLIKE>` in a doctest is now rendered as `<BLANKLINE>` instead of an actual blank line.",
    "created_at": "2019-01-29T15:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369090",
    "user": "https://github.com/jdemeyer"
}
```

There is a minor regression in the produced documentation: a `<BLANKLIKE>` in a doctest is now rendered as `<BLANKLINE>` instead of an actual blank line.



---

archive/issue_comments_369091.json:
```json
{
    "body": "That's the only issue in the generated documentation I could find by diffing the docs before and after this ticket. It does have problems with parsing ``A = ` ``self``` (see `src/sage/categories/filtered_algebras_with_basis.py`) but the current version also has problems, just different problems.",
    "created_at": "2019-01-29T15:32:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369091",
    "user": "https://github.com/jdemeyer"
}
```

That's the only issue in the generated documentation I could find by diffing the docs before and after this ticket. It does have problems with parsing ``A = ` ``self``` (see `src/sage/categories/filtered_algebras_with_basis.py`) but the current version also has problems, just different problems.



---

archive/issue_comments_369092.json:
```json
{
    "body": "Replying to [comment:60 jdemeyer]:\n> There is a minor regression in the produced documentation: a `<BLANKLIKE>` in a doctest is now rendered as `<BLANKLINE>` instead of an actual blank line.\n\nDid you check to see if other `nonmath_substitutes` from `misc.sagedoc` are handled properly? (Or I should say, at least as properly as they currently are?)",
    "created_at": "2019-01-29T19:45:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369092",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:60 jdemeyer]:
> There is a minor regression in the produced documentation: a `<BLANKLIKE>` in a doctest is now rendered as `<BLANKLINE>` instead of an actual blank line.

Did you check to see if other `nonmath_substitutes` from `misc.sagedoc` are handled properly? (Or I should say, at least as properly as they currently are?)



---

archive/issue_comments_369093.json:
```json
{
    "body": "Maybe this isn't handled by `sage.misc.sagedoc`, but should instead be handled by `sphinx.ext.doctest`: lines like\n\n```\n        if self.name == 'doctest':\n            if '<BLANKLINE>' in code:\n                # convert <BLANKLINE>s to ordinary blank lines for presentation\n                test = code\n                code = blankline_re.sub('', code)\n```\n\nThere weren't any changes in this between the old and new versions of Sphinx.",
    "created_at": "2019-01-29T20:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369093",
    "user": "https://github.com/jhpalmieri"
}
```

Maybe this isn't handled by `sage.misc.sagedoc`, but should instead be handled by `sphinx.ext.doctest`: lines like

```
        if self.name == 'doctest':
            if '<BLANKLINE>' in code:
                # convert <BLANKLINE>s to ordinary blank lines for presentation
                test = code
                code = blankline_re.sub('', code)
```

There weren't any changes in this between the old and new versions of Sphinx.



---

archive/issue_comments_369094.json:
```json
{
    "body": "Replying to [comment:59 arojas]:\n> Replying to [comment:58 jdemeyer]:\n> > Replying to [comment:57 arojas]:\n> > > As a packager I share Timo's concerns about the sphinx patch.\n> > \n> > Is there is any particular reason that you're concerned about that specific patch and not the other patches that Sage has for Sphinx?\n> \n> Yes, those other patches either address minor issues or are not relevant to Arch, so not having them is not a problem. This one is necessary for docs to build at all.\n\nHere is maybe a better approach with graphviz.\n----\nNew commits:",
    "created_at": "2019-01-30T06:03:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369094",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:59 arojas]:
> Replying to [comment:58 jdemeyer]:
> > Replying to [comment:57 arojas]:
> > > As a packager I share Timo's concerns about the sphinx patch.
> > 
> > Is there is any particular reason that you're concerned about that specific patch and not the other patches that Sage has for Sphinx?
> 
> Yes, those other patches either address minor issues or are not relevant to Arch, so not having them is not a problem. This one is necessary for docs to build at all.

Here is maybe a better approach with graphviz.
----
New commits:



---

archive/issue_comments_369095.json:
```json
{
    "body": "The point here is that the inventory builder is Sage-specific, and that's where the problem lies. So patching graphviz.py to deal with the inventory builder is okay (in my opinion) and would not make sense to report upstream. It looks like we can deal with it differently, though: rather than preventing graphviz.py from populating `_static` directories, we can remove them in the cleanup stage of the inventory build.",
    "created_at": "2019-01-30T06:06:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369095",
    "user": "https://github.com/jhpalmieri"
}
```

The point here is that the inventory builder is Sage-specific, and that's where the problem lies. So patching graphviz.py to deal with the inventory builder is okay (in my opinion) and would not make sense to report upstream. It looks like we can deal with it differently, though: rather than preventing graphviz.py from populating `_static` directories, we can remove them in the cleanup stage of the inventory build.



---

archive/issue_comments_369096.json:
```json
{
    "body": "Great! I'll look into the `<BLANKLINE>` thing now.",
    "created_at": "2019-01-30T14:10:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369096",
    "user": "https://github.com/jdemeyer"
}
```

Great! I'll look into the `<BLANKLINE>` thing now.



---

archive/issue_comments_369097.json:
```json
{
    "body": "Replying to [comment:66 jhpalmieri]:\n> The point here is that the inventory builder is Sage-specific, and that's where the problem lies. So patching graphviz.py to deal with the inventory builder is okay (in my opinion) and would not make sense to report upstream. It looks like we can deal with it differently, though: rather than preventing graphviz.py from populating `_static` directories, we can remove them in the cleanup stage of the inventory build.\n\nThanks. With this branch, the docs build fine on Arch with unpatched sphinx 1.8.3, modulo #26608",
    "created_at": "2019-01-30T14:26:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369097",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:66 jhpalmieri]:
> The point here is that the inventory builder is Sage-specific, and that's where the problem lies. So patching graphviz.py to deal with the inventory builder is okay (in my opinion) and would not make sense to report upstream. It looks like we can deal with it differently, though: rather than preventing graphviz.py from populating `_static` directories, we can remove them in the cleanup stage of the inventory build.

Thanks. With this branch, the docs build fine on Arch with unpatched sphinx 1.8.3, modulo #26608



---

archive/issue_comments_369098.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-30T17:55:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369098",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_369099.json:
```json
{
    "body": "The most recent commit is an attempt on my part to squash the commits that add and then remove the graphviz patch. My first time squashing, so I hope it worked.",
    "created_at": "2019-01-30T17:56:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369099",
    "user": "https://github.com/jhpalmieri"
}
```

The most recent commit is an attempt on my part to squash the commits that add and then remove the graphviz patch. My first time squashing, so I hope it worked.



---

archive/issue_comments_369100.json:
```json
{
    "body": "Thanks for avoiding the graphviz.py patch. Now we can also use the patch in Debian.\n\nIn Debian we have a few new failing doctests with sage 8.6, sphinx 1.8.3 and this patch. There is this:\n\n\n```\nsage -t --long src/doc/common/conf.py\n**********************************************************************\nFile \"src/doc/common/conf.py\", line 619, in doc.common.conf.call_intersphinx\nFailed example:\n    for line in open(thematic_index).readlines():  # optional - dochtml\n        if \"padics\" in line:\n            sys.stdout.write(line)\nExpected:\n    <li><a class=\"reference external\" href=\"../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial\" title=\"(in Sage Reference Manual: p-Adics v...)\"><span>Introduction to the -adics</span></a></li>\nGot:\n    <li><a class=\"reference external\" href=\"../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial\" title=\"(in Sage Reference Manual: p-Adics v8.6)\"><span>Introduction to the p-adics</span></a></li>\n```\n\nand 6 occurances of `ApplicationError: Source directory and destination directory cannot be identical` in `sagenb/misc/sphinxify.py` (which need to be fixed in sagenb I guess).",
    "created_at": "2019-01-31T23:34:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369100",
    "user": "https://github.com/tobihan"
}
```

Thanks for avoiding the graphviz.py patch. Now we can also use the patch in Debian.

In Debian we have a few new failing doctests with sage 8.6, sphinx 1.8.3 and this patch. There is this:


```
sage -t --long src/doc/common/conf.py
**********************************************************************
File "src/doc/common/conf.py", line 619, in doc.common.conf.call_intersphinx
Failed example:
    for line in open(thematic_index).readlines():  # optional - dochtml
        if "padics" in line:
            sys.stdout.write(line)
Expected:
    <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(in Sage Reference Manual: p-Adics v...)"><span>Introduction to the -adics</span></a></li>
Got:
    <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(in Sage Reference Manual: p-Adics v8.6)"><span>Introduction to the p-adics</span></a></li>
```

and 6 occurances of `ApplicationError: Source directory and destination directory cannot be identical` in `sagenb/misc/sphinxify.py` (which need to be fixed in sagenb I guess).



---

archive/issue_comments_369101.json:
```json
{
    "body": "Cc Dima Pasechnik about the sagenb question.",
    "created_at": "2019-01-31T23:41:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369101",
    "user": "https://github.com/slel"
}
```

Cc Dima Pasechnik about the sagenb question.



---

archive/issue_comments_369102.json:
```json
{
    "body": "Replying to [comment:72 slelievre]:\n> Cc Dima Pasechnik about the sagenb question.\nThanks. This is now https://github.com/sagemath/sagenb/issues/465",
    "created_at": "2019-02-01T00:21:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369102",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:72 slelievre]:
> Cc Dima Pasechnik about the sagenb question.
Thanks. This is now https://github.com/sagemath/sagenb/issues/465



---

archive/issue_comments_369103.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-02-01T18:50:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369103",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_369104.json:
```json
{
    "body": "The SageNB problem should be fixed from their end, and here is a fix for the Sage doctest failure.",
    "created_at": "2019-02-01T18:51:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369104",
    "user": "https://github.com/jhpalmieri"
}
```

The SageNB problem should be fixed from their end, and here is a fix for the Sage doctest failure.



---

archive/issue_comments_369105.json:
```json
{
    "body": "Replying to [comment:75 jhpalmieri]:\n> The SageNB problem should be fixed from their end, and here is a fix for the Sage doctest failure.\n\nIt is fixed now (the fix will be the next sagenb release).",
    "created_at": "2019-02-01T19:37:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369105",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:75 jhpalmieri]:
> The SageNB problem should be fixed from their end, and here is a fix for the Sage doctest failure.

It is fixed now (the fix will be the next sagenb release).



---

archive/issue_comments_369106.json:
```json
{
    "body": "One annoying warning with this sphinx now:\n\n```\nsrc/sage_setup/docbuild/ext/sage_autodoc.py:1170: RemovedInSphinx20Warning: formatargspec() is now deprecated.  Please use sphinx.util.inspect.Signature \n```\n\n\n(and the same warning in `sage_autodoc.py:1072`)",
    "created_at": "2019-02-01T19:49:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369106",
    "user": "https://github.com/dimpase"
}
```

One annoying warning with this sphinx now:

```
src/sage_setup/docbuild/ext/sage_autodoc.py:1170: RemovedInSphinx20Warning: formatargspec() is now deprecated.  Please use sphinx.util.inspect.Signature 
```


(and the same warning in `sage_autodoc.py:1072`)



---

archive/issue_comments_369107.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-02-01T19:49:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369107",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_369108.json:
```json
{
    "body": "Noted in comment:45. It's annoying but can we deal with it on another ticket?",
    "created_at": "2019-02-01T20:02:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369108",
    "user": "https://github.com/jhpalmieri"
}
```

Noted in comment:45. It's annoying but can we deal with it on another ticket?



---

archive/issue_comments_369109.json:
```json
{
    "body": "In particular, I don't know how to solve it. `Signature` does not seem to be just a drop-in replacement. We could just silence the warnings, but that's probably a bad idea.",
    "created_at": "2019-02-01T20:13:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369109",
    "user": "https://github.com/jhpalmieri"
}
```

In particular, I don't know how to solve it. `Signature` does not seem to be just a drop-in replacement. We could just silence the warnings, but that's probably a bad idea.



---

archive/issue_comments_369110.json:
```json
{
    "body": "I agree, it needs a bit of coding (examples may be found by googling this warning...)\nA new ticket then. By the way, the sagenb update is on #27200.",
    "created_at": "2019-02-01T20:30:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369110",
    "user": "https://github.com/dimpase"
}
```

I agree, it needs a bit of coding (examples may be found by googling this warning...)
A new ticket then. By the way, the sagenb update is on #27200.



---

archive/issue_comments_369111.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2019-02-01T20:30:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369111",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_369112.json:
```json
{
    "body": "Jeroen, do you agree with the positive review?",
    "created_at": "2019-02-01T21:15:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369112",
    "user": "https://github.com/jhpalmieri"
}
```

Jeroen, do you agree with the positive review?



---

archive/issue_comments_369113.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2019-02-02T07:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369113",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_369114.json:
```json
{
    "body": "Is the `<BLANKLINE>` issue fixed?",
    "created_at": "2019-02-02T07:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369114",
    "user": "https://github.com/jdemeyer"
}
```

Is the `<BLANKLINE>` issue fixed?



---

archive/issue_comments_369115.json:
```json
{
    "body": "to me, blankline is blankline, how to check this...",
    "created_at": "2019-02-02T08:03:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369115",
    "user": "https://github.com/dimpase"
}
```

to me, blankline is blankline, how to check this...



---

archive/issue_comments_369116.json:
```json
{
    "body": "some of the doctests here are fixed by #27200, adding as a dependency",
    "created_at": "2019-02-02T09:48:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369116",
    "user": "https://github.com/dimpase"
}
```

some of the doctests here are fixed by #27200, adding as a dependency



---

archive/issue_comments_369117.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-02-02T17:54:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369117",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_369118.json:
```json
{
    "body": "Two problems:\n- The BLANKLINE problem is still there. For example, in `calculus/riemann.pyx`, a doctest for `complex_to_spiderweb` includes `<BLANKLINE>`. With the old Sphinx, this was printed as an actual blank line, while with the new one, it prints \"<BLANKLINE>\".\n- The real blocker: math is not rendered in the reference manual (although it is in the tutorial). Indeed, in the generated html files, these lines were included in the old Sphinx, but not in the new one. I don't know why, and I don't know if I have time figure it out right now:\n\n```\n    <script type=\"text/javascript\" src=\"../../../_static/MathJax.js?config=TeX-AMS_HTML-full,../mathjax_sage.js\"></script>\n    <script type=\"text/javascript\" src=\"../../../_static/MathJax.js?config=TeX-AMS_HTML-full,../mathjax_sage.js\"></script>\n```\n\nManually adding those lines fixes the problem, but they should be there automatically.",
    "created_at": "2019-02-02T17:54:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369118",
    "user": "https://github.com/jhpalmieri"
}
```

Two problems:
- The BLANKLINE problem is still there. For example, in `calculus/riemann.pyx`, a doctest for `complex_to_spiderweb` includes `<BLANKLINE>`. With the old Sphinx, this was printed as an actual blank line, while with the new one, it prints "<BLANKLINE>".
- The real blocker: math is not rendered in the reference manual (although it is in the tutorial). Indeed, in the generated html files, these lines were included in the old Sphinx, but not in the new one. I don't know why, and I don't know if I have time figure it out right now:

```
    <script type="text/javascript" src="../../../_static/MathJax.js?config=TeX-AMS_HTML-full,../mathjax_sage.js"></script>
    <script type="text/javascript" src="../../../_static/MathJax.js?config=TeX-AMS_HTML-full,../mathjax_sage.js"></script>
```

Manually adding those lines fixes the problem, but they should be there automatically.



---

archive/issue_comments_369119.json:
```json
{
    "body": "I tried to replace src/doc/common/themes/sageref with a symlink to src/doc/common/themes/sage, but this did not change the result (no TeX in reference manual).\n\nCould it be some special parallel hack that breaks it? I really have no idea.",
    "created_at": "2019-02-04T12:06:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369119",
    "user": "https://github.com/dimpase"
}
```

I tried to replace src/doc/common/themes/sageref with a symlink to src/doc/common/themes/sage, but this did not change the result (no TeX in reference manual).

Could it be some special parallel hack that breaks it? I really have no idea.



---

archive/issue_comments_369120.json:
```json
{
    "body": "I think the issue is that in the new Sphinx, `sphinx.ext.mathjax` has the line\n\n```\n    app.connect('env-check-consistency', install_mathjax)\n```\n\nAs far as I can tell, this means that those lines should be produced when `self.env.check_consistency()` is run, but it doesn't get run during the reference/html build. I'm guessing this is because of our multidocs extension, or maybe the sage_autodoc extension.",
    "created_at": "2019-02-05T18:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369120",
    "user": "https://github.com/jhpalmieri"
}
```

I think the issue is that in the new Sphinx, `sphinx.ext.mathjax` has the line

```
    app.connect('env-check-consistency', install_mathjax)
```

As far as I can tell, this means that those lines should be produced when `self.env.check_consistency()` is run, but it doesn't get run during the reference/html build. I'm guessing this is because of our multidocs extension, or maybe the sage_autodoc extension.



---

archive/issue_comments_369121.json:
```json
{
    "body": "Sphinx 1.8.4 was released and uploaded to PyPI on 2019-02-03.\n\n- **Tarball**: https://files.pythonhosted.org/packages/dd/f8/df628d41f42793d446285767164c6a8da71d82892f2c98c43e0523836d39/Sphinx-1.8.4.tar.gz",
    "created_at": "2019-02-14T14:14:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369121",
    "user": "https://github.com/slel"
}
```

Sphinx 1.8.4 was released and uploaded to PyPI on 2019-02-03.

- **Tarball**: https://files.pythonhosted.org/packages/dd/f8/df628d41f42793d446285767164c6a8da71d82892f2c98c43e0523836d39/Sphinx-1.8.4.tar.gz



---

archive/issue_comments_369122.json:
```json
{
    "body": "Unfortunately this doesn't help with the mathjax issue. I'm stuck, so I hope someone else has some ideas.",
    "created_at": "2019-02-14T16:03:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369122",
    "user": "https://github.com/jhpalmieri"
}
```

Unfortunately this doesn't help with the mathjax issue. I'm stuck, so I hope someone else has some ideas.



---

archive/issue_comments_369123.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-19T22:47:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369123",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_369124.json:
```json
{
    "body": "Okay, I've fixed the mathjax problem and the `<BLANKLINE>` problem. The second of these involves patching Sphinx, so if you don't want patches, you will get `<BLANKLINE>` in some doctest output, rather than an actual blank line. Sphinx still produces lots of `formatargspec() is now deprecated` warnings, but I suggest we deal with those in a separate ticket.\n\nOh, by the way, [Sphinx 2.0.0.beta1](https://github.com/sphinx-doc/sphinx/blob/v2.0.0b1/CHANGES) has been released. It drops Python 2.7 support, so it's not for us yet.",
    "created_at": "2019-02-19T22:51:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369124",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, I've fixed the mathjax problem and the `<BLANKLINE>` problem. The second of these involves patching Sphinx, so if you don't want patches, you will get `<BLANKLINE>` in some doctest output, rather than an actual blank line. Sphinx still produces lots of `formatargspec() is now deprecated` warnings, but I suggest we deal with those in a separate ticket.

Oh, by the way, [Sphinx 2.0.0.beta1](https://github.com/sphinx-doc/sphinx/blob/v2.0.0b1/CHANGES) has been released. It drops Python 2.7 support, so it's not for us yet.



---

archive/issue_comments_369125.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-02-19T23:04:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369125",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_369126.json:
```json
{
    "body": "Changing keywords from \"sphinx, conda\" to \"sphinx, conda, upgrade\".",
    "created_at": "2019-02-19T23:12:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369126",
    "user": "https://github.com/slel"
}
```

Changing keywords from "sphinx, conda" to "sphinx, conda, upgrade".



---

archive/issue_comments_369127.json:
```json
{
    "body": "If all else fails, we can just silence those deprecation warnings the same way we silence lots of other \"chatter\" in the Sphinx build. See `sage_setup/docbuild/sphinxbuild.py`.",
    "created_at": "2019-02-19T23:13:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369127",
    "user": "https://github.com/jhpalmieri"
}
```

If all else fails, we can just silence those deprecation warnings the same way we silence lots of other "chatter" in the Sphinx build. See `sage_setup/docbuild/sphinxbuild.py`.



---

archive/issue_comments_369128.json:
```json
{
    "body": "Why wasn't the `sage:` prompt patch necessary before?\n\nOn nixos with this patch applied I get some kind of unicode issue (not sure if its 100% reproducible; I think I've seen it working some time):\n\n\n```\nsage -t docsrc/common/conf.py\n**********************************************************************\nFile \"docsrc/common/conf.py\", line 614, in common.conf.call_intersphinx\nFailed example:\n    for line in open(thematic_index).readlines():  # optional - dochtml\n        if \"padics\" in line:\n            sys.stdout.write(line)\nExpected:\n    <li><a class=\"reference external\" href=\"../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial\" title=\"(i\nn Sage Reference Manual: p-Adics v...)\"><span>Introduction to the p-adics</span></a></li>\nGot:\n    <li><a class=\"reference external\" href=\"../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial\" title=\"(\u0432\n Sage Reference Manual: p-Adics v8.6)\"><span>Introduction to the p-adics</span></a></li>\n**********************************************************************\n1 item had failures:\n   1 of   4 in common.conf.call_intersphinx\n    [3 tests, 1 failure, 0.01 s]\n```\n\n\nI don't know if this has to do with some different dependency on nix or if it could also happen on sage-the-distro.",
    "created_at": "2019-02-20T14:47:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369128",
    "user": "https://github.com/timokau"
}
```

Why wasn't the `sage:` prompt patch necessary before?

On nixos with this patch applied I get some kind of unicode issue (not sure if its 100% reproducible; I think I've seen it working some time):


```
sage -t docsrc/common/conf.py
**********************************************************************
File "docsrc/common/conf.py", line 614, in common.conf.call_intersphinx
Failed example:
    for line in open(thematic_index).readlines():  # optional - dochtml
        if "padics" in line:
            sys.stdout.write(line)
Expected:
    <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(i
n Sage Reference Manual: p-Adics v...)"><span>Introduction to the p-adics</span></a></li>
Got:
    <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(Ð²
 Sage Reference Manual: p-Adics v8.6)"><span>Introduction to the p-adics</span></a></li>
**********************************************************************
1 item had failures:
   1 of   4 in common.conf.call_intersphinx
    [3 tests, 1 failure, 0.01 s]
```


I don't know if this has to do with some different dependency on nix or if it could also happen on sage-the-distro.



---

archive/issue_comments_369129.json:
```json
{
    "body": "Replying to [comment:96 gh-timokau]:\n> Why wasn't the `sage:` prompt patch necessary before?\n\nBecause the file being patched didn't exist before.\n\n> On nixos with this patch applied I get some kind of unicode issue (not sure if its 100% reproducible; I think I've seen it working some time):\n> \n> {{{\n> sage -t docsrc/common/conf.py\n> **********************************************************************\n> File \"docsrc/common/conf.py\", line 614, in common.conf.call_intersphinx\n> Failed example:\n>     for line in open(thematic_index).readlines():  # optional - dochtml\n>         if \"padics\" in line:\n>             sys.stdout.write(line)\n> Expected:\n>     <li><a class=\"reference external\" href=\"../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial\" title=\"(i\n> n Sage Reference Manual: p-Adics v...)\"><span>Introduction to the p-adics</span></a></li>\n> Got:\n>     <li><a class=\"reference external\" href=\"../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial\" title=\"(\u0432\n>  Sage Reference Manual: p-Adics v8.6)\"><span>Introduction to the p-adics</span></a></li>\n> **********************************************************************\n> 1 item had failures:\n>    1 of   4 in common.conf.call_intersphinx\n>     [3 tests, 1 failure, 0.01 s]\n> }}}\n> \n> I don't know if this has to do with some different dependency on nix or if it could also happen on sage-the-distro.\n\nI don't see this with sage-the-distro. The file `doc/common/conf.py` had its doctests changed recently in another ticket (to fix Python 3 issues, I think). This branch doesn't touch that file, and I don't see why it would be related.",
    "created_at": "2019-02-20T16:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369129",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:96 gh-timokau]:
> Why wasn't the `sage:` prompt patch necessary before?

Because the file being patched didn't exist before.

> On nixos with this patch applied I get some kind of unicode issue (not sure if its 100% reproducible; I think I've seen it working some time):
> 
> {{{
> sage -t docsrc/common/conf.py
> **********************************************************************
> File "docsrc/common/conf.py", line 614, in common.conf.call_intersphinx
> Failed example:
>     for line in open(thematic_index).readlines():  # optional - dochtml
>         if "padics" in line:
>             sys.stdout.write(line)
> Expected:
>     <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(i
> n Sage Reference Manual: p-Adics v...)"><span>Introduction to the p-adics</span></a></li>
> Got:
>     <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(Ð²
>  Sage Reference Manual: p-Adics v8.6)"><span>Introduction to the p-adics</span></a></li>
> **********************************************************************
> 1 item had failures:
>    1 of   4 in common.conf.call_intersphinx
>     [3 tests, 1 failure, 0.01 s]
> }}}
> 
> I don't know if this has to do with some different dependency on nix or if it could also happen on sage-the-distro.

I don't see this with sage-the-distro. The file `doc/common/conf.py` had its doctests changed recently in another ticket (to fix Python 3 issues, I think). This branch doesn't touch that file, and I don't see why it would be related.



---

archive/issue_comments_369130.json:
```json
{
    "body": "Replying to [comment:92 jhpalmieri]:\n> Okay, I've fixed the mathjax problem and the `<BLANKLINE>` problem. The second of these involves patching Sphinx, so if you don't want patches, you will get `<BLANKLINE>` in some doctest output, rather than an actual blank line.\n\nInstead of adding this very sage specific patch to sphinx, why not do this in a sphinx extension?\n\nLike this:\n\n\n```\n--- a/src/doc/common/conf.py\n+++ b/src/doc/common/conf.py\n@@ -13,7 +13,7 @@\n \n # Add any Sphinx extension module names here, as strings. They can be extensions\n # coming with Sphinx (named 'sphinx.ext.*') or your custom ones.\n-extensions = ['inventory_builder', 'multidocs',\n+extensions = ['inventory_builder', 'multidocs', 'trim_doctest_flags',\n               'sage_autodoc',  'sphinx.ext.graphviz',\n               'sphinx.ext.inheritance_diagram', 'sphinx.ext.todo',\n               'sphinx.ext.extlinks', 'matplotlib.sphinxext.plot_directive']\n--- /dev/null\n+++ b/src/sage_setup/docbuild/ext/trim_doctest_flags.py\n@@ -0,0 +1,67 @@\n+\"\"\"\n+    trim doctest flags\n+    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+    transforms for code-blocks.\n+\n+    modified from sphinx.transforms.post_transforms.code\n+\n+    :copyright: Copyright 2007-2019 by the Sphinx team, see AUTHORS.\n+    :license: BSD, see LICENSE for details.\n+\"\"\"\n+\n+import sys\n+from typing import NamedTuple\n+\n+from docutils import nodes\n+from pygments.lexers import PythonConsoleLexer, guess_lexer\n+\n+from sphinx import addnodes\n+from sphinx.ext import doctest\n+from sphinx.transforms import SphinxTransform\n+\n+class TrimDoctestFlagsTransformSage(SphinxTransform):\n+    \"\"\"\n+    Trim doctest flags like ``# doctest: +FLAG`` from sage code-blocks.\n+\n+    The only difference from Sphinx' TrimDoctestFlagsTransform is that\n+    here lines starting with 'sage:' rather than '>>>' are transformed.\n+    \"\"\"\n+    default_priority = 401\n+\n+    def apply(self, **kwargs):\n+        # type: (Any) -> None\n+        if not self.config.trim_doctest_flags:\n+            return\n+\n+        for node in self.document.traverse(nodes.literal_block):\n+            if self.is_pyconsole(node):\n+                source = node.rawsource\n+                source = doctest.blankline_re.sub('', source)\n+                source = doctest.doctestopt_re.sub('', source)\n+                node.rawsource = source\n+                node[:] = [nodes.Text(source)]\n+\n+    @staticmethod\n+    def is_pyconsole(node):\n+        # type: (nodes.literal_block) -> bool\n+        if node.rawsource != node.astext():\n+            return False  # skip parsed-literal node\n+\n+        language = node.get('language')\n+        if language in ('pycon', 'pycon3'):\n+            return True\n+        elif language in ('py', 'py3', 'python', 'python3', 'default'):\n+            return node.rawsource.startswith('sage:')\n+        elif language == 'guess':\n+            try:\n+                lexer = guess_lexer(node.rawsource)\n+                return isinstance(lexer, PythonConsoleLexer)\n+            except Exception:\n+                pass\n+\n+        return False\n+\n+\n+def setup(app):\n+    app.add_post_transform(TrimDoctestFlagsTransformSage)\n```\n\n\nhttps://salsa.debian.org/science-team/sagemath/blob/master/debian/patches/u1-sphinx-1.8-doctest-transform.patch",
    "created_at": "2019-02-24T14:19:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369130",
    "user": "https://github.com/tobihan"
}
```

Replying to [comment:92 jhpalmieri]:
> Okay, I've fixed the mathjax problem and the `<BLANKLINE>` problem. The second of these involves patching Sphinx, so if you don't want patches, you will get `<BLANKLINE>` in some doctest output, rather than an actual blank line.

Instead of adding this very sage specific patch to sphinx, why not do this in a sphinx extension?

Like this:


```
--- a/src/doc/common/conf.py
+++ b/src/doc/common/conf.py
@@ -13,7 +13,7 @@
 
 # Add any Sphinx extension module names here, as strings. They can be extensions
 # coming with Sphinx (named 'sphinx.ext.*') or your custom ones.
-extensions = ['inventory_builder', 'multidocs',
+extensions = ['inventory_builder', 'multidocs', 'trim_doctest_flags',
               'sage_autodoc',  'sphinx.ext.graphviz',
               'sphinx.ext.inheritance_diagram', 'sphinx.ext.todo',
               'sphinx.ext.extlinks', 'matplotlib.sphinxext.plot_directive']
--- /dev/null
+++ b/src/sage_setup/docbuild/ext/trim_doctest_flags.py
@@ -0,0 +1,67 @@
+"""
+    trim doctest flags
+    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+
+    transforms for code-blocks.
+
+    modified from sphinx.transforms.post_transforms.code
+
+    :copyright: Copyright 2007-2019 by the Sphinx team, see AUTHORS.
+    :license: BSD, see LICENSE for details.
+"""
+
+import sys
+from typing import NamedTuple
+
+from docutils import nodes
+from pygments.lexers import PythonConsoleLexer, guess_lexer
+
+from sphinx import addnodes
+from sphinx.ext import doctest
+from sphinx.transforms import SphinxTransform
+
+class TrimDoctestFlagsTransformSage(SphinxTransform):
+    """
+    Trim doctest flags like ``# doctest: +FLAG`` from sage code-blocks.
+
+    The only difference from Sphinx' TrimDoctestFlagsTransform is that
+    here lines starting with 'sage:' rather than '>>>' are transformed.
+    """
+    default_priority = 401
+
+    def apply(self, **kwargs):
+        # type: (Any) -> None
+        if not self.config.trim_doctest_flags:
+            return
+
+        for node in self.document.traverse(nodes.literal_block):
+            if self.is_pyconsole(node):
+                source = node.rawsource
+                source = doctest.blankline_re.sub('', source)
+                source = doctest.doctestopt_re.sub('', source)
+                node.rawsource = source
+                node[:] = [nodes.Text(source)]
+
+    @staticmethod
+    def is_pyconsole(node):
+        # type: (nodes.literal_block) -> bool
+        if node.rawsource != node.astext():
+            return False  # skip parsed-literal node
+
+        language = node.get('language')
+        if language in ('pycon', 'pycon3'):
+            return True
+        elif language in ('py', 'py3', 'python', 'python3', 'default'):
+            return node.rawsource.startswith('sage:')
+        elif language == 'guess':
+            try:
+                lexer = guess_lexer(node.rawsource)
+                return isinstance(lexer, PythonConsoleLexer)
+            except Exception:
+                pass
+
+        return False
+
+
+def setup(app):
+    app.add_post_transform(TrimDoctestFlagsTransformSage)
```


https://salsa.debian.org/science-team/sagemath/blob/master/debian/patches/u1-sphinx-1.8-doctest-transform.patch



---

archive/issue_comments_369131.json:
```json
{
    "body": "There is a balance to be struck: we're more or less forking Sphinx with extensions like this, so they require maintenance: as Sphinx changes, so should the extension. This recently required a fair amount of work for Sage's autodoc extension (#26949).\n\nSo is it better to patch Sphinx or create an extension?",
    "created_at": "2019-02-24T16:35:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369131",
    "user": "https://github.com/jhpalmieri"
}
```

There is a balance to be struck: we're more or less forking Sphinx with extensions like this, so they require maintenance: as Sphinx changes, so should the extension. This recently required a fair amount of work for Sage's autodoc extension (#26949).

So is it better to patch Sphinx or create an extension?



---

archive/issue_comments_369132.json:
```json
{
    "body": "Any more comments on this? If people who deal with distributions feel that using a Sphinx extension would be better than a patch, then please go ahead and implement that. If people feel that patching is better, then what else needs to be done?",
    "created_at": "2019-03-07T04:15:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369132",
    "user": "https://github.com/jhpalmieri"
}
```

Any more comments on this? If people who deal with distributions feel that using a Sphinx extension would be better than a patch, then please go ahead and implement that. If people feel that patching is better, then what else needs to be done?



---

archive/issue_comments_369133.json:
```json
{
    "body": "Replying to [comment:100 jhpalmieri]:\n> Any more comments on this? If people who deal with distributions feel that using a Sphinx extension would be better than a patch, then please go ahead and implement that. If people feel that patching is better, then what else needs to be done?\n\nI already implemented it and posted the patch here. Is there something wrong with it?",
    "created_at": "2019-03-07T09:32:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369133",
    "user": "https://github.com/tobihan"
}
```

Replying to [comment:100 jhpalmieri]:
> Any more comments on this? If people who deal with distributions feel that using a Sphinx extension would be better than a patch, then please go ahead and implement that. If people feel that patching is better, then what else needs to be done?

I already implemented it and posted the patch here. Is there something wrong with it?



---

archive/issue_comments_369134.json:
```json
{
    "body": "Replying to [comment:101 thansen]:\n> Replying to [comment:100 jhpalmieri]:\n> > Any more comments on this? If people who deal with distributions feel that using a Sphinx extension would be better than a patch, then please go ahead and implement that. If people feel that patching is better, then what else needs to be done?\n> \n> I already implemented it and posted the patch here. Is there something wrong with it?\n\nCare to propose a full branch? (So that it's 100% clear what the solution is)",
    "created_at": "2019-03-07T12:12:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369134",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:101 thansen]:
> Replying to [comment:100 jhpalmieri]:
> > Any more comments on this? If people who deal with distributions feel that using a Sphinx extension would be better than a patch, then please go ahead and implement that. If people feel that patching is better, then what else needs to be done?
> 
> I already implemented it and posted the patch here. Is there something wrong with it?

Care to propose a full branch? (So that it's 100% clear what the solution is)



---

archive/issue_comments_369135.json:
```json
{
    "body": "Replying to [comment:101 thansen]:\n> Replying to [comment:100 jhpalmieri]:\n> > Any more comments on this? If people who deal with distributions feel that using a Sphinx extension would be better than a patch, then please go ahead and implement that. If people feel that patching is better, then what else needs to be done?\n> \n> I already implemented it and posted the patch here. Is there something wrong with it?\n\nNot necessarily, but I did respond and ask a question about the philosophy of patches vs. extensions. I was hoping for a discussion.",
    "created_at": "2019-03-07T16:03:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369135",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:101 thansen]:
> Replying to [comment:100 jhpalmieri]:
> > Any more comments on this? If people who deal with distributions feel that using a Sphinx extension would be better than a patch, then please go ahead and implement that. If people feel that patching is better, then what else needs to be done?
> 
> I already implemented it and posted the patch here. Is there something wrong with it?

Not necessarily, but I did respond and ask a question about the philosophy of patches vs. extensions. I was hoping for a discussion.



---

archive/issue_comments_369136.json:
```json
{
    "body": "From a packagers standpoint the extension is clearly better. Since the sphinx patch does not make much sense for us we would probably have to keep patching in the extension anyway. But I thought that was obvious and you were asking for opinions of sage developers.",
    "created_at": "2019-03-07T16:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369136",
    "user": "https://github.com/tobihan"
}
```

From a packagers standpoint the extension is clearly better. Since the sphinx patch does not make much sense for us we would probably have to keep patching in the extension anyway. But I thought that was obvious and you were asking for opinions of sage developers.



---

archive/issue_comments_369137.json:
```json
{
    "body": "From developers point of view, we appreciate your efforts a lot --- although  we'd much prefer a branch with your solution to a link to Debian patches, from which one sometimes might need to do reverse engineering to get what's needed and works in Sage sans Debian...",
    "created_at": "2019-03-15T16:54:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369137",
    "user": "https://github.com/dimpase"
}
```

From developers point of view, we appreciate your efforts a lot --- although  we'd much prefer a branch with your solution to a link to Debian patches, from which one sometimes might need to do reverse engineering to get what's needed and works in Sage sans Debian...



---

archive/issue_comments_369138.json:
```json
{
    "body": "Replying to [comment:105 dimpase]:\n> From developers point of view, we appreciate your efforts a lot --- although  we'd much prefer a branch with your solution to a link to Debian patches, from which one sometimes might need to do reverse engineering to get what's needed and works in Sage sans Debian...\n\nOk, here is a branch:\nhttps://git.sagemath.org/sage.git/log/?h=u/thansen/26451",
    "created_at": "2019-03-17T13:19:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369138",
    "user": "https://github.com/tobihan"
}
```

Replying to [comment:105 dimpase]:
> From developers point of view, we appreciate your efforts a lot --- although  we'd much prefer a branch with your solution to a link to Debian patches, from which one sometimes might need to do reverse engineering to get what's needed and works in Sage sans Debian...

Ok, here is a branch:
https://git.sagemath.org/sage.git/log/?h=u/thansen/26451



---

archive/issue_comments_369139.json:
```json
{
    "body": "Replying to [comment:106 thansen]:\n> Replying to [comment:105 dimpase]:\n> > From developers point of view, we appreciate your efforts a lot --- although  we'd much prefer a branch with your solution to a link to Debian patches, from which one sometimes might need to do reverse engineering to get what's needed and works in Sage sans Debian...\n> \n> Ok, here is a branch:\n> https://git.sagemath.org/sage.git/log/?h=u/thansen/26451\n\nClarification. I am assuming this needs to be applied on top of the current branch already in this ticket. Right?",
    "created_at": "2019-03-17T21:42:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369139",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:106 thansen]:
> Replying to [comment:105 dimpase]:
> > From developers point of view, we appreciate your efforts a lot --- although  we'd much prefer a branch with your solution to a link to Debian patches, from which one sometimes might need to do reverse engineering to get what's needed and works in Sage sans Debian...
> 
> Ok, here is a branch:
> https://git.sagemath.org/sage.git/log/?h=u/thansen/26451

Clarification. I am assuming this needs to be applied on top of the current branch already in this ticket. Right?



---

archive/issue_comments_369140.json:
```json
{
    "body": "Replying to [comment:107 fbissey]:\n> Replying to [comment:106 thansen]:\n> > Replying to [comment:105 dimpase]:\n> > > From developers point of view, we appreciate your efforts a lot --- although  we'd much prefer a branch with your solution to a link to Debian patches, from which one sometimes might need to do reverse engineering to get what's needed and works in Sage sans Debian...\n> > \n> > Ok, here is a branch:\n> > https://git.sagemath.org/sage.git/log/?h=u/thansen/26451\n> \n> Clarification. I am assuming this needs to be applied on top of the current branch already in this ticket. Right?\n\nNo, this is just the branch of this ticket with John's fix for the <BLANKLINE> issue removed and my patch applied.",
    "created_at": "2019-03-17T23:38:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369140",
    "user": "https://github.com/tobihan"
}
```

Replying to [comment:107 fbissey]:
> Replying to [comment:106 thansen]:
> > Replying to [comment:105 dimpase]:
> > > From developers point of view, we appreciate your efforts a lot --- although  we'd much prefer a branch with your solution to a link to Debian patches, from which one sometimes might need to do reverse engineering to get what's needed and works in Sage sans Debian...
> > 
> > Ok, here is a branch:
> > https://git.sagemath.org/sage.git/log/?h=u/thansen/26451
> 
> Clarification. I am assuming this needs to be applied on top of the current branch already in this ticket. Right?

No, this is just the branch of this ticket with John's fix for the <BLANKLINE> issue removed and my patch applied.



---

archive/issue_comments_369141.json:
```json
{
    "body": "So, building reference manual, mathjax works on u/thansen/26451",
    "created_at": "2019-03-17T23:46:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369141",
    "user": "https://github.com/dimpase"
}
```

So, building reference manual, mathjax works on u/thansen/26451



---

archive/issue_comments_369142.json:
```json
{
    "body": "Replying to [comment:109 dimpase]:\n> So, building reference manual, mathjax works on u/thansen/26451\n\nThe thing I changed has nothing to do with mathjax, it's a different fix for the <BLANKLINE> issue.",
    "created_at": "2019-03-17T23:48:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369142",
    "user": "https://github.com/tobihan"
}
```

Replying to [comment:109 dimpase]:
> So, building reference manual, mathjax works on u/thansen/26451

The thing I changed has nothing to do with mathjax, it's a different fix for the <BLANKLINE> issue.



---

archive/issue_comments_369143.json:
```json
{
    "body": "Replying to [comment:110 thansen]:\n> Replying to [comment:109 dimpase]:\n> > So, building reference manual, mathjax works on u/thansen/26451\n> \n> The thing I changed has nothing to do with mathjax, it's a different fix for the <BLANKLINE> issue.\n\nSorry, I got lost here. Is `u/thansen/26451` a complete branch? If so, please put it into the Branch field of the ticket, and add your name to the list of authors.",
    "created_at": "2019-03-18T09:30:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369143",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:110 thansen]:
> Replying to [comment:109 dimpase]:
> > So, building reference manual, mathjax works on u/thansen/26451
> 
> The thing I changed has nothing to do with mathjax, it's a different fix for the <BLANKLINE> issue.

Sorry, I got lost here. Is `u/thansen/26451` a complete branch? If so, please put it into the Branch field of the ticket, and add your name to the list of authors.



---

archive/issue_comments_369144.json:
```json
{
    "body": "Replying to [comment:111 dimpase]:\n> Replying to [comment:110 thansen]:\n> > Replying to [comment:109 dimpase]:\n> > > So, building reference manual, mathjax works on u/thansen/26451\n> > \n> > The thing I changed has nothing to do with mathjax, it's a different fix for the <BLANKLINE> issue.\n> \n> Sorry, I got lost here. Is `u/thansen/26451` a complete branch? If so, please put it into the Branch field of the ticket, and add your name to the list of authors.\n\nThat's why I asked the question earlier. I was going to do just that on thansen's behalf, but when I clicked on the link I could only see one commit. Now that may just have been the way I navigated there, that's why I asked.",
    "created_at": "2019-03-18T09:34:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369144",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:111 dimpase]:
> Replying to [comment:110 thansen]:
> > Replying to [comment:109 dimpase]:
> > > So, building reference manual, mathjax works on u/thansen/26451
> > 
> > The thing I changed has nothing to do with mathjax, it's a different fix for the <BLANKLINE> issue.
> 
> Sorry, I got lost here. Is `u/thansen/26451` a complete branch? If so, please put it into the Branch field of the ticket, and add your name to the list of authors.

That's why I asked the question earlier. I was going to do just that on thansen's behalf, but when I clicked on the link I could only see one commit. Now that may just have been the way I navigated there, that's why I asked.



---

archive/issue_comments_369145.json:
```json
{
    "body": "Replying to [comment:111 dimpase]:\n> Replying to [comment:110 thansen]:\n> > Replying to [comment:109 dimpase]:\n> > > So, building reference manual, mathjax works on u/thansen/26451\n> > \n> > The thing I changed has nothing to do with mathjax, it's a different fix for the <BLANKLINE> issue.\n> \n> Sorry, I got lost here. Is `u/thansen/26451` a complete branch? If so, please put it into the Branch field of the ticket, and add your name to the list of authors.\n\nYes, it's a complete branch. I didn't put it in the branch field of the ticket because this is John's ticket and he never said we should use my fix instead of his.",
    "created_at": "2019-03-18T10:02:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369145",
    "user": "https://github.com/tobihan"
}
```

Replying to [comment:111 dimpase]:
> Replying to [comment:110 thansen]:
> > Replying to [comment:109 dimpase]:
> > > So, building reference manual, mathjax works on u/thansen/26451
> > 
> > The thing I changed has nothing to do with mathjax, it's a different fix for the <BLANKLINE> issue.
> 
> Sorry, I got lost here. Is `u/thansen/26451` a complete branch? If so, please put it into the Branch field of the ticket, and add your name to the list of authors.

Yes, it's a complete branch. I didn't put it in the branch field of the ticket because this is John's ticket and he never said we should use my fix instead of his.



---

archive/issue_comments_369146.json:
```json
{
    "body": "IMHO John won't mind---in fact he appears to have said OK to this on comment:101. (John, please shout if I am wrong).\n----\nNew commits:",
    "created_at": "2019-03-18T10:33:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369146",
    "user": "https://github.com/dimpase"
}
```

IMHO John won't mind---in fact he appears to have said OK to this on comment:101. (John, please shout if I am wrong).
----
New commits:



---

archive/issue_comments_369147.json:
```json
{
    "body": "Here is a different approach for the `<BLANKLINE>` problem, as suggested [on Sphinx's github page](https://github.com/sphinx-doc/sphinx/issues/6188). I've added a dependency, #27528, which also removes `highlighting.patch`. It is necessary here because it suppresses some warnings which are produced by `SageMathTransform`.\n\nIf this is acceptable, we should probably squash some commits: we don't need to create `trim_doctest_flags.py` and then delete it.\n----\nNew commits:",
    "created_at": "2019-03-22T03:12:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369147",
    "user": "https://github.com/jhpalmieri"
}
```

Here is a different approach for the `<BLANKLINE>` problem, as suggested [on Sphinx's github page](https://github.com/sphinx-doc/sphinx/issues/6188). I've added a dependency, #27528, which also removes `highlighting.patch`. It is necessary here because it suppresses some warnings which are produced by `SageMathTransform`.

If this is acceptable, we should probably squash some commits: we don't need to create `trim_doctest_flags.py` and then delete it.
----
New commits:



---

archive/issue_comments_369148.json:
```json
{
    "body": "With this branch on top of 8.7 and sphinx 1.8.5 I'm getting:\n\n\n```\nProcess Process-79:\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 267, in _bootstrap\n    self.run()\n  File \"/usr/lib/python2.7/multiprocessing/process.py\", line 114, in run\n    self._target(*self._args, **self._kwargs)\n  File \"/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py\", line 79, in build_ref_doc\n    getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)\n  File \"/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py\", line 763, in _wrapper\n    getattr(DocBuilder, build_type)(self, *args, **kwds)\n  File \"/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py\", line 135, in f\n    runsphinx()\n  File \"/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/sphinxbuild.py\", line 314, in runsphinx\n    sys.stderr.raise_errors()\n  File \"/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/sphinxbuild.py\", line 249, in raise_errors\n    raise OSError(self._error)\nOSError: /build/sagemath-doc/src/sage-8.7/src/doc/en/reference/combinat/sage/combinat/shifted_primed_tableau.rst:267: WARNING: Could not lex literal_block as \"pycon\". Highlighting skipped.\nError building the documentation.\nTraceback (most recent call last):\n  File \"/usr/lib/python2.7/runpy.py\", line 174, in _run_module_as_main\n    \"__main__\", fname, loader, pkg_name)\n  File \"/usr/lib/python2.7/runpy.py\", line 72, in _run_code\n    exec code in run_globals\n  File \"/build/sagemath-doc/src/sage-8.7/src/sage_setup/docbuild/__main__.py\", line 2, in <module>\n    main()\n  File \"/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py\", line 1732, in main\n    builder()\n  File \"/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py\", line 358, in _wrapper\n    getattr(get_builder(document), name)(*args, **kwds)\n  File \"/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py\", line 549, in _wrapper\n    build_many(build_ref_doc, L)\n  File \"/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/utils.py\", line 214, in _build_many\n    raise worker_exc\nWorkerDiedException: worker for ('reference/combinat', 'en', 'html', {}) died with non-zero exit code 1\n\n    Note: incremental documentation builds sometimes cause spurious\n    error messages. To be certain that these are real errors, run\n    \"make doc-clean\" first and try again.\n```\n",
    "created_at": "2019-03-24T12:32:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369148",
    "user": "https://github.com/antonio-rojas"
}
```

With this branch on top of 8.7 and sphinx 1.8.5 I'm getting:


```
Process Process-79:
Traceback (most recent call last):
  File "/usr/lib/python2.7/multiprocessing/process.py", line 267, in _bootstrap
    self.run()
  File "/usr/lib/python2.7/multiprocessing/process.py", line 114, in run
    self._target(*self._args, **self._kwargs)
  File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 79, in build_ref_doc
    getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)
  File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 763, in _wrapper
    getattr(DocBuilder, build_type)(self, *args, **kwds)
  File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 135, in f
    runsphinx()
  File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/sphinxbuild.py", line 314, in runsphinx
    sys.stderr.raise_errors()
  File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/sphinxbuild.py", line 249, in raise_errors
    raise OSError(self._error)
OSError: /build/sagemath-doc/src/sage-8.7/src/doc/en/reference/combinat/sage/combinat/shifted_primed_tableau.rst:267: WARNING: Could not lex literal_block as "pycon". Highlighting skipped.
Error building the documentation.
Traceback (most recent call last):
  File "/usr/lib/python2.7/runpy.py", line 174, in _run_module_as_main
    "__main__", fname, loader, pkg_name)
  File "/usr/lib/python2.7/runpy.py", line 72, in _run_code
    exec code in run_globals
  File "/build/sagemath-doc/src/sage-8.7/src/sage_setup/docbuild/__main__.py", line 2, in <module>
    main()
  File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 1732, in main
    builder()
  File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 358, in _wrapper
    getattr(get_builder(document), name)(*args, **kwds)
  File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 549, in _wrapper
    build_many(build_ref_doc, L)
  File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/utils.py", line 214, in _build_many
    raise worker_exc
WorkerDiedException: worker for ('reference/combinat', 'en', 'html', {}) died with non-zero exit code 1

    Note: incremental documentation builds sometimes cause spurious
    error messages. To be certain that these are real errors, run
    "make doc-clean" first and try again.
```




---

archive/issue_comments_369149.json:
```json
{
    "body": "Sphinx 1.8.5 was released on PyPI on 2019-03-10, and Sphinx 2.0.0b2 on 2019-03-20. See\n\n- https://pypi.org/project/Sphinx/#history",
    "created_at": "2019-03-24T14:13:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369149",
    "user": "https://github.com/slel"
}
```

Sphinx 1.8.5 was released on PyPI on 2019-03-10, and Sphinx 2.0.0b2 on 2019-03-20. See

- https://pypi.org/project/Sphinx/#history



---

archive/issue_comments_369150.json:
```json
{
    "body": "I believe that Sphinx 2.0.0b2 is dropping support for Python 2.7, so we can't use that. I'll look at 1.8.5.",
    "created_at": "2019-03-24T18:23:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369150",
    "user": "https://github.com/jhpalmieri"
}
```

I believe that Sphinx 2.0.0b2 is dropping support for Python 2.7, so we can't use that. I'll look at 1.8.5.



---

archive/issue_comments_369151.json:
```json
{
    "body": "Replying to [comment:117 arojas]:\n> With this branch on top of 8.7 and sphinx 1.8.5 I'm getting:\n> \n> {{{\n> Process Process-79:\n> Traceback (most recent call last):\n>   File \"/usr/lib/python2.7/multiprocessing/process.py\", line 267, in _bootstrap\n>     self.run()\n>   File \"/usr/lib/python2.7/multiprocessing/process.py\", line 114, in run\n>     self._target(*self._args, **self._kwargs)\n>   File \"/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py\", line 79, in build_ref_doc\n>     getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)\n>   File \"/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py\", line 763, in _wrapper\n>     getattr(DocBuilder, build_type)(self, *args, **kwds)\n>   File \"/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py\", line 135, in f\n>     runsphinx()\n>   File \"/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/sphinxbuild.py\", line 314, in runsphinx\n>     sys.stderr.raise_errors()\n>   File \"/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/sphinxbuild.py\", line 249, in raise_errors\n>     raise OSError(self._error)\n> OSError: /build/sagemath-doc/src/sage-8.7/src/doc/en/reference/combinat/sage/combinat/shifted_primed_tableau.rst:267: WARNING: Could not lex literal_block as \"pycon\". Highlighting skipped.\n> Error building the documentation.\n> Traceback (most recent call last):\n>   File \"/usr/lib/python2.7/runpy.py\", line 174, in _run_module_as_main\n>     \"__main__\", fname, loader, pkg_name)\n>   File \"/usr/lib/python2.7/runpy.py\", line 72, in _run_code\n>     exec code in run_globals\n>   File \"/build/sagemath-doc/src/sage-8.7/src/sage_setup/docbuild/__main__.py\", line 2, in <module>\n>     main()\n>   File \"/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py\", line 1732, in main\n>     builder()\n>   File \"/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py\", line 358, in _wrapper\n>     getattr(get_builder(document), name)(*args, **kwds)\n>   File \"/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py\", line 549, in _wrapper\n>     build_many(build_ref_doc, L)\n>   File \"/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/utils.py\", line 214, in _build_many\n>     raise worker_exc\n> WorkerDiedException: worker for ('reference/combinat', 'en', 'html', {}) died with non-zero exit code 1\n> \n>     Note: incremental documentation builds sometimes cause spurious\n>     error messages. To be certain that these are real errors, run\n>     \"make doc-clean\" first and try again.\n> }}}\n\nDid you also use the branch from #27528? That would get rid of the warning which is causing the problems. This is somewhat moot, since I am reworking #27528. I should be able to post something later today.",
    "created_at": "2019-03-24T18:24:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369151",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:117 arojas]:
> With this branch on top of 8.7 and sphinx 1.8.5 I'm getting:
> 
> {{{
> Process Process-79:
> Traceback (most recent call last):
>   File "/usr/lib/python2.7/multiprocessing/process.py", line 267, in _bootstrap
>     self.run()
>   File "/usr/lib/python2.7/multiprocessing/process.py", line 114, in run
>     self._target(*self._args, **self._kwargs)
>   File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 79, in build_ref_doc
>     getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)
>   File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 763, in _wrapper
>     getattr(DocBuilder, build_type)(self, *args, **kwds)
>   File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 135, in f
>     runsphinx()
>   File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/sphinxbuild.py", line 314, in runsphinx
>     sys.stderr.raise_errors()
>   File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/sphinxbuild.py", line 249, in raise_errors
>     raise OSError(self._error)
> OSError: /build/sagemath-doc/src/sage-8.7/src/doc/en/reference/combinat/sage/combinat/shifted_primed_tableau.rst:267: WARNING: Could not lex literal_block as "pycon". Highlighting skipped.
> Error building the documentation.
> Traceback (most recent call last):
>   File "/usr/lib/python2.7/runpy.py", line 174, in _run_module_as_main
>     "__main__", fname, loader, pkg_name)
>   File "/usr/lib/python2.7/runpy.py", line 72, in _run_code
>     exec code in run_globals
>   File "/build/sagemath-doc/src/sage-8.7/src/sage_setup/docbuild/__main__.py", line 2, in <module>
>     main()
>   File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 1732, in main
>     builder()
>   File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 358, in _wrapper
>     getattr(get_builder(document), name)(*args, **kwds)
>   File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 549, in _wrapper
>     build_many(build_ref_doc, L)
>   File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/utils.py", line 214, in _build_many
>     raise worker_exc
> WorkerDiedException: worker for ('reference/combinat', 'en', 'html', {}) died with non-zero exit code 1
> 
>     Note: incremental documentation builds sometimes cause spurious
>     error messages. To be certain that these are real errors, run
>     "make doc-clean" first and try again.
> }}}

Did you also use the branch from #27528? That would get rid of the warning which is causing the problems. This is somewhat moot, since I am reworking #27528. I should be able to post something later today.



---

archive/issue_comments_369152.json:
```json
{
    "body": "Replying to [comment:120 jhpalmieri]:\n> \n> Did you also use the branch from #27528? That would get rid of the warning which is causing the problems. This is somewhat moot, since I am reworking #27528. I should be able to post something later today.\n\nAh, no. I was under the (wrong) impression that branches in trac tickets already pulled the changes from dependant tickets.",
    "created_at": "2019-03-24T18:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369152",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:120 jhpalmieri]:
> 
> Did you also use the branch from #27528? That would get rid of the warning which is causing the problems. This is somewhat moot, since I am reworking #27528. I should be able to post something later today.

Ah, no. I was under the (wrong) impression that branches in trac tickets already pulled the changes from dependant tickets.



---

archive/issue_comments_369153.json:
```json
{
    "body": "Replying to [comment:121 arojas]:\n> Replying to [comment:120 jhpalmieri]:\n> > \n> > Did you also use the branch from #27528? That would get rid of the warning which is causing the problems. This is somewhat moot, since I am reworking #27528. I should be able to post something later today.\n> \n> Ah, no. I was under the (wrong) impression that branches in trac tickets already pulled the changes from dependant tickets.\n\nSometimes they do and sometimes they don't. I don't know what I am supposed to do when preparing branches: base this one on the one from #27528 or on `develop`?",
    "created_at": "2019-03-24T18:37:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369153",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:121 arojas]:
> Replying to [comment:120 jhpalmieri]:
> > 
> > Did you also use the branch from #27528? That would get rid of the warning which is causing the problems. This is somewhat moot, since I am reworking #27528. I should be able to post something later today.
> 
> Ah, no. I was under the (wrong) impression that branches in trac tickets already pulled the changes from dependant tickets.

Sometimes they do and sometimes they don't. I don't know what I am supposed to do when preparing branches: base this one on the one from #27528 or on `develop`?



---

archive/issue_comments_369154.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-03-24T23:09:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369154",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_369155.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-03-24T23:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369155",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_369156.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-03-24T23:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369156",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_369157.json:
```json
{
    "body": "Here is a new branch which is based on #27528. I put the `<BLANKLINE>` stuff at #27528, not here, since I needed it there.",
    "created_at": "2019-03-24T23:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369157",
    "user": "https://github.com/jhpalmieri"
}
```

Here is a new branch which is based on #27528. I put the `<BLANKLINE>` stuff at #27528, not here, since I needed it there.



---

archive/issue_comments_369158.json:
```json
{
    "body": "Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369158",
    "user": "https://github.com/embray"
}
```

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_comments_369159.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-25T18:14:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369159",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_369160.json:
```json
{
    "body": "PDF documentation builds fine for me.",
    "created_at": "2019-03-25T22:19:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369160",
    "user": "https://github.com/jhpalmieri"
}
```

PDF documentation builds fine for me.



---

archive/issue_comments_369161.json:
```json
{
    "body": "looks good to me.",
    "created_at": "2019-03-26T00:13:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369161",
    "user": "https://github.com/dimpase"
}
```

looks good to me.



---

archive/issue_comments_369162.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-26T00:13:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369162",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_369163.json:
```json
{
    "body": "Great! Now we need to silence all of the stupid deprecation warnings.",
    "created_at": "2019-03-26T04:21:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369163",
    "user": "https://github.com/jhpalmieri"
}
```

Great! Now we need to silence all of the stupid deprecation warnings.



---

archive/issue_comments_369164.json:
```json
{
    "body": "See #27578 for a ticket to stop using the deprecated `formatargspec`.",
    "created_at": "2019-03-30T22:29:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369164",
    "user": "https://github.com/jhpalmieri"
}
```

See #27578 for a ticket to stop using the deprecated `formatargspec`.



---

archive/issue_comments_369165.json:
```json
{
    "body": "Merge conflict",
    "created_at": "2019-03-30T22:37:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369165",
    "user": "https://github.com/vbraun"
}
```

Merge conflict



---

archive/issue_comments_369166.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-03-30T22:37:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369166",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_369167.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-03-31T01:52:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369167",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_369168.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2019-03-31T01:52:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369168",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_369169.json:
```json
{
    "body": "Rebased.",
    "created_at": "2019-03-31T01:52:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369169",
    "user": "https://github.com/jhpalmieri"
}
```

Rebased.



---

archive/issue_comments_369170.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-04-02T21:30:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26214",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26214#issuecomment-369170",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
