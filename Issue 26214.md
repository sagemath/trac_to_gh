# Issue 26214: Prepare for sphinx 1.8

Issue created by migration from https://trac.sagemath.org/ticket/26451

Original creator: saraedum

Original creation time: 2018-10-10 07:53:52

CC:  @timokau fbissey arojas embray slelievre jhpalmieri dimpase thansen

With sphinx 1.8.1 we see quite a few


```
ApplicationError: Source directory and destination directory cannot be identical
```


coming out of Sphinx as they have chahnged the argument checking of the `Sphinx` constructor it seems.

It would be nice to be more friendly to downstream by making Sage work better with Sphinx 1.8 already.


---

Comment by saraedum created at 2018-10-10 07:55:30

Note that there is nothing I can doctest here.


---

Comment by saraedum created at 2018-10-10 07:57:31

Changing status from new to needs_review.


---

Comment by saraedum created at 2018-10-10 07:57:31

New commits:


---

Comment by saraedum created at 2018-10-10 07:58:49

Changing keywords from "" to "sphinx, conda".


---

Comment by jdemeyer created at 2018-10-10 08:14:12

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2018-10-10 08:14:12

I'd rather upgrade Sphinx while we're at it. That's a good thing to do and I would need to do that anyway to test this ticket.


---

Comment by saraedum created at 2018-10-10 08:27:25

I was fearing that you would propose that ;)

I am not planning on working on upgrading Sphinx in Sage (as I've got too many other things to worry about.) I don't know what has chahnged in 1.8.1 and whether we would want to upgrade at all.

More generally, I don't know what we're aiming for here. I feel we don't have enough people to keep Sage-the-distribution close to upstream most of the time so that's probably not what we should be aiming for?

That said, feel free to upgrade Sphinx :) But if anybody likes these small changes and we want to move the Sphinx upgrade into a separate ticket, I would prefer that.


---

Comment by arojas created at 2018-10-10 08:30:38

Upgrading sphinx requires further changes to make docs build. I have a minimal patch at https://git.archlinux.org/svntogit/community.git/tree/trunk/sagemath-doc-sphinx-1.8.patch?h=packages/sagemath-doc
to make it build, although with it one still gets lots of deprecation warnings due to changes in logging functions.


---

Comment by jdemeyer created at 2018-10-10 08:34:04

Antonio, does Sphinx 1.8.1 work with just those changes (even if there are deprecation warnings)? If so, we might as well upgrade.


---

Comment by arojas created at 2018-10-10 08:35:36

Replying to [comment:11 jdemeyer]:
> Antonio, does Sphinx 1.8.1 work with just those changes (even if there are deprecation warnings)? If so, we might as well upgrade.

Yes, with Julian's patch and mine introspection works and docs build correctly.


---

Comment by jdemeyer created at 2018-10-10 08:36:35

Changing component from documentation to packages: standard.


---

Comment by saraedum created at 2018-10-10 10:12:29

jdemeyer, did you forget to push your branch? (you added yourself as an Author but did not push any changes it seems.)


---

Comment by jdemeyer created at 2018-10-10 10:15:02

Please give me time...


---

Comment by saraedum created at 2018-10-10 10:20:57

Note that there is a licensing issue in sphinxify.py, see #26453.


---

Comment by git created at 2018-10-10 10:41:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-10-10 10:42:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2018-10-12 17:53:08

New commits:


---

Comment by jhpalmieri created at 2018-10-12 18:32:32

By the way, see also #26449 for issues with Sphinx and the Python 3 build of Sage.


---

Comment by @timokau created at 2018-10-22 21:13:56

I just did the upgrade on nix and I also needed to apply the same patch to sagenb's `sphinxify.py` (https://github.com/sagemath/sagenb/pull/461).


---

Comment by fbissey created at 2018-10-22 21:19:56

Replying to [comment:22 gh-timokau]:
> I just did the upgrade on nix and I also needed to apply the same patch to sagenb's `sphinxify.py` (https://github.com/sagemath/sagenb/pull/461).

Once upon a time `sphinxify` was a part of sagenb and it was used in sage itself. So time ago we put an end to that. May be it is time to go in reverse and have (the now deprecated) sagenb use sage's sphinxify.


---

Comment by jhpalmieri created at 2018-10-23 19:00:09

The documentation does not build for me on OS X: I get

```
[reference]     valuations: 1 todos, 14 index, 1409 citations, 13 modules
[reference] ... done (472 todos, 2068 index, 1409 citations, 2019 modules)
[reference] preparing documents... skipping loading of indexes... done
[reference] Merging js index files...
[reference]     algebras: 3466 js index entries
[reference]     arithgroup: 966 js index entries

   ...

[reference]     structure: 1995 js index entries
[reference]     tensor_free_modules: 1035 js index entries
[reference]     valuations: 817 js index entries
[reference] ... done (44888 js index entries)
[reference] WARNING: cannot copy static file IOError(20, 'Not a directory')
[reference] copying static files... copying extra files... done
[reference] The HTML pages are in local/share/doc/sage/html/en/reference.
Error building the documentation.
Traceback (most recent call last):
  File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/runpy.py", line 174, in _run_module_as_main
    "__main__", fname, loader, pkg_name)
  File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/runpy.py", line 72, in _run_code
    exec code in run_globals
  File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
    main()
  File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 1715, in main
    builder()
  File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 338, in _wrapper
    getattr(get_builder(document), name)(*args, **kwds)
  File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 536, in _wrapper
    getattr(DocBuilder(self.name, lang), format)(*args, **kwds)
  File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/__init__.py", line 130, in f
    runsphinx()
  File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/sphinxbuild.py", line 319, in runsphinx
    sys.stderr.raise_errors()
  File "/Users/jpalmier/Desktop/Sage/git/sage/local/lib/python2.7/site-packages/sage_setup/docbuild/sphinxbuild.py", line 254, in raise_errors
    raise OSError(self._error)
OSError: WARNING: cannot copy static file IOError(20, 'Not a directory')
```

Indeed, `local/share/doc/sage/html/en/reference/_static` is a file, not a directory: it is the file `graphviz.css` from Sphinx. If I delete it, create a directory `_static`, and run `make` again, then only `graphviz.css` is copied to the directory, so the reference manual is missing all of its css files. The other parts of the documentation look good.


---

Comment by jhpalmieri created at 2018-10-23 21:04:18

There is some odd behavior with `graphviz.css`. First, it gets copied to `local/share/doc/sage/inventory/en/reference/_static` (a file, not a directory): Sphinx shouldn't copy any css files in the inventory build. Then it also gets copied to a similar location in the html build. I commented out `'sphinx.ext.graphviz'` in the list of extensions in `src/doc/common/conf.py` and started over, but the same thing happened. So something strange is going on with graphviz and our custom builder for the reference manual. In contrast, `./sage --docbuild tutorial html` works fine.


---

Comment by jdemeyer created at 2018-10-24 05:54:12

See https://github.com/sphinx-doc/sphinx/pull/5549


---

Comment by jhpalmieri created at 2018-10-24 18:34:47

Replying to [comment:27 jdemeyer]:
> See https://github.com/sphinx-doc/sphinx/pull/5549

That's very helpful, thank you, but it leads to my next problem: with that fix applied, `graphviz.css` is still copied to `local/share/doc/sage/inventory/en/reference/_static/`, and there is no reason to copy css files to the inventory build. As a consequence, I see this error:

```
Building reference manual, second pass.

[arithgrou] WARNING: failed to reach any of the inventories with the following issues:
[arithgrou] WARNING: intersphinx inventory '/Users/jpalmier/Desktop/Sage/git/sage/local/share/doc/sage/inventory/en/reference/_static/objects.inv' not fetchable due to <type 'exceptions.IOError'>: [Errno 2] No such file or directory: '/Users/jpalmier/Desktop/Sage/git/sage/local/share/doc/sage/inventory/en/reference/_static/objects.inv'
```

I think intersphinx looks in every subdirectory of `inventory/en/reference/`, including `_static`, which should not be there.


---

Comment by jhpalmieri created at 2018-10-24 20:22:36

And once I clean that up, I still see a _file_ `_static` in the html reference build.


---

Comment by jhpalmieri created at 2018-10-24 23:25:25

I wonder if the problem is that it tries to copy `graphviz.css` to, for example, `html/en/reference/algebras/_static`, which is a symlink pointing to the as yet non-existent `html/en/reference/_static`.


---

Comment by jhpalmieri created at 2018-10-25 19:23:16

Here is a new branch. I'm not happy about the changes to `src/sage_setup/docbuild/__init__.py`, but I couldn't get the reference manual to build otherwise. Maybe there is another Sphinx bug, or maybe it's something about our multidoc extension. I would be happy if someone found a cleaner fix.

(This requires Jeroen's Sphinx fix from https://github.com/sphinx-doc/sphinx/pull/5549, by the way. I did not add that as a patch to Sphinx, although maybe we will need to if Sphinx doesn't fix it themselves.)
----
New commits:


---

Comment by git created at 2018-10-26 21:49:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2018-10-26 21:50:58

With this (plus Jeroen's Sphinx fix, plus #26558 if your version of TeXLive is recent), the html and pdf docs build for me.


---

Comment by slelievre created at 2018-11-18 22:52:45

The following tickets mentioned in the discussion above are now fixed and closed,

- #26449 Sphinx and the Python 3 build of Sage
- #26453 Relicense sphinxify.py
- #26558 doc-pdf fails due to conflict with new babel.sty

The following pull request to Sphinx was merged on 2018-10-28,

- [Sphinx issue 5549: Correctly deal with non-existing static dir in graphviz extension](https://github.com/sphinx-doc/sphinx/pull/5549)

and finally

- Sphinx 1.8.2 was uploaded to PyPI on 2018-11-11.

Is this comment from the ticket description still a problem with Sphinx 1.8.2?

> With Sphinx 1.8.1 we see quite a few
> {{{
> ApplicationError: Source directory and destination directory cannot be identical
> }}}
> coming out of Sphinx in conda as they have changed the argument checking of the `Sphinx()` constructor it seems.


---

Comment by slelievre created at 2019-01-13 18:52:26

Sphinx 1.8.3 was released on 2018-12-25.

Tarball: https://files.pythonhosted.org/packages/4d/ed/4595274b5c9ce53a768cc0804ef65fd6282c956b93919a969e98d53894e4/Sphinx-1.8.3.tar.gz


---

Comment by arojas created at 2019-01-17 07:01:08

Unfortunately the patch no longer works with 1.8.3. I'm getting this error on the second pass:

```
[manifolds] building [html]: targets for 60 source files that are out of date
[manifolds] updating environment: 60 added, 0 changed, 0 removed
[manifolds]   app.builder.info(bold('loading cross citations... '), nonl=1)
[manifolds]   app.builder.info("done (%s citations)."%len(cache))
[manifolds]   app.builder.info(bold('linking _static directory.'))
[manifolds] The HTML pages are in doc/html/en/reference/manifolds.
[manifolds] Exception occurred:
[manifolds]   File "/usr/lib/python2.7/os.py", line 157, in makedirs
[manifolds]     mkdir(name, mode)
[manifolds] OSError: [Errno 17] File exists: '/build/sagemath-doc/src/sage-8.6/src/doc/html/en/reference/manifolds/_static'
[manifolds] The full traceback has been saved in /tmp/sphinx-err-EkdWJl.log, if you want to report the issue to the developers.
[manifolds] Please also report this if it was a user error, so that a better error message can be provided next time.
[manifolds] A bug report can be filed in the tracker at <https://github.com/sphinx-doc/sphinx/issues>. Thanks!
Error building the documentation.
Traceback (most recent call last):
  File "/usr/lib/python2.7/runpy.py", line 174, in _run_module_as_main
    "__main__", fname, loader, pkg_name)
  File "/usr/lib/python2.7/runpy.py", line 72, in _run_code
    exec code in run_globals
  File "/build/sagemath-doc/src/sage-8.6/src/sage_setup/docbuild/__main__.py", line 2, in <module>
    main()
  File "/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/__init__.py", line 1744, in main
    builder()
  File "/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/__init__.py", line 356, in _wrapper
    getattr(get_builder(document), name)(*args, **kwds)
  File "/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/__init__.py", line 547, in _wrapper
    build_many(build_ref_doc, L)
  File "/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/__init__.py", line 290, in build_many
    results.append(target(arg))
  File "/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/__init__.py", line 74, in build_ref_doc
    getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)
  File "/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/__init__.py", line 772, in _wrapper
    getattr(DocBuilder, build_type)(self, *args, **kwds)
  File "/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/__init__.py", line 130, in f
    runsphinx()
  File "/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/sphinxbuild.py", line 319, in runsphinx
    sys.stderr.raise_errors()
  File "/build/sagemath-doc/src/sage-8.6/local-python/sage_setup/docbuild/sphinxbuild.py", line 254, in raise_errors
    raise OSError(self._error)
OSError: Exception occurred:

    Note: incremental documentation builds sometimes cause spurious
    error messages. To be certain that these are real errors, run
    "make doc-clean" first and try again.
```



---

Comment by arojas created at 2019-01-17 19:09:57

The problem is that /build/sagemath-doc/src/sage-8.6/src/doc/html/en/reference/manifolds/_static is a symlink to a non-existant ../_static, which makes sphinx raise an error after [this commit](https://github.com/sphinx-doc/sphinx/commit/a7d950ad580eb1feab5094b59857c2eebb8a8976)


---

Comment by jhpalmieri created at 2019-01-18 00:01:44

I don't understand what Sphinx is doing. I don't know if I will have time to work on this soon, but a starting point is to get rid of [my proposed _static commit](https://git.sagemath.org/sage.git/commit/?h=65ab61522cacad7558350f3cb1f0b16d0001235e&id=4a91a6005a550f99bd927b447d36cf7adc4e0f2c). The other commits (or variations on them – in particular `environment.patch` needs to be modified) are I think needed.

Here is my first question: why does the inventory builder create `_static` directories? Those directories should not be there in the first place. They only contain `graphviz.css`, which makes me think it's a bug in Sphinx's graphviz extension. A Sage-specific patch for Sphinx that might help:

```diff
diff --git a/sphinx/ext/graphviz.py~ b/sphinx/ext/graphviz.py
index c9b1541..6fffcd6 100644
--- a/sphinx/ext/graphviz.py
+++ b/sphinx/ext/graphviz.py
@@ -410,7 +410,7 @@ def man_visit_graphviz(self, node):
 
 def on_build_finished(app, exc):
     # type: (Sphinx, Exception) -> None
-    if exc is None:
+    if exc is None and not app.config.multidoc_first_pass:
         src = path.join(sphinx.package_dir, 'templates', 'graphviz', 'graphviz.css')
         dst = path.join(app.outdir, '_static')
         copy_asset(src, dst)
```



---

Comment by jhpalmieri created at 2019-01-18 00:26:03

That patch doesn't quite work: there is still a `_static` directory in `local/share/doc/sage/inventory/en/reference/`, although it prevents them from being created in all of the subdirectories. Something stupid like `not 'inventory' in app.outdir` works, although there should be better ways to check that we're doing an inventory build. That still doesn't work, of course, but it's a place to start.


---

Comment by jhpalmieri created at 2019-01-18 06:14:17

If I use some sort of stupid patch on graphviz.py, then Sphinx crashes when it reaches the second pass, because of the reason you point out: `html/en/reference/_static` does not exist, but there are symlinks pointing to it. If I then manually create this directory (which we could add to the code), the docbuild still fails:

```
WARNING: search index couldn't be loaded, but not all documents will be built: the index will be incomplete.
```

There is a method in sphinx.builders.html called `load_indexer`, and for reasons I don't understand, it is not finding all of the relevant files: its input is two lists, the files it thinks it should include, and the files covered by the index, and if they are not the same, it raises this warning. I added some print statements to see how these two sets differed, and I couldn't see any pattern. When I disable that warning, it gets much farther, but I'm guessing that something will be broken with either the documentation or the index.


---

Comment by git created at 2019-01-18 06:41:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2019-01-18 06:44:40

Okay, here is my current "progress". If I use the branch I just posted, along with this change to Sphinx (which is a terrible idea):

```diff
diff --git a/sphinx/builders/html.py b/sphinx/builders/html.py
index 5060d1f..6747b6c 100644
--- a/sphinx/builders/html.py
+++ b/sphinx/builders/html.py
@@ -1010,7 +1010,7 @@ class StandaloneHTMLBuilder(Builder):
             with f:
                 self.indexer.load(f, self.indexer_format)
         except (IOError, OSError, ValueError):
-            if keep:
+            if keep and False:
                 logger.warning(__('search index couldn\'t be loaded, but not all '
                                   'documents will be built: the index will be '
                                   'incomplete.'))
```

then the documentation builds. Remaining questions: is the documentation complete? Is the index complete? What is the right way to fix the problem that this stupid patch fixes? Are the other changes okay?


---

Comment by jdemeyer created at 2019-01-18 09:19:50

This really should be rebased to #26949 since that makes non-trivial changes to the docbuilder.


---

Comment by jhpalmieri created at 2019-01-18 23:53:35

Note that the line from #26949

```
from sphinx.ext.autodoc.inspector import format_annotation, formatargspec
```

and later use of `formatargspec` leads to deprecation warnings with new versions of Sphinx.


---

Comment by jhpalmieri created at 2019-01-19 00:17:04

On the other hand, documentation seems to build with the branch here + #26949. Now to figure out which changes are actually needed once rebased to #26949.


---

Comment by git created at 2019-01-21 07:03:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2019-01-21 07:04:08

Okay, let's try this.


---

Comment by jhpalmieri created at 2019-01-21 07:04:08

Changing status from needs_info to needs_review.


---

Comment by git created at 2019-01-21 07:05:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2019-01-21 07:15:38

I'd rather wait until the dependency is actually merged to review this.


---

Comment by @timokau created at 2019-01-22 20:23:13

What's the upstream story of that patch? Was it proposed somewhere? What is its purpose?


---

Comment by jhpalmieri created at 2019-01-22 20:51:09

For its purpose, see comments 25-30, 39, and maybe some others. (Search this page for "graphviz".) Basically, Sphinx needlessly copies the file `graphviz.css` to `inventory/en/refererence/MODULE/_static/` directories, and then that confuses the intersphinx build. I haven't reported it upstream because I don't know how Sage-specific it is. We have our own inventory builder, our own "multidocs" extension, etc., and it is not clear how much those are responsible for the problem.

I would also not be surprised if there were better ways to handle the problem with `graphviz.css`. I believe that my suggestion works, so now is the time to confirm that and then to improve on it. (Or wait until #26949 is merged and then do that.)


---

Comment by jdemeyer created at 2019-01-29 08:59:29

Rebased to 8.7.beta1
----
New commits:


---

Comment by jdemeyer created at 2019-01-29 09:03:46

I also restored some of the older commits, to make clear who did what.


---

Comment by jdemeyer created at 2019-01-29 09:07:02

Based on the diff, I'm willing to give this ticket the benefit of the doubt. I cannot say that I understand everything but there is nothing obviously bad.

I haven't actually built the documentation yet, I'll do that next.


---

Comment by arojas created at 2019-01-29 09:10:36

As a packager I share Timo's concerns about the sphinx patch. Are there plans to upstream it?


---

Comment by jdemeyer created at 2019-01-29 13:32:59

Replying to [comment:57 arojas]:
> As a packager I share Timo's concerns about the sphinx patch.

Is there is any particular reason that you're concerned about that specific patch and not the other patches that Sage has for Sphinx?


---

Comment by arojas created at 2019-01-29 13:36:50

Replying to [comment:58 jdemeyer]:
> Replying to [comment:57 arojas]:
> > As a packager I share Timo's concerns about the sphinx patch.
> 
> Is there is any particular reason that you're concerned about that specific patch and not the other patches that Sage has for Sphinx?

Yes, those other patches either address minor issues or are not relevant to Arch, so not having them is not a problem. This one is necessary for docs to build at all.


---

Comment by jdemeyer created at 2019-01-29 15:05:43

There is a minor regression in the produced documentation: a `<BLANKLIKE>` in a doctest is now rendered as `<BLANKLINE>` instead of an actual blank line.


---

Comment by jdemeyer created at 2019-01-29 15:32:23

That's the only issue in the generated documentation I could find by diffing the docs before and after this ticket. It does have problems with parsing ``A = ` ``self``` (see `src/sage/categories/filtered_algebras_with_basis.py`) but the current version also has problems, just different problems.


---

Comment by jhpalmieri created at 2019-01-29 19:45:18

Replying to [comment:60 jdemeyer]:
> There is a minor regression in the produced documentation: a `<BLANKLIKE>` in a doctest is now rendered as `<BLANKLINE>` instead of an actual blank line.

Did you check to see if other `nonmath_substitutes` from `misc.sagedoc` are handled properly? (Or I should say, at least as properly as they currently are?)


---

Comment by jhpalmieri created at 2019-01-29 20:03:34

Maybe this isn't handled by `sage.misc.sagedoc`, but should instead be handled by `sphinx.ext.doctest`: lines like

```
        if self.name == 'doctest':
            if '<BLANKLINE>' in code:
                # convert <BLANKLINE>s to ordinary blank lines for presentation
                test = code
                code = blankline_re.sub('', code)
```

There weren't any changes in this between the old and new versions of Sphinx.


---

Comment by jhpalmieri created at 2019-01-30 06:03:56

Replying to [comment:59 arojas]:
> Replying to [comment:58 jdemeyer]:
> > Replying to [comment:57 arojas]:
> > > As a packager I share Timo's concerns about the sphinx patch.
> > 
> > Is there is any particular reason that you're concerned about that specific patch and not the other patches that Sage has for Sphinx?
> 
> Yes, those other patches either address minor issues or are not relevant to Arch, so not having them is not a problem. This one is necessary for docs to build at all.

Here is maybe a better approach with graphviz.
----
New commits:


---

Comment by jhpalmieri created at 2019-01-30 06:06:08

The point here is that the inventory builder is Sage-specific, and that's where the problem lies. So patching graphviz.py to deal with the inventory builder is okay (in my opinion) and would not make sense to report upstream. It looks like we can deal with it differently, though: rather than preventing graphviz.py from populating `_static` directories, we can remove them in the cleanup stage of the inventory build.


---

Comment by jdemeyer created at 2019-01-30 14:10:33

Great! I'll look into the `<BLANKLINE>` thing now.


---

Comment by arojas created at 2019-01-30 14:26:58

Replying to [comment:66 jhpalmieri]:
> The point here is that the inventory builder is Sage-specific, and that's where the problem lies. So patching graphviz.py to deal with the inventory builder is okay (in my opinion) and would not make sense to report upstream. It looks like we can deal with it differently, though: rather than preventing graphviz.py from populating `_static` directories, we can remove them in the cleanup stage of the inventory build.

Thanks. With this branch, the docs build fine on Arch with unpatched sphinx 1.8.3, modulo #26608


---

Comment by git created at 2019-01-30 17:55:14

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2019-01-30 17:56:24

The most recent commit is an attempt on my part to squash the commits that add and then remove the graphviz patch. My first time squashing, so I hope it worked.


---

Comment by thansen created at 2019-01-31 23:34:55

Thanks for avoiding the graphviz.py patch. Now we can also use the patch in Debian.

In Debian we have a few new failing doctests with sage 8.6, sphinx 1.8.3 and this patch. There is this:


```
sage -t --long src/doc/common/conf.py
**********************************************************************
File "src/doc/common/conf.py", line 619, in doc.common.conf.call_intersphinx
Failed example:
    for line in open(thematic_index).readlines():  # optional - dochtml
        if "padics" in line:
            sys.stdout.write(line)
Expected:
    <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(in Sage Reference Manual: p-Adics v...)"><span>Introduction to the -adics</span></a></li>
Got:
    <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(in Sage Reference Manual: p-Adics v8.6)"><span>Introduction to the p-adics</span></a></li>
```

and 6 occurances of `ApplicationError: Source directory and destination directory cannot be identical` in `sagenb/misc/sphinxify.py` (which need to be fixed in sagenb I guess).


---

Comment by slelievre created at 2019-01-31 23:41:25

Cc Dima Pasechnik about the sagenb question.


---

Comment by dimpase created at 2019-02-01 00:21:27

Replying to [comment:72 slelievre]:
> Cc Dima Pasechnik about the sagenb question.
Thanks. This is now https://github.com/sagemath/sagenb/issues/465


---

Comment by git created at 2019-02-01 18:50:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2019-02-01 18:51:14

The SageNB problem should be fixed from their end, and here is a fix for the Sage doctest failure.


---

Comment by dimpase created at 2019-02-01 19:37:34

Replying to [comment:75 jhpalmieri]:
> The SageNB problem should be fixed from their end, and here is a fix for the Sage doctest failure.

It is fixed now (the fix will be the next sagenb release).


---

Comment by dimpase created at 2019-02-01 19:49:09

One annoying warning with this sphinx now:

```
src/sage_setup/docbuild/ext/sage_autodoc.py:1170: RemovedInSphinx20Warning: formatargspec() is now deprecated.  Please use sphinx.util.inspect.Signature 
```


(and the same warning in `sage_autodoc.py:1072`)


---

Comment by dimpase created at 2019-02-01 19:49:09

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2019-02-01 20:02:40

Noted in comment:45. It's annoying but can we deal with it on another ticket?


---

Comment by jhpalmieri created at 2019-02-01 20:13:50

In particular, I don't know how to solve it. `Signature` does not seem to be just a drop-in replacement. We could just silence the warnings, but that's probably a bad idea.


---

Comment by dimpase created at 2019-02-01 20:30:09

I agree, it needs a bit of coding (examples may be found by googling this warning...)
A new ticket then. By the way, the sagenb update is on #27200.


---

Comment by dimpase created at 2019-02-01 20:30:09

Changing status from needs_work to positive_review.


---

Comment by jhpalmieri created at 2019-02-01 21:15:37

Jeroen, do you agree with the positive review?


---

Comment by jdemeyer created at 2019-02-02 07:53:12

Changing status from positive_review to needs_review.


---

Comment by jdemeyer created at 2019-02-02 07:53:12

Is the `<BLANKLINE>` issue fixed?


---

Comment by dimpase created at 2019-02-02 08:03:57

to me, blankline is blankline, how to check this...


---

Comment by dimpase created at 2019-02-02 09:48:33

some of the doctests here are fixed by #27200, adding as a dependency


---

Comment by jhpalmieri created at 2019-02-02 17:54:59

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2019-02-02 17:54:59

Two problems:
- The BLANKLINE problem is still there. For example, in `calculus/riemann.pyx`, a doctest for `complex_to_spiderweb` includes `<BLANKLINE>`. With the old Sphinx, this was printed as an actual blank line, while with the new one, it prints "<BLANKLINE>".
- The real blocker: math is not rendered in the reference manual (although it is in the tutorial). Indeed, in the generated html files, these lines were included in the old Sphinx, but not in the new one. I don't know why, and I don't know if I have time figure it out right now:

```
    <script type="text/javascript" src="../../../_static/MathJax.js?config=TeX-AMS_HTML-full,../mathjax_sage.js"></script>
    <script type="text/javascript" src="../../../_static/MathJax.js?config=TeX-AMS_HTML-full,../mathjax_sage.js"></script>
```

Manually adding those lines fixes the problem, but they should be there automatically.


---

Comment by dimpase created at 2019-02-04 12:06:37

I tried to replace src/doc/common/themes/sageref with a symlink to src/doc/common/themes/sage, but this did not change the result (no TeX in reference manual).

Could it be some special parallel hack that breaks it? I really have no idea.


---

Comment by jhpalmieri created at 2019-02-05 18:26:47

I think the issue is that in the new Sphinx, `sphinx.ext.mathjax` has the line

```
    app.connect('env-check-consistency', install_mathjax)
```

As far as I can tell, this means that those lines should be produced when `self.env.check_consistency()` is run, but it doesn't get run during the reference/html build. I'm guessing this is because of our multidocs extension, or maybe the sage_autodoc extension.


---

Comment by slelievre created at 2019-02-14 14:14:10

Sphinx 1.8.4 was released and uploaded to PyPI on 2019-02-03.

- *Tarball*: https://files.pythonhosted.org/packages/dd/f8/df628d41f42793d446285767164c6a8da71d82892f2c98c43e0523836d39/Sphinx-1.8.4.tar.gz


---

Comment by jhpalmieri created at 2019-02-14 16:03:18

Unfortunately this doesn't help with the mathjax issue. I'm stuck, so I hope someone else has some ideas.


---

Comment by git created at 2019-02-19 22:47:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2019-02-19 22:51:20

Okay, I've fixed the mathjax problem and the `<BLANKLINE>` problem. The second of these involves patching Sphinx, so if you don't want patches, you will get `<BLANKLINE>` in some doctest output, rather than an actual blank line. Sphinx still produces lots of `formatargspec() is now deprecated` warnings, but I suggest we deal with those in a separate ticket.

Oh, by the way, [Sphinx 2.0.0.beta1](https://github.com/sphinx-doc/sphinx/blob/v2.0.0b1/CHANGES) has been released. It drops Python 2.7 support, so it's not for us yet.


---

Comment by jhpalmieri created at 2019-02-19 23:04:51

Changing status from needs_work to needs_review.


---

Comment by slelievre created at 2019-02-19 23:12:04

Changing keywords from "sphinx, conda" to "sphinx, conda, upgrade".


---

Comment by jhpalmieri created at 2019-02-19 23:13:40

If all else fails, we can just silence those deprecation warnings the same way we silence lots of other "chatter" in the Sphinx build. See `sage_setup/docbuild/sphinxbuild.py`.


---

Comment by @timokau created at 2019-02-20 14:47:12

Why wasn't the `sage:` prompt patch necessary before?

On nixos with this patch applied I get some kind of unicode issue (not sure if its 100% reproducible; I think I've seen it working some time):


```
sage -t docsrc/common/conf.py
**********************************************************************
File "docsrc/common/conf.py", line 614, in common.conf.call_intersphinx
Failed example:
    for line in open(thematic_index).readlines():  # optional - dochtml
        if "padics" in line:
            sys.stdout.write(line)
Expected:
    <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(i
n Sage Reference Manual: p-Adics v...)"><span>Introduction to the p-adics</span></a></li>
Got:
    <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(в
 Sage Reference Manual: p-Adics v8.6)"><span>Introduction to the p-adics</span></a></li>
**********************************************************************
1 item had failures:
   1 of   4 in common.conf.call_intersphinx
    [3 tests, 1 failure, 0.01 s]
```


I don't know if this has to do with some different dependency on nix or if it could also happen on sage-the-distro.


---

Comment by jhpalmieri created at 2019-02-20 16:44:02

Replying to [comment:96 gh-timokau]:
> Why wasn't the `sage:` prompt patch necessary before?

Because the file being patched didn't exist before.

> On nixos with this patch applied I get some kind of unicode issue (not sure if its 100% reproducible; I think I've seen it working some time):
> 
> {{{
> sage -t docsrc/common/conf.py
> **********************************************************************
> File "docsrc/common/conf.py", line 614, in common.conf.call_intersphinx
> Failed example:
>     for line in open(thematic_index).readlines():  # optional - dochtml
>         if "padics" in line:
>             sys.stdout.write(line)
> Expected:
>     <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(i
> n Sage Reference Manual: p-Adics v...)"><span>Introduction to the p-adics</span></a></li>
> Got:
>     <li><a class="reference external" href="../reference/padics/sage/rings/padics/tutorial.html#sage-rings-padics-tutorial" title="(в
>  Sage Reference Manual: p-Adics v8.6)"><span>Introduction to the p-adics</span></a></li>
> **********************************************************************
> 1 item had failures:
>    1 of   4 in common.conf.call_intersphinx
>     [3 tests, 1 failure, 0.01 s]
> }}}
> 
> I don't know if this has to do with some different dependency on nix or if it could also happen on sage-the-distro.

I don't see this with sage-the-distro. The file `doc/common/conf.py` had its doctests changed recently in another ticket (to fix Python 3 issues, I think). This branch doesn't touch that file, and I don't see why it would be related.


---

Comment by thansen created at 2019-02-24 14:19:53

Replying to [comment:92 jhpalmieri]:
> Okay, I've fixed the mathjax problem and the `<BLANKLINE>` problem. The second of these involves patching Sphinx, so if you don't want patches, you will get `<BLANKLINE>` in some doctest output, rather than an actual blank line.

Instead of adding this very sage specific patch to sphinx, why not do this in a sphinx extension?

Like this:


```
--- a/src/doc/common/conf.py
+++ b/src/doc/common/conf.py
@@ -13,7 +13,7 @@
 
 # Add any Sphinx extension module names here, as strings. They can be extensions
 # coming with Sphinx (named 'sphinx.ext.*') or your custom ones.
-extensions = ['inventory_builder', 'multidocs',
+extensions = ['inventory_builder', 'multidocs', 'trim_doctest_flags',
               'sage_autodoc',  'sphinx.ext.graphviz',
               'sphinx.ext.inheritance_diagram', 'sphinx.ext.todo',
               'sphinx.ext.extlinks', 'matplotlib.sphinxext.plot_directive']
--- /dev/null
+++ b/src/sage_setup/docbuild/ext/trim_doctest_flags.py
@@ -0,0 +1,67 @@
+"""
+    trim doctest flags
+    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+
+    transforms for code-blocks.
+
+    modified from sphinx.transforms.post_transforms.code
+
+    :copyright: Copyright 2007-2019 by the Sphinx team, see AUTHORS.
+    :license: BSD, see LICENSE for details.
+"""
+
+import sys
+from typing import NamedTuple
+
+from docutils import nodes
+from pygments.lexers import PythonConsoleLexer, guess_lexer
+
+from sphinx import addnodes
+from sphinx.ext import doctest
+from sphinx.transforms import SphinxTransform
+
+class TrimDoctestFlagsTransformSage(SphinxTransform):
+    """
+    Trim doctest flags like ``# doctest: +FLAG`` from sage code-blocks.
+
+    The only difference from Sphinx' TrimDoctestFlagsTransform is that
+    here lines starting with 'sage:' rather than '>>>' are transformed.
+    """
+    default_priority = 401
+
+    def apply(self, **kwargs):
+        # type: (Any) -> None
+        if not self.config.trim_doctest_flags:
+            return
+
+        for node in self.document.traverse(nodes.literal_block):
+            if self.is_pyconsole(node):
+                source = node.rawsource
+                source = doctest.blankline_re.sub('', source)
+                source = doctest.doctestopt_re.sub('', source)
+                node.rawsource = source
+                node[:] = [nodes.Text(source)]
+
+    @staticmethod
+    def is_pyconsole(node):
+        # type: (nodes.literal_block) -> bool
+        if node.rawsource != node.astext():
+            return False  # skip parsed-literal node
+
+        language = node.get('language')
+        if language in ('pycon', 'pycon3'):
+            return True
+        elif language in ('py', 'py3', 'python', 'python3', 'default'):
+            return node.rawsource.startswith('sage:')
+        elif language == 'guess':
+            try:
+                lexer = guess_lexer(node.rawsource)
+                return isinstance(lexer, PythonConsoleLexer)
+            except Exception:
+                pass
+
+        return False
+
+
+def setup(app):
+    app.add_post_transform(TrimDoctestFlagsTransformSage)
```


https://salsa.debian.org/science-team/sagemath/blob/master/debian/patches/u1-sphinx-1.8-doctest-transform.patch


---

Comment by jhpalmieri created at 2019-02-24 16:35:17

There is a balance to be struck: we're more or less forking Sphinx with extensions like this, so they require maintenance: as Sphinx changes, so should the extension. This recently required a fair amount of work for Sage's autodoc extension (#26949).

So is it better to patch Sphinx or create an extension?


---

Comment by jhpalmieri created at 2019-03-07 04:15:10

Any more comments on this? If people who deal with distributions feel that using a Sphinx extension would be better than a patch, then please go ahead and implement that. If people feel that patching is better, then what else needs to be done?


---

Comment by thansen created at 2019-03-07 09:32:57

Replying to [comment:100 jhpalmieri]:
> Any more comments on this? If people who deal with distributions feel that using a Sphinx extension would be better than a patch, then please go ahead and implement that. If people feel that patching is better, then what else needs to be done?

I already implemented it and posted the patch here. Is there something wrong with it?


---

Comment by dimpase created at 2019-03-07 12:12:03

Replying to [comment:101 thansen]:
> Replying to [comment:100 jhpalmieri]:
> > Any more comments on this? If people who deal with distributions feel that using a Sphinx extension would be better than a patch, then please go ahead and implement that. If people feel that patching is better, then what else needs to be done?
> 
> I already implemented it and posted the patch here. Is there something wrong with it?

Care to propose a full branch? (So that it's 100% clear what the solution is)


---

Comment by jhpalmieri created at 2019-03-07 16:03:59

Replying to [comment:101 thansen]:
> Replying to [comment:100 jhpalmieri]:
> > Any more comments on this? If people who deal with distributions feel that using a Sphinx extension would be better than a patch, then please go ahead and implement that. If people feel that patching is better, then what else needs to be done?
> 
> I already implemented it and posted the patch here. Is there something wrong with it?

Not necessarily, but I did respond and ask a question about the philosophy of patches vs. extensions. I was hoping for a discussion.


---

Comment by thansen created at 2019-03-07 16:20:50

From a packagers standpoint the extension is clearly better. Since the sphinx patch does not make much sense for us we would probably have to keep patching in the extension anyway. But I thought that was obvious and you were asking for opinions of sage developers.


---

Comment by dimpase created at 2019-03-15 16:54:14

From developers point of view, we appreciate your efforts a lot --- although  we'd much prefer a branch with your solution to a link to Debian patches, from which one sometimes might need to do reverse engineering to get what's needed and works in Sage sans Debian...


---

Comment by thansen created at 2019-03-17 13:19:50

Replying to [comment:105 dimpase]:
> From developers point of view, we appreciate your efforts a lot --- although  we'd much prefer a branch with your solution to a link to Debian patches, from which one sometimes might need to do reverse engineering to get what's needed and works in Sage sans Debian...

Ok, here is a branch:
https://git.sagemath.org/sage.git/log/?h=u/thansen/26451


---

Comment by fbissey created at 2019-03-17 21:42:51

Replying to [comment:106 thansen]:
> Replying to [comment:105 dimpase]:
> > From developers point of view, we appreciate your efforts a lot --- although  we'd much prefer a branch with your solution to a link to Debian patches, from which one sometimes might need to do reverse engineering to get what's needed and works in Sage sans Debian...
> 
> Ok, here is a branch:
> https://git.sagemath.org/sage.git/log/?h=u/thansen/26451

Clarification. I am assuming this needs to be applied on top of the current branch already in this ticket. Right?


---

Comment by thansen created at 2019-03-17 23:38:32

Replying to [comment:107 fbissey]:
> Replying to [comment:106 thansen]:
> > Replying to [comment:105 dimpase]:
> > > From developers point of view, we appreciate your efforts a lot --- although  we'd much prefer a branch with your solution to a link to Debian patches, from which one sometimes might need to do reverse engineering to get what's needed and works in Sage sans Debian...
> > 
> > Ok, here is a branch:
> > https://git.sagemath.org/sage.git/log/?h=u/thansen/26451
> 
> Clarification. I am assuming this needs to be applied on top of the current branch already in this ticket. Right?

No, this is just the branch of this ticket with John's fix for the <BLANKLINE> issue removed and my patch applied.


---

Comment by dimpase created at 2019-03-17 23:46:18

So, building reference manual, mathjax works on u/thansen/26451


---

Comment by thansen created at 2019-03-17 23:48:43

Replying to [comment:109 dimpase]:
> So, building reference manual, mathjax works on u/thansen/26451

The thing I changed has nothing to do with mathjax, it's a different fix for the <BLANKLINE> issue.


---

Comment by dimpase created at 2019-03-18 09:30:47

Replying to [comment:110 thansen]:
> Replying to [comment:109 dimpase]:
> > So, building reference manual, mathjax works on u/thansen/26451
> 
> The thing I changed has nothing to do with mathjax, it's a different fix for the <BLANKLINE> issue.

Sorry, I got lost here. Is `u/thansen/26451` a complete branch? If so, please put it into the Branch field of the ticket, and add your name to the list of authors.


---

Comment by fbissey created at 2019-03-18 09:34:05

Replying to [comment:111 dimpase]:
> Replying to [comment:110 thansen]:
> > Replying to [comment:109 dimpase]:
> > > So, building reference manual, mathjax works on u/thansen/26451
> > 
> > The thing I changed has nothing to do with mathjax, it's a different fix for the <BLANKLINE> issue.
> 
> Sorry, I got lost here. Is `u/thansen/26451` a complete branch? If so, please put it into the Branch field of the ticket, and add your name to the list of authors.

That's why I asked the question earlier. I was going to do just that on thansen's behalf, but when I clicked on the link I could only see one commit. Now that may just have been the way I navigated there, that's why I asked.


---

Comment by thansen created at 2019-03-18 10:02:26

Replying to [comment:111 dimpase]:
> Replying to [comment:110 thansen]:
> > Replying to [comment:109 dimpase]:
> > > So, building reference manual, mathjax works on u/thansen/26451
> > 
> > The thing I changed has nothing to do with mathjax, it's a different fix for the <BLANKLINE> issue.
> 
> Sorry, I got lost here. Is `u/thansen/26451` a complete branch? If so, please put it into the Branch field of the ticket, and add your name to the list of authors.

Yes, it's a complete branch. I didn't put it in the branch field of the ticket because this is John's ticket and he never said we should use my fix instead of his.


---

Comment by dimpase created at 2019-03-18 10:33:28

IMHO John won't mind---in fact he appears to have said OK to this on comment:101. (John, please shout if I am wrong).
----
New commits:


---

Comment by jhpalmieri created at 2019-03-22 03:12:58

Here is a different approach for the `<BLANKLINE>` problem, as suggested [on Sphinx's github page](https://github.com/sphinx-doc/sphinx/issues/6188). I've added a dependency, #27528, which also removes `highlighting.patch`. It is necessary here because it suppresses some warnings which are produced by `SageMathTransform`.

If this is acceptable, we should probably squash some commits: we don't need to create `trim_doctest_flags.py` and then delete it.
----
New commits:


---

Comment by arojas created at 2019-03-24 12:32:58

With this branch on top of 8.7 and sphinx 1.8.5 I'm getting:


```
Process Process-79:
Traceback (most recent call last):
  File "/usr/lib/python2.7/multiprocessing/process.py", line 267, in _bootstrap
    self.run()
  File "/usr/lib/python2.7/multiprocessing/process.py", line 114, in run
    self._target(*self._args, **self._kwargs)
  File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 79, in build_ref_doc
    getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)
  File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 763, in _wrapper
    getattr(DocBuilder, build_type)(self, *args, **kwds)
  File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 135, in f
    runsphinx()
  File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/sphinxbuild.py", line 314, in runsphinx
    sys.stderr.raise_errors()
  File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/sphinxbuild.py", line 249, in raise_errors
    raise OSError(self._error)
OSError: /build/sagemath-doc/src/sage-8.7/src/doc/en/reference/combinat/sage/combinat/shifted_primed_tableau.rst:267: WARNING: Could not lex literal_block as "pycon". Highlighting skipped.
Error building the documentation.
Traceback (most recent call last):
  File "/usr/lib/python2.7/runpy.py", line 174, in _run_module_as_main
    "__main__", fname, loader, pkg_name)
  File "/usr/lib/python2.7/runpy.py", line 72, in _run_code
    exec code in run_globals
  File "/build/sagemath-doc/src/sage-8.7/src/sage_setup/docbuild/__main__.py", line 2, in <module>
    main()
  File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 1732, in main
    builder()
  File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 358, in _wrapper
    getattr(get_builder(document), name)(*args, **kwds)
  File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 549, in _wrapper
    build_many(build_ref_doc, L)
  File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/utils.py", line 214, in _build_many
    raise worker_exc
WorkerDiedException: worker for ('reference/combinat', 'en', 'html', {}) died with non-zero exit code 1

    Note: incremental documentation builds sometimes cause spurious
    error messages. To be certain that these are real errors, run
    "make doc-clean" first and try again.
```



---

Comment by slelievre created at 2019-03-24 14:13:48

Sphinx 1.8.5 was released on PyPI on 2019-03-10, and Sphinx 2.0.0b2 on 2019-03-20. See

- https://pypi.org/project/Sphinx/#history


---

Comment by jhpalmieri created at 2019-03-24 18:23:26

I believe that Sphinx 2.0.0b2 is dropping support for Python 2.7, so we can't use that. I'll look at 1.8.5.


---

Comment by jhpalmieri created at 2019-03-24 18:24:51

Replying to [comment:117 arojas]:
> With this branch on top of 8.7 and sphinx 1.8.5 I'm getting:
> 
> {{{
> Process Process-79:
> Traceback (most recent call last):
>   File "/usr/lib/python2.7/multiprocessing/process.py", line 267, in _bootstrap
>     self.run()
>   File "/usr/lib/python2.7/multiprocessing/process.py", line 114, in run
>     self._target(*self._args, **self._kwargs)
>   File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 79, in build_ref_doc
>     getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)
>   File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 763, in _wrapper
>     getattr(DocBuilder, build_type)(self, *args, **kwds)
>   File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 135, in f
>     runsphinx()
>   File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/sphinxbuild.py", line 314, in runsphinx
>     sys.stderr.raise_errors()
>   File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/sphinxbuild.py", line 249, in raise_errors
>     raise OSError(self._error)
> OSError: /build/sagemath-doc/src/sage-8.7/src/doc/en/reference/combinat/sage/combinat/shifted_primed_tableau.rst:267: WARNING: Could not lex literal_block as "pycon". Highlighting skipped.
> Error building the documentation.
> Traceback (most recent call last):
>   File "/usr/lib/python2.7/runpy.py", line 174, in _run_module_as_main
>     "__main__", fname, loader, pkg_name)
>   File "/usr/lib/python2.7/runpy.py", line 72, in _run_code
>     exec code in run_globals
>   File "/build/sagemath-doc/src/sage-8.7/src/sage_setup/docbuild/__main__.py", line 2, in <module>
>     main()
>   File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 1732, in main
>     builder()
>   File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 358, in _wrapper
>     getattr(get_builder(document), name)(*args, **kwds)
>   File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/__init__.py", line 549, in _wrapper
>     build_many(build_ref_doc, L)
>   File "/build/sagemath-doc/src/sage-8.7/local-python/sage_setup/docbuild/utils.py", line 214, in _build_many
>     raise worker_exc
> WorkerDiedException: worker for ('reference/combinat', 'en', 'html', {}) died with non-zero exit code 1
> 
>     Note: incremental documentation builds sometimes cause spurious
>     error messages. To be certain that these are real errors, run
>     "make doc-clean" first and try again.
> }}}

Did you also use the branch from #27528? That would get rid of the warning which is causing the problems. This is somewhat moot, since I am reworking #27528. I should be able to post something later today.


---

Comment by arojas created at 2019-03-24 18:30:24

Replying to [comment:120 jhpalmieri]:
> 
> Did you also use the branch from #27528? That would get rid of the warning which is causing the problems. This is somewhat moot, since I am reworking #27528. I should be able to post something later today.

Ah, no. I was under the (wrong) impression that branches in trac tickets already pulled the changes from dependant tickets.


---

Comment by jhpalmieri created at 2019-03-24 18:37:21

Replying to [comment:121 arojas]:
> Replying to [comment:120 jhpalmieri]:
> > 
> > Did you also use the branch from #27528? That would get rid of the warning which is causing the problems. This is somewhat moot, since I am reworking #27528. I should be able to post something later today.
> 
> Ah, no. I was under the (wrong) impression that branches in trac tickets already pulled the changes from dependant tickets.

Sometimes they do and sometimes they don't. I don't know what I am supposed to do when preparing branches: base this one on the one from #27528 or on `develop`?


---

Comment by jhpalmieri created at 2019-03-24 23:09:20

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-03-24 23:50:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2019-03-24 23:50:58

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2019-03-24 23:50:58

Here is a new branch which is based on #27528. I put the `<BLANKLINE>` stuff at #27528, not here, since I needed it there.


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by git created at 2019-03-25 18:14:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2019-03-25 22:19:09

PDF documentation builds fine for me.


---

Comment by dimpase created at 2019-03-26 00:13:00

looks good to me.


---

Comment by dimpase created at 2019-03-26 00:13:00

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2019-03-26 04:21:55

Great! Now we need to silence all of the stupid deprecation warnings.


---

Comment by jhpalmieri created at 2019-03-30 22:29:30

See #27578 for a ticket to stop using the deprecated `formatargspec`.


---

Comment by vbraun created at 2019-03-30 22:37:44

Merge conflict


---

Comment by vbraun created at 2019-03-30 22:37:44

Changing status from positive_review to needs_work.


---

Comment by git created at 2019-03-31 01:52:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2019-03-31 01:52:35

Changing status from needs_work to positive_review.


---

Comment by jhpalmieri created at 2019-03-31 01:52:35

Rebased.


---

Comment by vbraun created at 2019-04-02 21:30:01

Resolution: fixed
