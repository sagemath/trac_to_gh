# Issue 31725: Package cvxpy

Issue created by migration from https://trac.sagemath.org/ticket/31962

Original creator: mkoeppe

Original creation time: 2021-06-12 00:19:17

CC:  dimpase yzh @sheerluck dcoudert slabbe

... for disciplined convex programming and extensions

https://www.cvxpy.org/index.html

with many backend solvers - https://www.cvxpy.org/tutorial/advanced/index.html#choosing-a-solver

with differentiable programming - 
https://www.cvxpy.org/tutorial/advanced/index.html#sensitivity-analysis-and-gradients

https://github.com/cvxgrp/cvxpylayers


---

Comment by slelievre created at 2021-06-12 10:59:27

New commits:


---

Comment by dimpase created at 2021-06-12 11:12:12

can we get some examples/tests using it, too?


---

Comment by mkoeppe created at 2021-06-17 06:03:15

Replying to [comment:4 dimpase]:
> can we get some examples/tests using it, too?

see #31981


---

Comment by git created at 2021-07-21 00:08:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-21 05:16:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-07-21 06:40:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-22 17:30:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-22 19:40:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-25 22:43:54

Ready for a look by an SDP expert...


---

Comment by git created at 2021-07-25 22:58:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-07-26 22:37:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-09 23:09:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-03-12 05:49:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-12 05:51:00

Here's a first, incomplete draft of `CVXPYBackend`.


---

Comment by @sheerluck created at 2022-03-12 07:14:31


```diff
--- a/generic_backend.pyx
+++ b/generic_backend.pyx
@@ -1803,7 +1803,7 @@
         if solver == "Cvxpy":
             return CVXPYBackend()
         if solver.startswith("Cvxpy/"):
-            return CVXPYBackend(cvxpy_solver=solver[len("Cvxpy/")])
+            return CVXPYBackend(cvxpy_solver=solver[len("Cvxpy/"):])
```



---

Comment by mkoeppe created at 2022-03-12 17:29:33

Thanks


---

Comment by git created at 2022-03-12 17:43:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-12 17:56:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-03-12 18:53:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-12 19:10:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-12 19:13:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-12 19:25:22

Some methods are not implemented yet, but some things work already. After `./sage -i cvxpy cylp`, the CVXPY/CBC solver is the default and `./sage -tp src/sage/graphs/` gives only a few errors.


---

Comment by git created at 2022-03-12 20:24:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @sheerluck created at 2022-03-12 21:21:28

Thanks to this ticket I was able to solve #32053

```
sage: designs.steiner_triple_system(7).coloring(solver="cvxpy/CBC")
[[0, 2, 3, 6], [4, 5], [1]]
```

by adding some code from `ppl_backend.pyx` to `cvxpy_backend.{pyx,pxd}`

but in `mip.pyx` I got `value = self._backend_variable_value(v, tolerance)` of type `<class 'numpy.ndarray'>` and that is a bug.


---

Attachment


---

Attachment

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-12 21:52:54

Thanks! I've committed your additions.


---

Comment by mkoeppe created at 2022-03-12 21:53:20

Replying to [comment:39 gh-sheerluck]:
> but in `mip.pyx` I got `value = self._backend_variable_value(v, tolerance)` of type `<class 'numpy.ndarray'>` and that is a bug.

I already fixed this one in one of my commits


---

Comment by @sheerluck created at 2022-03-12 21:58:52

btw `is_variable_binary`, `is_variable_integer`, `is_variable_continuous` should be properly implemented, `return True` or `return False` is inflexible :)


---

Comment by git created at 2022-03-13 00:08:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-13 00:11:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-13 00:18:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-13 04:56:35

These failures indicate that the solver doesn't handle integer variables correctly.
Not sure if it's the new interface or if the CyLP/CBC backend in CVXPY that is not in good shape.

```
sage -t --random-seed=200293476130791194302620065212091883890 src/sage/graphs/comparability.pyx
**********************************************************************
File "src/sage/graphs/comparability.pyx", line 417, in sage.graphs.comparability.is_comparability_MILP
Failed example:
    is_comparability(graphs.CycleGraph(5), certificate = True)
Exception raised:
    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.comparability.is_comparability_MILP[1]>", line 1, in <module>
        is_comparability(graphs.CycleGraph(Integer(5)), certificate = True)
      File "sage/graphs/comparability.pyx", line 475, in sage.graphs.comparability.is_comparability_MILP (build/cythonized/sage/graphs/comparability.c:5404)
        o = p.get_values(o, convert=True, tolerance=tol)
      File "sage/numerical/mip.pyx", line 1770, in sage.numerical.mip.MixedIntegerLinearProgram.get_values (build/cythonized/sage/numerical/mip.c:12568)
        c[k] = get_backend_variable_value(v, tolerance)
      File "sage/numerical/mip.pyx", line 1523, in sage.numerical.mip.MixedIntegerLinearProgram._backend_variable_value_True (build/cythonized/sage/numerical/mip.c:11789)
        return self._backend_variable_value_ZZ(v, tolerance)
      File "sage/numerical/mip.pyx", line 1441, in sage.numerical.mip.MixedIntegerLinearProgram._backend_variable_value_ZZ (build/cythonized/sage/numerical/mip.c:11278)
        raise RuntimeError(f'variable {v} exceeds integrality tolerance {tolerance}')
    RuntimeError: variable x_0 exceeds integrality tolerance 1e-06
```



---

Comment by @sheerluck created at 2022-03-13 08:01:57

I use patched `cvxpy/reductions/solvers/conic_solvers/cbc_conif.py` for `import mip` and I got

```
sage -t --random-seed=200293476130791194302620065212091883890 src/sage/graphs/comparability.pyx
    [52 tests, 11.50 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```



---

Attachment


---

Comment by mkoeppe created at 2022-03-13 17:35:50

Any relation to https://pypi.org/project/mip-cvxpy/?


---

Comment by @sheerluck created at 2022-03-13 18:19:09

yes, my patch is full copy of mip-cvxpy with class `class PYTHON_MIP` renamed:

```
sage: from cvxpy import installed_solvers; installed_solvers()
['CBC', 'CVXOPT', 'DIFFCP', 'ECOS', 'ECOS_BB', 'GLPK', 'GLPK_MI', 'OSQP', 'SCIPY', 'SCS']
```

that 'CBC' is actually 'PYTHON_MIP'


---

Comment by mkoeppe created at 2022-03-13 18:47:43

I also tested with `default_mip_solver('CVXPY/GLPK_MI')`, which works fine. So the problem is definitely in the CyLP/CBC backend or even in CyLP itself.


---

Comment by mkoeppe created at 2022-03-13 19:33:25

This appears to be https://github.com/coin-or/CyLP/issues/81 - integer infeasibility is not handled correctly in cylp (and not covered by their testsuite)


---

Comment by mkoeppe created at 2022-03-13 20:07:30

Workaround: https://github.com/cvxpy/cvxpy/pull/1703


---

Comment by @sheerluck created at 2022-03-13 20:58:17

I was fighting with **python-mip** to get something like `model.setNumberThreads(ncpus())` from `coin_backend.pyx` and then I realized that `python-mip` does not use my fresh local `cbc`, it has its own old binary `mip/libraries/cbc-c-linux-x86-64.so` stored in github. And **CyLP** tells me his `CbcMain0` from `cylp/cpp/ICbcModel.cpp` is not compatible with my `CbcMain0` from `/usr/include/coin-or/CbcSolver.hpp`. So I guess I have to find myself another library :)


---

Comment by git created at 2022-03-13 21:25:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-13 21:27:59

Replying to [comment:57 gh-sheerluck]:
>  I realized that `python-mip` does not use my fresh local `cbc`

I guess one needs to install it as `sage -pip install --no-binary :all: mip`


---

Comment by mkoeppe created at 2022-03-13 21:40:59

Oh, I see, even the source tarball has these, and it can only be overridden using an environment variable. https://github.com/coin-or/python-mip/blob/master/mip/cbc.py#L63

That's of course highly problematic.


---

Comment by mkoeppe created at 2022-03-13 21:43:11

The build script for this vendored stuff are in https://github.com/coin-or/python-mip/tree/master/scripts


---

Comment by mkoeppe created at 2022-03-13 22:39:13

So far `python-mip` is not present in major distributions, https://repology.org/project/python:mip/versions, so we cannot see how they would be dealing with this type of vendoring.


---

Comment by git created at 2022-03-14 03:19:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @sheerluck created at 2022-03-14 08:21:41

Replying to [comment:61 mkoeppe]:
> The build script for this vendored stuff are in https://github.com/coin-or/python-mip/tree/master/scripts
for now I manually run 

```
g++ -shared -fPIC -march=native -mtune=native -O3 \
 -maes -mavx -mavx2 -mf16c -mfma -mmmx -mpclmul \
 -mpopcnt -msse -msse2 -msse3 -msse4.1 -msse4.2 \
 -o ./cbc-c-linux-x86-64.so \
 -I/usr/include/coin-or \
 -I/usr/include/coin/ThirdParty \
 -DCBC_THREAD \
 ./Cbc_C_Interface.cpp \
 -L/usr/lib64 \
 -lCbc -lpthread -lrt -lCgl \
 -lOsiClp -lClp -lOsi -lCoinUtils \
 -lgfortran -lquadmath -lm

strip ./cbc-c-linux-x86-64.so
```

Then I manually copy `./cbc-c-linux-x86-64.so` to `/usr/lib/python3.10/site-packages/mip/libraries`

it's good enough for now. But `coin_backend.pyx` with `model.setNumberThreads(ncpus())` is way better... if it wasn't broken.


---

Comment by git created at 2022-03-14 22:23:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-14 22:25:10

Back to using Cvxpy/cbc. 

The remaining failures are from unimplemented `set_variable_type`


---

Comment by mkoeppe created at 2022-03-14 23:12:43

Replying to [comment:67 mkoeppe]:
> The remaining failures are from unimplemented `set_variable_type`

I've opened #33504 `sage.graphs`, `sage.numerical.mip`: Remove unnecessary uses of `set_binary`, `set_integer`.


---

Comment by git created at 2022-03-14 23:27:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-16 04:05:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-27 02:09:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-27 02:22:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-27 02:24:47

Branch pushed to git repo; I updated commit sha1. New commits:
