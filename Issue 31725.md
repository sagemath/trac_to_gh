# Issue 31725: Package cvxpy

archive/issues_031725.json:
```json
{
    "body": "CC:  @dimpase @yuan-zhou @sheerluck @dcoudert @seblabbe\n\n... for disciplined convex programming and extensions\n\nhttps://www.cvxpy.org/index.html\n\nwith many backend solvers - https://www.cvxpy.org/tutorial/advanced/index.html#choosing-a-solver\n\nwith differentiable programming - \nhttps://www.cvxpy.org/tutorial/advanced/index.html#sensitivity-analysis-and-gradients\n\nhttps://github.com/cvxgrp/cvxpylayers\n\nIssue created by migration from https://trac.sagemath.org/ticket/31962\n\n",
    "created_at": "2021-06-12T00:19:17Z",
    "labels": [
        "linear programming",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Package cvxpy",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31725",
    "user": "@mkoeppe"
}
```
CC:  @dimpase @yuan-zhou @sheerluck @dcoudert @seblabbe

... for disciplined convex programming and extensions

https://www.cvxpy.org/index.html

with many backend solvers - https://www.cvxpy.org/tutorial/advanced/index.html#choosing-a-solver

with differentiable programming - 
https://www.cvxpy.org/tutorial/advanced/index.html#sensitivity-analysis-and-gradients

https://github.com/cvxgrp/cvxpylayers

Issue created by migration from https://trac.sagemath.org/ticket/31962





---

archive/issue_comments_453315.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-06-12T10:59:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453315",
    "user": "@slel"
}
```

New commits:



---

archive/issue_comments_453316.json:
```json
{
    "body": "can we get some examples/tests using it, too?",
    "created_at": "2021-06-12T11:12:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453316",
    "user": "@dimpase"
}
```

can we get some examples/tests using it, too?



---

archive/issue_comments_453317.json:
```json
{
    "body": "Replying to [comment:4 dimpase]:\n> can we get some examples/tests using it, too?\n\nsee #31981",
    "created_at": "2021-06-17T06:03:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453317",
    "user": "@mkoeppe"
}
```

Replying to [comment:4 dimpase]:
> can we get some examples/tests using it, too?

see #31981



---

archive/issue_comments_453318.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-21T00:08:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453318",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453319.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-07-21T05:16:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453319",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_453320.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-21T06:40:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453320",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453321.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-22T17:30:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453321",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453322.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-22T19:40:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453322",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453323.json:
```json
{
    "body": "Ready for a look by an SDP expert...",
    "created_at": "2021-07-25T22:43:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453323",
    "user": "@mkoeppe"
}
```

Ready for a look by an SDP expert...



---

archive/issue_comments_453324.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-07-25T22:58:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453324",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_453325.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-07-26T22:37:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453325",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453326.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-03-09T23:09:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453326",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_453327.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-12T05:49:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453327",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453328.json:
```json
{
    "body": "Here's a first, incomplete draft of `CVXPYBackend`.",
    "created_at": "2022-03-12T05:51:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453328",
    "user": "@mkoeppe"
}
```

Here's a first, incomplete draft of `CVXPYBackend`.



---

archive/issue_comments_453329.json:
```json
{
    "body": "\n```diff\n--- a/generic_backend.pyx\n+++ b/generic_backend.pyx\n@@ -1803,7 +1803,7 @@\n         if solver == \"Cvxpy\":\n             return CVXPYBackend()\n         if solver.startswith(\"Cvxpy/\"):\n-            return CVXPYBackend(cvxpy_solver=solver[len(\"Cvxpy/\")])\n+            return CVXPYBackend(cvxpy_solver=solver[len(\"Cvxpy/\"):])\n```\n",
    "created_at": "2022-03-12T07:14:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453329",
    "user": "@sheerluck"
}
```


```diff
--- a/generic_backend.pyx
+++ b/generic_backend.pyx
@@ -1803,7 +1803,7 @@
         if solver == "Cvxpy":
             return CVXPYBackend()
         if solver.startswith("Cvxpy/"):
-            return CVXPYBackend(cvxpy_solver=solver[len("Cvxpy/")])
+            return CVXPYBackend(cvxpy_solver=solver[len("Cvxpy/"):])
```




---

archive/issue_comments_453330.json:
```json
{
    "body": "Thanks",
    "created_at": "2022-03-12T17:29:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453330",
    "user": "@mkoeppe"
}
```

Thanks



---

archive/issue_comments_453331.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-12T17:43:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453331",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453332.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-03-12T17:56:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453332",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_453333.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-12T18:53:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453333",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453334.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-12T19:10:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453334",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453335.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-12T19:13:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453335",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453336.json:
```json
{
    "body": "Some methods are not implemented yet, but some things work already. After `./sage -i cvxpy cylp`, the CVXPY/CBC solver is the default and `./sage -tp src/sage/graphs/` gives only a few errors.",
    "created_at": "2022-03-12T19:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453336",
    "user": "@mkoeppe"
}
```

Some methods are not implemented yet, but some things work already. After `./sage -i cvxpy cylp`, the CVXPY/CBC solver is the default and `./sage -tp src/sage/graphs/` gives only a few errors.



---

archive/issue_comments_453337.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-12T20:24:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453337",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453338.json:
```json
{
    "body": "Thanks to this ticket I was able to solve #32053\n\n```\nsage: designs.steiner_triple_system(7).coloring(solver=\"cvxpy/CBC\")\n[[0, 2, 3, 6], [4, 5], [1]]\n```\n\nby adding some code from `ppl_backend.pyx` to `cvxpy_backend.{pyx,pxd}`\n\nbut in `mip.pyx` I got `value = self._backend_variable_value(v, tolerance)` of type `<class 'numpy.ndarray'>` and that is a bug.",
    "created_at": "2022-03-12T21:21:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453338",
    "user": "@sheerluck"
}
```

Thanks to this ticket I was able to solve #32053

```
sage: designs.steiner_triple_system(7).coloring(solver="cvxpy/CBC")
[[0, 2, 3, 6], [4, 5], [1]]
```

by adding some code from `ppl_backend.pyx` to `cvxpy_backend.{pyx,pxd}`

but in `mip.pyx` I got `value = self._backend_variable_value(v, tolerance)` of type `<class 'numpy.ndarray'>` and that is a bug.



---

archive/issue_comments_453339.json:
```json
{
    "body": "Attachment [cvxpy_backend.pyx](tarball://root/attachments/some-uuid/ticket31962/cvxpy_backend.pyx) by @sheerluck created at 2022-03-12 21:22:34",
    "created_at": "2022-03-12T21:22:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453339",
    "user": "@sheerluck"
}
```

Attachment [cvxpy_backend.pyx](tarball://root/attachments/some-uuid/ticket31962/cvxpy_backend.pyx) by @sheerluck created at 2022-03-12 21:22:34



---

archive/issue_comments_453340.json:
```json
{
    "body": "Attachment [cvxpy_backend.pxd](tarball://root/attachments/some-uuid/ticket31962/cvxpy_backend.pxd) by git created at 2022-03-12 21:51:22\n\nBranch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-12T21:51:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453340",
    "user": "git"
}
```

Attachment [cvxpy_backend.pxd](tarball://root/attachments/some-uuid/ticket31962/cvxpy_backend.pxd) by git created at 2022-03-12 21:51:22

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453341.json:
```json
{
    "body": "Thanks! I've committed your additions.",
    "created_at": "2022-03-12T21:52:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453341",
    "user": "@mkoeppe"
}
```

Thanks! I've committed your additions.



---

archive/issue_comments_453342.json:
```json
{
    "body": "Replying to [comment:39 gh-sheerluck]:\n> but in `mip.pyx` I got `value = self._backend_variable_value(v, tolerance)` of type `<class 'numpy.ndarray'>` and that is a bug.\n\nI already fixed this one in one of my commits",
    "created_at": "2022-03-12T21:53:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453342",
    "user": "@mkoeppe"
}
```

Replying to [comment:39 gh-sheerluck]:
> but in `mip.pyx` I got `value = self._backend_variable_value(v, tolerance)` of type `<class 'numpy.ndarray'>` and that is a bug.

I already fixed this one in one of my commits



---

archive/issue_comments_453343.json:
```json
{
    "body": "btw `is_variable_binary`, `is_variable_integer`, `is_variable_continuous` should be properly implemented, `return True` or `return False` is inflexible :)",
    "created_at": "2022-03-12T21:58:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453343",
    "user": "@sheerluck"
}
```

btw `is_variable_binary`, `is_variable_integer`, `is_variable_continuous` should be properly implemented, `return True` or `return False` is inflexible :)



---

archive/issue_comments_453344.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-13T00:08:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453344",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453345.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-13T00:11:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453345",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453346.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-13T00:18:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453346",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453347.json:
```json
{
    "body": "These failures indicate that the solver doesn't handle integer variables correctly.\nNot sure if it's the new interface or if the CyLP/CBC backend in CVXPY that is not in good shape.\n\n```\nsage -t --random-seed=200293476130791194302620065212091883890 src/sage/graphs/comparability.pyx\n**********************************************************************\nFile \"src/sage/graphs/comparability.pyx\", line 417, in sage.graphs.comparability.is_comparability_MILP\nFailed example:\n    is_comparability(graphs.CycleGraph(5), certificate = True)\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py\", line 695, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1093, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.graphs.comparability.is_comparability_MILP[1]>\", line 1, in <module>\n        is_comparability(graphs.CycleGraph(Integer(5)), certificate = True)\n      File \"sage/graphs/comparability.pyx\", line 475, in sage.graphs.comparability.is_comparability_MILP (build/cythonized/sage/graphs/comparability.c:5404)\n        o = p.get_values(o, convert=True, tolerance=tol)\n      File \"sage/numerical/mip.pyx\", line 1770, in sage.numerical.mip.MixedIntegerLinearProgram.get_values (build/cythonized/sage/numerical/mip.c:12568)\n        c[k] = get_backend_variable_value(v, tolerance)\n      File \"sage/numerical/mip.pyx\", line 1523, in sage.numerical.mip.MixedIntegerLinearProgram._backend_variable_value_True (build/cythonized/sage/numerical/mip.c:11789)\n        return self._backend_variable_value_ZZ(v, tolerance)\n      File \"sage/numerical/mip.pyx\", line 1441, in sage.numerical.mip.MixedIntegerLinearProgram._backend_variable_value_ZZ (build/cythonized/sage/numerical/mip.c:11278)\n        raise RuntimeError(f'variable {v} exceeds integrality tolerance {tolerance}')\n    RuntimeError: variable x_0 exceeds integrality tolerance 1e-06\n```\n",
    "created_at": "2022-03-13T04:56:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453347",
    "user": "@mkoeppe"
}
```

These failures indicate that the solver doesn't handle integer variables correctly.
Not sure if it's the new interface or if the CyLP/CBC backend in CVXPY that is not in good shape.

```
sage -t --random-seed=200293476130791194302620065212091883890 src/sage/graphs/comparability.pyx
**********************************************************************
File "src/sage/graphs/comparability.pyx", line 417, in sage.graphs.comparability.is_comparability_MILP
Failed example:
    is_comparability(graphs.CycleGraph(5), certificate = True)
Exception raised:
    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.10/lib/python3.10/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.comparability.is_comparability_MILP[1]>", line 1, in <module>
        is_comparability(graphs.CycleGraph(Integer(5)), certificate = True)
      File "sage/graphs/comparability.pyx", line 475, in sage.graphs.comparability.is_comparability_MILP (build/cythonized/sage/graphs/comparability.c:5404)
        o = p.get_values(o, convert=True, tolerance=tol)
      File "sage/numerical/mip.pyx", line 1770, in sage.numerical.mip.MixedIntegerLinearProgram.get_values (build/cythonized/sage/numerical/mip.c:12568)
        c[k] = get_backend_variable_value(v, tolerance)
      File "sage/numerical/mip.pyx", line 1523, in sage.numerical.mip.MixedIntegerLinearProgram._backend_variable_value_True (build/cythonized/sage/numerical/mip.c:11789)
        return self._backend_variable_value_ZZ(v, tolerance)
      File "sage/numerical/mip.pyx", line 1441, in sage.numerical.mip.MixedIntegerLinearProgram._backend_variable_value_ZZ (build/cythonized/sage/numerical/mip.c:11278)
        raise RuntimeError(f'variable {v} exceeds integrality tolerance {tolerance}')
    RuntimeError: variable x_0 exceeds integrality tolerance 1e-06
```




---

archive/issue_comments_453348.json:
```json
{
    "body": "I use patched `cvxpy/reductions/solvers/conic_solvers/cbc_conif.py` for `import mip` and I got\n\n```\nsage -t --random-seed=200293476130791194302620065212091883890 src/sage/graphs/comparability.pyx\n    [52 tests, 11.50 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\n```\n",
    "created_at": "2022-03-13T08:01:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453348",
    "user": "@sheerluck"
}
```

I use patched `cvxpy/reductions/solvers/conic_solvers/cbc_conif.py` for `import mip` and I got

```
sage -t --random-seed=200293476130791194302620065212091883890 src/sage/graphs/comparability.pyx
    [52 tests, 11.50 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```




---

archive/issue_comments_453349.json:
```json
{
    "body": "Attachment [cbc_conif.py.patch](tarball://root/attachments/some-uuid/ticket31962/cbc_conif.py.patch) by @sheerluck created at 2022-03-13 08:02:25",
    "created_at": "2022-03-13T08:02:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453349",
    "user": "@sheerluck"
}
```

Attachment [cbc_conif.py.patch](tarball://root/attachments/some-uuid/ticket31962/cbc_conif.py.patch) by @sheerluck created at 2022-03-13 08:02:25



---

archive/issue_comments_453350.json:
```json
{
    "body": "Any relation to https://pypi.org/project/mip-cvxpy/?",
    "created_at": "2022-03-13T17:35:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453350",
    "user": "@mkoeppe"
}
```

Any relation to https://pypi.org/project/mip-cvxpy/?



---

archive/issue_comments_453351.json:
```json
{
    "body": "yes, my patch is full copy of mip-cvxpy with class `class PYTHON_MIP` renamed:\n\n```\nsage: from cvxpy import installed_solvers; installed_solvers()\n['CBC', 'CVXOPT', 'DIFFCP', 'ECOS', 'ECOS_BB', 'GLPK', 'GLPK_MI', 'OSQP', 'SCIPY', 'SCS']\n```\n\nthat 'CBC' is actually 'PYTHON_MIP'",
    "created_at": "2022-03-13T18:19:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453351",
    "user": "@sheerluck"
}
```

yes, my patch is full copy of mip-cvxpy with class `class PYTHON_MIP` renamed:

```
sage: from cvxpy import installed_solvers; installed_solvers()
['CBC', 'CVXOPT', 'DIFFCP', 'ECOS', 'ECOS_BB', 'GLPK', 'GLPK_MI', 'OSQP', 'SCIPY', 'SCS']
```

that 'CBC' is actually 'PYTHON_MIP'



---

archive/issue_comments_453352.json:
```json
{
    "body": "I also tested with `default_mip_solver('CVXPY/GLPK_MI')`, which works fine. So the problem is definitely in the CyLP/CBC backend or even in CyLP itself.",
    "created_at": "2022-03-13T18:47:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453352",
    "user": "@mkoeppe"
}
```

I also tested with `default_mip_solver('CVXPY/GLPK_MI')`, which works fine. So the problem is definitely in the CyLP/CBC backend or even in CyLP itself.



---

archive/issue_comments_453353.json:
```json
{
    "body": "This appears to be https://github.com/coin-or/CyLP/issues/81 - integer infeasibility is not handled correctly in cylp (and not covered by their testsuite)",
    "created_at": "2022-03-13T19:33:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453353",
    "user": "@mkoeppe"
}
```

This appears to be https://github.com/coin-or/CyLP/issues/81 - integer infeasibility is not handled correctly in cylp (and not covered by their testsuite)



---

archive/issue_comments_453354.json:
```json
{
    "body": "Workaround: https://github.com/cvxpy/cvxpy/pull/1703",
    "created_at": "2022-03-13T20:07:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453354",
    "user": "@mkoeppe"
}
```

Workaround: https://github.com/cvxpy/cvxpy/pull/1703



---

archive/issue_comments_453355.json:
```json
{
    "body": "I was fighting with **python-mip** to get something like `model.setNumberThreads(ncpus())` from `coin_backend.pyx` and then I realized that `python-mip` does not use my fresh local `cbc`, it has its own old binary `mip/libraries/cbc-c-linux-x86-64.so` stored in github. And **CyLP** tells me his `CbcMain0` from `cylp/cpp/ICbcModel.cpp` is not compatible with my `CbcMain0` from `/usr/include/coin-or/CbcSolver.hpp`. So I guess I have to find myself another library :)",
    "created_at": "2022-03-13T20:58:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453355",
    "user": "@sheerluck"
}
```

I was fighting with **python-mip** to get something like `model.setNumberThreads(ncpus())` from `coin_backend.pyx` and then I realized that `python-mip` does not use my fresh local `cbc`, it has its own old binary `mip/libraries/cbc-c-linux-x86-64.so` stored in github. And **CyLP** tells me his `CbcMain0` from `cylp/cpp/ICbcModel.cpp` is not compatible with my `CbcMain0` from `/usr/include/coin-or/CbcSolver.hpp`. So I guess I have to find myself another library :)



---

archive/issue_comments_453356.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-13T21:25:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453356",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453357.json:
```json
{
    "body": "Replying to [comment:57 gh-sheerluck]:\n>  I realized that `python-mip` does not use my fresh local `cbc`\n\nI guess one needs to install it as `sage -pip install --no-binary :all: mip`",
    "created_at": "2022-03-13T21:27:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453357",
    "user": "@mkoeppe"
}
```

Replying to [comment:57 gh-sheerluck]:
>  I realized that `python-mip` does not use my fresh local `cbc`

I guess one needs to install it as `sage -pip install --no-binary :all: mip`



---

archive/issue_comments_453358.json:
```json
{
    "body": "Oh, I see, even the source tarball has these, and it can only be overridden using an environment variable. https://github.com/coin-or/python-mip/blob/master/mip/cbc.py#L63\n\nThat's of course highly problematic.",
    "created_at": "2022-03-13T21:40:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453358",
    "user": "@mkoeppe"
}
```

Oh, I see, even the source tarball has these, and it can only be overridden using an environment variable. https://github.com/coin-or/python-mip/blob/master/mip/cbc.py#L63

That's of course highly problematic.



---

archive/issue_comments_453359.json:
```json
{
    "body": "The build script for this vendored stuff are in https://github.com/coin-or/python-mip/tree/master/scripts",
    "created_at": "2022-03-13T21:43:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453359",
    "user": "@mkoeppe"
}
```

The build script for this vendored stuff are in https://github.com/coin-or/python-mip/tree/master/scripts



---

archive/issue_comments_453360.json:
```json
{
    "body": "So far `python-mip` is not present in major distributions, https://repology.org/project/python:mip/versions, so we cannot see how they would be dealing with this type of vendoring.",
    "created_at": "2022-03-13T22:39:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453360",
    "user": "@mkoeppe"
}
```

So far `python-mip` is not present in major distributions, https://repology.org/project/python:mip/versions, so we cannot see how they would be dealing with this type of vendoring.



---

archive/issue_comments_453361.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-14T03:19:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453361",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453362.json:
```json
{
    "body": "Replying to [comment:61 mkoeppe]:\n> The build script for this vendored stuff are in https://github.com/coin-or/python-mip/tree/master/scripts\nfor now I manually run \n\n```\ng++ -shared -fPIC -march=native -mtune=native -O3 \\\n -maes -mavx -mavx2 -mf16c -mfma -mmmx -mpclmul \\\n -mpopcnt -msse -msse2 -msse3 -msse4.1 -msse4.2 \\\n -o ./cbc-c-linux-x86-64.so \\\n -I/usr/include/coin-or \\\n -I/usr/include/coin/ThirdParty \\\n -DCBC_THREAD \\\n ./Cbc_C_Interface.cpp \\\n -L/usr/lib64 \\\n -lCbc -lpthread -lrt -lCgl \\\n -lOsiClp -lClp -lOsi -lCoinUtils \\\n -lgfortran -lquadmath -lm\n\nstrip ./cbc-c-linux-x86-64.so\n```\n\nThen I manually copy `./cbc-c-linux-x86-64.so` to `/usr/lib/python3.10/site-packages/mip/libraries`\n\nit's good enough for now. But `coin_backend.pyx` with `model.setNumberThreads(ncpus())` is way better... if it wasn't broken.",
    "created_at": "2022-03-14T08:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453362",
    "user": "@sheerluck"
}
```

Replying to [comment:61 mkoeppe]:
> The build script for this vendored stuff are in https://github.com/coin-or/python-mip/tree/master/scripts
for now I manually run 

```
g++ -shared -fPIC -march=native -mtune=native -O3 \
 -maes -mavx -mavx2 -mf16c -mfma -mmmx -mpclmul \
 -mpopcnt -msse -msse2 -msse3 -msse4.1 -msse4.2 \
 -o ./cbc-c-linux-x86-64.so \
 -I/usr/include/coin-or \
 -I/usr/include/coin/ThirdParty \
 -DCBC_THREAD \
 ./Cbc_C_Interface.cpp \
 -L/usr/lib64 \
 -lCbc -lpthread -lrt -lCgl \
 -lOsiClp -lClp -lOsi -lCoinUtils \
 -lgfortran -lquadmath -lm

strip ./cbc-c-linux-x86-64.so
```

Then I manually copy `./cbc-c-linux-x86-64.so` to `/usr/lib/python3.10/site-packages/mip/libraries`

it's good enough for now. But `coin_backend.pyx` with `model.setNumberThreads(ncpus())` is way better... if it wasn't broken.



---

archive/issue_comments_453363.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-14T22:23:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453363",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453364.json:
```json
{
    "body": "Back to using Cvxpy/cbc. \n\nThe remaining failures are from unimplemented `set_variable_type`",
    "created_at": "2022-03-14T22:25:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453364",
    "user": "@mkoeppe"
}
```

Back to using Cvxpy/cbc. 

The remaining failures are from unimplemented `set_variable_type`



---

archive/issue_comments_453365.json:
```json
{
    "body": "Replying to [comment:67 mkoeppe]:\n> The remaining failures are from unimplemented `set_variable_type`\n\nI've opened #33504 `sage.graphs`, `sage.numerical.mip`: Remove unnecessary uses of `set_binary`, `set_integer`.",
    "created_at": "2022-03-14T23:12:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453365",
    "user": "@mkoeppe"
}
```

Replying to [comment:67 mkoeppe]:
> The remaining failures are from unimplemented `set_variable_type`

I've opened #33504 `sage.graphs`, `sage.numerical.mip`: Remove unnecessary uses of `set_binary`, `set_integer`.



---

archive/issue_comments_453366.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-14T23:27:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453366",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453367.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-16T04:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453367",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453368.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-27T02:09:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453368",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453369.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-27T02:22:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453369",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_453370.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-03-27T02:24:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31725",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31725#issuecomment-453370",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:
