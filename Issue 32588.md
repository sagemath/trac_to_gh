# Issue 32588: pygraphviz fails to build

Issue created by migration from https://trac.sagemath.org/ticket/32825

Original creator: tmonteil

Original creation time: 2021-11-04 11:05:49

CC:  mkoeppe dcoudert

We got `pygraphviz/graphviz_wrap.c:2711:10: fatal error: graphviz/cgraph.h: No such file or directory`, see the log in attachment.


---

Attachment


---

Comment by dcoudert created at 2021-11-04 14:15:37

I tried `./sage -pip install pygraphviz` on a linux fedora desktop and it works fine.


---

Comment by mkoeppe created at 2021-11-04 15:52:47

More detail is needed here - on what kind of system; how was graphviz installed etc. Top-level config.log please


---

Comment by tmonteil created at 2021-11-04 16:04:17

The system is a standard Debian bullseye, architecture x86_64, graphviz was installed from the packages. I first saw the error on some VM, and could reproduce it on my laptop.


---

Attachment


---

Comment by tmonteil created at 2021-11-04 16:05:06

I attached the config.log.


---

Comment by mkoeppe created at 2021-11-04 19:21:39

There is a gap in our dependencies. 
The `graphviz` package only checks for executables in the system package test (`spkg-configure.m4`). But `pygraphviz` needs header files and presumably the shared library -- which on `debian` are in a separate system package https://packages.debian.org/bookworm/libgraphviz-dev

```
$ cat build/pkgs/graphviz/spkg-configure.m4 
SAGE_SPKG_CONFIGURE([graphviz], [
    dnl We check all executables that are tested by sage.features.graphviz
    AC_CHECK_PROGS([DOT], [dot])
    AS_IF([test x$DOT = x], [sage_spkg_install_graphviz=yes])
    AC_CHECK_PROGS([NEATO], [neato])
    AS_IF([test x$NEATO = x], [sage_spkg_install_graphviz=yes])
    AC_CHECK_PROGS([TWOPI], [twopi])
    AS_IF([test x$TWOPI = x], [sage_spkg_install_graphviz=yes])
])
$ cat build/pkgs/graphviz/distros/debian.txt 
graphviz
$ cat build/pkgs/pygraphviz/dependencies 
$(PYTHON) graphviz | $(PYTHON_TOOLCHAIN)
```


The solution is to add a dummy script package `libgraphviz` in the same way that it is done for `nauty`, `libnauty`.


---

Comment by tmonteil created at 2021-11-04 22:09:18

Replying to [comment:6 mkoeppe]:
> The solution is to add a dummy script package `libgraphviz` in the same way that it is done for `nauty`, `libnauty`.

This looks verbose, why not simply put both `graphviz` and `libgraphviz-dev` in the distro file of the `graphviz` spkg, as we do for `openssl` ?


---

Comment by mkoeppe created at 2021-11-04 22:11:51

because other uses of `graphviz` do not need the shared library


---

Comment by mkoeppe created at 2021-11-08 02:05:39

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-11-08 02:05:39

New commits:


---

Comment by mkoeppe created at 2021-11-08 02:06:05

Tested successfully with `tox -e docker-debian-bullseye-maximal -- pygraphviz`


---

Comment by dimpase created at 2021-11-23 16:30:16

lgtm


---

Comment by dimpase created at 2021-11-23 16:30:16

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-11-23 16:57:10

Thanks!


---

Comment by vbraun created at 2021-12-05 11:15:03

Resolution: fixed
