# Issue 29132: spkg-configure.m4 for brial

Issue created by migration from https://trac.sagemath.org/ticket/29369

Original creator: mjo

Original creation time: 2020-03-19 17:26:06

CC:  embray fbissey mkoeppe dimpase

Nothing unusual here except that this is a C++ library with no pkg-config file, and that makes it a bit harder to search for. I've assumed that any version we find is acceptable, which probably is not quite true.


---

Comment by mjo created at 2020-03-19 17:36:14

Changing status from new to needs_review.


---

Comment by mjo created at 2020-03-19 17:36:14

I left off the libpng dependency, because I think brial needs it if and only if mr4i does. I also left off the python dependency, but maybe I shouldn't have?
----
New commits:


---

Comment by fbissey created at 2020-03-19 19:03:13

This is a matter for another ticket but I think the python part should be merged into sage proper.
A bit of history.
PolyBoRi use to have its own python bindings. sage also had its own python bindings to PolyBoRi. The python part of PolyBoRI (now BRiAl) could work with either the PolyBoRI or sage bindings. In BRiAl we never bothered with porting the python bindings of PolyBoRi - they are not there anymore. I removed all bits that could have used the PolyBoRi bindings from what is now sage-brial in Gentoo. So at the moment
* Brial is needed to build sage because sage builds binding to brial
* sage-brial needs sage's binding at runtime to be usable
* sage needs sage-brial at run time for some stuff

I think sage-brial should just be merged in sage.


---

Comment by mkoeppe created at 2020-03-19 19:25:43

`build/pkgs/brial/distros/` needs filling


---

Comment by mkoeppe created at 2020-03-19 19:42:40

At the moment we cannot use python packages in the system python -- such as presumably the one of brial.
See #29023


---

Comment by mjo created at 2020-03-19 23:17:45

Changing status from needs_review to needs_work.


---

Comment by mjo created at 2020-03-19 23:17:45

Replying to [comment:2 fbissey]:
> This is a matter for another ticket but I think the python part should be merged into sage proper.

Ah, I didn't realize that sage's brial is installing TWO things, both the C++ library and a python package. I've only detected the C++ library, so this will have to wait until something happens with python -- either adding support for system python modules, or just moving sage-brial into sage in this case.

(I'm still running a ptestlong on this branch but presumably it will fail.)


---

Comment by dimpase created at 2020-03-20 04:23:15

a less invasive option that moving sage-brial into sage would be to split the package into two parts, python and non-python (they may use the same tarball). Then the work done here is perfectly useful for brial proper, and sage-brial becomes another story.


---

Comment by git created at 2020-03-26 13:02:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2020-03-26 13:08:48

Changing status from needs_work to needs_review.


---

Comment by mjo created at 2020-03-26 13:08:48

Replying to [comment:6 dimpase]:
> a less invasive option that moving sage-brial into sage would be to split the package into two parts, python and non-python (they may use the same tarball). Then the work done here is perfectly useful for brial proper, and sage-brial becomes another story.

Yeah, for now this is the path of least resistance (although the whole thing can probably be copy/pasted into src/sage/libs/brial). I factored the python module out into a new standard sage_brial package and now everything looks OK.


---

Comment by mkoeppe created at 2020-03-26 18:39:44

https://repology.org/project/brial/versions


---

Comment by mjo created at 2020-03-26 18:46:51

You can throw an upgrade on top of my commits if you want, I just didn't feel like adding more variables to this ticket (especially since my goal is to never again use the SPKG in the first place).


---

Comment by git created at 2020-03-26 19:13:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-26 19:25:18

Tests run at https://github.com/mkoeppe/sage/actions/runs/64055444


---

Comment by git created at 2020-03-26 20:51:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-26 21:18:21

Testing at ​https://github.com/mkoeppe/sage/actions/runs/64126739


---

Comment by dimpase created at 2020-03-27 02:35:13

OK, looks good. I'll wait for MacOS tests to finish.


---

Comment by mkoeppe created at 2020-03-27 04:02:53

better macOS tests scheduled here: https://github.com/mkoeppe/sage/actions/runs/64318155
(hopefully I fixed the broken parallelization of the build)


---

Comment by fbissey created at 2020-03-27 04:07:55

brial's build or sage's one?


---

Comment by dimpase created at 2020-03-27 04:13:42

I gather it's Sage's builds using brial from Homebrew


---

Comment by dimpase created at 2020-03-27 08:18:43

system brial needs m4ri and boost, yet

```
2020-03-27T06:01:37.8676320Z Checking whether SageMath should install SPKG brial...
2020-03-27T06:01:37.8715050Z checking whether any of boost m4ri is installed as or will be installed as SPKG... yes; install brial as well
2020-03-27T06:01:37.8715730Z configure: no suitable system package found for SPKG brial
```


and then the build dies on pynac (not surprisingly)

The problem is in m4ri

```
2020-03-27T06:01:37.8106410Z Checking whether SageMath should install SPKG m4ri...
2020-03-27T06:01:37.8144280Z checking whether any of libpng is installed as or will be installed as SPKG... no
2020-03-27T06:01:37.8422490Z checking for m4ri >= 20140914... no
2020-03-27T06:01:37.8673980Z configure: no suitable system package found for SPKG m4ri
```


there is a non-standard location formula/installation availabe:

https://github.com/brewsci/homebrew-science/blob/master/Formula/m4ri.rb


---

Comment by dimpase created at 2020-03-27 08:26:49

let's merge this, and fix for MacOS/Cygwin, if/as needed.


---

Comment by dimpase created at 2020-03-27 08:26:49

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-03-27 13:12:41

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2020-03-27 13:12:41

Because it depends on m4ri and we only accept very new versions of that, this only uses brial on very few system configurations.
`ubuntu-eoan-python2` (https://github.com/mkoeppe/sage/runs/537774470), `ubuntu-focal` (https://github.com/mkoeppe/sage/runs/537774488) and `archlinux-latest-standard` (https://github.com/mkoeppe/sage/runs/537774841) work well.
The test failures on `debian-bullseye-standard` (https://github.com/mkoeppe/sage/runs/537774574) are probably unrelated.

There's no brial package for homebrew, so there's nothing to test.

But it does not find brial on `fedora-31-standard` (https://github.com/mkoeppe/sage/runs/537774738). Please take a look


---

Comment by mkoeppe created at 2020-03-27 13:14:49

Replying to [comment:21 dimpase]:
> there is a non-standard location formula/installation availabe:
> 
> https://github.com/brewsci/homebrew-science/blob/master/Formula/m4ri.rb

https://github.com/brewsci/homebrew-science is unmaintained. Let's not use it.


---

Comment by mjo created at 2020-03-27 13:54:03

Replying to [comment:23 mkoeppe]:
> 
> But it does not find brial on `fedora-31-standard` (https://github.com/mkoeppe/sage/runs/537774738). Please take a look
> 

Is brial-devel installed there?


---

Comment by git created at 2020-03-27 14:29:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-27 14:35:22

Another round of tests at https://github.com/mkoeppe/sage/actions/runs/64668026


---

Comment by mkoeppe created at 2020-03-27 19:09:26

fedora-28-standard (https://github.com/mkoeppe/sage/runs/539636819):

```
  [sagelib-9.1.beta8]   build/cythonized/sage/rings/polynomial/pbori.cpp:60026:55: error: use of deleted function ‘polybori::BooleConstant& polybori::BooleConstant::operator=(polybori::BooleConstant&&)’
  [sagelib-9.1.beta8]      __pyx_v_self->_pbconst = BooleConstant(__pyx_v_value);
  [sagelib-9.1.beta8]                                                          ^
  [sagelib-9.1.beta8]   In file included from /usr/include/polybori/BoolePolynomial.h:42,
  [sagelib-9.1.beta8]                    from /sage/src/sage/libs/polybori/pb_wrap.h:1,
  [sagelib-9.1.beta8]                    from build/cythonized/sage/rings/polynomial/pbori.cpp:684:
  [sagelib-9.1.beta8]   /usr/include/polybori/BooleConstant.h:40:7: note: ‘polybori::BooleConstant& polybori::BooleConstant::operator=(polybori::BooleConstant&&)’ is implicitly deleted because the default definition would be ill-formed:
  [sagelib-9.1.beta8]    class BooleConstant:
  [sagelib-9.1.beta8]          ^~~~~~~~~~~~~
  [sagelib-9.1.beta8]   /usr/include/polybori/BooleConstant.h:40:7: error: non-static const member ‘const bool polybori::BooleConstant::m_value’, can’t use default assignment operator
  [sagelib-9.1.beta8]   error: command 'gcc' failed with exit status 1
```



---

Comment by mjo created at 2020-03-27 20:09:34

Replying to [comment:28 mkoeppe]:
> fedora-28-standard (https://github.com/mkoeppe/sage/runs/539636819):
> {{{
>   [sagelib-9.1.beta8]   build/cythonized/sage/rings/polynomial/pbori.cpp:60026:55: error: use of deleted function ‘polybori::BooleConstant& polybori::BooleConstant::operator=(polybori::BooleConstant&&)’
> ...
>   [sagelib-9.1.beta8]   error: command 'gcc' failed with exit status 1
> }}}

See, this is why I became a mathematician...


---

Comment by mkoeppe created at 2020-03-27 20:14:06

Right, for the endless fun with other mathematicians' software...


---

Comment by mjo created at 2020-03-28 00:53:36

This one rejects brial-0.8.5.
----
New commits:


---

Comment by mjo created at 2020-03-28 00:53:36

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2020-03-28 00:58:51

And I am physicist, which would make me the practical one - except I do more theoretical physics, so some people would say I am a mathematician with the wrong clothes. So, would something upstream make your job easier? Like a .pc file :)

I am upstream's maintainer after all. Pull requests welcome.


---

Comment by mjo created at 2020-03-28 01:05:30

Replying to [comment:32 fbissey]:
> And I am physicist, which would make me the practical one - except I do more theoretical physics, so some people would say I am a mathematician with the wrong clothes. So, would something upstream make your job easier? Like a .pc file :)
> 
> I am upstream's maintainer after all. Pull requests welcome.

A `.pc` file will be invaluable the next time around, but here we need to detect the versions that have already shipped. I probably should have asked for help writing the test program, but it didn't look that hard until it was too late =)


---

Comment by mkoeppe created at 2020-03-28 03:38:44

Tests run at https://github.com/mkoeppe/sage/actions/runs/65083365


---

Comment by mkoeppe created at 2020-03-28 16:11:53

New tests at https://github.com/mkoeppe/sage/actions/runs/65346154


---

Comment by mkoeppe created at 2020-03-29 12:39:46

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-04-05 08:30:35

Resolution: fixed


---

Comment by mkoeppe created at 2020-04-09 17:11:37

Follow-up: I see crashes in running doctests on `fedora-30-standard` (https://github.com/mkoeppe/sage/runs/572856797), which uses system brial 1.2.5-1


```
sage -t src/sage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to abort
sage -t src/sage/rings/polynomial/pbori.pyx  # Killed due to abort
sage -t src/sage/rings/polynomial/polynomial_ring_constructor.py  # Killed due to abort
sage -t src/sage/sat/boolean_polynomials.py  # Killed due to abort
sage -t src/sage/sat/solvers/dimacs.py  # Killed due to abort
```



---

Comment by mkoeppe created at 2020-04-09 21:56:26

This is now #29490


---

Comment by dimpase created at 2020-04-28 02:43:28

Set assignee to mjo.


---

Comment by dimpase created at 2020-04-28 03:10:14

In src/module_list.py there is 

```
Extension('sage.rings.polynomial.pbori',
...
      depends = [SAGE_INC + "/polybori/" + hd + ".h" for hd in ["polybori", "config"]],
      extra_compile_args = m4ri_extra_compile_args),
```

which causes constant rebuilds with system package, as these headers are no longer in `SAGE_INC`. It's a minor annoyance, but still.


---

Comment by mkoeppe created at 2020-08-11 00:16:52

Replying to [comment:2 fbissey]:
> This is a matter for another ticket but I think the python part should be merged into sage proper.
> [....] So at the moment
> * Brial is needed to build sage because sage builds binding to brial
> * sage-brial needs sage's binding at runtime to be usable
> * sage needs sage-brial at run time for some stuff
> 
> I think sage-brial should just be merged in sage.

This is now #30332
