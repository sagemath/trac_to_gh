# Issue 22112: Graph.vertices() should not sort by default

Issue created by migration from https://trac.sagemath.org/ticket/22349

Original creator: jdemeyer

Original creation time: 2017-02-10 16:07:32

CC:  stefan jmantysalo jhpalmieri

Why does `Graph.vertices()` need to _sort_ the list of vertices?


---

Comment by git created at 2017-02-10 17:28:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dcoudert created at 2017-02-11 10:36:38

What you propose to do is not an easy task. I suspect that many algorithms assume that the vertices are sorted. For sure, many algorithms assume that the ordering is always the same when calling `vertices()` and `vertex_iterator()`, so I hope that what you propose preserves this strong assumption.

Is your long term plan to remove parameter `sort` from the methods or just to set its default value to false ?
I don't know the potential problems of sorting with Python 3, so I'm not sure of the motivation.

Many many tests are broken

```
sage -t src/sage/graphs/generic_graph.py  # 45 doctests failed
sage -t src/sage/graphs/generators/smallgraphs.py  # 4 doctests failed
sage -t src/sage/graphs/strongly_regular_db.pyx  # 1 doctest failed
sage -t src/sage/graphs/graph.py  # 11 doctests failed
sage -t src/sage/graphs/base/static_sparse_graph.pyx  # 1 doctest failed
sage -t src/sage/graphs/generators/families.py  # 3 doctests failed
sage -t src/sage/graphs/digraph.py  # 10 doctests failed
sage -t src/sage/graphs/digraph_generators.py  # 3 doctests failed
sage -t src/sage/graphs/base/graph_backends.pyx  # 2 doctests failed
sage -t src/sage/graphs/generic_graph_pyx.pyx  # 3 doctests failed
sage -t src/sage/graphs/comparability.pyx  # 1 doctest failed
sage -t src/sage/graphs/bipartite_graph.py  # 3 doctests failed
sage -t src/sage/graphs/base/c_graph.pyx  # 1 doctest failed
sage -t src/sage/graphs/graph_decompositions/vertex_separation.pyx  # 4 doctests failed
sage -t src/sage/graphs/schnyder.py  # 1 doctest failed
sage -t src/sage/graphs/line_graph.py  # 3 doctests failed
sage -t src/sage/graphs/isgci.py  # 1 doctest failed
sage -t src/sage/graphs/graph_decompositions/graph_products.pyx  # 1 doctest failed
sage -t src/sage/quivers/path_semigroup.py  # 3 doctests failed
sage -t src/sage/groups/perm_gps/partn_ref/refinement_graphs.pyx  # 1 doctest failed
```


for instance (random copy/paste)

```
File "src/sage/graphs/line_graph.py", line 466, in sage.graphs.line_graph.root_graph
Failed example:
    root_graph(graphs.DiamondGraph())
Expected:
    (Graph on 4 vertices, {0: (0, 3), 1: (0, 1), 2: (0, 2), 3: (1, 2)})
Got:
    (Graph on 4 vertices, {0: (1, 2), 1: (0, 1), 2: (0, 2), 3: (0, 3)})
**********************************************************************
File "src/sage/graphs/base/graph_backends.pyx", line 802, in sage.graphs.base.graph_backends.NetworkXGraphDeprecated.mutate
Failed example:
    G.edges(sort=False)
Exception raised:
    Traceback (most recent call last):
      File "/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.base.graph_backends.NetworkXGraphDeprecated.mutate[5]>", line 1, in <module>
        G.edges(sort=False)
    TypeError: edges() got an unexpected keyword argument 'sort'
**********************************************************************
File "src/sage/graphs/digraph.py", line 3424, in sage.graphs.digraph.DiGraph.flow_polytope
Failed example:
    fl.vertices(sort=False)
Exception raised:
    Traceback (most recent call last):
      File "/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.digraph.DiGraph.flow_polytope[19]>", line 1, in <module>
        fl.vertices(sort=False)
    TypeError: __call__() got an unexpected keyword argument 'sort'
**********************************************************************
File "src/sage/graphs/generic_graph.py", line 20558, in sage.graphs.generic_graph.GenericGraph.?
Failed example:
    d.automorphism_group(algorithm='sage')
Expected:
    Permutation Group with generators [('01','02')('10','20')('11','22')('12','21')]
Got:
    Permutation Group with generators [()]
**********************************************************************
File "src/sage/graphs/generic_graph.py", line 20197, in sage.graphs.generic_graph.GenericGraph.degree_to_cell
Failed example:
    G.degree_to_cell('111', cell)
Expected:
    0
Got:
    1
```



---

Comment by jdemeyer created at 2017-02-11 13:22:50

Replying to [comment:9 dcoudert]:
> What you propose to do is not an easy task.

I never claimed that it was easy. But it has to be done in order to support Python 3.

> For sure, many algorithms assume that the ordering is always the same when calling `vertices()` and `vertex_iterator()`, so I hope that what you propose preserves this strong assumption.

It should remain the same, yes.

> Is your long term plan to remove parameter `sort` from the methods or just to set its default value to false ?

I don't care much. I guess once the default is `False`, there will be little reason left to keep the `sort` keyword.

> I don't know the potential problems of sorting with Python 3, so I'm not sure of the motivation.

The problem is that you cannot sort arbitrary things in Python 3. For example:

```
>>> sorted([1, "hello"])
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
TypeError: unorderable types: str() < int()
```



---

Comment by dcoudert created at 2017-02-11 15:10:56

Now I understand the need for this big change.

Is there a way to sort arbitrary things in Python 3 ? some trick ?


---

Comment by jdemeyer created at 2017-02-11 15:35:33

Replying to [comment:11 dcoudert]:
> Is there a way to sort arbitrary things in Python 3 ?

Of course there is. The question is: what would you expect from such "arbitrary" sorting?

And if it's arbitrary anyway: why would you want to "sort" in the first place?


---

Comment by mmezzarobba created at 2017-02-14 18:53:15

As far as I understand, there are at least two different issues here:
* some algorithms want a consistent and easy to test order on the vertices, typically (but probably not only) to loop over the unordered pairs of vertices normalized by putting the smalled vertex first;
* in interactive use, when there is a natural order on the vertices (in practice, mostly when they are integers, strings, or possibly nested tuples of such things), _people_ want to see the vertices, edges, etc. listed in an order that makes the output easy to read, and it would be a significant regression to take that away from them.

Additionally, it may well be the case that some algorithms also rely on vertices of a certain type (say tuples of integers) automatically coming out sorted in a particular order, I'm not sure.


---

Comment by git created at 2017-02-15 08:36:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by nbruin created at 2017-11-06 11:06:01

Replying to [comment:11 dcoudert]:
> Now I understand the need for this big change.
> 
> Is there a way to sort arbitrary things in Python 3 ? some trick ?

one way is

>>> sorted( ..., key=str )

You could of course use another key function that uses some sorting heuristic (something like the key function used by https://pypi.python.org/pypi/natsort)

Display functions in IPython have hooks for nice sorting (used for dicts and sets), so if graphs need to display their keys and edges in a nice way, that's probably the hook to go for.

Algorithms that need their edges sorted should either insist on sortable labels or sort by index tuples or something like that (something that is guaranteed to be sortable regardless of what the user decides to use as labels).


---

Comment by jdemeyer created at 2017-11-06 12:02:41

Replying to [comment:13 mmezzarobba]:
> * in interactive use, when there is a natural order on the vertices (in practice, mostly when they are integers, strings, or possibly nested tuples of such things), _people_ want to see the vertices, edges, etc. listed in an order that makes the output easy to read, and it would be a significant regression to take that away from them.

In that case, the best solution is probably to use a custom class for this. It would behave exactly like a Python `list` (or `tuple`) in all possible ways, except that it would be sorted on display.


---

Comment by jdemeyer created at 2017-11-06 12:28:40

Replying to [comment:17 nbruin]:
> Display functions in IPython have hooks for nice sorting (used for dicts and sets), so if graphs need to display their keys and edges in a nice way, that's probably the hook to go for.

Nils, I only just saw your comment now. But yes, this was exactly my point too.


---

Comment by mmezzarobba created at 2017-11-06 12:37:52

Replying to [comment:17 nbruin]:
> Algorithms that need their edges sorted should either insist on sortable labels or sort by index tuples or something like that (something that is guaranteed to be sortable regardless of what the user decides to use as labels). 

They could simply sort by `id()`, provided that the same label is not represented by several physically distinct objects that compare equal. Unfortunately, this probably does happen (see #22374).


---

Comment by jdemeyer created at 2017-11-06 12:43:02

Replying to [comment:20 mmezzarobba]:
> They could simply sort by `id()`

If you want to sort by `id()`, what is the purpose of sorting at all? I mean, it's not sorting, it's putting in a deterministic (but otherwise arbitrary) order. Assuming that methods like `vertices()` return the vertices in a deterministic order, I don't see the point.


---

Comment by mmezzarobba created at 2017-11-06 13:02:42

Replying to [comment:21 jdemeyer]:
> Replying to [comment:20 mmezzarobba]:
> > They could simply sort by `id()`
> 
> If you want to sort by `id()`, what is the purpose of sorting at all? I mean, it's not sorting, it's putting in a deterministic (but otherwise arbitrary) order. Assuming that methods like `vertices()` return the vertices in a deterministic order, I don't see the point.

All I'm saying is that some algorithms do want to access the vertices in some arbitrary deterministic order, typically in order to iterate over the unordered pairs {v,v'}, and, as far as I remember, currently rely on the output of `vertices()` etc. being sorted to do that. If all the methods these algorithms use to access the vertices return them in the same deterministic order, then indeed, there is no need to do anything, otherwise, sorting by `id()` may be a better option than requiring the labels to be ordered.


---

Comment by jdemeyer created at 2018-03-29 12:51:14

Changing keywords from "" to "richcmp".


---

Comment by chapoton created at 2018-07-11 15:22:35

Changing keywords from "richcmp" to "python3, richcmp".


---

Comment by dcoudert created at 2018-08-31 16:35:03

Apart from the need for ensuring that the internal order of vertices/edges during iterations is always the same (many algorithms assume that we have such a fixed order, whatever it is) and doing our best to preserve a nice display for interactive use, I think we have another issue:
- For an edge `(u, v, label)` in an undirected graph, we usually have `u <= v`. So somehow we have a sorting here and many algorithms assume that vertices are ordered (not all). If I understand well, it is a problem with Python3 if vertex labels are of different types. We must find a solution for that.
- In many algorithms, we have tests like `if u < v`. Again a big problem.
So what can we do ?

The only good news here is that vertices must be immutable.


---

Comment by dcoudert created at 2018-09-01 09:30:10

#26169 Trial for not sorting multiple edges


---

Comment by jdemeyer created at 2019-01-07 08:46:49

Do we already have a plan for this ticket? I know that there have many graph-related Python 3 tickets, but I'm a bit lost on the overall plan.


---

Comment by jdemeyer created at 2019-01-07 08:48:02

I am asking because there are now only a handful of doctest failures remaining in #22029 and they are almost all due to sorting in graphs.


---

Comment by dcoudert created at 2019-01-07 08:59:21

There are 3 different points here: 1) sorting the list of vertices, 2) sorting the list of edges, and 3) sorting the vertices of an edge.

For 1), we made huge progresses in reducing the dependency of methods to `.vertices()`. I'm not sure how many methods still rely on it. Most of them now use the ordering given by  `list(G)` without making specific assumption on that order. We create a mapping when needed, and pass it to some methods. We can certainly completely avoid that dependency, but can we do that without deprecation ? 

For 2), similarly, we have reduced the number of methods relying on `.edges()`, plus we can use `sort=False` parameter. We can try and see...

3) is more tricky and I don't know how to do that yet.


---

Comment by jdemeyer created at 2019-01-07 09:23:06

For 1) there is still an issue with `relabel()`: #27027


---

Comment by jdemeyer created at 2019-01-07 15:55:27

And one more with `graph_isom_equivalent_non_edge_labeled_graph()`: #27029


---

Comment by dcoudert created at 2019-02-23 10:34:18

We have now drastically reduced the dependency to `.vertices()` and `.edges()` in the graph module (except in doctests, but we can specify `sort=True` or just change the expected output). 
We must now identify the remaining tasks to do and schedule the work. I propose to do that in #26640 to get a full picture.


---

Comment by jdemeyer created at 2019-02-24 13:16:26

Here is a concrete proposal for this ticket:

1. If no `sort` option is given (the default), give a deprecation and try to sort but fail gracefully if the input is not sortable.

2. If a `sort` option is given, do as before.


---

Comment by jdemeyer created at 2019-02-24 13:17:21

I also like the idea that somebody posted on sage-devel (I don't remember who) that `.vertices()` and `.edges()` should return a "view" which could have various operations on it.


---

Comment by dcoudert created at 2019-02-24 13:54:13

It's Thierry ([this message](https://groups.google.com/d/msg/sage-devel/uEHBKekJ_Cw/peoyx4PaBQAJ)). I also like this idea. Should we do that here, before in another ticket, or later ?


Networkx now also use views [networkx.Graph.edges](https://networkx.github.io/documentation/latest/reference/classes/generated/networkx.Graph.edges.html#networkx.Graph.edges).


---

Comment by dcoudert created at 2019-03-03 21:21:11

A proposal for an `EdgeView` in #27408.


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by embray created at 2019-06-14 14:54:19

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).


---

Comment by dcoudert created at 2020-04-18 10:16:26

Now that we have EdgesView #27408 and Python3, we have few remaining methods methods effectively relying on the order of the vertices and/or edges. So we should restart working on this ticket for 9.2.


---

Comment by dcoudert created at 2020-07-15 12:05:42

With #30145, we propose to deprecate `edge_iterator`, thus generalizing the use of `.edges` method and so of `EdgesView`. After that, it should be easier to deprecate sorting edges by default.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by dcoudert created at 2022-03-10 15:55:12

Actually, #27408 has silently (not mentioned in the ticket) introduced a deprecation warning for sorting edges by default, but it is used in method `.edges(...)` only when `sort is None` and the default value of `sort` is `True`. So I think no-one is aware of it.

I'm not sure how to make this deprecation warning visible without breaking numerous doctests.


---

Comment by alexjbest created at 2022-06-28 12:51:51

Replying to [comment:52 dcoudert]:
> Actually, #27408 has silently (not mentioned in the ticket) introduced a deprecation warning for sorting edges by default, but it is used in method `.edges(...)` only when `sort is None` and the default value of `sort` is `True`. So I think no-one is aware of it.
> 
> I'm not sure how to make this deprecation warning visible without breaking numerous doctests.

I'd be interested in seeing this ticket resolved, perhaps you could ask about how to go about this deprecation on sage-devel? Or I am happy to follow this up if you'd prefer.


---

Comment by dcoudert created at 2022-06-28 13:58:50

The difficulty is that we still have some methods relying on `.vertices()`, and I don't know how to avoid that.

For instance in `graph.py`: `effective_resistance_matrix`, `common_neighbors_matrix`, `orientations` (but this one can be avoided easily), `chromatic_quasisymmetric_function`, `twograph`, `write_to_eps`. And there might be other modules using graphs and relying on the ordering of the vertices given by `.vertices()` (e.g., `combinat`, `geometry`, `groups`, `matroids`, `schemes`, `topology`, etc..

So the first step might be to identify methods/modules relying on `.vertices()` and try to modify them. Once done, we will be able to safely deprecate sorting by default.


---

Comment by jhpalmieri created at 2022-06-28 22:05:16

The `.vertices()` method is probably used lots of times, but one fix could be:

- every time it's used, add the argument `sort=False` or `sort=True` as necessary,
- and then change the default to `sort=False`.

Maybe it's easier with edges: add the explicit argument everywhere and then change the default to `None`.

Or is that too naïve? I tried this change:

```diff
diff --git a/src/sage/graphs/graph.py b/src/sage/graphs/graph.py
index 1579f23ad8..5dbb937b6b 100644
--- a/src/sage/graphs/graph.py
+++ b/src/sage/graphs/graph.py
@@ -3480,7 +3480,7 @@ class Graph(GenericGraph):
             name = 'An orientation of ' + name
 
         if not self.size():
-            D = DiGraph(data=[self.vertices(), []],
+            D = DiGraph(data=[self.vertices(sort=False), []],
                         format='vertices_and_edges',
                         name=name,
                         pos=self._pos,
@@ -3494,7 +3494,7 @@ class Graph(GenericGraph):
 
         E = [[(u,v,label), (v,u,label)] if u != v else [(u,v,label)]
              for u,v,label in self.edge_iterator()]
-        verts = self.vertices()
+        verts = self.vertices(sort=False)
         for edges in itertools.product(*E):
             D = DiGraph(data=[verts, edges],
                         format='vertices_and_edges',
@@ -4009,7 +4009,7 @@ class Graph(GenericGraph):
             R = t.parent()
         M = QuasiSymmetricFunctions(R).M()
         ret = M.zero()
-        V = self.vertices()
+        V = self.vertices(sort=False)
 
         def asc(sigma):
             stat = 0
@@ -6185,7 +6185,7 @@ class Graph(GenericGraph):
                 T.append([x, y, z])
 
         T = TwoGraph(T)
-        T.relabel({i: v for i,v in enumerate(self.vertices())})
+        T.relabel({i: v for i,v in enumerate(self.vertices(sort=False))})
 
         return T
 
@@ -6221,7 +6221,7 @@ class Graph(GenericGraph):
         if filename[-4:] != '.eps':
             filename += '.eps'
         f = open(filename, 'w')
-        f.write( print_graph_eps(self.vertices(), self.edge_iterator(), pos) )
+        f.write( print_graph_eps(self.vertices(sort=False), self.edge_iterator(), pos) )
         f.close()
 
     @doc_index("Algorithmically hard stuff")
@@ -7940,7 +7940,7 @@ class Graph(GenericGraph):
             D = None
         elif self.order() == 1:
             D = create_prime_node()
-            D.children.append(create_normal_node(self.vertices()[0]))
+            D.children.append(create_normal_node(self.vertices(sort=False)[0]))
         else:
             D = habib_maurer_algorithm(self)
 
@@ -9225,7 +9225,7 @@ class Graph(GenericGraph):
         if not n:
             raise ValueError('unable to compute effective resistance for an empty Graph object')
         if vertices is None:
-            vertices = self.vertices()
+            vertices = self.vertices(sort=False)
         self._scream_if_not_simple()
         if not self.is_connected():
             raise ValueError('the Graph is not a connected graph')
@@ -9458,7 +9458,7 @@ class Graph(GenericGraph):
         """
         self._scream_if_not_simple()
         if vertices is None:
-            vertices = self.vertices()
+            vertices = self.vertices(sort=False)
         set_immutable = kwds.pop('immutable', False)
         A = self.adjacency_matrix(vertices=vertices, base_ring=base_ring, immutable=True, **kwds)
         M = A**2
```

and all tests in the graphs directory still passed.


---

Comment by dcoudert created at 2022-06-29 06:15:24

We cannot blindly use `.vertices(sort=False)`. It will clearly break badly some methods, for instance methods building adjacency or laplacian matrices, etc.
We already pave the way by reducing the number of situations in which we call `.vertices()`, but we still have work to do to reduce the dependency. We did the same for `.edges()`.

The safe way is to use only `.vertices(sort=True)`, and whenever possible, avoid calls to `.vertices()`. For instance, I see in `generic_graph.py` a call to `self.vertices(sort=False)[0]` while we have `self.order() == 1`. So we can avoid this call.

Then, we can set the default to `None` with a deprecation warning that the default will be changed to `False`.


---

Comment by jhpalmieri created at 2022-06-30 04:47:26

Replying to [comment:57 dcoudert]:
> We cannot blindly use `.vertices(sort=False)`.

That's not what I suggested. Please reread the first bullet point.


---

Comment by dcoudert created at 2022-06-30 09:43:31

Right, I missed some parts.
I agree with your proposal, but we need an appropriate deprecation warning to inform users of the change. It's a big change.


---

Comment by jhpalmieri created at 2022-07-15 21:19:25

The best I can think of right now is:

- Make the default `sort=None` and raise a deprecation warning if this default gets used, thereby requiring an explicit argument everywhere in the Sage library.

- So use `sort=False` or `sort=True` as appropriate in the library.

Then later we can change the default to `sort=False`.


---

Comment by jhpalmieri created at 2022-07-16 01:51:45

Here is a start. This does what I proposed in comment:60, and all tests pass. I was not that careful in choosing `sort=True` or `sort=False`, and so I would not surprised if we could use `sort=False` in more places. Feel free to modify the branch.
----
New commits:


---

Comment by jhpalmieri created at 2022-07-16 01:56:58

The key changes are in `graphs/generic_graph.py`:

```diff
@@ -10972,15 +10974,20 @@ class GenericGraph(GenericGraph_pyx):
         for u in self._backend.iterator_nbrs(vertex):
             yield u
 
-    def vertices(self, sort=True, key=None, degree=None, vertex_property=None):
+    def vertices(self, sort=None, key=None, degree=None, vertex_property=None):
         r"""
         Return a list of the vertices.
 
         INPUT:
 
-        - ``sort`` -- boolean (default: ``True``); if ``True``, vertices are
+        - ``sort`` -- boolean (default: ``None``); if ``True``, vertices are
           sorted according to the default ordering
 
+          As of :trac:`22349`, this argument must be explicitly
+          specified (unless a ``key`` is given); otherwise a warning
+          is printed and ``sort=True`` is used. The default will
+          eventually be changed to ``False``.
+
         - ``key`` -- a function (default: ``None``); a function that takes a
           vertex as its one argument and returns a value that can be used for
           comparisons in the sorting algorithm (we must have ``sort=True``)
```

and

```diff
@@ -11065,9 +11072,23 @@ class GenericGraph(GenericGraph_pyx):
             Traceback (most recent call last):
             ...
             ValueError: sort keyword is False, yet a key function is given
+
+        Deprecation warning for ``sort=None`` (:trac:`22349`)::
+
+            sage: G = graphs.HouseGraph()
+            sage: G.vertices()
+            doctest:...: DeprecationWarning: parameter 'sort' will be set to False by default in the future
+            See http://trac.sagemath.org/22349 for details.
+            [0, 1, 2, 3, 4]
         """
+        if sort is None:
+            if key is None:
+                deprecation(22349, "parameter 'sort' will be set to False by default in the future")
+            sort = True
+
         if (not sort) and key:
             raise ValueError('sort keyword is False, yet a key function is given')
+
         if sort:
             return sorted(self.vertex_iterator(degree=degree, vertex_property=vertex_property), key=key)
         return list(self.vertex_iterator(degree=degree, vertex_property=vertex_property))
```

and similar for `edges` (although `edges` already printed a warning if `None` was used, but `None` was not the default, so it had to be called explicitly as `g.edges(sort=None)` to trigger the warning before).


---

Comment by dcoudert created at 2022-07-16 18:12:29

I'm impressed !

I'm currently doing some tests and will push later some corrections.


---

Comment by dcoudert created at 2022-07-17 09:12:53

I did a few changes in graphs and many tests. I have not detected any problem yet, but others may raise some issues.

This ticket highlights many places were the usage of graphs must be improved. I did some (minor) corrections in `src/sage/schemes/curves/zariski_vankampen.py` as example, but more can be done in this file.
Typically, it is better to use `for u in G:` than `for u in G.vertices(sort=False):`. The ordering of the vertices is the same, but we avoid building the list of vertices. Tests like `u in G.vertices(sort=False)` should be replaced by `u in G`. etc.
In future tickets, we should address (very bad) code like this in `src/sage/geometry/hyperplane_arrangement/library.py`

```diff
-        for e in G.edges():
-            i = G.vertices().index(e[0])
-            j = G.vertices().index(e[1])
+        for e in G.edges(sort=True):
+            i = G.vertices(sort=True).index(e[0])
+            j = G.vertices(sort=True).index(e[1])
```

Clearly, we need to define a mapping from vertices to index.

----
New commits:


---

Comment by dcoudert created at 2022-07-17 09:19:09

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2022-07-17 16:19:54

Great! I'm happy with your changes. We can try to get it merged soon, although with this many files affected, there might very well be merge conflicts.


---

Comment by jhpalmieri created at 2022-07-17 16:19:54

Changing priority from major to critical.


---

Comment by jhpalmieri created at 2022-07-17 16:21:35

Positive review from me for your contributions.


---

Comment by dcoudert created at 2022-07-17 16:23:56

We will certainly get merge conflicts (due to the many tickets improving the coding style for instance), but let's try.

Positive review from me too.


---

Comment by dcoudert created at 2022-07-17 16:23:56

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-07-18 19:48:47

Merge failure on top of:

83a3df1c99 Trac #34131: some doc polishing in symbolic

dee5229b00 Trac #34130: some doc polishing in groups

fd80fa111f Trac #34126: some doc polishing in categories

718d356f1c Trac #34125: some doc polishing in modular

49390d8bcf Trac #34124: some doc polishing in combinat

af94c25b54 Trac #34096: Fix typo: enviroment -> environment

d04c189c8e Trac #34050: add some space around == in paths and rational

1634bb6946 Trac #34047: Typo in _repr_Expression in symbolic/expression.pyx

dc8086fd57 Trac #34154: Fix repeated word typos

17b1c177aa Trac #34148: fix and activate pycodestyle E306

785bdbd0ec Trac #34136: modernize super() in rings (part one)

9882001355 Trac #34129: Dummy packages should write proper log files

dbc6b9e161 Trac #34109: pep8 for sagedoc.py

5e6a3318c8 Trac #34103: randomize infinite recursion

17ba76f00b Trac #34093: Wrong evaluation of elements of CBF[x] on polynomials from other rings

4657052737 Trac #34122: Bug in is_planar() method for directed graphs

c9cfb5395f Trac #34087: inverse reciprocal trig functions not (back)translated to/from Mathematica

1d6d055563 Trac #34076: pycodestyle cleanup in src/sage/graphs/genus.pyx

043d862b5d Trac #34071: pycodestyle cleanup in asteroidal_triples.pyx, chrompoly.pyx, cliquer.pyx, convexity_properties.pyx

b9b25dc735 Trac #34070: pycodestyle cleanup in src/sage/graphs/centrality.pyx

4ef2c6597d Trac #34069: pycodestyle cleanup in src/sage/graphs/comparability.pyx

5b1146766b Trac #34066: Tachyon help message

798adaa5a3 Trac #34065: pycodestyle cleanup in src/sage/graphs/bliss.pyx

ce62be23a2 Trac #34063: pycodestyle cleanup in src/sage/graphs/base/

a0eadb3e40 Trac #34059: Fix trivial case in conversion of list to number field element

fea0ac50a6 Trac #34057: changes about avoiding double dieses

9eefd5c27e Trac #34145: modernize super in geometry/

01e117dfd8 Trac #34137: modernize super in categories/

6c79334402 Trac #33819: build.yml: In workflow_dispatch, make container and base tag selectable; add doc

6a64ab8d00 Trac #33760: do not update _pos, _pos3d, _embedding on vertex/edge deletions

dbf091dbbb Trac #34139: fix the linter

625ac58151 Updated [SageMath](SageMath) version to 9.7.beta5



merge was not clean: conflicts in src/sage/groups/perm_gps/partn_ref/refinement_graphs.pyx


---

Comment by vbraun created at 2022-07-18 19:48:47

Changing status from positive_review to needs_work.


---

Comment by git created at 2022-07-18 20:19:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2022-07-18 20:19:20

Changing status from needs_work to positive_review.


---

Comment by jhpalmieri created at 2022-07-18 20:19:20

Rebased over #34130.


---

Comment by vbraun created at 2022-07-24 22:25:37

Merge failure on top of:

7f7149489c Updated [SageMath](SageMath) version to 9.7.beta6



merge was not clean: conflicts in src/sage/combinat/yang_baxter_graph.py


---

Comment by vbraun created at 2022-07-24 22:25:37

Changing status from positive_review to needs_work.


---

Comment by git created at 2022-07-25 02:45:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2022-07-25 02:46:03

Changing status from needs_work to positive_review.


---

Comment by jhpalmieri created at 2022-07-25 02:46:03

Merged 9.7.beta6.


---

Comment by dcoudert created at 2022-07-25 08:47:02

Let's hope this one can be merged soon to avoid new conflicts.


---

Comment by vbraun created at 2022-07-28 21:21:40

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2022-07-28 21:21:40

see patchbot


---

Comment by jhpalmieri created at 2022-07-28 22:20:58

Replying to [comment:77 vbraun]:
> see patchbot

Which part? I believe the "deprecation number" warning is from this change:

```diff
@@ -12229,7 +12255,8 @@ class GenericGraph(GenericGraph_pyx):
             [(0, 1, None), (0, 2, None), (1, 3, None), (2, 3, None), (2, 4, None), (3, 4, None)]
         """
         if sort is None:
-            deprecation(27408, "parameter 'sort' will be set to False by default in the future")
+            if key is None:
+                deprecation(27408, "parameter 'sort' will be set to False by default in the future")
             sort = True
 
         if vertices is not None and vertices in self:
```

and that seems appropriate: no reason to change the ticket number. (That's the only match for "27408" in the changes for this ticket.)

The `pyflakes` warnings are not related to this ticket: they are in files touched by this ticket but not where we've modified them. (In addition, I don't understand the warning about `simplicial_complex.py`)


---

Comment by jhpalmieri created at 2022-07-28 22:20:58

Changing status from needs_work to positive_review.


---

Comment by tscrim created at 2022-07-29 02:16:29

It is more fundamental: there is a test failing for `src/sage/graphs/edge_connectivity.pyx`.


---

Comment by tscrim created at 2022-07-29 02:16:38

Changing status from positive_review to needs_work.


---

Comment by git created at 2022-07-29 05:37:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2022-07-29 05:38:10

Doctest fixed.


---

Comment by jhpalmieri created at 2022-07-29 05:38:10

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2022-08-04 22:47:08

Resolution: fixed
