# Issue 30496: GH Actions: Remove use of deprecated set-env command

archive/issues_030496.json:
```json
{
    "body": "CC:  @kliem dimpase @tobiasdiez\n\nThe `set-env` command is deprecated and will be disabled soon. Please upgrade to using Environment Files. For more information see: https://github.blog/changelog/2020-10-01-github-actions-deprecating-set-env-and-add-path-commands/\n\nIssue created by migration from https://trac.sagemath.org/ticket/30733\n\n",
    "created_at": "2020-10-06T19:02:52Z",
    "labels": [
        "porting",
        "major",
        "bug"
    ],
    "title": "GH Actions: Remove use of deprecated set-env command",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30496",
    "user": "mkoeppe"
}
```
CC:  @kliem dimpase @tobiasdiez

The `set-env` command is deprecated and will be disabled soon. Please upgrade to using Environment Files. For more information see: https://github.blog/changelog/2020-10-01-github-actions-deprecating-set-env-and-add-path-commands/

Issue created by migration from https://trac.sagemath.org/ticket/30733





---

archive/issue_comments_435234.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2020-11-17T01:44:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30496#issuecomment-435234",
    "user": "mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_435235.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-11-17T02:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30496#issuecomment-435235",
    "user": "mkoeppe"
}
```

New commits:



---

archive/issue_comments_435236.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-11-17T02:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30496#issuecomment-435236",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_435237.json:
```json
{
    "body": "Is this really working? According to https://docs.github.com/en/free-pro-team`@`latest/actions/reference/workflow-commands-for-github-actions#environment-files the syntax is slightly different: `echo \"action_state=yellow\" >> $GITHUB_ENV`, that is, no `name=` prefix and `=` instead of `::`.",
    "created_at": "2020-11-17T11:20:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30496#issuecomment-435237",
    "user": "@tobiasdiez"
}
```

Is this really working? According to https://docs.github.com/en/free-pro-team`@`latest/actions/reference/workflow-commands-for-github-actions#environment-files the syntax is slightly different: `echo "action_state=yellow" >> $GITHUB_ENV`, that is, no `name=` prefix and `=` instead of `::`.



---

archive/issue_comments_435238.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2020-11-17T11:20:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30496#issuecomment-435238",
    "user": "@tobiasdiez"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_435239.json:
```json
{
    "body": "You are right, sorry!",
    "created_at": "2020-11-17T16:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30496#issuecomment-435239",
    "user": "mkoeppe"
}
```

You are right, sorry!



---

archive/issue_comments_435240.json:
```json
{
    "body": "Wait, isn't this exactly the change that I have done?",
    "created_at": "2020-11-17T16:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30496#issuecomment-435240",
    "user": "mkoeppe"
}
```

Wait, isn't this exactly the change that I have done?



---

archive/issue_comments_435241.json:
```json
{
    "body": "I think instead of \n\n```\necho \"name=DOCKER_PUSH_REPOSITORY::docker.pkg.github.com/${{ github.repository }}/\" >> $GITHUB_ENV\n```\n\nit should be \n\n```\necho \"DOCKER_PUSH_REPOSITORY=docker.pkg.github.com/${{ github.repository }}/\" >> $GITHUB_ENV\n```\n\n\nIt would be good if you could trigger these workflows and see if they still work.",
    "created_at": "2020-11-17T17:45:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30496#issuecomment-435241",
    "user": "@tobiasdiez"
}
```

I think instead of 

```
echo "name=DOCKER_PUSH_REPOSITORY::docker.pkg.github.com/${{ github.repository }}/" >> $GITHUB_ENV
```

it should be 

```
echo "DOCKER_PUSH_REPOSITORY=docker.pkg.github.com/${{ github.repository }}/" >> $GITHUB_ENV
```


It would be good if you could trigger these workflows and see if they still work.



---

archive/issue_comments_435242.json:
```json
{
    "body": "OK, thanks, now after enough coffee I see the mistake that you pointed out.",
    "created_at": "2020-11-17T18:44:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30496#issuecomment-435242",
    "user": "mkoeppe"
}
```

OK, thanks, now after enough coffee I see the mistake that you pointed out.



---

archive/issue_comments_435243.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-11-17T19:00:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30496#issuecomment-435243",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_435244.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2020-11-17T19:07:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30496#issuecomment-435244",
    "user": "mkoeppe"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_435245.json:
```json
{
    "body": "This now seems to work, as can be seen in https://github.com/mkoeppe/sage/runs/1414148202:\n\n```\nPushing docker.pkg.github.com/mkoeppe/sage/sage-docker-debian-bullseye-standard-configured:9.1.rc4-71302-ga75c9b7518-failed\nThe push refers to repository [docker.pkg.github.com/mkoeppe/sage/sage-docker-debian-bullseye-standard-configured]\n1414c2322460: Preparing\n```\n\n\n(That the actual docker push is failing with `no basic auth credentials` is a separate issue -- this has already been failing for a while and will be addressed in another ticket.)",
    "created_at": "2020-11-17T19:10:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30496#issuecomment-435245",
    "user": "mkoeppe"
}
```

This now seems to work, as can be seen in https://github.com/mkoeppe/sage/runs/1414148202:

```
Pushing docker.pkg.github.com/mkoeppe/sage/sage-docker-debian-bullseye-standard-configured:9.1.rc4-71302-ga75c9b7518-failed
The push refers to repository [docker.pkg.github.com/mkoeppe/sage/sage-docker-debian-bullseye-standard-configured]
1414c2322460: Preparing
```


(That the actual docker push is failing with `no basic auth credentials` is a separate issue -- this has already been failing for a while and will be addressed in another ticket.)



---

archive/issue_comments_435246.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-11-17T21:07:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30496#issuecomment-435246",
    "user": "@tobiasdiez"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_435247.json:
```json
{
    "body": "LGTM! (Not sure if the github url should stay in Reviewers comment.)\n\nJust for reference, a different solution would use the recently added feature that steps (and jobs) can have return values: https://docs.github.com/en/free-pro-team`@`latest/actions/reference/workflow-syntax-for-github-actions#jobsjob_idoutputs",
    "created_at": "2020-11-17T21:07:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30496#issuecomment-435247",
    "user": "@tobiasdiez"
}
```

LGTM! (Not sure if the github url should stay in Reviewers comment.)

Just for reference, a different solution would use the recently added feature that steps (and jobs) can have return values: https://docs.github.com/en/free-pro-team`@`latest/actions/reference/workflow-syntax-for-github-actions#jobsjob_idoutputs



---

archive/issue_comments_435248.json:
```json
{
    "body": "Thanks for reviewing!",
    "created_at": "2020-11-17T21:31:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30496#issuecomment-435248",
    "user": "mkoeppe"
}
```

Thanks for reviewing!



---

archive/issue_comments_435249.json:
```json
{
    "body": "Replying to [comment:14 gh-tobiasdiez]:\n> Just for reference, a different solution would use the recently added feature that steps (and jobs) can have return values: https://docs.github.com/en/free-pro-team`@`latest/actions/reference/workflow-syntax-for-github-actions#jobsjob_idoutputs\n\nYes, thanks, this is good to know",
    "created_at": "2020-11-17T21:31:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30496#issuecomment-435249",
    "user": "mkoeppe"
}
```

Replying to [comment:14 gh-tobiasdiez]:
> Just for reference, a different solution would use the recently added feature that steps (and jobs) can have return values: https://docs.github.com/en/free-pro-team`@`latest/actions/reference/workflow-syntax-for-github-actions#jobsjob_idoutputs

Yes, thanks, this is good to know



---

archive/issue_comments_435250.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-11-22T15:06:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30496",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30496#issuecomment-435250",
    "user": "vbraun"
}
```

Resolution: fixed
