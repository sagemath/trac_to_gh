# Issue 14490: Update SymPy to 0.7.2

Issue created by migration from Trac.

Original creator: eviatarbach

Original creation time: 2013-06-06 01:04:41

Assignee: jdemeyer

CC:  fbissey

SymPy 0.7.2 was released on October 16, 2012. The release notes are at https://github.com/sympy/sympy/wiki/Release-Notes-for-0.7.2.


---

Comment by eviatarbach created at 2013-07-14 21:11:59

SymPy is now on version 0.7.3, so that's what the Sage version should be updated to.


---

Comment by eviatarbach created at 2013-08-17 21:14:56

I created the new SPKG, it's up at http://www.phas.ubc.ca/~eviatarb/sympy-0.7.3.spkg.

The patch fixes the only doctest failure I could find.


---

Comment by eviatarbach created at 2013-08-17 21:16:18

Changing status from new to needs_review.


---

Comment by fbissey created at 2013-08-17 21:21:56

Yes the pretty printing test. There was another one that was broken with 0.7.2 in sage-on-gentoo I will have to chase it to check it is gone away.


---

Comment by fbissey created at 2013-08-20 21:47:56

OK, I check on a vanilla 5.12.beta1 and there is one more doctest failure as with 0.7.2 on sage-on-gentoo:

```
sage -t --long devel/sage/sage/symbolic/constants.py
**********************************************************************
File "devel/sage/sage/symbolic/constants.py", line 715, in sage.symbolic.constants.NotANumber._sympy_
Failed example:
    sympy.nan == NaN # indirect doctest
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of   3 in sage.symbolic.constants.NotANumber._sympy_
```

The other patch works fine. We may want to get upstream involved with that one.


---

Comment by eviatarbach created at 2013-08-21 00:02:45

Okay. Do you think we could still merge it though? I don't think users should be comparing SymPy and Sage objects too often anyway.


---

Comment by fbissey created at 2013-08-21 00:07:47

Sure but the doctest has to be fixed one way or another before we merge. I am not giving a positive review while there is a known doctest breakage.


---

Comment by eviatarbach created at 2013-08-21 00:10:39

Yeah that's what I meant. Patch coming up.


---

Attachment

New patch.


---

Comment by fbissey created at 2013-08-22 21:32:17

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2013-08-22 21:32:17

Not sure what to do with the old doctest but it all passes now. LEt's try to make it for beta4.


---

Comment by fbissey created at 2013-08-23 06:26:59

Sorry forgot to also include the patch in the description. Only the last patch should be applied.


---

Comment by jdemeyer created at 2013-08-23 09:00:16


```
sage -t devel/sage/sage/misc/displayhook.py
**********************************************************************
File "devel/sage/sage/misc/displayhook.py", line 25, in sage.misc.displayhook
Failed example:
    shell.run_cell('integral(x^2/pi^x, x)')
Expected:
     / 2    2                      \  -x*log(pi)
    -\x *log (pi) + 2*x*log(pi) + 2/*e
    --------------------------------------------
                         3
                      log (pi)
Got:
     / 2    2                      \  -x*log(pi) 
    -\x *log (pi) + 2*x*log(pi) + 2/*e           
    ---------------------------------------------
                          3                      
                       log (pi)                  
**********************************************************************
```


```
sage -t devel/sage/sage/misc/ascii_art.py
**********************************************************************
File "devel/sage/sage/misc/ascii_art.py", line 807, in sage.misc.ascii_art.ascii_art
Failed example:
    ascii_art(sum(binomial(2*n,n+1)*x^n, n, 0, oo))
Expected:
     /        __________    \
    -\2*x + \/ -4*x + 1  - 1/
    -------------------------
               __________
         2*x*\/ -4*x + 1
Got:
     /        __________    \ 
    -\2*x + \/ -4*x + 1  - 1/ 
    --------------------------
               __________     
         2*x*\/ -4*x + 1      
**********************************************************************
```

(note the number of hypens)


```
sage -t devel/sage/sage/symbolic/integration/integral.py
**********************************************************************
File "devel/sage/sage/symbolic/integration/integral.py", line 474, in sage.symbolic.integration.integral.integrate
Failed example:
    (x^y-z).integrate(y,algorithm="sympy")
Exception raised:
    Traceback (most recent call last):
      File "/mazur/release/merger/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 479, in _run
        self.execute(example, compiled, test.globs)
      File "/mazur/release/merger/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 838, in execute
        exec compiled in globs
      File "<doctest sage.symbolic.integration.integral.integrate[41]>", line 1, in <module>
        (x**y-z).integrate(y,algorithm="sympy")
      File "expression.pyx", line 9759, in sage.symbolic.expression.Expression.integral (sage/symbolic/expression.cpp:40828)
      File "/mazur/release/merger/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/symbolic/integration/integral.py", line 683, in integrate
        return integrator(expression, v, a, b)
      File "/mazur/release/merger/sage-5.12.beta4/local/lib/python2.7/site-packages/sage/symbolic/integration/external.py", line 39, in sympy_integrator
        return result._sage_()
      File "/mazur/release/merger/sage-5.12.beta4/local/lib/python2.7/site-packages/sympy/core/add.py", line 721, in _sage_
        s += x._sage_()
    AttributeError: 'Piecewise' object has no attribute '_sage_'
**********************************************************************
```



---

Comment by jdemeyer created at 2013-08-23 09:00:16

Changing status from positive_review to needs_work.


---

Comment by fbissey created at 2013-08-23 10:56:41

Hum. I assumed the new patch was correct for the first one on the basis that it was correct in the first version. Not sure how the second one escaped unless eviatarbach used 5.10, it is also specifc to 0.7.3, 0.7.2 just works. The last one is also showing a difference between 0.7.2 and 0.7.3.


---

Comment by eviatarbach created at 2013-08-24 15:31:10

Sorry, I should have run `testall`. New patch fixes all the tests that were failing.


---

Comment by eviatarbach created at 2013-08-24 15:31:10

Changing status from needs_work to needs_review.


---

Attachment


---

Attachment


---

Comment by jdemeyer created at 2013-08-26 06:37:53

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2013-08-26 06:37:53

Why did you change

```
(x^y-z).integrate(y,algorithm="sympy")
```

to

```
(x*y-z).integrate(y,algorithm="sympy")
```

One needs a good reason to remove doctests.


---

Comment by eviatarbach created at 2013-08-26 16:00:44

Because now SymPy returns a `Piecewise` object for that integral, which can't be converted back to Sage. Making the conversion work would actually require a change in SymPy, since currently we look for the `_sage_` method in SymPy objects, which isn't defined for `Piecewise`.

I couldn't think of anything else to do except modifying the doctest, at least until the conversions are fixed upstream. What do you suggest?


---

Comment by jdemeyer created at 2013-08-26 17:12:15

Replying to [comment:23 eviatarbach]:
> I couldn't think of anything else to do except modifying the doctest, at least until the conversions are fixed upstream. What do you suggest?
At least, mark the existing doctest `# known bug`.


---

Comment by fbissey created at 2013-08-26 19:38:36

I would catch instead of changing it so we can know when it is fixed. In any case I will contact sympy upstream shortly about it.


---

Comment by fbissey created at 2013-08-26 23:52:52

See Aaron interesting answer at [https://groups.google.com/forum/#!topic/sympy/VRNKUeJATNs](https://groups.google.com/forum/#!topic/sympy/VRNKUeJATNs)


---

Comment by asmeurer created at 2013-08-27 00:54:20

I might repeat my request here for people to help out adding _sage_ methods to unsupported objects in SymPy. The number of SymPy users who know the corresponding Sage methods is rather low, unfortunately. But SymPy currently has a lot of special functions and special objects like Piecewise which won't convert directly (even for the special functions, a direct name conversion might not work because of convention differences).


---

Comment by asmeurer created at 2013-08-27 01:00:07

Also, feel free to CC me on any SymPy related issue in this issue tracker.


---

Attachment


---

Comment by eviatarbach created at 2013-08-27 15:51:22

Thank you Aaron, I will see if I can submit a pull request adding `_sage_` methods. It would be good for SymPy and Sage to interface better to each other.

New patch added. How does this one look?


---

Comment by eviatarbach created at 2013-08-27 15:51:22

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2013-08-28 07:11:43

When marking a test `# known bug`, you should add the doctest result what you *want* to get, not what you actually get. In other words, just add `# known bug` without changing the result of the test.


---

Comment by eviatarbach created at 2013-08-28 17:03:44

Okay. I removed the `# known bug` then, since now SymPy returns a piecewise function and `-y*z + x^y/log(x)` is no longer the "expected" output. How SymPy's Piecewise is converted to Sage's piecewise is left to be implemented, so it's not clear exactly what the expected output will be.


---

Attachment


---

Comment by jdemeyer created at 2013-09-04 08:09:56

Resolution: fixed
