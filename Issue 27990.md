# Issue 27990: py3 fixes for weyl_characters.py

Issue created by migration from https://trac.sagemath.org/ticket/28227

Original creator: jhpalmieri

Original creation time: 2019-07-22 05:33:38

Fix the Python 3 doctest failures in `combinat/root_systems/weyl_characters.py`. The failures all come down to sorting. The more complicated problem is the method `fusion_labels` which relies on sorted output when it shouldn't.


---

Comment by jhpalmieri created at 2019-07-22 05:34:31

New commits:


---

Comment by jhpalmieri created at 2019-07-22 05:34:31

Changing status from new to needs_review.


---

Comment by git created at 2019-07-22 05:35:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @mwageringel created at 2019-07-22 08:23:43

It would be clearer if the second test here makes use of the sorted basis instead of sorting the highest weights, assuming assigning labels in the third test takes those weights into account.

```
        sage: sorted(B22.basis(), key=str)
        [B22(0,0), B22(0,1), B22(0,2), B22(1,0), B22(1,1), B22(2,0)]
        sage: sorted([x.highest_weight() for x in B22.basis()], key=str)
        [(0, 0), (1, 0), (1, 1), (1/2, 1/2), (2, 0), (3/2, 1/2)]
        sage: B22.fusion_labels(['1','X','Y1','Y2','Xp','Z'])
```


Also, I am wondering whether the more fundamental problem is that `RecursivelyEnumeratedSet` used for the basis does not give consistent results.

```
sage: S = RecursivelyEnumeratedSet([1000], lambda a: [a//2, a//3]); S
A recursively enumerated set (breadth first search)
sage: str(list(S))  # py3
'[1000, 500, 333, 250, 166, 111, 37, 83, 125, 55, 41, 12, 18, 27, 62, 4, 6, 9, 13, 20, 31, 1, 2, 3, 10, 15, 0, 5, 7]'
sage: str(list(S))  # py2
'[1000, 500, 333, 250, 166, 111, 37, 83, 125, 55, 41, 18, 27, 12, 62, 4, 6, 9, 13, 20, 31, 1, 2, 3, 10, 15, 0, 5, 7]'
```

If the successor function gives consistent results, the breadth-first search should be unique, should it not?


---

Comment by @mwageringel created at 2019-07-22 08:39:55

There is #27967 already, but it only deals with the graded variant of `RecursivelyEnumeratedSet`.


---

Comment by vklein created at 2019-07-22 09:07:51


```
+        if key:
+            fb = sorted(self.basis(), key=key)
+        else:
+            fb = list(self.basis())
```


As `str` is the default `key` maybe the doc should says that the user can use `key=None` to get an unsorted result.


---

Comment by vklein created at 2019-07-22 12:47:24

With this branch and py2 i get the following error :

```
sage -t --long src/sage/combinat/root_system/weyl_characters.py
**********************************************************************
File "src/sage/combinat/root_system/weyl_characters.py", line 2233, in sage.combinat.root_system.weyl_characters.FusionRing
Failed example:
    Z*Z
Expected:
    1
Got:
    1 + Y1 + Y2
**********************************************************************
1 item had failures:
   1 of  14 in sage.combinat.root_system.weyl_characters.FusionRing
    [308 tests, 1 failure, 1.88 s]
----------------------------------------------------------------------
sage -t --long src/sage/combinat/root_system/weyl_characters.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by jhpalmieri created at 2019-07-22 16:57:29

Replying to [comment:7 vklein]:
> With this branch and py2 i get the following error :
> {{{
> sage -t --long src/sage/combinat/root_system/weyl_characters.py
> **********************************************************************
> File "src/sage/combinat/root_system/weyl_characters.py", line 2233, in sage.combinat.root_system.weyl_characters.FusionRing
> Failed example:
>     Z*Z
> Expected:
>     1
> Got:
>     1 + Y1 + Y2
> **********************************************************************
> 1 item had failures:
>    1 of  14 in sage.combinat.root_system.weyl_characters.FusionRing
>     [308 tests, 1 failure, 1.88 s]
> ----------------------------------------------------------------------
> sage -t --long src/sage/combinat/root_system/weyl_characters.py  # 1 doctest failed
> ----------------------------------------------------------------------
> }}}

I can only reproduce this if I check out the branch and fail to run `make` or `./sage -b` before running tests. Can you double check that you really get this failure?


---

Comment by git created at 2019-07-23 03:12:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2019-07-23 03:14:42

Replying to [comment:4 gh-mwageringel]:
> It would be clearer if the second test here makes use of the sorted basis instead of sorting the highest weights, assuming assigning labels in the third test takes those weights into account.
> {{{
>         sage: sorted(B22.basis(), key=str)
>         [B22(0,0), B22(0,1), B22(0,2), B22(1,0), B22(1,1), B22(2,0)]
>         sage: sorted([x.highest_weight() for x in B22.basis()], key=str)
>         [(0, 0), (1, 0), (1, 1), (1/2, 1/2), (2, 0), (3/2, 1/2)]
>         sage: B22.fusion_labels(['1','X','Y1','Y2','Xp','Z'])
> }}}

Is this better? 

> Also, I am wondering whether the more fundamental problem is that `RecursivelyEnumeratedSet` used for the basis does not give consistent results.
> {{{
> sage: S = RecursivelyEnumeratedSet([1000], lambda a: [a//2, a//3]); S
> A recursively enumerated set (breadth first search)
> sage: str(list(S))  # py3
> '[1000, 500, 333, 250, 166, 111, 37, 83, 125, 55, 41, 12, 18, 27, 62, 4, 6, 9, 13, 20, 31, 1, 2, 3, 10, 15, 0, 5, 7]'
> sage: str(list(S))  # py2
> '[1000, 500, 333, 250, 166, 111, 37, 83, 125, 55, 41, 18, 27, 12, 62, 4, 6, 9, 13, 20, 31, 1, 2, 3, 10, 15, 0, 5, 7]'
> }}}
> If the successor function gives consistent results, the breadth-first search should be unique, should it not?

Should we delay the changes here until #27967 is resolved, or do these and then perhaps have to change then again depending on #27967 and/or other changes to `RecursiveEnumeratedSet`?

Replying to [comment:6 vklein]:
> 
> {{{
> +        if key:
> +            fb = sorted(self.basis(), key=key)
> +        else:
> +            fb = list(self.basis())
> }}}
> 
> As `str` is the default `key` maybe the doc should says that the user can use `key=None` to get an unsorted result.

I added something.


---

Comment by vklein created at 2019-07-23 07:24:57

Replying to [comment:8 jhpalmieri]:
> Replying to [comment:7 vklein]:
> ...
> I can only reproduce this if I check out the branch and fail to run `make` or `./sage -b` before running tests. Can you double check that you really get this failure?

I had a mess in my py2 local branch. It works now.

I'm ok with this ticket as it is. `@`gh-mwageringel : I let you set the ticket to positive review if you agree.


---

Comment by @mwageringel created at 2019-07-23 08:21:56

Replying to [comment:10 jhpalmieri]:
> Is this better? 

Yes, thanks.

> Should we delay the changes here until #27967 is resolved, or do these and then perhaps have to change then again depending on #27967 and/or other changes to `RecursiveEnumeratedSet`?

IMO, it would be better to delay this as it is a change of the API, not just the doctests. I am not sure where #27967 is headed though, so I will not insist. Feel free to set this to positive if you prefer these changes be merged now.


---

Comment by jhpalmieri created at 2019-07-23 17:37:03

If you think that #27967 will take a while to get resolved, then maybe we should merge these changes now to fix these doctests, but the two of you (vklein, gh-mwageringel) have a better idea of the fate of #27967 than I do, so I will let you decide what to do here.


---

Comment by vklein created at 2019-07-24 07:56:28

I think we should merge this ticket now.

From #27967#comment:10
>Also, why should the enumeration order be certified? This is not claimed in the documentation.

I think this is a valid point and therefore modifying RecursivelyEnumeratedSet rather than the classes using it is debatable. So yes i think #27967 will take a while.


---

Comment by @mwageringel created at 2019-07-24 08:35:43

Changing status from needs_review to positive_review.


---

Comment by @mwageringel created at 2019-07-24 08:35:43

Ok, let us move on here. Setting to positive.


---

Comment by vbraun created at 2019-07-29 21:54:47

Resolution: fixed
