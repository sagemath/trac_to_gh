# Issue 30458: Padic slice method fails on exact zeros for certain inputs

Issue created by migration from https://trac.sagemath.org/ticket/30695

Original creator: @n-vi

Original creation time: 2020-10-02 03:59:48

Keywords: slice, zero

Using version 9.2.beta14 of Sage, the p-adic `slice` method fails on exact zeros, for input of j=None or j=infinity (where j is the 'upper-bound' of the slice). 

For example:

```
sage: F=Qp(3)
sage: a=F(0)                                                                                                                                                                       
sage: a.slice(0,None)                                                                                                                                                              
---------------------------------------------------------------------------
SignError                                 Traceback (most recent call last)
<ipython-input-4-d78676a03c88> in <module>
----> 1 a.slice(Integer(0),None)

~/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/rings/padics/local_generic_element.pyx in sage.rings.padics.local_generic_element.LocalGenericElement.slice (build/cythonized/sage/rings/padics/local_generic_element.c:3430)()
    329         if self.parent().is_field():
    330             start -= self.valuation()
--> 331             stop -= self.valuation()
    332 
    333         # make sure that start and stop are non-negative

~/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__sub__ (build/cythonized/sage/structure/element.c:11514)()
   1353         cdef int cl = classify_elements(left, right)
   1354         if HAVE_SAME_PARENT(cl):
-> 1355             return (<Element>left)._sub_(right)
   1356         if BOTH_ARE_ELEMENT(cl):
   1357             return coercion_model.bin_op(left, right, sub)

~/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.ModuleElement._sub_ (build/cythonized/sage/structure/element.c:15803)()
   2386         return coercion_model.bin_op(self, n, add)
   2387 
-> 2388     cpdef _sub_(self, other):
   2389         """
   2390         Default implementation of subtraction using addition and

~/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/rings/infinity.py in _sub_(self, other)
    426                 raise SignError("cannot subtract unsigned infinities")
    427             elif self._sign == other._sign:
--> 428                 raise SignError("cannot add infinity to minus infinity")
    429         return self
    430 

SignError: cannot add infinity to minus infinity


sage: a.slice(0,infinity)                                                                                                                                                          
---------------------------------------------------------------------------
SignError                                 Traceback (most recent call last)
<ipython-input-5-98f115011f22> in <module>
----> 1 a.slice(Integer(0),infinity)

~/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/rings/padics/local_generic_element.pyx in sage.rings.padics.local_generic_element.LocalGenericElement.slice (build/cythonized/sage/rings/padics/local_generic_element.c:3430)()
    329         if self.parent().is_field():
    330             start -= self.valuation()
--> 331             stop -= self.valuation()
    332 
    333         # make sure that start and stop are non-negative

~/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__sub__ (build/cythonized/sage/structure/element.c:11514)()
   1353         cdef int cl = classify_elements(left, right)
   1354         if HAVE_SAME_PARENT(cl):
-> 1355             return (<Element>left)._sub_(right)
   1356         if BOTH_ARE_ELEMENT(cl):
   1357             return coercion_model.bin_op(left, right, sub)

~/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.ModuleElement._sub_ (build/cythonized/sage/structure/element.c:15803)()
   2386         return coercion_model.bin_op(self, n, add)
   2387 
-> 2388     cpdef _sub_(self, other):
   2389         """
   2390         Default implementation of subtraction using addition and

~/workspace/padic_project/sage/local/lib/python3.7/site-packages/sage/rings/infinity.py in _sub_(self, other)
    426                 raise SignError("cannot subtract unsigned infinities")
    427             elif self._sign == other._sign:
--> 428                 raise SignError("cannot add infinity to minus infinity")
    429         return self
    430 

SignError: cannot add infinity to minus infinity
```



---

Comment by @n-vi created at 2020-10-02 04:15:54

New commits:


---

Comment by @n-vi created at 2020-10-02 04:15:54

Changing status from new to needs_review.


---

Comment by saraedum created at 2020-10-29 22:31:52

I think the code would be easier to read if you put the `if j is infinity` up, i.e.,


```
        if j is None or j is infinity:
            j = self.precision_absolute()
            if j is infinity:
                ...
```


otherwise I found it a bit confusing.


---

Comment by saraedum created at 2020-10-29 22:31:58

Changing status from needs_review to needs_work.


---

Comment by @n-vi created at 2020-11-01 02:47:58

Hi Julian, thanks! 

The reason why I put those lines down there, was my thinking that if k<=0, the function should (in all cases) reach the part of the code that makes it return `ValueError`. I wasn't sure about it though. Perhaps if j is infinity or None, and self.precision_absolute is infinity, we want to return zero regardless of whether or not k is legal. 

However, if we want to return `ValueError` for k<=0, we can either preserve the current location of the lines, or change the order in which the arguments are checked, like so: 


```
        if k is None:
            k = 1
        if k<=0:
            raise ValueError("slice step must be positive")
        if i is None:
            i = self.valuation()
        if j is None or j is infinity:
            j = self.precision_absolute()
            if j is infinity:
                return self.parent()(0)

        ...
```

What would you suggest? 



---

Comment by @n-vi created at 2020-11-01 02:48:16

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2020-11-20 12:28:08

I like your proposal to reorder. Note that you should write `if k <= 0` with such spaces. I think that's the formatting standard here.

Sorry for taking so long to respond to such a triviality.


---

Comment by saraedum created at 2020-11-20 12:28:13

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2020-11-20 12:28:40

But if you don't want to make that change, feel free to set this ticket to positive review. It's certainly a big improvement already.


---

Comment by git created at 2020-11-20 14:00:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @n-vi created at 2020-11-20 14:01:34

Thanks Julian, I changed the order as suggested.


---

Comment by @n-vi created at 2020-11-20 14:01:53

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2021-01-21 00:31:58

Noa, I think you need to merge in the latest dev branch since there seem to be merge conflicts with other work that happened in the meantime.


---

Comment by saraedum created at 2021-01-21 00:32:08

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-02-22 14:48:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-02 20:21:54

Moving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage


---

Comment by chapoton created at 2021-05-18 09:48:41

is this "needs_work" or "needs_review" ? Seems to be pretty trivial


---

Comment by @n-vi created at 2021-06-16 20:04:22

Replying to [comment:19 chapoton]:
> is this "needs_work" or "needs_review" ? Seems to be pretty trivial
Hi #chapoton, thank you for your comment, I will indeed change status to "needs_review". Sorry for the delay in the answer.


---

Comment by @n-vi created at 2021-06-16 20:04:45

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2021-06-19 10:02:31

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2021-06-19 10:02:31

Sorry to set this back to needs work but I think that this is wrong now for lazy p-adics. They report `+Infinity` for `precision_absolute()` even if they are non-zero.

The old code threw an error, now it's silently wrong returning 0.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by @n-vi created at 2022-02-01 10:50:07

Hi Julian,\\
You are right, thank you for the comment.\\
Currently there is a different slice method for relaxed p-adics. It appears in: relaxed_template.pxi and accepts slightly different arguments (for example, it doesn't have an analog for the k argument in the usual slice method, which enables a constant skip in the slicing).\\
Therefore I think that it should first be decided how to organize these methods and which possibilities to allow in the relaxed case.\\
What do you think?


---

Comment by @n-vi created at 2022-02-01 10:50:07

Changing status from needs_work to needs_review.


---

Comment by roed created at 2022-02-15 23:09:04

I think that the `k` argument is likely never used, since it's not very useful.  Certainly `k <= 0` doesn't make sense.  I'd be fine with just raising a `NotImplementedError` if the user passes in anything other than `k=1`.


---

Comment by @n-vi created at 2022-02-16 12:06:40

Currently, the slice method that's implemented in https://github.com/sagemath/sage/blob/develop/src/sage/rings/padics/local_generic_element.pyx receives the arguments: `self`, `i`, `j`, `k = 1`, `lift_mode='simple'`, whereas the slice method implemented in https://github.com/sagemath/sage/blob/develop/src/sage/rings/padics/relaxed_template.pxi receives: `self`, `start=None`, `stop=None`, `bound=False`.\\
`i`, `j` are equivalent to: `start`, `stop`. But `k`, `lift_mode`, and `bound` have no equivalences in the other implementation.\\
To avoid mistakes and problems, I think perhaps the relaxed implementation should override the general one, right? But this requires that the signature of those methods become identical. What do you think?\\
Thanks.


---

Comment by caruso created at 2022-02-16 19:17:32

I think that it's a good thing to fix rapidly the bug you reported and leave the discussion of uniformizing the behaviour of `slice` for another ticket. So I give a positive review to the ticket.


---

Comment by caruso created at 2022-02-16 19:17:32

Changing status from needs_review to positive_review.


---

Comment by @n-vi created at 2022-02-16 21:46:02

Great,thanks David!


---

Comment by vbraun created at 2022-02-20 13:27:55

Resolution: fixed
