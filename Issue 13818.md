# Issue 13818: Get scipy fortran objects be built with -fPIC again

Issue created by migration from https://trac.sagemath.org/ticket/14022

Original creator: fbissey

Original creation time: 2013-01-28 08:39:54

Assignee: tbd

This is a follow up to #13985. After that ticket was merged FC/F90/F77 are not set to something that includes -fPIC. This leads to problems like the one reported by Stephen Montgomery-Smith working on the BSD port.

```
/usr/home/stephen/sage-devel/work/sage-5.7.beta1/local/bin/gfortran
-Wall -shared
-Wl,-rpath=/usr/home/stephen/sage-devel/work/sage-5.7.beta1/local/lib
-Wl,-rpath=/usr/local/lib/gcc46
build/temp.freebsd-8.3-STABLE-amd64-2.7/build/src.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/_fftpackmodule.o
build/temp.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/src/zfft.o
build/temp.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/src/drfft.o
build/temp.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/src/zrfft.o
build/temp.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/src/zfftnd.o
build/temp.freebsd-8.3-STABLE-amd64-2.7/build/src.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/src/dct.o
build/temp.freebsd-8.3-STABLE-amd64-2.7/build/src.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/src/dst.o
build/temp.freebsd-8.3-STABLE-amd64-2.7/build/src.freebsd-8.3-STABLE-amd64-2.7/fortranobject.o
-L/usr/local/lib/gcc46/gcc/x86_64-portbld-freebsd8.3/4.6.3
-Lbuild/temp.freebsd-8.3-STABLE-amd64-2.7 -ldfftpack -lfftpack
-lpython2.7 -lgfortran -o
build/lib.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/_fftpack.so
/usr/local/bin/ld:
build/temp.freebsd-8.3-STABLE-amd64-2.7/libdfftpack.a(dffti1.o):
relocation R_X86_64_32S against `.rodata' can not be used when making a
shared object; recompile with -fPIC
build/temp.freebsd-8.3-STABLE-amd64-2.7/libdfftpack.a: could not read
symbols: Bad value
collect2: ld returned 1 exit status
/usr/local/bin/ld:
build/temp.freebsd-8.3-STABLE-amd64-2.7/libdfftpack.a(dffti1.o):
relocation R_X86_64_32S against `.rodata' can not be used when making a
shared object; recompile with -fPIC
build/temp.freebsd-8.3-STABLE-amd64-2.7/libdfftpack.a: could not read
symbols: Bad value
collect2: ld returned 1 exit status
```


{F,FC}FLAGS should be set to append "-fPIC" when compiling scipy.


---

Comment by jdemeyer created at 2013-01-28 08:55:34

Changing component from PLEASE CHANGE to packages.


---

Comment by jdemeyer created at 2013-01-28 08:55:34

Changing type from PLEASE CHANGE to defect.


---

Comment by jdemeyer created at 2013-01-28 08:55:34

Changing priority from major to blocker.


---

Comment by jdemeyer created at 2013-01-28 08:58:28

Before jumping to conclusions, I'd like to see the full logfile of the failed build first.  Because on other systems, I am seeing in the SciPy logs

```
building 'dfftpack' library
compiling Fortran sources
Fortran f77 compiler: gfortran -Wall -ffixed-form -fno-second-underscore -fPIC -O3 -funroll-loops
Fortran f90 compiler: gfortran -Wall -fno-second-underscore -fPIC -O3 -funroll-loops
Fortran fix compiler: gfortran -Wall -ffixed-form -fno-second-underscore -Wall -fno-second-underscore -fPIC -O3 -funroll-loops
```



---

Comment by fbissey created at 2013-01-28 09:01:58

OK, but I have the spkg ready just in case.


---

Comment by fbissey created at 2013-01-28 09:08:01

Actually I am not sure why you asked for the ATLAS log. Does scipy takes some cues from ATLAS (if it is the cblas/lapack of choice)?


---

Comment by jdemeyer created at 2013-01-28 09:45:07

Replying to [comment:4 fbissey]:
> Does scipy takes some cues from ATLAS (if it is the cblas/lapack of choice)?
I don't know but SciPy at least _mentions_ the ATLAS build flags:

```
ATLAS version 3.8.4 built by buildbot on Sat Jan 26 08:53:30 SGT 2013:
   UNAME    : Linux arando 3.2.0-32-generic-pae #51-Ubuntu SMP Wed Sep 26 21:54:23 UTC 2012 i686 i686 i386 GNU/Linux
   INSTFLG  : -1 0 -a 1
   ARCHDEFS : -DATL_OS_Linux -DATL_ARCH_Corei2 -DATL_CPUMHZ=3301 -DATL_SSE3 -DATL_SSE2 -DATL_SSE1 -DATL_GAS_x8632
   F2CDEFS  : -DAdd_ -DF77_INTEGER=int -DStringSunStyle
   CACHEEDGE: 0
   F77      : sage_fortran, version GNU Fortran (Ubuntu/Linaro 4.6.3-1ubuntu5) 4.6.3
   F77FLAGS : -O -fPIC -m32
   SMC      : gcc, version gcc (Ubuntu/Linaro 4.6.3-1ubuntu5) 4.6.3
   SMCFLAGS : -fomit-frame-pointer -mfpmath=sse -mavx -O2 -fno-schedule-insns2 -fPIC -m32
   SKC      : gcc, version gcc (Ubuntu/Linaro 4.6.3-1ubuntu5) 4.6.3
   SKCFLAGS : -fomit-frame-pointer -mfpmath=sse -mavx -O2 -fno-schedule-insns2 -fPIC -m32
```



---

Comment by jdemeyer created at 2013-01-29 08:58:38

Log of failed FreeBSD build


---

Attachment

At least it's clear now that `-fPIC` isn't added on FreeBSD.  But I would still really like to know where `SciPy` (or `SCons`) gets the flags from:

```
Fortran f77 compiler: gfortran -Wall -ffixed-form -fno-second-underscore -pipe -Wl,-rpath=/usr/home/stephen/sage-devel/work/sage-5.7.beta1/local/lib -Wl,-rpath=/usr/local/lib/gcc46 -O3 -funroll-loops
Fortran f90 compiler: gfortran -Wall -fno-second-underscore -pipe -Wl,-rpath=/usr/home/stephen/sage-devel/work/sage-5.7.beta1/local/lib -Wl,-rpath=/usr/local/lib/gcc46 -O3 -funroll-loops
Fortran fix compiler: gfortran -Wall -ffixed-form -fno-second-underscore -Wall -fno-second-underscore -pipe -Wl,-rpath=/usr/home/stephen/sage-devel/work/sage-5.7.beta1/local/lib -Wl,-rpath=/usr/local/lib/gcc46 -O3 -funroll-loops
```



---

Comment by jdemeyer created at 2013-01-29 09:21:24

Replying to [comment:3 fbissey]:
> OK, but I have the spkg ready just in case.
Care to put it up?


---

Comment by fbissey created at 2013-01-29 09:25:23

Sure. It will take a few minutes. Also, I don't think Stephen has a trac account so we cannot add him to the ticket so he could see your question.
The presence of all those -Wl,-rpath= make me think he has set some of the fortran flags manually but it would be nice to have confirmation. My other thought was libgfortan.spec but that wouldn't show up.


---

Comment by fbissey created at 2013-01-29 09:30:31

New spkg available in ticket description.


---

Comment by jdemeyer created at 2013-01-29 09:47:41

Looks good to me if you remove `scipy-0.11.0.p1-review.diff`

But we should let Stephen test it before putting positive review.


---

Comment by stephen created at 2013-01-29 13:32:26

I can confirm that scipy-0.11.0.p1 builds on FreeBSD.  (And I do have a trac account.)


---

Comment by fbissey created at 2013-01-29 17:12:25

Sorry, I didn't see your name on the wiki front page and I didn't search any further. I'll do the clean up, which shouldn't be too hard as the file is not tracked.


---

Comment by stephen created at 2013-01-29 23:46:02

No problem.


---

Comment by fbissey created at 2013-01-30 00:14:07

spkg updated. Your comment reminded me to do it.


---

Comment by jdemeyer created at 2013-01-30 07:15:48

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2013-01-30 07:16:59

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-01-31 09:19:27

Resolution: fixed
