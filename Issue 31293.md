# Issue 31293: New subs bug caused by #30378

Issue created by migration from https://trac.sagemath.org/ticket/31530

Original creator: mkoeppe

Original creation time: 2021-03-21 16:27:55

CC:  @spaghettisalat egourgoulhon slelievre vbraun

as reported in #30378#comment:49

```
sage: var('a b epsilon')                                                                                                                     
(a, b, epsilon)
sage: (a+b*epsilon).series(epsilon,2).subs(a=a,b=b)                                                                                          
b*epsilon
```



---

Comment by @DaveWitteMorris created at 2021-03-21 18:12:03

I confirm the bug. I have no idea how this could have happened, but I will look into it. Suggestions are welcome.


---

Comment by @DaveWitteMorris created at 2021-03-24 23:57:22

Changing status from new to needs_review.


---

Comment by @DaveWitteMorris created at 2021-03-24 23:57:22

I think this PR solves the problem on this ticket. (It eliminates unnecessary substitutions that caused problems.)  But I don't fully understand what happened, so I will investigate to see if there is another issue that I overlooked.
----
New commits:


---

Comment by @DaveWitteMorris created at 2021-03-25 01:51:15

OK, I think I understand the problem, so this ticket is ready for review.

The reason I was confused is that there were 2 different bugs. Both of them are triggered by the fact that my code performed the unnecessary substitution `epsilon=epsilon`. 

Any substitution for the variable `epsilon` is considered to be an evaluation of the series, so the `O(epsilon^2)` term is deleted.  That mistake in my code is fixed by this pull request.

The substitution for `epsilon` also triggered a different bug that has been around since at least 9.1. I opened #31554 for this old bug, which is what deleted the `a` term. (The bug was triggered because the substitution is performed inside a hold context, in order to avoid the problem described in ticket:30378#comment:32.)


---

Comment by slelievre created at 2021-03-25 03:16:28

Changing keywords from "" to "subs".


---

Comment by @DaveWitteMorris created at 2021-03-25 18:14:49

Changing status from needs_review to needs_info.


---

Comment by @DaveWitteMorris created at 2021-03-25 18:14:49

Temporarily setting to "needs info". If the bug in #31554 gets fixed, then the code can probably be simplified to use only a hold context (with no need for new temporary variables). On the other hand, if that bug does not get fixed soon, then the code may need to be rewritten to avoid using a hold context (which I think would mean using named variables instead of anonymous variables).


---

Comment by @DaveWitteMorris created at 2021-04-03 05:39:40

Pynac is buggy inside a hold context (see #31597), so I don't think we can use the solution that is in the current branch.

I thought we could get around the problem by using named variables, but I realized this may also give wrong answers. Variables may have a domain or be involved in assumptions, and this can affect the allowable simplifications. If we replace a variable with a new variable that does not match the original data, then incorrect simplifications may be triggered (if it is not in a hold context). 

I should be able to write a small pynac patch that fixes the specific problem in #30378 (without the bug that is on this ticket), but I think that anything more substantial will have to wait for 9.4, unless someone else has good ideas.


---

Comment by @DaveWitteMorris created at 2021-04-03 05:39:40

Changing status from needs_info to needs_work.


---

Comment by git created at 2021-04-04 02:05:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DaveWitteMorris created at 2021-04-04 02:11:16

This PR removes the patch that was added in #30378 (and modified by the original PR on this ticket).  Instead, it fixes the problem by patching pynac's `power::subs` method in the same way that the fix for #9891 patched the `container<C>::subs` method. This may cause doctest failures due to changed output, but it should not cause any mathematical errors.

I did not know anything about pynac (or C++) when we first started discussing the problem in #30378 eight months ago. Now that I have some experience, I don't think it will be difficult for me to properly eliminate this issue (and some others) by modifying pynac's `subs` methods.  (Related ticket: #25447.)  It's too late for this release cycle, though, so I think we should use this band-aid for now.


---

Comment by @DaveWitteMorris created at 2021-04-04 02:48:08

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-04-05 02:48:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DaveWitteMorris created at 2021-04-05 02:51:14

A doctest failed because it had the wrong error message. To fix this, we revert a change that was made in #30378.


---

Comment by mkoeppe created at 2021-04-05 16:54:30

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-04-05 16:54:30

LGTM at least as a hotfix for this blocker.


---

Comment by vbraun created at 2021-04-06 21:45:11

Resolution: fixed
