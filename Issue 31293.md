# Issue 31293: New subs bug caused by #30378

archive/issues_031293.json:
```json
{
    "body": "CC:  @spaghettisalat egourgoulhon slelievre vbraun\n\nas reported in #30378#comment:49\n\n```\nsage: var('a b epsilon')                                                                                                                     \n(a, b, epsilon)\nsage: (a+b*epsilon).series(epsilon,2).subs(a=a,b=b)                                                                                          \nb*epsilon\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/31530\n\n",
    "created_at": "2021-03-21T16:27:55Z",
    "labels": [
        "symbolics",
        "blocker",
        "bug"
    ],
    "title": "New subs bug caused by #30378",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31293",
    "user": "mkoeppe"
}
```
CC:  @spaghettisalat egourgoulhon slelievre vbraun

as reported in #30378#comment:49

```
sage: var('a b epsilon')                                                                                                                     
(a, b, epsilon)
sage: (a+b*epsilon).series(epsilon,2).subs(a=a,b=b)                                                                                          
b*epsilon
```


Issue created by migration from https://trac.sagemath.org/ticket/31530





---

archive/issue_comments_447367.json:
```json
{
    "body": "I confirm the bug. I have no idea how this could have happened, but I will look into it. Suggestions are welcome.",
    "created_at": "2021-03-21T18:12:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31293#issuecomment-447367",
    "user": "@DaveWitteMorris"
}
```

I confirm the bug. I have no idea how this could have happened, but I will look into it. Suggestions are welcome.



---

archive/issue_comments_447368.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-03-24T23:57:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31293#issuecomment-447368",
    "user": "@DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_447369.json:
```json
{
    "body": "I think this PR solves the problem on this ticket. (It eliminates unnecessary substitutions that caused problems.)  But I don't fully understand what happened, so I will investigate to see if there is another issue that I overlooked.\n----\nNew commits:",
    "created_at": "2021-03-24T23:57:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31293#issuecomment-447369",
    "user": "@DaveWitteMorris"
}
```

I think this PR solves the problem on this ticket. (It eliminates unnecessary substitutions that caused problems.)  But I don't fully understand what happened, so I will investigate to see if there is another issue that I overlooked.
----
New commits:



---

archive/issue_comments_447370.json:
```json
{
    "body": "OK, I think I understand the problem, so this ticket is ready for review.\n\nThe reason I was confused is that there were 2 different bugs. Both of them are triggered by the fact that my code performed the unnecessary substitution `epsilon=epsilon`. \n\nAny substitution for the variable `epsilon` is considered to be an evaluation of the series, so the `O(epsilon^2)` term is deleted.  That mistake in my code is fixed by this pull request.\n\nThe substitution for `epsilon` also triggered a different bug that has been around since at least 9.1. I opened #31554 for this old bug, which is what deleted the `a` term. (The bug was triggered because the substitution is performed inside a hold context, in order to avoid the problem described in ticket:30378#comment:32.)",
    "created_at": "2021-03-25T01:51:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31293#issuecomment-447370",
    "user": "@DaveWitteMorris"
}
```

OK, I think I understand the problem, so this ticket is ready for review.

The reason I was confused is that there were 2 different bugs. Both of them are triggered by the fact that my code performed the unnecessary substitution `epsilon=epsilon`. 

Any substitution for the variable `epsilon` is considered to be an evaluation of the series, so the `O(epsilon^2)` term is deleted.  That mistake in my code is fixed by this pull request.

The substitution for `epsilon` also triggered a different bug that has been around since at least 9.1. I opened #31554 for this old bug, which is what deleted the `a` term. (The bug was triggered because the substitution is performed inside a hold context, in order to avoid the problem described in ticket:30378#comment:32.)



---

archive/issue_comments_447371.json:
```json
{
    "body": "Changing keywords from \"\" to \"subs\".",
    "created_at": "2021-03-25T03:16:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31293#issuecomment-447371",
    "user": "slelievre"
}
```

Changing keywords from "" to "subs".



---

archive/issue_comments_447372.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2021-03-25T18:14:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31293#issuecomment-447372",
    "user": "@DaveWitteMorris"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_447373.json:
```json
{
    "body": "Temporarily setting to \"needs info\". If the bug in #31554 gets fixed, then the code can probably be simplified to use only a hold context (with no need for new temporary variables). On the other hand, if that bug does not get fixed soon, then the code may need to be rewritten to avoid using a hold context (which I think would mean using named variables instead of anonymous variables).",
    "created_at": "2021-03-25T18:14:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31293#issuecomment-447373",
    "user": "@DaveWitteMorris"
}
```

Temporarily setting to "needs info". If the bug in #31554 gets fixed, then the code can probably be simplified to use only a hold context (with no need for new temporary variables). On the other hand, if that bug does not get fixed soon, then the code may need to be rewritten to avoid using a hold context (which I think would mean using named variables instead of anonymous variables).



---

archive/issue_comments_447374.json:
```json
{
    "body": "Pynac is buggy inside a hold context (see #31597), so I don't think we can use the solution that is in the current branch.\n\nI thought we could get around the problem by using named variables, but I realized this may also give wrong answers. Variables may have a domain or be involved in assumptions, and this can affect the allowable simplifications. If we replace a variable with a new variable that does not match the original data, then incorrect simplifications may be triggered (if it is not in a hold context). \n\nI should be able to write a small pynac patch that fixes the specific problem in #30378 (without the bug that is on this ticket), but I think that anything more substantial will have to wait for 9.4, unless someone else has good ideas.",
    "created_at": "2021-04-03T05:39:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31293#issuecomment-447374",
    "user": "@DaveWitteMorris"
}
```

Pynac is buggy inside a hold context (see #31597), so I don't think we can use the solution that is in the current branch.

I thought we could get around the problem by using named variables, but I realized this may also give wrong answers. Variables may have a domain or be involved in assumptions, and this can affect the allowable simplifications. If we replace a variable with a new variable that does not match the original data, then incorrect simplifications may be triggered (if it is not in a hold context). 

I should be able to write a small pynac patch that fixes the specific problem in #30378 (without the bug that is on this ticket), but I think that anything more substantial will have to wait for 9.4, unless someone else has good ideas.



---

archive/issue_comments_447375.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2021-04-03T05:39:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31293#issuecomment-447375",
    "user": "@DaveWitteMorris"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_447376.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-04T02:05:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31293#issuecomment-447376",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447377.json:
```json
{
    "body": "This PR removes the patch that was added in #30378 (and modified by the original PR on this ticket).  Instead, it fixes the problem by patching pynac's `power::subs` method in the same way that the fix for #9891 patched the `container<C>::subs` method. This may cause doctest failures due to changed output, but it should not cause any mathematical errors.\n\nI did not know anything about pynac (or C++) when we first started discussing the problem in #30378 eight months ago. Now that I have some experience, I don't think it will be difficult for me to properly eliminate this issue (and some others) by modifying pynac's `subs` methods.  (Related ticket: #25447.)  It's too late for this release cycle, though, so I think we should use this band-aid for now.",
    "created_at": "2021-04-04T02:11:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31293#issuecomment-447377",
    "user": "@DaveWitteMorris"
}
```

This PR removes the patch that was added in #30378 (and modified by the original PR on this ticket).  Instead, it fixes the problem by patching pynac's `power::subs` method in the same way that the fix for #9891 patched the `container<C>::subs` method. This may cause doctest failures due to changed output, but it should not cause any mathematical errors.

I did not know anything about pynac (or C++) when we first started discussing the problem in #30378 eight months ago. Now that I have some experience, I don't think it will be difficult for me to properly eliminate this issue (and some others) by modifying pynac's `subs` methods.  (Related ticket: #25447.)  It's too late for this release cycle, though, so I think we should use this band-aid for now.



---

archive/issue_comments_447378.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-04-04T02:48:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31293#issuecomment-447378",
    "user": "@DaveWitteMorris"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_447379.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-05T02:48:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31293#issuecomment-447379",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_447380.json:
```json
{
    "body": "A doctest failed because it had the wrong error message. To fix this, we revert a change that was made in #30378.",
    "created_at": "2021-04-05T02:51:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31293#issuecomment-447380",
    "user": "@DaveWitteMorris"
}
```

A doctest failed because it had the wrong error message. To fix this, we revert a change that was made in #30378.



---

archive/issue_comments_447381.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-05T16:54:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31293#issuecomment-447381",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_447382.json:
```json
{
    "body": "LGTM at least as a hotfix for this blocker.",
    "created_at": "2021-04-05T16:54:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31293#issuecomment-447382",
    "user": "mkoeppe"
}
```

LGTM at least as a hotfix for this blocker.



---

archive/issue_comments_447383.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-04-06T21:45:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31293",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31293#issuecomment-447383",
    "user": "vbraun"
}
```

Resolution: fixed
