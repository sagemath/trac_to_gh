# Issue 20402: Sphinx sometimes doesn't resolve :meth:`.method` references correctly

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2016-05-20 09:13:27

In Sphinx it's possible to reference a method (or I guess attribute) of a class, or also a member of a module, using a shorthand notation with a leading dot. E.g. `:meth:`.order`` which should resolve documentation of the `order()` method of the current class being documented.

However, I found that this often fails, it seems, especially if that method is documented in a parent class, but not directly in some subclass.  E.g. the following error can occur when building the docs:


```
OSError: [graphs   ] /home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/graphs/digraph.py:docstring of sage.graphs.digraph.DiGraph.reverse_edge:116: WARNING: more than one target found for cross-reference u'edge_label': sage.graphs.generic_graph.GenericGraph.edge_label, sage.combinat.knutson_tao_puzzles.PuzzlePiece.edge_label
```


It's possible this doesn't occur when building the docs in parallel, but when building in a single process it's inevitable in a few places.

The problem in this case is that when generating a reference for `DiGraph.edge_label` (which is referenced in the docstring for `DiGraph` as `:meth:`.edge_label``) it comes up with multiple matches: 


```
[(u'sage.combinat.knutson_tao_puzzles.PuzzlePiece.edge_label', (u'sage/combinat/knutson_tao_puzzles', u'method')), (u'sage.graphs.generic_graph.GenericGraph.edge_label', (u'sage/graphs/generic_graph', u'method'))]
```


In this case it should of course use `GenericGraph.edge_label`, but it doesn't recognize that `GenericGraph` is a subclass of `DiGraph` and should be preferred. Instead this ends up generating an incorrect reference.  A workaround would be to use a more explicit reference.  

I'm also not sure why it results in an `OSError` and craashes the build instead of just producing a warning--is the doc build configured to promote all warnings to exceptions?


---

Comment by jdemeyer created at 2016-05-20 09:53:12

Replying to [ticket:20639 embray]:
> I'm also not sure why it results in an `OSError` and craashes the build instead of just producing a warning--is the doc build configured to promote all warnings to exceptions?

Yes.


---

Comment by embray created at 2016-05-20 10:11:46

Okay, thanks for clarifying that.  The fact that it's an `OSError` is weird but otherwise I have no problem with that.


---

Comment by vbraun created at 2016-05-21 23:01:25

To document the *current* class you should use `:meth:`order``

Leading dot is for searching all files; disambiguate as needed `:meth:`.GenericGraph.edge_label``


---

Comment by embray created at 2016-05-23 13:03:45

I see--I would have thought it the other way around though?

I haven't checked--are Sage classes documented with inherited members?


---

Comment by embray created at 2016-05-25 15:28:02

The Sphinx docs read:

> Normally, names in these roles are searched first without any further qualification, then with the current module name prepended, then with the current module and class name (if any) prepended. If you prefix the name with a dot, this order is reversed. For example, in the documentation of Pythonâ€™s codecs module, `:py:func:`open`` always refers to the built-in function, while `:py:func:`.open`` refers to `codecs.open()`.

Later it reads:

> Also, if the name is prefixed with a dot, and no exact match is found, the target is taken as a suffix and all object names with that suffix are searched. For example, `:py:meth:`.TarFile.close`` references the `tarfile.TarFile.close()` function, even if the current module is not tarfile. Since this can get ambiguous, if there is more than one possible match, you will get a warning from Sphinx.

So that does more or less reflect the current behavior accurately.  However, for attributes and methods of classes, the matching should take into consideration the class's subclasses, and currently it does not.  So it complains about ambiguity when really there's nothing ambiguous.


---

Comment by embray created at 2017-04-24 15:09:40

I think maybe this is not really a problem anymore since #21044, of this was a symptom, was fixed.  I still think the logic in Sphinx might not be perfect here, but as long as reference data is not being unnecessarily shared between docs, as fixed in #21044, this is less likely to come up.
