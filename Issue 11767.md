# Issue 11767: Notebook "ulimit -v" does not work

archive/issues_011767.json:
```json
{
    "body": "Assignee: jason, mpatel, was\n\nCC:  @fchapoton\n\nThe `ulimit -v` argument does not do anything at all (I have not tested other options), neither locally nor remote.  Both commands\n\n```\nnotebook(ulimit=\"-v 1\")\n```\n\nand\n\n```\nnotebook(server_pool=[\"jdemeyer@localhost\"], ulimit=\"-v 1\")\n```\n\ndon't seem to put any limit.\n\nIssue created by migration from https://trac.sagemath.org/ticket/11939\n\n",
    "created_at": "2011-10-18T10:22:46Z",
    "labels": [
        "component: notebook",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Notebook \"ulimit -v\" does not work",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11767",
    "user": "https://github.com/jdemeyer"
}
```
Assignee: jason, mpatel, was

CC:  @fchapoton

The `ulimit -v` argument does not do anything at all (I have not tested other options), neither locally nor remote.  Both commands

```
notebook(ulimit="-v 1")
```

and

```
notebook(server_pool=["jdemeyer@localhost"], ulimit="-v 1")
```

don't seem to put any limit.

Issue created by migration from https://trac.sagemath.org/ticket/11939





---

archive/issue_comments_134015.json:
```json
{
    "body": "I looked at the code couple of months ago and what it does is baffling. It parses all the parameters and then recombines them and tries to call ulimit. No idea why it does so.\n\nIn my opinion, setting ulimit should be an argument to `SAGE_ROOT/sage`, i.e., `SAGE_ROOT/local/bin/sage-sage`. Then ulimit should be set by running `ulimit <along with the options passed without parsing them>` and then Sage or the Sage notebook should be launched. Since Sage or Sage nb will be running in the same shell, it will run with the ulimits that were set.",
    "created_at": "2011-10-18T12:35:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11767#issuecomment-134015",
    "user": "https://github.com/ppurka"
}
```

I looked at the code couple of months ago and what it does is baffling. It parses all the parameters and then recombines them and tries to call ulimit. No idea why it does so.

In my opinion, setting ulimit should be an argument to `SAGE_ROOT/sage`, i.e., `SAGE_ROOT/local/bin/sage-sage`. Then ulimit should be set by running `ulimit <along with the options passed without parsing them>` and then Sage or the Sage notebook should be launched. Since Sage or Sage nb will be running in the same shell, it will run with the ulimits that were set.



---

archive/issue_comments_134016.json:
```json
{
    "body": "Replying to [comment:2 ppurka]:\n> Since Sage or Sage nb will be running in the same shell, it will run with the ulimits that were set.\n\nThis is not true for remote notebook workers, so we need something more clever.",
    "created_at": "2011-10-18T13:43:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11767#issuecomment-134016",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:2 ppurka]:
> Since Sage or Sage nb will be running in the same shell, it will run with the ulimits that were set.

This is not true for remote notebook workers, so we need something more clever.



---

archive/issue_comments_134017.json:
```json
{
    "body": "It seems at least *your example* (`-v 1`) yields a zero limit, since the value is first divided by `1000.0`, then gets converted back to an `int`, and **afterwards** gets multiplied by `1000` again.",
    "created_at": "2011-10-18T13:46:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11767#issuecomment-134017",
    "user": "https://github.com/nexttime"
}
```

It seems at least *your example* (`-v 1`) yields a zero limit, since the value is first divided by `1000.0`, then gets converted back to an `int`, and **afterwards** gets multiplied by `1000` again.



---

archive/issue_comments_134018.json:
```json
{
    "body": "Even with all the conversions, I am pretty sure ulimit does not work. That's what brought down our servers on the first day of classes. Everyone had -v set to 2G and yet the Sage process of one person was allowed to run up 20G+ of memory, eating up all the available ram and swap.",
    "created_at": "2011-10-18T13:52:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11767#issuecomment-134018",
    "user": "https://github.com/ppurka"
}
```

Even with all the conversions, I am pretty sure ulimit does not work. That's what brought down our servers on the first day of classes. Everyone had -v set to 2G and yet the Sage process of one person was allowed to run up 20G+ of memory, eating up all the available ram and swap.



---

archive/issue_comments_134019.json:
```json
{
    "body": "You may try this (haven't tested the notebook at all):\n\n```diff\ndiff --git a/sagenb/interfaces/expect.py b/sagenb/interfaces/expect.py\n--- a/sagenb/interfaces/expect.py\n+++ b/sagenb/interfaces/expect.py\n@@ -47,7 +47,7 @@\n         if process_limits:\n             u = ''\n             if process_limits.max_vmem is not None:\n-                u += ' -v %s'%(int(process_limits.max_vmem)*1000)\n+                u += ' -v %s'%(int(process_limits.max_vmem*1000))\n             if process_limits.max_cputime is not None:\n                 u += ' -t %s'%(int(process_limits.max_cputime))\n             if process_limits.max_processes is not None:\n```\n",
    "created_at": "2011-10-18T13:55:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11767#issuecomment-134019",
    "user": "https://github.com/nexttime"
}
```

You may try this (haven't tested the notebook at all):

```diff
diff --git a/sagenb/interfaces/expect.py b/sagenb/interfaces/expect.py
--- a/sagenb/interfaces/expect.py
+++ b/sagenb/interfaces/expect.py
@@ -47,7 +47,7 @@
         if process_limits:
             u = ''
             if process_limits.max_vmem is not None:
-                u += ' -v %s'%(int(process_limits.max_vmem)*1000)
+                u += ' -v %s'%(int(process_limits.max_vmem*1000))
             if process_limits.max_cputime is not None:
                 u += ' -t %s'%(int(process_limits.max_cputime))
             if process_limits.max_processes is not None:
```




---

archive/issue_comments_134020.json:
```json
{
    "body": "Oh, also you can check whether ulimit is set by running this from a worksheet:\n\n```\nimport os\nos.system(\"ulimit -a\")\n```\n",
    "created_at": "2011-10-18T13:57:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11767#issuecomment-134020",
    "user": "https://github.com/ppurka"
}
```

Oh, also you can check whether ulimit is set by running this from a worksheet:

```
import os
os.system("ulimit -a")
```




---

archive/issue_comments_134021.json:
```json
{
    "body": "**Hahahahaha!!!1! **\n\n\n```python\n\n    def command(self):\n        return self._python\n        # TODO: The following simply doesn't work -- this is not a valid way to run\n        # ulimited.  Also we should check if ulimit is available before even\n        # doing this.   \n        return '&&'.join([x for x in [self._ulimit, self._python] if x])\n\n```\n\n(This is `WorksheetProcess_ExpectImplementation.command()`.)",
    "created_at": "2011-10-18T15:07:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11767#issuecomment-134021",
    "user": "https://github.com/nexttime"
}
```

**Hahahahaha!!!1! **


```python

    def command(self):
        return self._python
        # TODO: The following simply doesn't work -- this is not a valid way to run
        # ulimited.  Also we should check if ulimit is available before even
        # doing this.   
        return '&&'.join([x for x in [self._ulimit, self._python] if x])

```

(This is `WorksheetProcess_ExpectImplementation.command()`.)



---

archive/issue_comments_134022.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11767#issuecomment-134022",
    "user": "https://github.com/jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/issue_comments_134023.json:
```json
{
    "body": "In my experience the only working way to set limits is to edit the sage script to call ulimit if the username is \"Sage worker\". It is quite annoying to remember to do it between upgrades and in any case this is not what the documentation tells us to do...",
    "created_at": "2013-01-21T18:25:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11767#issuecomment-134023",
    "user": "https://github.com/novoselt"
}
```

In my experience the only working way to set limits is to edit the sage script to call ulimit if the username is "Sage worker". It is quite annoying to remember to do it between upgrades and in any case this is not what the documentation tells us to do...



---

archive/issue_comments_134024.json:
```json
{
    "body": "See https://github.com/sagemath/sagenb/issues/235",
    "created_at": "2014-09-18T02:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11767#issuecomment-134024",
    "user": "https://github.com/kcrisman"
}
```

See https://github.com/sagemath/sagenb/issues/235



---

archive/issue_comments_134025.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-08-18T00:36:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11767#issuecomment-134025",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_134026.json:
```json
{
    "body": "Proposing to close all sagenb tickets as outdated, so that all remaining open tickets in the notebook component are about the Jupyter notebook.",
    "created_at": "2020-08-18T00:36:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11767#issuecomment-134026",
    "user": "https://github.com/mkoeppe"
}
```

Proposing to close all sagenb tickets as outdated, so that all remaining open tickets in the notebook component are about the Jupyter notebook.



---

archive/issue_comments_134027.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2020-08-19T08:59:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11767",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11767#issuecomment-134027",
    "user": "https://github.com/fchapoton"
}
```

Resolution: invalid



---

archive/issue_events_011834.json:
```json
{
    "actor": "@fchapoton",
    "created_at": "2020-08-19T08:59:08Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11767",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11767#event-11834"
}
```
